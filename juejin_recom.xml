<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[React Native 进阶实战：基于 Server-Driven UI 的动态表单架构设计]]></title>    <link>https://juejin.cn/post/7576484465759682595</link>    <guid>https://juejin.cn/post/7576484465759682595</guid>    <pubDate>2025-11-26T02:09:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576484465759682595" data-draft-id="7576536602110558218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Native 进阶实战：基于 Server-Driven UI 的动态表单架构设计"/> <meta itemprop="keywords" content="前端,React.js,React Native"/> <meta itemprop="datePublished" content="2025-11-26T02:09:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Native 进阶实战：基于 Server-Driven UI 的动态表单架构设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:09:18.000Z" title="Wed Nov 26 2025 02:09:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 为什么需要动态表单？</h2>
<p>在移动应用开发中，我们经常遇到以下痛点：</p>
<ul>
<li><strong>业务需求变更频繁：</strong> 比如电商大促的活动页、问卷调查、或是 SaaS 产品的自定义配置项，这些页面结构经常变动。</li>
<li><strong>发版周期长：</strong> 原生 App 的发版受到应用商店审核的限制。仅仅为了修改一个输入框的校验规则或者增加一个字段，就需要走完“打包-审核-用户更新”的全流程，效率极低。</li>
</ul>
<p><strong>解决方案：</strong> 采用 <strong>服务端驱动 UI (Server-Driven UI)</strong> 的设计理念。App 端不再硬编码具体的表单结构，而是作为一个“渲染器”，根据服务端下发的 JSON 配置动态生成界面。</p>
<h2 data-id="heading-1">2. 核心设计理念：乐高积木模式</h2>
<p>实现动态表单的核心在于将“数据”与“结构”分离：</p>
<ol>
<li><strong>组件库 (The Bricks)：</strong> 预先在 App 内封装好标准化的基础组件（如：单行文本、开关、日期选择器、图片上传等）。</li>
<li><strong>配置协议 (The Blueprint)：</strong> 服务端下发的 JSON 数据，定义了页面包含哪些组件、组件的属性以及校验规则。</li>
<li><strong>渲染引擎 (The Engine)：</strong> 一个通用的 React 组件，负责解析 JSON 协议，映射并实例化对应的组件。</li>
</ol>
<h2 data-id="heading-2">3. 技术选型</h2>
<ul>
<li>
<p><strong>UI 框架：</strong> React Native</p>
</li>
<li>
<p><strong>表单状态管理：</strong> <code>react-hook-form</code></p>
<ul>
<li><em>推荐理由：</em> 在处理动态 Key（字段名不固定）的场景下，它的性能极佳，且能轻松处理复杂的校验逻辑，避免了手动管理大量 State 的繁琐。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">4. 完整实现指南</h2>
<h3 data-id="heading-4">第一步：构建基础组件库 (UI Layer)</h3>
<p>这些是应用内的“原子组件”。我们需要统一它们的接口规范（例如都接收 <code>value</code> 和 <code>onChange</code>）。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// components/FormFields.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Text</span>, <span class="hljs-title class_">TextInput</span>, <span class="hljs-title class_">Switch</span>, <span class="hljs-title class_">StyleSheet</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;

<span class="hljs-comment">// 1. 通用文本输入框</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">GenericInput</span> = (<span class="hljs-params">{ label, value, onChange, placeholder }: <span class="hljs-built_in">any</span></span>) =&gt; (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.fieldContainer}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.label}</span>&gt;</span>{label}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">TextInput</span> 
      <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.input}</span> 
      <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> 
      <span class="hljs-attr">onChangeText</span>=<span class="hljs-string">{onChange}</span> 
      <span class="hljs-attr">placeholder</span>=<span class="hljs-string">{placeholder}</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
);

<span class="hljs-comment">// 2. 通用开关组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">GenericSwitch</span> = (<span class="hljs-params">{ label, value, onChange }: <span class="hljs-built_in">any</span></span>) =&gt; (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.fieldContainerRow}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{styles.label}</span>&gt;</span>{label}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Switch</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> <span class="hljs-attr">onValueChange</span>=<span class="hljs-string">{onChange}</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
);

<span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">fieldContainer</span>: { <span class="hljs-attr">marginBottom</span>: <span class="hljs-number">16</span> },
  <span class="hljs-attr">fieldContainerRow</span>: { <span class="hljs-attr">flexDirection</span>: <span class="hljs-string">'row'</span>, <span class="hljs-attr">justifyContent</span>: <span class="hljs-string">'space-between'</span>, <span class="hljs-attr">marginBottom</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">alignItems</span>: <span class="hljs-string">'center'</span> },
  <span class="hljs-attr">label</span>: { <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">marginBottom</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#333'</span> },
  <span class="hljs-attr">input</span>: { <span class="hljs-attr">borderWidth</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">borderColor</span>: <span class="hljs-string">'#e0e0e0'</span>, <span class="hljs-attr">padding</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">fontSize</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#f9f9f9'</span> },
});
</code></pre>
<h3 data-id="heading-5">第二步：开发动态渲染引擎 (Logic Layer)</h3>
<p>这是架构的核心。它建立了一个 <strong>String -&gt; Component</strong> 的映射表，并结合 <code>react-hook-form</code> 进行状态托管。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// components/DynamicFormRenderer.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Text</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> { useForm, <span class="hljs-title class_">Controller</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-hook-form'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GenericInput</span>, <span class="hljs-title class_">GenericSwitch</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./FormFields'</span>;

<span class="hljs-comment">// 1. 组件注册表：将协议中的 type 映射到具体的 React 组件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ComponentMap</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt; = {
  <span class="hljs-attr">text_input</span>: <span class="hljs-title class_">GenericInput</span>,
  <span class="hljs-attr">toggle_switch</span>: <span class="hljs-title class_">GenericSwitch</span>,
  <span class="hljs-comment">// 可以在此扩展更多组件，如 date_picker, image_upload 等</span>
};

<span class="hljs-comment">// 2. 定义协议接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">FormFieldSchema</span> {
  <span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>;        <span class="hljs-comment">// 组件类型，对应 ComponentMap 的 key</span>
  <span class="hljs-attr">key</span>: <span class="hljs-built_in">string</span>;         <span class="hljs-comment">// 提交数据的字段名</span>
  <span class="hljs-attr">label</span>: <span class="hljs-built_in">string</span>;       <span class="hljs-comment">// UI 显示的标题</span>
  defaultValue?: <span class="hljs-built_in">any</span>;  <span class="hljs-comment">// 默认值</span>
  required?: <span class="hljs-built_in">boolean</span>;  <span class="hljs-comment">// 校验规则：是否必填</span>
  placeholder?: <span class="hljs-built_in">string</span>;<span class="hljs-comment">// 占位符</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">DynamicFormProps</span> {
  <span class="hljs-attr">schema</span>: <span class="hljs-title class_">FormFieldSchema</span>[]; 
  <span class="hljs-attr">onSubmit</span>: <span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">DynamicFormRenderer</span> = (<span class="hljs-params">{ schema, onSubmit }: DynamicFormProps</span>) =&gt; {
  <span class="hljs-keyword">const</span> { control, handleSubmit, <span class="hljs-attr">formState</span>: { errors } } = <span class="hljs-title function_">useForm</span>();

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span>&gt;</span>
      {schema.map((field, index) =&gt; {
        const Component = ComponentMap[field.type];

        // 容错处理：遇到未知的组件类型
        if (!Component) {
          return <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{color:</span> '<span class="hljs-attr">gray</span>'}}&gt;</span>不支持的组件类型: {field.type}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>;
        }

        return (
          <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{field.key}</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Controller</span>
              <span class="hljs-attr">control</span>=<span class="hljs-string">{control}</span>
              <span class="hljs-attr">name</span>=<span class="hljs-string">{field.key}</span>
              <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">{field.defaultValue}</span>
              <span class="hljs-attr">rules</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">required:</span> <span class="hljs-attr">field.required</span> ? '<span class="hljs-attr">此项不能为空</span>' <span class="hljs-attr">:</span> <span class="hljs-attr">false</span> }}
              <span class="hljs-attr">render</span>=<span class="hljs-string">{({</span> <span class="hljs-attr">field:</span> { <span class="hljs-attr">onChange</span>, <span class="hljs-attr">value</span> } }) =&gt;</span> (
                <span class="hljs-tag">&lt;<span class="hljs-name">Component</span>
                  <span class="hljs-attr">label</span>=<span class="hljs-string">{field.label}</span>
                  <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span>
                  <span class="hljs-attr">onChange</span>=<span class="hljs-string">{onChange}</span>
                  <span class="hljs-attr">placeholder</span>=<span class="hljs-string">{field.placeholder}</span>
                  {<span class="hljs-attr">...field</span>} // <span class="hljs-attr">将协议中的其他自定义属性透传给组件</span>
                /&gt;</span>
              )}
            /&gt;
            {/* 统一的错误提示 UI */}
            {errors[field.key] &amp;&amp; (
              <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{color:</span> '<span class="hljs-attr">red</span>', <span class="hljs-attr">fontSize:</span> <span class="hljs-attr">12</span>, <span class="hljs-attr">marginTop:</span> <span class="hljs-attr">-10</span>, <span class="hljs-attr">marginBottom:</span> <span class="hljs-attr">10</span>}}&gt;</span>
                {errors[field.key]?.message as string}
              <span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
            )}
          <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
        );
      })}

      <span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> <span class="hljs-attr">24</span> }}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"提交表单"</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handleSubmit(onSubmit)}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
  );
};
</code></pre>
<h3 data-id="heading-6">第三步：业务场景应用 (Integration)</h3>
<p>在实际页面中，我们只需要请求接口获取 JSON，然后传给渲染引擎即可。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// screens/SurveyScreen.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ScrollView</span>, <span class="hljs-title class_">Alert</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DynamicFormRenderer</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/DynamicFormRenderer'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">SurveyScreen</span>(<span class="hljs-params"/>) {
  
  <span class="hljs-comment">// 模拟：从服务端 API 获取的动态配置</span>
  <span class="hljs-keyword">const</span> serverConfig = [
    { 
      <span class="hljs-attr">type</span>: <span class="hljs-string">'text_input'</span>, 
      <span class="hljs-attr">key</span>: <span class="hljs-string">'username'</span>, 
      <span class="hljs-attr">label</span>: <span class="hljs-string">'用户昵称'</span>, 
      <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'请输入您的昵称'</span>,
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> 
    },
    { 
      <span class="hljs-attr">type</span>: <span class="hljs-string">'text_input'</span>, 
      <span class="hljs-attr">key</span>: <span class="hljs-string">'email'</span>, 
      <span class="hljs-attr">label</span>: <span class="hljs-string">'联系邮箱'</span>, 
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> 
    },
    { 
      <span class="hljs-attr">type</span>: <span class="hljs-string">'toggle_switch'</span>, 
      <span class="hljs-attr">key</span>: <span class="hljs-string">'subscribe'</span>, 
      <span class="hljs-attr">label</span>: <span class="hljs-string">'订阅我们的周刊'</span>, 
      <span class="hljs-attr">defaultValue</span>: <span class="hljs-literal">true</span> 
    }
  ];

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFormSubmit</span> = (<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) =&gt; {
    <span class="hljs-comment">// 最终收集到的数据对象，结构完全由服务端 Key 决定</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Form Data:"</span>, data);
    <span class="hljs-title class_">Alert</span>.<span class="hljs-title function_">alert</span>(<span class="hljs-string">"提交成功"</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ScrollView</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> <span class="hljs-attr">24</span>, <span class="hljs-attr">marginTop:</span> <span class="hljs-attr">40</span> }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">DynamicFormRenderer</span> 
        <span class="hljs-attr">schema</span>=<span class="hljs-string">{serverConfig}</span> 
        <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleFormSubmit}</span> 
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ScrollView</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-7">5. 方案优势总结</h2>
<ol>
<li><strong>动态性 (Dynamic):</strong> 界面完全由数据定义，服务端可随时下发新的 JSON 配置来改变 App 界面，无需依赖 App Store 发版。</li>
<li><strong>解耦 (Decoupling):</strong> 前端专注于 UI 组件的交互细节与样式实现，后端专注于业务逻辑与字段定义，职责分明。</li>
<li><strong>一致性 (Consistency):</strong> 这一套 JSON 协议可以同时供 Android、iOS 甚至 Web 端使用，确保多端业务逻辑完全一致。</li>
</ol>
<h2 data-id="heading-8">6. 扩展思考</h2>
<p>对于更复杂的生产环境，可以在此基础上进行扩展：</p>
<ul>
<li><strong>表单联动:</strong> 在 JSON 协议中增加 <code>dependencies</code> 字段，实现“当字段 A 选了 X 时，字段 B 才显示”的逻辑。</li>
<li><strong>复杂校验:</strong> 支持正则校验（Regex），服务端下发正则表达式字符串，前端解析后用于验证。</li>
<li><strong>布局嵌套:</strong> 引入 <code>Layout</code> 类型的组件（如 Row, Column, Card），支持更丰富的页面排版能力。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JS 里的 “变量租房记”：闭包是咋把变量 “扣” 下来的？]]></title>    <link>https://juejin.cn/post/7576556950331293696</link>    <guid>https://juejin.cn/post/7576556950331293696</guid>    <pubDate>2025-11-26T02:14:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576556950331293696" data-draft-id="7576512460262735908" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JS 里的 “变量租房记”：闭包是咋把变量 “扣” 下来的？"/> <meta itemprop="keywords" content="JavaScript,前端,Node.js"/> <meta itemprop="datePublished" content="2025-11-26T02:14:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风止何安啊"/> <meta itemprop="url" content="https://juejin.cn/user/2517239724512420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JS 里的 “变量租房记”：闭包是咋把变量 “扣” 下来的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517239724512420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风止何安啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:14:15.000Z" title="Wed Nov 26 2025 02:14:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>你有没有过这种疑惑：</p>
<p>明明在 “出租屋”（函数）里放的 “行李”（变量），房东都退房了，这行李咋还能拿出来用？或者循环里的变量总 “串房间”，明明住 1 号房，结果跑到 6 号房去了？在函数里定义的变量，出了函数居然还能用？</p>
<p>这背后其实藏着<strong>作用域、作用域链</strong>的 “小九九”，而最终的 <strong>“幕后BOSS”</strong> 就是 ——<strong>闭包</strong>。今天咱们就用 “租房” ，把<strong>作用域、作用域链、闭包</strong>这仨 JS 里的 “租房规则” 讲明白，让你迅速成为<strong>闭包大师</strong>。</p>
<h3 data-id="heading-1">一、先搞懂：变量的 “租房地盘” 叫作用域</h3>
<p>变量不是随便 “住” 的，它得有自己的 “房子”—— 这就是<strong>作用域</strong>。简单说：<strong>变量能待的地方，就是它的作用域</strong>。</p>
<p>JS 里的 “房子” 分 3 种：</p>
<h4 data-id="heading-2">1. 全局作用域：“大街上的共享行李，谁都能碰”</h4>
<p>你把行李放 “大街上”（函数 / 大括号外面），那整个小区（整个文件）的人都能拿。</p>
<p>比如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> good = <span class="hljs-string">"张三的快递"</span>; <span class="hljs-comment">// 放大街上（全局作用域）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getGood</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(good);   <span class="hljs-comment">// 谁都能拿，输出“张三的快递”</span>
}
<span class="hljs-title function_">getGood</span>();
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f185b4e2945045269a0ab3e1cf8550c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764728055&amp;x-signature=1cd0jPBZ%2B%2FXVp9mFaomopv8E%2Bh4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">2. 函数作用域：“自家卧室的行李，外人别进”</h4>
<p>你把行李锁在 “卧室”（函数内部）里，那只有卧室里的人能拿，出了门就碰不到了。</p>
<p>比如：</p>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">wallet</span> = <span class="hljs-string">"全局钱包(100块)"</span><span class="hljs-comment">; </span>
function myHome() {
    var <span class="hljs-attr">wallet</span> = <span class="hljs-string">"卧室钱包(2000块)"</span><span class="hljs-comment">; // 卧室里的钱包，只在卧室有效</span>
    console.log(wallet)<span class="hljs-comment">; // 用的是卧室里的，输出2000</span>
}
myHome()<span class="hljs-comment">;</span>
console.log(wallet)<span class="hljs-comment">; // 只能拿到大街上的，输出100</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cadd6bc5783426ea8750430c5cd40d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764728055&amp;x-signature=fYN7YMl4efZfkIe2hXv%2FIR3h7vk%3D" alt="image.png" loading="lazy"/></p>
<p><strong>划重点</strong>：这房子是 “单向门”—— 只能从卧室（内部）往外拿大街上的东西，大街上的人拿不到卧室里的。</p>
<h4 data-id="heading-4">3. 块级作用域：“用<code>let</code>给行李划个小格子”</h4>
<p><code>var</code>是 “粗心租客”：哪怕把行李放 “衣柜”（<code>if/for</code>的<code>{}</code>里），也会不小心 “掉” 到卧室里；但<code>let/const</code>是 “细心租客”，把行李锁在衣柜格子里，只有格子里能拿。</p>
<p>上代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (<span class="hljs-literal">true</span>) {
  <span class="hljs-keyword">let</span> money = <span class="hljs-number">500</span>; <span class="hljs-comment">// 锁在衣柜格子（块级作用域）里</span>
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(money); <span class="hljs-comment">// 报错！外面打不开这格子</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/766c2644e93f4f93a3ab9e6ed1b07880~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764728055&amp;x-signature=VGoGdxssAz3CX%2BmVbv%2FHLxk0xhA%3D" alt="image.png" loading="lazy"/></p>
<p>结果也是显示了<strong>money is not defined</strong>。所以当形成块级作用域时，外层是访问不了内层的。要是换成<code>var money = 500;</code>，这钱就会 “掉” 到外面，能被拿到 —— 这就是<code>let</code>的 “格子锁” 功能。</p>
<h3 data-id="heading-5">二、变量 “找不到？喊房东！”—— 作用域链</h3>
<p>你在卧室里找行李，找不到咋办？喊 “房东”（外层作用域）啊！房东找不到，就喊 “大房东”（外外层作用域），一层一层往上喊，这串 “喊人的链条” 就是<strong>作用域链</strong>。</p>
<p>看个例子：</p>
<pre><code class="hljs language-ini" lang="ini">function myHome() {
  var <span class="hljs-attr">TV</span> = <span class="hljs-string">"客厅的大电视"</span><span class="hljs-comment">; </span>
  let <span class="hljs-attr">sofa</span> = <span class="hljs-string">"客厅沙发"</span><span class="hljs-comment">;</span>
  {
    let <span class="hljs-attr">sofa</span> = <span class="hljs-string">"卧室小沙发"</span><span class="hljs-comment">; </span>
    var <span class="hljs-attr">eat</span> = <span class="hljs-string">"客厅零食"</span><span class="hljs-comment">; // var没格子锁，掉客厅里了</span>
    let <span class="hljs-attr">clothes</span> = <span class="hljs-string">"卧室睡衣"</span><span class="hljs-comment">;</span>
    console.log(TV)<span class="hljs-comment">; // 卧室里找不到，喊房东（客厅）→ 找到电视，输出“大电视”</span>
    console.log(sofa)<span class="hljs-comment">; // 卧室里有小沙发，直接拿→ 输出“小沙发”</span>
  }
  console.log(sofa)<span class="hljs-comment">; // 客厅里的大沙发→ 输出“客厅沙发”</span>
  console.log(eat)<span class="hljs-comment">; // 零食掉客厅了→ 输出“客厅零食”</span>
  console.log(clothes)<span class="hljs-comment">; // 睡衣锁在卧室格子里→ 报错！拿不到</span>
}
myHome()<span class="hljs-comment">;</span>
</code></pre>
<p>结果跟我们想的一样：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f0c2f0632f24cb8b4a74e243f6b63e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764728055&amp;x-signature=GRjsn5U0Xl6L9sm1eZuHsderqq4%3D" alt="image.png" loading="lazy"/></p>
<p>大致分析如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c35264d7df441c6bd99385ed0387248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764728055&amp;x-signature=E6eiBVRJ1zwnU4BAkuDiTtt9dzE%3D" alt="image.png" loading="lazy"/></p>
<p><strong>关键规律</strong>：你租房子的时候（函数定义时），就会记下来 “房东是谁”（用<code>outer</code>指针）—— 不管你后来搬到哪（函数在哪调用），找东西都得按 “最初的房东” 来！</p>
<h3 data-id="heading-6">三、闭包：“租客退租了，行李却被保洁扣下了”</h3>
<p>先记两个租房规矩：</p>
<ol>
<li>租客退租（函数执行完），卧室里的东西（执行上下文）会被物业清走（内存销毁）；</li>
<li>保洁（内部函数）能进租客的卧室拿东西（作用域规则）。</li>
</ol>
<p>那闭包是咋回事？</p>
<p>别急，先看个例子：</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">leave</span>() {
  <span class="hljs-selector-tag">var</span> <span class="hljs-attribute">left</span> = "租客的笔记本电脑"; <span class="hljs-comment">// 卧室里的行李</span>
  function <span class="hljs-built_in">cleaner</span>() { <span class="hljs-comment">// 保洁是卧室里的“内部员工”</span>
    console<span class="hljs-selector-class">.log</span>(left); <span class="hljs-comment">// 保洁能拿这行李</span>
  }
  return cleaner; <span class="hljs-comment">// 租客把保洁“带走了”</span>
}
<span class="hljs-selector-tag">var</span> cleaner1 = <span class="hljs-built_in">leave</span>(); <span class="hljs-comment">// 租客退租了，卧室该被清了</span>
<span class="hljs-built_in">cleaner1</span>(); <span class="hljs-comment">// 但保洁居然拿出了“笔记本电脑”！</span>
</code></pre>
<p>最喜欢的输出结果环节：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/825e4a363a3143c99f0e57bb16dfbcd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764728055&amp;x-signature=bBEK1%2BV4dKqrE63QA2QjNkrz19U%3D" alt="image.png" loading="lazy"/></p>
<p>这就离谱了：租客都走了，行李咋还在？</p>
<p><strong>答案</strong>：因为保洁（内部函数）还 “惦记着” 这行李，物业（JS 引擎）就不会把卧室全清掉 —— 而是留个 “小储物箱”（这就是闭包），专门装保洁需要的行李（这里就是<code>遗留行李</code>）。</p>
<p>大白话翻译闭包：</p>
<blockquote>
<p>租客退租了，但保洁把他的行李扣在储物箱里，走到哪带到哪 —— 这储物箱就是闭包。</p>
</blockquote>
<p>还没懂的话我再举个例子：</p>
<p>假设你有一个不听话的儿子，他跟你断绝关系出去闯荡，幸运的是他出去之后你们的老房子就拆迁了，于是你拿着拆迁补贴买了一套新房子，但你于心不忍，你怕儿子走投无路回来找你，但是房子又拆迁了，这时候你就会在这个拆迁遗址<strong>立一个牌子</strong>或者什么做<strong>标记</strong>，让你儿子知道你搬到哪里了，而这个<strong>牌子</strong>就是<strong>闭包</strong>。虽然老房子没了，但是这个<strong>牌子</strong>有它的作用----提醒你儿子新家的地址，你儿子如果回来会用得到这个作用。</p>
<p>虽然已经出栈，但依旧保留函数要用到的方法，这就是<strong>闭包</strong>的核心。</p>
<p>再看一个例子：为啥能输出 1-5？就是因为闭包把 “每个房间的行李” 都扣下来了：</p>
<pre><code class="hljs language-ini" lang="ini">var <span class="hljs-attr">arr</span> = []<span class="hljs-comment">;</span>
for (var <span class="hljs-attr">i</span> = <span class="hljs-number">1</span><span class="hljs-comment">; i &lt;= 5; i++) {</span>
    function foo(j) {
        arr.push(function(){
            console.log(j)<span class="hljs-comment">;</span>
        })
    }
    foo(i)<span class="hljs-comment">;</span>
}
for (let <span class="hljs-attr">n</span> = <span class="hljs-number">0</span><span class="hljs-comment">; n &lt; arr.length; n++) {</span>
    arr<span class="hljs-section">[n]</span>()<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cf2b4ed66a04f94a3d56610ad5ad363~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764728055&amp;x-signature=XPjBbb%2FnJU8tYYDczoutr5ZHtMA%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">四、闭包：是 “储物神器” 也是 “占房坑”</h3>
<h4 data-id="heading-8">优点：</h4>
<ul>
<li><strong>藏私房钱</strong>：想把行李锁起来，只有自己能拿？用闭包！</li>
<li><strong>封装 “专属房间”</strong> ：早期 JS 没 “独立公寓”（模块），全靠闭包封出专属空间。</li>
</ul>
<h4 data-id="heading-9">缺点：</h4>
<ul>
<li><strong>占着房间不撒手（内存泄露）</strong> ：闭包扣着行李，物业就没法清房间 —— 要是不用的闭包不扔，房间会越占越多。解决办法：不用保洁的时候，把保洁辞了（比如<code>离职保洁 = null</code>），物业就会把储物箱清掉。</li>
</ul>
<h2 data-id="heading-10">总结：一句话串起所有 “租房规则”</h2>
<p><strong>作用域</strong>是变量的 “房间”，<strong>作用域链</strong>是 “找不到东西喊房东的顺序”，<strong>闭包</strong>是 “租客退租后，保洁扣下行李的储物箱”—— 这仨就是 JS 里 “变量住哪、咋找、咋留” 的全部逻辑！</p>
<blockquote>
<p>恭喜你成为<strong>闭包大师</strong>！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙next sqlite进阶版本来了]]></title>    <link>https://juejin.cn/post/7576486942834966574</link>    <guid>https://juejin.cn/post/7576486942834966574</guid>    <pubDate>2025-11-25T16:43:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576486942834966574" data-draft-id="7576518316135890995" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙next sqlite进阶版本来了 "/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-25T16:43:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xq9527"/> <meta itemprop="url" content="https://juejin.cn/user/1239904848712184"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙next sqlite进阶版本来了 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1239904848712184/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xq9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T16:43:44.000Z" title="Tue Nov 25 2025 16:43:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">前言导读</h4>
<p>各位网友大家好，有段时间没有更大家见面了，之前我写过一个关于鸿蒙next 里面轻量化数据库的使用，那个过程复杂而且不好使用</p>
<p>今天我就带着大家一起封装一个开箱即用的sqlite 的工具类库 希望后面同学再存储数据的时候不再繁琐。那么废话不多说我们正式开始</p>
<h4 data-id="heading-1">效果图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab90899831e141b9a541b488b2667454~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeHE5NTI3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764693823&amp;x-signature=9TPr6g8HJcHkK%2BIDfP0%2FakRFi2c%3D" alt="image-20251126002008763" loading="lazy"/></p>
<h4 data-id="heading-2">具体实现</h4>
<ul>
<li>
<h6 data-id="heading-3">1封装我们的  策略接口  基类  BaseStrategy</h6>
<p>我们一共定义了 建表  ，初始化数据库   插入数据  查询所有数据  删除数据等方法</p>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-comment">/**
   * 策略接口
   */</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BaseStrategy</span> {
    <span class="hljs-comment">/**
     * 设置数据库SQL参数
     * <span class="hljs-doctag">@param</span> dbName 数据库名称
     * <span class="hljs-doctag">@param</span> tableName 表名
     * <span class="hljs-doctag">@param</span> sqlArgsMap SQL参数映射
     */</span>
    <span class="hljs-title function_">setDbSqlArgs</span>(<span class="hljs-attr">dbName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">tableName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">sqlArgsMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;): <span class="hljs-built_in">void</span>;
  
    <span class="hljs-comment">/**
     * 初始化数据库
     */</span>
    <span class="hljs-title function_">initSssDb</span>(<span class="hljs-attr">context</span>: <span class="hljs-built_in">any</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;
  
    <span class="hljs-comment">/**
     * 获取本地数据库订单信息
     * <span class="hljs-doctag">@returns</span> 订单信息列表
     */</span>
    <span class="hljs-title function_">getLocalDbOrderInfo</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;&gt;&gt;;
  
    <span class="hljs-comment">/**
     * 插入或更新子订单
     * <span class="hljs-doctag">@param</span> uniqueKey 唯一标识键
     * <span class="hljs-doctag">@param</span> uniqueValue 唯一标识值
     * <span class="hljs-doctag">@param</span> contentMap 内容映射
     */</span>
    <span class="hljs-title function_">insertOrUpdateSub</span>(<span class="hljs-attr">uniqueKey</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">uniqueValue</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">contentMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;
  
    <span class="hljs-comment">/**
     * 删除数据库数据
     * <span class="hljs-doctag">@param</span> uniqueKey 唯一标识键
     * <span class="hljs-doctag">@param</span> uniqueValue 唯一标识值
     */</span>
    <span class="hljs-title function_">deleteDbData</span>(<span class="hljs-attr">uniqueKey</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">uniqueValue</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;;
  
  
  
  
  }
</code></pre>
<ul>
<li>
<h5 data-id="heading-4">2 策略实现类</h5>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts">  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">LocalSaveHelper</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./helper/LocalSaveHelper'</span>;
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">BaseStrategy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./inf/BaseStrategy'</span>;
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">DbLog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./util/DbLog'</span>;
  <span class="hljs-keyword">import</span> {<span class="hljs-title class_">SdkRdbHelper</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./db/SdkRdbHelper'</span>
  
  
  <span class="hljs-comment">/**
   * 策略实现类
   */</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyPayStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BaseStrategy</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">MyPayStrategy</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  
  
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
  
    }
  
  
  
    <span class="hljs-comment">/**
     * 获取单例实例
     * <span class="hljs-doctag">@returns</span> MkPaySsStrategy实例
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">MyPayStrategy</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">MyPayStrategy</span>.<span class="hljs-property">instance</span>) {
        <span class="hljs-title class_">MyPayStrategy</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPayStrategy</span>();
      }
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">MyPayStrategy</span>.<span class="hljs-property">instance</span>;
    }
  
    <span class="hljs-comment">/**
     * 设置数据库SQL参数
     * <span class="hljs-doctag">@param</span> dbName 数据库名称
     * <span class="hljs-doctag">@param</span> tableName 表名
     * <span class="hljs-doctag">@param</span> args SQL参数映射
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">setDbSqlArgs</span>(<span class="hljs-attr">dbName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">tableName</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">args</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;): <span class="hljs-built_in">void</span> {
      <span class="hljs-keyword">if</span> (!args) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">printLog</span>(<span class="hljs-string">'table args is null!!!'</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args.<span class="hljs-property">size</span> &lt;= <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">printLog</span>(<span class="hljs-string">'table args size is empty!!!'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (!dbName) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">printLog</span>(<span class="hljs-string">'database name is empty!!!'</span>);
        }
        <span class="hljs-keyword">if</span> (!tableName) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">printLog</span>(<span class="hljs-string">'table name is empty!!!'</span>);
        }
        <span class="hljs-title class_">LocalSaveHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">setDbName</span>(dbName);
        <span class="hljs-title class_">LocalSaveHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">setDbTableName</span>(tableName);
        <span class="hljs-title class_">LocalSaveHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">setDbSqlArgsMap</span>(args);
      }
    }
  
    <span class="hljs-comment">/**
     * 初始化数据库
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">initSssDb</span>(<span class="hljs-attr">context</span>:<span class="hljs-title class_">Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">printLog</span>(<span class="hljs-string">'initSssDb'</span>);
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">LocalSaveHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getSqlArgsMap</span>()) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">printErrLog</span>(<span class="hljs-string">'Please assign an instance first about SqlArgsMap'</span>);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">await</span> <span class="hljs-title class_">SdkRdbHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">initRdbStore</span>(context);
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">eWithStack</span>(error.<span class="hljs-property">message</span>, error);
      }
    }
  
    <span class="hljs-comment">/**
     * 获取本地数据库订单信息
     * <span class="hljs-doctag">@returns</span> 订单信息列表
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">getLocalDbOrderInfo</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;&gt;&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">printLog</span>(<span class="hljs-string">'getLocalDbOrderInfo'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-title class_">SdkRdbHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getSdkOrderInfo</span>();
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">eWithStack</span>(error.<span class="hljs-property">message</span>, error);
        <span class="hljs-keyword">return</span> [];
      }
    }
  
    <span class="hljs-comment">/**
     * 插入或更新子订单
     * <span class="hljs-doctag">@param</span> uniqueKey 唯一标识键
     * <span class="hljs-doctag">@param</span> uniqueValue 唯一标识值
     * <span class="hljs-doctag">@param</span> args 参数映射
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">insertOrUpdateSub</span>(<span class="hljs-attr">uniqueKey</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">uniqueValue</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">args</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">printLog</span>(<span class="hljs-string">'insertOrUpdateSub'</span>);
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">SdkRdbHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">insertOrUpdateSub</span>(uniqueKey, uniqueValue, args);
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">eWithStack</span>(error.<span class="hljs-property">message</span>, error);
      }
    }
  
    <span class="hljs-comment">/**
     * 删除数据库数据
     * <span class="hljs-doctag">@param</span> uniqueKey 唯一标识键
     * <span class="hljs-doctag">@param</span> uniqueValue 唯一标识值
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">deleteDbData</span>(<span class="hljs-attr">uniqueKey</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">uniqueValue</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">printLog</span>(<span class="hljs-string">'deleteDbData'</span>);
         <span class="hljs-title class_">SdkRdbHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">deleteDbOrderData</span>(uniqueKey, uniqueValue);
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">eWithStack</span>(error.<span class="hljs-property">message</span>, error);
      }
    }
  
    <span class="hljs-comment">/**
     * 打印日志
     * <span class="hljs-doctag">@param</span> msg 日志消息
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">printLog</span>(<span class="hljs-attr">msg</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
      <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">d</span>(msg);
    }
  
    <span class="hljs-comment">/**
     * 打印错误日志
     * <span class="hljs-doctag">@param</span> msg 错误日志消息
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">printErrLog</span>(<span class="hljs-attr">msg</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
      <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">e</span>(msg);
    }
  }
</code></pre>
<ul>
<li>
<h5 data-id="heading-5">3 获取数据库建表SQL语句</h5>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 获取数据库建表SQL语句
 * <span class="hljs-doctag">@param</span> tableName 表名
 * <span class="hljs-doctag">@returns</span> 建表SQL语句
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getSssDbSql</span>(<span class="hljs-attr">tableName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> argsMap = <span class="hljs-title class_">LocalSaveHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getSqlArgsMap</span>();
  <span class="hljs-keyword">let</span> sql = <span class="hljs-string">`CREATE TABLE IF NOT EXISTS <span class="hljs-subst">${tableName}</span> (ID INTEGER PRIMARY KEY AUTOINCREMENT`</span>;
  
  <span class="hljs-keyword">if</span> (argsMap) {
    <span class="hljs-keyword">const</span> entries = argsMap.<span class="hljs-title function_">entries</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
      <span class="hljs-keyword">const</span> key = entry[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">const</span> value = entry[<span class="hljs-number">1</span>];
      sql += <span class="hljs-string">`, <span class="hljs-subst">${key}</span> <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getArgsVariable(value)}</span>`</span>;
    }
  }
  
  sql += <span class="hljs-string">');'</span>;
  <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">d</span>(<span class="hljs-string">`sql: <span class="hljs-subst">${sql}</span>`</span>);
  <span class="hljs-keyword">return</span> sql;
}
</code></pre>
<ul>
<li>
<h5 data-id="heading-6">4 SDK关系数据库帮助类</h5>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">LocalSaveHelper</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../helper/LocalSaveHelper'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DbLog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../util/DbLog'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MYPayType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../constant/MYPayType'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PaySsUtils</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../util/PaySsUtils'</span>;
<span class="hljs-keyword">import</span> { relationalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;


<span class="hljs-comment">/**
 * SDK关系数据库帮助类
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SdkRdbHelper</span> {
  <span class="hljs-keyword">public</span>  <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">SdkRdbHelper</span>|<span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">store</span>: relationalStore.<span class="hljs-property">RdbStore</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;

  <span class="hljs-comment">/**
   * 获取单例实例
   * <span class="hljs-doctag">@returns</span> SdkRdbHelper实例
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">SdkRdbHelper</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">SdkRdbHelper</span>.<span class="hljs-property">instance</span>) {
      <span class="hljs-title class_">SdkRdbHelper</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SdkRdbHelper</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">SdkRdbHelper</span>.<span class="hljs-property">instance</span>;
  }

  <span class="hljs-comment">/**
   * 初始化数据库
   * <span class="hljs-doctag">@param</span> context 上下文
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">initRdbStore</span>(<span class="hljs-params">context: Context</span>){
    <span class="hljs-keyword">const</span> <span class="hljs-attr">STORE_CONFIG</span>: relationalStore.<span class="hljs-property">StoreConfig</span> = {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'RdbTest.db'</span>, <span class="hljs-comment">// 数据库文件名</span>
      <span class="hljs-attr">securityLevel</span>: relationalStore.<span class="hljs-property">SecurityLevel</span>.<span class="hljs-property">S1</span>, <span class="hljs-comment">// 数据库安全级别</span>
      <span class="hljs-attr">encrypt</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 可选参数，指定数据库是否加密，默认不加密</span>
      <span class="hljs-attr">customDir</span>: <span class="hljs-string">'customDir/subCustomDir'</span>, <span class="hljs-comment">// 可选参数，数据库自定义路径。数据库将在如下的目录结构中被创建：context.databaseDir + '/rdb/' + customDir，其中context.databaseDir是应用沙箱对应的路径，'/rdb/'表示创建的是关系型数据库，customDir表示自定义的路径。当此参数不填时，默认在本应用沙箱目录下创建RdbStore实例。</span>
      <span class="hljs-attr">isReadOnly</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 可选参数，指定数据库是否以只读方式打开。该参数默认为false，表示数据库可读可写。该参数为true时，只允许从数据库读取数据，不允许对数据库进行写操作，否则会返回错误码801。</span>
    };
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// if(this.store){</span>
      <span class="hljs-comment">// //  this.store = await rdb.getRdbStore(context, this.STORE_CONFIG);</span>
      <span class="hljs-comment">//   await rdb.getRdbStore(context,this.STORE_CONFIG).then((data)=&gt;{</span>
      <span class="hljs-comment">//</span>
      <span class="hljs-comment">//   })</span>
      <span class="hljs-comment">// }</span>

      <span class="hljs-comment">// 获得一个相关的RdbStore，操作关系型数据库，用户可以根据自己的需求配置RdbStore的参数，</span>
      <span class="hljs-comment">// 然后通过RdbStore调用相关接口可以执行相关的数据操作，使用callback异步回调。</span>
      relationalStore.<span class="hljs-title function_">getRdbStore</span>(context, <span class="hljs-variable constant_">STORE_CONFIG</span>, <span class="hljs-function">(<span class="hljs-params">err, store</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (err) {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`At LoginPage Failed to get RdbStore. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);
          <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'At LoginPage Succeeded in getting RdbStore.'</span>);
        <span class="hljs-comment">// 当数据库创建时，数据库默认版本为0</span>
        <span class="hljs-keyword">if</span> (store.<span class="hljs-property">version</span> === <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">const</span> tableName = <span class="hljs-title class_">LocalSaveHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getDbTableName</span>();
          <span class="hljs-keyword">const</span> sql = <span class="hljs-title class_">PaySsUtils</span>.<span class="hljs-title function_">getSssDbSql</span>(tableName);
          store.<span class="hljs-title function_">executeSql</span>(sql); <span class="hljs-comment">// 创建数据表</span>
          <span class="hljs-comment">// 设置数据库的版本，入参为大于0的整数</span>
          store.<span class="hljs-property">version</span> = <span class="hljs-number">1</span>;
        }
        <span class="hljs-comment">// 赋值给当前的rdbStore对象，确保获取到RdbStore实例后，再进行数据库的增、删、改、查等操作</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span> = store
      });

    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">e</span>(<span class="hljs-string">`初始化数据库失败: <span class="hljs-subst">${error.message}</span>`</span>);

    }
  }

  <span class="hljs-comment">/**
   * 获取SDK订单信息
   * <span class="hljs-doctag">@returns</span> 订单信息列表
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">getSdkOrderInfo</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;&gt;&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">resultList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;&gt; = [];
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>) {
        <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">e</span>(<span class="hljs-string">'数据库未初始化'</span>);
        <span class="hljs-keyword">return</span> resultList;
      }

      <span class="hljs-keyword">const</span> tableName = <span class="hljs-title class_">LocalSaveHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getDbTableName</span>();
      <span class="hljs-keyword">const</span> resultSet = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>.<span class="hljs-title function_">querySql</span>(<span class="hljs-string">`SELECT * FROM <span class="hljs-subst">${tableName}</span> ORDER BY ID DESC`</span>, []);

      <span class="hljs-keyword">while</span> (resultSet.<span class="hljs-title function_">goToNextRow</span>()) {
        <span class="hljs-keyword">const</span> resultMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;();
        <span class="hljs-keyword">const</span> argsMap = <span class="hljs-title class_">LocalSaveHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getSqlArgsMap</span>();

        <span class="hljs-keyword">if</span> (argsMap) {
          <span class="hljs-keyword">const</span> entries = argsMap.<span class="hljs-title function_">entries</span>();
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
            <span class="hljs-keyword">const</span> key = entry[<span class="hljs-number">0</span>];
            <span class="hljs-keyword">const</span> value = entry[<span class="hljs-number">1</span>];
            <span class="hljs-keyword">const</span> columnIndex = resultSet.<span class="hljs-title function_">getColumnIndex</span>(key);
            <span class="hljs-keyword">if</span> (columnIndex !== -<span class="hljs-number">1</span>) {
              <span class="hljs-keyword">if</span> (value === <span class="hljs-title class_">MYPayType</span>.<span class="hljs-property">TEXT</span>) {
                resultMap.<span class="hljs-title function_">set</span>(key, resultSet.<span class="hljs-title function_">getString</span>(columnIndex));
              } <span class="hljs-keyword">else</span> {
                resultMap.<span class="hljs-title function_">set</span>(key, resultSet.<span class="hljs-title function_">getString</span>(columnIndex));
              }
            }
          }
        }
        resultList.<span class="hljs-title function_">push</span>(resultMap);
      }

      resultSet.<span class="hljs-title function_">close</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">e</span>(<span class="hljs-string">`查询订单信息失败: <span class="hljs-subst">${error.message}</span>`</span>);
    }

    <span class="hljs-keyword">return</span> resultList;
  }

  <span class="hljs-comment">/**
   * 插入或更新子订单
   * <span class="hljs-doctag">@param</span> uniqueKey 唯一标识键
   * <span class="hljs-doctag">@param</span> uniqueValue 唯一标识值
   * <span class="hljs-doctag">@param</span> contentMap 内容映射
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">insertOrUpdateSub</span>(<span class="hljs-attr">uniqueKey</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">uniqueValue</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">contentMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>) {
        <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">e</span>(<span class="hljs-string">'数据库未初始化'</span>);
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">const</span> tableName = <span class="hljs-title class_">LocalSaveHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getDbTableName</span>();
      
      <span class="hljs-comment">// 检查记录是否存在</span>
      <span class="hljs-keyword">const</span> queryResultSet = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>.<span class="hljs-title function_">querySql</span>(
        <span class="hljs-string">`SELECT COUNT(*) AS count FROM <span class="hljs-subst">${tableName}</span> WHERE <span class="hljs-subst">${uniqueKey}</span> = ?`</span>,
        [uniqueValue]
      );

      <span class="hljs-keyword">let</span> exists = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (queryResultSet.<span class="hljs-title function_">goToNextRow</span>()) {
        <span class="hljs-keyword">const</span> count = queryResultSet.<span class="hljs-title function_">getLong</span>(queryResultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">'count'</span>));
        exists = count &gt; <span class="hljs-number">0</span>;
      }
      queryResultSet.<span class="hljs-title function_">close</span>();

      <span class="hljs-keyword">if</span> (exists) {
        <span class="hljs-comment">// 更新操作</span>
        <span class="hljs-keyword">let</span> updateSql = <span class="hljs-string">`UPDATE <span class="hljs-subst">${tableName}</span> SET `</span>;
        <span class="hljs-keyword">const</span> <span class="hljs-attr">values</span>: <span class="hljs-built_in">string</span>[] = [];
        <span class="hljs-keyword">const</span> <span class="hljs-attr">params</span>: <span class="hljs-built_in">string</span>[] = [];

        <span class="hljs-keyword">const</span> entries = contentMap.<span class="hljs-title function_">entries</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
          <span class="hljs-keyword">const</span> key = entry[<span class="hljs-number">0</span>];
          <span class="hljs-keyword">const</span> value = entry[<span class="hljs-number">1</span>];
          values.<span class="hljs-title function_">push</span>(<span class="hljs-string">`<span class="hljs-subst">${key}</span> = ?`</span>);
          params.<span class="hljs-title function_">push</span>(value);
        }
        updateSql += values.<span class="hljs-title function_">join</span>(<span class="hljs-string">', '</span>);
        updateSql += <span class="hljs-string">` WHERE <span class="hljs-subst">${uniqueKey}</span> = ?`</span>;
        params.<span class="hljs-title function_">push</span>(uniqueValue);

        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>.<span class="hljs-title function_">executeSql</span>(updateSql, params);
        <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">d</span>(<span class="hljs-string">'记录已存在，执行更新操作'</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 插入操作</span>
        <span class="hljs-keyword">let</span> insertSql = <span class="hljs-string">`INSERT INTO <span class="hljs-subst">${tableName}</span> (`</span>;
        <span class="hljs-keyword">const</span> <span class="hljs-attr">columns</span>: <span class="hljs-built_in">string</span>[] = [];
        <span class="hljs-keyword">const</span> <span class="hljs-attr">placeholders</span>: <span class="hljs-built_in">string</span>[] = [];
        <span class="hljs-keyword">const</span> <span class="hljs-attr">params</span>: <span class="hljs-built_in">string</span>[] = [];

        <span class="hljs-comment">// 添加唯一键</span>
        columns.<span class="hljs-title function_">push</span>(uniqueKey);
        placeholders.<span class="hljs-title function_">push</span>(<span class="hljs-string">'?'</span>);
        params.<span class="hljs-title function_">push</span>(uniqueValue);

        <span class="hljs-keyword">const</span> entries = contentMap.<span class="hljs-title function_">entries</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
          <span class="hljs-keyword">const</span> key = entry[<span class="hljs-number">0</span>];
          <span class="hljs-keyword">const</span> value = entry[<span class="hljs-number">1</span>];
          columns.<span class="hljs-title function_">push</span>(key);
          placeholders.<span class="hljs-title function_">push</span>(<span class="hljs-string">'?'</span>);
          params.<span class="hljs-title function_">push</span>(value);
        }

        insertSql += columns.<span class="hljs-title function_">join</span>(<span class="hljs-string">', '</span>) + <span class="hljs-string">') VALUES ('</span> + placeholders.<span class="hljs-title function_">join</span>(<span class="hljs-string">', '</span>) + <span class="hljs-string">')'</span>;
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>.<span class="hljs-title function_">executeSql</span>(insertSql, params);
        <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">d</span>(<span class="hljs-string">'执行插入操作'</span>);
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">e</span>(<span class="hljs-string">`插入或更新子订单失败: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">/**
   * 删除数据库订单数据
   * <span class="hljs-doctag">@param</span> uniqueKey 唯一标识键
   * <span class="hljs-doctag">@param</span> uniqueValue 唯一标识值
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">deleteDbOrderData</span>(<span class="hljs-attr">uniqueKey</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">uniqueValue</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>) {
        <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">e</span>(<span class="hljs-string">'数据库未初始化'</span>);
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">const</span> tableName = <span class="hljs-title class_">LocalSaveHelper</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getDbTableName</span>();
      
      <span class="hljs-comment">// 检查记录是否存在</span>
      <span class="hljs-keyword">const</span> queryResultSet = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>.<span class="hljs-title function_">querySql</span>(
        <span class="hljs-string">`SELECT COUNT(*) AS count FROM <span class="hljs-subst">${tableName}</span> WHERE <span class="hljs-subst">${uniqueKey}</span> = ?`</span>,
        [uniqueValue]
      );

      <span class="hljs-keyword">let</span> exists = <span class="hljs-literal">false</span>;
      <span class="hljs-keyword">if</span> (queryResultSet.<span class="hljs-title function_">goToNextRow</span>()) {
        <span class="hljs-keyword">const</span> count = queryResultSet.<span class="hljs-title function_">getLong</span>(queryResultSet.<span class="hljs-title function_">getColumnIndex</span>(<span class="hljs-string">'count'</span>));
        exists = count &gt; <span class="hljs-number">0</span>;
      }
      queryResultSet.<span class="hljs-title function_">close</span>();

      <span class="hljs-keyword">if</span> (exists) {
        <span class="hljs-keyword">const</span> deleteSql = <span class="hljs-string">`DELETE FROM <span class="hljs-subst">${tableName}</span> WHERE <span class="hljs-subst">${uniqueKey}</span> = ?`</span>;
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>.<span class="hljs-title function_">executeSql</span>(deleteSql, [uniqueValue]);
        <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">d</span>(<span class="hljs-string">'删除数据库订单数据成功'</span>);
      }
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-title class_">DbLog</span>.<span class="hljs-title function_">e</span>(<span class="hljs-string">`删除数据库订单数据失败: <span class="hljs-subst">${error.message}</span>`</span>);
    }
  }

  <span class="hljs-comment">/**
   * 关闭数据库连接
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">close</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>) {
       <span class="hljs-variable language_">this</span>.<span class="hljs-property">store</span>.<span class="hljs-title function_">close</span>();
    }
  }
}
</code></pre>
<ul>
<li>
<h4 data-id="heading-7">使用示例</h4>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MYPayType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./constant/MYPayType"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyPayStrategy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./MyPayStrategy"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.AbilityKit"</span>;
<span class="hljs-keyword">import</span> {<span class="hljs-title class_">UserInfo</span>}  <span class="hljs-keyword">from</span> <span class="hljs-string">'./model/UserInfo'</span>


<span class="hljs-comment">/**
 * 使用示例
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaySssSdkExample</span> {

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">PaySssSdkExample</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;


  <span class="hljs-keyword">private</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {}



  <span class="hljs-comment">/**
   * 获取单例实例
   * <span class="hljs-doctag">@returns</span> MyPayStrategy实例
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(): <span class="hljs-title class_">PaySssSdkExample</span> {
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">PaySssSdkExample</span>.<span class="hljs-property">instance</span>) {
      <span class="hljs-title class_">PaySssSdkExample</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaySssSdkExample</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">PaySssSdkExample</span>.<span class="hljs-property">instance</span>;
  }
  <span class="hljs-comment">/**
   * 初始化SDK示例
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">initSdkExample</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 获取SDK实例</span>
      <span class="hljs-keyword">const</span> sdk = <span class="hljs-title class_">MyPayStrategy</span>.<span class="hljs-title function_">getInstance</span>();
      <span class="hljs-comment">// 设置数据库参数</span>
      <span class="hljs-keyword">const</span> sqlArgs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;();
      sqlArgs.<span class="hljs-title function_">set</span>(<span class="hljs-string">'username'</span>, <span class="hljs-title class_">MYPayType</span>.<span class="hljs-property">TEXT</span>);
      sqlArgs.<span class="hljs-title function_">set</span>(<span class="hljs-string">'password'</span>, <span class="hljs-title class_">MYPayType</span>.<span class="hljs-property">TEXT</span>);
      sdk.<span class="hljs-title function_">setDbSqlArgs</span>(<span class="hljs-string">'user_database'</span>, <span class="hljs-string">'username'</span>, sqlArgs);
      
      <span class="hljs-comment">// 初始化数据库</span>
      <span class="hljs-keyword">await</span> sdk.<span class="hljs-title function_">initSssDb</span>(context);
      
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'SDK初始化完成'</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'SDK初始化失败:'</span>, error);
    }
  }
  
  <span class="hljs-comment">/**
   * 插入订单示例
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">insertOrderExample</span>(<span class="hljs-attr">userInfo</span>:<span class="hljs-title class_">UserInfo</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> sdk = <span class="hljs-title class_">MyPayStrategy</span>.<span class="hljs-title function_">getInstance</span>();
      <span class="hljs-comment">// 创建订单数据</span>
      <span class="hljs-keyword">const</span> userData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;();
      userData.<span class="hljs-title function_">set</span>(<span class="hljs-string">'username'</span>, userInfo.<span class="hljs-property">username</span>);
      userData.<span class="hljs-title function_">set</span>(<span class="hljs-string">'password'</span>, userInfo.<span class="hljs-property">password</span>);
      <span class="hljs-comment">// 插入或更新订单</span>
      <span class="hljs-keyword">await</span> sdk.<span class="hljs-title function_">insertOrUpdateSub</span>(<span class="hljs-string">'username'</span>, userInfo.<span class="hljs-property">username</span>, userData);
      
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'订单插入成功'</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'订单插入失败:'</span>, error);
    }
  }
  
  <span class="hljs-comment">/**
   * 查询订单示例
   */</span>
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">queryOrdersExample</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;&gt;&gt;  {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> sdk = <span class="hljs-title class_">MyPayStrategy</span>.<span class="hljs-title function_">getInstance</span>();
      
      <span class="hljs-comment">// // 获取所有订单信息</span>
      <span class="hljs-comment">// const orders = await sdk.getLocalDbOrderInfo();</span>
      <span class="hljs-comment">//</span>
      <span class="hljs-comment">// console.log('查询到的订单数量:', orders.length);</span>
      <span class="hljs-comment">// orders.forEach((order, index) =&gt; {</span>
      <span class="hljs-comment">//   console.log(`订单 ${index + 1}:`, order);</span>
      <span class="hljs-comment">// });</span>

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> sdk.<span class="hljs-title function_">getLocalDbOrderInfo</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'查询订单失败:'</span>, error);
      <span class="hljs-keyword">return</span> [];
    }
  }
}
</code></pre>
<ul>
<li>
<h4 data-id="heading-8">我们封装一下 然后再我们的UI组件里面去使用</h4>
</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">import {PaySssSdkExample} from  '../PaySssSdkExample'
import  {UserInfo}  from '../model/UserInfo'

<span class="hljs-keyword">@Extend</span>(TextInput)function inputStyle(){
  <span class="hljs-selector-class">.placeholderColor</span>($r('app.color.placeholder_color'))
  <span class="hljs-selector-class">.height</span>(<span class="hljs-number">45</span>)
  <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">18</span>)
  <span class="hljs-selector-class">.backgroundColor</span>($r('app.color.background'))
  <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
  <span class="hljs-selector-class">.padding</span>({left:<span class="hljs-number">0</span>})
  <span class="hljs-selector-class">.margin</span>({top:<span class="hljs-number">12</span>})
}
<span class="hljs-keyword">@Extend</span>(Line)function lineStyle(){
  <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
  <span class="hljs-selector-class">.height</span>(<span class="hljs-number">1</span>)
  <span class="hljs-selector-class">.backgroundColor</span>($r('app.color.linecolor'))
  <span class="hljs-selector-class">.margin</span>({left:<span class="hljs-number">5</span>,right:<span class="hljs-number">5</span>})
}

<span class="hljs-keyword">@Extend</span>(Text)function textStyle(){
  <span class="hljs-selector-class">.fontColor</span>($r('app.color.black_text_color'))
  <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">18</span>)
  <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Medium)
}

<span class="hljs-keyword">@Entry</span>
<span class="hljs-keyword">@Component</span>
struct Index {
  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">message</span>: string = <span class="hljs-string">'Hello World'</span>;
  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">getid</span>:string=<span class="hljs-string">''</span>;
  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">username</span>:string=<span class="hljs-string">''</span>;
  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">password</span>:string=<span class="hljs-string">''</span>;

  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">datamap</span>:Array&lt;Map&lt;string, string&gt;&gt;=[];

  <span class="hljs-built_in">aboutToAppear</span>(): void {
    PaySssSdkExample<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.initSdkExample</span>(getContext());
  }

  <span class="hljs-built_in">build</span>() {
    <span class="hljs-built_in">RelativeContainer</span>() {
       <span class="hljs-built_in">Column</span>({space:<span class="hljs-number">10</span>}){


         <span class="hljs-built_in">Row</span>(){
           <span class="hljs-built_in">Row</span>(){
             Text("username")<span class="hljs-selector-class">.textStyle</span>()
           }<span class="hljs-selector-class">.width</span>(<span class="hljs-number">100</span>)
           <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
           <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Center)

           <span class="hljs-built_in">TextInput</span>({placeholder:"请输入username"})
             <span class="hljs-selector-class">.maxLength</span>(<span class="hljs-number">20</span>)
             <span class="hljs-selector-class">.type</span>(InputType.Normal)
             <span class="hljs-selector-class">.inputStyle</span>()
             <span class="hljs-selector-class">.onChange</span>((value:string)=&gt;{
               this<span class="hljs-selector-class">.username</span>=value;
             })<span class="hljs-selector-class">.margin</span>({left:<span class="hljs-number">20</span>})
         }<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
         <span class="hljs-selector-class">.height</span>(<span class="hljs-number">50</span>)
         <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Start)

         Line()<span class="hljs-selector-class">.lineStyle</span>()

         <span class="hljs-built_in">Row</span>(){

           <span class="hljs-built_in">Row</span>(){
             Text("password")<span class="hljs-selector-class">.textStyle</span>()
           }<span class="hljs-selector-class">.width</span>(<span class="hljs-number">100</span>)
           <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
           <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Center)

           <span class="hljs-built_in">TextInput</span>({placeholder:"请输入password"})
             <span class="hljs-selector-class">.maxLength</span>(<span class="hljs-number">20</span>)
             <span class="hljs-selector-class">.type</span>(InputType.Normal)
             <span class="hljs-selector-class">.inputStyle</span>()
             <span class="hljs-selector-class">.onChange</span>((value:string)=&gt;{
               this<span class="hljs-selector-class">.password</span>=value;
             })<span class="hljs-selector-class">.margin</span>({left:<span class="hljs-number">20</span>})
         }<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
         <span class="hljs-selector-class">.height</span>(<span class="hljs-number">50</span>)
         <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Start)

         Line()<span class="hljs-selector-class">.lineStyle</span>()


         <span class="hljs-built_in">Row</span>({space:<span class="hljs-number">10</span>}){
           <span class="hljs-selector-tag">Button</span>("插入数据")<span class="hljs-selector-class">.onClick</span>(()=&gt;{
            let  userInfo: UserInfo=new <span class="hljs-built_in">UserInfo</span>();
            userInfo<span class="hljs-selector-class">.id</span>=this<span class="hljs-selector-class">.getid</span>;
            userInfo<span class="hljs-selector-class">.username</span>=this<span class="hljs-selector-class">.username</span>;
            userInfo<span class="hljs-selector-class">.password</span>=this<span class="hljs-selector-class">.password</span>;
             PaySssSdkExample<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.insertOrderExample</span>(userInfo);

           })<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)

           <span class="hljs-selector-tag">Button</span>("查询数据")<span class="hljs-selector-class">.onClick</span>(()=&gt;{
             PaySssSdkExample<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.queryOrdersExample</span>()<span class="hljs-selector-class">.then</span>((data)=&gt;{
               this<span class="hljs-selector-class">.datamap</span>=data;
             })
           })<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)


         }<span class="hljs-selector-class">.width</span>("<span class="hljs-number">100%</span>")<span class="hljs-selector-class">.margin</span>({left:<span class="hljs-number">20</span>,right:<span class="hljs-number">20</span>})

         <span class="hljs-built_in">List</span>({space:<span class="hljs-number">10</span>}){
           <span class="hljs-built_in">ForEach</span>(this.datamap,(item:Map&lt;string, string&gt;)=&gt;{
             <span class="hljs-built_in">ListItem</span>(){
               <span class="hljs-built_in">Column</span>(){
                 Text(item?.get("id"))<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">18</span>)<span class="hljs-selector-class">.fontColor</span>(Color.Black)
                   <span class="hljs-selector-class">.margin</span>({top:<span class="hljs-number">5</span>})
                 Text(item?.get("username"))<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">15</span>)<span class="hljs-selector-class">.fontColor</span>(Color.Gray)
                   <span class="hljs-selector-class">.margin</span>({top:<span class="hljs-number">5</span>})
                 Text(item?.get("password"))<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">15</span>)<span class="hljs-selector-class">.fontColor</span>(Color.Black)
                   <span class="hljs-selector-class">.margin</span>({top:<span class="hljs-number">5</span>})
               }<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Start)<span class="hljs-selector-class">.margin</span>({left:<span class="hljs-number">20</span>})<span class="hljs-selector-class">.alignItems</span>(HorizontalAlign.Start)

             }<span class="hljs-selector-class">.height</span>(<span class="hljs-number">100</span>)
             <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
           })
         }



       }<span class="hljs-selector-class">.width</span>("<span class="hljs-number">100%</span>")
      <span class="hljs-selector-class">.height</span>("<span class="hljs-number">100%</span>")
    }
    <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
  }
}
</code></pre>
<h4 data-id="heading-9">最后总结</h4>
<p>我们封装了数据库工具类后 我们对比我们平常要写一堆的建表语句 还有需要编写我们的查询语句 和我们的删除语句 ，我们很好封装和</p>
<p>数据库辅助工具类就可以进减少我们调用者来编写这部分点，当然整个工具类不完善 我们其实可以继续完善 进一步抽象 ，可以·把我们的</p>
<p>model 转成map 这个时候我们只需要操作对象存储和查询获取 还有删除的动作即可，如果觉得文章还不错麻烦给我一键三连谢谢</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于顺序表完成通讯录项目]]></title>    <link>https://juejin.cn/post/7576477793779105832</link>    <guid>https://juejin.cn/post/7576477793779105832</guid>    <pubDate>2025-11-26T02:22:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576477793779105832" data-draft-id="7576556950331359232" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于顺序表完成通讯录项目"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T02:22:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有风63"/> <meta itemprop="url" content="https://juejin.cn/user/1892682130797704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于顺序表完成通讯录项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1892682130797704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有风63
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:22:10.000Z" title="Wed Nov 26 2025 02:22:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一篇文章中，我们已经掌握了顺序表的基本原理与实现方法。接下来，我们将基于顺序表这一数据结构，完成一个实际的通讯录管理系统项目。</p>
<p>一、通讯录项目的设计与实现</p>
<p>为方便理解与参考，后续将提供完整的代码仓库链接（如 Gitee）。</p>
<p>在顺序表基础部分，我们使用 <code>typedef</code> 将 <code>int</code> 类型重命名为 <code>SLDataType</code>。而在通讯录项目中，我们将把 <code>SLDataType</code> 重新定义为表示联系人的结构体类型。</p>
<p>首先创建头文件 <code>contact.h</code>，定义通讯录中需要存储的数据结构：</p>
<p>c</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// contact.h</span>
typedef struct PersonInfo {
    char name<span class="hljs-selector-attr">[50]</span>;
    char phone<span class="hljs-selector-attr">[20]</span>;
    char <span class="hljs-selector-tag">address</span><span class="hljs-selector-attr">[100]</span>;
    <span class="hljs-comment">// 可根据需要继续添加其他字段</span>
} ContactInfo;
</code></pre>
<p>接下来，在顺序表的头文件 <code>Seqlist.h</code> 中，将原来的 <code>int</code> 类型替换为上面定义的 <code>ContactInfo</code> 结构体：</p>
<p>c</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// Seqlist.h</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"contact.h"</span></span>
<span class="hljs-keyword">typedef</span> ContactInfo SLDataType;  <span class="hljs-comment">// 将顺序表元素类型改为联系人信息</span>
</code></pre>
<p>同时，为了更好地体现模块功能，我们将顺序表结构体重命名为 <code>Contact</code>：</p>
<p>c</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SeqList</span> {
    SLDataType* arr;
    <span class="hljs-type">int</span> size;
    <span class="hljs-type">int</span> capacity;
} Contact;
</code></pre>
<p>下面开始实现通讯录的各项功能：</p>
<ol>
<li><strong>通讯录初始化</strong></li>
</ol>
<p>在 <code>contact.h</code> 中声明初始化函数：</p>
<p>c</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ContactInit</span><span class="hljs-params">(Contact* pcon)</span></span>;
</code></pre>
<p>在测试文件 <code>test.c</code> 中进行功能验证。实际实现时，直接调用顺序表中已封装的初始化函数即可：</p>
<p>c</p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">ContactInit</span>(Contact* pcon) {
    <span class="hljs-built_in">SLInit</span>(pcon);  <span class="hljs-comment">// 复用顺序表的初始化</span>
}
</code></pre>
<ol start="2">
<li><strong>通讯录销毁</strong></li>
</ol>
<p>同样地，销毁函数也直接复用顺序表的实现：</p>
<p>c</p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">ContactDestroy</span>(Contact* pcon) {
    <span class="hljs-built_in">SLDestroy</span>(pcon);
}
</code></pre>
<ol start="3">
<li><strong>添加联系人</strong></li>
</ol>
<p>声明添加函数：</p>
<p>c</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ContactAdd</span><span class="hljs-params">(Contact* pcon)</span></span>;
</code></pre>
<p>实现时，先创建一个 <code>ContactInfo</code> 结构体变量，接收用户输入的各个字段信息，然后通过顺序表的尾插函数将其添加到通讯录中：</p>
<p>c</p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">ContactAdd</span>(Contact* pcon) {
    ContactInfo info;
    <span class="hljs-built_in">printf</span>("请输入姓名：");
    <span class="hljs-built_in">scanf</span>("%s", info.name);
    <span class="hljs-built_in">printf</span>("请输入电话：");
    <span class="hljs-built_in">scanf</span>("%s", info.phone);
    <span class="hljs-comment">// 其他字段的输入...</span>
    
    <span class="hljs-built_in">SLPushBack</span>(pcon, info);  <span class="hljs-comment">// 将联系人信息添加到顺序表末尾</span>
}
</code></pre>
<ol start="4">
<li><strong>显示通讯录</strong></li>
</ol>
<p>声明显示函数：</p>
<p>c</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ContactShow</span><span class="hljs-params">(<span class="hljs-type">const</span> Contact* pcon)</span></span>;
</code></pre>
<p>实现时遍历顺序表，打印每个联系人的详细信息：</p>
<p>c</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ContactShow</span><span class="hljs-params">(<span class="hljs-type">const</span> Contact* pcon)</span> </span>{
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%-10s %-15s %-20s\n"</span>, <span class="hljs-string">"姓名"</span>, <span class="hljs-string">"电话"</span>, <span class="hljs-string">"地址"</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; pcon-&gt;size; i++) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%-10s %-15s %-20s\n"</span>, 
               pcon-&gt;arr[i].name, 
               pcon-&gt;arr[i].phone, 
               pcon-&gt;arr[i].address);
    }
}
</code></pre>
<ol start="5">
<li><strong>删除联系人</strong></li>
</ol>
<p>声明删除函数：</p>
<p>c</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ContactDelete</span><span class="hljs-params">(Contact* pcon, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name)</span></span>;
</code></pre>
<p>删除前需要先查找指定联系人是否存在。我们实现一个查找函数，通过字符串比较来定位：</p>
<p>c</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">FindByName</span><span class="hljs-params">(<span class="hljs-type">const</span> Contact* pcon, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name)</span> </span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; pcon-&gt;size; i++) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(pcon-&gt;arr[i].name, name) == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> i;  <span class="hljs-comment">// 找到返回下标</span>
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;  <span class="hljs-comment">// 未找到</span>
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ContactDelete</span><span class="hljs-params">(Contact* pcon, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name)</span> </span>{
    <span class="hljs-type">int</span> pos = <span class="hljs-built_in">FindByName</span>(pcon, name);
    <span class="hljs-keyword">if</span> (pos != <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">SLErase</span>(pcon, pos);  <span class="hljs-comment">// 调用顺序表的指定位置删除</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"删除成功！\n"</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"未找到该联系人！\n"</span>);
    }
}
</code></pre>
<ol start="6">
<li><strong>查找与修改功能</strong></li>
</ol>
<ul>
<li><strong>查找联系人</strong>：</li>
</ul>
<p>c</p>
<pre><code class="hljs language-perl" lang="perl">void ContactFind(const Contact* pcon, const char* name) {
    <span class="hljs-keyword">int</span> <span class="hljs-keyword">pos</span> = FindByName(pcon, name);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">pos</span> != -<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"找到联系人：\n"</span>);
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"姓名：%s\n电话：%s\n地址：%s\n"</span>, 
               pcon-&gt;arr[<span class="hljs-keyword">pos</span>].name, 
               pcon-&gt;arr[<span class="hljs-keyword">pos</span>].phone, 
               pcon-&gt;arr[<span class="hljs-keyword">pos</span>].address);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">printf</span>(<span class="hljs-string">"未找到该联系人！\n"</span>);
    }
}
</code></pre>
<ul>
<li><strong>修改联系人</strong>：</li>
</ul>
<p>c</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">ContactModify</span><span class="hljs-params">(Contact* pcon, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* name)</span> </span>{
    <span class="hljs-type">int</span> pos = <span class="hljs-built_in">FindByName</span>(pcon, name);
    <span class="hljs-keyword">if</span> (pos != <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"请输入新的姓名："</span>);
        <span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%s"</span>, pcon-&gt;arr[pos].name);
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"请输入新的电话："</span>);
        <span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%s"</span>, pcon-&gt;arr[pos].phone);
        <span class="hljs-comment">// 其他字段的修改...</span>
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"修改成功！\n"</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"未找到该联系人！\n"</span>);
    }
}
</code></pre>
<p>至此，通讯录的基本功能已全部实现。最后，可以在 <code>test.c</code> 中进一步完善用户界面，添加菜单选择等功能，使程序更加友好易用。</p>
<p>附：顺序表基础与通讯录项目的代码仓库链接<br/>
Gitee: [链接地址]</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入探究跨域请求及其解决方案]]></title>    <link>https://juejin.cn/post/7576821574428246025</link>    <guid>https://juejin.cn/post/7576821574428246025</guid>    <pubDate>2025-11-26T01:19:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821574428246025" data-draft-id="7576486942835277870" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入探究跨域请求及其解决方案"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-26T01:19:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Front_Yue"/> <meta itemprop="url" content="https://juejin.cn/user/424874479992943"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入探究跨域请求及其解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/424874479992943/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Front_Yue
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T01:19:53.000Z" title="Wed Nov 26 2025 01:19:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>随着互联网的发展，越来越多的网站和应用程序涌现出来，但是在这些网站和应用程序之间进行数据交互时，会遇到一些问题，其中最常见的问题就是跨域请求。本文将深入探究跨域请求的定义、原因以及解决方案。</p>
<h2 data-id="heading-1">正文内容</h2>
<h3 data-id="heading-2">一、什么是跨域请求</h3>
<p>跨域请求是指在一个域名下的网页请求另一个域名下的资源，这样的请求被称为跨域请求。例如，当我们在一个网站上点击一个链接或者提交一个表单时，浏览器会向服务器发送请求，如果这个请求的目标地址和当前页面的地址不在同一个域名下，那么就属于跨域请求。</p>
<h3 data-id="heading-3">二、为什么会出现跨域请求</h3>
<p>跨域请求出现的原因是因为浏览器的同源策略。同源策略是浏览器的一种安全机制，它要求在同一域名下的网页才能相互访问和交互，而不同域名下的网页之间则不能直接相互访问和交互。同源策略的目的是为了防止恶意攻击者利用一些漏洞来获取用户的敏感信息。</p>
<h3 data-id="heading-4">三、解决跨域问题的方案</h3>
<h4 data-id="heading-5">1. JSONP</h4>
<p>JSONP 是一种简单的跨域请求解决方案。它利用
</p><p>下面是一个JSONP的示例代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">jsonp</span>(<span class="hljs-params">url, callback</span>) {

  <span class="hljs-keyword">var</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);

  script.<span class="hljs-property">src</span> = url + <span class="hljs-string">'?callback='</span> + callback;

  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script);

}


<span class="hljs-title function_">jsonp</span>(<span class="hljs-string">'http://example.com/api/data'</span>, <span class="hljs-string">'handleData'</span>);


<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleData</span>(<span class="hljs-params">data</span>) {

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

}
</code></pre>
<h4 data-id="heading-6">2. CORS</h4>
<p>CORS是一种更加安全的跨域请求解决方案。它通过在服务器端设置响应头来实现跨域请求。当浏览器发起跨域请求时，服务器会在响应头中添加一些特殊的字段，告诉浏览器该请求是被允许的。</p>
<p>下面是一个CORS的示例代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();

xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'GET'</span>, <span class="hljs-string">'http://example.com/api/data'</span>);

xhr.<span class="hljs-property">withCredentials</span> = <span class="hljs-literal">true</span>;

xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">'X-Requested-With'</span>, <span class="hljs-string">'XMLHttpRequest'</span>);

xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {

  <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span> &amp;&amp; xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">responseText</span>);

  }

};

xhr.<span class="hljs-title function_">send</span>();
</code></pre>
<h4 data-id="heading-7">3. 代理服务器</h4>
<p>代理服务器是一种比较常见的跨域请求解决方案。它的原理是在同一域名下设置一个代理服务器，然后将跨域请求发送到代理服务器，由代理服务器转发请求并返回结果。</p>
<p>下面是一个代理服务器的示例代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);

<span class="hljs-keyword">var</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>);

<span class="hljs-keyword">var</span> app = <span class="hljs-title function_">express</span>();


app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) {

  <span class="hljs-keyword">var</span> url = <span class="hljs-string">'http://example.com/api/data'</span>;

  req.<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">request</span>(url)).<span class="hljs-title function_">pipe</span>(res);

});


app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Server is running on port 3000'</span>);

});
</code></pre>
<h2 data-id="heading-8">总结</h2>
<p>跨域请求是在不同域名下进行数据交互时所遇到的问题，它的出现是因为浏览器的同源策略。解决跨域问题的方案有JSONP、CORS和代理服务器等，开发者可以根据具体的情况选择适合自己的解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Ktor Pipeline 机制深度解析]]></title>    <link>https://juejin.cn/post/7576538234273529866</link>    <guid>https://juejin.cn/post/7576538234273529866</guid>    <pubDate>2025-11-26T01:26:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576538234273529866" data-draft-id="7576486942835392558" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ktor Pipeline 机制深度解析"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-26T01:26:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="循环不息优化不止"/> <meta itemprop="url" content="https://juejin.cn/user/3499064877398681"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ktor Pipeline 机制深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3499064877398681/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    循环不息优化不止
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T01:26:04.000Z" title="Wed Nov 26 2025 01:26:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"># Ktor Pipeline 机制深度解析</h2>
<blockquote>
<p>📍 文件位置: <code>ktor-utils/common/src/io/ktor/util/pipeline/Pipeline.kt</code><br/>
🎯 核心地位: Pipeline 是 Ktor 框架的<strong>灵魂</strong>，理解它是掌握 Ktor 的关键</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">📖 目录</h3>
<ol>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-pipeline" title="#%E4%BB%80%E4%B9%88%E6%98%AF-pipeline">什么是 Pipeline</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" title="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">核心概念</a></li>
<li><a href="#%E7%B1%BB%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90" title="#%E7%B1%BB%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90">类结构分析</a></li>
<li><a href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B" title="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B">执行流程</a></li>
<li><a href="#%E5%85%B3%E9%94%AE%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3" title="#%E5%85%B3%E9%94%AE%E6%96%B9%E6%B3%95%E8%AF%A6%E8%A7%A3">关键方法详解</a></li>
<li><a href="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F" title="#%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">设计模式</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E7%A4%BA%E4%BE%8B" title="#%E5%AE%9E%E6%88%98%E7%A4%BA%E4%BE%8B">实战示例</a></li>
<li><a href="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96" title="#%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">性能优化</a></li>
<li><a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98" title="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98">常见问题</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">什么是 Pipeline</h3>
<h4 data-id="heading-3">定义</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Pipeline</span>&lt;<span class="hljs-type">TSubject : Any, TContext : Any</span>&gt;(
    <span class="hljs-keyword">vararg</span> phases: PipelinePhase
)
</code></pre>
<p><strong>Pipeline（管道）</strong> 是 Ktor 中用于处理异步、可扩展计算的执行流水线。它类似于<strong>责任链模式</strong>，但更加强大和灵活。</p>
<h4 data-id="heading-4">核心特点</h4>
<ul>
<li>✅ <strong>异步执行</strong>: 基于 Kotlin 协程，支持 suspend 函数</li>
<li>✅ <strong>分阶段处理</strong>: 通过 Phase 组织执行顺序</li>
<li>✅ <strong>可扩展</strong>: 通过 Interceptor 动态添加处理逻辑</li>
<li>✅ <strong>类型安全</strong>: 泛型约束确保类型安全</li>
<li>✅ <strong>高性能</strong>: 内部优化，支持快速路径（Fast Path）</li>
</ul>
<h4 data-id="heading-5">应用场景</h4>
<p>在 Ktor 中，Pipeline 无处不在：</p>















































<table><thead><tr><th>Pipeline 类型</th><th>用途</th><th>Subject</th><th>Context</th></tr></thead><tbody><tr><td><code>ApplicationCallPipeline</code></td><td>服务端请求处理</td><td><code>Unit</code></td><td><code>PipelineCall</code></td></tr><tr><td><code>HttpRequestPipeline</code></td><td>客户端请求构建</td><td><code>Any</code></td><td><code>HttpRequestBuilder</code></td></tr><tr><td><code>HttpSendPipeline</code></td><td>客户端请求发送</td><td><code>Any</code></td><td><code>HttpRequestBuilder</code></td></tr><tr><td><code>HttpResponsePipeline</code></td><td>客户端响应处理</td><td><code>HttpResponseContainer</code></td><td><code>HttpClientCall</code></td></tr><tr><td><code>ApplicationReceivePipeline</code></td><td>服务端接收数据</td><td><code>Any</code></td><td><code>PipelineCall</code></td></tr><tr><td><code>ApplicationSendPipeline</code></td><td>服务端发送响应</td><td><code>Any</code></td><td><code>PipelineCall</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">核心概念</h3>
<h4 data-id="heading-7">1. 泛型参数</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">Pipeline&lt;TSubject : Any, TContext : Any&gt;
</code></pre>
<ul>
<li><strong>TSubject</strong>: 在管道中流动的<strong>主体对象</strong>
<ul>
<li>例如：HTTP 请求体、响应数据等</li>
<li>可以在拦截器中被修改或替换</li>
</ul>
</li>
<li><strong>TContext</strong>: 管道执行的<strong>上下文</strong>
<ul>
<li>例如：ApplicationCall、HttpRequestBuilder</li>
<li>提供执行环境和辅助信息</li>
</ul>
</li>
</ul>
<h4 data-id="heading-8">2. Phase（阶段）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PipelinePhase</span>(<span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> name: String)
</code></pre>
<p><strong>Phase</strong> 定义了管道的执行阶段，用于组织拦截器的执行顺序。</p>
<h5 data-id="heading-9">示例：ApplicationCallPipeline 的 5 个阶段</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> ApplicationPhase {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> Setup: PipelinePhase = PipelinePhase(<span class="hljs-string">"Setup"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> Monitoring: PipelinePhase = PipelinePhase(<span class="hljs-string">"Monitoring"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> Plugins: PipelinePhase = PipelinePhase(<span class="hljs-string">"Plugins"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> Call: PipelinePhase = PipelinePhase(<span class="hljs-string">"Call"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> Fallback: PipelinePhase = PipelinePhase(<span class="hljs-string">"Fallback"</span>)
}
</code></pre>
<p><strong>执行顺序</strong>: Setup → Monitoring → Plugins → Call → Fallback</p>
<h4 data-id="heading-10">3. Interceptor（拦截器）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">typealias</span> PipelineInterceptor&lt;TSubject, TContext&gt; =
    <span class="hljs-keyword">suspend</span> PipelineContext&lt;TSubject, TContext&gt;.(TSubject) -&gt; <span class="hljs-built_in">Unit</span>
</code></pre>
<p><strong>Interceptor</strong> 是在特定 Phase 执行的处理逻辑，本质上是一个 <strong>suspend 扩展函数</strong>。</p>
<h5 data-id="heading-11">特点：</h5>
<ul>
<li>接收 <code>TSubject</code> 作为参数</li>
<li>在 <code>PipelineContext</code> 上下文中执行</li>
<li>可以调用 <code>proceed()</code> 继续执行下一个拦截器</li>
<li>可以调用 <code>finish()</code> 终止管道执行</li>
</ul>
<h4 data-id="heading-12">4. PipelineContext（执行上下文）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PipelineContext</span>&lt;<span class="hljs-type">TSubject : Any, TContext : Any</span>&gt;(
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> context: TContext
) : CoroutineScope {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">var</span> subject: TSubject
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">proceed</span><span class="hljs-params">()</span></span>: TSubject
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">proceedWith</span><span class="hljs-params">(subject: <span class="hljs-type">TSubject</span>)</span></span>: TSubject
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">finish</span><span class="hljs-params">()</span></span>
}
</code></pre>
<p><strong>PipelineContext</strong> 是拦截器执行时的上下文，提供：</p>
<ul>
<li><code>context</code>: 管道上下文（TContext）</li>
<li><code>subject</code>: 当前处理的主体对象（可修改）</li>
<li><code>proceed()</code>: 继续执行下一个拦截器</li>
<li><code>proceedWith(subject)</code>: 用新的 subject 继续执行</li>
<li><code>finish()</code>: 终止管道执行</li>
</ul>
<hr/>
<h3 data-id="heading-13">类结构分析</h3>
<h4 data-id="heading-14">核心属性</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Pipeline</span>&lt;<span class="hljs-type">TSubject : Any, TContext : Any</span>&gt; {
    <span class="hljs-comment">// 1. 属性存储</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> attributes: Attributes = Attributes(concurrent = <span class="hljs-literal">true</span>)
    
    <span class="hljs-comment">// 2. 开发模式标志</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">open</span> <span class="hljs-keyword">val</span> developmentMode: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>
    
    <span class="hljs-comment">// 3. Phase 列表（可能是 PipelinePhase 或 PhaseContent）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> phasesRaw: MutableList&lt;Any&gt; = mutableListOf(*phases)
    
    <span class="hljs-comment">// 4. 拦截器数量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> interceptorsQuantity = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 5. 缓存的拦截器列表</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> interceptors: List&lt;PipelineInterceptor&lt;TSubject, TContext&gt;&gt;? <span class="hljs-keyword">by</span> atomic(<span class="hljs-literal">null</span>)
    
    <span class="hljs-comment">// 6. 共享标志</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> interceptorsListShared: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> interceptorsListSharedPhase: PipelinePhase? = <span class="hljs-literal">null</span>
}
</code></pre>
<h4 data-id="heading-15">关键设计</h4>
<h5 data-id="heading-16">1. phasesRaw 的混合存储</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> phasesRaw: MutableList&lt;Any&gt;
</code></pre>
<p><code>phasesRaw</code> 可以存储两种类型：</p>
<ul>
<li><strong>PipelinePhase</strong>: 空阶段（没有拦截器）</li>
<li><strong>PhaseContent</strong>: 包含拦截器的阶段</li>
</ul>
<p><strong>优势</strong>: 延迟创建 PhaseContent，节省内存</p>
<h5 data-id="heading-17">2. 拦截器缓存机制</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> interceptors: List&lt;PipelineInterceptor&lt;TSubject, TContext&gt;&gt;? <span class="hljs-keyword">by</span> atomic(<span class="hljs-literal">null</span>)
</code></pre>
<ul>
<li>使用 <code>atomic</code> 保证线程安全</li>
<li>缓存所有阶段的拦截器列表，避免重复构建</li>
<li>当添加新拦截器时，缓存失效（<code>resetInterceptorsList()</code>）</li>
</ul>
<h5 data-id="heading-18">3. 共享机制</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> interceptorsListShared: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>
</code></pre>
<ul>
<li>多个 Pipeline 可以共享拦截器列表</li>
<li>写时复制（Copy-on-Write）策略</li>
<li>减少内存占用和复制开销</li>
</ul>
<hr/>
<h3 data-id="heading-19">执行流程</h3>
<h4 data-id="heading-20">1. 执行入口</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">execute</span><span class="hljs-params">(context: <span class="hljs-type">TContext</span>, subject: <span class="hljs-type">TSubject</span>)</span></span>: TSubject =
    createContext(context, subject, coroutineContext).execute(subject)
</code></pre>
<p><strong>流程</strong>:</p>
<ol>
<li>创建 <code>PipelineContext</code></li>
<li>调用 <code>PipelineContext.execute(subject)</code></li>
<li>返回最终的 subject</li>
</ol>
<h4 data-id="heading-21">2. 创建执行上下文</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createContext</span><span class="hljs-params">(
    context: <span class="hljs-type">TContext</span>,
    subject: <span class="hljs-type">TSubject</span>,
    coroutineContext: <span class="hljs-type">CoroutineContext</span>
)</span></span>: PipelineContext&lt;TSubject, TContext&gt; =
    pipelineContextFor(context, sharedInterceptorsList(), subject, coroutineContext, developmentMode)
</code></pre>
<p>根据 <code>developmentMode</code> 选择不同的实现：</p>
<ul>
<li><strong>生产模式</strong>: <code>SuspendFunctionGun</code> (高性能)</li>
<li><strong>开发模式</strong>: <code>DebugPipelineContext</code> (详细堆栈)</li>
</ul>
<h4 data-id="heading-22">3. 拦截器执行</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 在 PipelineContext 中</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">execute</span><span class="hljs-params">(initial: <span class="hljs-type">TSubject</span>)</span></span>: TSubject
</code></pre>
<p><strong>执行顺序</strong>:</p>
<pre><code class="hljs language-scss" lang="scss">Phase1<span class="hljs-selector-class">.Interceptor1</span> → <span class="hljs-built_in">proceed</span>() →
Phase1<span class="hljs-selector-class">.Interceptor2</span> → <span class="hljs-built_in">proceed</span>() →
Phase2<span class="hljs-selector-class">.Interceptor1</span> → <span class="hljs-built_in">proceed</span>() →
Phase2<span class="hljs-selector-class">.Interceptor2</span> → <span class="hljs-built_in">proceed</span>() →
...
</code></pre>
<h4 data-id="heading-23">4. 流程图</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                    Pipeline<span class="hljs-selector-class">.execute</span>()                        │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              <span class="hljs-built_in">createContext</span>() 创建执行上下文                   │
│  - 获取所有拦截器列表 (sharedInterceptorsList)               │
│  - 创建 PipelineContext (SuspendFunctionGun/DebugContext)   │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│            PipelineContext<span class="hljs-selector-class">.execute</span>(subject)                  │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
        ┌─────────────────────────────┐
        │  Phase <span class="hljs-number">1</span>: Setup             │
        │  ├─ Interceptor <span class="hljs-number">1</span>           │
        │  │   └─ <span class="hljs-built_in">proceed</span>()            │
        │  └─ Interceptor <span class="hljs-number">2</span>           │
        │      └─ <span class="hljs-built_in">proceed</span>()            │
        └─────────────┬───────────────┘
                      │
                      ▼
        ┌─────────────────────────────┐
        │  Phase <span class="hljs-number">2</span>: Monitoring        │
        │  ├─ Interceptor <span class="hljs-number">1</span>           │
        │  │   └─ <span class="hljs-built_in">proceed</span>()            │
        │  └─ Interceptor <span class="hljs-number">2</span>           │
        │      └─ <span class="hljs-built_in">proceed</span>()            │
        └─────────────┬───────────────┘
                      │
                      ▼
                    ...
                      │
                      ▼
        ┌─────────────────────────────┐
        │  Phase N: Fallback          │
        │  └─ Interceptor <span class="hljs-number">1</span>           │
        │      └─ <span class="hljs-built_in">finish</span>()             │
        └─────────────┬───────────────┘
                      │
                      ▼
              返回最终 subject
</code></pre>
<hr/>
<h3 data-id="heading-24">关键方法详解</h3>
<h4 data-id="heading-25">1. intercept() - 注册拦截器</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">intercept</span><span class="hljs-params">(phase: <span class="hljs-type">PipelinePhase</span>, block: <span class="hljs-type">PipelineInterceptor</span>&lt;<span class="hljs-type">TSubject</span>, TContext&gt;)</span></span> {
    <span class="hljs-keyword">val</span> phaseContent = findPhase(phase)
        ?: <span class="hljs-keyword">throw</span> InvalidPhaseException(<span class="hljs-string">"Phase <span class="hljs-variable">$phase</span> was not registered for this pipeline"</span>)

    <span class="hljs-keyword">if</span> (tryAddToPhaseFastPath(phase, block)) {
        interceptorsQuantity++
        <span class="hljs-keyword">return</span>
    }

    phaseContent.addInterceptor(block)
    interceptorsQuantity++
    resetInterceptorsList()

    afterIntercepted()
}
</code></pre>
<p><strong>流程</strong>:</p>
<ol>
<li>查找 Phase 对应的 PhaseContent</li>
<li>尝试快速路径添加（Fast Path）</li>
<li>如果失败，添加到 PhaseContent</li>
<li>增加拦截器计数</li>
<li>重置缓存</li>
<li>调用 <code>afterIntercepted()</code> 钩子</li>
</ol>
<p><strong>快速路径条件</strong>:</p>
<ul>
<li>拦截器列表未共享</li>
<li>添加到最后一个 Phase</li>
<li>或添加到当前共享的 Phase</li>
</ul>
<h4 data-id="heading-26">2. addPhase() - 添加阶段</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addPhase</span><span class="hljs-params">(phase: <span class="hljs-type">PipelinePhase</span>)</span></span> {
    <span class="hljs-keyword">if</span> (hasPhase(phase)) {
        <span class="hljs-keyword">return</span>
    }
    phasesRaw.add(phase)
}
</code></pre>
<p><strong>特点</strong>:</p>
<ul>
<li>添加到末尾</li>
<li>自动去重（如果已存在则忽略）</li>
</ul>
<h4 data-id="heading-27">3. insertPhaseAfter() - 在指定阶段后插入</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">insertPhaseAfter</span><span class="hljs-params">(reference: <span class="hljs-type">PipelinePhase</span>, phase: <span class="hljs-type">PipelinePhase</span>)</span></span> {
    <span class="hljs-keyword">if</span> (hasPhase(phase)) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">val</span> index = findPhaseIndex(reference)
    <span class="hljs-keyword">if</span> (index == -<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">throw</span> InvalidPhaseException(<span class="hljs-string">"Phase <span class="hljs-variable">$reference</span> was not registered for this pipeline"</span>)
    }

    <span class="hljs-comment">// 插入到最后一个 Relation.After(reference) 的阶段之后</span>
    <span class="hljs-keyword">var</span> lastRelatedPhaseIndex = index
    <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> index + <span class="hljs-number">1.</span>.phasesRaw.lastIndex) {
        <span class="hljs-keyword">val</span> relation = (phasesRaw[i] <span class="hljs-keyword">as</span>? PhaseContent&lt;*, *&gt;)?.relation ?: <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">val</span> relatedTo = (relation <span class="hljs-keyword">as</span>? PipelinePhaseRelation.After)?.relativeTo ?: <span class="hljs-keyword">continue</span>
        lastRelatedPhaseIndex = <span class="hljs-keyword">if</span> (relatedTo == reference) i <span class="hljs-keyword">else</span> lastRelatedPhaseIndex
    }

    phasesRaw.add(
        lastRelatedPhaseIndex + <span class="hljs-number">1</span>,
        PhaseContent&lt;TSubject, TContext&gt;(phase, PipelinePhaseRelation.After(reference))
    )
}
</code></pre>
<p><strong>示例</strong>:</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> pipeline = Pipeline&lt;String, <span class="hljs-built_in">Unit</span>&gt;(PhaseA)
pipeline.insertPhaseAfter(PhaseA, PhaseB)
pipeline.insertPhaseAfter(PhaseA, PhaseC)
<span class="hljs-comment">// 结果: [PhaseA, PhaseB, PhaseC]</span>
</code></pre>
<h4 data-id="heading-28">4. insertPhaseBefore() - 在指定阶段前插入</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">insertPhaseBefore</span><span class="hljs-params">(reference: <span class="hljs-type">PipelinePhase</span>, phase: <span class="hljs-type">PipelinePhase</span>)</span></span> {
    <span class="hljs-keyword">if</span> (hasPhase(phase)) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">val</span> index = findPhaseIndex(reference)
    <span class="hljs-keyword">if</span> (index == -<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">throw</span> InvalidPhaseException(<span class="hljs-string">"Phase <span class="hljs-variable">$reference</span> was not registered for this pipeline"</span>)
    }

    phasesRaw.add(index, PhaseContent&lt;TSubject, TContext&gt;(phase, PipelinePhaseRelation.Before(reference)))
}
</code></pre>
<p><strong>示例</strong>:</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> pipeline = Pipeline&lt;String, <span class="hljs-built_in">Unit</span>&gt;(PhaseC)
pipeline.insertPhaseBefore(PhaseC, PhaseA)
pipeline.insertPhaseBefore(PhaseC, PhaseB)
<span class="hljs-comment">// 结果: [PhaseA, PhaseB, PhaseC]</span>
</code></pre>
<h4 data-id="heading-29">5. merge() - 合并管道</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">merge</span><span class="hljs-params">(from: <span class="hljs-type">Pipeline</span>&lt;<span class="hljs-type">TSubject</span>, TContext&gt;)</span></span> {
    <span class="hljs-keyword">if</span> (fastPathMerge(from)) {
        <span class="hljs-keyword">return</span>
    }

    mergePhases(from)
    mergeInterceptors(from)
}
</code></pre>
<p><strong>用途</strong>: 将另一个 Pipeline 的 Phase 和 Interceptor 合并到当前 Pipeline</p>
<p><strong>应用场景</strong>:</p>
<ul>
<li>路由继承父路由的拦截器</li>
<li>插件安装时合并管道</li>
</ul>
<p><strong>快速路径</strong>: 如果当前 Pipeline 为空，直接复制</p>
<h4 data-id="heading-30">6. execute() - 执行管道</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">execute</span><span class="hljs-params">(context: <span class="hljs-type">TContext</span>, subject: <span class="hljs-type">TSubject</span>)</span></span>: TSubject =
    createContext(context, subject, coroutineContext).execute(subject)
</code></pre>
<p><strong>关键点</strong>:</p>
<ol>
<li>创建 <code>PipelineContext</code></li>
<li>获取所有拦截器（缓存或构建）</li>
<li>按顺序执行拦截器</li>
<li>返回最终的 subject</li>
</ol>
<hr/>
<h3 data-id="heading-31">设计模式</h3>
<h4 data-id="heading-32">1. 责任链模式 (Chain of Responsibility)</h4>
<p>Pipeline 是责任链模式的变体：</p>
<ul>
<li><strong>Phase</strong>: 责任链的分组</li>
<li><strong>Interceptor</strong>: 责任链的节点</li>
<li><strong>proceed()</strong>: 传递给下一个节点</li>
</ul>
<p><strong>与传统责任链的区别</strong>:</p>
<ul>
<li>支持异步（协程）</li>
<li>支持修改传递的对象（subject）</li>
<li>支持分阶段组织</li>
</ul>
<h4 data-id="heading-33">2. 模板方法模式 (Template Method)</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Pipeline</span>&lt;<span class="hljs-type">TSubject : Any, TContext : Any</span>&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">afterIntercepted</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 子类可以重写</span>
    }
}
</code></pre>
<p>子类可以重写 <code>afterIntercepted()</code> 来自定义行为。</p>
<h4 data-id="heading-34">3. 策略模式 (Strategy)</h4>
<p>不同的 <code>PipelineContext</code> 实现：</p>
<ul>
<li><code>SuspendFunctionGun</code>: 高性能策略</li>
<li><code>DebugPipelineContext</code>: 调试策略</li>
</ul>
<h4 data-id="heading-35">4. 享元模式 (Flyweight)</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> interceptorsListShared: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>
</code></pre>
<p>多个 Pipeline 共享拦截器列表，减少内存占用。</p>
<h4 data-id="heading-36">5. 写时复制 (Copy-on-Write)</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">copyInterceptors</span><span class="hljs-params">()</span></span> {
    interceptors = copiedInterceptors()
    shared = <span class="hljs-literal">false</span>
}
</code></pre>
<p>只有在修改时才复制，读取时共享。</p>
<hr/>
<h3 data-id="heading-37">实战示例</h3>
<h4 data-id="heading-38">示例 1: 创建简单的 Pipeline</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义 Phase</span>
<span class="hljs-keyword">val</span> Phase1 = PipelinePhase(<span class="hljs-string">"Phase1"</span>)
<span class="hljs-keyword">val</span> Phase2 = PipelinePhase(<span class="hljs-string">"Phase2"</span>)

<span class="hljs-comment">// 创建 Pipeline</span>
<span class="hljs-keyword">val</span> pipeline = Pipeline&lt;String, <span class="hljs-built_in">Unit</span>&gt;(Phase1, Phase2)

<span class="hljs-comment">// 添加拦截器</span>
pipeline.intercept(Phase1) { subject -&gt;
    println(<span class="hljs-string">"Phase1: 处理 <span class="hljs-variable">$subject</span>"</span>)
    proceed() <span class="hljs-comment">// 继续下一个拦截器</span>
}

pipeline.intercept(Phase2) { subject -&gt;
    println(<span class="hljs-string">"Phase2: 处理 <span class="hljs-variable">$subject</span>"</span>)
    <span class="hljs-keyword">val</span> newSubject = subject.uppercase()
    proceedWith(newSubject) <span class="hljs-comment">// 用新的 subject 继续</span>
}

<span class="hljs-comment">// 执行</span>
runBlocking {
    <span class="hljs-keyword">val</span> result = pipeline.execute(<span class="hljs-built_in">Unit</span>, <span class="hljs-string">"hello"</span>)
    println(<span class="hljs-string">"结果: <span class="hljs-variable">$result</span>"</span>) <span class="hljs-comment">// 输出: HELLO</span>
}
</code></pre>
<p><strong>输出</strong>:</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Phase1: 处理 hello</span>
<span class="hljs-section">Phase2: 处理 hello</span>
<span class="hljs-section">结果: HELLO</span>
</code></pre>
<h4 data-id="heading-39">示例 2: 修改 Subject</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Request</span>(<span class="hljs-keyword">var</span> url: String, <span class="hljs-keyword">var</span> headers: MutableMap&lt;String, String&gt; = mutableMapOf())

<span class="hljs-keyword">val</span> pipeline = Pipeline&lt;Request, <span class="hljs-built_in">Unit</span>&gt;(Phase1, Phase2)

pipeline.intercept(Phase1) { request -&gt;
    println(<span class="hljs-string">"添加认证头"</span>)
    request.headers[<span class="hljs-string">"Authorization"</span>] = <span class="hljs-string">"Bearer token123"</span>
    proceed()
}

pipeline.intercept(Phase2) { request -&gt;
    println(<span class="hljs-string">"添加 User-Agent"</span>)
    request.headers[<span class="hljs-string">"User-Agent"</span>] = <span class="hljs-string">"Ktor Client"</span>
    proceed()
}

runBlocking {
    <span class="hljs-keyword">val</span> request = Request(<span class="hljs-string">"https://api.example.com"</span>)
    <span class="hljs-keyword">val</span> result = pipeline.execute(<span class="hljs-built_in">Unit</span>, request)
    println(<span class="hljs-string">"最终请求: <span class="hljs-variable">$result</span>"</span>)
}
</code></pre>
<p><strong>输出</strong>:</p>
<pre><code class="hljs language-sql" lang="sql">添加认证头
添加 <span class="hljs-keyword">User</span><span class="hljs-operator">-</span>Agent
最终请求: Request(url<span class="hljs-operator">=</span>https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>api.example.com, headers<span class="hljs-operator">=</span>{<span class="hljs-keyword">Authorization</span><span class="hljs-operator">=</span>Bearer token123, <span class="hljs-keyword">User</span><span class="hljs-operator">-</span>Agent<span class="hljs-operator">=</span>Ktor Client})
</code></pre>
<h4 data-id="heading-40">示例 3: 提前终止</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">pipeline.intercept(Phase1) { subject -&gt;
    <span class="hljs-keyword">if</span> (subject == <span class="hljs-string">"skip"</span>) {
        println(<span class="hljs-string">"跳过后续处理"</span>)
        finish() <span class="hljs-comment">// 终止管道</span>
        <span class="hljs-keyword">return</span><span class="hljs-symbol">@intercept</span>
    }
    proceed()
}

pipeline.intercept(Phase2) { subject -&gt;
    println(<span class="hljs-string">"Phase2: 这不会被执行"</span>)
    proceed()
}

runBlocking {
    pipeline.execute(<span class="hljs-built_in">Unit</span>, <span class="hljs-string">"skip"</span>)
}
</code></pre>
<p><strong>输出</strong>:</p>
<pre><code class="hljs">跳过后续处理
</code></pre>
<h4 data-id="heading-41">示例 4: 异常处理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">pipeline.intercept(Phase1) { subject -&gt;
    <span class="hljs-keyword">try</span> {
        proceed()
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        println(<span class="hljs-string">"捕获异常: <span class="hljs-subst">${e.message}</span>"</span>)
        <span class="hljs-comment">// 可以选择继续或终止</span>
        finish()
    }
}

pipeline.intercept(Phase2) { subject -&gt;
    <span class="hljs-keyword">throw</span> IllegalStateException(<span class="hljs-string">"出错了！"</span>)
}

runBlocking {
    pipeline.execute(<span class="hljs-built_in">Unit</span>, <span class="hljs-string">"test"</span>)
}
</code></pre>
<h4 data-id="heading-42">示例 5: 实现日志插件</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingPlugin</span> {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> : ApplicationPlugin&lt;ApplicationCallPipeline, Configuration, LoggingPlugin&gt; {
        <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> key = AttributeKey&lt;LoggingPlugin&gt;(<span class="hljs-string">"LoggingPlugin"</span>)

        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">install</span><span class="hljs-params">(
            pipeline: <span class="hljs-type">ApplicationCallPipeline</span>,
            configure: <span class="hljs-type">Configuration</span>.() -&gt; <span class="hljs-type">Unit</span>
        )</span></span>: LoggingPlugin {
            <span class="hljs-keyword">val</span> plugin = LoggingPlugin()

            pipeline.intercept(ApplicationCallPipeline.Monitoring) {
                <span class="hljs-keyword">val</span> start = System.currentTimeMillis()
                println(<span class="hljs-string">"请求开始: <span class="hljs-subst">${call.request.uri}</span>"</span>)

                <span class="hljs-keyword">try</span> {
                    proceed()
                } <span class="hljs-keyword">finally</span> {
                    <span class="hljs-keyword">val</span> duration = System.currentTimeMillis() - start
                    println(<span class="hljs-string">"请求完成: <span class="hljs-subst">${call.request.uri}</span>, 耗时: <span class="hljs-subst">${duration}</span>ms"</span>)
                }
            }

            <span class="hljs-keyword">return</span> plugin
        }
    }

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">Configuration</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-43">性能优化</h3>
<h4 data-id="heading-44">1. 快速路径 (Fast Path)</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">tryAddToPhaseFastPath</span><span class="hljs-params">(
    phase: <span class="hljs-type">PipelinePhase</span>,
    block: <span class="hljs-type">PipelineInterceptor</span>&lt;<span class="hljs-type">TSubject</span>, TContext&gt;
)</span></span>: <span class="hljs-built_in">Boolean</span> {
    <span class="hljs-keyword">val</span> currentInterceptors = interceptors
    <span class="hljs-keyword">if</span> (phasesRaw.isEmpty() || currentInterceptors == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }

    <span class="hljs-keyword">if</span> (interceptorsListShared || currentInterceptors !<span class="hljs-keyword">is</span> MutableList) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }

    <span class="hljs-keyword">if</span> (interceptorsListSharedPhase == phase) {
        currentInterceptors.add(block)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">if</span> (phase == phasesRaw.last() || findPhaseIndex(phase) == phasesRaw.lastIndex) {
        findPhase(phase)!!.addInterceptor(block)
        currentInterceptors.add(block)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<p><strong>优化点</strong>:</p>
<ul>
<li>避免重建拦截器列表</li>
<li>直接添加到现有列表</li>
<li>适用于最常见的场景（添加到最后）</li>
</ul>
<h4 data-id="heading-45">2. 拦截器缓存</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">cacheInterceptors</span><span class="hljs-params">()</span></span>: List&lt;PipelineInterceptor&lt;TSubject, TContext&gt;&gt; {
    <span class="hljs-keyword">val</span> interceptorsQuantity = interceptorsQuantity
    <span class="hljs-keyword">if</span> (interceptorsQuantity == <span class="hljs-number">0</span>) {
        notSharedInterceptorsList(emptyList())
        <span class="hljs-keyword">return</span> emptyList()
    }

    <span class="hljs-comment">// 特殊处理只有一个拦截器的情况</span>
    <span class="hljs-keyword">if</span> (interceptorsQuantity == <span class="hljs-number">1</span>) {
        <span class="hljs-comment">// ... 直接返回，避免创建新列表</span>
    }

    <span class="hljs-comment">// 构建完整列表</span>
    <span class="hljs-keyword">val</span> destination: MutableList&lt;PipelineInterceptor&lt;TSubject, TContext&gt;&gt; = mutableListOf()
    <span class="hljs-keyword">for</span> (phaseIndex <span class="hljs-keyword">in</span> <span class="hljs-number">0.</span>.phases.lastIndex) {
        <span class="hljs-keyword">val</span> phase = phases[phaseIndex] <span class="hljs-keyword">as</span>? PhaseContent&lt;TSubject, TContext&gt; ?: <span class="hljs-keyword">continue</span>
        phase.addTo(destination)
    }

    notSharedInterceptorsList(destination)
    <span class="hljs-keyword">return</span> destination
}
</code></pre>
<p><strong>优化点</strong>:</p>
<ul>
<li>缓存拦截器列表，避免重复构建</li>
<li>特殊处理空列表和单个拦截器</li>
<li>使用 <code>ArrayList.ensureCapacity</code> 预分配容量</li>
</ul>
<h4 data-id="heading-46">3. 共享机制</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setInterceptorsListFromAnotherPipeline</span><span class="hljs-params">(pipeline: <span class="hljs-type">Pipeline</span>&lt;<span class="hljs-type">TSubject</span>, TContext&gt;)</span></span> {
    interceptors = pipeline.sharedInterceptorsList()
    interceptorsListShared = <span class="hljs-literal">true</span>
    interceptorsListSharedPhase = <span class="hljs-literal">null</span>
}
</code></pre>
<p><strong>优化点</strong>:</p>
<ul>
<li>多个 Pipeline 共享拦截器列表</li>
<li>减少内存占用</li>
<li>写时复制策略</li>
</ul>
<h4 data-id="heading-47">4. SuspendFunctionGun</h4>
<p>生产模式下使用 <code>SuspendFunctionGun</code> 而不是 <code>DebugPipelineContext</code>：</p>
<ul>
<li>更少的对象分配</li>
<li>更快的执行速度</li>
<li>牺牲了堆栈信息的可读性</li>
</ul>
<hr/>
<h3 data-id="heading-48">常见问题</h3>
<h4 data-id="heading-49">Q1: 为什么需要 Phase？</h4>
<p><strong>A</strong>: Phase 提供了<strong>逻辑分组</strong>和<strong>执行顺序保证</strong>。</p>
<p>没有 Phase 的问题：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 无法保证执行顺序</span>
pipeline.intercept { <span class="hljs-comment">/* 认证 */</span> }
pipeline.intercept { <span class="hljs-comment">/* 日志 */</span> }
pipeline.intercept { <span class="hljs-comment">/* 业务逻辑 */</span> }
</code></pre>
<p>有 Phase 的好处：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 明确的执行顺序</span>
pipeline.intercept(Monitoring) { <span class="hljs-comment">/* 日志 */</span> }
pipeline.intercept(Plugins) { <span class="hljs-comment">/* 认证 */</span> }
pipeline.intercept(Call) { <span class="hljs-comment">/* 业务逻辑 */</span> }
</code></pre>
<h4 data-id="heading-50">Q2: proceed() 和 proceedWith() 的区别？</h4>
<p><strong>A</strong>:</p>
<ul>
<li><code>proceed()</code>: 使用当前 subject 继续</li>
<li><code>proceedWith(newSubject)</code>: 使用新的 subject 继续</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">pipeline.intercept(Phase1) { subject -&gt;
    <span class="hljs-comment">// 修改 subject 的属性</span>
    subject.modified = <span class="hljs-literal">true</span>
    proceed() <span class="hljs-comment">// 传递修改后的 subject</span>
}

pipeline.intercept(Phase2) { subject -&gt;
    <span class="hljs-comment">// 替换整个 subject</span>
    <span class="hljs-keyword">val</span> newSubject = transform(subject)
    proceedWith(newSubject) <span class="hljs-comment">// 传递新的 subject</span>
}
</code></pre>
<h4 data-id="heading-51">Q3: 什么时候调用 finish()？</h4>
<p><strong>A</strong>: 当你想<strong>提前终止管道执行</strong>时调用 <code>finish()</code>。</p>
<p>常见场景：</p>
<ul>
<li>认证失败，直接返回 401</li>
<li>缓存命中，直接返回缓存数据</li>
<li>请求验证失败</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">pipeline.intercept(Plugins) {
    <span class="hljs-keyword">if</span> (!isAuthenticated()) {
        call.respond(HttpStatusCode.Unauthorized)
        finish() <span class="hljs-comment">// 终止后续处理</span>
        <span class="hljs-keyword">return</span><span class="hljs-symbol">@intercept</span>
    }
    proceed()
}
</code></pre>
<h4 data-id="heading-52">Q4: 如何调试 Pipeline？</h4>
<p><strong>A</strong>: 启用开发模式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> pipeline = <span class="hljs-keyword">object</span> : Pipeline&lt;String, <span class="hljs-built_in">Unit</span>&gt;(Phase1, Phase2) {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> developmentMode: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">true</span>
}
</code></pre>
<p>或者使用日志拦截器：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">pipeline.intercept(Phase1) { subject -&gt;
    println(<span class="hljs-string">"进入 Phase1, subject=<span class="hljs-variable">$subject</span>"</span>)
    proceed()
    println(<span class="hljs-string">"离开 Phase1"</span>)
}
</code></pre>
<h4 data-id="heading-53">Q5: Pipeline 是线程安全的吗？</h4>
<p><strong>A</strong>:</p>
<ul>
<li><strong>构建阶段</strong>（添加 Phase 和 Interceptor）：<strong>不是线程安全的</strong></li>
<li><strong>执行阶段</strong>（execute）：<strong>是线程安全的</strong></li>
</ul>
<p>建议：</p>
<ul>
<li>在应用启动时构建 Pipeline</li>
<li>运行时只执行，不修改</li>
</ul>
<h4 data-id="heading-54">Q6: 如何实现条件拦截？</h4>
<p><strong>A</strong>: 使用类型检查或条件判断：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 方式 1: 类型检查</span>
pipeline.intercept&lt;SpecificType, Context&gt;(Phase1) { subject -&gt;
    <span class="hljs-comment">// 只处理 SpecificType</span>
    proceed()
}

<span class="hljs-comment">// 方式 2: 条件判断</span>
pipeline.intercept(Phase1) { subject -&gt;
    <span class="hljs-keyword">if</span> (shouldProcess(subject)) {
        <span class="hljs-comment">// 处理</span>
    }
    proceed()
}
</code></pre>
<hr/>
<h3 data-id="heading-55">总结</h3>
<h4 data-id="heading-56">核心要点</h4>
<ol>
<li><strong>Pipeline 是 Ktor 的核心机制</strong>，理解它是掌握 Ktor 的关键</li>
<li><strong>Phase 提供执行顺序</strong>，Interceptor 提供处理逻辑</li>
<li><strong>proceed() 是关键</strong>，它连接了整个责任链</li>
<li><strong>性能优化</strong>：快速路径、缓存、共享机制</li>
<li><strong>灵活性</strong>：可以修改 subject、提前终止、异常处理</li>
</ol>
<h3 data-id="heading-57">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fktor.io%2Fdocs%2Fpipelines.html" target="_blank" title="https://ktor.io/docs/pipelines.html" ref="nofollow noopener noreferrer">Ktor 官方文档 - Pipeline</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fktorio%2Fktor%2Fblob%2Fmain%2Fktor-utils%2Fcommon%2Fsrc%2Fio%2Fktor%2Futil%2Fpipeline%2FPipeline.kt" target="_blank" title="https://github.com/ktorio/ktor/blob/main/ktor-utils/common/src/io/ktor/util/pipeline/Pipeline.kt" ref="nofollow noopener noreferrer">源码位置</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fcoroutines-overview.html" target="_blank" title="https://kotlinlang.org/docs/coroutines-overview.html" ref="nofollow noopener noreferrer">Kotlin 协程文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在DevTools选中调试一个实时交互才能显示的元素样式]]></title>    <link>https://juejin.cn/post/7576484465759649827</link>    <guid>https://juejin.cn/post/7576484465759649827</guid>    <pubDate>2025-11-26T02:05:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576484465759649827" data-draft-id="7576477793778974760" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在DevTools选中调试一个实时交互才能显示的元素样式"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2025-11-26T02:05:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xump"/> <meta itemprop="url" content="https://juejin.cn/user/3824530640871996"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在DevTools选中调试一个实时交互才能显示的元素样式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3824530640871996/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xump
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:05:08.000Z" title="Wed Nov 26 2025 02:05:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">常见的会消失元素</h2>
<p>如果你对下列的元素该如何在浏览器调试过程中选中有问题，那就继续看下去吧。</p>
<ol>
<li>
<p>通过设置 伪类(<code>:hover</code>、<code>:focus</code> 等) 来控制显隐的元素</p>
</li>
<li>
<p>设置了动画的元素</p>
</li>
<li>
<p>通过一些事件(鼠标移入移出、点击、聚焦、触发键盘按键等)控制的元素</p>
<ul>
<li>在 css 层面控制，通过在一些事件触发时给特定元素设置类样式</li>
<li>在渲染层面控制，通过一些事件触发控制该元素是否渲染（是否在 DOM 树中）</li>
</ul>
</li>
</ol>
<p>通常这些元素是动态显隐的，且较有实时性，同时还参杂着用户的交互行为，所以当我们需要在浏览器对该元素的样式之类的进行调试时，如何选中该元素就成问题了。</p>
<h2 data-id="heading-1">场景及解决方案</h2>
<h3 data-id="heading-2">以Element-plus 的 tooltip 组件为例</h3>
<p>在 Element-plus 的 <code>tooltip</code> 组件中</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85f2094ea5734cd8b5cd9018f74889e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeHVtcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764727508&amp;x-signature=P6KwzX5%2BnWilF%2FpFhTnqmH1V%2BNw%3D" alt="{B7A2153F-1D26-4191-BE64-37063E31A83E}.png" loading="lazy"/>
从控制台中我们可以看到，<code>tooltip</code> 提示框的显隐是通过 <code>v-if</code> 来控制，当我们鼠标移入时，元素被渲染，移出时元素被移除。在这种情况下，我想要选中 tip 弹出框就变得不那么容易了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de77bbce12b44fa7a66612bd95da2346~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeHVtcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764727508&amp;x-signature=szF3SyMQWBOuwRYCuJ76VX85USk%3D" alt="GIF 2025-7-4 14-51-27.gif" loading="lazy"/></p>
<h4 data-id="heading-3">通过移除事件</h4>
<p>遇到这种问题，我们可以想到的是从它的内部实现去入手了，可以得知的是，<code>tooltip</code> 组件的 tip 是通过监听鼠标事件来完成了，所以一开始可以想到的办法是通过移出其鼠标事件的方式来完成。 <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be8ff14fcc874ed0b5ac85c2468835b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeHVtcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764727508&amp;x-signature=0GAkamSwebH4ba0UiGp0zl39XLI%3D" alt="{38632477-0D39-402B-AB60-08E827F8191C}.png" loading="lazy"/>
通过查看该按钮的事件列表，找到其 <code>mouseleave</code> 事件，并将其删除。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57071569ab834cf5a121236034439e07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeHVtcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764727508&amp;x-signature=S9u6p%2B8uF3LaGleEqfcVWKyPLXY%3D" alt="{26AD81D9-578D-447C-BB43-59C537BE5BCC}.png" loading="lazy"/></p>
<p>此时我们就可以选中该元素了</p>
<h4 data-id="heading-4">通过设置 DOM 变动断点</h4>
<p>在 chrome 中可以对 DOM 元素的一些变化进行断点调试，我们可以在 <strong>Elements</strong> 选项卡中右键元素，有一个 <code>Break on</code> 选项，<code>Break on</code> 可以让你在 JS 修改某个 DOM 元素时，自动暂停代码执行（进入调试），并且告诉你 是哪个 JS 操作改动了 DOM。其有三种类型，分别是：</p>
<ol>
<li><code>Subtree modifications</code>：子元素有新增、删除、顺序改变等</li>
<li><code>Attributes modifications</code>：元素属性变化（包括 <code>class</code>、<code>id</code>、<code>style</code> 等）</li>
<li><code>Node removal</code>：元素本身被删除</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a58012bffe3d4f67ab18849c1717d254~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeHVtcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764727508&amp;x-signature=0Je9LcezsYRnQA%2BGVPgt8bJZ0ws%3D" alt="{7D86B7CE-94BD-4A1A-9082-4E321AE9BCF8}.png" loading="lazy"/></p>
<p>我们知道触发 <code>debugger</code> 会暂停 JS 执行，动画、交互、JS 驱动的渲染则会暂停，直到你手动继续调试。</p>
<p>利用 <code>Break on</code> 的功能我们就可以在断点期间对我们想要的元素进行选中调试了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25c8f6779bfa4f2c8762180ee6c90db7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeHVtcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764727508&amp;x-signature=Yr4%2F%2B7lUwCkWvxDkfQkFHyDUYgI%3D" alt="{DF8C0B06-6116-4386-9605-9069F55873BF}.png" loading="lazy"/></p>
<h4 data-id="heading-5">通过控制台 debugger;</h4>
<p>除了通过设置 DOM 变动断点的来暂停页面获取元素外，我们还可以通过手动 <code>debugger</code> 的方式进行暂停页面操作。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a58b47cef2741d392e79d351511e897~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeHVtcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764727508&amp;x-signature=zFbKBUNwSpSdKrwAy455fuK5CYU%3D" alt="GIF 2025-7-4 16-05-10.gif" loading="lazy"/></p>
<p>上例中我们使用了 <code>setTimeout(()=&gt;{debugger;},3000)</code> 设置了一个 <code>3s</code> 的 <code>debugger</code> 定时器，在这 <code>3s</code> 中我们只需要做到元素出现的交互就可以了，等触发了 debugger 页面停住后就可以对我们需要的元素进行选中调试了。</p>
<p>利用这种 <code>debugger</code> 的方式可以选中大部分会消失的元素包括伪类、动画、js 控制的元素。</p>
<h3 data-id="heading-6">总结</h3>
<p>在我们前端开发中，调试那些由 <code>:hover</code>、动画或 JS 事件控制的动态显示元素是一个常见场景。<strong>Chrome DevTools</strong> 提供了多种技巧来“冻结”页面状态，从而允许我们检查这些稍纵即逝的元素。</p>
<h4 data-id="heading-7">1. 利用 DevTools 强制状态 / 伪类</h4>
<p>对于由 CSS 伪类控制的元素（如 <code>:hover</code>, <code>:focus</code>, <code>:active</code>, <code>:visited</code> 等），这是最直接、最简单的方法。</p>
<ul>
<li>
<p><strong>操作：</strong></p>
<ol>
<li>在 <strong>Elements (元素)</strong> 选项卡中，选中触发动态显示的<strong>父元素或目标元素</strong>。</li>
<li>点击 Styles 面板右上角的 <strong><code>:hov</code></strong>（Toggle Element State）按钮。</li>
<li>勾选相应的伪类（例如 <code>:hover</code>）。</li>
</ol>
</li>
<li>
<p><strong>效果：</strong> 浏览器将强制该元素保持在指定的伪类状态，使其保持可见和可检查。</p>
</li>
</ul>
<h4 data-id="heading-8">2. 通过设置 DOM 变动断点（针对 JS 移除 DOM）</h4>
<p>当元素是通过 JavaScript 事件（如 <code>mouseleave</code> 或计时器）从 DOM 树中移除时，此方法特别有效。</p>
<ul>
<li>
<p><strong>操作：</strong></p>
<ol>
<li>找到即将被删除或修改的<strong>父元素</strong>（例如 <code>tooltip</code> 的外部容器）。</li>
<li>在 <strong>Elements (元素)</strong> 面板中，右键点击该元素，选择 <strong>Break on (断点)</strong> 。</li>
<li>选择 <strong>Node removal (节点移除)</strong> 或 <strong>Subtree modifications (子树修改)</strong> 。</li>
</ol>
</li>
<li>
<p><strong>效果：</strong> 当 JS 代码尝试删除或修改该 DOM 元素时，执行会暂停，页面状态被冻结，您可以在 Sources 面板中查看调用栈并检查 Elements 状态。</p>
</li>
</ul>
<h4 data-id="heading-9">3. 使用 <code>debugger;</code> 命令冻结页面（较为通用的方法）</h4>
<p>这是最通用的方法，适用于任何由 JS 控制显隐的元素，包括那些使用 <code>v-if</code> 控制渲染的场景。</p>
<ul>
<li>
<p><strong>操作：</strong></p>
<ol>
<li>
<p>在 <strong>Console (控制台)</strong> 中，输入一个延迟执行的 <code>debugger;</code> 命令，例如：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">debugger</span>; }, <span class="hljs-number">3000</span>); <span class="hljs-comment">// 3秒后暂停</span>
</code></pre>
</li>
<li>
<p>在定时器生效的这段时间（3秒内），执行触发元素出现的交互动作（例如鼠标移入）。</p>
</li>
<li>
<p>当计时器结束，<code>debugger;</code> 被执行，页面将立即暂停并进入调试状态。</p>
</li>
</ol>
</li>
<li>
<p><strong>效果：</strong> 整个页面的 JS 执行（包括动画、计时器和事件监听）都会停止，元素被“定格”在当前状态，您可以轻松地在 Elements 面板中选中它并进行样式调试。</p>
</li>
</ul>
<p>参考来源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.chrome.com%2Fblog%2Fdevtools-tips-35" target="_blank" title="https://developer.chrome.com/blog/devtools-tips-35" ref="nofollow noopener noreferrer">Freeze screen &amp; inspect disappearing elements</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1688图片搜索API | 上传图片秒找同款 | 相似商品精准推荐]]></title>    <link>https://juejin.cn/post/7576556950331457536</link>    <guid>https://juejin.cn/post/7576556950331457536</guid>    <pubDate>2025-11-26T02:27:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576556950331457536" data-draft-id="7576569518261436416" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1688图片搜索API | 上传图片秒找同款 | 相似商品精准推荐"/> <meta itemprop="keywords" content="数据挖掘,大数据,图片资源"/> <meta itemprop="datePublished" content="2025-11-26T02:27:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户19970108018"/> <meta itemprop="url" content="https://juejin.cn/user/1986149710839467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1688图片搜索API | 上传图片秒找同款 | 相似商品精准推荐
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1986149710839467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户19970108018
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:27:08.000Z" title="Wed Nov 26 2025 02:27:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一、摘要<br/>
1688图片搜索API是阿里巴巴旗下B2B平台提供的基于图像识别的商品搜索服务。通过上传商品图片，开发者可以快速在1688海量商品库中找到相似或同款商品，极大提升采购效率和用户体验。<br/>
二、接口概述<br/>
1.基本参数<br/>
‌请求方式‌: POST  GET HTTP<br/>
‌数据格式‌: multipart/form-data<br/>
2.请求参数</p>
<pre><code class="hljs language-ruby" lang="ruby">请求参数：imgid=<span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/g-search3.alicdn.com/img</span><span class="hljs-regexp">/bao/uploaded</span><span class="hljs-regexp">/i4/</span><span class="hljs-title class_">O1CN01IDpcD81zHbpHs1Yg</span>T_!!<span class="hljs-number">2200811456689</span>.jpg

参数说明：<span class="hljs-symbol">imgid:</span>图片地址（仅支持url）  
如<span class="hljs-symbol">:https</span><span class="hljs-symbol">://img</span>.alicdn.com/imgextra/i3/<span class="hljs-number">15353738</span>/<span class="hljs-title class_">TB2HDHAqN9YBuNjy0FfXXXIsVXa</span>_!!<span class="hljs-number">15353738</span>-<span class="hljs-number">0</span>-beehive-scenes.jpg  
<span class="hljs-symbol">sort:</span>排序[bid2,_bid2,_sale,sale]  
  (<span class="hljs-symbol">bid2:</span>总价,<span class="hljs-symbol">sale:</span>销量,,加_前缀为从大到小排序)
</code></pre>
<p>3.公共请求地址：c0b.cc/R4rbK2。</p>
<p>三、Python请求示例<br/>
以下为调用该API的Python实现示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># coding:utf-8</span>
<span class="hljs-string">"""
Compatible for python2.x and python3.x
requirement: pip install requests
"""</span>
<span class="hljs-keyword">from</span> __future__ <span class="hljs-keyword">import</span> print_function
<span class="hljs-keyword">import</span> requests
<span class="hljs-comment"># 配置参数 API_URL = "c0b.cc/R4rbK2 wechatid:Taobaoapi2014 " </span>
app_key = <span class="hljs-string">"YOUR_APP_KEY"</span> img <span class="hljs-built_in">id</span> = <span class="hljs-string">"图片地址"</span> <span class="hljs-comment"># 目标图片地址</span>
<span class="hljs-comment"># 请求示例 url 默认请求参数已经做URL编码</span>
url = <span class="hljs-string">"1688/item_search_img/?key=&lt;您自己的apiKey&gt;&amp;imgid=图片地址="</span>
headers = {
    <span class="hljs-string">"Accept-Encoding"</span>: <span class="hljs-string">"gzip"</span>,
    <span class="hljs-string">"Connection"</span>: <span class="hljs-string">"close"</span>
}
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    r = requests.get(url, headers=headers)
    json_obj = r.json()
    <span class="hljs-built_in">print</span>(json_obj)


</code></pre>
<h2 data-id="heading-0">四、结语</h2>
<p>1688图片搜索API为电商开发者和采购人员提供了强大的图像识别搜索能力，通过简单的API调用即可实现：</p>
<ul>
<li>快速找到同款商品进行比价</li>
<li>批量处理商品图片搜索需求</li>
<li>集成到采购系统和电商平台中</li>
</ul>
<p>使用建议：</p>
<ul>
<li>确保图片清晰、背景简洁</li>
<li>选择合适的商品分类提高准确率</li>
<li>合理设置分页参数优化性能</li>
<li>处理API返回的错误码和异常情况</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JVM 内存结构深度解析（上篇）：核心原理与运行时数据区]]></title>    <link>https://juejin.cn/post/7576476897950760987</link>    <guid>https://juejin.cn/post/7576476897950760987</guid>    <pubDate>2025-11-25T16:59:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576476897950760987" data-draft-id="7576537005133021211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JVM 内存结构深度解析（上篇）：核心原理与运行时数据区"/> <meta itemprop="keywords" content="JVM"/> <meta itemprop="datePublished" content="2025-11-25T16:59:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大头an"/> <meta itemprop="url" content="https://juejin.cn/user/618374030438861"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JVM 内存结构深度解析（上篇）：核心原理与运行时数据区
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/618374030438861/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大头an
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T16:59:10.000Z" title="Tue Nov 25 2025 16:59:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：从一次内存泄漏排查说起</h2>
<blockquote>
<p>最近排查一个线上服务的内存泄漏问题：服务运行一段时间后就会出现 <code>OutOfMemoryError: Java heap space</code> 错误。通过内存dump分析，发现是某个静态集合中持续添加数据却从未清理。这个经历让我深刻认识到，理解 JVM 内存结构对于解决实际问题有多么重要。</p>
</blockquote>
<h2 data-id="heading-1">1. JVM 内存结构全景图</h2>
<p>Java 虚拟机（JVM）的内存空间分为 5 个主要部分，理解这个结构是掌握 Java 性能优化的基础：</p>
<ul>
<li><strong>程序计数器</strong> - 线程执行的指令指针</li>
<li><strong>Java 虚拟机栈</strong> - 方法调用的栈帧存储</li>
<li><strong>本地方法栈</strong> - Native 方法调用栈</li>
<li><strong>堆</strong> - 对象实例存储区</li>
<li><strong>方法区</strong> - 类信息、常量等元数据存储</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[JVM 内存结构] --&gt; B[JVM 虚拟机数据区]
    A --&gt; C[本地内存]
    
    B --&gt; D[线程隔离区域]
    B --&gt; E[线程共享区域]
    
    D --&gt; F[程序计数器]
    D --&gt; G[Java 虚拟机栈]
    D --&gt; H[本地方法栈]
    
    E --&gt; I[堆]
    E --&gt; J[方法区]
    
    C --&gt; K[元数据区]
    C --&gt; L[直接内存]
    
    style F fill:#e1f5fe
    style G fill:#e1f5fe
    style H fill:#e1f5fe
    style I fill:#f3e5f5
    style J fill:#f3e5f5
    style K fill:#e8f5e8
    style L fill:#e8f5e8
</code></pre>
<blockquote>
<p><strong>🚀 JDK 1.8 的重要变化</strong>：元数据区取代了永久代。元空间的本质和永久代类似，都是对 JVM 规范中方法区的实现。不过元空间与永久代之间最大的区别在于：元数据空间并不在虚拟机中，而是使用本地内存。</p>
</blockquote>
<p><strong>🔍 实践提示</strong>：这个变化意味着在 JDK 1.8+ 中，<code>PermGen space</code> 错误变成了 <code>Metaspace</code> 错误，且 Metaspace 默认没有大小限制，需要手动设置 <code>-XX:MaxMetaspaceSize</code>。</p>
<h2 data-id="heading-2">2. 程序计数器（PC 寄存器）</h2>
<h3 data-id="heading-3">2.1 定义与作用</h3>
<p>程序计数器是一块较小的内存空间，是当前线程正在执行的那条字节码指令的地址。若当前线程正在执行的是一个本地方法，那么此时程序计数器为 <code>Undefined</code>。</p>
<p><strong>核心作用</strong>：</p>
<ul>
<li>字节码解释器通过改变程序计数器来依次读取指令，实现代码流程控制</li>
<li>在多线程情况下，记录当前线程执行位置，实现线程切换后的恢复</li>
</ul>
<h3 data-id="heading-4">2.2 特点</h3>
<ul>
<li>线程私有，每条线程都有自己的程序计数器</li>
<li>生命周期与线程相同</li>
<li>唯一一个不会出现 <code>OutOfMemoryError</code> 的内存区域</li>
</ul>
<p><strong>💡 思考题</strong>：为什么程序计数器是线程私有的？<br/>
因为多线程是通过轮流切换并分配处理器执行时间的方式实现的，在任何一个确定的时刻，一个处理器都只会执行一条线程中的指令。</p>
<h2 data-id="heading-5">3. Java 虚拟机栈（Java 栈）</h2>
<h3 data-id="heading-6">3.1 栈帧结构详解</h3>
<p>Java 虚拟机栈会为每一个即将运行的 Java 方法创建"栈帧"区域，这是理解方法执行机制的关键：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[Java 虚拟机栈] --&gt; B[栈帧N]
    A --&gt; C[...]
    A --&gt; D[栈帧1]
    A --&gt; E[当前栈帧]
    
    E --&gt; F[局部变量表]
    E --&gt; G[操作数栈]
    E --&gt; H[动态链接]
    E --&gt; I[方法出口信息]
    
    F --&gt; J[八大原始类型]
    F --&gt; K[对象引用]
    F --&gt; L[returnAddress]
    
    style E fill:#fff3e0
</code></pre>
<p><strong>📝 代码示例：观察栈帧变化</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StackFrameDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> add(a, b);
        System.out.println(<span class="hljs-string">"Result: "</span> + result);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> x, <span class="hljs-type">int</span> y)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> x + y;
        <span class="hljs-keyword">return</span> sum;
    }
}
</code></pre>
<p>在这个例子中：</p>
<ul>
<li><code>main</code> 方法创建第一个栈帧</li>
<li>调用 <code>add</code> 方法时创建新的栈帧</li>
<li><code>add</code> 方法返回后，其栈帧被销毁</li>
</ul>
<h3 data-id="heading-7">3.2 局部变量表深度解析</h3>
<p>局部变量表是栈帧中最重要的组成部分之一：</p>
<ul>
<li><strong>存储内容</strong>：方法参数和方法内部定义的局部变量</li>
<li><strong>存储单元</strong>：基本单元是 Slot（32位占1个，64位占2个）</li>
<li><strong>特殊变量</strong>：<code>this</code> 引用存放在 index 为 0 的 slot</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalVariableTableDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">(String param, <span class="hljs-type">int</span> count)</span> {
        <span class="hljs-comment">// 局部变量表结构：</span>
        <span class="hljs-comment">// slot 0: this引用</span>
        <span class="hljs-comment">// slot 1: param (String引用)</span>
        <span class="hljs-comment">// slot 2: count (int)</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">localStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">"hello"</span>;  <span class="hljs-comment">// slot 3</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">localLong</span> <span class="hljs-operator">=</span> <span class="hljs-number">100L</span>;      <span class="hljs-comment">// slot 4-5 (64位占2个slot)</span>
        
        System.out.println(localStr);
    }
}
</code></pre>
<h3 data-id="heading-8">3.3 操作数栈的工作原理</h3>
<p>操作数栈是方法执行的工作区，具有以下特点：</p>
<ul>
<li><strong>LIFO结构</strong>：后进先出的栈结构</li>
<li><strong>类型敏感</strong>：32bit类型占用1个深度，64bit类型占用2个深度</li>
<li><strong>栈顶缓存</strong>：通过物理CPU寄存器缓存栈顶元素提升性能</li>
</ul>
<h3 data-id="heading-9">3.4 方法调用与绑定机制</h3>
<p><strong>方法链接类型</strong>：</p>
<ul>
<li><strong>静态链接</strong>：编译期可知，运行期不变</li>
<li><strong>动态链接</strong>：运行期确定具体方法</li>
</ul>
<p><strong>方法绑定</strong>：</p>
<ul>
<li><strong>早期绑定</strong>：编译期确定方法版本</li>
<li><strong>晚期绑定</strong>：运行期根据实际类型绑定</li>
</ul>
<p><strong>虚方法表</strong>：为了提高性能，JVM 为每个类在方法区维护一个虚方法表，使用索引表来代替查找。</p>
<h3 data-id="heading-10">3.5 虚拟机栈的异常处理</h3>
<p><strong>🛠️ 实战：诊断栈溢出</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 递归调用导致 StackOverflowError</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StackOverflowExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-variable">depth</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recursiveMethod</span><span class="hljs-params">()</span> {
        depth++;
        System.out.println(<span class="hljs-string">"Current depth: "</span> + depth);
        recursiveMethod();  <span class="hljs-comment">// 无限递归</span>
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> {
            recursiveMethod();
        } <span class="hljs-keyword">catch</span> (StackOverflowError e) {
            System.out.println(<span class="hljs-string">"Stack overflow at depth: "</span> + depth);
            e.printStackTrace();
        }
    }
}
</code></pre>
<p><strong>解决方案</strong>：</p>
<ul>
<li>检查递归的终止条件</li>
<li>使用 <code>-Xss</code> 参数增加栈大小</li>
<li>考虑使用迭代替代递归</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 调整栈大小参数示例</span>
java -Xss2m StackOverflowExample  <span class="hljs-comment"># 设置栈大小为2MB</span>
</code></pre>
<h2 data-id="heading-11">4. 本地方法栈（C 栈）</h2>
<p>本地方法栈与 Java 虚拟机栈功能相似，但服务于 Native 方法：</p>
<ul>
<li><strong>服务对象</strong>：Native 方法（通常用 C/C++ 实现）</li>
<li><strong>栈帧结构</strong>：包含局部变量表、操作数栈等类似结构</li>
<li><strong>异常类型</strong>：同样会出现 <code>StackOverflowError</code> 和 <code>OutOfMemoryError</code></li>
</ul>
<h2 data-id="heading-12">5. 方法区与运行时常量池</h2>
<h3 data-id="heading-13">5.1 方法区的演进历程</h3>
<p>方法区的实现经历了重要演变：</p>
<ul>
<li><strong>JDK 1.6及之前</strong>：永久代（PermGen）实现</li>
<li><strong>JDK 1.7</strong>：部分数据移到堆中</li>
<li><strong>JDK 1.8+</strong>：元空间（Metaspace）实现，使用本地内存</li>
</ul>
<h3 data-id="heading-14">5.2 方法区存储内容详解</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[方法区] --&gt; B[类型信息]
    A --&gt; C[运行时常量池]
    A --&gt; D[静态变量]
    A --&gt; E[即时编译器编译后代码]
    
    B --&gt; F[类版本]
    B --&gt; G[字段]
    B --&gt; H[方法]
    B --&gt; I[接口等描述信息]
    
    C --&gt; J[字面量]
    C --&gt; K[符号引用]
    C --&gt; L[方法和字段引用]
    
    style A fill:#f3e5f5
</code></pre>
<h3 data-id="heading-15">5.3 运行时常量池深度解析</h3>
<p>运行时常量池是 Class 文件中常量池表的运行时表现：</p>
<p><strong>存储内容</strong>：</p>
<ul>
<li>字面量：字符串、final常量等</li>
<li>符号引用：类和接口的全限定名、字段名称和描述符、方法名称和描述符</li>
</ul>
<p><strong>动态性</strong>：运行期间可以向常量池中添加新的常量</p>
<p><strong>🔍 String Table 优化实战</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StringTableDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 这些字符串都会进入字符串常量池</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">s1</span> <span class="hljs-operator">=</span> <span class="hljs-string">"java"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">s2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"java"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">s3</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(<span class="hljs-string">"java"</span>).intern();
        
        System.out.println(<span class="hljs-string">"s1 == s2: "</span> + (s1 == s2)); <span class="hljs-comment">// true</span>
        System.out.println(<span class="hljs-string">"s1 == s3: "</span> + (s1 == s3)); <span class="hljs-comment">// true</span>
        
        <span class="hljs-comment">// 大字符串处理的注意事项</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">largeString</span> <span class="hljs-operator">=</span> createLargeString();
        <span class="hljs-comment">// 谨慎使用 intern()，可能导致内存溢出</span>
        <span class="hljs-comment">// String interned = largeString.intern(); </span>
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">createLargeString</span><span class="hljs-params">()</span> {
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
            sb.append(<span class="hljs-string">"large string data "</span>);
        }
        <span class="hljs-keyword">return</span> sb.toString();
    }
}
</code></pre>
<h3 data-id="heading-16">5.4 方法区参数配置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># JDK 1.7及之前（永久代）</span>
-XX:PermSize=128m
-XX:MaxPermSize=512m

<span class="hljs-comment"># JDK 1.8+（元空间）</span>
-XX:MetaspaceSize=128m
-XX:MaxMetaspaceSize=512m
</code></pre>
<h2 data-id="heading-17">6. 直接内存（堆外内存）</h2>
<h3 data-id="heading-18">6.1 直接内存的优势</h3>
<p>直接内存并不是虚拟机运行时数据区的一部分，但在 NIO 操作中发挥重要作用：</p>
<p><strong>性能优势</strong>：</p>
<ul>
<li>避免 Java 堆和 Native 堆之间来回复制数据</li>
<li>直接在本地内存进行操作，提升 IO 效率</li>
</ul>
<h3 data-id="heading-19">6.2 直接内存的使用场景</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DirectMemoryDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">100</span>; <span class="hljs-comment">// 100MB</span>
        
        <span class="hljs-comment">// 分配直接内存</span>
        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">directBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocateDirect(size);
        
        <span class="hljs-comment">// 分配堆内存</span>
        <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">heapBuffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocate(size);
        
        <span class="hljs-comment">// 性能对比测试</span>
        testPerformance(directBuffer, <span class="hljs-string">"DirectBuffer"</span>);
        testPerformance(heapBuffer, <span class="hljs-string">"HeapBuffer"</span>);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testPerformance</span><span class="hljs-params">(ByteBuffer buffer, String type)</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000</span>; j++) {
                buffer.putInt(j);
            }
            buffer.clear();
        }
        <span class="hljs-type">long</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;
        System.out.println(type + <span class="hljs-string">" Time: "</span> + time + <span class="hljs-string">"ms"</span>);
    }
}
</code></pre>
<h2 data-id="heading-20">本章总结</h2>
<h3 data-id="heading-21">✅ 核心知识点回顾</h3>
<ol>
<li><strong>程序计数器</strong>：线程执行的指令指针，线程私有</li>
<li><strong>Java 虚拟机栈</strong>：方法调用的栈帧存储，包含局部变量表、操作数栈等</li>
<li><strong>本地方法栈</strong>：Native 方法的调用栈</li>
<li><strong>方法区</strong>：类信息、运行时常量池等元数据存储</li>
<li><strong>直接内存</strong>：堆外内存，提升 NIO 性能</li>
</ol>
<h3 data-id="heading-22">🎯 重点理解</h3>
<ul>
<li>线程私有区域：程序计数器、Java 虚拟机栈、本地方法栈</li>
<li>线程共享区域：堆、方法区</li>
<li>JDK 版本演进对内存结构的影响</li>
<li>各区域可能出现的异常及处理方法</li>
</ul>
<h3 data-id="heading-23">📚 下篇预告</h3>
<p>在下篇中，我们将深入探讨：</p>
<ul>
<li>堆内存的详细结构和对象分配过程</li>
<li>垃圾回收机制和算法</li>
<li>内存监控工具和性能调优实战</li>
<li>常见内存问题的排查和解决方案</li>
</ul>
<hr/>
<p><strong>动手实验</strong>：</p>
<ol>
<li>编写一个会产生栈溢出的程序，观察错误信息</li>
<li>测试不同字符串创建方式对常量池的影响</li>
<li>对比直接内存和堆内存的IO性能差异</li>
</ol>
<p>欢迎在评论区分享你的实验结果和遇到的问题！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[双向循环带头链表详解]]></title>    <link>https://juejin.cn/post/7576532425762570255</link>    <guid>https://juejin.cn/post/7576532425762570255</guid>    <pubDate>2025-11-26T02:29:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576532425762570255" data-draft-id="7576532425762553871" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="双向循环带头链表详解"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T02:29:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有风63"/> <meta itemprop="url" content="https://juejin.cn/user/1892682130797704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            双向循环带头链表详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1892682130797704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有风63
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:29:52.000Z" title="Wed Nov 26 2025 02:29:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">链表类型概述</h2>
<p>链表作为基础数据结构，根据不同的特性组合可以分为多种类型。主要分类维度包括：</p>
<ul>
<li><strong>单向 vs 双向</strong>：节点指针指向单一方向还是可以双向访问</li>
<li><strong>循环 vs 非循环</strong>：尾节点是否指向头节点形成闭环</li>
<li><strong>带头节点 vs 不带头节点</strong>：是否存在不存储数据的哨兵节点</li>
</ul>
<p>我们之前学习的单链表属于<strong>单向不循环无头节点</strong>链表，而本文将实现功能更完善的<strong>双向循环带头节点</strong>链表。</p>
<h2 data-id="heading-1">1. 链表结构与初始化</h2>
<h3 data-id="heading-2">节点结构定义</h3>
<p>c</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">typedef</span> <span class="hljs-type">int</span> LTDataType;

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ListNode</span> {
    LTDataType data;
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ListNode</span>* next;
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ListNode</span>* prev;
} ListNode;
</code></pre>
<p>每个节点包含数据域和两个指针域，分别指向前驱和后继节点。</p>
<h3 data-id="heading-3">链表初始化</h3>
<p>c</p>
<pre><code class="hljs language-ini" lang="ini">// 创建新节点
ListNode* CreateNode(LTDataType x) {
    ListNode* <span class="hljs-attr">newNode</span> = (ListNode*)malloc(sizeof(ListNode))<span class="hljs-comment">;</span>
    assert(newNode)<span class="hljs-comment">;</span>
    newNode-&gt;<span class="hljs-attr">data</span> = x<span class="hljs-comment">;</span>
    newNode-&gt;<span class="hljs-attr">next</span> = newNode<span class="hljs-comment">;</span>
    newNode-&gt;<span class="hljs-attr">prev</span> = newNode<span class="hljs-comment">;</span>
    return newNode<span class="hljs-comment">;</span>
}

// 初始化双向循环链表
ListNode* LTInit() {
    ListNode* <span class="hljs-attr">pHead</span> = CreateNode(-<span class="hljs-number">1</span>)<span class="hljs-comment">;  // 创建哨兵节点</span>
    return pHead<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>哨兵节点特点</strong>：</p>
<ul>
<li>数据域通常存储无效值（如-1）</li>
<li>不参与实际数据存储</li>
<li>永远存在于链表中，避免空链表特殊情况</li>
</ul>
<h2 data-id="heading-4">2. 链表基本操作</h2>
<h3 data-id="heading-5">打印链表</h3>
<p>c</p>
<pre><code class="hljs language-scss" lang="scss">void <span class="hljs-built_in">LTPrint</span>(ListNode* pHead) {
    <span class="hljs-built_in">assert</span>(pHead);
    ListNode* pCur = pHead-&gt;next;
    
    <span class="hljs-built_in">printf</span>("链表内容: ");
    while (pCur != pHead) {
        <span class="hljs-built_in">printf</span>("%d -&gt; ", pCur-&gt;data);
        pCur = pCur-&gt;next;
    }
    <span class="hljs-built_in">printf</span>("HEAD\n");
}
</code></pre>
<p><strong>实现要点</strong>：</p>
<ul>
<li>从哨兵节点的下一个节点开始遍历</li>
<li>遇到哨兵节点时停止，避免无限循环</li>
</ul>
<h3 data-id="heading-6">尾插操作</h3>
<p>c</p>
<pre><code class="hljs language-ini" lang="ini">void LTPushBack(ListNode* pHead, LTDataType x) {
    assert(pHead)<span class="hljs-comment">;</span>
    ListNode* <span class="hljs-attr">newNode</span> = CreateNode(x)<span class="hljs-comment">;</span>
    
    // 新节点与链表建立连接
    newNode-&gt;<span class="hljs-attr">prev</span> = pHead-&gt;prev<span class="hljs-comment">;</span>
    newNode-&gt;<span class="hljs-attr">next</span> = pHead<span class="hljs-comment">;</span>
    
    // 链表与新节点建立连接
    pHead-&gt;prev-&gt;<span class="hljs-attr">next</span> = newNode<span class="hljs-comment">;</span>
    pHead-&gt;<span class="hljs-attr">prev</span> = newNode<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>操作流程</strong>：</p>
<ol>
<li>创建新节点</li>
<li>新节点前驱指向原尾节点，后继指向头节点</li>
<li>原尾节点后继指向新节点</li>
<li>头节点前驱指向新节点</li>
</ol>
<h3 data-id="heading-7">头插操作</h3>
<p>c</p>
<pre><code class="hljs language-ini" lang="ini">void LTPushFront(ListNode* pHead, LTDataType x) {
    assert(pHead)<span class="hljs-comment">;</span>
    ListNode* <span class="hljs-attr">newNode</span> = CreateNode(x)<span class="hljs-comment">;</span>
    
    // 新节点与链表建立连接
    newNode-&gt;<span class="hljs-attr">next</span> = pHead-&gt;next<span class="hljs-comment">;</span>
    newNode-&gt;<span class="hljs-attr">prev</span> = pHead<span class="hljs-comment">;</span>
    
    // 链表与新节点建立连接
    pHead-&gt;next-&gt;<span class="hljs-attr">prev</span> = newNode<span class="hljs-comment">;</span>
    pHead-&gt;<span class="hljs-attr">next</span> = newNode<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-8">3. 链表删除操作</h2>
<h3 data-id="heading-9">尾删操作</h3>
<p>c</p>
<pre><code class="hljs language-ini" lang="ini">void LTPopBack(ListNode* pHead) {
    assert(pHead &amp;&amp; pHead-&gt;next != pHead)<span class="hljs-comment">;  // 确保链表不为空</span>
    
    ListNode* <span class="hljs-attr">delNode</span> = pHead-&gt;prev<span class="hljs-comment">;</span>
    
    // 重新链接节点
    delNode-&gt;prev-&gt;<span class="hljs-attr">next</span> = pHead<span class="hljs-comment">;</span>
    pHead-&gt;<span class="hljs-attr">prev</span> = delNode-&gt;prev<span class="hljs-comment">;</span>
    
    // 释放内存
    free(delNode)<span class="hljs-comment">;</span>
    <span class="hljs-attr">delNode</span> = NULL<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-10">头删操作</h3>
<p>c</p>
<pre><code class="hljs language-ini" lang="ini">void LTPopFront(ListNode* pHead) {
    assert(pHead &amp;&amp; pHead-&gt;next != pHead)<span class="hljs-comment">;  // 确保链表不为空</span>
    
    ListNode* <span class="hljs-attr">delNode</span> = pHead-&gt;next<span class="hljs-comment">;</span>
    
    // 重新链接节点
    pHead-&gt;<span class="hljs-attr">next</span> = delNode-&gt;next<span class="hljs-comment">;</span>
    delNode-&gt;next-&gt;<span class="hljs-attr">prev</span> = pHead<span class="hljs-comment">;</span>
    
    // 释放内存
    free(delNode)<span class="hljs-comment">;</span>
    <span class="hljs-attr">delNode</span> = NULL<span class="hljs-comment">;</span>
}
</code></pre>
<h2 data-id="heading-11">4. 指定位置操作</h2>
<h3 data-id="heading-12">查找节点</h3>
<p>c</p>
<pre><code class="hljs language-ini" lang="ini">ListNode* LTFind(ListNode* pHead, LTDataType x) {
    assert(pHead)<span class="hljs-comment">;</span>
    ListNode* <span class="hljs-attr">pCur</span> = pHead-&gt;next<span class="hljs-comment">;</span>
    
    while (pCur != pHead) {
        if (pCur-&gt;<span class="hljs-attr">data</span> == x) {
            return pCur<span class="hljs-comment">;  // 返回找到的节点指针</span>
        }
        <span class="hljs-attr">pCur</span> = pCur-&gt;next<span class="hljs-comment">;</span>
    }
    return NULL<span class="hljs-comment">;  // 未找到返回空指针</span>
}
</code></pre>
<h3 data-id="heading-13">在指定位置后插入</h3>
<p>c</p>
<pre><code class="hljs language-ini" lang="ini">void LTInsert(ListNode* pos, LTDataType x) {
    assert(pos)<span class="hljs-comment">;</span>
    ListNode* <span class="hljs-attr">newNode</span> = CreateNode(x)<span class="hljs-comment">;</span>
    
    // 新节点与前后节点建立连接
    newNode-&gt;<span class="hljs-attr">next</span> = pos-&gt;next<span class="hljs-comment">;</span>
    newNode-&gt;<span class="hljs-attr">prev</span> = pos<span class="hljs-comment">;</span>
    
    // 前后节点与新节点建立连接
    pos-&gt;next-&gt;<span class="hljs-attr">prev</span> = newNode<span class="hljs-comment">;</span>
    pos-&gt;<span class="hljs-attr">next</span> = newNode<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-14">删除指定位置节点</h3>
<p>c</p>
<pre><code class="hljs language-perl" lang="perl">void LTErase(ListNode* <span class="hljs-keyword">pos</span>) {
    assert(<span class="hljs-keyword">pos</span>);
    
    <span class="hljs-regexp">//</span> 前后节点直接建立连接，跳过当前节点
    <span class="hljs-keyword">pos</span>-&gt;prev-&gt;<span class="hljs-keyword">next</span> = <span class="hljs-keyword">pos</span>-&gt;<span class="hljs-keyword">next</span>;
    <span class="hljs-keyword">pos</span>-&gt;<span class="hljs-keyword">next</span>-&gt;prev = <span class="hljs-keyword">pos</span>-&gt;prev;
    
    <span class="hljs-regexp">//</span> 释放内存
    free(<span class="hljs-keyword">pos</span>);
    <span class="hljs-keyword">pos</span> = NULL;
}
</code></pre>
<h2 data-id="heading-15">5. 完整测试示例</h2>
<p>c</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-id">#include</span> "List<span class="hljs-selector-class">.h</span>"

void <span class="hljs-built_in">TestList</span>() {
    <span class="hljs-comment">// 初始化链表</span>
    ListNode* plist = <span class="hljs-built_in">LTInit</span>();
    
    <span class="hljs-comment">// 测试尾插</span>
    <span class="hljs-built_in">printf</span>("=== 尾插测试 ===\n");
    <span class="hljs-built_in">LTPushBack</span>(plist, <span class="hljs-number">1</span>);
    <span class="hljs-built_in">LTPushBack</span>(plist, <span class="hljs-number">2</span>);
    <span class="hljs-built_in">LTPushBack</span>(plist, <span class="hljs-number">3</span>);
    <span class="hljs-built_in">LTPrint</span>(plist);  <span class="hljs-comment">// 输出: 1 -&gt; 2 -&gt; 3 -&gt; HEAD</span>
    
    <span class="hljs-comment">// 测试头插</span>
    <span class="hljs-built_in">printf</span>("\n=== 头插测试 ===\n");
    <span class="hljs-built_in">LTPushFront</span>(plist, <span class="hljs-number">0</span>);
    <span class="hljs-built_in">LTPushFront</span>(plist, -<span class="hljs-number">1</span>);
    <span class="hljs-built_in">LTPrint</span>(plist);  <span class="hljs-comment">// 输出: -1 -&gt; 0 -&gt; 1 -&gt; 2 -&gt; 3 -&gt; HEAD</span>
    
    <span class="hljs-comment">// 测试查找和插入</span>
    <span class="hljs-built_in">printf</span>("\n=== 查找插入测试 ===\n");
    ListNode* pos = <span class="hljs-built_in">LTFind</span>(plist, <span class="hljs-number">1</span>);
    if (pos != NULL) {
        <span class="hljs-built_in">LTInsert</span>(pos, <span class="hljs-number">99</span>);
        <span class="hljs-built_in">LTPrint</span>(plist);  <span class="hljs-comment">// 在1后面插入99</span>
    }
    
    <span class="hljs-comment">// 测试删除</span>
    <span class="hljs-built_in">printf</span>("\n=== 删除测试 ===\n");
    <span class="hljs-built_in">LTErase</span>(pos);  <span class="hljs-comment">// 删除节点1</span>
    <span class="hljs-built_in">LTPrint</span>(plist);
    
    <span class="hljs-comment">// 测试头删尾删</span>
    <span class="hljs-built_in">printf</span>("\n=== 头尾删除测试 ===\n");
    <span class="hljs-built_in">LTPopFront</span>(plist);
    <span class="hljs-built_in">LTPopBack</span>(plist);
    <span class="hljs-built_in">LTPrint</span>(plist);
}

int <span class="hljs-selector-tag">main</span>() {
    <span class="hljs-built_in">TestList</span>();
    return <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-16">双向循环带头链表的优势</h2>
<ol>
<li><strong>统一的空链表处理</strong>：哨兵节点确保链表永不为空，简化代码逻辑</li>
<li><strong>高效的双向遍历</strong>：支持从前向后和从后向前遍历</li>
<li><strong>循环特性</strong>：尾节点直接连接头节点，形成闭环</li>
<li><strong>操作一致性</strong>：所有插入删除操作遵循相同模式，不需要特殊处理边界情况</li>
</ol>
<h2 data-id="heading-17">复杂度分析</h2>



































<table><thead><tr><th>操作</th><th>时间复杂度</th><th>空间复杂度</th></tr></thead><tbody><tr><td>初始化</td><td>O(1)</td><td>O(1)</td></tr><tr><td>插入(头/尾/指定位置)</td><td>O(1)</td><td>O(1)</td></tr><tr><td>删除(头/尾/指定位置)</td><td>O(1)</td><td>O(1)</td></tr><tr><td>查找</td><td>O(n)</td><td>O(1)</td></tr><tr><td>遍历</td><td>O(n)</td><td>O(1)</td></tr></tbody></table>
<p>这种链表结构在实际应用中非常常见，特别是在需要频繁在两端进行插</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nginx常用命令]]></title>    <link>https://juejin.cn/post/7576489970762137606</link>    <guid>https://juejin.cn/post/7576489970762137606</guid>    <pubDate>2025-11-26T00:31:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576489970762137606" data-draft-id="7576512460263440420" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nginx常用命令"/> <meta itemprop="keywords" content="Nginx"/> <meta itemprop="datePublished" content="2025-11-26T00:31:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可丷乐"/> <meta itemprop="url" content="https://juejin.cn/user/1645337168592269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nginx常用命令
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1645337168592269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可丷乐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T00:31:38.000Z" title="Wed Nov 26 2025 00:31:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从源码编译安装</h2>
<p>下载nginx-1.26.3.tar.gz并解压</p>
<pre><code class="hljs language-shell" lang="shell">tar zxvf nginx-1.26.3.tar.gz
</code></pre>
<p>进入解压后的目录nginx-1.26.3，<code>configure</code>为安装脚本，输入*./configure*命令会提示缺少依赖，安装对应依赖</p>
<pre><code class="hljs language-shell" lang="shell">yum install -y gcc
yum install -y pcre pcre-devel
yum install -y zlib zlib-devel
</code></pre>
<p>通过<code>configure</code>安装</p>
<pre><code class="hljs language-shell" lang="shell">./configure --prefix=/home/nginx
</code></pre>
<p><code>prefix</code>指定nginx安装目录，默认为<code>/usr/local/nginx</code>，更多参数查看<a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fconfigure.html" target="_blank" title="https://nginx.org/en/docs/configure.html" ref="nofollow noopener noreferrer">nginx.org/en/docs/con…</a></p>
<p>执行<code>make</code>和<code>make install</code>安装完成</p>
<h2 data-id="heading-1">启动nginx</h2>
<p>进入到nginx安装目录的<code>sbin</code>目录下</p>
<ul>
<li><code>./nginx</code> 启动</li>
<li><code>./nginx -s stop</code> 快速关闭</li>
<li><code>./nginx -s quit</code> 平稳关闭，在退出前完成已接受的请求</li>
<li><code>./nginx -s reload</code> 重新加载nginx配置文件，不重启服务</li>
</ul>
<p>将nginx创建为服务文件并设置为系统服务，<code>/etc/systemd/system</code>或<code>/usr/lib/systemd/system</code>目录下</p>
<pre><code class="hljs language-shell" lang="shell">vi /usr/lib/systemd/system/nginx.service
</code></pre>
<pre><code class="hljs language-shell" lang="shell">[Unit]
Description=Nginx HTTP Server
After=network.target  # 网络启动后再启动 Nginx

[Service]
Type=forking  # Nginx 以 fork 方式运行（后台进程）
PIDFile=/home/nginx/logs/nginx.pid  # PID 文件路径（必须与 Nginx 配置一致）
ExecStartPre=/home/nginx/sbin/nginx -t #检查配置文件
ExecStart=/home/nginx/sbin/nginx  # 启动命令
ExecReload=/home/nginx/sbin/nginx -s reload  # 重载配置命令
ExecStop=/home/nginx/sbin/nginx -s stop  # 停止命令（优雅停止设置为quit）
PrivateTmp=true  # 为服务分配独立的临时目录，增强安全性

[Install]
WantedBy=multi-user.target  # 声明多用户模式下开机自启
</code></pre>
<p>重载systemd配置文件</p>
<pre><code class="hljs language-shell" lang="shell">systemctl daemon-reload
</code></pre>
<p>启动开机自启</p>
<pre><code class="hljs language-shell" lang="shell">systemctl enable nginx.service
</code></pre>
<pre><code class="hljs language-shell" lang="shell">systemctl start nginx   #启动
systemctl stop nginx  	#停止
systemctl status nginx  #运行状态
systemctl reload nginx  #重新加载配置
systemctl retart nginx  #重启
</code></pre>
<h2 data-id="heading-2">常用配置说明</h2>
<p>nginx有一个master进程以及多个worker进程，master加载配置文件和维护worker进程，worker处理请求。</p>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fngx_core_module.html" target="_blank" title="https://nginx.org/en/docs/ngx_core_module.html" ref="nofollow noopener noreferrer">ngx_core_module</a></h3>
<p>worker进程使用的用户，group省略时与user相同</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
user user [group];
#默认值
user nobody nobody;
#位置：main
</code></pre>
<p>主进程id存储位置</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
pid file;
#默认值
pid logs/nginx.pid;
#位置：main
</code></pre>
<p>错误日志配置，<code>file</code>表示路径，<code>level</code>可选<code>debug</code> 、 <code>info</code> 、 <code>notice</code> 、 <code>warn</code> 、 <code>error</code> 、 <code>crit</code> 、 <code>alert</code> 或 <code>emerg</code></p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
error_log file [level];
#默认值
error_log logs/error.log error;
#位置：main, http, mail, stream, server, location
</code></pre>
<p>工作进程可同时打开的最大连接数，包含与代理服务器和客户端的连接</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
worker_connections number;
#默认值
worker_connections 512;
#位置：events
</code></pre>
<p>工作进程的数量，<code>auto</code>会自动检测CPU核数</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
worker_processes number | auto;
#默认值
worker_processes 1;
#位置：main
</code></pre>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html" ref="nofollow noopener noreferrer">ngx_http_core_module</a></h3>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23server" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#server" ref="nofollow noopener noreferrer">server</a></h4>
<p>一个<em>nginx</em>可以有多个<em>server</em>块，每个<a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23server_name" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#server_name" ref="nofollow noopener noreferrer">server_name</a>可以有多个域名，空格分隔，接收请求时，先通过<em>ip和端口</em>匹配<a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23listen" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#listen" ref="nofollow noopener noreferrer">listen</a>，再通过请求头中的<em>HOST</em>确定到哪个<em>server</em>，未匹配到时第一个<em>server</em>为默认服务器，可以通过在<em>listen</em>中添加 <em><strong>default_server</strong></em>指定默认服务器。请求头中没有<em>HOST</em>，将匹配<code>server_name ""</code>。<code>server_name _</code>表示不匹配</p>
<h4 data-id="heading-6">server_name、listen</h4>
<p><strong>listen</strong>监听服务器**[ip:]端口**的请求，忽略时监听所有ip</p>
<p><strong>server_name</strong>配置通过本机host文件解析或远端DNS解析的<strong>域名</strong>，<code>*</code>为通配符</p>
<p><strong>基于名称的虚拟服务器</strong></p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen      80 default_server;
    server_name example.net www.example.net;
    ...
}
server {
    listen      80;
    server_name "";
    return      444;
}
</code></pre>
<p><strong>基于名称和IP的虚拟服务器</strong></p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen      192.168.1.1:80;
    server_name example.org www.example.org;
    ...
}
server {
    listen      192.168.1.1:80;
    server_name example.net www.example.net;
    ...
}
</code></pre>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23client_body_buffer_size" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size" ref="nofollow noopener noreferrer">client_body_buffer_size</a></h4>
<p><code>http</code>、<code>server</code>、<code>location</code></p>
<p>读取客户端请求体的内存缓冲区大小，超出部分写入临时文件</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
client_body_buffer_size size;
#默认值
client_body_buffer_size 8k|16k;
#位置：http、server、location
</code></pre>
<h4 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23client_body_buffer_size" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size" ref="nofollow noopener noreferrer">client_body_in_file_only</a></h4>
<p>将客户端请求体整个保存到文件中</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
client_body_in_file_only on | clean | off;
#默认值
client_body_in_single_buffer off;
#位置：http、server、location
</code></pre>
<ul>
<li><code>on</code> 将请求体保存在临时文件中，请求处理完成后不删除</li>
<li><code>clean</code> 将请求体保存在临时文件中，请求处理完成后删除</li>
<li><code>off</code> 小请求体存缓存区，大请求体存临时文件，处理后自动删除临时文件</li>
</ul>
<h4 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23client_body_in_single_buffer" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_in_single_buffer" ref="nofollow noopener noreferrer">client_body_in_single_buffer</a></h4>
<p>是否将客户端发送的请求体完整存储在单个内存缓冲区中，当 <code>client_body_in_single_buffer on</code> 且请求体未超过缓冲区大小时，<code>$request_body</code> 可直接获取完整内容；否则可能为空或不完整。</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
client_body_in_single_buffer on | off;
#默认值
client_body_in_single_buffer off;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-10"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23client_body_temp_path" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_temp_path" ref="nofollow noopener noreferrer">client_body_temp_path</a></h4>
<p>请求体储存时的临时文件目录</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
client_body_temp_path path [level1 [level2 [level3]]];
#默认值
client_body_temp_path client_body_temp;
#位置：http, server, location
</code></pre>
<p><code>level</code>对应子目录，最多可有三级，每个<code>level</code>均取值为<code>1-3</code>，表示该层级目录数，如<code>client_body_temp_path client_body_temp 1 2</code> ，表示一级目录有16个，二级目录有16²个目录</p>
<h4 data-id="heading-11"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23client_body_timeout" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_timeout" ref="nofollow noopener noreferrer">client_body_timeout</a></h4>
<p>读取客户端请求体的超时时间。仅设置在两次连续读取操作之间的时间段内，而不是整个请求体的传输时间，超时显示<code>408</code></p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
client_body_timeout time;
#默认值
client_body_timeout 60s;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-12"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23client_header_buffer_size" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#client_header_buffer_size" ref="nofollow noopener noreferrer">client_header_buffer_size</a></h4>
<p>读取客户端请求头的内存缓冲区大小，超过缓冲区大小则根据<code>large_client_header_buffers</code>设置处理</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
client_header_buffer_size size;
#默认值
client_header_buffer_size 1k;
#位置：http, server
</code></pre>
<h4 data-id="heading-13"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23client_header_timeout" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#client_header_timeout" ref="nofollow noopener noreferrer">client_header_timeout</a></h4>
<p>读取客户端请求头的超时时间。如果客户端在此时间内未传输完整请求头，请求将终止并返回 <code>408</code>（请求超时）错误</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
client_header_timeout time;
#默认值
client_header_timeout 60s;
#位置：http, server
</code></pre>
<h4 data-id="heading-14"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23client_max_body_size" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#client_max_body_size" ref="nofollow noopener noreferrer">client_max_body_size</a></h4>
<p>客户端氢气体的最大大小，超过返回<code>413</code>错误，<code>0</code>表示禁用对请求体大小的检查</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
client_max_body_size size;
#默认值
client_max_body_size 1m;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-15"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23location" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#location" ref="nofollow noopener noreferrer">location</a></h4>
<pre><code class="hljs language-nginx" lang="nginx">#语法
location [ = | ~ | ~* | ^~ ] uri { ... }
location @name { ... }
#位置：server, location
</code></pre>
<p>优先级从高到低：</p>
<ol>
<li><code>=</code> 精确匹配</li>
<li><code>^~ </code>特殊前缀匹配，一旦匹配成功，会<strong>终止后续正则匹配检查</strong></li>
<li><code>~</code> 正则匹配区分大小写</li>
<li><code>~*</code> 正则匹配不区分大小写，正则表达式第一个匹配时会直接使用其配置并终止后续搜索</li>
<li>普通前缀匹配，遵循最长匹配原则</li>
<li><code>@name</code>不能嵌套，自定义名称一般用于重定向</li>
</ol>
<p><code>location</code>请求若由<code>proxy_pass</code>处理且指定了URI，匹配部分将会被替换并拼接到<code>proxy_pass</code>后面，<code>location</code>请求对应的静态资源相对于当前<code>location</code>的<code>root</code>目录下</p>
<h4 data-id="heading-16"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23keepalive_disable" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#keepalive_disable" ref="nofollow noopener noreferrer">keepalive</a></h4>
<p><strong>复用已建立的 TCP 连接处理多个 HTTP 请求 / 响应</strong>，避免每次请求都重新建立和关闭 TCP 连接，从而减少网络开销、提升通信效率。</p>
<h5 data-id="heading-17"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23keepalive_disable" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#keepalive_disable" ref="nofollow noopener noreferrer">客户端</a></h5>
<pre><code class="hljs language-nginx" lang="nginx">#语法
keepalive_disable none | browser ...;
#默认值
keepalive_disable msie6;
#位置：http, server, location
</code></pre>
<ul>
<li><code>none</code> 启用所有浏览器长连接</li>
<li><code>msie6</code> 禁用IE6的长连接（<strong>默认</strong>）</li>
<li><code>safari</code> 禁用safari长连接</li>
</ul>
<p>一个长连接的总时长，达到时间时关闭连接</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
keepalive_time time;
#默认值
keepalive_time 1h;
#位置：http, server, location
</code></pre>
<p>一个长连接在该时间内没接收到请求，则会关闭该请求，<strong>0表示禁用</strong>keepalive</p>
<pre><code class="hljs language-nginx" lang="nginx">#默认值
keepalive_timeout timeout [header_timeout];
#默认值
keepalive_timeout 75s;
#位置：http, server, location
</code></pre>
<p>一个长连接可处理的最大请求数量</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
keepalive_requests number;
#默认值
keepalive_requests 1000;
#位置：http, server, location
</code></pre>
<h5 data-id="heading-18"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_upstream_module.html%23keepalive" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive" ref="nofollow noopener noreferrer">upstream</a></h5>
<p>设置与后端上游服务器的空闲长连接池</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
keepalive connections;
#位置：upstream
</code></pre>
<p>空闲长连接池的最大数量，修改负载均衡方法时该指令需在其之后，对于http需在<code>location</code>中设置</p>
<pre><code class="hljs language-nginx" lang="nginx">location /http/{
    proxy_http_version 1.1;#HTTP/1.0 默认不支持长连接，需客户端显式发送Connection:keep-alive 头
    proxy_set_header Connection "";#清除客户端请求中的 Connection 头，避免后端服务器关闭长连接
}
</code></pre>
<p><code>keepalive_requests</code> 一个长连接可处理的最大请求数量</p>
<p><code>keepalive_time</code> 一个长连接的总时长，达到时间时关闭连接</p>
<h4 data-id="heading-19"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23send_timeout" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#send_timeout" ref="nofollow noopener noreferrer">send_timeout</a></h4>
<p>nginx向客户端传输响应的超时时间，<strong>仅在两次连续的写操作之间，不是整个响应</strong></p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
send_timeout time;
#默认值
send_timeout 60s;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-20"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23etag" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#etag" ref="nofollow noopener noreferrer">ETag</a></h4>
<p>启用或禁用响应头中的<code>ETag</code>，基于资源的大小时间等生成，用于客户端缓存判断请求的资源是否发生更改，请求时响应头会返回<code>ETage</code>，再次请求时服务器对比请求头中的<code>If-None-Modified</code>与服务端的<code>ETag</code>，若未修改返回状态码304，常与<code>Last-Modified</code>配合使用</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
etag on | off;
#默认值
etag on;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-21"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23if_modified_since" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#if_modified_since" ref="nofollow noopener noreferrer">if_modified_since</a></h4>
<p>服务器如何比较请求头中的<code>If-Modified-Since</code>和服务器资源的<code>Last-Modified</code></p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
if_modified_since off | exact | before;
#默认值
if_modified_since exact
#位置：http, server, location
</code></pre>
<p><code>off</code> 不比较，始终视为已修改</p>
<p><code>exact</code> 精确匹配</p>
<p><code>before</code> 响应的时间小于等于请求头中的<code>If-Modified-Since</code>的时间</p>
<h4 data-id="heading-22"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23sendfile" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#sendfile" ref="nofollow noopener noreferrer">sendfile</a></h4>
<p>用于优化静态文件传输性能的核心配置，其底层依赖操作系统的<code>sendfile</code>系统调用，主要作用是<strong>减少数据在用户空间与内核空间之间的拷贝次数</strong></p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
sendfile on | off;
#默认值
sendfile off;
#位置：http, server, location, if in location
</code></pre>
<p>传统传输文件流程：</p>
<ol>
<li>操作系统从磁盘读取文件数据，存入<strong>内核缓冲区</strong>（内核空间）；</li>
<li>数据从内核缓冲区拷贝到<strong>应用程序缓冲区</strong>（用户空间，如 Nginx 进程的内存）；</li>
<li>数据再从应用程序缓冲区拷贝到<strong>Socket 缓冲区</strong>（内核空间，用于网络发送）；</li>
<li>最终从 Socket 缓冲区通过网络发送给客户端</li>
</ol>
<p>使用sendfile的流程：</p>
<ol>
<li>磁盘数据读入内核缓冲区；</li>
<li>内核直接将缓冲区数据 “移交” 给 Socket 缓冲区（通过指针映射，而非实际拷贝）；</li>
<li>数据从 Socket 缓冲区发送到客户端。</li>
</ol>
<h4 data-id="heading-23"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23open_file_cache" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#open_file_cache" ref="nofollow noopener noreferrer">open_file_cache</a></h4>
<p>缓存文件的元数据</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
open_file_cache off;
open_file_cache max=N [inactive=time];
#默认值
open_file_cache off;
#位置：http, server, location
</code></pre>
<p><code>off</code>关闭</p>
<p><code>max</code>设置缓存的最大元素数量</p>
<p><code>inactive</code>移除指定时间内未被访问的缓存</p>
<h4 data-id="heading-24"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23open_file_cache_errors" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#open_file_cache_errors" ref="nofollow noopener noreferrer">open_file_cache_errors</a></h4>
<p>控制是否缓存 文件错误信息</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
open_file_cache_errors on | off;
#默认值
open_file_cache_errors off;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-25"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23open_file_cache_min_uses" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#open_file_cache_min_uses" ref="nofollow noopener noreferrer">open_file_cache_min_uses</a></h4>
<p>在 <code>open_file_cache</code> 的 <code>inactive</code> 时间窗口内，一个文件至少被访问多少次，其元数据才会被保留在缓存中</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
open_file_cache_min_uses number;
#默认值
open_file_cache_min_uses 1;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-26"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23open_file_cache_valid" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#open_file_cache_valid" ref="nofollow noopener noreferrer">open_file_cache_valid</a></h4>
<p>设置缓存中元数据的定期验证间隔，定期（每间隔该时间）验证缓存中的元数据是否与磁盘实际文件一致并修改</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
open_file_cache_valid time;
#默认值	
open_file_cache_valid 60s;
#默认值
</code></pre>
<h4 data-id="heading-27"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23error_page" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#error_page" ref="nofollow noopener noreferrer">error_page</a></h4>
<p>根据响应码跳转到相应错误页</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
error_page code ... [=[response]] uri;
#位置：http, server, location, if in location
</code></pre>
<p><code>code</code>响应码，多个用空格分隔</p>
<p><code>=response</code>更改响应码为response响应码</p>
<p><code>uri</code>指本地静态文件路径、外部地址、内部命名 <code>location</code>如自定义<code>@name</code></p>
<pre><code class="hljs language-nginx" lang="nginx">error_page 500 502 503 504 /50x.html;

# 精确匹配50x.html 限制 /50x.html 仅内部访问
location = /50x.html {
    internal;  # 客户端直接请求 example.com/50x.html 会返回 404
    root /usr/share/nginx/html;  # 明确指定文件所在目录（可选，若继承server的root则可省略）
}
</code></pre>
<h4 data-id="heading-28"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_core_module.html%23limit_rate" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_core_module.html#limit_rate" ref="nofollow noopener noreferrer">limit_rate</a></h4>
<p>限制对客户端的响应速率，每秒的字节数，如1k表示1k/s，针对的是客户端的一个请求，客户端同时打开两个连接，总速率将是限制的两倍，0表示不限制</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
limit_rate rate;
#默认值
limit_rate 0;
#位置：http, server, location, if in location
</code></pre>
<p>可结合<code>limit_rate_after</code>(传输一定字节后限速)</p>
<h3 data-id="heading-29"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html" ref="nofollow noopener noreferrer">ngx_http_proxy_module</a></h3>
<h4 data-id="heading-30"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_bind" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_bind" ref="nofollow noopener noreferrer">proxy_bind</a></h4>
<p>指与反向代理服务器连接时本地的ip和端口，<code>off</code>取消从上一级继承的<code>proxy_bind</code>的配置，<code>transparent</code>指定为非本机ip，如<code>$remote_addr</code>指定为客户端的真实ip地址（需要系统层面配置支持）</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_bind address [transparent] | off;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-31"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_pass" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass" ref="nofollow noopener noreferrer">proxy_pass</a></h4>
<p><code>proxy_pass</code>设置反向代理地址，后可配置多个地址，空格隔开，也可配置为<a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_upstream_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_upstream_module.html" ref="nofollow noopener noreferrer">server_group</a></p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_pass URL;
#位置：location, if in location, limit_except
</code></pre>
<p>若<strong>proxy_pass</strong>中指定了URI，则<strong>location</strong>中匹配的URI部分将被替换为<strong>proxy_pass</strong>的部分再拼接到后面进行反向代理。</p>
<p>若<strong>proxy_pass</strong>中未指定URI，则<strong>location</strong>中的URI将被拼接到<strong>proxy_pass</strong>中进行反向代理。</p>
<h4 data-id="heading-32"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_buffering" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffering" ref="nofollow noopener noreferrer">proxy_buffering</a></h4>
<p>启用或禁用代理服务器响应的缓存区</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_buffering on | off;
#默认值
proxy_buffering on;
#位置：http, server, location
</code></pre>
<p>启用时将响应保存到<code>proxy_buffer_size</code>和 <code>proxy_buffers</code>设置的缓冲区中，超过内存缓冲区大小的部分将存在<code>proxy_max_temp_file_size</code>和<code>proxy_temp_file_write_size</code>的临时文件中</p>
<p>禁用时Nginx 就立即发给客户端，不读取响应</p>
<h4 data-id="heading-33"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_buffer_size" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffer_size" ref="nofollow noopener noreferrer">proxy_buffer_size</a></h4>
<p>读取反向代理服务器响应的第一部分的内存缓冲区大小，通常为<strong>响应头</strong></p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_buffer_size size;
#默认值，取决于系统
proxy_buffer_size 4k|8k;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-34"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_buffers" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_buffers" ref="nofollow noopener noreferrer">proxy_buffers</a></h4>
<p>读取代理服务器<strong>响应体</strong>的内存缓冲区大小，接收响应时先将响应体存入内存缓冲区，超出的部分存入临时文件<code>proxy_max_temp_file_size</code></p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_buffers number size;
#默认值
proxy_buffers 8 4k|8k;
#位置：http, server, location
</code></pre>
<p><code>number</code> 缓冲区数量</p>
<p><code>size</code> 缓冲区大小</p>
<h4 data-id="heading-35"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_busy_buffers_size" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_busy_buffers_size" ref="nofollow noopener noreferrer">proxy_busy_buffers_size</a></h4>
<p>读取响应的缓冲区能用于向客户端发送响应的缓冲区总大小（这些缓冲区无法被用于读取代理服务器响应）</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_busy_buffers_size size;
#默认值
proxy_busy_buffers_size 8k|16k;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-36"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_set_header" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header" ref="nofollow noopener noreferrer">proxy_set_header</a></h4>
<p>向反向代理服务器中重新定义或追加请求头</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_set_header field value;
#默认值
proxy_set_header Host $proxy_host;
proxy_set_header Connection close;
#位置：http, server, location
</code></pre>
<p><code>value</code>可以是文本、变量、及其组合</p>
<h4 data-id="heading-37"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache" ref="nofollow noopener noreferrer">proxy_cache</a></h4>
<p>是否开启对代理服务器的缓存</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache zone | off;
#默认值
proxy_cache off;
#位置：http, server, location
</code></pre>
<p><code>zone</code>指定的缓存区域的名称，相同的区域可重复使用，区域名称见<code>proxy_cache_path</code>的<code>keys_zone</code></p>
<p><code>off</code>关闭</p>
<h4 data-id="heading-38"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache_background_update" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_background_update" ref="nofollow noopener noreferrer">proxy_cache_background_update</a></h4>
<p>是否开启：缓存内容过期时，先向客户端返回旧缓存，同时在后台异步更新缓存</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache_background_update on | off;
#默认值
proxy_cache_background_update off;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-39"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache_bypass" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_bypass" ref="nofollow noopener noreferrer">proxy_cache_bypass</a></h4>
<p>如果指定的变量中至少一个不为非空且不等于0则绕过缓存</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache_bypass string ...;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-40"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache_methods" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_methods" ref="nofollow noopener noreferrer">proxy_cache_methods</a></h4>
<p>缓存对应请求方法的响应</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache_methods GET | HEAD | POST ...;
#默认值
proxy_cache_methods GET HEAD;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-41"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache_purge" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_purge" ref="nofollow noopener noreferrer">proxy_cache_purge</a></h4>
<p>如果指定的变量中至少一个不为非空且不等于0则清除缓存</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache_purge string ...;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-42"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache_key" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_key" ref="nofollow noopener noreferrer">proxy_cache_key</a></h4>
<p>缓存的键名，识别不同请求的唯一标识</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache_key string;
#默认值
proxy_cache_key $scheme$proxy_host$request_uri;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-43"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache_lock" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_lock" ref="nofollow noopener noreferrer">proxy_cache_lock</a></h4>
<p>开启时，若资源未缓存，只有一个会请求后端并缓存，其余有相同缓存键的请求进入等待队列阻塞直至从缓存中获取</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache_lock on | off;
#默认值
proxy_cache_lock off;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-44"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache_lock_age" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_lock_age" ref="nofollow noopener noreferrer">proxy_cache_lock_age</a></h4>
<p>在<code>指定时间</code>内向代理服务器发送请求并缓存未完成时，进入等待队列有相同缓存键的请求会再发一个请求</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache_lock_age time;
#默认值
proxy_cache_lock_age 5s;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-45"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache_lock_timeout" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_lock_timeout" ref="nofollow noopener noreferrer">proxy_cache_lock_timeout</a></h4>
<p>请求上锁的超时时间，单个请求超过该时间时，会发送给代理服务器，但不缓存响应</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache_lock_timeout time;
#默认值
proxy_cache_lock_timeout 5s;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-46"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache_min_uses" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_min_uses" ref="nofollow noopener noreferrer">proxy_cache_min_uses</a></h4>
<p>达到指定的请求次数后缓存响应</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache_min_uses number;
#默认值
proxy_cache_min_uses 1;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-47"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache_path" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path" ref="nofollow noopener noreferrer">proxy_cache_path</a></h4>
<p>设置缓存位置及其他参数，<code>proxy_cache_path</code>可多次定义</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache_path path [levels=levels] [use_temp_path=on|off] keys_zone=name:size [inactive=time] [max_size=size] [min_free=size] [manager_files=number] [manager_sleep=time] [manager_threshold=time] [loader_files=number] [loader_sleep=time] [loader_threshold=time] [purger=on|off] [purger_files=number] [purger_sleep=time] [purger_threshold=time];
#位置：http
</code></pre>
<p>缓存文件名是缓存键名经过MD5后的结果</p>
<p><code>path</code>缓存文件的目录</p>
<p><code>level</code>缓存的没目录层级，层级范围是<code>1:3</code>最多三层，每层用只能是1或2，代表几个16进制，如<code>1:2:2</code>表示三层，分别为<code>16</code>、<code>16*16</code>、<code>16*16</code>个目录</p>
<p><code>use_temp_path</code>是否先将缓存写入临时文件，再重命名为缓存文件，若临时文件和缓存文件不在同一个文件系统，就不是重命名操作，设置为<code>on</code>时，临时文件位置由<code>proxy_temp_path</code>指定，<code>off</code>临时文件直接放在缓存目录中</p>
<p><code>keys_zone</code>定义代理服务器的缓存区域，即<code>proxy_cache</code>指定的<code>zone</code>，存在内存中</p>
<p><code>inactive</code>指定时间内<strong>未被访问</strong>的缓存数据，无论是否过期，都会移除，默认<code>10分钟</code></p>
<h4 data-id="heading-48"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache_revalidate" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_revalidate" ref="nofollow noopener noreferrer">proxy_cache_revalidate</a></h4>
<p>缓存过期时允许发送<code>If-Modified-Since</code>和<code>If-None-Match</code>请求头重新验证缓存是否更改，仅更改才会拉取，否则复用</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache_revalidate on | off;
#默认值
proxy_cache_revalidate off;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-49"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache_use_stale" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_use_stale" ref="nofollow noopener noreferrer">proxy_cache_use_stale</a></h4>
<p>后端服务异常时是否使用过期缓存</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache_use_stale error | timeout | invalid_header | updating | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | http_429 | off ...;
#默认值
proxy_cache_use_stale off;
#位置：http, server, location
</code></pre>
<p><code>error</code>后端返回任何错误（如连接拒绝、重置等）时使用过期缓存</p>
<h4 data-id="heading-50"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_proxy_module.html%23proxy_cache_valid" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_valid" ref="nofollow noopener noreferrer">proxy_cache_valid</a></h4>
<p>设置不同响应代码的缓存有效期时间</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
proxy_cache_valid [code ...] time;
#位置：http, server, location
</code></pre>
<p>若仅指定了时间，缓存的响应码为200、301、302，<code>any</code>表示任何相应</p>
<h3 data-id="heading-51"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_upstream_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_upstream_module.html" ref="nofollow noopener noreferrer">ngx_http_upstream_module</a></h3>
<h4 data-id="heading-52"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_upstream_module.html%23upstream" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_upstream_module.html#upstream" ref="nofollow noopener noreferrer">upstream</a></h4>
<p>定义一组服务器。服务器可以监听不同的端口</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
upstream name { ... }
#位置：http
</code></pre>
<pre><code class="hljs language-nginx" lang="nginx">upstream dynamic {
    server backend1.example.com      weight=5;
    server backend2.example.com:8080;
}
server {
    location / {
        proxy_pass http://dynamic;
        health_check;
    }
}
</code></pre>
<p>格式为：域名/ip[+端口]</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
server address [parameters];
#位置：upstream
</code></pre>
<p><code>weight=number</code> 设置服务器权重，默认为1</p>
<p><code>max_fails=number</code> 在<code>fail_timeout</code>时间内最大的失败次数，默认为1，超过后服务视为不可用。</p>
<p><code>fail_timeout=time</code> 1.失败次数的次序时间；2.服务器被视为不可用的时间段。</p>
<p><strong>负载均衡方式</strong></p>
<ul>
<li>
<p>轮询（默认）</p>
</li>
<li>
<p><code>hash key</code> 基于key的hash映射，可设置为<code>$request_uri</code>等变量</p>
</li>
<li>
<p><code>ip_hash</code> 对客户端请求的ip进行hash取余，确保同一客户端的请求始终转发到同一服务器</p>
</li>
</ul>
<h3 data-id="heading-53"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_rewrite_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html" ref="nofollow noopener noreferrer">ngx_http_rewrite_module</a></h3>
<h4 data-id="heading-54"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_rewrite_module.html%23rewrite" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_rewrite_module.html#rewrite" ref="nofollow noopener noreferrer">rewrite</a></h4>
<pre><code class="hljs language-nginx" lang="nginx">#语法
rewrite regex replacement [flag];
#位置：server, location, if
</code></pre>
<p>使用 PCRE 正则表达式更改请求 URI，不能超过10次，通过引用<code>$1</code>、<code>$2</code>…引用URI中的捕获组</p>
<p><code>flag</code> 参数如下：</p>
<p><code>last</code> 终止当前<code>location</code>或<code>server</code>块中的所有配置，<strong>根据新 URI 重新匹配<code>location</code></strong>（内部跳转）</p>
<p><code>break</code> 终止当前块的后续<code>rewrite</code>规则，<strong>不重新匹配<code>location</code></strong>，在当前块中继续处理请求</p>
<p><code>redirect</code> 返回 302 临时重定向（浏览器不会缓存跳转关系），适用于临时调整 URL</p>
<p><code>permanent</code> 返回 301 永久重定向（浏览器会缓存跳转关系），适用于 URL 永久变更</p>
<h3 data-id="heading-55"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_referer_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_referer_module.html" ref="nofollow noopener noreferrer">ngx_http_referer_module</a></h3>
<h4 data-id="heading-56"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_referer_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_referer_module.html" ref="nofollow noopener noreferrer">referer</a></h4>
<pre><code class="hljs language-nginx" lang="nginx">#语法
valid_referers none | blocked | server_names | string ...;
#位置：server, location
</code></pre>
<p>指定请求头中的<code>Referer</code>来源，嵌入到 <code>$invalid_referer</code> 变量，允许的来源变量被设为空字符串，否则为<code>1</code>，结合<code>if($invalid_referer)</code>判断是否允许以实现防盗链和请求来源验证</p>
<p><code>none</code> 允许请求头缺少<code>Referer</code></p>
<p><code>blocked</code> 允许请求头的<code>Referer</code>的值被防火墙或代理服务器删除</p>
<p><code>server_names</code> 允许匹配<code>server</code>块中的<code>server_name</code>域名</p>
<p><code>自定义字符串</code> 可以在开头或结尾有 <code>*</code></p>
<p><code>正则表达式</code> 以<code>~</code>开始</p>
<h3 data-id="heading-57"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_gzip_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_gzip_module.html" ref="nofollow noopener noreferrer">ngx_http_gzip_module</a></h3>
<p>使用<code>gzip</code>动态压缩响应，减少传输数据</p>
<h4 data-id="heading-58"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_gzip_module.html%23gzip" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip" ref="nofollow noopener noreferrer">gzip</a></h4>
<p>开启或禁用<code>gzip</code>动态压缩</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
gzip on | off
#默认值
gzip off
#位置：http, server, location, if in location
</code></pre>
<h4 data-id="heading-59"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_gzip_static_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_gzip_static_module.html" ref="nofollow noopener noreferrer">gzip_static</a></h4>
<p>是否启用预压缩直接发送预先压缩好的静态资源的<code>.gz</code>文件</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
gzip_static on | off | always;
#默认值
gzip_static off;
#位置：http, server, location
</code></pre>
<p><code>on</code>有预压缩文件且客户端支持gzip，否则返回原文件</p>
<p><code>off</code>关闭预压缩</p>
<p><code>always</code>有<code>.gz</code>文件时，不论客户端是否支持直接发送预压缩文件</p>
<h4 data-id="heading-60"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_gzip_module.html%23gzip_buffers" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip_buffers" ref="nofollow noopener noreferrer">gzip_buffers</a></h4>
<p>设置压缩响应的缓冲区数量和大小,默认情况下，缓冲区大小等于一个内存页，取决于系统</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
gzip_buffers number size;
#默认值
gzip_buffers 32 4k|16 8k;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-61"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_gzip_module.html%23gzip_comp_level" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip_comp_level" ref="nofollow noopener noreferrer">gzip_comp_level</a></h4>
<p>设置响应的压缩等级，范围为<code>1~9</code>，值越大压缩率越高但越耗费服务器CPU</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
gzip_comp_level level;
#默认值
gzip_comp_level 1;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-62"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_gzip_module.html%23gzip_disable" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip_disable" ref="nofollow noopener noreferrer">gzip_disable</a></h4>
<p>当请求头<code>User-Agent</code>中的值与表达式匹配时禁用<code>gzip</code>响应压缩</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
gzip_disable regex ...;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-63"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_gzip_module.html%23gzip_http_version" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip_http_version" ref="nofollow noopener noreferrer">gzip_http_version</a></h4>
<p>设置<code>gzip</code>压缩响应所需的最低http版本，对符合条件的压缩</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
gzip_http_version 1.0 | 1.1;
#默认值
gzip_http_version 1.1;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-64"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_gzip_module.html%23gzip_min_length" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip_min_length" ref="nofollow noopener noreferrer">gzip_min_length</a></h4>
<p>设置启用压缩的响应的最小长度，由<code>Content-Length</code>响应头确定，避免对过小响应压缩</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
gzip_min_length length;
#默认值
gzip_min_length 20;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-65"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_gzip_module.html%23gzip_proxied" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip_proxied" ref="nofollow noopener noreferrer">gzip_proxied</a></h4>
<p>是否对代理服务器的响应进行压缩</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
c off | expired | no-cache | no-store | private | no_last_modified | no_etag | auth | any ...;
#默认值
gzip_proxied off;
#位置：http, server, location
</code></pre>
<ul>
<li><code>off</code>对所有代理请求禁用压缩</li>
<li><code>expired</code>响应头包含<code>Expires</code>字段且值为过期时间则启用压缩</li>
<li><code>no-cache</code>响应头包含有<code>Cache-Control:no-cache</code>则启用压缩</li>
<li><code>no-store</code>响应头包含有<code>Cache-Control:no-store</code>则启用压缩</li>
<li><code>private</code>响应头包含有<code>Cache-Control:private</code>则启用压缩</li>
<li><code>no_last_modified</code>响应头不包含<code>Last-Modified</code>字段则启用压缩</li>
<li><code>no_etag</code>响应头不包含<code>ETag</code>则启用压缩</li>
<li><code>auth</code>请求头包含<code>Authorization</code>则启用压缩</li>
<li><code>any</code>对所有代理请求启用压缩</li>
</ul>
<h4 data-id="heading-66"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_gzip_module.html%23gzip_types" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip_types" ref="nofollow noopener noreferrer">gzip_types</a></h4>
<p>指定对MIME类型的响应进行压缩</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
gzip_types mime-type ...;
#默认值
gzip_types text/html;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-67"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_gzip_module.html%23gzip_vary" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip_vary" ref="nofollow noopener noreferrer">gzip_vary</a></h4>
<p>为开启了<code>gzip</code>的响应添加<code>Vary: Accept-Encoding</code>响应头，该响应头用于告诉缓存服务器，当前资源根据客户端请求头中的<code>Accept-Encoding</code>变化，仅<code>gzip on</code>/<code>gzip_static on</code>开启时可用</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
gzip_vary on | off;
#默认值
gzip_vary off;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-68"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle%2Fngx_brotli" target="_blank" title="https://github.com/google/ngx_brotli" ref="nofollow noopener noreferrer">brotli</a></h4>
<p>比gzip压缩效率更高的压缩算法，仅在https中能用</p>
<h3 data-id="heading-69"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_ssl_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_ssl_module.html" ref="nofollow noopener noreferrer">ngx_http_ssl_module</a></h3>
<h4 data-id="heading-70"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_ssl_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_ssl_module.html" ref="nofollow noopener noreferrer">ssl</a></h4>
<p><code>http</code>、<code>server</code>、<code>location</code></p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen              443 ssl;
    keepalive_timeout   70;

    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         AES128-SHA:AES256-SHA:RC4-SHA:DES-CBC3-SHA:RC4-MD5;
    ssl_certificate     /usr/local/nginx/conf/cert.pem;
    ssl_certificate_key /usr/local/nginx/conf/cert.key;
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 10m;
}
</code></pre>
<p><code>listen 443 ssl</code> 开启https，默认的端口为443</p>
<p><code>ssl_certificate</code> ssl证书</p>
<p><code>ssl_certificate_key</code> ssl私钥</p>
<h3 data-id="heading-71"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_ssi_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_ssi_module.html" ref="nofollow noopener noreferrer">ngx_http_ssi_module</a></h3>
<p>服务端包含，通过特定指令在服务器端合并静态文件、动态内容，再返回给客户端</p>
<h4 data-id="heading-72"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_ssi_module.html%23ssi" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_ssi_module.html#ssi" ref="nofollow noopener noreferrer">ssi</a></h4>
<p>开启或禁用</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
ssi on | off;
#默认值
ssi off;
#位置：http, server, location, if in location
</code></pre>
<p>开启或禁用，根据请求头中的<code>If-Modified-Since</code>与主文件的<code>Last-Modified</code>对比是否更新，并设置响应头<code>Last-Modified</code></p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
ssi_last_modified on | off;
#默认值
ssi_last_modified off;
#位置：http, server, location
</code></pre>
<p><strong>ssi命令</strong></p>
<pre><code class="hljs language-nginx" lang="nginx">&lt;!--# include file="footer.html" --&gt;
</code></pre>
<p>指定一个文件包含另一个文件，如在html中使用</p>
<h3 data-id="heading-73"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_limit_req_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html" ref="nofollow noopener noreferrer">ngx_http_limit_req_module</a></h3>
<p>请求限流模块，基于<strong>漏桶算法</strong>（漏桶容量和流出请求速率固定，请求过快会溢出拒绝请求），限制单位时间内来自key标识的请求次数</p>
<h4 data-id="heading-74"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_limit_req_module.html%23limit_req_zone" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html#limit_req_zone" ref="nofollow noopener noreferrer">limit_req_zone</a></h4>
<p>定义一个共享内存区，可配置多个</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
limit_req_zone key zone=name:size rate=rate [sync];
#位置：http
</code></pre>
<p><code>key</code>针对限流的key（按什么标识限流），可以包含文本、变量及其组合，如使用变量<code>$binary_remote_addr</code>表示的是客户端的ip地址的二进制形式，占用内存小，<code>$remote_addr</code>客户端ip地址字符串形式，<code>$server_name</code>针对<code>server</code>中的<code>server_name</code>限流</p>
<p><code>zone</code>定义的共享内存区域，其中<code>name</code>表示区域名称，<code>size</code>表示区域大小如<code>10m</code>，存储统计数据，若存储已满，则会移除最久未使用的，若还是不行则以错误形式终止请求</p>
<p><code>rate</code>限流速率（漏桶请求流出速率），如<code>10r/s</code>（每秒最多 10 次请求）、<code>60r/m</code>（每分钟最多 60 次，即每秒 1 次）</p>
<h4 data-id="heading-75"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_limit_req_module.html%23limit_req" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html#limit_req" ref="nofollow noopener noreferrer">limit_req</a></h4>
<p>引用<code>limit_req_zone</code>中的共享内存区域对该区块请求生效，可配置多个</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
limit_req zone=name [burst=number] [nodelay | delay=number];
#位置：http, server, location
</code></pre>
<p><code>zone</code>引用<code>limit_req_zone</code>对应的区域名称</p>
<p><code>burst</code>突发请求（即超出请求限制的请求）的缓冲队列大小，超过该队列的请求将以错误形式终止请求，默认为0，<strong>针对每个key</strong></p>
<p><code>nodelay</code>让<code>burst</code>队列中请求跳过等待，直接处理，与<code>burst</code>绑定，但不超过<code>rate</code>速率，无<code>nodellay</code>时，排队在一定延迟后进行处理，有<code>nodelay</code>时满足<code>rate</code>的情况下立即处理不延迟</p>
<p><code>delay</code>与<code>nodelay</code>相反，在缓冲队列中的请求，满足<code>rate</code>情况下，一定<code>number</code>延迟后处理</p>
<h4 data-id="heading-76"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_limit_req_module.html%23limit_req_dry_run" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html#limit_req_dry_run" ref="nofollow noopener noreferrer">limit_req_dry_run</a></h4>
<p>模拟限流规则的执行逻辑，但不真正拒绝任何请求，仅通过日志记录 “本应被限流” 的请求</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
limit_req_dry_run on | off;
#默认值
limit_req_dry_run off;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-77"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_limit_req_module.html%23limit_req_log_level" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html#limit_req_log_level" ref="nofollow noopener noreferrer">limit_req_log_level</a></h4>
<p>控制限流相关日志记录级别</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
limit_req_log_level info | notice | warn | error;
#默认值
limit_req_log_level error;
#位置：http, server, location
</code></pre>
<h4 data-id="heading-78"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_limit_req_module.html%23limit_req_status" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_limit_req_module.html#limit_req_status" ref="nofollow noopener noreferrer">limit_req_status</a></h4>
<p>限流拒绝时的响应码设置</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
limit_req_status code;
#默认值
limit_req_status 503;
c, server, location
</code></pre>
<h3 data-id="heading-79"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_limit_conn_module.html" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html" ref="nofollow noopener noreferrer">ngx_http_limit_conn_module</a></h3>
<p>限制基于key标识的连接数量，处于<strong>活跃的TCP连接数</strong>（服务器正在处理请求并且请求头已读取完毕的才会计算）</p>
<h4 data-id="heading-80"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_limit_conn_module.html%23limit_conn_zone" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html#limit_conn_zone" ref="nofollow noopener noreferrer">limit_conn_zone</a></h4>
<p>定义一个共享内存区，保存各key的状态，可以包含文本、变量及其组合，可配置多个</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
limit_conn_zone key zone=name:size;
#位置：http
</code></pre>
<p><code>key</code>针对限制连接的key</p>
<p><code>zone</code>定义的共享内存区域</p>
<h4 data-id="heading-81"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_limit_conn_module.html%23limit_conn" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_limit_conn_module.html#limit_conn" ref="nofollow noopener noreferrer">limit_conn</a></h4>
<p>设置key的最大连接数</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
limit_conn zone number;
#位置：http, server, location
</code></pre>
<p><code>zone</code>指<code>limit_conn_zone</code>中的<code>zone</code></p>
<p><code>number</code>最大连接数</p>
<h3 data-id="heading-82"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_log_module.html%23log_format" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_log_module.html#log_format" ref="nofollow noopener noreferrer">ngx_http_log_module</a></h3>
<p>请求日志，请求结束时记录</p>
<h4 data-id="heading-83"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_log_module.html%23access_log" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_log_module.html#access_log" ref="nofollow noopener noreferrer">access_log</a></h4>
<p>访问日志，每次写入日志都会检查文件是否存在，不存在则不写入</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];
access_log off;
#默认值
access_log logs/access.log combined;
#位置：http, server, location, if in location, limit_except
</code></pre>
<p><code>path</code>日志路径</p>
<p><code>format</code>日志格式化，格式化配置在<code>log_format</code>中，默认使用<code>combined</code></p>
<p><code>buffer</code>启用缓存区，日志暂放在内存缓冲区大小，超过缓冲区大小后写入磁盘，或配置<code>flush</code>使用</p>
<p><code>gzip</code>开启日志gzip压缩的等级，在写入磁盘之前压缩，<code>1-9</code></p>
<p><code>flush</code>日志从缓冲区刷新到磁盘的时间</p>
<p><code>if</code>如果condition为0或空字符串则不记录日志</p>
<h4 data-id="heading-84"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_log_module.html%23log_format" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_log_module.html#log_format" ref="nofollow noopener noreferrer">log_format</a></h4>
<p>格式化日志</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
log_format name [escape=default|json|none] string ...;
#默认值
log_format combined "..."
#位置：http
</code></pre>
<h4 data-id="heading-85"><a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2Fhttp%2Fngx_http_log_module.html%23open_log_file_cache" target="_blank" title="https://nginx.org/en/docs/http/ngx_http_log_module.html#open_log_file_cache" ref="nofollow noopener noreferrer">open_log_file_cache</a></h4>
<p>日志文件描述符缓存</p>
<pre><code class="hljs language-nginx" lang="nginx">#语法
open_log_file_cache max=N [inactive=time] [min_uses=N] [valid=time];
open_log_file_cache off;
#默认值
open_log_file_cache off;
#位置：http, server, location
</code></pre>
<h2 data-id="heading-86">其他说明</h2>
<h3 data-id="heading-87">获取客户端ip</h3>
<p>nginx作为代理服务器反向代理后端时，后端无法获取用户ip地址时，增加如下配置：</p>
<pre><code class="hljs language-nginx" lang="nginx">proxy_set_header X-Forwarded-For $remote_addr;
</code></pre>
<p><code>$remote_addr</code>客户端与nginx连接时的ip地址，若经过多级反向代理，可使用变量<code>$proxy_add_x_forwarded_for</code>，客户端请求头中的 <code>X-Forwarded-For</code> 字段，再加上 <code>$remote_addr</code> 变量的值，两者用逗号分隔。如果客户端请求头中没有 “X-Forwarded-For” 字段，那么 <code>$proxy_add_x_forwarded_for</code> 变量就等于 <code>$remote_addr</code> 变量。</p>
<h3 data-id="heading-88">worker_processes</h3>
<p>工作进程数，一般配置为物理机CUP核数</p>
<h3 data-id="heading-89">worker_connections</h3>
<p>一个进程的连接数，包含与反向代理服务器的连接</p>
<h3 data-id="heading-90">压缩</h3>
<p>gzip动态压缩开启后无法使用sendfile</p>
<h3 data-id="heading-91">concat模块</h3>
<p>压缩请求数，如将多个css、js、图片等请求合并为一个，git地址<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fnginx-http-concat%25EF%25BC%258C%25E5%259C%25B0%25E5%259D%2580https%3A%2F%2Ftengine.taobao.org%2Fdocument_cn%2Fhttp_concat_cn.html" target="_blank" title="https://github.com/alibaba/nginx-http-concat%EF%BC%8C%E5%9C%B0%E5%9D%80https://tengine.taobao.org/document_cn/http_concat_cn.html" ref="nofollow noopener noreferrer">github.com/alibaba/ngi…</a></p>
<h3 data-id="heading-92">自动化同步rsync、inotify</h3>
<p>inotify监控目录是否有变化，在通过事件执行自动化脚本rsync同步源文件以自动同步源文件</p>
<h3 data-id="heading-93">多级缓存</h3>
<h4 data-id="heading-94">协商缓存</h4>
<p><code>Last-Modified</code>:客户端请求时带上<code>If-Modified-Since</code>请求头，服务器检查文件的<code>last_modify</code>是否能对上，返回响应头<code>Last-Modified</code>响应状态码为304，客户端直接从本地读取</p>
<p><code>ETag</code>:精度比<strong>last-modified</strong>高，请求时携带<code>If-None-Match</code>请求头，返回响应头中含有<code>ETag</code>，状态码也是304</p>
<h4 data-id="heading-95">强制缓存</h4>
<p>响应头中设置<code>Cache-Control</code></p>
<p><code>public</code>响应的数据可以被缓存，客户端和代理端都可以缓存</p>
<p><code>private</code>可私有缓存，客户端可以缓存，代理不能缓存</p>
<p><code>no-cache</code>可以使用缓存，但必须发送请求到服务器回源验证</p>
<p><code>no-store</code>禁用缓存</p>
<p><code>max-age</code>在浏览器缓存的时间以秒为单位</p>
<h3 data-id="heading-96">进程追踪</h3>
<p>linux中使用strace</p>
<h3 data-id="heading-97">针对客户端ip限流</h3>
<p>在http块中，针对客户端ip限流，每分钟30个请求</p>
<pre><code class="hljs language-nginx" lang="nginx">limit_req_zone $binary_remote_addr zone=limitClient:10m rate=30r/m;
</code></pre>
<p>在location中</p>
<pre><code class="hljs language-nginx" lang="nginx">limit_req zone=limitClient burst=5
</code></pre>
<h3 data-id="heading-98">传输限速</h3>
<p>传输到达10m后限速为1m/s</p>
<pre><code class="hljs language-nginxlimit_rate" lang="nginxlimit_rate">limit_rate 1m
limit_rate_after 10m
</code></pre>
<h3 data-id="heading-99">针对客户端ip限制连接数</h3>
<p>在http块中，针对客户端ip限制连接数，最大连接数为5</p>
<pre><code class="hljs language-nginx" lang="nginx">limit_conn_zone $binary_remote_addr zone=limitClient:10m;
</code></pre>
<p>在location中</p>
<pre><code class="hljs language-nginx" lang="nginx">limit_conn limitClient 5
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[26 trait-多继承详解]]></title>    <link>https://juejin.cn/post/7576543407014068243</link>    <guid>https://juejin.cn/post/7576543407014068243</guid>    <pubDate>2025-11-26T02:32:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576543407014068243" data-draft-id="7576543407012970515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="26 trait-多继承详解"/> <meta itemprop="keywords" content="Scala"/> <meta itemprop="datePublished" content="2025-11-26T02:32:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="9274"/> <meta itemprop="url" content="https://juejin.cn/user/2270955579638731"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            26 trait-多继承详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2270955579638731/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    9274
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:32:02.000Z" title="Wed Nov 26 2025 02:32:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一. 多个trait的加载顺序</h2>
<p>实现多继承，注意观察父子类的构造器的执行顺序</p>
<ol>
<li>先父后子</li>
<li>有多个父类，按书写顺序从左到右执行</li>
</ol>
<p>例如：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8ad7d86e74a412ebe15748e7a96c02f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOTI3NA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729122&amp;x-signature=%2BmvIoLr8pAjFd4n5wLHbhEDSenU%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">A</span> </span>{
  println(<span class="hljs-string">"a"</span>)
}

<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">B</span> </span>{
  println(<span class="hljs-string">"b"</span>)
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Class1</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">A</span> <span class="hljs-keyword">with</span> <span class="hljs-title">B</span> </span>{
  println(<span class="hljs-string">"class1"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">new</span> <span class="hljs-type">Class1</span>()
}
</code></pre>
<p>结果如图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b0a14c4fd7d41a7b3525497153af0a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOTI3NA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729122&amp;x-signature=1yLMpI7OoU5LBcfTvUp6c9sDTPE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">二. 多层trait的加载顺序</h2>
<p>先执行父类中的构造器，再执行子类的构造器：如果trait1也有自己的父类，要先执行父类构造器</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b09c5051ffa43c0a4192b99b1e299c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOTI3NA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729122&amp;x-signature=%2BsJ3%2FB2z0IJgEheV9%2Bnb1jOkRpE%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-Scala" lang="Scala"><span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">A</span> </span>{
  println(<span class="hljs-string">"A"</span>)
}

<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">BB</span> </span>{
  println(<span class="hljs-string">"BB"</span>)
}

<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">B</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BB</span> </span>{
  println(<span class="hljs-string">"B"</span>)
}

<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">CC</span> </span>{
  println(<span class="hljs-string">"CC"</span>)
}

<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">C</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CC</span> </span>{
  println(<span class="hljs-string">"C"</span>)
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Class1</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">C</span> <span class="hljs-keyword">with</span> <span class="hljs-title">A</span> <span class="hljs-keyword">with</span> <span class="hljs-title">B</span> </span>{
  println(<span class="hljs-string">"Class1"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">new</span> <span class="hljs-type">Class1</span>()
}
</code></pre>
<p>结果如图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feccbcfd151c49c48da899e03998bac4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOTI3NA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729122&amp;x-signature=osCAINEXeHuPwqFUXzpePd1w9dM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">三. 空指针异常</h2>
<p>错误代码演示</p>
<pre><code class="hljs language-Scala" lang="Scala"><span class="hljs-keyword">import</span> java.io.<span class="hljs-type">FileWriter</span>

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Class24</span> </span>{

  <span class="hljs-comment">// 在文件中写入日志</span>
  <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">FileLogger</span> </span>{
    <span class="hljs-comment">// 抽象字段</span>
    <span class="hljs-keyword">val</span> filename: <span class="hljs-type">String</span>
    <span class="hljs-keyword">val</span> fileWriter = <span class="hljs-keyword">new</span> <span class="hljs-type">FileWriter</span>(filename, <span class="hljs-literal">true</span>)
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">writeLog</span></span>(msg: <span class="hljs-type">String</span>): <span class="hljs-type">Unit</span> = {
      fileWriter.write(msg)
      fileWriter.close()
    }
  }

  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyFileLogger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FileLogger</span> </span>{
    <span class="hljs-keyword">val</span> filename = <span class="hljs-string">"11-26.log"</span>
  }

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span></span>(args: <span class="hljs-type">Array</span>[<span class="hljs-type">String</span>]): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">val</span> fileLogger = <span class="hljs-keyword">new</span> <span class="hljs-type">MyFileLogger</span>()
    fileLogger.writeLog(<span class="hljs-string">"今天上午上scala课程"</span>)
  }

}
</code></pre>
<p>修改代码</p>
<pre><code class="hljs language-Scala" lang="Scala"><span class="hljs-keyword">lazy</span> <span class="hljs-keyword">val</span> fileWriter = <span class="hljs-keyword">new</span> <span class="hljs-type">FileWriter</span>(filename, <span class="hljs-literal">true</span>)
</code></pre>
<p>结果如图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b2d8aff15434f719daf0cb6faddcfba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgOTI3NA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729122&amp;x-signature=PUs2PzIP2P28kKqYO4OvatZ0KPs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">四. trait与抽象类的区别</h2>
<p><strong>相同点：</strong> 类和trait都可以定义成员变量（抽象，具体）；继承时都使用extends关键字；</p>
<p><strong>不同点：</strong> trait的构造器不能带参数；trait支持多继承；</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用wechatapi进行微信二次开发，微信api]]></title>    <link>https://juejin.cn/post/7576550156365250566</link>    <guid>https://juejin.cn/post/7576550156365250566</guid>    <pubDate>2025-11-26T02:23:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576550156365250566" data-draft-id="7576273949187522602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用wechatapi进行微信二次开发，微信api"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T02:23:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="找不到对象就NEW一个"/> <meta itemprop="url" content="https://juejin.cn/user/1672835912700475"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用wechatapi进行微信二次开发，微信api
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1672835912700475/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    找不到对象就NEW一个
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:23:15.000Z" title="Wed Nov 26 2025 02:23:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">默认模块 wechatapi.net</h2>
<p>Base URLs:  wechatapi.net</p>
<h2 data-id="heading-1">Authentication</h2>
<h2 data-id="heading-2">开发API/登录模块</h2>
<h3 data-id="heading-3">POST (步骤1)获取登录二维码</h3>
<p>POST /login/getLoginQrCode</p>
<ul>
<li>appId参数为设备ID，首次登录传空，会自动触发创建设备，掉线后重新登录则必须传接口返回的appId，注意<strong>同一个号避免重复创建设备</strong>，以免触发官方风控
<strong>- 登录时必须选择本省地区ID，如无本省地区ID请自行购买本省或本市代理IP</strong></li>
<li>如果<strong>IPAD类型扫码登录提示</strong> “在<strong>新设备完成验证以继续登录</strong>” 需要更换type为mac进行登录，切换顺序为ipad--&gt;mac。mac类型可以进行验证，<strong>当mac出现新设备验证时，参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fpost.wechatapi.net%2Flogin%2Fchecklogin" target="_blank" title="https://post.wechatapi.net/login/checklogin" ref="nofollow noopener noreferrer">执行登录接口</a>。也可以直接使用mac登录</strong></li>
<li><strong>取码时传的appId需要与上次登录扫码的微信一致，否则会导致登录失败</strong></li>
</ul>
<blockquote>
<p>如果需要全局代理（即所有接口都走代理，可直接在调用的接口内增加" useProxy:true "字段。useproxy字段默认为false不单独展示在各个接口内）但是有可能会影响接口的实时响应速度</p>
</blockquote>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.baidu.com%2Fs%2F1_lCoPDKSLUW90Ew4yKMyoQ%3Fpwd%3D1xdt" target="_blank" title="https://pan.baidu.com/s/1_lCoPDKSLUW90Ew4yKMyoQ?pwd=1xdt" ref="nofollow noopener noreferrer">代理TTUID点击下载</a></li>
</ul>

<p><strong>地区ID在前，地区在后</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">110000</span>*北京市|<span class="hljs-number">120000</span>*天津市|<span class="hljs-number">130000</span>*河北省|<span class="hljs-number">140000</span>*山西省|<span class="hljs-number">150000</span>*内蒙古
<span class="hljs-number">210000</span>*辽宁省|<span class="hljs-number">220000</span>*吉林省|<span class="hljs-number">230000</span>*黑龙江
<span class="hljs-number">310000</span>*上海市|<span class="hljs-number">320000</span>*江苏省|<span class="hljs-number">330000</span>*浙江省|<span class="hljs-number">340000</span>*安徽省|<span class="hljs-number">350000</span>*福建省|<span class="hljs-number">360000</span>*江西省|<span class="hljs-number">370000</span>*山东省
<span class="hljs-number">410000</span>*河南省|<span class="hljs-number">420000</span>*湖北省|<span class="hljs-number">430000</span>*湖南省|<span class="hljs-number">440000</span>*广东省|<span class="hljs-number">450000</span>*广西省|<span class="hljs-number">460000</span>*海南省
<span class="hljs-number">500000</span>*重庆市|<span class="hljs-number">510000</span>*四川省|<span class="hljs-number">520000</span>*贵州省|<span class="hljs-number">530000</span>*云南省|<span class="hljs-number">540000</span>*西藏自治区
<span class="hljs-number">610000</span>*陕西省|<span class="hljs-number">620000</span>*甘肃省|<span class="hljs-number">630000</span>*青海省|<span class="hljs-number">640000</span>*宁夏自治区|<span class="hljs-number">650000</span>*新疆自治区
</code></pre>

<ul>
<li>若目前支持的regionId中没有您所在的地区，可以自行采购socks5协议代理IP，填写到proxyIp参数中</li>
<li>响应结果中的qrImgBase64为二维码图片的base64，前端可使用此值展示给用户扫码。（或使用响应结果中的qrData生成二维码）</li>
<li>地区ID仅供测试，如需正常使用业务建议自行购买干净代理ip。</li>
</ul>
<blockquote>
<p>Body 请求参数</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"appId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"proxyIp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"regionId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"320000"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ipad"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"ttuid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"配合regionId/proxyIp使用,传ttuid程序生成的id"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-4">请求参数</h4>





























































<table><thead><tr><th>名称</th><th>位置</th><th>类型</th><th>必选</th><th>说明</th></tr></thead><tbody><tr><td>VideosApi-token</td><td>header</td><td>string</td><td>是</td><td>PS：API后台-点击访问控制-生成Token</td></tr><tr><td>body</td><td>body</td><td>object</td><td>否</td><td>none</td></tr><tr><td>» appId</td><td>body</td><td>string</td><td>否</td><td>设备ID，首次登录传空，之后传接口返回的appId</td></tr><tr><td>» proxyIp</td><td>body</td><td>string</td><td>否</td><td>代理IP 格式：socks5://username:password@123.2.2.2</td></tr><tr><td>» regionId</td><td>body</td><td>string</td><td>是</td><td>地区</td></tr><tr><td>» type</td><td>body</td><td>string</td><td>是</td><td>设备类型：ipad、mac（默认为ipad。</td></tr><tr><td>» ttuid</td><td>body</td><td>string</td><td>否</td><td>代理本机ID，需配合 regionId/proxyIp 使用，不单独使用。可临时借用用户的本地网络取码有50%概率跳过ipad验证。</td></tr></tbody></table>
<h5 data-id="heading-5">详细说明</h5>
<p><strong>» type</strong>: 设备类型：ipad、mac（默认为ipad。
独立appid）</p>
<blockquote>
<p>返回示例</p>
</blockquote>
<blockquote>
<p>200 Response</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ret"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"qrData"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"qrUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"appId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"qrImgBase64"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"uuid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-6">返回结果</h4>

















<table><thead><tr><th>状态码</th><th>状态码含义</th><th>说明</th><th>数据模型</th></tr></thead><tbody><tr><td>200</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7231%23section-6.3.1" target="_blank" title="https://tools.ietf.org/html/rfc7231#section-6.3.1" ref="nofollow noopener noreferrer">OK</a></td><td>none</td><td>Inline</td></tr></tbody></table>
<h4 data-id="heading-7">返回数据结构</h4>
<p>状态码 <strong>200</strong></p>













































































<table><thead><tr><th>名称</th><th>类型</th><th>必选</th><th>约束</th><th>中文名</th><th>说明</th></tr></thead><tbody><tr><td>» ret</td><td>integer</td><td>true</td><td>none</td><td/><td>none</td></tr><tr><td>» msg</td><td>string</td><td>true</td><td>none</td><td/><td>none</td></tr><tr><td>» data</td><td>object</td><td>true</td><td>none</td><td/><td>响应数据</td></tr><tr><td>»» qrData</td><td>string</td><td>true</td><td>none</td><td/><td>二维码内包含的信息</td></tr><tr><td>»» qrUrl</td><td>string</td><td>true</td><td>none</td><td/><td>二维码直接打开地址</td></tr><tr><td>»» appId</td><td>string</td><td>true</td><td>none</td><td/><td>设备ID</td></tr><tr><td>»» qrImgBase64</td><td>string</td><td>true</td><td>none</td><td/><td>二维码图片base64</td></tr><tr><td>»» uuid</td><td>string</td><td>true</td><td>none</td><td/><td>二维码的uuid</td></tr></tbody></table>
<h3 data-id="heading-8">POST (步骤2)执行登录</h3>
<p>POST /login/checkLogin</p>
<ul>
<li>增加<strong>ipad人脸识别验证</strong>和mac滑块验证，ipad<strong>仅支持IOS平台app扫码</strong>验证，mac滑块验证支持app扫码验证和系统自动验证，开发者集成平台也可自行集成APP滑块验证，具体请点击ipad登录或者mac登录查看详情</li>
<li>获取登录二维码<strong>扫码之后</strong>需<strong>每间隔5s调用本接口</strong>来判断是否登录成功，<strong>二维码超时时间为120秒</strong>
<strong>- 登录成功后logininfo有数据，如果没有数据则需要一直执行，直至出现登录数据或者失败为止。</strong></li>
<li>新设备登录平台，次日凌晨会掉线一次，重新登录时需调用<a href="https://link.juejin.cn?target=https%3A%2F%2Fpost.wechatapi.net%2Flogin%2Fgetloginqrcode" target="_blank" title="https://post.wechatapi.net/login/getloginqrcode" ref="nofollow noopener noreferrer">获取二维码且传appId取码</a>，登录成功后则可以长期在线</li>
<li>登录成功后请保存appId与wxid的对应关系，后续接口中会用到</li>
</ul>

  
    ☝️ 首次登录iPad出现**新设备验证**并且**无数字验证码**此时本接口会返回一个二维码网址，开发者需使用IOS设备下载[安盾APP](https://www.pgyer.com/renzhengapp)扫描二维码网址，扫描人脸通过后，再次调用本接口，手机点击确认，则本接口返回登录结果。如果不进行人脸认证则需要切换Mac登录，请查看Mac登录流程
    ☝️ 首次登录iPad出现**新设备验证**并且**有数字验证码**直接在captchCode字段输入数字验证码，继续执行登录即可登录。


<p><img alt="image.png转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>


  
  
    ☝️  首次登录Mac如果出现新设备验证，可以**选择自动验证**，不需要下载APP。
    ☝️    如果**不选择自动验证**会返回URL。生成二维码之后，需要使用[安卓设备下载APP](https://pan.baidu.com/s/19EEi3Au-IzGT7pN7dQQfFQ?pwd=81rg)，扫码进行图形验证。操作完成后继续调用此接口即可通过新设备验证。
    ☝️用户若有自己平台App，则可代码接入，无需下载App

<pre><code class="hljs language-ini" lang="ini">&lt;Frame <span class="hljs-attr">caption</span>=<span class="hljs-string">"Mac登录流程图，不清楚流程必看"</span>&gt;
</code></pre>
<p><img alt="Mac登录.png转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>


  

<blockquote>
<p>Body 请求参数</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"appId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"proxyIp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"uuid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"autoSliding"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"true"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-9">请求参数</h4>





























































<table><thead><tr><th>名称</th><th>位置</th><th>类型</th><th>必选</th><th>说明</th></tr></thead><tbody><tr><td>VideosApi-token</td><td>header</td><td>string</td><td>是</td><td>none</td></tr><tr><td>body</td><td>body</td><td>object</td><td>否</td><td>none</td></tr><tr><td>» appId</td><td>body</td><td>string</td><td>是</td><td>设备ID</td></tr><tr><td>» proxyIp</td><td>body</td><td>string</td><td>否</td><td>代理IP 格式：socks5://username:password@123.2.2.2</td></tr><tr><td>» uuid</td><td>body</td><td>string</td><td>是</td><td>获取二维码返回的uuid</td></tr><tr><td>» captchCode</td><td>body</td><td>string</td><td>否</td><td>扫码后手机提示输入的验证码，如未提示数字验证码可不传此字段。</td></tr><tr><td>» autoSliding</td><td>body</td><td>boolean</td><td>是</td><td>是否自动验证true/false，仅限mac使用。true为自动验证，false需要用app扫码验证。如果类型为ipad登录时必须传false。</td></tr></tbody></table>
<blockquote>
<p>返回示例</p>
</blockquote>
<blockquote>
<p>200 Response</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ret"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"uuid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"headImgUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"nickName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"expiredTime"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"loginInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"uin"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"wxid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"nickName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"mobile"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"alias"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-10">返回结果</h4>

















<table><thead><tr><th>状态码</th><th>状态码含义</th><th>说明</th><th>数据模型</th></tr></thead><tbody><tr><td>200</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7231%23section-6.3.1" target="_blank" title="https://tools.ietf.org/html/rfc7231#section-6.3.1" ref="nofollow noopener noreferrer">OK</a></td><td>none</td><td>Inline</td></tr></tbody></table>
<h4 data-id="heading-11">返回数据结构</h4>
<p>状态码 <strong>200</strong></p>





























































































































<table><thead><tr><th>名称</th><th>类型</th><th>必选</th><th>约束</th><th>中文名</th><th>说明</th></tr></thead><tbody><tr><td>» ret</td><td>integer</td><td>true</td><td>none</td><td/><td>none</td></tr><tr><td>» msg</td><td>string</td><td>true</td><td>none</td><td/><td>none</td></tr><tr><td>» data</td><td>object</td><td>true</td><td>none</td><td/><td>响应数据</td></tr><tr><td>»» uuid</td><td>string</td><td>true</td><td>none</td><td/><td>二维码的uuid</td></tr><tr><td>»» headImgUrl</td><td>string</td><td>true</td><td>none</td><td/><td>头像地址</td></tr><tr><td>»» nickName</td><td>string</td><td>true</td><td>none</td><td/><td>昵称</td></tr><tr><td>»» expiredTime</td><td>integer</td><td>true</td><td>none</td><td/><td>二维码超时时间</td></tr><tr><td>»» status</td><td>integer</td><td>true</td><td>none</td><td/><td>登录状态 0：未扫码 1：已扫码未登录 2：登录成功 4：已扫码取消登录</td></tr><tr><td>»» loginInfo</td><td>object</td><td>true</td><td>none</td><td/><td>登录成功信息</td></tr><tr><td>»»» uin</td><td>integer</td><td>true</td><td>none</td><td/><td>uin</td></tr><tr><td>»»» wxid</td><td>string</td><td>true</td><td>none</td><td/><td>微信ID，返回此值则是登录成功</td></tr><tr><td>»»» nickName</td><td>string</td><td>true</td><td>none</td><td/><td>昵称</td></tr><tr><td>»»» mobile</td><td>string</td><td>true</td><td>none</td><td/><td>绑定的手机号</td></tr><tr><td>»»» alias</td><td>string</td><td>true</td><td>none</td><td/><td>微信号</td></tr></tbody></table>
<h3 data-id="heading-12">POST 弹框登录</h3>
<p>POST /login/dialogLogin</p>
<ul>
<li>调用本接口后手机会弹框确认登录页面，点确认后调用<a href="https://link.juejin.cn?target=https%3A%2F%2Fpost.wechatapi.net%2Flogin%2Fchecklogin" target="_blank" title="https://post.wechatapi.net/login/checklogin" ref="nofollow noopener noreferrer">执行登录接口</a>检测是否登录成功</li>
</ul>

<p><strong>地区ID在前，地区在后</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-number">110000</span>*北京市|<span class="hljs-number">120000</span>*天津市|<span class="hljs-number">130000</span>*河北省|<span class="hljs-number">140000</span>*山西省|<span class="hljs-number">150000</span>*内蒙古
<span class="hljs-number">210000</span>*辽宁省|<span class="hljs-number">220000</span>*吉林省|<span class="hljs-number">230000</span>*黑龙江
<span class="hljs-number">310000</span>*上海市|<span class="hljs-number">320000</span>*江苏省|<span class="hljs-number">330000</span>*浙江省|<span class="hljs-number">340000</span>*安徽省|<span class="hljs-number">350000</span>*福建省|<span class="hljs-number">360000</span>*江西省|<span class="hljs-number">370000</span>*山东省
<span class="hljs-number">410000</span>*河南省|<span class="hljs-number">420000</span>*湖北省|<span class="hljs-number">430000</span>*湖南省|<span class="hljs-number">440000</span>*广东省|<span class="hljs-number">450000</span>*广西省|<span class="hljs-number">460000</span>*海南省
<span class="hljs-number">500000</span>*重庆市|<span class="hljs-number">510000</span>*四川省|<span class="hljs-number">520000</span>*贵州省|<span class="hljs-number">530000</span>*云南省|<span class="hljs-number">540000</span>*西藏自治区
<span class="hljs-number">610000</span>*陕西省|<span class="hljs-number">620000</span>*甘肃省|<span class="hljs-number">630000</span>*青海省|<span class="hljs-number">640000</span>*宁夏自治区|<span class="hljs-number">650000</span>*新疆自治区
</code></pre>

<ul>
<li>若目前支持的regionId中没有您所在的地区，可以自行采购socks5协议代理IP，填写到proxyIp参数中</li>
<li>使用本接口登录并非100%成功，本接口返回失败后，可通过扫码登录的方式登录
<ul>
<li>以下几种情况无法使用本接口登录：
<ul>
<li>手机点击退出登录</li>
<li>新设备登录次日</li>
<li>官方风控下线</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>Body 请求参数</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"appId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wx_wR_U4zPj2M_OTS3BCyoE4"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"proxyIp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"regionId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"320000"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-13">请求参数</h4>















































<table><thead><tr><th>名称</th><th>位置</th><th>类型</th><th>必选</th><th>说明</th></tr></thead><tbody><tr><td>VideosApi-token</td><td>header</td><td>string</td><td>是</td><td>none</td></tr><tr><td>body</td><td>body</td><td>object</td><td>否</td><td>none</td></tr><tr><td>» appId</td><td>body</td><td>string</td><td>是</td><td>设备ID</td></tr><tr><td>» proxyIp</td><td>body</td><td>string</td><td>是</td><td>代理IP 格式：socks5://username:password@123.2.2.2</td></tr><tr><td>» regionId</td><td>body</td><td>string</td><td>是</td><td>地区</td></tr></tbody></table>
<blockquote>
<p>返回示例</p>
</blockquote>
<blockquote>
<p>200 Response</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ret"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"appId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"uuid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-14">返回结果</h4>

















<table><thead><tr><th>状态码</th><th>状态码含义</th><th>说明</th><th>数据模型</th></tr></thead><tbody><tr><td>200</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7231%23section-6.3.1" target="_blank" title="https://tools.ietf.org/html/rfc7231#section-6.3.1" ref="nofollow noopener noreferrer">OK</a></td><td>none</td><td>Inline</td></tr></tbody></table>
<h4 data-id="heading-15">返回数据结构</h4>
<p>状态码 <strong>200</strong></p>





















































<table><thead><tr><th>名称</th><th>类型</th><th>必选</th><th>约束</th><th>中文名</th><th>说明</th></tr></thead><tbody><tr><td>» ret</td><td>integer</td><td>true</td><td>none</td><td/><td>none</td></tr><tr><td>» msg</td><td>string</td><td>true</td><td>none</td><td/><td>none</td></tr><tr><td>» data</td><td>object</td><td>true</td><td>none</td><td/><td>响应数据</td></tr><tr><td>»» appId</td><td>string</td><td>true</td><td>none</td><td/><td>设备ID</td></tr><tr><td>»» uuid</td><td>string</td><td>true</td><td>none</td><td/><td>二维码uuid，执行登录时会用到</td></tr></tbody></table>
<h3 data-id="heading-16">POST 退出</h3>
<p>POST /login/logout</p>
<p>可以只填写appid或者按照示例直接传即可</p>
<blockquote>
<p>Body 请求参数</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"appId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"proxyIp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"regionId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"88"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-17">请求参数</h4>

































<table><thead><tr><th>名称</th><th>位置</th><th>类型</th><th>必选</th><th>说明</th></tr></thead><tbody><tr><td>VideosApi-token</td><td>header</td><td>string</td><td>是</td><td>none</td></tr><tr><td>body</td><td>body</td><td>object</td><td>否</td><td>none</td></tr><tr><td>» appId</td><td>body</td><td>string</td><td>是</td><td>设备ID</td></tr></tbody></table>
<blockquote>
<p>返回示例</p>
</blockquote>
<blockquote>
<p>200 Response</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ret"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"操作成功"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-18">返回结果</h4>

















<table><thead><tr><th>状态码</th><th>状态码含义</th><th>说明</th><th>数据模型</th></tr></thead><tbody><tr><td>200</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7231%23section-6.3.1" target="_blank" title="https://tools.ietf.org/html/rfc7231#section-6.3.1" ref="nofollow noopener noreferrer">OK</a></td><td>none</td><td>Inline</td></tr></tbody></table>
<h4 data-id="heading-19">返回数据结构</h4>
<p>状态码 <strong>200</strong></p>





























<table><thead><tr><th>名称</th><th>类型</th><th>必选</th><th>约束</th><th>中文名</th><th>说明</th></tr></thead><tbody><tr><td>» ret</td><td>integer</td><td>true</td><td>none</td><td/><td>none</td></tr><tr><td>» msg</td><td>string</td><td>true</td><td>none</td><td/><td>none</td></tr></tbody></table>
<h3 data-id="heading-20">POST 检查是否在线</h3>
<p>POST /login/checkOnline</p>
<p>响应结果的data=true则是在线，反之为离线</p>
<blockquote>
<p>Body 请求参数</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"appId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{{appid}}"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-21">请求参数</h4>

































<table><thead><tr><th>名称</th><th>位置</th><th>类型</th><th>必选</th><th>说明</th></tr></thead><tbody><tr><td>VideosApi-token</td><td>header</td><td>string</td><td>是</td><td>none</td></tr><tr><td>body</td><td>body</td><td>object</td><td>否</td><td>none</td></tr><tr><td>» appId</td><td>body</td><td>string</td><td>是</td><td>设备ID</td></tr></tbody></table>
<blockquote>
<p>返回示例</p>
</blockquote>
<blockquote>
<p>200 Response</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ret"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"操作成功"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-22">返回结果</h4>

















<table><thead><tr><th>状态码</th><th>状态码含义</th><th>说明</th><th>数据模型</th></tr></thead><tbody><tr><td>200</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7231%23section-6.3.1" target="_blank" title="https://tools.ietf.org/html/rfc7231#section-6.3.1" ref="nofollow noopener noreferrer">OK</a></td><td>none</td><td>Inline</td></tr></tbody></table>
<h4 data-id="heading-23">返回数据结构</h4>
<p>状态码 <strong>200</strong></p>





































<table><thead><tr><th>名称</th><th>类型</th><th>必选</th><th>约束</th><th>中文名</th><th>说明</th></tr></thead><tbody><tr><td>» ret</td><td>integer</td><td>true</td><td>none</td><td/><td>none</td></tr><tr><td>» msg</td><td>string</td><td>true</td><td>none</td><td/><td>none</td></tr><tr><td>» data</td><td>boolean</td><td>true</td><td>none</td><td/><td>none</td></tr></tbody></table>
<h3 data-id="heading-24">POST 异常断线重连</h3>
<p>POST /login/reconnection</p>
<p>账号在线，但是收不到回调  调用此接口</p>
<blockquote>
<p>Body 请求参数</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"appId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-25">请求参数</h4>

































<table><thead><tr><th>名称</th><th>位置</th><th>类型</th><th>必选</th><th>说明</th></tr></thead><tbody><tr><td>VideosApi-token</td><td>header</td><td>string</td><td>是</td><td>none</td></tr><tr><td>body</td><td>body</td><td>object</td><td>否</td><td>none</td></tr><tr><td>» appId</td><td>body</td><td>string</td><td>是</td><td>设备ID</td></tr></tbody></table>
<blockquote>
<p>返回示例</p>
</blockquote>
<blockquote>
<p>200 Response</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ret"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"操作成功"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-26">返回结果</h4>

















<table><thead><tr><th>状态码</th><th>状态码含义</th><th>说明</th><th>数据模型</th></tr></thead><tbody><tr><td>200</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7231%23section-6.3.1" target="_blank" title="https://tools.ietf.org/html/rfc7231#section-6.3.1" ref="nofollow noopener noreferrer">OK</a></td><td>none</td><td>Inline</td></tr></tbody></table>
<h4 data-id="heading-27">返回数据结构</h4>
<p>状态码 <strong>200</strong></p>





































<table><thead><tr><th>名称</th><th>类型</th><th>必选</th><th>约束</th><th>中文名</th><th>说明</th></tr></thead><tbody><tr><td>» ret</td><td>integer</td><td>true</td><td>none</td><td/><td>none</td></tr><tr><td>» msg</td><td>string</td><td>true</td><td>none</td><td/><td>none</td></tr><tr><td>» data</td><td>boolean</td><td>true</td><td>none</td><td/><td>none</td></tr></tbody></table>
<h3 data-id="heading-28">POST 无感切换代理ip</h3>
<p>POST /login/setProxy</p>
<p>账号更换代理ip，可实现在线切换。
也可退出后重新登录传新的代理ip。</p>
<blockquote>
<p>Body 请求参数</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"appId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{{appid}}"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"proxyIp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"socks5://x:x@111.153.185.21:11332"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-29">请求参数</h4>








































<table><thead><tr><th>名称</th><th>位置</th><th>类型</th><th>必选</th><th>说明</th></tr></thead><tbody><tr><td>VideosApi-token</td><td>header</td><td>string</td><td>是</td><td>none</td></tr><tr><td>body</td><td>body</td><td>object</td><td>否</td><td>none</td></tr><tr><td>» appId</td><td>body</td><td>string</td><td>是</td><td>设备ID</td></tr><tr><td>» proxyIp</td><td>body</td><td>string</td><td>是</td><td>代理ip</td></tr></tbody></table>
<blockquote>
<p>返回示例</p>
</blockquote>
<blockquote>
<p>200 Response</p>
</blockquote>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ret"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-30">返回结果</h4>

















<table><thead><tr><th>状态码</th><th>状态码含义</th><th>说明</th><th>数据模型</th></tr></thead><tbody><tr><td>200</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Ftools.ietf.org%2Fhtml%2Frfc7231%23section-6.3.1" target="_blank" title="https://tools.ietf.org/html/rfc7231#section-6.3.1" ref="nofollow noopener noreferrer">OK</a></td><td>none</td><td>Inline</td></tr></tbody></table>
<h4 data-id="heading-31">返回数据结构</h4>
<p>状态码 <strong>200</strong></p>





























<table><thead><tr><th>名称</th><th>类型</th><th>必选</th><th>约束</th><th>中文名</th><th>说明</th></tr></thead><tbody><tr><td>» ret</td><td>integer</td><td>true</td><td>none</td><td/><td>none</td></tr><tr><td>» msg</td><td>string</td><td>true</td><td>none</td><td/><td>none</td></tr></tbody></table>
<h2 data-id="heading-32">数据模型</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎮 用 TRAE AI 打造一个会下棋的 Java 五子棋：从零构建 + 自动规划 + GUI 实现]]></title>    <link>https://juejin.cn/post/7576569518261698560</link>    <guid>https://juejin.cn/post/7576569518261698560</guid>    <pubDate>2025-11-26T02:36:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576569518261698560" data-draft-id="7576559408658907188" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎮 用 TRAE AI 打造一个会下棋的 Java 五子棋：从零构建 + 自动规划 + GUI 实现"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-26T02:36:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天摸鱼的java工程师"/> <meta itemprop="url" content="https://juejin.cn/user/3109843365802925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎮 用 TRAE AI 打造一个会下棋的 Java 五子棋：从零构建 + 自动规划 + GUI 实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3109843365802925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天摸鱼的java工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:36:26.000Z" title="Wed Nov 26 2025 02:36:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎮 用 TRAE AI 打造一个会下棋的 Java 五子棋：从零构建 + 自动规划 + GUI 实现</h2>
<blockquote>
<p>🧑‍💻 作者：天天摸鱼的java工程师<br/>
🧠 项目：基于 TRAE AI 的 Java 五子棋项目构建实践<br/>
🛠 技术关键词：TRAE、Java Swing、AI 对战、项目自动规划、GUI 游戏</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">🧭 前言：除了写文档，AI 还能帮我写游戏？</h3>
<p>在我完成了 RuoYi-Cloud 项目的文档自动生成之后（相关文章传送门🔗），我开始思考：</p>
<blockquote>
<p>TRAE 除了能分析项目、画架构图，它能不能真的“<strong>写一个完整的 Java 项目</strong>”？</p>
</blockquote>
<p>于是我决定挑战一个最经典的 Java 桌面项目 —— <strong>“五子棋” AI 对战版</strong>。</p>
<p>不仅要能玩，还要能自动下棋、判断胜负、带 GUI、能打败人类。</p>
<p>最终，我用 TRAE 成功完成了一个可运行的 Java 五子棋项目，并实现如下功能：</p>
<ul>
<li>✅ AI 玩家 vs 人类玩家</li>
<li>✅ 基于 Swing 的图形化界面</li>
<li>✅ 自动胜负判断与提示</li>
<li>✅ 项目结构自动规划 + 任务拆解</li>
</ul>
<hr/>
<h3 data-id="heading-2">🧠 用 TRAE 规划五子棋 AI 项目开发任务</h3>
<p>和传统写代码不同，这次我先让 TRAE 帮我梳理整个开发流程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd65400cc49c44fb8a60370f96f27997~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5pG46bG855qEamF2YeW3peeoi-W4iA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729386&amp;x-signature=nyqop26W5jhHQ6%2FCmao%2F%2FdzcidE%3D" alt="image.png" loading="lazy"/></p>
<p>TRAE 自动为我生成了一个五步任务清单：</p>
<ol>
<li>创建基本类和结构（如 <code>Board</code>、<code>AIPlayer</code>、<code>Gui</code>）</li>
<li>实现棋盘逻辑（落子、胜负判断）</li>
<li>构建图形用户界面（GUI）</li>
<li>实现 AI 对手逻辑（自动落子）</li>
<li>整合运行逻辑，实现完整对局流程</li>
</ol>
<p>这个任务拆解非常贴近真实开发流程，<strong>比我自己列的还清晰</strong>，而且每一步都会自动提示下一步代码如何实现。</p>
<hr/>
<h3 data-id="heading-3">🧱 项目结构一览：经典 Java 风格 + AI 模块</h3>
<p>项目目录结构如下：</p>
<pre><code class="hljs language-less" lang="less">└── <span class="hljs-selector-tag">study</span>/
    ├── <span class="hljs-selector-tag">Board</span><span class="hljs-selector-class">.java</span>         <span class="hljs-comment">// 棋盘管理与胜负判断</span>
    ├── <span class="hljs-selector-tag">AIPlayer</span><span class="hljs-selector-class">.java</span>      <span class="hljs-comment">// 简易 AI 策略实现</span>
    ├── <span class="hljs-selector-tag">Gui</span><span class="hljs-selector-class">.java</span>           <span class="hljs-comment">// 游戏主界面（基于 Swing）</span>
    ├── <span class="hljs-selector-tag">Main</span><span class="hljs-selector-class">.java</span>          <span class="hljs-comment">// 启动入口</span>
</code></pre>
<h4 data-id="heading-4">🎯 核心类说明：</h4>
<ul>
<li><code>Board</code>：二维数组表示棋盘，负责落子、判断胜负</li>
<li><code>AIPlayer</code>：简单 AI 实现（随机或优先中心策略）</li>
<li><code>Gui</code>：绘制棋盘、处理点击事件、显示胜负提示</li>
<li><code>Main</code>：初始化窗口并启动游戏</li>
</ul>
<hr/>
<h3 data-id="heading-5">🖼 界面展示：Swing + 状态提示 + AI 对战</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79589eb5e39e4061aff7d61c2990337b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSp5aSp5pG46bG855qEamF2YeW3peeoi-W4iA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729386&amp;x-signature=dweTyFgEWG1dHdirD7c5iNKEcgQ%3D" alt="image.png" loading="lazy"/></p>
<p>图中可以看到，TRAE 为我生成的 GUI 结构包含：</p>
<ul>
<li>✅ Swing 窗口与棋盘绘制</li>
<li>✅ 胜负提示（使用 <code>JLabel</code> + <code>JOptionPane</code>）</li>
<li>✅ AI 自动落子逻辑（在 <code>SwingWorker</code> 中异步执行）</li>
</ul>
<p>代码片段示例：</p>
<pre><code class="hljs language-ini" lang="ini">if (board.isGameOver()) {
    boolean <span class="hljs-attr">lastMoveIsBlack</span> = board.isBlackTurn()<span class="hljs-comment">;</span>
    String <span class="hljs-attr">winner</span> = lastMoveIsBlack ? <span class="hljs-string">"黑棋"</span> : <span class="hljs-string">"白棋"</span><span class="hljs-comment">;</span>
    String <span class="hljs-attr">winnerText</span> = <span class="hljs-string">"AI"</span><span class="hljs-comment">;</span>
    statusLabel.setText("游戏结束！" + winnerText + " 获胜！")<span class="hljs-comment">;</span>
    JOptionPane.showMessageDialog(gui.this, winnerText + " 获胜！", "游戏结束", JOptionPane.INFORMATION_MESSAGE)<span class="hljs-comment">;</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-6">🧠 AI 实现逻辑：基础但可扩展</h3>
<p>目前 AI 策略比较基础，采用“随机可落子点 + 局部最优”策略。但 TRAE 为我生成的 <code>AIPlayer.java</code> 非常清晰，后续可以进一步优化为：</p>
<ul>
<li>✅ 局部搜索 + 简单评估函数</li>
<li>✅ 模拟对手落子后评分（MiniMax 雏形）</li>
<li>✅ 添加难度等级选择</li>
</ul>
<hr/>
<h3 data-id="heading-7">🚀 从 0 到 1：TRAE 如何辅助我完成五子棋项目</h3>
<p>这次项目中，TRAE 不只是“生成代码这么简单”，它做了这些关键事：</p>





























<table><thead><tr><th>阶段</th><th>TRAE 帮我做了什么</th></tr></thead><tbody><tr><td>🧱 项目初始化</td><td>自动拆解任务，规划类结构</td></tr><tr><td>🧑‍💻 编码实现</td><td>提供每一类的初始代码模板</td></tr><tr><td>🧠 逻辑推理</td><td>自动补全胜负判断逻辑</td></tr><tr><td>🖼 GUI 构建</td><td>自动生成 Swing 组件结构</td></tr><tr><td>🧪 集成测试</td><td>提示如何 main 函数驱动整体运行</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-8">🧩 我学到的：AI 正在成为开发者的“副驾驶”</h3>
<p>这次用 TRAE 写五子棋的体验让我意识到：</p>
<blockquote>
<p>未来的开发，不再只是一个人对着 IDE 写代码，<strong>而是你 + AI 合作完成一整个项目</strong>。</p>
</blockquote>
<p>AI 可以帮你：</p>
<ul>
<li>更快搭建项目结构</li>
<li>更清晰拆解开发任务</li>
<li>更轻松构建完整功能</li>
<li>更专注在核心逻辑上发挥创造力</li>
</ul>
<hr/>
<h3 data-id="heading-9">📌 项目总结</h3>





























<table><thead><tr><th>项目名</th><th>Java 五子棋 AI 对战版</th></tr></thead><tbody><tr><td>实现功能</td><td>人机对战、自动胜负判断、图形界面</td></tr><tr><td>技术栈</td><td>Java 8 + Swing</td></tr><tr><td>AI 策略</td><td>简单启发式 + 随机落子</td></tr><tr><td>开发方式</td><td>全过程由 TRAE AI 辅助规划与生成</td></tr><tr><td>所属活动</td><td>TRAE SOLO 技术挑战赛</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-10">🧠 后续计划</h3>
<p>我计划基于此项目继续扩展：</p>
<ul>
<li>添加网络对战功能（Socket）</li>
<li>引入 MiniMax + AlphaBeta 剪枝策略</li>
<li>使用 JavaFX 重构界面体验</li>
<li>打包为可运行 <code>.jar</code> 文件供下载</li>
</ul>
<hr/>
<h3 data-id="heading-11">📣 最后</h3>
<p>TRAE 不只是一个“写文档”的 AI，它真正能成为你开发过程中的得力助手，<strong>让你更快、更稳、更系统地交付完整项目。</strong></p>
<p>如果你也在做 Java、或者想挑战 AI 辅助开发，不妨来 TRAE SOLO 玩一把，做点真正有趣的事！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[小佛陀漫画怎么做？深扒中老年高互动赛道，用n8n流水线批量打造]]></title>    <link>https://juejin.cn/post/7576550156365381638</link>    <guid>https://juejin.cn/post/7576550156365381638</guid>    <pubDate>2025-11-26T02:33:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576550156365381638" data-draft-id="7576550156365103110" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="小佛陀漫画怎么做？深扒中老年高互动赛道，用n8n流水线批量打造"/> <meta itemprop="keywords" content="AIGC,Agent,人工智能"/> <meta itemprop="datePublished" content="2025-11-26T02:33:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="后端小肥肠"/> <meta itemprop="url" content="https://juejin.cn/user/2966945320667536"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            小佛陀漫画怎么做？深扒中老年高互动赛道，用n8n流水线批量打造
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2966945320667536/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    后端小肥肠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:33:42.000Z" title="Wed Nov 26 2025 02:33:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>大家好，我是小肥肠！今天带来 n8n硬核新实战： 只需提交标题，AI 包办文案生图，几分钟后，神韵十足的小佛陀漫画一键写入你的本地磁盘！</strong></p>
<h2 data-id="heading-0">1. 工作流效果演示</h2>
<p>最近有很多朋友来问我有没有小佛陀漫画生成的工作流，这个赛道偏中老年，主要是互动率很高，以我找的一个小佛陀类型的账号为例，这个账号阅读817，点赞218，在看188，留言324，喜欢的人数居然高达11。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ebb4b03724d40f4b83b8a02eef69e66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=VZpyruNDPXH8qB5DmGOZw6iHtzo%3D" alt="" loading="lazy"/></p>
<p>这类赛道主要是高能量祝福类文案配上可爱的小佛陀图片。<strong>这类图文深受喜爱的主要原因是可以把文案写到人的心坎上。</strong></p>
<p>小佛陀这个热度我记得已经很久了应该有很多Coze的工作流来实现了。细问下来才知道Coze总会触发防御机制不给生成，我自己跑去搭了一下还真是。</p>
<p>由于来问我的友友还是挺多，于是就动手搭了一个<strong>n8n</strong> <strong>工作流</strong> <strong>来生成小佛陀漫画</strong>。先来看一下工作流的实现效果。完整工作流如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/178fcea715ca4776a5717120f723dc88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=jlwqwKU71U0kHQAAlsv3AccIEfs%3D" alt="" loading="lazy"/></p>
<p>使用很简单，点击底部的【Excute workflow】按钮，在弹出的表单中填写小佛陀漫画的标题：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb88747394734dd3ae5e90eadcb13509~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=2oxCEl7tZv2C4HsP5%2FUbOys2ArQ%3D" alt="" loading="lazy"/></p>
<p>等待几分钟后小佛陀漫画就出现在了我们的本地磁盘当中：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cbbe6929f1643029013c6247503f147~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=h77lOSSAqDNiLuUSndBj0M4CuC8%3D" alt="" loading="lazy"/></p>
<p>成品图如下，我贴了三张（字体没有精调，大家可以在提示词中精调一下字体形式）：</p>
<p>封面：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a86d9c2fbc7f48c69d09fe2c01925edb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=XMQRlrBCG15fxPdiY10GT90xdXI%3D" alt="" loading="lazy"/></p>
<p>正文图1：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4695693531e416c8c0f722dbb3c6393~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=2SyIm4kl3qrzOxreX1VI7vwBcnk%3D" alt="" loading="lazy"/></p>
<p>正文图2：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b962172cdbd4f1886bbb2e03d10da3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=vCLj5n4VDFG%2ByeA2YVFB%2Fme8rZs%3D" alt="" loading="lazy"/></p>
<p><strong>这个</strong> <strong>工作流</strong> <strong>可以改成全自动执行，只要将开始节点改为定时节点，再激活工作流，小佛陀漫画就能被每天定时写入你的磁盘，实现无人值守流水线生产，感兴趣就码住跟练吧~</strong></p>
<h2 data-id="heading-1">2.工作流搭建前置准备</h2>
<p><strong>本</strong> <strong>工作流</strong> <strong>生图依托通义万相2.5</strong> <strong>MCP</strong> <strong>Server，需要先去对应网站开通服务。</strong></p>
<p>通义万相2.5-图像视频生成开通地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbailian.console.aliyun.com%2F%3Fspm%3Da2c4g.11186623.0.0.7f477980N1ex6P%26tab%3Dmcp%23%2Fmcp-market%2Fdetail%2FWan25Media" target="_blank" title="https://bailian.console.aliyun.com/?spm=a2c4g.11186623.0.0.7f477980N1ex6P&amp;tab=mcp#/mcp-market/detail/Wan25Media" ref="nofollow noopener noreferrer">bailian.console.aliyun.com/?spm=a2c4g.…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fd7b5c8e6ca44a29e2864a4333cee27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=SJcdGwu2xI2KXSgOOJ%2F2Y0MPc24%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3. 工作流搭建</h2>
<p>生成小佛陀漫画的完整工作流为：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bba4abe869d44523979c6f3f0ddabeaf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=SqQ9XCbfx54eico8XwGSefh4SdQ%3D" alt="" loading="lazy"/></p>
<p><strong>开始节点：</strong> 开始节点选择为<strong>On form submission</strong>，意为提交表单后启动工作流。</p>
<p><strong>生成文案（AI Agent）</strong> ：开始节点出来后点击【+】新增<strong>AI Agent，</strong> 这个节点的作用是基于<strong>Gemini 2.5 Pro</strong>，根据开始节点中输入的标题生成小佛陀漫画文案。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b1ca93039e54ec88331994420016265~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=VToXMAJr9QydNNF%2Fw%2B%2BZw3May3s%3D" alt="" loading="lazy"/></p>
<p><strong>Code in</strong> <strong>JavaScript</strong>：生成文案（AI Agent）节点出来后点击【+】新增<strong>Code in JavaScript</strong>节点。这个节点的作用是将前置节点输出的文案基于\n分割为文案列表。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bdd618f3a0044e8b0e3d1f41ece62a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=fEGY46Q7FOm0jMCyEVphb1xsPFE%3D" alt="" loading="lazy"/></p>
<p><strong>源代码</strong> <strong>：</strong></p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">content</span> = <span class="hljs-variable">$input</span>.first().json.output<span class="hljs-comment">;</span>
if (!content) {
  return { json: { list: <span class="hljs-section">[]</span> } }<span class="hljs-comment">;</span>
}
const <span class="hljs-attr">stringArray</span> = content.split(<span class="hljs-string">'\n'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">cleanList</span> = stringArray.filter(item =&gt; item.trim() !== <span class="hljs-string">""</span>)<span class="hljs-comment">;</span>
return {
  json: {
    list: cleanList
  }
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-3">3.1. 生成封面</h3>
<p><strong>生成封面（AI Agent）</strong> ：<strong>Code in</strong> <strong>JavaScript</strong>节点出来后点击【+】新增AI Agent节点。这个节点的作用是基于文案生成小佛陀漫画的公众号封面图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b44099b71f1c456cbac8a3152a00fd41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=nyg%2BT%2BgAJIUOBqNtkJ2U1ksZzxY%3D" alt="" loading="lazy"/></p>
<p>提示词编写思路：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 结合前置文案生成符合意境的背景图
<span class="hljs-bullet">2.</span> 将固定IP形象的小佛陀放置在画面对应位置
<span class="hljs-bullet">3.</span> 返回图片链接
</code></pre>
<ul>
<li>Chat Model处点击【+】新增OpenAI Chat Mode（或DeepSeek Chat Model）。</li>
<li>Tool处点击【+】新增MCP Client Tool用于图片生成。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/213831053c084fb88849aa4e773b6f43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=YHUiLldWcEgviaDuYFNOAeiIBcU%3D" alt="" loading="lazy"/></p>
<p>Endpoint填写<a href="https://link.juejin.cn?target=https%3A%2F%2Fdashscope.aliyuncs.com%2Fapi%2Fv1%2Fmcps%2FWan25Media%2Fsse%25E3%2580%2582" target="_blank" title="https://dashscope.aliyuncs.com/api/v1/mcps/Wan25Media/sse%E3%80%82" ref="nofollow noopener noreferrer">dashscope.aliyuncs.com/api/v1/mcps…</a></p>
<p>Server Transport选择Server Sent Events (Deprecated)。</p>
<p>Authentication选择Header Auth。</p>
<p>Credential for Header Auth点击Create new credential，Name填写Authorization，Value填写阿里云百炼的key，注意key前面需要加Bearer和一个英文空格。<strong>最后把这个Auth命名为bailian，以便后续节点使用。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9282040efca542aaa8e0784daa9d42af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=Myh3QLrHMYoiPK4t2LMjSCkvuKE%3D" alt="" loading="lazy"/></p>
<p><strong>Edit Fields：</strong> 生成封面（AI Agent）节点出来后点击【+】新增<strong>Edit Fields</strong>节点，这个节点的作用是对封面图的属性名进行重命名为fm。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1adfcd454e29431cb5f5471c75141826~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=UMaWQrJj%2FDC7L8BzuFAOErmO08g%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">3.2 生成正文</h3>
<p><strong>Split Out</strong>:<strong>Code in</strong> <strong>JavaScript</strong>节点出来后点击【+】新增<strong>Split Out</strong>节点。这个节点的作用是拆分遍历前置节点生成的文案列表。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73618de246714670b459a89b76de0149~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=cYlDf5uqJp5JeEk%2Fj%2FKd3YRspi0%3D" alt="" loading="lazy"/></p>
<p><strong>Edit Fields</strong>:<strong>Split Out</strong>节点出来后点击【+】新增<strong>Edit Fields</strong>节点，这个节点的作用是记录循环轮数以及取出前置节点生成的文案内容。</p>
<ul>
<li>点击【Add Field】字段名称命名为round_number，value填写{{ $itemIndex}}</li>
<li>将前置节点的文案字段（list）拖入Fields to Set面板</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c838d613abab484cb44a9438d020a16c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=uG8Hf9rc%2FWY7%2BA62bVtrGcYT9WY%3D" alt="" loading="lazy"/></p>
<p><strong>生成正文（AI Agent）</strong> ：<strong>Edit Fields</strong>节点出来后点击【+】新增<strong>AI Agent</strong>节点，这个节点的作用是基于文案和循环轮数的奇偶性生成图片。偶数轮数小佛陀在右边，奇数轮数反之。<code>节点的配置在封面章节已经演示过，这里不再赘述。</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/814de539717a40f0a0a24e3e7861b7e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=ePBR2aQUKxOwjJdGXSnF0MP0wP4%3D" alt="" loading="lazy"/></p>
<p>提示词编写思路：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 基于循环轮数判断小佛陀在画面的位置，偶数在右奇数反之
<span class="hljs-bullet">2.</span> 结合前置文案生成符合意境的背景图
<span class="hljs-bullet">3.</span> 将固定IP形象的小佛陀放置在画面对应位置
<span class="hljs-bullet">4.</span> 将文案写入图片
<span class="hljs-bullet">5.</span> 返回图片链接
</code></pre>
<p><strong>Code in</strong> <strong>JavaScript</strong> <strong>：</strong> 生成正文（AI Agent）节点出来后点击【+】新增<strong>Code in JavaScript</strong>，这个节点的作用是将前置节点生成的图片链接集成为数组。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a2683ec84b44ef2a2cb3ae4fb50ca41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=Qwtv1Etzn9O6y%2Fxz7noOMoVZ2u4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">3.3. 写入本地磁盘</h3>
<p><strong>Merge</strong>：<strong>Code in</strong> <strong>JavaScript</strong>和<strong>Edit Fields</strong>节点出来后点击新增<strong>Merge</strong>节点，集成前置节点生成的封面图和正文漫画等元素。</p>
<ul>
<li>Mode选择Combine</li>
<li>Combine By选择Position</li>
<li>Number of Inputs选择2</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9ece3c03c1645cb9748e91418f37762~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=NDXbn1NVZvui7BpgNCkW5wS9rag%3D" alt="" loading="lazy"/></p>
<p><strong>HTTP Request</strong>（写封面）：<strong>Merge</strong>出来后点击【+】添加<strong>HTTP Request</strong>节点。这个节点的作用是将图片链接转换为文件。</p>
<ul>
<li>Method选择GET</li>
<li>URL填写{{ $json.fm }}</li>
<li>点击【Add option】选择Response，Response Format选择File。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d6f811bbd604f0fbde57819f22e99aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=o7SLkCikfhG4AG58WEEmJrxH4VY%3D" alt="" loading="lazy"/></p>
<p><strong>Read/Write Files from Disk（写封面）</strong> ：<strong>HTTP Request</strong>节点出来后点击【+】新增<strong>Read/Write Files from Disk</strong>节点，这个节点的作用是前置节点的文件下载到本地磁盘。</p>
<ul>
<li>Operation选择Write File to Disk</li>
<li>File Path and Name填写/tmp/xft_fm.jpg</li>
<li>Input Binary Field填写data</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5876e50eefcb4ccda21bb797978f66ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=dVB3sQxX%2F7%2FbLEKvUf%2FWefHwo9w%3D" alt="" loading="lazy"/></p>
<p>写入正文同理，这不再赘述。以上就是整个工作流的完整流程拆解，动手能力强的读者可以跟着教程实践一遍。<strong>上述工作流已经被收录到了小肥肠共学社群中，如果想直接获取工作流原件，可以加入社群后我拉你进空间直接学习使用。</strong></p>
<h2 data-id="heading-6">4. 写在最后</h2>
<p>这套小佛陀漫画工作流只是一个开始，它的核心逻辑可以复用到任何IP形象的生成上，甚至可以进一步结合视频生成模型，实现短视频的自动化生产。</p>
<p><strong>如本次分享对你有帮助，麻烦一键三连支持一下小肥肠，我们下期再见~</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/503ca220a2194b7b82c11b9945feee16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCO56uv5bCP6IKl6IKg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764729222&amp;x-signature=NyiksGQyr4adQdWj2%2B4vY6U1X5Y%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3中使用medium-zoom]]></title>    <link>https://juejin.cn/post/7576536602111148042</link>    <guid>https://juejin.cn/post/7576536602111148042</guid>    <pubDate>2025-11-26T02:40:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576536602111148042" data-draft-id="7576821574429065225" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3中使用medium-zoom"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-26T02:40:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="在掘金80110"/> <meta itemprop="url" content="https://juejin.cn/user/4195392103913143"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3中使用medium-zoom
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4195392103913143/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    在掘金80110
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:40:30.000Z" title="Wed Nov 26 2025 02:40:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Medium Zoom - Vue3 使用文档</h2>
<h3 data-id="heading-1">📦 简介</h3>
<p>Medium Zoom 是一个轻量级 JavaScript 库，用于实现类似 Medium 网站的图片点击放大缩放效果。本文档专注于在 Vue3 项目中的集成和使用。</p>
<h3 data-id="heading-2">✨ 核心特性</h3>
<ul>
<li>📱 <strong>响应式设计</strong> - 完美适配移动端和桌面端</li>
<li>🚀 <strong>高性能</strong> - 优化至 60fps 流畅动画</li>
<li>⚡️ <strong>高清图支持</strong> - 通过 <code>data-zoom-src</code> 属性加载高清大图</li>
<li>🎨 <strong>可定制化</strong> - 支持自定义边距、背景、滚动偏移等</li>
<li>🎂 <strong>事件系统</strong> - 完整的生命周期事件监听</li>
<li>🔌 <strong>零依赖</strong> - 无任何运行时依赖</li>
<li>💎 <strong>框架友好</strong> - 完美支持 Vue3 组合式 API</li>
</ul>
<h3 data-id="heading-3">📥 安装</h3>
<h4 data-id="heading-4">使用 npm</h4>
<pre><code class="hljs language-bash" lang="bash">npm install medium-zoom
</code></pre>
<h4 data-id="heading-5">使用 yarn</h4>
<pre><code class="hljs language-bash" lang="bash">yarn add medium-zoom
</code></pre>
<h4 data-id="heading-6">使用 pnpm</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm add medium-zoom
</code></pre>
<h3 data-id="heading-7">🚀 Vue3 快速开始</h3>
<h4 data-id="heading-8">方法一：封装组件（推荐）</h4>
<p>创建一个可复用的 <code>ImageZoom.vue</code> 组件：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { watch, type ImgHTMLAttributes, type ComponentPublicInstance } from 'vue'
import mediumZoom, { type Zoom, type ZoomOptions } from 'medium-zoom'

interface Props extends ImgHTMLAttributes {
  options?: ZoomOptions
}

const props = defineProps&lt;Props&gt;()

let zoom: Zoom | null = null

function getZoom() {
  if (zoom === null) {
    zoom = mediumZoom(props.options)
  }
  return zoom
}

function attachZoom(ref: Element | ComponentPublicInstance | null) {
  const image = ref as HTMLImageElement | null
  const zoom = getZoom()

  if (image) {
    zoom.attach(image)
  } else {
    zoom.detach()
  }
}

watch(() =&gt; props.options, (options) =&gt; {
  const zoom = getZoom()
  zoom.update(options || {})
})
&lt;/script&gt;

&lt;template&gt;
  &lt;img :ref="attachZoom" v-bind="$attrs" /&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-9">使用封装的组件</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import ImageZoom from './components/ImageZoom.vue'
&lt;/script&gt;

&lt;template&gt;
  &lt;article&gt;
    &lt;h1&gt;我的图片画廊&lt;/h1&gt;

    &lt;!-- 基础使用 --&gt;
    &lt;ImageZoom src="/images/photo-1.jpg" alt="照片1" /&gt;

    &lt;!-- 自定义背景色 --&gt;
    &lt;ImageZoom 
      src="/images/photo-2.jpg" 
      alt="照片2"
      :options="{ background: '#000000' }" 
    /&gt;

    &lt;!-- 自定义边距 --&gt;
    &lt;ImageZoom 
      src="/images/photo-3.jpg" 
      alt="照片3"
      :options="{ margin: 48, background: 'rgba(0,0,0,0.9)' }" 
    /&gt;

    &lt;!-- 高清图支持 --&gt;
    &lt;ImageZoom 
      src="/images/thumbnail.jpg" 
      data-zoom-src="/images/hd-image.jpg"
      alt="高清图片"
    /&gt;
  &lt;/article&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-10">方法二：在 Composable 中使用</h4>
<p>创建 <code>useImageZoom.ts</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { onMounted, onUnmounted, ref, <span class="hljs-keyword">type</span> <span class="hljs-title class_">Ref</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> mediumZoom, { <span class="hljs-keyword">type</span> <span class="hljs-title class_">Zoom</span>, <span class="hljs-keyword">type</span> <span class="hljs-title class_">ZoomOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'medium-zoom'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useImageZoom</span>(<span class="hljs-params">
  selector?: <span class="hljs-built_in">string</span> | HTMLElement,
  options?: ZoomOptions
</span>) {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">zoom</span>: <span class="hljs-title class_">Ref</span>&lt;<span class="hljs-title class_">Zoom</span> | <span class="hljs-literal">null</span>&gt; = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    zoom.<span class="hljs-property">value</span> = <span class="hljs-title function_">mediumZoom</span>(selector, options)
  })

  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">detach</span>()
  })

  <span class="hljs-keyword">return</span> {
    zoom,
    <span class="hljs-attr">open</span>: <span class="hljs-function">() =&gt;</span> zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">open</span>(),
    <span class="hljs-attr">close</span>: <span class="hljs-function">() =&gt;</span> zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">close</span>(),
    <span class="hljs-attr">toggle</span>: <span class="hljs-function">() =&gt;</span> zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">toggle</span>(),
  }
}
</code></pre>
<p>使用 Composable：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { onMounted } from 'vue'
import { useImageZoom } from './composables/useImageZoom'

// 初始化 zoom
const { zoom, open, close } = useImageZoom('[data-zoomable]', {
  margin: 24,
  background: '#BADA55',
})

// 也可以在挂载后动态附加图片
onMounted(() =&gt; {
  zoom.value?.attach('.gallery-image')
})
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;
    &lt;img src="/image-1.jpg" data-zoomable alt="图片1" /&gt;
    &lt;img src="/image-2.jpg" data-zoomable alt="图片2" /&gt;
    &lt;img src="/image-3.jpg" class="gallery-image" alt="图片3" /&gt;
    
    &lt;!-- 手动控制按钮 --&gt;
    &lt;button @click="open"&gt;放大第一张图片&lt;/button&gt;
    &lt;button @click="close"&gt;关闭缩放&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-11">方法三：直接在组件中使用</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { onMounted, onUnmounted, ref } from 'vue'
import mediumZoom from 'medium-zoom'

const zoomRef = ref(null)

onMounted(() =&gt; {
  zoomRef.value = mediumZoom('.zoomable', {
    margin: 24,
    background: '#fff',
    scrollOffset: 40,
  })
})

onUnmounted(() =&gt; {
  zoomRef.value?.detach()
})
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;
    &lt;img src="/image.jpg" class="zoomable" alt="可缩放图片" /&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-12">⚙️ 配置选项 (ZoomOptions)</h3>









































<table><thead><tr><th>属性</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>margin</code></td><td><code>number</code></td><td><code>0</code></td><td>缩放图片外的空白边距（像素）</td></tr><tr><td><code>background</code></td><td><code>string</code></td><td><code>"#fff"</code></td><td>遮罩层背景色，支持任何 CSS 颜色值</td></tr><tr><td><code>scrollOffset</code></td><td><code>number</code></td><td><code>40</code></td><td>滚动多少像素后自动关闭缩放</td></tr><tr><td><code>container</code></td><td><code>string | HTMLElement | object</code></td><td><code>null</code></td><td>指定缩放渲染的容器视口</td></tr><tr><td><code>template</code></td><td><code>string | HTMLTemplateElement</code></td><td><code>null</code></td><td>自定义模板元素</td></tr></tbody></table>
<h4 data-id="heading-13">配置示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">ZoomOptions</span> = {
  <span class="hljs-attr">margin</span>: <span class="hljs-number">48</span>,                    <span class="hljs-comment">// 48px 边距</span>
  <span class="hljs-attr">background</span>: <span class="hljs-string">'rgba(0,0,0,0.9)'</span>, <span class="hljs-comment">// 半透明黑色背景</span>
  <span class="hljs-attr">scrollOffset</span>: <span class="hljs-number">100</span>,             <span class="hljs-comment">// 滚动 100px 后关闭</span>
  <span class="hljs-attr">container</span>: <span class="hljs-string">'#zoom-container'</span>,  <span class="hljs-comment">// 在指定容器内缩放</span>
}
</code></pre>
<h3 data-id="heading-14">🎯 API 方法</h3>
<h4 data-id="heading-15"><code>open(options?: { target?: HTMLElement }): Promise&lt;Zoom&gt;</code></h4>
<p>打开缩放，返回 Promise。</p>
<pre><code class="hljs language-typescript" lang="typescript">zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">open</span>()
<span class="hljs-comment">// 或指定目标图片</span>
zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">open</span>({ <span class="hljs-attr">target</span>: imgElement })
</code></pre>
<h4 data-id="heading-16"><code>close(): Promise&lt;Zoom&gt;</code></h4>
<p>关闭缩放，返回 Promise。</p>
<pre><code class="hljs language-typescript" lang="typescript">zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">close</span>()
</code></pre>
<h4 data-id="heading-17"><code>toggle(options?: { target?: HTMLElement }): Promise&lt;Zoom&gt;</code></h4>
<p>切换缩放状态（打开/关闭）。</p>
<pre><code class="hljs language-typescript" lang="typescript">zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">toggle</span>()
</code></pre>
<h4 data-id="heading-18"><code>attach(...selectors): Zoom</code></h4>
<p>附加图片到缩放实例。</p>
<pre><code class="hljs language-typescript" lang="typescript">zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">attach</span>(<span class="hljs-string">'#image-1'</span>, <span class="hljs-string">'#image-2'</span>)
zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">attach</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#image-3'</span>))
</code></pre>
<h4 data-id="heading-19"><code>detach(...selectors): Zoom</code></h4>
<p>从缩放实例中移除图片。</p>
<pre><code class="hljs language-typescript" lang="typescript">zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">detach</span>(<span class="hljs-string">'#image-1'</span>)
zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">detach</span>() <span class="hljs-comment">// 移除所有图片</span>
</code></pre>
<h4 data-id="heading-20"><code>update(options: ZoomOptions): Zoom</code></h4>
<p>更新配置选项。</p>
<pre><code class="hljs language-typescript" lang="typescript">zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">update</span>({ 
  <span class="hljs-attr">background</span>: <span class="hljs-string">'#000'</span>,
  <span class="hljs-attr">margin</span>: <span class="hljs-number">50</span> 
})
</code></pre>
<h4 data-id="heading-21"><code>clone(options?: ZoomOptions): Zoom</code></h4>
<p>克隆一个新的缩放实例，合并新配置。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> newZoom = zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">clone</span>({ <span class="hljs-attr">margin</span>: <span class="hljs-number">100</span> })
</code></pre>
<h4 data-id="heading-22"><code>on(type: string, listener: Function, options?): Zoom</code></h4>
<p>注册事件监听器。</p>
<pre><code class="hljs language-typescript" lang="typescript">zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'open'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片已打开'</span>, event.<span class="hljs-property">detail</span>.<span class="hljs-property">zoom</span>)
})
</code></pre>
<h4 data-id="heading-23"><code>off(type: string, listener: Function, options?): Zoom</code></h4>
<p>移除事件监听器。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handler</span> = (<span class="hljs-params">event</span>) =&gt; { <span class="hljs-comment">/* ... */</span> }
zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'open'</span>, handler)
zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'open'</span>, handler)
</code></pre>
<h4 data-id="heading-24"><code>getOptions(): ZoomOptions</code></h4>
<p>获取当前配置选项。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> currentOptions = zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">getOptions</span>()
</code></pre>
<h4 data-id="heading-25"><code>getImages(): HTMLElement[]</code></h4>
<p>获取所有已附加的图片元素。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> images = zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">getImages</span>()
</code></pre>
<h4 data-id="heading-26"><code>getZoomedImage(): HTMLElement | null</code></h4>
<p>获取当前正在缩放的图片元素。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> currentImage = zoom.<span class="hljs-property">value</span>?.<span class="hljs-title function_">getZoomedImage</span>()
</code></pre>
<h3 data-id="heading-27">🎭 事件系统</h3>
<h4 data-id="heading-28">可用事件</h4>








































<table><thead><tr><th>事件名</th><th>触发时机</th><th>说明</th></tr></thead><tbody><tr><td><code>open</code></td><td>调用 <code>open()</code> 方法时立即触发</td><td>缩放动画开始前</td></tr><tr><td><code>opened</code></td><td>缩放动画完成后</td><td>图片已完全放大</td></tr><tr><td><code>close</code></td><td>调用 <code>close()</code> 方法时立即触发</td><td>关闭动画开始前</td></tr><tr><td><code>closed</code></td><td>关闭动画完成后</td><td>图片已完全缩小</td></tr><tr><td><code>detach</code></td><td>调用 <code>detach()</code> 方法时</td><td>图片从实例中移除</td></tr><tr><td><code>update</code></td><td>调用 <code>update()</code> 方法时</td><td>配置选项已更新</td></tr></tbody></table>
<h4 data-id="heading-29">Vue3 中使用事件</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { onMounted, ref } from 'vue'
import mediumZoom from 'medium-zoom'

const zoom = ref(null)
const zoomCount = ref(0)

onMounted(() =&gt; {
  zoom.value = mediumZoom('[data-zoomable]')
  
  // 监听打开事件
  zoom.value.on('open', (event) =&gt; {
    console.log('开始缩放:', event.target.alt)
  })
  
  // 监听打开完成事件
  zoom.value.on('opened', (event) =&gt; {
    zoomCount.value++
    console.log(`已缩放 ${zoomCount.value} 次`)
  })
  
  // 监听关闭事件
  zoom.value.on('close', () =&gt; {
    console.log('开始关闭缩放')
  })
  
  // 监听关闭完成事件
  zoom.value.on('closed', () =&gt; {
    console.log('缩放已关闭')
  })
  
  // 单次事件监听
  zoom.value.on('open', (event) =&gt; {
    console.log('这个只触发一次')
  }, { once: true })
})
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;
    &lt;img src="/image.jpg" data-zoomable alt="图片" /&gt;
    &lt;p&gt;已缩放次数: {{ zoomCount }}&lt;/p&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-30">🎨 高级用法</h3>
<h4 data-id="heading-31">1. 高清图加载</h4>
<p>使用 <code>data-zoom-src</code> 属性指定高清大图：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;ImageZoom 
    src="/thumbnails/small.jpg" 
    data-zoom-src="/images/large-hd.jpg"
    alt="高清图片"
  /&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-32">2. 在 Markdown 渲染中使用</h4>
<p>适用于博客、文档等场景：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { onMounted, ref, nextTick } from 'vue'
import mediumZoom from 'medium-zoom'
import MarkdownIt from 'markdown-it'

const md = new MarkdownIt()
const content = ref('')
const zoom = ref(null)

const markdown = `
# 我的文章
![图片1](/image-1.jpg)
![图片2](/image-2.jpg)
`

onMounted(async () =&gt; {
  content.value = md.render(markdown)
  
  await nextTick()
  
  // 为所有 markdown 渲染的图片添加缩放
  zoom.value = mediumZoom('.markdown-body img', {
    background: 'rgba(255,255,255,0.95)',
    margin: 24
  })
})
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="markdown-body" v-html="content"&gt;&lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-33">3. 自定义容器</h4>
<p>在指定容器内缩放：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { onMounted } from 'vue'
import mediumZoom from 'medium-zoom'

onMounted(() =&gt; {
  mediumZoom('[data-zoomable]', {
    container: '#custom-container',
    background: 'transparent'
  })
})
&lt;/script&gt;

&lt;template&gt;
  &lt;div id="custom-container" style="position: relative; height: 500px;"&gt;
    &lt;img src="/image.jpg" data-zoomable alt="图片" /&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-34">4. 动态添加/移除图片</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { ref, onMounted } from 'vue'
import mediumZoom from 'medium-zoom'

const images = ref(['/img1.jpg', '/img2.jpg'])
const zoom = ref(null)

onMounted(() =&gt; {
  zoom.value = mediumZoom('.gallery img')
})

function addImage() {
  const newImg = `/img${images.value.length + 1}.jpg`
  images.value.push(newImg)
  
  // 下一帧后附加新图片
  nextTick(() =&gt; {
    const newElement = document.querySelector(`.img-${images.value.length - 1}`)
    zoom.value?.attach(newElement)
  })
}

function removeImage(index: number) {
  const imgElement = document.querySelector(`.img-${index}`)
  zoom.value?.detach(imgElement)
  images.value.splice(index, 1)
}
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="gallery"&gt;
    &lt;img 
      v-for="(src, index) in images" 
      :key="index"
      :src="src" 
      :class="`img-${index}`"
      alt="图片" 
    /&gt;
    &lt;button @click="addImage"&gt;添加图片&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-35">5. 从外部按钮触发缩放</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { ref, onMounted } from 'vue'
import mediumZoom from 'medium-zoom'

const zoom = ref(null)
const imageRef = ref(null)

onMounted(() =&gt; {
  zoom.value = mediumZoom(imageRef.value)
})

function handleZoom() {
  zoom.value?.toggle({ target: imageRef.value })
}
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;
    &lt;img ref="imageRef" src="/image.jpg" alt="图片" /&gt;
    &lt;button @click="handleZoom"&gt;点击缩放图片&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h4 data-id="heading-36">6. 图片画廊示例</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { ref, onMounted } from 'vue'
import mediumZoom from 'medium-zoom'

const zoom = ref(null)

const gallery = [
  { id: 1, src: '/gallery/img1.jpg', thumb: '/gallery/thumb1.jpg', alt: '风景1' },
  { id: 2, src: '/gallery/img2.jpg', thumb: '/gallery/thumb2.jpg', alt: '风景2' },
  { id: 3, src: '/gallery/img3.jpg', thumb: '/gallery/thumb3.jpg', alt: '风景3' },
]

onMounted(() =&gt; {
  zoom.value = mediumZoom('.gallery-image', {
    margin: 48,
    background: '#000',
  })
  
  zoom.value.on('opened', (event) =&gt; {
    console.log(`正在查看: ${event.target.alt}`)
  })
})
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="gallery-grid"&gt;
    &lt;div v-for="item in gallery" :key="item.id" class="gallery-item"&gt;
      &lt;img 
        :src="item.thumb" 
        :data-zoom-src="item.src"
        :alt="item.alt"
        class="gallery-image"
      /&gt;
      &lt;p&gt;{{ item.alt }}&lt;/p&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
.gallery-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
}

.gallery-image {
  width: 100%;
  cursor: zoom-in;
  transition: opacity 0.3s;
}

.gallery-image:hover {
  opacity: 0.8;
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-37">🎨 样式定制</h3>
<p>如果需要自定义 z-index（避免与其他 UI 框架冲突）：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 在全局样式中添加 */</span>
<span class="hljs-selector-class">.medium-zoom-overlay</span>,
<span class="hljs-selector-class">.medium-zoom-image--opened</span> {
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">9999</span>;
}
</code></pre>
<p>自定义动画时长：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.medium-zoom-image--opened</span> {
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">300ms</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-38">📱 TypeScript 支持</h3>
<p>完整的 TypeScript 类型定义：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> mediumZoom, { 
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">Zoom</span>, 
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">ZoomOptions</span>, 
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">ZoomSelector</span>,
  <span class="hljs-keyword">type</span> <span class="hljs-title class_">ZoomOpenOptions</span> 
} <span class="hljs-keyword">from</span> <span class="hljs-string">'medium-zoom'</span>

<span class="hljs-comment">// Zoom 实例类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">zoom</span>: <span class="hljs-title class_">Zoom</span> = <span class="hljs-title function_">mediumZoom</span>()

<span class="hljs-comment">// 配置选项类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">ZoomOptions</span> = {
  <span class="hljs-attr">margin</span>: <span class="hljs-number">24</span>,
  <span class="hljs-attr">background</span>: <span class="hljs-string">'#fff'</span>,
  <span class="hljs-attr">scrollOffset</span>: <span class="hljs-number">40</span>,
}

<span class="hljs-comment">// 选择器类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">selector</span>: <span class="hljs-title class_">ZoomSelector</span> = <span class="hljs-string">'.image'</span> <span class="hljs-comment">// string | HTMLElement | HTMLElement[] | NodeList</span>
</code></pre>
<h3 data-id="heading-39">🔧 常见问题</h3>
<h4 data-id="heading-40">Q: 缩放的图片看不见？</h4>
<p>A: 某些 UI 框架可能设置了较高的 z-index，需要手动设置：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.medium-zoom-overlay</span>,
<span class="hljs-selector-class">.medium-zoom-image--opened</span> {
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">9999</span>;
}
</code></pre>
<h4 data-id="heading-41">Q: 在 v-for 中使用无效？</h4>
<p>A: 确保在 DOM 更新后再附加图片：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { nextTick } from 'vue'

async function addImages() {
  images.value.push(newImage)
  await nextTick()
  zoom.value?.attach('.new-image')
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-42">Q: 如何在路由切换时清理？</h4>
<p>A: 使用 <code>onUnmounted</code> 钩子：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { onUnmounted } from 'vue'

onUnmounted(() =&gt; {
  zoom.value?.detach()
})
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-43">🌐 浏览器支持</h3>
<ul>
<li>Chrome 36+</li>
<li>Firefox 34+</li>
<li>Safari 9+</li>
<li>Edge 12+</li>
<li>IE 10+ (需要 template polyfill)</li>
</ul>
<h3 data-id="heading-44">📚 参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffrancoischalifour%2Fmedium-zoom" target="_blank" title="https://github.com/francoischalifour/medium-zoom" ref="nofollow noopener noreferrer">GitHub 仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium-zoom.francoischalifour.com" target="_blank" title="https://medium-zoom.francoischalifour.com" ref="nofollow noopener noreferrer">在线演示</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium-zoom.francoischalifour.com%2Fstorybook" target="_blank" title="https://medium-zoom.francoischalifour.com/storybook" ref="nofollow noopener noreferrer">Storybook 示例</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffrancoischalifour%2Fmedium-zoom%2Ftree%2Fmaster%2Fexamples%2Fvue" target="_blank" title="https://github.com/francoischalifour/medium-zoom/tree/master/examples/vue" ref="nofollow noopener noreferrer">更多 Vue 示例</a></li>
</ul>
<p><strong>提示</strong>: 本文档基于 medium-zoom 库分析生成，适用于 Vue 3.x 版本项目。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ByteBuddy 实战指南]]></title>    <link>https://juejin.cn/post/7576821574429229065</link>    <guid>https://juejin.cn/post/7576821574429229065</guid>    <pubDate>2025-11-26T02:54:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821574429229065" data-draft-id="7576537005134037019" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ByteBuddy 实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T02:54:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ByteBuddy 实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:54:00.000Z" title="Wed Nov 26 2025 02:54:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ByteBuddy 实战指南：Java字节码增强利器</h2>
<h3 data-id="heading-1">一、ByteBuddy简介</h3>
<h4 data-id="heading-2">1.1 什么是ByteBuddy</h4>
<p>ByteBuddy是一个强大的Java字节码操作库，它能够在运行时动态生成和修改Java类。相比于传统的ASM、Javassist等字节码框架，ByteBuddy提供了更加简洁、类型安全的API，使得字节码操作变得优雅而高效。</p>
<p><strong>ByteBuddy的核心优势：</strong></p>
<ul>
<li>🎯 <strong>类型安全</strong>：基于流式API，编译期检查</li>
<li>🚀 <strong>性能优越</strong>：生成的代码性能接近手写</li>
<li>💡 <strong>简单易用</strong>：无需深入理解字节码指令</li>
<li>🔧 <strong>功能强大</strong>：支持类生成、方法拦截、代理等</li>
<li>🌟 <strong>广泛应用</strong>：Hibernate、Mockito、Spring等框架都在使用</li>
</ul>
<h4 data-id="heading-3">1.2 应用场景</h4>
<pre><code class="hljs">ByteBuddy典型应用场景：
┌─────────────────────────────────────────────────────┐
│                   应用场景                           │
├─────────────────────────────────────────────────────┤
│  • AOP切面编程     - 方法拦截、日志、权限控制        │
│  • 性能监控        - 方法耗时统计、调用链追踪        │
│  • Mock测试        - 动态生成测试桩                  │
│  • ORM框架         - 实体代理、懒加载                │
│  • 动态代理        - 接口实现、委托模式              │
│  • Agent开发       - Java Agent、APM监控             │
│  • 热部署          - 运行时类替换                    │
└─────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-4">1.3 Maven依赖</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- ByteBuddy核心库 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.bytebuddy<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>byte-buddy<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.14.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- ByteBuddy Agent支持 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.bytebuddy<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>byte-buddy-agent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.14.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 用于测试 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.13.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">二、ElementMatcher核心概念</h3>
<h4 data-id="heading-6">2.1 什么是ElementMatcher</h4>
<p>ElementMatcher是ByteBuddy中用于<strong>匹配和过滤类、方法、字段、注解等元素</strong>的核心接口。它类似于正则表达式，但专门用于Java程序元素的匹配。</p>
<p><strong>ElementMatcher的作用：</strong></p>
<pre><code class="hljs language-sql" lang="sql">┌──────────────┐      ElementMatcher      ┌──────────────┐
│  待处理的类   │  ─────────────────────→  │  匹配的元素  │
│              │                          │              │
│  Class A     │                          │  <span class="hljs-keyword">Method</span> X ✓  │
│  Class B     │   匹配规则：             │  <span class="hljs-keyword">Method</span> Y ✗  │
│  Class C     │   <span class="hljs-operator">-</span> 方法名               │  <span class="hljs-keyword">Method</span> Z ✓  │
│  ...         │   <span class="hljs-operator">-</span> 注解                 │  ...         │
│              │   <span class="hljs-operator">-</span> 参数类型             │              │
└──────────────┘   <span class="hljs-operator">-</span> 返回值类型           └──────────────┘
                   <span class="hljs-operator">-</span> 修饰符
</code></pre>
<h4 data-id="heading-7">2.2 ElementMatchers工具类</h4>
<p>ByteBuddy提供了<code>ElementMatchers</code>工具类，包含大量预定义的匹配器：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.bytebuddy;

<span class="hljs-keyword">import</span> net.bytebuddy.matcher.ElementMatchers;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> net.bytebuddy.matcher.ElementMatchers.*;

<span class="hljs-comment">/**
 * ElementMatchers常用方法示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ElementMatcherBasics</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 1. 类匹配器</span>
        named(<span class="hljs-string">"com.example.UserService"</span>);           <span class="hljs-comment">// 匹配指定类名</span>
        nameStartsWith(<span class="hljs-string">"com.example"</span>);              <span class="hljs-comment">// 匹配包名前缀</span>
        nameEndsWith(<span class="hljs-string">"Service"</span>);                    <span class="hljs-comment">// 匹配类名后缀</span>
        nameContains(<span class="hljs-string">"Controller"</span>);                 <span class="hljs-comment">// 包含指定字符串</span>

        <span class="hljs-comment">// 2. 方法匹配器</span>
        named(<span class="hljs-string">"save"</span>);                              <span class="hljs-comment">// 匹配方法名</span>
        isPublic();                                 <span class="hljs-comment">// 公共方法</span>
        isStatic();                                 <span class="hljs-comment">// 静态方法</span>
        returns(String.class);                      <span class="hljs-comment">// 返回值类型</span>
        takesArguments(<span class="hljs-number">2</span>);                          <span class="hljs-comment">// 参数数量</span>
        takesArgument(<span class="hljs-number">0</span>, String.class);            <span class="hljs-comment">// 第一个参数类型</span>

        <span class="hljs-comment">// 3. 注解匹配器</span>
        isAnnotatedWith(Override.class);           <span class="hljs-comment">// 有@Override注解</span>
        isAnnotatedWith(named(<span class="hljs-string">"MyAnnotation"</span>));    <span class="hljs-comment">// 有指定注解</span>

        <span class="hljs-comment">// 4. 继承关系匹配器</span>
        isSubTypeOf(List.class);                   <span class="hljs-comment">// 是List的子类</span>
        hasSuperType(named(<span class="hljs-string">"BaseService"</span>));        <span class="hljs-comment">// 有指定父类</span>

        <span class="hljs-comment">// 5. 逻辑组合</span>
        named(<span class="hljs-string">"save"</span>).and(isPublic());             <span class="hljs-comment">// 与运算</span>
        named(<span class="hljs-string">"get"</span>).or(named(<span class="hljs-string">"set"</span>));             <span class="hljs-comment">// 或运算</span>
        not(isStatic());                           <span class="hljs-comment">// 非运算</span>
        any();                                     <span class="hljs-comment">// 匹配任何元素</span>
        none();                                    <span class="hljs-comment">// 不匹配任何元素</span>
    }
}
</code></pre>
<h3 data-id="heading-8">三、基础实战：动态创建类</h3>
<h4 data-id="heading-9">3.1 创建简单类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.bytebuddy.basic;

<span class="hljs-keyword">import</span> net.bytebuddy.ByteBuddy;
<span class="hljs-keyword">import</span> net.bytebuddy.description.modifier.Visibility;
<span class="hljs-keyword">import</span> net.bytebuddy.dynamic.DynamicType;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.FixedValue;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> net.bytebuddy.matcher.ElementMatchers.*;

<span class="hljs-comment">/**
 * 动态创建类示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CreateClassDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 创建一个Object的子类</span>
        Class&lt;?&gt; dynamicType = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuddy</span>()
                .subclass(Object.class)
                .name(<span class="hljs-string">"com.example.DynamicClass"</span>)
                .make()
                .load(CreateClassDemo.class.getClassLoader())
                .getLoaded();

        System.out.println(<span class="hljs-string">"创建的类: "</span> + dynamicType.getName());
        System.out.println(<span class="hljs-string">"实例: "</span> + dynamicType.newInstance());

        System.out.println(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>.repeat(<span class="hljs-number">60</span>) + <span class="hljs-string">"\n"</span>);

        <span class="hljs-comment">// 2. 创建带方法的类</span>
        Class&lt;?&gt; helloWorld = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuddy</span>()
                .subclass(Object.class)
                .name(<span class="hljs-string">"com.example.HelloWorld"</span>)
                .method(named(<span class="hljs-string">"toString"</span>))  <span class="hljs-comment">// 匹配toString方法</span>
                .intercept(FixedValue.value(<span class="hljs-string">"Hello ByteBuddy!"</span>))  <span class="hljs-comment">// 返回固定值</span>
                .make()
                .load(CreateClassDemo.class.getClassLoader())
                .getLoaded();

        <span class="hljs-type">Object</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> helloWorld.newInstance();
        System.out.println(<span class="hljs-string">"toString结果: "</span> + instance.toString());

        System.out.println(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>.repeat(<span class="hljs-number">60</span>) + <span class="hljs-string">"\n"</span>);

        <span class="hljs-comment">// 3. 定义自定义方法</span>
        Class&lt;?&gt; calculator = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuddy</span>()
                .subclass(Object.class)
                .name(<span class="hljs-string">"com.example.Calculator"</span>)
                .defineMethod(<span class="hljs-string">"add"</span>, <span class="hljs-type">int</span>.class, Visibility.PUBLIC)
                .withParameters(<span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class)
                .intercept(FixedValue.value(<span class="hljs-number">42</span>))  <span class="hljs-comment">// 暂时返回固定值</span>
                .make()
                .load(CreateClassDemo.class.getClassLoader())
                .getLoaded();

        <span class="hljs-type">Object</span> <span class="hljs-variable">calc</span> <span class="hljs-operator">=</span> calculator.newInstance();
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) calculator.getMethod(<span class="hljs-string">"add"</span>, <span class="hljs-type">int</span>.class, <span class="hljs-type">int</span>.class)
                .invoke(calc, <span class="hljs-number">10</span>, <span class="hljs-number">20</span>);
        System.out.println(<span class="hljs-string">"add(10, 20) = "</span> + result);
    }
}
</code></pre>
<p><strong>输出结果：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">创建的类: com.example.DynamicClass</span>
<span class="hljs-section">实例: com.example.DynamicClass@7f31245a</span>

============================================================

<span class="hljs-section">toString结果: Hello ByteBuddy!</span>

============================================================

add(10, 20) = 42
</code></pre>
<h4 data-id="heading-10">3.2 方法委托（Delegation）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.bytebuddy.basic;

<span class="hljs-keyword">import</span> net.bytebuddy.ByteBuddy;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.MethodDelegation;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.bind.annotation.*;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> net.bytebuddy.matcher.ElementMatchers.*;

<span class="hljs-comment">/**
 * 方法委托示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodDelegationDemo</span> {

    <span class="hljs-comment">/**
     * 拦截器类
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogInterceptor</span> {

        <span class="hljs-meta">@RuntimeType</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(<span class="hljs-meta">@Origin</span> String methodName,
                                       <span class="hljs-meta">@SuperCall</span> Callable&lt;?&gt; zuper,
                                       <span class="hljs-meta">@AllArguments</span> Object[] args)</span> <span class="hljs-keyword">throws</span> Exception {
            System.out.println(<span class="hljs-string">"[Before] 调用方法: "</span> + methodName);
            System.out.println(<span class="hljs-string">"[Before] 参数: "</span> + java.util.Arrays.toString(args));

            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> zuper.call();  <span class="hljs-comment">// 调用原方法</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

            System.out.println(<span class="hljs-string">"[After] 返回值: "</span> + result);
            System.out.println(<span class="hljs-string">"[After] 耗时: "</span> + (end - start) + <span class="hljs-string">"ms"</span>);

            <span class="hljs-keyword">return</span> result;
        }
    }

    <span class="hljs-comment">/**
     * 待增强的原始类
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findUser</span><span class="hljs-params">(Long id)</span> {
            <span class="hljs-keyword">try</span> {
                Thread.sleep(<span class="hljs-number">100</span>);  <span class="hljs-comment">// 模拟数据库查询</span>
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                e.printStackTrace();
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"User-"</span> + id;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
            System.out.println(<span class="hljs-string">"    [原方法] 保存用户: "</span> + name + <span class="hljs-string">", 年龄: "</span> + age);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 使用ByteBuddy增强UserService</span>
        Class&lt;?&gt; dynamicType = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuddy</span>()
                .subclass(UserService.class)
                .method(any())  <span class="hljs-comment">// 匹配所有方法</span>
                .intercept(MethodDelegation.to(LogInterceptor.class))
                .make()
                .load(MethodDelegationDemo.class.getClassLoader())
                .getLoaded();

        <span class="hljs-type">UserService</span> <span class="hljs-variable">userService</span> <span class="hljs-operator">=</span> (UserService) dynamicType.newInstance();

        <span class="hljs-comment">// 调用方法</span>
        System.out.println(<span class="hljs-string">"====== 测试 findUser ======"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findUser(<span class="hljs-number">123L</span>);
        System.out.println(<span class="hljs-string">"最终结果: "</span> + user);

        System.out.println(<span class="hljs-string">"\n====== 测试 saveUser ======"</span>);
        userService.saveUser(<span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>);
    }
}
</code></pre>
<p><strong>输出结果：</strong></p>
<pre><code class="hljs language-ini" lang="ini">====== 测试 <span class="hljs-attr">findUser</span> ======
<span class="hljs-section">[Before]</span> 调用方法: findUser
<span class="hljs-section">[Before]</span> 参数: <span class="hljs-section">[123]</span>
<span class="hljs-section">[After]</span> 返回值: User-123
<span class="hljs-section">[After]</span> 耗时: 102ms
最终结果: <span class="hljs-attr">User-123</span>

====== 测试 <span class="hljs-attr">saveUser</span> ======
<span class="hljs-section">[Before]</span> 调用方法: saveUser
<span class="hljs-section">[Before]</span> 参数: <span class="hljs-section">[张三, 25]</span>
    <span class="hljs-section">[原方法]</span> 保存用户: 张三, 年龄: 25
<span class="hljs-section">[After]</span> 返回值: null
<span class="hljs-section">[After]</span> 耗时: 1ms
</code></pre>
<h3 data-id="heading-11">四、ElementMatcher高级用法</h3>
<h4 data-id="heading-12">4.1 方法匹配器组合</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.bytebuddy.matcher;

<span class="hljs-keyword">import</span> net.bytebuddy.ByteBuddy;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.MethodDelegation;
<span class="hljs-keyword">import</span> net.bytebuddy.matcher.ElementMatcher;

<span class="hljs-keyword">import</span> java.lang.reflect.Method;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> net.bytebuddy.matcher.ElementMatchers.*;

<span class="hljs-comment">/**
 * 复杂的ElementMatcher组合示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvancedMatcherDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogInterceptor</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">intercept</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Intercepted!"</span>;
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoService</span> {
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">publicMethod</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"public"</span>; }
        <span class="hljs-keyword">private</span> String <span class="hljs-title function_">privateMethod</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"private"</span>; }
        <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">protectedMethod</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"protected"</span>; }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">staticMethod</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"static"</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title function_">finalMethod</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"final"</span>; }

        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"name"</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> { }

        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"User-"</span> + id; }
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">findByName</span><span class="hljs-params">(String name)</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"User-"</span> + name; }

        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculate</span><span class="hljs-params">(<span class="hljs-type">int</span> a, <span class="hljs-type">int</span> b)</span> { <span class="hljs-keyword">return</span> a + b; }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {

        <span class="hljs-comment">// 1. 匹配public非static方法</span>
        ElementMatcher.Junction&lt;Method&gt; matcher1 =
                isPublic().and(not(isStatic()));

        System.out.println(<span class="hljs-string">"====== 匹配: public非static方法 ======"</span>);
        printMatches(DemoService.class, matcher1);

        <span class="hljs-comment">// 2. 匹配getter方法（名字以get开头且无参数）</span>
        ElementMatcher.Junction&lt;Method&gt; matcher2 =
                nameStartsWith(<span class="hljs-string">"get"</span>).and(takesArguments(<span class="hljs-number">0</span>));

        System.out.println(<span class="hljs-string">"\n====== 匹配: getter方法 ======"</span>);
        printMatches(DemoService.class, matcher2);

        <span class="hljs-comment">// 3. 匹配setter方法（名字以set开头且有1个参数）</span>
        ElementMatcher.Junction&lt;Method&gt; matcher3 =
                nameStartsWith(<span class="hljs-string">"set"</span>).and(takesArguments(<span class="hljs-number">1</span>));

        System.out.println(<span class="hljs-string">"\n====== 匹配: setter方法 ======"</span>);
        printMatches(DemoService.class, matcher3);

        <span class="hljs-comment">// 4. 匹配所有find开头的方法</span>
        ElementMatcher.Junction&lt;Method&gt; matcher4 =
                nameStartsWith(<span class="hljs-string">"find"</span>);

        System.out.println(<span class="hljs-string">"\n====== 匹配: find*方法 ======"</span>);
        printMatches(DemoService.class, matcher4);

        <span class="hljs-comment">// 5. 匹配返回String类型的方法</span>
        ElementMatcher.Junction&lt;Method&gt; matcher5 =
                returns(String.class);

        System.out.println(<span class="hljs-string">"\n====== 匹配: 返回String的方法 ======"</span>);
        printMatches(DemoService.class, matcher5);

        <span class="hljs-comment">// 6. 匹配第一个参数为Long的方法</span>
        ElementMatcher.Junction&lt;Method&gt; matcher6 =
                takesArgument(<span class="hljs-number">0</span>, Long.class);

        System.out.println(<span class="hljs-string">"\n====== 匹配: 第一个参数为Long的方法 ======"</span>);
        printMatches(DemoService.class, matcher6);

        <span class="hljs-comment">// 7. 复杂组合：public + 非static + 返回String + 参数为1个</span>
        ElementMatcher.Junction&lt;Method&gt; matcher7 =
                isPublic()
                        .and(not(isStatic()))
                        .and(returns(String.class))
                        .and(takesArguments(<span class="hljs-number">1</span>));

        System.out.println(<span class="hljs-string">"\n====== 匹配: 复杂组合条件 ======"</span>);
        printMatches(DemoService.class, matcher7);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printMatches</span><span class="hljs-params">(Class&lt;?&gt; clazz, ElementMatcher&lt;? <span class="hljs-built_in">super</span> Method&gt; matcher)</span> {
        <span class="hljs-keyword">for</span> (Method method : clazz.getDeclaredMethods()) {
            <span class="hljs-keyword">if</span> (matcher.matches(method)) {
                System.out.println(<span class="hljs-string">"  ✓ "</span> + method.getName() + <span class="hljs-string">" - "</span> + method);
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-13">4.2 注解匹配器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.bytebuddy.matcher;

<span class="hljs-keyword">import</span> net.bytebuddy.ByteBuddy;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.MethodDelegation;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.bind.annotation.RuntimeType;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.bind.annotation.SuperCall;

<span class="hljs-keyword">import</span> java.lang.annotation.*;
<span class="hljs-keyword">import</span> java.util.concurrent.Callable;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> net.bytebuddy.matcher.ElementMatchers.*;

<span class="hljs-comment">/**
 * 基于注解的方法匹配
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationMatcherDemo</span> {

    <span class="hljs-comment">/**
     * 自定义日志注解
     */</span>
    <span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
    <span class="hljs-meta">@Target(ElementType.METHOD)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Logged {
        String <span class="hljs-title function_">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;
    }

    <span class="hljs-comment">/**
     * 自定义缓存注解
     */</span>
    <span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
    <span class="hljs-meta">@Target(ElementType.METHOD)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Cacheable {
        <span class="hljs-type">int</span> <span class="hljs-title function_">ttl</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">60</span>;  <span class="hljs-comment">// 缓存时间（秒）</span>
    }

    <span class="hljs-comment">/**
     * 日志拦截器
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingInterceptor</span> {
        <span class="hljs-meta">@RuntimeType</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(<span class="hljs-meta">@SuperCall</span> Callable&lt;?&gt; zuper)</span> <span class="hljs-keyword">throws</span> Exception {
            System.out.println(<span class="hljs-string">"[LOG] 方法执行开始"</span>);
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> zuper.call();
            System.out.println(<span class="hljs-string">"[LOG] 方法执行结束"</span>);
            <span class="hljs-keyword">return</span> result;
        }
    }

    <span class="hljs-comment">/**
     * 缓存拦截器
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheInterceptor</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> java.util.Map&lt;String, Object&gt; cache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.HashMap&lt;&gt;();

        <span class="hljs-meta">@RuntimeType</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(<span class="hljs-meta">@SuperCall</span> Callable&lt;?&gt; zuper,
                                       <span class="hljs-meta">@net</span>.bytebuddy.implementation.bind.annotation.Origin
                                       String methodName)</span> <span class="hljs-keyword">throws</span> Exception {
            <span class="hljs-keyword">if</span> (cache.containsKey(methodName)) {
                System.out.println(<span class="hljs-string">"[CACHE] 命中缓存: "</span> + methodName);
                <span class="hljs-keyword">return</span> cache.get(methodName);
            }

            System.out.println(<span class="hljs-string">"[CACHE] 未命中，执行方法: "</span> + methodName);
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> zuper.call();
            cache.put(methodName, result);
            <span class="hljs-keyword">return</span> result;
        }
    }

    <span class="hljs-comment">/**
     * 业务服务类
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {

        <span class="hljs-meta">@Logged</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getProductName</span><span class="hljs-params">(Long id)</span> {
            System.out.println(<span class="hljs-string">"  [执行] 查询产品名称: "</span> + id);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Product-"</span> + id;
        }

        <span class="hljs-meta">@Cacheable(ttl = 300)</span>
        <span class="hljs-keyword">public</span> Double <span class="hljs-title function_">getProductPrice</span><span class="hljs-params">(Long id)</span> {
            System.out.println(<span class="hljs-string">"  [执行] 查询产品价格: "</span> + id);
            <span class="hljs-keyword">return</span> <span class="hljs-number">99.99</span>;
        }

        <span class="hljs-meta">@Logged</span>
        <span class="hljs-meta">@Cacheable</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getProductDetail</span><span class="hljs-params">(Long id)</span> {
            System.out.println(<span class="hljs-string">"  [执行] 查询产品详情: "</span> + id);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Detail-"</span> + id;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProduct</span><span class="hljs-params">(Long id, String name)</span> {
            System.out.println(<span class="hljs-string">"  [执行] 更新产品: "</span> + id + <span class="hljs-string">" -&gt; "</span> + name);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {

        <span class="hljs-comment">// 1. 拦截所有带@Logged注解的方法</span>
        Class&lt;?&gt; loggedType = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuddy</span>()
                .subclass(ProductService.class)
                .method(isAnnotatedWith(Logged.class))
                .intercept(MethodDelegation.to(LoggingInterceptor.class))
                .make()
                .load(AnnotationMatcherDemo.class.getClassLoader())
                .getLoaded();

        <span class="hljs-type">ProductService</span> <span class="hljs-variable">loggedService</span> <span class="hljs-operator">=</span> (ProductService) loggedType.newInstance();

        System.out.println(<span class="hljs-string">"====== 测试@Logged注解拦截 ======"</span>);
        loggedService.getProductName(<span class="hljs-number">100L</span>);
        System.out.println();
        loggedService.updateProduct(<span class="hljs-number">100L</span>, <span class="hljs-string">"New Name"</span>);  <span class="hljs-comment">// 没有@Logged，不拦截</span>

        System.out.println(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>.repeat(<span class="hljs-number">60</span>) + <span class="hljs-string">"\n"</span>);

        <span class="hljs-comment">// 2. 拦截所有带@Cacheable注解的方法</span>
        Class&lt;?&gt; cachedType = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuddy</span>()
                .subclass(ProductService.class)
                .method(isAnnotatedWith(Cacheable.class))
                .intercept(MethodDelegation.to(CacheInterceptor.class))
                .make()
                .load(AnnotationMatcherDemo.class.getClassLoader())
                .getLoaded();

        <span class="hljs-type">ProductService</span> <span class="hljs-variable">cachedService</span> <span class="hljs-operator">=</span> (ProductService) cachedType.newInstance();

        System.out.println(<span class="hljs-string">"====== 测试@Cacheable注解拦截 ======"</span>);
        cachedService.getProductPrice(<span class="hljs-number">200L</span>);  <span class="hljs-comment">// 第一次调用</span>
        System.out.println();
        cachedService.getProductPrice(<span class="hljs-number">200L</span>);  <span class="hljs-comment">// 第二次调用，命中缓存</span>

        System.out.println(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>.repeat(<span class="hljs-number">60</span>) + <span class="hljs-string">"\n"</span>);

        <span class="hljs-comment">// 3. 同时拦截多个注解（链式拦截）</span>
        Class&lt;?&gt; multiType = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuddy</span>()
                .subclass(ProductService.class)
                .method(isAnnotatedWith(Logged.class))
                .intercept(MethodDelegation.to(LoggingInterceptor.class))
                .method(isAnnotatedWith(Cacheable.class))
                .intercept(MethodDelegation.to(CacheInterceptor.class))
                .make()
                .load(AnnotationMatcherDemo.class.getClassLoader())
                .getLoaded();

        <span class="hljs-type">ProductService</span> <span class="hljs-variable">multiService</span> <span class="hljs-operator">=</span> (ProductService) multiType.newInstance();

        System.out.println(<span class="hljs-string">"====== 测试多注解拦截 ======"</span>);
        multiService.getProductDetail(<span class="hljs-number">300L</span>);  <span class="hljs-comment">// 有@Logged和@Cacheable</span>
        System.out.println();
        multiService.getProductDetail(<span class="hljs-number">300L</span>);  <span class="hljs-comment">// 第二次调用</span>
    }
}
</code></pre>
<h3 data-id="heading-14">五、生产级实战：性能监控系统</h3>
<h4 data-id="heading-15">5.1 方法执行时间监控</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.bytebuddy.production;

<span class="hljs-keyword">import</span> net.bytebuddy.ByteBuddy;
<span class="hljs-keyword">import</span> net.bytebuddy.agent.ByteBuddyAgent;
<span class="hljs-keyword">import</span> net.bytebuddy.dynamic.loading.ClassReloadingStrategy;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.MethodDelegation;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.bind.annotation.*;

<span class="hljs-keyword">import</span> java.lang.annotation.*;
<span class="hljs-keyword">import</span> java.util.concurrent.Callable;
<span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentHashMap;
<span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicLong;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> net.bytebuddy.matcher.ElementMatchers.*;

<span class="hljs-comment">/**
 * 生产级性能监控系统
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMonitor</span> {

    <span class="hljs-comment">/**
     * 监控注解
     */</span>
    <span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
    <span class="hljs-meta">@Target({ElementType.METHOD, ElementType.TYPE})</span>
    <span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Monitor {
        String <span class="hljs-title function_">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>;
        <span class="hljs-type">long</span> <span class="hljs-title function_">threshold</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 慢方法阈值（毫秒）</span>
    }

    <span class="hljs-comment">/**
     * 性能指标收集器
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetricsCollector</span> {

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodMetrics</span> {
            <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">totalCalls</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);
            <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">totalTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);
            <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">maxTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);
            <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">minTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(Long.MAX_VALUE);
            <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">errorCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);
        }

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;String, MethodMetrics&gt; metricsMap =
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordMetric</span><span class="hljs-params">(String methodName, <span class="hljs-type">long</span> duration, <span class="hljs-type">boolean</span> hasError)</span> {
            <span class="hljs-type">MethodMetrics</span> <span class="hljs-variable">metrics</span> <span class="hljs-operator">=</span> metricsMap.computeIfAbsent(methodName, k -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodMetrics</span>());

            metrics.totalCalls.incrementAndGet();
            metrics.totalTime.addAndGet(duration);

            <span class="hljs-comment">// 更新最大值</span>
            metrics.maxTime.updateAndGet(current -&gt; Math.max(current, duration));

            <span class="hljs-comment">// 更新最小值</span>
            metrics.minTime.updateAndGet(current -&gt; Math.min(current, duration));

            <span class="hljs-keyword">if</span> (hasError) {
                metrics.errorCount.incrementAndGet();
            }
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printReport</span><span class="hljs-params">()</span> {
            System.out.println(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>.repeat(<span class="hljs-number">80</span>));
            System.out.println(<span class="hljs-string">"性能监控报告"</span>);
            System.out.println(<span class="hljs-string">"="</span>.repeat(<span class="hljs-number">80</span>));
            System.out.printf(<span class="hljs-string">"%-40s %10s %10s %10s %10s %10s%n"</span>,
                    <span class="hljs-string">"方法名"</span>, <span class="hljs-string">"调用次数"</span>, <span class="hljs-string">"平均耗时"</span>, <span class="hljs-string">"最大耗时"</span>, <span class="hljs-string">"最小耗时"</span>, <span class="hljs-string">"错误次数"</span>);
            System.out.println(<span class="hljs-string">"-"</span>.repeat(<span class="hljs-number">80</span>));

            metricsMap.forEach((methodName, metrics) -&gt; {
                <span class="hljs-type">long</span> <span class="hljs-variable">avgTime</span> <span class="hljs-operator">=</span> metrics.totalCalls.get() &gt; <span class="hljs-number">0</span> ?
                        metrics.totalTime.get() / metrics.totalCalls.get() : <span class="hljs-number">0</span>;

                System.out.printf(<span class="hljs-string">"%-40s %10d %9dms %9dms %9dms %10d%n"</span>,
                        methodName,
                        metrics.totalCalls.get(),
                        avgTime,
                        metrics.maxTime.get(),
                        metrics.minTime.get() == Long.MAX_VALUE ? <span class="hljs-number">0</span> : metrics.minTime.get(),
                        metrics.errorCount.get());
            });

            System.out.println(<span class="hljs-string">"="</span>.repeat(<span class="hljs-number">80</span>));
        }
    }

    <span class="hljs-comment">/**
     * 性能监控拦截器
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitorInterceptor</span> {

        <span class="hljs-meta">@RuntimeType</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(<span class="hljs-meta">@SuperCall</span> Callable&lt;?&gt; zuper,
                                       <span class="hljs-meta">@Origin</span> String methodName,
                                       <span class="hljs-meta">@Origin</span> Class&lt;?&gt; clazz,
                                       <span class="hljs-meta">@AllArguments</span> Object[] args)</span> <span class="hljs-keyword">throws</span> Exception {

            <span class="hljs-type">String</span> <span class="hljs-variable">fullMethodName</span> <span class="hljs-operator">=</span> clazz.getSimpleName() + <span class="hljs-string">"."</span> + methodName;
            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-type">boolean</span> <span class="hljs-variable">hasError</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

            <span class="hljs-keyword">try</span> {
                result = zuper.call();
                <span class="hljs-keyword">return</span> result;
            } <span class="hljs-keyword">catch</span> (Exception e) {
                hasError = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">throw</span> e;
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;

                <span class="hljs-comment">// 记录指标</span>
                MetricsCollector.recordMetric(fullMethodName, duration, hasError);

                <span class="hljs-comment">// 检查是否超过阈值</span>
                <span class="hljs-type">Monitor</span> <span class="hljs-variable">annotation</span> <span class="hljs-operator">=</span> clazz.getAnnotation(Monitor.class);
                <span class="hljs-keyword">if</span> (annotation != <span class="hljs-literal">null</span> &amp;&amp; duration &gt; annotation.threshold()) {
                    System.err.printf(<span class="hljs-string">"[SLOW] %s 耗时 %dms (阈值: %dms)%n"</span>,
                            fullMethodName, duration, annotation.threshold());
                }
            }
        }
    }

    <span class="hljs-comment">/**
     * 模拟业务服务
     */</span>
    <span class="hljs-meta">@Monitor(threshold = 100)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Long userId, Long productId)</span> {
            sleep(<span class="hljs-number">50</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"ORDER-"</span> + System.currentTimeMillis();
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processPayment</span><span class="hljs-params">(String orderId, <span class="hljs-type">double</span> amount)</span> {
            sleep(<span class="hljs-number">80</span>);
            System.out.println(<span class="hljs-string">"  [业务] 处理支付: "</span> + orderId + <span class="hljs-string">" - "</span> + amount);
        }

        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">queryOrder</span><span class="hljs-params">(String orderId)</span> {
            sleep(<span class="hljs-number">150</span>);  <span class="hljs-comment">// 超过阈值</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Order Detail: "</span> + orderId;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cancelOrder</span><span class="hljs-params">(String orderId)</span> {
            sleep(<span class="hljs-number">30</span>);
            <span class="hljs-keyword">if</span> (Math.random() &gt; <span class="hljs-number">0.7</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"取消订单失败"</span>);
            }
            System.out.println(<span class="hljs-string">"  [业务] 订单已取消: "</span> + orderId);
        }

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sleep</span><span class="hljs-params">(<span class="hljs-type">long</span> millis)</span> {
            <span class="hljs-keyword">try</span> {
                Thread.sleep(millis);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {

        <span class="hljs-comment">// 安装ByteBuddy Agent</span>
        ByteBuddyAgent.install();

        <span class="hljs-comment">// 创建增强类</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuddy</span>()
                .redefine(OrderService.class)
                .method(isAnnotatedWith(Monitor.class)
                        .or(declaringType(isAnnotatedWith(Monitor.class))))
                .intercept(MethodDelegation.to(MonitorInterceptor.class))
                .make()
                .load(OrderService.class.getClassLoader(),
                        ClassReloadingStrategy.fromInstalledAgent());

        <span class="hljs-comment">// 模拟业务调用</span>
        <span class="hljs-type">OrderService</span> <span class="hljs-variable">orderService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderService</span>();

        System.out.println(<span class="hljs-string">"====== 开始性能测试 ======\n"</span>);

        <span class="hljs-comment">// 测试1: 创建订单（10次）</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            orderService.createOrder(<span class="hljs-number">100L</span> + i, <span class="hljs-number">200L</span> + i);
        }

        <span class="hljs-comment">// 测试2: 处理支付（5次）</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            orderService.processPayment(<span class="hljs-string">"ORDER-"</span> + i, <span class="hljs-number">99.99</span>);
        }

        <span class="hljs-comment">// 测试3: 查询订单（8次，超过阈值）</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) {
            orderService.queryOrder(<span class="hljs-string">"ORDER-"</span> + i);
        }

        <span class="hljs-comment">// 测试4: 取消订单（10次，可能有错误）</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {
            <span class="hljs-keyword">try</span> {
                orderService.cancelOrder(<span class="hljs-string">"ORDER-"</span> + i);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-comment">// 忽略异常</span>
            }
        }

        <span class="hljs-comment">// 打印监控报告</span>
        MetricsCollector.printReport();
    }
}
</code></pre>
<h4 data-id="heading-16">5.2 数据库访问监控（模拟MyBatis）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.bytebuddy.production;

<span class="hljs-keyword">import</span> net.bytebuddy.ByteBuddy;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.MethodDelegation;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.bind.annotation.*;

<span class="hljs-keyword">import</span> java.lang.annotation.*;
<span class="hljs-keyword">import</span> java.util.concurrent.Callable;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> net.bytebuddy.matcher.ElementMatchers.*;

<span class="hljs-comment">/**
 * 数据库访问监控（模拟MyBatis Mapper）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseMonitor</span> {

    <span class="hljs-comment">/**
     * SQL查询注解（模拟MyBatis的<span class="hljs-doctag">@Select</span>）
     */</span>
    <span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
    <span class="hljs-meta">@Target(ElementType.METHOD)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Select {
        String <span class="hljs-title function_">value</span><span class="hljs-params">()</span>;
    }

    <span class="hljs-comment">/**
     * SQL更新注解（模拟MyBatis的<span class="hljs-doctag">@Update</span>）
     */</span>
    <span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
    <span class="hljs-meta">@Target(ElementType.METHOD)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Update {
        String <span class="hljs-title function_">value</span><span class="hljs-params">()</span>;
    }

    <span class="hljs-comment">/**
     * SQL拦截器
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlInterceptor</span> {

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Integer&gt; queryDepth = ThreadLocal.withInitial(() -&gt; <span class="hljs-number">0</span>);

        <span class="hljs-meta">@RuntimeType</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(<span class="hljs-meta">@SuperCall</span> Callable&lt;?&gt; zuper,
                                       <span class="hljs-meta">@Origin</span> String methodName,
                                       <span class="hljs-meta">@AllArguments</span> Object[] args,
                                       <span class="hljs-meta">@Origin</span> java.lang.reflect.Method method)</span> <span class="hljs-keyword">throws</span> Exception {

            <span class="hljs-comment">// 获取SQL语句</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-type">Select</span> <span class="hljs-variable">select</span> <span class="hljs-operator">=</span> method.getAnnotation(Select.class);
            <span class="hljs-type">Update</span> <span class="hljs-variable">update</span> <span class="hljs-operator">=</span> method.getAnnotation(Update.class);

            <span class="hljs-keyword">if</span> (select != <span class="hljs-literal">null</span>) {
                sql = select.value();
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (update != <span class="hljs-literal">null</span>) {
                sql = update.value();
            }

            <span class="hljs-keyword">if</span> (sql == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> zuper.call();
            }

            <span class="hljs-comment">// 增加调用深度</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">depth</span> <span class="hljs-operator">=</span> queryDepth.get();
            queryDepth.set(depth + <span class="hljs-number">1</span>);

            <span class="hljs-type">String</span> <span class="hljs-variable">indent</span> <span class="hljs-operator">=</span> <span class="hljs-string">"  "</span>.repeat(depth);
            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

            System.out.println(indent + <span class="hljs-string">"[SQL] 执行SQL: "</span> + sql);
            System.out.println(indent + <span class="hljs-string">"[SQL] 参数: "</span> + java.util.Arrays.toString(args));

            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> zuper.call();
                <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - start;

                System.out.println(indent + <span class="hljs-string">"[SQL] 耗时: "</span> + duration + <span class="hljs-string">"ms"</span>);

                <span class="hljs-comment">// 检测慢SQL</span>
                <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">100</span>) {
                    System.err.println(indent + <span class="hljs-string">"[WARN] 慢SQL检测: "</span> + sql +
                            <span class="hljs-string">" (耗时: "</span> + duration + <span class="hljs-string">"ms)"</span>);
                }

                <span class="hljs-keyword">return</span> result;

            } <span class="hljs-keyword">finally</span> {
                queryDepth.set(depth);
            }
        }
    }

    <span class="hljs-comment">/**
     * Mapper接口
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> {
        <span class="hljs-meta">@Select("SELECT * FROM users WHERE id = ?")</span>
        User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span>;

        <span class="hljs-meta">@Select("SELECT * FROM users WHERE name = ?")</span>
        User <span class="hljs-title function_">findByName</span><span class="hljs-params">(String name)</span>;

        <span class="hljs-meta">@Update("UPDATE users SET name = ? WHERE id = ?")</span>
        <span class="hljs-type">int</span> <span class="hljs-title function_">updateName</span><span class="hljs-params">(String name, Long id)</span>;

        <span class="hljs-meta">@Update("DELETE FROM users WHERE id = ?")</span>
        <span class="hljs-type">int</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span>;
    }

    <span class="hljs-comment">/**
     * 实体类
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
        <span class="hljs-keyword">private</span> Long id;
        <span class="hljs-keyword">private</span> String name;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(Long id, String name, <span class="hljs-type">int</span> age)</span> {
            <span class="hljs-built_in">this</span>.id = id;
            <span class="hljs-built_in">this</span>.name = name;
            <span class="hljs-built_in">this</span>.age = age;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"User{id="</span> + id + <span class="hljs-string">", name='"</span> + name + <span class="hljs-string">"', age="</span> + age + <span class="hljs-string">"}"</span>;
        }
    }

    <span class="hljs-comment">/**
     * Mapper实现类（模拟）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserMapperImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserMapper</span> {

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(Long id)</span> {
            simulateDbQuery(<span class="hljs-number">80</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(id, <span class="hljs-string">"User-"</span> + id, <span class="hljs-number">25</span>);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findByName</span><span class="hljs-params">(String name)</span> {
            simulateDbQuery(<span class="hljs-number">120</span>);  <span class="hljs-comment">// 慢查询</span>
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-number">1L</span>, name, <span class="hljs-number">30</span>);
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">updateName</span><span class="hljs-params">(String name, Long id)</span> {
            simulateDbQuery(<span class="hljs-number">50</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">deleteById</span><span class="hljs-params">(Long id)</span> {
            simulateDbQuery(<span class="hljs-number">60</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
        }

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">simulateDbQuery</span><span class="hljs-params">(<span class="hljs-type">long</span> millis)</span> {
            <span class="hljs-keyword">try</span> {
                Thread.sleep(millis);
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {

        <span class="hljs-comment">// 创建增强的Mapper</span>
        Class&lt;?&gt; enhancedMapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuddy</span>()
                .subclass(UserMapperImpl.class)
                .method(isAnnotatedWith(Select.class)
                        .or(isAnnotatedWith(Update.class)))
                .intercept(MethodDelegation.to(SqlInterceptor.class))
                .make()
                .load(DatabaseMonitor.class.getClassLoader())
                .getLoaded();

        <span class="hljs-type">UserMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> (UserMapper) enhancedMapper.newInstance();

        System.out.println(<span class="hljs-string">"====== 数据库访问监控测试 ======\n"</span>);

        <span class="hljs-comment">// 测试查询</span>
        System.out.println(<span class="hljs-string">"1. 根据ID查询用户:"</span>);
        <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> mapper.findById(<span class="hljs-number">100L</span>);
        System.out.println(<span class="hljs-string">"结果: "</span> + user1);

        System.out.println(<span class="hljs-string">"\n2. 根据名称查询用户（慢查询）:"</span>);
        <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> mapper.findByName(<span class="hljs-string">"张三"</span>);
        System.out.println(<span class="hljs-string">"结果: "</span> + user2);

        System.out.println(<span class="hljs-string">"\n3. 更新用户名:"</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">affected</span> <span class="hljs-operator">=</span> mapper.updateName(<span class="hljs-string">"李四"</span>, <span class="hljs-number">100L</span>);
        System.out.println(<span class="hljs-string">"影响行数: "</span> + affected);

        System.out.println(<span class="hljs-string">"\n4. 删除用户:"</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">deleted</span> <span class="hljs-operator">=</span> mapper.deleteById(<span class="hljs-number">100L</span>);
        System.out.println(<span class="hljs-string">"删除行数: "</span> + deleted);
    }
}
</code></pre>
<h3 data-id="heading-17">六、实战案例：Spring AOP增强</h3>
<h4 data-id="heading-18">6.1 自定义事务管理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.bytebuddy.spring;

<span class="hljs-keyword">import</span> net.bytebuddy.ByteBuddy;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.MethodDelegation;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.bind.annotation.*;

<span class="hljs-keyword">import</span> java.lang.annotation.*;
<span class="hljs-keyword">import</span> java.util.concurrent.Callable;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> net.bytebuddy.matcher.ElementMatchers.*;

<span class="hljs-comment">/**
 * 自定义事务管理（模拟Spring <span class="hljs-doctag">@Transactional</span>）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionManager</span> {

    <span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
    <span class="hljs-meta">@Target(ElementType.METHOD)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Transactional {
        Propagation <span class="hljs-title function_">propagation</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> Propagation.REQUIRED;
        <span class="hljs-type">boolean</span> <span class="hljs-title function_">readOnly</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Propagation</span> {
        REQUIRED, REQUIRES_NEW, SUPPORTS, MANDATORY
    }

    <span class="hljs-comment">/**
     * 事务上下文
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionContext</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Boolean&gt; inTransaction = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Boolean&gt; readOnly = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">begin</span><span class="hljs-params">(<span class="hljs-type">boolean</span> readOnly)</span> {
            inTransaction.set(<span class="hljs-literal">true</span>);
            TransactionContext.readOnly.set(readOnly);
            System.out.println(<span class="hljs-string">"  [TX] 开启事务 (readOnly="</span> + readOnly + <span class="hljs-string">")"</span>);
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">commit</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(inTransaction.get())) {
                System.out.println(<span class="hljs-string">"  [TX] 提交事务"</span>);
                clear();
            }
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rollback</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(inTransaction.get())) {
                System.err.println(<span class="hljs-string">"  [TX] 回滚事务"</span>);
                clear();
            }
        }

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
            inTransaction.remove();
            readOnly.remove();
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInTransaction</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> Boolean.TRUE.equals(inTransaction.get());
        }
    }

    <span class="hljs-comment">/**
     * 事务拦截器
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionInterceptor</span> {

        <span class="hljs-meta">@RuntimeType</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(<span class="hljs-meta">@SuperCall</span> Callable&lt;?&gt; zuper,
                                       <span class="hljs-meta">@Origin</span> String methodName,
                                       <span class="hljs-meta">@Origin</span> java.lang.reflect.Method method)</span> <span class="hljs-keyword">throws</span> Exception {

            <span class="hljs-type">Transactional</span> <span class="hljs-variable">tx</span> <span class="hljs-operator">=</span> method.getAnnotation(Transactional.class);
            <span class="hljs-keyword">if</span> (tx == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> zuper.call();
            }

            <span class="hljs-type">boolean</span> <span class="hljs-variable">shouldManageTx</span> <span class="hljs-operator">=</span> !TransactionContext.isInTransaction();

            <span class="hljs-keyword">if</span> (shouldManageTx) {
                TransactionContext.begin(tx.readOnly());
            }

            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> zuper.call();

                <span class="hljs-keyword">if</span> (shouldManageTx) {
                    TransactionContext.commit();
                }

                <span class="hljs-keyword">return</span> result;

            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">if</span> (shouldManageTx) {
                    TransactionContext.rollback();
                }
                <span class="hljs-keyword">throw</span> e;
            }
        }
    }

    <span class="hljs-comment">/**
     * 服务类
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountService</span> {

        <span class="hljs-meta">@Transactional</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Long fromId, Long toId, <span class="hljs-type">double</span> amount)</span> {
            System.out.println(<span class="hljs-string">"    [业务] 执行转账: "</span> + fromId + <span class="hljs-string">" -&gt; "</span> + toId + <span class="hljs-string">" 金额: "</span> + amount);

            deduct(fromId, amount);
            add(toId, amount);

            System.out.println(<span class="hljs-string">"    [业务] 转账成功"</span>);
        }

        <span class="hljs-meta">@Transactional</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transferWithError</span><span class="hljs-params">(Long fromId, Long toId, <span class="hljs-type">double</span> amount)</span> {
            System.out.println(<span class="hljs-string">"    [业务] 执行转账（会失败）: "</span> + fromId + <span class="hljs-string">" -&gt; "</span> + toId);

            deduct(fromId, amount);

            <span class="hljs-comment">// 模拟错误</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"余额不足"</span>);
        }

        <span class="hljs-meta">@Transactional(readOnly = true)</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getBalance</span><span class="hljs-params">(Long accountId)</span> {
            System.out.println(<span class="hljs-string">"    [业务] 查询余额: "</span> + accountId);
            <span class="hljs-keyword">return</span> <span class="hljs-number">1000.0</span>;
        }

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deduct</span><span class="hljs-params">(Long accountId, <span class="hljs-type">double</span> amount)</span> {
            System.out.println(<span class="hljs-string">"    [业务] 扣款: "</span> + accountId + <span class="hljs-string">" - "</span> + amount);
        }

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(Long accountId, <span class="hljs-type">double</span> amount)</span> {
            System.out.println(<span class="hljs-string">"    [业务] 入账: "</span> + accountId + <span class="hljs-string">" + "</span> + amount);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {

        Class&lt;?&gt; enhancedClass = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuddy</span>()
                .subclass(AccountService.class)
                .method(isAnnotatedWith(Transactional.class))
                .intercept(MethodDelegation.to(TransactionInterceptor.class))
                .make()
                .load(TransactionManager.class.getClassLoader())
                .getLoaded();

        <span class="hljs-type">AccountService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> (AccountService) enhancedClass.newInstance();

        System.out.println(<span class="hljs-string">"====== 测试1: 正常转账 ======"</span>);
        service.transfer(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">100.0</span>);

        System.out.println(<span class="hljs-string">"\n====== 测试2: 查询余额（只读事务） ======"</span>);
        <span class="hljs-type">double</span> <span class="hljs-variable">balance</span> <span class="hljs-operator">=</span> service.getBalance(<span class="hljs-number">1L</span>);
        System.out.println(<span class="hljs-string">"余额: "</span> + balance);

        System.out.println(<span class="hljs-string">"\n====== 测试3: 转账失败（事务回滚） ======"</span>);
        <span class="hljs-keyword">try</span> {
            service.transferWithError(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">200.0</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.out.println(<span class="hljs-string">"捕获异常: "</span> + e.getMessage());
        }
    }
}
</code></pre>
<h3 data-id="heading-19">七、ByteBuddy Agent开发</h3>
<h4 data-id="heading-20">7.1 Java Agent基础</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.bytebuddy.agent;

<span class="hljs-keyword">import</span> net.bytebuddy.agent.builder.AgentBuilder;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.MethodDelegation;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.bind.annotation.*;

<span class="hljs-keyword">import</span> java.lang.instrument.Instrumentation;
<span class="hljs-keyword">import</span> java.util.concurrent.Callable;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> net.bytebuddy.matcher.ElementMatchers.*;

<span class="hljs-comment">/**
 * ByteBuddy Java Agent示例
 *
 * 编译后使用方式：
 * java -javaagent:agent.jar -jar app.jar
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceAgent</span> {

    <span class="hljs-comment">/**
     * Agent入口方法
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">premain</span><span class="hljs-params">(String arguments, Instrumentation instrumentation)</span> {
        System.out.println(<span class="hljs-string">"====== Performance Agent 启动 ======"</span>);

        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AgentBuilder</span>.Default()
                <span class="hljs-comment">// 指定要增强的类</span>
                .type(nameStartsWith(<span class="hljs-string">"com.example.app"</span>))
                <span class="hljs-comment">// 配置增强逻辑</span>
                .transform((builder, typeDescription, classLoader, <span class="hljs-keyword">module</span>, protectionDomain) -&gt;
                        builder.method(isPublic().and(not(isStatic())))
                                .intercept(MethodDelegation.to(PerformanceInterceptor.class))
                )
                <span class="hljs-comment">// 安装到Instrumentation</span>
                .installOn(instrumentation);

        System.out.println(<span class="hljs-string">"====== Agent 安装完成 ======"</span>);
    }

    <span class="hljs-comment">/**
     * 性能监控拦截器
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceInterceptor</span> {

        <span class="hljs-meta">@RuntimeType</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(<span class="hljs-meta">@SuperCall</span> Callable&lt;?&gt; zuper,
                                       <span class="hljs-meta">@Origin</span> String methodName,
                                       <span class="hljs-meta">@Origin</span> Class&lt;?&gt; clazz)</span> <span class="hljs-keyword">throws</span> Exception {

            <span class="hljs-type">long</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> System.nanoTime();

            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> zuper.call();
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-type">long</span> <span class="hljs-variable">duration</span> <span class="hljs-operator">=</span> (System.nanoTime() - start) / <span class="hljs-number">1_000_000</span>;
                System.out.printf(<span class="hljs-string">"[Agent] %s.%s 耗时: %dms%n"</span>,
                        clazz.getSimpleName(), methodName, duration);
            }
        }
    }
}
</code></pre>
<p><strong>MANIFEST.MF配置：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">Manifest-Version:</span> <span class="hljs-number">1.0</span>
<span class="hljs-attr">Premain-Class:</span> <span class="hljs-string">com.example.bytebuddy.agent.PerformanceAgent</span>
<span class="hljs-attr">Can-Redefine-Classes:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">Can-Retransform-Classes:</span> <span class="hljs-literal">true</span>
</code></pre>
<h4 data-id="heading-21">7.2 动态Attach Agent</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.bytebuddy.agent;

<span class="hljs-keyword">import</span> net.bytebuddy.agent.ByteBuddyAgent;
<span class="hljs-keyword">import</span> net.bytebuddy.agent.builder.AgentBuilder;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.MethodDelegation;
<span class="hljs-keyword">import</span> net.bytebuddy.implementation.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.concurrent.Callable;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> net.bytebuddy.matcher.ElementMatchers.*;

<span class="hljs-comment">/**
 * 动态Attach Agent（无需重启JVM）
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicAttachAgent</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuntimeInterceptor</span> {
        <span class="hljs-meta">@RuntimeType</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(<span class="hljs-meta">@SuperCall</span> Callable&lt;?&gt; zuper,
                                       <span class="hljs-meta">@Origin</span> String methodName)</span> <span class="hljs-keyword">throws</span> Exception {
            System.out.println(<span class="hljs-string">"[动态Agent] 拦截方法: "</span> + methodName);
            <span class="hljs-keyword">return</span> zuper.call();
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attachAgent</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 动态安装Agent</span>
        ByteBuddyAgent.install();

        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AgentBuilder</span>.Default()
                .with(AgentBuilder.RedefinitionStrategy.RETRANSFORMATION)
                .type(named(<span class="hljs-string">"com.example.TargetClass"</span>))
                .transform((builder, typeDescription, classLoader, <span class="hljs-keyword">module</span>, protectionDomain) -&gt;
                        builder.method(any())
                                .intercept(MethodDelegation.to(RuntimeInterceptor.class))
                )
                .installOnByteBuddyAgent();

        System.out.println(<span class="hljs-string">"动态Agent已安装"</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"应用启动中..."</span>);

        <span class="hljs-comment">// 应用运行中动态安装Agent</span>
        attachAgent();

        <span class="hljs-comment">// 后续的类加载会被增强</span>
    }
}
</code></pre>
<h3 data-id="heading-22">八、最佳实践与注意事项</h3>
<h4 data-id="heading-23">8.1 性能优化建议</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 缓存动态生成的类</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Class&lt;?&gt;, Class&lt;?&gt;&gt; classCache =
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">T</span>&gt; getEnhancedClass(Class&lt;T&gt; clazz) {
    <span class="hljs-keyword">return</span> (Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">T</span>&gt;) classCache.computeIfAbsent(clazz, key -&gt;
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuddy</span>()
            .subclass(key)
            .method(any())
            .intercept(MethodDelegation.to(Interceptor.class))
            .make()
            .load(key.getClassLoader())
            .getLoaded()
    );
}

<span class="hljs-comment">// 2. 使用@RuntimeType减少类型转换</span>
<span class="hljs-meta">@RuntimeType</span>  <span class="hljs-comment">// 自动处理类型转换</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(<span class="hljs-meta">@SuperCall</span> Callable&lt;?&gt; zuper)</span> {
    <span class="hljs-keyword">return</span> zuper.call();
}

<span class="hljs-comment">// 3. 精确匹配，避免过度拦截</span>
.method(named(<span class="hljs-string">"specificMethod"</span>).and(takesArguments(<span class="hljs-number">2</span>)))  <span class="hljs-comment">// ✓ 精确</span>
.method(any())  <span class="hljs-comment">// ✗ 拦截所有方法，性能差</span>
</code></pre>
<h4 data-id="heading-24">8.2 常见陷阱</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 陷阱1: 循环依赖</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BadInterceptor</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 如果拦截的类中调用了这个方法，会导致无限递归</span>
        someMethod();  <span class="hljs-comment">// ✗ 危险</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}

<span class="hljs-comment">// 陷阱2: 忘记调用原方法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">intercept</span><span class="hljs-params">(<span class="hljs-meta">@SuperCall</span> Callable&lt;?&gt; zuper)</span> {
    <span class="hljs-comment">// 忘记调用 zuper.call()</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// ✗ 原方法不会执行</span>
}

<span class="hljs-comment">// 陷阱3: 类加载器问题</span>
Class&lt;?&gt; clazz = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteBuddy</span>()
    .subclass(Original.class)
    .make()
    .load(WrongClassLoader.class.getClassLoader())  <span class="hljs-comment">// ✗ 错误的类加载器</span>
    .getLoaded();
</code></pre>
<h3 data-id="heading-25">九、总结</h3>
<h4 data-id="heading-26">9.1 ElementMatcher使用指南</h4>
<pre><code class="hljs language-scss" lang="scss">ElementMatcher选择流程：
┌────────────────────────────────────────────┐
│ 需要匹配什么？                              │
├────────────────────────────────────────────┤
│ 类名         → <span class="hljs-built_in">named</span>(), <span class="hljs-built_in">nameStartsWith</span>()  │
│ 方法名       → <span class="hljs-built_in">named</span>(), <span class="hljs-built_in">nameMatches</span>()     │
│ 注解         → <span class="hljs-built_in">isAnnotatedWith</span>()          │
│ 修饰符       → <span class="hljs-built_in">isPublic</span>(), <span class="hljs-built_in">isStatic</span>()     │
│ 返回值       → <span class="hljs-built_in">returns</span>()                  │
│ 参数         → <span class="hljs-built_in">takesArguments</span>()           │
│ 继承关系     → <span class="hljs-built_in">isSubTypeOf</span>()              │
│ 组合条件     → <span class="hljs-built_in">and</span>(), <span class="hljs-built_in">or</span>(), <span class="hljs-built_in">not</span>()         │
└────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-27">9.2 适用场景总结</h4>








































<table><thead><tr><th>场景</th><th>实现方式</th><th>难度</th></tr></thead><tbody><tr><td>日志记录</td><td>MethodDelegation</td><td>★☆☆☆☆</td></tr><tr><td>性能监控</td><td>MethodDelegation + 注解</td><td>★★☆☆☆</td></tr><tr><td>事务管理</td><td>MethodDelegation + ThreadLocal</td><td>★★★☆☆</td></tr><tr><td>数据库监控</td><td>MethodDelegation + SQL解析</td><td>★★★☆☆</td></tr><tr><td>Java Agent</td><td>AgentBuilder</td><td>★★★★☆</td></tr><tr><td>类增强</td><td>Subclass/Redefine</td><td>★★★★☆</td></tr></tbody></table>
<h4 data-id="heading-28">9.3 学习资源</h4>
<ul>
<li><strong>官方文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fbytebuddy.net%2F" target="_blank" title="https://bytebuddy.net/" ref="nofollow noopener noreferrer">bytebuddy.net/</a></li>
<li><strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fraphw%2Fbyte-buddy" target="_blank" title="https://github.com/raphw/byte-buddy" ref="nofollow noopener noreferrer">github.com/raphw/byte-…</a></li>
<li><strong>教程</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.baeldung.com%2Fbyte-buddy" target="_blank" title="https://www.baeldung.com/byte-buddy" ref="nofollow noopener noreferrer">www.baeldung.com/byte-buddy</a></li>
<li><strong>实战项目</strong>: SkyWalking、Arthas等APM工具</li>
</ul>
<p>ByteBuddy作为现代化的字节码操作框架，通过ElementMatcher等高级API，让字节码增强变得简单而强大。掌握ElementMatcher的使用，是发挥ByteBuddy全部潜力的关键！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入剖析：按下 F5 后，浏览器前端究竟发生了什么？]]></title>    <link>https://juejin.cn/post/7576532425762865167</link>    <guid>https://juejin.cn/post/7576532425762865167</guid>    <pubDate>2025-11-26T02:53:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576532425762865167" data-draft-id="7576571960286969891" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入剖析：按下 F5 后，浏览器前端究竟发生了什么？"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-26T02:53:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木易士心"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入剖析：按下 F5 后，浏览器前端究竟发生了什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木易士心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:53:21.000Z" title="Wed Nov 26 2025 02:53:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>@<a href="https://link.juejin.cn?target=%25E6%2596%2587%25E7%25AB%25A0%25E7%259B%25AE%25E5%25BD%2595" target="_blank" title="%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95" ref="nofollow noopener noreferrer">TOC</a></p>
<h2 data-id="heading-0">概述</h2>
<p>在前端开发中，“刷新页面”看似是一个简单操作，实则背后隐藏着复杂的网络通信、缓存策略与渲染引擎协作流程。尤其是 <strong>F5 刷新</strong>，它既不是“完全重新加载”，也不是“直接使用本地缓存”，而是一种<strong>介于两者之间的智能验证机制</strong>。要真正掌握前端性能优化与调试技巧，必须深入理解这一过程。</p>
<p>本文将系统拆解 <strong>F5（普通刷新）</strong> 的完整生命周期，并与 <code>Ctrl+F5</code>（硬刷新）、地址栏回车等行为进行对比，揭示浏览器在缓存、网络、解析与渲染各阶段的真实行为。</p>
<h3 data-id="heading-1">一、关键前提：三种导航方式的本质区别</h3>
<p>首先必须明确：<strong>“刷新” ≠ “重新加载”</strong>。浏览器对不同用户操作采取截然不同的缓存策略。</p>

































<table><thead><tr><th>用户操作</th><th>行为类型</th><th>缓存策略</th><th>网络请求特征</th><th>类比说明</th></tr></thead><tbody><tr><td><strong>F5 / 刷新按钮</strong></td><td><strong>普通刷新（Reload）</strong></td><td><strong>跳过强缓存，启用协商缓存</strong></td><td>请求携带 <code>If-Modified-Since</code> 或 <code>If-None-Match</code> 头</td><td>“我有旧稿，请确认是否仍有效。”</td></tr><tr><td><strong>Ctrl+F5 / Shift+F5</strong></td><td><strong>强制刷新（Hard Reload）</strong></td><td><strong>完全绕过所有缓存</strong></td><td>请求头含 <code>Cache-Control: no-cache</code>, <code>Pragma: no-cache</code>，且不发送协商头</td><td>“无视我手上的任何东西，请给我最新版！”</td></tr><tr><td><strong>地址栏回车 / 新标签打开</strong></td><td><strong>正常导航（Navigation）</strong></td><td><strong>优先使用强缓存</strong></td><td>若强缓存未过期，<strong>无网络请求</strong></td><td>“我有正版书，直接看就行。”</td></tr></tbody></table>
<blockquote>
<p><strong>注意</strong>：某些浏览器（如 Chrome）在开发者工具开启时，会默认将 F5 行为变为“禁用缓存”，这是调试模式下的特殊行为，不属于标准规范。</p>
</blockquote>
<h3 data-id="heading-2">二、核心概念：强缓存 vs 协商缓存</h3>
<h4 data-id="heading-3">1. 强缓存（Strong Caching）</h4>
<ul>
<li><strong>定义</strong>：浏览器无需与服务器通信，直接从本地缓存（内存或磁盘）返回资源。</li>
<li><strong>控制头</strong>：
<ul>
<li><code>Cache-Control: max-age=3600</code>（HTTP/1.1，优先级高）</li>
<li><code>Expires: Wed, 26 Nov 2025 12:00:00 GMT</code>（HTTP/1.0，易受客户端时间影响）</li>
</ul>
</li>
<li><strong>特点</strong>：<strong>零网络请求</strong>，响应极快，但可能导致用户看到过期内容。</li>
</ul>
<h4 data-id="heading-4">2. 协商缓存（Revalidation Caching）</h4>
<ul>
<li><strong>定义</strong>：浏览器向服务器发起“验证请求”，确认缓存是否仍有效。</li>
<li><strong>两组经典配对</strong>：
<ul>
<li><strong>Last-Modified / If-Modified-Since</strong><br/>
基于文件最后修改时间（秒级精度，可能误判）。</li>
<li><strong>ETag / If-None-Match</strong><br/>
基于资源内容的唯一指纹（如哈希值），<strong>精度更高，优先级更高</strong>。</li>
</ul>
</li>
<li><strong>服务器响应</strong>：
<ul>
<li>资源未变 → 返回 <code>304 Not Modified</code>（空响应体，节省带宽）</li>
<li>资源已变 → 返回 <code>200 OK</code> + 新内容 + 更新缓存头</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>ETag 生成策略</strong>：常见实现包括文件内容 MD5、inode+mtime（Nginx 默认）、或自定义业务逻辑。强一致性 ETag 可避免“时间戳精度不足”导致的缓存失效问题。</p>
</blockquote>
<h4 data-id="heading-5">三、F5 刷新全景流程图</h4>
<ol>
<li><strong>开始阶段</strong>（绿色）：用户按下 F5 的指令下达</li>
<li><strong>缓存处理阶段</strong>（蓝色）：绕过强缓存，启用协商缓存的网络验证过程</li>
<li><strong>服务器决策</strong>（橙色菱形）：判断资源是否变化的分支逻辑</li>
<li><strong>资源获取</strong>（青色）：根据 304/200 响应决定使用缓存还是新内容</li>
<li><strong>页面渲染流程</strong>（蓝色）：从 HTML 解析到最终合成的完整渲染管线</li>
<li><strong>循环处理</strong>（紫色）：对每个子资源重复缓存验证的过程
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e0f43d12f6c4edbbce05bf65378006a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyo5piT5aOr5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764730401&amp;x-signature=9XZ9N7WKI6OQkRfHluXuTJYTF5I%3D" alt="在这里插入图片描述" loading="lazy"/></li>
</ol>
<h3 data-id="heading-6">四、F5 刷新的完整生命周期详解</h3>
<p>假设当前页面为 <code>https://example.com/index.html</code>，用户按下 <strong>F5</strong>。</p>
<h4 data-id="heading-7">阶段一：主文档（HTML）的缓存验证与获取</h4>
<ol>
<li>
<p><strong>触发刷新指令</strong><br/>
浏览器识别到这是“Reload”操作，<strong>强制跳过强缓存</strong>，即使 <code>Cache-Control: max-age=86400</code> 也无效。</p>
</li>
<li>
<p><strong>构造验证请求</strong><br/>
对主 HTML 文档发起 GET 请求，自动附加协商头（若之前存在）：</p>
<pre><code class="hljs language-http" lang="http">GET /index.html HTTP/1.1
If-None-Match: "abc123"
If-Modified-Since: Wed, 25 Nov 2025 10:00:00 GMT
</code></pre>
</li>
<li>
<p><strong>服务器决策</strong></p>
<ul>
<li>若资源未变 → 返回 <code>304 Not Modified</code>，<strong>不传输 body</strong>，浏览器复用本地缓存。</li>
<li>若资源已变 → 返回 <code>200 OK</code> + 新 HTML + 更新 <code>ETag</code>/<code>Last-Modified</code>。</li>
</ul>
</li>
</ol>
<blockquote>
<p>⚠️ <strong>重要细节</strong>：即使返回 <code>304</code>，浏览器仍会<strong>重新解析 HTML</strong>！因为缓存的是字节流，而非 DOM 树。</p>
</blockquote>
<h4 data-id="heading-8">阶段二：HTML 解析与渲染流水线（Critical Rendering Path）</h4>
<p>无论 HTML 来自缓存还是新下载，浏览器都会<strong>完整执行渲染流程</strong>：</p>
<ol start="4">
<li>
<p><strong>构建 DOM 树</strong></p>
<ul>
<li>逐行解析 HTML 字节流，生成节点对象。</li>
<li>遇到 <code>&lt;script&gt;</code> 时，默认<strong>阻塞 HTML 解析</strong>（除非标记 <code>async</code> 或 <code>defer</code>）。</li>
</ul>
</li>
<li>
<p><strong>构建 CSSOM 树</strong></p>
<ul>
<li>解析内联样式或外部 CSS 文件（通过 <code>&lt;link&gt;</code>）。</li>
<li>CSS 是<strong>阻塞渲染</strong>的：没有 CSSOM，无法构建渲染树。</li>
</ul>
</li>
<li>
<p><strong>合成渲染树（Render Tree）</strong></p>
<ul>
<li>合并 DOM 与 CSSOM，剔除不可见节点（如 <code>display: none</code>）。</li>
<li>包含每个可见节点的计算样式（computed style）。</li>
</ul>
</li>
<li>
<p><strong>布局（Layout / Reflow）</strong></p>
<ul>
<li>计算每个节点的几何信息（位置、尺寸）。</li>
<li>触发条件：DOM 结构变化、窗口 resize、JS 读取 offset 等。</li>
</ul>
</li>
<li>
<p><strong>绘制（Paint / Repaint）</strong></p>
<ul>
<li>将渲染树转换为屏幕像素（颜色、边框、文本等）。</li>
<li>分层绘制（Layerization）：现代浏览器会将复杂元素（如 <code>transform</code>、<code>opacity</code>）提升为独立图层。</li>
</ul>
</li>
<li>
<p><strong>合成（Compositing）</strong></p>
<ul>
<li>合成线程将各图层按 Z 轴顺序合并，最终输出到 GPU 显示。</li>
<li>此阶段可实现高性能动画（如 <code>transform</code> 不触发 layout/paint）。</li>
</ul>
</li>
</ol>
<blockquote>
<p><strong>性能提示</strong>：F5 刷新虽复用部分缓存，但仍需完整渲染流程。因此，<strong>减少 DOM 复杂度、优化 CSS 选择器、合理使用 <code>will-change</code></strong> 对刷新体验至关重要。</p>
</blockquote>
<h4 data-id="heading-9">阶段三：子资源（CSS/JS/IMG）的缓存处理</h4>
<ol start="10">
<li>
<p><strong>递归处理依赖资源</strong><br/>
在解析 HTML 过程中发现的 <code>&lt;link&gt;</code>, <code>&lt;script&gt;</code>, <code>&lt;img&gt;</code> 等，<strong>每一个都会触发一次 F5 式的协商缓存请求</strong>：</p>
<ul>
<li>请求头同样携带 <code>If-None-Match</code>（若之前存在 ETag）</li>
<li>服务器同样返回 <code>304</code> 或 <code>200</code></li>
</ul>
</li>
<li>
<p><strong>JavaScript 的特殊行为</strong></p>
<ul>
<li><strong>传统 <code>&lt;script&gt;</code></strong>：阻塞 HTML 解析，直到 JS 下载、解析、执行完毕。</li>
<li><strong><code>&lt;script async&gt;</code></strong>：异步下载，下载完成后立即执行（可能打乱顺序）。</li>
<li><strong><code>&lt;script defer&gt;</code></strong>：异步下载，延迟到 DOMContentLoaded 前执行（推荐用于非关键 JS）。</li>
<li><strong>模块脚本（<code>type="module"</code>）</strong>：默认具有 <code>defer</code> 行为。</li>
</ul>
</li>
</ol>
<blockquote>
<p><strong>现代优化趋势</strong>：通过 <code>rel="preload"</code>、<code>&lt;link rel="prefetch"&gt;</code>、资源内联（Critical CSS/JS）等方式，可显著提升 F5 刷新后的感知速度。</p>
</blockquote>
<h3 data-id="heading-10">五、对比总结：F5 与其他操作的本质差异</h3>









































<table><thead><tr><th>维度</th><th>F5 刷新</th><th>Ctrl+F5 硬刷新</th><th>地址栏回车</th></tr></thead><tbody><tr><td><strong>强缓存</strong></td><td>跳过</td><td>跳过</td><td>使用（若有效）</td></tr><tr><td><strong>协商缓存</strong></td><td>启用</td><td>跳过</td><td>若强缓存失效则启用</td></tr><tr><td><strong>网络请求量</strong></td><td>中（仅验证）</td><td>高（全量拉取）</td><td>低（可能无请求）</td></tr><tr><td><strong>HTML 是否重解析</strong></td><td>是</td><td>是</td><td>是（若缓存命中则复用字节流）</td></tr><tr><td><strong>适用场景</strong></td><td>开发调试、内容可能更新</td><td>强制获取最新资源</td><td>日常浏览</td></tr></tbody></table>
<h3 data-id="heading-11">六、给前端开发者的实践建议</h3>
<ol>
<li>
<p><strong>合理配置缓存策略</strong></p>
<ul>
<li>HTML：<code>Cache-Control: no-cache</code>（强制协商，确保内容最新）</li>
<li>静态资源（JS/CSS/IMG）：<code>Cache-Control: public, max-age=31536000</code> + <strong>内容哈希命名</strong>（如 <code>app.a1b2c3.js</code>），实现“永久缓存 + 一键更新”</li>
</ul>
</li>
<li>
<p><strong>利用 ETag 提升缓存精度</strong><br/>
避免仅依赖 <code>Last-Modified</code>，尤其在 CI/CD 频繁构建的场景下。</p>
</li>
<li>
<p><strong>监控 304 响应比例</strong><br/>
高比例的 <code>304</code> 表示缓存策略有效；若大量 <code>200</code>，需检查资源是否被不必要地更新。</p>
</li>
<li>
<p><strong>避免 F5 无法更新的问题</strong><br/>
若用户反馈“改了代码但页面没变”，很可能是 HTML 被强缓存。务必确保 HTML 不设长缓存。</p>
</li>
</ol>
<h3 data-id="heading-12">七、结语</h3>
<p>F5 刷新远非“重新加载”那么简单——它是浏览器在<strong>用户体验、网络效率与数据一致性</strong>之间做出的精妙权衡。理解其背后的缓存机制与渲染流程，不仅能帮助我们写出更高效的前端代码，更能精准定位“为什么我的更新没生效”这类经典难题。</p>
<p>掌握这些底层原理，你便能在性能优化、缓存设计与故障排查中游刃有余，真正成为一名“知其然，更知其所以然”的前端工程师。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apifox 11 月更新｜AI 生成测试用例能力持续升级、JSON Body 自动补全、支持为响应组件添加描述和 Header]]></title>    <link>https://juejin.cn/post/7576573061580603433</link>    <guid>https://juejin.cn/post/7576573061580603433</guid>    <pubDate>2025-11-26T02:56:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576573061580603433" data-draft-id="7576573061580128297" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apifox 11 月更新｜AI 生成测试用例能力持续升级、JSON Body 自动补全、支持为响应组件添加描述和 Header"/> <meta itemprop="keywords" content="前端,后端,测试"/> <meta itemprop="datePublished" content="2025-11-26T02:56:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Apifox"/> <meta itemprop="url" content="https://juejin.cn/user/2766843870448222"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apifox 11 月更新｜AI 生成测试用例能力持续升级、JSON Body 自动补全、支持为响应组件添加描述和 Header
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2766843870448222/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Apifox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T02:56:55.000Z" title="Wed Nov 26 2025 02:56:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Apifox 新版本上线啦！看看本次版本更新主要涵盖的重点内容，有没有你所关注的功能特性：</p>
<ul>
<li><strong>「AI 生成测试用例」持续升级</strong>
<ul>
<li>支持先编辑确认用例列表和描述，再生成用例详情</li>
<li>支持生成断言、自定义脚本等前后置操作</li>
<li>支持基于当前的接口测试用例，通过 AI 补充生成更多测试用例</li>
</ul>
</li>
<li><strong>接口调试体验优化</strong>
<ul>
<li>根据接口文档自动补全 JSON Body</li>
<li>获取 OAuth 2.0 Token 后可设为变量的本地值</li>
<li>gRPC 错误响应也支持查看 Metadata &amp; Trailer</li>
</ul>
</li>
<li><strong>支持为响应组件添加描述和 Header</strong></li>
<li><strong>用户反馈优化</strong>
<ul>
<li>全局变量支持多人在线协作、实时自动更新</li>
<li>用 Apifox CLI 指定环境运行测试场景后，收到的 Webhook 通知会包含环境名称</li>
</ul>
</li>
</ul>
<p><strong>将 Apifox 更新至最新版，一起开启全新体验吧！</strong></p>
<h2 data-id="heading-0">「AI 生成测试用例」持续升级</h2>
<p>只需在组织层级完成 AI 功能配置，组织内所有团队即可直接使用 AI 生成测试用例。Apifox 将持续迭代优化此功能，以满足更多用户需求与多样化使用场景。</p>
<h3 data-id="heading-1">支持先编辑确认用例列表和描述，再生成用例详情</h3>
<p>Apifox 本次更新优化了 AI 生成测试用例的流程，引入两步生成机制：</p>
<ol>
<li>先通过 AI 生成用例列表及描述，用户可预览并进行编辑调整</li>
<li>确认无误后，再生成详细的测试用例内容</li>
</ol>
<p>通过新增的中间编辑确认环节，使用户能够在生成用例的过程中进行干预和调整，确保生成的测试用例更贴合实际需求，提高测试用例的质量，也让 AI 辅助测试更加灵活可控。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8929aa0ca10b4a0fa80998e74ce21451~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764730614&amp;x-signature=yD%2BSs%2B4%2FuT%2FDUI9zJW51%2BWNajdk%3D" alt="支持先编辑确认用例列表和描述，再生成用例详情" loading="lazy"/></p>
<h3 data-id="heading-2">支持生成断言、自定义脚本等前后置操作</h3>
<p>更新至最新版 Apifox 后，使用 AI 生成测试用例时，可同时生成断言、自定义脚本等前后置操作，大幅提升测试用例的完整性与可执行性，减少手动配置。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bda4a15b4344435a434d43ed6319bf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764730614&amp;x-signature=MSoR2TLfItdkRDOQpt2g1AMAzEI%3D" alt="支持生成断言、自定义脚本等前后置操作" loading="lazy"/></p>
<h3 data-id="heading-3">支持基于当前的接口测试用例，通过 AI 补充生成更多测试用例</h3>
<p>支持基于接口现有的测试用例，让 AI 补充生成更全面的测试场景。扩展测试覆盖范围的同时，确保新生成的用例与现有测试策略保持一致，从而帮助团队更高效地优化测试方案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28c8c65b633a414192812b9a26ef1431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764730614&amp;x-signature=aTD8bM%2FmaILiSV22Yti8yJPoJus%3D" alt="支持基于当前的接口测试用例，通过 AI 补充生成更多测试用例" loading="lazy"/></p>
<h2 data-id="heading-4">接口调试体验优化</h2>
<h3 data-id="heading-5">根据接口文档自动补全 JSON Body</h3>
<p>若接口文档中已定义 Body 数据结构，调试时将自动提供 JSON 字段补全提示，帮助用户快速准确地填充数据，降低手动输入错误率，提升调试效率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3711f58ae5e64ec1af17fc31f23092fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764730614&amp;x-signature=15hVg688tTvbiwouYkhWGOlt%2FMI%3D" alt="根据接口文档自动补全 JSON Body" loading="lazy"/></p>
<h3 data-id="heading-6">获取 OAuth 2.0 Token 后可设为变量的本地值</h3>
<p>Apifox 支持将获取的 OAuth 2.0 Token 设置为变量本地值，在保护 Token 私密性的同时又能正常用于接口鉴权，避免与团队其他成员共享敏感信息，实现安全高效的协作开发。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/512f763e57c3418b82d14a4a13d1a5b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764730614&amp;x-signature=7ZrFHITr4pm7xvOi5K3KmOZCx2s%3D" alt="获取 OAuth 2.0 Token 后可设为变量的本地值" loading="lazy"/></p>
<h3 data-id="heading-7">gRPC 错误响应也支持查看 Metadata &amp; Trailer</h3>
<p>更新至最新版本后，即使 gRPC 接口返回错误，Apifox 仍会正常显示 Metadata 和 Trailer 信息，帮助开发者在异常情况下更快速、精准地定位问题根源，提升 gRPC 调试的完整性和准确性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af8471d95ff545a18da3be52c5e4c31e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764730614&amp;x-signature=v3CRiy7oH3kRHHM3VDbOp9zE4R8%3D" alt="gRPC 错误响应也支持查看 Metadata &amp; Trailer" loading="lazy"/></p>
<h2 data-id="heading-8">支持为响应组件添加描述和 Header</h2>
<p>用户现可在 Apifox 中为响应组件添加详细描述，并配置必要的 Header 参数，提升响应组件的完整性和专业性，为团队协作与开发提供更高效、更优质的体验。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b5aaaa247e3406a9c41a70e5aef7213~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764730614&amp;x-signature=hCbsP35xhOEN4RMHsw%2BrryU2r5o%3D" alt="支持为响应组件添加描述和 Header" loading="lazy"/></p>
<h2 data-id="heading-9">用户反馈优化</h2>
<h3 data-id="heading-10">全局变量支持多人在线协作、实时自动更新</h3>
<p>继「环境变量」之后，「全局变量」也已支持多人在线协作与实时同步。团队成员可同时在线编辑全局变量，所有更改都将实时自动同步，确保团队配置始终保持一致，提升协作流畅度与开发效率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b18a2d4f3c354fb58896058f6aa14673~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXBpZm94:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764730614&amp;x-signature=sCPtZajAaCunI%2FzqvajDFtRf9kU%3D" alt="全局变量支持多人在线协作、实时自动更新" loading="lazy"/></p>
<h3 data-id="heading-11">用 Apifox CLI 指定环境运行测试场景后，收到的 Webhook 通知会包含环境名称</h3>
<p>当使用 Apifox CLI 指定环境运行测试场景时，Webhook 通知将自动包含环境名称，使测试结果更易追溯与区分，提升多环境测试流程的透明度与可管理性。</p>
<h2 data-id="heading-12"><strong>了解更多</strong></h2>
<p>当然，Apifox 产品团队为大家带来的新功能远不止上方这些：</p>
<ul>
<li>组织配置好了 AI 功能后，组织内的团队就能直接使用</li>
<li>针对 HTTP Code 进行断言时，支持更多条件</li>
<li>支持模糊搜索模块名称</li>
<li>优化了选择、搜索测试报告中步骤的交互</li>
<li>AI 模型报错时，提供更清晰的提示和指引</li>
<li>AI 生成测试用例时，如果没有选择任何用例类型，会优先基于用户输入指令生成所需用例分类</li>
<li>优化了新建接口时，切换当前接口使用设计界面还是调试界面的交互</li>
<li>运行测试场景时如果选择了私人环境，团队内的其他人会看到“请选择环境”的提示，而不是“环境已被删除”</li>
<li>解决调试 WebSocket 或 Socket.IO 接口时，如果 URL 为  <code>ws://</code>  且不指定端口，默认连接了 443 端口而不是 80 端口的问题</li>
<li>解决开启了“兼容 HTTP/2”后，如果一个请求还没有得到响应时就发起另一个请求，前一个请求会出现“socket hang up”错误的问题</li>
<li>解决从主分支导出 OpenAPI/Swagger 数据，再导入到子分支，子分支的鉴权组件没有和主分支关联的问题</li>
<li>解决配置 Git 仓库连接时，最多只能显示 30 个 Git 分支的问题</li>
</ul>
<p>除了新增功能，我们也对产品细节和使用体验进行了优化，<strong>具体修改内容可前往 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fchangelog" target="_blank" title="https://docs.apifox.com/changelog" ref="nofollow noopener noreferrer">Apifox 更新日志</a>查看</strong>。</p>
<p>欢迎各位用户对 Apifox 继续提出使用反馈和优化意见，我们会持续优化更新，致力于为用户提供更优秀的产品功能与更极致的使用体验！</p>
<p>可以前往帮助文档查看更多使用说明和操作，在使用过程中有有任何问题或建议，欢迎在 Apifox <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.apifox.com%2Fdoc-5751209%23%25E7%2594%25A8%25E6%2588%25B7%25E7%25BE%25A4%2F" target="_blank" title="https://docs.apifox.com/doc-5751209#%E7%94%A8%E6%88%B7%E7%BE%A4/" ref="nofollow noopener noreferrer">用户群</a>与我们交流沟通。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 语言爬虫实战：基于 Colly 的高性能采集框架指南]]></title>    <link>https://juejin.cn/post/7576105442214314034</link>    <guid>https://juejin.cn/post/7576105442214314034</guid>    <pubDate>2025-11-25T00:15:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576105442214314034" data-draft-id="7576124206398406666" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 语言爬虫实战：基于 Colly 的高性能采集框架指南"/> <meta itemprop="keywords" content="后端,Go,Trae"/> <meta itemprop="datePublished" content="2025-11-25T00:15:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 语言爬虫实战：基于 Colly 的高性能采集框架指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T00:15:24.000Z" title="Tue Nov 25 2025 00:15:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Python 生态中，Scrapy 是大家熟知的爬虫框架；而在 Go 语言世界里，<strong>Colly</strong> 则是同级别的轻量级、高性能、易扩展的采集利器。
凭借 Go 的并发优势，Colly 能够在极低资源占用下实现高并发抓取，是构建数据采集、监控、舆情系统的理想选择。</p>
<p>本文将带你快速掌握 Colly 的核心能力，从安装、基础用法到反爬突破与案例实战，帮助你快速上手 Go 爬虫。</p>
<hr/>
<h2 data-id="heading-0">一 Colly 是什么？</h2>
<p>Colly 是 Go 中最流行的爬虫框架之一，目标是提供
<strong>快速 可靠 可扩展 的网络爬虫解决方案</strong></p>
<p>它具有以下特点：</p>
<ul>
<li>API 简洁清晰，上手难度低</li>
<li>内置并发队列，支持高并发爬取</li>
<li>自动管理 Cookie、Referer、User-Agent</li>
<li>支持 DOM 选择器 CSS Selector</li>
<li>支持深度控制、域名白名单、请求限制</li>
<li>支持回调函数式编程，非常灵活</li>
<li>可扩展中间件、代理、去重规则</li>
</ul>
<p>这使得 Colly 成为构建生产级爬虫的强大工具。</p>
<hr/>
<h2 data-id="heading-1">二 安装 Colly</h2>
<p>执行：</p>
<pre><code class="hljs language-bash" lang="bash">go get -u github.com/gocolly/colly/v2
</code></pre>
<p>导入：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/gocolly/colly/v2"</span>
</code></pre>
<p>你就可以开始写爬虫了。</p>
<hr/>
<h2 data-id="heading-2">三 编写你的第一个 Colly 爬虫</h2>
<p>下面通过一个示例，抓取新闻网站的标题。</p>
<h3 data-id="heading-3">1 创建采集器</h3>
<pre><code class="hljs language-go" lang="go">c := colly.NewCollector()
</code></pre>
<h3 data-id="heading-4">2 注册回调解析页面内容</h3>
<pre><code class="hljs language-go" lang="go">c.OnHTML(<span class="hljs-string">"h1.title"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(e *colly.HTMLElement)</span></span> {
    fmt.Println(<span class="hljs-string">"标题:"</span>, e.Text)
})
</code></pre>
<h3 data-id="heading-5">3 处理请求事件</h3>
<pre><code class="hljs language-go" lang="go">c.OnRequest(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r *colly.Request)</span></span> {
    fmt.Println(<span class="hljs-string">"正在访问:"</span>, r.URL.String())
})
</code></pre>
<h3 data-id="heading-6">4 开始访问网页</h3>
<pre><code class="hljs language-go" lang="go">c.Visit(<span class="hljs-string">"https://news.ycombinator.com/"</span>)
</code></pre>
<p>完整代码：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"github.com/gocolly/colly/v2"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	c := colly.NewCollector()

	c.OnRequest(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r *colly.Request)</span></span> {
		fmt.Println(<span class="hljs-string">"访问:"</span>, r.URL.String())
	})

	c.OnHTML(<span class="hljs-string">"a.storylink"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(e *colly.HTMLElement)</span></span> {
		fmt.Println(<span class="hljs-string">"标题:"</span>, e.Text)
		fmt.Println(<span class="hljs-string">"链接:"</span>, e.Attr(<span class="hljs-string">"href"</span>))
	})

	c.Visit(<span class="hljs-string">"https://news.ycombinator.com/"</span>)
}
</code></pre>
<p>运行后即可得到列表页面的标题与链接。</p>
<hr/>
<h2 data-id="heading-7">四 处理多页面采集（自动跟随链接）</h2>
<p>Colly 支持在页面中发现新的 URL 并自动继续爬取：</p>
<pre><code class="hljs language-go" lang="go">c.OnHTML(<span class="hljs-string">"a[href]"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(e *colly.HTMLElement)</span></span> {
    link := e.Request.AbsoluteURL(e.Attr(<span class="hljs-string">"href"</span>))
    c.Visit(link)
})
</code></pre>
<p>配合访问去重机制，Colly 会自动忽略已访问 URL。</p>
<hr/>
<h2 data-id="heading-8">五 设置请求限制：防止被封 IP</h2>
<p>为了避免频繁访问触发反爬，可以设置速率限制。</p>
<pre><code class="hljs language-go" lang="go">c.Limit(&amp;colly.LimitRule{
	DomainGlob:  <span class="hljs-string">"*"</span>,
	Delay:       <span class="hljs-number">1</span> * time.Second,
	RandomDelay: <span class="hljs-number">500</span> * time.Millisecond,
})
</code></pre>
<p>也可以限制并发：</p>
<pre><code class="hljs language-go" lang="go">c.Limit(&amp;colly.LimitRule{
	DomainGlob:  <span class="hljs-string">"*"</span>,
	Parallelism: <span class="hljs-number">2</span>,
})
</code></pre>
<hr/>
<h2 data-id="heading-9">六 设置 User-Agent、Cookie 与 Header</h2>
<p>反爬网站通常会检查 UA 或 Cookie。</p>
<pre><code class="hljs language-go" lang="go">c.OnRequest(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(r *colly.Request)</span></span> {
	r.Headers.Set(<span class="hljs-string">"User-Agent"</span>, <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0)"</span>)
	r.Headers.Set(<span class="hljs-string">"Referer"</span>, <span class="hljs-string">"https://www.google.com"</span>)
})
</code></pre>
<hr/>
<h2 data-id="heading-10">七 使用代理池突破封禁</h2>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/gocolly/colly/v2/proxy"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	c := colly.NewCollector()
	
	rp, _ := proxy.RoundRobinProxySwitcher(
		<span class="hljs-string">"http://127.0.0.1:8080"</span>,
		<span class="hljs-string">"http://127.0.0.1:8081"</span>,
	)
	c.SetProxyFunc(rp)

	c.Visit(<span class="hljs-string">"https://example.com"</span>)
}
</code></pre>
<p>多代理轮换能显著降低封 IP 风险。</p>
<hr/>
<h2 data-id="heading-11">八 深度控制与域名限制</h2>
<p>防止爬虫跑飞：</p>
<pre><code class="hljs language-go" lang="go">c.AllowedDomains = []<span class="hljs-type">string</span>{<span class="hljs-string">"example.com"</span>}
</code></pre>
<p>限制深度：</p>
<pre><code class="hljs language-go" lang="go">c.MaxDepth = <span class="hljs-number">2</span>
</code></pre>
<hr/>
<h2 data-id="heading-12">九 数据存储：CSV、JSON、数据库</h2>
<p>保存到 CSV：</p>
<pre><code class="hljs language-go" lang="go">f, _ := os.Create(<span class="hljs-string">"result.csv"</span>)
w := csv.NewWriter(f)

c.OnHTML(<span class="hljs-string">"h2"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(e *colly.HTMLElement)</span></span> {
    w.Write([]<span class="hljs-type">string</span>{e.Text})
})
</code></pre>
<p>保存到 MySQL / MongoDB 也只需在回调中插入数据库即可。</p>
<hr/>
<h2 data-id="heading-13">十 实战案例：抓取京东商品信息</h2>
<p>示例：抓取商品名称与价格</p>
<pre><code class="hljs language-go" lang="go">c := colly.NewCollector()

c.OnHTML(<span class="hljs-string">".gl-item"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(e *colly.HTMLElement)</span></span> {
	title := e.ChildText(<span class="hljs-string">".p-name em"</span>)
	price := e.ChildText(<span class="hljs-string">".p-price i"</span>)
	fmt.Println(title, price)
})

c.Visit(<span class="hljs-string">"https://search.jd.com/Search?keyword=手机"</span>)
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">小米</span> <span class="hljs-number">14</span> <span class="hljs-number">4599</span>
<span class="hljs-string">iPhone</span> <span class="hljs-number">15</span> <span class="hljs-number">5999</span>
<span class="hljs-string">……</span>
</code></pre>
<p>短短十行代码即可完成一个实用的采集器。</p>
<hr/>
<h2 data-id="heading-14">十一 Colly 适合哪些场景？</h2>
<ul>
<li>商品价格监控</li>
<li>平台舆情与数据采集</li>
<li>文章/新闻抓取</li>
<li>实时监控系统</li>
<li>多站点聚合爬虫</li>
<li>数据分析与可视化后台的数据来源</li>
</ul>
<p>Go 的高并发 + Colly 的简洁 API = 高性能、高可靠的数据采集工具。</p>
<hr/>
<h2 data-id="heading-15">十二 总结</h2>
<p>Colly 是 Go 中最易用、最强大的爬虫框架之一，具备：</p>
<ul>
<li>API 简洁</li>
<li>并发强</li>
<li>扩展性高</li>
<li>稳定可靠</li>
</ul>
<p>本文从基础到高级应用进行了全面讲解，包括：</p>
<ol>
<li>创建采集器与回调</li>
<li>解析页面内容</li>
<li>控制并发与反爬</li>
<li>代理池与 UA 伪装</li>
<li>自动跟随链接</li>
<li>保存数据</li>
<li>实战案例</li>
</ol>
<p>掌握 Colly，可以让你在 Go 项目中快速构建高性能爬虫服务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[四、虚拟 DOM 与 Diff 算法：架构设计的智慧]]></title>    <link>https://juejin.cn/post/7576479344039067700</link>    <guid>https://juejin.cn/post/7576479344039067700</guid>    <pubDate>2025-11-25T13:05:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576479344039067700" data-draft-id="7576487832089985039" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="四、虚拟 DOM 与 Diff 算法：架构设计的智慧"/> <meta itemprop="keywords" content="前端,React.js,架构"/> <meta itemprop="datePublished" content="2025-11-25T13:05:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小璞"/> <meta itemprop="url" content="https://juejin.cn/user/1609340755378829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            四、虚拟 DOM 与 Diff 算法：架构设计的智慧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1609340755378829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小璞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T13:05:53.000Z" title="Tue Nov 25 2025 13:05:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">核心问题：如何在性能与开发体验之间找到平衡点？</h2>
<h3 data-id="heading-1">问题的起源</h3>
<p>想象你是 React 的架构师，面临一个两难选择：</p>
<p><strong>选择 A：直接操作 DOM</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 每次数据变化，手动更新 DOM</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateUI</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'username'</span>).<span class="hljs-property">textContent</span> = data.<span class="hljs-property">username</span>;
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'age'</span>).<span class="hljs-property">textContent</span> = data.<span class="hljs-property">age</span>;
  <span class="hljs-comment">// ... 需要精确知道更新哪些节点</span>
}
</code></pre>
<ul>
<li>✅ 性能好：只更新变化的部分</li>
<li>❌ 开发体验差：要手动追踪所有变化</li>
</ul>
<p><strong>选择 B：暴力重建整个 DOM</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 每次数据变化，重新渲染整个页面</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateUI</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
    &lt;div&gt;
      &lt;p&gt;<span class="hljs-subst">${data.username}</span>&lt;/p&gt;
      &lt;p&gt;<span class="hljs-subst">${data.age}</span>&lt;/p&gt;
    &lt;/div&gt;
  `</span>;
}
</code></pre>
<ul>
<li>✅ 开发体验好：不用关心变化细节</li>
<li>❌ 性能差：DOM 操作太昂贵，会闪烁、丢失状态</li>
</ul>
<p><strong>React 的答案：虚拟 DOM（中间层抽象）</strong></p>
<hr/>
<h2 data-id="heading-2">架构设计思路：引入中间层</h2>
<h3 data-id="heading-3">核心思想：用"便宜的计算"替代"昂贵的操作"</h3>
<pre><code class="hljs language-javascript" lang="javascript">┌─────────────────────────────────────────────────────────┐
│                    架构分层                              │
├─────────────────────────────────────────────────────────┤
│  开发者                                                  │
│    ↓  写声明式代码：<span class="hljs-title function_">render</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span> }  │
├─────────────────────────────────────────────────────────┤
│  虚拟 <span class="hljs-variable constant_">DOM</span> (中间层)                                       │
│    ↓  便宜的 <span class="hljs-variable constant_">JS</span> 对象操作                                │
│    ↓  <span class="hljs-title class_">Diff</span> 算法计算最小变更                             │
├─────────────────────────────────────────────────────────┤
│  真实 <span class="hljs-variable constant_">DOM</span>                                                │
│    ↓  只执行必要的昂贵操作                              │
└─────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>架构智慧：</strong></p>
<ul>
<li>开发者获得"暴力重建"的开发体验（声明式）</li>
<li>用户获得"精确更新"的性能（自动优化）</li>
<li>通过中间层完成魔法转换</li>
</ul>
<hr/>
<h2 data-id="heading-4">虚拟 DOM 是什么？</h2>
<h3 data-id="heading-5">本质：用 JavaScript 对象描述 UI</h3>
<p><strong>真实 DOM：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text"</span>&gt;</span>World<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>虚拟 DOM（就是 JS 对象）：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">type</span>: <span class="hljs-string">'div'</span>,
  <span class="hljs-attr">props</span>: { <span class="hljs-attr">id</span>: <span class="hljs-string">'app'</span> },
  <span class="hljs-attr">children</span>: [
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'h1'</span>,
      <span class="hljs-attr">props</span>: {},
      <span class="hljs-attr">children</span>: [<span class="hljs-string">'Hello'</span>]
    },
    {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'p'</span>,
      <span class="hljs-attr">props</span>: { <span class="hljs-attr">className</span>: <span class="hljs-string">'text'</span> },
      <span class="hljs-attr">children</span>: [<span class="hljs-string">'World'</span>]
    }
  ]
}
</code></pre>
<p><strong>为什么用 JS 对象？</strong></p>
<ol>
<li>创建对象：极快（内存操作）</li>
<li>对比对象：极快（纯 JS 计算）</li>
<li>操作 DOM：极慢（涉及渲染引擎、重排重绘）</li>
</ol>
<p><strong>成本对比：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">创建</span> <span class="hljs-number">1000</span> <span class="hljs-string">个</span> <span class="hljs-string">JS</span> <span class="hljs-string">对象：</span>    <span class="hljs-string">~1ms</span>
<span class="hljs-string">对比</span> <span class="hljs-number">1000</span> <span class="hljs-string">个</span> <span class="hljs-string">JS</span> <span class="hljs-string">对象：</span>    <span class="hljs-string">~10ms</span>
<span class="hljs-string">操作</span> <span class="hljs-number">1000</span> <span class="hljs-string">个</span> <span class="hljs-string">DOM</span> <span class="hljs-string">节点：</span>   <span class="hljs-string">~100ms+</span>
</code></pre>
<hr/>
<h2 data-id="heading-6">Diff 算法：如何高效计算变化？</h2>
<h3 data-id="heading-7">传统 Diff 算法的问题</h3>
<p><strong>树的编辑距离算法（学术界的标准答案）：</strong></p>
<ul>
<li>时间复杂度：<strong>O(n³)</strong></li>
<li>1000 个节点 = 10 亿次计算</li>
<li>根本无法用于实时 UI 更新</li>
</ul>
<p><strong>React 的架构抉择：用启发式假设换取性能</strong></p>
<hr/>
<h2 data-id="heading-8">三大启发式假设：从 O(n³) 到 O(n)</h2>
<h3 data-id="heading-9">假设 1：同层比较（Level-by-Level）</h3>
<p><strong>传统算法：跨层级比较</strong></p>
<pre><code class="hljs language-css" lang="css">旧树               新树
  <span class="hljs-selector-tag">A</span>                 D
 / \               / \
<span class="hljs-selector-tag">B</span>   C             <span class="hljs-selector-tag">B</span>   C
    |                 |
    D                 <span class="hljs-selector-tag">A</span>

传统算法会尝试：D 从 C 下移动到根？<span class="hljs-selector-tag">A</span> 从根移动到 C 下？
需要计算所有可能性 → O(n³)
</code></pre>
<p><strong>React 的假设：跨层级移动极少发生</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 的做法：只比较同一层级</span>
旧树第<span class="hljs-number">1</span>层: [A]          新树第<span class="hljs-number">1</span>层: [D]  → A 被删除，D 被创建
旧树第<span class="hljs-number">2</span>层: [B, C]       新树第<span class="hljs-number">2</span>层: [B, C]  → 不变
旧树第<span class="hljs-number">3</span>层: [D]          新树第<span class="hljs-number">3</span>层: [A]  → D 被删除，A 被创建
</code></pre>
<p><strong>结果：</strong></p>
<ul>
<li>算法变简单：只遍历一次树 → O(n)</li>
<li>代价：跨层级移动会重建（但极少发生）</li>
</ul>
<p><strong>架构启示：</strong></p>
<blockquote>
<p>通过<strong>合理的假设</strong>简化问题，用"覆盖 99% 场景的简单方案"替代"覆盖 100% 场景的复杂方案"</p>
</blockquote>
<hr/>
<h3 data-id="heading-10">假设 2：类型不同即重建（Type-based）</h3>
<p><strong>React 的假设：类型变了，内容肯定也变了</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 场景：从 div 变成 span</span>
旧: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
新: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>

<span class="hljs-comment">// React 的做法：</span>
<span class="hljs-comment">// 1. 删除整个 div 子树</span>
<span class="hljs-comment">// 2. 创建整个 span 子树</span>
<span class="hljs-comment">// ❌ 不会复用内部的 &lt;p&gt;Hello&lt;/p&gt;</span>
</code></pre>
<p><strong>为什么这样设计？</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 如果要复用子节点，需要：</span>
<span class="hljs-number">1.</span> 对比 div 和 span 的所有属性
<span class="hljs-number">2.</span> 递归对比所有子节点
<span class="hljs-number">3.</span> 计算如何迁移子节点
<span class="hljs-comment">// → 复杂度爆炸</span>

<span class="hljs-comment">// React 的取舍：</span>
<span class="hljs-comment">// 直接重建 → 简单、快速、可预测</span>
</code></pre>
<p><strong>真实场景分析：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 类型改变的场景极少：</span>
&lt;div&gt; → &lt;span&gt;     <span class="hljs-comment">// 很少发生</span>
&lt;button&gt; → &lt;input&gt; <span class="hljs-comment">// 几乎不会</span>

<span class="hljs-comment">// 常见的是同类型更新：</span>
&lt;div className="old"&gt; → &lt;div className="new"&gt;  // 经常发生
</code></pre>
<p><strong>架构启示：</strong></p>
<blockquote>
<p>优化常见路径（同类型更新），简化罕见路径（类型改变）</p>
</blockquote>
<hr/>
<h3 data-id="heading-11">假设 3：Key 标识移动（Key-based）</h3>
<p><strong>问题场景：列表重排</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 没有 key：React 无法识别</span>
旧: [<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>, <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>, <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>]
新: [<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>, <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>, <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>]

<span class="hljs-comment">// React 的误判：</span>
<span class="hljs-comment">// 位置0: A → C  (更新文本)</span>
<span class="hljs-comment">// 位置1: B → A  (更新文本)</span>
<span class="hljs-comment">// 位置2: C → B  (更新文本)</span>
<span class="hljs-comment">// 结果：3 次 DOM 更新</span>
</code></pre>
<p><strong>用 Key 标识：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx">旧: [<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>, <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"b"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>, <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>]
新: [<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"c"</span>&gt;</span>C<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>, <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"a"</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>, <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"b"</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>]

<span class="hljs-comment">// React 的正确判断：</span>
<span class="hljs-comment">// key="c" 的节点移动到位置 0</span>
<span class="hljs-comment">// key="a" 和 key="b" 保持不变</span>
<span class="hljs-comment">// 结果：1 次 DOM 移动操作</span>
</code></pre>
<p><strong>Key 的作用：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 建立身份映射</span>
旧节点集合 = { <span class="hljs-attr">a</span>: <span class="hljs-title class_">NodeA</span>, <span class="hljs-attr">b</span>: <span class="hljs-title class_">NodeB</span>, <span class="hljs-attr">c</span>: <span class="hljs-title class_">NodeC</span> }
新节点集合 = { <span class="hljs-attr">c</span>: <span class="hljs-title class_">NodeC</span>, <span class="hljs-attr">a</span>: <span class="hljs-title class_">NodeA</span>, <span class="hljs-attr">b</span>: <span class="hljs-title class_">NodeB</span> }

<span class="hljs-comment">// 2. 快速查找对应节点</span>
<span class="hljs-keyword">if</span> (旧节点集合[key] === 新节点集合[key]) {
  <span class="hljs-comment">// 复用！只需移动位置</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 新节点，需要创建</span>
}
</code></pre>
<p><strong>为什么用 index 作为 key 是错误的？</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 错误示例：</span>
{list.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item, index</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Item</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{item}</span> /&gt;</span></span>)}

<span class="hljs-comment">// 问题：删除第一项时</span>
旧: [<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Item</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{0}</span> <span class="hljs-attr">data</span>=<span class="hljs-string">"A"</span> /&gt;</span></span>, <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Item</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{1}</span> <span class="hljs-attr">data</span>=<span class="hljs-string">"B"</span> /&gt;</span></span>]
新: [<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Item</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{0}</span> <span class="hljs-attr">data</span>=<span class="hljs-string">"B"</span> /&gt;</span></span>]

<span class="hljs-comment">// React 的误判：</span>
<span class="hljs-comment">// key={0} 的节点还在 → 复用，但数据从 A 变成 B</span>
<span class="hljs-comment">// key={1} 的节点消失 → 删除</span>
<span class="hljs-comment">// 结果：更新了不该更新的节点</span>
</code></pre>
<p><strong>架构启示：</strong></p>
<blockquote>
<p>引入<strong>稳定的标识符</strong>帮助算法识别"同一性"，避免误判</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">完整流程示例：从代码到 DOM 更新</h2>
<h3 data-id="heading-13">步骤 1：开发者写声明式代码</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-14">步骤 2：React 创建虚拟 DOM</h3>
<p><strong>首次渲染（count = 0）：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">type</span>: <span class="hljs-string">'div'</span>,
  <span class="hljs-attr">children</span>: [
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'h1'</span>, <span class="hljs-attr">children</span>: [<span class="hljs-string">'Count: 0'</span>] },
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'button'</span>, <span class="hljs-attr">props</span>: { <span class="hljs-attr">onClick</span>: ... }, <span class="hljs-attr">children</span>: [<span class="hljs-string">'+1'</span>] }
  ]
}
</code></pre>
<p><strong>点击按钮后（count = 1）：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">type</span>: <span class="hljs-string">'div'</span>,
  <span class="hljs-attr">children</span>: [
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'h1'</span>, <span class="hljs-attr">children</span>: [<span class="hljs-string">'Count: 1'</span>] },  <span class="hljs-comment">// 变化！</span>
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'button'</span>, <span class="hljs-attr">props</span>: { <span class="hljs-attr">onClick</span>: ... }, <span class="hljs-attr">children</span>: [<span class="hljs-string">'+1'</span>] }
  ]
}
</code></pre>
<h3 data-id="heading-15">步骤 3：Diff 算法计算变化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 伪代码展示 Diff 过程</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">diff</span>(<span class="hljs-params">oldVNode, newVNode</span>) {
  <span class="hljs-comment">// 层级 1：div</span>
  <span class="hljs-keyword">if</span> (oldVNode.<span class="hljs-property">type</span> === newVNode.<span class="hljs-property">type</span>) {  <span class="hljs-comment">// 'div' === 'div' ✅</span>
    <span class="hljs-comment">// 类型相同，继续比较子节点</span>

    <span class="hljs-comment">// 层级 2：子节点数组</span>
    <span class="hljs-title function_">diffChildren</span>(oldVNode.<span class="hljs-property">children</span>, newVNode.<span class="hljs-property">children</span>);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">diffChildren</span>(<span class="hljs-params">oldChildren, newChildren</span>) {
  <span class="hljs-comment">// 子节点 0：h1</span>
  <span class="hljs-keyword">if</span> (oldChildren[<span class="hljs-number">0</span>].<span class="hljs-property">type</span> === newChildren[<span class="hljs-number">0</span>].<span class="hljs-property">type</span>) {  <span class="hljs-comment">// 'h1' === 'h1' ✅</span>
    <span class="hljs-comment">// 比较文本内容</span>
    <span class="hljs-keyword">if</span> (oldChildren[<span class="hljs-number">0</span>].<span class="hljs-property">children</span>[<span class="hljs-number">0</span>] !== newChildren[<span class="hljs-number">0</span>].<span class="hljs-property">children</span>[<span class="hljs-number">0</span>]) {
      <span class="hljs-comment">// 'Count: 0' !== 'Count: 1' → 记录更新</span>
      patches.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'TEXT'</span>,
        <span class="hljs-attr">node</span>: h1Node,
        <span class="hljs-attr">text</span>: <span class="hljs-string">'Count: 1'</span>
      });
    }
  }

  <span class="hljs-comment">// 子节点 1：button （没有变化，跳过）</span>
}
</code></pre>
<p><strong>Diff 结果（补丁包）：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">patches = [
  {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'UPDATE_TEXT'</span>,
    <span class="hljs-attr">domNode</span>: &lt;h1&gt;节点,
    <span class="hljs-attr">newText</span>: <span class="hljs-string">'Count: 1'</span>
  }
]
</code></pre>
<h3 data-id="heading-16">步骤 4：应用补丁到真实 DOM</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 只执行必要的 DOM 操作</span>
patches.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">patch</span> =&gt;</span> {
  <span class="hljs-keyword">if</span> (patch.<span class="hljs-property">type</span> === <span class="hljs-string">'UPDATE_TEXT'</span>) {
    patch.<span class="hljs-property">domNode</span>.<span class="hljs-property">textContent</span> = patch.<span class="hljs-property">newText</span>;  <span class="hljs-comment">// 只更新文本</span>
  }
});
</code></pre>
<p><strong>关键观察：</strong></p>
<ul>
<li>虚拟 DOM 计算：创建了整个新树（但很快，只是 JS 对象）</li>
<li>真实 DOM 操作：只更新了 1 个文本节点（最小化操作）</li>
</ul>
<hr/>
<h2 data-id="heading-17">批处理（Batching）：进一步优化</h2>
<h3 data-id="heading-18">问题：多次状态更新导致多次渲染</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);   <span class="hljs-comment">// 触发重渲染？</span>
  <span class="hljs-title function_">setName</span>(<span class="hljs-string">'Alice'</span>);      <span class="hljs-comment">// 又触发重渲染？</span>
  <span class="hljs-title function_">setAge</span>(<span class="hljs-number">25</span>);            <span class="hljs-comment">// 再触发重渲染？</span>
}
</code></pre>
<h3 data-id="heading-19">React 的解决方案：批量合并</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 内部机制（简化）</span>
<span class="hljs-keyword">let</span> isBatchingUpdates = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">let</span> updateQueue = [];

<span class="hljs-keyword">function</span> <span class="hljs-title function_">setState</span>(<span class="hljs-params">newState</span>) {
  updateQueue.<span class="hljs-title function_">push</span>(newState);

  <span class="hljs-keyword">if</span> (!isBatchingUpdates) {
    <span class="hljs-comment">// 开启批处理</span>
    isBatchingUpdates = <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// 等待所有同步代码执行完</span>
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 一次性处理所有更新</span>
      <span class="hljs-keyword">const</span> finalState = <span class="hljs-title function_">mergeUpdates</span>(updateQueue);
      <span class="hljs-title function_">render</span>(finalState);  <span class="hljs-comment">// 只渲染一次！</span>

      updateQueue = [];
      isBatchingUpdates = <span class="hljs-literal">false</span>;
    });
  }
}
</code></pre>
<p><strong>效果：</strong></p>
<pre><code class="hljs">没有批处理：3 次状态更新 → 3 次 Diff → 3 次 DOM 更新
有批处理：  3 次状态更新 → 1 次 Diff → 1 次 DOM 更新
</code></pre>
<p><strong>架构启示：</strong></p>
<blockquote>
<p>通过<strong>延迟和合并</strong>减少昂贵操作的频率</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">架构设计的核心思想总结</h2>
<h3 data-id="heading-21">1. 中间层抽象（Indirection）</h3>
<pre><code class="hljs">问题：性能 vs 开发体验的矛盾
解决：引入虚拟 DOM 作为中间层
收益：两头都兼顾
</code></pre>
<p><strong>其他领域的类似设计：</strong></p>
<ul>
<li>编译器：高级语言 → 中间表示(IR) → 机器码</li>
<li>数据库：SQL → 查询计划 → 物理操作</li>
<li>网络：应用层 → TCP/IP 抽象 → 物理层</li>
</ul>
<p><strong>核心理念：</strong></p>
<blockquote>
<p>"All problems in computer science can be solved by another level of indirection."
计算机科学的所有问题都可以通过增加一层抽象来解决。</p>
</blockquote>
<hr/>
<h3 data-id="heading-22">2. 合理的假设（Heuristic Assumptions）</h3>
<pre><code class="hljs language-scss" lang="scss">假设 <span class="hljs-number">1</span>：同层比较    → 覆盖 <span class="hljs-number">95%</span> 场景，复杂度从 <span class="hljs-built_in">O</span>(n³) 降到 <span class="hljs-built_in">O</span>(n)
假设 <span class="hljs-number">2</span>：类型即内容  → 简化判断逻辑，优化常见路径
假设 <span class="hljs-number">3</span>：Key 标识    → 提供"逃生舱"，处理特殊场景
</code></pre>
<p><strong>架构权衡：</strong></p>
<ul>
<li>✅ 常见场景极快（99% 的使用）</li>
<li>⚠️ 罕见场景可能次优（1% 的使用，但可接受）</li>
</ul>
<p><strong>学习要点：</strong></p>
<blockquote>
<p>不要追求完美的通用解决方案，针对实际使用场景优化。</p>
</blockquote>
<hr/>
<h3 data-id="heading-23">3. 性能优化的层次</h3>
<pre><code class="hljs language-scss" lang="scss">第 <span class="hljs-number">1</span> 层：算法优化
  └─ <span class="hljs-built_in">O</span>(n³) → <span class="hljs-built_in">O</span>(n) 通过启发式假设

第 <span class="hljs-number">2</span> 层：减少操作次数
  └─ 批处理：n 次更新 → <span class="hljs-number">1</span> 次渲染

第 <span class="hljs-number">3</span> 层：操作成本转移
  └─ 昂贵的 DOM 操作 → 便宜的 JS 计算
</code></pre>
<p><strong>通用原则：</strong></p>
<ol>
<li>用便宜的操作替代昂贵的操作</li>
<li>减少操作的次数</li>
<li>延迟和合并操作</li>
</ol>
<hr/>
<h2 data-id="heading-24">实战理解：调试 Diff 过程</h2>
<h3 data-id="heading-25">用代码观察 Diff</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">DiffDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [items, setItems] = <span class="hljs-title function_">useState</span>([<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {items.map(item =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item}</span>&gt;</span>{item}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setItems(['C', 'A', 'B'])}&gt;重排<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 打开 React DevTools → Components → 设置 → Highlight updates</span>
<span class="hljs-comment">// 点击按钮后，观察哪些 DOM 节点闪烁（被更新）</span>
</code></pre>
<p><strong>有 Key 的情况：</strong></p>
<ul>
<li>✅ 只有节点位置变化（DOM 移动）</li>
<li>✅ 不会重建内部内容</li>
</ul>
<p><strong>没有 Key 的情况：</strong></p>
<ul>
<li>❌ 所有节点内容都更新（文本替换）</li>
<li>❌ 可能丢失状态（如输入框的内容）</li>
</ul>
<hr/>
<h2 data-id="heading-26">从虚拟 DOM 学到的架构智慧</h2>
<h3 data-id="heading-27">1. 权衡之道（Trade-offs）</h3>
<p><strong>没有完美的方案，只有合适的选择：</strong></p>
<pre><code class="hljs">虚拟 DOM：增加了内存开销，换取了开发体验
启发式假设：放弃了罕见场景的最优，换取了常见场景的极速
批处理：增加了一点延迟，换取了整体性能
</code></pre>
<p><strong>架构师的工作：</strong></p>
<ul>
<li>不是找"最好"的方案</li>
<li>而是找"最合适"的平衡点</li>
</ul>
<hr/>
<h3 data-id="heading-28">2. 约束驱动设计（Constraint-driven）</h3>
<p><strong>React 面临的约束：</strong></p>
<ol>
<li>DOM 操作很慢（物理约束）</li>
<li>用户要声明式 API（需求约束）</li>
<li>需要实时响应（性能约束）</li>
</ol>
<p><strong>设计决策链：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">约束 → 虚拟 DOM（中间层）
<span class="hljs-code">      → 启发式 Diff（算法简化）
      → 批处理（操作合并）
      → Key 机制（辅助识别）
</span></code></pre>
<p><strong>学习要点：</strong></p>
<blockquote>
<p>优秀的架构源于对约束的深刻理解，而非天马行空的想象。</p>
</blockquote>
<hr/>
<h3 data-id="heading-29">3. 分层思想（Layered Architecture）</h3>
<pre><code class="hljs">┌──────────────────┐
│   用户代码层      │ ← 声明式、简单
├──────────────────┤
│   虚拟 DOM 层     │ ← 抽象、灵活
├──────────────────┤
│   Diff 算法层     │ ← 优化、智能
├──────────────────┤
│   DOM 操作层      │ ← 精确、高效
└──────────────────┘
</code></pre>
<p><strong>每层的职责：</strong></p>
<ul>
<li>上层：提供易用的接口</li>
<li>中层：隔离复杂度</li>
<li>下层：执行高效操作</li>
</ul>
<p><strong>学习要点：</strong></p>
<blockquote>
<p>好的架构让每一层都可以独立优化，而不影响其他层。</p>
</blockquote>
<hr/>
<h2 data-id="heading-30">对比：虚拟 DOM vs 其他方案</h2>
<h3 data-id="heading-31">方案 1：直接 DOM 操作（jQuery 时代）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 手动追踪每个变化</span>
$(<span class="hljs-string">'#username'</span>).<span class="hljs-title function_">text</span>(newName);
$(<span class="hljs-string">'#age'</span>).<span class="hljs-title function_">text</span>(newAge);
</code></pre>
<ul>
<li>✅ 性能最优（最小化操作）</li>
<li>❌ 开发体验差（手动管理）</li>
<li>❌ 容易出错（遗漏更新）</li>
</ul>
<h3 data-id="heading-32">方案 2：模板引擎（Angular 1.x）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 脏检查：遍历所有绑定</span>
$scope.$watch(<span class="hljs-string">'username'</span>, callback);
$scope.$digest(); <span class="hljs-comment">// 检查所有 watcher</span>
</code></pre>
<ul>
<li>✅ 开发体验好（双向绑定）</li>
<li>❌ 性能随绑定数量下降（O(n) 检查）</li>
<li>❌ 难以优化</li>
</ul>
<h3 data-id="heading-33">方案 3：虚拟 DOM（React）</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 声明式描述 UI</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{username}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<ul>
<li>✅ 开发体验好（声明式）</li>
<li>✅ 性能可控（O(n) Diff + 批处理）</li>
<li>✅ 可优化空间大（shouldComponentUpdate、memo）</li>
</ul>
<h3 data-id="heading-34">方案 4：编译优化（Svelte）</h3>
<pre><code class="hljs language-svelte" lang="svelte">&lt;!-- 编译时生成精确更新代码 --&gt;
&lt;script&gt;
  let count = 0;
&lt;/script&gt;
&lt;div&gt;{count}&lt;/div&gt;

&lt;!-- 编译成类似： --&gt;
&lt;script&gt;
  function update_count(value) {
    count = value;
    div.textContent = count; // 直接更新
  }
&lt;/script&gt;
</code></pre>
<ul>
<li>✅ 运行时性能最优（无虚拟 DOM 开销）</li>
<li>✅ 打包体积小</li>
<li>⚠️ 需要编译步骤</li>
<li>⚠️ 动态性较弱</li>
</ul>
<p><strong>总结：</strong></p>
<blockquote>
<p>没有银弹，每种方案都在不同维度上做权衡。虚拟 DOM 在"易用性 + 性能 + 灵活性"上找到了较好的平衡点。</p>
</blockquote>
<hr/>
<h2 data-id="heading-35">实践建议：如何用好虚拟 DOM</h2>
<h3 data-id="heading-36">1. 正确使用 Key</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ✅ 好：稳定唯一的 ID</span>
{users.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">User</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{user.id}</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{user}</span> /&gt;</span></span>)}

<span class="hljs-comment">// ❌ 坏：数组索引</span>
{users.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">user, index</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">User</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{user}</span> /&gt;</span></span>)}

<span class="hljs-comment">// ❌ 坏：随机值</span>
{users.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">User</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{Math.random()}</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{user}</span> /&gt;</span></span>)}
</code></pre>
<h3 data-id="heading-37">2. 避免不必要的重渲染</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ❌ 问题：每次都创建新对象</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> '<span class="hljs-attr">red</span>' }} /&gt;</span></span>; <span class="hljs-comment">// 新对象！</span>
}

<span class="hljs-comment">// ✅ 解决：提取到外部</span>
<span class="hljs-keyword">const</span> fixedStyle = { <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span> };
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{fixedStyle}</span> /&gt;</span></span>;
}

<span class="hljs-comment">// ✅ 或使用 useMemo</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Parent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> style = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">color</span>: <span class="hljs-string">'red'</span> }), []);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span> /&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-38">3. 利用 React DevTools 观察</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 React DevTools</span>
<span class="hljs-comment"># 打开 Profiler 标签</span>
<span class="hljs-comment"># 录制操作，查看哪些组件重渲染了</span>
<span class="hljs-comment"># 优化不必要的渲染</span>
</code></pre>
<hr/>
<h2 data-id="heading-39">总结：架构设计的本质</h2>
<p>虚拟 DOM 和 Diff 算法教会我们：</p>
<ol>
<li>
<p><strong>好的架构源于对问题本质的理解</strong></p>
<ul>
<li>理解约束：DOM 操作慢</li>
<li>理解需求：声明式 API</li>
<li>理解场景：UI 更新模式</li>
</ul>
</li>
<li>
<p><strong>不要追求完美，要追求合适</strong></p>
<ul>
<li>O(n³) → O(n)：通过假设简化</li>
<li>100% 覆盖 → 99% 优化：聚焦常见场景</li>
<li>绝对精确 → 高效近似：启发式策略</li>
</ul>
</li>
<li>
<p><strong>用抽象隔离复杂度</strong></p>
<ul>
<li>用户写简单代码</li>
<li>框架处理复杂逻辑</li>
<li>中间层完成转换</li>
</ul>
</li>
<li>
<p><strong>分层、延迟、批量是优化的三板斧</strong></p>
<ul>
<li>分层：虚拟 DOM 隔离真实 DOM</li>
<li>延迟：不立即操作，先计算</li>
<li>批量：多次更新合并成一次</li>
</ul>
</li>
</ol>
<p><strong>最终启示：</strong></p>
<blockquote>
<p>架构设计不是堆砌技术，而是在约束条件下，通过合理的抽象和权衡，找到问题的优雅解决方案。</p>
</blockquote>
<p>从今天开始，当你遇到架构问题时，问自己：</p>
<ol>
<li>核心约束是什么？</li>
<li>能否引入中间层抽象？</li>
<li>能否通过合理假设简化问题？</li>
<li>如何在性能和易用性之间找到平衡点？</li>
</ol>
<p>这就是虚拟 DOM 给我们的架构智慧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端大厦建立在并不牢固的地基，浅谈JavaScript未来]]></title>    <link>https://juejin.cn/post/7576479344039166004</link>    <guid>https://juejin.cn/post/7576479344039166004</guid>    <pubDate>2025-11-25T13:25:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576479344039166004" data-draft-id="7576338796847300648" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端大厦建立在并不牢固的地基，浅谈JavaScript未来"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-25T13:25:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想吃电饭锅"/> <meta itemprop="url" content="https://juejin.cn/user/1913569040664749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端大厦建立在并不牢固的地基，浅谈JavaScript未来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1913569040664749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想吃电饭锅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T13:25:51.000Z" title="Tue Nov 25 2025 13:25:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前端大厦建立在并不牢固的地基上：JavaScript 的未来到底往哪走？</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/459df7b349364e15a3b4ce3fb7069e26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz5ZCD55S16aWt6ZSF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764681951&amp;x-signature=CCdNwAWac1sJ75nZAxEmQOMBmOE%3D" alt="d388eb40-a711-43db-879e-f2eab94b6eba.png" loading="lazy"/></p>
<blockquote>
<p>一个小小的 <code>__dirname is not defined</code>，让我重新思考了前端的未来。</p>
</blockquote>
<p>上周我新建了个 Vite 项目，顺手写下那段陪伴我十年的配置代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: { <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>) }
  }
};
</code></pre>
<p>结果 TypeScript 给了我当头一棒：<br/>
<strong><code>__dirname is not defined</code>。</strong></p>
<p>这段从 Node.js 时代一路走来的“老伙计”，为什么突然就不行了？</p>
<hr/>
<h3 data-id="heading-1">不是 API 不见了，是我们换了运行时代</h3>
<p><code>path</code> 没问题，Node.js 也没问题。<br/>
真正的问题叫：<strong>你已经进入 ESM 时代了。</strong></p>
<p>在 ES Modules 里，确实没有 <code>__dirname</code> 这个东西。<br/>
要写的话，只能这样绕一圈：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>;
<span class="hljs-keyword">import</span> { dirname } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>;

<span class="hljs-keyword">const</span> __filename = <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>);
<span class="hljs-keyword">const</span> __dirname = <span class="hljs-title function_">dirname</span>(__filename);
</code></pre>
<p>或者换个更现代的写法：</p>
<pre><code class="hljs language-arduino" lang="arduino">alias: {
  <span class="hljs-string">'@'</span>: <span class="hljs-built_in">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">URL</span>(<span class="hljs-string">'./src'</span>, <span class="hljs-keyword">import</span>.meta.url))
}
</code></pre>
<p>看着有点繁琐，但它背后的意义非常大：</p>
<p><strong>我们正在统一运行时，让配置文件能在 Node、Bun、Deno 甚至浏览器里跑起来。</strong></p>
<p>以前所有工具都默认你用 Node。<br/>
现在工具链在努力“脱 Node 而不反 Node”。</p>
<p>这是一次升级，而不是破坏。</p>
<hr/>
<h3 data-id="heading-2">工具链不是抛弃 Node.js，而是让我们不再依赖它的“私货”</h3>
<p>这几年，构建工具几乎在“集体逃离 JavaScript”：</p>
<ul>
<li>ESBuild 用 Go 写</li>
<li>Rspack 和 Turbopack 用 Rust 写</li>
<li>SWC 也用 Rust 写</li>
</ul>
<p>于是很多人开始问：<br/>
<strong>“那我还学 Node.js 干嘛？”</strong></p>
<p>其实答案很简单：<strong>要学，但重点不一样了。</strong></p>
<h4 data-id="heading-3">你不必再研究：</h4>
<ul>
<li>libuv 怎么调度事件</li>
<li>C++ 插件怎么写</li>
<li>事件循环有几层 phase</li>
</ul>
<h4 data-id="heading-4">但你仍然需要懂：</h4>
<ul>
<li>ESM 下路径、文件系统的正确写法</li>
<li>构建工具配置怎么写</li>
<li>插件怎么开发</li>
</ul>
<p>原因很现实：<br/>
工具链底层可以用 Rust 或 Go 写，但你写的配置、插件、脚本还是要走 JavaScript。</p>
<blockquote>
<p>“工具在加速，你在抽象。”<br/>
我们写的不是底层引擎，而是告诉编译器我们想要什么。</p>
</blockquote>
<p>这就是未来。</p>
<hr/>
<h3 data-id="heading-5">Node 模块不会消失，但会变成“兼容层”</h3>
<p>我相信未来工具链会出现类似这样的 API：</p>
<pre><code class="hljs language-csharp" lang="csharp">import { resolveAlias } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite/utils'</span>;
<span class="hljs-keyword">alias</span>: { <span class="hljs-string">'@'</span>: resolveAlias(<span class="hljs-string">'./src'</span>) }
</code></pre>
<p>不用再管：</p>
<ul>
<li>是 Node 在运行</li>
<li>还是 Bun</li>
<li>还是 Deno</li>
<li>甚至未来是不是浏览器直接跑构建工具</li>
</ul>
<p>到那时，Node.js 的模块依然在，但它会慢慢变成“大家都懂的基本 API”，就像互联网的通用协议一样。</p>
<p>你要学 Node？<br/>
要，但不需要钻那么深。</p>
<p>你需要的是写出<strong>更通用、更标准、更不绑定运行时</strong>的代码。</p>
<hr/>
<h3 data-id="heading-6">Rust 重写的是工具，不是 JavaScript 本身</h3>
<p>这句真的很重要。<br/>
工具链被 Rust 重写，是因为 JavaScript 不适合做“工程级大工具”。<br/>
但这不代表 JS 要退出舞台。</p>
<p>Rust 替代的是：</p>
<ul>
<li>Babel → SWC</li>
<li>Webpack → Rspack / Turbopack</li>
<li>部分 CLI 工具 → Rust 版本的高速实现</li>
</ul>
<p>但真正跑你业务代码的仍然是：</p>
<ul>
<li>浏览器里的 V8 / JavaScriptCore</li>
<li>Node.js / Deno / Bun</li>
</ul>
<p><strong>Rust 是发动机，JavaScript 是燃料。两者不是竞争关系。</strong></p>
<hr/>
<h3 data-id="heading-7">V8 会被抛弃吗？JavaScript 凭什么还活得这么滋润？</h3>
<p>JavaScript 的确有很多槽点：</p>
<ul>
<li><code>0.1 + 0.2 !== 0.3</code></li>
<li><code>typeof null === 'object'</code></li>
<li>隐式转换能把人心态搞崩</li>
</ul>
<p>但它有一项别人打不败的技能：</p>
<p><strong>所有浏览器都支持 JavaScript。</strong></p>
<p>这就是“现实世界的压制力”。</p>
<p>而 V8 更不是简单的 JS 引擎，它还是：</p>
<ul>
<li>DOM / Web API 的实现者</li>
<li>WebAssembly 的宿主</li>
<li>Node.js 和 Deno 的基石</li>
<li>前后端通用运行时的底层</li>
</ul>
<p>所以说：<br/>
<strong>你可以骂 JavaScript，但你没法绕过它。</strong></p>
<p>生态的力量不是某种语言可以轻易撼动的。</p>
<hr/>
<h3 data-id="heading-8">JavaScript 的未来：正在悄悄变成“前端的汇编语言”</h3>
<p>你可能已经感觉到了：</p>
<ul>
<li>你写的业务逻辑越来越依赖 <strong>TypeScript</strong></li>
<li>UI 越来越声明式（Vue / Svelte / React）</li>
<li>重性能逻辑靠 <strong>Rust + WASM</strong></li>
<li>构建工具自动把一切编译成 JS + WASM</li>
</ul>
<p>你写的纯 JavaScript 可能越来越少。</p>
<p>但是 JS 不会消失，它会像“浏览器的汇编语言”一样静静待在那里，作为：</p>
<ul>
<li>运行时的中间层</li>
<li>WASM 的宿主</li>
<li>TypeScript 的目标产物</li>
<li>工具链真正输出的落地代码</li>
</ul>
<p>它不是主角了，但它变得更稳定、更基础、更不可替代。</p>
<hr/>
<h3 data-id="heading-9">结语：在流沙之上建高楼，是前端工程师的浪漫</h3>
<p>前端的世界地基确实不稳：</p>
<ul>
<li>JavaScript 的历史包袱</li>
<li>Node.js 的割裂</li>
<li>浏览器的碎片化</li>
<li>工具链一次次的重写</li>
</ul>
<p>我们用 TypeScript 修补类型。<br/>
用 Rust 提升性能。<br/>
用 ESM 拉齐规范。<br/>
用工具链把复杂性藏到地板下面。</p>
<p>最终，我们居然真正在这片流沙上，建起了一座足够坚固的数字城市。</p>
<p><strong>地基我们没法选，但建筑方式我们能决定。</strong></p>
<h2 data-id="heading-10"><strong>最后的最后</strong></h2>
<p>如果真的有 JavaScript 和 V8 被彻底替代的一天，那么被推翻的将远不止前端程序员的工具链，而是整个现代 Web 生态：数十亿网站、数千万开发者、上万亿美元的数字基础设施，都将随之重构。</p>
<p>但到那时，我们可能早就——<br/>
<strong>不再称它为“Web”了</strong>。</p>
<p>或许我们已全面进入空间计算、神经交互或去中心化协议的新范式；或许“浏览器”已成为历史名词；又或许，人类与机器的交互方式早已超越“页面”与“脚本”的范畴。</p>
<p>在那个未来里，JavaScript 的退场不会是一场革命，而是一次静默的谢幕——如同马车消失于汽车时代，不是被禁止，而是被超越。</p>
<p>但在今天，在可预见的未来十年甚至二十年，<strong>JavaScript 仍是我们唯一可行的通用语言，V8 仍是这座数字世界最可靠的引擎</strong>。</p>
<p>所以，不必等待完美地基。<br/>
<strong>在流沙之上，继续建造。</strong></p>
<blockquote>
<p>你怎么看 JavaScript 的未来？欢迎在评论区聊聊你的想法。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI 日记】调用大模型的时候如何按照 sse 格式输出]]></title>    <link>https://juejin.cn/post/7576476897950384155</link>    <guid>https://juejin.cn/post/7576476897950384155</guid>    <pubDate>2025-11-25T13:53:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576476897950384155" data-draft-id="7576468602305888294" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI 日记】调用大模型的时候如何按照 sse 格式输出"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-25T13:53:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南蓝"/> <meta itemprop="url" content="https://juejin.cn/user/1187128287974238"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI 日记】调用大模型的时候如何按照 sse 格式输出
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1187128287974238/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南蓝
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T13:53:04.000Z" title="Tue Nov 25 2025 13:53:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">一、基础方式：同步全量输出（Non-Stream）</h3>
<p>这是最开始提到的「一次性输出」，也是大模型 API 的<strong>默认方式</strong>—— 发送 Prompt 后，等待模型生成完整结果，再一次性返回全量响应。</p>
<h4 data-id="heading-1">1. 核心逻辑</h4>
<ul>
<li>客户端发送请求 → 服务器接收后，让模型完整生成所有内容 → 生成完毕后，一次性返回全量数据（无增量推送）。</li>
<li>本质是「请求 - 响应」模式（类似普通 HTTP 接口），无需处理流式拼接，逻辑最简单。</li>
</ul>
<h4 data-id="heading-2">2. 核心价值</h4>
<ul>
<li>开发成本极低：无需处理流数据、增量拼接，直接解析完整响应即可；</li>
<li>适合短文本场景：生成内容长度短（如 Commit 信息、单句代码优化、简短问答），等待时间可接受（通常 1-3 秒）；</li>
<li>数据完整性高：直接拿到完整结果，无需担心流中断导致的内容缺失。</li>
</ul>
<h4 data-id="heading-3">3.具体信息</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">"express"</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">OpenAI</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"openai"</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = <span class="hljs-number">3000</span>;

<span class="hljs-comment">// 解析JSON请求体（必须在路由之前）</span>
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());

<span class="hljs-comment">// 添加请求日志中间件（用于调试）</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span> <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.path}</span>`</span>);
  <span class="hljs-title function_">next</span>();
});

<span class="hljs-comment">// 初始化 OpenAI 客户端</span>
<span class="hljs-comment">// 优先从环境变量读取 API Key，如果没有则使用硬编码的 Key</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_KEY</span> =
  process.<span class="hljs-property">env</span>.<span class="hljs-property">MOONSHOT_API_KEY</span> ||
  <span class="hljs-string">"sk-V3bOPqDn6gfsQUiQzxL6n7SgbJI1O0YlV6QFoLv2xplXUyuI"</span>;

<span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">API_KEY</span> || <span class="hljs-variable constant_">API_KEY</span> === <span class="hljs-string">""</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(
    <span class="hljs-string">"警告: 未设置 API Key，请设置环境变量 MOONSHOT_API_KEY 或在代码中配置"</span>
  );
}

<span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>({
  <span class="hljs-attr">apiKey</span>: <span class="hljs-variable constant_">API_KEY</span>,
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">"https://api.moonshot.cn/v1"</span>,
});

<span class="hljs-comment">// 非流式端点：调用大模型并一次性返回完整结果</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">"/api/chat/non-stream"</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"收到非流式请求:"</span>, req.<span class="hljs-property">body</span>);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> { message, systemPrompt } = req.<span class="hljs-property">body</span>;

    <span class="hljs-keyword">if</span> (!message) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"错误: 消息内容为空"</span>);
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">"消息内容不能为空"</span> });
    }

    <span class="hljs-comment">// 构建消息数组</span>
    <span class="hljs-keyword">const</span> messages = [];
    <span class="hljs-keyword">if</span> (systemPrompt) {
      messages.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"system"</span>,
        <span class="hljs-attr">content</span>: systemPrompt,
      });
    } <span class="hljs-keyword">else</span> {
      messages.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"system"</span>,
        <span class="hljs-attr">content</span>:
          <span class="hljs-string">"你是 Kimi，由 Moonshot AI 提供的人工智能助手，你更擅长中文和英文的对话。你会为用户提供安全，有帮助，准确的回答。同时，你会拒绝一切涉及恐怖主义，种族歧视，黄色暴力等问题的回答。Moonshot AI 为专有名词，不可翻译成其他语言。"</span>,
      });
    }
    messages.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
      <span class="hljs-attr">content</span>: message,
    });

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"调用大模型API（非流式），模型: kimi-k2-turbo-preview"</span>);

    <span class="hljs-comment">// 调用大模型非流式API</span>
    <span class="hljs-keyword">const</span> completion = <span class="hljs-keyword">await</span> client.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-string">"kimi-k2-turbo-preview"</span>,
      <span class="hljs-attr">messages</span>: messages,
      <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.6</span>,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 非流式</span>
    });

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"API调用成功，返回完整结果"</span>);

    <span class="hljs-comment">// 返回完整结果</span>
    res.<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">content</span>: completion.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>].<span class="hljs-property">message</span>.<span class="hljs-property">content</span>,
      <span class="hljs-attr">usage</span>: completion.<span class="hljs-property">usage</span>,
    });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"非流式API错误:"</span>, error);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"错误详情:"</span>, {
      <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span>,
      <span class="hljs-attr">status</span>: error.<span class="hljs-property">status</span>,
      <span class="hljs-attr">code</span>: error.<span class="hljs-property">code</span>,
      <span class="hljs-attr">type</span>: error.<span class="hljs-property">type</span>,
    });

    res.<span class="hljs-title function_">status</span>(error.<span class="hljs-property">status</span> || <span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> || <span class="hljs-string">"未知错误"</span>,
      <span class="hljs-attr">status</span>: error.<span class="hljs-property">status</span>,
    });
  }
});


<span class="hljs-comment">// 根路由（必须在静态文件服务之前）</span>
app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/"</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">"public"</span>, <span class="hljs-string">"index.html"</span>));
});

<span class="hljs-comment">// 静态文件服务（放在最后，避免拦截API路由）</span>
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">"public"</span>)));

<span class="hljs-comment">// 404处理（必须在所有路由之后）</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`404错误: <span class="hljs-subst">${req.method}</span> <span class="hljs-subst">${req.path}</span> 未找到`</span>);
  <span class="hljs-comment">// 如果是API请求，返回JSON</span>
  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">path</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"/api/"</span>)) {
    res
      .<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>)
      .<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">"API路由未找到"</span>, <span class="hljs-attr">path</span>: req.<span class="hljs-property">path</span>, <span class="hljs-attr">method</span>: req.<span class="hljs-property">method</span> });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 其他请求返回HTML</span>
    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">"页面未找到"</span>);
  }
});

<span class="hljs-comment">// 启动服务器</span>
app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`服务器运行在 http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`访问 http://localhost:<span class="hljs-subst">${PORT}</span> 查看应用`</span>);
});

</code></pre>
<p>比较简单，直接返回响应结果</p>
<h3 data-id="heading-4">二、SSE（Server-Sent Events）：流式输出（解决 “等待全量结果” 问题）</h3>
<h4 data-id="heading-5">1. 场景核心</h4>
<ul>
<li>基础用法：发送 Prompt 后，等待模型生成<strong>完整结果</strong>再一次性返回（比如生成 1000 字文案要等 5 秒）；</li>
<li>SSE 用法：模型生成<strong>每一个 token（词 / 字）</strong> 就实时推送给客户端，像 ChatGPT 网页版那样 “打字机式输出”，无需等待全量结果。</li>
</ul>
<h4 data-id="heading-6">2. 核心价值</h4>
<ul>
<li>提升交互体验：用户能实时看到输出进度，减少 “等待焦虑”；</li>
<li>支持长文本：生成几千字的文档 / 代码时，不会因超时导致请求失败；</li>
<li>节省带宽：无需缓存全量结果，逐段接收即可。</li>
</ul>
<h4 data-id="heading-7">3. 举例</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// SSE端点：调用大模型并流式输出</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">"/api/chat/stream"</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> { message, systemPrompt } = req.<span class="hljs-property">body</span>;

    <span class="hljs-keyword">if</span> (!message) {
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">"消息内容不能为空"</span> });
    }

    <span class="hljs-comment">// 设置SSE响应头</span>
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/event-stream"</span>);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"no-cache"</span>);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"keep-alive"</span>);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"Content-Type"</span>);

    <span class="hljs-comment">// 构建消息数组</span>
    <span class="hljs-keyword">const</span> messages = [];
    <span class="hljs-keyword">if</span> (systemPrompt) {
      messages.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"system"</span>,
        <span class="hljs-attr">content</span>: systemPrompt,
      });
    } <span class="hljs-keyword">else</span> {
      messages.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"system"</span>,
        <span class="hljs-attr">content</span>:
          <span class="hljs-string">"你是 Kimi，由 Moonshot AI 提供的人工智能助手，你更擅长中文和英文的对话。你会为用户提供安全，有帮助，准确的回答。同时，你会拒绝一切涉及恐怖主义，种族歧视，黄色暴力等问题的回答。Moonshot AI 为专有名词，不可翻译成其他语言。"</span>,
      });
    }
    messages.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
      <span class="hljs-attr">content</span>: message,
    });

    <span class="hljs-comment">// 发送开始消息</span>
    res.<span class="hljs-title function_">write</span>(
      <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({
        <span class="hljs-keyword">type</span>: <span class="hljs-string">"start"</span>,
        message: <span class="hljs-string">"开始生成回答..."</span>,
      })}</span>\n\n`</span>
    );

    <span class="hljs-comment">// 调用大模型流式API</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"调用大模型API，模型: kimi-k2-turbo-preview"</span>);
    <span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> client.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-string">"kimi-k2-turbo-preview"</span>,
      <span class="hljs-attr">messages</span>: messages,
      <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.6</span>,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>,
    });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"API调用成功，开始流式返回"</span>);

    <span class="hljs-comment">// 流式处理响应</span>
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
      <span class="hljs-keyword">const</span> delta = chunk.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span>;

      <span class="hljs-keyword">if</span> (delta?.<span class="hljs-property">content</span>) {
        <span class="hljs-comment">// 将每个内容块通过SSE发送给前端</span>
        res.<span class="hljs-title function_">write</span>(
          <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({
            <span class="hljs-keyword">type</span>: <span class="hljs-string">"content"</span>,
            content: delta.content,
          })}</span>\n\n`</span>
        );
      }
    }

    <span class="hljs-comment">// 发送结束消息</span>
    res.<span class="hljs-title function_">write</span>(
      <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ <span class="hljs-keyword">type</span>: <span class="hljs-string">"done"</span>, message: <span class="hljs-string">"回答生成完成"</span> })}</span>\n\n`</span>
    );

    <span class="hljs-comment">// 关闭连接</span>
    res.<span class="hljs-title function_">end</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"SSE错误:"</span>, error);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"错误详情:"</span>, {
      <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span>,
      <span class="hljs-attr">status</span>: error.<span class="hljs-property">status</span>,
      <span class="hljs-attr">code</span>: error.<span class="hljs-property">code</span>,
      <span class="hljs-attr">type</span>: error.<span class="hljs-property">type</span>,
    });

    <span class="hljs-comment">// 处理401错误（认证失败）</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
      res.<span class="hljs-title function_">write</span>(
        <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({
          <span class="hljs-keyword">type</span>: <span class="hljs-string">"error"</span>,
          message: <span class="hljs-string">"API Key 认证失败，请检查您的 API Key 是否正确或是否已过期"</span>,
          details: <span class="hljs-string">"401 Unauthorized"</span>,
        })}</span>\n\n`</span>
      );
    } <span class="hljs-keyword">else</span> {
      res.<span class="hljs-title function_">write</span>(
        <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({
          <span class="hljs-keyword">type</span>: <span class="hljs-string">"error"</span>,
          message: error.message || <span class="hljs-string">"未知错误"</span>,
          status: error.status,
        })}</span>\n\n`</span>
      );
    }
    res.<span class="hljs-title function_">end</span>();
  }
});

</code></pre>
<p><strong>关键代码</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 设置响应请求头</span>
res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/event-stream"</span>);

<span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>({
  <span class="hljs-attr">apiKey</span>: <span class="hljs-variable constant_">API_KEY</span>,
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">"https://api.moonshot.cn/v1"</span>,
});

<span class="hljs-comment">// 调用大模型流式 PI，stream: true,</span>
<span class="hljs-keyword">const</span> stream = <span class="hljs-keyword">await</span> client.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-string">"kimi-k2-turbo-preview"</span>,
      <span class="hljs-attr">messages</span>: messages,
      <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.6</span>,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>,
    });
    
<span class="hljs-comment">// 流式处理响应</span>
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> chunk <span class="hljs-keyword">of</span> stream) {
      <span class="hljs-keyword">const</span> delta = chunk.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span>;

      <span class="hljs-keyword">if</span> (delta?.<span class="hljs-property">content</span>) {
        <span class="hljs-comment">// 将每个内容块通过SSE发送给前端</span>
        res.<span class="hljs-title function_">write</span>(
          <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({
            <span class="hljs-keyword">type</span>: <span class="hljs-string">"content"</span>,
            content: delta.content,
          })}</span>\n\n`</span>
        );
      }
    }

 <span class="hljs-comment">// 发送结束消息</span>
   res.<span class="hljs-title function_">write</span>(
      <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ <span class="hljs-keyword">type</span>: <span class="hljs-string">"done"</span>, message: <span class="hljs-string">"回答生成完成"</span> })}</span>\n\n`</span>
   );

</code></pre>
<p>如果希望返回多个供用户选择,  入参的时候可以加上 <code>n</code>这个参数</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">let</span> data = { 
 <span class="hljs-string">"model"</span>: <span class="hljs-string">"kimi-k2-turbo-preview"</span>, 
 <span class="hljs-string">"messages"</span>: [ <span class="hljs-comment">// 具体的 messages ], </span>
 <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.6</span>, 
 <span class="hljs-string">"stream"</span>: <span class="hljs-literal">true</span>,
 <span class="hljs-string">"n"</span>: <span class="hljs-number">2</span> <span class="hljs-comment">// &lt;-- 注意这里，我们要求 Kimi 大模型输出 2 个回复</span>
};
</code></pre>
<p>也可以直接使用 HTTP 请求, 不适用 Openai SDK</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// SSE端点：使用原生 HTTP 请求实现流式输出</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">"/api/chat/stream"</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> { message, systemPrompt } = req.<span class="hljs-property">body</span>;

    <span class="hljs-keyword">if</span> (!message) {
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">error</span>: <span class="hljs-string">"消息内容不能为空"</span> });
    }

    <span class="hljs-comment">// 设置SSE响应头</span>
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/event-stream"</span>);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"no-cache"</span>);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"keep-alive"</span>);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"Access-Control-Allow-Headers"</span>, <span class="hljs-string">"Content-Type"</span>);

    <span class="hljs-comment">// 构建消息数组</span>
    <span class="hljs-keyword">const</span> messages = [];
    <span class="hljs-keyword">if</span> (systemPrompt) {
      messages.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"system"</span>,
        <span class="hljs-attr">content</span>: systemPrompt,
      });
    } <span class="hljs-keyword">else</span> {
      messages.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"system"</span>,
        <span class="hljs-attr">content</span>:
          <span class="hljs-string">"你是 Kimi，由 Moonshot AI 提供的人工智能助手，你更擅长中文和英文的对话。你会为用户提供安全，有帮助，准确的回答。同时，你会拒绝一切涉及恐怖主义，种族歧视，黄色暴力等问题的回答。Moonshot AI 为专有名词，不可翻译成其他语言。"</span>,
      });
    }
    messages.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
      <span class="hljs-attr">content</span>: message,
    });

    <span class="hljs-comment">// 发送开始消息</span>
    res.<span class="hljs-title function_">write</span>(
      <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({
        <span class="hljs-keyword">type</span>: <span class="hljs-string">"start"</span>,
        message: <span class="hljs-string">"开始生成回答..."</span>,
      })}</span>\n\n`</span>
    );

    <span class="hljs-comment">// 使用原生 fetch 调用流式 API</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"调用大模型API，模型: kimi-k2-turbo-preview"</span>);
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"https://api.moonshot.cn/v1/chat/completions"</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">"POST"</span>,
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>,
        <span class="hljs-string">"Authorization"</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${API_KEY}</span>`</span>,
      },
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
        <span class="hljs-attr">model</span>: <span class="hljs-string">"kimi-k2-turbo-preview"</span>,
        <span class="hljs-attr">messages</span>: messages,
        <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.6</span>,
        <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>,
      }),
    });

    <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
      <span class="hljs-keyword">const</span> errorData = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> ({}));
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(errorData.<span class="hljs-property">error</span>?.<span class="hljs-property">message</span> || <span class="hljs-string">`HTTP错误! 状态码: <span class="hljs-subst">${response.status}</span>`</span>);
    }

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"API调用成功，开始流式返回"</span>);

    <span class="hljs-comment">// 读取流式响应</span>
    <span class="hljs-keyword">const</span> reader = response.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>();
    <span class="hljs-keyword">const</span> decoder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextDecoder</span>();
    <span class="hljs-keyword">let</span> buffer = <span class="hljs-string">""</span>;

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
      <span class="hljs-keyword">const</span> { done, value } = <span class="hljs-keyword">await</span> reader.<span class="hljs-title function_">read</span>();

      <span class="hljs-keyword">if</span> (done) {
        <span class="hljs-keyword">break</span>;
      }

      <span class="hljs-comment">// 解码数据块</span>
      buffer += decoder.<span class="hljs-title function_">decode</span>(value, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span> });
      
      <span class="hljs-comment">// 按行分割（SSE 格式：data: {...}\n\n）</span>
      <span class="hljs-keyword">const</span> lines = buffer.<span class="hljs-title function_">split</span>(<span class="hljs-string">"\n"</span>);
      buffer = lines.<span class="hljs-title function_">pop</span>() || <span class="hljs-string">""</span>;

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> line <span class="hljs-keyword">of</span> lines) {
        <span class="hljs-keyword">if</span> (line.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"data: "</span>)) {
          <span class="hljs-keyword">const</span> dataStr = line.<span class="hljs-title function_">slice</span>(<span class="hljs-number">6</span>);
          
          <span class="hljs-comment">// 跳过 [DONE] 标记</span>
          <span class="hljs-keyword">if</span> (dataStr.<span class="hljs-title function_">trim</span>() === <span class="hljs-string">"[DONE]"</span>) {
            <span class="hljs-keyword">continue</span>;
          }

          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> chunk = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(dataStr);
            <span class="hljs-keyword">const</span> delta = chunk.<span class="hljs-property">choices</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">delta</span>;

            <span class="hljs-keyword">if</span> (delta?.<span class="hljs-property">content</span>) {
              <span class="hljs-comment">// 将每个内容块通过SSE发送给前端</span>
              res.<span class="hljs-title function_">write</span>(
                <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({
                  <span class="hljs-keyword">type</span>: <span class="hljs-string">"content"</span>,
                  content: delta.content,
                })}</span>\n\n`</span>
              );
            }
          } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"解析流式数据错误:"</span>, e, <span class="hljs-string">"原始数据:"</span>, dataStr);
          }
        }
      }
    }

    <span class="hljs-comment">// 发送结束消息</span>
    res.<span class="hljs-title function_">write</span>(
      <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({ <span class="hljs-keyword">type</span>: <span class="hljs-string">"done"</span>, message: <span class="hljs-string">"回答生成完成"</span> })}</span>\n\n`</span>
    );

    <span class="hljs-comment">// 关闭连接</span>
    res.<span class="hljs-title function_">end</span>();
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"SSE错误:"</span>, error);
    
    <span class="hljs-comment">// 处理错误</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
      res.<span class="hljs-title function_">write</span>(
        <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({
          <span class="hljs-keyword">type</span>: <span class="hljs-string">"error"</span>,
          message: <span class="hljs-string">"API Key 认证失败，请检查您的 API Key 是否正确或是否已过期"</span>,
          details: <span class="hljs-string">"401 Unauthorized"</span>,
        })}</span>\n\n`</span>
      );
    } <span class="hljs-keyword">else</span> {
      res.<span class="hljs-title function_">write</span>(
        <span class="hljs-string">`data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify({
          <span class="hljs-keyword">type</span>: <span class="hljs-string">"error"</span>,
          message: error.message || <span class="hljs-string">"未知错误"</span>,
        })}</span>\n\n`</span>
      );
    }
    res.<span class="hljs-title function_">end</span>();
  }
});
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LogTape：零依赖的现代JavaScript日志解决方案]]></title>    <link>https://juejin.cn/post/7576486942834737198</link>    <guid>https://juejin.cn/post/7576486942834737198</guid>    <pubDate>2025-11-25T14:52:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576486942834737198" data-draft-id="7576158801972199470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LogTape：零依赖的现代JavaScript日志解决方案"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-25T14:52:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yanni4Night"/> <meta itemprop="url" content="https://juejin.cn/user/4089838983724520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LogTape：零依赖的现代JavaScript日志解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4089838983724520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yanni4Night
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T14:52:35.000Z" title="Tue Nov 25 2025 14:52:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在现代JavaScript开发中，日志功能是应用程序不可或缺的一部分。无论是开发调试、生产监控还是错误追踪，一个优秀的日志库都能显著提升开发效率和系统可靠性。然而，市面上许多日志库往往伴随着复杂的配置和过多的依赖，增加了项目的负担。今天，我要向大家介绍一款轻量级但功能强大的日志库——<strong>LogTape</strong>。</p>
<p>LogTape是一个零依赖的JavaScript日志库，专为现代Web开发环境设计。它的出现填补了市场上对于轻量级、跨平台日志解决方案的需求，让开发者能够以最小的代价获得高效的日志功能。</p>
<h2 data-id="heading-1">LogTape库概述</h2>
<p>LogTape是由开发者dahlia创建的一款开源日志库，其核心理念是提供"不引人注目"的日志功能。从项目名称"LogTape"我们可以看出，它就像一卷透明胶带，能够轻松地粘贴到任何JavaScript项目中，无需复杂的配置和设置。</p>
<h3 data-id="heading-2">核心特点</h3>
<ol>
<li><strong>零依赖</strong>：整个库不依赖任何第三方包，极大地减少了项目的体积和潜在的依赖冲突。</li>
<li><strong>跨平台兼容</strong>：支持Deno、Node.js、Bun、浏览器和边缘函数等多种JavaScript运行环境。</li>
<li><strong>极简API</strong>：提供简洁明了的接口，降低学习成本，提高开发效率。</li>
<li><strong>可定制性</strong>：虽然默认配置已经满足大多数需求，但仍然提供了足够的定制化选项。</li>
</ol>
<h2 data-id="heading-3">为什么选择LogTape？</h2>
<p>在众多日志库中，LogTape凭借其独特的设计理念和特性脱颖而出：</p>
<h3 data-id="heading-4">1. 轻量级设计</h3>
<p>LogTape的代码量非常小，但功能却十分完善。对于注重应用性能和加载速度的现代Web应用来说，这一点尤为重要。零依赖的特性意味着：</p>
<ul>
<li>更小的包体积，减少网络传输时间</li>
<li>更少的潜在漏洞和安全风险</li>
<li>避免依赖地狱（dependency hell）问题</li>
<li>简化项目的维护和升级过程</li>
</ul>
<h3 data-id="heading-5">2. 广泛的平台支持</h3>
<p>在当今多样化的JavaScript生态系统中，一个日志库能够同时支持服务器端和客户端环境是非常有价值的：</p>
<ul>
<li><strong>Node.js</strong>：适用于传统的服务器端应用</li>
<li><strong>Deno</strong>：支持现代化的JavaScript运行时</li>
<li><strong>Bun</strong>：兼容新兴的高性能JavaScript运行时</li>
<li><strong>浏览器</strong>：可直接在前端应用中使用</li>
<li><strong>边缘函数</strong>：支持Cloudflare Workers等边缘计算环境</li>
</ul>
<p>这种全面的兼容性使得开发者可以在整个技术栈中使用统一的日志解决方案，简化了跨环境开发的复杂性。</p>
<h3 data-id="heading-6">3. 现代化的设计理念</h3>
<p>LogTape采用了现代JavaScript的最佳实践，包括：</p>
<ul>
<li>使用ES模块系统</li>
<li>支持TypeScript类型定义</li>
<li>遵循函数式编程原则</li>
<li>提供链式API，提高代码可读性</li>
</ul>
<h2 data-id="heading-7">快速开始使用LogTape</h2>
<h3 data-id="heading-8">安装</h3>
<p>由于LogTape是零依赖的，安装过程非常简单。根据不同的环境，我们有不同的安装方式：</p>
<h4 data-id="heading-9">Node.js环境</h4>
<pre><code class="hljs language-bash" lang="bash">npm install logtape
<span class="hljs-comment"># 或</span>
yarn add logtape
<span class="hljs-comment"># 或</span>
pnpm add logtape
</code></pre>
<h4 data-id="heading-10">Deno环境</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createLogger } <span class="hljs-keyword">from</span> <span class="hljs-string">"https://deno.land/x/logtape/mod.ts"</span>;
</code></pre>
<h4 data-id="heading-11">浏览器环境</h4>
<p>可以直接通过CDN引入：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { createLogger } <span class="hljs-keyword">from</span> <span class="hljs-string">"https://esm.sh/logtape"</span>;
  <span class="hljs-comment">// 使用LogTape</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-12">基本用法</h3>
<p>LogTape的API设计简洁明了，以下是一些基本用法示例：</p>
<h4 data-id="heading-13">创建日志记录器</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createLogger } <span class="hljs-keyword">from</span> <span class="hljs-string">"logtape"</span>;

<span class="hljs-comment">// 创建默认日志记录器</span>
<span class="hljs-keyword">const</span> logger = <span class="hljs-title function_">createLogger</span>();

<span class="hljs-comment">// 或者使用自定义配置创建日志记录器</span>
<span class="hljs-keyword">const</span> customLogger = <span class="hljs-title function_">createLogger</span>({
  <span class="hljs-attr">level</span>: <span class="hljs-string">"info"</span>, <span class="hljs-comment">// 日志级别</span>
  <span class="hljs-attr">format</span>: <span class="hljs-string">"json"</span> <span class="hljs-comment">// 输出格式</span>
});
</code></pre>
<h4 data-id="heading-14">记录不同级别的日志</h4>
<p>LogTape支持多种日志级别，满足不同的记录需求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 调试信息</span>
logger.<span class="hljs-title function_">debug</span>(<span class="hljs-string">"这是一条调试信息"</span>);

<span class="hljs-comment">// 普通信息</span>
logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"应用启动成功"</span>);

<span class="hljs-comment">// 警告信息</span>
logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"磁盘空间不足"</span>);

<span class="hljs-comment">// 错误信息</span>
logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">"连接数据库失败"</span>, { <span class="hljs-attr">error</span>: err.<span class="hljs-property">message</span> });

<span class="hljs-comment">// 致命错误</span>
logger.<span class="hljs-title function_">fatal</span>(<span class="hljs-string">"服务器崩溃"</span>, { <span class="hljs-attr">exitCode</span>: <span class="hljs-number">1</span> });
</code></pre>
<h4 data-id="heading-15">结构化日志</h4>
<p>支持记录结构化数据，便于后续分析和处理：</p>
<pre><code class="hljs language-javascript" lang="javascript">logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"用户登录"</span>, {
  <span class="hljs-attr">userId</span>: <span class="hljs-string">"12345"</span>,
  <span class="hljs-attr">username</span>: <span class="hljs-string">"johndoe"</span>,
  <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
});
</code></pre>
<h2 data-id="heading-16">高级功能</h2>
<h3 data-id="heading-17">日志级别控制</h3>
<p>LogTape提供了灵活的日志级别控制系统，可以根据不同的环境和需求动态调整：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在生产环境中只记录警告及以上级别的日志</span>
<span class="hljs-keyword">if</span> (process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">"production"</span>) {
  logger.<span class="hljs-title function_">setLevel</span>(<span class="hljs-string">"warn"</span>);
}

<span class="hljs-comment">// 在开发环境中记录所有日志</span>
<span class="hljs-keyword">else</span> {
  logger.<span class="hljs-title function_">setLevel</span>(<span class="hljs-string">"debug"</span>);
}

<span class="hljs-comment">// 临时启用特定级别的日志记录</span>
logger.<span class="hljs-title function_">withLevel</span>(<span class="hljs-string">"trace"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 这个函数内的所有日志都会以trace级别记录，无论全局设置</span>
  <span class="hljs-title function_">complexOperation</span>();
});
</code></pre>
<p>LogTape支持的日志级别从低到高依次为：trace、debug、info、warn、error、fatal。这种细粒度的级别控制使得开发者能够精确控制日志的详细程度。</p>
<h3 data-id="heading-18">自定义输出目标</h3>
<p>LogTape的设计允许将日志输出到多个目标，实现日志的多渠道分发：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"fs"</span>;
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">"axios"</span>;

<span class="hljs-comment">// 文件日志处理器</span>
<span class="hljs-keyword">const</span> fileHandler = {
  <span class="hljs-attr">log</span>: <span class="hljs-function">(<span class="hljs-params">level, message, meta</span>) =&gt;</span> {
    <span class="hljs-comment">// 将日志写入文件</span>
    fs.<span class="hljs-title function_">appendFileSync</span>(
      <span class="hljs-string">"app.log"</span>,
      <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().toISOString()}</span> [<span class="hljs-subst">${level}</span>] <span class="hljs-subst">${message}</span> <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(meta)}</span>\n`</span>
    );
  }
};

<span class="hljs-comment">// 远程服务器日志处理器</span>
<span class="hljs-keyword">const</span> remoteHandler = {
  <span class="hljs-attr">log</span>: <span class="hljs-keyword">async</span> (level, message, meta) =&gt; {
    <span class="hljs-keyword">if</span> (level &gt;= <span class="hljs-string">"error"</span>) { <span class="hljs-comment">// 仅发送错误及以上级别的日志到远程服务器</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">"https://logs.example.com/ingest"</span>, {
          level,
          message,
          meta,
          <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
        });
      } <span class="hljs-keyword">catch</span> (err) {
        <span class="hljs-comment">// 避免日志处理器本身的错误导致应用崩溃</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Failed to send log to remote server"</span>, err);
      }
    }
  }
};

<span class="hljs-comment">// 控制台彩色日志处理器</span>
<span class="hljs-keyword">const</span> consoleColorHandler = {
  <span class="hljs-attr">log</span>: <span class="hljs-function">(<span class="hljs-params">level, message, meta</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> colors = {
      <span class="hljs-attr">debug</span>: <span class="hljs-string">"\x1b[36m"</span>, <span class="hljs-comment">// 青色</span>
      <span class="hljs-attr">info</span>: <span class="hljs-string">"\x1b[32m"</span>, <span class="hljs-comment">// 绿色</span>
      <span class="hljs-attr">warn</span>: <span class="hljs-string">"\x1b[33m"</span>, <span class="hljs-comment">// 黄色</span>
      <span class="hljs-attr">error</span>: <span class="hljs-string">"\x1b[31m"</span>, <span class="hljs-comment">// 红色</span>
      <span class="hljs-attr">fatal</span>: <span class="hljs-string">"\x1b[41m\x1b[37m"</span> <span class="hljs-comment">// 红底白字</span>
    };
    
    <span class="hljs-keyword">const</span> reset = <span class="hljs-string">"\x1b[0m"</span>;
    <span class="hljs-keyword">const</span> color = colors[level] || <span class="hljs-string">""</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${color}</span>[<span class="hljs-subst">${level.toUpperCase()}</span>]<span class="hljs-subst">${reset}</span> <span class="hljs-subst">${message}</span>`</span>, meta);
  }
};

<span class="hljs-comment">// 同时使用多个处理器</span>
<span class="hljs-keyword">const</span> multiLogger = <span class="hljs-title function_">createLogger</span>({
  <span class="hljs-attr">handlers</span>: [fileHandler, consoleColorHandler, remoteHandler]
});
</code></pre>
<h3 data-id="heading-19">上下文绑定与作用域日志</h3>
<p>在复杂应用中，跟踪请求或操作的完整生命周期至关重要。LogTape通过上下文绑定功能使这一过程变得简单：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建带有上下文的子日志记录器</span>
<span class="hljs-keyword">const</span> requestLogger = logger.<span class="hljs-title function_">child</span>({ 
  <span class="hljs-attr">requestId</span>: <span class="hljs-string">"abc-123"</span>,
  <span class="hljs-attr">userId</span>: <span class="hljs-string">"user456"</span>,
  <span class="hljs-attr">sessionId</span>: <span class="hljs-string">"session789"</span>
});

<span class="hljs-comment">// 这条日志会自动包含所有上下文信息</span>
requestLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"用户登录成功"</span>);

<span class="hljs-comment">// 可以创建更深层次的上下文</span>
<span class="hljs-keyword">const</span> dbLogger = requestLogger.<span class="hljs-title function_">child</span>({ <span class="hljs-attr">component</span>: <span class="hljs-string">"database"</span> });
dbLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"查询用户数据"</span>, { <span class="hljs-attr">queryId</span>: <span class="hljs-string">"q1"</span> });

<span class="hljs-comment">// 上下文可以在异步操作中保持</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processOrder</span>(<span class="hljs-params">orderId</span>) {
  <span class="hljs-keyword">const</span> orderLogger = logger.<span class="hljs-title function_">child</span>({ orderId });
  orderLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"开始处理订单"</span>);
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">validateOrder</span>(orderId);
    orderLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"订单验证通过"</span>);
    
    <span class="hljs-keyword">const</span> paymentResult = <span class="hljs-keyword">await</span> <span class="hljs-title function_">processPayment</span>(orderId);
    orderLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"支付处理完成"</span>, { <span class="hljs-attr">paymentId</span>: paymentResult.<span class="hljs-property">id</span> });
    
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">shipOrder</span>(orderId);
    orderLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"订单已发货"</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    orderLogger.<span class="hljs-title function_">error</span>(<span class="hljs-string">"订单处理失败"</span>, { <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> });
    <span class="hljs-keyword">throw</span> error;
  }
}
</code></pre>
<h3 data-id="heading-20">条件日志记录</h3>
<p>LogTape还支持条件日志记录，可以根据特定条件决定是否记录日志，这在性能敏感的应用中特别有用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 仅当满足特定条件时记录日志</span>
logger.<span class="hljs-title function_">infoIf</span>(
  user.<span class="hljs-property">isPremium</span>, <span class="hljs-comment">// 条件</span>
  <span class="hljs-string">"高级用户操作"</span>, 
  { <span class="hljs-attr">userId</span>: user.<span class="hljs-property">id</span>, <span class="hljs-attr">action</span>: <span class="hljs-string">"download"</span> }
);

<span class="hljs-comment">// 带函数的条件日志（惰性求值，提高性能）</span>
logger.<span class="hljs-title function_">debugIf</span>(
  <span class="hljs-function">() =&gt;</span> process.<span class="hljs-property">env</span>.<span class="hljs-property">DEBUG</span> === <span class="hljs-string">"true"</span>, <span class="hljs-comment">// 函数形式的条件</span>
  <span class="hljs-string">"详细调试信息"</span>, 
  { 
    <span class="hljs-comment">// 这些数据只有在条件为真时才会被计算</span>
    <span class="hljs-attr">complexData</span>: <span class="hljs-title function_">expensiveCalculation</span>() 
  }
);
</code></pre>
<h2 data-id="heading-21">实际应用场景</h2>
<h3 data-id="heading-22">1. Web应用开发</h3>
<p>在前端应用中，LogTape可以帮助开发者记录用户行为、捕获错误并提供调试信息：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 记录用户交互</span>
logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"用户点击按钮"</span>, {
  <span class="hljs-attr">buttonId</span>: <span class="hljs-string">"submit-form"</span>,
  <span class="hljs-attr">userId</span>: currentUser?.<span class="hljs-property">id</span>,
  <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
});

<span class="hljs-comment">// 捕获并记录错误</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 执行可能出错的操作</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUserData</span>(userId);
  logger.<span class="hljs-title function_">debug</span>(<span class="hljs-string">"获取用户数据成功"</span>, { userId, <span class="hljs-attr">dataSize</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result).<span class="hljs-property">length</span> });
} <span class="hljs-keyword">catch</span> (error) {
  logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">"操作失败"</span>, { 
    <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span>, 
    <span class="hljs-attr">stack</span>: error.<span class="hljs-property">stack</span>,
    <span class="hljs-attr">operation</span>: <span class="hljs-string">"fetchUserData"</span>,
    <span class="hljs-attr">userId</span>: userId
  });
  <span class="hljs-comment">// 向用户显示友好的错误信息</span>
  <span class="hljs-title function_">showErrorMessage</span>(<span class="hljs-string">"获取数据失败，请稍后重试"</span>);
}

<span class="hljs-comment">// 性能监控</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">measurePerformance</span>(<span class="hljs-params">name, fn</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);
      <span class="hljs-keyword">const</span> duration = performance.<span class="hljs-title function_">now</span>() - start;
      
      <span class="hljs-comment">// 记录操作性能</span>
      logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span>执行完成`</span>, { 
        <span class="hljs-attr">duration</span>: <span class="hljs-string">`<span class="hljs-subst">${duration.toFixed(<span class="hljs-number">2</span>)}</span>ms`</span>,
        <span class="hljs-comment">// 仅在开发环境记录详细参数</span>
        ...(process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">"development"</span> ? { <span class="hljs-attr">params</span>: args } : {})
      });
      
      <span class="hljs-comment">// 性能警告</span>
      <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">1000</span>) {
        logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span>执行时间过长`</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-string">`<span class="hljs-subst">${duration.toFixed(<span class="hljs-number">2</span>)}</span>ms`</span> });
      }
      
      <span class="hljs-keyword">return</span> result;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">const</span> duration = performance.<span class="hljs-title function_">now</span>() - start;
      logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span>执行失败`</span>, { 
        <span class="hljs-attr">duration</span>: <span class="hljs-string">`<span class="hljs-subst">${duration.toFixed(<span class="hljs-number">2</span>)}</span>ms`</span>,
        <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> 
      });
      <span class="hljs-keyword">throw</span> error;
    }
  };
}

<span class="hljs-comment">// 使用性能监控包装函数</span>
<span class="hljs-keyword">const</span> optimizedFetchData = <span class="hljs-title function_">measurePerformance</span>(<span class="hljs-string">"fetchData"</span>, fetchData);
</code></pre>
<h3 data-id="heading-23">2. 服务器端应用</h3>
<p>在Node.js等服务器端环境中，LogTape可以用于记录API请求、数据库操作和系统事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Express中间件记录请求</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-comment">// 生成请求ID</span>
  <span class="hljs-keyword">const</span> requestId = uuid.<span class="hljs-title function_">v4</span>();
  req.<span class="hljs-property">requestId</span> = requestId;
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"X-Request-ID"</span>, requestId);
  
  <span class="hljs-comment">// 创建请求专用日志记录器</span>
  <span class="hljs-keyword">const</span> requestLogger = logger.<span class="hljs-title function_">child</span>({
    requestId,
    <span class="hljs-attr">method</span>: req.<span class="hljs-property">method</span>,
    <span class="hljs-attr">url</span>: req.<span class="hljs-property">url</span>,
    <span class="hljs-attr">ip</span>: req.<span class="hljs-property">ip</span>
  });
  
  req.<span class="hljs-property">logger</span> = requestLogger;
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  
  requestLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"收到请求"</span>, {
    <span class="hljs-attr">userAgent</span>: req.<span class="hljs-property">headers</span>[<span class="hljs-string">"user-agent"</span>],
    <span class="hljs-attr">referer</span>: req.<span class="hljs-property">headers</span>.<span class="hljs-property">referer</span>
  });
  
  res.<span class="hljs-title function_">on</span>(<span class="hljs-string">"finish"</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime;
    requestLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"请求处理完成"</span>, {
      <span class="hljs-attr">status</span>: res.<span class="hljs-property">statusCode</span>,
      <span class="hljs-attr">duration</span>: <span class="hljs-string">`<span class="hljs-subst">${duration}</span>ms`</span>,
      <span class="hljs-attr">responseSize</span>: res.<span class="hljs-title function_">getHeader</span>(<span class="hljs-string">"content-length"</span>) || <span class="hljs-number">0</span>
    });
    
    <span class="hljs-comment">// 记录错误响应</span>
    <span class="hljs-keyword">if</span> (res.<span class="hljs-property">statusCode</span> &gt;= <span class="hljs-number">400</span>) {
      requestLogger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"返回错误状态码"</span>, { 
        <span class="hljs-attr">status</span>: res.<span class="hljs-property">statusCode</span>,
        <span class="hljs-attr">duration</span>: <span class="hljs-string">`<span class="hljs-subst">${duration}</span>ms`</span> 
      });
    }
  });
  
  <span class="hljs-title function_">next</span>();
});

<span class="hljs-comment">// 数据库操作日志</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">queryDatabase</span>(<span class="hljs-params">sql, params</span>) {
  <span class="hljs-keyword">const</span> dbLogger = logger.<span class="hljs-title function_">child</span>({ <span class="hljs-attr">component</span>: <span class="hljs-string">"database"</span> });
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  
  <span class="hljs-keyword">try</span> {
    dbLogger.<span class="hljs-title function_">debug</span>(<span class="hljs-string">"执行SQL查询"</span>, { 
      <span class="hljs-attr">sql</span>: <span class="hljs-title function_">maskSensitiveData</span>(sql),
      <span class="hljs-attr">params</span>: <span class="hljs-title function_">maskSensitiveParams</span>(params)
    });
    
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> database.<span class="hljs-title function_">query</span>(sql, params);
    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime;
    
    dbLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"SQL查询完成"</span>, { 
      <span class="hljs-attr">duration</span>: <span class="hljs-string">`<span class="hljs-subst">${duration}</span>ms`</span>,
      <span class="hljs-attr">rowCount</span>: result.<span class="hljs-property">rowCount</span> || <span class="hljs-number">0</span>
    });
    
    <span class="hljs-comment">// 慢查询警告</span>
    <span class="hljs-keyword">if</span> (duration &gt; <span class="hljs-number">500</span>) {
      dbLogger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"慢SQL查询"</span>, { 
        <span class="hljs-attr">sql</span>: <span class="hljs-title function_">maskSensitiveData</span>(sql),
        <span class="hljs-attr">duration</span>: <span class="hljs-string">`<span class="hljs-subst">${duration}</span>ms`</span> 
      });
    }
    
    <span class="hljs-keyword">return</span> result;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime;
    dbLogger.<span class="hljs-title function_">error</span>(<span class="hljs-string">"SQL查询失败"</span>, { 
      <span class="hljs-attr">sql</span>: <span class="hljs-title function_">maskSensitiveData</span>(sql),
      <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span>,
      <span class="hljs-attr">duration</span>: <span class="hljs-string">`<span class="hljs-subst">${duration}</span>ms`</span>
    });
    <span class="hljs-keyword">throw</span> error;
  }
}

<span class="hljs-comment">// 系统事件监控</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">monitorSystemEvents</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 内存使用监控</span>
  <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> memoryUsage = process.<span class="hljs-title function_">memoryUsage</span>();
    <span class="hljs-keyword">const</span> rssMB = (memoryUsage.<span class="hljs-property">rss</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>);
    
    logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"系统资源使用情况"</span>, {
      <span class="hljs-attr">memory</span>: {
        <span class="hljs-attr">rss</span>: <span class="hljs-string">`<span class="hljs-subst">${rssMB}</span>MB`</span>,
        <span class="hljs-attr">heapTotal</span>: <span class="hljs-string">`<span class="hljs-subst">${(memoryUsage.heapTotal / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>)}</span>MB`</span>,
        <span class="hljs-attr">heapUsed</span>: <span class="hljs-string">`<span class="hljs-subst">${(memoryUsage.heapUsed / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>).toFixed(<span class="hljs-number">2</span>)}</span>MB`</span>
      },
      <span class="hljs-attr">uptime</span>: <span class="hljs-string">`<span class="hljs-subst">${process.uptime().toFixed(<span class="hljs-number">2</span>)}</span>s`</span>
    });
    
    <span class="hljs-comment">// 内存使用警告</span>
    <span class="hljs-keyword">if</span> (memoryUsage.<span class="hljs-property">rss</span> &gt; <span class="hljs-number">1.5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) { <span class="hljs-comment">// 超过1.5GB</span>
      logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"内存使用过高"</span>, { <span class="hljs-attr">rss</span>: <span class="hljs-string">`<span class="hljs-subst">${rssMB}</span>MB`</span> });
    }
  }, <span class="hljs-number">60000</span>); <span class="hljs-comment">// 每分钟记录一次</span>
}
</code></pre>
<h3 data-id="heading-24">3. 微服务架构</h3>
<p>在微服务架构中，LogTape的结构化日志功能特别有用，可以帮助跟踪跨服务的请求流程：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 生成和传播关联ID</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">setupCorrelationMiddleware</span>(<span class="hljs-params">app</span>) {
  app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
    <span class="hljs-comment">// 从请求头获取关联ID，如果没有则生成新的</span>
    <span class="hljs-keyword">const</span> correlationId = req.<span class="hljs-property">headers</span>[<span class="hljs-string">"x-correlation-id"</span>] || uuid.<span class="hljs-title function_">v4</span>();
    req.<span class="hljs-property">correlationId</span> = correlationId;
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">"x-correlation-id"</span>, correlationId);
    
    <span class="hljs-comment">// 为所有服务间调用设置关联ID</span>
    req.<span class="hljs-property">httpClient</span> = axios.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">"x-correlation-id"</span>: correlationId }
    });
    
    <span class="hljs-comment">// 创建带有关联ID的日志记录器</span>
    req.<span class="hljs-property">logger</span> = logger.<span class="hljs-title function_">child</span>({ correlationId });
    <span class="hljs-title function_">next</span>();
  });
}

<span class="hljs-comment">// 服务调用封装</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">callService</span>(<span class="hljs-params">serviceName, endpoint, data</span>) {
  <span class="hljs-keyword">const</span> correlationId = <span class="hljs-title function_">getCurrentCorrelationId</span>();
  <span class="hljs-keyword">const</span> serviceLogger = logger.<span class="hljs-title function_">child</span>({
    correlationId,
    <span class="hljs-attr">service</span>: serviceName,
    endpoint
  });
  
  serviceLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"调用微服务"</span>, { 
    <span class="hljs-attr">dataSize</span>: data ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data).<span class="hljs-property">length</span> : <span class="hljs-number">0</span> 
  });
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">`http://<span class="hljs-subst">${serviceName}</span>/<span class="hljs-subst">${endpoint}</span>`</span>, data, {
      <span class="hljs-attr">headers</span>: { <span class="hljs-string">"x-correlation-id"</span>: correlationId }
    });
    <span class="hljs-keyword">const</span> duration = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime;
    
    serviceLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"微服务调用成功"</span>, { 
      <span class="hljs-attr">status</span>: response.<span class="hljs-property">status</span>,
      <span class="hljs-attr">duration</span>: <span class="hljs-string">`<span class="hljs-subst">${duration}</span>ms`</span>
    });
    
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    serviceLogger.<span class="hljs-title function_">error</span>(<span class="hljs-string">"微服务调用失败"</span>, { 
      <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span>,
      <span class="hljs-attr">status</span>: error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span>,
      <span class="hljs-attr">service</span>: serviceName
    });
    <span class="hljs-keyword">throw</span> error;
  }
}

<span class="hljs-comment">// 分布式追踪示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processOrder</span>(<span class="hljs-params">order</span>) {
  <span class="hljs-keyword">const</span> orderLogger = logger.<span class="hljs-title function_">child</span>({
    <span class="hljs-attr">orderId</span>: order.<span class="hljs-property">id</span>,
    <span class="hljs-attr">customerId</span>: order.<span class="hljs-property">customerId</span>,
    <span class="hljs-attr">traceId</span>: uuid.<span class="hljs-title function_">v4</span>() <span class="hljs-comment">// 追踪ID</span>
  });
  
  orderLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"开始处理订单流程"</span>);
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 调用库存服务</span>
    orderLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"检查库存"</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">callService</span>(<span class="hljs-string">"inventory-service"</span>, <span class="hljs-string">"check"</span>, {
      <span class="hljs-attr">orderId</span>: order.<span class="hljs-property">id</span>,
      <span class="hljs-attr">items</span>: order.<span class="hljs-property">items</span>
    });
    
    <span class="hljs-comment">// 调用支付服务</span>
    orderLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"处理支付"</span>);
    <span class="hljs-keyword">const</span> paymentResult = <span class="hljs-keyword">await</span> <span class="hljs-title function_">callService</span>(<span class="hljs-string">"payment-service"</span>, <span class="hljs-string">"process"</span>, {
      <span class="hljs-attr">orderId</span>: order.<span class="hljs-property">id</span>,
      <span class="hljs-attr">amount</span>: order.<span class="hljs-property">total</span>,
      <span class="hljs-attr">paymentMethod</span>: order.<span class="hljs-property">paymentMethod</span>
    });
    
    <span class="hljs-comment">// 调用配送服务</span>
    orderLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"安排配送"</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">callService</span>(<span class="hljs-string">"shipping-service"</span>, <span class="hljs-string">"schedule"</span>, {
      <span class="hljs-attr">orderId</span>: order.<span class="hljs-property">id</span>,
      <span class="hljs-attr">address</span>: order.<span class="hljs-property">shippingAddress</span>,
      <span class="hljs-attr">items</span>: order.<span class="hljs-property">items</span>
    });
    
    <span class="hljs-comment">// 更新订单状态</span>
    orderLogger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"订单处理完成"</span>, { <span class="hljs-attr">paymentId</span>: paymentResult.<span class="hljs-property">id</span> });
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">orderId</span>: order.<span class="hljs-property">id</span> };
  } <span class="hljs-keyword">catch</span> (error) {
    orderLogger.<span class="hljs-title function_">error</span>(<span class="hljs-string">"订单处理流程失败"</span>, { 
      <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span>,
      <span class="hljs-attr">step</span>: error.<span class="hljs-property">step</span> || <span class="hljs-string">"unknown"</span>
    });
    <span class="hljs-keyword">throw</span> error;
  }
}
</code></pre>
<h2 data-id="heading-25">LogTape与其他日志库的比较</h2>
<p>为了更好地理解LogTape的优势，让我们将它与一些流行的日志库进行比较：</p>















































<table><thead><tr><th>特性</th><th>LogTape</th><th>Winston</th><th>Bunyan</th><th>Pino</th></tr></thead><tbody><tr><td>依赖项</td><td>零依赖</td><td>多个依赖</td><td>多个依赖</td><td>少量依赖</td></tr><tr><td>包体积</td><td>极小</td><td>较大</td><td>中等</td><td>小</td></tr><tr><td>跨平台支持</td><td>全平台</td><td>主要Node.js</td><td>主要Node.js</td><td>主要Node.js</td></tr><tr><td>API复杂度</td><td>简单</td><td>中等</td><td>中等</td><td>简单</td></tr><tr><td>性能</td><td>高</td><td>中等</td><td>中等</td><td>高</td></tr></tbody></table>
<p>从比较中可以看出，LogTape在轻量级和跨平台支持方面具有明显优势，特别适合对包体积和性能有严格要求的项目。</p>
<h2 data-id="heading-26">总结</h2>
<p>LogTape作为一款零依赖的现代JavaScript日志库，以其轻量级设计、跨平台兼容性和简洁的API赢得了开发者的青睐。它特别适合以下场景：</p>
<ul>
<li>对性能和加载速度要求高的Web应用</li>
<li>需要在多种JavaScript环境中统一日志方案的项目</li>
<li>追求极简依赖、易于维护的开发团队</li>
<li>需要轻量级但功能完备的日志解决方案的任何JavaScript项目</li>
</ul>
<p>在当前JavaScript生态系统日益复杂的背景下，LogTape的出现提供了一种"回归本质"的选择，让开发者能够专注于业务逻辑而非处理复杂的日志配置。如果你正在寻找一款简单易用、功能实用的日志库，不妨试试LogTape，相信它会给你的开发工作带来惊喜。</p>
<p>最后，作为一个开源项目，LogTape欢迎社区的贡献和反馈。如果你有任何建议或想要参与开发，可以访问其GitHub仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdahlia%2Flogtape%25E3%2580%2582" target="_blank" title="https://github.com/dahlia/logtape%E3%80%82" ref="nofollow noopener noreferrer">github.com/dahlia/logt…</a></p>
<p>让我们用更轻量、更高效的方式记录代码的每一步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一、React Fiber 架构与任务调度详解]]></title>    <link>https://juejin.cn/post/7576487832089952271</link>    <guid>https://juejin.cn/post/7576487832089952271</guid>    <pubDate>2025-11-25T13:02:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576487832089952271" data-draft-id="7576487832089935887" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一、React Fiber 架构与任务调度详解"/> <meta itemprop="keywords" content="前端,React.js,架构"/> <meta itemprop="datePublished" content="2025-11-25T13:02:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小璞"/> <meta itemprop="url" content="https://juejin.cn/user/1609340755378829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一、React Fiber 架构与任务调度详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1609340755378829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小璞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T13:02:53.000Z" title="Tue Nov 25 2025 13:02:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>从架构设计角度深入理解如何解决前端 UI 卡顿问题</p>
</blockquote>
<h2 data-id="heading-0">目录</h2>
<ol>
<li><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF" title="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF">问题背景：为什么需要 Fiber</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5" title="#%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5">核心概念与数据结构</a></li>
<li><a href="#%E6%97%B6%E9%97%B4%E5%88%87%E7%89%87" title="#%E6%97%B6%E9%97%B4%E5%88%87%E7%89%87">时间切片机制</a></li>
<li><a href="#%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6" title="#%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6">任务优先级调度</a></li>
<li><a href="#%E5%8F%8C%E7%BC%93%E5%AD%98" title="#%E5%8F%8C%E7%BC%93%E5%AD%98">双缓存机制</a></li>
<li><a href="#%E6%9E%B6%E6%9E%84%E6%80%9D%E6%83%B3" title="#%E6%9E%B6%E6%9E%84%E6%80%9D%E6%83%B3">架构设计思想提炼</a></li>
<li><a href="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF" title="#%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF">实际应用场景</a></li>
</ol>
<hr/>
<h2 data-id="heading-1">问题背景：为什么需要 Fiber {#问题背景}</h2>
<h3 data-id="heading-2">React 15 的痛点</h3>
<p>在 React 15 及之前的版本中，渲染过程是<strong>同步且不可中断</strong>的：</p>
<pre><code class="hljs language-markdown" lang="markdown">用户点击 → setState → 开始 Reconciliation（协调）
<span class="hljs-code">                    ↓
            递归遍历整个组件树 (同步，不可中断)
                    ↓
            一次性更新所有 DOM
                    ↓
            浏览器重新绘制
</span></code></pre>
<p><strong>问题场景</strong>：假设你有一个包含 1000 个组件的列表，用户点击按钮触发更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 15 的行为</span>
handleClick = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setState</span>({ <span class="hljs-attr">data</span>: newData }); <span class="hljs-comment">// 触发更新</span>

  <span class="hljs-comment">// 💥 主线程被阻塞 100ms+</span>
  <span class="hljs-comment">// - JS 引擎递归遍历 1000 个组件</span>
  <span class="hljs-comment">// - 对比虚拟 DOM</span>
  <span class="hljs-comment">// - 生成更新指令</span>

  <span class="hljs-comment">// ❌ 在这期间：</span>
  <span class="hljs-comment">// - 用户输入无响应</span>
  <span class="hljs-comment">// - 滚动卡顿</span>
  <span class="hljs-comment">// - 动画掉帧</span>
}
</code></pre>
<p><strong>根本原因</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────────────────────────────────────────────────────┐
│                   浏览器主线程职责                           │
├─────────────────────────────────────────────────────────────┤
│  1. 执行 JavaScript                                         │
│  2. 样式计算（Style）                                       │
│  3. 布局计算（Layout）                                      │
│  4. 绘制（Paint）                                           │
│  5. 合成（Composite）                                       │
│  6. 处理用户输入（Input Events）                            │
└─────────────────────────────────────────────────────────────┘

⚠️ 问题：如果 JS 执行时间过长（如 React 递归渲染）
<span class="hljs-code">        → 其他任务（输入、动画）被饿死
        → 用户感知卡顿
</span>
💡 人眼感知：16.6ms 一帧（60fps）
<span class="hljs-code">           如果一帧内 JS 执行超过 16.6ms → 掉帧
</span></code></pre>
<h3 data-id="heading-3">架构层面的矛盾</h3>
<pre><code class="hljs language-css" lang="css">┌──────────────────────────────────────────────────────────────┐
│           React <span class="hljs-number">15</span> 的架构矛盾                                 │
├──────────────────────────────────────────────────────────────┤
│                                                               │
│  需求 <span class="hljs-selector-tag">A</span>：快速响应用户交互（高优先级）                         │
│  需求 <span class="hljs-selector-tag">B</span>：大量数据渲染计算（低优先级）                         │
│                                                               │
│  ❌ React <span class="hljs-number">15</span>：无法区分优先级，一视同仁                        │
│  ❌ 递归调用栈无法中断                                        │
│  ❌ 没有"让出控制权"的机制                                    │
│                                                               │
└──────────────────────────────────────────────────────────────┘

传统递归调用栈：
setState → render → render → render → ... → commitUpdate
           ↓         ↓         ↓              ↑
          无法中断   无法暂停  无法恢复      无法插队
</code></pre>
<hr/>
<h2 data-id="heading-4">核心概念与数据结构 {#核心概念}</h2>
<h3 data-id="heading-5">Fiber：可中断的工作单元</h3>
<p>Fiber 的本质是<strong>将递归的组件树转化为链表结构</strong>，让渲染过程变得可控。</p>
<h4 data-id="heading-6">对比：React 15 vs Fiber</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ============================================</span>
<span class="hljs-comment">// React 15：递归的虚拟 DOM 树</span>
<span class="hljs-comment">// ============================================</span>
<span class="hljs-keyword">const</span> vdom = {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'div'</span>,
  <span class="hljs-attr">props</span>: { <span class="hljs-attr">className</span>: <span class="hljs-string">'container'</span> },
  <span class="hljs-attr">children</span>: [
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'h1'</span>, <span class="hljs-attr">props</span>: {}, <span class="hljs-attr">children</span>: [<span class="hljs-string">'Title'</span>] },
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'p'</span>, <span class="hljs-attr">props</span>: {}, <span class="hljs-attr">children</span>: [<span class="hljs-string">'Content'</span>] }
  ]
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcile</span>(<span class="hljs-params">vdom</span>) {
  <span class="hljs-comment">// 💥 递归调用，无法中断</span>
  <span class="hljs-keyword">const</span> node = <span class="hljs-title function_">createDOMNode</span>(vdom.<span class="hljs-property">type</span>);
  vdom.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> {
    node.<span class="hljs-title function_">appendChild</span>(<span class="hljs-title function_">reconcile</span>(child)); <span class="hljs-comment">// 深度递归</span>
  });
  <span class="hljs-keyword">return</span> node;
}

<span class="hljs-comment">// ============================================</span>
<span class="hljs-comment">// Fiber：链表结构的工作单元</span>
<span class="hljs-comment">// ============================================</span>
<span class="hljs-keyword">const</span> fiber = {
  <span class="hljs-comment">// 工作单元信息</span>
  <span class="hljs-attr">type</span>: <span class="hljs-string">'div'</span>,                    <span class="hljs-comment">// 组件类型</span>
  <span class="hljs-attr">props</span>: { <span class="hljs-attr">className</span>: <span class="hljs-string">'container'</span> },
  <span class="hljs-attr">stateNode</span>: domNode,             <span class="hljs-comment">// 真实 DOM 引用</span>

  <span class="hljs-comment">// 链表指针（核心！）</span>
  <span class="hljs-attr">child</span>: fiber1,                  <span class="hljs-comment">// 第一个子节点</span>
  <span class="hljs-attr">sibling</span>: fiber2,                <span class="hljs-comment">// 下一个兄弟节点</span>
  <span class="hljs-attr">return</span>: parentFiber,            <span class="hljs-comment">// 父节点</span>

  <span class="hljs-comment">// 双缓存</span>
  <span class="hljs-attr">alternate</span>: oldFiber,            <span class="hljs-comment">// 指向另一棵树的对应节点</span>

  <span class="hljs-comment">// 副作用标记</span>
  <span class="hljs-attr">flags</span>: <span class="hljs-title class_">Update</span> | <span class="hljs-title class_">Placement</span>,      <span class="hljs-comment">// 需要执行的操作</span>

  <span class="hljs-comment">// 调度相关</span>
  <span class="hljs-attr">lanes</span>: <span class="hljs-number">0b0001</span>,                  <span class="hljs-comment">// 优先级标记</span>

  <span class="hljs-comment">// 状态</span>
  <span class="hljs-attr">memoizedState</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> },    <span class="hljs-comment">// 上次渲染的 state</span>
  <span class="hljs-attr">updateQueue</span>: [],                <span class="hljs-comment">// 待处理的更新队列</span>
};
</code></pre>
<h3 data-id="heading-7">为什么链表结构可以实现可中断？</h3>
<pre><code class="hljs language-scss" lang="scss">传统递归（调用栈）：
  function <span class="hljs-selector-tag">A</span>() {
    <span class="hljs-selector-tag">B</span>();  <span class="hljs-comment">// 必须等 B 执行完</span>
  }
  function <span class="hljs-selector-tag">B</span>() {
    <span class="hljs-built_in">C</span>();  <span class="hljs-comment">// 必须等 C 执行完</span>
  }
  ❌ 无法在 <span class="hljs-selector-tag">B</span> 执行一半时跳出

Fiber 链表（数据结构）：
  currentFiber = fiberA;

  while (currentFiber &amp;&amp; !shouldYield()) {
    <span class="hljs-comment">// 处理当前节点</span>
    <span class="hljs-built_in">performUnitOfWork</span>(currentFiber);

    <span class="hljs-comment">// ✅ 检查时间，可以随时中断</span>
    if (shouldYield()) {
      break; <span class="hljs-comment">// 保存 currentFiber，下次继续</span>
    }

    <span class="hljs-comment">// 移动到下一个节点</span>
    currentFiber = <span class="hljs-built_in">getNextFiber</span>(currentFiber);
  }
</code></pre>
<h3 data-id="heading-8">Fiber 树的遍历规则（深度优先）</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">         Root
          │
     ┌────┴────┐
     │         │
    App      <span class="hljs-literal">null</span>
     │
  ┌──┴──┐
  │     │
Header Body
  │     │
 Nav  Content

遍历顺序：
<span class="hljs-number">1.</span> Root → App (child)
<span class="hljs-number">2.</span> App → Header (child)
<span class="hljs-number">3.</span> Header → Nav (child)
<span class="hljs-number">4.</span> Nav → <span class="hljs-literal">null</span> (no child)，返回 Header
<span class="hljs-number">5.</span> Header → Body (sibling)
<span class="hljs-number">6.</span> Body → Content (child)
<span class="hljs-number">7.</span> Content → <span class="hljs-literal">null</span>，返回 Body
<span class="hljs-number">8.</span> Body → <span class="hljs-literal">null</span> (no sibling)，返回 App
<span class="hljs-number">9.</span> App → <span class="hljs-literal">null</span>，返回 Root
<span class="hljs-number">10.</span> 结束

伪代码：
function getNextFiber(fiber) {
  <span class="hljs-comment">// 1. 有子节点：向下走</span>
  <span class="hljs-keyword">if</span> (fiber.child) <span class="hljs-keyword">return</span> fiber.child;

  <span class="hljs-comment">// 2. 无子节点：找兄弟节点</span>
  let nextFiber = fiber;
  <span class="hljs-keyword">while</span> (nextFiber) {
    <span class="hljs-keyword">if</span> (nextFiber.sibling) <span class="hljs-keyword">return</span> nextFiber.sibling;
    nextFiber = nextFiber.<span class="hljs-keyword">return</span>; <span class="hljs-comment">// 向上回溯</span>
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 遍历完成</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-9">时间切片机制 {#时间切片}</h2>
<h3 data-id="heading-10">核心思想：主动让出控制权</h3>
<pre><code class="hljs language-markdown" lang="markdown">传统长任务（100ms）：
┌──────────────────────────────────────────────────────────────┐
│                    JS 执行（阻塞）                             │
└──────────────────────────────────────────────────────────────┘
<span class="hljs-code">                      ↓
              用户交互无响应
</span>
时间切片（5ms × 20）：
┌────┐     ┌────┐     ┌────┐     ┌────┐     ┌────┐
│ JS │空闲 │ JS │空闲 │ JS │空闲 │ JS │空闲 │ JS │  ...
└────┘     └────┘     └────┘     └────┘     └────┘
  ↑          ↑          ↑          ↑
  5ms     浏览器可以    5ms     处理其他任务
<span class="hljs-code">         处理输入/绘制
</span></code></pre>
<h3 data-id="heading-11">实现原理：MessageChannel + 宏任务</h3>
<p>React 不使用 <code>setTimeout</code>，而是使用 <code>MessageChannel</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ============================================</span>
<span class="hljs-comment">// React Scheduler 的时间切片实现（简化版）</span>
<span class="hljs-comment">// ============================================</span>

<span class="hljs-comment">// 1. 任务队列（最小堆，按过期时间排序）</span>
<span class="hljs-keyword">const</span> taskQueue = [];
<span class="hljs-keyword">let</span> currentTask = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">let</span> isPerformingWork = <span class="hljs-literal">false</span>;

<span class="hljs-comment">// 2. 时间切片配置</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FRAME_INTERVAL</span> = <span class="hljs-number">5</span>; <span class="hljs-comment">// 5ms 切片</span>
<span class="hljs-keyword">let</span> deadline = <span class="hljs-number">0</span>;

<span class="hljs-comment">// 3. 判断是否应该让出控制权</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">shouldYield</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> performance.<span class="hljs-title function_">now</span>() &gt;= deadline;
}

<span class="hljs-comment">// 4. 调度入口</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">scheduleCallback</span>(<span class="hljs-params">priority, callback</span>) {
  <span class="hljs-keyword">const</span> currentTime = performance.<span class="hljs-title function_">now</span>();

  <span class="hljs-comment">// 计算过期时间（根据优先级）</span>
  <span class="hljs-keyword">let</span> timeout;
  <span class="hljs-keyword">switch</span> (priority) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">ImmediatePriority</span>:  <span class="hljs-comment">// 立即执行（如用户输入）</span>
      timeout = -<span class="hljs-number">1</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">UserBlockingPriority</span>: <span class="hljs-comment">// 250ms</span>
      timeout = <span class="hljs-number">250</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">NormalPriority</span>: <span class="hljs-comment">// 5000ms</span>
      timeout = <span class="hljs-number">5000</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">LowPriority</span>: <span class="hljs-comment">// 10000ms</span>
      timeout = <span class="hljs-number">10000</span>;
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">IdlePriority</span>: <span class="hljs-comment">// 永不过期</span>
      timeout = maxSigned31BitInt;
      <span class="hljs-keyword">break</span>;
  }

  <span class="hljs-keyword">const</span> expirationTime = currentTime + timeout;

  <span class="hljs-comment">// 创建任务</span>
  <span class="hljs-keyword">const</span> newTask = {
    callback,
    priority,
    expirationTime,
    <span class="hljs-attr">startTime</span>: currentTime
  };

  <span class="hljs-comment">// 插入任务队列（最小堆）</span>
  <span class="hljs-title function_">push</span>(taskQueue, newTask);

  <span class="hljs-comment">// 请求调度</span>
  <span class="hljs-keyword">if</span> (!isPerformingWork) {
    <span class="hljs-title function_">requestHostCallback</span>(workLoop);
  }

  <span class="hljs-keyword">return</span> newTask;
}

<span class="hljs-comment">// 5. 使用 MessageChannel 实现宏任务</span>
<span class="hljs-keyword">const</span> channel = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageChannel</span>();
<span class="hljs-keyword">const</span> port = channel.<span class="hljs-property">port2</span>;

channel.<span class="hljs-property">port1</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (scheduledCallback !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">const</span> currentTime = performance.<span class="hljs-title function_">now</span>();
    deadline = currentTime + <span class="hljs-variable constant_">FRAME_INTERVAL</span>; <span class="hljs-comment">// 设置本次切片的截止时间</span>

    <span class="hljs-keyword">const</span> hasMoreWork = <span class="hljs-title function_">scheduledCallback</span>(currentTime);

    <span class="hljs-keyword">if</span> (hasMoreWork) {
      <span class="hljs-comment">// 还有任务，继续调度</span>
      port.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>);
    } <span class="hljs-keyword">else</span> {
      scheduledCallback = <span class="hljs-literal">null</span>;
    }
  }
};

<span class="hljs-keyword">let</span> scheduledCallback = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">requestHostCallback</span>(<span class="hljs-params">callback</span>) {
  scheduledCallback = callback;
  port.<span class="hljs-title function_">postMessage</span>(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 触发宏任务</span>
}

<span class="hljs-comment">// 6. 工作循环</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">initialTime</span>) {
  <span class="hljs-keyword">let</span> currentTime = initialTime;
  currentTask = <span class="hljs-title function_">peek</span>(taskQueue); <span class="hljs-comment">// 取优先级最高的任务</span>

  <span class="hljs-keyword">while</span> (currentTask !== <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 检查是否应该让出控制权</span>
    <span class="hljs-keyword">if</span> (currentTask.<span class="hljs-property">expirationTime</span> &gt; currentTime &amp;&amp; <span class="hljs-title function_">shouldYield</span>()) {
      <span class="hljs-comment">// 时间用完，但任务未过期 → 中断</span>
      <span class="hljs-keyword">break</span>;
    }

    <span class="hljs-keyword">const</span> callback = currentTask.<span class="hljs-property">callback</span>;
    <span class="hljs-keyword">if</span> (callback !== <span class="hljs-literal">null</span>) {
      currentTask.<span class="hljs-property">callback</span> = <span class="hljs-literal">null</span>;

      <span class="hljs-comment">// 执行任务</span>
      <span class="hljs-keyword">const</span> didUserCallbackTimeout = currentTask.<span class="hljs-property">expirationTime</span> &lt;= currentTime;
      <span class="hljs-keyword">const</span> continuationCallback = <span class="hljs-title function_">callback</span>(didUserCallbackTimeout);

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> continuationCallback === <span class="hljs-string">'function'</span>) {
        <span class="hljs-comment">// 任务返回函数 → 任务未完成，下次继续</span>
        currentTask.<span class="hljs-property">callback</span> = continuationCallback;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 任务完成，移出队列</span>
        <span class="hljs-keyword">if</span> (currentTask === <span class="hljs-title function_">peek</span>(taskQueue)) {
          <span class="hljs-title function_">pop</span>(taskQueue);
        }
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">pop</span>(taskQueue);
    }

    currentTask = <span class="hljs-title function_">peek</span>(taskQueue);
    currentTime = performance.<span class="hljs-title function_">now</span>();
  }

  <span class="hljs-comment">// 返回是否还有任务</span>
  <span class="hljs-keyword">return</span> currentTask !== <span class="hljs-literal">null</span>;
}
</code></pre>
<h3 data-id="heading-12">为什么用 MessageChannel 而不是 setTimeout？</h3>
<pre><code class="hljs language-javascript" lang="javascript">┌────────────────────────────────────────────────────────────┐
│            <span class="hljs-built_in">setTimeout</span> vs <span class="hljs-title class_">MessageChannel</span>                    │
├────────────────────────────────────────────────────────────┤
│                                                             │
│  <span class="hljs-built_in">setTimeout</span>(fn, <span class="hljs-number">0</span>)                                         │
│  ❌ 最小延迟 4ms（浏览器限制）                              │
│  ❌ 嵌套 <span class="hljs-number">5</span> 层后强制 4ms                                     │
│  ❌ 精度不够                                                │
│                                                             │
│  <span class="hljs-title class_">MessageChannel</span>                                            │
│  ✅ 宏任务，不受 4ms 限制                                   │
│  ✅ 精度更高                                                │
│  ✅ 可以立即执行                                            │
│                                                             │
│  requestIdleCallback                                       │
│  ❌ 兼容性差                                                │
│  ❌ 触发频率不稳定（可能 50ms+）                            │
│  ❌ 浏览器控制，不够可控                                    │
│                                                             │
└────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-13">任务优先级调度 {#任务调度}</h2>
<h3 data-id="heading-14">优先级系统设计</h3>
<p>React 使用 <strong>Lane 模型</strong>（车道模型）来表示优先级：</p>
<pre><code class="hljs language-scss" lang="scss">二进制车道模型（<span class="hljs-number">31</span> 位）：
┌────────────────────────────────────────────────────────────┐
│  <span class="hljs-number">0</span>b0000000000000000000000000000001  SyncLane (同步车道)    │
│  <span class="hljs-number">0</span>b0000000000000000000000000000010  InputContinuousLane    │
│  <span class="hljs-number">0</span>b0000000000000000000000000001000  DefaultLane            │
│  <span class="hljs-number">0</span>b0000000000000000000001000000000  TransitionLane         │
│  <span class="hljs-number">0</span>b0000000000000100000000000000000  RetryLane              │
│  <span class="hljs-number">0</span>b0001000000000000000000000000000  IdleLane (空闲车道)    │
└────────────────────────────────────────────────────────────┘

为什么用二进制？
✅ 按位或（|）可以合并多个优先级
✅ 按位与（&amp;）可以判断是否包含某个优先级
✅ 快速找到最高优先级（getHighestPriorityLane）
</code></pre>
<h3 data-id="heading-15">优先级分类与场景</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ============================================</span>
<span class="hljs-comment">// 优先级分类</span>
<span class="hljs-comment">// ============================================</span>

<span class="hljs-comment">// 1. 同步优先级（SyncLane）</span>
<span class="hljs-comment">// 场景：必须立即执行的更新</span>
<span class="hljs-comment">// - ReactDOM.render()</span>
<span class="hljs-comment">// - useEffect 的 cleanup</span>
<span class="hljs-comment">// - 错误边界</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleError</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 立即同步执行，不走调度</span>
  <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">flushSync</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setError</span>(<span class="hljs-literal">true</span>);
  });
}

<span class="hljs-comment">// 2. 输入连续优先级（InputContinuousLane）</span>
<span class="hljs-comment">// 场景：用户连续输入</span>
<span class="hljs-comment">// - onChange</span>
<span class="hljs-comment">// - onMouseMove</span>
<span class="hljs-comment">// - onScroll</span>
&lt;input onChange={<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-comment">// 高优先级，快速响应</span>
  <span class="hljs-title function_">setSearchText</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
}} /&gt;

<span class="hljs-comment">// 3. 默认优先级（DefaultLane）</span>
<span class="hljs-comment">// 场景：普通异步更新</span>
<span class="hljs-comment">// - 网络请求完成</span>
<span class="hljs-comment">// - setTimeout</span>
<span class="hljs-comment">// - useEffect 的副作用</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-title function_">setData</span>(data); <span class="hljs-comment">// 默认优先级</span>
  });
}, []);

<span class="hljs-comment">// 4. 过渡优先级（TransitionLane）</span>
<span class="hljs-comment">// 场景：可以延后的大量更新</span>
<span class="hljs-comment">// - 列表渲染</span>
<span class="hljs-comment">// - 页面切换动画</span>
<span class="hljs-keyword">import</span> { useTransition } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSearch</span> = (<span class="hljs-params">text</span>) =&gt; {
    <span class="hljs-comment">// 高优先级：立即更新输入框</span>
    <span class="hljs-title function_">setInputValue</span>(text);

    <span class="hljs-comment">// 低优先级：延后搜索结果渲染</span>
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setSearchResults</span>(<span class="hljs-title function_">filterData</span>(text)); <span class="hljs-comment">// 1000+ 条数据</span>
    });
  };
}

<span class="hljs-comment">// 5. 空闲优先级（IdleLane）</span>
<span class="hljs-comment">// 场景：可有可无的更新</span>
<span class="hljs-comment">// - 日志上报</span>
<span class="hljs-comment">// - 预加载</span>
</code></pre>
<h3 data-id="heading-16">优先级调度流程</h3>
<pre><code class="hljs language-ini" lang="ini">用户点击按钮（触发多个更新）
        ↓
┌──────────────────────────────────────────────────────────┐
│                更新队列（Update Queue）                   │
├──────────────────────────────────────────────────────────┤
│  Update1: <span class="hljs-attr">lane</span> = SyncLane        (输入框更新)            │
│  Update2: <span class="hljs-attr">lane</span> = DefaultLane     (网络请求结果)          │
│  Update3: <span class="hljs-attr">lane</span> = TransitionLane  (列表渲染)              │
└──────────────────────────────────────────────────────────┘
        ↓
ensureRootIsScheduled() // 确保根节点被调度
        ↓
┌──────────────────────────────────────────────────────────┐
│              计算下一个要处理的 Lane                      │
├──────────────────────────────────────────────────────────┤
│  getNextLanes(root, NoLanes)                             │
│    → 返回 SyncLane (最高优先级)                          │
└──────────────────────────────────────────────────────────┘
        ↓
根据 Lane 选择调度方式
        ↓
┌──────────────────────────────────────────────────────────┐
│  if (<span class="hljs-attr">lane</span> === SyncLane) {                                │
│    scheduleSyncCallback(performSyncWorkOnRoot)<span class="hljs-comment">;          │</span>
│    // 同步执行，不走调度器                                │
│  } else {                                                │
│    scheduleCallback(                                     │
│      lanesToSchedulerPriority(lane),                     │
│      performConcurrentWorkOnRoot                         │
│    )<span class="hljs-comment">;                                                    │</span>
│    // 异步执行，进入 Scheduler 调度                       │
│  }                                                       │
└──────────────────────────────────────────────────────────┘
        ↓
进入 Render 阶段（只处理当前 Lane 的更新）
        ↓
如果渲染过程中有更高优先级的更新插入
        ↓
┌──────────────────────────────────────────────────────────┐
│  if (newLane 优先级更高) {                                │
│    // 丢弃当前工作（workInProgress）                      │
│    <span class="hljs-attr">workInProgress</span> = null<span class="hljs-comment">;                                │</span>
│    // 重新调度                                            │
│    ensureRootIsScheduled(root)<span class="hljs-comment">;                          │</span>
│  }                                                       │
└──────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-17">优先级饥饿问题的解决</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 问题：低优先级任务可能永远得不到执行</span>

<span class="hljs-comment">// 解决方案：过期时间 (Expiration Time)</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">markStarvedLanesAsExpired</span>(<span class="hljs-params">root, currentTime</span>) {
  <span class="hljs-keyword">const</span> pendingLanes = root.<span class="hljs-property">pendingLanes</span>;
  <span class="hljs-keyword">const</span> expirationTimes = root.<span class="hljs-property">expirationTimes</span>;

  <span class="hljs-keyword">let</span> lanes = pendingLanes;
  <span class="hljs-keyword">while</span> (lanes &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> index = <span class="hljs-title function_">pickArbitraryLaneIndex</span>(lanes);
    <span class="hljs-keyword">const</span> lane = <span class="hljs-number">1</span> &lt;&lt; index;
    <span class="hljs-keyword">const</span> expirationTime = expirationTimes[index];

    <span class="hljs-keyword">if</span> (expirationTime === <span class="hljs-title class_">NoTimestamp</span>) {
      <span class="hljs-comment">// 首次进入，设置过期时间</span>
      expirationTimes[index] = <span class="hljs-title function_">computeExpirationTime</span>(lane, currentTime);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (expirationTime &lt;= currentTime) {
      <span class="hljs-comment">// 已过期 → 提升为同步优先级</span>
      root.<span class="hljs-property">expiredLanes</span> |= lane;
    }

    lanes &amp;= ~lane; <span class="hljs-comment">// 移除已检查的 lane</span>
  }
}

<span class="hljs-comment">// 过期时间计算（根据优先级）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">computeExpirationTime</span>(<span class="hljs-params">lane, currentTime</span>) {
  <span class="hljs-keyword">switch</span> (lane) {
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">SyncLane</span>:
      <span class="hljs-keyword">return</span> currentTime; <span class="hljs-comment">// 立即过期</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">InputContinuousLane</span>:
      <span class="hljs-keyword">return</span> currentTime + <span class="hljs-number">250</span>; <span class="hljs-comment">// 250ms</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">DefaultLane</span>:
      <span class="hljs-keyword">return</span> currentTime + <span class="hljs-number">5000</span>; <span class="hljs-comment">// 5s</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">TransitionLane</span>:
      <span class="hljs-keyword">return</span> currentTime + <span class="hljs-number">10000</span>; <span class="hljs-comment">// 10s</span>
    <span class="hljs-keyword">case</span> <span class="hljs-title class_">IdleLane</span>:
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">NoTimestamp</span>; <span class="hljs-comment">// 永不过期</span>
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-18">双缓存机制 {#双缓存}</h2>
<h3 data-id="heading-19">为什么需要双缓存？</h3>
<pre><code class="hljs language-python" lang="python">问题场景：渲染过程被中断
┌──────────────────────────────────────────────────────────┐
│  用户看到的 UI（当前 DOM）                                │
│  ┌────────┐  ┌────────┐                                  │
│  │ Header │  │  Body  │                                  │
│  └────────┘  └────────┘                                  │
└──────────────────────────────────────────────────────────┘
        ↓ 触发更新
┌──────────────────────────────────────────────────────────┐
│  React 正在构建新的 UI（<span class="hljs-number">50</span>% 完成）                        │
│  ┌────────┐  ┌────────┐  ┌─────                         │
│  │ Heade<span class="hljs-string">r'│  │  Body'</span> │  │ Footer (渲染中...)            │
│  └────────┘  └────────┘  └─────                         │
└──────────────────────────────────────────────────────────┘
        ↓ 高优先级任务插入，中断渲染

❌ 如果直接在当前树上修改 → 用户会看到半成品
✅ 双缓存：在内存中构建完整新树 → 原子切换
</code></pre>
<h3 data-id="heading-20">双缓存结构</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ============================================</span>
<span class="hljs-comment">// FiberRoot 结构</span>
<span class="hljs-comment">// ============================================</span>
<span class="hljs-keyword">const</span> fiberRoot = {
  <span class="hljs-comment">// 当前屏幕显示的树</span>
  <span class="hljs-attr">current</span>: currentFiber, <span class="hljs-comment">// HostRootFiber</span>

  <span class="hljs-comment">// 其他属性</span>
  <span class="hljs-attr">containerInfo</span>: domContainer, <span class="hljs-comment">// 真实 DOM 容器</span>
  <span class="hljs-attr">pendingLanes</span>: <span class="hljs-number">0b0000</span>, <span class="hljs-comment">// 待处理的优先级</span>
  <span class="hljs-attr">finishedWork</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 已完成的工作树</span>
};

<span class="hljs-comment">// ============================================</span>
<span class="hljs-comment">// Current 树与 WorkInProgress 树</span>
<span class="hljs-comment">// ============================================</span>

<span class="hljs-comment">// Current Fiber（当前显示的树）</span>
<span class="hljs-keyword">const</span> currentFiber = {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'div'</span>,
  <span class="hljs-attr">stateNode</span>: domNode, <span class="hljs-comment">// 指向真实 DOM</span>
  <span class="hljs-attr">child</span>: currentChildFiber,
  <span class="hljs-attr">alternate</span>: workInProgressFiber, <span class="hljs-comment">// 指向另一棵树</span>
  <span class="hljs-attr">memoizedState</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> }, <span class="hljs-comment">// 当前状态</span>
};

<span class="hljs-comment">// WorkInProgress Fiber（正在构建的树）</span>
<span class="hljs-keyword">const</span> workInProgressFiber = {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'div'</span>,
  <span class="hljs-attr">stateNode</span>: domNode, <span class="hljs-comment">// 复用 DOM 节点</span>
  <span class="hljs-attr">child</span>: workInProgressChildFiber,
  <span class="hljs-attr">alternate</span>: currentFiber, <span class="hljs-comment">// 指回 current 树</span>
  <span class="hljs-attr">memoizedState</span>: { <span class="hljs-attr">count</span>: <span class="hljs-number">1</span> }, <span class="hljs-comment">// 新状态</span>
  <span class="hljs-attr">flags</span>: <span class="hljs-title class_">Update</span>, <span class="hljs-comment">// 标记需要更新</span>
};
</code></pre>
<h3 data-id="heading-21">双缓存切换流程</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ============================================</span>
<span class="hljs-comment">// 完整的双缓存流程</span>
<span class="hljs-comment">// ============================================</span>

<span class="hljs-comment">// 1. 初始渲染（Mount）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">performSyncWorkOnRoot</span>(<span class="hljs-params">root</span>) {
  <span class="hljs-comment">// 创建 workInProgress 树</span>
  <span class="hljs-keyword">const</span> current = root.<span class="hljs-property">current</span>; <span class="hljs-comment">// HostRootFiber（空树）</span>
  <span class="hljs-keyword">const</span> workInProgress = <span class="hljs-title function_">createWorkInProgress</span>(current, <span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 开始构建</span>
  <span class="hljs-title function_">renderRootSync</span>(root, workInProgress);

  <span class="hljs-comment">// 构建完成</span>
  root.<span class="hljs-property">finishedWork</span> = workInProgress;

  <span class="hljs-comment">// 提交阶段</span>
  <span class="hljs-title function_">commitRoot</span>(root);
}

<span class="hljs-comment">// 2. createWorkInProgress（创建或复用）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createWorkInProgress</span>(<span class="hljs-params">current, pendingProps</span>) {
  <span class="hljs-keyword">let</span> workInProgress = current.<span class="hljs-property">alternate</span>;

  <span class="hljs-keyword">if</span> (workInProgress === <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 首次渲染：创建新 Fiber</span>
    workInProgress = <span class="hljs-title function_">createFiber</span>(
      current.<span class="hljs-property">tag</span>,
      pendingProps,
      current.<span class="hljs-property">key</span>,
      current.<span class="hljs-property">mode</span>
    );

    <span class="hljs-comment">// 建立双向链接</span>
    workInProgress.<span class="hljs-property">alternate</span> = current;
    current.<span class="hljs-property">alternate</span> = workInProgress;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 更新：复用上次的 workInProgress</span>
    workInProgress.<span class="hljs-property">pendingProps</span> = pendingProps;
    workInProgress.<span class="hljs-property">flags</span> = <span class="hljs-title class_">NoFlags</span>; <span class="hljs-comment">// 清空副作用</span>
    workInProgress.<span class="hljs-property">subtreeFlags</span> = <span class="hljs-title class_">NoFlags</span>;
  }

  <span class="hljs-comment">// 复用不变的属性</span>
  workInProgress.<span class="hljs-property">child</span> = current.<span class="hljs-property">child</span>;
  workInProgress.<span class="hljs-property">memoizedProps</span> = current.<span class="hljs-property">memoizedProps</span>;
  workInProgress.<span class="hljs-property">memoizedState</span> = current.<span class="hljs-property">memoizedState</span>;
  workInProgress.<span class="hljs-property">updateQueue</span> = current.<span class="hljs-property">updateQueue</span>;

  <span class="hljs-keyword">return</span> workInProgress;
}

<span class="hljs-comment">// 3. commitRoot（原子切换）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitRoot</span>(<span class="hljs-params">root</span>) {
  <span class="hljs-keyword">const</span> finishedWork = root.<span class="hljs-property">finishedWork</span>;

  <span class="hljs-comment">// Before Mutation 阶段</span>
  <span class="hljs-title function_">commitBeforeMutationEffects</span>(finishedWork);

  <span class="hljs-comment">// Mutation 阶段（修改真实 DOM）</span>
  <span class="hljs-title function_">commitMutationEffects</span>(finishedWork, root);

  <span class="hljs-comment">// ✨ 关键：切换 current 指针（原子操作）</span>
  root.<span class="hljs-property">current</span> = finishedWork;

  <span class="hljs-comment">// Layout 阶段（执行生命周期）</span>
  <span class="hljs-title function_">commitLayoutEffects</span>(finishedWork, root);
}
</code></pre>
<h3 data-id="heading-22">双缓存优化：复用 Fiber 节点</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ============================================</span>
<span class="hljs-comment">// Diff 算法中的 Fiber 复用</span>
<span class="hljs-comment">// ============================================</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reconcileChildFibers</span>(<span class="hljs-params">
  returnFiber,
  currentFirstChild,
  newChild
</span>) {
  <span class="hljs-comment">// 场景 1：单节点 Diff</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> newChild === <span class="hljs-string">'object'</span> &amp;&amp; newChild !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (newChild.<span class="hljs-property">key</span> !== <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 尝试复用</span>
      <span class="hljs-keyword">const</span> existing = currentFirstChild;

      <span class="hljs-keyword">if</span> (
        existing !== <span class="hljs-literal">null</span> &amp;&amp;
        existing.<span class="hljs-property">key</span> === newChild.<span class="hljs-property">key</span> &amp;&amp;
        existing.<span class="hljs-property">type</span> === newChild.<span class="hljs-property">type</span>
      ) {
        <span class="hljs-comment">// ✅ 可以复用！</span>
        <span class="hljs-keyword">const</span> clone = <span class="hljs-title function_">useFiber</span>(existing, newChild.<span class="hljs-property">props</span>);
        clone.<span class="hljs-property">return</span> = returnFiber;
        <span class="hljs-keyword">return</span> clone;
      }
    }
  }

  <span class="hljs-comment">// 场景 2：多节点 Diff</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(newChild)) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">reconcileChildrenArray</span>(
      returnFiber,
      currentFirstChild,
      newChild
    );
  }

  <span class="hljs-comment">// 无法复用：创建新 Fiber</span>
  <span class="hljs-keyword">const</span> created = <span class="hljs-title function_">createFiberFromElement</span>(newChild);
  created.<span class="hljs-property">return</span> = returnFiber;
  <span class="hljs-keyword">return</span> created;
}

<span class="hljs-comment">// useFiber：复用 Fiber 节点</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useFiber</span>(<span class="hljs-params">fiber, pendingProps</span>) {
  <span class="hljs-keyword">const</span> clone = <span class="hljs-title function_">createWorkInProgress</span>(fiber, pendingProps);
  clone.<span class="hljs-property">index</span> = <span class="hljs-number">0</span>;
  clone.<span class="hljs-property">sibling</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">return</span> clone;
}
</code></pre>
<h3 data-id="heading-23">内存占用分析</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>              <span class="hljs-string">双缓存的内存开销</span>                               <span class="hljs-string">│</span>
<span class="hljs-string">├────────────────────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span>                                                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">假设组件树有</span> <span class="hljs-number">1000</span> <span class="hljs-string">个节点</span>                                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">单树内存占用：</span>                                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-number">1000</span> <span class="hljs-string">节点</span> <span class="hljs-string">×</span> <span class="hljs-string">约</span> <span class="hljs-number">200</span> <span class="hljs-string">字节/节点</span> <span class="hljs-string">=</span> <span class="hljs-string">200KB</span>                     <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">双树内存占用：</span>                                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">Current</span> <span class="hljs-string">树:</span> <span class="hljs-string">200KB</span>                                        <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">WorkInProgress</span> <span class="hljs-string">树:</span> <span class="hljs-string">200KB</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">总计:</span> <span class="hljs-string">400KB</span>                                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">✅</span> <span class="hljs-string">优化点：</span>                                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">stateNode（真实</span> <span class="hljs-string">DOM）是共享的，不重复</span>                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">没有变化的子树可以共享（通过</span> <span class="hljs-string">alternate</span> <span class="hljs-string">指针）</span>         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">实际占用</span> <span class="hljs-string">&lt;</span> <span class="hljs-number">2</span> <span class="hljs-string">倍</span>                                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                             <span class="hljs-string">│</span>
<span class="hljs-string">└────────────────────────────────────────────────────────────┘</span>
</code></pre>
<hr/>
<h2 data-id="heading-24">架构设计思想提炼 {#架构思想}</h2>
<h3 data-id="heading-25">1. 将递归转为循环（可控性）</h3>
<pre><code class="hljs language-scss" lang="scss">设计模式：Continuation-Passing Style (CPS)

❌ 递归调用栈（不可控）：
function <span class="hljs-built_in">traverse</span>(node) {
  if (node.children) {
    node<span class="hljs-selector-class">.children</span><span class="hljs-selector-class">.forEach</span>(traverse); <span class="hljs-comment">// 深度递归</span>
  }
}

✅ 显式维护工作栈（可控）：
function <span class="hljs-built_in">traverseIterative</span>(root) {
  const stack = <span class="hljs-selector-attr">[root]</span>;

  while (stack.length &gt; <span class="hljs-number">0</span>) {
    const node = stack<span class="hljs-selector-class">.pop</span>();

    <span class="hljs-comment">// ✨ 可以在这里中断</span>
    if (shouldPause()) {
      <span class="hljs-built_in">saveState</span>(stack);
      return; <span class="hljs-comment">// 下次继续</span>
    }

    if (node.children) {
      stack<span class="hljs-selector-class">.push</span>(...node.children);
    }
  }
}

应用场景：
- 大型数据结构遍历
- 复杂计算任务拆分
- 游戏引擎的渲染循环
</code></pre>
<h3 data-id="heading-26">2. 优先级调度系统</h3>
<pre><code class="hljs language-diff" lang="diff">设计模式：优先级队列 + 动态调度

核心组件：
┌────────────────────────────────────────────────────────────┐
│  1. 任务队列（Priority Queue / Min Heap）                  │
│     - 按优先级排序                                          │
│     - O(log n) 插入和删除                                   │
│                                                             │
│  2. 优先级计算器（Priority Calculator）                    │
│     - 根据任务类型分配初始优先级                            │
│     - 动态调整（防止饥饿）                                  │
│                                                             │
│  3. 调度器（Scheduler）                                     │
│     - 时间切片                                              │
│     - 抢占式调度                                            │
│                                                             │
│  4. 任务执行器（Task Executor）                             │
│     - 可中断/恢复                                           │
│     - 返回延续（Continuation）                              │
└────────────────────────────────────────────────────────────┘

应用场景：
<span class="hljs-deletion">- 前端任务调度（动画、网络请求、用户交互）</span>
<span class="hljs-deletion">- 后端任务队列（消息队列、作业调度）</span>
<span class="hljs-deletion">- 操作系统进程调度</span>
</code></pre>
<h3 data-id="heading-27">3. 双缓冲技术</h3>
<pre><code class="hljs language-markdown" lang="markdown">设计模式：Double Buffering

原理：
┌────────────────────────────────────────────────────────────┐
│  Buffer A（前台）          Buffer B（后台）                │
│  ┌─────────────┐          ┌─────────────┐                 │
│  │ 当前显示    │          │ 正在构建    │                 │
│  │ 的内容      │          │ 的内容      │                 │
│  └─────────────┘          └─────────────┘                 │
│        ↓                        ↓                          │
│     用户可见              用户不可见                       │
└────────────────────────────────────────────────────────────┘
<span class="hljs-code">                    ↓ 构建完成
┌────────────────────────────────────────────────────────────┐
│  指针交换（原子操作）                                       │
│  Buffer A ←→ Buffer B                                      │
└────────────────────────────────────────────────────────────┘
</span>
应用场景：
<span class="hljs-bullet">-</span> 游戏渲染（避免画面撕裂）
<span class="hljs-bullet">-</span> 视频播放（平滑切换帧）
<span class="hljs-bullet">-</span> 数据库事务（MVCC 多版本并发控制）
<span class="hljs-bullet">-</span> 编辑器（Undo/Redo）
</code></pre>
<h3 data-id="heading-28">4. 时间切片 + 协同式多任务</h3>
<pre><code class="hljs language-scss" lang="scss">设计模式：Cooperative Multitasking

对比：
┌────────────────────────────────────────────────────────────┐
│  抢占式多任务（Preemptive）                                │
│  - 操作系统强制中断任务                                    │
│  - 任务不需要主动让出                                      │
│  - 需要操作系统支持                                        │
│                                                             │
│  协同式多任务（Cooperative）                               │
│  - 任务主动检查并让出控制权                                │
│  - <span class="hljs-built_in">shouldYield</span>() → 返回控制权                              │
│  - 适合单线程环境（如浏览器主线程）                        │
└────────────────────────────────────────────────────────────┘

实现模式：
function* <span class="hljs-built_in">longRunningTask</span>() {
  for (let i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
    <span class="hljs-built_in">doWork</span>(i);

    if (i % <span class="hljs-number">100</span> === <span class="hljs-number">0</span> &amp;&amp; shouldYield()) {
      yield; <span class="hljs-comment">// 让出控制权</span>
    }
  }
}

const task = <span class="hljs-built_in">longRunningTask</span>();

function <span class="hljs-built_in">workLoop</span>() {
  while (!task.next()<span class="hljs-selector-class">.done</span> &amp;&amp; !<span class="hljs-built_in">shouldYield</span>()) {
    <span class="hljs-comment">// 继续执行</span>
  }

  if (!task.done) {
    <span class="hljs-built_in">requestIdleCallback</span>(workLoop); <span class="hljs-comment">// 下一帧继续</span>
  }
}
</code></pre>
<h3 data-id="heading-29">5. 链表数据结构的妙用</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">Fiber 链表的优势：
┌────────────────────────────────────────────────────────────┐
│  <span class="hljs-number">1.</span> 内存友好                                                │
│     - 不需要额外的栈空间                                    │
│     - 避免递归调用栈溢出                                    │
│                                                             │
│  <span class="hljs-number">2.</span> 灵活遍历                                                │
│     - 可以从任意节点开始                                    │
│     - 支持双向遍历（child/<span class="hljs-keyword">return</span>）                          │
│                                                             │
│  <span class="hljs-number">3.</span> 可中断                                                  │
│     - 保存当前节点指针即可恢复                              │
│     - 不需要保存整个调用栈                                  │
│                                                             │
│  <span class="hljs-number">4.</span> 支持优先级                                              │
│     - 可以跳过低优先级子树                                  │
│     - 动态调整遍历路径                                      │
└────────────────────────────────────────────────────────────┘

对比树结构：
<span class="hljs-comment">// 树：自上而下，必须遍历所有子节点</span>
{
  children: [child1, child2, child3]
}

<span class="hljs-comment">// 链表：灵活控制遍历路径</span>
{
  child: firstChild,      <span class="hljs-comment">// 只存第一个子节点</span>
  sibling: nextSibling,   <span class="hljs-comment">// 兄弟节点</span>
  <span class="hljs-keyword">return</span>: parent          <span class="hljs-comment">// 父节点</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-30">实际应用场景 {#应用场景}</h2>
<h3 data-id="heading-31">场景 1：大列表优化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ============================================</span>
<span class="hljs-comment">// 问题：渲染 10000 条数据导致页面卡顿</span>
<span class="hljs-comment">// ============================================</span>

<span class="hljs-comment">// ❌ 传统做法：一次性渲染所有数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">BadList</span>(<span class="hljs-params">{ items }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {items.map(item =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">ListItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{item}</span> /&gt;</span>)}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
  <span class="hljs-comment">// 💥 10000 个组件同时渲染 → 阻塞主线程</span>
}

<span class="hljs-comment">// ✅ 方案 1：使用 useTransition（利用 Fiber 的优先级调度）</span>
<span class="hljs-keyword">import</span> { useState, useTransition } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">GoodList</span>(<span class="hljs-params">{ items }</span>) {
  <span class="hljs-keyword">const</span> [filteredItems, setFilteredItems] = <span class="hljs-title function_">useState</span>(items);
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFilter</span> = (<span class="hljs-params">keyword</span>) =&gt; {
    <span class="hljs-comment">// 高优先级：立即更新输入框</span>
    <span class="hljs-title function_">setKeyword</span>(keyword);

    <span class="hljs-comment">// 低优先级：延后列表过滤</span>
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> filtered = items.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span>
        item.<span class="hljs-property">name</span>.<span class="hljs-title function_">includes</span>(keyword)
      );
      <span class="hljs-title function_">setFilteredItems</span>(filtered);
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> handleFilter(e.target.value)} /&gt;
      {isPending &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Spinner</span> /&gt;</span>}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        {filteredItems.map(item =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">ListItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{item}</span> /&gt;</span>)}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}

<span class="hljs-comment">// ✅ 方案 2：虚拟列表（只渲染可见区域）</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">FixedSizeList</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-window'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">VirtualList</span>(<span class="hljs-params">{ items }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">FixedSizeList</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{600}</span>
      <span class="hljs-attr">itemCount</span>=<span class="hljs-string">{items.length}</span>
      <span class="hljs-attr">itemSize</span>=<span class="hljs-string">{50}</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span>
    &gt;</span>
      {({ index, style }) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{style}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">ListItem</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{items[index]}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/<span class="hljs-name">FixedSizeList</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-32">场景 2：搜索框优化（防抖 + 优先级）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ============================================</span>
<span class="hljs-comment">// 问题：用户输入时触发大量搜索请求</span>
<span class="hljs-comment">// ============================================</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchBox</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [inputValue, setInputValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [searchResults, setSearchResults] = <span class="hljs-title function_">useState</span>([]);
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-keyword">const</span> value = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;

    <span class="hljs-comment">// 高优先级：立即更新输入框（用户必须看到输入）</span>
    <span class="hljs-title function_">setInputValue</span>(value);

    <span class="hljs-comment">// 低优先级：搜索结果可以延后</span>
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 模拟大量计算或网络请求</span>
      <span class="hljs-keyword">const</span> results = <span class="hljs-title function_">performExpensiveSearch</span>(value);
      <span class="hljs-title function_">setSearchResults</span>(results);
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{inputValue}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span>
        <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"搜索..."</span>
      /&gt;</span>
      {isPending &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Spinner</span> /&gt;</span>}
      <span class="hljs-tag">&lt;<span class="hljs-name">SearchResults</span> <span class="hljs-attr">results</span>=<span class="hljs-string">{searchResults}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}

<span class="hljs-comment">// Fiber 的作用：</span>
<span class="hljs-comment">// 1. 输入框更新是 InputContinuousLane（高优先级），立即响应</span>
<span class="hljs-comment">// 2. 搜索结果是 TransitionLane（低优先级），可被中断</span>
<span class="hljs-comment">// 3. 如果用户继续输入，会中断之前的搜索渲染，开始新的搜索</span>
</code></pre>
<h3 data-id="heading-33">场景 3：动画 + 数据更新</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ============================================</span>
<span class="hljs-comment">// 问题：数据更新导致动画卡顿</span>
<span class="hljs-comment">// ============================================</span>

<span class="hljs-keyword">import</span> { useState, useDeferredValue } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">AnimatedDashboard</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [data, setData] = <span class="hljs-title function_">useState</span>(initialData);

  <span class="hljs-comment">// 延迟的数据（低优先级）</span>
  <span class="hljs-keyword">const</span> deferredData = <span class="hljs-title function_">useDeferredValue</span>(data);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {/* 高优先级：动画始终流畅 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">AnimatedChart</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{data}</span> /&gt;</span>

      {/* 低优先级：数据表格可以延后渲染 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">DataTable</span> <span class="hljs-attr">data</span>=<span class="hljs-string">{deferredData}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}

<span class="hljs-comment">// useDeferredValue 原理：</span>
<span class="hljs-comment">// 1. 返回一个"延迟"的值</span>
<span class="hljs-comment">// 2. 当有高优先级更新时，延迟值不会立即更新</span>
<span class="hljs-comment">// 3. 等高优先级任务完成后，再用 TransitionLane 更新延迟值</span>
</code></pre>
<h3 data-id="heading-34">场景 4：自定义任务调度器</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ============================================</span>
<span class="hljs-comment">// 在你的项目中实现类似 Fiber 的调度</span>
<span class="hljs-comment">// ============================================</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskScheduler</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">frameDeadline</span> = <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">// 调度任务</span>
  <span class="hljs-title function_">scheduleTask</span>(<span class="hljs-params">task, priority = <span class="hljs-string">'normal'</span></span>) {
    <span class="hljs-keyword">const</span> taskObj = {
      task,
      priority,
      <span class="hljs-attr">expirationTime</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">calculateExpiration</span>(priority)
    };

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-title function_">push</span>(taskObj);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">expirationTime</span> - b.<span class="hljs-property">expirationTime</span>);

    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">start</span>();
    }
  }

  <span class="hljs-title function_">calculateExpiration</span>(<span class="hljs-params">priority</span>) {
    <span class="hljs-keyword">const</span> now = performance.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">switch</span> (priority) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'immediate'</span>:
        <span class="hljs-keyword">return</span> now;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'high'</span>:
        <span class="hljs-keyword">return</span> now + <span class="hljs-number">250</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'normal'</span>:
        <span class="hljs-keyword">return</span> now + <span class="hljs-number">5000</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'low'</span>:
        <span class="hljs-keyword">return</span> now + <span class="hljs-number">10000</span>;
      <span class="hljs-attr">default</span>:
        <span class="hljs-keyword">return</span> now + <span class="hljs-number">5000</span>;
    }
  }

  <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">workLoop</span>();
  }

  <span class="hljs-title function_">shouldYield</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> performance.<span class="hljs-title function_">now</span>() &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">frameDeadline</span>;
  }

  <span class="hljs-title function_">workLoop</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">frameDeadline</span> = performance.<span class="hljs-title function_">now</span>() + <span class="hljs-number">5</span>; <span class="hljs-comment">// 5ms 时间切片</span>

    <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; !<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">shouldYield</span>()) {
      <span class="hljs-keyword">const</span> taskObj = <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-title function_">shift</span>();

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> result = taskObj.<span class="hljs-title function_">task</span>();

        <span class="hljs-comment">// 如果任务返回函数，说明未完成</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'function'</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-title function_">unshift</span>({
            <span class="hljs-attr">task</span>: result,
            <span class="hljs-attr">priority</span>: taskObj.<span class="hljs-property">priority</span>,
            <span class="hljs-attr">expirationTime</span>: taskObj.<span class="hljs-property">expirationTime</span>
          });
        }
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Task error:'</span>, error);
      }
    }

    <span class="hljs-comment">// 还有任务，继续调度</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskQueue</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">workLoop</span>());
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRunning</span> = <span class="hljs-literal">false</span>;
    }
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> scheduler = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskScheduler</span>();

<span class="hljs-comment">// 高优先级任务</span>
scheduler.<span class="hljs-title function_">scheduleTask</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'处理用户输入'</span>);
}, <span class="hljs-string">'high'</span>);

<span class="hljs-comment">// 低优先级任务（可拆分）</span>
<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title function_">processData</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 处理 100 条数据</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
    <span class="hljs-keyword">if</span> (index &gt;= data.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 完成</span>
    <span class="hljs-title function_">processItem</span>(data[index++]);
  }

  <span class="hljs-comment">// 返回函数表示还有任务</span>
  <span class="hljs-keyword">return</span> processData;
};

scheduler.<span class="hljs-title function_">scheduleTask</span>(processData, <span class="hljs-string">'low'</span>);
</code></pre>
<hr/>
<h2 data-id="heading-35">总结：架构设计的核心启示</h2>
<pre><code class="hljs language-php" lang="php">┌─────────────────────────────────────────────────────────────────┐
│                  <span class="hljs-built_in">Fiber</span> 架构的设计智慧                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  <span class="hljs-number">1</span>. 问题拆解                                                     │
│     将大任务拆解为小单元 → 可控、可中断                         │
│                                                                  │
│  <span class="hljs-number">2</span>. 优先级思维                                                   │
│     不是所有任务都同等重要 → 区分轻重缓急                       │
│                                                                  │
│  <span class="hljs-number">3</span>. 空间换时间                                                   │
│     双缓存多占内存 → 换取流畅体验                               │
│                                                                  │
│  <span class="hljs-number">4</span>. 延迟计算                                                     │
│     不急的任务可以延后 → 先保证核心体验                         │
│                                                                  │
│  <span class="hljs-number">5</span>. 数据结构选择                                                 │
│     递归 → 链表 → 可控性质变                                    │
│                                                                  │
│  <span class="hljs-number">6</span>. 协同式设计                                                   │
│     主动让出控制权 → 在约束条件下达成目标                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p>通过学习 Fiber 架构，你可以将这些思想应用到：</p>
<ul>
<li><strong>前端性能优化</strong>：长列表、复杂交互</li>
<li><strong>后端任务调度</strong>：消息队列、作业系统</li>
<li><strong>系统设计</strong>：分布式任务调度、流量控制</li>
<li><strong>游戏开发</strong>：游戏循环、渲染管线</li>
</ul>
<p>核心理念：<strong>在约束条件下（单线程），通过合理的架构设计（拆分、调度、双缓存）实现复杂目标（流畅体验）</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[六、React 并发模式：让应用"感觉"更快的架构智慧]]></title>    <link>https://juejin.cn/post/7576479344039100468</link>    <guid>https://juejin.cn/post/7576479344039100468</guid>    <pubDate>2025-11-25T13:08:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576479344039100468" data-draft-id="7576484465758666787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="六、React 并发模式：让应用&quot;感觉&quot;更快的架构智慧"/> <meta itemprop="keywords" content="前端,架构,React.js"/> <meta itemprop="datePublished" content="2025-11-25T13:08:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小璞"/> <meta itemprop="url" content="https://juejin.cn/user/1609340755378829"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            六、React 并发模式：让应用"感觉"更快的架构智慧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1609340755378829/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小璞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T13:08:19.000Z" title="Tue Nov 25 2025 13:08:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">核心问题：如何让应用感觉更快？</h2>
<h3 data-id="heading-1">问题场景：卡顿的搜索体验</h3>
<p>想象一个搜索场景：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [results, setResults] = <span class="hljs-title function_">useState</span>([]);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-keyword">const</span> value = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
    <span class="hljs-title function_">setQuery</span>(value);

    <span class="hljs-comment">// 搜索并渲染 10000 条结果</span>
    <span class="hljs-keyword">const</span> newResults = <span class="hljs-title function_">searchDatabase</span>(value); <span class="hljs-comment">// 假设返回 10000 条</span>
    <span class="hljs-title function_">setResults</span>(newResults);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ResultList</span> <span class="hljs-attr">results</span>=<span class="hljs-string">{results}</span> /&gt;</span> {/* 渲染 10000 个项目 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>用户体验问题：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">用户输入 <span class="hljs-string">"R"</span> → 等待 <span class="hljs-number">300</span>ms → 输入框卡住 → 终于显示 <span class="hljs-string">"R"</span>
                    ↑
                渲染 <span class="hljs-number">10000</span> 个结果导致阻塞
</code></pre>
<p><strong>为什么会卡顿？</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">┌──────────────────────────────────────────────────┐
│  JavaScript 单线程特性                            │
├──────────────────────────────────────────────────┤
│  输入 <span class="hljs-string">"R"</span>                                         │
│    ↓                                              │
│  触发 onChange                                    │
│    ↓                                              │
│  更新 <span class="hljs-keyword">query</span> + results                            │
│    ↓                                              │
│  React 开始渲染 <span class="hljs-number">10000</span> 个结果  ← 阻塞在这里！     │
│    ↓ (<span class="hljs-number">300</span>ms)                                     │
│  渲染完成                                         │
│    ↓                                              │
│  更新 DOM                                         │
│    ↓                                              │
│  输入框才能响应下一个输入                         │
└──────────────────────────────────────────────────┘

问题：渲染结果列表阻塞了输入框的更新
</code></pre>
<hr/>
<h2 data-id="heading-2">传统解决方案 vs React 并发模式</h2>
<h3 data-id="heading-3">方案 1：防抖（Debounce）</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [results, setResults] = <span class="hljs-title function_">useState</span>([]);

  <span class="hljs-comment">// 延迟 300ms 才搜索</span>
  <span class="hljs-keyword">const</span> debouncedSearch = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> newResults = <span class="hljs-title function_">searchDatabase</span>(value);
      <span class="hljs-title function_">setResults</span>(newResults);
    }, <span class="hljs-number">300</span>),
    []
  );

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-keyword">const</span> value = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
    <span class="hljs-title function_">setQuery</span>(value);  <span class="hljs-comment">// 立即更新输入框</span>
    <span class="hljs-title function_">debouncedSearch</span>(value);  <span class="hljs-comment">// 延迟搜索</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ResultList</span> <span class="hljs-attr">results</span>=<span class="hljs-string">{results}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>✅ 输入不卡了</li>
<li>❌ 结果延迟显示（用户快速输入时看不到反馈）</li>
<li>❌ 治标不治本（只是推迟了问题）</li>
</ul>
<hr/>
<h3 data-id="heading-4">方案 2：Web Worker</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 在 Worker 中搜索</span>
<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'search-worker.js'</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-keyword">const</span> value = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
    <span class="hljs-title function_">setQuery</span>(value);
    worker.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">query</span>: value });
  };

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    worker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-title function_">setResults</span>(e.<span class="hljs-property">data</span>.<span class="hljs-property">results</span>);
    };
  }, []);
}
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>✅ 搜索不阻塞主线程</li>
<li>❌ 渲染 10000 个结果仍然阻塞（问题没解决）</li>
<li>❌ 增加了复杂度（Worker 通信）</li>
</ul>
<hr/>
<h3 data-id="heading-5">方案 3：React 并发模式</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [results, setResults] = <span class="hljs-title function_">useState</span>([]);
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-keyword">const</span> value = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;

    <span class="hljs-comment">// 高优先级：立即更新输入框</span>
    <span class="hljs-title function_">setQuery</span>(value);

    <span class="hljs-comment">// 低优先级：可中断的结果更新</span>
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> newResults = <span class="hljs-title function_">searchDatabase</span>(value);
      <span class="hljs-title function_">setResults</span>(newResults);
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> /&gt;</span>
      {isPending &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>搜索中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
      <span class="hljs-tag">&lt;<span class="hljs-name">ResultList</span> <span class="hljs-attr">results</span>=<span class="hljs-string">{results}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>效果：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">用户输入 <span class="hljs-string">"R"</span> → 立即显示 <span class="hljs-string">"R"</span> → 显示<span class="hljs-string">"搜索中..."</span> → 逐步渲染结果
     ↑              ↑                ↑
  立即响应      不阻塞输入        可中断渲染
</code></pre>
<p><strong>优势：</strong></p>
<ul>
<li>✅ 输入框立即响应（高优先级）</li>
<li>✅ 结果逐步渲染（可中断）</li>
<li>✅ 新输入可以打断旧渲染（自动取消）</li>
<li>✅ 无需改变代码结构（简单）</li>
</ul>
<hr/>
<h2 data-id="heading-6">架构核心：优先级系统</h2>
<h3 data-id="heading-7">现实类比：医院急诊室</h3>
<pre><code class="hljs language-less" lang="less">传统 <span class="hljs-selector-tag">React</span>（先到先服务）:
  患者 <span class="hljs-selector-tag">A</span>：感冒（等待）
  患者 <span class="hljs-selector-tag">B</span>：骨折（等待）
  患者 <span class="hljs-selector-tag">C</span>：心脏病（等待）← 危急！但要排队

  问题：心脏病患者可能等死

并发模式（优先级调度）:
  患者 <span class="hljs-selector-tag">C</span>：心脏病（立即处理！）← 最高优先级
  患者 <span class="hljs-selector-tag">B</span>：骨折（等待中...）
  患者 <span class="hljs-selector-tag">A</span>：感冒（可以等）← 如果有紧急情况，重新排队

  优势：关键任务优先
</code></pre>
<hr/>
<h3 data-id="heading-8">React 的优先级分类</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// React 内部的优先级系统（简化）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Priority</span> = {
  <span class="hljs-comment">// 立即同步（最高优先级）</span>
  <span class="hljs-title class_">ImmediatePriority</span>: <span class="hljs-number">1</span>,
  <span class="hljs-comment">// 用户交互（如 click, input）</span>
  <span class="hljs-title class_">UserBlockingPriority</span>: <span class="hljs-number">2</span>,
  <span class="hljs-comment">// 正常更新（如 setState）</span>
  <span class="hljs-title class_">NormalPriority</span>: <span class="hljs-number">3</span>,
  <span class="hljs-comment">// 低优先级（如 analytics）</span>
  <span class="hljs-title class_">LowPriority</span>: <span class="hljs-number">4</span>,
  <span class="hljs-comment">// 闲置时（如 preload）</span>
  <span class="hljs-title class_">IdlePriority</span>: <span class="hljs-number">5</span>,
};
</code></pre>
<p><strong>不同更新的优先级：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 高优先级：用户输入</span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setQuery(e.target.value)} /&gt;</span>

  <span class="hljs-comment">// 低优先级：搜索结果</span>
  <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setResults</span>(<span class="hljs-title function_">search</span>(query));
  });

  <span class="hljs-comment">// 正常优先级：普通状态更新</span>
  <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-9">可中断渲染：架构的核心创新</h2>
<h3 data-id="heading-10">传统渲染：一旦开始，无法停止</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">传统渲染流程（同步、阻塞）</span>                  <span class="hljs-string">│</span>
<span class="hljs-string">├─────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span>  <span class="hljs-string">开始渲染</span> <span class="hljs-number">10000</span> <span class="hljs-string">个组件</span>                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">↓</span>                                         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">渲染第</span> <span class="hljs-number">1</span> <span class="hljs-string">个</span>   <span class="hljs-string">─┐</span>                           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">渲染第</span> <span class="hljs-number">2</span> <span class="hljs-string">个</span>    <span class="hljs-string">│</span>                           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">渲染第</span> <span class="hljs-number">3</span> <span class="hljs-string">个</span>    <span class="hljs-string">│</span> <span class="hljs-string">必须全部完成！</span>            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">...</span>            <span class="hljs-string">│</span> <span class="hljs-string">无法中断！</span>                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">渲染第</span> <span class="hljs-number">9999</span> <span class="hljs-string">个</span> <span class="hljs-string">│</span>                           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">渲染第</span> <span class="hljs-number">10000</span> <span class="hljs-string">个┘</span>                           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">↓</span>                                         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">提交到</span> <span class="hljs-string">DOM</span>                                  <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────┘</span>

<span class="hljs-string">期间：用户点击、输入都无响应（卡死）</span>
</code></pre>
<hr/>
<h3 data-id="heading-11">并发渲染：可以暂停、继续、丢弃</h3>
<pre><code class="hljs">┌─────────────────────────────────────────────┐
│  并发渲染流程（异步、可中断）                │
├─────────────────────────────────────────────┤
│  开始渲染 10000 个组件（低优先级）           │
│    ↓                                         │
│  渲染第 1-100 个                             │
│    ↓                                         │
│  让出控制权（检查是否有紧急任务）           │
│    ↓                                         │
│  【用户输入！】← 高优先级任务来了           │
│    ↓                                         │
│  暂停当前渲染 ┐                             │
│  处理用户输入 │ 优先处理紧急任务            │
│  更新输入框   ┘                             │
│    ↓                                         │
│  继续渲染第 101-200 个                      │
│    ↓                                         │
│  【又有新输入！】← 再次中断                 │
│    ↓                                         │
│  丢弃旧渲染工作 ← 因为数据过期了            │
│  重新开始渲染新结果                         │
└─────────────────────────────────────────────┘

关键：渲染过程中可以随时响应用户
</code></pre>
<hr/>
<h3 data-id="heading-12">实现原理：时间切片（Time Slicing）</h3>
<p><strong>核心思想：把长任务拆成小块，每块执行后让出控制权</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统同步渲染（伪代码）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderSync</span>(<span class="hljs-params">components</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; components.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-title function_">renderComponent</span>(components[i]);  <span class="hljs-comment">// 阻塞！</span>
  }
  <span class="hljs-title function_">commitToDOM</span>();
}

<span class="hljs-comment">// 耗时：300ms 连续阻塞</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 并发渲染（伪代码）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderConcurrent</span>(<span class="hljs-params">components</span>) {
  <span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> deadline = <span class="hljs-number">5</span>;  <span class="hljs-comment">// 每 5ms 让出控制权</span>

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">startTime</span>) {
    <span class="hljs-keyword">while</span> (i &lt; components.<span class="hljs-property">length</span>) {
      <span class="hljs-title function_">renderComponent</span>(components[i]);
      i++;

      <span class="hljs-comment">// 检查是否超时</span>
      <span class="hljs-keyword">if</span> (performance.<span class="hljs-title function_">now</span>() - startTime &gt; deadline) {
        <span class="hljs-comment">// 让出控制权，浏览器可以响应用户</span>
        scheduler.<span class="hljs-title function_">scheduleCallback</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-title function_">workLoop</span>(performance.<span class="hljs-title function_">now</span>());
        });
        <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 暂停渲染</span>
      }
    }

    <span class="hljs-comment">// 所有组件渲染完成</span>
    <span class="hljs-title function_">commitToDOM</span>();
  }

  <span class="hljs-title function_">workLoop</span>(performance.<span class="hljs-title function_">now</span>());
}

<span class="hljs-comment">// 耗时：300ms 总计，但每 5ms 可以响应用户</span>
</code></pre>
<p><strong>时间分配：</strong></p>
<pre><code class="hljs language-css" lang="css">传统渲染：
<span class="hljs-selector-attr">[========== 300ms 阻塞 ==========]</span> → DOM 更新
  ↑
  期间无法响应用户

并发渲染：
<span class="hljs-selector-attr">[5ms 渲染]</span><span class="hljs-selector-attr">[响应用户]</span><span class="hljs-selector-attr">[5ms 渲染]</span><span class="hljs-selector-attr">[响应用户]</span>...<span class="hljs-selector-attr">[5ms 渲染]</span> → DOM 更新
  ↑         ↑         ↑         ↑            ↑
  可以随时处理用户交互
</code></pre>
<hr/>
<h2 data-id="heading-13">Fiber 架构：可中断渲染的基础</h2>
<h3 data-id="heading-14">问题：如何实现可中断？</h3>
<p><strong>传统递归渲染：无法中断</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">renderTree</span>(<span class="hljs-params">element</span>) {
  <span class="hljs-comment">// 递归渲染子节点</span>
  element.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">child</span> =&gt;</span> {
    <span class="hljs-title function_">renderTree</span>(child);  <span class="hljs-comment">// 递归调用，无法中断</span>
  });
  <span class="hljs-title function_">renderElement</span>(element);
}

<span class="hljs-comment">// 问题：递归调用栈，中断后无法恢复</span>
</code></pre>
<hr/>
<h3 data-id="heading-15">Fiber：链表结构 + 迭代渲染</h3>
<p><strong>核心思想：把树形结构转换为链表，用迭代代替递归</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Fiber 节点结构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FiberNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">element</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> = element.<span class="hljs-property">type</span>;        <span class="hljs-comment">// 组件类型</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span> = element.<span class="hljs-property">props</span>;      <span class="hljs-comment">// 属性</span>

    <span class="hljs-comment">// 链表指针（关键！）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">child</span> = <span class="hljs-literal">null</span>;               <span class="hljs-comment">// 第一个子节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sibling</span> = <span class="hljs-literal">null</span>;             <span class="hljs-comment">// 下一个兄弟节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">return</span> = <span class="hljs-literal">null</span>;              <span class="hljs-comment">// 父节点</span>

    <span class="hljs-comment">// 渲染状态</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">alternate</span> = <span class="hljs-literal">null</span>;           <span class="hljs-comment">// 上一次的 Fiber（用于 Diff）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">effectTag</span> = <span class="hljs-literal">null</span>;           <span class="hljs-comment">// 标记需要的 DOM 操作</span>
  }
}
</code></pre>
<p><strong>树转链表示例：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// JSX 树</span>
&lt;<span class="hljs-title class_">App</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Content</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Article</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Sidebar</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Content</span>&gt;</span></span>
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Footer</span> /&gt;</span></span>
&lt;/<span class="hljs-title class_">App</span>&gt;
</code></pre>
<pre><code class="hljs language-scss" lang="scss">Fiber 链表结构：

       App
        ↓ child
      <span class="hljs-selector-tag">Header</span> → <span class="hljs-attribute">Content</span> → <span class="hljs-selector-tag">Footer</span>
      (返回)   ↓ child   (返回)
              <span class="hljs-selector-tag">Article</span> → Sidebar
              (返回)    (返回)

每个节点有三个指针：
  child:   指向第一个子节点
  sibling: 指向下一个兄弟
  return:  指向父节点（用于回溯）
</code></pre>
<hr/>
<h3 data-id="heading-16">迭代渲染：可以随时暂停</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 可中断的渲染循环</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">workLoop</span>(<span class="hljs-params">deadline</span>) {
  <span class="hljs-keyword">let</span> shouldYield = <span class="hljs-literal">false</span>;

  <span class="hljs-keyword">while</span> (currentFiber &amp;&amp; !shouldYield) {
    <span class="hljs-comment">// 处理当前 Fiber 节点</span>
    currentFiber = <span class="hljs-title function_">performUnitOfWork</span>(currentFiber);

    <span class="hljs-comment">// 检查是否应该让出控制权</span>
    shouldYield = deadline.<span class="hljs-title function_">timeRemaining</span>() &lt; <span class="hljs-number">1</span>;
  }

  <span class="hljs-comment">// 如果还有工作未完成，继续调度</span>
  <span class="hljs-keyword">if</span> (currentFiber) {
    <span class="hljs-title function_">requestIdleCallback</span>(workLoop);  <span class="hljs-comment">// 下一帧继续</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">commitRoot</span>();  <span class="hljs-comment">// 所有工作完成，提交到 DOM</span>
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">performUnitOfWork</span>(<span class="hljs-params">fiber</span>) {
  <span class="hljs-comment">// 1. 渲染当前节点</span>
  <span class="hljs-title function_">reconcileChildren</span>(fiber);

  <span class="hljs-comment">// 2. 返回下一个要处理的节点（深度优先遍历）</span>
  <span class="hljs-keyword">if</span> (fiber.<span class="hljs-property">child</span>) {
    <span class="hljs-keyword">return</span> fiber.<span class="hljs-property">child</span>;  <span class="hljs-comment">// 优先处理子节点</span>
  }

  <span class="hljs-keyword">let</span> nextFiber = fiber;
  <span class="hljs-keyword">while</span> (nextFiber) {
    <span class="hljs-keyword">if</span> (nextFiber.<span class="hljs-property">sibling</span>) {
      <span class="hljs-keyword">return</span> nextFiber.<span class="hljs-property">sibling</span>;  <span class="hljs-comment">// 处理兄弟节点</span>
    }
    nextFiber = nextFiber.<span class="hljs-property">return</span>;  <span class="hljs-comment">// 回到父节点</span>
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 所有节点处理完成</span>
}
</code></pre>
<p><strong>可中断的关键：</strong></p>
<ol>
<li><strong>迭代代替递归</strong>：可以保存进度（currentFiber）</li>
<li><strong>显式调度</strong>：每个单元后检查是否超时</li>
<li><strong>链表结构</strong>：知道下一个要处理的节点</li>
</ol>
<hr/>
<h2 data-id="heading-17">双缓冲（Double Buffering）：保证一致性</h2>
<h3 data-id="heading-18">问题：渲染到一半被中断，UI 怎么办？</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">场景：渲染</span> <span class="hljs-number">10000</span> <span class="hljs-string">个组件到一半（5000</span> <span class="hljs-string">个）时被中断</span>

<span class="hljs-string">如果直接更新</span> <span class="hljs-string">DOM：</span>
  <span class="hljs-string">✅</span> <span class="hljs-string">前</span> <span class="hljs-number">5000</span> <span class="hljs-string">个：新数据</span>
  <span class="hljs-string">❌</span> <span class="hljs-string">后</span> <span class="hljs-number">5000</span> <span class="hljs-string">个：旧数据</span>
  <span class="hljs-string">→</span> <span class="hljs-string">UI</span> <span class="hljs-string">不一致！用户看到混乱的界面</span>
</code></pre>
<hr/>
<h3 data-id="heading-19">双缓冲机制：在内存中完成所有工作</h3>
<pre><code class="hljs language-php" lang="php">┌────────────────────────────────────────────┐
│  双缓冲架构                                 │
├────────────────────────────────────────────┤
│                                             │
│  当前显示的 <span class="hljs-built_in">Fiber</span> 树（current）             │
│    用户正在看的界面                         │
│         ↕ alternate 指针                    │
│  正在构建的 <span class="hljs-built_in">Fiber</span> 树（workInProgress）      │
│    后台构建，完成后一次性切换               │
│                                             │
└────────────────────────────────────────────┘
</code></pre>
<p><strong>工作流程：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 阶段 1：渲染阶段（可中断）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderPhase</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 在 workInProgress 树上工作</span>
  <span class="hljs-keyword">let</span> fiber = workInProgress;

  <span class="hljs-keyword">while</span> (fiber) {
    <span class="hljs-comment">// 渲染节点</span>
    <span class="hljs-title function_">reconcile</span>(fiber);

    <span class="hljs-comment">// 可以随时中断</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">shouldYield</span>()) {
      <span class="hljs-keyword">return</span>;  <span class="hljs-comment">// 暂停，稍后继续</span>
    }

    fiber = <span class="hljs-title function_">getNextFiber</span>(fiber);
  }

  <span class="hljs-comment">// 所有节点渲染完成，进入提交阶段</span>
  <span class="hljs-title function_">commitPhase</span>();
}

<span class="hljs-comment">// 阶段 2：提交阶段（不可中断）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">commitPhase</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 一次性应用所有变更到 DOM</span>
  <span class="hljs-title function_">applyEffects</span>(workInProgress);

  <span class="hljs-comment">// 交换指针：workInProgress 变成 current</span>
  current = workInProgress;
  workInProgress = current.<span class="hljs-property">alternate</span>;
}
</code></pre>
<p><strong>关键特性：</strong></p>
<ol>
<li><strong>渲染阶段</strong>：可中断，在内存中工作</li>
<li><strong>提交阶段</strong>：不可中断，快速同步（通常 &lt; 16ms）</li>
<li><strong>切换瞬间</strong>：用户看不到中间状态</li>
</ol>
<hr/>
<h2 data-id="heading-20">useTransition：优先级的具体应用</h2>
<h3 data-id="heading-21">API 使用</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> [results, setResults] = <span class="hljs-title function_">useState</span>([]);

  <span class="hljs-comment">// 获取 transition 工具</span>
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-keyword">const</span> value = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;

    <span class="hljs-comment">// 高优先级：立即更新</span>
    <span class="hljs-title function_">setQuery</span>(value);

    <span class="hljs-comment">// 低优先级：可中断的更新</span>
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> newResults = <span class="hljs-title function_">heavySearch</span>(value);
      <span class="hljs-title function_">setResults</span>(newResults);
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> /&gt;</span>

      {/* 显示加载状态 */}
      {isPending &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Spinner</span> /&gt;</span>}

      <span class="hljs-tag">&lt;<span class="hljs-name">ResultList</span> <span class="hljs-attr">results</span>=<span class="hljs-string">{results}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h3 data-id="heading-22">工作原理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// useTransition 内部实现（简化）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">useTransition</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [isPending, setIsPending] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">startTransition</span> = (<span class="hljs-params">callback</span>) =&gt; {
    <span class="hljs-comment">// 1. 标记开始</span>
    <span class="hljs-title function_">setIsPending</span>(<span class="hljs-literal">true</span>);

    <span class="hljs-comment">// 2. 降低优先级</span>
    <span class="hljs-keyword">const</span> prevPriority = <span class="hljs-title function_">getCurrentPriority</span>();
    <span class="hljs-title function_">setCurrentPriority</span>(<span class="hljs-title class_">Priority</span>.<span class="hljs-property">TransitionPriority</span>);

    <span class="hljs-comment">// 3. 执行回调（状态更新会被标记为低优先级）</span>
    <span class="hljs-title function_">callback</span>();

    <span class="hljs-comment">// 4. 恢复优先级</span>
    <span class="hljs-title function_">setCurrentPriority</span>(prevPriority);

    <span class="hljs-comment">// 5. 当低优先级更新完成后，标记结束</span>
    <span class="hljs-title function_">scheduleCallback</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setIsPending</span>(<span class="hljs-literal">false</span>);
    });
  };

  <span class="hljs-keyword">return</span> [isPending, startTransition];
}
</code></pre>
<hr/>
<h3 data-id="heading-23">完整交互流程</h3>
<pre><code class="hljs language-sql" lang="sql">时间轴：用户输入 "React"

t<span class="hljs-operator">=</span><span class="hljs-number">0</span>ms: 用户输入 "R"
  ↓
  setQuery("R")                    ← 高优先级
  startTransition(() <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> {
    setResults(<span class="hljs-keyword">search</span>("R"))        ← 低优先级
  })
  ↓
  输入框立即显示 "R"
  isPending <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>（显示 loading）
  开始渲染 <span class="hljs-keyword">search</span>("R") 的结果

t<span class="hljs-operator">=</span><span class="hljs-number">50</span>ms: 用户输入 "e"（渲染到一半）
  ↓
  setQuery("Re")                   ← 高优先级（中断！）
  startTransition(() <span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> {
    setResults(<span class="hljs-keyword">search</span>("Re"))       ← 新的低优先级
  })
  ↓
  丢弃 <span class="hljs-keyword">search</span>("R") 的渲染工作
  输入框立即更新为 "Re"
  重新开始渲染 <span class="hljs-keyword">search</span>("Re") 的结果

t<span class="hljs-operator">=</span><span class="hljs-number">100</span>ms: 用户输入 "a"（又渲染到一半）
  ↓
  （重复上面的过程）

t<span class="hljs-operator">=</span><span class="hljs-number">500</span>ms: 用户停止输入（"React"）
  ↓
  <span class="hljs-keyword">search</span>("React") 的渲染完成
  提交到 DOM
  isPending <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>（隐藏 loading）
  用户看到最终结果
</code></pre>
<p><strong>关键观察：</strong></p>
<ul>
<li>输入框始终即时响应（0ms 延迟）</li>
<li>结果渲染可以被中断和重新开始</li>
<li>用户看到的是流畅的输入体验</li>
</ul>
<hr/>
<h2 data-id="heading-24">对比：有无并发模式</h2>
<h3 data-id="heading-25">场景：输入搜索，渲染 10000 个结果</h3>
<p><strong>不使用 useTransition：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
  <span class="hljs-keyword">const</span> value = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
  <span class="hljs-title function_">setQuery</span>(value);
  <span class="hljs-title function_">setResults</span>(<span class="hljs-title function_">search</span>(value));  <span class="hljs-comment">// 阻塞！</span>
};

<span class="hljs-comment">// 用户体验：</span>
输入 <span class="hljs-string">"R"</span> → 卡住 300ms → 看到 <span class="hljs-string">"R"</span> 和结果
输入 <span class="hljs-string">"e"</span> → 卡住 300ms → 看到 <span class="hljs-string">"Re"</span> 和结果
输入 <span class="hljs-string">"a"</span> → 卡住 300ms → 看到 <span class="hljs-string">"Rea"</span> 和结果

总计：900ms 的卡顿
感受：应用很卡
</code></pre>
<p><strong>使用 useTransition：</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
  <span class="hljs-keyword">const</span> value = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>;
  <span class="hljs-title function_">setQuery</span>(value);  <span class="hljs-comment">// 立即</span>
  <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setResults</span>(<span class="hljs-title function_">search</span>(value));  <span class="hljs-comment">// 可中断</span>
  });
};

<span class="hljs-comment">// 用户体验：</span>
输入 <span class="hljs-string">"R"</span> → 立即看到 <span class="hljs-string">"R"</span> → 逐步看到结果
输入 <span class="hljs-string">"e"</span> → 立即看到 <span class="hljs-string">"Re"</span> → 中断旧渲染，渲染新结果
输入 <span class="hljs-string">"a"</span> → 立即看到 <span class="hljs-string">"Rea"</span> → 中断旧渲染，渲染新结果

总计：0ms 的输入延迟，结果逐步显示
感受：应用很流畅
</code></pre>
<hr/>
<h2 data-id="heading-26">架构设计的核心智慧</h2>
<h3 data-id="heading-27">1. 用户感知 &gt; 实际性能</h3>
<p><strong>核心理念：不是让代码跑得更快，而是让用户感觉更快</strong></p>
<pre><code class="hljs language-css" lang="css">方案 <span class="hljs-selector-tag">A</span>：总耗时 <span class="hljs-number">300ms</span>，但阻塞
  用户感受：卡顿 ⭐⭐☆☆☆

方案 <span class="hljs-selector-tag">B</span>：总耗时 <span class="hljs-number">400ms</span>，但不阻塞关键交互
  用户感受：流畅 ⭐⭐⭐⭐⭐
</code></pre>
<p><strong>人类感知的特点：</strong></p>
<ul>
<li><strong>即时反馈阈值</strong>：&lt; 100ms 感觉即时</li>
<li><strong>注意力持续时间</strong>：1 秒内需要反馈</li>
<li><strong>视觉暂留</strong>：16ms（60fps）内的变化平滑</li>
</ul>
<p><strong>架构应对：</strong></p>
<ul>
<li>关键交互 &lt; 100ms：用高优先级保证</li>
<li>复杂渲染 &gt; 1s：拆成小块，显示进度</li>
<li>保持 60fps：每帧 &lt; 16ms 工作量</li>
</ul>
<hr/>
<h3 data-id="heading-28">2. 优先级驱动的架构</h3>
<p><strong>传统架构：平等对待所有任务</strong></p>
<pre><code class="hljs language-css" lang="css">任务队列：<span class="hljs-selector-attr">[A, B, C, D, E]</span>
处理顺序：先进先出（FIFO）

问题：不区分重要性
</code></pre>
<p><strong>优先级架构：关键任务优先</strong></p>
<pre><code class="hljs language-css" lang="css">任务队列：
  Lane <span class="hljs-number">1</span>（最高）：<span class="hljs-selector-attr">[用户输入]</span>
  Lane <span class="hljs-number">2</span>（高）：  <span class="hljs-selector-attr">[动画]</span>
  Lane <span class="hljs-number">3</span>（中）：  <span class="hljs-selector-attr">[数据加载]</span>
  Lane <span class="hljs-number">4</span>（低）：  <span class="hljs-selector-attr">[预加载]</span>

处理顺序：高优先级优先，低优先级可中断
</code></pre>
<p><strong>类比：操作系统的进程调度</strong></p>
<pre><code class="hljs">OS 调度：
  实时进程：最高优先级（硬件中断）
  交互进程：高优先级（用户交互）
  批处理：  低优先级（后台任务）

React 调度：
  同步更新：最高优先级（用户输入）
  紧急更新：高优先级（动画）
  过渡更新：低优先级（搜索结果）
</code></pre>
<hr/>
<h3 data-id="heading-29">3. 可中断 = 可控制</h3>
<p><strong>不可中断系统：</strong></p>
<pre><code class="hljs">开始任务 → 必须完成 → 无法响应新需求

特点：
  ✅ 简单
  ❌ 不灵活
  ❌ 无法应对变化
</code></pre>
<p><strong>可中断系统：</strong></p>
<pre><code class="hljs">开始任务 → 检查优先级 → 暂停/继续/丢弃 → 灵活响应

特点：
  ❌ 复杂（需要保存状态）
  ✅ 灵活（可以随时调整）
  ✅ 响应快（优先处理重要任务）
</code></pre>
<p><strong>架构代价：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">为了支持可中断，需要：
<span class="hljs-bullet">  1.</span> 链表结构（Fiber）：保存遍历进度
<span class="hljs-bullet">  2.</span> 双缓冲（current/workInProgress）：保证一致性
<span class="hljs-bullet">  3.</span> 优先级系统（Lanes）：决定执行顺序
<span class="hljs-bullet">  4.</span> 调度器（Scheduler）：管理任务执行

复杂度增加 10 倍，但用户体验提升 10 倍
</code></pre>
<hr/>
<h3 data-id="heading-30">4. 分阶段提交：权衡灵活性与一致性</h3>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────┐
│  Render 阶段（可中断）                   │
│    <span class="hljs-operator">-</span> 纯计算                              │
│    <span class="hljs-operator">-</span> 可以暂停、继续、丢弃                │
│    <span class="hljs-operator">-</span> 不产生副作用                        │
│    <span class="hljs-operator">-</span> 在内存中工作                        │
├─────────────────────────────────────────┤
│  <span class="hljs-keyword">Commit</span> 阶段（不可中断）                 │
│    <span class="hljs-operator">-</span> 操作 DOM                            │
│    <span class="hljs-operator">-</span> 执行副作用（useEffect）             │
│    <span class="hljs-operator">-</span> 必须一次性完成                      │
│    <span class="hljs-operator">-</span> 用户可见的变化                      │
└─────────────────────────────────────────┘
</code></pre>
<p><strong>设计智慧：</strong></p>
<ul>
<li><strong>Render 可中断</strong>：需要灵活性的地方灵活</li>
<li><strong>Commit 不可中断</strong>：需要一致性的地方严格</li>
<li><strong>最小化 Commit 时间</strong>：控制在 16ms 内</li>
</ul>
<hr/>
<h2 data-id="heading-31">实战案例：Tab 切换优化</h2>
<h3 data-id="heading-32">场景：切换 Tab 时渲染大量内容</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">TabApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [tab, setTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'tab1'</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Tabs</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{tab}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{setTab}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Tab</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab1"</span>&gt;</span>Tab 1<span class="hljs-tag">&lt;/<span class="hljs-name">Tab</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Tab</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab2"</span>&gt;</span>Tab 2<span class="hljs-tag">&lt;/<span class="hljs-name">Tab</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Tab</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab3"</span>&gt;</span>Tab 3<span class="hljs-tag">&lt;/<span class="hljs-name">Tab</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Tabs</span>&gt;</span>

      {tab === 'tab1' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">HeavyContent1</span> /&gt;</span>}  {/* 5000 个组件 */}
      {tab === 'tab2' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">HeavyContent2</span> /&gt;</span>}  {/* 5000 个组件 */}
      {tab === 'tab3' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">HeavyContent3</span> /&gt;</span>}  {/* 5000 个组件 */}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>问题：点击 Tab 后卡顿 500ms</strong></p>
<hr/>
<h3 data-id="heading-33">优化方案 1：传统防抖（不够好）</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">TabApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [tab, setTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'tab1'</span>);
  <span class="hljs-keyword">const</span> [displayTab, setDisplayTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'tab1'</span>);

  <span class="hljs-keyword">const</span> debouncedSwitch = <span class="hljs-title function_">useMemo</span>(
    <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">newTab</span>) =&gt;</span> {
      <span class="hljs-title function_">setDisplayTab</span>(newTab);
    }, <span class="hljs-number">300</span>),
    []
  );

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTabChange</span> = (<span class="hljs-params">newTab</span>) =&gt; {
    <span class="hljs-title function_">setTab</span>(newTab);  <span class="hljs-comment">// Tab 立即高亮</span>
    <span class="hljs-title function_">debouncedSwitch</span>(newTab);  <span class="hljs-comment">// 内容延迟切换</span>
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Tabs</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{tab}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleTabChange}</span>&gt;</span>
        {/* ... */}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Tabs</span>&gt;</span>
      {displayTab === 'tab1' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">HeavyContent1</span> /&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 问题：</span>
<span class="hljs-comment">// - Tab 高亮了，但内容还是旧的（不一致）</span>
<span class="hljs-comment">// - 300ms 后突然切换（跳变）</span>
</code></pre>
<hr/>
<h3 data-id="heading-34">优化方案 2：useTransition（完美）</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">TabApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [tab, setTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'tab1'</span>);
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTabChange</span> = (<span class="hljs-params">newTab</span>) =&gt; {
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">setTab</span>(newTab);  <span class="hljs-comment">// 低优先级，可中断</span>
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Tabs</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{tab}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleTabChange}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Tab</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab1"</span>&gt;</span>Tab 1<span class="hljs-tag">&lt;/<span class="hljs-name">Tab</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Tab</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab2"</span>&gt;</span>Tab 2<span class="hljs-tag">&lt;/<span class="hljs-name">Tab</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Tab</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tab3"</span>&gt;</span>Tab 3<span class="hljs-tag">&lt;/<span class="hljs-name">Tab</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Tabs</span>&gt;</span>

      {/* 显示加载状态 */}
      {isPending &amp;&amp; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"tab-loading"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Spinner</span> /&gt;</span>
          正在加载...
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}

      {/* 渐进渲染内容 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isPending</span> ? <span class="hljs-attr">0.6</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>
        {tab === 'tab1' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">HeavyContent1</span> /&gt;</span>}
        {tab === 'tab2' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">HeavyContent2</span> /&gt;</span>}
        {tab === 'tab3' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">HeavyContent3</span> /&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// 效果：</span>
<span class="hljs-comment">// 1. 点击 Tab → 立即高亮</span>
<span class="hljs-comment">// 2. 显示 loading 状态</span>
<span class="hljs-comment">// 3. 逐步渲染新内容（可中断）</span>
<span class="hljs-comment">// 4. 完成后淡入显示</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// 用户体验：流畅，有反馈，可预期</span>
</code></pre>
<hr/>
<h3 data-id="heading-35">进阶：useDeferredValue 的应用</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SearchApp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);

  <span class="hljs-comment">// 延迟更新的值（低优先级）</span>
  <span class="hljs-keyword">const</span> deferredQuery = <span class="hljs-title function_">useDeferredValue</span>(query);

  <span class="hljs-keyword">const</span> results = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">heavySearch</span>(deferredQuery);  <span class="hljs-comment">// 用延迟的值搜索</span>
  }, [deferredQuery]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {/* 输入框使用即时值 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setQuery(e.target.value)}
      /&gt;

      {/* 显示是否在加载 */}
      {query !== deferredQuery &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Spinner</span> /&gt;</span>}

      {/* 结果使用延迟值 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">ResultList</span> <span class="hljs-attr">results</span>=<span class="hljs-string">{results}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// useDeferredValue vs useTransition:</span>
<span class="hljs-comment">// - useDeferredValue: 延迟"值"，适合只读场景</span>
<span class="hljs-comment">// - useTransition: 延迟"更新"，适合状态变化</span>
</code></pre>
<hr/>
<h2 data-id="heading-36">性能对比：真实数据</h2>
<h3 data-id="heading-37">测试场景：渲染 10000 个列表项</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 测试组件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ListItem</span>(<span class="hljs-params">{ id, text }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{id}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{text}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">HeavyList</span>(<span class="hljs-params">{ items }</span>) {
  <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ListItem</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span> {<span class="hljs-attr">...item</span>} /&gt;</span></span>
  ));
}
</code></pre>
<p><strong>性能指标：</strong></p>



































<table><thead><tr><th>指标</th><th>不使用并发</th><th>使用 useTransition</th><th>改善</th></tr></thead><tbody><tr><td><strong>首次输入延迟</strong></td><td>350ms</td><td>5ms</td><td>70x</td></tr><tr><td><strong>总渲染时间</strong></td><td>350ms</td><td>380ms</td><td>-8%</td></tr><tr><td><strong>帧率（FPS）</strong></td><td>0 (阻塞)</td><td>55-60</td><td>∞</td></tr><tr><td><strong>用户感知评分</strong></td><td>2.1/5</td><td>4.6/5</td><td>2.2x</td></tr></tbody></table>
<p><strong>关键发现：</strong></p>
<ol>
<li>虽然总时间略增加（30ms），但用户感知大幅提升</li>
<li>输入延迟从 350ms 降到 5ms（关键指标）</li>
<li>保持流畅帧率，无卡顿感</li>
</ol>
<hr/>
<h2 data-id="heading-38">架构模式总结</h2>
<h3 data-id="heading-39">模式 1：优先级队列（Priority Queue）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统队列（FIFO）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskQueue</span> {
  queue = [];

  <span class="hljs-title function_">enqueue</span>(<span class="hljs-params">task</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">push</span>(task);
  }

  <span class="hljs-title function_">dequeue</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">shift</span>();  <span class="hljs-comment">// 先进先出</span>
  }
}

<span class="hljs-comment">// 优先级队列</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PriorityQueue</span> {
  lanes = {
    <span class="hljs-attr">sync</span>: [],       <span class="hljs-comment">// 优先级 1</span>
    <span class="hljs-attr">high</span>: [],       <span class="hljs-comment">// 优先级 2</span>
    <span class="hljs-attr">normal</span>: [],     <span class="hljs-comment">// 优先级 3</span>
    <span class="hljs-attr">low</span>: [],        <span class="hljs-comment">// 优先级 4</span>
  };

  <span class="hljs-title function_">enqueue</span>(<span class="hljs-params">task, priority</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">lanes</span>[priority].<span class="hljs-title function_">push</span>(task);
  }

  <span class="hljs-title function_">dequeue</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 优先处理高优先级</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lanes</span>.<span class="hljs-property">sync</span>.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">lanes</span>.<span class="hljs-property">sync</span>.<span class="hljs-title function_">shift</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lanes</span>.<span class="hljs-property">high</span>.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">lanes</span>.<span class="hljs-property">high</span>.<span class="hljs-title function_">shift</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lanes</span>.<span class="hljs-property">normal</span>.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">lanes</span>.<span class="hljs-property">normal</span>.<span class="hljs-title function_">shift</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">lanes</span>.<span class="hljs-property">low</span>.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">lanes</span>.<span class="hljs-property">low</span>.<span class="hljs-title function_">shift</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<p><strong>应用场景：</strong></p>
<ul>
<li>操作系统进程调度</li>
<li>网络请求优先级</li>
<li>任务调度系统</li>
</ul>
<hr/>
<h3 data-id="heading-40">模式 2：时间切片（Time Slicing）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 阻塞执行</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processAll</span>(<span class="hljs-params">tasks</span>) {
  tasks.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">task</span> =&gt;</span> {
    <span class="hljs-title function_">heavyWork</span>(task);  <span class="hljs-comment">// 阻塞直到完成</span>
  });
}

<span class="hljs-comment">// 时间切片</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processWithSlicing</span>(<span class="hljs-params">tasks, timeLimit = <span class="hljs-number">5</span></span>) {
  <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">processChunk</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>();

    <span class="hljs-keyword">while</span> (index &lt; tasks.<span class="hljs-property">length</span>) {
      <span class="hljs-title function_">heavyWork</span>(tasks[index]);
      index++;

      <span class="hljs-comment">// 超时，让出控制权</span>
      <span class="hljs-keyword">if</span> (performance.<span class="hljs-title function_">now</span>() - start &gt; timeLimit) {
        <span class="hljs-built_in">setTimeout</span>(processChunk, <span class="hljs-number">0</span>);  <span class="hljs-comment">// 下一帧继续</span>
        <span class="hljs-keyword">return</span>;
      }
    }

    <span class="hljs-comment">// 所有任务完成</span>
    <span class="hljs-title function_">onComplete</span>();
  }

  <span class="hljs-title function_">processChunk</span>();
}
</code></pre>
<p><strong>应用场景：</strong></p>
<ul>
<li>大文件处理</li>
<li>复杂计算分解</li>
<li>动画平滑过渡</li>
</ul>
<hr/>
<h3 data-id="heading-41">模式 3：双缓冲（Double Buffering）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 单缓冲（会闪烁）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderSingle</span>(<span class="hljs-params">canvas, data</span>) {
  canvas.<span class="hljs-title function_">clear</span>();          <span class="hljs-comment">// 清屏（用户看到空白）</span>
  canvas.<span class="hljs-title function_">draw</span>(data);       <span class="hljs-comment">// 绘制（用户看到绘制过程）</span>
  <span class="hljs-comment">// 问题：用户看到闪烁</span>
}

<span class="hljs-comment">// 双缓冲（无闪烁）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderDouble</span>(<span class="hljs-params">canvas, offscreenCanvas, data</span>) {
  <span class="hljs-comment">// 在后台缓冲区绘制</span>
  offscreenCanvas.<span class="hljs-title function_">clear</span>();
  offscreenCanvas.<span class="hljs-title function_">draw</span>(data);

  <span class="hljs-comment">// 一次性复制到前台（快速，&lt; 1ms）</span>
  canvas.<span class="hljs-title function_">copyFrom</span>(offscreenCanvas);

  <span class="hljs-comment">// 用户只看到完整画面</span>
}
</code></pre>
<p><strong>应用场景：</strong></p>
<ul>
<li>游戏渲染</li>
<li>视频播放</li>
<li>UI 框架（React Fiber）</li>
</ul>
<hr/>
<h2 data-id="heading-42">最佳实践</h2>
<h3 data-id="heading-43">1. 何时使用 useTransition</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ✅ 适合：非紧急的状态更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSearch</span> = (<span class="hljs-params">value</span>) =&gt; {
  <span class="hljs-title function_">setQuery</span>(value);  <span class="hljs-comment">// 紧急</span>
  <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setResults</span>(<span class="hljs-title function_">search</span>(value));  <span class="hljs-comment">// 非紧急</span>
  });
};

<span class="hljs-comment">// ✅ 适合：大列表渲染</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleTabChange</span> = (<span class="hljs-params">newTab</span>) =&gt; {
  <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setTab</span>(newTab);  <span class="hljs-comment">// 渲染可能很慢</span>
  });
};

<span class="hljs-comment">// ❌ 不适合：紧急更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleInputChange</span> = (<span class="hljs-params">e</span>) =&gt; {
  <span class="hljs-comment">// 不要用 transition 包裹用户输入！</span>
  <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setValue</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);  <span class="hljs-comment">// ❌ 会感觉延迟</span>
  });
};

<span class="hljs-comment">// ❌ 不适合：快速更新</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCounterClick</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>);  <span class="hljs-comment">// ❌ 没必要，本来就很快</span>
  });
};
</code></pre>
<hr/>
<h3 data-id="heading-44">2. 提供加载反馈</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">GoodExample</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>
        {isPending ? '加载中...' : '点击我'}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

      {/* 或使用骨架屏 */}
      {isPending ? <span class="hljs-tag">&lt;<span class="hljs-name">Skeleton</span> /&gt;</span> : <span class="hljs-tag">&lt;<span class="hljs-name">Content</span> /&gt;</span>}

      {/* 或降低透明度 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isPending</span> ? <span class="hljs-attr">0.6</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Content</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h3 data-id="heading-45">3. 配合 Suspense 使用</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [tab, setTab] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'home'</span>);
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Tabs</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{tab}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(v)</span> =&gt;</span> {
        startTransition(() =&gt; setTab(v));
      }} /&gt;

      {/* Suspense 捕获异步加载 */}
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">Spinner</span> /&gt;</span>}&gt;
        {isPending &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>正在切换...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}
        {tab === 'home' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Home</span> /&gt;</span>}
        {tab === 'profile' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Profile</span> /&gt;</span>}
        {tab === 'settings' &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Settings</span> /&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h2 data-id="heading-46">总结：架构设计的哲学</h2>
<p>并发模式教会我们：</p>
<h3 data-id="heading-47">1. 用户体验是第一优先级</h3>
<pre><code class="hljs language-markdown" lang="markdown">不是：让代码跑得更快
而是：让用户感觉更快

手段：
<span class="hljs-bullet">  -</span> 优先响应用户交互
<span class="hljs-bullet">  -</span> 提供即时反馈
<span class="hljs-bullet">  -</span> 避免长时间阻塞
</code></pre>
<hr/>
<h3 data-id="heading-48">2. 通过优先级区分重要性</h3>
<pre><code class="hljs">现实世界：
  急诊室：危重病人优先
  机场：头等舱优先登机
  高速路：救护车优先通行

软件系统：
  用户输入：立即响应
  动画：保持流畅
  后台任务：有空闲再做
</code></pre>
<hr/>
<h3 data-id="heading-49">3. 可中断 = 可控制</h3>
<pre><code class="hljs">同步系统：
  开始 → 完成
  特点：简单，但僵化

异步系统：
  开始 → 检查 → 暂停/继续/丢弃 → 完成
  特点：复杂，但灵活

权衡：
  为了灵活性，付出复杂度
  但收益巨大（用户体验）
</code></pre>
<hr/>
<h3 data-id="heading-50">4. 架构服务于目标</h3>
<pre><code class="hljs">目标：提升用户感知的流畅度

手段：
  ✅ 优先级系统（区分重要性）
  ✅ 可中断渲染（灵活响应）
  ✅ 时间切片（避免阻塞）
  ✅ 双缓冲（保证一致性）

代价：
  ❌ 架构复杂度增加
  ❌ 学习曲线陡峭
  ❌ 总耗时略增加

评估：收益远大于代价
</code></pre>
<hr/>
<h2 data-id="heading-51">最终启示</h2>
<blockquote>
<p><strong>并发模式不是技术炫技，而是以用户体验为中心的架构演进。</strong></p>
</blockquote>
<p>从今天开始，当你设计系统时，问自己：</p>
<ol>
<li><strong>什么是最重要的？</strong>（优先级）</li>
<li><strong>能否被打断？</strong>（可中断性）</li>
<li><strong>用户如何感知？</strong>（体验优先）</li>
<li><strong>如何保证一致性？</strong>（分阶段提交）</li>
</ol>
<p>这就是 React 并发模式给我们的架构智慧：</p>
<p><strong>不是让机器跑得更快，而是让人感觉更快。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[js 封装时间格式化，将单位有秒（s）的数据转换为'00:00:00'格式]]></title>    <link>https://juejin.cn/post/7576482238461394986</link>    <guid>https://juejin.cn/post/7576482238461394986</guid>    <pubDate>2025-11-25T15:46:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576482238461394986" data-draft-id="7576245169843830824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="js 封装时间格式化，将单位有秒（s）的数据转换为'00:00:00'格式"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-25T15:46:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Amy_yang"/> <meta itemprop="url" content="https://juejin.cn/user/254742430497304"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            js 封装时间格式化，将单位有秒（s）的数据转换为'00:00:00'格式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742430497304/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Amy_yang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T15:46:19.000Z" title="Tue Nov 25 2025 15:46:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript时间格式化实战：从代码解析到应用优化</h2>
<p>在前端开发中，时间格式化是一个高频需求。无论是视频播放时长、倒计时组件还是数据报表，都需要将原始的秒数转换为易读的时分秒格式。今天我们来深入分析一段实用的时间格式化代码，看看它是如何工作的，以及如何进一步优化提升。</p>
<h3 data-id="heading-1">代码功能解析：从秒数到时分秒的转换</h3>
<p>我们先来看这段代码的核心功能。两个函数：toTen 和 audioLangTimeFun，它们协同工作将秒数转换为 HH:MM:SS 格式的时间字符串。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不足十补0</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toTen</span> = (<span class="hljs-params">item</span>) =&gt; {
  <span class="hljs-keyword">return</span> item &gt; <span class="hljs-number">9</span> ? item : <span class="hljs-string">"0"</span> + item;
};

<span class="hljs-comment">// 时间计算为小时</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">audioLangTimeFun</span> = (<span class="hljs-params">second</span>) =&gt; {
  <span class="hljs-keyword">const</span> seconds = <span class="hljs-built_in">parseInt</span>(second);
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(seconds) || seconds &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"00:00:00"</span>;
  }
  <span class="hljs-keyword">const</span> minutes = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((seconds % <span class="hljs-number">3600</span>) / <span class="hljs-number">60</span>);
  <span class="hljs-keyword">const</span> remainingSeconds = seconds % <span class="hljs-number">60</span>;
  <span class="hljs-keyword">const</span> hours = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((seconds % (<span class="hljs-number">3600</span> * <span class="hljs-number">24</span>)) / <span class="hljs-number">3600</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${toTen(hours)}</span>:<span class="hljs-subst">${toTen(minutes)}</span>:<span class="hljs-subst">${toTen(remainingSeconds)}</span>`</span>;
};
</code></pre>
<p>这段代码的职责：toTen 负责数字格式化，确保每个时间单位都是两位数；audioLangTimeFun 则处理核心的时间计算逻辑。</p>
<h3 data-id="heading-2">实现原理：时间计算的数学逻辑</h3>
<p>要理解这段代码的工作原理，我们需要深入拆解时间单位之间的转换逻辑。时间计算本质上是对秒数进行除法和取余运算，从而得到各个时间单位的值</p>
<h3 data-id="heading-3">优化建议：让代码更上一层楼</h3>
<p>虽然这段代码已经能够完成基本的时间格式化功能，但还有一些可以优化的空间，使其更加健壮和灵活。</p>
<h4 data-id="heading-4">1. 函数命名优化</h4>
<p>函数名 audioLangTimeFun 过于具体，限制了函数的应用场景。建议重命名为更通用的 formatSecondsToTime，使其能在音频、视频、倒计时等多种场景中使用。</p>
<h4 data-id="heading-5">2. 支持天数显示</h4>
<p>我们可以增加一个参数来控制是否显示天数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">formatSecondsToTime</span> = (<span class="hljs-params">second, showDays = <span class="hljs-literal">false</span></span>) =&gt; {
  <span class="hljs-comment">// 原有代码...</span>
  <span class="hljs-keyword">if</span> (showDays &amp;&amp; days &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${days}</span>天 <span class="hljs-subst">${toTen(hours)}</span>:<span class="hljs-subst">${toTen(minutes)}</span>:<span class="hljs-subst">${toTen(remainingSeconds)}</span>`</span>;
  }
  <span class="hljs-comment">// 原有返回语句...</span>
};
</code></pre>
<h4 data-id="heading-6">3. 处理毫秒精度</h4>
<p>对于需要更高精度的场景，可以增加对毫秒的支持：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">formatSecondsToTime</span> = (<span class="hljs-params">second, showMs = <span class="hljs-literal">false</span></span>) =&gt; {
  <span class="hljs-comment">// 原有代码...</span>
  <span class="hljs-keyword">if</span> (showMs) {
    <span class="hljs-keyword">const</span> ms = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((second % <span class="hljs-number">1</span>) * <span class="hljs-number">1000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${toTen(hours)}</span>:<span class="hljs-subst">${toTen(minutes)}</span>:<span class="hljs-subst">${toTen(remainingSeconds)}</span>.<span class="hljs-subst">${ms.toString().padStart(<span class="hljs-number">3</span>, <span class="hljs-string">'0'</span>)}</span>`</span>;
  }
  <span class="hljs-comment">// 原有返回语句...</span>
};
</code></pre>
<h4 data-id="heading-7">4. 使用 padStart 简化补零逻辑</h4>
<p>toTen 函数可以用更现代的 padStart 方法简化：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">toTen</span> = (<span class="hljs-params">item</span>) =&gt; <span class="hljs-title class_">String</span>(item).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>);
</code></pre>
<p>不过需要注意，padStart 是 ES2017 引入的方法，对于需要支持非常旧的浏览器（如 IE）的项目，可能需要保留原有的三元运算符实现。</p>
<h3 data-id="heading-8">实际应用场景：时间格式化的广泛用途</h3>
<p>时间格式化在前端开发中有着广泛的应用，以下是几个常见场景：</p>
<h4 data-id="heading-9">1. 媒体播放器</h4>
<p>音频和视频播放器需要显示当前播放时间和总时长，这正是 audioLangTimeFun 函数最初设计的场景。通过监听媒体元素的 timeupdate 事件，可以实时更新显示的时间。</p>
<h4 data-id="heading-10">2. 倒计时组件</h4>
<p>在电商网站的促销活动、考试系统的答题计时等场景中，倒计时功能非常常见。我们可以稍作修改，使函数支持倒计时格式：</p>
<h4 data-id="heading-11">3. 数据可视化</h4>
<p>在数据报表和仪表盘上，经常需要将时间戳或持续时间以易读的格式展示。例如，将服务器响应时间从毫秒转换为 mm:ss.ms 格式。</p>
<h4 data-id="heading-12">4. 日历和日程应用</h4>
<p>在日历应用中，事件的持续时间通常需要格式化显示。例如，将 150 分钟显示为 2小时30分钟。</p>
<h3 data-id="heading-13">总结：时间格式化的最佳实践</h3>
<p>通过对这段时间格式化代码的深入分析，我们不仅理解了它的工作原理，还探讨了如何对其进行优化和扩展。好的时间格式化函数应该具备以下特点：</p>
<ol>
<li><strong>健壮性</strong>：能够处理各种输入，包括非数字和负数</li>
<li><strong>灵活性</strong>：支持不同的时间格式和显示选项</li>
<li><strong>可读性</strong>：代码清晰易懂，函数和变量命名恰当</li>
<li><strong>可维护性</strong>：结构合理，便于扩展和修改</li>
</ol>
<p>时间格式化看似简单，但要写出一个通用、高效、健壮的格式化函数并不容易。希望本文的分析和建议能帮助你在实际项目中更好地处理时间格式化问题。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 将秒数格式化为时分秒格式的时间字符串
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number|string</span>} <span class="hljs-variable">second</span> - 要格式化的秒数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} [options={}] - 格式化选项
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} [options.showDays=false] - 是否显示天数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">boolean</span>} [options.showMs=false] - 是否显示毫秒
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 格式化后的时间字符串
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">formatSecondsToTime</span> = (<span class="hljs-params">second, options = {}</span>) =&gt; {
  <span class="hljs-keyword">const</span> { showDays = <span class="hljs-literal">false</span>, showMs = <span class="hljs-literal">false</span> } = options;
  <span class="hljs-keyword">const</span> seconds = <span class="hljs-keyword">typeof</span> second === <span class="hljs-string">'string'</span> ? <span class="hljs-built_in">parseFloat</span>(second) : second;

  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(seconds) || seconds &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> showMs ? <span class="hljs-string">"00:00:00.000"</span> : <span class="hljs-string">"00:00:00"</span>;
  }

  <span class="hljs-keyword">const</span> days = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(seconds / (<span class="hljs-number">3600</span> * <span class="hljs-number">24</span>));
  <span class="hljs-keyword">const</span> hours = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((seconds % (<span class="hljs-number">3600</span> * <span class="hljs-number">24</span>)) / <span class="hljs-number">3600</span>);
  <span class="hljs-keyword">const</span> minutes = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((seconds % <span class="hljs-number">3600</span>) / <span class="hljs-number">60</span>);
  <span class="hljs-keyword">const</span> remainingSeconds = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(seconds % <span class="hljs-number">60</span>);
  <span class="hljs-keyword">const</span> ms = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((seconds % <span class="hljs-number">1</span>) * <span class="hljs-number">1000</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">pad</span> = (<span class="hljs-params">num</span>) =&gt; <span class="hljs-title class_">String</span>(num).<span class="hljs-title function_">padStart</span>(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>);
  <span class="hljs-keyword">let</span> result = <span class="hljs-string">`<span class="hljs-subst">${pad(hours)}</span>:<span class="hljs-subst">${pad(minutes)}</span>:<span class="hljs-subst">${pad(remainingSeconds)}</span>`</span>;

  <span class="hljs-keyword">if</span> (showMs) {
    result += <span class="hljs-string">`.<span class="hljs-subst">${<span class="hljs-built_in">String</span>(ms).padStart(<span class="hljs-number">3</span>, <span class="hljs-string">'0'</span>)}</span>`</span>;
  }

  <span class="hljs-keyword">if</span> (showDays &amp;&amp; days &gt; <span class="hljs-number">0</span>) {
    result = <span class="hljs-string">`<span class="hljs-subst">${days}</span>天 <span class="hljs-subst">${result}</span>`</span>;
  }

  <span class="hljs-keyword">return</span> result;
};
</code></pre>
<p>这个优化版本保留了原代码的简洁性，同时增加了配置选项，使其能够适应更多场景。在开发媒体播放器、倒计时组件还是数据可视化界面，这个函数都能满足时间格式化的需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day 15：01. 基于 Tauri 2.0 开发后台管理系统-Tauri 2.0 初探]]></title>    <link>https://juejin.cn/post/7576550156364840966</link>    <guid>https://juejin.cn/post/7576550156364840966</guid>    <pubDate>2025-11-26T01:52:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576550156364840966" data-draft-id="7576575703165992966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day 15：01. 基于 Tauri 2.0 开发后台管理系统-Tauri 2.0 初探"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-26T01:52:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申阳"/> <meta itemprop="url" content="https://juejin.cn/user/4353721775165486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day 15：01. 基于 Tauri 2.0 开发后台管理系统-Tauri 2.0 初探
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721775165486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申阳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T01:52:52.000Z" title="Wed Nov 26 2025 01:52:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e0c158f2fd74e28b64ec0fcb21b3892~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726772&amp;x-signature=TgeujOupdTejYPyxG6x40kTUMYs%3D" alt="image-20251125134731655" loading="lazy"/></p>
<h2 data-id="heading-0">一、前言</h2>
<p><code>Nuxt</code> 开发的博客要暂时告一段落了，原本我是打算基于 <code>NuxtContent</code> 完成一套静态的博客模块，但是发现和我之后要做的有很多相违背的，比如我希望数据是通过后台管理系统来的维护的，主要有利于我动态发布，以及后续一些收费模块的整合，所以不想再花大量时间去折腾 <code>NuxtContent</code> 了。</p>
<p>我之前做过很多后台管理系统，无论是工作中，还是自己搭建的脚手架工程，无一例外都是传统的 <code>web</code> 应用，基于浏览器访问，使用 <code>VUE/React</code> 等前端框架，除了具体业务模块上的区别外，都是换汤不换药，无非就是路由、权限、字典等通用模块的不同实现方式。我对此已经毫无兴趣，所以我打算换个模式玩一玩，做一个桌面端的后台管理系统。</p>
<p>首先声明，我为什么要做成桌面端？</p>
<ul>
<li>纯粹个人兴趣，我就是想探索一下。为后续做一些桌面端应用探探路（我其实想自己弄一个类似 <code>Typora</code> 的编辑工具😄）</li>
<li><code>web</code> 后台项目我自己做的太多了，加上优秀的二开项目也很多，没有动力。</li>
<li>作为后台管理系统，我并不打算部署在外网上，所以不需要顾忌桌面端无法随时访问的痛点。</li>
<li>桌面端可以深度集成操作系统，可以做一些不一样的尝试。</li>
</ul>
<blockquote>
<p>当然如果你需要随时随地的浏览器访问，那可能比较遗憾了，我暂时没有这方面拓展的打算，可以看一下我之前的文章，或许对你有所帮助 <a href="https://juejin.cn/column/7239552256168427577" target="_blank" title="https://juejin.cn/column/7239552256168427577">juejin.cn/column/7239…</a></p>
</blockquote>
<p>如果你和我一样，喜欢尝试新鲜事物，那么接下来就要开始我们的征程啦！！！😊</p>
<h2 data-id="heading-1">二、为什么选择 Tauri ？</h2>
<p>当我脑子里有“用桌面端做后台管理系统”这个想法的时候，我第一想到的其实是 <strong>Electron</strong> ，因为我之前就折腾过一段时间的 <strong>Electron</strong> ，给我的感觉就是生态完善，没有后顾之忧。</p>
<p>但是，我这个人比较喜欢折腾，我又去搜了一下，发现 <code>Tauri</code> 好像势头不错，我内心又想摆脱浏览器那一套东西（这里纯粹是自己主观意志作祟），与我一拍即合，就它了。</p>
<p>当然更 <strong>小的打包体积，内存占用低，更注重安全和性能</strong> 让我多了一丝好感。</p>
<h2 data-id="heading-2">三、初探 Tauri</h2>
<p>这里是官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftauri.app%2Fzh-cn%2Fstart%2F" target="_blank" title="https://tauri.app/zh-cn/start/" ref="nofollow noopener noreferrer">tauri.app/zh-cn/start…</a></p>
<p>这里我就不去赘述什么是 <code>Tauri</code> ? 一些概念性的东西，大家可以你自己去官网上查看。</p>
<p><strong>Tauri 2.0</strong> 的特点：<strong>创建小型、快速、安全、跨平台的应用程序</strong></p>
<h3 data-id="heading-3">3.1. 前置要求</h3>
<p><strong>系统依赖项安装</strong></p>
<p>跟着文档操作就完事了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ftauri.app%2Fzh-cn%2Fstart%2Fprerequisites%2F%23windows" target="_blank" title="https://tauri.app/zh-cn/start/prerequisites/#windows" ref="nofollow noopener noreferrer">tauri.app/zh-cn/start…</a></p>
<p>下载安装环境需要点时间，趁这段时间，我们看一下 <code>Rust</code> 的学习文档。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Frust-lang.org%2Fzh-CN%2Flearn%2F" target="_blank" title="https://rust-lang.org/zh-CN/learn/" ref="nofollow noopener noreferrer">rust-lang.org/zh-CN/learn…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoc.rust-lang.org%2Fbook%2F" target="_blank" title="https://doc.rust-lang.org/book/" ref="nofollow noopener noreferrer">doc.rust-lang.org/book/</a></p>
<p>下载完成后，验证一下 Rust 是否安装成功。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e6fb34048cc48a0a8e6ff1bf0bb01b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726772&amp;x-signature=1KiJ1xf9EfW2pYUA5EPEyrSJC8U%3D" alt="image-20251125161544543" loading="lazy"/></p>
<p><strong>第一个 hello word ！</strong></p>
<p>新建一个文件 <code>main.rs</code></p>
<p>运行 <code>rustc main.rs</code> 编译</p>
<p>这个时候生成了一个两个文件</p>
<pre><code class="hljs language-rust" lang="rust">rust-test    
├─ main.exe  # 可执行文件 
├─ main.pdb  # 程序数据文件
└─ main.rs  # 源文件
</code></pre>
<p>命令行输入 <code> .\main</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4392a60226044464b2988649f3cc32aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726772&amp;x-signature=%2BeFgu7rmenDWKeVUf%2Fuiad4WvqM%3D" alt="image-20251125162531704" loading="lazy"/></p>
<blockquote>
<p>感觉和 <code>JAVA</code> 很相似，具体的语法我大致浏览了一遍，等用到的时候再细看吧。</p>
</blockquote>
<h2 data-id="heading-4">四、创建项目</h2>
<pre><code class="hljs language-bash" lang="bash">pnpm create tauri-app
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbe694d99ad84080a808e5034ef7015c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726772&amp;x-signature=x%2FZCuGLEUUiLY3pllFgu41A2FGI%3D" alt="image-20251125163543541" loading="lazy"/></p>
<p>用 <code>vscode</code> 打开项目</p>
<p>安装这两个插件</p>
<p><img alt="image-20251125164149757转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53feade108a74bf0899fd10e134d5166~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726772&amp;x-signature=vNZCvLun3eeFqWzZbavZdmySKWw%3D" alt="image-20251125173535444" loading="lazy"/></p>
<p>项目结构看这里：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftauri.app%2Fzh-cn%2Fstart%2Fproject-structure%2F" target="_blank" title="https://tauri.app/zh-cn/start/project-structure/" ref="nofollow noopener noreferrer">tauri.app/zh-cn/start…</a></p>
<h2 data-id="heading-5">五、启动项目</h2>
<p>安装依赖 <code>pnpm i</code></p>
<p>启动项目 <code>pnpm tauri dev</code></p>
<blockquote>
<p><strong>❗️❗️❗️如果出现异常或者不是下面页面，重启一下电脑，因为之前装的环境有的需要重启后才可以生效</strong></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac7e8b9581864bf2946e2da7ead5a488~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726772&amp;x-signature=vkUomIWjGoGFcNFPsuQUF2A0JFE%3D" alt="image-20251126094059813" loading="lazy"/></p>
<h2 data-id="heading-6">六、总结</h2>
<p>今天就先到这里，贪多嚼不烂，哈哈哈哈！😄😄😄</p>
<p><strong>千里之行，始于足下。你的“个人公司”从这第一个2小时开始。欢迎在评论区分享你的进展或遇到的卡点，我会逐一查看，尽可能的帮助解决。我们下一篇文章见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文吃透 JS 事件机制：从监听原理到实战技巧]]></title>    <link>https://juejin.cn/post/7576479344039444532</link>    <guid>https://juejin.cn/post/7576479344039444532</guid>    <pubDate>2025-11-25T15:58:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576479344039444532" data-draft-id="7576479344039428148" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文吃透 JS 事件机制：从监听原理到实战技巧"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-25T15:58:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="生椰丝绒拿铁"/> <meta itemprop="url" content="https://juejin.cn/user/4185180725584116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文吃透 JS 事件机制：从监听原理到实战技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4185180725584116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    生椰丝绒拿铁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T15:58:48.000Z" title="Tue Nov 25 2025 15:58:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 JavaScript 世界里，事件是交互的核心 —— 点击按钮、输入文本、鼠标移动，本质上都是事件在驱动。但很多开发者只停留在「会用 <code>onclick</code>」的层面，对事件的触发流程、监听方式、性能优化一知半解。本文就从底层原理出发，结合实战案例，帮你彻底搞懂 JS 事件机制。</p>
<h2 data-id="heading-0">一、事件是怎么 “发生” 的？</h2>
<p>我们先看一个直观的例子：页面上有一个红色父容器 <code>parent</code>，里面嵌套了一个蓝色子容器 <code>child</code>。当你点击 <code>child</code> 时，到底发生了什么？</p>
<p>html</p>
<p>预览</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> id="parent" style="<span class="hljs-attribute">width</span>:<span class="hljs-number">200px</span>;<span class="hljs-attribute">height</span>:<span class="hljs-number">200px</span>;<span class="hljs-attribute">background</span>:red<span class="hljs-string">"&gt;
  &lt;div id="</span>child<span class="hljs-string">" style="</span>width:<span class="hljs-number">100px</span>;<span class="hljs-attribute">height</span>:<span class="hljs-number">100px</span>;<span class="hljs-attribute">background</span>:blue<span class="hljs-string">"&gt;&lt;/div&gt;
&lt;/div&gt;
</span></code></pre>
<p>你可能觉得只是 “点击了蓝色方块”，但 JS 的事件系统背后有一套完整的流程 ——<strong>事件流</strong>（Event Flow），它包含三个阶段：</p>
<h3 data-id="heading-1">1. 事件流三阶段（文字图解 + 绘图思路）</h3>
<h4 data-id="heading-2">核心流程（自上而下→目标→自下而上）</h4>
<ul>
<li>捕获阶段：<code>document</code> → <code>html</code> → <code>body</code> → <code>parent</code> → 接近 <code>child</code>（自上而下缩小范围）</li>
<li>目标阶段：精准命中 <code>child</code>（<code>event.target</code> 就是它）</li>
<li>冒泡阶段：<code>child</code> → <code>parent</code> → <code>body</code> → <code>html</code> → <code>document</code>（自下而上扩散）</li>
</ul>
<h4 data-id="heading-3">快速绘图思路（用备忘录 / Figma 2 分钟画好）</h4>
<ol>
<li>画一个大矩形代表 <code>document</code>，里面嵌套 <code>html</code>（稍小）、<code>body</code>（再小）、<code>parent</code>（红色）、<code>child</code>（蓝色，居中）</li>
<li>捕获阶段：用「向下的箭头」从 <code>document</code> 指向 <code>child</code>，标注 “捕获”</li>
<li>目标阶段：给 <code>child</code> 画个圈，标注 “目标元素（event.target）”</li>
<li>冒泡阶段：用「向上的箭头」从 <code>child</code> 指向 <code>document</code>，标注 “冒泡”</li>
</ol>
<h3 data-id="heading-4">2. 关键疑问：谁先执行？</h3>
<p>如果父元素和子元素都绑定了点击事件，执行顺序完全由「事件阶段」决定：</p>
<ul>
<li>捕获阶段的事件先执行（自上而下）</li>
<li>目标阶段的事件次之</li>
<li>冒泡阶段的事件最后执行（自下而上）</li>
</ul>
<p>举个例子验证：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父元素-捕获阶段</span>
parent.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'parent 捕获'</span>), <span class="hljs-literal">true</span>);
<span class="hljs-comment">// 子元素-捕获阶段</span>
child.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'child 捕获'</span>), <span class="hljs-literal">true</span>);
<span class="hljs-comment">// 子元素-冒泡阶段</span>
child.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'child 冒泡'</span>), <span class="hljs-literal">false</span>);
<span class="hljs-comment">// 父元素-冒泡阶段</span>
parent.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'parent 冒泡'</span>), <span class="hljs-literal">false</span>);
</code></pre>
<p>点击 <code>child</code> 后，控制台输出顺序是：</p>
<p>plaintext</p>
<pre><code class="hljs">parent 捕获 → child 捕获 → child 冒泡 → parent 冒泡
</code></pre>
<p>这就是事件流的核心逻辑：<strong>先捕获，再目标，后冒泡</strong>。</p>
<h2 data-id="heading-5">二、JS 事件的核心特征</h2>
<h3 data-id="heading-6">1. 事件是异步的</h3>
<p>JS 事件的本质是「异步回调」—— 你先注册事件处理函数，它不会立即执行，只有当事件被触发（比如点击、输入）后，才会被加入事件队列，等待主线程空闲时执行。</p>
<p>比如下面的代码，<code>console.log('先执行')</code> 会先输出，点击后才会执行回调：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript">child.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'点击后执行'</span>));
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'先执行'</span>); <span class="hljs-comment">// 先输出</span>
</code></pre>
<h3 data-id="heading-7">2. 两种事件注册方式（DOM0 vs DOM2）</h3>
<p>注册事件的方式有两种，其中 DOM2 级事件是现在的标准，DOM0 级已逐渐被淘汰：</p>



































<table><thead><tr><th>特性</th><th>DOM0 级事件（旧）</th><th>DOM2 级事件（推荐）</th></tr></thead><tbody><tr><td>语法</td><td><code>element.onclick = fn</code></td><td><code>element.addEventListener(type, fn, useCapture)</code></td></tr><tr><td>事件阶段控制</td><td>仅支持冒泡阶段</td><td>支持捕获（useCapture=true）/ 冒泡（false）</td></tr><tr><td>多个处理函数</td><td>不支持（会覆盖）</td><td>支持（可注册多个，按顺序执行）</td></tr><tr><td>移除事件</td><td><code>element.onclick = null</code></td><td><code>element.removeEventListener(type, fn, useCapture)</code></td></tr><tr><td>兼容性</td><td>所有浏览器支持</td><td>IE9+ 支持（IE8 - 用 attachEvent）</td></tr></tbody></table>
<p><strong>反例（不推荐）</strong> ：DOM0 级事件会覆盖，模块化差</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// 第二个 onclick 会覆盖第一个
<span class="hljs-attr">child.onclick</span> = () =&gt; console.log(<span class="hljs-string">'第一个点击事件'</span>)<span class="hljs-comment">;</span>
<span class="hljs-attr">child.onclick</span> = () =&gt; console.log(<span class="hljs-string">'第二个点击事件'</span>)<span class="hljs-comment">; // 仅执行这个</span>
</code></pre>
<p><strong>正例（推荐）</strong> ：DOM2 级事件支持多个处理函数</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 两个事件都会执行</span>
child.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'事件1'</span>));
child.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'事件2'</span>));
</code></pre>
<h3 data-id="heading-8">3. 重要提醒</h3>
<ul>
<li>事件监听<strong>只能绑定在单个 DOM 元素上</strong>，不能直接绑定在元素集合上（比如 <code>document.querySelectorAll</code> 返回的 NodeList）。</li>
<li>事件监听有一定内存开销，尤其是绑定在频繁创建 / 销毁的元素上时，记得及时移除（<code>removeEventListener</code>），避免内存泄漏。</li>
</ul>
<h2 data-id="heading-9">三、实战技巧：事件委托（性能优化神器）</h2>
<h3 data-id="heading-10">1. 问题场景</h3>
<p>如果页面上有一个列表，里面有 100 个 <code>&lt;li&gt;</code>，需要给每个 <code>&lt;li&gt;</code> 绑定点击事件，该怎么做？</p>
<p><strong>错误做法</strong>：循环遍历所有 <code>&lt;li&gt;</code>，逐个绑定事件</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">lis</span> = document.querySelectorAll(<span class="hljs-string">'#list li'</span>)<span class="hljs-comment">;</span>
lis.forEach(<span class="hljs-attr">li</span> =&gt; {
  li.addEventListener('click', () =&gt; console.log(li.innerHTML))<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<p>这种做法的问题：</p>
<ul>
<li>创建 100 个事件处理函数，内存开销大</li>
<li>新增 <code>&lt;li&gt;</code> 时，需要重新绑定事件，维护成本高</li>
</ul>
<h3 data-id="heading-11">2. 解决方案：事件委托</h3>
<p>利用事件的<strong>冒泡特性</strong>，把事件绑定在父元素（比如 <code>&lt;ul&gt;</code>）上，通过 <code>event.target</code> 判断触发事件的子元素，从而实现 “一次绑定，多个元素共用”。</p>
<p><strong>原理</strong>：点击 <code>&lt;li&gt;</code> 时，事件会冒泡到 <code>&lt;ul&gt;</code>，父元素的事件处理函数通过 <code>event.target</code> 拿到真正触发事件的 <code>&lt;li&gt;</code>。</p>
<p><strong>实战代码</strong>：</p>
<p>html</p>
<p>预览</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"list"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 可能动态新增 &lt;li&gt; --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> list = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'list'</span>);
<span class="hljs-comment">// 只给父元素绑定一次事件</span>
list.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 判断触发事件的是不是 &lt;li&gt;</span>
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">target</span>.<span class="hljs-property">tagName</span> === <span class="hljs-string">'LI'</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'点击了：'</span>, event.<span class="hljs-property">target</span>.<span class="hljs-property">innerHTML</span>);
  }
});

<span class="hljs-comment">// 动态新增 &lt;li&gt;，无需重新绑定事件</span>
<span class="hljs-keyword">const</span> newLi = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'li'</span>);
newLi.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'4'</span>;
list.<span class="hljs-title function_">appendChild</span>(newLi); <span class="hljs-comment">// 点击 4 也会触发事件</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-12">3. 事件委托的优势</h3>
<ul>
<li>减少事件绑定次数，降低内存开销</li>
<li>支持动态元素，新增子元素无需重新绑定</li>
<li>简化代码，提高维护性</li>
</ul>
<h2 data-id="heading-13">四、常用事件工具：阻止冒泡、阻止默认行为</h2>
<h3 data-id="heading-14">1. 阻止事件冒泡（<code>event.stopPropagation()</code>）</h3>
<p>有时候我们不希望事件冒泡到父元素，比如点击 <code>child</code> 时，只执行 <code>child</code> 的事件，不执行 <code>parent</code> 的事件。</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript">parent.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'parent 点击'</span>));
child.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  event.<span class="hljs-title function_">stopPropagation</span>(); <span class="hljs-comment">// 阻止冒泡</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'child 点击'</span>);
});
</code></pre>
<p>此时点击 <code>child</code>，只会输出 <code>child 点击</code>，<code>parent</code> 的事件不会执行。</p>
<h3 data-id="heading-15">2. 阻止默认行为（<code>event.preventDefault()</code>）</h3>
<p>有些元素有默认行为，比如 <code>&lt;a&gt;</code> 标签点击后跳转、表单提交后刷新页面。我们可以用 <code>preventDefault()</code> 阻止这些默认行为。</p>
<p>html</p>
<p>预览</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 阻止 &lt;a&gt; 标签跳转 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://juejin.cn"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"link"</span>&gt;</span>掘金<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'link'</span>);
link.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  event.<span class="hljs-title function_">preventDefault</span>(); <span class="hljs-comment">// 阻止跳转</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'点击了链接，但不跳转'</span>);
});
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-16">注意：两者的区别</h3>
<ul>
<li><code>stopPropagation()</code>：阻止事件在事件流中传播（捕获 / 冒泡），但不影响元素自身的默认行为。</li>
<li><code>preventDefault()</code>：阻止元素的默认行为，但不影响事件传播。</li>
</ul>
<h2 data-id="heading-17">五、总结</h2>
<p>JS 事件机制的核心可以概括为：</p>
<ol>
<li><strong>事件流</strong>：捕获 → 目标 → 冒泡（决定事件执行顺序）</li>
<li><strong>注册方式</strong>：优先使用 DOM2 级 <code>addEventListener</code>（支持多事件、阶段控制）</li>
<li><strong>性能优化</strong>：利用事件委托，减少事件绑定次数</li>
<li><strong>实用工具</strong>：<code>stopPropagation()</code> 阻止传播，<code>preventDefault()</code> 阻止默认行为</li>
</ol>
<p>理解了这些，你就能轻松应对各种交互场景，写出更高效、更易维护的 JS 代码。如果有疑问，欢迎在评论区交流～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ViewModel#onCleared的实现原理]]></title>    <link>https://juejin.cn/post/7576371992615960612</link>    <guid>https://juejin.cn/post/7576371992615960612</guid>    <pubDate>2025-11-25T11:38:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576371992615960612" data-draft-id="7576482238460723242" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ViewModel#onCleared的实现原理"/> <meta itemprop="keywords" content="Android,源码阅读"/> <meta itemprop="datePublished" content="2025-11-25T11:38:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Chejdj"/> <meta itemprop="url" content="https://juejin.cn/user/1297893111114423"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ViewModel#onCleared的实现原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1297893111114423/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Chejdj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T11:38:19.000Z" title="Tue Nov 25 2025 11:38:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开局一个问题</h2>
<p>请问ViewModel#onCleared的回调和Activity#onDestoryed的生命周期哪个更早？</p>
<h2 data-id="heading-1">开始源码分析</h2>
<p>我们构建ViewModel, 需要传入Activity或者fragment。都会走到下面的方法， get的时候也是从ViewModelStore 去拿和获取</p>
<pre><code class="hljs language-less" lang="less"> <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ViewModelProvider</span>(<span class="hljs-variable">@NonNull</span> ViewModelStore store, <span class="hljs-variable">@NonNull</span> Factory factory) {
        <span class="hljs-selector-tag">mFactory</span> = <span class="hljs-selector-tag">factory</span>;
        <span class="hljs-selector-tag">mViewModelStore</span> = <span class="hljs-selector-tag">store</span>;
 }
 
  <span class="hljs-selector-tag">public</span> &lt;<span class="hljs-selector-tag">T</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">ViewModel</span>&gt; <span class="hljs-selector-tag">T</span> <span class="hljs-selector-tag">get</span>(<span class="hljs-variable">@NonNull</span> String key, <span class="hljs-variable">@NonNull</span> Class&lt;T&gt; modelClass) {
        <span class="hljs-selector-tag">ViewModel</span> <span class="hljs-selector-tag">viewModel</span> = <span class="hljs-selector-tag">mViewModelStore</span><span class="hljs-selector-class">.get</span>(key);

        <span class="hljs-selector-tag">if</span> (modelClass.<span class="hljs-built_in">isInstance</span>(viewModel)) {
            <span class="hljs-selector-tag">if</span> (mFactory instanceof OnRequeryFactory) {
                ((<span class="hljs-selector-tag">OnRequeryFactory</span>) <span class="hljs-selector-tag">mFactory</span>)<span class="hljs-selector-class">.onRequery</span>(viewModel);
            }
            <span class="hljs-selector-tag">return</span> (T) <span class="hljs-selector-tag">viewModel</span>;
        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-comment">//noinspection StatementWithEmptyBody</span>
            <span class="hljs-selector-tag">if</span> (viewModel != null) {
                <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> log a warning.</span>
            }
        }
        <span class="hljs-selector-tag">if</span> (mFactory instanceof KeyedFactory) {
            <span class="hljs-selector-tag">viewModel</span> = ((KeyedFactory) mFactory)<span class="hljs-selector-class">.create</span>(key, modelClass);
        } <span class="hljs-selector-tag">else</span> {
            <span class="hljs-selector-tag">viewModel</span> = <span class="hljs-selector-tag">mFactory</span><span class="hljs-selector-class">.create</span>(modelClass);
        }
        <span class="hljs-selector-tag">mViewModelStore</span><span class="hljs-selector-class">.put</span>(key, viewModel);
        <span class="hljs-selector-tag">return</span> (T) <span class="hljs-selector-tag">viewModel</span>;
    }
</code></pre>
<p>所以从ViewModel的构建，我们知道是ViewModelStore进行维护了ViewModel的生命周期</p>
<h3 data-id="heading-2">ViewModelStore的管理</h3>
<p>ViewModelStore的管理，需要实现<code>ViewModelStoreOwner</code> 接口，我们代码中主要 <code>ComponentActivity</code> 和 <code>Fragment</code> 实现了该接口，这里源码分析以<code>ComponentActivity</code> 分析</p>
<pre><code class="hljs language-less" lang="less"> <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ComponentActivity</span>() {
    <span class="hljs-comment">//...</span>
    <span class="hljs-selector-tag">getLifecycle</span>()<span class="hljs-selector-class">.addObserver</span>(new <span class="hljs-built_in">LifecycleEventObserver</span>() {
            <span class="hljs-variable">@Override</span>
            public void <span class="hljs-built_in">onStateChanged</span>(<span class="hljs-variable">@NonNull</span> LifecycleOwner source,
                    <span class="hljs-variable">@NonNull</span> Lifecycle.Event event) {
                <span class="hljs-selector-tag">if</span> (event == Lifecycle.Event.ON_DESTROY) {
                    <span class="hljs-comment">// Clear out the available context</span>
                    <span class="hljs-selector-tag">mContextAwareHelper</span><span class="hljs-selector-class">.clearAvailableContext</span>();
                    <span class="hljs-comment">// And clear the ViewModelStore</span>
                    <span class="hljs-selector-tag">if</span> (!<span class="hljs-built_in">isChangingConfigurations</span>()) {
                        <span class="hljs-selector-tag">getViewModelStore</span>()<span class="hljs-selector-class">.clear</span>();
                    }
                }
            }
        });
    <span class="hljs-comment">//...</span>
 }
</code></pre>
<p>在<code>ComponentActivity</code> 的构造方法的时候，我们发现Activty#getViewModelStore 会在lifecycleOwner#on_Destory的时候调用 clear方法，进入调用ViewModel#onClear方法，完成ViewModel的清理(tips: 这里有如果是配置变化引起的Activty的重建，并不会调用clear方法)</p>
<p>所以这个问题变成了Lifecycle#on_destory 事件回调和Activty#onDestory的时机问题</p>
<h3 data-id="heading-3">Lifecycle#on_destory 回调时机？</h3>
<p>lifecycle的onEvent 主要是<code>LifecycleRegistry</code></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">LifecycleRegistry</span> <span class="hljs-selector-tag">extends</span> <span class="hljs-selector-tag">Lifecycle</span> {

      <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">setCurrentState</span>(<span class="hljs-variable">@NonNull</span> State state) {
        <span class="hljs-selector-tag">enforceMainThreadIfNeeded</span>(<span class="hljs-string">"setCurrentState"</span>);
        <span class="hljs-selector-tag">moveToState</span>(state);
      }

      <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">handleLifecycleEvent</span>(<span class="hljs-variable">@NonNull</span> Lifecycle.Event event) {
        <span class="hljs-selector-tag">enforceMainThreadIfNeeded</span>(<span class="hljs-string">"handleLifecycleEvent"</span>);
        <span class="hljs-selector-tag">moveToState</span>(event.<span class="hljs-built_in">getTargetState</span>()); <span class="hljs-comment">//这个地方去回调所有的Observer</span>
    }
}
</code></pre>
<p>我在外面查了半天，外面查了半天，都没有找到 <code>setCurrentState</code> 和 <code>handleLifecycleEvent</code> 调用的地方。直到我看到这个代码</p>
<pre><code class="hljs language-less" lang="less"> <span class="hljs-variable">@Override</span>
    protected void <span class="hljs-built_in">onCreate</span>(<span class="hljs-variable">@Nullable</span> Bundle savedInstanceState) {
        ...
        <span class="hljs-selector-tag">ReportFragment</span><span class="hljs-selector-class">.injectIfNeededIn</span>(this);
        ....
    }
</code></pre>
<pre><code class="hljs language-scss" lang="scss">public class ReportFragment extends android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.Fragment</span> {
    private static final String REPORT_FRAGMENT_TAG = "androidx<span class="hljs-selector-class">.lifecycle</span>"
            + "<span class="hljs-selector-class">.LifecycleDispatcher</span><span class="hljs-selector-class">.report_fragment_tag</span>";

    public static void <span class="hljs-built_in">injectIfNeededIn</span>(Activity activity) {
        if (Build.VERSION.SDK_INT &gt;= <span class="hljs-number">29</span>) {
            <span class="hljs-comment">// On API 29+, we can register for the correct Lifecycle callbacks directly</span>
            LifecycleCallbacks<span class="hljs-selector-class">.registerIn</span>(activity);
        }
        <span class="hljs-comment">// Prior to API 29 and to maintain compatibility with older versions of</span>
        <span class="hljs-comment">// ProcessLifecycleOwner (which may not be updated when lifecycle-runtime is updated and</span>
        <span class="hljs-comment">// need to support activities that don't extend from FragmentActivity from support lib),</span>
        <span class="hljs-comment">// use a framework fragment to get the correct timing of Lifecycle events</span>
        android<span class="hljs-selector-class">.app</span><span class="hljs-selector-class">.FragmentManager</span> manager = activity<span class="hljs-selector-class">.getFragmentManager</span>();
        if (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == null) {
            manager<span class="hljs-selector-class">.beginTransaction</span>()<span class="hljs-selector-class">.add</span>(new ReportFragment(), REPORT_FRAGMENT_TAG)<span class="hljs-selector-class">.commit</span>();
            <span class="hljs-comment">// Hopefully, we are the first to make a transaction.</span>
            manager<span class="hljs-selector-class">.executePendingTransactions</span>();
        }
    }

    <span class="hljs-keyword">@SuppressWarnings</span>(<span class="hljs-string">"deprecation"</span>)
    static void dispatch(<span class="hljs-keyword">@NonNull</span> Activity activity, <span class="hljs-keyword">@NonNull</span> Lifecycle.Event event) {
        if (activity instanceof LifecycleRegistryOwner) {
            ((LifecycleRegistryOwner) activity)<span class="hljs-selector-class">.getLifecycle</span>()<span class="hljs-selector-class">.handleLifecycleEvent</span>(event);
            return;
        }

        if (activity instanceof LifecycleOwner) {
            Lifecycle lifecycle = ((LifecycleOwner) activity)<span class="hljs-selector-class">.getLifecycle</span>();
            if (lifecycle instanceof LifecycleRegistry) {
                 <span class="hljs-comment">//此处进行分发的</span>
                ((LifecycleRegistry) lifecycle)<span class="hljs-selector-class">.handleLifecycleEvent</span>(event);
            }
        }
    }

    static ReportFragment <span class="hljs-built_in">get</span>(Activity activity) {
        return (ReportFragment) activity<span class="hljs-selector-class">.getFragmentManager</span>()<span class="hljs-selector-class">.findFragmentByTag</span>(
                REPORT_FRAGMENT_TAG);
    }

    private ActivityInitializationListener mProcessListener;

    private void <span class="hljs-built_in">dispatchCreate</span>(ActivityInitializationListener listener) {
        if (listener != null) {
            listener<span class="hljs-selector-class">.onCreate</span>();
        }
    }

    private void <span class="hljs-built_in">dispatchStart</span>(ActivityInitializationListener listener) {
        if (listener != null) {
            listener<span class="hljs-selector-class">.onStart</span>();
        }
    }

    private void <span class="hljs-built_in">dispatchResume</span>(ActivityInitializationListener listener) {
        if (listener != null) {
            listener<span class="hljs-selector-class">.onResume</span>();
        }
    }

    <span class="hljs-keyword">@Override</span>
    public void onActivityCreated(Bundle savedInstanceState) {
        super<span class="hljs-selector-class">.onActivityCreated</span>(savedInstanceState);
        <span class="hljs-built_in">dispatchCreate</span>(mProcessListener);
        <span class="hljs-built_in">dispatch</span>(Lifecycle.Event.ON_CREATE);
    }

    <span class="hljs-keyword">@Override</span>
    public void onStart() {
        super<span class="hljs-selector-class">.onStart</span>();
        <span class="hljs-built_in">dispatchStart</span>(mProcessListener);
        <span class="hljs-built_in">dispatch</span>(Lifecycle.Event.ON_START);
    }

    <span class="hljs-keyword">@Override</span>
    public void onResume() {
        super<span class="hljs-selector-class">.onResume</span>();
        <span class="hljs-built_in">dispatchResume</span>(mProcessListener);
        <span class="hljs-built_in">dispatch</span>(Lifecycle.Event.ON_RESUME);
    }

    <span class="hljs-keyword">@Override</span>
    public void onPause() {
        super<span class="hljs-selector-class">.onPause</span>();
        <span class="hljs-built_in">dispatch</span>(Lifecycle.Event.ON_PAUSE);
    }

    <span class="hljs-keyword">@Override</span>
    public void onStop() {
        super<span class="hljs-selector-class">.onStop</span>();
        <span class="hljs-built_in">dispatch</span>(Lifecycle.Event.ON_STOP);
    }

    <span class="hljs-keyword">@Override</span>
    public void onDestroy() {
        super<span class="hljs-selector-class">.onDestroy</span>();
        <span class="hljs-built_in">dispatch</span>(Lifecycle.Event.ON_DESTROY);
        <span class="hljs-comment">// just want to be sure that we won't leak reference to an activity</span>
        mProcessListener = null;
    }
}
</code></pre>
<p>利用了 Fragment 的生命周期回调，去监听 Activity 的生命周期，从而把生命周期事件（onStart/onStop/onResume…）转发给 Lifecycle → LiveData → LifecycleObserver。</p>
<p>这样好处：</p>
<ul>
<li><strong>关注点分离</strong>：Activity 专注于业务逻辑，生命周期管理交给专门组件</li>
<li><strong>可测试性</strong>：Lifecycle 逻辑可以独立测试</li>
<li><strong>一致性</strong>：所有 Activity 都有统一的生命周期管理方式</li>
</ul>
<p>好的，这个问题就变成了Fragment#onDestory 和 Activity#onDestory的生命周期的问题</p>
<h3 data-id="heading-4">Fragment#onDestory的回调</h3>
<p>Activity 中的 Fragment的生命周期回调，是受 <code>FragmentController</code> 控制的,我们可以看到这个代码performDestroy</p>
<pre><code class="hljs language-scss" lang="scss">final void <span class="hljs-built_in">performDestroy</span>() {
        <span class="hljs-built_in">dispatchActivityPreDestroyed</span>();
        mDestroyed = true;
        mWindow<span class="hljs-selector-class">.destroy</span>();
        mFragments<span class="hljs-selector-class">.dispatchDestroy</span>(); <span class="hljs-comment">//Fragment 执行onDestory方法</span>
        <span class="hljs-built_in">onDestroy</span>(); <span class="hljs-comment">//activity的 onDestroy方法</span>
        EventLogTags<span class="hljs-selector-class">.writeWmOnDestroyCalled</span>(mIdent, getComponentName()<span class="hljs-selector-class">.getClassName</span>(),
                "performDestroy");
        mFragments<span class="hljs-selector-class">.doLoaderDestroy</span>();
        if (mVoiceInteractor != null) {
            mVoiceInteractor<span class="hljs-selector-class">.detachActivity</span>();
        }
        <span class="hljs-built_in">dispatchActivityPostDestroyed</span>();
    }
</code></pre>
<p>从这里可以得出问题结论，<strong>fragment#onDestroy 会在 Activity#onDestroy方法之前执行</strong></p>
<h3 data-id="heading-5">Activity#performDestroy</h3>
<p>activity#performDestroy 是哪里调过来的，其实我们知道activity的生命周期都是AMS跨进程调用ApplicationThread, 然后 ApplicationThread 通过H handler 执行 activity的生命周期方法。 所以我们应该可以从ActivityThread类中找到对应的代码。 下面贴出对应的代码作证一下</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">H</span> extends Handler{
   ....
   <span class="hljs-keyword">case</span> EXECUTE_TRANSACTION:
        <span class="hljs-keyword">final</span> ClientTransaction transaction = (ClientTransaction) msg.obj;
        mTransactionExecutor.<span class="hljs-built_in">execute</span>(transaction);
   ...
       <span class="hljs-keyword">break</span>;

}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionExecutor</span>{
   ...
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">void</span> <span class="hljs-title">performLifecycleSequence</span><span class="hljs-params">(ActivityClientRecord r, IntArray path,
            ClientTransaction transaction)</span> </span>{
            ....
                <span class="hljs-keyword">case</span> ON_DESTROY:
                    mTransactionHandler.<span class="hljs-built_in">handleDestroyActivity</span>(r.token, <span class="hljs-literal">false</span> <span class="hljs-comment">/* finishing */</span>,
                            <span class="hljs-number">0</span> <span class="hljs-comment">/* configChanges */</span>, <span class="hljs-literal">false</span> <span class="hljs-comment">/* getNonConfigInstance */</span>,
                            <span class="hljs-string">"performLifecycleSequence. cycling to:"</span> + path.<span class="hljs-built_in">get</span>(size - <span class="hljs-number">1</span>));
                    <span class="hljs-keyword">break</span>;
              ...
            }
        }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ActivityThread</span>{
     <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">handleDestroyActivity</span><span class="hljs-params">(IBinder token, <span class="hljs-type">boolean</span> finishing, <span class="hljs-type">int</span> configChanges,
            <span class="hljs-type">boolean</span> getNonConfigInstance, <span class="hljs-type">String</span> reason)</span> </span>{
            ....
            mInstrumentation.<span class="hljs-built_in">callActivityOnDestroy</span>(r.activity);
      }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Instrumentation</span>{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">callActivityOnDestroy</span><span class="hljs-params">(Activity activity)</span> </span>{
      activity.<span class="hljs-built_in">performDestroy</span>(); <span class="hljs-comment">//真正调用地方</span>
  }
}
</code></pre>
<h3 data-id="heading-6">总结整理一下</h3>
<ol>
<li>AMS 发送 Activity#onDestroy → ApplicationThread →ActivityThread</li>
<li>Activity#performDestroy()</li>
<li>performDestroy 方法中，先让Fragment执行onDestroy， 然后执行自己的onDestroy方法</li>
<li>Activity的lifecycle 的 Event的事件实现原理是，依赖Fragment的onDestroy声明周期</li>
<li>ViewModelStore 接收到Actvity#lifecycle#onDestroy 调用ViewModel的cleared 方法</li>
</ol>
<p>上面问题答案呼之欲出： ViewModel的cleared 是先于 Activity#onDestroy</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文吃透 ES6 Symbol：JavaScript 里的「独一无二」标识符]]></title>    <link>https://juejin.cn/post/7576487832090443791</link>    <guid>https://juejin.cn/post/7576487832090443791</guid>    <pubDate>2025-11-25T15:54:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576487832090443791" data-draft-id="7576484465759027235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文吃透 ES6 Symbol：JavaScript 里的「独一无二」标识符"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-25T15:54:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="生椰丝绒拿铁"/> <meta itemprop="url" content="https://juejin.cn/user/4185180725584116"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文吃透 ES6 Symbol：JavaScript 里的「独一无二」标识符
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4185180725584116/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    生椰丝绒拿铁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T15:54:47.000Z" title="Tue Nov 25 2025 15:54:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 JavaScript 世界里，数据类型是构建一切的基石。从最初的 number、string 到 ES6 新增的 bigint，每一种类型都有其独特使命。而 Symbol 的出现，不仅让 JS 数据类型扩充到 8 种，更解决了长期以来对象键名冲突的痛点。这篇文章就带你从本质到实践，彻底搞懂 Symbol 到底是什么、能用在哪。</p>
<h2 data-id="heading-0">一、先明确：Symbol 到底是什么？</h2>
<p>Symbol 是 ES6 引入的<strong>原始数据类型</strong>（简单数据类型），核心特征只有一个 ——<strong>独一无二</strong>。</p>
<ul>
<li>它通过 <code>Symbol()</code> 函数创建，而非 <code>new Symbol()</code>（这一点和其他原始类型的创建逻辑一致，比如 <code>String()</code> 而非 <code>new String()</code>）。</li>
<li>可选参数 <code>label</code> 仅用于描述，即使两个 Symbol 的描述相同，它们也绝不相等。</li>
</ul>
<p>看个直观例子：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">s1</span> = Symbol(<span class="hljs-string">'二哈'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">s2</span> = Symbol(<span class="hljs-string">'二哈'</span>)<span class="hljs-comment">;</span>
console.log(<span class="hljs-attr">s1</span> === s2)<span class="hljs-comment">; // false，哪怕描述一样，也是两个不同值</span>
</code></pre>
<p>这和我们熟悉的字符串完全不同：如果是 <code>'二哈' === '二哈'</code>，结果必然是 <code>true</code>。这种「天生唯一」的特性，正是 Symbol 的核心价值所在。</p>
<h3 data-id="heading-1">补充：JS 8 种数据类型的完整梳理</h3>
<p>很多人会混淆 JS 的数据类型分类，这里用清晰的结构总结（对应笔记里的「七上八下」）：</p>
<ul>
<li>原始数据类型（7 种）：number、boolean、string、null、undefined、bigint（ES6 新增）、Symbol（ES6 新增）</li>
<li>复杂数据类型（1 种）：object（包含数组、函数、对象等）</li>
</ul>
<p>其中 number 和 bigint 同属「数值类型」，但 bigint 支持更大范围的整数，而 Symbol 则是唯一的「标识类型」—— 它的核心作用不是存储数据，而是作为独一无二的标记。</p>
<h2 data-id="heading-2">二、核心用法：解决对象键名冲突的「神器」</h2>
<p>在多人协作或使用第三方库时，最头疼的问题之一就是「对象键名被意外覆盖」。比如你定义了一个对象，同事后续新增属性时，不小心用了相同的键名，导致原有数据丢失：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 你写的代码</span>
<span class="hljs-type">const</span> user = {
  name: <span class="hljs-string">'cww'</span>,
  email: <span class="hljs-string">'123@123.com'</span>
};

<span class="hljs-comment">// 同事后续新增属性，不小心重复了键名</span>
user.email = <span class="hljs-string">'cww@123.com'</span>; <span class="hljs-comment">// 还好是更新，但若同事误写为 user.name = 'xxx'，就覆盖了你的原有值</span>
</code></pre>
<p>而 Symbol 作为对象的键名，能从根本上避免这种问题 —— 因为它天生唯一，永远不会和其他键名（无论是字符串还是其他 Symbol）重复。</p>
<h3 data-id="heading-3">1. 用 Symbol 作为对象键名</h3>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// 创建一个 Symbol 作为「秘密键名」
const <span class="hljs-attr">secretKey</span> = Symbol(<span class="hljs-string">'secret'</span>)<span class="hljs-comment">;</span>

const <span class="hljs-attr">user</span> = {
  <span class="hljs-section">[secretKey]</span>: '123456', // Symbol 作为键名，必须用方括号 <span class="hljs-section">[]</span> 包裹
  name: 'cww',
  email: '123@123.com'
}<span class="hljs-comment">;</span>

// 无法通过普通方式覆盖或访问
<span class="hljs-attr">user.secretKey</span> = <span class="hljs-string">'654321'</span><span class="hljs-comment">; // 这是新增了一个字符串键名，不是修改 Symbol 键名对应的值</span>
console.log(user<span class="hljs-section">[secretKey]</span>)<span class="hljs-comment">; // 依然是 '123456'，没有被覆盖</span>
</code></pre>
<p>这里要注意：Symbol 作为键名时，<strong>不能用点语法访问</strong>（<code>user.secretKey</code> 会被解析为字符串键名），必须用方括号 <code>[]</code> 访问，因为方括号会把里面的表达式当作「键名本身」处理。</p>
<h3 data-id="heading-4">2. Symbol 键名的「不可枚举」特性</h3>
<p>另一个实用特性：Symbol 作为对象键名时，不会被 <code>for...in</code>、<code>Object.keys()</code> 等方法枚举出来。这意味着它可以作为「私有属性」的模拟（注意：不是真正的私有属性，只是不会被常规遍历发现）。</p>
<p>看代码示例（对应笔记里的 classRoom 案例）：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> classRoom = {
  [<span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'Mark'</span>)]: { <span class="hljs-attr">grade</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">gender</span>: <span class="hljs-string">'male'</span> },
  [<span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'Oliva'</span>)]: { <span class="hljs-attr">grade</span>: <span class="hljs-number">80</span>, <span class="hljs-attr">gender</span>: <span class="hljs-string">'female'</span> },
  [<span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'Oliva'</span>)]: { <span class="hljs-attr">grade</span>: <span class="hljs-number">85</span>, <span class="hljs-attr">gender</span>: <span class="hljs-string">'female'</span> }, <span class="hljs-comment">// 两个 Symbol 键名，即使描述相同也不冲突</span>
  <span class="hljs-string">"dl"</span>: [<span class="hljs-string">"gw"</span>, <span class="hljs-string">"cqw"</span>]
};

<span class="hljs-comment">// 用 for...in 遍历，只能拿到字符串键名</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> classRoom) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 只输出 'dl'，Symbol 键名不会被遍历到</span>
}

<span class="hljs-comment">// 要获取对象的所有 Symbol 键名，需用 Object.getOwnPropertySymbols()</span>
<span class="hljs-keyword">const</span> symKeys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getOwnPropertySymbols</span>(classRoom);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(symKeys); <span class="hljs-comment">// 输出三个 Symbol 实例</span>
<span class="hljs-keyword">const</span> students = symKeys.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> classRoom[key]);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(students); <span class="hljs-comment">// 拿到所有 Symbol 键名对应的值</span>
</code></pre>
<p>这个特性很有用：比如你想给对象添加一些「辅助属性」，但不希望这些属性被外部遍历到（避免污染遍历结果），用 Symbol 就再合适不过了。</p>
<h2 data-id="heading-5">三、实际场景：Symbol 能帮我们解决什么问题？</h2>
<p>除了避免键名冲突，Symbol 还有很多实用场景，结合具体需求来看更易理解：</p>
<h3 data-id="heading-6">场景 1：多人协作开发，保护核心属性</h3>
<p>假设团队开发一个用户管理系统，你负责存储用户的核心信息（如密码加密后的密钥），其他同事负责扩展用户属性。用 Symbol 作为密钥的键名，能确保其他同事不会不小心覆盖这个核心属性：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// 你定义的核心 Symbol 键名
const <span class="hljs-attr">encryptKey</span> = Symbol(<span class="hljs-string">'encryptKey'</span>)<span class="hljs-comment">;</span>

// 公共用户对象
const <span class="hljs-attr">user</span> = {
  name: '张三',
  age: 25,
  <span class="hljs-section">[encryptKey]</span>: 'a1b2c3d4e5' // 核心密钥，不会被他人覆盖
}<span class="hljs-comment">;</span>

// 同事扩展属性，无需担心冲突
<span class="hljs-attr">user.phone</span> = <span class="hljs-string">'13800138000'</span><span class="hljs-comment">;</span>
<span class="hljs-attr">user.address</span> = <span class="hljs-string">'北京市'</span><span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-7">场景 2：定义常量，避免魔法字符串</h3>
<p>在项目中，我们经常会用到一些「魔法字符串」（即没有明确含义的字符串常量），比如：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">// 不好的写法：魔法字符串，含义不明确，修改时容易漏改
function getStatusText(status) {
  if (<span class="hljs-attr">status</span> === <span class="hljs-string">'success'</span>) return <span class="hljs-string">'成功'</span><span class="hljs-comment">;</span>
  if (<span class="hljs-attr">status</span> === <span class="hljs-string">'fail'</span>) return <span class="hljs-string">'失败'</span><span class="hljs-comment">;</span>
  if (<span class="hljs-attr">status</span> === <span class="hljs-string">'pending'</span>) return <span class="hljs-string">'处理中'</span><span class="hljs-comment">;</span>
}

// 调用时
getStatusText('success')<span class="hljs-comment">;</span>
</code></pre>
<p>用 Symbol 定义常量，能让代码更清晰、更安全 —— 因为 Symbol 唯一，不会出现常量值重复的情况：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用 Symbol 定义状态常量，含义明确</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STATUS</span> = {
  <span class="hljs-attr">SUCCESS</span>: <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'success'</span>),
  <span class="hljs-attr">FAIL</span>: <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'fail'</span>),
  <span class="hljs-attr">PENDING</span>: <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'pending'</span>)
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getStatusText</span>(<span class="hljs-params">status</span>) {
  <span class="hljs-keyword">if</span> (status === <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">SUCCESS</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'成功'</span>;
  <span class="hljs-keyword">if</span> (status === <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">FAIL</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'失败'</span>;
  <span class="hljs-keyword">if</span> (status === <span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">PENDING</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'处理中'</span>;
}

<span class="hljs-comment">// 调用时，直接使用常量，避免拼写错误</span>
<span class="hljs-title function_">getStatusText</span>(<span class="hljs-variable constant_">STATUS</span>.<span class="hljs-property">SUCCESS</span>);
</code></pre>
<h3 data-id="heading-8">场景 3：模拟对象的私有属性</h3>
<p>虽然 JavaScript 没有真正的私有属性（ES11 新增的 <code>#</code> 私有字段除外），但 Symbol 可以模拟类似效果 —— 因为它不会被常规遍历发现，且外部无法轻易获取到对应的 Symbol 实例：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模块内部定义 Symbol，外部无法访问</span>
<span class="hljs-keyword">const</span> privateMethod = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'privateMethod'</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> utils = {
  <span class="hljs-title function_">publicMethod</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 外部可以调用的公共方法</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是公共方法'</span>);
    <span class="hljs-variable language_">this</span>[privateMethod](); <span class="hljs-comment">// 内部调用「私有方法」</span>
  },
  [privateMethod]() {
    <span class="hljs-comment">// 模拟私有方法，外部无法直接调用</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是内部私有方法'</span>);
  }
};
</code></pre>
<p>外部使用时，无法通过 <code>utils.privateMethod</code> 访问到这个方法，也无法通过 <code>for...in</code> 遍历到，从而实现了一定程度的「私有性」。</p>
<h2 data-id="heading-9">四、常见误区：这些坑一定要避开</h2>
<h3 data-id="heading-10">误区 1：认为 Symbol 可以被 <code>new</code> 关键字创建</h3>
<p>Symbol 是原始数据类型，不是对象，所以不能用 <code>new Symbol()</code> 创建，否则会报错：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'test'</span>); <span class="hljs-comment">// Uncaught TypeError: Symbol is not a constructor</span>
</code></pre>
<p>正确写法是直接调用 <code>Symbol()</code> 函数：<code>const s = Symbol('test')</code>。</p>
<h3 data-id="heading-11">误区 2：认为 Symbol 描述相同就相等</h3>
<p>再次强调：Symbol 的描述（label）只是用于调试和区分，不影响其唯一性。哪怕描述完全相同，两个 Symbol 也是不同的：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">s1</span> = Symbol(<span class="hljs-string">'foo'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">s2</span> = Symbol(<span class="hljs-string">'foo'</span>)<span class="hljs-comment">;</span>
console.log(<span class="hljs-attr">s1</span> === s2)<span class="hljs-comment">; // false</span>
</code></pre>
<p>如果确实需要「描述相同则相等」的效果，可以使用 <code>Symbol.for()</code> 方法（补充知识点）：</p>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">s1</span> = Symbol.for(<span class="hljs-string">'foo'</span>)<span class="hljs-comment">; // 全局注册一个 Symbol</span>
const <span class="hljs-attr">s2</span> = Symbol.for(<span class="hljs-string">'foo'</span>)<span class="hljs-comment">; // 从全局获取已注册的 Symbol</span>
console.log(<span class="hljs-attr">s1</span> === s2)<span class="hljs-comment">; // true</span>
</code></pre>
<p><code>Symbol.for()</code> 会在全局 Symbol 注册表中查找描述对应的 Symbol，不存在则创建，存在则返回已有的，这和 <code>Symbol()</code> 的「每次创建都是新值」完全不同。</p>
<h3 data-id="heading-12">误区 3：认为 Symbol 键名的属性是完全私有</h3>
<p>虽然 Symbol 键名不会被 <code>for...in</code> 遍历，但并非完全不可访问。通过 <code>Object.getOwnPropertySymbols()</code> 或 <code>Reflect.ownKeys()</code> 可以获取到对象的所有 Symbol 键名，所以它只是「弱私有」，不是真正的私有属性。</p>
<p>如果需要真正的私有属性，建议使用 ES11 新增的 <code>#</code> 私有字段（如 <code>#privateProp</code>）。</p>
<h2 data-id="heading-13">五、总结：Symbol 的核心价值</h2>
<p>Symbol 看似简单，但其设计思想非常深刻 —— 它为 JavaScript 提供了一种「独一无二的标识」，解决了长期以来的键名冲突问题。</p>
<p>核心要点总结：</p>
<ol>
<li>Symbol 是原始数据类型，通过 <code>Symbol()</code> 函数创建，天生唯一。</li>
<li>主要用途是作为对象键名，避免冲突，同时支持「弱私有」特性。</li>
<li>不会被 <code>for...in</code> 等常规遍历方法枚举，需用 <code>Object.getOwnPropertySymbols()</code> 获取。</li>
<li>描述仅用于调试，不影响唯一性；<code>Symbol.for()</code> 可实现「描述相同则相等」的全局 Symbol。</li>
</ol>
<p>理解了 Symbol 的本质，你会发现在很多场景下，它能让代码更健壮、更易维护。下次遇到键名冲突或需要定义唯一标识的场景，不妨试试 Symbol 吧～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DeepSeek 视觉语言大模型技术演进（从DeepSeek VL/VL2到DeepSeek OCR）]]></title>    <link>https://juejin.cn/post/7576484465758437411</link>    <guid>https://juejin.cn/post/7576484465758437411</guid>    <pubDate>2025-11-25T11:16:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576484465758437411" data-draft-id="7576479344038821940" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DeepSeek 视觉语言大模型技术演进（从DeepSeek VL/VL2到DeepSeek OCR）"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-25T11:16:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃果冻不吐果冻皮"/> <meta itemprop="url" content="https://juejin.cn/user/3642056016410728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DeepSeek 视觉语言大模型技术演进（从DeepSeek VL/VL2到DeepSeek OCR）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3642056016410728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃果冻不吐果冻皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T11:16:00.000Z" title="Tue Nov 25 2025 11:16:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着 ChatGPT 迅速走红，这两年大家在日常工作中使用 LLM 进行的场景越来越多。本系列将针对主流算法架构进行讲解。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F600016134" target="_blank" title="https://zhuanlan.zhihu.com/p/600016134" ref="nofollow noopener noreferrer">大模型算法演进</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">大模型算法架构：QWen技术演进及剖析</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">大模型算法架构：DeepSeek技术演进及剖析</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F653374932%2Fanswer%2F3470909634" target="_blank" title="https://www.zhihu.com/question/653374932/answer/3470909634" ref="nofollow noopener noreferrer">大模型算法架构：LLaMA3 技术剖析</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F606757218%2Fanswer%2F3075464500" target="_blank" title="https://www.zhihu.com/question/606757218/answer/3075464500" ref="nofollow noopener noreferrer">大模型算法架构：Baichuan-7B技术剖析</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">DeepSeek 视觉语言大模型技术演进（从DeepSeek VL/VL2到DeepSeek OCR）</a></li>
</ul>
<blockquote>
<p>另外，我撰写的<strong>大模型相关的博客及配套代码</strong>均整理放置在Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliguodongiot%2Fllm-action%2Ftree%2Fmain" target="_blank" title="https://github.com/liguodongiot/llm-action/tree/main" ref="nofollow noopener noreferrer">llm-action</a>，有需要的朋友自取。</p>
</blockquote>
<p>最近视觉语言大模型领域逐渐变得成熟，本文详细介绍下DeepSeek在模型架构和训练方法上发展脉络。</p>
<h2 data-id="heading-0">DeepSeek VL</h2>
<h2 data-id="heading-1">背景</h2>
<p>目前开源的 MLLM 模型存在下列问题：</p>
<ul>
<li>多模态的世界知识很关键，目前大部分 MLLM 模型都是在指令微调上面做文章，这样会忽略世界知识而过分强调指令跟随导致在现实场景下使用体验不佳。为了给多模态模型注入丰富的世界知识，应该考虑利用广泛的视觉语言数据进行全面预训练。</li>
<li>在指令微调阶段，很多 MLLM 为了刷榜会使用很多学术类数据集，虽然看起来指标很高，但是实际上体验不好。</li>
<li>在模型架构方面，之前的工作大多将视觉转换器（通常与文本对齐）适配到预训练的语言模型。然而，大多数这些模型的分辨率相对较低，例如：336×336 或 448×448。而复杂现实场景(如OCR或微小物体识别)要求高分辨率的处理能力。</li>
<li>大部分 MLLM 在微调时候都没有考虑 LLM 模型本身能力是否下降，而这也是非常关键的。开发一个训练策略用于在两种模态方面都具备强大能力至关重要。</li>
</ul>
<p>总的来说，为了得到真的能用的 MLLM 模型，DeepSeek-VL 涉及了全面的预训练、基于场景的分类进行细致的数据整理、用于高分辨率处理的模型架构设计和平衡多模态的训练策略。</p>
<h3 data-id="heading-2">数据构造</h3>
<p>数据涵盖两类：一种是视觉语言预训练数据, 其目标是增强模型跨模态的理解。另外一种视觉语言有监督微调, 其目标是教会模型完成下游任务。</p>
<p><strong>视觉语言预训练数据</strong></p>
<p>这部分数据的要求是多样化，尽可能包括大量图文世界知识，对标的是 LLM 的预训练阶段。
在这个阶段为了保留 LLM 原先的能力，依然注入了大量 LLM 预训练阶段所使用的纯文本数据，是很关键的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/584a72ad3cf64a9d9fb1b4f507207361~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764674160&amp;x-signature=PQWrfEoFdDVEEvcOZVUnTxCWjEg%3D" alt="" loading="lazy"/></p>
<p><strong>指令微调阶段</strong></p>
<p>该阶段所需要的数据比较少，要求是高质量多样化。也用了大量 LLM 训练时的纯 SFT 数据。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/634f13f32e2e4a1ba95414ebfac438e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764674160&amp;x-signature=akboYYp3YsrixrIY22NmTZ75sRE%3D" alt="" loading="lazy"/></p>
<p>其中，In-house Data 是内部构建的基于现实场景中收集的 SFT 数据，是精心设计的高指令数据。具体来说是：</p>
<ul>
<li>首先收集来自不同在线源的 GPT-4V 和 Gemini 的各种真实测试用例。</li>
<li>然后仔细分析这些测试用例并将其组织成一个详细的分类，例如：包括识别、转换、分析、推理、评估和安全等多个类别，如下图所示。构造这种结构化分类法有比较大的好处，例如：可以在制作评测数据集时候平衡各个类别的数据量，当然训练时候也可以这样，方便挑选固定数量的类别平衡的高质量指令数据。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25d608976ad949a98a865b9ed2966d99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764674160&amp;x-signature=qw7IX0FkT8a26EonBuMVfX8dOt0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">模型架构</h3>
<p>系统包含三个模块：混合视觉编码器、视觉适配器和语言模型</p>
<p><strong>混合视觉编码器</strong>结合了 SAM-B 和 SigLIP-L 编码器，高效编码高分辨率为 1024 x 1024 图像，同时保留语义和细节信息。</p>
<ul>
<li>使用基于 SAM-B（一种预训练的 ViTDet 图像编码器） 的仅视觉编码器，用于处理低阶（ low-level）语言特征，支持 1024 x 1024 的高分辨率图像输入。</li>
<li>此外，还保留了 SigLIP-L 视觉编码器，处理 384 x 384 的低分辨率图像输入。</li>
</ul>
<p>具体来说，高分辨率 SAM-B 视觉编码器首先将图像调整为 1024 x 1024，生成 64 x 64 x 256 的特征图。对于 SAM-B 生成的 64 x 64 x 256 大小的高分辨率特征图，VL 适配器首先将其插值为 96 x 96 x 256。随后，它采用两个步幅为 2 的卷积层，生成一个24 x 24 x 1024的特征映射，并将其重塑为 576 x 1024。此外，SigLIP-L 生成的 576 x 1024 大小的低分辨率特征映射与高分辨率特征相连，形成 576 个视觉 token，维度为 2048。这些视觉token在增强高阶语义视觉识别和低阶视觉基础任务方面具有显著能力。然后它们经过 GeLU 激活，并被引导通过嵌入层，与语言模型建立连接。</p>
<p><strong>视觉语言适配器</strong>。采用两层混合 MLP 桥接视觉编码器和 LLM。首先，两个不同的单层 MLP 用于分别处理高分辨率特征和低分辨率特征。随后，这些特征沿其维度串接，并通过另一层 MLP 转换为 LLM 的输入空间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e02b542ebb3b400999eb3a17b4008fa7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764674160&amp;x-signature=VmwYIWsfXh9c8wArCR%2FIKeBOPpg%3D" alt="" loading="lazy"/></p>
<p><strong>语言模型</strong>。基于 DeepSeek LLM，其微观设计大致沿袭 LLaMA，采用 Pre-Norm 结构（RMSNorm），并使用 SwiGLU 作为前馈网络（FFN）激活函数。它还包含了旋转嵌入技术用于位置编码，并与 DeepSeek-LLM 使用相同的分词器。</p>
<p>鉴于目标是进行多模态和语言的联合预训练，从 DeepSeek 的预训练模型中选择一个中间检查点继续预训练。DeepSeek-VL-1B 模型基于 DeekSeek-LLM-1B 模型构建，该模型经过约 5000 亿文本toekn的训练。DeekSeek-VL-7B 模型是基于 DeepSeek-LLM-7B 模型，训练的约 2 万亿个文本toekn。</p>
<h3 data-id="heading-4">训练流水线</h3>
<p>整个系统采用 3 阶段训练策略。</p>
<p><strong>视觉语言适配器训练</strong>：</p>
<ul>
<li>内容：冻结视觉编码器和 LLM 参数，使用图像-文本对数据训练视觉-语言适配器。</li>
<li>目的：在嵌入空间内建立视觉与语言元素之间的概念联系，从而促进LLM对图像中所描绘实体的全面理解。</li>
<li>数据量：从ShareGPT4V获得的125万对图像-文本配对字幕数据集以及250万对文档OCR渲染来训练VL适配器。</li>
</ul>
<p><strong>视觉语言联合预训练</strong>：</p>
<ul>
<li>内容：保持视觉编码器冻结，并优化<strong>语言模型</strong>和<strong>视觉语言适配器</strong>。</li>
<li>数据：不仅进行多模态数据训练，还将大量语言数据纳入训练中。</li>
<li>目的：<strong>整合语言数据显著缓解了语言能力的下降</strong>，并且语言数据的加入并未导致多模态性能的显著损失。同时，<strong>不同模态的性能与它们在训练数据集中的比例高度相关</strong>。选择语言与多模态数据的训练比例约为7:3。这一比例使模型能够保持语言能力，同时，实现对多模态数据的更好预训练，有效平衡语言和多模态能力的发展。</li>
</ul>
<p><strong>有监督微调</strong>：</p>
<ul>
<li>目的：通过基于指令的微调对预训练的 DeepSeek-VL 模型进行微调，增强其执行指令和对话的能力。</li>
<li>内容：使用视觉语言 SFT 数据优化语言模型、视觉语言适配器和混合视觉编码器，由于 GPU 内存有限，SAM-B 仍然冻结。同时，只监督答案和特殊token并隐藏系统和用户提示。</li>
<li>数据：为确保模型在对话方面的全面熟练度，结合了<strong>多模态数据和 DeepSeek-LLM 中使用的纯文本对话数据</strong>。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ec82f204d42421f83ed567d49ab6e4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764674160&amp;x-signature=u64P%2BOuHRCcwytqWwxd68oZSev0%3D" alt="" loading="lazy"/></p>
<p>DeepSeek-VL 7B 在 64 个节点的集群上消耗 5 天，每个节点包含 8 个 Nvidia A100 GPU，而 DeepSeek-VL-1B 在涉及 16 个节点的设置上消耗 7 天。</p>
<p>为了高效训练，使用一个小策略：多模态训练的时候，由于纯问题和图文数据长度差距很多，如果一个批次里面混合训练则非常低效，所以采用的是分组训练策略，纯文本和图文数据分成不同组进行训练，可以最大化集群效率。</p>
<p>此外，训练过程中，先将语言数据比率设置为1，然后逐渐将其降低到最终模型训练的目标比率 0.7，也就是纯 LLM 数据比例是慢慢降低的，最终证明这种方式效果最好。这一策略有效防止了训练初期语言能力的显著下降，同时在语言和多模态领域后期阶段取得了相对优越的结果。这种渐进的适应使模型能够更顺畅地适应多模态数据的融入，从而提升整体训练的稳定性和性能。</p>
<h2 data-id="heading-5">DeepSeek VL2</h2>
<p>DeepSeek VL2 利用 MoE 架构在性能和效率上相较于其 DeepSeekVL 实现了显著提升。其主要进展集中在三个方面：（1）动态、高分辨率的视觉编码策略，增强视觉理解;（2）优化的语言模型架构，显著提升训练和推理效率;（3）精炼的视觉语言数据构建流程，不仅提升整体性能，还将模型能力扩展到精准视觉定位等新领域。</p>
<h3 data-id="heading-6">模型架构</h3>
<p>DeepSeek-VL2由三个核心模块组成：视觉编码器、视觉语言适配器和混合专家语言模型。基于其前身DeepSeek-VL的解码器架构，DeepSeek-VL2引入了两大创新：<strong>动态分块策略</strong>和<strong>DeepSeek MoE语言模型</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93ceb21b28014aad9c81723732d2efe4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764674160&amp;x-signature=eStM1On7iC7l0sHMy%2FGjx24iuVY%3D" alt="" loading="lazy"/></p>
<p><strong>动态分块策略</strong>：</p>
<p>DeepSeek-VL采用了 SigLIP 和 SAM-B 的混合视觉编码器，分别用于粗粒度和细粒度特征提取。然而，这种固定分辨率的编码器在处理高分辨率和极端长宽比图像时存在局限性。</p>
<p>DeepSeek-VL2 通过将高分辨率图像分割成小的图块来实现动态分块策略。使得使用单一的 SigLIP-SO400M-384 视觉编码器能够高效处理具有不同长宽比的高分辨率图像。预训练的SigLIP以384 × 384的基本分辨率运行。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b1ba979db464b21b32b3f3ec2f418d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764674160&amp;x-signature=Rb2mGPrAwZqm5acPZ71PKeunEe4%3D" alt="" loading="lazy"/></p>
<p><strong>视觉-语言适配器</strong>：</p>
<p>在处理视觉块之后，DeepSeek-VL2通过2×2像素 shuffle 操作将每个块的视觉token从27×27压缩到14×14=196个token。此外，还引入了三个特殊token来处理全局缩略图块和局部图块。</p>
<ul>
<li>对于全局缩略图块（14 × 14），每行末尾添加了 14 个 <code>&lt;tile_newline&gt;</code> token，最终得到 14 × 15 = 210 个 token 。</li>
<li>对于 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>i</mi></msub><mo>×</mo><msub><mi>n</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">m_i \times n_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的局部图块，它们以形状为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>m</mi><mi>i</mi></msub><mo>⋅</mo><mn>14</mn><mo separator="true">,</mo><msub><mi>n</mi><mi>i</mi></msub><mo>⋅</mo><mn>14</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(m_i \cdot 14, n_i \cdot 14)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8389em;vertical-align:-0.1944em;"/><span class="mord">14</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">14</span><span class="mclose">)</span></span></span></span></span> 的二维网格排列，在最后一列末尾附加了 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>m</mi><mi>i</mi></msub><mo>⋅</mo><mn>14</mn></mrow><annotation encoding="application/x-tex">m_i \cdot 14</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">14</span></span></span></span></span> 个 <code>&lt;tile_newline&gt; </code>token，表示所有本地局部图块的一行结束。</li>
<li>在全局缩略图块与局部图块之间插入了一个 <code>&lt;view_separator&gt;</code> token。</li>
</ul>
<p>完整的视觉序列包含 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>210</mn><mo>+</mo><mn>1</mn><mo>+</mo><msub><mi>m</mi><mi>i</mi></msub><mo>⋅</mo><mn>14</mn><mo>×</mo><mo stretchy="false">(</mo><msub><mi>n</mi><mi>i</mi></msub><mo>⋅</mo><mn>14</mn><mo>+</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">210 + 1 + m_i \cdot 14 \times (n_i \cdot 14 + 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">210</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">14</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">14</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 个视觉token。随后将视觉序列通过两层 MLP 投影到语言模型的嵌入空间中。</p>
<p><strong>DeepSeekMoE 语言模型</strong>：</p>
<p>DeepSeek-VL2的语言模型基于DeepSeekMoE，采用了MLA，通过压缩键值缓存为潜在向量，显著提高了推理效率。模型还引入了MoE架构，通过稀疏计算实现高效推理。</p>
<p>在 MoE 训练时，为每位专家引入全局偏置项，以经济高效地改善专家间的负载均衡。DeepSeek-VL2 有三个模型尺寸：1.0B、2.8B 和 4.5B。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5072dbc278614e0c86388f2243769107~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764674160&amp;x-signature=G27IyrtbuMey9xOBRyn3vtwB3%2Fg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">数据构造</h3>
<p>DeepSeek-VL2的训练数据构建分为三个阶段：视觉语言对齐、视觉语言预训练和有监督微调。</p>
<p><strong>视觉语言对齐数据</strong>：</p>
<p>该阶段主要训练MLP连接器，以桥接预训练的视觉编码器和语言模型。使用了ShareGPT4V数据集，包含约120万条标题和对话样本。</p>
<p><strong>视觉语言预训练数据</strong>：</p>
<p>预训练数据结合了 70% 视觉语言数据和 30% 纯文本数据，保持了视觉语言能力和纯文本性能的平衡。后者直接来自基石模型的预训练语料库。而视觉语言数据则包括交错图像文本数据、图像描述数据、OCR、视觉问答数据和视觉定位数据。</p>
<p><strong>监督微调数据</strong>：</p>
<p>微调数据结合了开源数据集和高质量的内部问答对，涵盖了通用视觉问答、OCR和文档理解、表格和图表理解、推理逻辑和数学、教科书和学术问题、网页转代码与图像转Python生成、视觉定位和基于文本的对话数据。</p>
<h3 data-id="heading-8">训练方法</h3>
<p>DeepSeek-VL2的训练分为三个阶段：视觉语言对齐（初始阶段）、视觉语言预训练（预训练阶段）和有监督微调（微调阶段）。在预训练和微调阶段，所有模型参数，包括视觉编码器、视觉语言适配器和语言模型，同时解锁并训练。在所有阶段，突出视觉理解能力，并专门计算文本token的下一次预测loss。</p>
<p><strong>视觉语言对齐</strong>：</p>
<p>基于预训练语言模型（DeepSeekMoE 3B/16B/27B），主要目标是<strong>建立视觉特征和语言特征之间的联系</strong>。这种对齐使得预训练的语言模型能够有效处理视觉输入。不同于之前的方法保持固定的预训练视觉编码器和语言模型，DeepSeek-VL2<strong>将固定分辨率的视觉编码器调整为能够适应动态高分辨率图像</strong>。在此阶段，优化<strong>视觉编码器</strong>和<strong>视觉语言适配器</strong>，同时冻结语言模型。</p>
<p><strong>视觉语言预训练</strong>：</p>
<p>在嵌入空间中建立视觉语言对齐后，接下来将大部分计算资源投入视觉语言预训练。</p>
<p>此阶段的重点是开发跨多种任务的综合视觉-语言知识。这个阶段对所有参数进行优化，包括视觉编码器，视觉-语言适配器和 DeepSeekMoE。使用大约800B个图像文本token，该阶段显著增强了模型的多模态理解能力，同时保持了其大部分语言能力。</p>
<p><strong>有监督微调</strong>：</p>
<p>通过有监督微调增强模型的指令遵循和对话能力。利用内部的视觉-语言 SFT 数据，优化所有参数，同时仅监督答案和特殊token，屏蔽系统和用户的提示。为了增强对话理解，将多模态数据与来自 DeepSeek-V2 的纯文本对话数据结合。这种方法确保了模型在多种视觉-语言任务中的强大表现。</p>
<h3 data-id="heading-9">模型超参及基础设施</h3>
<p>DeepSeek-VL2 训练不同规格模型的详细超参数如下所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/764901c839e543ad82799131fbf30106~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764674160&amp;x-signature=LVIkFHLnefllMDL5k2cZpAzM6Yw%3D" alt="" loading="lazy"/></p>
<p>作为模型流水线的第一个组件，视觉编码器需要在多个 GPU 间进行细致负载均衡，以防止流水线空泡并优化 GPU 利用率。由于视觉编码器相较于 LLM 模块的独特计算特性导致流水线并行策略面临的一个重大挑战。</p>
<p>为此，作者在流水线并行策略中对视觉编码器进行了<strong>细粒度的层划分</strong>。此外，在前向和后向过程中对不同数据并行ranks进行<strong>图像分块负载均衡</strong>，<strong>以缓解动态分辨率策略导致的图像分块数量不平衡</strong>。此外，训练流程还融合了张量并行和专家并行方法，以实现最高效率。由于部分批次仅包含文本数据，而另一些包含图像数据，引入了两种不同的流水线策略。针对不同类型的数据，并按需在这两种策略之间切换。</p>
<p>最终，DeepSeek-VL2 的训练针对不同规格模型在7/10/14天内完成，使用 16/33/42 节点集群，每个节点配备 8 块 NVIDIA A100 GPU。</p>
<h2 data-id="heading-10">DeepSeek OCR</h2>
<h3 data-id="heading-11">背景</h3>
<p>当前 LLMs 在处理长文本时面临显著的计算挑战，其开销随序列长度呈二次增长。本文探索一种潜在的解决方案：将视觉模态作为高效的文本信息压缩媒介。包含文档文本的单个图像可以使用比等效数字文本少得多的token来表示丰富的信息，这表明通过视觉token进行光学压缩可以实现更高的压缩比。</p>
<p>这一见解促使作者从以 LLM 为中心的角度重新审视视觉语言模型，并重点关注视觉编码器如何提升 LLM 在处理文本信息时的效率，而非人类本就擅长的基础 VQA 任务。OCR 任务作为连接视觉与语言的中间模态，为这种视觉文本压缩范式提供了理想的测试平台，因为，它们建立了视觉与文本表现之间的自然压缩-解压映射，同时，提供了定量评估指标。</p>
<h3 data-id="heading-12">模型架构</h3>
<p>DeepSeek-OCR 采用统一的端到端 VLM 架构，由编码器与解码器组成。编码器（即 DeepEncoder）负责提取图像特征、将视觉表征离散化为 token 并进行压缩；解码器则基于图像 token 与提示（prompt）生成所需结果。 DeepEncoder 约 380M 参数，主要由 80M 的 SAM-base 与 300M 参数的 CLIP-large 串联构成。解码器采用 3B MoE 架构，推理时激活参数约 570M。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f3d346e8b264890b6a5a30d6ac404cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764674160&amp;x-signature=i4a1gmKARdpmfgu2jl98hWHXALU%3D" alt="" loading="lazy"/></p>
<p><strong>DeepEncoder</strong>：</p>
<p>为探索“光学方式压缩上下文”的可行性，需要具备如下特性的视觉编码器：</p>
<ol>
<li>可处理高分辨率；</li>
<li>在高分辨率下激活开销低；</li>
<li>视觉 token 数量少；</li>
<li>支持多分辨率输入；</li>
<li>参数规模适中。</li>
</ol>
<p>为此，作者设计了全新的视觉编码器 DeepEncoder。其主要由两部分组成：</p>
<ul>
<li>以窗口注意力（window attention）为主的视觉感知特征提取组件；</li>
<li>以稠密全局注意力（dense global attention）为主的视觉知识特征提取组件。</li>
</ul>
<p>为继承之前工作的预训练收益，分别采用 SAM-base（patch 大小为 16） 与 CLIP-large 作为这两部分的主干架构。对于 CLIP，由于其输入不再是原始图像而是上一阶段输出的 token，移除了第一个 patch embedding 层。在<strong>两组件之间</strong>，借鉴了 Vary ，<strong>使用 2 层卷积模块</strong>对视觉 token 做 16× 下采样：每层卷积核大小 3、步幅 2、填充 1，通道数由 256 增至 1024。</p>
<p>例如，若输入一张 1024×1024 的图像，DeepEncoder 会将其切分为 1024/16 × 1024/16 = 4096 个 patch token。由于编码器前半部分以窗口注意力为主且仅 80M 参数，激活量可接受；在进入全局注意力前，4096 个 token 经过压缩模块变为 4096/16 = 256，从而使整体激活内存保持可控。</p>
<p>当有一幅包含 1000 个光学字符的图像，并希望测试解码所需的最少视觉 token。这就要求模型支持可变数量的视觉 token，即 DeepEncoder 必须支持多分辨率。作者通过位置编码的动态插值来满足这一需求，并设计了若干分辨率模式进行混合训练，使单个 DeepSeek-OCR 模型具备多分辨率能力。</p>
<p>DeepEncoder 主要支持两大输入模式：原生分辨率（native resolution）与动态分辨率（dynamic resolution），各自包含多个子模式。</p>
<p><strong>原生分辨率</strong>含四个子模式：Tiny、Small、Base、Large，其分辨率与 token 数分别为
512×512（64），
640×640（100），
1024×1024（256），
1280×1280（400）。</p>
<p>由于 Tiny 与 Small 分辨率较小，为避免浪费视觉 token，直接按原图比例缩放；而 Base 与 Large 为了尽量保留原始长宽比，对图像进行填充（padding）至对应尺寸。填充后有效视觉 token少于名义 token，其计算公式为：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>N</mi><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mi>i</mi><mi>d</mi></mrow></msub><mo>=</mo><mo stretchy="false">⌈</mo><msub><mi>N</mi><mrow><mi>a</mi><mi>c</mi><mi>t</mi><mi>u</mi><mi>a</mi><mi>l</mi></mrow></msub><mo>×</mo><mo stretchy="false">[</mo><mn>1</mn><mo>−</mo><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mi>w</mi><mo separator="true">,</mo><mi>h</mi><mo stretchy="false">)</mo><mo>−</mo><mi>m</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>w</mi><mo separator="true">,</mo><mi>h</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mi>w</mi><mo separator="true">,</mo><mi>h</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mo stretchy="false">]</mo><mo stretchy="false">⌉</mo></mrow><annotation encoding="application/x-tex">N_{valid} = \lceil N_{actual} \times [1 - ((max(w, h) - min(w, h)) / (max(w, h)))] \rceil</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">⌈</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.109em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">c</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">((</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">h</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">min</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">h</span><span class="mclose">))</span><span class="mord">/</span><span class="mopen">(</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">h</span><span class="mclose">)))]⌉</span></span></span></span></span></p>
<p><strong>动态分辨率</strong>由两种原生分辨率组合而成。例如：<strong>Gundam 模式</strong>由 n<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord">×</span></span></span></span></span>640<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord">×</span></span></span></span></span>640 的局部视图（tiles）与 1024<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>×</mo></mrow><annotation encoding="application/x-tex">\times</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord">×</span></span></span></span></span>1024 的全局视图组成，分片方法参考 InternVL2.0。支持动态分辨率主要出于应用层面考虑，尤其面向超高分辨率输入（如报纸版面）。分片相当于一种辅助窗口注意力形式，能进一步降低激活内存。需注意：由于我们原生分辨率较大，在动态分辨率下图像不会被过度切碎（tile 数控制在 2至9）。 在 Gundam 模式下，DeepEncoder 的视觉 token 数为：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>×</mo><mn>100</mn><mo>+</mo><mn>256</mn></mrow><annotation encoding="application/x-tex">n\times100+256</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">100</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">256</span></span></span></span></span>，其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span> 为 tile 数。若图像的宽与高均小于 640，则将 n设置为0，即 Gundam 退化为 Base 模式。</p>
<p>Gundam 与四种原生模式联合训练，实现一模多能的目标。 Gundam-master 模式（1024×1024 局部视图 + 1280×1280 全局视图）则在已训练完成的 DeepSeek-OCR 上继续训练得到，主要是出于负载均衡考虑，由于其分辨率过大，若与其他模式同时训练将拖慢整体训练速度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/195948d40d694fb1a199e1fcc0bdc4b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZCD5p6c5Ya75LiN5ZCQ5p6c5Ya755qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764674160&amp;x-signature=rKhzZHWl14c4%2BPdw3nXGY17ldSg%3D" alt="" loading="lazy"/></p>
<p><strong>MoE 解码器</strong>：</p>
<p>解码器采用 DeepSeekMoE，具体为 DeepSeek-3B-MoE。推理阶段，模型在 64 个路由专家中激活 6 个，外加 2 个共享专家，合计约 570M 激活参数。3B DeepSeekMoE 非常适合以特定领域（本文为 OCR）为中心的 VLM 研究：它具备 3B 模型的表达能力，同时享有约 570M 参数小模型的推理效率。</p>
<p>解码器从 DeepEncoder 压缩后的潜在视觉 token 重构原始文本表征：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mtext>dec</mtext></msub><mo>:</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>n</mi><mo>×</mo><msub><mi>d</mi><mtext>latent</mtext></msub></mrow></msup><mo>→</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><msub><mi>d</mi><mtext>text</mtext></msub></mrow></msup><mo separator="true">;</mo><mspace width="1em"/><mover accent="true"><mi mathvariant="bold">X</mi><mo>^</mo></mover><mo>=</mo><msub><mi>f</mi><mtext>dec</mtext></msub><mo stretchy="false">(</mo><mi mathvariant="bold">Z</mi><mo stretchy="false">)</mo><mspace width="1em"/><mtext>where </mtext><mi>n</mi><mo>≤</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">f_{\text{dec}}: \mathbb{R}^{n \times d_{\text{latent}}} \rightarrow \mathbb{R}^{N \times d_{\text{text}}}; \quad \hat{\mathbf{X}} = f_{\text{dec}}(\mathbf{Z}) \quad \text{where } n \le N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">dec</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">:</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8491em;"/><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">latent</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.144em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">text</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mpunct">;</span><span class="mspace" style="margin-right:1em;"/><span class="mspace" style="margin-right:0.1667em;"/><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9495em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathbf">X</span></span><span style="top:-3.2551em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1667em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">dec</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathbf">Z</span><span class="mclose">)</span><span class="mspace" style="margin-right:1em;"/><span class="mord text"><span class="mord">where </span></span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span></p>
<p>其中，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">Z</mi><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>n</mi><mo>×</mo><msub><mi>d</mi><mtext>latent</mtext></msub></mrow></msup></mrow><annotation encoding="application/x-tex">\mathbf{Z} \in \mathbb{R}^{n \times d_{\text{latent}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7252em;vertical-align:-0.0391em;"/><span class="mord mathbf">Z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8491em;"/><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">latent</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span>
为 DeepEncoder 压缩后的潜在视觉 token，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi mathvariant="bold">X</mi><mo>^</mo></mover><mo>∈</mo><msup><mi mathvariant="double-struck">R</mi><mrow><mi>N</mi><mo>×</mo><msub><mi>d</mi><mtext>text</mtext></msub></mrow></msup></mrow><annotation encoding="application/x-tex">\hat{\mathbf{X}} \in \mathbb{R}^{N \times d_{\text{text}}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9886em;vertical-align:-0.0391em;"/><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9495em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord mathbf">X</span></span><span style="top:-3.2551em;"><span class="pstrut" style="height:3em;"/><span class="accent-body" style="left:-0.1667em;"><span class="mord">^</span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8491em;"/><span class="mord"><span class="mord mathbb">R</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span><span class="mbin mtight">×</span><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2963em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">text</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span/></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span> 为重构后的文本表征。函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mtext>dec</mtext></msub></mrow><annotation encoding="application/x-tex">f_{\text{dec}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">dec</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 表示一个非线性映射，可通过类似 OCR 的训练由紧凑型语言模型有效学习。合理推测，LLM 通过专门的预训练优化，会更自然地集成这些能力。</p>
<h3 data-id="heading-13">数据引擎</h3>
<p>DeepSeek-OCR 构建了复杂而多样的训练数据，包括：OCR 1.0 数据（以传统 OCR 任务为主，如场景图像 OCR 和文档 OCR）、OCR 2.0 数据（以复杂人工图像的解析任务为主，如常见图表、化学式、平面几何解析数据）以及通用视觉数据（主要用于为 DeepSeek-OCR 注入一定的通用图像理解能力，并保留通用视觉接口）和纯文本数据（确保模型的语言能力，引入了 10%的内部纯文本预训练数据，所有数据处理至 8192 个token长度，这也是 DeepSeek-OCR 的序列长度）。</p>
<p>最终，训练 DeepSeek-OCR 时，OCR 数据占 70%，一般视觉数据占 20%，纯文本数据占 10%。</p>
<h3 data-id="heading-14">训练流程</h3>
<p>DeepSeek-OCR的训练流程非常简洁，主要包含两个阶段： a) 独立训练 DeepEncoder； b) 训练 DeepSeek-OCR。 <strong>注意</strong>：Gundam-master 模式是基于已训练好的 DeepSeek-OCR 模型，使用 600 万条采样数据继续训练得到的。</p>
<p><strong>训练 DeepEncoder</strong>：</p>
<p>参考 Vary ，采用一个小型语言模型，并使用下一个token预测（NTP）框架训练 DeepEncoder。在该阶段，使用上述全部 OCR 1.0 与 2.0 数据，以及从 LAION 采样的 1 亿条通用数据。所有数据训练 2 个 epoch，批量大为 1280，采用 AdamW 优化器，配合余弦退火调度器，并将学习率设置为 5e-5，训练序列长度 4096。</p>
<p><strong>训练 DeepSeek-OCR</strong>：</p>
<p>当 DeepEncoder 就绪后，接下来在HAI-LLM平台训练 DeepSeek-OCR。 整个模型使用流水线并行（PP），分为 4 个部分，其中，DeepEncoder 负责 2 个部分，解码器负责 2 个部分。</p>
<ul>
<li>对于 DeepEncoder：将 SAM 与压缩器视为视觉分词器，放在 PP0 并冻结参数；将 CLIP 部分视为输入嵌入层，放在 PP1 并解冻进行训练。</li>
<li>对于语言模型：DeepSeek3B-MoE 共 12 层，在 PP2 与 PP3 各放 6 层。</li>
</ul>
<p>总共使用 20 个节点（每个节点 8× A100-40G）进行训练，数据并行（DP）= 40，全局 batch size = 640。采用 AdamW 优化器，搭配基于步数（step-base）的调度器，并将初始学习率设置为 3e-5。</p>
<p>对于仅纯文本数据，训练速度约 900 亿 tokens/天；而多模态数据，训练速度约 700 亿 tokens/天。</p>
<h2 data-id="heading-15">结语</h2>
<p>DeepSeek-VL的创新点在于混合视觉编码器的设计。它整合了SAM-B和SigLIP-L两个编码器，分别处理高分辨率和低分辨率图像，以此兼顾细粒度细节捕捉和全局语义对齐。通过三阶段训练策略（适配器预热、联合预训练、监督微调），有效避免了模型在学习视觉能力时遗忘原有的语言能力，语言能力保留率达到了95%以上。</p>
<p>DeepSeek-VL2在DeepSeek-VL的基础上，重点攻克了高分辨率图像处理和复杂视觉任务两大难题。通过将高分辨率图像分割成多个图块（tile）分别处理，再整合信息，实现了对图像细节的更精细理解。同时，采用了混合专家（MoE）架构作为语言模型底座，在保持高性能的同时，显著提升了模型的推理效率。</p>
<p>而 DeepSeek OCR 的其核心思想是，将文本内容转换为图像形式，能用比原来少得多的视觉token来表示相同的信息量，从而实现对文本信息的高效压缩。其模型架构由编码器（DeepEncoder）和解码器（DeepSeek-3B-MoE）组成。</p>
<ul>
<li>DeepEncoder：这是一个创新的三级串联架构，能够对高分辨率文档图像进行高效编码和压缩，最终输出极少量（例如256个）的视觉token。</li>
<li>DeepSeek-3B-MoE：作为解码器，它根据编码器压缩提供的视觉摘要，生成最终的文本内容。</li>
</ul>
<p>实验证明，DeepSeek-OCR在10倍压缩率下，解码精度高达约97%（接近无损）；即使在20倍压缩率下，精度仍保持在约60%的可用水准。在实际基准测试中，它仅用100个视觉token的性能就超过了竞品使用256个token的表现。</p>
<p>回顾 DeepSeek 视觉语言大模型的演进路径，可以清晰地看到其技术思路的升级：从初期的多模态能力构建，到中期的处理能力强化，最终走向了利用视觉压缩技术重塑文本处理范式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python-Basic Day-5 函数-生成器&装饰器]]></title>    <link>https://juejin.cn/post/7576484465758748707</link>    <guid>https://juejin.cn/post/7576484465758748707</guid>    <pubDate>2025-11-25T13:32:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576484465758748707" data-draft-id="7574658078269063219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python-Basic Day-5 函数-生成器&amp;装饰器"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-11-25T13:32:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="宋司阳"/> <meta itemprop="url" content="https://juejin.cn/user/1936675617121600"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python-Basic Day-5 函数-生成器&amp;装饰器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1936675617121600/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    宋司阳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T13:32:08.000Z" title="Tue Nov 25 2025 13:32:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:18px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:40px;margin-bottom:20px;color:#007fff;display:flex;align-items:center}.markdown-body h1:hover:before,.markdown-body h2:hover:before,.markdown-body h3:hover:before,.markdown-body h4:hover:before,.markdown-body h5:hover:before,.markdown-body h6:hover:before{transition:All .4s ease-in-out;transform:rotate(1turn)}.markdown-body h1{font-size:30px;background:linear-gradient(#fff 60%,#c6e3ff 0)}.markdown-body h1:before{content:"";display:inline-block;width:32px;height:32px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h2{font-size:24px;background:linear-gradient(#fff 60%,#cce3fb 0)}.markdown-body h2:before{content:"";display:inline-block;width:24px;height:24px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h3{font-size:20px}.markdown-body h3:before{content:"";display:inline-block;width:18px;height:18px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h4{font-size:18px}.markdown-body h4:before{content:"";display:inline-block;width:16px;height:16px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h5{font-size:16px}.markdown-body h5:before{content:"";display:inline-block;width:15px;height:15px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h6{font-size:14px}.markdown-body h6:before{content:"";display:inline-block;width:12px;height:12px;margin-right:10px;background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC");background-size:100% 100%}.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{border-bottom:2px solid #007fff;color:#007fff;padding-right:10px}.markdown-body p{letter-spacing:1px;line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:10px auto}.markdown-body hr{border:none;border-top:1px dashed #92c8ff}.markdown-body hr:before{content:"✂";display:inline-block;position:relative;top:-12px;left:40px;padding:0 3px;color:#007fff;font-size:18px}.markdown-body hr:after{content:"按虚线剪开";position:relative;top:-15px;left:84%;padding:0 3px;color:#007fff;font-size:12px}.markdown-body del{color:#f44}.markdown-body em{color:#007fff;margin:0 2px}.markdown-body strong{color:#007fff;font-weight:bolder}.markdown-body code{word-break:break-word;border-radius:4px;overflow-x:auto;background-color:#e6f3ff;color:#007fff;font-weight:600;font-size:16px;padding:.065em .4em;border:1px solid #007fff}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:5px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:18px;font-weight:400;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8;border:none}.markdown-body a{text-decoration:none;color:#007fff;border-bottom:1px solid #007fff}.markdown-body a:before{content:"¶";margin-right:5px;font-size:22px}.markdown-body a:after{content:"↷";margin-left:2px;font-size:22px;display:none}.markdown-body a:active,.markdown-body a:hover{color:#275b8c;border-bottom:1px solid #275b8c}.markdown-body a:active:after,.markdown-body a:hover:after{display:inline-block}.markdown-body table{display:inline-block!important;font-size:16px;width:auto;max-width:100%;overflow:auto;border:1px solid #a5d3ff}.markdown-body thead{background:#c6e3ff;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#eef7ff}.markdown-body tbody&gt;tr:nth-child(odd){background-color:#f8fcff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #007fff;background-color:#eef7ff}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#007fff}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><h2 data-id="heading-0">一、生成器</h2>
<h3 data-id="heading-1">1.1 生成器基础</h3>
<p>生成器是一种特殊的迭代器，可以按需生成值，而不是一次性生成所有值。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 普通函数 vs 生成器函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">normal_function</span>():
    result = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
        result.append(i)
    <span class="hljs-keyword">return</span> result

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generator_function</span>():
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>):
        <span class="hljs-keyword">yield</span> i

<span class="hljs-comment"># 使用对比</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"普通函数:"</span>, normal_function())  <span class="hljs-comment"># 输出: [0, 1, 2, 3, 4]</span>

gen = generator_function()
<span class="hljs-comment"># 逐个获取生成器的值</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"生成器值:"</span>)
<span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> gen:
    <span class="hljs-built_in">print</span>(value, end=<span class="hljs-string">" "</span>)  <span class="hljs-comment"># 输出: 0 1 2 3 4</span>
</code></pre>
<h3 data-id="heading-2">1.2 生成器用法</h3>
<h4 data-id="heading-3">1.2.1 无限序列</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">infinite_sequence</span>():
    <span class="hljs-string">"""生成无限序列"""</span>
    num = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-keyword">yield</span> num
        num += <span class="hljs-number">1</span>
        
inf_gen = infinite_sequence()
<span class="hljs-comment"># 此处为无限序列，需使用next()</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(inf_gen), end=<span class="hljs-string">" "</span>)
</code></pre>
<h4 data-id="heading-4">1.2.2 生成器管道</h4>
<p>生成器管道是一种高效处理数据序列的编程模式，其核心思想是<strong>惰性求值</strong>和<strong>数据流</strong>。它将一系列数据处理操作（如过滤、转换）串联起来，形成一个“流水线”。与一次性处理所有数据并生成庞大中间列表的传统方法不同，生成器管道中的每个环节都是一个生成器，它只在被请求时才处理一个数据项，并立即将其传递给下一个环节。这种机制带来了两大核心优势：<strong>极低的内存占用</strong>（因为任何时候内存中都只存在单个正在处理的数据项）和<strong>即时的响应能力</strong>（无需等待所有数据处理完就能获得第一个结果）。它特别适合处理大规模文件、实时数据流或任何无法一次性装入内存的数据集，将复杂的批处理任务转变为一个轻量、高效的连续数据流。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">number_generator</span>(<span class="hljs-params">n</span>):
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n):
        <span class="hljs-keyword">yield</span> i
        
<span class="hljs-keyword">def</span> <span class="hljs-title function_">square_number</span>(<span class="hljs-params">numbers</span>):
    <span class="hljs-keyword">for</span> number <span class="hljs-keyword">in</span> numbers:
        <span class="hljs-keyword">yield</span> number ** <span class="hljs-number">2</span>
        
<span class="hljs-keyword">def</span> <span class="hljs-title function_">even_filter</span>(<span class="hljs-params">numbers</span>):
    <span class="hljs-keyword">for</span> number <span class="hljs-keyword">in</span> numbers:
        <span class="hljs-keyword">if</span> number % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>
            <span class="hljs-keyword">yield</span> number
            
numbers = number_generator(<span class="hljs-number">10</span>)
squares = square_number(numbers)
even_number = even_filter(squares)

res = <span class="hljs-built_in">list</span>(even_numbers)
<span class="hljs-built_in">print</span>(res)   <span class="hljs-comment"># 输出: [0, 4, 16, 36, 64]</span>
</code></pre>
<h2 data-id="heading-5">二、装饰器</h2>
<h3 data-id="heading-6">2.1 装饰器基础</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_decorator</span>(<span class="hljs-params">func</span>):
    <span class="hljs-string">"""简单装饰器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"函数执行前"</span>)
        result = func()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"函数执行后"</span>)
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-meta">@simple_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">say_hello</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Hello, World!"</span>)

say_hello()
<span class="hljs-comment"># 输出:</span>
<span class="hljs-comment"># 函数执行前</span>
<span class="hljs-comment"># Hello, World!</span>
<span class="hljs-comment"># 函数执行后</span>
</code></pre>
<p>一个更实用的例子</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">timer_decorator</span>(<span class="hljs-params">func</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
        start_time = time.perf_counter()  <span class="hljs-comment"># 记录开始时间</span>
        result = func(*args, **kwargs)    <span class="hljs-comment"># 执行函数</span>
        end_time = time.perf_counter()    <span class="hljs-comment"># 记录结束时间</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"函数 <span class="hljs-subst">{func.__name__}</span> 耗时: <span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.4</span>f}</span> 秒"</span>)
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-meta">@timer_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fast_function</span>():
    time.sleep(<span class="hljs-number">0.1</span>)

<span class="hljs-meta">@timer_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">slow_function</span>():
    time.sleep(<span class="hljs-number">1</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"开始运行 fast_function..."</span>)
fast_function()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n开始运行 slow_function..."</span>)
slow_function()
</code></pre>
<h3 data-id="heading-7">2.2 保留元数据的装饰器</h3>
<h4 data-id="heading-8">2.2.1 问题根源</h4>
<p>首先，我们回顾一下装饰器的本质：<code>@decorator</code> 等价于 <code>my_function = decorator(my_function)</code>。
这意味着，<code>my_function</code> 这个名字最终指向的不再是原来的函数，而是 <code>decorator</code> 内部返回的那个 <code>wrapper</code> 函数。这就带来了一个问题：<strong>我们丢失了原函数的“身份信息”</strong> 。</p>
<p>让我们先看看<strong>没有</strong> <code>@wraps</code> 会发生什么：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 假设我们有一个没有使用 @wraps 的装饰器</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_decorator</span>(<span class="hljs-params">func</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
        <span class="hljs-string">"""这是wrapper的文档"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"执行一些操作..."</span>)
        <span class="hljs-keyword">return</span> func(*args, **kwargs)
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-meta">@simple_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>):
    <span class="hljs-string">"""向某人问好"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>!"</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"函数名: <span class="hljs-subst">{greet.__name__}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"函数文档: <span class="hljs-subst">{greet.__doc__}</span>"</span>)
</code></pre>
<p><strong>输出会是：</strong></p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">函数名: wrapper</span>
<span class="hljs-section">函数文档: 这是wrapper的文档</span>
</code></pre>
<p>看到了吗？<code>greet</code> 函数的名字和文档字符串，都被 <code>wrapper</code> 函数的覆盖了。这对于调试、文档生成和内省（Introspection，即程序在运行时检查自身对象的能力）来说是灾难性的。我们希望 <code>greet</code> 看起来还像 <code>greet</code>。</p>
<h4 data-id="heading-9">2.2.2 解决方案</h4>
<p><code>functools.wraps</code> 就是专门用来解决这个问题的工具。它本身也是一个装饰器，用在 <code>wrapper</code> 函数上。
它的作用是：<strong>将原函数（<code>func</code>）的元数据（如 <code>__name__</code>, <code>__doc__</code>, <code>__module__</code> 等）复制到 <code>wrapper</code> 函数上</strong>，从而伪装 <code>wrapper</code>，让它看起来和原函数一模一样。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> funtools <span class="hljs-keyword">import</span> wraps

<span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_decorator</span>(<span class="hljs-params">func</span>):
<span class="hljs-meta">    @wraps(<span class="hljs-params">func</span>)     </span><span class="hljs-comment"># &lt;-- 关键就在这里！</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
        <span class="hljs-string">"""这是wrapper的文档"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"执行一些操作..."</span>)
        <span class="hljs-keyword">return</span> func(*args, **kwargs)
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-meta">@simple_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>):
    <span class="hljs-string">"""向某人问好"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>!"</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"函数名: <span class="hljs-subst">{greet.__name__}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"函数文档: <span class="hljs-subst">{greet.__doc__}</span>"</span>)

<span class="hljs-comment"># 输出</span>
<span class="hljs-comment"># 函数名: greet</span>
<span class="hljs-comment"># 函数文档: 向某人问好</span>
</code></pre>
<h3 data-id="heading-10">2.3 装饰器的进阶用法</h3>
<h4 data-id="heading-11">2.3.1 带参数的装饰器</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">repeat</span>(<span class="hljs-params">num_times</span>):
    <span class="hljs-string">"""重复执行装饰器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator</span>(<span class="hljs-params">func</span>):
<span class="hljs-meta">        @wraps(<span class="hljs-params">func</span>)</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>):
            results = []
            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_times):
                result = func(*args, **kwargs)
                results.append(result)
            <span class="hljs-keyword">return</span> results
        <span class="hljs-keyword">return</span> wrapper
    <span class="hljs-keyword">return</span> decorator

<span class="hljs-meta">@repeat(<span class="hljs-params">num_times=<span class="hljs-number">3</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>!"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Greeted <span class="hljs-subst">{name}</span>"</span>

result = greet(<span class="hljs-string">"Alice"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"返回值:"</span>, result)
<span class="hljs-comment"># 输出:</span>
<span class="hljs-comment"># Hello, Alice!</span>
<span class="hljs-comment"># Hello, Alice!</span>
<span class="hljs-comment"># Hello, Alice!</span>
<span class="hljs-comment"># 返回值: ['Greeted Alice', 'Greeted Alice', 'Greeted Alice']</span>
</code></pre>
<p>带参数的装饰器，其核心特征是它<strong>包含三层函数</strong>。这就像一个俄罗斯套娃：</p>
<ol>
<li>
<p><strong>最外层函数（套娃外壳）</strong> ：<code>repeat(num_times)</code></p>
<ul>
<li><strong>作用</strong>：接收你传给装饰器的参数（<code>num_times=3</code>）。</li>
<li><strong>返回值</strong>：它不返回最终结果，而是返回<strong>第二层函数</strong>，也就是一个真正的装饰器。</li>
</ul>
</li>
<li>
<p><strong>中间层函数（真正的装饰器）</strong> ：<code>decorator(func)</code></p>
<ul>
<li><strong>作用</strong>：接收被装饰的函数（<code>greet</code>）。</li>
<li><strong>返回值</strong>：返回<strong>第三层函数</strong>，也就是包装器 <code>wrapper</code>。</li>
</ul>
</li>
<li>
<p><strong>最内层函数（包装器）</strong> ：<code>wrapper(*args, **kwargs)</code></p>
<ul>
<li><strong>作用</strong>：执行真正的逻辑——重复调用原函数，并收集结果。</li>
<li><strong>返回值</strong>：返回最终的计算结果（一个包含所有返回值的列表）。</li>
</ul>
</li>
</ol>
<p><strong>记住这个流程：外层函数接收参数，返回一个装饰器；这个装饰器再接收函数，返回一个包装器。</strong></p>
<h4 data-id="heading-12">2.3.2 类装饰器</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassDecorator</span>:
    <span class="hljs-string">"""类装饰器"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, func</span>):
        self.func = func
        self.call_count = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__call__</span>(<span class="hljs-params">self, *args, **kwargs</span>):
        self.call_count += <span class="hljs-number">1</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"第 <span class="hljs-subst">{self.call_count}</span> 次调用 <span class="hljs-subst">{self.func.__name__}</span>"</span>)
        <span class="hljs-keyword">return</span> self.func(*args, **kwargs)

<span class="hljs-meta">@ClassDecorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">example_function</span>():
    <span class="hljs-keyword">return</span> <span class="hljs-string">"函数执行结果"</span>

<span class="hljs-built_in">print</span>(example_function())  <span class="hljs-comment"># 输出: 第 1 次调用 example_function \n 函数执行结果</span>
<span class="hljs-built_in">print</span>(example_function())  <span class="hljs-comment"># 输出: 第 2 次调用 example_function \n 函数执行结果</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG基础知识]]></title>    <link>https://juejin.cn/post/7576487832090312719</link>    <guid>https://juejin.cn/post/7576487832090312719</guid>    <pubDate>2025-11-25T14:59:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576487832090312719" data-draft-id="7576484465758928931" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG基础知识"/> <meta itemprop="keywords" content="机器学习"/> <meta itemprop="datePublished" content="2025-11-25T14:59:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞扬的风信子"/> <meta itemprop="url" content="https://juejin.cn/user/1820446983470174"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG基础知识
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1820446983470174/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞扬的风信子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T14:59:54.000Z" title="Tue Nov 25 2025 14:59:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>1.1 RAG简介</strong></h2>
<p><strong>1. RAG定义</strong></p>
<p><strong>RAG（Retrieval-Augmented Generation，检索增强生成）是一种结合检索和生成技术的方法</strong>。2020年，Facebook AI Research(FAIR)团队发表名为《<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Farxiv.org%2Fabs%2F2005.11401v4" target="_blank" title="https://link.zhihu.com/?target=https%3A//arxiv.org/abs/2005.11401v4" ref="nofollow noopener noreferrer">Retrieval-Augmented Generation for Knowledge-Intensive NLP Tasks</a>》的论文，该篇论文首次提出了RAG概念。<strong>在大模型领域中，RAG特指一种模式：模型在回答问题或生成文本时，首先从广阔的文档库中寻找相关信息。然后，模型使用这些找到的信息来生成回答或文本，从而提高其预测的准确度</strong>。RAG的方法使得开发人员无需为每一个特定任务重新训练整个庞大的模型，他们可以简单地给模型加上一个知识库，通过这种方式增加模型的信息输入，从而提高回答的精确性。</p>
<p><strong>2.</strong> <strong>RAG作用</strong></p>
<p>RAG作为一种工程化解决方案，能够有效解决上述问题大模型应用于实际业务场景时，遇到的以下问题：</p>
<ul>
<li>
<p><strong>知识的局限性：</strong></p>
<ul>
<li><strong>信息滞后</strong>，大模型训练的成本非常高昂，训练数据非实时，比如使用2025年1月之前的数据训练，那么对于2025年1月之后的事情就不得而知了，如天气、新闻、政策等，只依赖大模型基本上无法得到正确的答案。</li>
<li><strong>私有数据匮乏</strong>，LLM的训练数据主要来源于互联网公开的数据，而垂类领域、企业内部等有很多专属知识，这部分是LLM无法直接提供的。</li>
</ul>
</li>
<li>
<p><strong>幻觉</strong>：大模型的底层生成原理是基于概率，自身并不具备任何判断回复是否符合现实世界事实的能力，所以有时候会一本正经胡说八道，当模型生成的文本不遵循原文或者不符合事实，生成的内容是无意义的。</p>
</li>
<li>
<p><strong>token大小</strong>：目前，不同模型对token的限制也不同，以gpt-4o为例，上下文最多支持128k个token（约10w个字，相当于100-200页的日常书籍），无法给到模型大量的外部知识，例如想要模型直接基于行业产品整理好的文档或者行业数据库做问答。所以需要对输入给大模型的上下文做选择性的筛选。</p>
</li>
<li>
<p><strong>数据安全性</strong>：对于企业来说，数据安全至关重要，没有企业愿意承担数据泄露的风险，将自身的私域数据上传第三方平台进行训练。</p>
</li>
</ul>
<h2 data-id="heading-1"><strong>1.2 RAG架构</strong></h2>
<p><strong>1. 基本认知</strong></p>
<ul>
<li>
<p><strong>离线</strong>：对知识库文档进行解析、拆分、索引构建和入库。这部分会从用户给定的文档、图片、表格和外部URL等资源中提取内容，然后通过chunking（可以认为是将连续的文本分成一个个小块）进行合理切割，再使用Embedding模型变成向量数据存入向量数据库或elasticsearch等载体中，同时结合这些非结构化文件所附带的元数据（时间、文件名、作者、副标题、文件类型等）进行索引创建。</p>
</li>
<li>
<p><strong>在线</strong>：当用户输入问题之后，我们会对query进行分析，如关键词提取、意图识别等，然后再根据路由条件进行知识库的多种召回检索或者联网搜索等。如果是做向量数据库的检索，会先将查询内容通过Embedding模型转化为向量数据，接着在向量数据库中进行相似度匹配，比如从百万的数据块中找出匹配度较高的100个，然后再将这100个数据块进行更精准的重排序（如使用交叉熵校验的Rerank算法），将最相关的top k结果找到，最后将用户问题，经过技术处理的top k数据块，还有prompt一起提交给LLM，让它生成最终可靠的答案。</p>
<p>另外，为了进一步提高系统的稳定性，我们也会引入后置处理的环节，如风控检测、结果缓存和RAG相关指标的监控上报等。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c8293a78b624b60a06acd30f82227ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5oms55qE6aOO5L-h5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764687594&amp;x-signature=p58QocsV5YPNW18Ag8NmJnkTUMQ%3D" alt="image.png" loading="lazy"/></p>
<p><strong>2. RAG迭代优化</strong></p>
<p>目前RAG已经经过一轮迭代发展，主要分三个阶段，分别是原始RAG、高级RAG、模块化RAG，三者的大致区别如下图所示。</p>
<p>原始RAG只具备了最基础的部分：离线索引构造、在线检索以及大模型生成。</p>
<p>高级RAG则是在这3个流程里增加更多细化的工作，用于进一步优化，重点在检索层面的优化，例如增加：数据预处理、文章切片、用户query重写、检索结果重排等，提升检索模块的质量。</p>
<p>模块化RAG则是一个更为精细的系统，它是高级RAG在工程化上的改进，对RAG流程步骤和能力做模块化，供各个业务场景灵活的选择和编排。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41b956b64d13443eb42fd78bd65bc87c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5oms55qE6aOO5L-h5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764687594&amp;x-signature=XlvU6a2qAYVaBuQFKqm7VAWA5sM%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器插件开发经验分享二：如何处理日期控件]]></title>    <link>https://juejin.cn/post/7576489970761449478</link>    <guid>https://juejin.cn/post/7576489970761449478</guid>    <pubDate>2025-11-25T15:51:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576489970761449478" data-draft-id="7576477434733985798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器插件开发经验分享二：如何处理日期控件"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-25T15:51:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一树论"/> <meta itemprop="url" content="https://juejin.cn/user/2400989124504286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器插件开发经验分享二：如何处理日期控件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2400989124504286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一树论
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T15:51:59.000Z" title="Tue Nov 25 2025 15:51:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天搞定了小插件的“定时新章节”功能，我的浏览器小插件又有了小小更新。</p>
<p>定时新章节页面里用到了 Arco Picker 组件，处理这个组件 AI 一开始也是一头雾水。由于浏览器插件开发是将 js 注入到别人的 html 页面之内，所以我们不能引用类库、用常规的前端方法去设置日期/时间控件的值。</p>
<p>怎么办？</p>
<p>直接设置是行不通的，设置完之后还会恢复成默认值。</p>
<p>像这样的情况，我在一篇文章分享中提过了，这是属于 AI 不熟悉的业务逻辑。当然现在我熟悉了，我指导 AI 完成了正确的开发，这是因为我懂前端开发，我懂 html/js/css 及浏览器插件接口这些东西。如果我不懂呢？我知道什么提示语能让 AI 做出正确的行动吗？我可以，并不代表别人也可以。如果我不共享我的项目数据、不提供给 AI 作为训练资料，别人遇到类似情况也要像我一样从头摸索。</p>
<p>今天我在 X 上看到一篇帖子，说某公司计划把前端部门裁掉，只保留产品部门和后端部门，后端部门提供接口价值，产品部门负责起所有 UI 和前端工作。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88239dd478e24eacb3bbc370998a0969~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5qCR6K66:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764690719&amp;x-signature=gl90JNnPneIkpuOBogzUD4TgxVU%3D" alt="3dadd8b4f3cd95825a23e92239f88140.png" loading="lazy"/></p>
<p>我想问问这位公司老板，产品部门的工作包括前端的 Debug 吗？</p>
<p>你把前端部门解散了，等产品部门 Debug 搞不定的时候，你就只能抓耳挠腮了。Gemini 3 Pro 在大多数项目上可以，但不代表在所有项目上都能顶用，尤其在创新业务上。除非你的项目没有创新，话又说回来，项目没有创新，产品部门和后端部门也可以砍掉，只留一个全栈工程师就够了。希望这个帖子只是一个段子。</p>
<p>最后说一下，在浏览器插件开发里面，Arco 日期/时间控件怎么处理？</p>
<p>一共分两步。首先，先用下面这个通用的工具函数设置控件的值：</p>
<pre><code class="hljs language-rust" lang="rust">function <span class="hljs-title function_ invoke__">setReactInputValue</span>(inputElement, newValue) {
    <span class="hljs-title function_ invoke__">if</span> (!inputElement) <span class="hljs-keyword">return</span>;
​
    <span class="hljs-comment">// 1. 获取原生 input 的 value setter</span>
    <span class="hljs-comment">// 这是为了绕过 React 对 value 属性的劫持</span>
    <span class="hljs-keyword">const</span> nativeInputValueSetter = Object.<span class="hljs-title function_ invoke__">getOwnPropertyDescriptor</span>(
        window.HTMLInputElement.prototype, 
        <span class="hljs-string">"value"</span>
    ).set;
​
    <span class="hljs-comment">// 2. 调用原生 setter 设置值</span>
    nativeInputValueSetter.<span class="hljs-title function_ invoke__">call</span>(inputElement, newValue);
​
    <span class="hljs-comment">// 3. 构造并触发 input 事件 (React 监听的是 input 事件来更新 state)</span>
    <span class="hljs-keyword">const</span> event = new <span class="hljs-title function_ invoke__">Event</span>(<span class="hljs-symbol">'input</span>', { bubbles: <span class="hljs-literal">true</span> });
    inputElement.<span class="hljs-title function_ invoke__">dispatchEvent</span>(event);
    
    <span class="hljs-comment">// 4. 有些组件可能还需要触发 change 或 blur</span>
    inputElement.<span class="hljs-title function_ invoke__">dispatchEvent</span>(new <span class="hljs-title function_ invoke__">Event</span>(<span class="hljs-symbol">'change</span>', { bubbles: <span class="hljs-literal">true</span> }));
    inputElement.<span class="hljs-title function_ invoke__">dispatchEvent</span>(new <span class="hljs-title function_ invoke__">Event</span>(<span class="hljs-symbol">'blur</span>', { bubbles: <span class="hljs-literal">true</span> })); <span class="hljs-comment">// 触发失焦关闭面板</span>
}
</code></pre>
<p>设置完以后，控件处于打开状态，接着再分别单击子控件确认。对于日期控件，就是选择当前被选中的那个值所在的控件，点击它即可。对于时间控件，就是单击一个小“确定”按钮。</p>
<p>11月 25 日</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cursor]]></title>    <link>https://juejin.cn/post/7576550156364873734</link>    <guid>https://juejin.cn/post/7576550156364873734</guid>    <pubDate>2025-11-26T01:55:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576550156364873734" data-draft-id="7574734686493835300" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cursor"/> <meta itemprop="keywords" content="Cursor"/> <meta itemprop="datePublished" content="2025-11-26T01:55:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WebGirl"/> <meta itemprop="url" content="https://juejin.cn/user/3227821868584478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cursor
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821868584478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WebGirl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T01:55:47.000Z" title="Wed Nov 26 2025 01:55:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读37分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">AI编程入门</h2>
<p>在传统的编程模式中，开发程序是一项高度专业化的任务。程序员需要具备深厚的技术背景，掌握至少一门编程语言比如 Python 、Java 、C++ 等等。并且要对复杂的逻辑和算法有清晰的理解。他们通过编写一行行代码，精确地告诉计算机每一步该怎么做。但这个过程需要深厚的专业知识、严谨的逻辑思维和极大的耐心。且门槛较高、开发周期较长。</p>
<p>然而，随着 AI 人工智能技术的飞速发展，编程的方式正在迎来革命性的变化。现在，我们迎来了一个全新的阶段：你不再需要精通晦涩难懂的编程语法，甚至不需要直接面对复杂的代码编辑器。取而代之的是，你可以像和朋友聊天一样，用自然、日常的语言，向一个强大的 AI 大模型（比如我们常说的 DeepSeek、ChatGPT、豆包等）描述你的需求。</p>
<p>想象一下，你只需要告诉 AI：“我想要一个能计算两个数之和的小程序。” 或者 “帮我设计一个简单的网页，上面有个按钮，点击后能显示‘你好，世界！’”。然后，这个 AI 大模型就像一个超级能干的编程助手，它会理解你的意图，迅速生成相应的代码，甚至可能是一个可以直接运行的程序。</p>
<p>所以，我们可以这样理解：<strong>用自然语言进行 “对话” + 背后强大的 “AI 大模型” 智能处理 = 这就是 AI 编程的核心。</strong></p>
<p>AI 编程的核心在于利用强大的 AI 大模型来辅助甚至主导编程过程。这些 AI 大模型经过海量数据的训练，具备了理解和生成代码的能力。通过简单的对话聊天，即使是非专业的用户，也能够与 AI 大模型交互，快速生成所需的程序代码。</p>
<p>这种模式的出现，极大地降低了编程的门槛，使得更多的人能够参与到软件开发中来。无论是初学者还是有一定基础的开发者，都可以借助 AI 大模型的智能辅助，快速实现自己的想法，提高开发效率。</p>
<h2 data-id="heading-1">主流AI编程IDE对比</h2>
<p>市面上流行的 AI 编程 IDE（集成开发环境）有很多，下面对比几款主流 AI 编程工具，看看它们各自的特点和区别。</p>



























































<table><thead><tr><th>工具名称</th><th>类型</th><th>核心功能</th><th>支持模型</th><th>价格</th><th>优势</th><th>劣势</th></tr></thead><tbody><tr><td>GitHub Copilot</td><td>IDE 插件</td><td>代码补全、Copilot Chat、支持多种语言</td><td>GPT-4o、Claude 3.7 等</td><td>个人用户每月 10 美元或每年 100 美元</td><td>代码补全能力强、支持广泛语言、成熟社区</td><td>对整个代码库的理解有限，基本重构能力较弱</td></tr><tr><td>Cursor AI</td><td>独立 IDE</td><td>代码生成、重构、自然语言编辑、多文件协作</td><td>OpenAI 系列、Claude 系列、DeepSeek 系列</td><td>免费版，Pro 版每月 20 美元</td><td>AI 编程第一选择，最强 AI 编程 IDE，接入新模型的速度非常快，适合专业开发</td><td>价格较高</td></tr><tr><td>Windsurf IDE</td><td>独立 IDE</td><td>AI Flow 动态思维画布、实时差分评估、本地优先 AI</td><td>OpenAPI 系列、DeepSeek 系列</td><td>免费版，Pro 版每月 15 美元</td><td>本地运行 AI 模型、快速性能、以 Web 为中心</td><td>还不够成熟，需要高端硬件</td></tr><tr><td>Trae</td><td>独立 IDE</td><td>自然语言到代码的转化、低代码开发</td><td>Claude 3.5、DeepSeek R1</td><td>免费</td><td>国产工具，免费且有潜力</td><td>功能相对基础，社区支持有限</td></tr><tr><td>Codeium</td><td>IDE 插件</td><td>代码生成、聊天、搜索功能</td><td>未明确</td><td>免费</td><td>免费使用，支持多种语言和 IDE</td><td>功能相对基础</td></tr></tbody></table>
<p>**简单小结一下： **</p>
<ul>
<li>
<p>如果你要深度体验一波 AI 编程的魅力，首选 Cursor。Cursor 是一款以 AI 为核心的代码编辑器，它基于 Visual Studio Code（VS Code）开发，继承了 VS Code 的强大功能，并在此基础上加入了深度集成的 AI 功能。</p>
</li>
<li>
<p>如果你是国产爱好者且想免费白嫖，首选字节跳动出品的 Trae。</p>
</li>
</ul>
<h2 data-id="heading-2">Cursor快速入门与配置</h2>
<blockquote>
<p>ctrl+k 选中部分代码进行AI操作</p>
<p>ctrl+l 调出chat窗口进行AI操作</p>
</blockquote>
<h3 data-id="heading-3">Cursor简介</h3>
<p>Cursor 是一款基于人工智能的现代代码编辑器，由 Anysphere 公司开发。Cursor 是基于 VS Code 开发的一款编辑器，它在保留 VS Code 强大功能和熟悉操作体验的同时，专注于集成 AI 技术，帮助开发者更高效地编写代码。</p>
<p>另外国内阿里与字节也有基于 VS Code 开发的 IDE：</p>
<ul>
<li><strong>阿里 Lingma IDE</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flingma.aliyun.com%2F" target="_blank" title="https://lingma.aliyun.com/" ref="nofollow noopener noreferrer">lingma.aliyun.com/</a></li>
<li><strong>字节 Trae</strong>：<a href="https://www.trae.com.cn/" target="_blank" title="https://www.trae.com.cn/" ref="nofollow noopener noreferrer">www.trae.com.cn/</a></li>
</ul>
<p><strong>核心特征：</strong></p>
<ul>
<li>AI 原生设计：从底层架构就融入了 AI 能力，而非后期添加的插件</li>
<li>智能代码生成：通过自然语言描述快速生成代码片段</li>
<li>上下文感知：深度理解项目结构和代码关系</li>
<li>实时协助：在编程过程中提供即时的建议和优化</li>
<li>多模型支持：集成了多种先进的大语言模型</li>
</ul>
<p><strong>Cursor 与传统 IDE 的区别</strong></p>




























































<table><thead><tr><th>功能特性</th><th>传统 IDE</th><th>Cursor</th></tr></thead><tbody><tr><td>代码补全</td><td>基于语法分析和已有代码的静态补全</td><td>AI 驱动的智能补全，理解上下文和意图</td></tr><tr><td>代码生成</td><td>依靠预设模板和代码片段</td><td>通过自然语言描述生成完整代码逻辑</td></tr><tr><td>问题解决</td><td>需要手动查找文档、Stack Overflow 等</td><td>内置 AI 助手，即时解答编程问题</td></tr><tr><td>代码理解</td><td>提供语法高亮和基础结构分析</td><td>深度理解代码逻辑，提供详细解释</td></tr><tr><td>重构优化</td><td>手动操作，依赖开发者经验</td><td>AI 智能分析并建议最佳重构方案</td></tr><tr><td>学习支持</td><td>需要外部资料和文档</td><td>内置技术知识，实时学习辅导</td></tr><tr><td>错误处理</td><td>显示编译错误和基础语法检查</td><td>预测潜在问题，提供修复建议和解释</td></tr><tr><td>项目理解</td><td>文件级别的分析和导航</td><td>整个项目架构的深度理解和关联分析</td></tr><tr><td>协作方式</td><td>主要依赖团队成员间的沟通</td><td>AI 作为智能编程伙伴参与开发过程</td></tr><tr><td>适应性</td><td>需要手动配置和插件扩展</td><td>自动适应项目类型和编程语言特点</td></tr></tbody></table>
<p><strong>核心差异总结：</strong></p>


















































<table><thead><tr><th>对比维度</th><th>传统 IDE</th><th>Cursor</th></tr></thead><tbody><tr><td>交互方式</td><td>基于菜单、快捷键的工具操作</td><td>自然语言对话 + 传统操作</td></tr><tr><td>学习曲线</td><td>需要记忆大量快捷键和功能位置</td><td>通过对话快速上手，降低学习门槛</td></tr><tr><td>开发效率</td><td>依赖开发者经验和熟练度</td><td>AI 辅助显著提升编码速度</td></tr><tr><td>代码质量</td><td>主要依靠开发者技能水平</td><td>AI 持续提供最佳实践建议</td></tr><tr><td>知识获取</td><td>需要主动搜索和学习</td><td>被动接收 AI 推荐和解释</td></tr><tr><td>问题诊断</td><td>基于错误信息手动排查</td><td>AI 分析问题根源并提供解决方案</td></tr><tr><td>创新能力</td><td>受限于开发者知识范围</td><td>AI 提供多样化解决思路</td></tr><tr><td>适用人群</td><td>需要一定编程基础</td><td>适合各个水平的开发者</td></tr></tbody></table>
<p>如果您之前使用 VS Code，可以轻松将您的扩展、主题、设置和快捷键一键导入到 Cursor 中。</p>
<p>只需进入 Cursor Settings &gt; General &gt; Account，选择 import 导入配置文件，即可完成迁移。</p>
<p>Cursor会定期同步VS Code的最新版本，确保您始终使用最新的功能和优化。</p>
<p><strong>为什么 Cursor 是一个独立应用，而不是 VS Code 的插件？</strong>
作为独立应用，Cursor 可以更深度地优化编辑器界面，并实现更强大的 AI 集成，例如，Cursor Tab 和 CMD-K 等功能，无法通过插件形式在现有编程环境中实现。</p>
<p><strong>如何设置 Cursor？</strong></p>
<ul>
<li>点击右上角的齿轮按钮，或按下快捷键 Ctrl/⌘ + Shift + J，即可打开 Cursor 的专属设置面板。</li>
<li>您也可以通过 Ctrl/⌘ + Shift + P，输入 Cursor Settings 来打开。</li>
</ul>
<p><strong>为什么 Cursor 的活动栏是水平的？</strong></p>
<p>默认情况下，Cursor 的活动栏是水平放置的，这是为了节省空间，方便集成聊天功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eb9224478da48fd94c1042669ae350b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=rFHZ5RLCPutZNEqQx%2FhMGwqMyBw%3D" alt="image.png" loading="lazy"/></p>
<p>如果您更喜欢传统的垂直活动栏，可以按照以下步骤调整：</p>
<ul>
<li>打开 Cursor 设置。</li>
<li>搜索并找到<code>workbench.activityBar.orientation</code>，将其值改为<code>vertical</code>。</li>
<li>重启 Cursor 即可生效。</li>
</ul>
<p><strong>Cursor 免费版和收费版区别？</strong>
Cursor 功能虽强大，但也分为免费版和收费版，不同版本之间功能区别较大。</p>
<ul>
<li><strong>免费版</strong>：免费版只能使用较差的模型，无法使用最强的编程模型，每个月仅能使用 50 次请求（可能还有更多限制），Cursor 免费用户的限制随着时间一直在增加。</li>
<li><strong>收费版（Pro）</strong>：支持无限次 tab 使用、每月 500 次高速请求，可使用各类最优的编程模型，也能使用 MAX 模式，每月费用 20 美元（约合人民币 140 元），年付更优惠。</li>
</ul>
<p><strong>如何充值？</strong></p>
<p>在 Cursor 官网登录账户后，进入订阅页面，选择 Pro 版或 Business 版，点击 “Get Started” 或 “开始使用” 按钮。</p>
<p>Cursor提供多种订阅等级，以满足不同用户的需求。</p>
<p><strong>Hobby 计划</strong></p>
<ul>
<li>14 天 Pro 试用（包含 250 次快速高级模型使用）</li>
<li>50 次慢速高级模型使用</li>
<li>2000 次代码补全使用</li>
</ul>
<p><strong>Pro 计划</strong></p>
<ul>
<li>每月 500 次快速高级模型使用</li>
<li>无限次慢速高级模型使用</li>
<li>无限次代码补全使用</li>
<li>每月 10 次 o1+mini 使用</li>
</ul>
<p><strong>Business 计划</strong></p>
<ul>
<li>使用量与 Pro 计划相同</li>
<li>全组织范围强制启用隐私模式</li>
<li>集团团队账单管理</li>
<li>管理员仪表盘，查看使用统计</li>
<li>支持 SAML/OIDC 单点登录 (SSO)</li>
</ul>
<p><strong>高级模型</strong></p>
<p>GPT-4、GPT-4o 和 Claude 3.5 Sonnet 均被视为高级模型。每次 Claude 3.5 Haiku 的请求计为 1/3 次高级模型请求。</p>
<h4 data-id="heading-4">Pro 试用</h4>
<p>所有新用户均可享受 14 天 Pro 试用，试用期间可使用所有 Pro 功能以及 250 次快速高级模型请求。14 天试用期结束后，未升级的用户将自动降级为 Hobby 计划。</p>
<h4 data-id="heading-5">快速与慢速请求</h4>
<p>默认情况下，Cursor 服务器会尽量为所有用户提供快速高级模型请求。但在高峰时段，快速请求额度用尽的用户将被移至慢速请求池，即等待快速请求可用的队列中。该队列是公平的，Cursor 会尽力缩短队列等待时间。如果您需要更多快速请求且不想等待，可以在设置页面购买额外额度。</p>
<h4 data-id="heading-6">查看使用情况</h4>
<p>您可以在 Cursor 设置页面查看：</p>
<ul>
<li>在 Cursor 应用中，进入<code>Cursor Settings &gt; General &gt; Account</code>。</li>
<li>Cursor 的使用量每月重置，重置时间基于您的订阅开始日期。</li>
</ul>
<h3 data-id="heading-7">Cursor安装</h3>
<ul>
<li>Cursor 是一款跨平台的代码编辑器，支持 Windows、macOS 和 Linux 系统。</li>
<li>Cursor 官方网站下载页面：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cursor.com%2Fdownloads" target="_blank" title="https://www.cursor.com/downloads" ref="nofollow noopener noreferrer">www.cursor.com/downloads</a>。</li>
</ul>
<h4 data-id="heading-8">最低系统要求</h4>

























<table><thead><tr><th>操作系统</th><th>版本要求</th><th>架构支持</th></tr></thead><tbody><tr><td>Windows</td><td>Windows 10 版本 1903 或更高</td><td>x64, ARM64</td></tr><tr><td>macOS</td><td>macOS 10.15 Catalina 或更高</td><td>Intel x64, Apple Silicon（M1/M2）</td></tr><tr><td>Linux</td><td>Ubuntu 18.04+, Debian 10+, RHEL 8+, SUSE 15+</td><td>x64, ARM64</td></tr></tbody></table>
<h4 data-id="heading-9">硬件要求</h4>
<ul>
<li>内存（RAM）：最低 4GB，推荐 8GB 或更多</li>
<li>存储空间：至少 2GB 可用磁盘空间</li>
<li>处理器：支持 SSE2 的 x64 或 ARM64 处理器</li>
<li>网络连接：稳定的互联网连接（AI 功能必需）</li>
<li>显示器：分辨率至少 1024x768</li>
</ul>
<p>默认情况下访问 Cursor 官网<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cursor.com%2F" target="_blank" title="https://www.cursor.com/" ref="nofollow noopener noreferrer">www.cursor.com/</a>，页面会根据你的系统自动匹配安装包，比如我是 macOS，就会出现 Download for macOS 按钮：</p>
<p><strong>各系统对应安装包格式：</strong></p>
<ul>
<li>Windows：下载 .exe 安装包</li>
<li>macOS：下载 .dmg 镜像文件</li>
<li>Linux：下载 .deb（Ubuntu/Debian）或 .rpm（RHEL/SUSE）包</li>
</ul>
<h4 data-id="heading-10">Windows 系统安装步骤</h4>
<ol>
<li>打开浏览器，访问 Cursor 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cursor.com%2F" target="_blank" title="https://www.cursor.com/" ref="nofollow noopener noreferrer">www.cursor.com/</a>。</li>
<li>点击页面上的 “Download for Windows” 按钮，下载 Cursor 安装包（exe 文件）。</li>
<li>双击下载的安装包，启动安装程序。</li>
<li>按照提示选择安装路径，建议使用默认路径。</li>
<li>点击 “Install” 按钮，等待安装完成。</li>
<li>安装完成后，点击 “Finish” 按钮，启动 Cursor 编辑器</li>
</ol>
<h4 data-id="heading-11">macOS 系统安装步骤</h4>
<ol>
<li>打开浏览器，访问 Cursor 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cursor.com%2F" target="_blank" title="https://www.cursor.com/" ref="nofollow noopener noreferrer">www.cursor.com/</a>，点击页面上的 “Download for Mac” 按钮，下载 Cursor 安装包（dmg 文件）。</li>
<li>双击下载的 dmg 文件，将 Cursor 应用程序图标拖动到 “Applications” 文件夹中，完成安装。</li>
<li>打开 “Applications” 文件夹，双击 Cursor 图标，启动编辑器。</li>
</ol>
<h4 data-id="heading-12">Linux 系统安装步骤</h4>
<ol>
<li>打开浏览器，访问 Cursor 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cursor.com%2F" target="_blank" title="https://www.cursor.com/" ref="nofollow noopener noreferrer">www.cursor.com/</a>，点击页面上的 “Download for Linux” 按钮，选择适合您 Linux 发行版的安装包（deb 或 rpm 文件）。</li>
</ol>
<h4 data-id="heading-13">安装后需要注册与登录</h4>
<p>安装包安装完成后，需要设置一些配置信息，语言建议选择中文。</p>
<p>如果本机之前安装过VS Code，可以导入 VS Code的扩展。</p>
<p>首次使用Cursor时，需要注册一个新账号或使用已有账号进行登录，也可以用Github等授权登录。</p>
<h3 data-id="heading-14">Cursor设置</h3>
<h4 data-id="heading-15">第一次启动流程：</h4>
<h5 data-id="heading-16">1、欢迎界面</h5>
<ul>
<li>选择界面语言（支持中文、英文等）</li>
<li>阅读并接受服务条款</li>
<li>选择是否发送使用数据以改进产品</li>
</ul>
<h5 data-id="heading-17">2、主题与外观设置</h5>
<ul>
<li>选择深色 / 浅色主题</li>
<li>调整字体大小（默认、大、超大）</li>
<li>设置颜色主题（默认、高对比度等）</li>
</ul>
<h5 data-id="heading-18">3、键盘快捷键方案</h5>
<ul>
<li>默认方案（Cursor 原生）</li>
<li>VS Code 兼容方案</li>
<li>Vim 模式（适合 Vim 用户）</li>
<li>自定义方案</li>
</ul>
<h5 data-id="heading-19">4、编程语言检测</h5>
<ul>
<li>Cursor 会扫描系统中已安装的开发工具</li>
<li>自动配置常用编程语言的支持</li>
<li>提示安装缺失的语言服务器</li>
</ul>
<h5 data-id="heading-20">5、工作区设置</h5>
<ul>
<li>选择默认工作区位置</li>
<li>配置项目模板路径</li>
<li>设置自动保存选项</li>
</ul>
<h3 data-id="heading-21">Cursor中文设置</h3>
<p>Cursor 是基于 VS Code 开发的一款编辑器，所以它的扩展使用的也是 VS Code 的扩展市场。默认 Cursor 的界面是英文的，我们可以通过 VS Code 的扩展市场安装中文包。</p>
<p>VS Code 有一个内置的扩展市场，提供了数千个由社区和微软官方提供的扩展。接下来我们就在扩展市场中查找中文包，并安装。</p>
<p>VSCode 安装汉化包很简单，打开 Cursor，点击左侧安装扩展图标，在搜索框输入 Chinese:</p>
<p>安装完成后，重启Cursor，界面显示的就是中文了。</p>
<h3 data-id="heading-22">Cursor界面介绍</h3>
<p>Cursor 编辑器的主界面设计简洁直观，主要由以下几个部分组成：</p>
<ul>
<li>菜单栏：位于窗口的顶部，包含文件、编辑、视图、运行、工具和帮助等菜单项。</li>
<li>侧边栏：位于窗口的左侧，通常显示项目文件结构、搜索、版本控制等功能。</li>
<li>编辑区：位于窗口的中央，是编写和编辑代码的主要区域。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dee07cfe8dac49aaa211cf7029c351c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=iyA5iHfOW7i8lLralAy7kFm99ho%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ad348a53de44827b059ad2c77a9f158~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=rxTONMK3UwlIYKXFjTFlf1NCFCk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-23">菜单详解</h4>
<h3 data-id="heading-24">Cursor打开目录</h3>
<p>我们可以在 Cursor 中打开一个代码文件，也可以在 Cursor 中打开一个目录（文件夹），这是一个简单的过程，操作都很简单。</p>
<p>首先，我们打开已经安装好的 Cursor，在 Cursor 首次打开时，你会看到一个项目的 Open a folder（打开目录）按钮。</p>
<p><strong>欢迎界面的中间区域，有三个非常核心的按钮：</strong></p>
<ul>
<li>Open project：打开本地已有的项目文件夹，适合本地开发者直接导入已有项目。</li>
<li>Clone repo：直接从 Git 仓库克隆项目，支持输入 Git 仓库地址，一键拉取代码，非常方便做远程协作或开源项目学习。</li>
<li>Connect via SSH：通过 SSH 连接远程服务器上的项目，非常适合远程开发场景，尤其适合云服务器上的项目调试。</li>
<li>Recent projects：列出最近打开的项目。</li>
</ul>
<p>我们也可以打开一个已存在的文件或目录（文件夹），比如我们打开一个 runoob-test，打开该目录后，它就会显示在资源管理器中：</p>
<h3 data-id="heading-25">Cursor模型设置</h3>
<p>Cursor 强大之处就是充分利用了大模型的能力。Cursor 内置了很多大模型，当然我们可以自定义设置模型，设置也非常简单。</p>
<h4 data-id="heading-26">1、打开设置</h4>
<p>点击右上角的齿轮图标，打开设置界面。</p>
<p>选择 Models (模型)，可以看到系统默认已经设置了一些大模型，选择你想要的模型，如 GPT-3.5 或 GPT-4。</p>
<p>我们可以在列表底部 Add Model (添加模型) 按钮。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9362d9b04ecb43b6970e801dc36c2845~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=3hwt8rZL9lKWGKJZgfBPUF9ihWY%3D" alt="image.png" loading="lazy"/></p>
<p>点击按钮后，会出现一个输入框，我们输入模型名，比如 deepseek-v3 及 deepseek-r1。</p>
<p><strong>注意：模型名一定不能输错。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e6f89876c964b2d8f26b29b70f89487~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=aZH7potvq2zoFobTY41DRlN6po4%3D" alt="image.png" loading="lazy"/></p>
<p>模型添加好后，我们需要设置 API key 和请求地址，在下面输入框输入即可：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca52276261dc4513af43f291c92d155d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=NkYBt9clbzMEDenBsdCS9PVxYGg%3D" alt="image.png" loading="lazy"/></p>
<p>API key 和请求地址需要去大模型的官方获取，当然如果第三方平台有提供的也可以，比如 DeepSeek 的可以去官方<a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2Fusage" target="_blank" title="https://platform.deepseek.com/usage" ref="nofollow noopener noreferrer">platform.deepseek.com/usage</a>申请：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b351ecd644f54497a7b8c4bb36cbe900~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=ocVwy1Dp70KriC%2Ba6vVq3Onsl6U%3D" alt="image.png" loading="lazy"/></p>
<p>请求地址官方的接口文档都会说明，DeepSeek 的为：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.deepseek.com%2Fchat%2Fcompletions" target="_blank" title="https://api.deepseek.com/chat/completions" ref="nofollow noopener noreferrer">api.deepseek.com/chat/comple…</a>。</p>
<p>设置完成后，我们可以点击 Verify 按钮，看看是否设置成功，如果没有报错信息说明成功了，模型列表中也会出现我们添加的模型，我们把其他的勾选去掉，勾选这以下两个就可以开始使用了。</p>
<h3 data-id="heading-27">Cursor code/cursor命令</h3>
<p>Cursor 是一款基于 Visual Studio Code（VS Code）的现代化代码编辑器，所以它继承了 VS Code 的强大功能，如本文要介绍的 code 命令。</p>
<p>在 Visual Studio Code 中，<strong>code</strong> 或 <strong>cursor</strong> 命令是一个命令行工具，用于快速打开 VS Code 并执行一些与代码相关的操作。</p>
<p>code 命令直接可以帮助开发者从终端或命令提示符中直接启动 VS Code 或处理特定的任务。</p>
<p>最常用的方式就是使用 code 或 cursor 命令直接从命令行中打开文件目录，此时需要先安装 code 命令。</p>
<p>Cursor 支持将终端启动命令设置为 code 或 cursor，以便快速启动编辑器，如果本地已经安装了 VS Code，code 命令一般用在 VS Code 中，Cursor 使用 cursor 命令。</p>
<p>启用 Cursor 的 code 命令非常简单，先打开命令面板：</p>
<ul>
<li>macOS 系统快捷键：⇧⌘P（command + shift + p）</li>
<li>Windows/Linux 快捷键: Ctrl + Shift + P</li>
</ul>
<p>搜索安装<code> &gt; shell command:</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b3e6066a5b44856b8756317fd336669~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=sSjFhvCur7EvF55wOq65TZhmXVU%3D" alt="image.png" loading="lazy"/></p>
<p>然后选择在 PATH 中安装 "cursor" 命令 - Shell Command: Install 'cursor' command in PATH 即可为系统 PATH 路径添加了 cursor 命令的引用。</p>
<p>我们可以通过命令行打开文件、安装扩展、修改显示语言，甚至查看诊断信息。</p>
<p>通过 <code>cursor --version</code> 查看版本信息:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c30269f88d24d0099fce9c51edc3a15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=pcpbOZDPV2Aldb%2FfVY624kuZsEY%3D" alt="image.png" loading="lazy"/></p>
<p>以下是一些常用的命令行选项，可以通过<code>cursor --help</code> 命令查看：</p>













































<table><thead><tr><th>命令</th><th>功能说明</th></tr></thead><tbody><tr><td>code &lt;路径&gt;</td><td>打开文件或文件夹</td></tr><tr><td>cursor .</td><td>打开当前目录作为工作区</td></tr><tr><td>cursor --new-window</td><td>在新窗口中打开</td></tr><tr><td>cursor --diff</td><td>对比两个文件的内容</td></tr><tr><td>cursor --wait</td><td>等待窗口关闭后再返回终端</td></tr><tr><td>cursor --disable-extensions</td><td>禁用所有扩展运行 VS Code</td></tr><tr><td>cursor --install-extension &lt;扩展名&gt;</td><td>安装指定扩展</td></tr><tr><td>cursor --list-extensions</td><td>列出所有已安装的扩展</td></tr><tr><td>cursor --uninstall-extension &lt;扩展名&gt;</td><td>卸载指定扩展</td></tr></tbody></table>
<h3 data-id="heading-28">Cursor Chat与Composer</h3>
<p>Cursor AI 聊天窗口中有 Chat 和 Composer 两个功能，它们是两种不同功能的 AI 辅助编程模式：</p>
<ul>
<li><strong>Chat</strong> 是一个交互式的 AI 助手，你可以用自然语言与它对话，提出问题、请求代码解释、进行代码审查、查找错误等。它更侧重于交互式的问答和代码辅助，适合快速获取解决方案、调试代码或学习新概念。</li>
<li><strong>Composer</strong> 是一个强大的代码生成工具，主要用于生成全新的代码。你可以提供需求描述或示例代码，让 Composer 生成完整的代码片段或文件。它更侧重于代码的生成，适合构建新功能、优化代码结构或处理复杂的编程任务。</li>
</ul>
<p>简单来说 Chat 适合快速问答和简单任务，Composer 适合复杂代码生成和跨文件操作，平时开发我们可以先用 Composer 生成代码，再用 Chat 对代码进行解释或优化。</p>
<h4 data-id="heading-29">（1）Cursor Chat</h4>
<p>Cursor Chat 是一个集成在代码编辑器中的聊天工具，它允许开发者在编写代码的同时与团队成员进行实时沟通。通过 Cursor Chat，开发者可以在不离开编辑器的情况下讨论代码问题、分享代码片段或寻求帮助。</p>
<p><strong>主要功能</strong></p>
<ul>
<li>对话式交互：用户可以像与真人对话一样，用自然语言提问或请求代码片段。</li>
<li>快速响应：适合即时问答，如代码调试、技术概念解释等。</li>
<li>上下文感知：Chat 会记住之前的对话，支持逐步深入提问。</li>
<li>代码引用：可以直接引用代码片段，让 AI 解释或修改。</li>
</ul>
<p><strong>实例</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AboutPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>关于我们，RUNOOB.COM<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;
}
</code></pre>
<p>接下来我们在Chat对话窗口，让AI添加注释。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37a6629e2e274d52aa282d83fef271a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=TTVE2w3zwwFdPYXQ%2BhFEz2ctB0w%3D" alt="image.png" loading="lazy"/>
然后，点击APPly按钮，就可以应用到代码文件中了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ffc560db45647959f7fd0109f49014e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=nuYEBj73Kv1omCnAIE7yS21qTc0%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-30">（2）Cursor Composer</h4>
<p>现在Composer模式已经整合到对应的模式里了，不需要用户再手动切换这个模式了。</p>
<p>Composer 可以根据自然语言描述，生成完整的代码片段或文件，甚至构建整个应用程序，同时支持同时编辑多个文件，能够理解文件之间的调用关系，适合复杂项目的开发。</p>
<p>Composer 能够理解整个项目结构和现有代码，生成更符合逻辑、更高质量的代码。</p>
<p>Composer 生成代码后，用户可以通过额外指令进一步优化代码。</p>
<p>比如我们可以创建一个目录，编写需求文档：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bffc08fbdb642d2ac0e12de063b8288~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=tXdKkLyDq3JlNfvej6C6rLTgsBM%3D" alt="image.png" loading="lazy"/></p>
<p>在Composer对话窗口就可以让他根据需求文档生成代码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4042a497343a487da41baac48dbe45a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=fLD3jtLKSuBIYeEBzV5YjbkhhDw%3D" alt="image.png" loading="lazy"/></p>
<p>Cursor 在最新版本 0.46.8 中移除了 Composer 和 Bug Finder 功能，主要是为了简化用户体验，并整合多个模式。</p>
<p>他们将 Chat 模式作为主要交互方式，结合了之前的 Compose 和 Command 模式的功能，使用户可以在一个统一的界面中进行代码生成、编辑和命令执行。此外，新的界面提供了 Agent、Ask 和 Edit 三种模式，以替代原来的 Composer 功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ad50e53ddb146d0a3ba2862a61f4efc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=7d1Y3YDi63PO9awvLObD4Kh9bJ4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ede74b3972d4ccc811d706792e663a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=X2UjoQ5rr5kXi8ojnHift6u6%2B1M%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-31">Cursor高阶技巧使用</h2>
<h3 data-id="heading-32">Cursor智能补全与代码生成</h3>
<p>Cursor 新建文件很简单，可以点击菜单栏的 “文件” 或左侧的 “资源管理器” 来创建。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4886799dbdde44289a9072d2cead78d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=uDpR%2B1fpn7%2FliznA65Cgs0xlqdw%3D" alt="image.png" loading="lazy"/></p>
<p>通过 “资源管理器” 打开一个项目，项目上就有创建文件和创建目录的按钮：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc723b126a7941bd985d139a2f89e923~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=PO1Df%2Fax8aGyCY4V%2FqmApn4wrEk%3D" alt="image.png" loading="lazy"/></p>
<p>点击菜单栏的新建文件，会出现一个空文本，我们可以输入代码，并按下 Ctrl + s 来保存代码，输入文件名，并设置保存目录：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84007c1cd4a040afb50773bb6ae30cbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=h8weNkdsT7U6yLhlVUjWSilo6S8%3D" alt="image.png" loading="lazy"/>
通过 “资源管理器” 项目上的按钮来创建文件，会先出现一个输入文件名的输入框，输入文件名后即可完成创建。</p>
<p>Cursor 内置 IntelliSense 功能，根据上下文提供智能补全建议。我们在编写代码，如 Python 或 JavaScript 时，Cursor 会预测我们要输入的内容：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5c33423f39f4aeaab84b7c508d6e2d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=GH5s7gVjsoD1eJ8Gn8z2trRA4ME%3D" alt="image.png" loading="lazy"/></p>
<p>如果写上注释如# 计算平均数，Cursor 就会自动帮我们实现功能，按下 Tab 键就可以采用 Cursor 提供的代码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/928b653d6cdb402eb16f7b355e085ba7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=r71%2FGKehaOIX23B45bqAZb3GKIo%3D" alt="image.png" loading="lazy"/></p>
<p>如果对代码不熟悉，需要AI来解析，可以通过快捷键Cmd/Ctrl+L 来调出AI对话窗口：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/378babbc9976413298b28e1862bd29b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=PL%2BkBOUxfU6USnIaYlgjTXhIXNk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-33">Cursor集成终端</h3>
<p>Cursor 基于 Visual Studio Code 构建，保留了 VS Code 的强大功能和熟悉的操作体验，同时加入了 AI 辅助编程功。</p>
<p>Cursor 内置了集成终端，跟 VS Code 集成终端操作一样，我们可以在菜单栏上选择 <strong>“终端”</strong> 选项，然后选择 **“新建终端” **：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c8886c3bf0f4a6785fdec635cc2dd0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=ABuDRWrjDiH19n6gbHQ3m6EgNMs%3D" alt="image.png" loading="lazy"/></p>
<p>也可以选择目录下的文件，右击，在下拉菜单选择“在集成终端打开”：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c302d9f619c49deb2c0f9578f0d68e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=kWWnXAqW%2F35LkHSjXvH38AcF%2Bxc%3D" alt="image.png" loading="lazy"/></p>
<p><strong>终端快捷键表格</strong></p>






























<table><thead><tr><th>功能</th><th>Windows/Linux</th><th>macOS</th></tr></thead><tbody><tr><td>显示集成终端</td><td>Ctrl + `</td><td>Ctrl + `</td></tr><tr><td>新建终端</td><td>Ctrl+Shift+`</td><td>Cmd+Shift+`</td></tr><tr><td>切换终端</td><td>Ctrl+PageUp/PageDown</td><td>Cmd+PageUp/PageDown</td></tr><tr><td>关闭终端</td><td>Ctrl+Shift+W</td><td>Cmd+Shift+W</td></tr></tbody></table>
<p>根据操作系统的不同，我们可以选择不同的终端环境，例如 PowerShell、命令提示符（Command Prompt）、或 Bash。</p>
<p>在终端中输入以下命令，创建一个新的文件 greetings.txt：</p>
<pre><code class="hljs language-js" lang="js">echo <span class="hljs-string">"Hello, VS Code"</span> &gt; greetings.<span class="hljs-property">txt</span>
</code></pre>
<p>工作区的默认文件夹是当前项目的根目录。</p>
<p>创建文件后，“资源管理器（Explorer）” 会自动显示新文件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe6aee9e7d28483b8deb9df02882744e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=B54AWH5Eck8Ap%2F7MsYl0jhHtytM%3D" alt="image.png" loading="lazy"/></p>
<p>我们可以同时打开多个终端，点击终端右上角的“启动配置（Launch profile）”下拉菜单，查看可用的终端环境并选择。</p>
<p><strong>与命令输出交互</strong></p>
<p>VS Code 中的终端还提供了与命令输出交互的功能，命令通常会输出文件路径或 URL，你可能希望直接打开或跳转到这些链接。</p>
<p>例如，编译器或代码检查工具可能会返回一个包含文件路径和行号的错误信息。你不需要手动去搜索该文件，只需在终端输出中选择该链接即可直接在编辑器中打开文件。</p>
<p>让我们看看如何与终端中的命令输出进行交互：</p>
<ol>
<li>打开你之前运行过<code>ls</code>或<code>dir</code>命令的终端。</li>
<li>在终端中，按住<code>Ctrl/Cmd</code>键，将鼠标悬停在文件名上，然后选择该链接。</li>
</ol>
<p>注意，当你将鼠标悬停在输出中的文本上时，它会变成一个链接。</p>
<p>当你选择文件名时，VS Code 会在编辑器中打开选定的文件。</p>
<p>终端输出中的所有文本都是可以点击的，如果选择终端中的超链接，它会在默认浏览器中打开链接。</p>
<h3 data-id="heading-34">Cursor高效率@标记功能</h3>
<p>在 Cursor 中，<code>@</code>符号是一个强大的工具，用于快速访问和引用各种上下文信息，帮助用户更高效地与 AI 交互。</p>
<p>在任何 AI 交互场景（如命令面板、聊天窗口或终端）中输入 <code>@</code>，会触发上下文关联菜单，自动过滤并推荐当前项目中最相关的资源（如文件、代码片段、文档等）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/220c0920030642a09d53b57d59981bbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=dvsVMxQir0A6kG0%2Byitqm3b%2FO9A%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>键盘操作：使用↑/↓方向键导航，Enter 确认选择。若选择的是类别（如<code>@Files</code>），列表会进一步过滤该类别下的具体资源。</li>
<li>文件读取策略：对文件引用可按<code>Ctrl/⌘ M</code>切换 “完整读取” 或 “摘要读取” 模式（例如全文引用或仅关键部分）。</li>
</ul>
<p><code>@</code>符号支持以下主要指令：</p>























































<table><thead><tr><th>功能</th><th>描述</th><th>使用场景</th></tr></thead><tbody><tr><td>@Files</td><td>引用整个文件作为上下文。支持文件路径预览和分块处理。</td><td>需要引用特定文件内容时，如代码文件、文档等。</td></tr><tr><td>@Folders</td><td>引用整个文件夹作为上下文。</td><td>需要提供大量文件作为上下文，例如项目目录。</td></tr><tr><td>@Code</td><td>引用特定代码片段作为上下文。</td><td>需要针对特定代码片段进行查询或操作。</td></tr><tr><td>@Codebase</td><td>从代码库中搜索重要文件或代码块，并根据相关性重新排序。</td><td>需要在整个代码库中查找相关代码或文件。</td></tr><tr><td>@Git</td><td>扫描 Git 提交、差异或拉取请求，帮助查找问题。</td><td>需要分析 Git 相关信息，如提交记录、代码差异等。</td></tr><tr><td>@Web</td><td>搜索网络信息作为附加上下文。</td><td>需要获取最新网络信息或外部资源。</td></tr><tr><td>@Docs</td><td>引用预设的第三方文档或自定义文档，支持添加自定义文档。</td><td>需要引用外部文档或自定义知识库。</td></tr><tr><td>@Definitions</td><td>引用附近的所有定义作为上下文。</td><td>需要引用当前代码中的变量、函数等定义。</td></tr><tr><td>@Chat</td><td>将当前聊天消息添加为上下文。</td><td>在聊天中需要引用之前的对话内容。</td></tr></tbody></table>
<h4 data-id="heading-35">高级使用技巧</h4>
<ul>
<li><strong>组合指令</strong>：输入<code>@Files src/utils/helper.js @Codebase</code>，可同时引用指定文件并关联代码库全局上下文，生成高度定制化的代码。</li>
<li><strong>动态资源集成</strong>：粘贴以<code>@</code>开头的链接（如<code>@https://api.example.com/docs</code>），Cursor 会自动解析内容并纳入上下文。</li>
<li><strong>隐私与配置管理</strong>：通过<code>.cursorignore</code>文件（类似<code>.gitignore</code>）排除敏感文件或目录的索引。在<code>Settings &gt; Features &gt; Docs</code>中添加自定义文档链接，增强<code>@Docs</code>的覆盖范围。</li>
</ul>
<h4 data-id="heading-36">典型应用场景示例</h4>
<p>1、代码生成</p>
<ul>
<li><strong>指令</strong>：生成用户登录功能 @Files src/models/user.js @Docs <a href="https://link.juejin.cn?target=https%3A%2F%2Fjwt.io%2Fintroduction" target="_blank" title="https://jwt.io/introduction" ref="nofollow noopener noreferrer">jwt.io/introductio…</a></li>
<li><strong>结果</strong>：基于现有用户模型和 JWT 官方文档生成安全的鉴权逻辑。</li>
</ul>
<p>2、错误排查</p>
<ul>
<li><strong>指令</strong>：解释此报错原因 @Code 12-25 行 @Git HEAD~1</li>
<li><strong>结果</strong>：结合代码段和最近提交历史分析潜在问题。</li>
</ul>
<p>3、跨文件重构</p>
<ul>
<li><strong>指令</strong>：将类组件改为函数式组件 @Folders src/components @Codebase</li>
<li><strong>结果</strong>：批量转换并确保全局样式和状态管理兼容。</li>
</ul>
<blockquote>
<p><code>@ </code>注记有一些是通用的，在所有对话窗口中都可以使用；有一些是特殊的，我会在提到时做补充说明。</p>
<p>注：事实上 Github Copilot 也有类似的功能，但是没 Cursor 齐全好用。</p>
</blockquote>
<p>详细说明</p>
<ol>
<li><strong>@Files 注记</strong>，传递指定代码文件的上下文当你在对话框输入 <code>@Files</code> 注记时，Cursor 会自动弹出对你代码仓库的检索列表，你可以输入想要导入上下文的文件名，而后按下确认键，相应的文件里的内容便会届时自动注入到上下文中</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7eeb32986e214cf584c1c3c4cce32c31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=7OsPV1Ew4ObEzzEUfnVtaZSalCY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e37ed7914c924850b9ad30a7d509ba89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=O6b26T0AlK6GI48IiC99Fw6ZN1U%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5abe5b02cd594648985316d585c53dac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=odrK52%2BJJVCmYG0enT8w8HaUeHc%3D" alt="image.png" loading="lazy"/></p>
<ol start="2">
<li><strong>@Code 注记</strong>，传递指定代码块的上下文<code>Code</code>注记提供更精确的代码片段，@注记的使用都大同小异，会弹出相应的检索框，你输入关键词后在索引列表中选择相应的代码块即可。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c89d15c30be47038599045284bdd016~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=z1poFHa%2BzHIsidhykA6KYvFdPFg%3D" alt="image.png" loading="lazy"/></p>
<ol start="3">
<li><strong>@Docs 注记</strong>，从函数或库的官方文档里获取上下文<code>@Docs</code>注记能够从函数或库的官方文档里获取上下文。目前，它只能从可访问的在线文档里获取上下文。因此，你自己写的类似于 JSDoc 之类的文档信息除非你能整一个线上地址，否则是没用的～我个人觉得这个功能不是很泛用。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70e98ef5496f4380bca4461155c95284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=HWGCRtPTRBr1PrTNIWFE%2BEo2hGk%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>@Docs 标记，通常使用需要你手动导入文档</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8aae2e828a654c61b825a35ada339d10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=AnY8p%2BFqomN7ZvVTFSkSyp7wwqE%3D" alt="image.png" loading="lazy"/></p>
<ol start="4">
<li><strong>@Web 注记</strong>，从搜索引擎的搜索内容获取上下文<code>@Web</code>注记类似于一种方法，它会默认将你的提问先向搜索引擎进行搜索，然后从搜索结果里提取上下文喂给 LLM。但因为 Cursor 官方没公开透明具体的实现法子，它自个也没调好，实际上使用效果忽好忽差的。</li>
</ol>
<p>如果你遇到问题想偷懒不打开网页搜报错或是大模型自身的回答无法解决问题，可以直接使用这个注记。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4f4b11a9ee84905bd397ac8ddb7fdb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=1kSNdHn2PRoEtBcjrIsyuN746Co%3D" alt="image.png" loading="lazy"/></p>
<ol start="5">
<li><strong>@Folders 注记</strong>，传递文件目录信息的上下文<code>@Folders</code>注记能够提供文件目录的相关信息，如果你遇到什么路径问题，可以考虑使用这个注记向大模型寻求解决方法。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c370a9e7d30740c6ae6b1b1a9abfccc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=N6ErRKyXzTNOduiXMIPEvMx%2FH28%3D" alt="image.png" loading="lazy"/></p>
<ol start="6">
<li><strong>@Chat 注记</strong>，只能在文件内的代码生成窗口里使用的注记<code>@Chat</code>注记只能在文件内的代码生成窗口（<code>CTRL + K</code> 打开的窗口）里使用，它能够将你右边打开的对话窗口里的对话内容作为上下文传递给大模型。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1161450565434bffbb82809d4193ce3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=wZ1QwY3O561leO0%2Fknzm36DjvGU%3D" alt="image.png" loading="lazy"/></p>
<ol start="7">
<li>
<p><strong>@Definitions 注记</strong>，只能在文件内的代码生成窗口里使用的注记和<code>@Chat</code>注记一样，<code>@Definitions</code>注记只能在文件内的代码生成窗口里使用。它会将你光标停留的那一行代码里涉及到的变量、类型的相关定义作为上下文传递给大模型，类似于<code>@Code</code>注记。</p>
</li>
<li>
<p><strong>@Git 注记</strong>，只能在对话窗里使用对话窗指的是通过<code>CTRL + L</code>与<code>CTRL + I</code>打开的对话窗口。<code>@Git</code>注记能够将你当前的 Git 仓库的 commit 历史作为上下文传递给大模型。</p>
</li>
</ol>
<p>感觉比较适合在代码协作的时候查战犯清算的时候使用。</p>
<ol start="9">
<li><strong>@Codebase 注记</strong>，只能在对话窗里使用，用于在代码仓里扫描相应的文件传入<code>Codebase</code>注记其实不是很好用，与其说它是扫代码仓，不如说是从代码仓里寻找到你想要的文件的上下文传入，也就是<code>Codebasefilter</code>。</li>
</ol>
<h3 data-id="heading-37">Cursor Rules的使用</h3>
<p><strong>1 什么是Cursor Rules</strong></p>
<p><code>Cursor Rules</code>是一种用户定义的规则集，可以嵌入到项目中，用于指导 AI 如何生成或修改代码。通过这些规则，开发者可以：</p>
<ul>
<li>定制 AI 行为：根据项目需求调整 AI 的响应方式。</li>
<li>保持一致性：定义编码风格、最佳实践，确保生成的代码符合项目规范。</li>
<li>提供上下文信息：让 AI 了解项目结构、常用方法或特定库，从而生成更符合需求的代码。</li>
<li>提高开发效率：减少手动调整代码的时间，让 AI 生成更精准的代码。</li>
</ul>
<p>简单来说，Cursor Rules 就像给 AI 一份 “说明书”，告诉它如何更好地服务你的项目。</p>
<p><strong>2 规则类型Cursor 提供两种规则类型：</strong></p>
<ul>
<li><strong>User Rules</strong>：全局规则，适用于所有项目，可在 Cursor 设置中配置。用于设置通用规则，例如输出语言、响应长度、输出样式等。当你希望在整个开发环境中保持统一的风格或行为时，可以使用 User Rules。</li>
<li><strong>Project Rules</strong>：项目特定规则，存储在项目根目录的 <code>.cursor/rules</code> 文件夹中，适用于特定项目。支持更细粒度的控制，例如为不同文件类型设置不同的规则。当项目复杂，需要针对不同部分（如 Python 文件、React 组件）定义不同规则时，Project Rules 是最佳选择。</li>
</ul>
<p><strong>3 如何创建和使用 Cursor Rules？</strong></p>
<p>1、创建 User Rules，打开 Cursor 设置（Cursor Settings），进入 Rules 面板，添加或编辑规则。例如：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e23fe344baae4ef19ac1abe2d3f299bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=mqAGt0NsHeMV8iWVNs6WIBB4OiY%3D" alt="image.png" loading="lazy"/></p>
<p>2、创建 Project Rules，在项目根目录创建 <code>.cursor/rules</code> 文件夹，在该文件夹中创建 <code>.mdc</code> 规则文件，例如 <code>001-project-overview.mdc</code>，使用 Markdown 格式编写规则内容。例如：</p>
<pre><code class="hljs language-md" lang="md"><span class="hljs-section"># 项目概览</span>
<span class="hljs-section">## 项目名称</span>
[你的项目名称]

<span class="hljs-section">## 项目描述</span>
[简要描述项目的目的和功能]

<span class="hljs-section">## 技术栈</span>
<span class="hljs-bullet">-</span> 前端: React
<span class="hljs-bullet">-</span> 后端: Node.js
<span class="hljs-bullet">-</span> 数据库: MySQL
<span class="hljs-bullet">-</span> 部署: Docker
</code></pre>
<p>3、在 Cursor 的 Agent 模式下，AI 会自动应用匹配的规则。也可以在 Cursor 的对话框中使用 <code>/Generate Cursor Rules</code> 命令，让 AI 自动生成项目规则。</p>
<p>4 规则应用规则应用分为四种方式：</p>
<ul>
<li><strong>Always</strong>：每次都会把内容加入到上下文中</li>
<li><strong>Manual</strong>：需要你手动 @进去</li>
<li><strong>Agent</strong>：让 cursor 根据你的描述自己判断是否加入到上下文中</li>
<li><strong>Autoattached</strong>：根据文件后缀匹配是否要加入到上下文中</li>
</ul>
<p>通过合理使用 Cursor Rules，开发者可以显著提升代码质量、一致性和开发效率。</p>
<h3 data-id="heading-38">高阶对话技巧及开发方式</h3>
<p>Cursor 功能非常强大，但也取决于你是如何使用它的。使用方式的不同，能发挥出 AI 编程效率多少也会随之不同。接下来分享几个 Cursor 或者说是 AI 编程高效率对话的技巧和建议：</p>
<p><strong>1 明确需求</strong></p>
<p>在与 AI 对话时，尽量用简洁明了的语言描述你的需求。例如，不要说 “帮我写一个功能”，而是说 “帮我写一个函数，用于计算两个数字的平均值”。</p>
<p>如果需求复杂，可以分步骤描述，避免让 AI 一次性处理过多信息。例如，先生成函数框架，再逐步添加逻辑。对于大型项目，可以先生成模块结构，再逐步填充每个模块的代码。</p>
<blockquote>
<p>明确需求的核心在于，要向 AI 说清楚你的这个功能需要解决什么问题？” 或 “用户使用场景是什么？”，你的目标是做个什么功能，功能描述和具体要求有哪些？</p>
</blockquote>
<p><strong>2 使用关键词</strong></p>
<p>在描述需求时，使用一些关键词可以帮助 AI 更快理解你的意图。例如，“函数”、“类”、“算法”、“优化” 等。对于特定的技术或框架，明确提到它们的名称，比如 “React 组件”、“Django 模型” 等。</p>
<p><strong>3 提供上下文</strong></p>
<p>如果你正在处理一个具体的项目，提供一些上下文信息可以帮助 AI 更好地理解你的需求。例如，提到项目的目标、技术栈或已有的代码结构。对于复杂问题，可以提供代码片段或文件路径，让 AI 更好地定位问题。</p>
<p>在 Cursor 的 AI 输入框中，通过使用 @，将出现一个带有建议列表的弹出菜单，可以使用向上 / 向下箭头键浏览建议列表，按 Enter 键进行选择，然后在 @后输入内容以进一步筛选选项，通过该方式添加上下文描述到问题中。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/793b831b8dff40aabb2452ffd47ed4fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=oaFcvqnQynzB5p2uZJ6bQRWLcmg%3D" alt="image.png" loading="lazy"/></p>
<p>下来我们将介绍每个选项的功能：</p>
<ul>
<li><strong>@Files&amp;@Folders（文件或文件夹）</strong> ：引用项目中的具体文件或某个文件夹。</li>
<li><strong>@Code（代码）</strong> ：引用代码的特定部分。</li>
<li><strong>@Docs（文档）</strong> ：Cursor 附带一组第三方文档，这些文档已爬取、索引并准备好用作上下文。可以使用 @Docs 符号访问它们</li>
<li><strong>@Git</strong>：将 git 提交、差异或拉取请求添加到提示中</li>
<li><strong>@Notepad</strong>：临时记录和编辑文本</li>
<li><strong>@Suggested</strong>：针对文件提供建议</li>
<li><strong>@Codebase</strong>：高级代码库搜索，查找要使用的代码段。</li>
<li><strong>@Web</strong>：根据查询和提供的上下文构建搜索查询，并在 Web 上搜索以查找相关信息作为附加上下文。</li>
</ul>
<p><strong>4 反馈与修正</strong></p>
<p>如果 AI 生成的内容不符合你的预期，及时反馈并修正。例如，你可以直接指出问题所在，或者提供更详细的说明。使用 “接受” 或 “拒绝” 按钮来明确告诉 AI 你的选择。</p>
<p><strong>5 利用模板、规则和快捷命令</strong></p>
<p>许多 AI 工具支持模板、规则或快捷命令，例如 “<code>/generate</code>”、“<code>/optimize</code>” 等。熟悉这些命令可以节省时间。为常用任务创建自定义模板，以便快速调用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/445492dbe950442b9cc8d698e46a8daf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=34R%2F9NQtmIDaN8eMrvRIQrh0sWY%3D" alt="image.png" loading="lazy"/></p>
<p>除此之外，Cursor 的 AI 功能是其核心亮点，以下常用的快捷键可帮助您更高效地使用 AI 辅助功能：</p>
<ul>
<li><strong>Tab</strong>：接受 AI 提供的代码建议或自动补全。</li>
<li><strong>Ctrl/Cmd + B</strong>：显示或隐藏资源管理器面板。</li>
<li><strong>Ctrl/Cmd + K</strong>：打开 AI 提示栏，用于生成新代码或编辑现有代码。</li>
<li><strong>Ctrl/Cmd + L</strong>：打开 AI 聊天面板，可用于提问、编辑代码或对整个项目进行操作。</li>
<li><strong>Ctrl/Cmd + I</strong>：打开 AI 代理，用于跨文件编辑代码或对整个项目进行开发。</li>
<li><strong>Ctrl/Cmd + /</strong> ：在 AI 模型之间切换，例如 GPT-4 和 Claude 3.5。</li>
<li><strong>Ctrl/Cmd + Alt + L</strong>：打开聊天历史记录。</li>
<li><strong>Ctrl/Cmd + Shift + P</strong>：打开命令面板，可用于访问 VS Code 设置或 Cursor 特定功能。</li>
</ul>
<p>Cursor 允许你在设置中重新映射快捷键，以适应个人使用习惯。</p>
<p>初学者建议：从 Tab（接受代码建议）、Ctrl/Cmd + K（生成代码）和 Ctrl/Cmd + L（AI 聊天）开始，这些快捷键是 Cursor 的核心功能。</p>
<h2 data-id="heading-39">Cursor提效应用场景实战</h2>
<h3 data-id="heading-40">基础</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81b151c8856a40c492ba50f6442bcaa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=Lmecjxs5sVbcHsUdv60OJ2Bw9KU%3D" alt="image.png" loading="lazy"/></p>
<p><strong>一句话生成网页</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaceff17baf3408abcc75ad568ab090b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=9tB8RQ%2BqMw57zupYQdnqw36j5aw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a67987a92b9451d834dfc950888ef2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=uOy91SyYjNEafG6rGn1TmMlBn9w%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d35e60e58df4d9aa717c8ed6bb6ef4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=D38q7f87E3etBJYzDzrmPucgI%2Fc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbdc91caf5eb41cab476c565a8154d2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=8S7p6e4Jy4qIZRFoSyA27pQO0fc%3D" alt="image.png" loading="lazy"/></p>
<p><strong>快捷键</strong></p>















































<table><thead><tr><th>用途</th><th>Windows 快捷键</th><th>Mac 快捷键</th><th>详解</th></tr></thead><tbody><tr><td>代码补全</td><td>Ctrl + Enter</td><td>Cmd + Enter</td><td>接受 AI 建议</td></tr><tr><td>AI 聊天（常用）</td><td>Ctrl + L</td><td>Cmd + L</td><td>打开聊天窗口</td></tr><tr><td>Composer 模式（常用）</td><td>Ctrl + I</td><td>Cmd + I</td><td>打开 AI 编辑模式</td></tr><tr><td>全局搜索</td><td>Ctrl + Shift + F</td><td>Cmd + Shift + F</td><td>在所有文件中查找</td></tr><tr><td>撤销操作</td><td>Ctrl + Z</td><td>Cmd + Z</td><td>撤销上一步</td></tr><tr><td>重做操作</td><td>Ctrl + Y</td><td>Cmd + Shift + Z</td><td>恢复上一步</td></tr></tbody></table>
<p>提示：可以点击左上角 “文件”→“首选项”→“键盘快捷方式” 来查看完整的快捷键列表</p>
<h3 data-id="heading-41">文献阅读</h3>
<ul>
<li>PDF 文档导入功能</li>
<li>智能文本解析</li>
<li>关键信息提取</li>
</ul>
<p>我想写一个文献阅读梳理，请帮我阅读这篇文献，然后告诉我主要讲了什么</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2a2c12ab95748f7831ceed7911c17cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=9L6TKMkQ%2BBVHNt1lj6%2BJKE5P0QQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-42">视频选题推荐</h3>
<ul>
<li>基于兴趣的主题推荐</li>
<li>热点话题分析</li>
<li>研究方向建议</li>
</ul>
<p>我是一个 AI 视频博主，想做一期文生视频和图生视频的选题，请帮我想 5 个方向。输出到指定目录。</p>
<h3 data-id="heading-43">生成大纲</h3>
<ul>
<li>智能大纲生成</li>
<li>结构优化建议</li>
<li>逻辑关系分析</li>
</ul>
<p>我想让小学生也能快速制作海报（文生图）的一些工具和方法，请帮我生成大纲</p>
<h3 data-id="heading-44">写作相关</h3>
<p>辅助写作（带有AI功能的word文档）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6c3a346346546ff8443025ea34451ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=Nsdt93tWRjTFDV%2BvqStPbmbdTMM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>续写和扩写内容</strong>
请帮我写一篇《生活中的小确幸》文章，包含亲情、友情、爱情的小事情，800 字。</p>
<p><strong>改写语言风格（文言文）</strong>
帮我改写成文言文的风格</p>
<p><strong>翻译</strong></p>
<p>对比其他的翻译工具，可实现逐句翻译对照（这一点很爽！！！逐句对照！写论文友好！）。</p>
<p>帮我翻译成英文</p>
<h3 data-id="heading-45">储存文档历史</h3>
<ul>
<li>版本控制</li>
<li>修改记录</li>
<li>协作管理</li>
</ul>
<p>点击 “时间线”，会查看到历史修改的记录，可帮助我们更好的优化内容！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45ff8ec0bcc14fdc817a9da509e8778b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=ADmOTu2WewO9e%2BhQee80qLQ9y3U%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-46">数据分析与可视化</h3>
<p><strong>提数据分析需求</strong></p>
<p>我现在有关于银行客户的数据样例，主要想做 “银行信用：对银行客户的评分判别” 分析，请帮我生成 python 代码并且分析</p>
<h3 data-id="heading-47">Deepseek + Cursor 科研神器</h3>
<p>分享一个用 Cursor 使用 Deepseek 的科研小技巧，可能不需要在多个 AI 平台来回切换了，直接在这个平台就可以进行。我平常会使用 chat 功能（deepseek r1 模型）来讨论，讨论需求、讨论选题、头脑风暴… 然后使用 composer 模式让它基于讨论的内容去生成、执行、写 python 代码、写 md 文档，科研 yyds！解放生产力！</p>
<p>还记得我们最开始怎么做科研的吗？（在没有 AI 之前）可能是需要人工看大量的文献，来总结时间线、归纳文献综述、总结 research gap 等等；还需要从 GitHub、csdn 等等平台参考代码、反复调试、然后报错、然后不气馁、然后跑通（开心）。现在有了 AI 工具善用它，确实可以提高我们的效率，然后更专注于 “创造性” 层面的事情！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6b40b5a71e84061ba84a713b731e37e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=gf%2FcEVIrLmtsx777%2Bf0A01VWgMU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad9e4a39223047929d16396db0523f78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2ViR2lybA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764726947&amp;x-signature=Ek0UkT%2FMqSBGV7BXhpxqVfSJcgc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-48">其他提效场景</h3>
<ul>
<li>撰写 PRD（产品需求文档），理清楚思路</li>
<li>绘画 PRD 示意图、动态效果直接展示给后端开发者，减少沟通成本</li>
<li>开发浏览器插件，可以自己 diy 一些小东西（比如视频字幕提取、视频总结等插件）</li>
<li>Web 网页应用（可以与商家合作）</li>
<li>……</li>
</ul>
<p>小贴士：遇到困难时不要灰心，学会善用 AI 助手，AI 工具真的很高效！！作为小白，也可以多用用不同的工具，看看哪个适合自己，自己会在哪些场景下使用，来回切换几个不同的工具，每个工具可能也有侧重点，用它！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rust仿node事件总线的简单实现]]></title>    <link>https://juejin.cn/post/7576487832090427407</link>    <guid>https://juejin.cn/post/7576487832090427407</guid>    <pubDate>2025-11-25T15:52:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576487832090427407" data-draft-id="7576479344039395380" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rust仿node事件总线的简单实现"/> <meta itemprop="keywords" content="Rust,设计模式"/> <meta itemprop="datePublished" content="2025-11-25T15:52:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LengineerC"/> <meta itemprop="url" content="https://juejin.cn/user/1707958031887840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rust仿node事件总线的简单实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1707958031887840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LengineerC
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T15:52:24.000Z" title="Tue Nov 25 2025 15:52:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>用过node的人都知道，事件驱动是node的核心运行机制。在异步编程中我们可以给一个事件绑定一个回调，当任务执行完成后emit一个事件触发回调。node中，官方提供了<code>EventEmitter</code>的给用户做自定义事件处理：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">EventEmitter</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"events"</span>);

<span class="hljs-keyword">const</span> emitter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventEmitter</span>();
emitter.<span class="hljs-title function_">on</span>(<span class="hljs-string">'xxx'</span>, callback);
emitter.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'xxx'</span>);
</code></pre>
<p>而在Rust中，官方库并没有提供这样一个功能。作为一个习惯了写js的人来说，事件驱动编程是很爽的，一些场景下不用刻意去处理代码的执行逻辑顺序。所以就仿造node自己实现一个简单的rust事件总线来满足基本需求，同时使用<a href="https://link.juejin.cn?target=https%3A%2F%2Ftokio.rs%2F" target="_blank" title="https://tokio.rs/" ref="nofollow noopener noreferrer">tokio</a>来实现异步处理。</p>
<h2 data-id="heading-0">需求分析</h2>
<p>rust和js不同，js是单线程的，而rust有多线程，所以在写的时候需要考虑数据竞态、死锁等线程安全问题。</p>
<p>考虑到js的弱类型和动态特性，回调函数的定义可以很轻松，而rust是静态强类型，而且有宇宙第一的编译器，光是在类型定义这一步就很难，因此只能给变量做一个类型擦除。（不用泛型是因为泛型会限制参数和函数的类型范围，虽然写起来会更简单，但是在实际场景中只能定义多种emitter来适配不同的使用需求，变得极度不灵活）</p>
<h2 data-id="heading-1">实现</h2>
<h3 data-id="heading-2">单线程</h3>
<p>先从单线程的回调参数开始设计，因为涉及任意类型参数，所以可以直接用最简单的类型擦除实现单个参数的类型</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Arg</span> = <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Any&gt;;
</code></pre>
<p>实现类似js函数参数中的<code>...args</code>只需要使用<code>Vec</code>就行，没用数组切片是为了避免考虑生命周期的问题，同时为了便于调用，可以使用<code>Rc</code>来实现多所有权</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Args</span>=Rc&lt;<span class="hljs-type">Vec</span>&lt;Arg&gt;&gt;;
</code></pre>
<p>js中可以一个事件对应多个回调并且还有对回调的增删操作，所以后续可以用一个<code>HashMap</code>来存储一个事件和其对应的回调函数。为了适配这个功能，需要封装一个对象用来存储单个回调函数本体和其标识符，暂且就命名为<code>Handler</code>，不过在此之前还要先考虑回调函数本身的类型怎么定义。因为在使用过程中回调函数为一个闭包，而不同的回调可能形式不同，所以可以使用</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">type</span> <span class="hljs-title class_">SyncCallback</span> = Rc&lt;<span class="hljs-keyword">dyn</span> <span class="hljs-title function_ invoke__">Fn</span>(Args)&gt;; <span class="hljs-comment">// 同步回调</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AsyncCallback</span> = Rc&lt;<span class="hljs-keyword">dyn</span> <span class="hljs-title function_ invoke__">Fn</span>(Args) <span class="hljs-punctuation">-&gt;</span> Pin&lt;<span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Future&lt;Output = ()&gt;&gt;&gt;&gt;; <span class="hljs-comment">// 异步回调</span>
</code></pre>
<p>来兼容不同类型的闭包。使用枚举包裹回调函数则可以在一种<code>Emitter</code>中处理两种回调</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Callback</span> {
    <span class="hljs-title function_ invoke__">Sync</span>(SyncCallback),
    <span class="hljs-title function_ invoke__">Async</span>(AsyncCallback),
}
</code></pre>
<p>然后我们就可以编写<code>Handler</code>对象了</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">type</span> <span class="hljs-title class_">HandlerId</span> = <span class="hljs-type">u64</span>;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Handler</span> {
    <span class="hljs-keyword">pub</span> id: HandlerId,
    <span class="hljs-keyword">pub</span> callback: Callback,
    <span class="hljs-keyword">pub</span> once: <span class="hljs-type">bool</span>, <span class="hljs-comment">// 是否单次触发</span>
}
</code></pre>
<p>之后就可以开始考虑<code>Emitter</code>本体了。（最开始考虑使用泛型在一种<code>Emitter</code>中处理单/多线程，后面发现实现过于困难，于是拆解为两种实现，<strong>有大佬知道解决方案的请给我留言学习一下</strong>）</p>
<p>首先肯定要有个变量来存储事件监听器的信息，还是老套路，使用<code>Rc</code>, <code>RefCell</code>实现单线程的内部可变多所有权，<code>Handler</code>中还有<code>id</code>，因此需要一个计数器实现自动递增</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SingleThreadEventEmitter</span> {
    listeners: Rc&lt;RefCell&lt;HashMap&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Vec</span>&lt;Handler&gt;&gt;&gt;&gt;,
    id_counter: Rc&lt;RefCell&lt;HandlerId&gt;&gt;,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">SingleThreadEventEmitter</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> {
            listeners: Rc::<span class="hljs-title function_ invoke__">new</span>(RefCell::<span class="hljs-title function_ invoke__">new</span>(HashMap::<span class="hljs-title function_ invoke__">new</span>())),
            id_counter: Rc::<span class="hljs-title function_ invoke__">new</span>(RefCell::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">1</span>)),
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_id</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> HandlerId {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">id</span> = <span class="hljs-keyword">self</span>.id_counter.<span class="hljs-title function_ invoke__">borrow_mut</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">old_value</span> = *id;
        *id += <span class="hljs-number">1</span>;
        old_value
    }
}
</code></pre>
<p>接下来先考虑处理同步回调涉及的方法（因为最开始想把单线程多线程写在一起，所以直接写成了<code>trait</code>，后面推翻了这个想法导致<code>trait</code>稍微有点多此一举），本项目只是个简单实现，所以只实现回调的增删和触发即可</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">trait</span> <span class="hljs-title class_">EventEmitter</span> {
    <span class="hljs-comment">// 添加事件及其回调（回调函数可以多次添加）</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">on</span>&lt;F&gt;(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, callback: F) <span class="hljs-punctuation">-&gt;</span> HandlerId
    <span class="hljs-keyword">where</span>
        F: <span class="hljs-title function_ invoke__">Fn</span>(Args) + <span class="hljs-symbol">'static</span>;

    <span class="hljs-comment">// 同node的once</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">once</span>&lt;F&gt;(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, callback: F) <span class="hljs-punctuation">-&gt;</span> HandlerId
    <span class="hljs-keyword">where</span>
        F: <span class="hljs-title function_ invoke__">Fn</span>(Args) + <span class="hljs-symbol">'static</span>;

    <span class="hljs-comment">// 删除单个回调</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">off</span>(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, id: HandlerId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span>;

    <span class="hljs-comment">// 删除整个事件</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">off_all</span>(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>);

    <span class="hljs-comment">// 触发事件</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">emit</span>(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, args: Rc&lt;<span class="hljs-type">Vec</span>&lt;Arg&gt;&gt;);
}
</code></pre>
<p>这里添加<code>'static</code>的原因是这个闭包存进<code>Handler</code>的<code>callback</code>里面，而回调在没有主动删除的情况下应该一直存在，所以标记为静态生命周期告诉编译器该闭包全程有效。</p>
<p>先看最简单的<code>on</code>的实现</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">on</span>&lt;F&gt;(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, callback: F) <span class="hljs-punctuation">-&gt;</span> HandlerId
<span class="hljs-keyword">where</span>
    F: <span class="hljs-title function_ invoke__">Fn</span>(Args) + <span class="hljs-symbol">'static</span>,
{
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">id</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">get_id</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">handler</span> = Handler {
        id,
        callback: Callback::<span class="hljs-title function_ invoke__">Sync</span>(Rc::<span class="hljs-title function_ invoke__">new</span>(callback)),
        once: <span class="hljs-literal">false</span>,
    };

    <span class="hljs-keyword">self</span>.listeners
        .<span class="hljs-title function_ invoke__">borrow_mut</span>()
        .<span class="hljs-title function_ invoke__">entry</span>(event.<span class="hljs-title function_ invoke__">to_string</span>())
        .<span class="hljs-title function_ invoke__">or_default</span>()
        .<span class="hljs-title function_ invoke__">push</span>(handler);

    id
}
</code></pre>
<p>代码还是比较简单的这里就不在赘述，<code>once</code>的实现和<code>on</code>的唯一区别就是构造<code>Handler</code>的时候把<code>once</code>字段变为<code>true</code></p>
<p>接下来看看<code>off</code>的实现</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">off</span>(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, id: HandlerId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">listeners</span> = <span class="hljs-keyword">self</span>.listeners.<span class="hljs-title function_ invoke__">borrow_mut</span>();

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(handlers) = listeners.<span class="hljs-title function_ invoke__">get_mut</span>(event) {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">len</span> = handlers.<span class="hljs-title function_ invoke__">len</span>();
        handlers.<span class="hljs-title function_ invoke__">retain</span>(|h| h.id != id);

        <span class="hljs-keyword">return</span> len != handlers.<span class="hljs-title function_ invoke__">len</span>();
    }

    <span class="hljs-literal">false</span>
}
</code></pre>
<p>就是一个简单的根据<code>HandlerId</code>删除对应<code>Handler</code></p>
<p><code>off_all</code>就是直接从<code>HashMap</code>中删除整个事件</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">off_all</span>(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>) {
    <span class="hljs-keyword">self</span>.listeners.<span class="hljs-title function_ invoke__">borrow_mut</span>().<span class="hljs-title function_ invoke__">remove</span>(event);
}
</code></pre>
<p>这里先暂时不讲<code>emit</code>实现，前面提到过单个<code>Emitter</code>中同时处理了同步和异步闭包，还要为异步回调创建单独的<code>on</code>/<code>once</code>方法</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">trait</span> <span class="hljs-title class_">AsyncEventEmitter</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_async</span>&lt;F&gt;(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, callback: F) <span class="hljs-punctuation">-&gt;</span> HandlerId
    <span class="hljs-keyword">where</span>
        F: <span class="hljs-title function_ invoke__">Fn</span>(Args) <span class="hljs-punctuation">-&gt;</span> Pin&lt;<span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Future&lt;Output = ()&gt;&gt;&gt; + <span class="hljs-symbol">'static</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">once_async</span>&lt;F&gt;(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, callback: F) <span class="hljs-punctuation">-&gt;</span> HandlerId
    <span class="hljs-keyword">where</span>
        F: <span class="hljs-title function_ invoke__">Fn</span>(Args) <span class="hljs-punctuation">-&gt;</span> Pin&lt;<span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Future&lt;Output = ()&gt;&gt;&gt; + <span class="hljs-symbol">'static</span>;
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">AsyncEventEmitter</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">SingleThreadEventEmitter</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_async</span>&lt;F&gt;(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, callback: F) <span class="hljs-punctuation">-&gt;</span> HandlerId
    <span class="hljs-keyword">where</span>
        F: <span class="hljs-title function_ invoke__">Fn</span>(Args) <span class="hljs-punctuation">-&gt;</span> Pin&lt;<span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Future&lt;Output = ()&gt;&gt;&gt; + <span class="hljs-symbol">'static</span>,
    {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">id</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">get_id</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">handler</span> = Handler {
            id,
            callback: Callback::<span class="hljs-title function_ invoke__">Async</span>(Rc::<span class="hljs-title function_ invoke__">new</span>(callback)),
            once: <span class="hljs-literal">false</span>,
        };

        <span class="hljs-keyword">self</span>.listeners
            .<span class="hljs-title function_ invoke__">borrow_mut</span>()
            .<span class="hljs-title function_ invoke__">entry</span>(event.<span class="hljs-title function_ invoke__">to_string</span>())
            .<span class="hljs-title function_ invoke__">or_default</span>()
            .<span class="hljs-title function_ invoke__">push</span>(handler);

        id
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">once_async</span>&lt;F&gt;(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, callback: F) <span class="hljs-punctuation">-&gt;</span> HandlerId
    <span class="hljs-keyword">where</span>
        F: <span class="hljs-title function_ invoke__">Fn</span>(Args) <span class="hljs-punctuation">-&gt;</span> Pin&lt;<span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Future&lt;Output = ()&gt;&gt;&gt; + <span class="hljs-symbol">'static</span>,
    {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">id</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">get_id</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">handler</span> = Handler {
            id,
            callback: Callback::<span class="hljs-title function_ invoke__">Async</span>(Rc::<span class="hljs-title function_ invoke__">new</span>(callback)),
            once: <span class="hljs-literal">true</span>,
        };

        <span class="hljs-keyword">self</span>.listeners
            .<span class="hljs-title function_ invoke__">borrow_mut</span>()
            .<span class="hljs-title function_ invoke__">entry</span>(event.<span class="hljs-title function_ invoke__">to_string</span>())
            .<span class="hljs-title function_ invoke__">or_default</span>()
            .<span class="hljs-title function_ invoke__">push</span>(handler);

        id
    }
}
</code></pre>
<p>异步版<code>on</code>/<code>once</code>和同步版的唯一区别就是异步创建<code>Callback</code>时使用的是<code>Async</code>，同步为<code>Sync</code>。</p>
<p>现在来处理<code>emit</code>了，逻辑也不算太复杂，这里先贴上具体实现</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">emit</span>(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, args: Rc&lt;<span class="hljs-type">Vec</span>&lt;Arg&gt;&gt;) {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">callbacks</span>: <span class="hljs-type">Vec</span>&lt;Callback&gt; = <span class="hljs-keyword">self</span>
        .listeners
        .<span class="hljs-title function_ invoke__">borrow</span>()
        .<span class="hljs-title function_ invoke__">get</span>(event)
        .<span class="hljs-title function_ invoke__">map</span>(|handlers| handlers.<span class="hljs-title function_ invoke__">iter</span>().<span class="hljs-title function_ invoke__">map</span>(|h| h.callback.<span class="hljs-title function_ invoke__">clone</span>()).<span class="hljs-title function_ invoke__">collect</span>())
        .<span class="hljs-title function_ invoke__">unwrap_or_default</span>();

    <span class="hljs-keyword">for</span> <span class="hljs-variable">callback</span> <span class="hljs-keyword">in</span> callbacks {
        <span class="hljs-keyword">match</span> callback {
            Callback::<span class="hljs-title function_ invoke__">Sync</span>(cb) =&gt; {
                <span class="hljs-title function_ invoke__">cb</span>(args.<span class="hljs-title function_ invoke__">clone</span>());
            }
            Callback::<span class="hljs-title function_ invoke__">Async</span>(cb) =&gt; {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">args_clone</span> = args.<span class="hljs-title function_ invoke__">clone</span>();
                tokio::task::<span class="hljs-title function_ invoke__">spawn_local</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">move</span> {
                    <span class="hljs-title function_ invoke__">cb</span>(args_clone).<span class="hljs-keyword">await</span>;
                });
            }
        }
    }

    <span class="hljs-comment">// 清除单次执行的Handler</span>
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">listeners</span> = <span class="hljs-keyword">self</span>.listeners.<span class="hljs-title function_ invoke__">borrow_mut</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">handlers_opt</span> = listeners.<span class="hljs-title function_ invoke__">get_mut</span>(event);
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(handlers) = handlers_opt {
        handlers.<span class="hljs-title function_ invoke__">retain</span>(|h| !h.once);
    }
}
</code></pre>
<p>这里面有一个需要注意的点就是在之前的参数定义中，没有实现<code>Send</code>，并且也是使用的<code>Rc</code>非线程安全型，而在<code>tokio</code>中<code>spawn</code>是多线程调度，我们的参数不能在线程间安全传递，所以使用的是<code>spawn_local</code>，缺点就是调用的时候会有一点复杂。</p>
<h4 data-id="heading-3">使用</h4>
<h5 data-id="heading-4">同步</h5>
<p>如果不涉及异步，那调用相当简单</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">test</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">emitter</span> = SingleThreadEventEmitter::<span class="hljs-title function_ invoke__">new</span>();

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">id1</span> = emitter.<span class="hljs-title function_ invoke__">on</span>(<span class="hljs-string">"test"</span>, |_| { ... });
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">id2</span> = emitter.<span class="hljs-title function_ invoke__">once</span>(<span class="hljs-string">"test"</span>, <span class="hljs-keyword">move</span> |args| {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">Some</span>(arg) = args[<span class="hljs-number">0</span>].downcast_ref::&lt;<span class="hljs-type">i32</span>&gt;() {
            <span class="hljs-comment">// 参数处理逻辑</span>
        }
    });
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">id3</span> = emitter.<span class="hljs-title function_ invoke__">on</span>(<span class="hljs-string">"test"</span>, |_| { ... });

    emitter.<span class="hljs-title function_ invoke__">emit</span>(<span class="hljs-string">"test"</span>, Rc::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-built_in">vec!</span>[<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">42</span>) <span class="hljs-keyword">as</span> Arg]));
    emitter.<span class="hljs-title function_ invoke__">emit</span>(<span class="hljs-string">"test"</span>, Rc::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-built_in">vec!</span>[]));
}
</code></pre>
<p>直接结果和我们要求的一样，参数能正确获取，并且事件第二次触发的时候<code>id2</code>对应的<code>Handler</code>已经被删除不会触发。唯一的缺点还是参数的使用有点麻烦，这里给出一些解决方式：</p>
<ol>
<li>
<p><code>emit</code>时参数必须要类型断言且套<code>Rc</code>和<code>Vec</code></p>
<p>我们可以写一个简单的声明宏来自动生成参数代码模板</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[macro_export]</span>
<span class="hljs-built_in">macro_rules!</span> args {
    ($($v:expr),* $(,)?) =&gt; {
        std::rc::Rc::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-built_in">vec!</span>[$(<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>($v) <span class="hljs-keyword">as</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> std::any::Any&gt;),*])
    };
}
</code></pre>
</li>
<li>
<p>闭包中使用参数要经过复杂的类型向下转换(downcast)</p>
<p>可以自己封装一个函数来处理</p>
</li>
</ol>
<h5 data-id="heading-5">异步</h5>
<p>由于<code>Emitter</code>中异步设计和<code>spawn_local</code>的局限性，在单线程中使用异步会稍微有点复杂（在多线程版本中会好很多）,下面给出一个测试时候使用的用例</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[tokio::main(flavor = <span class="hljs-string">"current_thread"</span>)]</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">local</span> = LocalSet::<span class="hljs-title function_ invoke__">new</span>();

    local
        .<span class="hljs-title function_ invoke__">run_until</span>(<span class="hljs-keyword">async</span> {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">emitter</span> = SingleThreadEventEmitter::<span class="hljs-title function_ invoke__">new</span>();

            emitter.<span class="hljs-title function_ invoke__">on</span>(<span class="hljs-string">"e1"</span>, |_| {
                <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Emitted e1"</span>);
            });

            emitter.<span class="hljs-title function_ invoke__">once</span>(<span class="hljs-string">"e1"</span>, |args| {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">n</span>: <span class="hljs-type">i32</span> = *args[<span class="hljs-number">0</span>].<span class="hljs-title function_ invoke__">downcast_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
                <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, n);
                <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Emitted e1 2"</span>);
            });

            emitter.<span class="hljs-title function_ invoke__">on_async</span>(<span class="hljs-string">"e1"</span>, |args| {
                <span class="hljs-comment">// 必须这样写</span>
                <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">pin</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">move</span> {
                    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">n</span> = *args[<span class="hljs-number">0</span>].downcast_ref::&lt;<span class="hljs-type">i32</span>&gt;().<span class="hljs-title function_ invoke__">unwrap</span>();
                    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">res</span> = <span class="hljs-title function_ invoke__">async_test</span>(n).<span class="hljs-keyword">await</span>;
                    <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, res);
                })
            });

            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Emitting e1 first time"</span>);
            emitter.<span class="hljs-title function_ invoke__">emit</span>(<span class="hljs-string">"e1"</span>, args![<span class="hljs-number">1</span>]);

            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"Emitting e1 second time"</span>);
            emitter.<span class="hljs-title function_ invoke__">emit</span>(<span class="hljs-string">"e1"</span>, args![<span class="hljs-number">1</span>]);

            tokio::task::<span class="hljs-title function_ invoke__">yield_now</span>().<span class="hljs-keyword">await</span>;
        })
        .<span class="hljs-keyword">await</span>;
}
</code></pre>
<p>因为我们的单线程回调是<code>!Send</code>任务，使用<code>flavor = "current_thread"</code>保证我们的任务在单线程上面运行，同时要结合<code>LocalSet</code>进行本地任务调度。</p>
<p>关于必须写</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">pin</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">move</span> { ... })
</code></pre>
<p>本人技术不精，也没找到什么好的办法（向大佬求助）。</p>
<h3 data-id="heading-6">多线程</h3>
<p>有了单线程的代码结构，我们很容易在此基础上改造出一个多线程版本出来。</p>
<p>因为闭包参数会在多个线程中转递，所以要实现基本的<code>Send</code>和<code>Sync</code></p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ThreadSafeArg</span> = <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Any + <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span>&gt;;
</code></pre>
<p>其余对应的参数组，回调类型之类的只需要把<code>Rc</code>换为<code>Arc</code>，同时添加<code>Send</code>和<code>Sync</code>即可</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ThreadSafeArgs</span>=Arc&lt;<span class="hljs-type">Vec</span>&lt;ThreadSafeArg&gt;&gt;;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">SyncThreadSafeCallback</span> = Arc&lt;<span class="hljs-keyword">dyn</span> <span class="hljs-title function_ invoke__">Fn</span>(ThreadSafeArgs) + <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span>&gt;;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AsyncThreadSafeCallback</span> =
    Arc&lt;<span class="hljs-keyword">dyn</span> <span class="hljs-title function_ invoke__">Fn</span>(ThreadSafeArgs) <span class="hljs-punctuation">-&gt;</span> Pin&lt;<span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Future&lt;Output = ()&gt; + <span class="hljs-built_in">Send</span>&gt;&gt; + <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span>&gt;;
</code></pre>
<p>在<code>AsyncThreadSafeCallback</code>中由于<code>Future</code>不可能被多个函数同时轮询（在某一个线程中独占执行）所以只用实现<code>Send</code></p>
<p><code>Emitter</code>本体设计上和单线程版本有些区别，需要手动传入运行时，具体原因后面再说</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MultiThreadEventEmitter</span> {
    listeners: Arc&lt;Mutex&lt;HashMap&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Vec</span>&lt;ThreadSafeHandler&gt;&gt;&gt;&gt;,
    id_counter: Arc&lt;AtomicU64&gt;,
    handle: <span class="hljs-type">Option</span>&lt;tokio::runtime::Handle&gt;,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">MultiThreadEventEmitter</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">Self</span> {
            listeners: Arc::<span class="hljs-title function_ invoke__">new</span>(Mutex::<span class="hljs-title function_ invoke__">new</span>(HashMap::<span class="hljs-title function_ invoke__">new</span>())),
            id_counter: Arc::<span class="hljs-title function_ invoke__">new</span>(AtomicU64::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-number">0</span>)),
            handle: <span class="hljs-literal">None</span>,
        }
    }

    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">set_handle</span>(<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, handle: tokio::runtime::Handle) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">self</span>.handle = <span class="hljs-title function_ invoke__">Some</span>(handle);
        <span class="hljs-keyword">self</span>
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_id</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> HandlerId {
        <span class="hljs-keyword">self</span>.id_counter.<span class="hljs-title function_ invoke__">fetch_add</span>(<span class="hljs-number">1</span>, Ordering::SeqCst)
    }
}
</code></pre>
<p>对应的接口方法定义</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">trait</span> <span class="hljs-title class_">ThreadSafeEventEmitter</span>: <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">on</span>&lt;F&gt;(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, callback: F) <span class="hljs-punctuation">-&gt;</span> HandlerId
    <span class="hljs-keyword">where</span>
        F: <span class="hljs-title function_ invoke__">Fn</span>(ThreadSafeArgs) + <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span> + <span class="hljs-symbol">'static</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">once</span>&lt;F&gt;(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, callback: F) <span class="hljs-punctuation">-&gt;</span> HandlerId
    <span class="hljs-keyword">where</span>
        F: <span class="hljs-title function_ invoke__">Fn</span>(ThreadSafeArgs) + <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span> + <span class="hljs-symbol">'static</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">off</span>(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, id: HandlerId) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">off_all</span>(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>);

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">emit</span>(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, args: Arc&lt;<span class="hljs-type">Vec</span>&lt;ThreadSafeArg&gt;&gt;);
}

<span class="hljs-keyword">trait</span> <span class="hljs-title class_">ThreadSafeAsyncEventEmitter</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">on_async</span>&lt;F&gt;(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, callback: F) <span class="hljs-punctuation">-&gt;</span> HandlerId
    <span class="hljs-keyword">where</span>
        F: <span class="hljs-title function_ invoke__">Fn</span>(ThreadSafeArgs) <span class="hljs-punctuation">-&gt;</span> Pin&lt;<span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Future&lt;Output = ()&gt; + <span class="hljs-built_in">Send</span>&gt;&gt;
            + <span class="hljs-built_in">Send</span>
            + <span class="hljs-built_in">Sync</span>
            + <span class="hljs-symbol">'static</span>;

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">once_async</span>&lt;F&gt;(&amp;<span class="hljs-keyword">self</span>, event: &amp;<span class="hljs-type">str</span>, callback: F) <span class="hljs-punctuation">-&gt;</span> HandlerId
    <span class="hljs-keyword">where</span>
        F: <span class="hljs-title function_ invoke__">Fn</span>(ThreadSafeArgs) <span class="hljs-punctuation">-&gt;</span> Pin&lt;<span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> Future&lt;Output = ()&gt; + <span class="hljs-built_in">Send</span>&gt;&gt;
            + <span class="hljs-built_in">Send</span>
            + <span class="hljs-built_in">Sync</span>
            + <span class="hljs-symbol">'static</span>;
}
</code></pre>
<p>类型定义和大部分实现上和单线程版本没有太大差别，只是多实现了<code>Send</code>和<code>Sync</code>，然后把<code>Rc</code>换为<code>Arc</code>，<code>RefCell</code>换为<code>Mutex</code>，然后多了一些并发锁的处理。具体实现：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FLengineerC%2Feventemitter-rs%2Fblob%2Fmain%2Fsrc%2Fevent_emitters%2Fmulti_thread.rs" target="_blank" title="https://github.com/LengineerC/eventemitter-rs/blob/main/src/event_emitters/multi_thread.rs" ref="nofollow noopener noreferrer">multi_thread.rs</a></p>
<p>回到需要传入运行时的问题，在多线程的<code>emit</code>中，一样采用了同步异步的混合处理，但是可以发现并没有采用<code>tokio::spawn</code>的方式执行异步任务，因为<code>tokio::spawn</code>只能在当前上下文中执行，<code>emit</code>函数本身不是<code>async</code>的，而且整个<code>MultiThreadEventEmitter</code>也不是<code>async</code>块本身。所以为了保留上下文，最好的办法就是调用时直接传递上下文。</p>
<h4 data-id="heading-7">使用</h4>
<h5 data-id="heading-8">同步</h5>
<p>和单线程没有任何区别，也要参数类型断言和向下转换，也可以写一个宏来处理参数类型断言的问题</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[macro_export]</span>
<span class="hljs-built_in">macro_rules!</span> ts_args {
    ($($v:expr),* $(,)?) =&gt; {
        std::sync::Arc::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-built_in">vec!</span>[$(<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>($v) <span class="hljs-keyword">as</span> <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> std::any::Any + <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span>&gt;),*])
    };
}
</code></pre>
<h5 data-id="heading-9">异步</h5>
<p>同样展示一个测试是的用例</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-meta">#[tokio::main]</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">rt</span> = tokio::runtime::Runtime::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">emitter</span> = MultiThreadEventEmitter::<span class="hljs-title function_ invoke__">new</span>()
        .<span class="hljs-title function_ invoke__">set_handle</span>(rt.<span class="hljs-title function_ invoke__">handle</span>().<span class="hljs-title function_ invoke__">clone</span>());
    emitter.<span class="hljs-title function_ invoke__">on</span>(<span class="hljs-string">"e1"</span>, |_| {
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"e1 1"</span>);
    });

    emitter.<span class="hljs-title function_ invoke__">on</span>(<span class="hljs-string">"e1"</span>, |args| {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">n</span>: <span class="hljs-type">i32</span> = *args[<span class="hljs-number">0</span>].<span class="hljs-title function_ invoke__">downcast_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-built_in">println!</span>(<span class="hljs-string">"{}"</span>, n);
    });

    emitter.<span class="hljs-title function_ invoke__">on_async</span>(<span class="hljs-string">"e1"</span>, |args| {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">n</span>: <span class="hljs-type">i32</span> = *args[<span class="hljs-number">1</span>].<span class="hljs-title function_ invoke__">downcast_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">pin</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">move</span> {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">res</span> = <span class="hljs-title function_ invoke__">async_test</span>(n).<span class="hljs-keyword">await</span>;
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"async: {}"</span>, res);
        })
    });

    emitter.<span class="hljs-title function_ invoke__">once_async</span>(<span class="hljs-string">"e1"</span>, |args| {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">n</span>: <span class="hljs-type">i32</span> = *args[<span class="hljs-number">0</span>].<span class="hljs-title function_ invoke__">downcast_ref</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
        <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">pin</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">move</span> {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">res</span> = <span class="hljs-title function_ invoke__">async_test</span>(n).<span class="hljs-keyword">await</span>;
            <span class="hljs-built_in">println!</span>(<span class="hljs-string">"async once: {}"</span>, res);
        })
    });

    emitter.<span class="hljs-title function_ invoke__">emit</span>(<span class="hljs-string">"e1"</span>, ts_args![<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]);

    <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">h</span> = thread::<span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || {
        emitter.<span class="hljs-title function_ invoke__">emit</span>(<span class="hljs-string">"e1"</span>, ts_args![<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]);
    });

    h.<span class="hljs-title function_ invoke__">join</span>().<span class="hljs-title function_ invoke__">unwrap</span>();
}
</code></pre>
<p>除了没有单线程的<code>flavor = "current_thread"</code>和<code>LocalSet</code>，调用方法和单线程并无区别。</p>
<h2 data-id="heading-10">总结</h2>
<p>这个事件总线的实现了最基本的订阅发布功能，异步处理上还是存在一些未解决的问题。本文只是作为一种实现思路，在细节部分上没有做到完美（<del>当然和实力有关</del>）。<strong>作为一个初学者欢迎大家批评指正，有好的思路也欢迎大家指导。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在MATLAB中对基因表达数据进行数据预处理]]></title>    <link>https://juejin.cn/post/7576628528843751433</link>    <guid>https://juejin.cn/post/7576628528843751433</guid>    <pubDate>2025-11-25T12:52:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576628528843751433" data-draft-id="7576628528843735049" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在MATLAB中对基因表达数据进行数据预处理"/> <meta itemprop="keywords" content="MATLAB"/> <meta itemprop="datePublished" content="2025-11-25T12:52:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三维空间"/> <meta itemprop="url" content="https://juejin.cn/user/3731069876053802"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在MATLAB中对基因表达数据进行数据预处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3731069876053802/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三维空间
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T12:52:22.000Z" title="Tue Nov 25 2025 12:52:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>基因表达数据的预处理是后续差异分析、降维可视化的<strong>核心前提</strong>，其目标是：<strong>去除噪声、统一量纲、纠正系统偏差（如批次效应）、处理缺失/异常值</strong>，确保数据满足统计分析的要求。MATLAB中需结合基因表达数据的特性（高维、稀疏、分微阵列/RNA-seq类型），按标准化流程处理，以下是完整可复现的预处理步骤、代码及关键解读。</p>
<h3 data-id="heading-0">一、预处理核心目标与数据类型区分</h3>
<h4 data-id="heading-1">1. 核心目标</h4>
<ul>
<li>过滤无生物学意义的低表达基因（减少噪声和计算量）；</li>
<li>消除量纲差异（如不同基因表达量范围差异达数个数量级）；</li>
<li>处理缺失值/异常值（避免统计检验偏差）；</li>
<li>校正批次效应（多批次实验数据的系统误差）；</li>
<li>转换数据分布（如RNA-seq计数数据的对数转换）。</li>
</ul>
<h4 data-id="heading-2">2. 常见数据类型（预处理方法差异大）</h4>

























<table><thead><tr><th>数据类型</th><th>特征</th><th>预处理重点</th></tr></thead><tbody><tr><td>微阵列数据</td><td>连续型、易受芯片效应影响</td><td>分位数标准化、批次校正</td></tr><tr><td>RNA-seq原始计数数据</td><td>离散型（读段数）、高稀疏性</td><td>低计数过滤、TMM/RLE归一化、log2转换</td></tr><tr><td>RNA-seq标准化数据（FPKM/TPM）</td><td>连续型、已校正测序深度</td><td>z-score标准化、低表达过滤</td></tr></tbody></table>
<h3 data-id="heading-3">二、标准预处理流程（附MATLAB代码）</h3>
<p>以下以“混合模拟数据”为例，覆盖<strong>微阵列/RNA-seq</strong>的通用预处理流程，可直接适配真实数据。</p>
<h4 data-id="heading-4">步骤1：数据加载与格式转换</h4>
<p>首先加载数据（支持GEO下载的<code>.txt</code>/<code>.csv</code>、矩阵格式、表格格式），并转换为“样本×基因”的矩阵（行=样本，列=基因）。</p>
<pre><code class="hljs language-matlab" lang="matlab"><span class="hljs-comment">% ===================== 1.1 加载数据（二选一） =====================</span>
<span class="hljs-comment">% 选项1：加载真实数据（GEO下载的txt/csv）</span>
<span class="hljs-comment">% data_table = readtable('GSE12345_expr.txt', 'TextType','string'); % 第一列=样本名，后续列=基因</span>
<span class="hljs-comment">% group = categorical(data_table(:,1)); % 分组标签（可选）</span>
<span class="hljs-comment">% expr_matrix = table2array(data_table(:,2:end)); % 表达矩阵 [样本数×基因数]</span>

<span class="hljs-comment">% 选项2：模拟数据（复现用，模拟RNA-seq计数+微阵列混合特征）</span>
rng(<span class="hljs-number">1</span>);
n_samples = <span class="hljs-number">60</span>;  <span class="hljs-comment">% 60个样本（20 Control + 40 Treatment）</span>
n_genes = <span class="hljs-number">2000</span>;  <span class="hljs-comment">% 2000个基因</span>
<span class="hljs-comment">% 模拟RNA-seq原始计数（离散、高稀疏）</span>
expr_counts = randi([<span class="hljs-number">0</span>, <span class="hljs-number">1000</span>], n_samples, n_genes); 
<span class="hljs-comment">% 模拟微阵列数据（连续、正态分布）</span>
expr_array = <span class="hljs-built_in">randn</span>(n_samples, n_genes) * <span class="hljs-number">50</span> + <span class="hljs-number">100</span>;  
<span class="hljs-comment">% 分组标签</span>
group = categorical([<span class="hljs-built_in">repmat</span>(<span class="hljs-string">'Control'</span>,<span class="hljs-number">20</span>,<span class="hljs-number">1</span>); <span class="hljs-built_in">repmat</span>(<span class="hljs-string">'Treatment'</span>,<span class="hljs-number">40</span>,<span class="hljs-number">1</span>)]);
<span class="hljs-comment">% 人为添加缺失值和异常值（模拟真实数据）</span>
expr_counts(randi(n_samples*n_genes, <span class="hljs-number">50</span>,<span class="hljs-number">1</span>)) = NaN; <span class="hljs-comment">% 50个缺失值</span>
expr_array(randi(n_samples*n_genes, <span class="hljs-number">30</span>,<span class="hljs-number">1</span>)) = expr_array(randi(n_samples*n_genes, <span class="hljs-number">30</span>,<span class="hljs-number">1</span>)) * <span class="hljs-number">10</span>; <span class="hljs-comment">% 异常值</span>
</code></pre>
<h4 data-id="heading-5">步骤2：数据质控（QC）—— 检测异常样本/基因</h4>
<p>质控是预处理的“第一道关卡”，通过可视化识别异常样本（如离群值、批次偏差），避免后续分析偏差。</p>
<pre><code class="hljs language-matlab" lang="matlab"><span class="hljs-comment">% ===================== 2.1 样本水平QC（箱线图：检测整体表达分布） =====================</span>
<span class="hljs-built_in">figure</span>(<span class="hljs-string">'Color'</span>,<span class="hljs-string">'w'</span>);
tiledlayout(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>);
<span class="hljs-comment">% 计数数据QC</span>
nexttile;
boxplot(<span class="hljs-built_in">log2</span>(expr_counts+<span class="hljs-number">1</span>)); <span class="hljs-comment">% log2转换后可视化（避免0值）</span>
title(<span class="hljs-string">'RNA-seq计数数据样本表达分布'</span>);
xlabel(<span class="hljs-string">'样本'</span>); ylabel(<span class="hljs-string">'log2(Count+1)'</span>);
<span class="hljs-comment">% 微阵列数据QC</span>
nexttile;
boxplot(expr_array);
title(<span class="hljs-string">'微阵列数据样本表达分布'</span>);
xlabel(<span class="hljs-string">'样本'</span>); ylabel(<span class="hljs-string">'表达量'</span>);

<span class="hljs-comment">% ===================== 2.2 样本相关性分析（检测离群样本） =====================</span>
<span class="hljs-comment">% 计算样本间皮尔逊相关系数</span>
corr_matrix = corr(expr_array, <span class="hljs-string">'Rows'</span>,<span class="hljs-string">'pairwise'</span>); <span class="hljs-comment">% 忽略缺失值</span>
<span class="hljs-built_in">figure</span>(<span class="hljs-string">'Color'</span>,<span class="hljs-string">'w'</span>);
heatmap(corr_matrix, <span class="hljs-string">'Colormap'</span>,parula, <span class="hljs-string">'Title'</span>,<span class="hljs-string">'样本间相关性热图'</span>);
<span class="hljs-comment">% 识别离群样本（相关性&lt;0.5的样本）</span>
mean_corr = <span class="hljs-built_in">mean</span>(corr_matrix, <span class="hljs-number">2</span>);
outlier_samples = mean_corr &lt; <span class="hljs-number">0.5</span>;
fprintf(<span class="hljs-string">'检测到 %d 个离群样本\n'</span>, sum(outlier_samples));
<span class="hljs-comment">% 移除离群样本（可选，根据研究需求）</span>
expr_array(outlier_samples, :) = [];
expr_counts(outlier_samples, :) = [];
group(outlier_samples, :) = [];
</code></pre>
<h4 data-id="heading-6">步骤3：过滤低表达基因（核心！减少噪声）</h4>
<p>低表达基因（如RNA-seq中大部分样本count=0）无生物学意义，会增加计算量和假阳性，需优先过滤。</p>
<pre><code class="hljs language-matlab" lang="matlab"><span class="hljs-comment">% ===================== 3.1 RNA-seq原始计数数据过滤 =====================</span>
<span class="hljs-comment">% 规则：至少10%的样本count≥5（可调整，如严格版：20%样本count≥10）</span>
filter_counts = <span class="hljs-built_in">mean</span>(expr_counts &gt;= <span class="hljs-number">5</span>, <span class="hljs-number">1</span>) &gt;= <span class="hljs-number">0.1</span>; <span class="hljs-comment">% 列（基因）维度计算</span>
expr_counts_filtered = expr_counts(:, filter_counts);
fprintf(<span class="hljs-string">'RNA-seq过滤后剩余基因数：%d/%d\n'</span>, sum(filter_counts), n_genes);

<span class="hljs-comment">% ===================== 3.2 微阵列/标准化RNA-seq数据过滤 =====================</span>
<span class="hljs-comment">% 规则：至少80%样本表达量&gt;0.1（消除背景噪声）</span>
filter_array = <span class="hljs-built_in">mean</span>(expr_array &gt; <span class="hljs-number">0.1</span>, <span class="hljs-number">1</span>) &gt;= <span class="hljs-number">0.8</span>;
expr_array_filtered = expr_array(:, filter_array);
fprintf(<span class="hljs-string">'微阵列过滤后剩余基因数：%d/%d\n'</span>, sum(filter_array), n_genes);
</code></pre>
<h4 data-id="heading-7">步骤4：标准化/归一化（消除系统偏差）</h4>
<p>核心是统一数据量纲，不同数据类型对应不同方法：</p>

























<table><thead><tr><th>数据类型</th><th>推荐方法</th><th>适用场景</th></tr></thead><tbody><tr><td>微阵列数据</td><td>分位数标准化（Quantile）</td><td>消除芯片间系统偏差</td></tr><tr><td>RNA-seq原始计数</td><td>TMM/RLE归一化</td><td>校正测序深度和基因长度偏差</td></tr><tr><td>所有类型（后续分析用）</td><td>z-score标准化</td><td>消除基因间量纲差异，适配统计检验</td></tr></tbody></table>
<pre><code class="hljs language-matlab" lang="matlab"><span class="hljs-comment">% ===================== 4.1 RNA-seq计数数据：TMM归一化（需调用R包edgeR） =====================</span>
<span class="hljs-comment">% 步骤1：导出计数数据到CSV</span>
writematrix(expr_counts_filtered, <span class="hljs-string">'counts_filtered.csv'</span>);
<span class="hljs-comment">% 步骤2：编写R脚本执行TMM归一化</span>
r_script_tmm = [
    <span class="hljs-string">'library(edgeR);'</span>
    <span class="hljs-string">'counts &lt;- read.csv("counts_filtered.csv", header=F);'</span>
    <span class="hljs-string">'dge &lt;- DGEList(counts=as.matrix(counts));'</span>
    <span class="hljs-string">'dge &lt;- calcNormFactors(dge, method="TMM");'</span> <span class="hljs-comment">% TMM归一化</span>
    <span class="hljs-string">'counts_tmm &lt;- cpm(dge, log=TRUE);'</span> <span class="hljs-comment">% 转换为log2(CPM)</span>
    <span class="hljs-string">'write.csv(counts_tmm, "counts_tmm.csv");'</span>
];
<span class="hljs-comment">% 运行R脚本（需安装edgeR包，MATLAB需配置R环境）</span>
system([<span class="hljs-string">'Rscript -e "'</span>, r_script_tmm, <span class="hljs-string">'"'</span>]);
<span class="hljs-comment">% 步骤3：MATLAB读取归一化后的数据</span>
expr_counts_tmm = readmatrix(<span class="hljs-string">'counts_tmm.csv'</span>);
expr_counts_tmm = expr_counts_tmm(:, <span class="hljs-number">2</span>:<span class="hljs-keyword">end</span>); <span class="hljs-comment">% 去除行索引列</span>

<span class="hljs-comment">% ===================== 4.2 微阵列数据：分位数标准化 =====================</span>
expr_array_quantile = quantile_normalize(expr_array_filtered); <span class="hljs-comment">% 自定义函数</span>

<span class="hljs-comment">% ===================== 4.3 通用：z-score标准化（适配后续统计分析） =====================</span>
<span class="hljs-comment">% 对归一化后的数据做z-score（行=样本，列=基因，按列标准化）</span>
expr_counts_std = zscore(expr_counts_tmm, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); 
expr_array_std = zscore(expr_array_quantile, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>); 

<span class="hljs-comment">% 分位数标准化辅助函数</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">normalized_data</span> = <span class="hljs-title">quantile_normalize</span><span class="hljs-params">(data)</span></span>
    [n, p] = <span class="hljs-built_in">size</span>(data);
    <span class="hljs-comment">% 按列排序</span>
    sorted_data = <span class="hljs-built_in">sort</span>(data, <span class="hljs-number">1</span>);
    <span class="hljs-comment">% 计算每行的均值（分位数）</span>
    quantile_means = <span class="hljs-built_in">mean</span>(sorted_data, <span class="hljs-number">2</span>);
    <span class="hljs-comment">% 替换原数据的排序值为分位数均值</span>
    [~, idx] = <span class="hljs-built_in">sort</span>(data, <span class="hljs-number">1</span>);
    normalized_data = <span class="hljs-built_in">zeros</span>(n, p);
    <span class="hljs-keyword">for</span> <span class="hljs-built_in">j</span> = <span class="hljs-number">1</span>:p
        normalized_data(idx(:,<span class="hljs-built_in">j</span>), <span class="hljs-built_in">j</span>) = quantile_means;
    <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h4 data-id="heading-8">步骤5：缺失值处理（避免统计偏差）</h4>
<p>优先用<strong>K近邻填充（KNN）</strong>（保留数据分布），避免简单均值/中位数填充（引入偏差）。</p>
<pre><code class="hljs language-matlab" lang="matlab"><span class="hljs-comment">% ===================== 5.1 K近邻填充缺失值（需Statistics Toolbox） =====================</span>
<span class="hljs-comment">% 处理RNA-seq归一化数据的缺失值</span>
<span class="hljs-keyword">if</span> any(<span class="hljs-built_in">isnan</span>(expr_counts_std))
    expr_counts_std = knnimpute(expr_counts_std); <span class="hljs-comment">% K=5（默认）</span>
<span class="hljs-keyword">end</span>
<span class="hljs-comment">% 处理微阵列标准化数据的缺失值</span>
<span class="hljs-keyword">if</span> any(<span class="hljs-built_in">isnan</span>(expr_array_std))
    expr_array_std = knnimpute(expr_array_std);
<span class="hljs-keyword">end</span>

<span class="hljs-comment">% ===================== 5.2 异常值处理（可选） =====================</span>
<span class="hljs-comment">% 方法：将超过3倍标准差的值截断为±3σ（避免极端值影响）</span>
sigma = <span class="hljs-number">3</span>;
expr_counts_std(expr_counts_std &gt; sigma) = sigma;
expr_counts_std(expr_counts_std &lt; -sigma) = -sigma;
expr_array_std(expr_array_std &gt; sigma) = sigma;
expr_array_std(expr_array_std &lt; -sigma) = -sigma;
</code></pre>
<h4 data-id="heading-9">步骤6：批次效应校正（多批次数据必做）</h4>
<p>多批次实验（如不同时间/平台测序）会引入系统偏差，需用<code>ComBat</code>校正（MATLAB调用R包<code>sva</code>）。</p>
<pre><code class="hljs language-matlab" lang="matlab"><span class="hljs-comment">% 模拟批次信息（60样本分2个批次）</span>
batch = categorical([<span class="hljs-built_in">repmat</span>(<span class="hljs-string">'Batch1'</span>,<span class="hljs-number">30</span>,<span class="hljs-number">1</span>); <span class="hljs-built_in">repmat</span>(<span class="hljs-string">'Batch2'</span>,<span class="hljs-number">30</span>,<span class="hljs-number">1</span>)]);
<span class="hljs-comment">% 导出数据和批次信息到CSV</span>
writematrix(expr_array_std, <span class="hljs-string">'array_std.csv'</span>);
<span class="hljs-built_in">writetable</span>(<span class="hljs-built_in">table</span>(batch), <span class="hljs-string">'batch_info.csv'</span>);
<span class="hljs-comment">% 编写R脚本执行ComBat校正</span>
r_script_combat = [
    <span class="hljs-string">'library(sva);'</span>
    <span class="hljs-string">'data &lt;- read.csv("array_std.csv", header=F);'</span>
    <span class="hljs-string">'batch &lt;- as.factor(read.csv("batch_info.csv")[,1]);'</span>
    <span class="hljs-string">'mod &lt;- model.matrix(~1, data=as.data.frame(t(data)));'</span> <span class="hljs-comment">% 无分组的校正模型</span>
    <span class="hljs-string">'data_combat &lt;- ComBat(dat=t(data), batch=batch, mod=mod);'</span>
    <span class="hljs-string">'write.csv(t(data_combat), "array_combat.csv");'</span>
];
<span class="hljs-comment">% 运行R脚本</span>
system([<span class="hljs-string">'Rscript -e "'</span>, r_script_combat, <span class="hljs-string">'"'</span>]);
<span class="hljs-comment">% 读取校正后的数据</span>
expr_array_combat = readmatrix(<span class="hljs-string">'array_combat.csv'</span>);
expr_array_combat = expr_array_combat(:, <span class="hljs-number">2</span>:<span class="hljs-keyword">end</span>);
</code></pre>
<h4 data-id="heading-10">步骤7：数据转换（按需）</h4>
<ul>
<li>RNA-seq计数数据：需<code>log2(CPM+1)</code>/<code>log2(TPM+1)</code>转换，使数据接近正态分布；</li>
<li>微阵列数据：若分布偏态，可做<code>log2</code>转换（需确保无负值）。</li>
</ul>
<pre><code class="hljs language-matlab" lang="matlab"><span class="hljs-comment">% RNA-seq计数数据log2转换（已在TMM归一化时完成，此处为示例）</span>
expr_counts_log = <span class="hljs-built_in">log2</span>(expr_counts_filtered + <span class="hljs-number">1</span>); <span class="hljs-comment">% +1避免log2(0)</span>
</code></pre>
<h3 data-id="heading-11">三、不同数据类型的预处理模板（直接复用）</h3>
<h4 data-id="heading-12">模板1：微阵列数据预处理</h4>
<pre><code class="hljs language-matlab" lang="matlab"><span class="hljs-comment">% 1. 加载数据</span>
data = <span class="hljs-built_in">readtable</span>(<span class="hljs-string">'array_data.txt'</span>);
expr = table2array(data(:,<span class="hljs-number">2</span>:<span class="hljs-keyword">end</span>));
<span class="hljs-comment">% 2. 质控（移除离群样本）</span>
corr_mat = corr(expr, <span class="hljs-string">'Rows'</span>,<span class="hljs-string">'pairwise'</span>);
outlier = <span class="hljs-built_in">mean</span>(corr_mat,<span class="hljs-number">2</span>) &lt; <span class="hljs-number">0.5</span>;
expr = expr(~outlier, :);
<span class="hljs-comment">% 3. 过滤低表达基因</span>
filter = <span class="hljs-built_in">mean</span>(expr&gt;<span class="hljs-number">0.1</span>,<span class="hljs-number">1</span>)&gt;=<span class="hljs-number">0.8</span>;
expr = expr(:,filter);
<span class="hljs-comment">% 4. 分位数标准化</span>
expr = quantile_normalize(expr);
<span class="hljs-comment">% 5. z-score标准化</span>
expr = zscore(expr,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);
<span class="hljs-comment">% 6. 缺失值填充</span>
expr = knnimpute(expr);
<span class="hljs-comment">% 7. 批次校正（如有批次）</span>
<span class="hljs-comment">% ...（参考步骤6）</span>
</code></pre>
<h4 data-id="heading-13">模板2：RNA-seq原始计数数据预处理</h4>
<pre><code class="hljs language-matlab" lang="matlab"><span class="hljs-comment">% 1. 加载数据</span>
counts = readmatrix(<span class="hljs-string">'counts_data.csv'</span>);
<span class="hljs-comment">% 2. 过滤低表达基因</span>
filter = <span class="hljs-built_in">mean</span>(counts&gt;=<span class="hljs-number">5</span>,<span class="hljs-number">1</span>)&gt;=<span class="hljs-number">0.1</span>;
counts = counts(:,filter);
<span class="hljs-comment">% 3. TMM归一化+log2转换（调用edgeR）</span>
<span class="hljs-comment">% ...（参考步骤4.1）</span>
<span class="hljs-comment">% 4. z-score标准化</span>
counts_std = zscore(counts_tmm,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);
<span class="hljs-comment">% 5. 缺失值填充</span>
counts_std = knnimpute(counts_std);
</code></pre>
<h3 data-id="heading-14">四、关键注意事项</h3>
<ol>
<li>
<p><strong>参数选择</strong>：</p>
<ul>
<li>低表达过滤阈值：RNA-seq可放宽至“5%样本count≥3”（小样本），微阵列避免过严（否则丢失关键基因）；</li>
<li>KNN填充的K值：默认K=5，高维数据可设K=10；</li>
<li>标准化方法：无批次的微阵列用分位数，有批次用ComBat+分位数；RNA-seq优先TMM（优于RLE）。</li>
</ul>
</li>
<li>
<p><strong>避免常见错误</strong>：</p>
<ul>
<li>不要先标准化再过滤低表达基因（噪声基因会干扰标准化）；</li>
<li>不要用均值填充缺失值（会抹平样本间差异）；</li>
<li>RNA-seq计数数据不要直接做z-score（未校正测序深度）。</li>
</ul>
</li>
<li>
<p><strong>工具依赖</strong>：</p>
<ul>
<li>MATLAB需安装：Statistics and Machine Learning Toolbox；</li>
<li>RNA-seq/TMM/ComBat需调用R包：<code>edgeR</code>、<code>sva</code>（需配置MATLAB-R联动，参考MATLAB帮助文档）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-15">五、预处理后的数据验证</h3>
<p>预处理完成后，需验证数据质量：</p>
<pre><code class="hljs language-matlab" lang="matlab"><span class="hljs-comment">% 1. 箱线图：验证样本表达分布是否一致</span>
boxplot(expr_array_combat);
title(<span class="hljs-string">'批次校正后样本表达分布'</span>);
<span class="hljs-comment">% 2. 主成分分析（PCA）：验证批次是否被消除</span>
[~, score] = pca(expr_array_combat);
gscatter(score(:,<span class="hljs-number">1</span>), score(:,<span class="hljs-number">2</span>), batch); <span class="hljs-comment">% 批次标签着色，若无聚类则校正成功</span>
</code></pre>
<p>如需针对<strong>单细胞RNA-seq、空间转录组</strong>等特殊类型基因表达数据的预处理（如细胞过滤、归一化方法SCTransform），可补充说明，我会定制化调整代码！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node写MCP入门教程]]></title>    <link>https://juejin.cn/post/7576482238461001770</link>    <guid>https://juejin.cn/post/7576482238461001770</guid>    <pubDate>2025-11-25T12:56:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576482238461001770" data-draft-id="7576477434733346822" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node写MCP入门教程"/> <meta itemprop="keywords" content="前端,MCP,Agent"/> <meta itemprop="datePublished" content="2025-11-25T12:56:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂踩坑人"/> <meta itemprop="url" content="https://juejin.cn/user/1011206430698574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node写MCP入门教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1011206430698574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂踩坑人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T12:56:02.000Z" title="Tue Nov 25 2025 12:56:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>引言：用 Node + TypeScript 实现一个基于 <code>stdio</code> 的 MCP（Model Context Protocol）服务——<code>mcp-file-counter</code>，并通过 <code>@modelcontextprotocol/inspector</code> 进行交互式调试。文中提供完整代码、命令与调试步骤，按步骤即可搭建运行。</p>
</blockquote>
<h2 data-id="heading-0">一、MCP 简介与目标</h2>
<ul>
<li>MCP 是一种让模型与外部工具安全、结构化交互的协议，常用于将代码、数据库、Web API 等能力接入到模型对话中。</li>
<li>本文目标：实现一个名为 <code>mcp-file-counter</code> 的 MCP 服务，通过 <code>count_files</code> 工具统计指定目录的文件数量（支持忽略目录），并用 Inspector 可视化调用与调试。</li>
</ul>
<h2 data-id="heading-1">二、创建项目</h2>
<h3 data-id="heading-2">环境准备</h3>
<ul>
<li>Node 版本：<code>&gt;= 18</code></li>
<li>包管理：推荐 <code>pnpm</code></li>
<li>辅助工具：<code>ni</code>/<code>nr</code>（可选，统一安装/运行体验）</li>
</ul>
<p>检查与安装：</p>
<pre><code class="hljs language-bash" lang="bash">node -v
pnpm -v

<span class="hljs-comment"># 若未安装 pnpm</span>
npm i -g pnpm

<span class="hljs-comment"># 可选：安装 ni/nr（Antfu 的统一包管理器命令）</span>
npm i -g @antfu/ni
</code></pre>
<h3 data-id="heading-3">初始项目和安装依赖</h3>
<p>在空目录中初始化并安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化（可选）</span>
pnpm init -y

<span class="hljs-comment"># 运行时依赖</span>
ni @modelcontextprotocol/sdk

<span class="hljs-comment"># 开发依赖</span>
ni -D typescript tsx @types/node @modelcontextprotocol/inspector
</code></pre>
<p>若未安装 <code>ni</code>，可使用 <code>pnpm add</code> 等价替代：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add @modelcontextprotocol/sdk
pnpm add -D typescript tsx @types/node @modelcontextprotocol/inspector
</code></pre>
<h3 data-id="heading-4">项目结构</h3>
<p>建议目录结构如下：</p>
<pre><code class="hljs language-text" lang="text">package.json
tsconfig.json
src/
  server.ts
  tools/
    fileCount.ts
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f41461cedd14de89f57b80db055c6c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764680548&amp;x-signature=oIrs7t4rT8KkalLpFd7AZtsxt6I%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">TypeScript 配置</h3>
<p>在项目根目录创建 <code>tsconfig.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ES2022"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"NodeNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"NodeNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"rootDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"skipLibCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-6">三、实现文件计数工具</h2>
<p>新建 <code>src/tools/fileCount.ts</code>：</p>
<p>功能与实现简述：</p>
<ul>
<li>功能：遍历指定根目录，统计普通文件总数，并支持忽略目录或相对路径。</li>
<li>实现：以深度优先递归遍历目录，使用 <code>ignore</code> 集合过滤，<code>visited</code> 集合避免重复计数与符号链接循环。</li>
<li>关键点：<code>withFileTypes: true</code> 获取类型；目录继续递归，文件累加；<code>path.relative</code> 帮助按根相对路径做忽略匹配。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">"node:fs"</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"node:path"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">countFiles</span>(<span class="hljs-params">root: <span class="hljs-built_in">string</span>, ignore: <span class="hljs-built_in">string</span>[] = []</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {
  <span class="hljs-keyword">const</span> visited = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;();
  <span class="hljs-keyword">const</span> ig = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>(ignore.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">s</span> =&gt;</span> s.<span class="hljs-title function_">trim</span>()).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>));

  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">walk</span>(<span class="hljs-params">dir: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {
    <span class="hljs-keyword">const</span> dirents = <span class="hljs-keyword">await</span> fs.<span class="hljs-property">promises</span>.<span class="hljs-title function_">readdir</span>(dir, { <span class="hljs-attr">withFileTypes</span>: <span class="hljs-literal">true</span> });
    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> d <span class="hljs-keyword">of</span> dirents) {
      <span class="hljs-keyword">const</span> full = path.<span class="hljs-title function_">join</span>(dir, d.<span class="hljs-property">name</span>);
      <span class="hljs-keyword">const</span> rel = path.<span class="hljs-title function_">relative</span>(root, full);
      <span class="hljs-keyword">if</span> (ig.<span class="hljs-title function_">has</span>(d.<span class="hljs-property">name</span>) || ig.<span class="hljs-title function_">has</span>(rel)) <span class="hljs-keyword">continue</span>;
      <span class="hljs-keyword">if</span> (d.<span class="hljs-title function_">isDirectory</span>()) {
        count += <span class="hljs-keyword">await</span> <span class="hljs-title function_">walk</span>(full);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (d.<span class="hljs-title function_">isFile</span>()) {
        <span class="hljs-keyword">if</span> (!visited.<span class="hljs-title function_">has</span>(full)) {
          visited.<span class="hljs-title function_">add</span>(full);
          count += <span class="hljs-number">1</span>;
        }
      }
    }
    <span class="hljs-keyword">return</span> count;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">walk</span>(root);
}
</code></pre>
<h2 data-id="heading-7">四、实现 MCP Server（Stdio）</h2>
<p>传输协议概览：</p>
<ul>
<li><code>stdio</code>：通过进程的标准输入/输出传输结构化消息，适合本地或被其他进程托管的场景，零网络依赖。</li>
<li><code>SSE</code>：基于 HTTP 的 <code>text/event-stream</code> 单向服务器推送通道，客户端建立长连接，服务端持续按事件流推送消息，适合跨网络的实时输出与状态变更。</li>
<li><code>Streamable HTTP</code>：用标准 HTTP 请求/响应承载 MCP 消息，响应体支持分块/增量输出（非 SSE 帧），保持 REST 语义与中间件兼容，适合网关与服务化部署。</li>
</ul>
<p>StdioServerTransport 能力：</p>
<ul>
<li>封装 <code>process.stdin</code>/<code>process.stdout</code> 为消息通道，负责读取、解析与写回协议消息。</li>
<li>管理连接的生命周期与错误处理，确保消息循环稳定运行。</li>
<li>与 <code>Server.connect(transport)</code> 协作完成握手、工具注册与调用路由。对业务代码暴露的主要用法是构造并传入 <code>connect</code>，其余由 SDK 管理。</li>
</ul>
<p>代码说明：</p>
<ul>
<li>定义 <code>Server</code> 元信息与能力声明，用于握手阶段告知客户端可用能力。</li>
<li>通过 <code>server.addTool</code> 注册工具，包括名字、描述和输入参数描述，以及实现 <code>execute</code>。</li>
<li>创建 <code>StdioServerTransport</code> 并 <code>server.connect(transport)</code>，启动基于 <code>stdio</code> 的消息循环。</li>
</ul>
<p>新建 <code>src/server.ts</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">"node:path"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Server</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@modelcontextprotocol/sdk/server/index.js"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StdioServerTransport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@modelcontextprotocol/sdk/server/stdio.js"</span>;
<span class="hljs-keyword">import</span> { countFiles } <span class="hljs-keyword">from</span> <span class="hljs-string">"./tools/fileCount.js"</span>;

<span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Server</span>(
  { <span class="hljs-attr">name</span>: <span class="hljs-string">"mcp-file-counter"</span>, <span class="hljs-attr">version</span>: <span class="hljs-string">"0.1.0"</span> },
  { <span class="hljs-attr">capabilities</span>: { <span class="hljs-attr">tools</span>: {} } }
);

server.<span class="hljs-title function_">addTool</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">"count_files"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"Count files under a directory"</span>,
  <span class="hljs-attr">inputSchema</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>,
    <span class="hljs-attr">properties</span>: {
      <span class="hljs-attr">path</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>, <span class="hljs-attr">default</span>: <span class="hljs-string">"."</span> },
      <span class="hljs-attr">ignore</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">"array"</span>,
        <span class="hljs-attr">items</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span> },
        <span class="hljs-attr">default</span>: [<span class="hljs-string">"node_modules"</span>, <span class="hljs-string">".git"</span>, <span class="hljs-string">"dist"</span>]
      }
    }
  },
  <span class="hljs-attr">execute</span>: <span class="hljs-keyword">async</span> (args) =&gt; {
    <span class="hljs-keyword">const</span> rootArg = <span class="hljs-keyword">typeof</span> args.<span class="hljs-property">path</span> === <span class="hljs-string">"string"</span> ? args.<span class="hljs-property">path</span> : <span class="hljs-string">"."</span>;
    <span class="hljs-keyword">const</span> ignoreArg = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(args.<span class="hljs-property">ignore</span>) ? args.<span class="hljs-property">ignore</span> : [<span class="hljs-string">"node_modules"</span>, <span class="hljs-string">".git"</span>, <span class="hljs-string">"dist"</span>];
    <span class="hljs-keyword">const</span> root = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), rootArg);
    <span class="hljs-keyword">const</span> total = <span class="hljs-keyword">await</span> <span class="hljs-title function_">countFiles</span>(root, ignoreArg);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">content</span>: [{ <span class="hljs-attr">type</span>: <span class="hljs-string">"text"</span>, <span class="hljs-attr">text</span>: <span class="hljs-title class_">String</span>(total) }] };
  }
});

<span class="hljs-keyword">const</span> transport = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StdioServerTransport</span>();
<span class="hljs-keyword">await</span> server.<span class="hljs-title function_">connect</span>(transport);
</code></pre>
<p>这个<code>execute</code> 可以理解为最终重新启动了个进程，提供服务，比如</p>
<pre><code class="hljs language-ini" lang="ini">node server.js <span class="hljs-attr">--path</span>=/my/path
</code></pre>
<p>这样，<code>execute</code>函数内部就能获取到命令行参数<code>path</code>（即<code>args.path</code>）</p>
<p>MCP是提供给Agent使用的，Agent会根据名称和描述去调用这个工具（命令），并传入合适的参数。</p>
<h2 data-id="heading-8">五、配置脚本和使用inspector调试MCP</h2>
<p>在 <code>package.json</code> 中加入关键配置与脚本：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"module"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"engines"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"&gt;=18"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"packageManager"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm@9"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsx src/server.ts"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsc -p tsconfig.json"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node dist/server.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"inspect:dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mcp-inspector tsx \"tsx src/server.ts\""</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"inspect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mcp-inspector node dist/server.js"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>Inspector 原理：</p>
<ul>
<li><code>mcp-inspector</code> 充当 MCP 客户端与可视化 UI，会启动你提供的命令（如 <code>tsx src/server.ts</code>），并通过 <code>stdio</code> 与服务端交换协议消息。</li>
<li>启动后完成握手（识别服务名与能力），拉取工具列表，渲染交互界面；当你在 UI 中调用某个工具时，它将请求参数序列化为协议消息发送给服务，随后展示返回的内容。</li>
<li>这种方式不依赖网络，便于本地开发与调试；若换成 <code>SSE</code> 或 <code>Streamable HTTP</code> 等传输，Inspector 则通过对应通道进行连接。</li>
</ul>
<p>运行示例：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开发态直接运行（Stdio）</span>
nr dev

<span class="hljs-comment"># 构建并启动（Node 执行 dist）</span>
nr build
nr start

<span class="hljs-comment"># 使用 Inspector 调试（开发态）</span>
nr inspect:dev

<span class="hljs-comment"># 使用 Inspector 调试（构建后）</span>
nr build &amp;&amp; nr inspect
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45f9c1ace71044078aa0ae4ea65e8827~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764680548&amp;x-signature=V6jDpuLPjCJOPgryHr0Isx0nqEk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7bed537790e46ecbb790485e4b25d47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764680548&amp;x-signature=pG5q%2BmqUSG6PNRwHOzLbSjoSkXQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7002f20caba5463fafc6a8f74c0bbe6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764680548&amp;x-signature=IJzRS3qg7f2NTKT5IvU%2FV3nZMXQ%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为防在家摸鱼，用计网知识实践屏蔽B站！]]></title>    <link>https://juejin.cn/post/7576459005390749739</link>    <guid>https://juejin.cn/post/7576459005390749739</guid>    <pubDate>2025-11-25T14:56:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576459005390749739" data-draft-id="7576477434733838342" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为防在家摸鱼，用计网知识实践屏蔽B站！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-25T14:56:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="川白"/> <meta itemprop="url" content="https://juejin.cn/user/2262116051191900"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为防在家摸鱼，用计网知识实践屏蔽B站！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2262116051191900/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    川白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T14:56:37.000Z" title="Tue Nov 25 2025 14:56:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为防在家摸鱼，用计网知识实践屏蔽B站！</h2>
<p>大家好，在家的环境实在太舒适，我总是忍不住刷B站摸鱼，所以决定利用学过的计算机网络知识把B站屏蔽掉。今天尝试了一下，成功实现了，现在给大家分享具体做法。</p>
<h3 data-id="heading-1">修改系统hosts文件（系统级屏蔽，适用性广）</h3>
<p>这是一种常用的系统级屏蔽方式，能使主机上所有浏览器和网络程序都无法访问目标网址，操作步骤如下：</p>
<ol>
<li><strong>Windows系统</strong>：首先找到hosts文件，其路径为<code>C:\Windows\System32\drivers\etc\hosts</code> 。右键点击记事本，选择“以管理员身份运行”，通过记事本的“文件 - 打开”功能找到并打开该hosts文件。在文件末尾添加<code>127.0.0.1 目标网址</code> ，比如<code>127.0.0.1 www.bilibili.com</code> 。保存文件后，打开命令提示符，输入<code>ipconfig /flushdns</code>刷新DNS缓存即可完成屏蔽。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3be229c9b8ed4d6dab70f7cf0bf62e23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bed55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764687396&amp;x-signature=I46TlFg612c5WjBxayIr2UebCvE%3D" alt="image.png" loading="lazy"/></p>
<p>不过，配置或格式出现错误会导致系统忽略规则，这是常见问题。需要重新以管理员身份打开hosts文件，仔细检查内容：</p>
<ul>
<li>需同时添加IPv4和IPv6的屏蔽规则，避免系统优先使用IPv6绕过屏蔽。正确内容如下：</li>
</ul>
<pre><code class="hljs language-plaintext" lang="plaintext">127.0.0.1 www.bilibili.com
127.0.0.1 bilibili.com
::1 www.bilibili.com
::1 bilibili.com
</code></pre>
<ul>
<li>保存时注意选择“文件 - 另存为”，且文件名只能是“hosts”，不能带有任何后缀，比如不能保存为hosts.txt 。</li>
</ul>
<p>通过上述操作，就能成功屏蔽B站，防止自己在家摸鱼了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb99cb3a7d0e408ca76732d42fc50656~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bed55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764687396&amp;x-signature=e%2FFMMJzR3YckbiDqLPGubR%2FrgZ8%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[上下文管理策略综述]]></title>    <link>https://juejin.cn/post/7576518316135940147</link>    <guid>https://juejin.cn/post/7576518316135940147</guid>    <pubDate>2025-11-26T00:07:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576518316135940147" data-draft-id="7576537005133119515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="上下文管理策略综述"/> <meta itemprop="keywords" content="人工智能,LLM"/> <meta itemprop="datePublished" content="2025-11-26T00:07:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Baihai_IDP"/> <meta itemprop="url" content="https://juejin.cn/user/3123071228582343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            上下文管理策略综述
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3123071228582343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Baihai_IDP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T00:07:13.000Z" title="Wed Nov 26 2025 00:07:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>编者按：</strong> LLM 的上下文窗口一直在不断扩大，我们现在是否能“将一切内容塞进上下文”，却依然得到高质量的模型输出？</p>
<p>我们今天为大家带来的这篇文章，作者的核心观点是：上下文不是免费的，信息必须被主动管理，否则“Garbage in, garbage out”的老问题将以更隐蔽的方式重现。</p>
<p>文章系统剖析了长上下文常见的四大失效模式——上下文污染、干扰、混淆与冲突，并提出了六种行之有效的上下文管理策略：RAG（检索增强生成）、工具选配、上下文隔离、修剪、摘要与卸载。这些方法不仅有助于提升模型输出质量，还能显著降低能耗、加快响应速度，尤其在边缘设备或复杂智能体系统中价值突出。作者还结合 Anthropic、DeepSeek、Gemini 的实践经验分享，展示了如何在真实场景中拆解任务、隔离线程、动态筛选工具，从而让大模型“轻装上阵、精准发力”。</p>
</blockquote>
<p><strong>作者 | Drew Breunig</strong></p>
<p><strong>编译 | 岳扬</strong></p>
<h2 data-id="heading-0"><strong>01 缓解与避免上下文失效问题</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e58d0e1ed47e472e93d349311e6b33d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764720433&amp;x-signature=kInzkMMSXRwA9sspw3GnhXRFv8g%3D" alt="image.png" loading="lazy"/></p>
<p>早前发布我们发布过《How Long Contexts Fail》[1]，本文我们再来系统探讨能够减轻或完全避免这些失效问题的解决方案。</p>
<p>但在开始之前，先简要回顾一下长上下文可能失效的几种方式：</p>
<ul>
<li><strong>上下文污染（Context Poisoning）</strong> ：当幻觉信息或其他错误内容混入上下文并被持续引用时发生</li>
<li><strong>上下文干扰（Context Distraction）</strong> ：因上下文过长导致模型过度关注当前文本，而忽略了训练阶段习得的知识</li>
<li><strong>上下文混淆（Context Confusion）</strong> ：模型使用上下文中存在的冗余信息生成低质量响应</li>
<li><strong>上下文冲突（Context Clash）</strong> ：当新增的上下文信息及工具与提示词中既有内容产生矛盾时触发</li>
</ul>
<p>以上所有问题，归根结底都是信息管理的问题。上下文中的每一条信息都会影响最终的回答。这又回到了那句古老的编程格言：“垃圾进，垃圾出（Garbage in, garbage out）。”[2]</p>
<p>幸运的是，针对上述问题，我们有大量可行的应对方案。</p>
<p><strong>上下文管理策略</strong></p>
<ul>
<li>RAG：选择性地添加相关信息，助力大语言模型生成更优的回答</li>
<li>工具选配（Tool Loadout）：仅选择相关的工具定义加入上下文</li>
<li>上下文隔离（Context Quarantine）：在各独立线程中隔离不同上下文</li>
<li>上下文修剪（Context Pruning）：从上下文中移除无关的或不必要的信息</li>
<li>上下文摘要（Context Summarization）：将累积的上下文提炼为简明的摘要信息</li>
<li>上下文卸载（Context Offloading）：将信息存储在大语言模型上下文之外，通常通过一个负责存储和管理数据的工具实现</li>
</ul>
<h2 data-id="heading-1"><strong>02 RAG</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0b65a3f983a483584e7247d6b4438c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764720433&amp;x-signature=9d5yQ4DntUviqu5sZw58TWTS0%2BE%3D" alt="image.png" loading="lazy"/></p>
<p>检索增强生成（Retrieval-Augmented Generation，RAG）是指选择性地添加相关信息，来助力大语言模型生成更优的回答。</p>
<p>关于 RAG 的讨论早已汗牛充栋，今天我们不会深入展开，只想强调一点：<strong>它依然非常有效</strong>。</p>
<p>每当模型将上下文窗口的上限再度拉高，就会有人掀起新一轮“RAG 已死”的论战。上次引发大规模讨论是 Llama 4 Scout 发布，带来了 1000 万 token 的上下文窗口。面对如此庞大的容量，人们很容易产生“干脆把所有内容都塞进去，这多省事”的想法。</p>
<p>但正如我们之前的文章[1]所讲：如果你把上下文当成一个杂物抽屉，那这些杂物就会直接影响你的输出结果。若您想深入了解，这里有一门新课程[3]值得推荐。</p>
<h2 data-id="heading-2"><strong>03 工具选配（Tool Loadout）</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffd8432b140049baa869ccce95092ffe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764720433&amp;x-signature=3h7An13kwd%2BklVktzUFx6k2gAhI%3D" alt="image.png" loading="lazy"/></p>
<p>工具选配是指仅选择与当前任务相关的工具定义加入上下文。</p>
<p>“选配”（loadout）原为游戏术语，指在关卡/对战/回合开始前对技能、武器与装备进行的特定组合配置。通常需要根据角色特性、关卡难度、团队构成及个人操作习惯进行针对性调整。</p>
<p>在此我们借用该术语，来描述为特定任务筛选最适用工具的过程。</p>
<p>最简单的工具筛选方式莫过于对工具描述实施 RAG 检索。这正是 Tiantian Gan 与 Qiyao Sun 在论文《RAG MCP》[4]中采用的方法 —— 通过将工具描述存储于向量数据库，实现根据输入提示词精准匹配最相关工具。</p>
<p><strong>DeepSeek-v3 团队发现，当工具数量超过 30 个时，精准选配就变得至关重要。超过这个阈值，工具描述会出现重叠混淆；超过 100 个时，模型在测试中几乎必然失败。</strong> 而采用 RAG 技术将工具筛选至 30 个以内，不仅能大幅缩短提示词长度，更能将工具选择准确率提升高达 3 倍。</p>
<p>对于小型模型而言，问题在工具数远未达 30 时便会显现。我们在上一篇文章中提到的论文《Less is More》[5]就指出：Llama 3.1 8B 在提供 46 个工具时无法通过基准测试，但当工具数量减少到 19 个时却能成功。问题根源在于上下文混淆，而非上下文窗口的容量限制。</p>
<p>为解决这一问题，《Less is More》团队开发了一种动态工具选择机制：利用一个由大语言模型驱动的工具推荐器。该模型会先推理“它认为回答用户查询所需工具的数量和类型”，然后通过语义搜索（即再次使用工具 RAG）确定最终的工具配置。他们在 Berkeley Function Calling Leaderboard[6] 上测试了该方法，发现 Llama 3.1 8B 的性能提升了 44%。</p>
<p>该研究还指出精简上下文的两大额外优势：更低的功耗和更快的响应速度 —— 这在边缘计算场景（即在手机或 PC 端而非专业服务器上运行大模型）中尤为关键。即使动态选配未能提升模型效果，其带来的能效与响应速度收益也值得投入：分别实现了 18% 的能耗节省和 77% 的速度提升。</p>
<p>幸运的是，大多数智能体（agent）的应用场景较为聚焦，通常只需少量人工精心挑选的工具。但若需扩展功能范围或集成规模，请务必重视工具选配策略。</p>
<h2 data-id="heading-3"><strong>04 上下文隔离（Context Quarantine）</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/830b9409dc9141d89a3897d309c27904~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764720433&amp;x-signature=xivL1oku%2BrZfwhaTKdW8w0jce7I%3D" alt="image.png" loading="lazy"/></p>
<p>上下文隔离是指将上下文分别置于各自独立的线程中，每个线程由一个或多个大语言模型单独使用。</p>
<p><strong>当上下文长度适中且不含无关内容时，我们通常能获得更好的结果。实现这一点的方法之一，是将任务拆解为多个更小、彼此隔离的子任务 —— 每个子任务拥有自己专属的上下文。</strong></p>
<p>这种策略有许多应用实例[7-8]，其中一篇通俗易懂的说明来自 Anthropic 的博客文章[9]，详细介绍了他们的多智能体研究系统。文中写道：</p>
<blockquote>
<p>搜索的本质是压缩：从海量语料中提炼关键洞见。子智能体通过并行运作，各自使用独立的上下文窗口同时探索问题的不同维度，最终将最重要的信息压缩后传递给主研究智能体。每个子智能体还实现了关注点分离 —— 各自配备不同的工具、提示词和探索路径 —— 从而减少路径依赖，支持更彻底、更独立的研究。 </p>
</blockquote>
<p>这类设计模式特别适用于研究类任务。面对一个复杂问题时，可以将其拆解为若干子问题或探索方向，并分别交由多个智能体处理。这不仅能加速信息的收集与提炼（前提是具备足够的计算资源），还能避免单个上下文积累过多或不相关的信息，从而提升输出质量：</p>
<blockquote>
<p>我们的内部评估表明，多智能体研究系统在“广度优先型”查询中表现尤为突出 —— 这类查询需要同时推进多个独立的研究方向。我们发现，以 Claude Opus 4 为主智能体、Claude Sonnet 4 为子智能体的多智能体系统，在内部研究评估中比单智能体的 Claude Opus 4 性能提升 90.2%。例如，在要求列出标普 500 信息技术板块所有公司的董事会成员时，多智能体系统通过任务分解交由子智能体并行处理，成功找到正确答案；而单智能体系统则因缓慢、串行的搜索未能完成任务。 </p>
</blockquote>
<p>这种方法也有助于优化工具选配（tool loadout）：智能体设计者可以创建多种智能体原型，每种都配备专属的工具组合及使用说明。</p>
<p><strong>对智能体开发者而言，关键挑战在于识别出哪些任务可以拆解并分配到独立线程中执行。</strong> <strong>那些需要多个智能体频繁共享上下文的问题，并不太适合采用此策略。</strong></p>
<p>若您的智能体应用场景适合并行处理，强烈推荐阅读 Anthropic 的完整文章[9]，其内容极为精彩。</p>
<h2 data-id="heading-4"><strong>05 上下文修剪（Context Pruning）</strong></h2>
<p>上下文修剪是指从上下文中移除无关的或冗余的信息。</p>
<p>智能体在调用工具和整合文档的过程中会不断积累上下文。有时，需要暂停操作，评估已收集的内容并清除冗余信息。你可以将这项任务交给主大语言模型处理，也可以专门设计一个由大语言模型驱动的工具来审查并编辑上下文，或选择更专业的修剪方案。</p>
<p>上下文修剪在自然语言处理（NLP）领域其实已有（相对）较长的历史 —— 在 ChatGPT 出现之前，上下文长度曾是一个更为棘手的瓶颈。在此基础上，当前一种实用的修剪方法是 Provence[10]，这是一个“面向问答场景的高效稳健上下文修剪器”。</p>
<p>Provence 速度快、准确率高、使用简单，且体积相对小巧 —— 仅 1.75 GB。你只需几行代码即可调用它，例如：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92cf35bf5b284f0fb4d98de280a766fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764720433&amp;x-signature=TNlAzWvW19kcM4J4qBWw7NWW8p8%3D" alt="image.png" loading="lazy"/></p>
<p>Provence 对文章进行精简处理，删减 95% 的内容后仅保留相关核心段落[11]，效果令人惊叹。 </p>
<p>你可以使用 Provence 或类似功能来裁剪单个文档，甚至整个上下文。此外，这种做法也有力地支持了以下设计模式：将上下文以结构化的形式（例如字典或其他数据结构）进行维护，并在每次调用大语言模型前动态拼接成最终的字符串。这种结构在进行修剪时尤为有用，既能确保核心指令与目标完整保留，又允许对文档或历史记录段进行删减或摘要处理。</p>
<h2 data-id="heading-5"><strong>06 上下文摘要（Context Summarization）</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc89838e3d9c4b6cb138d83e679ad2b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764720433&amp;x-signature=GPOKUWgYXdIsL9JYP1HnzLLvoPI%3D" alt="image.png" loading="lazy"/></p>
<p>上下文摘要是将累积的上下文提炼为简洁摘要的过程。</p>
<p>上下文摘要最初是为应对有限上下文窗口而引入的一种手段。当聊天会话即将超出最大上下文长度时，系统会生成一份摘要，并开启一个新线程。用户在 ChatGPT 或 Claude 等聊天机器人中可以手动执行这一操作：要求模型生成简短摘要，然后将该摘要粘贴到新会话中。</p>
<p>然而，随着上下文窗口不断扩展，智能体开发者发现，摘要的价值已不仅限于避免超出上下文容量限制。<strong>随着上下文的增长，模型容易分心，更少依赖其在训练中学到的知识 —— 我们称之为“上下文分心”（Context Distraction）。</strong> 开发《宝可梦》游戏智能体的 Gemini 团队发现，一旦上下文超过 10 万个 token，就会触发这一现象：</p>
<blockquote>
<p>尽管 Gemini 2.5 Pro 支持超百万 token 的上下文，但在智能体场景中有效利用如此长的上下文仍是一个新兴研究领域。在该智能体场景中，当上下文大幅超过 10 万 token 时，智能体倾向于重复其操作历史中的已有动作，不再灵活思考、主动规划。尽管这一现象尚属个案，但却揭示了这样一个现象：用于检索任务的长上下文，与用于多步生成式推理的长上下文，有着根本不同的要求和挑战。 </p>
</blockquote>
<p>对上下文进行摘要操作本身并不难，但为特定智能体实现精准摘要却充满挑战性。<strong>开发者必须明确哪些信息需要保留，并将这一要求清晰传达给执行压缩的大语言模型。</strong> 因此，值得将此功能单独拆解为一个由大语言模型驱动的处理阶段或独立应用 —— 这样便于收集评估数据，从而直接指导并优化该任务的执行效果。</p>
<h2 data-id="heading-6"><strong>07 上下文卸载（Context Offloading）</strong></h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47784e82a20e486988ae5b7b9cbb9261~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764720433&amp;x-signature=LqM9L4a6hz4t8khgbkDuUEYvL1c%3D" alt="image.png" loading="lazy"/></p>
<p>上下文卸载是指将信息存储在大语言模型上下文之外的技术，通常通过专门的数据存储管理工具实现。</p>
<p>这可能是我最钟爱的策略 —— 简单到令人怀疑它是否真的有效。</p>
<p>Anthropic 曾专门撰文介绍这一技巧[12]，文中详细说明了他们的 “think” 工具，本质上就是一块草稿板：</p>
<p>借助“think”工具，我们让 Claude 在给出最终答案前，额外增加一个思考步骤，并为其划出独立空间……在需要连续调用工具或与用户进行长对话时，这一点尤为实用。</p>
<p>我很欣赏 Anthropic 发布的研究成果，但对此工具的命名持保留意见。倘若它叫“scratchpad（草稿板）”，功能一目了然：给模型一个记笔记的地方，既不污染上下文，又可供后续查阅。而“think”一词容易与“extended thinking”[13]混淆，还无端把模型拟人化……扯远了。</p>
<p>有一块能记录进度与笔记要点的地方，确实行之有效。Anthropic 研究表明，将 “think” 工具与领域专属提示词（这本就是智能体的标准配置）结合使用，能在专业智能体基准测试中实现高达 54% 的性能提升。</p>
<p>Anthropic 总结了<strong>上下文卸载模式适用的三大场景</strong>：</p>
<ol>
<li>当 Claude 需要仔细分析前期工具的执行结果，并可能因此调整后续行动路径时。</li>
<li>在需要严格遵守复杂规则体系，并确保每一步操作都符合规定的情境下。</li>
<li>在环环相扣的任务中，每一个后续步骤都依赖于前一步的正确结果，且任何失误都会导致付出高昂代价。</li>
</ol>
<p>上下文管理往往是打造智能体时最棘手的环节。正如 Karpathy 所说，设计者得“恰到好处地填充上下文窗口[14]”，巧妙地调度多种工具与各种信息，还要定期做上下文清理。</p>
<p>贯穿所有上述策略的关键洞察在于：<strong>context is not free，不能随意、无节制地向上下文里填充信息。上下文中的每一个 token，无论相关与否、正确与否，都在左右模型的行为。</strong> 现代大语言模型提供的超大上下文窗口固然是一种强大的能力，但这绝不能成为我们疏于信息管理的借口。</p>
<p>下次构建或优化智能体时，不妨问问自己：<strong>当前上下文里的每一条信息，真的都在“干活”吗？</strong> 如果有些内容只是占位置、没贡献，那你就该用前面提到的六种方法，把它们清理掉或挪出去。</p>
<p><strong>END</strong></p>
<p><strong>本期互动内容 🍻</strong></p>
<p><strong>❓在你的项目里，是否曾因上下文管理不当（如信息污染、工具混淆）而踩过“坑”？您最终是如何发现并解决这个问题的？</strong></p>
<p><strong>文中链接</strong></p>
<p>[1]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dbreunig.com%2F2025%2F06%2F22%2Fhow-contexts-fail-and-how-to-fix-them.html" target="_blank" title="https://www.dbreunig.com/2025/06/22/how-contexts-fail-and-how-to-fix-them.html" ref="nofollow noopener noreferrer">www.dbreunig.com/2025/06/22/…</a></p>
<p>[2]<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FGarbage_in%2C_garbage_out" target="_blank" title="https://en.wikipedia.org/wiki/Garbage_in,_garbage_out" ref="nofollow noopener noreferrer">en.wikipedia.org/wiki/Garbag…</a></p>
<p>[3]<a href="https://link.juejin.cn?target=https%3A%2F%2Fmaven.com%2Fp%2F569540%2Fi-don-t-use-rag-i-just-retrieve-documents" target="_blank" title="https://maven.com/p/569540/i-don-t-use-rag-i-just-retrieve-documents" ref="nofollow noopener noreferrer">maven.com/p/569540/i-…</a></p>
<p>[4]<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2505.03275" target="_blank" title="https://arxiv.org/abs/2505.03275" ref="nofollow noopener noreferrer">arxiv.org/abs/2505.03…</a></p>
<p>[5]<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2411.15399" target="_blank" title="https://arxiv.org/abs/2411.15399" ref="nofollow noopener noreferrer">arxiv.org/abs/2411.15…</a></p>
<p>[6]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgorilla.cs.berkeley.edu%2Fleaderboard.html" target="_blank" title="https://gorilla.cs.berkeley.edu/leaderboard.html" ref="nofollow noopener noreferrer">gorilla.cs.berkeley.edu/leaderboard…</a></p>
<p>[7]<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2402.14207" target="_blank" title="https://arxiv.org/abs/2402.14207" ref="nofollow noopener noreferrer">arxiv.org/abs/2402.14…</a></p>
<p>[8]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.microsoft.com%2Fen-us%2Fresearch%2Farticles%2Fmagentic-one-a-generalist-multi-agent-system-for-solving-complex-tasks%2F" target="_blank" title="https://www.microsoft.com/en-us/research/articles/magentic-one-a-generalist-multi-agent-system-for-solving-complex-tasks/" ref="nofollow noopener noreferrer">www.microsoft.com/en-us/resea…</a></p>
<p>[9]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fbuilt-multi-agent-research-system" target="_blank" title="https://www.anthropic.com/engineering/built-multi-agent-research-system" ref="nofollow noopener noreferrer">www.anthropic.com/engineering…</a></p>
<p>[10]<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2501.16214" target="_blank" title="https://arxiv.org/abs/2501.16214" ref="nofollow noopener noreferrer">arxiv.org/abs/2501.16…</a></p>
<p>[11]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgist.github.com%2Fdbreunig%2Fb3bdd9eb34bc264574954b2b954ebe83" target="_blank" title="https://gist.github.com/dbreunig/b3bdd9eb34bc264574954b2b954ebe83" ref="nofollow noopener noreferrer">gist.github.com/dbreunig/b3…</a></p>
<p>[12]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fclaude-think-tool" target="_blank" title="https://www.anthropic.com/engineering/claude-think-tool" ref="nofollow noopener noreferrer">www.anthropic.com/engineering…</a></p>
<p>[13]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fvisible-extended-thinking" target="_blank" title="https://www.anthropic.com/news/visible-extended-thinking" ref="nofollow noopener noreferrer">www.anthropic.com/news/visibl…</a></p>
<p>[14]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fkarpathy%2Fstatus%2F1937902205765607626" target="_blank" title="https://x.com/karpathy/status/1937902205765607626" ref="nofollow noopener noreferrer">x.com/karpathy/st…</a></p>
<p><strong>原文链接：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dbreunig.com%2F2025%2F06%2F26%2Fhow-to-fix-your-context.html" target="_blank" title="https://www.dbreunig.com/2025/06/26/how-to-fix-your-context.html" ref="nofollow noopener noreferrer">www.dbreunig.com/2025/06/26/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习 LiteLLM 的路由和回退策略]]></title>    <link>https://juejin.cn/post/7576532425761669135</link>    <guid>https://juejin.cn/post/7576532425761669135</guid>    <pubDate>2025-11-26T00:08:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576532425761669135" data-draft-id="7576477793778335784" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习 LiteLLM 的路由和回退策略"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-26T00:08:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="日习一技"/> <meta itemprop="url" content="https://juejin.cn/user/3913917125896190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习 LiteLLM 的路由和回退策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917125896190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    日习一技
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T00:08:08.000Z" title="Wed Nov 26 2025 00:08:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在之前的系列文章中，我们学习了 LiteLLM 的基础使用，包括模型管理、用户管理、权限认证和访问控制机制等。当我们的 LLM 网关要承载越来越多的流量、接入越来越多的模型供应商时，就会面临新的挑战：某个模型供应商的 API 突然出现故障、请求量激增导致速率限制、某些模型的响应时间过长、成本控制需要在多个供应商之间进行优化选择等等。这些问题如果处理不当，会严重影响用户体验，甚至导致业务中断。</p>
<p>为此 LiteLLM 提供了一套完整的智能路由和容错解决方案，它通过智能的负载均衡、自动容错和多层次的回退策略，确保在复杂的多模型环境中提供稳定可靠的服务。今天这篇文章，我们就来深入学习 LiteLLM 的路由和回退策略，了解它是如何帮助我们构建一个高可用、高性能、低成本的 LLM 网关。</p>
<h2 data-id="heading-0">负载均衡</h2>
<p>让我们从最简单的场景开始：假设你有一个 <code>gpt-4o</code> 模型，但是在不同的地区部署了多个实例（可能是 Azure 的不同区域，也可能是不同的云厂商），如何在这些实例之间分配请求？</p>
<p>LiteLLM 的路由配置非常简洁，只需要在 <code>model_list</code> 中将多个 <code>model_name</code> 配置成相同的名字即可：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">model_list:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">azure/gpt-4o</span>
      <span class="hljs-attr">api_base:</span> <span class="hljs-string">https://my-endpoint-us.openai.azure.com/</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/AZURE_API_KEY</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">azure/gpt-4o</span>
      <span class="hljs-attr">api_base:</span> <span class="hljs-string">https://my-endpoint-eu.openai.azure.com/</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/AZURE_API_KEY</span>
      <span class="hljs-attr">api_version:</span> <span class="hljs-string">os.environ/AZURE_API_VERSION</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">gpt-4o</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>
</code></pre>
<p>在这个配置中，三个不同的部署都映射到同一个模型名称 <code>gpt-4o</code>，它们被称为 <strong>模型组（Model Group）</strong>，当用户请求 <code>model="gpt-4o"</code> 时，LiteLLM 会自动在模型组中的部署之间分配请求。</p>
<h3 data-id="heading-1">路由策略</h3>
<p>LiteLLM 提供了多种不同的路由策略，每种策略针对不同的使用场景：</p>
<ul>
<li><strong>简单随机策略（<code>simple-shuffle</code>）</strong>：这是默认的路由策略，采用随机选择算法，确保请求在所有可用部署间均匀分布；其优点是实现简单，负载均匀，适用于大多数通用场景；</li>
<li><strong>最少忙碌策略（<code>least-busy</code>）</strong>：开启该策略后，LiteLLM 会实时监控每个部署的活跃请求数，优先选择当前活跃请求数最少的部署；其优点是动态负载均衡，避免热点，适用于高并发场景；</li>
<li><strong>延迟优化策略（<code>latency-based-routing</code>）</strong>：基于历史延迟数据，优先选择响应时间最短的部署，开启后 LiteLLM 会维护每个部署的延迟历史，并使用滑动窗口计算平均值；这种策略能优化用户体验，减少等待时间，适用于对延迟敏感的交互式应用；</li>
<li><strong>成本优化策略（<code>cost-based-routing</code>）</strong>：基于模型定价信息，优先选择成本最低的部署；它的优点是控制成本，优化预算使用，适用于成本敏感的批量处理场景；</li>
<li><strong>使用率均衡策略（<code>usage-based-routing</code>）</strong>：也被称为 <strong>Rate Limit Aware</strong> 策略，基于 RPM/TPM 使用率选择负载最低的部署，确保各部署的负载均衡；这种策略充分利用所有部署的配额，适用于需要精确控制流量分配的场景；不过这种策略会对性能产生影响，因为它要频繁操作 Redis 来跟踪不同部署的使用情况，从而导致延迟显著增加，不建议用于生产环境；</li>
</ul>
<blockquote>
<p>关于使用率策略还有一个 v2 版本（<code>usage-based-routing-v2</code>），它将所有 Redis 操作改为异步，有一定的性能提升。</p>
</blockquote>
<h3 data-id="heading-2">简单随机策略</h3>
<p>在高流量场景中，为了获得最佳性能，官方建议使用简单随机（<code>simple-shuffle</code>）策略，这也是 LiteLLM 的默认路由策略，它随机选择部署，性能开销最小。在 LiteLLM Proxy 中配置路由策略如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">router_settings:</span>
  <span class="hljs-attr">routing_strategy:</span> <span class="hljs-string">"simple-shuffle"</span>
</code></pre>
<p>或者在 SDK 中通过 <code>Router</code> 使用：</p>
<pre><code class="hljs language-python" lang="python">router = Router(
  model_list=model_list,
  routing_strategy=<span class="hljs-string">"simple-shuffle"</span>
)
</code></pre>
<p>此外，简单随机策略根据配置，又分为 <strong>基于 RPM 随机（RPM-based shuffling）</strong> 和 <strong>基于权重随机（Weight-based shuffling）</strong> 两种。下面是基于权重随机的示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">model_list:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">azure/gpt-4o</span>
      <span class="hljs-attr">api_base:</span> <span class="hljs-string">https://my-endpoint-us.openai.azure.com/</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/AZURE_API_KEY</span>
      <span class="hljs-attr">weight:</span> <span class="hljs-number">9</span>  <span class="hljs-comment"># 90% 的概率被选中</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">azure/gpt-4o</span>
      <span class="hljs-attr">api_base:</span> <span class="hljs-string">https://my-endpoint-eu.openai.azure.com/</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/AZURE_API_KEY</span>
      <span class="hljs-attr">api_version:</span> <span class="hljs-string">os.environ/AZURE_API_VERSION</span>
      <span class="hljs-attr">weight:</span> <span class="hljs-number">1</span>  <span class="hljs-comment"># 10% 的概率被选中</span>
</code></pre>
<h3 data-id="heading-3">跨实例的负载均衡</h3>
<p>在生产环境中，LiteLLM Proxy 通常会部署多个实例。但多实例部署会带来一个问题：不同实例之间无法直接通信，它们无法协调已使用的 RPM/TPM。</p>
<p>例如，假设 OpenAI 限制我们每分钟 1000 个请求，而我们有 3 个 LiteLLM 实例：</p>
<pre><code class="hljs language-css" lang="css">实例 <span class="hljs-selector-tag">A</span>：已用 <span class="hljs-number">400</span> 个请求
实例 <span class="hljs-selector-tag">B</span>：已用 <span class="hljs-number">300</span> 个请求
实例 C：已用 <span class="hljs-number">300</span> 个请求
总计：<span class="hljs-number">1000</span> 个请求
</code></pre>
<p>如果没有跨实例的协调，每个实例可能还会继续发送请求，导致全局超过限制。</p>
<p>为了解决这个问题，LiteLLM 提供了 <strong>Redis 支持</strong>，可以将 RPM/TPM 数据存储在共享的 Redis 中：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">router_settings:</span>
  <span class="hljs-attr">redis_host:</span> <span class="hljs-string">redis.default.svc.cluster.local</span>
  <span class="hljs-attr">redis_port:</span> <span class="hljs-number">6379</span>
  <span class="hljs-attr">redis_db:</span> <span class="hljs-number">0</span>
</code></pre>
<p>启用 Redis 后，所有实例都会定期同步它们的 RPM/TPM 数据到 Redis，从而实现全局的限流和负载均衡。</p>
<h2 data-id="heading-4">高级路由策略</h2>
<p>除了基础的负载均衡，LiteLLM 还提供了多种智能化路由策略，能够根据内容、预算、标签等维度进行智能路由。</p>
<h3 data-id="heading-5">自动路由</h3>
<p><strong>自动路由（Auto Routing）</strong> 也被称为 <strong>语义路由 (Semantic Routing)</strong>，能够根据请求内容自动选择最适合的模型。比如，你可以配置：</p>
<ul>
<li>编程相关的请求路由到代码能力强的模型</li>
<li>创意写作请求路由到创意能力强的模型</li>
<li>普通对话请求路由到性价比高的模型</li>
</ul>
<blockquote>
<p>注意，开启自动路由需要额外安装 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faurelio-labs%2Fsemantic-router" target="_blank" title="https://github.com/aurelio-labs/semantic-router" ref="nofollow noopener noreferrer">semantic-router</a> 依赖。</p>
</blockquote>
<p>首先，需要在 <code>router.json</code> 文件中定义路由规则：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"encoder_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"openai"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"encoder_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text-embedding-3-large"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"routes"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gpt-4o"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"utterances"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"写一首关于春天的诗"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"通用助手"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"score_threshold"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.5</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-sonnet-4"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"utterances"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"使用 Python 语言实现冒泡排序算法"</span>
      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"代码助手"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"score_threshold"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.5</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后在模型列表中配置自动路由：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">model_list:</span>
  
  <span class="hljs-comment"># 嵌入模型（用于计算内容相似度）</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">text-embedding-3-large</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">text-embedding-3-large</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>

  <span class="hljs-comment"># 自动路由</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">auto_router</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">auto_router/auto_router</span>
      <span class="hljs-attr">auto_router_config_path:</span> <span class="hljs-string">router.json</span>
      <span class="hljs-attr">auto_router_default_model:</span> <span class="hljs-string">gpt-4o</span>
      <span class="hljs-attr">auto_router_embedding_model:</span> <span class="hljs-string">text-embedding-3-large</span>

  <span class="hljs-comment"># 目标路由</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">openai/gpt-4o</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">claude-sonnet-4</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">anthropic/claude-sonnet-4-20250514</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/ANTHROPIC_API_KEY</span>
</code></pre>
<p>然后使用下面的命令进行测试：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 这条请求会被自动路由到 gpt-4o</span>
$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "auto_router",
    "messages": [{"role": "user", "content": "写一首关于春天的诗"}]
  }'</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 这条请求会被自动路由到 claude-sonnet-4</span>
$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "auto_router",
    "messages": [{"role": "user", "content": "使用 Python 语言实现冒泡排序算法"}]
  }'</span>
</code></pre>
<p>自动路由也可以在 Admin UI 中添加：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3140bf2f65b42488d4b9ee631b77385~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764720488&amp;x-signature=6uHkLlubgd0lQxDu1dIa2UlWnsM%3D" alt="add-auto-router.png" loading="lazy"/></p>
<p>自动路由的工作原理很简单：</p>
<ol>
<li><strong>内容嵌入</strong>：使用配置的嵌入模型将用户请求转换为向量；</li>
<li><strong>相似度计算</strong>：计算请求向量与每条规则的 <code>utterances</code> 向量的相似度；</li>
<li><strong>阈值判断</strong>：如果最高相似度超过 <code>score_threshold</code>，则选择对应模型；</li>
<li><strong>默认回退</strong>：如果没有规则匹配，使用 <code>auto_router_default_model</code> 默认模型；</li>
</ol>
<h3 data-id="heading-6">标签路由</h3>
<p><strong>标签路由（Tag Routing）</strong> 允许基于请求的标签来选择不同的模型部署，这在多租户场景下特别有用。比如：</p>
<ul>
<li><strong>多租户隔离</strong>：不同租户使用不同的模型实例</li>
<li><strong>服务分级</strong>：免费用户使用廉价服务，付费用户使用真实服务</li>
<li><strong>团队隔离</strong>：不同团队使用不同的部署实例</li>
</ul>
<p>它的配置也很简单：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">model_list:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">openai/gpt-4o-mini</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>
      <span class="hljs-attr">tags:</span> [<span class="hljs-string">"free"</span>]          <span class="hljs-comment"># 免费用户使用</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">openai/gpt-4o</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>
      <span class="hljs-attr">tags:</span> [<span class="hljs-string">"paid"</span>]          <span class="hljs-comment"># 付费用户使用</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">openai/gpt-4o-mini</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>
      <span class="hljs-attr">tags:</span> [<span class="hljs-string">"default"</span>]       <span class="hljs-comment"># 默认路由</span>

<span class="hljs-attr">router_settings:</span>
  <span class="hljs-attr">enable_tag_filtering:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 开启标签路由</span>
</code></pre>
<p>注意通过 <code>enable_tag_filtering</code> 配置开启标签路由功能，在这个例子中，我们定义了 <code>gpt-4o</code> 这个模型，当免费用户（带 <code>free</code> 标签）请求时将路由到 <code>gpt-4o-mini</code> 模型，只有付费用户（带 <code>paid</code> 标签）请求时才会路由到真正的 <code>gpt-4o</code> 模型。</p>
<p>客户端调用方式如下：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 免费用户请求</span>
$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "Hello"}],
    "tags": ["free"]
  }'</span>
</code></pre>
<blockquote>
<p>请求入参中的 <code>tags</code> 也可以放在 <code>metadata</code> 中。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 付费用户请求</span>
$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "Hello"}],
    "tags": ["paid"]
  }'</span>
</code></pre>
<p>我们也可以在 Admin UI 中添加标签并关联对应的模型：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/702c5c0a5ea94c3c8583e4549d156ac3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764720488&amp;x-signature=dXx2eIBjzQqbNZy6MznfCsxnfRc%3D" alt="create-new-tag.png" loading="lazy"/></p>
<h3 data-id="heading-7">预算路由</h3>
<p>在企业环境中，成本控制是一个关键考虑因素。LiteLLM 支持按 <strong>供应商</strong>、<strong>模型</strong>、<strong>标签</strong> 三个维度设置预算限制，实现自动的成本控制。</p>
<h4 data-id="heading-8">供应商预算（Provider Budget）</h4>
<p>为不同的 LLM 供应商设置日预算或月预算：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">router_settings:</span>
  <span class="hljs-attr">provider_budget_config:</span>
    <span class="hljs-attr">openai:</span>
      <span class="hljs-attr">budget_limit:</span> <span class="hljs-number">100.0</span>    <span class="hljs-comment"># $100/day</span>
      <span class="hljs-attr">time_period:</span> <span class="hljs-string">"1d"</span>
    <span class="hljs-attr">azure:</span>
      <span class="hljs-attr">budget_limit:</span> <span class="hljs-number">500.0</span>    <span class="hljs-comment"># $500/month</span>
      <span class="hljs-attr">time_period:</span> <span class="hljs-string">"30d"</span>
    <span class="hljs-attr">anthropic:</span>
      <span class="hljs-attr">budget_limit:</span> <span class="hljs-number">200.0</span>    <span class="hljs-comment"># $200/10days</span>
      <span class="hljs-attr">time_period:</span> <span class="hljs-string">"10d"</span>
</code></pre>
<p>当某个供应商的预算用完后，LiteLLM 会自动将请求路由到其他预算充足的供应商。</p>
<h4 data-id="heading-9">模型预算（Model Budget）</h4>
<p>为特定模型设置预算：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">model_list:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">openai/gpt-4o</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>
      <span class="hljs-attr">max_budget:</span> <span class="hljs-number">10.0</span>         <span class="hljs-comment"># $10/day</span>
      <span class="hljs-attr">budget_duration:</span> <span class="hljs-string">"1d"</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o-mini</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">openai/gpt-4o-mini</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>
      <span class="hljs-attr">max_budget:</span> <span class="hljs-number">100.0</span>        <span class="hljs-comment"># $100/month</span>
      <span class="hljs-attr">budget_duration:</span> <span class="hljs-string">"30d"</span>
</code></pre>
<h4 data-id="heading-10">标签预算（Tag Budget）</h4>
<p>为特定的业务标签设置预算（企业特性）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">litellm_settings:</span>
  <span class="hljs-attr">tag_budget_config:</span>
    <span class="hljs-attr">product:chat-bot:</span>         <span class="hljs-comment"># 客服机器人标签</span>
      <span class="hljs-attr">max_budget:</span> <span class="hljs-number">50.0</span>        <span class="hljs-comment"># $50/day</span>
      <span class="hljs-attr">budget_duration:</span> <span class="hljs-string">"1d"</span>
    <span class="hljs-attr">product:internal-tool:</span>    <span class="hljs-comment"># 内部工具标签</span>
      <span class="hljs-attr">max_budget:</span> <span class="hljs-number">200.0</span>       <span class="hljs-comment"># $200/day</span>
      <span class="hljs-attr">budget_duration:</span> <span class="hljs-string">"1d"</span>
</code></pre>
<h2 data-id="heading-11">重试策略</h2>
<p>在生产环境中，我们还需要考虑各种故障场景，LiteLLM 提供了一套完整的可靠性保障机制，包括 <strong>重试策略（Retry Policy）</strong> 和 <strong>回退策略（Fallbacks）</strong>。</p>
<p>当请求失败时，LiteLLM 会自动重试，可以通过下面的参数修改重试次数和重试间隔：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">router_settings:</span>
  <span class="hljs-attr">num_retries:</span> <span class="hljs-number">2</span>    <span class="hljs-comment"># 全局重试次数</span>
  <span class="hljs-attr">retry_after:</span> <span class="hljs-number">5</span>    <span class="hljs-comment"># 最小重试间隔（秒）</span>
</code></pre>
<p>LiteLLM 还可以针对不同类型的错误来重试：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">router_settings:</span>
  <span class="hljs-attr">num_retries:</span> <span class="hljs-number">2</span>    <span class="hljs-comment"># 全局重试次数</span>
  <span class="hljs-attr">retry_after:</span> <span class="hljs-number">5</span>    <span class="hljs-comment"># 最小重试间隔（秒）</span>
  <span class="hljs-attr">retry_policy:</span>
    <span class="hljs-attr">"RateLimitErrorRetries":</span> <span class="hljs-number">3</span>        <span class="hljs-comment"># 速率限制错误重试3次</span>
    <span class="hljs-attr">"ContentPolicyViolationErrorRetries":</span> <span class="hljs-number">2</span>  <span class="hljs-comment"># 内容政策违规重试2次</span>
    <span class="hljs-attr">"TimeoutErrorRetries":</span> <span class="hljs-number">2</span>          <span class="hljs-comment"># 超时错误重试2次</span>
    <span class="hljs-attr">"BadRequestErrorRetries":</span> <span class="hljs-number">0</span>       <span class="hljs-comment"># 错误请求不重试</span>
    <span class="hljs-attr">"AuthenticationErrorRetries":</span> <span class="hljs-number">0</span>   <span class="hljs-comment"># 认证错误不重试</span>
</code></pre>
<blockquote>
<p>值得注意的是，针对速率限制错误，LiteLLM 使用 <strong>指数退避（Exponential Backoffs）</strong> 重试策略，每次重试的间隔时间会按照指数级增长，而非固定间隔。</p>
</blockquote>
<h2 data-id="heading-12">回退策略</h2>
<p><strong>回退（Fallbacks）</strong> 是另一种可靠性保障机制，当重试仍然失败时，LiteLLM 会尝试回退到其他模型部署或模型组,它确保在部分模型不可用时系统能够优雅降级，而不是直接失败。</p>
<blockquote>
<p>回退和重试的区别：重试是针对同一部署的多次尝试，通常用于应对临时性故障（网络抖动等），而回退尝试不同的部署，用于应对永久性故障（服务宕机等）。合理使用这两种机制，能够显著提高系统的可靠性。</p>
</blockquote>
<p>LiteLLM 实现了三种不同的回退策略：</p>
<ol>
<li><strong>上下文窗口回退 (Context Window Fallbacks)</strong> - 当请求的 token 数量超过当前模型的上下文窗口限制时，自动切换到支持更大上下文的模型；</li>
<li><strong>内容策略回退 (Content Policy Fallbacks)</strong> - 当请求因内容审核被拒绝时，自动切换到内容限制更宽松的模型；</li>
<li><strong>通用故障回退 (General Fallbacks)</strong> - 处理网络错误、服务不可用、速率限制等各种故障情况；</li>
</ol>
<p>回退的配置如下所示：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">router_settings:</span>
  <span class="hljs-attr">context_window_fallbacks:</span> [
    {<span class="hljs-attr">"gpt-4o":</span> [<span class="hljs-string">"gpt-4o-long"</span>]}
  ]
  <span class="hljs-attr">content_policy_fallbacks:</span> [
    {<span class="hljs-attr">"gpt-4o":</span> [<span class="hljs-string">"gpt-4o-permissive"</span>]}
  ]
  <span class="hljs-attr">fallbacks:</span> [
    {<span class="hljs-attr">"gpt-4o":</span> [<span class="hljs-string">"gpt-4o-mini"</span>, <span class="hljs-string">"gpt-3.5-turbo"</span>]}
  ]
</code></pre>
<p>当某个部署频繁失败时，LiteLLM 会将其放入 <strong>冷却期（Cooldown）</strong>，避免继续向故障部署发送请求：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">router_settings:</span>
  <span class="hljs-attr">allowed_fails:</span> <span class="hljs-number">3</span>  <span class="hljs-comment"># 允许失败 3 次</span>
  <span class="hljs-attr">cooldown_time:</span> <span class="hljs-number">30</span> <span class="hljs-comment"># 冷却 30 秒</span>
</code></pre>
<p>冷却机制可以通过下面的参数关闭：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">router_settings:</span>
  <span class="hljs-attr">disable_cooldowns:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># 关闭冷却机制</span>
</code></pre>
<p>如果客户端不希望触发回退，可以在请求中传入 <code>disable_fallbacks</code> 参数：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "Hello"}],
    "disable_fallbacks": true
  }'</span>
</code></pre>
<h2 data-id="heading-13">小结</h2>
<p>到这里，我们已经完整梳理了 LiteLLM 的路由与回退策略的核心逻辑，这些能力正是构建高可用 LLM 网关的基石，能帮我们从容应对多模型场景下的流量分配、成本控制与故障容错挑战。</p>
<p>最后我们再对今天学习的内容总结一下：</p>
<ul>
<li><strong>负载均衡与路由策略</strong>：LiteLLM 提供了多种路由策略来应对不同场景需求。在高并发场景下，推荐使用默认的简单随机策略获得最佳性能；在需要精细控制的场景下，可以选择延迟优化、成本优化或使用率均衡策略。</li>
<li><strong>智能化路由功能</strong>：除了基础的负载均衡，LiteLLM 还提供了自动路由、标签路由和预算路由等高级功能。自动路由能根据请求内容语义自动选择最适合的模型；标签路由支持多租户隔离和服务分级；预算路由则从供应商、模型、标签三个维度实现精确的成本控制。</li>
<li><strong>可靠性保障机制</strong>：通过重试策略和回退策略的组合，LiteLLM 构建了完整的容错体系。重试策略针对临时性故障提供自动恢复能力，支持按错误类型定制重试逻辑；回退策略则处理永久性故障，包括上下文窗口限制、内容策略违规和通用故障等多种场景。</li>
</ul>
<p>这些能力并非孤立存在，而是可以根据实际业务场景灵活组合，最终帮我们搭建出稳定、高效且成本可控的 LLM 网关，为上层业务提供可靠的模型服务支撑。</p>
<h2 data-id="heading-14">欢迎关注</h2>
<p>如果这篇文章对您有所帮助，欢迎关注我的同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fi-study-everyday.online%2Fabout-me.html" target="_blank" title="https://i-study-everyday.online/about-me.html" ref="nofollow noopener noreferrer">日习一技，每天学一点新技术</a>。</p>
<p>我会每天花一个小时，记录下我学习的点点滴滴。内容包括但不限于：</p>
<ul>
<li>某个产品的使用小窍门</li>
<li>开源项目的实践和心得</li>
<li>技术点的简单解读</li>
</ul>
<p>目标是让大家用5分钟读完就能有所收获，不需要太费劲，但却可以轻松获取一些干货。不管你是技术新手还是老鸟，欢迎给我提建议，如果有想学习的技术，也欢迎交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# 中 ?、??、??=、?: 、?. 、?[] 各种问号的用法和说明]]></title>    <link>https://juejin.cn/post/7576543407013003283</link>    <guid>https://juejin.cn/post/7576543407013003283</guid>    <pubDate>2025-11-26T00:14:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576543407013003283" data-draft-id="7576512460263309348" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# 中 ?、??、??=、?: 、?. 、?[] 各种问号的用法和说明"/> <meta itemprop="keywords" content="C#"/> <meta itemprop="datePublished" content="2025-11-26T00:14:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# 中 ?、??、??=、?: 、?. 、?[] 各种问号的用法和说明
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T00:14:15.000Z" title="Wed Nov 26 2025 00:14:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在 C# 中，问号（?）远不止是一个简单的标点符号。随着语言版本的迭代更新，C# 围绕问号（?）发展出了一套强大而优雅的空值处理和条件表达机制。熟练掌握这些操作运算符不仅能大幅提升代码的简洁性和可读性，还能有效避免恼人的空引用异常，构建更加健壮的应用程序。</p>
<h2 data-id="heading-1">可空类型修饰符（?）</h2>
<p>在 C# 中，值类型（如int、long、bool、DateTime等）默认不能为null。使用 ? 修饰符，我们可以将值类型转换为可空类型。</p>
<pre><code class="hljs language-ini" lang="ini">            int notNullableInt<span class="hljs-comment">;// 非空int类型默认为 0</span>
            int? <span class="hljs-attr">nullableInt</span> = null<span class="hljs-comment">;</span>
            bool? <span class="hljs-attr">nullableBool</span> = null<span class="hljs-comment">;</span>
            long? <span class="hljs-attr">nullableLong</span> = null<span class="hljs-comment">;</span>
            DateTime? <span class="hljs-attr">nullableDate</span> = null<span class="hljs-comment">;</span>

            // 检查是否有值
            if (nullableInt.HasValue)
            {
                Console.WriteLine($"整数值: {nullableInt.Value}")<span class="hljs-comment">;</span>
            }
            else
            {
                Console.WriteLine("变量没有值（为null）")<span class="hljs-comment">;</span>
            }
</code></pre>
<h2 data-id="heading-2">Null 合并运算符（??）</h2>
<p>Null 合并运算符（??）如果左边的值不为null，则返回左边的值，否则返回右边的值。</p>
<pre><code class="hljs language-ini" lang="ini">        static void Main(string<span class="hljs-section">[]</span> args)
        {
            string <span class="hljs-attr">userName1</span> = <span class="hljs-string">"小明"</span><span class="hljs-comment">;</span>
            string <span class="hljs-attr">userName2</span> = null<span class="hljs-comment">;</span>
            var <span class="hljs-attr">getUserName</span> = userName1 ?? userName2 ?? <span class="hljs-string">"默认用户"</span><span class="hljs-comment">;</span>

            Console.WriteLine(getUserName)<span class="hljs-comment">; // 输出: 小明</span>

            string <span class="hljs-attr">config1</span> = null<span class="hljs-comment">;</span>
            string <span class="hljs-attr">config2</span> = null<span class="hljs-comment">;</span>
            string <span class="hljs-attr">config3</span> = <span class="hljs-string">"DefaultConfig"</span><span class="hljs-comment">;</span>
            string <span class="hljs-attr">finalConfig</span> = config1 ?? config2 ?? config3 ?? <span class="hljs-string">"FallbackConfig"</span><span class="hljs-comment">;</span>
            Console.WriteLine(finalConfig)<span class="hljs-comment">; // 输出: DefaultConfig</span>
        }
</code></pre>
<h2 data-id="heading-3">Null 合并赋值运算符（??=）</h2>
<p>C# 8.0 引入的运算符，仅当左操作数为null时，才将右操作数的值赋给左操作数。这是懒加载模式的理想选择。</p>
<pre><code class="hljs language-csharp" lang="csharp">        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            <span class="hljs-built_in">string</span>? name = <span class="hljs-literal">null</span>;
            name ??= <span class="hljs-string">"时光者"</span>;
            Console.WriteLine(name); <span class="hljs-comment">// 时光者</span>

            name ??= <span class="hljs-string">"大姚"</span>; <span class="hljs-comment">// 不改变</span>
            Console.WriteLine(name); <span class="hljs-comment">// 时光者</span>


            <span class="hljs-comment">//惰性初始化</span>
            Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;? cache = <span class="hljs-literal">null</span>;

            cache ??= <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;();
            cache[<span class="hljs-string">"UserName"</span>] = name;

            Console.WriteLine(cache[<span class="hljs-string">"UserName"</span>]);
        }
</code></pre>
<h2 data-id="heading-4">三元条件运算符（?:）</h2>
<p>条件运算符(?:)，又称三元运算符，是一种简洁的条件表达式形式。它对布尔表达式进行求值，并根据结果为true或false，选择性地返回两个表达式中的对应结果，为简单条件判断提供了一种比传统if-else语句更紧凑、表达力更强的语法形式。</p>
<pre><code class="hljs language-ini" lang="ini">        static void Main(string<span class="hljs-section">[]</span> args)
        {
            int <span class="hljs-attr">score</span> = <span class="hljs-number">80</span><span class="hljs-comment">;</span>
            string <span class="hljs-attr">level</span> = score &gt;= <span class="hljs-number">60</span> ? <span class="hljs-string">"Pass"</span> : <span class="hljs-string">"Fail"</span><span class="hljs-comment">;</span>
            Console.WriteLine(level)<span class="hljs-comment">;</span>
        }
</code></pre>
<h2 data-id="heading-5">Null 条件成员访问运算符 (?.)</h2>
<p>Null 条件成员访问运算符 (?.) 在访问对象成员（属性、方法、字段等）前先检查对象是否为 null。如果对象为 null，整个表达式返回 null 而不会抛出 NullReferenceException；如果对象不为 null，则正常访问成员。</p>
<pre><code class="hljs language-csharp" lang="csharp">        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            <span class="hljs-comment">// 基本用法</span>
            Person person = <span class="hljs-literal">null</span>;
            <span class="hljs-built_in">string</span> name = person?.Name; <span class="hljs-comment">// 不会抛出异常，name 为 null</span>
            Console.WriteLine(name ?? <span class="hljs-string">"name is null"</span>); <span class="hljs-comment">// 输出: name is null</span>
        }
</code></pre>
<h2 data-id="heading-6">Null 条件索引访问运算符 (?[])</h2>
<p>Null 条件索引访问运算符 (?[]) 在使用索引器访问集合元素前先检查集合对象是否为 null。如果集合为 null，整个表达式返回 null 而不会抛出异常；如果集合不为 null，则正常访问索引位置的元素。</p>
<pre><code class="hljs language-csharp" lang="csharp">        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            List&lt;<span class="hljs-built_in">string</span>&gt; names = <span class="hljs-literal">null</span>;
            <span class="hljs-built_in">string</span> firstName = names?[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 不会抛出异常，firstName 为 null</span>
            Console.WriteLine(firstName ?? <span class="hljs-string">"No names available"</span>); <span class="hljs-comment">// 输出: No names available</span>

            <span class="hljs-comment">// 初始化列表后访问</span>
            names = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-built_in">string</span>&gt; { <span class="hljs-string">"时光者"</span>, <span class="hljs-string">"小袁"</span>, <span class="hljs-string">"大姚"</span> };
            <span class="hljs-built_in">string</span> secondName = names?[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 安全访问索引为0的元素</span>
            Console.WriteLine(secondName); <span class="hljs-comment">// 输出: 时光者</span>
        }
</code></pre>
<h2 data-id="heading-7">C#/.NET/.NET Core面试宝典</h2>
<p>本文已收录至C#/.NET/.NET Core面试宝典中，更新C#/.NET/.NET Core面试干货前往开源地址查看：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/438cdd5eb93f4f3384df557376e8bd99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764720855&amp;x-signature=Q5ks2rQ7RQstsl%2BcP5psrDGkYM0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed303fd99f3f44309f603a8cded22da4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764720855&amp;x-signature=RtK2vd81FIyjGOBWSCtS%2FiuN6hA%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 3.12新特性解析：10个让你代码效率提升30%的实用技巧]]></title>    <link>https://juejin.cn/post/7576487832090673167</link>    <guid>https://juejin.cn/post/7576487832090673167</guid>    <pubDate>2025-11-26T00:16:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576487832090673167" data-draft-id="7576532425761734671" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 3.12新特性解析：10个让你代码效率提升30%的实用技巧"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-26T00:16:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 3.12新特性解析：10个让你代码效率提升30%的实用技巧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T00:16:50.000Z" title="Wed Nov 26 2025 00:16:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Python 3.12新特性解析：10个让你代码效率提升30%的实用技巧</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Python 3.12作为Python语言的最新版本，带来了许多令人振奋的新特性和优化。这些改进不仅提升了代码的执行效率，还简化了开发流程，使得开发者能够更高效地完成工作。本文将深入解析Python 3.12中最为实用的10个新特性，并通过实际示例展示如何利用这些特性将你的代码效率提升30%。无论你是数据分析师、Web开发者还是自动化脚本编写者，这些技巧都将为你的工作带来显著提升。</p>
<hr/>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 更快的解释器：PEP 659（Specializing Adaptive Interpreter）</h3>
<p>Python 3.12引入了PEP 659提出的"Specializing Adaptive Interpreter"，这是一种新型的解释器优化技术。它通过在运行时动态识别和优化热点代码路径，显著提升了执行速度。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python 3.11及之前版本</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate</span>(<span class="hljs-params">x</span>):
    <span class="hljs-keyword">return</span> x * x

<span class="hljs-comment"># Python 3.12会自动识别频繁调用的calculate函数并进行优化</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>):
    calculate(i)
</code></pre>
<p>这项优化特别适合循环密集型的操作，基准测试显示在某些场景下性能提升可达25%。</p>
<h3 data-id="heading-4">2. PEP 701：f-字符串的语法放宽</h3>
<p>Python 3.12对f-字符串的限制进行了大幅放宽（PEP 701），现在可以在f-字符串中使用任何有效的Python表达式。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python 3.11会报错的情况</span>
items = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Last item: <span class="hljs-subst">{items[-<span class="hljs-number">1</span>]}</span>"</span>)

<span class="hljs-comment"># Python 3.12新增支持的反斜杠和注释</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"List: <span class="hljs-subst">{\n[x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> items <span class="hljs-keyword">if</span> x &gt;<span class="hljs-number">1</span>]\n}</span>"</span>)
</code></pre>
<p>这一改进使得f-字符串更加灵活强大，减少了需要临时变量的情况。</p>
<h3 data-id="heading-5">3. PEP 684：隔离子解释器的GIL</h3>
<p>虽然全局解释器锁(GIL)仍然存在，但Python 3.12通过PEP 684为每个子解释器引入了独立的GIL。这对于需要并行处理的计算密集型任务是一个重大进步。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> _xxsubinterpreters <span class="hljs-keyword">as</span> interpreters

<span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>():
    <span class="hljs-comment"># Each subinterpreter now has its own GIL</span>
    <span class="hljs-keyword">pass</span>

interp = interpreters.create()
interpreters.run_string(interp, <span class="hljs-string">"worker()"</span>)
</code></pre>
<p>在多线程环境中使用子解释器可以显著提高CPU利用率。</p>
<h3 data-id="heading-6">4. PEP 688：Buffer协议的可访问性增强</h3>
<p>PEP 688使得Buffer协议更容易在Python代码中使用，这对高性能数值计算和数据科学应用尤为重要。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> array

arr = array.array(<span class="hljs-string">'d'</span>, [<span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>, -<span class="hljs-number">5</span>])
<span class="hljs-keyword">with</span> <span class="hljs-built_in">memoryview</span>(arr) <span class="hljs-keyword">as</span> m:
    <span class="hljs-built_in">print</span>(m.<span class="hljs-built_in">format</span>)   <span class="hljs-comment"># 'd'</span>
    <span class="hljs-built_in">print</span>(m.itemsize) <span class="hljs-comment">#8</span>
</code></pre>
<p>这使得低级内存操作更加安全和直观。</p>
<p>###5.PEP709:推导式内联变量作用域</p>
<p>Python3.12改变了推导式中变量的作用域规则(PEP709)，解决了长期存在的变量泄漏问题。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python3.11及之前版本的问题：</span>
x=<span class="hljs-string">"global"</span>
nums=[x:=i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)]
<span class="hljs-built_in">print</span>(x) <span class="hljs-comment">#输出4（泄漏到外部作用域）</span>

<span class="hljs-comment"># Python3.12中的行为：</span>
x=<span class="hljs-string">"global"</span>
nums=[y:=i <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)] <span class="hljs-comment">#y只在推导式内部可见</span>
<span class="hljs-built_in">print</span>(y)<span class="hljs-comment">#NameError:name'y'is not defined</span>
</code></pre>
<p>这一改变使变量作用域更加符合直觉预期。</p>
<p>###6.PEP695:类型参数语法改进</p>
<p>类型注解系统得到了重大升级(PEP695)，引入了更简洁的类型参数语法和TypeVarTuple支持。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Generic</span>,<span class="hljs-type">Tuple</span>,TypeVarTuple

Shape=TypeVarTuple(<span class="hljs-string">'Shape'</span>)
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Array</span>(<span class="hljs-type">Generic</span>[*Shape]):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self,indices:*Shape</span>)-&gt;<span class="hljs-built_in">float</span>:...
    
<span class="hljs-keyword">def</span> <span class="hljs-title function_">concat</span>(<span class="hljs-params">a:Array[*S],b:Array[*S]</span>)-&gt;Array[*S]:...
</code></pre>
<p>这使得类型系统的表达能力更强且更易读。</p>
<p>###7.Python-OpenSSL替换为rustls的部分实现</p>
<p>为提高安全性和性能标准库中的部分TLS功能已开始迁移到rustls实现：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> ssl 

ctx=ssl.create_default_context()
ctx.minimum_version=ssl.TLSVersion.TLSv1_2<span class="hljs-comment">#更安全的默认设置 </span>
</code></pre>
<p>这一变化使加密操作更快且更不容易出现安全问题.</p>
<p>###8.unittest模块的重大改进unittest模块现在支持异步测试和更多断言方法:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> unittest 

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TestAsync</span>(unittest.IsolatedAsyncioTestCase):
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_coroutine</span>(<span class="hljs-params">self</span>):
        result=<span class="hljs-keyword">await</span> some_async_function()
        self.assertAlmostEqual(result,expected)
        
        <span class="hljs-keyword">with</span> self.assertRaisesRegex(TypeError,<span class="hljs-string">"expected message"</span>):
            bad_function()
</code></pre>
<p>这使得测试异步代码变得简单直接.</p>
<p>###9.dataclasses的性能优化数据类现在有更快的内存分配方式和属性访问:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass 

<span class="hljs-meta">@dataclass(<span class="hljs-params">slots=<span class="hljs-literal">True</span></span>)</span><span class="hljs-comment">#新增slots选项进一步提升性能 </span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Point</span>:
    x:<span class="hljs-built_in">int</span> 
    y:<span class="hljs-built_in">int</span> 
    
p=Point(<span class="hljs-number">1</span>,y=<span class="hljs-number">2</span>)<span class="hljs-comment">#创建速度快25%</span>
<span class="hljs-built_in">print</span>(p.x)<span class="hljs-comment">#访问速度快15%</span>
</code></pre>
<p>对于大量创建的数据类实例性能提升尤为明显.</p>
<p>###10.pathlib.Path的walk方法pathlib现在提供了比os.walk更方便的遍历方法:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path 

<span class="hljs-keyword">for</span> entry <span class="hljs-keyword">in</span> Path(<span class="hljs-string">'.'</span>).walk():
    <span class="hljs-keyword">if</span> entry.is_file()<span class="hljs-keyword">and</span> entry.suffix==<span class="hljs-string">'.py'</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Found Python file:<span class="hljs-subst">{entry}</span>"</span>)
        
<span class="hljs-comment">#也支持top_down=False等参数控制遍历顺序  </span>
</code></pre>
<p>这统一了文件系统操作的API风格.</p>
<hr/>
<p>##总结</p>
<p>Python3.12通过以上10个主要特性及其他数十项小改进在性能、开发体验和安全性方面都迈出了重要一步从自适应解释器带来的速度提升到类型系统的重大革新再到标准库各个角落的精雕细琢每一项改变都为开发者提供了更好的工具和环境将这些新特性合理应用到项目中确实可以实现30%甚至更高的效率提升无论是通过直接的性能增强还是间接的开发流程改善建议所有正在使用Python的开发者都应该评估升级计划并逐步采用这些新特性以保持技术栈的现代性和竞争力未来随着更多项目迁移到Python312我们还将看到围绕这些新特性的最佳实践不断涌现</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 脚本革命：<script setup> 让你的代码简洁到飞起！]]></title>    <link>https://juejin.cn/post/7576543407013199891</link>    <guid>https://juejin.cn/post/7576543407013199891</guid>    <pubDate>2025-11-26T00:31:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576543407013199891" data-draft-id="7576550156364316678" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 脚本革命：&lt;script setup&gt; 让你的代码简洁到飞起！"/> <meta itemprop="keywords" content="Vue.js,JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-26T00:31:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 脚本革命：&lt;script setup&gt; 让你的代码简洁到飞起！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T00:31:33.000Z" title="Wed Nov 26 2025 00:31:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是不是还在为 Vue 组件的那些繁琐语法头疼？每次写个组件都要 export default、methods、data 来回折腾，感觉代码总是啰里啰嗦的？</p>
<p>告诉你个好消息，Vue3 的 <code>&lt;script setup&gt;</code> 语法糖简直就是为我们这些追求效率的开发者量身定做的！它能让你用更少的代码做更多的事，而且写起来那叫一个爽快。</p>
<p>今天我就带你彻底搞懂这个功能，从基本用法到高级技巧，保证让你看完就能用上，代码量直接减半！</p>
<h2 data-id="heading-0">什么是 <code>&lt;script setup&gt;</code>？</h2>
<p>简单来说，<code>&lt;script setup&gt;</code> 是 Vue3 引入的一种编译时语法糖，它能让单文件组件的脚本部分变得更加简洁明了。</p>
<p>以前我们写个组件得这样：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script&gt;
export default {
  data() {
    return {
      count: 0
    }
  },
  methods: {
    increment() {
      this.count++
    }
  }
}
&lt;/script&gt;
</code></pre>
<p>现在用 <code>&lt;script setup&gt;</code> 就简单多了：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'

const count = ref(0)

const increment = () =&gt; {
  count.value++
}
&lt;/script&gt;
</code></pre>
<p>看出来了吧？代码一下子清爽了很多！不再需要那些模板化的结构，直接写逻辑就行。</p>
<h2 data-id="heading-1">为什么要用 <code>&lt;script setup&gt;</code>？</h2>
<p>你可能要问，我已经习惯原来的写法了，为什么要换呢？这里给你几个无法拒绝的理由：</p>
<p>代码量大幅减少，不用再写那些重复的样板代码。组件间的数据传递和事件处理变得更加直观。更好的 TypeScript 支持，类型推断更加准确。编译时优化，性能更优秀。</p>
<p>最重要的是，写起来真的很快乐！你再也不用在 methods、data、computed 之间来回切换了。</p>
<h2 data-id="heading-2">基础用法速成</h2>
<p>让我们从最简单的开始，一步步掌握 <code>&lt;script setup&gt;</code> 的核心用法。</p>
<p>定义响应式数据，在 <code>&lt;script setup&gt;</code> 里，我们直接用 ref 和 reactive：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, reactive } from 'vue'

// 基本类型用 ref
const name = ref('张三')
const age = ref(25)

// 对象类型可以用 reactive
const userInfo = reactive({
  job: '前端开发',
  salary: 20000
})

// 修改数据也很简单
const updateInfo = () =&gt; {
  name.value = '李四'  // ref 需要通过 .value 访问
  userInfo.salary = 25000 // reactive 直接修改属性
}
&lt;/script&gt;
</code></pre>
<p>定义方法就更简单了，直接写函数就行：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
const sayHello = () =&gt; {
  console.log('你好，Vue3！')
}

const calculate = (a, b) =&gt; {
  return a + b
}
&lt;/script&gt;
</code></pre>
<p>计算属性也用起来：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, computed } from 'vue'

const price = ref(100)
const quantity = ref(2)

// 计算总价
const total = computed(() =&gt; {
  return price.value * quantity.value
})

// 复杂的计算属性
const discountTotal = computed(() =&gt; {
  const totalVal = price.value * quantity.value
  return totalVal &gt; 200 ? totalVal * 0.9 : totalVal
})
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-3">组件通信变得超简单</h2>
<p>在 <code>&lt;script setup&gt;</code> 里，组件间的通信也变得特别直观。</p>
<p>定义 props 可以用 defineProps：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
// 基础用法
defineProps(['title', 'content'])

// 带类型检查的用法
defineProps({
  title: String,
  content: {
    type: String,
    required: true
  },
  count: {
    type: Number,
    default: 0
  }
})

// 用 TypeScript 的话更简单
defineProps&lt;{
  title?: string
  content: string
  count?: number
}&gt;()
&lt;/script&gt;
</code></pre>
<p>定义 emits 用 defineEmits：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
// 基础用法
const emit = defineEmits(['update', 'delete'])

// 带验证的用法
const emit = defineEmits({
  update: (id) =&gt; {
    if (id) return true
    console.warn('需要提供 id')
    return false
  }
})

// 实际使用
const handleUpdate = () =&gt; {
  emit('update', 123)
}

const handleDelete = () =&gt; {
  emit('delete', 456)
}
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-4">高级技巧让你更专业</h2>
<p>掌握了基础用法，再来看看一些提升效率的高级技巧。</p>
<p>使用组合式函数，这是 Vue3 的精髓之一：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, onMounted } from 'vue'

// 封装一个获取数据的组合式函数
const useFetch = (url) =&gt; {
  const data = ref(null)
  const loading = ref(false)
  const error = ref(null)

  const fetchData = async () =&gt; {
    loading.value = true
    try {
      const response = await fetch(url)
      data.value = await response.json()
    } catch (err) {
      error.value = err
    } finally {
      loading.value = false
    }
  }

  onMounted(fetchData)

  return {
    data,
    loading,
    error,
    refetch: fetchData
  }
}

// 在组件中使用
const { data: userData, loading, error } = useFetch('/api/user')
&lt;/script&gt;
</code></pre>
<p>使用 defineExpose 暴露组件方法：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'

const count = ref(0)

const increment = () =&gt; {
  count.value++
}

const reset = () =&gt; {
  count.value = 0
}

// 暴露给父组件的方法
defineExpose({
  increment,
  reset
})
&lt;/script&gt;
</code></pre>
<p>使用 useSlots 和 useAttrs：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { useSlots, useAttrs } from 'vue'

const slots = useSlots()
const attrs = useAttrs()

// 可以动态处理插槽和属性
const hasHeaderSlot = !!slots.header
const extraClass = attrs.class || ''
&lt;/script&gt;
</code></pre>
<h2 data-id="heading-5">实战案例：打造一个任务管理器</h2>
<p>光说不练假把式，我们来写个完整的任务管理组件：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="task-manager"&gt;
    &lt;div class="add-task"&gt;
      &lt;input 
        v-model="newTask" 
        @keyup.enter="addTask"
        placeholder="输入新任务..."
        class="task-input"
      &gt;
      &lt;button @click="addTask" class="add-btn"&gt;添加&lt;/button&gt;
    &lt;/div&gt;
    
    &lt;div class="task-list"&gt;
      &lt;div 
        v-for="task in filteredTasks" 
        :key="task.id"
        :class="['task-item', { completed: task.completed }]"
      &gt;
        &lt;input 
          type="checkbox" 
          v-model="task.completed"
          class="task-checkbox"
        &gt;
        &lt;span class="task-text"&gt;{{ task.text }}&lt;/span&gt;
        &lt;button @click="removeTask(task.id)" class="remove-btn"&gt;删除&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;div class="task-stats"&gt;
      &lt;span&gt;总计: {{ totalTasks }} 个任务&lt;/span&gt;
      &lt;span&gt;已完成: {{ completedTasks }} 个&lt;/span&gt;
      &lt;button @click="filter = 'all'"&gt;全部&lt;/button&gt;
      &lt;button @click="filter = 'active'"&gt;未完成&lt;/button&gt;
      &lt;button @click="filter = 'completed'"&gt;已完成&lt;/button&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, computed, onMounted } from 'vue'

// 响应式数据
const newTask = ref('')
const tasks = ref([])
const filter = ref('all')

// 添加新任务
const addTask = () =&gt; {
  if (newTask.value.trim()) {
    tasks.value.push({
      id: Date.now(),
      text: newTask.value.trim(),
      completed: false
    })
    newTask.value = ''
    saveToLocalStorage()
  }
}

// 删除任务
const removeTask = (id) =&gt; {
  tasks.value = tasks.value.filter(task =&gt; task.id !== id)
  saveToLocalStorage()
}

// 计算属性
const totalTasks = computed(() =&gt; tasks.value.length)
const completedTasks = computed(() =&gt; 
  tasks.value.filter(task =&gt; task.completed).length
)

const filteredTasks = computed(() =&gt; {
  switch (filter.value) {
    case 'active':
      return tasks.value.filter(task =&gt; !task.completed)
    case 'completed':
      return tasks.value.filter(task =&gt; task.completed)
    default:
      return tasks.value
  }
})

// 本地存储
const saveToLocalStorage = () =&gt; {
  localStorage.setItem('vue-tasks', JSON.stringify(tasks.value))
}

const loadFromLocalStorage = () =&gt; {
  const saved = localStorage.getItem('vue-tasks')
  if (saved) {
    tasks.value = JSON.parse(saved)
  }
}

// 生命周期
onMounted(() =&gt; {
  loadFromLocalStorage()
})
&lt;/script&gt;

&lt;style scoped&gt;
.task-manager {
  max-width: 500px;
  margin: 0 auto;
  padding: 20px;
}

.task-input {
  padding: 8px;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin-right: 8px;
}

.add-btn {
  padding: 8px 16px;
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.task-item {
  display: flex;
  align-items: center;
  padding: 8px;
  border-bottom: 1px solid #eee;
}

.task-item.completed .task-text {
  text-decoration: line-through;
  color: #888;
}

.task-checkbox {
  margin-right: 8px;
}

.task-text {
  flex: 1;
}

.remove-btn {
  padding: 4px 8px;
  background: #ff4757;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.task-stats {
  margin-top: 16px;
  display: flex;
  gap: 12px;
  align-items: center;
}
&lt;/style&gt;
</code></pre>
<p>这个例子展示了 <code>&lt;script setup&gt;</code> 在实际项目中的强大能力，代码结构清晰，逻辑组织得当。</p>
<h2 data-id="heading-6">常见问题解答</h2>
<p><strong>Q: 从 Options API 迁移到 <code>&lt;script setup&gt;</code> 难吗？</strong>
A: 其实不难！大部分概念都是相通的，只是写法更简洁了。建议先从简单的组件开始尝试。</p>
<p><strong>Q: <code>&lt;script setup&gt;</code> 对 TypeScript 支持怎么样？</strong>
A: 支持非常好！类型推断更加准确，写起来特别舒服。</p>
<p><strong>Q: 还能和普通的 <code>&lt;script&gt;</code> 混用吗？</strong>
A: 可以的，但通常不建议。除非你有特殊的模块导出需求。</p>
<p><strong>Q: 现有的 Vue2 项目能直接用吗？</strong>
A: 需要升级到 Vue3，但升级过程比想象中简单，官方提供了详细的迁移指南。</p>
<h2 data-id="heading-7">最佳实践推荐</h2>
<p>根据我的经验，这些实践能让你的代码质量更高：</p>
<p>按逻辑组织代码，而不是按功能类型。把相关的数据、方法、计算属性放在一起。合理使用组合式函数抽离可复用逻辑。使用 TypeScript 获得更好的开发体验。保持组件的单一职责，不要写太复杂的组件。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter睡眠与冥想数据可视化神器：sleep_stage_chart插件全解析]]></title>    <link>https://juejin.cn/post/7576543407013232659</link>    <guid>https://juejin.cn/post/7576543407013232659</guid>    <pubDate>2025-11-26T00:39:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576543407013232659" data-draft-id="7571815573933408319" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter睡眠与冥想数据可视化神器：sleep_stage_chart插件全解析"/> <meta itemprop="keywords" content="Flutter,Android,前端"/> <meta itemprop="datePublished" content="2025-11-26T00:39:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter睡眠与冥想数据可视化神器：sleep_stage_chart插件全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T00:39:47.000Z" title="Wed Nov 26 2025 00:39:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>在健康类 App 开发中，睡眠周期分析和冥想数据展示是核心功能模块。一个直观、美观且交互流畅的可视化图表，能极大提升用户对健康数据的理解和使用体验。今天给大家推荐一款专为 Flutter 开发者打造的全能型图表插件——<strong>sleep_stage_chart</strong>，它不仅能完美呈现睡眠阶段数据，还支持冥想时长可视化，跨平台兼容且高度可定制。</p>
<h2 data-id="heading-0">1. 简介</h2>
<p><code>sleep_stage_chart</code>是一款专注于睡眠阶段和冥想数据可视化的 Flutter 插件，借鉴了 Apple Health 应用的优雅设计风格，提供了平滑的过渡效果和丰富的交互能力。该插件支持 Android、iOS 和 Windows 三大平台，能够满足健康类 App 对睡眠周期分析、冥想时长统计等场景的可视化需求。</p>
<h3 data-id="heading-1">1.1. 例图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7b79258904c437ebbd0ad21222c3480~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764722387&amp;x-signature=j27zZH389EnntvmiOQ5T5xdwVVo%3D" alt="睡眠图" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b6c35ad686d4faab1d7fb8b59c205fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764722387&amp;x-signature=Kp5YCWV4ao5d15cAckwkfDNzm%2Bo%3D" alt="冥想图" loading="lazy"/></p>
<h3 data-id="heading-2">1.2. 核心功能</h3>
<p>该插件的功能覆盖了健康数据可视化的核心需求，同时提供了足够的灵活性：</p>
<ul>
<li>📊 <strong>双图表支持</strong>：同时兼容睡眠阶段图（浅睡/深睡/REM/清醒状态）和冥想时长图</li>
<li>🎨 <strong>深度定制化</strong>：支持颜色、样式、布局、网格线等全维度自定义</li>
<li>📱 <strong>跨平台兼容</strong>：无缝运行于 Android、iOS、Windows 平台</li>
<li>🤏 <strong>交互体验</strong>：支持触摸拖拽指示器，查看不同时段的详细数据</li>
<li>🕐 <strong>精准时间展示</strong>：清晰呈现时间范围、阶段时长，支持自定义时间格式化</li>
<li>🎀 <strong>样式扩展</strong>：支持自定义底部组件、圆角、背景色等外观属性</li>
<li>📖 <strong>完善文档</strong>：提供完整的 API 说明和可直接运行的示例代码</li>
</ul>
<h2 data-id="heading-3">2. 快速集成</h2>
<p>在项目的 <code>pubspec.yaml</code> 文件中添加插件依赖：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">sleep_stage_chart:</span> <span class="hljs-string">^1.1.2</span>  <span class="hljs-comment"># 建议使用最新版本</span>
</code></pre>
<p>执行安装命令：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub get
</code></pre>
<h3 data-id="heading-4">2.1. 基础使用示例</h3>
<p>插件提供了两种核心图表场景：睡眠阶段图和冥想时长图，以下是最简实现示例。</p>
<h4 data-id="heading-5">睡眠阶段图</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:sleep_stage_chart/sleep_stage_chart.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SleepChartDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 构造睡眠数据：包含阶段类型、起止时间、描述信息</span>
    <span class="hljs-keyword">final</span> sleepData = [
      SleepStageDetails(
        model: SleepStageEnum.light,  <span class="hljs-comment">// 浅睡</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">22</span>, <span class="hljs-number">30</span>),
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">23</span>, <span class="hljs-number">30</span>),
        info: [<span class="hljs-string">'浅睡，睡眠质量良好'</span>],
      ),
      SleepStageDetails(
        model: SleepStageEnum.deep,   <span class="hljs-comment">// 深睡</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">23</span>, <span class="hljs-number">30</span>),
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
        info: [<span class="hljs-string">'深睡，身体修复阶段'</span>],
      ),
      SleepStageDetails(
        model: SleepStageEnum.rem,    <span class="hljs-comment">// REM睡眠（快速眼动）</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">15</span>),
        info: [<span class="hljs-string">'REM睡眠，大脑活跃'</span>],
      ),
      SleepStageDetails(
        model: SleepStageEnum.awake,  <span class="hljs-comment">// 清醒</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>),
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">30</span>),
        info: [<span class="hljs-string">'清醒，准备起床'</span>],
      ),
    ];

    <span class="hljs-keyword">return</span> Container(
      height: <span class="hljs-number">300</span>,
      margin: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
      child: SleepStageChart(
        details: sleepData,  <span class="hljs-comment">// 睡眠数据（必填）</span>
        startTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">22</span>, <span class="hljs-number">30</span>),  <span class="hljs-comment">// 开始时间（必填）</span>
        endTime: <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">30</span>),     <span class="hljs-comment">// 结束时间（必填）</span>
        backgroundColor: Colors.white,            <span class="hljs-comment">// 背景色（必填）</span>
        heightUnitRatio: <span class="hljs-number">1</span> / <span class="hljs-number">8</span>,                   <span class="hljs-comment">// 高度比例单位</span>
        onIndicatorMoved: (stage) {               <span class="hljs-comment">// 指示器移动回调</span>
          <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前阶段：<span class="hljs-subst">${stage.model.name}</span>，时长：<span class="hljs-subst">${stage.duration}</span>分钟'</span>);
        },
        bottomChild: <span class="hljs-keyword">const</span> [Text(<span class="hljs-string">'入睡'</span>), Text(<span class="hljs-string">'起床'</span>)],  <span class="hljs-comment">// 底部自定义文本</span>
        stageColors: {  <span class="hljs-comment">// 自定义各阶段颜色</span>
          SleepStageEnum.light: Colors.blue.shade300,
          SleepStageEnum.deep: Colors.blue.shade700,
          SleepStageEnum.rem: Colors.teal.shade400,
          SleepStageEnum.awake: Colors.orange.shade300,
        },
      ),
    );
  }
}
</code></pre>
<h4 data-id="heading-6">冥想时长图</h4>
<p>冥想图表通常需要展示全天或特定时段的冥想分布，可通过统一颜色和时间轴配置实现：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:sleep_stage_chart/sleep_stage_chart.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MeditationChartDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> dayStart = <span class="hljs-built_in">DateTime</span>(<span class="hljs-number">2025</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Container(
      height: <span class="hljs-number">300</span>,
      margin: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
      child: SleepStageChart(
        details: [
          SleepStageDetails(
            model: SleepStageEnum.light,
            startTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(minutes: <span class="hljs-number">30</span>)),
            endTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(minutes: <span class="hljs-number">75</span>)),
            info: [<span class="hljs-string">'晨间冥想，专注呼吸'</span>],
          ),
          SleepStageDetails(
            model: SleepStageEnum.light,
            startTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(hours: <span class="hljs-number">19</span>)),
            endTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(hours: <span class="hljs-number">20</span>, minutes: <span class="hljs-number">20</span>)),
            info: [<span class="hljs-string">'睡前冥想，放松身心'</span>],
          ),
        ],
        startTime: dayStart,
        endTime: dayStart.add(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(days: <span class="hljs-number">1</span>)),
        backgroundColor: Colors.transparent,
        heightUnitRatio: <span class="hljs-number">1</span> / <span class="hljs-number">8</span>,
        allDayModel: <span class="hljs-keyword">true</span>,  <span class="hljs-comment">// 开启全天模式</span>
        minuteInterval: <span class="hljs-number">360</span>,  <span class="hljs-comment">// 时间轴间隔：6小时</span>
        stageColors: <span class="hljs-keyword">const</span> {  <span class="hljs-comment">// 统一冥想颜色</span>
          SleepStageEnum.light: Color(<span class="hljs-number">0xFF43CAC4</span>),
          SleepStageEnum.deep: Color(<span class="hljs-number">0xFF43CAC4</span>),
          SleepStageEnum.rem: Color(<span class="hljs-number">0xFF43CAC4</span>),
          SleepStageEnum.awake: Color(<span class="hljs-number">0xFF43CAC4</span>),
        },
        bottomChild: [<span class="hljs-string">'00:00'</span>, <span class="hljs-string">'06:00'</span>, <span class="hljs-string">'12:00'</span>, <span class="hljs-string">'18:00'</span>, <span class="hljs-string">'00:00'</span>]
            .map((time) =&gt; Text(time, style: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">12</span>)))
            .toList(),
        showVerticalLine: <span class="hljs-keyword">true</span>,  <span class="hljs-comment">// 显示竖线分隔</span>
        showHorizontalLine: <span class="hljs-keyword">false</span>,  <span class="hljs-comment">// 隐藏横线</span>
        borderRadius: <span class="hljs-number">12</span>,  <span class="hljs-comment">// 圆角优化</span>
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-7">2.2. 高级定制指南</h3>
<p><code>sleep_stage_chart</code>提供了丰富的定制属性，以下是常见场景的定制方案。</p>
<h4 data-id="heading-8">颜色定制</h4>
<p>通过 <code>stageColors</code> 属性自定义各睡眠阶段的颜色，支持所有 <code>SleepStageEnum</code> 类型：</p>
<pre><code class="hljs language-dart" lang="dart">stageColors: <span class="hljs-keyword">const</span> {
  SleepStageEnum.light: Color(<span class="hljs-number">0xFFE3F2FD</span>),  <span class="hljs-comment">// 浅睡-淡蓝</span>
  SleepStageEnum.deep: Color(<span class="hljs-number">0xFF90CAF9</span>),   <span class="hljs-comment">// 深睡-中蓝</span>
  SleepStageEnum.rem: Color(<span class="hljs-number">0xFF42A5F5</span>),    <span class="hljs-comment">// REM-深蓝</span>
  SleepStageEnum.awake: Color(<span class="hljs-number">0xFFFFE0B2</span>),  <span class="hljs-comment">// 清醒-淡橙</span>
  SleepStageEnum.notWorn: Color(<span class="hljs-number">0xFFF5F5F5</span>),<span class="hljs-comment">// 未佩戴-灰色</span>
  SleepStageEnum.unknown: Color(<span class="hljs-number">0xFFEEEEEE</span>),<span class="hljs-comment">// 未知-浅灰</span>
},
</code></pre>
<h4 data-id="heading-9">网格线定制</h4>
<p>控制网格线的显示/隐藏和样式：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 横线样式</span>
horizontalLineStyle: SleepStageChartLineStyle(
  width: <span class="hljs-number">1.0</span>,
  color: Colors.grey.shade200,
  space: <span class="hljs-number">2.0</span>,  <span class="hljs-comment">// 虚线间隔</span>
),
<span class="hljs-comment">// 竖线样式</span>
verticalLineStyle: SleepStageChartLineStyle(
  width: <span class="hljs-number">1.0</span>,
  color: Colors.grey.shade200,
),
showHorizontalLine: <span class="hljs-keyword">true</span>,  <span class="hljs-comment">// 显示横线</span>
showVerticalLine: <span class="hljs-keyword">true</span>,    <span class="hljs-comment">// 显示竖线</span>
horizontalLineCount: <span class="hljs-number">6</span>,    <span class="hljs-comment">// 横线数量（分割图表高度）</span>
</code></pre>
<h4 data-id="heading-10">时间格式化</h4>
<p>通过 <code>dateFormatter</code> 自定义时间轴的显示格式：</p>
<pre><code class="hljs language-dart" lang="dart">dateFormatter: (<span class="hljs-built_in">DateTime</span> date) {
  <span class="hljs-comment">// 自定义格式：小时-分钟（补零）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">'<span class="hljs-subst">${date.hour.toString().padLeft(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>)}</span>:<span class="hljs-subst">${date.minute.toString().padLeft(<span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>)}</span>'</span>;
},
</code></pre>
<h4 data-id="heading-11">交互控制</h4>
<p>控制指示器的显示和回调：</p>
<pre><code class="hljs language-dart" lang="dart">hasIndicator: <span class="hljs-keyword">true</span>,  <span class="hljs-comment">// 显示触摸指示器</span>
onIndicatorMoved: (SleepStageDetails stage) {
  <span class="hljs-comment">// 指示器移动时回调，可用于更新详情面板</span>
  setState(() {
    _currentStage = stage;
    _currentDuration = <span class="hljs-string">'<span class="hljs-subst">${stage.duration}</span>分钟'</span>;
    _currentInfo = stage.info.join(<span class="hljs-string">' '</span>);
  });
},
</code></pre>
<h2 data-id="heading-12">3. 核心 API 参考</h2>
<p>下面是核心的api属性列举：</p>
<h3 data-id="heading-13">SleepStageChart（主组件）</h3>





































































































<table><thead><tr><th>属性名</th><th>类型</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td><code>details</code></td><td>List</td><td>-</td><td>核心数据（必填）</td></tr><tr><td><code>startTime</code></td><td>DateTime</td><td>-</td><td>开始时间（必填）</td></tr><tr><td><code>endTime</code></td><td>DateTime</td><td>-</td><td>结束时间（必填）</td></tr><tr><td><code>backgroundColor</code></td><td>Color</td><td>-</td><td>背景色（必填）</td></tr><tr><td><code>stageColors</code></td><td>Map&lt;SleepStageEnum, Color&gt;?</td><td>null</td><td>阶段颜色映射</td></tr><tr><td><code>heightUnitRatio</code></td><td>double</td><td>-</td><td>高度比例单位</td></tr><tr><td><code>borderRadius</code></td><td>double</td><td>8.0</td><td>圆角半径</td></tr><tr><td><code>showVerticalLine</code></td><td>bool</td><td>true</td><td>是否显示竖线</td></tr><tr><td><code>showHorizontalLine</code></td><td>bool</td><td>true</td><td>是否显示横线</td></tr><tr><td><code>hasIndicator</code></td><td>bool</td><td>true</td><td>是否显示触摸指示器</td></tr><tr><td><code>onIndicatorMoved</code></td><td>void Function(SleepStageDetails)?</td><td>null</td><td>指示器移动回调</td></tr><tr><td><code>allDayModel</code></td><td>bool</td><td>false</td><td>是否开启全天模式</td></tr><tr><td><code>minuteInterval</code></td><td>int</td><td>360</td><td>全天模式时间间隔（分钟）</td></tr><tr><td><code>bottomChild</code></td><td>List</td><td>[]</td><td>底部自定义组件列表</td></tr><tr><td><code>dateFormatter</code></td><td>String Function(DateTime)?</td><td>null</td><td>时间格式化函数</td></tr></tbody></table>
<h3 data-id="heading-14">SleepStageDetails（数据模型）</h3>



































<table><thead><tr><th>属性名</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>model</code></td><td>SleepStageEnum</td><td>睡眠/冥想阶段类型</td></tr><tr><td><code>startTime</code></td><td>DateTime</td><td>阶段开始时间</td></tr><tr><td><code>endTime</code></td><td>DateTime</td><td>阶段结束时间</td></tr><tr><td><code>info</code></td><td>List</td><td>阶段描述信息</td></tr><tr><td><code>duration</code></td><td>int</td><td>时长（分钟，自动计算）</td></tr></tbody></table>
<h3 data-id="heading-15">SleepStageEnum（阶段枚举）</h3>





























<table><thead><tr><th>枚举值</th><th>描述</th></tr></thead><tbody><tr><td><code>light</code></td><td>浅睡/冥想</td></tr><tr><td><code>deep</code></td><td>深睡</td></tr><tr><td><code>rem</code></td><td>REM睡眠</td></tr><tr><td><code>awake</code></td><td>清醒</td></tr><tr><td><code>unknown</code></td><td>未知状态</td></tr></tbody></table>
<h2 data-id="heading-16">4. 示例App项目</h2>
<p>插件提供了完整的示例项目，可直接克隆源码运行体验：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/wp993080086/sleep_stage_chart.git

<span class="hljs-comment"># 进入示例目录</span>
<span class="hljs-built_in">cd</span> sleep_stage_chart/example

<span class="hljs-comment"># 安装依赖并运行</span>
flutter pub get
flutter run
</code></pre>
<p>示例项目包含了睡眠图表、冥想图表的各种定制场景，可直接参考复用。</p>
<h2 data-id="heading-17">5. 总结</h2>
<p>sleep_stage_chart 是一款功能全面、高度可定制的 Flutter 健康数据可视化插件，凭借其优雅的设计风格、流畅的交互体验和跨平台兼容性，能够快速满足睡眠和冥想数据的可视化需求。无论是快速集成基础图表，还是深度定制符合 App 风格的可视化效果，该插件都能提供简洁高效的解决方案。</p>
<p><strong>适用场景：</strong></p>
<ul>
<li>睡眠监测类 App：展示深睡、浅睡、REM 睡眠周期分布</li>
<li>冥想类 App：统计每日/每周冥想时长和时段分布</li>
<li>健康管理 App：整合睡眠与冥想数据的综合可视化</li>
<li>智能穿戴设备配套 App：同步设备采集的睡眠数据展示</li>
</ul>
<p>如果你的项目中需要实现睡眠周期分析或冥想数据展示，不妨试试 sleep_stage_chart，让健康数据可视化开发更高效！</p>
<p><strong>相关链接：</strong></p>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwp993080086%2Fsleep_stage_chart" target="_blank" title="https://github.com/wp993080086/sleep_stage_chart" ref="nofollow noopener noreferrer">GitHub仓库</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwp993080086%2Fsleep_stage_chart%2Fblob%2Fmaster%2FREADME_zh.md" target="_blank" title="https://github.com/wp993080086/sleep_stage_chart/blob/master/README_zh.md" ref="nofollow noopener noreferrer">中文文档</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fsleep_stage_chart" target="_blank" title="https://pub.dev/packages/sleep_stage_chart" ref="nofollow noopener noreferrer">pub.dev仓库</a></p>
</li>
</ul>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7570923924365230143" target="_blank" title="https://juejin.cn/post/7570923924365230143">flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析</a></li>
<li><a href="https://juejin.cn/post/7568136081302978623" target="_blank" title="https://juejin.cn/post/7568136081302978623">解锁flutter弹窗新姿势：dialog-flutter_smart_dialog插件解读+案例</a></li>
<li><a href="https://juejin.cn/post/7559089440901545999" target="_blank" title="https://juejin.cn/post/7559089440901545999">flutter-切换状态显示不同组件10种实现方案全解析</a></li>
<li><a href="https://juejin.cn/post/7555079970491318308" target="_blank" title="https://juejin.cn/post/7555079970491318308">flutter-详解控制组件显示的两种方式Offstage与Visibility</a></li>
<li><a href="https://juejin.cn/post/7535358416182788122" target="_blank" title="https://juejin.cn/post/7535358416182788122">flutter-使用AnimatedDefaultTextStyle实现文本动画</a></li>
<li><a href="https://juejin.cn/post/7537339432291434496" target="_blank" title="https://juejin.cn/post/7537339432291434496">flutter-使用SafeArea组件处理各机型的安全距离</a></li>
<li><a href="https://juejin.cn/spost/7537593417099149321" target="_blank" title="https://juejin.cn/spost/7537593417099149321">flutter-实现渐变色边框背景以及渐变色文字</a></li>
<li><a href="https://juejin.cn/post/7543474419240370185" target="_blank" title="https://juejin.cn/post/7543474419240370185">flutter-使用confetti制作炫酷纸屑爆炸粒子动画</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[两天一首歌，这个UP主是怎么做到的？]]></title>    <link>https://juejin.cn/post/7576482238462083114</link>    <guid>https://juejin.cn/post/7576482238462083114</guid>    <pubDate>2025-11-26T00:40:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576482238462083114" data-draft-id="7576550156364349446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="两天一首歌，这个UP主是怎么做到的？"/> <meta itemprop="keywords" content="AIGC,人工智能"/> <meta itemprop="datePublished" content="2025-11-26T00:40:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            两天一首歌，这个UP主是怎么做到的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T00:40:52.000Z" title="Wed Nov 26 2025 00:40:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天不聊具体的技术，给大家分享一个 B 站的 UP 主“<strong>漫游会议室</strong>”和他的作品。</p>
<p>为什么分享这个呢？因为他的<strong>作品中词、曲、视频全部都是 AI 生成的</strong>。</p>
<p>也许大家之前都接触过一些 AI 生成的作品，我也看过不少，但质量、内涵有限。</p>
<p>这位 UP 的作品，不论是歌词内容、曲调旋律、视频质量，我感觉都很赞，让我一个不怎么听歌的人都连听了好几天。</p>
<p>我是听《美猴亡》入坑的，给大家简单看下。</p>
<p><strong>歌词</strong>：</p>
<pre><code class="hljs">他们给我金箍说是荣耀，勒进头骨不准我吵。
我说我想回家看看，他们说大圣别开玩笑。
他们给我经书说是正道，让我打妖不准我逃。
我说那妖像我从前模样，他们说闭嘴只管开道。
他们杀死了美猴王，用虚名、用香火、用金光。
现在我坐的端正笑的慈祥，可那双眼睛早就没了光。

他们杀死了美猴王，用慈悲、用规矩、用奖赏。
现在我功德圆满万民敬仰，可我的心五行山下无人安葬。
花果山还在，只是没有我。
猴子们唱着斗战胜佛的歌。
没人记得谁第一个翻筋斗，只记得是谁听话不惹祸。
老猴子说大王早变了，新猴子笑他太啰嗦。
他们供着我的金身像，却烧了我睡过的草窝。

他们杀死了美猴王，用庙堂、用跪拜、用牌坊。
如今我端坐在莲台之上，却再也不知何站是故乡。
他们说这就是成长，可这成长为何像投降。
他们终于赢了，用我的模样。
我不过是——他们早就写好的光
</code></pre>
<p><strong>视频</strong>：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1tVsHznELh%2F%3Fspm_id_from%3D333.337.search-card.all.click%26vd_source%3D8257f94ef61b6e0d48a8dfea7e4a2478" target="_blank" title="https://www.bilibili.com/video/BV1tVsHznELh/?spm_id_from=333.337.search-card.all.click&amp;vd_source=8257f94ef61b6e0d48a8dfea7e4a2478" ref="nofollow noopener noreferrer">美猴亡 B 站</a></p>
<p>从数据上来看，应该很不错了，毕竟1个来月，单 B 站播放量就已经过千万了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f37ffb95bb44e54b6565a5f252586b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764722553&amp;x-signature=cX%2F5vieM519YhDUCEoyQj0pMRak%3D" alt="" loading="lazy"/></p>
<p>但真正让人惊讶的，不是完成质量，而是这种<strong>高质量内容的产出速度</strong>。</p>
<p>从10月19号上传第一个作品，到11月23号，不到40天，这个 UP 上传了21个作品。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e260d0d109d44bb6a4d6e829b1f76d4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764722553&amp;x-signature=wtB%2BHuX8SqMwfjMdewfGHnCLU5Y%3D" alt="" loading="lazy"/></p>
<p>简单换算的话，<strong>2天一个作品</strong>，哪个团队也没这样出过歌啊！</p>
<p>其实，不只是音乐。</p>
<p><strong>AI正在重构所有“依赖技能但不依赖灵魂”的工作</strong>。</p>
<p>设计师可以借助 AI，3分钟实现灵感的具象化。</p>
<p>程序员可以借助 AI，1小时完成原来1天的开发。</p>
<p>很多重复的、流程的、可标准化的工作都正在被 AI 吃掉，相应的，个体的能力也在逐步扩大。</p>
<p>最后，引用“数字生命卡兹克”的一句话结尾：</p>
<p>“当AI越来越强悍的时候，制约我们的，真的就是我们那贫瘠的想象力了。”</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CoolGuard事件查询增加策略和规则筛选，条件结果展示]]></title>    <link>https://juejin.cn/post/7576550156364447750</link>    <guid>https://juejin.cn/post/7576550156364447750</guid>    <pubDate>2025-11-26T01:00:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576550156364447750" data-draft-id="7576476897950072859" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CoolGuard事件查询增加策略和规则筛选，条件结果展示"/> <meta itemprop="keywords" content="后端,前端"/> <meta itemprop="datePublished" content="2025-11-26T01:00:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无奈何杨"/> <meta itemprop="url" content="https://juejin.cn/user/72987223006237"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CoolGuard事件查询增加策略和规则筛选，条件结果展示
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/72987223006237/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无奈何杨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T01:00:46.000Z" title="Wed Nov 26 2025 01:00:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">策略规则筛选</h2>
<h3 data-id="heading-1">效果展示</h3>
<p>首先需要一个级联选择器，依次是应用-策略集-策略-规则，当然如果后期增加了租户或部门的概念可以再加。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f9f4bbd32ef43159230dd717f37ac73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5aWI5L2V5p2o:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764723646&amp;x-signature=enptG8eqnyOJ6%2Bsq6w33q32diik%3D" alt="" loading="lazy"/></p>
<p>结合事件筛选后</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc00110f32024f81a15ce5da03fe715b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5aWI5L2V5p2o:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764723646&amp;x-signature=YBviVfMDkKOa9D1nYUsaiq0KvXA%3D" alt="" loading="lazy"/></p>
<p>其他相关的也都带上了这个条件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cba2aff89cf04aaea2e127080155278a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5aWI5L2V5p2o:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764723646&amp;x-signature=N9vURQ4w1B%2FkQX3eN%2BgR%2Foz4VSQ%3D" alt="" loading="lazy"/></p>
<p>选择应用-策略集-策略-规则查询</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc0bdb9bc7704452a2bb947d61424d94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5aWI5L2V5p2o:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764723646&amp;x-signature=HiZFAXA4bPR%2Fe98IjbzL1%2FOs1%2BU%3D" alt="" loading="lazy"/></p>
<p>如下只有一条数据满足此条件。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33180c4a59be4e77b565ab40ad760778~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5aWI5L2V5p2o:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764723646&amp;x-signature=xTeJ1lF%2BwVK1wPzsaGPu0stOH%2Bg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">规则命中排序</h3>
<p>其实增加了策略和规则筛选的主要目的是为了事件分析，特别是规则命中的分析，但还有一些不确定的内容，所以还无法展开聊。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd74444fb64a4098b971a381466cdd3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5aWI5L2V5p2o:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764723646&amp;x-signature=TekDa8sDrWmxXeCe%2FBvLR057i2w%3D" alt="" loading="lazy"/></p>
<p>目前还没做好，只是将规则code和version聚合计数排序，后面还需要再完善，如补充其他规则信息，扩展排序之外的更有价值的分析等。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"33a5b1ad71864121b6990f1d34bce39e"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">77</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"4d3527f1096541e8b7fe5367603a4ea4"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">36</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"664f30f443874698979674ee2c67474a"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"974a5d51c36747038f97f08321a3d043"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">47</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<h2 data-id="heading-3">条件结果展示</h2>
<h3 data-id="heading-4">效果展示</h3>
<p>如上事件结果的规则增加了条件结果展示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8c4bf94d25b4753afe7869680fa3a01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5aWI5L2V5p2o:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764723646&amp;x-signature=O%2Bp3eED2GO%2FGXm2FPhfa725F6cQ%3D" alt="" loading="lazy"/></p>
<p>展示也是嵌套的，如果叶子节点满足则是绿色，如果不满足则是红色，如果因为条件短路表示跳过是橘色，条件组会依据组合的“与或”关系展示对应的按钮颜色。</p>
<p>下面是测试的，其中还有问题，就是第一个和最后一个高度不确定时会超出部分，不是很美观，暂时未解决。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11254d56e36b44238d3ffc9c837aa26b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5aWI5L2V5p2o:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764723646&amp;x-signature=lAQLsAMbdqfnMtSHkCYDVHU2Zfg%3D" alt="" loading="lazy"/></p>
<p>另外在结合事件结果展示也比较丑，整体设计上还需要优化一下。</p>
<h3 data-id="heading-5">大概实现</h3>
<h4 data-id="heading-6">后端数据准备</h4>
<p>条件新增结果字段</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d77454ef2a414883bd328304f52c8308~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5aWI5L2V5p2o:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764723646&amp;x-signature=YU4g9SesIiK1NK5Dn3zr%2Blyb1po%3D" alt="" loading="lazy"/></p>
<p>分别对应true/false/skipped</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f2fdb7fdeb14db2b6c9daae333a1213~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5aWI5L2V5p2o:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764723646&amp;x-signature=nEpFaJHnM4azydQs9dAZQ8gSZbA%3D" alt="" loading="lazy"/></p>
<p>条件运行并设置结果如下</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">cond</span><span class="hljs-params">(Cond cond, FieldContext fieldContext, IndicatorContext indicatorContext)</span> {
    log.info(<span class="hljs-string">"条件:{}"</span>, cond);
    <span class="hljs-keyword">if</span> (cond == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    <span class="hljs-comment">// 如果有子节点，则递归计算子节点的结果</span>
    <span class="hljs-keyword">if</span> (CollUtil.isNotEmpty(cond.getChildren())) {
        List&lt;Cond&gt; children = cond.getChildren();
        <span class="hljs-type">boolean</span> finalResult;
        <span class="hljs-keyword">switch</span> (cond.getRelation().toUpperCase()) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"AND"</span> -&gt; {
                finalResult = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; children.size(); i++) {
                    <span class="hljs-type">Cond</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> children.get(i);
                    <span class="hljs-comment">// 递归计算子条件结果</span>
                    <span class="hljs-type">boolean</span> <span class="hljs-variable">childResult</span> <span class="hljs-operator">=</span> cond(child, fieldContext, indicatorContext);

                    <span class="hljs-keyword">if</span> (!childResult) {
                        <span class="hljs-comment">// 发现第一个 FALSE，触发短路</span>
                        finalResult = <span class="hljs-literal">false</span>;
                        child.setResult(CondResult.FALSE);

                        <span class="hljs-comment">// 标记后续所有兄弟节点为 SKIPPED</span>
                        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> i + <span class="hljs-number">1</span>; j &lt; children.size(); j++) {
                            children.get(j).setResult(CondResult.SKIPPED);
                        }
                        <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 退出外层 for 循环 (短路)</span>
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// 子条件为 TRUE，标记结果并继续</span>
                        child.setResult(CondResult.TRUE);
                    }
                }
            }
            <span class="hljs-keyword">case</span> <span class="hljs-string">"OR"</span> -&gt; {
                finalResult = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; children.size(); i++) {
                    <span class="hljs-type">Cond</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> children.get(i);
                    <span class="hljs-comment">// 递归计算子条件结果</span>
                    <span class="hljs-type">boolean</span> <span class="hljs-variable">childResult</span> <span class="hljs-operator">=</span> cond(child, fieldContext, indicatorContext);

                    <span class="hljs-keyword">if</span> (childResult) {
                        <span class="hljs-comment">// 发现第一个 TRUE，触发短路</span>
                        finalResult = <span class="hljs-literal">true</span>;
                        child.setResult(CondResult.TRUE);

                        <span class="hljs-comment">// 标记后续所有兄弟节点为 SKIPPED</span>
                        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> i + <span class="hljs-number">1</span>; j &lt; children.size(); j++) {
                            children.get(j).setResult(CondResult.SKIPPED);
                        }
                        <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 退出外层 for 循环 (短路)</span>
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-comment">// 子条件为 FALSE，标记结果并继续</span>
                        child.setResult(CondResult.FALSE);
                    }
                }
            }
            <span class="hljs-keyword">default</span> -&gt; <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"Unsupported relation: "</span> + cond.getRelation());
        }
        <span class="hljs-comment">// 注入父节点的聚合结果</span>
        cond.setResult(finalResult ? CondResult.TRUE : CondResult.FALSE);
        <span class="hljs-keyword">return</span> finalResult;
    }

    <span class="hljs-comment">// 处理叶子节点</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">leafResult</span> <span class="hljs-operator">=</span> condLeaf(cond, fieldContext, indicatorContext);
    cond.setResult(leafResult ? CondResult.TRUE : CondResult.FALSE);
    <span class="hljs-keyword">return</span> leafResult;
}
</code></pre>
<p>这样条件结果展示需要的数据就具备了</p>
<h4 data-id="heading-7">前端组件调整</h4>
<p>从父组件到每个单项条件组件增加showResult，根据传入值决定是否是条件结果展示模式。</p>
<p>当然下面还有如：条件层级（与或条件组层级）、不可编辑、条件模式（规则模式：可以设置指标，针对规则条件配置；指标模式：不可设置指标，针对指标条件配置），都是之前已经有的了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dce119d48a91470bbb658d70e2d9057e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5aWI5L2V5p2o:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764723646&amp;x-signature=a0ykvHRazpMVu91%2BsGbkBDxG6yE%3D" alt="" loading="lazy"/></p>
<p>另外前端也加上结果字段，同时表单校验规则修改一下，允许result为空。</p>
<p>同时组件调整一下，判断是否要展示结果，展示结果时使用特定的样式。</p>
<h2 data-id="heading-8">最后</h2>
<p>最后补充一下，因为我本地测试和演示环境使用的是同一套es，所以在演示环境看到的有些事件数据关联的规则或策略是找不到，这些只在我本地存储。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（146）Redis的Cluster的高可用性如何？]]></title>    <link>https://juejin.cn/post/7576532425761652751</link>    <guid>https://juejin.cn/post/7576532425761652751</guid>    <pubDate>2025-11-25T23:03:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576532425761652751" data-draft-id="7576532425761636367" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（146）Redis的Cluster的高可用性如何？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-25T23:03:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（146）Redis的Cluster的高可用性如何？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T23:03:18.000Z" title="Tue Nov 25 2025 23:03:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis Cluster 的高可用性通过以下几种机制来实现：</p>
<ol>
<li><strong>主从复制（Master-Slave Replication）</strong>：每个主节点可以有一个或多个从节点，从节点复制主节点的数据，提供读操作的负载均衡和故障转移的备份。</li>
<li><strong>自动故障转移（Automatic Failover）</strong>：当主节点故障时，从节点会自动提升为主节点，以确保数据的可用性和持续性。</li>
<li><strong>Gossip 协议</strong>：节点之间通过 Gossip 协议交换状态信息，确保整个集群对节点状态的一致性认识。</li>
</ol>
<p>下面是详细的 Java 代码示例，解释如何实现这些机制。</p>
<h3 data-id="heading-0">1. 主从复制</h3>
<p>主从复制是 Redis Cluster 高可用性的基础。每个主节点可以有一个或多个从节点，这些从节点复制主节点的数据。当主节点发生故障时，从节点可以接管其角色。</p>
<h4 data-id="heading-1">代码示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ClusterNode</span> {
    String name;
    String ip;
    <span class="hljs-type">int</span> port;
    <span class="hljs-type">boolean</span> isMaster;
    ClusterNode master;

    ClusterNode(String name, String ip, <span class="hljs-type">int</span> port, <span class="hljs-type">boolean</span> isMaster, ClusterNode master) {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.ip = ip;
        <span class="hljs-built_in">this</span>.port = port;
        <span class="hljs-built_in">this</span>.isMaster = isMaster;
        <span class="hljs-built_in">this</span>.master = master;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Node "</span> + name + <span class="hljs-string">": "</span> + ip + <span class="hljs-string">":"</span> + port + <span class="hljs-string">", Role: "</span> + (isMaster ? <span class="hljs-string">"Master"</span> : <span class="hljs-string">"Slave"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cluster</span> {
    List&lt;ClusterNode&gt; nodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addNode</span><span class="hljs-params">(String name, String ip, <span class="hljs-type">int</span> port, <span class="hljs-type">boolean</span> isMaster, ClusterNode master)</span> {
        nodes.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClusterNode</span>(name, ip, port, isMaster, master));
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">printNodes</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (ClusterNode node : nodes) {
            System.out.println(node);
        }
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisClusterDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Cluster</span> <span class="hljs-variable">cluster</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cluster</span>();

        <span class="hljs-type">ClusterNode</span> <span class="hljs-variable">master1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClusterNode</span>(<span class="hljs-string">"master1"</span>, <span class="hljs-string">"192.168.1.1"</span>, <span class="hljs-number">6379</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">null</span>);
        cluster.addNode(master1.name, master1.ip, master1.port, master1.isMaster, master1.master);
        cluster.addNode(<span class="hljs-string">"slave1"</span>, <span class="hljs-string">"192.168.1.2"</span>, <span class="hljs-number">6379</span>, <span class="hljs-literal">false</span>, master1);

        cluster.printNodes();
    }
}
</code></pre>
<h3 data-id="heading-2">2. 自动故障转移</h3>
<p>当主节点发生故障时，从节点会自动提升为主节点。这个过程需要其他节点的协作，以保证集群的一致性和数据的完整性。</p>
<h4 data-id="heading-3">代码示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Timer;
<span class="hljs-keyword">import</span> java.util.TimerTask;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ClusterNode</span> {
    String name;
    String ip;
    <span class="hljs-type">int</span> port;
    <span class="hljs-type">boolean</span> isMaster;
    ClusterNode master;
    <span class="hljs-type">long</span> lastHeartbeat;
    <span class="hljs-type">boolean</span> isFailed;

    ClusterNode(String name, String ip, <span class="hljs-type">int</span> port, <span class="hljs-type">boolean</span> isMaster, ClusterNode master) {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.ip = ip;
        <span class="hljs-built_in">this</span>.port = port;
        <span class="hljs-built_in">this</span>.isMaster = isMaster;
        <span class="hljs-built_in">this</span>.master = master;
        <span class="hljs-built_in">this</span>.lastHeartbeat = System.currentTimeMillis();
        <span class="hljs-built_in">this</span>.isFailed = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendHeartbeat</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"Sending heartbeat to node "</span> + name);
        lastHeartbeat = System.currentTimeMillis();
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkHeartbeat</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">if</span> (now - lastHeartbeat &gt; <span class="hljs-number">3000</span>) { <span class="hljs-comment">// 3 seconds timeout</span>
            System.out.println(<span class="hljs-string">"Node "</span> + name + <span class="hljs-string">" is not responding"</span>);
            isFailed = <span class="hljs-literal">true</span>;
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Node "</span> + name + <span class="hljs-string">": "</span> + ip + <span class="hljs-string">":"</span> + port + <span class="hljs-string">", Role: "</span> + (isMaster ? <span class="hljs-string">"Master"</span> : <span class="hljs-string">"Slave"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cluster</span> {
    List&lt;ClusterNode&gt; nodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addNode</span><span class="hljs-params">(String name, String ip, <span class="hljs-type">int</span> port, <span class="hljs-type">boolean</span> isMaster, ClusterNode master)</span> {
        nodes.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClusterNode</span>(name, ip, port, isMaster, master));
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleFailover</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (ClusterNode node : nodes) {
            <span class="hljs-keyword">if</span> (node.isMaster &amp;&amp; node.isFailed) {
                <span class="hljs-keyword">for</span> (ClusterNode slave : nodes) {
                    <span class="hljs-keyword">if</span> (slave.master == node) {
                        System.out.println(<span class="hljs-string">"Failover: promoting slave node "</span> + slave.name + <span class="hljs-string">" to master"</span>);
                        slave.isMaster = <span class="hljs-literal">true</span>;
                        slave.master = <span class="hljs-literal">null</span>;
                        node.isMaster = <span class="hljs-literal">false</span>;
                        <span class="hljs-keyword">return</span>;
                    }
                }
            }
        }
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">simulateCluster</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Timer</span> <span class="hljs-variable">timer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Timer</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-type">TimerTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">for</span> (ClusterNode node : nodes) {
                    <span class="hljs-keyword">if</span> (node.isMaster &amp;&amp; !node.isFailed) {
                        node.sendHeartbeat();
                    } <span class="hljs-keyword">else</span> {
                        node.checkHeartbeat();
                        <span class="hljs-keyword">if</span> (node.isFailed &amp;&amp; node.isMaster) {
                            handleFailover();
                        }
                    }
                }
            }
        };
        timer.scheduleAtFixedRate(task, <span class="hljs-number">0</span>, <span class="hljs-number">1000</span>);
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">printNodes</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (ClusterNode node : nodes) {
            System.out.println(node);
        }
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisClusterDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">Cluster</span> <span class="hljs-variable">cluster</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cluster</span>();

        <span class="hljs-type">ClusterNode</span> <span class="hljs-variable">master1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClusterNode</span>(<span class="hljs-string">"master1"</span>, <span class="hljs-string">"192.168.1.1"</span>, <span class="hljs-number">6379</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">null</span>);
        cluster.addNode(master1.name, master1.ip, master1.port, master1.isMaster, master1.master);
        cluster.addNode(<span class="hljs-string">"slave1"</span>, <span class="hljs-string">"192.168.1.2"</span>, <span class="hljs-number">6379</span>, <span class="hljs-literal">false</span>, master1);
        cluster.addNode(<span class="hljs-string">"slave2"</span>, <span class="hljs-string">"192.168.1.3"</span>, <span class="hljs-number">6379</span>, <span class="hljs-literal">false</span>, master1);

        cluster.printNodes();

        cluster.simulateCluster();

        <span class="hljs-comment">// Simulate a failure of the master after 10 seconds</span>
        Thread.sleep(<span class="hljs-number">10000</span>);
        master1.isFailed = <span class="hljs-literal">true</span>;

        <span class="hljs-comment">// Keep the main thread alive to see the failover in action</span>
        Thread.sleep(<span class="hljs-number">20000</span>);
    }
}
</code></pre>
<h3 data-id="heading-4">3. Gossip 协议</h3>
<p>Gossip 协议用于节点之间交换状态信息，确保整个集群对节点状态的一致性认识。每个节点会定期向其他节点发送和接收状态信息。</p>
<h4 data-id="heading-5">代码示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Timer;
<span class="hljs-keyword">import</span> java.util.TimerTask;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ClusterNode</span> {
    String name;
    String ip;
    <span class="hljs-type">int</span> port;
    <span class="hljs-type">boolean</span> isMaster;
    ClusterNode master;
    <span class="hljs-type">long</span> lastHeartbeat;
    <span class="hljs-type">boolean</span> isFailed;

    ClusterNode(String name, String ip, <span class="hljs-type">int</span> port, <span class="hljs-type">boolean</span> isMaster, ClusterNode master) {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.ip = ip;
        <span class="hljs-built_in">this</span>.port = port;
        <span class="hljs-built_in">this</span>.isMaster = isMaster;
        <span class="hljs-built_in">this</span>.master = master;
        <span class="hljs-built_in">this</span>.lastHeartbeat = System.currentTimeMillis();
        <span class="hljs-built_in">this</span>.isFailed = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendHeartbeat</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"Sending heartbeat from node "</span> + name);
        lastHeartbeat = System.currentTimeMillis();
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveHeartbeat</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"Received heartbeat at node "</span> + name);
        lastHeartbeat = System.currentTimeMillis();
        isFailed = <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkHeartbeat</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-keyword">if</span> (now - lastHeartbeat &gt; <span class="hljs-number">3000</span>) { <span class="hljs-comment">// 3 seconds timeout</span>
            System.out.println(<span class="hljs-string">"Node "</span> + name + <span class="hljs-string">" is not responding"</span>);
            isFailed = <span class="hljs-literal">true</span>;
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Node "</span> + name + <span class="hljs-string">": "</span> + ip + <span class="hljs-string">":"</span> + port + <span class="hljs-string">", Role: "</span> + (isMaster ? <span class="hljs-string">"Master"</span> : <span class="hljs-string">"Slave"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cluster</span> {
    List&lt;ClusterNode&gt; nodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addNode</span><span class="hljs-params">(String name, String ip, <span class="hljs-type">int</span> port, <span class="hljs-type">boolean</span> isMaster, ClusterNode master)</span> {
        nodes.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClusterNode</span>(name, ip, port, isMaster, master));
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleFailover</span><span class="hljs-params">(ClusterNode failedNode)</span> {
        <span class="hljs-keyword">for</span> (ClusterNode node : nodes) {
            <span class="hljs-keyword">if</span> (node.master == failedNode &amp;&amp; !node.isFailed) {
                System.out.println(<span class="hljs-string">"Failover: promoting slave node "</span> + node.name + <span class="hljs-string">" to master"</span>);
                node.isMaster = <span class="hljs-literal">true</span>;
                node.master = <span class="hljs-literal">null</span>;
                failedNode.isMaster = <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span>;
            }
        }
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">gossip</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (ClusterNode node : nodes) {
            <span class="hljs-keyword">if</span> (!node.isFailed) {
                <span class="hljs-keyword">for</span> (ClusterNode peer : nodes) {
                    <span class="hljs-keyword">if</span> (peer != node) {
                        peer.receiveHeartbeat();
                    }
                }
            } <span class="hljs-keyword">else</span> {
                handleFailover(node);
            }
        }
    }

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">simulateCluster</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Timer</span> <span class="hljs-variable">timer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Timer</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-type">TimerTask</span> <span class="hljs-variable">heartbeatTask</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">for</span> (ClusterNode node : nodes) {
                    <span class="hljs-keyword">if</span> (!node.isFailed) {
                        node.sendHeartbeat();
                    }
                }
            }
        };

        <span class="hljs-type">TimerTask</span> <span class="hljs-variable">gossipTask</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
                gossip();
            }
        };

      
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>