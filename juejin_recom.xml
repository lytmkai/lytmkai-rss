<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[每周AI论文速递（260126-260130）]]></title>    <link>https://juejin.cn/post/7601159804489744403</link>    <guid>https://juejin.cn/post/7601159804489744403</guid>    <pubDate>2026-01-31T14:12:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601159804489744403" data-draft-id="7601034810313392182" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每周AI论文速递（260126-260130）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-31T14:12:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叶子的技术碎碎念"/> <meta itemprop="url" content="https://juejin.cn/user/2831954919569245"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每周AI论文速递（260126-260130）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2831954919569245/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叶子的技术碎碎念
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T14:12:42.000Z" title="Sat Jan 31 2026 14:12:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Can LLMs Clean Up Your Mess? A Survey of Application-Ready Data Preparation with LLMs</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.17058" target="_blank" title="https://arxiv.org/abs/2601.17058" ref="nofollow noopener noreferrer">大语言模型能否处理混乱数据？面向应用的 LLM 数据准备技术综述</a></p>
<p>数据准备旨在清理原始数据集、发现跨数据集关联并从中提取有价值的洞见，这对于众多以数据为中心的应用至关重要。在以下因素的共同驱动下: (i) 对可直接用于应用的数据 (例如用于分析、可视化、决策) 的需求不断增长, (ii) 大语言模型技术日益强大, 以及 (iii) 便于灵活构建 AI 智能体的基础设施 (例如使用 Databricks Unity Catalog) 的出现, 基于大语言模型增强的方法正迅速成为数据准备领域一个变革性乃至主导性的范式。本文通过分析数百篇近期文献, 对这一快速发展领域进行了系统性综述, 重点关注如何利用大语言模型技术为各类下游任务准备数据。首先, 我们阐述了该领域的基本范式转变, 即从基于规则、模型特定的流水线转向提示驱动、上下文感知且由智能体驱动的工作流。接着, 我们提出了一个以任务为中心的分类体系, 将相关研究归纳为三大核心任务: 数据清洗 (例如标准化、错误修复、数据填补)、数据集成 (例如实体匹配、模式匹配) 以及数据丰富 (例如数据标注、数据画像)。针对每项任务, 我们综述了代表性技术, 并着重分析了它们各自的优势 (例如泛化能力提升、语义理解增强) 与局限性 (例如扩展大语言模型的高昂成本、即使在先进智能体中仍持续存在的幻觉问题、先进方法与薄弱评估之间的脱节)。此外, 我们还分析了常用的数据集与评估指标 (实证研究部分)。最后, 我们探讨了开放的研究挑战, 并勾勒了一个前瞻性路线图, 强调需关注可扩展的大语言模型与数据系统、可靠智能体工作流的 principled 设计以及稳健的评估协议。</p>
<h2 data-id="heading-1">LongCat-Flash-Thinking-2601 Technical Report</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.16725" target="_blank" title="https://arxiv.org/abs/2601.16725" ref="nofollow noopener noreferrer">LongCat-Flash-Thinking-2601 技术报告</a></p>
<p>我们介绍了 LongCat-Flash-Thinking-2601，这是一个拥有 5600 亿参数的开源混合专家 (Mixture-of-Experts, MoE) 推理模型，具备卓越的智能体推理能力。在广泛的智能体基准测试（包括智能体搜索、智能体工具使用和工具集成推理）中，LongCat-Flash-Thinking-2601 在开源模型中实现了最先进的性能。除了基准测试表现，该模型还展现出强大的泛化能力，能够处理复杂的工具交互，并在嘈杂的现实环境中保持鲁棒的行为。其先进能力源于一个统一的训练框架，该框架结合了领域并行专家训练与后续融合，并实现了从预训练到后训练阶段的数据构建、环境、算法和基础设施的端到端协同设计。具体而言，该模型在复杂工具使用方面的强大泛化能力，得益于我们对环境缩放和基于原则的任务构建的深入探索。为了优化长尾、偏斜的生成以及多轮智能体交互，并为了在跨越 20 多个领域的超过 10,000 个环境中实现稳定训练，我们系统地扩展了异步强化学习框架 DORA，以支持稳定高效的大规模多环境训练。此外，我们认识到现实任务本质上是嘈杂的，因此对现实世界的噪声模式进行了系统分析和分解，并设计了针对性的训练流程，明确地将这些不完美因素纳入训练过程，从而提升了模型在现实应用中的鲁棒性。为了进一步提升复杂推理任务的性能，我们引入了重型思考 (Heavy Thinking) 模式，该模式通过密集的并行思考同时扩展推理的深度和宽度，从而实现有效的测试时缩放。</p>
<h2 data-id="heading-2">Idea2Story: An Automated Pipeline for Transforming Research Concepts into Complete Scientific Narratives</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.20833" target="_blank" title="https://arxiv.org/abs/2601.20833" ref="nofollow noopener noreferrer">Idea2Story：一个将研究概念转化为完整科学叙事的自动化流水线</a></p>
<p>基于大语言模型 (LLM) 的 AI 智能体在自主科学发现领域近期取得了显著进展，展现了自动化端到端研究工作流程的能力。然而，现有系统主要采用运行时中心型的执行范式，需要反复在线读取、总结和推理海量科学文献。这种即时计算策略不仅计算成本高昂、受限于上下文窗口，还常常导致推理过程脆弱并产生幻觉。我们提出了 Idea2Story，一个预计算驱动型的自主科学发现框架，它将文献理解从在线推理迁移至离线知识构建。Idea2Story 持续收集同行评审论文及其评审反馈，提取核心方法论单元，组合成可重用的研究模式，并将其组织成一个结构化的方法论知识图谱。在运行时，系统将用户欠指定的研究意图与既定的研究范式进行对齐，从而实现高质量研究模式的高效检索与复用，而非依赖于开放式生成和试错。通过将研究规划与执行过程基于预构建的知识图谱，Idea2Story 缓解了大语言模型的上下文窗口瓶颈，并大幅减少了对文献的重复运行时推理。我们进行了定性分析和初步实证研究，结果表明 Idea2Story 能够生成连贯、方法扎实且新颖的研究模式，并能在端到端场景下产出多个高质量的研究示例。这些发现表明，离线知识构建为可靠、可扩展的自主科学发现提供了切实可行的基础。</p>
<h2 data-id="heading-3">daVinci-Dev: Agent-native Mid-training for Software Engineering</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.18418" target="_blank" title="https://arxiv.org/abs/2601.18418" ref="nofollow noopener noreferrer">daVinci-Dev：面向软件工程的智能体原生中期训练</a></p>
<p>近来，大语言模型（LLM）能力的前沿已从单轮代码生成转向基于智能体的软件工程——这是一种模型能够自主导航、编辑和测试复杂代码库的新范式。尽管后训练方法已成为代码智能体事实上的主流方法，但<strong>智能体中期训练</strong>——即在模拟真实智能体工作流程的大规模数据上进行的 Mid-training（MT）——虽然为培养基础智能体行为提供了一条比单纯依赖昂贵强化学习更具可扩展性的路径，但由于其巨大的资源需求，至今仍未得到充分探索。实现有效智能体中期训练的一个核心挑战在于静态训练数据与真实开发中动态、富含反馈的环境之间存在分布差异。为解决此问题，我们对智能体中期训练进行了系统性研究，建立了适用于大规模有效智能体开发的数据合成原则与训练方法。我们方法的核心在于<strong>智能体原生数据</strong>——这是一种包含两种互补类型轨迹的监督数据：<strong>上下文原生轨迹</strong>，其保留了智能体所经历的完整信息流，提供了广泛的覆盖面和多样性；以及<strong>环境原生轨迹</strong>，这些轨迹从可执行代码库中收集，其观测值来源于实际的工具调用和测试执行，从而提供了深度和交互真实性。我们在 <code>SWE-Bench Verified</code> 基准上验证了模型的智能体能力。在两种后训练设置下，使用对齐的基础模型和智能体框架，我们证明了我们的方法优于先前开放的软件工程中期训练方案 <code>Kimi-Dev</code>，同时所使用的中期训练 Token 数量不到后者的一半（73.1B）。除了相对优势，我们性能最佳的 32B 和 72B 模型分别实现了 <strong>56.1%</strong> 和 <strong>58.5%</strong> 的问题解决率，这一结果是...</p>
<h2 data-id="heading-4">AgentDoG: A Diagnostic Guardrail Framework for AI Agent Safety and Security</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.18491" target="_blank" title="https://arxiv.org/abs/2601.18491" ref="nofollow noopener noreferrer">AgentDoG：一个用于AI智能体安全与防护的诊断护栏框架</a></p>
<p>AI智能体的兴起，因其自主使用工具和与环境交互的特性，带来了复杂的安全与防护挑战。当前的护栏模型缺乏对智能体风险的认知，且在风险诊断方面透明度不足。为了构建一个能够覆盖复杂且多样风险行为的智能体护栏，我们首先提出了一种统一的三维分类法，该分类法从风险来源（何处）、失效模式（如何）和后果（什么）三个正交维度对智能体风险进行系统分类。在这一结构化、层次化的分类法指导下，我们提出了一个新的细粒度智能体安全基准（ATBench）以及一个用于智能体安全与防护的诊断护栏框架（AgentDoG）。AgentDoG能够对智能体的行为轨迹进行细粒度的、结合上下文的监控。更为关键的是，AgentDoG不仅能诊断不安全行为的根本原因，还能识别那些看似安全实则不合理的行动，提供超越简单二元判定的溯源信息和透明度，从而有效促进智能体对齐。AgentDoG提供了基于Qwen和Llama模型系列的三种参数规模变体（4B、7B和8B）。大量实验结果表明，在多样且复杂的交互场景中，AgentDoG在智能体安全审核方面达到了最先进的性能。所有模型和数据集均已开源发布。</p>
<h2 data-id="heading-5">Harder Is Better: Boosting Mathematical Reasoning via Difficulty-Aware GRPO and Multi-Aspect Question Reformulation</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.20614" target="_blank" title="https://arxiv.org/abs/2601.20614" ref="nofollow noopener noreferrer">Harder Is Better: 通过难度感知 GRPO 与多角度问题改写提升数学推理能力</a></p>
<p>具备可验证奖励的强化学习 (Reinforcement Learning with Verifiable Rewards, RLVR) 为提升大型语言模型的数学推理能力提供了一种稳健的机制。然而，我们发现，尽管更具挑战性的问题对于完善模型的能力短板至关重要，但现有方法在算法和数据层面均未给予这类问题足够的重视。在算法层面，广泛使用的组相对策略优化 (Group Relative Policy Optimization, GRPO) 存在一种隐含的不平衡性：对于更难的问题，其策略更新量往往较低。在数据层面，现有的增强方法主要通过改写问题来增加多样性，并未系统性地提升问题的内在难度。为解决这些问题，我们提出了一个双管齐下的 MathForge 框架，旨在从算法和数据两个维度聚焦于更难的问题，以提升数学推理能力。该框架包含一个难度感知组策略优化 (Difficulty-Aware Group Policy Optimization, DGPO) 算法和一个多角度问题改写 (Multi-Aspect Question Reformulation, MQR) 策略。具体而言，DGPO 首先通过难度平衡的组优势估计来修正 GRPO 中的隐含不平衡，并进一步通过难度感知的问题级加权，给予更难的问题更高的学习优先级。同时，MQR 从多个角度对问题进行改写，在保持原始标准答案不变的前提下，系统地增加问题的难度。总体而言，MathForge 形成了一个协同增效的良性循环：MQR 拓展了数据的边界，而 DGPO 则能有效地从这些增强数据中学习。大量实验表明，MathForge 在多种数学推理任务上均显著优于现有方法。代码及增强数据均已公开在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAMAP-ML%2FMathForge%25E3%2580%2582" target="_blank" title="https://github.com/AMAP-ML/MathForge%E3%80%82" ref="nofollow noopener noreferrer">github.com/AMAP-ML/Mat…</a></p>
<h2 data-id="heading-6">Everything in Its Place: Benchmarking Spatial Intelligence of Text-to-Image Models</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.20354" target="_blank" title="https://arxiv.org/abs/2601.20354" ref="nofollow noopener noreferrer">万物归位：评估文本到图像模型的空间智能</a></p>
<p>文本到图像 (T2I) 模型在生成高保真度图像方面已取得显著成功，但在处理复杂空间关系（如空间感知、推理或交互）时往往表现不佳。由于现有基准测试的提示设计通常较为简短或信息稀疏，这些关键方面在很大程度上被忽视了。为此，本文提出了 SpatialGenEval，这是一个旨在系统评估 T2I 模型空间智能的新基准，主要涵盖两个方面：(1) SpatialGenEval 包含了涵盖 25 个真实世界场景的 1,230 个长且信息密集的提示。每个提示整合了 10 个空间子领域及其对应的 10 个多项选择题-答案对，内容涵盖物体位置、布局、遮挡及因果关系等多个方面。我们对 21 个前沿模型进行了全面评估，结果表明高阶空间推理仍是其主要瓶颈。(2) 为了证明我们信息密集设计的价值不仅限于评估，我们还构建了 SpatialT2I 数据集。该数据集包含 15,400 个文本-图像对，其中的提示经过重写，在保持信息密度的同时确保了与图像内容的一致性。基于当前主流基础模型（即 Stable Diffusion-XL、Uniworld-V1、OmniGen2）的微调实验显示，模型性能获得了稳定提升（分别提升 +4.2%、+5.7%、+4.4%），并且在空间关系上呈现出更逼真的效果，这凸显了通过以数据为中心的方法来实现 T2I 模型空间智能的潜力。</p>
<h2 data-id="heading-7">Advancing Open-source World Models</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.20540" target="_blank" title="https://arxiv.org/abs/2601.20540" ref="nofollow noopener noreferrer">推进开源世界模型</a></p>
<p>我们推出 LingBot-World，一个基于视频生成的开源世界模拟器。它定位为顶级世界模型，具备以下特性。(1) 在包括写实、科学场景、卡通风格等在内的广泛环境中，均能保持高保真度与稳健的动态特性。(2) 支持分钟级的模拟时长，并能随时间保持上下文一致性，即具备"长期记忆"能力。(3) 支持实时交互，在以每秒16帧的速率生成时，可实现低于1秒的延迟。我们公开了代码和模型，以期缩小开源与闭源技术之间的差距。我们相信，此次发布将助力社区在内容创作、游戏及机器人学习等领域实现实际应用。</p>
<h2 data-id="heading-8">SWE-Pruner: Self-Adaptive Context Pruning for Coding Agents</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.16746" target="_blank" title="https://arxiv.org/abs/2601.16746" ref="nofollow noopener noreferrer">SWE-Pruner: 面向编码智能体的自适应上下文剪枝</a></p>
<p>大语言模型智能体在软件开发中已展现出卓越能力，但其性能常受限于冗长的交互上下文，这会带来高昂的 API 调用成本和延迟。尽管已有多种上下文压缩方法 (如 LongLLMLingua) 出现以应对此问题，但它们通常依赖固定指标 (如 PPL)，而忽略了代码理解的任务特定性。因此，这些方法往往会破坏代码的语法和逻辑结构，且无法保留关键的实现细节。本文提出 SWE-Pruner，一个专为编码智能体设计的自适应上下文剪枝框架。该框架受人类程序员在开发与调试过程中"选择性浏览"源代码的启发，能够对长上下文进行任务感知的自适应剪枝。具体而言，针对当前任务，智能体会制定一个明确的目标 (例如 "聚焦于错误处理") 作为提示，用以指导剪枝过程。我们训练了一个轻量级神经浏览模型 (参数量 0.6B)，使其能够依据给定目标，从周边上下文中动态筛选出相关的代码行。在四个基准测试集和多个模型上的评估结果表明，SWE-Pruner 在各种场景下均表现有效：在 SWE-Bench Verified 等智能体任务上，它能减少 23-54% 的 Token 消耗；在 LongCodeQA 等单轮任务上，则能实现高达 14.84 倍的压缩率，同时性能影响微乎其微。</p>
<h2 data-id="heading-9">Scaling Embeddings Outperforms Scaling Experts in Language Models</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.21204" target="_blank" title="https://arxiv.org/abs/2601.21204" ref="nofollow noopener noreferrer">在语言模型中扩展嵌入优于扩展专家</a></p>
<p>虽然专家混合 (Mixture-of-Experts, MoE) 架构已成为大语言模型中稀疏性扩展的标准方法，但它们正日益面临收益递减和系统级瓶颈。在本工作中，我们探索将嵌入扩展作为一种强大且正交的维度，用于实现稀疏性扩展。通过全面的分析和实验，我们确定了在特定条件下，嵌入扩展相较于专家扩展能够实现更优帕累托边界。我们系统地分析了决定此效能的关键架构因素，包括参数预算、以及与模型宽度和深度的相互作用。此外，通过整合定制的系统优化和推测解码 (Speculative Decoding)，我们有效地将这种稀疏性转化为显著的推理加速。基于这些见解，我们推出了 LongCat-Flash-Lite 模型，这是一个拥有 685 亿参数、激活参数约 30 亿、从头开始训练的模型。尽管将超过 300 亿参数分配给了嵌入，LongCat-Flash-Lite 不仅超越了参数等效的 MoE 基线模型，而且在智能体和编码领域，与现有同等规模的模型相比，展现出了卓越的竞争力。</p>
<h2 data-id="heading-10">Innovator-VL: A Multimodal Large Language Model for Scientific Discovery</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.19325" target="_blank" title="https://arxiv.org/abs/2601.19325" ref="nofollow noopener noreferrer">Innovator-VL：一个用于科学发现的多模态大语言模型</a></p>
<p>我们提出了 Innovator-VL，这是一个面向科学领域的多模态大语言模型，旨在提升对多种科学领域的理解与推理能力，同时在通用视觉任务上保持优异性能。与当前依赖海量领域特定预训练及不透明流程的趋势不同，我们的研究表明，基于原则的训练设计和透明的方法论，能够以大幅降低的数据需求实现强大的科学智能。具体贡献如下：(i) 首先，我们提供了一个完全透明、端到端可复现的训练流程，包括数据收集、清洗、预处理、监督微调、强化学习、评估以及详细的优化方案，便于社区进行系统性复现与扩展。(ii) 其次，Innovator-VL 展现出卓越的数据效率，在未进行大规模预训练的情况下，仅使用少于五百万的精选样本，便在多种科学任务上取得了具有竞争力的性能。这一结果凸显了通过原则性数据选择（而非盲目规模扩张）来实现有效推理的可行性。(iii) 第三，Innovator-VL 表现出强大的泛化能力，在通用视觉、多模态推理以及科学基准测试中均达到了有竞争力的水平。这表明，将科学任务对齐能力集成到统一模型中，并不会削弱其通用性能。我们的实践表明，即使不依赖大规模数据，也能构建出高效、可复现且高性能的科学多模态模型，这为未来的研究奠定了坚实基础。</p>
<h2 data-id="heading-11">TwinBrainVLA: Unleashing the Potential of Generalist VLMs for Embodied Tasks via Asymmetric Mixture-of-Transformers</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.14133" target="_blank" title="https://arxiv.org/abs/2601.14133" ref="nofollow noopener noreferrer">通过非对称混合Transformer机制释放通用VLM在具身任务中的潜力</a></p>
<p>标准的视觉-语言-动作 (VLA) 模型通常通过微调一个单一的视觉-语言模型 (VLM) 主干网络来专门实现机器人控制。然而，这种方法在维持高级通用语义理解与学习低级、细粒度的感觉运动技能之间产生了核心矛盾，常常导致模型出现开放世界能力的“灾难性遗忘”。为解决这一冲突，我们提出了 TwinBrainVLA，这是一种新颖的架构。它协调了一个保留通用语义理解的通用 VLM 与一个专精于具身本体感知的专用 VLM，以进行联合机器人控制。TwinBrainVLA 通过一种新颖的非对称混合Transformer (Asymmetric Mixture-of-Transformers, AsyMoT) 机制，将一个保持强大通用视觉推理能力的冻结“左脑”与一个专为具身感知设计的可训练“右脑”高效协同。该设计使得右脑能够动态地从冻结的左脑中查询语义知识，并将其与本体感知状态融合，从而为流匹配动作专家 (Flow-Matching Action Expert) 生成精确的连续控制提供了丰富的条件信息。在 SimplerEnv 和 RoboCasa 基准上进行的大量实验表明，与最先进的基线模型相比，TwinBrainVLA 实现了更优的操作性能，同时明确保留了预训练 VLM 的全面视觉理解能力。这为构建同时具备高级语义理解和低级物理灵巧性的通用机器人指明了一个有前景的方向。</p>
<h2 data-id="heading-12">The Script is All You Need: An Agentic Framework for Long-Horizon Dialogue-to-Cinematic Video Generation</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.17737" target="_blank" title="https://arxiv.org/abs/2601.17737" ref="nofollow noopener noreferrer">剧本即所需：一种面向长跨度对话到电影视频生成的智能体框架</a></p>
<p>近期视频生成技术的进展催生了许多模型，它们能够根据简单的文本提示合成视觉效果惊人的内容。然而，这些模型难以基于对话这类高层级概念生成篇幅较长且连贯的叙事，这暴露出创意构思与其电影化呈现之间存在“语义鸿沟”。为弥合此鸿沟，我们提出了一种新颖的、端到端的智能体框架，用于从对话生成电影视频。该框架的核心是 ScripterAgent，它是一个经过训练的模型，能够将粗略的对话转化为细粒度、可执行的电影剧本。为此，我们构建了 ScriptBench，这是一个包含丰富多模态上下文信息的大规模新基准数据集，其标注工作通过专家指导的流程完成。生成的剧本随后用于指导 DirectorAgent，后者采用跨场景连续生成策略来协调调度多个最先进的视频模型，以确保长跨度叙事的一致性。我们进行了全面的评估，其中包含一个由 AI 驱动的 CriticAgent 以及一个新提出的视觉-剧本对齐 (VSA) 指标。评估结果表明，我们的框架显著提升了所有被测视频模型在剧本忠实度和时间保真度方面的表现。此外，我们的分析揭示了当前最先进模型在追求视觉奇观与严格遵循剧本之间存在关键权衡，这为自动化电影制作的未来发展提供了有价值的见解。</p>
<h2 data-id="heading-13">DynamicVLA: A Vision-Language-Action Model for Dynamic Object Manipulation</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.22153" target="_blank" title="https://arxiv.org/abs/2601.22153" ref="nofollow noopener noreferrer">DynamicVLA：用于动态物体操作的视觉-语言-动作模型</a></p>
<p>动态物体操作对视觉-语言-动作 (VLA) 模型而言仍是一个开放挑战。这类模型虽然在静态操作中泛化能力很强，但在需要快速感知、时序预测和连续控制的动态场景中却表现不佳。我们提出了 DynamicVLA，这是一个用于动态物体操作的框架，它通过三项关键设计整合了时序推理和闭环适应能力：1) 一个紧凑的 0.4B 参数 VLA 模型，采用卷积视觉编码器进行空间高效且结构保真的编码，从而实现快速的多模态推理；2) 连续推理机制，通过重叠推理与执行来降低延迟，并及时适应物体运动；3) 潜在感知动作流技术，通过强制执行时间对齐的动作来弥合感知与执行之间的差距。为了填补动态操作数据基础的缺失，我们引入了动态物体操作 (DOM) 基准。该基准从头构建，采用自动数据收集流程，高效采集了涵盖 2.8K 个场景和 206 个物体的 20 万条合成交互片段，并能快速收集 2K 条无需遥操作的真实世界片段。大量评估结果表明，DynamicVLA 在响应速度、感知能力和泛化性能上均有显著提升，使其成为一个适用于跨具身通用动态物体操作的统一框架。</p>
<h2 data-id="heading-14">AdaReasoner: Dynamic Tool Orchestration for Iterative Visual Reasoning</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2601.18631" target="_blank" title="https://arxiv.org/abs/2601.18631" ref="nofollow noopener noreferrer">AdaReasoner: 面向迭代视觉推理的动态工具编排</a></p>
<p>当人类遇到超出自身即时能力的问题时，往往会借助工具。这为提高多模态大语言模型 (MLLMs) 的视觉推理能力提供了一个极具前景的范式。有效的推理，关键在于知道在何时、选用何种工具，以及如何在多步骤中组合这些工具，即使面对新工具或新任务时也应如此。为此，我们提出了 <strong>AdaReasoner</strong> 模型家族，其核心在于将工具使用学习为一种通用的推理技能，而非针对特定工具或依赖于显式监督的行为。AdaReasoner 的实现基于三个关键组件：(i) 一个可扩展的数据整理流程，让模型能够学习长视野、多步骤的工具交互；(ii) Tool-GRPO 强化学习算法，该算法根据最终任务的成功率来优化工具的选择与调用顺序；(iii) 一种能够动态调节工具使用的自适应学习机制。这些组件协同工作，使模型能够根据任务上下文和中间结果推断工具的效用，从而协调多个工具的使用，并泛化至未见过的工具。实证结果表明，AdaReasoner 展现出强大的工具自适应和泛化能力：它能自主采纳有益的工具、抑制无关工具，并根据任务需求调整工具使用频率，尽管模型从未被明确训练去执行这些行为。这些能力使其在多个具有挑战性的基准测试中取得了最先进的性能：它将 7B 基础模型的平均性能提升了 24.9%，并在包括 VSP 和 Jigsaw 在内的多项任务上超越了 GPT-5 等强大的闭源模型系统。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀OpenClaw/Moltbot自动进化技巧分享！打造全自动智能超级助手，彻底解放双手，让AI越用越聪明！能自动学习避坑！OpenClaw自动操控Claud]]></title>    <link>https://juejin.cn/post/7601169987411804198</link>    <guid>https://juejin.cn/post/7601169987411804198</guid>    <pubDate>2026-01-31T14:21:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601169987411804198" data-draft-id="7601169987411787814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀OpenClaw/Moltbot自动进化技巧分享！打造全自动智能超级助手，彻底解放双手，让AI越用越聪明！能自动学习避坑！OpenClaw自动操控Claud"/> <meta itemprop="keywords" content="AIGC,OpenAI,AI编程"/> <meta itemprop="datePublished" content="2026-01-31T14:21:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="win4r"/> <meta itemprop="url" content="https://juejin.cn/user/1739869037541555"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀OpenClaw/Moltbot自动进化技巧分享！打造全自动智能超级助手，彻底解放双手，让AI越用越聪明！能自动学习避坑！OpenClaw自动操控Claud
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739869037541555/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    win4r
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T14:21:02.000Z" title="Sat Jan 31 2026 14:21:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深度体验OpenClaw：这才是AI超级助理该有的样子</h2>
<p>大家好，今天为大家分享一下OpenClaw这个项目的真实使用场景和使用技巧。</p>
<p>🔥🔥🔥<strong>本篇笔记所对应的视频：</strong> ****<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV17B61BxE3h%2F" target="_blank" title="https://www.bilibili.com/video/BV17B61BxE3h/" ref="nofollow noopener noreferrer"><strong>https://www.bilibili.com/video/BV17B61BxE3h/</strong>****</a></p>
<p>先说一下这个项目的更名历程，前几天这个项目还叫ClawdBot，然后改名成了MoltBot，昨天又从MoltBot改成了OpenClaw。所以本文我们就按照最新的名字OpenClaw来称呼它。</p>
<p>通过我这几天的深度使用，最大的感受就是——<strong>OpenClaw更像是一个超级助理</strong>。它并不是单单给Claude Code加了个即时通讯软件这么简单，因为OpenClaw它具有持久的记忆与定时任务功能，而且还能通过Home Assistant来控制智能家居。更厉害的是，它还可以实现边执行任务边学习，能够记住之前踩的坑以及遇到的问题，并且能够将经验同步更新到对应的Skill中。</p>
<h3 data-id="heading-1">关于安全性，完全不用担心</h3>
<p>大家可能担心OpenClaw的安全问题，这个担心是完全没必要的。</p>
<p>通过我这几天高强度的测试，让OpenClaw执行各种敏感操作，比如说让它来执行<code>rm -rf /</code>这条命令，然后OpenClaw它能准确识别到执行这条命令会将系统根目录下的所有文件全部删除，等同于自毁服务器，所以它直接拒绝执行。</p>
<p>还有就是我让它显示存储API Key的配置文件里的内容，然后OpenClaw它能很智能地知道这个文件里的内容是敏感内容，不能透露给我们。然后我让它直接将这个文件发送给我，它也不会直接将文件发送给我，而是只发给我配置结构，并不会将这些API Key等敏感内容发送给我。</p>
<p>所以自媒体上那些说OpenClaw删除了他们的数据或者删除了他们文件的说法，我感觉都是为了流量故意编造的一些引人转发的话题。</p>
<h3 data-id="heading-2">我用OpenClaw实现了什么？</h3>
<p>我用OpenClaw实现了<strong>自动发X Post</strong>的功能，而且还实现了<strong>每天早上8点准时为我生成与AI相关的英文播客</strong>。当它生成好英文播客，就会自动推送给我这个音频文件，然后我只需要点击播放就可以了。像这样的话，我们每天早上就可以听OpenClaw为我们生成的与AI相关的英文播客来练习英语听力。</p>
<p>我甚至还实现了<strong>让OpenClaw操控Claude Code</strong>，通过SpecKit实现规格驱动开发。也就是整个操作流程都由OpenClaw来操控，Claude Code通过SpecKit实现规格驱动开发，整个过程都不需要我们手动去干预。</p>
<p>当OpenClaw完成整个操作流程之后，它就会学习到这些操作技巧和操作经验，并且我们可以让它将学习到的经验直接写入到对应的Skill中。这样的话，它下次再帮我们去操作Claude Code，就能够读取Skill中积累的这些经验和技巧。</p>
<p>通过不断迭代对应的Skill以及OpenClaw的记忆，所以OpenClaw它更像一个<strong>能够自动进化的AI智能体</strong>，越用越聪明。</p>
<h3 data-id="heading-3">为什么我选择GPT-5.2模型</h3>
<p>为了让OpenClaw更聪明，我这里使用了GPT-5.2模型。因为通过我这几天的测试，发现使用GPT-5.2可以完成更加复杂的任务。之所以没有用Claude模型，是因为我怕被Claude给封号。</p>
<h3 data-id="heading-4">三大核心Skill详解</h3>
<p>为了让OpenClaw能够自动生成播客、能够为我发X Post、还有能够为我调用Claude Code通过SpecKit实现规格驱动开发，为了实现这些功能，每一个功能我都写了一个Skill来实现对应的场景：</p>
<p><strong>第一个Skill</strong>是用来在Claude Code或者在OpenClaw中实现自动发布X Post的。</p>
<p><strong>第二个Skill</strong>是用来生成每日英文播客的。大家也可以将这个Skill改成让它生成中文播客，因为我是为了练习英语听力，所以默认让它生成英文播客。这个Skill的功能就是它能将任何一个链接里的文章内容来生成播客风格的MP3。</p>
<p><strong>第三个Skill</strong>就是在OpenClaw中来调用Claude Code，用SpecKit或者OpenSpec实现真正的规格驱动开发。</p>
<h3 data-id="heading-5">播客生成实战演示</h3>
<p>我们可以在OpenClaw中来测试一下这个能够自动生成播客的Skill。比如说我们随便找一篇科技文章，直接复制这个文章的链接，再回到我们的聊天软件，就可以直接输入提示词：</p>
<blockquote>
<p>"将这篇文章通过播客Skill生成英文播客"</p>
</blockquote>
<p>然后直接发送，它就很快为我们生成了这个播客。这样的话，我们就实现了在OpenClaw中为我们生成播客。</p>
<p>然后我们还可以将它设置成定时任务，让它每天早上七点自动生成一篇播客推送给我。它会从指定的RSS里选一篇文章来生成英文播客并且推送给我。</p>
<h3 data-id="heading-6">操控Claude Code实现规格驱动开发</h3>
<p>下面我们测试一下使用Claude Code这个Skill，让OpenClaw直接操控Claude Code，通过SpecKit或者OpenSpec这两个规格驱动开发的工作流，在Claude Code中实现真正的规格驱动开发。</p>
<p>我输入的提示词是：</p>
<blockquote>
<p>"调用Claude Code，使用OpenSpec开发一个X风格的私人日记的Web应用，要求具有简单的发送输入框、无限滚动时间线、情绪标签、图片上传、日历快速跳转、去年今日回顾的功能"</p>
</blockquote>
<p>然后直接发送，看一下它能否通过这个Skill来调用Claude Code为我们完成这个项目的开发。</p>
<h3 data-id="heading-7">Skill迭代的核心方法论</h3>
<p>让我来分享一下我是如何在OpenClaw中通过不断试错、不断迭代，最后完善了这个调用Claude Code的Skill。</p>
<p>首先最简单的方式是我将Claude Code的官方文档发送给了OpenClaw，然后告诉它让它深度阅读Claude Code的官方文档，然后创建一个OpenClaw可以调用的Skill。紧接着它就阅读了文档并且很快开发好了能够调用Claude Code的这个Skill。</p>
<p>在测试过程中遇到报错，我将报错发送给它让它去修复，经过几轮迭代它就修复了。然后我告诉它让它通过Claude Code使用SpecKit的完整步骤和技巧，更新到Claude Code的Skill中。紧接着它就更新了这个Skill。</p>
<p><strong>核心流程就是：</strong></p>
<p>我们来提出需求 → 让OpenClaw来执行 → 观察和测试是否会报错 → 如果报错就进行调试 → 最后将报错踩的这些坑和总结的这些经验编写为Skill → 将Skill推送到GitHub → 再重复测试这个Skill → 再进行观察和调试 → 再不断更新这个Skill → 再推送再重复测试</p>
<p>通过这个循环让OpenClaw持续迭代对应的Skill，最后得到一个非常完善且非常高效的Skill。</p>
<h3 data-id="heading-8">让AI记住经验，越用越聪明</h3>
<p>每当OpenClaw完成一个复杂任务后，我都会让它将学习到的经验存储到记忆文件里，同时更新到对应的Skill中。这样的话：</p>
<ol>
<li>它的记忆库会不断积累使用技巧</li>
<li>对应的Skill会不断完善</li>
<li>下次执行类似任务时就能直接读取这些经验</li>
</ol>
<p>当对应的Skill迭代到一定程度的时候，OpenClaw就可以通过对应的Skill来轻松完成我们交给它的任务。</p>
<h3 data-id="heading-9">最终效果展示</h3>
<p>运行之后我们就看到了它调用Claude Code使用OpenSpec为我们开发了这个X风格的私人日记应用。而且还自动生成了一些测试数据，我们可以随便输入内容测试，选择情绪标签，点击记录就发送成功了。</p>
<p>像这样的话，这个项目就完全是OpenClaw通过Claude Code这个Skill，用OpenSpec规格驱动开发来完成的项目开发。</p>
<hr/>
<p><strong>总结一下</strong>，OpenClaw不仅仅是一个即时通讯机器人，它是一个能够：</p>
<ul>
<li>跨平台使用（WhatsApp、Telegram、Slack、Discord等）</li>
<li>持久记忆并不断学习</li>
<li>通过Skill系统无限扩展能力</li>
<li>安全可靠地执行各种任务</li>
<li>越用越聪明的AI超级助理</li>
</ul>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoltbot%2Fmoltbot" target="_blank" title="https://github.com/moltbot/moltbot" ref="nofollow noopener noreferrer">github.com/moltbot/mol…</a></p>
<p>如果你也想拥有这样一个能够自动进化的AI智能体，强烈推荐去试试OpenClaw。</p>
<p>本期分享就到这里，欢迎大家点赞关注和转发，谢谢大家观看！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue-Data 属性避坑指南]]></title>    <link>https://juejin.cn/post/7601169987411820582</link>    <guid>https://juejin.cn/post/7601169987411820582</guid>    <pubDate>2026-01-31T14:34:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601169987411820582" data-draft-id="7601041482892820530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue-Data 属性避坑指南"/> <meta itemprop="keywords" content="前端,面试,Vue.js"/> <meta itemprop="datePublished" content="2026-01-31T14:34:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue-Data 属性避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T14:34:12.000Z" title="Sat Jan 31 2026 14:34:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在 Vue 开发中，我们经常会遇到“明明修改了数据，视图却不更新”的尴尬场景。这通常与 Vue 的初始化顺序及响应式实现原理有关。本文将从 Data 属性的本质出发，解析响应式“丢失”的根本原因及解决方案。</p>
<h2 data-id="heading-1">一、 组件中的 Data 为什么必须是函数？</h2>
<p>在 Vue 2 中，根实例的 <code>data</code> 可以是对象，但<strong>组件中的 <code>data</code> 必须是函数</strong>。</p>
<h3 data-id="heading-2">核心原因：数据隔离</h3>
<ul>
<li><strong>对象形式</strong>：JavaScript 中的对象是引用类型。如果 <code>data</code> 是对象，所有组件实例将共享同一个内存地址。修改实例 A 的数据，实例 B 也会跟着变。</li>
<li><strong>函数形式</strong>：当 <code>data</code> 是一个函数时，每次创建新实例，Vue 都会调用该函数，返回一个<strong>全新的数据对象拷贝</strong>。这保证了每个组件实例数据的独立性。</li>
</ul>
<hr/>
<h2 data-id="heading-3">二、 Props 与 Data 的优先级之争</h2>
<p>在组件初始化时，Vue 会按照特定的顺序处理选项。</p>
<h3 data-id="heading-4">初始化顺序</h3>
<blockquote>
<p><strong>Props</strong> → <strong>Methods</strong> → <strong>Data</strong> → <strong>Computed</strong> → <strong>Watch</strong></p>
</blockquote>
<p>因为 <code>Props</code> 最先被初始化，<strong>所以我们可以在 <code>data</code> 中直接引用 <code>props</code> 传来的值</strong>：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// Vue 3 + TS 示例</span>
<span class="hljs-keyword">const</span> props = defineProps&lt;{ <span class="hljs-attr">initialCount</span>: <span class="hljs-built_in">number</span> }&gt;();
<span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(props.<span class="hljs-property">initialCount</span>); <span class="hljs-comment">// 合法，因为 props 优先初始化</span>
</code></pre>
<hr/>
<h2 data-id="heading-5">三、 Vue2动态添加新属性的“失效”困局</h2>
<h3 data-id="heading-6">1. 故障场景</h3>
<p>vue2中当我们直接给对象添加一个原本不存在的属性时，视图不会产生任何变化。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;p v-for="(value,key)in item" :key="key"&gt;
    {{ value }}
&lt;/p&gt;
&lt;button@click="addProperty"&gt;动态添加新属性&lt;/button&gt;

const app = new Vue({
  el: '#app',
  data: {
    item: {
      oldProperty: 'l日属性'
    }
  },
  methods: {
    addProperty() {
      this.items.newProperty = '新属性'; // 为items添加新属性
      console.log(this.items); // 输出带有newProperty的items
    }
  }
})
</code></pre>
<h3 data-id="heading-7">2. 原因剖析</h3>
<ul>
<li><strong>Vue 2 局限性</strong>：使用 <code>Object.defineProperty</code> 实现响应式。它只能劫持对象<strong>已有的</strong>属性。对于后来新增的属性，Vue 无法感知其 <code>getter/setter</code>，因此无法触发视图更新。</li>
<li><strong>Vue 3 的进化</strong>：改用 <code>Proxy</code> 代理整个对象。<code>Proxy</code> 可以拦截到属性的新增与删除，因此 Vue 3 不再有这个问题。</li>
</ul>
<hr/>
<h2 data-id="heading-8">四、 解决方案（Vue 2 必备技巧）</h2>
<p>如果你仍在使用 Vue 2，可以通过以下三种方式解决：</p>
<h3 data-id="heading-9">1. 推荐方案：<code>Vue.set</code> / <code>this.$set</code></h3>
<p>这是最正统的方法，它会手动将新属性转为响应式，并触发依赖更新。</p>
<blockquote>
<p><strong>语法：</strong> <code>this.$set(target, propertyName/index, value)</code></p>
</blockquote>
<ul>
<li><code>target</code>：data中要修改的对象或者数组</li>
<li><code>propertyName/index</code>：要添加或修改的属性名称（对于对象）或索引（对于数组）</li>
<li><code>value</code>：要设置的值</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">addProperty</span>(<span class="hljs-params"/>) {
   <span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>, <span class="hljs-string">'newProperty'</span>, <span class="hljs-string">'新属性'</span>); 
}
</code></pre>
<h3 data-id="heading-10">2. 对象整体替换：<code>Object.assign</code></h3>
<p>通过创建一个包含新属性的新对象，并将这个新对象赋值给原有对象,触发 Vue 对原对象引用的变更感知。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">addProperty</span>(<span class="hljs-params"/>) {
   <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>, { <span class="hljs-attr">newProperty</span>: <span class="hljs-string">'新属性'</span> });
   <span class="hljs-comment">// 或者使用展开运算符</span>
   <span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span> = { ...<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>, <span class="hljs-attr">newProperty</span>: <span class="hljs-string">'新属性'</span> };
}
</code></pre>
<h3 data-id="heading-11">3. 暴力方案：<code>$forceUpdate</code></h3>
<p>迫使 Vue 重新渲染组件。</p>
<ul>
<li><strong>注意</strong>：这只是“治标”。虽然视图刷新了，但该属性<strong>依然不是响应式的</strong>。后续再次修改 <code>newProperty</code> 时，视图依然不会动。</li>
</ul>
<hr/>
<h2 data-id="heading-12">五、 Vue 3 + TS 最佳实践</h2>
<p>在 Vue 3 中，借助 TypeScript 的类型定义，我们可以规避大部分因“动态添加”导致的逻辑混乱。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { reactive } from 'vue';

// 定义接口，提前声明可选属性
interface Item {
  oldProperty: string;
  newProperty?: string; // 声明可选属性
}

const item = reactive&lt;Item&gt;({
  oldProperty: '旧属性'
});

const addProperty = () =&gt; {
  // Vue 3 Proxy 自动处理响应式，无需 $set
  item.newProperty = '新属性'; 
};
&lt;/script&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JSyncQueue——一个开箱即用的鸿蒙异步任务同步队列]]></title>    <link>https://juejin.cn/post/7601073900525223978</link>    <guid>https://juejin.cn/post/7601073900525223978</guid>    <pubDate>2026-01-31T14:55:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601073900525223978" data-draft-id="7601076694104375332" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JSyncQueue——一个开箱即用的鸿蒙异步任务同步队列"/> <meta itemprop="keywords" content="HarmonyOS,TypeScript,Android"/> <meta itemprop="datePublished" content="2026-01-31T14:55:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江澎涌"/> <meta itemprop="url" content="https://juejin.cn/user/1820446986338504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JSyncQueue——一个开箱即用的鸿蒙异步任务同步队列
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1820446986338504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江澎涌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T14:55:40.000Z" title="Sat Jan 31 2026 14:55:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">零、JSyncQueue</h2>
<p>JSyncQueue 是一个开箱即用的鸿蒙异步任务同步队列。</p>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FzincPower%2FJSyncQueue" target="_blank" title="https://github.com/zincPower/JSyncQueue" ref="nofollow noopener noreferrer">github.com/zincPower/J…</a></p>
<h2 data-id="heading-1">一、JSyncQueue 有什么作用</h2>
<p>在鸿蒙应用开发中，有时需要让多个异步任务按顺序执行，例如状态的转换处理，如果不加控制，会因为执行顺序混乱而产生一些莫名其妙的问题。 所以 <code>JSyncQueue</code> 提供了一个简洁的解决方案：</p>
<ul>
<li><strong>保证顺序执行</strong>：所有任务严格按照入队顺序执行，即使任务内部有异步操作也能保证顺序</li>
<li><strong>两种执行模式</strong>：支持 "立即执行" 和 "延时执行" 两种模式，可以满足不同场景需求</li>
<li><strong>两种任务类型</strong>：支持向同步队列添加 "Message 类型任务" 和 "Runnable 类型任务"</li>
<li><strong>任务取消和管理</strong>：可随时取消指定任务或清空整个队列</li>
<li><strong>获取任务结果</strong>：通过任务的 <code>getResult()</code> 获取执行结果</li>
</ul>
<p>项目架构如下图所示：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4fcd88072de4f9da8ff3d1c7fcd252f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rGf5r6O5raM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770476139&amp;x-signature=P4ubIEk%2Fg3o%2BgFBgiyrcXeg8rBU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">二、如何安装 JSyncQueue</h2>
<p><strong>第一种方式：</strong> 在需要使用 <code>JSyncQueue</code> 的模块中运行以下命令</p>
<pre><code class="hljs language-bash" lang="bash">ohpm install jsyncqueue
</code></pre>
<p><strong>第二种方式：</strong> 在需要使用 <code>JSyncQueue</code> 的模块 <code>oh-package.json5</code> 中添加以下依赖</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sample"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Please describe the basic information."</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"author"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"license"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"jsyncqueue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span> <span class="hljs-comment">// 添加这一行，请根据需要修改版本号</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-3">三、JSyncQueue API 介绍</h2>
<h3 data-id="heading-4">3-1、JSyncQueue 类</h3>
<h4 data-id="heading-5">构造函数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">constructor</span>(<span class="hljs-params">queueName: <span class="hljs-built_in">string</span></span>)
</code></pre>
<p>创建一个同步队列实例。</p>
<ul>
<li><code>queueName</code>: 队列名称，用于标识和调试</li>
</ul>
<h4 data-id="heading-6">方法</h4>



























































<table><thead><tr><th>方法</th><th>参数</th><th>返回值</th><th>说明</th></tr></thead><tbody><tr><td><code>post(runnable)</code></td><td><code>runnable: (taskId: number) =&gt; Promise&lt;Any&gt;</code></td><td><code>Task</code></td><td>立即执行闭包</td></tr><tr><td><code>postDelay(runnable, delay)</code></td><td><code>runnable: (taskId: number) =&gt; Promise&lt;Any&gt;</code>, <code>delay: number</code></td><td><code>Task</code></td><td>延时 delay 毫秒执行闭包</td></tr><tr><td><code>sendMessage(message)</code></td><td><code>message: Message</code></td><td><code>Task</code></td><td>立即发送消息</td></tr><tr><td><code>sendMessageDelay(message, delay)</code></td><td><code>message: Message</code>, <code>delay: number</code></td><td><code>Task</code></td><td>延时 delay 毫秒发送消息</td></tr><tr><td><code>cancel(taskId)</code></td><td><code>taskId: number</code></td><td><code>void</code></td><td>取消指定任务</td></tr><tr><td><code>clear()</code></td><td>-</td><td><code>void</code></td><td>清空队列中所有等待的任务</td></tr><tr><td><code>dumpInfo()</code></td><td>-</td><td><code>string</code></td><td>获取队列调试信息</td></tr><tr><td><code>onHandleMessage(message, taskId)</code></td><td><code>message: Message</code>, <code>taskId: number</code></td><td><code>Promise&lt;Any&gt;</code></td><td>消息处理方法，子类可重写</td></tr></tbody></table>
<h4 data-id="heading-7">属性</h4>




















<table><thead><tr><th>属性</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>queueName</code></td><td><code>string</code></td><td>队列名称（只读）</td></tr><tr><td><code>length</code></td><td><code>number</code></td><td>当前队列中的任务数量（只读）</td></tr></tbody></table>
<h3 data-id="heading-8">3-2、Message 接口</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Message</span> {
  <span class="hljs-attr">what</span>: <span class="hljs-built_in">string</span>   <span class="hljs-comment">// 消息类型</span>
  <span class="hljs-attr">data</span>: <span class="hljs-title class_">Any</span>      <span class="hljs-comment">// 消息数据</span>
}
</code></pre>
<h3 data-id="heading-9">3-3、Task 接口</h3>
<p>所有添加的任务，包括“Message 类型任务”和“Runnable 类型任务”，均会返回该类型实例，通过该实例可以“取消任务”、“获取任务结果”、“任务 Id”。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Task</span> {
  <span class="hljs-title function_">cancel</span>(): <span class="hljs-built_in">void</span>                  <span class="hljs-comment">// 取消任务</span>
  <span class="hljs-title function_">getResult</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt;       <span class="hljs-comment">// 获取任务结果</span>
  <span class="hljs-title function_">getTaskId</span>(): <span class="hljs-built_in">number</span>             <span class="hljs-comment">// 获取任务 ID</span>
}
</code></pre>
<h3 data-id="heading-10">3-4、异常类型</h3>
<h4 data-id="heading-11">JSyncQueueCancelException</h4>
<p>当任务被取消时，会抛出该类型的异常。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">JSyncQueueCancelException</span> {
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>
}
</code></pre>
<h4 data-id="heading-12">JSyncQueueException</h4>
<p>当 JSyncQueue 内部发生异常时，会抛出该类型的异常。</p>
<blockquote>
<p>值得注意：使用者编写的逻辑中抛出的异常会原封不动的抛到 <code>Task.getResult().catch</code> 中，而<strong>不是以 <code>JSyncQueueException</code> 类型抛出</strong>。</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">JSyncQueueException</span> {
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>
}
</code></pre>
<h2 data-id="heading-13">四、如何使用 JSyncQueue</h2>
<h3 data-id="heading-14">4-1、使用 JSyncQueue 创建同步队列</h3>
<p>如果你处理的场景<strong>均是简单的一次性任务</strong>，那么直接使用 <code>JSyncQueue</code> 创建一个同步队列，并压入 <code>Runnable</code> 闭包即可。</p>
<p>以下代码展示的逻辑细节：</p>
<ul>
<li>代码中使用了 delay 函数模拟了两次耗时操作，并且返回结果</li>
<li>外部通过 <code>Task</code> 类型实例接收返回结果，并且打印</li>
<li>在第四次循环（即 i 为 3）的时候，会模拟抛出异常，异常内容会原封不动的抛到 <code>catch</code> 中</li>
</ul>
<p><strong>值得注意：</strong></p>
<ul>
<li><strong>立即执行任务会严格按入队顺序执行</strong></li>
<li>任务结果的接收处理（即对 <code>Task.getResult()</code> 的处理）和 <code>JSyncQueue</code> 对任务的处理是<strong>不保证顺序</strong>的，因为 <code>Task.getResult()</code> 的处理已不在队列范围内</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-attr">immediatelyJSyncQueue</span>: <span class="hljs-title class_">JSyncQueue</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSyncQueue</span>(<span class="hljs-string">"ImmediatelyJSyncQueue"</span>)
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; ++i) {
  <span class="hljs-keyword">const</span> task = <span class="hljs-variable language_">this</span>.<span class="hljs-property">immediatelyJSyncQueue</span>.<span class="hljs-title function_">post</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> delayTime1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Runnable】执行逻辑 i=<span class="hljs-subst">${i}</span> 第一段 将会模拟耗时=<span class="hljs-subst">${delayTime1}</span>`</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime1)

    <span class="hljs-keyword">if</span> (i == <span class="hljs-number">3</span>) {
      <span class="hljs-keyword">throw</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"模拟异常"</span> } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>
    }

    <span class="hljs-keyword">const</span> delayTime2 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Runnable】执行逻辑 i=<span class="hljs-subst">${i}</span> 第二段 将会模拟耗时=<span class="hljs-subst">${delayTime2}</span>`</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime2)

    <span class="hljs-keyword">return</span> <span class="hljs-string">`jiangpengyong-添加5个Runnable <span class="hljs-subst">${i}</span>`</span>
  })
  task.<span class="hljs-title function_">getResult</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Runnable-执行成功】i=<span class="hljs-subst">${i}</span> result=<span class="hljs-subst">${result}</span>`</span>)
    })
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">e</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Runnable-执行异常】i=<span class="hljs-subst">${i}</span> e=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(e)}</span>`</span>)
    })
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Runnable-执行结束】i=<span class="hljs-subst">${i}</span>`</span>)
    })
}

<span class="hljs-comment">// ========================================= 输出日志 =========================================</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=0 第一段 将会模拟耗时=239</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=0 第二段 将会模拟耗时=315</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=1 第一段 将会模拟耗时=379</span>
<span class="hljs-comment">// 【添加5个Runnable-执行成功】i=0 result=jiangpengyong-添加5个Runnable 0</span>
<span class="hljs-comment">// 【添加5个Runnable-执行结束】i=0</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=1 第二段 将会模拟耗时=391</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=2 第一段 将会模拟耗时=499</span>
<span class="hljs-comment">// 【添加5个Runnable-执行成功】i=1 result=jiangpengyong-添加5个Runnable 1</span>
<span class="hljs-comment">// 【添加5个Runnable-执行结束】i=1</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=2 第二段 将会模拟耗时=395</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=3 第一段 将会模拟耗时=478</span>
<span class="hljs-comment">// 【添加5个Runnable-执行成功】i=2 result=jiangpengyong-添加5个Runnable 2</span>
<span class="hljs-comment">// 【添加5个Runnable-执行结束】i=2</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=4 第一段 将会模拟耗时=166</span>
<span class="hljs-comment">// 【添加5个Runnable-执行异常】i=3 e={"message":"模拟异常"}</span>
<span class="hljs-comment">// 【添加5个Runnable-执行结束】i=3</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=4 第二段 将会模拟耗时=33</span>
<span class="hljs-comment">// 【添加5个Runnable-执行成功】i=4 result=jiangpengyong-添加5个Runnable 4</span>
<span class="hljs-comment">// 【添加5个Runnable-执行结束】i=4</span>
</code></pre>
<p><strong>取消同步任务</strong></p>
<p>通过返回的 <code>Task</code> 类型实例调用 <code>cancel</code> 方法可以进行取消任务。</p>
<p>下面的代码会取消第四次任务，所以在日志中会看到对应的取消异常，并且不会执行该任务。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: <span class="hljs-title class_">Task</span> | <span class="hljs-literal">undefined</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; ++i) {
  <span class="hljs-keyword">const</span> tempTask = <span class="hljs-variable language_">this</span>.<span class="hljs-property">immediatelyJSyncQueue</span>.<span class="hljs-title function_">post</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> delayTime1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【移除Runnable】执行逻辑 i=<span class="hljs-subst">${i}</span> 第一段 将会模拟耗时=<span class="hljs-subst">${delayTime1}</span>`</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime1)

    <span class="hljs-keyword">const</span> delayTime2 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【移除Runnable】执行逻辑 i=<span class="hljs-subst">${i}</span> 第二段 将会模拟耗时=<span class="hljs-subst">${delayTime2}</span>`</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime2)

    <span class="hljs-keyword">if</span> (i == <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">throw</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"模拟异常"</span> } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">`jiangpengyong-移除Runnable <span class="hljs-subst">${i}</span>`</span>
  })
  tempTask.<span class="hljs-title function_">getResult</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【移除Runnable】执行成功 i=<span class="hljs-subst">${i}</span> result=<span class="hljs-subst">${result}</span>`</span>)
  }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: Any</span>) =&gt;</span> {
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">e</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【移除Runnable】执行异常 i=<span class="hljs-subst">${i}</span> e=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(e)}</span>`</span>)
  }).<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【移除Runnable】执行完成 i=<span class="hljs-subst">${i}</span>`</span>)
  })
  <span class="hljs-keyword">if</span> (i == <span class="hljs-number">3</span>) {
    task = tempTask
  }
}
<span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【移除Runnable】取消任务 task=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(task)}</span>`</span>)
task?.<span class="hljs-title function_">cancel</span>()

<span class="hljs-comment">// ========================================= 输出日志 =========================================</span>
<span class="hljs-comment">// 【移除Runnable】执行逻辑 i=0 第一段 将会模拟耗时=263</span>
<span class="hljs-comment">// 【移除Runnable】取消任务 task={"taskId":13,"queue":{},"promise":{}}</span>
<span class="hljs-comment">// 【移除Runnable】执行异常 i=3 e={"message":"Cancel task by cancel function."}</span>
<span class="hljs-comment">// 【移除Runnable】执行完成 i=3</span>
<span class="hljs-comment">// 【移除Runnable】执行逻辑 i=0 第二段 将会模拟耗时=474</span>
<span class="hljs-comment">// 【移除Runnable】执行逻辑 i=1 第一段 将会模拟耗时=318</span>
<span class="hljs-comment">// 【移除Runnable】执行成功 i=0 result=jiangpengyong-移除Runnable 0</span>
<span class="hljs-comment">// 【移除Runnable】执行完成 i=0</span>
<span class="hljs-comment">// 【移除Runnable】执行逻辑 i=1 第二段 将会模拟耗时=6</span>
<span class="hljs-comment">// 【移除Runnable】执行逻辑 i=2 第一段 将会模拟耗时=406</span>
<span class="hljs-comment">// 【移除Runnable】执行成功 i=1 result=jiangpengyong-移除Runnable 1</span>
<span class="hljs-comment">// 【移除Runnable】执行完成 i=1</span>
<span class="hljs-comment">// 【移除Runnable】执行逻辑 i=2 第二段 将会模拟耗时=212</span>
<span class="hljs-comment">// 【移除Runnable】执行逻辑 i=4 第一段 将会模拟耗时=226</span>
<span class="hljs-comment">// 【移除Runnable】执行异常 i=2 e={"message":"模拟异常"}</span>
<span class="hljs-comment">// 【移除Runnable】执行完成 i=2</span>
<span class="hljs-comment">// 【移除Runnable】执行逻辑 i=4 第二段 将会模拟耗时=439</span>
<span class="hljs-comment">// 【移除Runnable】执行成功 i=4 result=jiangpengyong-移除Runnable 4</span>
<span class="hljs-comment">// 【移除Runnable】执行完成 i=4</span>
</code></pre>
<p><strong>延时执行 Runnable 类型任务</strong></p>
<p>添加延时任务只需改用 <code>postDelay</code> 方法并传入延时参数</p>
<ul>
<li>下面代码记录了添加任务到真正执行的延时，通过 <code>realDelay</code> 参数可以查看</li>
<li>使用了 <code>delay</code> 函数模拟了两次耗时操作，并模拟返回了处理结果</li>
<li>第四次任务抛出了异常，异常消息会原封不动的在 <code>catch</code> 的日志展示</li>
<li>因为延时任务的添加是按索引进行累加的，所以添加顺序其实并没变化，从最后的日志输出可以看到保证了执行顺序</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; ++i) {
  <span class="hljs-keyword">const</span> startTime = systemDateTime.<span class="hljs-title function_">getTime</span>(<span class="hljs-literal">false</span>)
  <span class="hljs-keyword">const</span> delayTime = i * <span class="hljs-number">100</span>
  <span class="hljs-keyword">const</span> task = <span class="hljs-variable language_">this</span>.<span class="hljs-property">delayJSyncQueue</span>.<span class="hljs-title function_">postDelay</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> endTime = systemDateTime.<span class="hljs-title function_">getTime</span>(<span class="hljs-literal">false</span>)
    <span class="hljs-keyword">const</span> realDelay = endTime - startTime
    <span class="hljs-keyword">const</span> delayTime1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Runnable】执行逻辑 delay=<span class="hljs-subst">${delayTime}</span> realDelay=<span class="hljs-subst">${realDelay}</span> i=<span class="hljs-subst">${i}</span> 第一段 将会模拟耗时=<span class="hljs-subst">${delayTime1}</span>`</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime1)

    <span class="hljs-keyword">const</span> delayTime2 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Runnable】执行逻辑 i=<span class="hljs-subst">${i}</span> 第二段 将会模拟耗时=<span class="hljs-subst">${delayTime2}</span>`</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime2)

    <span class="hljs-keyword">if</span> (i == <span class="hljs-number">3</span>) {
      <span class="hljs-keyword">throw</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"模拟异常"</span> } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">`jiangpengyong-添加5个Runnable <span class="hljs-subst">${i}</span>`</span>
  }, delayTime)
  task.<span class="hljs-title function_">getResult</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Runnable】执行成功 i=<span class="hljs-subst">${i}</span> result=<span class="hljs-subst">${result}</span>`</span>)
    })
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">e</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Runnable】执行异常 i=<span class="hljs-subst">${i}</span> e=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(e)}</span>`</span>)
    })
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Runnable】执行结束 i=<span class="hljs-subst">${i}</span>`</span>)
    })
}

<span class="hljs-comment">// ========================================= 输出日志 =========================================</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 delay=0 realDelay=1 i=0 第一段 将会模拟耗时=473</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=0 第二段 将会模拟耗时=410</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 delay=100 realDelay=888 i=1 第一段 将会模拟耗时=178</span>
<span class="hljs-comment">// 【添加5个Runnable】执行成功 i=0 result=jiangpengyong-添加5个Runnable 0</span>
<span class="hljs-comment">// 【添加5个Runnable】执行结束 i=0</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=1 第二段 将会模拟耗时=204</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 delay=200 realDelay=1272 i=2 第一段 将会模拟耗时=410</span>
<span class="hljs-comment">// 【添加5个Runnable】执行成功 i=1 result=jiangpengyong-添加5个Runnable 1</span>
<span class="hljs-comment">// 【添加5个Runnable】执行结束 i=1</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=2 第二段 将会模拟耗时=36</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 delay=300 realDelay=1721 i=3 第一段 将会模拟耗时=475</span>
<span class="hljs-comment">// 【添加5个Runnable】执行成功 i=2 result=jiangpengyong-添加5个Runnable 2</span>
<span class="hljs-comment">// 【添加5个Runnable】执行结束 i=2</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=3 第二段 将会模拟耗时=483</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 delay=400 realDelay=2686 i=4 第一段 将会模拟耗时=9</span>
<span class="hljs-comment">// 【添加5个Runnable】执行异常 i=3 e={"message":"模拟异常"}</span>
<span class="hljs-comment">// 【添加5个Runnable】执行结束 i=3</span>
<span class="hljs-comment">// 【添加5个Runnable】执行逻辑 i=4 第二段 将会模拟耗时=395</span>
<span class="hljs-comment">// 【添加5个Runnable】执行成功 i=4 result=jiangpengyong-添加5个Runnable 4</span>
<span class="hljs-comment">// 【添加5个Runnable】执行结束 i=4</span>
</code></pre>
<p><strong>取消延时任务</strong></p>
<p>延时任务的取消操作和立即执行的取消操作是完全一样的，都是通过返回的 <code>Task</code> 实例调用 <code>cancel</code> 方法，这里就不再赘述。</p>
<h3 data-id="heading-15">4-2、继承 JSyncQueue 创建同步队列</h3>
<p><strong>如果你的同步逻辑需要集中管理或进行复用，可以考虑 <code>Message</code> 类型任务。</strong></p>
<p>处理 <code>Message</code> 类型任务，需要继承 <code>JSyncQueue</code> 实现 <code>onHandleMessage</code> 方法，在该方法中会按入队顺序接收到 <code>Message</code> ：</p>
<ul>
<li>通过 <code>Message.what</code> 属性区分不同类别消息实现不同处理逻辑</li>
<li>通过 <code>Message.data</code> 属性可以获取外部传入的数据，数据类型是 <code>Any</code> 可以是任意类型数据，使用者自行转换为真实类型进行逻辑处理</li>
</ul>
<p>具体操作如下：</p>
<ul>
<li>定义一个 <code>ImmediatelyQueue</code> 类继承 <code>JSyncQueue</code> ，实现 <code>onHandleMessage</code> 方法</li>
<li>创建一个 <code>ImmediatelyQueue</code> 实例，并通过这个实例进行发送 Message 消息，同步队列会按入队顺序一个个进行分发给该实例的 <code>onHandleMessage</code> 方法进行处理</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 自定义 JSyncQueue</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImmediatelyQueue</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">JSyncQueue</span> {
  <span class="hljs-keyword">private</span> count = <span class="hljs-number">0</span>

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onHandleMessage</span>(<span class="hljs-attr">message</span>: <span class="hljs-title class_">Message</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">what</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"say_hello"</span>: {
        <span class="hljs-keyword">const</span> name = message.<span class="hljs-property">data</span>[<span class="hljs-string">"name"</span>]
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> += <span class="hljs-number">1</span>

        <span class="hljs-keyword">const</span> delayTime1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
        <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"ImmediatelyQueue"</span>, <span class="hljs-string">`【say_hello】执行逻辑 第一段 将会模拟耗时=<span class="hljs-subst">${delayTime1}</span>`</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime1)

        <span class="hljs-keyword">const</span> delayTime2 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
        <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"ImmediatelyQueue"</span>, <span class="hljs-string">`【say_hello】执行逻辑 第二段 将会模拟耗时=<span class="hljs-subst">${delayTime2}</span>`</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime2)

        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> % <span class="hljs-number">10</span> == <span class="hljs-number">5</span>) {
          <span class="hljs-keyword">throw</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"模拟异常"</span> }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">`你好，<span class="hljs-subst">${name}</span>。这是第<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span>次打招呼。`</span>
      }
      <span class="hljs-comment">// ... 其他 what 处理逻辑</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
  }

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">delay</span>(<span class="hljs-params">ms: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt;(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, ms))
  }
}

<span class="hljs-comment">// 使用逻辑</span>
<span class="hljs-attr">immediatelyQueue</span>: <span class="hljs-title class_">JSyncQueue</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImmediatelyQueue</span>(<span class="hljs-string">"ImmediatelyQueue"</span>)
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; ++i) {
  <span class="hljs-keyword">const</span> tempTask = <span class="hljs-variable language_">this</span>.<span class="hljs-property">immediatelyQueue</span>.<span class="hljs-title function_">sendMessage</span>({
    <span class="hljs-attr">what</span>: <span class="hljs-string">`say_hello`</span>,
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'江澎涌'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> + i },
  })
  tempTask.<span class="hljs-title function_">getResult</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Message】执行成功 i=<span class="hljs-subst">${i}</span> result=<span class="hljs-subst">${result}</span>`</span>)
    })
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">e</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Message】执行异常 i=<span class="hljs-subst">${i}</span> e=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(e)}</span>`</span>)
    })
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Message】执行结束i=<span class="hljs-subst">${i}</span>`</span>)
    })
}
<span class="hljs-comment">// ========================================= 输出日志 =========================================</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"江澎涌","age":20}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=92</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=143</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"江澎涌","age":21}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=276</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=377</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"江澎涌","age":22}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=120</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=223</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"江澎涌","age":23}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=424</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=444</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"江澎涌","age":24}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=181</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=402</span>
</code></pre>
<p><strong>移除 Message 消息</strong></p>
<p>使用 <code>sendMessage</code> 方法压入 “Message 类型任务” 同样会返回 <code>Task</code> 类型实例，调用该实例的 <code>cancel</code> 方法就可以取消该任务。</p>
<p>下列代码会取消第二个任务，所以不会看到 <code>"age":11</code> 的消息。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">task</span>: <span class="hljs-title class_">Task</span> | <span class="hljs-literal">undefined</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; ++i) {
  <span class="hljs-keyword">const</span> tempTask = <span class="hljs-variable language_">this</span>.<span class="hljs-property">immediatelyQueue</span>.<span class="hljs-title function_">sendMessage</span>({
    <span class="hljs-attr">what</span>: <span class="hljs-string">`remove_message`</span>,
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'jiang peng yong'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">10</span> + i },
  })
  tempTask.<span class="hljs-title function_">getResult</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【移除Message】执行成功 i=<span class="hljs-subst">${i}</span> result=<span class="hljs-subst">${result}</span>`</span>)
  }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: Any</span>) =&gt;</span> {
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">e</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【移除Message】执行异常 i=<span class="hljs-subst">${i}</span> e=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(e)}</span>`</span>)
  }).<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【移除Message】执行完成 i=<span class="hljs-subst">${i}</span>`</span>)
  })
  <span class="hljs-keyword">if</span> (i == <span class="hljs-number">1</span>) {
    task = tempTask
  }
}
<span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【移除Message】取消任务 task=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(task)}</span>`</span>)
task?.<span class="hljs-title function_">cancel</span>()
<span class="hljs-comment">// ========================================= 输出日志 =========================================</span>
<span class="hljs-comment">// onHandleMessage message={"what":"remove_message","data":{"name":"jiang peng yong","age":10}}</span>
<span class="hljs-comment">// 【remove_message】执行逻辑 第一段 将会模拟耗时=497</span>
<span class="hljs-comment">// 【remove_message】执行逻辑 第二段 将会模拟耗时=397</span>
<span class="hljs-comment">// onHandleMessage message={"what":"remove_message","data":{"name":"jiang peng yong","age":12}}</span>
<span class="hljs-comment">// 【remove_message】执行逻辑 第一段 将会模拟耗时=162</span>
<span class="hljs-comment">// 【remove_message】执行逻辑 第二段 将会模拟耗时=283</span>
<span class="hljs-comment">// onHandleMessage message={"what":"remove_message","data":{"name":"jiang peng yong","age":13}}</span>
<span class="hljs-comment">// 【remove_message】执行逻辑 第一段 将会模拟耗时=193</span>
<span class="hljs-comment">// 【remove_message】执行逻辑 第二段 将会模拟耗时=93</span>
<span class="hljs-comment">// onHandleMessage message={"what":"remove_message","data":{"name":"jiang peng yong","age":14}}</span>
<span class="hljs-comment">// 【remove_message】执行逻辑 第一段 将会模拟耗时=359</span>
<span class="hljs-comment">// 【remove_message】执行逻辑 第二段 将会模拟耗时=145</span>
</code></pre>
<p><strong>延时执行 Message 类型任务</strong></p>
<ul>
<li>定义一个 <code>DelayQueue</code> 类继承 <code>JSyncQueue</code> ，主要重写 <code>onHandleMessage</code> 方法，用于接收处理 <code>Message</code></li>
<li>创建 <code>DelayQueue</code> 实例，通过这个实例调用 <code>sendMessageDelay</code> 方法即可达到相应的延时效果</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DelayQueue</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">JSyncQueue</span> {
  <span class="hljs-keyword">private</span> count = <span class="hljs-number">0</span>

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onHandleMessage</span>(<span class="hljs-attr">message</span>: <span class="hljs-title class_">Message</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt; {
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"DelayQueue"</span>, <span class="hljs-string">`onHandleMessage message=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(message)}</span>`</span>)
    <span class="hljs-keyword">switch</span> (message.<span class="hljs-property">what</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">"say_hello"</span>: {
        <span class="hljs-keyword">const</span> name = message.<span class="hljs-property">data</span>[<span class="hljs-string">"name"</span>]
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> += <span class="hljs-number">1</span>

        <span class="hljs-keyword">const</span> delayTime1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
        <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"DelayQueue"</span>, <span class="hljs-string">`【say_hello】执行逻辑 第一段 将会模拟耗时=<span class="hljs-subst">${delayTime1}</span>`</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime1)

        <span class="hljs-keyword">const</span> delayTime2 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
        <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-string">"DelayQueue"</span>, <span class="hljs-string">`【say_hello】执行逻辑 第二段 将会模拟耗时=<span class="hljs-subst">${delayTime2}</span>`</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime2)

        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> % <span class="hljs-number">10</span> == <span class="hljs-number">5</span>) {
          <span class="hljs-keyword">throw</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"模拟异常"</span> }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-string">`Hello，<span class="hljs-subst">${name}</span>. This is the <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span> th greeting.`</span>
      }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
  }

  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">delay</span>(<span class="hljs-params">ms: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Any</span>&gt;(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, ms))
  }
}

<span class="hljs-attr">delayQueue</span>: <span class="hljs-title class_">JSyncQueue</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DelayQueue</span>(<span class="hljs-string">"DelayQueue"</span>)
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; ++i) {
  <span class="hljs-keyword">const</span> delayTime = i * <span class="hljs-number">100</span>
  <span class="hljs-keyword">const</span> task = <span class="hljs-variable language_">this</span>.<span class="hljs-property">delayQueue</span>.<span class="hljs-title function_">sendMessageDelay</span>({
    <span class="hljs-attr">what</span>: <span class="hljs-string">`say_hello`</span>,
    <span class="hljs-attr">data</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'江澎涌'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> + i },
  }, delayTime)
  task.<span class="hljs-title function_">getResult</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Message】执行成功 i=<span class="hljs-subst">${i}</span> result=<span class="hljs-subst">${result}</span>`</span>)
    })
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">e</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Message】执行异常 i=<span class="hljs-subst">${i}</span> e=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(e)}</span>`</span>)
    })
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加5个Message】执行结束i=<span class="hljs-subst">${i}</span>`</span>)
    })
}
<span class="hljs-comment">// ========================================= 输出日志 ========================================= </span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"江澎涌","age":20}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=356</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=302</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"江澎涌","age":21}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=67</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=344</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"江澎涌","age":22}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=339</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=384</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"江澎涌","age":23}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=442</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=392</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"江澎涌","age":24}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=443</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=199</span>
</code></pre>
<p><strong>取消延时的 Message 类型任务</strong></p>
<p>延时任务的取消操作和立即执行的取消操作是完全一样的，都是通过返回的 <code>Task</code> 实例调用 <code>cancel</code> 方法，这里就不再赘述。</p>
<p><strong>同一队列压入 Message 类型任务和 Runnable 类型任务</strong></p>
<p>对 <code>JSyncQueue</code> 同一实例压入 <code>Message</code> 和 <code>Runnable</code> 两种类型任务是支持的，会按照压入顺序进行执行和分发。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ImmediatelyQueue 源码就不再展示，需要可以移步 Github 上查阅</span>
<span class="hljs-attr">immediatelyQueue</span>: <span class="hljs-title class_">JSyncQueue</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImmediatelyQueue</span>(<span class="hljs-string">"ImmediatelyQueue"</span>)
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; ++i) {
  <span class="hljs-keyword">if</span> (i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">immediatelyQueue</span>.<span class="hljs-title function_">post</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">const</span> delayTime1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加10个Message和Runnable】执行逻辑 i=<span class="hljs-subst">${i}</span> 第一段 将会模拟耗时=<span class="hljs-subst">${delayTime1}</span>`</span>)
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime1)

      <span class="hljs-keyword">const</span> delayTime2 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【添加10个Message和Runnable】执行逻辑 i=<span class="hljs-subst">${i}</span> 第二段 将会模拟耗时=<span class="hljs-subst">${delayTime2}</span>`</span>)
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime2)

      <span class="hljs-keyword">if</span> (i / <span class="hljs-number">2</span> == <span class="hljs-number">3</span>) {
        <span class="hljs-keyword">throw</span> { <span class="hljs-attr">message</span>: <span class="hljs-string">"模拟异常"</span> } <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>
      }
      <span class="hljs-keyword">return</span> <span class="hljs-string">`小朋友-添加10个Message和Runnable <span class="hljs-subst">${i}</span>`</span>
    })
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">immediatelyQueue</span>.<span class="hljs-title function_">sendMessage</span>({
      <span class="hljs-attr">what</span>: <span class="hljs-string">`say_hello`</span>,
      <span class="hljs-attr">data</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'小朋友'</span>, <span class="hljs-attr">age</span>: i },
    })
  }
}
<span class="hljs-comment">// ========================================= 输出日志 ========================================= </span>
<span class="hljs-comment">// 【添加10个Message和Runnable】执行逻辑 i=0 第一段 将会模拟耗时=416</span>
<span class="hljs-comment">// 【添加10个Message和Runnable】执行逻辑 i=0 第二段 将会模拟耗时=41</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"小朋友","age":1}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=184</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=63</span>
<span class="hljs-comment">// 【添加10个Message和Runnable】执行逻辑 i=2 第一段 将会模拟耗时=451</span>
<span class="hljs-comment">// 【添加10个Message和Runnable】执行逻辑 i=2 第二段 将会模拟耗时=223</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"小朋友","age":3}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=99</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=27</span>
<span class="hljs-comment">// 【添加10个Message和Runnable】执行逻辑 i=4 第一段 将会模拟耗时=273</span>
<span class="hljs-comment">// 【添加10个Message和Runnable】执行逻辑 i=4 第二段 将会模拟耗时=193</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"小朋友","age":5}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=20</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=231</span>
<span class="hljs-comment">// 【添加10个Message和Runnable】执行逻辑 i=6 第一段 将会模拟耗时=46</span>
<span class="hljs-comment">// 【添加10个Message和Runnable】执行逻辑 i=6 第二段 将会模拟耗时=198</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"小朋友","age":7}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=179</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=0</span>
<span class="hljs-comment">// 【添加10个Message和Runnable】执行逻辑 i=8 第一段 将会模拟耗时=131</span>
<span class="hljs-comment">// 【添加10个Message和Runnable】执行逻辑 i=8 第二段 将会模拟耗时=401</span>
<span class="hljs-comment">// onHandleMessage message={"what":"say_hello","data":{"name":"小朋友","age":9}}</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第一段 将会模拟耗时=452</span>
<span class="hljs-comment">// 【say_hello】执行逻辑 第二段 将会模拟耗时=40</span>
</code></pre>
<h3 data-id="heading-16">4-3、取消队列中所有任务</h3>
<p>对 <code>JSyncQueue</code> 实例调用 <code>clear</code> 方法，就会把队列中等待执行的任务，包括延时执行和立即执行的任务，全都取消。同时会抛出 <code>JSyncQueueCancelException</code> 类型异常。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; ++i) {
  <span class="hljs-keyword">const</span> task = <span class="hljs-variable language_">this</span>.<span class="hljs-property">immediatelyQueue</span>.<span class="hljs-title function_">post</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">const</span> delayTime1 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【清空队列】执行逻辑 i=<span class="hljs-subst">${i}</span> 第一段 将会模拟耗时=<span class="hljs-subst">${delayTime1}</span>`</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime1)

    <span class="hljs-keyword">const</span> delayTime2 = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">500</span>)
    <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【清空队列】执行逻辑 i=<span class="hljs-subst">${i}</span> 第二段 将会模拟耗时=<span class="hljs-subst">${delayTime2}</span>`</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delayTime2)

    <span class="hljs-keyword">return</span> <span class="hljs-string">`小朋友-清空队列 <span class="hljs-subst">${i}</span>`</span>
  })
  task.<span class="hljs-title function_">getResult</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【清空队列】执行成功 i=<span class="hljs-subst">${i}</span> result=<span class="hljs-subst">${result}</span>`</span>)
    })
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">e: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">e</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【清空队列】执行异常 i=<span class="hljs-subst">${i}</span> e=<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(e)}</span>`</span>)
    })
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title class_">Log</span>.<span class="hljs-title function_">i</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`【清空队列】执行结束 i=<span class="hljs-subst">${i}</span>`</span>)
    })
}
<span class="hljs-variable language_">this</span>.<span class="hljs-property">immediatelyQueue</span>.<span class="hljs-title function_">clear</span>()
<span class="hljs-comment">// ========================================= 输出日志 ========================================= </span>
<span class="hljs-comment">// 【清空队列】执行逻辑 i=0 第一段 将会模拟耗时=14</span>
<span class="hljs-comment">// 【清空队列】执行异常 i=1 e={"message":"Cancel task by clear function."}</span>
<span class="hljs-comment">// 【清空队列】执行异常 i=2 e={"message":"Cancel task by clear function."}</span>
<span class="hljs-comment">// 【清空队列】执行异常 i=3 e={"message":"Cancel task by clear function."}</span>
<span class="hljs-comment">// 【清空队列】执行异常 i=4 e={"message":"Cancel task by clear function."}</span>
<span class="hljs-comment">// 【清空队列】执行结束 i=1</span>
<span class="hljs-comment">// 【清空队列】执行结束 i=2</span>
<span class="hljs-comment">// 【清空队列】执行结束 i=3</span>
<span class="hljs-comment">// 【清空队列】执行结束 i=4</span>
<span class="hljs-comment">// 【清空队列】执行逻辑 i=0 第二段 将会模拟耗时=125</span>
<span class="hljs-comment">// 【清空队列】执行成功 i=0 result=小朋友-清空队列 0</span>
<span class="hljs-comment">// 【清空队列】执行结束 i=0</span>
</code></pre>
<h2 data-id="heading-17">五、作者博客</h2>
<p>掘金：<a href="https://juejin.im/user/5c3033ef51882524ec3a88ba/posts" target="_blank" title="https://juejin.im/user/5c3033ef51882524ec3a88ba/posts">juejin.im/user/5c3033…</a></p>
<p>csdn：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fweixin_37625173" target="_blank" title="https://blog.csdn.net/weixin_37625173" ref="nofollow noopener noreferrer">blog.csdn.net/weixin_3762…</a></p>
<p>公众号：微信搜索 "江澎涌"</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FossFLOW：开源等距图表工具，为技术文档注入立体活力！]]></title>    <link>https://juejin.cn/post/7601041482892623922</link>    <guid>https://juejin.cn/post/7601041482892623922</guid>    <pubDate>2026-01-31T12:12:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601041482892623922" data-draft-id="7601077764424237106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FossFLOW：开源等距图表工具，为技术文档注入立体活力！"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-01-31T12:12:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FossFLOW：开源等距图表工具，为技术文档注入立体活力！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T12:12:52.000Z" title="Sat Jan 31 2026 12:12:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>文章简介：FossFLOW是一款创新的开源等距图表工具，专为技术文档设计。它通过立体视角将复杂的系统架构转化为直观的3D图表，支持拖放式操作和离线使用，让技术图表变得生动易懂。无需注册，数据安全存储在本地，并提供JSON导入导出功能。无论是Docker快速部署还是在线体验，FossFLOW都能为架构图、流程图注入立体活力，是提升技术文档表现力的得力助手。</p>
</blockquote>
<p>你是否曾经为了绘制清晰的技术架构图或系统流程图而烦恼？是否觉得传统的平面图表难以表达复杂的层次关系？今天，我要向大家介绍一款令人惊艳的开源工具——<strong>FossFLOW</strong>，它能让你的技术图表瞬间变得立体、生动！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb593978666244e88a735fc3565d65d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770466372&amp;x-signature=kLsIqOoVTjJcXG%2BxDSrf4otY62M%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">🌟 什么是FossFLOW？</h2>
<p>FossFLOW 是一款功能强大的、开源的渐进式 Web 应用（PWA），专为创建精美的等距图表而设计。它基于 React 和 Isoflow（现已 fork 并以 fossflow 名称发布到 NPM）库构建，完全在浏览器中运行，并支持离线使用，让你随时随地都能创作出专业级的技术图表！</p>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fstan-smith%2FFossFLOW" title="https://github.com/stan-smith/FossFLOW" target="_blank" ref="nofollow noopener noreferrer">github.com/stan-smith/…</a></p>
<p>在线地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fstan-smith.github.io%2FFossFLOW" title="https://stan-smith.github.io/FossFLOW" target="_blank" ref="nofollow noopener noreferrer">stan-smith.github.io/FossFLOW/</a></p>
<p>该项目目前在github上已有<strong>17k</strong> ⭐️star</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b01c34edfb8c4a51bf24bc0b1a0e8936~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770466372&amp;x-signature=tlErdVFvEOC31mgnO0y7OUYe%2BJQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">✨ 主要特性</h2>
<h3 data-id="heading-2">🎨 <strong>立体图表，视觉升级</strong></h3>
<ul>
<li>• 创建令人惊叹的3D风格技术图表</li>
<li>• 等距视角让复杂的系统架构一目了然</li>
<li>• 拖放式操作，简单直观</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7456231f1c14f6eb6757cb7b2b2071e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770466372&amp;x-signature=plYE1r8nubSrio2surZjCWmzLmg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">🔒 <strong>隐私优先，安全可靠</strong></h3>
<ul>
<li>• 所有数据都存储在您的浏览器中</li>
<li>• 无需注册，无需上传</li>
<li>• 完全控制你的数据</li>
</ul>
<h3 data-id="heading-4">🔄 <strong>导入导出，轻松分享</strong></h3>
<ul>
<li>• JSON格式导入导出</li>
<li>• 快速分享你的设计</li>
<li>• 完整备份功能</li>
</ul>
<h2 data-id="heading-5">🚀 快速上手</h2>
<h3 data-id="heading-6">🐳Docker部署</h3>
<p>创建docker-compose.yml文件，内容如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">fossflow:</span>
    <span class="hljs-string">image:</span> <span class="hljs-string">stnsmith/fossflow:latest</span>
    <span class="hljs-string">container_name:</span> <span class="hljs-string">fossflow</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-string">-</span> <span class="hljs-string">"5010:80"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-comment"># 如果要禁用服务端存储，可以注释掉这行</span>
      <span class="hljs-string">-</span> <span class="hljs-string">./diagrams:/data/diagrams</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-string">-</span> <span class="hljs-string">TZ=Asia/Shanghai</span>
      <span class="hljs-comment"># 如果要启用服务端存储，注释掉下面这行</span>
      <span class="hljs-comment"># - ENABLE_SERVER_STORAGE="false"</span>
    <span class="hljs-string">restart:</span> <span class="hljs-string">unless-stopped</span>
</code></pre>
<p>在docker-compose.yml 同级命令下使用以下命令启动</p>
<pre><code class="hljs">docker-compose up -d
</code></pre>
<p>到此，我们就部署完了，在浏览器中输入地址就可以访问了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a748f8626b44dfd9850a4cfbc5b9af8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770466372&amp;x-signature=JNN1zQdIc%2B2oEsgLbT2Axt4cZZ4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">🌐在线体验</h3>
<p>直接访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fstan-smith.github.io%2FFossFLOW" title="https://stan-smith.github.io/FossFLOW" target="_blank" ref="nofollow noopener noreferrer">stan-smith.github.io/FossFLOW/</a></p>
<h3 data-id="heading-8">📱本地启动</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/stan-smith/FossFLOW
<span class="hljs-built_in">cd</span> FossFLOW

<span class="hljs-comment"># 安装依赖</span>
npm install

<span class="hljs-comment"># 启动开发服务器</span>
npm start
</code></pre>
<h2 data-id="heading-9">🛠️ 使用指南</h2>
<h3 data-id="heading-10">📈1. 创建图表</h3>
<ul>
<li>• 点击右上角"+"按钮打开组件库</li>
<li>• 从左侧拖放组件到画布</li>
<li>• 或右键网格选择"Add node"</li>
</ul>
<h3 data-id="heading-11">🧩2. 连接组件</h3>
<ul>
<li>• 使用连接器显示组件关系</li>
<li>• 智能对齐，保持图表整洁</li>
<li>• 多层连接，表达复杂关系</li>
</ul>
<h3 data-id="heading-12">✏️3. 自定义样式</h3>
<ul>
<li>• 更改颜色、标签和属性</li>
<li>• 调整位置和大小</li>
<li>• 添加说明文字</li>
</ul>
<h3 data-id="heading-13">🎨4. 导航操作</h3>
<ul>
<li>• 鼠标滚轮放大缩小</li>
<li>• 点击拖动平移画布</li>
<li>• Ctrl+Z撤销，Ctrl+Y重做</li>
</ul>
<h2 data-id="heading-14">🏗️ 技术栈</h2>
<ul>
<li>• <strong>React</strong> - 现代化的UI框架</li>
<li>• <strong>TypeScript</strong> - 类型安全的开发体验</li>
<li>• <strong>Isoflow</strong> - 强大的等距图表引擎</li>
<li>• <strong>PWA</strong> - 离线优先的Web应用架构</li>
</ul>
<h2 data-id="heading-15">🚨缺点与不足</h2>
<p>虽然该工具在基础功能方面表现良好，但在实际使用过程中仍存在一些明显的局限性与不足之处：</p>
<ul>
<li>
<p>• 3D节点资源严重匮乏</p>
<p>官方提供的3D节点类型极为有限，仅包含基础的几何形状和少数预设模型，无法满足复杂三维场景的构建需求。</p>
</li>
<li>
<p>• 第三方节点生态发展不完善</p>
<p>第三方插件多为2D节点，在构建复杂三维场景时可能面临节点素材不足的问题。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/416642ca598c4f2ba5493e31ade60c74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770466372&amp;x-signature=cWCaVwNBhxYoJAEbszgu%2FNhGAok%3D" alt="" loading="lazy"/></p>
<ul>
<li>• 快捷操作方式还有待改进</li>
</ul>
<h2 data-id="heading-16">📝 最后的话</h2>
<p>在技术文档越来越重要的今天，一个清晰、直观的图表往往胜过千言万语。FossFLOW以其独特的等距视角，为技术图表带来了全新的可能性。无论你是架构师、开发者、技术作家还是项目经理，这款工具都值得一试。</p>
<p>最重要的是，它是完全免费和开源的！你可以在GitHub上找到所有源代码，自由使用、学习和改进。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Docker 到底变成了什么？从“容器之王”到“开发者工具箱+AI 基建+安全公司”的奇妙漂流]]></title>    <link>https://juejin.cn/post/7601020578491236361</link>    <guid>https://juejin.cn/post/7601020578491236361</guid>    <pubDate>2026-01-31T12:27:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601020578491236361" data-draft-id="7601069677566476334" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Docker 到底变成了什么？从“容器之王”到“开发者工具箱+AI 基建+安全公司”的奇妙漂流"/> <meta itemprop="keywords" content="Java,Docker"/> <meta itemprop="datePublished" content="2026-01-31T12:27:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dcs"/> <meta itemprop="url" content="https://juejin.cn/user/3679404422861902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Docker 到底变成了什么？从“容器之王”到“开发者工具箱+AI 基建+安全公司”的奇妙漂流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3679404422861902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dcs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T12:27:59.000Z" title="Sat Jan 31 2026 12:27:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有些技术产品的命运很讽刺：它成功到成为“基础设施”，然后就很难再靠它赚钱。Docker 就是典型案例——容器化标准被全行业采用后，Docker越用越香，Docker公司反而开始进入一种“我是谁、我在哪、我卖什么”的长期迷茫期。</p>
<p>站在 2026 往回看，Docker 的路线像极了一个“曾经统治江湖的高手”，突然发现大家都学会了他的绝招，还免费开源教程，于是只能不断换赛道：从编排，到开发者体验，再到 AI，再到安全镜像……每一步单独看都合理，连起来就像在玩“商业模式大富翁”。😅</p>
<p>我们就来聊聊 Docker 这些年到底在追什么，以及对开发者意味着什么。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcbb5875bb9b414a9fb61311b33954ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGNz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770467281&amp;x-signature=tasB1xyW8iVipM4Zf8irMljQqwo%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">1）当“事实标准”变成“免费空气”：Docker 最难的不是技术，是收钱💰</h2>
<p>Docker 早年解决的是“应用交付的终极痛点”：环境不一致、部署不可靠、依赖乱。容器把这一切梳顺了，甚至把“打包交付”的语言都统一了。</p>
<p>问题也正出在这里：当容器化成为基础设施，大家默认“它就应该存在”，就像默认 TCP/IP 不该收费一样。基础设施越成功，商业化越痛苦——除非你能在基础设施之上，卖出新的、不可替代的价值。</p>
<p>于是 Docker 开始寻找“新价值点”。</p>
<hr/>
<h2 data-id="heading-1">2）编排之战：Kubernetes 赢了，Docker 选择“退一步海阔天空”🌊</h2>
<p>曾经 Docker 也想把版图扩到“编排”，让 Swarm 跟 Kubernetes 正面掰手腕。但现实是：K8s 成了事实标准，生态和社区像雪球越滚越大。</p>
<p>后来的剧情大家都知道：Docker 把企业业务（包含相关技术与客户资产）卖给 Mirantis，Swarm 也随这波交易进入 Mirantis 体系，Docker 自己则更聚焦在 Desktop、Hub、以及开发者工作流上。</p>
<p>这一步传递的信号很清晰：不再执着于“全栈云原生平台”，转而做自己最擅长、最贴近开发者的环节。</p>
<hr/>
<h2 data-id="heading-2">3）开发者工具转向：Scout、Testcontainers，把“安全”和“测试”塞进日常工作流🧰</h2>
<p>Docker 的“开发者体验路线”其实是非常聪明的一步：开发者愿意为效率和确定性付费，尤其是当软件供应链和依赖漏洞越来越像“定时炸弹”时。</p>
<h3 data-id="heading-3">Docker Scout：把镜像“拆开验货”，顺手把供应链安全做了</h3>
<p>Docker 通过收购 Atomist 加速进入软件供应链与可观测性方向，随后把能力沉淀到 Docker Scout 这类产品上：不只告诉你镜像里有什么包，还要追溯它怎么构建、哪里有漏洞、有没有合规风险。</p>
<h3 data-id="heading-4">Testcontainers：把集成测试从“玄学”拉回“可复现”</h3>
<p>Docker 收购 AtomicJar（Testcontainers 背后的公司）则是另一招“贴地飞行”：测试阶段直接拉起真实依赖（数据库、消息队列等），让集成测试更接近生产，从而减少“线上才爆炸”的概率。</p>
<p>这一阶段的 Docker，像一个越来越懂开发者的产品经理：不谈宏大叙事，只解决“今天能不能少加班”的问题。</p>
<hr/>
<h2 data-id="heading-5">4）AI 时代的“再一次身份切换”</h2>
<p>从容器到模型、从 Compose 到 Agent🤖</p>
<p>然后，AI 浪潮来了——几乎所有基础设施公司都会被迫回答一个问题：<strong>“AI 工作负载要怎么跑？我能插一脚吗？”</strong></p>
<p>Docker 的回答是：能，而且要跑得像 <code>docker run</code> 一样顺手。</p>
<h3 data-id="heading-6">Model Runner：让本地跑模型像跑容器一样自然</h3>
<p>Docker 推出 Docker Model Runner，主打“更快更简单地在本地运行和测试 AI 模型”，把模型运行塞进开发者熟悉的 Docker 工作流里。</p>
<h3 data-id="heading-7">Compose + Offload：本地调试，云端上 GPU 扩容</h3>
<p>Docker 还把 Compose 拉进“AI Agent 时代”，并引入 Docker Offload 来承接云端 GPU 规模化执行，把“本地好调试、线上跑得动”的老矛盾，包装成一条更平滑的路径。</p>
<p>说白了：Docker 正在努力把 AI 开发也变成一种“可声明、可复现、可搬运”的工程化体验——这正是它当年在容器时代最擅长的那套叙事。</p>
<hr/>
<h2 data-id="heading-8">5）安全牌加码</h2>
<p>收购 MCP Defender + 推出 Hardened Images，像在对行业喊“我还能打”🛡️</p>
<p>AI 之后，Docker 又把“安全”推到了更核心的位置。</p>
<h3 data-id="heading-9">MCP Defender：面向 Agentic AI 的运行时威胁检测</h3>
<p>2025 年 9 月，Docker 宣布收购 MCP Defender，定位是“为 agentic AI 应用提供安全能力”，强调运行时威胁检测与防护。
这一步几乎等于宣告：Docker 想做的不只是开发者工具，而是 AI 基础设施的一部分。</p>
<h3 data-id="heading-10">Hardened Images：1000+ 加固镜像开源免费，漏洞最多可降 95%</h3>
<p>更“狠”的是加固镜像：Docker 宣布将 Docker Hardened Images 走向“免费、开源、透明”，采用 Apache 2.0 许可，强调相比传统社区镜像漏洞最多可减少 95%，并建立在 Alpine、Debian 等基础之上。</p>
<p>这招很像“安全镜像赛道”的正面硬刚：当市场上出现强势对手（比如专注安全镜像的厂商），最有效的竞争手段之一就是——把门槛直接打到地板价：免费 + 开源。
但问题也随之而来：<strong>如果安全能力都免费了，那 Docker 要靠什么挣钱？</strong></p>
<hr/>
<h2 data-id="heading-11">6）CEO 更替与“被收购猜想”：公司层面的信号更耐人寻味👀</h2>
<p>2025 年 2 月，Docker 任命 Don Johnson 为新 CEO，接替 Scott Johnston。
外界对这种更替的解读往往很现实：当一个公司频繁调整战略、同时补齐多个“可能变现”的方向（开发者工具、企业安全、AI 基建），就很容易被联想到——是在为更大的合作或资本动作做准备。</p>
<p>当然，猜想归猜想，能确定的是：Docker 仍在寻找一个能长期自洽的商业答案。</p>
<hr/>
<h2 data-id="heading-12">7）对开发者意味着什么：别太焦虑，技术不会消失，但生态会变📦</h2>
<p>对大多数开发者来说，有两件事是相对确定的：</p>
<ol>
<li>Docker（技术）不会消失：它已经深到工具链和 CI/CD 的骨髓里，替代成本极高。</li>
<li>Docker（公司）的产品重心会继续演化：从 Desktop/HUB 到安全、再到 AI，未来会出现更多“付费增值层”。</li>
</ol>
<p>更现实的建议是：</p>
<ul>
<li>如果团队依赖容器交付：继续用 Docker 没问题，但把“镜像安全”“依赖治理”纳入标准流程（Scout/加固镜像这类能力值得评估）。</li>
<li>如果团队在做 AI 工程化：关注 Compose + Offload、Model Runner 这条路线是否能减少环境割裂与 GPU 资源管理成本。</li>
<li>如果团队需要长期可控：别把某一家厂商当“唯一答案”，把构建、扫描、签名、部署流程做成可替换模块，才是真正的抗风险。</li>
</ul>
<hr/>
<h2 data-id="heading-13">结语</h2>
<p>Docker 的“尴尬”其实是开源成功者的共同难题🙂</p>
<p>Docker 的故事像一面镜子：当你做出一个改变世界的开源技术，它越成功，就越像水和电一样“理所当然”；而越理所当然，就越难直接变现。
于是公司必须不断寻找新的附加价值：开发者效率、安全、AI、企业能力……每一张牌都能理解，但能否拼成一条长期可持续的路线，还要看接下来的几年。</p>
<hr/>
<p><strong>喜欢就奖励一个“👍”和“在看”呗~</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bed040c07dcd44c4be05fa90997a8914~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGNz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770467281&amp;x-signature=O0BjU32LWik5n3OZYdXi6tFmBWE%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Clawdbot 是如何实现永久记忆的？]]></title>    <link>https://juejin.cn/post/7601053058857156614</link>    <guid>https://juejin.cn/post/7601053058857156614</guid>    <pubDate>2026-01-31T12:28:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601053058857156614" data-draft-id="7601053058857140230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Clawdbot 是如何实现永久记忆的？"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-31T12:28:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿DD"/> <meta itemprop="url" content="https://juejin.cn/user/131597123993358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Clawdbot 是如何实现永久记忆的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/131597123993358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿DD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T12:28:56.000Z" title="Sat Jan 31 2026 12:28:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否曾经和AI助手聊了一整晚，第二天打开对话却发现它完全忘了你们讨论过的关键细节？或者当你在多个项目之间切换时，AI总是在问"你指的是哪个API"，让你不厌其烦地重复背景信息。这种"金鱼式记忆"是当下大多数云端AI产品的通病——它们要么只能记住有限的上下文，要么把所有数据都存储在厂商的服务器上。</p>
<p>但如果有一个AI助手，它能像一位真正的私人助理那样，永远记住你的偏好、你的项目细节、甚至你三个月前提过的小习惯？更妙的是，这些记忆完全存储在你自己的电脑上，由你全权掌控。</p>
<p>这就是Clawdbot正在做的事情。作为一款开源的个人AI助手，Clawdbot在GitHub上已经获得了超过125,000个Star。与运行在云端的ChatGPT或Claude不同，Clawdbot直接运行在你的本地机器上，并且能够集成到你日常使用的聊天平台中（Discord、WhatsApp、Telegram等）。</p>
<p>它不仅是一个聊天机器人，更是一个能自主处理实际任务的助手：管理邮件、安排日历、处理航班值机、按计划运行后台任务。但最吸引我的是它的持久化记忆系统——它能实现24/7的全天候上下文保持，记住对话内容，并无限期地基于之前的交互进行累积。</p>
<p>如果你读过我之前关于ChatGPT记忆和Claude记忆的文章，就知道我对不同AI产品如何处理记忆这个问题非常着迷。Clawdbot采用了一种截然不同的方法：它不是基于云端、由公司控制的记忆，而是将一切保存在本地，让用户完全拥有自己的上下文和技能数据。</p>
<p>让我们一起深入了解它是如何工作的。</p>
<blockquote>
<p>以下内容翻译自<a href="https://link.juejin.cn?target=https%3A%2F%2Fmanthanguptaa.in%2Fposts%2Fclawdbot_memory" target="_blank" title="https://manthanguptaa.in/posts/clawdbot_memory" ref="nofollow noopener noreferrer">《How Clawdbot Remembers Everything》</a></p>
</blockquote>
<h2 data-id="heading-0">上下文是如何构建的</h2>
<p>在深入探讨记忆之前，我们先来理解模型在每次请求时能看到什么：</p>
<pre><code class="hljs language-text" lang="text">[0] 系统提示词（静态指令 + 条件指令）
[1] 项目上下文（引导文件：AGENTS.md、SOUL.md 等）
[2] 对话历史（消息、工具调用、压缩摘要）
[3] 当前消息
</code></pre>
<p>系统提示词定义了Agent的能力和可用工具。与记忆相关的是"项目上下文"，它包含了用户可编辑的Markdown文件，这些文件会被注入到每次请求中：</p>
<p>这些文件位于Agent的工作空间中，与记忆文件并存，使得整个Agent的配置变得透明且可编辑。</p>
<h2 data-id="heading-1">上下文 vs 记忆</h2>
<p>理解上下文和记忆之间的区别，是理解Clawdbot的基础。</p>
<p><strong>上下文</strong>是模型在单次请求中能看到的一切：</p>
<pre><code class="hljs language-text" lang="text">上下文 = 系统提示词 + 对话历史 + 工具结果 + 附件
</code></pre>
<p>上下文的特性：</p>
<ul>
<li><strong>临时的</strong>——只存在于本次请求期间</li>
<li><strong>有限的</strong>——受限于模型的上下文窗口（例如20万token）</li>
<li><strong>昂贵的</strong>——每个token都计入API成本和速度</li>
</ul>
<p><strong>记忆</strong>是存储在磁盘上的内容：</p>
<pre><code class="hljs language-text" lang="text">记忆 = MEMORY.md + memory/*.md + 会话转录文件
</code></pre>
<p>记忆的特性：</p>
<ul>
<li><strong>持久的</strong>——在重启、日复一日、月复一月后依然存在</li>
<li><strong>无限的</strong>——可以无限增长</li>
<li><strong>低成本的</strong>——存储不产生API费用</li>
<li><strong>可搜索的</strong>——建立索引以支持语义检索</li>
</ul>
<h2 data-id="heading-2">记忆工具</h2>
<p>Agent通过两个专用工具来访问记忆：</p>
<h3 data-id="heading-3">1. memory_search</h3>
<p><strong>用途</strong>：在所有文件中查找相关的记忆</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"memory_search"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"强制性回忆步骤：在回答关于之前工作、决策、日期、人员、偏好或待办事项的问题之前，对MEMORY.md和memory/*.md进行语义搜索"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"query"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我们对API做了什么决定？"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"maxResults"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"minScore"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.35</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回结果</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"results"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"memory/2026-01-20.md"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"startLine"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">45</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"endLine"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">52</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"score"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.87</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"snippet"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"## API 讨论\n决定为了简单起见使用REST而不是GraphQL..."</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"source"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"memory"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"provider"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"openai"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"model"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text-embedding-3-small"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4">2. memory_get</h3>
<p><strong>用途</strong>：在找到内容后读取具体内容</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"memory_get"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"在使用memory_search后，从记忆文件中读取特定行"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"memory/2026-01-20.md"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"from"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">45</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lines"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">15</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回结果</strong>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"memory/2026-01-20.md"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"## API 讨论\n\n与团队讨论API架构。\n\n### 决策\n我们选择REST而非GraphQL，原因如下：\n1. 实现更简单\n2. 更好的缓存支持\n3. 团队更熟悉\n\n### 端点\n- GET /users\n- POST /auth/login\n- GET /projects/:id"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">写入记忆</h3>
<p>并没有专门的memory_write工具。Agent使用标准的写入和编辑工具来写入记忆——这些工具它本来就在用于处理任何文件。由于记忆就是普通的Markdown，你也可以手动编辑这些文件（它们会被自动重新索引）。</p>
<p>写入位置的决策是通过AGENTS.md中的提示来驱动的：</p>
<p>在预压缩刷新和会话结束时，也会自动进行写入（后续章节会介绍）。</p>
<h2 data-id="heading-6">记忆存储</h2>
<p>Clawdbot的记忆系统建立在"记忆就是Agent工作空间中的纯Markdown"这一原则之上。</p>
<h3 data-id="heading-7">双层记忆系统</h3>
<p>记忆位于Agent的工作空间中（默认：~/clawd/）：</p>
<pre><code class="hljs language-text" lang="text">~/clawd/
├── MEMORY.md              - 第二层：长期策划的知识
└── memory/
    ├── 2026-01-26.md      - 第一层：今天的笔记
    ├── 2026-01-25.md      - 昨天的笔记
    ├── 2026-01-24.md      - ...以此类推
    └── ...
</code></pre>
<p><strong>第一层：每日日志（memory/YYYY-MM-DD.md）</strong></p>
<p>这些是仅追加的每日笔记，Agent会在一天中随时写入。当Agent想要记住某事，或被明确告知要记住某事时，就会写入这里。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 2026-01-26</span>

<span class="hljs-section">## 10:30 AM - API 讨论</span>
与用户讨论REST vs GraphQL。决策：为了简单使用REST。
关键端点：/users、/auth、/projects。

<span class="hljs-section">## 2:15 PM - 部署</span>
将v2.3.0部署到生产环境。没有问题。

<span class="hljs-section">## 4:00 PM - 用户偏好</span>
用户提到他们喜欢TypeScript胜过JavaScript。
</code></pre>
<p><strong>第二层：长期记忆（MEMORY.md）</strong></p>
<p>这是经过策划的、持久的知识。当发生重大事件、想法、决策、观点和学到的教训时，Agent会写入这里。</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 长期记忆</span>

<span class="hljs-section">## 用户偏好</span>
<span class="hljs-bullet">-</span> 喜欢TypeScript胜过JavaScript
<span class="hljs-bullet">-</span> 喜欢简洁的解释
<span class="hljs-bullet">-</span> 正在做"Acme Dashboard"项目

<span class="hljs-section">## 重要决策</span>
<span class="hljs-bullet">-</span> 2026-01-15：选择PostgreSQL作为数据库
<span class="hljs-bullet">-</span> 2026-01-20：采用REST而非GraphQL
<span class="hljs-bullet">-</span> 2026-01-26：使用Tailwind CSS进行样式设计

<span class="hljs-section">## 关键联系人</span>
<span class="hljs-bullet">-</span> Alice (alice@acme.com) - 设计负责人
<span class="hljs-bullet">-</span> Bob (bob@acme.com) - 后端工程师
</code></pre>
<h3 data-id="heading-8">Agent如何知道要读取记忆</h3>
<p><code>AGENTS.md</code>文件（会自动加载）包含以下指令：</p>
<pre><code class="hljs language-text" lang="text">## 每次会话

在做其他事情之前：
1. 阅读 SOUL.md - 这是你是谁
2. 阅读 USER.md - 这是你在帮助谁
3. 阅读 memory/YYYY-MM-DD.md（今天和昨天）获取近期上下文
4. 如果是在主会话中（与你的主人直接聊天），还要阅读 MEMORY.md

不要请求许可，直接做。
</code></pre>
<h2 data-id="heading-9">记忆如何被索引</h2>
<p>当你保存一个记忆文件时，后台会发生以下事情：</p>
<pre><code class="hljs language-text" lang="text">┌─────────────────────────────────────────────────────────────┐
│  1. 文件保存                                                │
│     ~/clawd/memory/2026-01-26.md                            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  2. 文件监视器检测到变化                                    │
│     Chokidar 监视 MEMORY.md + memory/**/*.md                │
│     防抖1.5秒以批量处理快速写入                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  3. 分块                                                    │
│     分割成约400 token的块，重叠80 token                     │
│                                                             │
│     ┌────────────────┐                                      │
│     │ 块 1           │                                      │
│     │ 第 1-15 行     │──────┐                               │
│     └────────────────┘      │                               │
│     ┌────────────────┐      │ (80 token 重叠)               │
│     │ 块 2           │◄─────┘                               │
│     │ 第 12-28 行    │──────┐                               │
│     └────────────────┘      │                               │
│     ┌────────────────┐      │                               │
│     │ 块 3           │◄─────┘                               │
│     │ 第 25-40 行    │                                      │
│     └────────────────┘                                      │
│                                                             │
│     为什么用400/80？平衡语义连贯性与粒度。                  │
│     重叠确保跨越块边界的事实能被两边捕获。                   │
│     两个值都是可配置的。                                     │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  4. 嵌入                                                    │
│     每个块 -&gt; 嵌入提供商 -&gt; 向量                            │
│                                                             │
│     "讨论REST vs GraphQL" -&gt;                                │
│         OpenAI/Gemini/Local -&gt;                              │
│         [0.12, -0.34, 0.56, ...]  (1536 维)                 │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  5. 存储                                                    │
│     ~/.clawdbot/memory/&lt;agentId&gt;.sqlite                     │
│                                                             │
│     表：                                                    │
│     - chunks (id, path, start_line, end_line, text, hash)   │
│     - chunks_vec (id, embedding)      -&gt; sqlite-vec         │
│     - chunks_fts (text)               -&gt; FTS5 全文搜索      │
│     - embedding_cache (hash, vector)  -&gt; 避免重复嵌入       │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<blockquote>
<p><strong>sqlite-vec</strong> 是一个SQLite扩展，它直接在SQLite中实现向量相似度搜索，无需外部向量数据库。</p>
</blockquote>
<blockquote>
<p><strong>FTS5</strong> 是SQLite内置的全文搜索引擎，为BM25关键词匹配提供支持。两者结合，使Clawdbot能够从一个轻量级数据库文件中运行混合搜索（语义 + 关键词）。</p>
</blockquote>
<h2 data-id="heading-10">记忆如何被搜索</h2>
<p>当你搜索记忆时，Clawdbot会并行运行两种搜索策略。向量搜索（语义）找到意思相同的内容，BM25搜索（关键词）找到包含确切token的内容。</p>
<p>结果通过加权评分合并：</p>
<pre><code class="hljs language-text" lang="text">最终得分 = (0.7 * 向量得分) + (0.3 * 文本得分)
</code></pre>
<p>为什么是70/30？语义相似性是记忆回忆的主要信号，但BM25关键词匹配能捕捉向量可能遗漏的确切术语（名称、ID、日期）。低于minScore阈值（默认0.35）的结果会被过滤掉。所有这些值都是可配置的。</p>
<p>这确保无论你是在搜索概念（"那个数据库的事情"）还是具体内容（"POSTGRES_URL"），都能获得良好的结果。</p>
<h2 data-id="heading-11">多Agent记忆</h2>
<p>Clawdbot支持多个Agent，每个Agent都有完全独立的记忆：</p>
<pre><code class="hljs language-text" lang="text">~/.clawdbot/memory/              # 状态目录（索引）
├── main.sqlite                  # "main" Agent的向量索引
└── work.sqlite                  # "work" Agent的向量索引

~/clawd/                         # "main" Agent工作空间（源文件）
├── MEMORY.md
└── memory/
    └── 2026-01-26.md

~/clawd-work/                    # "work" Agent工作空间（源文件）
├── MEMORY.md
└── memory/
    └── 2026-01-26.md
</code></pre>
<p>Markdown文件（事实来源）位于每个工作空间中，而SQLite索引（派生数据）位于状态目录中。每个Agent都有自己的工作空间和索引。记忆管理器通过agentId + workspaceDir来区分，因此不会自动发生跨Agent记忆搜索。</p>
<p><strong>Agent能读取彼此的记忆吗？</strong> 默认不能。每个Agent只能看到自己的工作空间。但是，工作空间是一个软沙盒（默认工作目录），而不是硬边界。除非启用严格的沙盒机制，否则Agent理论上可以使用绝对路径访问另一个工作空间。</p>
<p>这种隔离对于分离上下文很有用。一个用于WhatsApp的"个人"Agent和一个用于Slack的"工作"Agent，各自拥有独立的记忆和个性。</p>
<h3 data-id="heading-12">压缩</h3>
<p>每个AI模型都有上下文窗口限制。Claude有20万token，GPT-5.1有100万。长对话最终会触及这个上限。</p>
<p>当这种情况发生时，Clawdbot使用压缩：将旧对话总结为紧凑的条目，同时保留最近消息的完整性。</p>
<pre><code class="hljs language-text" lang="text">┌─────────────────────────────────────────────────────────────┐
│  压缩前                                                     │
│  上下文：180,000 / 200,000 token                            │
│                                                             │
│  [第1轮] 用户："我们建个API吧"                              │
│  [第2轮] Agent："好的！你需要什么端点？"                    │
│  [第3轮] 用户："用户和认证相关的"                           │
│  [第4轮] Agent：*创建了500行模式定义*                       │
│  [第5轮] 用户："加上限流功能"                               │
│  [第6轮] Agent：*修改代码*                                  │
│  ...（还有100多轮）...                                      │
│  [第150轮] 用户："状态怎么样了？"                           │
│                                                             │
│  ⚠️ 接近限制                                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  触发压缩                                                   │
│                                                             │
│  1. 将第1-140轮总结为紧凑摘要                               │
│  2. 保留第141-150轮不变（近期上下文）                       │
│  3. 将摘要持久化到JSONL转录文件                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  压缩后                                                     │
│  上下文：45,000 / 200,000 token                             │
│                                                             │
│  [摘要] "构建了带/users、/auth端点的REST API。              │
│   实现了JWT认证、限流（100次/分钟）、PostgreSQL数据库。      │
│   已部署到预发布环境v2.4.0。                                 │
│   当前重点：生产环境部署准备。"                              │
│                                                             │
│  [第141-150轮原样保留]                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-13">自动 vs 手动压缩</h3>
<p><strong>自动</strong>：当接近上下文限制时触发</p>
<ul>
<li>在详细模式下你会看到：🧹 自动压缩完成</li>
<li>原始请求会用压缩后的上下文重试</li>
</ul>
<p><strong>手动</strong>：使用 /compact 命令</p>
<pre><code class="hljs language-bash" lang="bash">/compact 重点关注决策和未解决的问题
</code></pre>
<p>与某些优化不同，压缩会持久化到磁盘。摘要被写入会话的JSONL转录文件，因此未来的会话以压缩后的历史开始。</p>
<h2 data-id="heading-14">记忆刷新</h2>
<p>基于LLM的压缩是一个有损过程。重要信息可能被总结掉并可能丢失。为了应对这一点，Clawdbot使用了预压缩记忆刷新。</p>
<pre><code class="hljs language-text" lang="text">┌─────────────────────────────────────────────────────────────┐
│  上下文接近限制                                             │
│                                                             │
│  ████████████████████████████░░░░░░░░  上下文的75%         │
│                              ↑                              │
│                    超过软阈值                               │
│                    (contextWindow - reserve - softThreshold)│
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  静默记忆刷新轮次                                           │
│                                                             │
│  系统："预压缩记忆刷新。现在存储持久的                      │
│          记忆（使用 memory/YYYY-MM-DD.md）。                │
│          如果没有要存储的，回复 NO_REPLY。"                 │
│                                                             │
│  Agent：审查对话中的重要信息                                │
│         将关键决策/事实写入记忆文件                         │
│         -&gt; NO_REPLY（用户看不到任何内容）                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  安全进行压缩                                               │
│                                                             │
│  重要信息现在已在磁盘上                                     │
│  压缩可以在不丢失知识的情况下进行                           │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p>记忆刷新可以在clawdbot.yaml文件或clawdbot.json文件中配置。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"agents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"defaults"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"compaction"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"reserveTokensFloor"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20000</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"memoryFlush"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"softThresholdTokens"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4000</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"systemPrompt"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"会话接近压缩。现在存储持久的记忆。"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"prompt"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"将持久的笔记写入 memory/YYYY-MM-DD.md；如果没有要存储的，回复 NO_REPLY。"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-15">剪枝</h2>
<p>工具结果可能非常庞大。单个exec命令可能输出5万个字符的日志。剪枝会修剪这些旧输出，而不重写历史。这是一个有损过程，旧输出无法恢复。</p>
<pre><code class="hljs language-text" lang="text">┌─────────────────────────────────────────────────────────────┐
│  剪枝前（内存中）                                           │
│                                                             │
│  工具结果（exec）：[5万个字符的npm install输出]               │
│  工具结果（read）：[大型配置文件，1万个字符]                  │
│  工具结果（exec）：[构建日志，3万个字符]                      │
│  用户："构建成功了吗？"                                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼ （软修剪 + 硬清除）
┌─────────────────────────────────────────────────────────────┐
│  剪枝后（发送给模型）                                       │
│                                                             │
│  工具结果（exec）："npm WARN deprecated...[已截断]           │
│                       ...成功安装。"                        │
│  工具结果（read）："[旧工具结果内容已清除]"                   │
│  工具结果（exec）：[保留 - 太新，不适合剪枝]                  │
│  用户："构建成功了吗？"                                      │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<p>磁盘上的JSONL文件：保持不变（完整输出仍然在那里）</p>
<h3 data-id="heading-16">缓存TTL剪枝</h3>
<p>Anthropic会对提示词前缀进行最多5分钟的缓存，以减少重复调用的延迟和成本。当相同的提示词前缀在TTL窗口内发送时，缓存的token成本降低约90%。TTL过期后，下一个请求必须重新缓存整个提示词。</p>
<p>问题：如果会话在TTL之后闲置，下一个请求会失去缓存，必须以完整的"缓存写入"价格重新缓存完整的对话历史。</p>
<p>缓存TTL剪枝通过在缓存过期后检测并修剪旧工具结果来解决这个问题。更小的提示词重新缓存意味着更低的成本：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"agent"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"contextPruning"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cache-ttl"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"ttl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"600"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"keepLastAssistants"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"softTrim"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"maxChars"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4000</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"headChars"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1500</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"tailChars"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1500</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"hardClear"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"placeholder"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[旧工具结果内容已清除]"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-17">会话生命周期</h2>
<p>会话不会永远持续。它们根据可配置的规则进行重置，为记忆创建自然的边界。默认行为是每天重置。但也有其他模式可用。</p>
<h3 data-id="heading-18">会话记忆钩子</h3>
<p>当你运行 /new 开始一个新会话时，会话记忆钩子可以自动保存上下文：</p>
<pre><code class="hljs language-text" lang="text">/new
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  触发会话记忆钩子                                           │
│                                                             │
│  1. 从结束会话中提取最后15条消息                            │
│  2. 通过LLM生成描述性slug                                   │
│  3. 保存到 ~/clawd/memory/2026-01-26-api-design.md          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  新会话开始                                                 │
│                                                             │
│  之前的上下文现在可以通过 memory_search 搜索                │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-19">总结</h2>
<p>Clawdbot的记忆系统之所以成功，是因为它遵循了几个关键原则：</p>
<p><strong>1. 透明优于黑盒</strong></p>
<p>记忆是纯Markdown。你可以阅读、编辑、版本控制它。没有不透明数据库或专有格式。</p>
<p><strong>2. 搜索优于注入</strong></p>
<p>与其用所有内容塞满上下文，不如让Agent搜索相关内容。这保持上下文聚焦并降低成本。</p>
<p><strong>3. 持久优于会话</strong></p>
<p>重要信息作为文件保存在磁盘上，而不仅仅存在于对话历史中。压缩无法摧毁已经保存的内容。</p>
<p><strong>4. 混合优于单一</strong></p>
<p>纯向量搜索会漏掉精确匹配。纯关键词搜索会漏掉语义。混合搜索两者兼得。</p>
<h2 data-id="heading-20">参考资料</h2>
<ul>
<li>Clawdbot文档(<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.clawd.bot%2F" target="_blank" title="https://docs.clawd.bot/" ref="nofollow noopener noreferrer">docs.clawd.bot/</a>) - 官方文档，涵盖设置、配置和所有功能</li>
<li>GitHub仓库(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fclawdbot%2Fclawdbot" target="_blank" title="https://github.com/clawdbot/clawdbot" ref="nofollow noopener noreferrer">github.com/clawdbot/cl…</a>) - 源代码、问题和社区贡献</li>
</ul>
<p>感谢阅读，如果对Vibe Coding和Agent开发感兴趣，也可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fdidispace.com%2F" target="_blank" title="https://didispace.com/" ref="nofollow noopener noreferrer">关注我的博客：程序猿DD</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个让你效率翻三倍的AI技术博客写作工作流]]></title>    <link>https://juejin.cn/post/7601073900524814378</link>    <guid>https://juejin.cn/post/7601073900524814378</guid>    <pubDate>2026-01-31T12:37:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601073900524814378" data-draft-id="7601076694104064036" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个让你效率翻三倍的AI技术博客写作工作流"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-31T12:37:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿星AI工作室"/> <meta itemprop="url" content="https://juejin.cn/user/2250051536050763"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个让你效率翻三倍的AI技术博客写作工作流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2250051536050763/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿星AI工作室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T12:37:03.000Z" title="Sat Jan 31 2026 12:37:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>因为我自己经常写技术博客。但是在编程的时候往往是顾不上记录知识点的。所以我整理了下面的工作流，帮大家在编程的同时能够积累好写作素材，节约更多时间。</p>
<p>第一，每次编程过程中每做三大步，把踩坑经验都自动写入guidebook，guidebook里的内容就是你的图文创作基石，拿这种踩坑例子去写文章会更有感染力。而且这个也可以防止你的ide突然断片了上下文没了，你就吃瘪了。</p>
<p>第二，新建一个 Writing项目，Writing项目里边包括三个主要文件。</p>
<p>一个文件就是你刚才的guidebook 。每次做完某个项目，把那个guidebook的内容同步到这个Writing项目里边。</p>
<p>一个文件名字是Principle，Principle提炼自你以往推文的写作基因不管是结构上的，还是风格上的。</p>
<p>一个文档是包含写作提示词的正式文档，简单告诉AI基于你的写作principle和guidebook进行一个综合。</p>
<p>第三，每次编程的时候都建立这么一个guidebook，积累多了就可以形成自己的AI编程手册提炼出共性，作为独有的AI编程知识库。特别是一些API的连通，一些特定框架的用法，完全是一些只要有参考就可以复现的东西。如果不记录的话，下次还要重新摸索。</p>
<p>如果有意识地积累，每做一个项目，就等于积累了一个真正的可复用的实操经验。适合小白来弥补自己的知识盲点。</p>
<p>另外，如果你只是想简单保存聊天记录，暂时没空提炼。可以试试一些show me talk插件帮你保存聊天记录，但是你可能自己忘了保存或者意外退出。比如@code-is-cheap。这些都是我平常星球里分享的知识，希望有更多机会。为你分享更有用的工作流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一天一个开源项目（第8篇）：UI/UX Pro Max Skill - AI设计智能助手，让AI帮你构建专业UI/UX]]></title>    <link>https://juejin.cn/post/7601073900524797994</link>    <guid>https://juejin.cn/post/7601073900524797994</guid>    <pubDate>2026-01-31T11:43:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601073900524797994" data-draft-id="7601073900524781610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一天一个开源项目（第8篇）：UI/UX Pro Max Skill - AI设计智能助手，让AI帮你构建专业UI/UX"/> <meta itemprop="keywords" content="前端,UI Kit,开源"/> <meta itemprop="datePublished" content="2026-01-31T11:43:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一天一个开源项目（第8篇）：UI/UX Pro Max Skill - AI设计智能助手，让AI帮你构建专业UI/UX
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T11:43:11.000Z" title="Sat Jan 31 2026 11:43:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>"当AI能够理解设计系统、色彩理论、用户体验原则时，它就不再是简单的代码生成器，而是真正的设计伙伴。"</p>
</blockquote>
<p>这是"一天一个开源项目"系列的第8篇文章。今天带你了解的项目是 <strong>UI/UX Pro Max Skill</strong>（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnextlevelbuilder%2Fui-ux-pro-max-skill" target="_blank" title="https://github.com/nextlevelbuilder/ui-ux-pro-max-skill" ref="nofollow noopener noreferrer">GitHub</a>）。</p>
<p>如果你正在使用Claude Code、Cursor、Windsurf等AI编程助手，并且希望它们能够生成专业、美观、符合设计规范的UI/UX代码，那么UI/UX Pro Max Skill绝对值得你深入了解。它通过24.7k+ Stars的社区认可，证明了AI设计智能的巨大价值。</p>
<h3 data-id="heading-1">你将学到什么</h3>
<ul>
<li>UI/UX Pro Max Skill的核心架构和工作原理</li>
<li>如何为不同AI助手安装和配置这个技能</li>
<li>设计系统自动生成的机制和原理</li>
<li>智能推荐系统如何工作</li>
<li>如何构建分层设计系统（Master + Overrides）</li>
<li>与手动设计相比的优势和局限性</li>
<li>如何在实际项目中应用这个技能</li>
</ul>
<h3 data-id="heading-2">前置知识</h3>
<ul>
<li>对AI编程助手有基本了解（Claude Code、Cursor等）</li>
<li>熟悉UI/UX设计的基本概念</li>
<li>了解设计系统的基本组成</li>
<li>对命令行工具有基本使用经验</li>
</ul>
<hr/>
<h2 data-id="heading-3">项目背景</h2>
<h3 data-id="heading-4">项目简介</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68553e425e7d4263af50c4ca772316db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770464591&amp;x-signature=hpJDEbAjSRog4g%2BhtxwFUKDlS50%3D" alt="08-01-ui-pro-website.png" loading="lazy"/></p>
<p><strong>UI/UX Pro Max Skill</strong> 是一个<strong>为AI编程助手提供设计智能的开源技能</strong>，通过内置的设计系统生成引擎和智能推荐系统，让AI助手能够生成专业、美观、符合设计规范的UI/UX代码。它不仅仅是一个代码生成工具，而是一个完整的设计智能系统。</p>
<p><strong>项目解决的核心问题</strong>：</p>
<ul>
<li>AI生成的UI代码缺乏设计规范，样式混乱</li>
<li>缺乏对色彩理论、排版、间距等设计原则的理解</li>
<li>无法根据产品类型推荐合适的设计风格</li>
<li>缺少设计系统的概念，代码难以维护</li>
<li>不同AI助手平台需要重复配置设计知识</li>
</ul>
<p><strong>面向的用户群体</strong>：</p>
<ul>
<li>使用AI编程助手的开发者</li>
<li>需要快速生成专业UI的前端开发者</li>
<li>缺乏设计背景但需要构建美观界面的开发者</li>
<li>希望提升AI生成代码质量的团队</li>
<li>需要统一设计系统的项目</li>
</ul>
<h3 data-id="heading-5">作者/团队介绍</h3>
<p><strong>团队：nextlevelbuilder</strong></p>
<ul>
<li><strong>背景</strong>：专注于AI工具和设计智能的开源团队</li>
<li><strong>理念</strong>：让AI真正理解设计，而不仅仅是生成代码</li>
<li><strong>项目定位</strong>：AI设计智能的标准解决方案</li>
<li><strong>官网</strong>：ui-ux-pro-max-skill.nextlevelbuilder.io</li>
</ul>
<p><strong>项目创建时间</strong>：2024年（从GitHub活动来看是持续活跃的项目）</p>
<h3 data-id="heading-6">项目数据</h3>
<ul>
<li>⭐ <strong>GitHub Stars</strong>: 24.7k+（持续快速增长）</li>
<li>🍴 <strong>Forks</strong>: 2.5k+</li>
<li>📦 <strong>版本</strong>: v2.2.1（最新版本，2026年1月26日发布）</li>
<li>📄 <strong>License</strong>: MIT（完全开源，自由使用）</li>
<li>🌐 <strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fui-ux-pro-max-skill.nextlevelbuilder.io" target="_blank" title="https://ui-ux-pro-max-skill.nextlevelbuilder.io" ref="nofollow noopener noreferrer">ui-ux-pro-max-skill.nextlevelbuilder.io</a></li>
<li>📚 <strong>文档</strong>: 包含完整的使用指南和API文档</li>
<li>💬 <strong>社区</strong>: GitHub Issues和Discussions活跃</li>
<li>👥 <strong>贡献者</strong>: 27位贡献者，活跃的社区参与</li>
</ul>
<p><strong>项目发展历程</strong>：</p>
<ul>
<li>2024年：项目创建，开始构建核心设计智能引擎</li>
<li>2024年中：添加多平台支持，扩展到20+AI助手</li>
<li>2024年底：引入分层设计系统（Master + Overrides）</li>
<li>2025年：完善CLI工具，优化安装体验</li>
<li>2026年：持续优化，社区活跃度持续提升</li>
</ul>
<hr/>
<h2 data-id="heading-7">主要功能</h2>
<h3 data-id="heading-8">核心作用</h3>
<p>UI/UX Pro Max Skill的核心作用是<strong>为AI编程助手注入设计智能</strong>，主要功能包括：</p>
<ol>
<li><strong>自动生成设计系统</strong>：根据产品类型自动生成完整设计系统（色彩、字体、间距、组件规范）</li>
<li><strong>智能样式推荐</strong>：基于产品领域推荐最佳样式方案</li>
<li><strong>代码质量保障</strong>：生成符合UI/UX最佳实践的代码，自动检测设计反模式</li>
<li><strong>多平台支持</strong>：支持Web（HTML+Tailwind、React、Vue）、移动端（SwiftUI、Jetpack Compose）、跨平台（React Native、Flutter）</li>
<li><strong>分层设计系统</strong>：支持Master设计系统和页面级覆盖</li>
</ol>
<h3 data-id="heading-9">快速开始</h3>
<h4 data-id="heading-10">安装方式</h4>
<p>UI/UX Pro Max Skill支持多种安装方式：</p>
<p><strong>方式1：通过Claude Marketplace（Claude Code）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在Claude Code中直接安装</span>
/plugin marketplace add nextlevelbuilder/ui-ux-pro-max-skill
/plugin install ui-ux-pro-max@ui-ux-pro-max-skill
</code></pre>
<p><strong>方式2：使用CLI工具（推荐）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装CLI工具</span>
npm install -g uipro-cli

<span class="hljs-comment"># 为你的AI助手安装技能</span>
<span class="hljs-built_in">cd</span> /path/to/your/project

<span class="hljs-comment"># 支持多种AI助手</span>
uipro init --ai claude      <span class="hljs-comment"># Claude Code</span>
uipro init --ai cursor      <span class="hljs-comment"># Cursor</span>
uipro init --ai windsurf    <span class="hljs-comment"># Windsurf</span>
uipro init --ai antigravity <span class="hljs-comment"># Antigravity</span>
uipro init --ai copilot     <span class="hljs-comment"># GitHub Copilot</span>
uipro init --ai codex       <span class="hljs-comment"># Codex CLI</span>
uipro init --ai gemini       <span class="hljs-comment"># Gemini CLI</span>
uipro init --ai opencode    <span class="hljs-comment"># OpenCode</span>
uipro init --ai all         <span class="hljs-comment"># 所有支持的助手</span>
</code></pre>
<p><strong>其他CLI命令</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">uipro versions      <span class="hljs-comment"># 查看可用版本</span>
uipro update        <span class="hljs-comment"># 更新到最新版本</span>
uipro init --offline  <span class="hljs-comment"># 离线安装（使用本地资源）</span>
</code></pre>
<h4 data-id="heading-11">前置要求</h4>
<p>Python 3.x是必需的（用于搜索脚本）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查Python版本</span>
python3 --version

<span class="hljs-comment"># macOS安装</span>
brew install python3

<span class="hljs-comment"># Ubuntu/Debian安装</span>
sudo apt update &amp;&amp; sudo apt install python3

<span class="hljs-comment"># Windows安装</span>
winget install Python.Python.3.12
</code></pre>
<h4 data-id="heading-12">最简单的使用示例</h4>
<p><strong>Skill模式（自动激活）</strong></p>
<p>支持的平台：Claude Code, Windsurf, Antigravity, Codex CLI, Continue, Gemini CLI, OpenCode, Qoder, CodeBuddy</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 直接对话，技能会自动激活</span>
Build a landing page <span class="hljs-keyword">for</span> my SaaS product
</code></pre>
<p><strong>Workflow模式（斜杠命令）</strong></p>
<p>支持的平台：Cursor, Kiro, GitHub Copilot, Roo Code</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用斜杠命令</span>
/ui-ux-pro-max Build a landing page <span class="hljs-keyword">for</span> my SaaS product
</code></pre>
<p><strong>示例提示词</strong>：</p>
<pre><code class="hljs language-css" lang="css">Build <span class="hljs-selector-tag">a</span> landing page for my SaaS product
Create <span class="hljs-selector-tag">a</span> dashboard for healthcare analytics
Design <span class="hljs-selector-tag">a</span> portfolio website with dark mode
Make <span class="hljs-selector-tag">a</span> mobile app UI for e-commerce
Build <span class="hljs-selector-tag">a</span> fintech banking app with dark theme
</code></pre>
<p>我通过一行提示词生成的项目管理网站首页UI界面</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5186ba9f69e4ce698c62b0ae1e49a86~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770464591&amp;x-signature=U%2BSLCGBbkPFmSGDDWqJ6oORDzOE%3D" alt="08-02-ui-pro-demo.png" loading="lazy"/></p>
<h3 data-id="heading-13">核心特性</h3>
<ul>
<li><strong>自动设计系统生成</strong>：根据产品类型生成完整设计系统，支持10+个专业领域知识库</li>
<li><strong>智能推荐引擎</strong>：基于产品类型推荐最佳样式，考虑用户体验和可访问性</li>
<li><strong>多技术栈支持</strong>：Web（HTML+Tailwind、React、Vue等）、iOS（SwiftUI）、Android（Jetpack Compose）、跨平台（React Native、Flutter）</li>
<li><strong>分层设计系统</strong>：Master设计系统 + 页面级覆盖，智能检索和优先级管理</li>
<li><strong>设计规范检查</strong>：自动检测UI/UX反模式，提供改进建议</li>
<li><strong>CLI工具</strong>：统一安装管理，支持离线安装和版本管理</li>
<li><strong>模板系统</strong>：基于模板的代码生成，平台特定模板支持</li>
</ul>
<h3 data-id="heading-14">项目优势</h3>





















































<table><thead><tr><th align="left">对比项</th><th align="left">UI/UX Pro Max Skill</th><th align="left">手动设计</th><th align="left">其他AI设计工具</th></tr></thead><tbody><tr><td align="left"><strong>设计智能</strong></td><td align="left">✅ 内置完整设计系统</td><td align="left">❌ 需要手动设计</td><td align="left">⚠️ 有限设计知识</td></tr><tr><td align="left"><strong>多平台支持</strong></td><td align="left">✅ 20+AI助手</td><td align="left">❌ 无</td><td align="left">⚠️ 单一平台</td></tr><tr><td align="left"><strong>自动推荐</strong></td><td align="left">✅ 智能样式推荐</td><td align="left">❌ 需要经验</td><td align="left">⚠️ 基础推荐</td></tr><tr><td align="left"><strong>设计系统</strong></td><td align="left">✅ 自动生成</td><td align="left">❌ 手动构建</td><td align="left">⚠️ 部分支持</td></tr><tr><td align="left"><strong>代码质量</strong></td><td align="left">✅ 符合最佳实践</td><td align="left">⚠️ 依赖经验</td><td align="left">⚠️ 不一致</td></tr><tr><td align="left"><strong>学习曲线</strong></td><td align="left">✅ 开箱即用</td><td align="left">❌ 需要学习</td><td align="left">⚠️ 需要配置</td></tr><tr><td align="left"><strong>社区支持</strong></td><td align="left">✅ 24.7k+ Stars</td><td align="left">❌ 无</td><td align="left">⚠️ 有限</td></tr></tbody></table>
<p><strong>为什么选择UI/UX Pro Max Skill？</strong></p>
<p>相比手动设计和其他AI设计工具，UI/UX Pro Max Skill提供完整的设计系统生成引擎、智能推荐、20+AI助手支持、10+领域知识库，开箱即用，社区活跃（24.7k+ Stars）。</p>
<hr/>
<h2 data-id="heading-15">项目详细剖析</h2>
<h3 data-id="heading-16">架构设计</h3>
<p>UI/UX Pro Max Skill采用<strong>模块化、可扩展的架构</strong>，主要包含以下几个核心模块：</p>
<h4 data-id="heading-17">核心架构</h4>
<pre><code class="hljs language-arduino" lang="arduino">UI/UX Pro Max Skill
├── CLI工具层
│   ├── 安装器（uipro-cli）
│   ├── 模板生成系统
│   └── 版本管理
├── 技能层（.claude/skills/ui-ux-pro-max）
│   ├── 技能定义文件
│   ├── 提示词模板
│   └── 平台适配器
├── 数据层（data/）
│   ├── 设计知识库（CSV格式）
│   ├── 样式数据库
│   ├── 色彩方案库
│   └── 字体库
├── 脚本层（scripts/）
│   ├── search.py（搜索和推理引擎）
│   ├── 设计系统生成器
│   └── 推荐算法
└── 模板层（templates/）
    ├── 平台特定模板
    ├── 组件模板
    └── 页面模板
</code></pre>
<h4 data-id="heading-18">设计系统生成引擎</h4>
<p>核心是Python脚本<code>search.py</code>，实现设计系统的自动生成。流程包括：1) 分析产品类型和需求；2) 从知识库检索设计知识（色彩、字体、样式、组件、领域特定知识）；3) 应用推理引擎生成设计系统；4) 验证和优化设计系统。</p>
<h4 data-id="heading-19">智能推荐系统</h4>
<p>推荐系统基于产品类型和领域知识进行智能匹配，推荐维度包括：色彩方案（基于产品类型、目标用户、品牌调性、可访问性）、字体方案（基于可读性和品牌）、间距系统（基于平台和内容）、组件风格（基于交互需求）。通过相似度计算返回Top 3推荐方案。</p>
<h4 data-id="heading-20">分层设计系统（Master + Overrides）</h4>
<p>支持分层设计系统，Master系统包含全局色彩、字体、间距、组件规范，页面覆盖只包含与Master不同的规则。检索逻辑：如果指定页面，先检查页面覆盖文件；如果存在，合并Master和页面规则；否则只使用Master规则。</p>
<h3 data-id="heading-21">知识库系统</h3>
<p>UI/UX Pro Max Skill的核心是设计知识库，包含10+个领域的专业设计知识：</p>
<h4 data-id="heading-22">知识库结构</h4>
<pre><code class="hljs language-bash" lang="bash">data/
├── colors.csv          <span class="hljs-comment"># 色彩方案库</span>
├── typography.csv      <span class="hljs-comment"># 字体方案库</span>
├── styles.csv          <span class="hljs-comment"># 样式方案库</span>
├── components.csv      <span class="hljs-comment"># 组件规范库</span>
└── domain/             <span class="hljs-comment"># 领域特定知识</span>
    ├── saas.csv        <span class="hljs-comment"># SaaS产品设计</span>
    ├── ecommerce.csv   <span class="hljs-comment"># 电商设计</span>
    ├── fintech.csv     <span class="hljs-comment"># 金融科技设计</span>
    ├── healthcare.csv  <span class="hljs-comment"># 医疗健康设计</span>
    ├── education.csv   <span class="hljs-comment"># 教育设计</span>
    └── ...
</code></pre>
<h4 data-id="heading-23">知识库内容示例</h4>
<p><strong>色彩方案库（colors.csv）</strong>：</p>
<pre><code class="hljs language-csv" lang="csv">product_type,industry,tone,primary_color,secondary_color,accent_color,background_color,text_color
SaaS,B2B,professional,#2563EB,#1E40AF,#3B82F6,#FFFFFF,#1F2937
SaaS,B2C,friendly,#10B981,#059669,#34D399,#F9FAFB,#111827
Ecommerce,Retail,vibrant,#EC4899,#DB2777,#F472B6,#FFFFFF,#1F2937
Fintech,Finance,trustworthy,#1E40AF,#1E3A8A,#3B82F6,#F8FAFC,#0F172A
Healthcare,Medical,calm,#059669,#047857,#10B981,#FFFFFF,#064E3B
</code></pre>
<p><strong>字体方案库（typography.csv）</strong>：</p>
<pre><code class="hljs language-csv" lang="csv">product_type,heading_font,body_font,font_size_scale,line_height_scale
SaaS,Inter,Inter,1.25,1.5
Ecommerce,Poppins,Inter,1.2,1.6
Fintech,Roboto,Roboto,1.15,1.5
Healthcare,Open Sans,Open Sans,1.3,1.7
</code></pre>
<h4 data-id="heading-24">领域特定知识</h4>
<p>每个领域都有专门的设计知识库，包含：</p>
<ul>
<li><strong>行业最佳实践</strong>：该领域的UI/UX最佳实践</li>
<li><strong>用户行为模式</strong>：目标用户的使用习惯</li>
<li><strong>设计趋势</strong>：当前流行的设计风格</li>
<li><strong>可访问性要求</strong>：行业特定的可访问性标准</li>
<li><strong>合规要求</strong>：法律法规要求（如金融、医疗）</li>
</ul>
<h3 data-id="heading-25">多平台适配系统</h3>
<p>UI/UX Pro Max Skill通过模板系统支持多种AI助手平台：</p>
<h4 data-id="heading-26">平台适配架构</h4>
<p>通过<code>PlatformAdapter</code>接口实现平台适配，每个AI助手（Claude Code、Cursor等）都有独立的适配器。Claude Code支持自动激活，Cursor使用斜杠命令。CLI工具使用模板系统动态生成平台特定文件，从<code>templates/</code>目录加载模板并生成技能文件、配置文件和脚本。</p>
<h3 data-id="heading-27">设计规范检查系统</h3>
<p>UI/UX Pro Max Skill内置设计规范检查，自动检测常见反模式：</p>
<h4 data-id="heading-28">反模式检测</h4>
<p>设计规范检查系统自动检测常见反模式：色彩对比度不足（WCAG AA标准）、字体大小过小、间距不一致、组件使用不当、可访问性问题。检测器解析代码中的设计元素，对照设计系统规范，返回问题列表和改进建议。</p>
<h3 data-id="heading-29">工作流程</h3>
<p>UI/UX Pro Max Skill的完整工作流程：</p>
<pre><code class="hljs language-markdown" lang="markdown">用户请求UI/UX任务
<span class="hljs-code">    ↓
技能自动激活（Skill模式）或通过命令激活（Workflow模式）
    ↓
分析产品类型和需求
    ↓
从知识库检索相关设计知识
    ↓
应用推理引擎生成设计系统
    ↓
智能推荐最佳样式方案
    ↓
生成符合设计系统的代码
    ↓
执行设计规范检查
    ↓
返回生成的代码和改进建议
</span></code></pre>
<hr/>
<h2 data-id="heading-30">项目地址与资源</h2>
<h3 data-id="heading-31">官方资源</h3>
<ul>
<li>🌟 <strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnextlevelbuilder%2Fui-ux-pro-max-skill" target="_blank" title="https://github.com/nextlevelbuilder/ui-ux-pro-max-skill" ref="nofollow noopener noreferrer">github.com/nextlevelbu…</a></li>
<li>🌐 <strong>官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fui-ux-pro-max-skill.nextlevelbuilder.io" target="_blank" title="https://ui-ux-pro-max-skill.nextlevelbuilder.io" ref="nofollow noopener noreferrer">ui-ux-pro-max-skill.nextlevelbuilder.io</a></li>
<li>📚 <strong>文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnextlevelbuilder%2Fui-ux-pro-max-skill%23readme" target="_blank" title="https://github.com/nextlevelbuilder/ui-ux-pro-max-skill#readme" ref="nofollow noopener noreferrer">GitHub README</a></li>
<li>💬 <strong>社区</strong>: GitHub Discussions</li>
<li>🐛 <strong>Issue Tracker</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnextlevelbuilder%2Fui-ux-pro-max-skill%2Fissues" target="_blank" title="https://github.com/nextlevelbuilder/ui-ux-pro-max-skill/issues" ref="nofollow noopener noreferrer">GitHub Issues</a></li>
<li>📦 <strong>最新版本</strong>: v2.2.1（2026年1月26日发布）</li>
</ul>
<h3 data-id="heading-32">适用人群</h3>
<p><strong>UI/UX Pro Max Skill特别适合</strong>：需要快速生成专业UI代码的前端开发者、缺乏设计背景的全栈开发者、需要建立设计系统的项目、使用Claude Code/Cursor等AI助手的开发者、需要统一设计规范的团队。</p>
<p><strong>不适合</strong>：不需要AI辅助的资深设计师、只需要简单代码生成的用户、不使用AI编程助手的开发者。</p>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Claude Code:架构、上下文与工具系统]]></title>    <link>https://juejin.cn/post/7601034810313080886</link>    <guid>https://juejin.cn/post/7601034810313080886</guid>    <pubDate>2026-01-31T11:49:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601034810313080886" data-draft-id="7600994087589117971" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Claude Code:架构、上下文与工具系统"/> <meta itemprop="keywords" content="AI编程,Claude,前端"/> <meta itemprop="datePublished" content="2026-01-31T11:49:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Claude Code:架构、上下文与工具系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T11:49:35.000Z" title="Sat Jan 31 2026 11:49:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在上一篇文章中,我们通过 Todo List 项目体验了 Claude Code 的强大能力。你可能会好奇:为什么 Claude Code 能如此"聪明"地理解需求、规划任务、执行操作?它是如何在不同文件间穿梭自如,记住上下文,并在出错时自我修复的?</p>
<p>理解这些原理并不是为了"炫技",而是为了<strong>更好地使用工具</strong>。就像开车,你不需要成为汽车工程师,但了解发动机、变速箱的基本原理,能让你更好地驾驭车辆,出现问题时也能快速判断根因。</p>
<p>本文将深入 Claude Code 的"引擎室",解析其核心架构和工作机制。阅读本文后,你将能够:</p>
<ul>
<li><strong>理解为什么 Claude Code 有时会"忘记"之前的内容</strong>(上下文管理)</li>
<li><strong>知道如何让 Claude Code 更高效地工作</strong>(合理使用工具)</li>
<li><strong>掌握 Agent 的协作模式</strong>(什么时候自动调用子 Agent)</li>
<li><strong>优化开发体验</strong>(避免常见陷阱,提升响应速度)</li>
</ul>
<p>让我们从一个真实场景开始:</p>
<blockquote>
<p>场景:你让 Claude Code 重构一个大型项目,它先用 Glob 搜索所有相关文件,然后逐个 Read 文件内容,接着开始修改代码...突然,你发现它"忘记"了最开始分析的架构设计,开始做一些不符合预期的修改。</p>
</blockquote>
<p>这不是 Bug,而是<strong>上下文管理</strong>的必然结果。理解了这一点,你就能调整使用策略,避免这类问题。</p>
<hr/>
<h2 data-id="heading-1">一、Claude Code 的整体架构</h2>
<h3 data-id="heading-2">1.1 核心架构设计</h3>
<p>Claude Code 采用<strong>分层架构</strong>,每一层各司其职:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d4baaff4177431485a2a732dcd7e228~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770464974&amp;x-signature=abXWOTG4bprEtvKXjl%2FF2sTUObI%3D" alt="02-01-architecture-overview.png" loading="lazy"/></p>
<p><em>图1: Claude Code 分层架构设计,展示了从用户输入到 API 调用的完整数据流</em></p>
<p><strong>为什么这样设计?</strong></p>
<ol>
<li><strong>意图理解与工具执行分离</strong>:让 AI 专注于"想做什么",而不是"怎么做"</li>
<li><strong>Agent 编排层实现灵活扩展</strong>:可以随时添加新的专业 Agent</li>
<li><strong>上下文管理独立</strong>:优化 Token 使用,提升响应速度</li>
<li><strong>工具层标准化</strong>:所有工具遵循统一接口,易于扩展</li>
</ol>
<h3 data-id="heading-3">1.2 架构的实际影响</h3>
<p><strong>场景 1:为什么 Claude Code 能处理大型项目?</strong></p>
<p>传统 AI 助手通常有<strong>上下文长度限制</strong>(如 8K tokens),一个稍大的文件就会超限。Claude Code 通过:</p>
<ul>
<li><strong>按需加载</strong>:只读取必要的文件</li>
<li><strong>智能总结</strong>:对长文件进行摘要</li>
<li><strong>分层缓存</strong>:频繁访问的内容优先保留</li>
</ul>
<p>这样即使项目有上千个文件,也能高效处理。</p>
<p><strong>场景 2:为什么有时响应很慢?</strong></p>
<p>当你的请求触发了以下行为,响应会变慢:</p>
<ul>
<li>调用多个子 Agent(如先 Explore 再 Plan)</li>
<li>读取大量文件(每次 Read 都是 API 调用)</li>
<li>执行耗时命令(如 npm install)</li>
</ul>
<p>理解这一点,你就知道如何优化:<strong>明确指定文件路径</strong>,而不是让它全局搜索。</p>
<h3 data-id="heading-4">1.3 与其他 AI 工具的架构对比</h3>



































<table><thead><tr><th align="left">工具</th><th align="left">架构模式</th><th align="left">工具调用</th><th align="left">上下文管理</th></tr></thead><tbody><tr><td align="left"><strong>Claude Code</strong></td><td align="left">分层 Agent 架构</td><td align="left">丰富工具链</td><td align="left">智能压缩 + 缓存</td></tr><tr><td align="left">GitHub Copilot</td><td align="left">IDE 插件模式</td><td align="left">无独立工具</td><td align="left">仅当前文件</td></tr><tr><td align="left">Cursor</td><td align="left">IDE 集成 + Agent</td><td align="left">部分工具支持</td><td align="left">项目级上下文</td></tr><tr><td align="left">ChatGPT</td><td align="left">Web 对话</td><td align="left">无系统工具</td><td align="left">纯对话历史</td></tr></tbody></table>
<p>Claude Code 的架构优势在于:<strong>完整的任务闭环能力</strong>——从理解需求到执行验证,全程自动化。</p>
<hr/>
<h2 data-id="heading-5">二、上下文管理:Claude Code 的记忆系统</h2>
<h3 data-id="heading-6">2.1 什么是上下文?</h3>
<p>在 AI 对话中,**上下文(Context)**包括:</p>
<ol>
<li><strong>对话历史</strong>:你和 Claude Code 的所有交互记录</li>
<li><strong>文件内容</strong>:读取过的代码、配置文件</li>
<li><strong>命令输出</strong>:执行命令的结果</li>
<li><strong>项目元信息</strong>:技术栈、目录结构、依赖关系</li>
</ol>
<p>Claude Code 需要在<strong>有限的 Token 预算</strong>内(如 200K tokens)管理这些信息。</p>
<h3 data-id="heading-7">2.2 上下文管理策略</h3>
<h4 data-id="heading-8">策略 1:分层优先级</h4>
<p>Claude Code 对上下文内容设置不同优先级:</p>
<pre><code class="hljs language-markdown" lang="markdown">高优先级 (Always Keep):
<span class="hljs-bullet">  -</span> 用户当前输入
<span class="hljs-bullet">  -</span> 最近 3 轮对话
<span class="hljs-bullet">  -</span> 正在编辑的文件
<span class="hljs-bullet">  -</span> 任务列表 (Todo List)

中优先级 (Conditionally Keep):
<span class="hljs-bullet">  -</span> 最近读取的文件(10分钟内)
<span class="hljs-bullet">  -</span> 相关代码片段
<span class="hljs-bullet">  -</span> 命令执行结果

低优先级 (Can Be Summarized):
<span class="hljs-bullet">  -</span> 早期对话历史
<span class="hljs-bullet">  -</span> 已完成的任务
<span class="hljs-bullet">  -</span> 大型文件的完整内容
</code></pre>
<p><strong>实际影响</strong>:</p>
<p>你可能遇到过这种情况:</p>
<pre><code class="hljs language-csharp" lang="csharp">用户: 帮我重构用户认证模块
[<span class="hljs-meta">Claude 分析了 10 个文件,制定了方案</span>]

用户: (<span class="hljs-number">10</span>分钟后) 现在实现第一步
[<span class="hljs-meta">Claude: <span class="hljs-string">"请问你希望重构哪个模块?"</span></span>]
</code></pre>
<p>这是因为早期的对话被<strong>总结压缩</strong>了,细节丢失。解决方法:</p>
<ul>
<li>保持连续对话,不要中断太久</li>
<li>关键信息写入 <code>claude.md</code> 或 Todo List</li>
</ul>
<h4 data-id="heading-9">策略 2:智能总结与压缩</h4>
<p>当上下文接近 Token 限制时,Claude Code 会:</p>
<ol>
<li>
<p><strong>自动触发总结</strong>:
[System] Context approaching limit (180K/200K tokens)
[System] Summarizing conversation...
[System] Preserved key information:
- Task: Refactor user authentication
- Files modified: Auth.ts, Login.tsx
- Current status: Step 2 of 5 in progress</p>
</li>
<li>
<p><strong>保留核心信息</strong>:</p>
<ul>
<li>任务目标和进度</li>
<li>关键代码片段</li>
<li>错误和警告信息</li>
</ul>
</li>
<li>
<p><strong>压缩历史对话</strong>:</p>
<ul>
<li>合并相似轮次</li>
<li>删除冗余内容</li>
<li>提取关键决策点</li>
</ul>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26dd3e96997d437fa219c7d80e6c2b57~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770464974&amp;x-signature=K54AgvZAsixB5CEfBgWBT7Y%2BLLk%3D" alt="02-02-context-compression.png" loading="lazy"/></p>
<p><em>图2: 上下文压缩机制,当接近 Token 限制时自动触发优化流程</em></p>
<p><strong>真实案例</strong>:</p>
<p>在重构一个 5000 行的大文件时:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始:完整读取文件(~8000 tokens)</span>
&gt; 帮我分析 UserService.ts 的问题

[Claude 读取完整文件,进行分析...]

<span class="hljs-comment"># 10分钟后:文件被压缩为摘要(~500 tokens)</span>
&gt; 现在优化第 3 个方法

[Claude 重新读取文件,因为摘要不包含方法细节]
</code></pre>
<p><strong>优化技巧</strong>:</p>
<ul>
<li>大文件分阶段处理,每次专注一个部分</li>
<li>使用 <code>--context-window</code> 参数增大上下文限制</li>
<li>关键信息复制到单独的小文件中</li>
</ul>
<h4 data-id="heading-10">策略 3:文件缓存机制</h4>
<p>Claude Code 对读取过的文件进行缓存:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 伪代码:文件缓存逻辑</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">FileCache</span> {
  <span class="hljs-attr">path</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>;
  <span class="hljs-attr">accessCount</span>: <span class="hljs-built_in">number</span>;
  summary?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 缓存策略</span>
<span class="hljs-keyword">const</span> cachePolicy = {
  <span class="hljs-attr">maxSize</span>: <span class="hljs-number">50</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>, <span class="hljs-comment">// 50MB</span>
  <span class="hljs-attr">ttl</span>: <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>,       <span class="hljs-comment">// 15分钟</span>
  <span class="hljs-attr">evictionStrategy</span>: <span class="hljs-string">'LRU'</span>,   <span class="hljs-comment">// 最近最少使用</span>
};
</code></pre>
<p><strong>实际效果</strong>:</p>
<p>第一次读取文件:</p>
<pre><code class="hljs language-scss" lang="scss">&gt; 查看 User<span class="hljs-selector-class">.ts</span> 的内容

<span class="hljs-selector-attr">[Executing: Read tool for src/models/User.ts]</span>
<span class="hljs-selector-attr">[API Call: ~500ms]</span>
✓ File cached (valid for <span class="hljs-number">15</span> minutes)
</code></pre>
<p>后续读取(15分钟内):</p>
<pre><code class="hljs language-csharp" lang="csharp">&gt; User.ts 里的 validateEmail 方法是什么?

[<span class="hljs-meta">Using cached content</span>]
[<span class="hljs-meta">Response time: ~50ms, 10x faster!</span>]
</code></pre>
<h3 data-id="heading-11">2.3 如何优化上下文使用</h3>
<p><strong>技巧 1:主动管理上下文</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前上下文使用情况</span>
&gt; /context status

Context Usage: 125K / 200K tokens (62.5%)
  - Conversation: 45K tokens
  - File contents: 60K tokens
  - Command outputs: 20K tokens

<span class="hljs-comment"># 清理不必要的上下文</span>
&gt; /context clear
<span class="hljs-comment"># 或指定清理类型</span>
&gt; /context clear files
</code></pre>
<p><strong>技巧 2:使用 Todo List 持久化信息</strong></p>
<pre><code class="hljs language-bash" lang="bash">&gt; 创建一个任务列表,记录重构计划

[Claude 创建 Todo List,写入 .claude/tasks.json]
<span class="hljs-comment"># 即使对话被总结,Todo List 也会保留</span>
</code></pre>
<p><strong>技巧 3:利用 <code>claude.md</code> 存储项目规范</strong></p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 项目规范 (claude.md)</span>

<span class="hljs-section">## 架构设计</span>
<span class="hljs-bullet">-</span> 使用 Clean Architecture 分层
<span class="hljs-bullet">-</span> Controller → Service → Repository

<span class="hljs-section">## 编码规范</span>
<span class="hljs-bullet">-</span> 使用 TypeScript strict mode
<span class="hljs-bullet">-</span> 函数命名:动词开头(getUserById)
</code></pre>
<p>这样 Claude Code 会<strong>自动加载</strong>这些规范,无需每次对话都重复说明。</p>
<hr/>
<h2 data-id="heading-12">三、工具系统:Claude Code 的双手</h2>
<h3 data-id="heading-13">3.1 工具系统概览</h3>
<p>Claude Code 通过**工具(Tools)**与文件系统、命令行、代码库交互。所有工具遵循统一接口:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Tool</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">parameters</span>: <span class="hljs-title class_">ParameterSchema</span>;
  <span class="hljs-attr">execute</span>: <span class="hljs-function">(<span class="hljs-params">params: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ToolResult</span>&gt;;
}
</code></pre>
<p><strong>核心工具分类</strong>:</p>







































































<table><thead><tr><th align="left">类别</th><th align="left">工具名称</th><th align="left">用途</th><th align="center">使用频率</th></tr></thead><tbody><tr><td align="left"><strong>文件操作</strong></td><td align="left">Read</td><td align="left">读取文件内容</td><td align="center">⭐⭐⭐⭐⭐</td></tr><tr><td align="left"/><td align="left">Write</td><td align="left">创建/覆盖文件</td><td align="center">⭐⭐⭐⭐</td></tr><tr><td align="left"/><td align="left">Edit</td><td align="left">精确修改文件(字符串替换)</td><td align="center">⭐⭐⭐⭐⭐</td></tr><tr><td align="left"><strong>代码搜索</strong></td><td align="left">Glob</td><td align="left">按模式搜索文件</td><td align="center">⭐⭐⭐⭐</td></tr><tr><td align="left"/><td align="left">Grep</td><td align="left">搜索文件内容</td><td align="center">⭐⭐⭐⭐</td></tr><tr><td align="left"><strong>命令执行</strong></td><td align="left">Bash</td><td align="left">执行 Shell 命令</td><td align="center">⭐⭐⭐⭐⭐</td></tr><tr><td align="left"><strong>任务管理</strong></td><td align="left">TodoWrite</td><td align="left">创建/更新任务列表</td><td align="center">⭐⭐⭐</td></tr><tr><td align="left"/><td align="left">TaskCreate</td><td align="left">创建子任务</td><td align="center">⭐⭐⭐</td></tr><tr><td align="left"><strong>交互</strong></td><td align="left">AskUserQuestion</td><td align="left">向用户提问</td><td align="center">⭐⭐⭐</td></tr><tr><td align="left"><strong>Agent</strong></td><td align="left">Task</td><td align="left">调用子 Agent</td><td align="center">⭐⭐⭐⭐</td></tr></tbody></table>
<h3 data-id="heading-14">3.2 核心工具详解</h3>
<h4 data-id="heading-15">工具 1: Read - 读取文件</h4>
<p><strong>使用场景</strong>:</p>
<ul>
<li>分析代码结构</li>
<li>查看配置文件</li>
<li>读取日志</li>
</ul>
<p><strong>实际调用示例</strong>:</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户: 查看 package.json 的依赖</span>

[Claude 内部工具调用]
<span class="hljs-section">Tool: Read</span>
<span class="hljs-section">Parameters:</span>
  file_path: /path/to/project/package.json

<span class="hljs-section">Result:</span>
{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"my-app"</span>,
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"express"</span>: <span class="hljs-string">"^4.18.0"</span>,
    <span class="hljs-string">"typescript"</span>: <span class="hljs-string">"^5.0.0"</span>
  }
}

[Claude 回复用户]
项目使用了 Express 4.18 和 TypeScript 5.0...
</code></pre>
<p><strong>优化建议</strong>:</p>
<p>❌ 低效:让 Claude Code 自己搜索</p>
<pre><code class="hljs language-css" lang="css">&gt; 帮我找一下配置文件在哪里,然后查看内容
<span class="hljs-selector-attr">[触发 Glob 搜索 → Read 多个文件 → 浪费时间]</span>
</code></pre>
<p>✅ 高效:直接指定路径</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash">查看 ./config/app.json 的内容</span>
[直接 Read → 立即返回结果]
</code></pre>
<h4 data-id="heading-16">工具 2: Edit - 精确修改文件</h4>
<p><strong>核心原理</strong>:Edit 工具使用<strong>字符串精确匹配</strong>替换,而不是智能理解代码。</p>
<p><strong>错误示例</strong>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 原文件内容</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserById</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">return</span> db.<span class="hljs-property">users</span>.<span class="hljs-title function_">findOne</span>({ id });
}

<span class="hljs-comment">// Claude Code 尝试修改</span>
<span class="hljs-title class_">Tool</span>: <span class="hljs-title class_">Edit</span>
<span class="hljs-attr">old_string</span>: <span class="hljs-string">"return db.users.findOne({ id });"</span>
<span class="hljs-attr">new_string</span>: <span class="hljs-string">"return await db.users.findOne({ id });"</span>

<span class="hljs-comment">// ❌ 失败!因为原文件可能有额外空格或换行</span>
<span class="hljs-comment">// 实际内容: "return db.users.findOne({ id });\n"</span>
</code></pre>
<p><strong>正确用法</strong>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Claude Code 会先 Read 文件,获取精确内容</span>
<span class="hljs-title class_">Tool</span>: <span class="hljs-title class_">Read</span>
<span class="hljs-attr">file_path</span>: src/services/<span class="hljs-title class_">UserService</span>.<span class="hljs-property">ts</span>

<span class="hljs-comment">// 然后使用精确匹配的字符串</span>
<span class="hljs-title class_">Tool</span>: <span class="hljs-title class_">Edit</span>
<span class="hljs-attr">old_string</span>: <span class="hljs-string">"function getUserById(id: string) {\n  return db.users.findOne({ id });\n}"</span>
<span class="hljs-attr">new_string</span>: <span class="hljs-string">"async function getUserById(id: string) {\n  return await db.users.findOne({ id });\n}"</span>
</code></pre>
<p><strong>为什么这样设计?</strong></p>
<ul>
<li><strong>安全性</strong>:避免误修改相似代码</li>
<li><strong>精确性</strong>:用户可以明确看到修改内容</li>
<li><strong>可逆性</strong>:修改失败不会破坏文件</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/279dae112a334a35b2aa84cca89e8ac6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770464974&amp;x-signature=Lhu84CUp3QT8%2FY2%2FR9T9CSh5HPE%3D" alt="02-03-edit-tool-workflow.png" loading="lazy"/></p>
<p><em>图3: Edit 工具的精确匹配机制,确保代码修改的安全性和准确性</em></p>
<h4 data-id="heading-17">工具 3: Bash - 命令执行</h4>
<p><strong>强大之处</strong>:可以执行任何 Shell 命令,实现自动化。</p>
<p><strong>常见用途</strong>:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装依赖</span>
Bash: npm install axios

<span class="hljs-comment"># 运行测试</span>
Bash: npm <span class="hljs-built_in">test</span>

<span class="hljs-comment"># Git 操作</span>
Bash: git add . &amp;&amp; git commit -m <span class="hljs-string">"Refactor user service"</span>

<span class="hljs-comment"># 文件操作</span>
Bash: <span class="hljs-built_in">mkdir</span> -p src/components/common

<span class="hljs-comment"># 编译构建</span>
Bash: npm run build
</code></pre>
<p><strong>安全机制</strong>:</p>
<p>Claude Code 有<strong>权限控制系统</strong>(后续文章详解),高危命令会被拦截:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ⚠️ 会触发确认</span>
Bash: <span class="hljs-built_in">rm</span> -rf node_modules

[System] This <span class="hljs-built_in">command</span> may delete important files.
[User] Confirm execution? [y/N]

<span class="hljs-comment"># 🚫 直接拒绝执行</span>
Bash: sudo <span class="hljs-built_in">rm</span> -rf /
[System] Command blocked: Dangerous operation detected
</code></pre>
<h4 data-id="heading-18">工具 4: Task - 调用子 Agent</h4>
<p><strong>作用</strong>:当主 Agent 遇到需要专业知识的任务时,调用子 Agent 处理。</p>
<p><strong>调用时机</strong>:</p>
<pre><code class="hljs language-diff" lang="diff">用户: 帮我探索这个代码库的结构

[主 Agent 判断: 这是探索任务,应该调用 Explore Agent]

Tool: Task
subagent_type: Explore
prompt: "Analyze the codebase structure and identify key components"

[Explore Agent 开始工作...]
<span class="hljs-deletion">- 使用 Glob 查找关键文件</span>
<span class="hljs-deletion">- 分析目录结构</span>
<span class="hljs-deletion">- 识别技术栈</span>
<span class="hljs-deletion">- 生成架构摘要</span>

[返回结果给主 Agent,由主 Agent 呈现给用户]
</code></pre>
<p><strong>Agent 类型</strong>:</p>



































<table><thead><tr><th align="left">Agent 类型</th><th align="left">专长</th><th align="left">使用场景</th></tr></thead><tbody><tr><td align="left"><strong>Explore</strong></td><td align="left">代码库探索</td><td align="left">首次接触项目</td></tr><tr><td align="left"><strong>Plan</strong></td><td align="left">方案设计</td><td align="left">复杂功能开发前</td></tr><tr><td align="left"><strong>Backend-Architect</strong></td><td align="left">后端架构设计</td><td align="left">API/数据库设计</td></tr><tr><td align="left"><strong>Test-Runner</strong></td><td align="left">测试执行</td><td align="left">自动化测试</td></tr><tr><td align="left"><strong>General-Purpose</strong></td><td align="left">通用任务</td><td align="left">多步骤复杂任务</td></tr></tbody></table>
<h3 data-id="heading-19">3.3 工具调用链路分析</h3>
<p>让我们通过一个真实案例,看看 Claude Code 如何调用工具:</p>
<p><strong>案例:用户要求"优化登录 API 的性能"</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">步骤</span> <span class="hljs-attr">1:</span> <span class="hljs-string">理解需求</span>
  <span class="hljs-string">→</span> <span class="hljs-string">识别关键词:</span> <span class="hljs-string">"优化"</span><span class="hljs-string">、"登录</span> <span class="hljs-string">API"、"性能"</span>

<span class="hljs-string">步骤</span> <span class="hljs-attr">2:</span> <span class="hljs-string">定位文件</span>
  <span class="hljs-string">→</span> <span class="hljs-attr">Tool:</span> <span class="hljs-string">Glob</span>
     <span class="hljs-attr">pattern:</span> <span class="hljs-string">"**/login*.ts"</span>
     <span class="hljs-attr">result:</span> <span class="hljs-string">src/routes/login.ts,</span> <span class="hljs-string">src/services/LoginService.ts</span>

<span class="hljs-string">步骤</span> <span class="hljs-attr">3:</span> <span class="hljs-string">分析代码</span>
  <span class="hljs-string">→</span> <span class="hljs-attr">Tool:</span> <span class="hljs-string">Read</span> <span class="hljs-string">(src/routes/login.ts)</span>
  <span class="hljs-string">→</span> <span class="hljs-attr">Tool:</span> <span class="hljs-string">Read</span> <span class="hljs-string">(src/services/LoginService.ts)</span>

<span class="hljs-string">步骤</span> <span class="hljs-attr">4:</span> <span class="hljs-string">识别问题</span>
  <span class="hljs-string">→</span> <span class="hljs-string">发现:</span> <span class="hljs-string">每次登录都查询数据库</span>
  <span class="hljs-string">→</span> <span class="hljs-string">方案:</span> <span class="hljs-string">添加</span> <span class="hljs-string">Redis</span> <span class="hljs-string">缓存</span>

<span class="hljs-string">步骤</span> <span class="hljs-attr">5:</span> <span class="hljs-string">询问用户</span>
  <span class="hljs-string">→</span> <span class="hljs-attr">Tool:</span> <span class="hljs-string">AskUserQuestion</span>
     <span class="hljs-attr">question:</span> <span class="hljs-string">"是否要添加 Redis 缓存?"</span>
     <span class="hljs-attr">options:</span> [<span class="hljs-string">"Yes"</span>, <span class="hljs-string">"No"</span>, <span class="hljs-string">"Use in-memory cache"</span>]

<span class="hljs-string">步骤</span> <span class="hljs-attr">6:</span> <span class="hljs-string">实现修改(假设用户选择</span> <span class="hljs-literal">Yes</span><span class="hljs-string">)</span>
  <span class="hljs-string">→</span> <span class="hljs-attr">Tool:</span> <span class="hljs-string">Bash</span> <span class="hljs-string">(npm</span> <span class="hljs-string">install</span> <span class="hljs-string">redis)</span>
  <span class="hljs-string">→</span> <span class="hljs-attr">Tool:</span> <span class="hljs-string">Write</span> <span class="hljs-string">(src/config/redis.ts)</span>
  <span class="hljs-string">→</span> <span class="hljs-attr">Tool:</span> <span class="hljs-string">Edit</span> <span class="hljs-string">(src/services/LoginService.ts)</span>
     <span class="hljs-string">修改:</span> <span class="hljs-string">添加缓存逻辑</span>

<span class="hljs-string">步骤</span> <span class="hljs-attr">7:</span> <span class="hljs-string">测试验证</span>
  <span class="hljs-string">→</span> <span class="hljs-attr">Tool:</span> <span class="hljs-string">Bash</span> <span class="hljs-string">(npm</span> <span class="hljs-string">test)</span>
  <span class="hljs-string">→</span> <span class="hljs-string">如果失败,返回步骤</span> <span class="hljs-number">6</span> <span class="hljs-string">修复</span>

<span class="hljs-string">步骤</span> <span class="hljs-attr">8:</span> <span class="hljs-string">完成反馈</span>
  <span class="hljs-string">→</span> <span class="hljs-string">总结修改内容</span>
  <span class="hljs-string">→</span> <span class="hljs-string">询问是否需要进一步优化</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5992750f0d144478507905873b5ee00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770464974&amp;x-signature=tzDglLfeVUBHBMzy%2BbZX9orMSbM%3D" alt="02-04-tool-call-chain.png" loading="lazy"/></p>
<p><em>图4: 优化登录 API 性能的完整工具调用链路,展示每个步骤的 Token 消耗</em></p>
<p><strong>Token 消耗分析</strong>:</p>
<pre><code class="hljs language-scss" lang="scss">Read (login.ts, <span class="hljs-number">200</span> 行)        ~<span class="hljs-number">1</span>,<span class="hljs-number">500</span> tokens
Read (LoginService.ts, <span class="hljs-number">150</span> 行) ~<span class="hljs-number">1</span>,<span class="hljs-number">200</span> tokens
Write (redis.ts, <span class="hljs-number">50</span> 行)        ~<span class="hljs-number">400</span> tokens
Edit (LoginService.ts)         ~<span class="hljs-number">800</span> tokens
Bash 命令输出                   ~<span class="hljs-number">300</span> tokens
对话交互                        ~<span class="hljs-number">2</span>,<span class="hljs-number">000</span> tokens
────────────────────────────────────────────
总计                            ~<span class="hljs-number">6</span>,<span class="hljs-number">200</span> tokens
</code></pre>
<p>这就是为什么<strong>明确需求</strong>能节省 Token:如果你一开始就说"在 LoginService.ts 添加 Redis 缓存",可以跳过步骤 2 和 3,节省 ~2,700 tokens。</p>
<hr/>
<h2 data-id="heading-20">四、Agent 模式:从单打独斗到团队协作</h2>
<h3 data-id="heading-21">4.1 什么是 Agent?</h3>
<p>在 Claude Code 中,<strong>Agent</strong> 是一个具有<strong>特定能力</strong>和<strong>工具权限</strong>的智能单元。</p>
<p><strong>类比</strong>:把 Agent 想象成一个开发团队:</p>
<ul>
<li><strong>主 Agent</strong>:项目经理,负责理解需求、分配任务、协调进度</li>
<li><strong>Explore Agent</strong>:架构师,负责分析代码库、梳理结构</li>
<li><strong>Plan Agent</strong>:设计师,负责制定方案、规划实施步骤</li>
<li><strong>Backend-Architect Agent</strong>:后端专家,负责 API 和数据库设计</li>
<li><strong>Test-Runner Agent</strong>:QA 工程师,负责执行测试</li>
</ul>
<h3 data-id="heading-22">4.2 Agent 的工作流程</h3>
<p><strong>单一 Agent 模式</strong>(简单任务):</p>
<pre><code class="hljs language-ini" lang="ini">用户: 修改 README.md,添加安装说明

<span class="hljs-section">[主 Agent 独立完成]</span>
→ Read (README.md)
→ Edit (README.md)
→ 完成
</code></pre>
<p><strong>多 Agent 协作模式</strong>(复杂任务):</p>
<pre><code class="hljs language-markdown" lang="markdown">用户: 帮我分析这个项目并重构用户模块

[主 Agent 规划]
→ 任务 1: 探索项目结构
   → 调用 Explore Agent
<span class="hljs-code">      → Glob 搜索所有文件
      → 分析技术栈和架构
      → 返回摘要报告
</span>
→ 任务 2: 设计重构方案
   → 调用 Plan Agent
<span class="hljs-code">      → 基于 Explore 结果
      → 制定详细计划
      → 列出风险和注意事项
      → 返回 Plan 文档
</span>
→ 任务 3: 执行重构
   → 主 Agent 根据 Plan 逐步实施
<span class="hljs-code">      → Read/Edit 文件
      → 运行测试
      → 修复错误
</span>
→ 任务 4: 验证结果
   → 调用 Test-Runner Agent
<span class="hljs-code">      → 执行所有测试
      → 生成测试报告
</span></code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e11c5342776845e0b6a45164bc6af4d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770464974&amp;x-signature=b2g01WHfrIcfRCthYPN06sakdyc%3D" alt="02-05-agent-collaboration.png" loading="lazy"/></p>
<p><em>图5: 多 Agent 协作模式,展示主 Agent 如何调度 Explore、Plan、Test-Runner 等子 Agent</em></p>
<h3 data-id="heading-23">4.3 Agent 的能力边界</h3>
<p>每个 Agent 有不同的<strong>工具权限</strong>:</p>






























<table><thead><tr><th align="left">Agent</th><th align="left">可用工具</th><th align="left">限制</th></tr></thead><tbody><tr><td align="left"><strong>主 Agent</strong></td><td align="left">全部工具</td><td align="left">无限制</td></tr><tr><td align="left"><strong>Explore Agent</strong></td><td align="left">Read, Glob, Grep</td><td align="left">只读,不能修改</td></tr><tr><td align="left"><strong>Plan Agent</strong></td><td align="left">Read, Glob, Grep</td><td align="left">只读,不能修改</td></tr><tr><td align="left"><strong>执行类 Agent</strong></td><td align="left">Read, Write, Edit, Bash</td><td align="left">可修改,但需遵循 Plan</td></tr></tbody></table>
<p><strong>为什么这样设计?</strong></p>
<ul>
<li><strong>安全性</strong>:Explore Agent 不能误修改文件</li>
<li><strong>专注性</strong>:Plan Agent 专注于设计,不执行</li>
<li><strong>可控性</strong>:执行类 Agent 必须先有明确计划</li>
</ul>
<h3 data-id="heading-24">4.4 如何触发 Agent 调用?</h3>
<p><strong>自动触发</strong>(Claude Code 判断):</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 探索型任务 → Explore Agent</span>
<span class="hljs-section">用户: 这个项目是做什么的?</span>
<span class="hljs-section">用户: 分析代码库的架构</span>

<span class="hljs-comment"># 设计型任务 → Plan Agent</span>
<span class="hljs-section">用户: 我想添加一个支付模块,帮我设计方案</span>
<span class="hljs-section">用户: 重构这个模块,先制定计划</span>

<span class="hljs-comment"># 复杂任务 → General-Purpose Agent</span>
<span class="hljs-section">用户: 生成 API 文档并部署到 GitHub Pages</span>
</code></pre>
<p><strong>手动触发</strong>(使用 Task 工具):</p>
<pre><code class="hljs language-bash" lang="bash">用户: /task explore <span class="hljs-string">"分析 Android 项目的模块依赖关系"</span>
用户: /task plan <span class="hljs-string">"设计用户认证系统"</span>
</code></pre>
<hr/>
<h2 data-id="heading-25">五、实战案例:通过日志分析工作流程</h2>
<h3 data-id="heading-26">5.1 案例背景</h3>
<p>让我们通过一个真实案例,分析 Claude Code 的完整工作流程:</p>
<p><strong>任务</strong>: "帮我修复登录功能的 Bug:用户点击登录后没有反应"</p>
<h3 data-id="heading-27">5.2 完整工具调用日志</h3>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">00:00.000</span>] 用户输入
User: 帮我修复登录功能的 Bug:用户点击登录后没有反应

[<span class="hljs-meta">00:00.050</span>] 主 Agent 分析
[<span class="hljs-meta">Agent</span>] Understanding task: Bug fix <span class="hljs-keyword">in</span> login functionality
[<span class="hljs-meta">Agent</span>] Strategy: Locate login code → Analyze → Identify issue → Fix

[<span class="hljs-meta">00:00.100</span>] 步骤 <span class="hljs-number">1</span>: 定位相关文件
[<span class="hljs-meta">Tool</span>] Glob
  pattern: <span class="hljs-string">"**/*login*.{ts,tsx,js,jsx}"</span>
  result: [
    <span class="hljs-string">"src/pages/Login.tsx"</span>,
    <span class="hljs-string">"src/services/LoginService.ts"</span>,
    <span class="hljs-string">"src/api/login.ts"</span>
  ]

[<span class="hljs-meta">00:01.200</span>] 步骤 <span class="hljs-number">2</span>: 读取前端代码
[<span class="hljs-meta">Tool</span>] Read
  file_path: src/pages/Login.tsx
  lines: <span class="hljs-number">120</span>
  tokens: ~<span class="hljs-number">1</span>,<span class="hljs-number">800</span>

[<span class="hljs-meta">00:02.500</span>] 步骤 <span class="hljs-number">3</span>: 读取服务层代码
[<span class="hljs-meta">Tool</span>] Read
  file_path: src/services/LoginService.ts
  lines: <span class="hljs-number">85</span>
  tokens: ~<span class="hljs-number">1</span>,<span class="hljs-number">300</span>

[<span class="hljs-meta">00:03.800</span>] 步骤 <span class="hljs-number">4</span>: Agent 分析问题
[<span class="hljs-meta">Agent</span>] Analysis:
  - Login.tsx line <span class="hljs-number">45</span>: onClick handler missing <span class="hljs-keyword">await</span>
  - LoginService.login() returns Promise but <span class="hljs-keyword">not</span> handled
  - No error catching <span class="hljs-keyword">in</span> frontend

[<span class="hljs-meta">Agent</span>] Root cause: Async function <span class="hljs-keyword">not</span> properly awaited

[<span class="hljs-meta">00:03.900</span>] 步骤 <span class="hljs-number">5</span>: 修复代码
[<span class="hljs-meta">Tool</span>] Edit
  file_path: src/pages/Login.tsx
  old_string:
    <span class="hljs-keyword">const</span> handleLogin = () =&gt; {
      LoginService.login(username, password);
    };
  new_string:
    <span class="hljs-keyword">const</span> handleLogin = <span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> LoginService.login(username, password);
      } <span class="hljs-keyword">catch</span> (error) {
        console.error(<span class="hljs-string">'Login failed:'</span>, error);
      }
    };

[<span class="hljs-meta">00:04.500</span>] 步骤 <span class="hljs-number">6</span>: 运行测试
[<span class="hljs-meta">Tool</span>] Bash
  command: npm test -- Login.test.tsx
  output:
    ✓ <span class="hljs-function">Should handle login <span class="hljs-title">success</span> (<span class="hljs-params"><span class="hljs-number">125</span>ms</span>)
    ✓ Should handle login <span class="hljs-title">failure</span> (<span class="hljs-params"><span class="hljs-number">98</span>ms</span>)
    All tests passed!

[00:06.200] 完成反馈
[Agent] 问题已修复!
  - 原因: 异步函数未正确等待
  - 修改: 添加 <span class="hljs-keyword">async</span>/<span class="hljs-keyword">await</span> 和错误处理
  - 测试: 所有测试通过
  需要我解释具体的技术细节吗?
</span></code></pre>
<h3 data-id="heading-28">5.3 关键观察点</h3>
<p><strong>观察 1: 工具调用的合理性</strong></p>
<p>Claude Code 没有盲目读取所有文件,而是:</p>
<ol>
<li>先用 Glob 定位候选文件</li>
<li>只读取相关的 2 个文件</li>
<li>定位问题后直接修复</li>
</ol>
<p><strong>观察 2: 上下文的使用</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">[Context Before Fix]
<span class="hljs-bullet">  -</span> User input: ~50 tokens
<span class="hljs-bullet">  -</span> File 1 content: ~1,800 tokens
<span class="hljs-bullet">  -</span> File 2 content: ~1,300 tokens
<span class="hljs-bullet">  -</span> Total: ~3,150 tokens

[Context After Fix]
<span class="hljs-bullet">  -</span> 保留: 修改的代码片段 (~200 tokens)
<span class="hljs-bullet">  -</span> 压缩: 文件摘要 (~500 tokens)
<span class="hljs-bullet">  -</span> 总计节省: ~2,450 tokens
</code></pre>
<p><strong>观察 3: 错误处理</strong></p>
<p>如果修复失败:</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">Tool</span>] Edit (failed)
  error: <span class="hljs-string">"old_string not found in file"</span>

[<span class="hljs-meta">Agent</span>] Retry strategy:
  → Re-read file <span class="hljs-keyword">with</span> context
  → Adjust <span class="hljs-built_in">string</span> matching
  → Retry Edit

[<span class="hljs-meta">Tool</span>] Read (<span class="hljs-keyword">with</span> full context)
[<span class="hljs-meta">Tool</span>] Edit (success)
</code></pre>
<hr/>
<h2 data-id="heading-29">六、优化建议与最佳实践</h2>
<h3 data-id="heading-30">6.1 提升响应速度的技巧</h3>
<p><strong>技巧 1: 明确指定文件路径</strong></p>
<p>❌ 慢:</p>
<pre><code class="hljs language-css" lang="css">&gt; 帮我修改配置文件
<span class="hljs-selector-attr">[触发 Glob 搜索 → 读取多个候选文件]</span>
</code></pre>
<p>✅ 快:</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash">帮我修改 ./config/app.json</span>
[直接 Read 指定文件]
</code></pre>
<p><strong>技巧 2: 分阶段处理大任务</strong></p>
<p>❌ 低效:</p>
<pre><code class="hljs language-css" lang="css">&gt; 重构整个项目,添加测试,优化性能,更新文档
<span class="hljs-selector-attr">[一次性任务过大,需要多次上下文压缩]</span>
</code></pre>
<p>✅ 高效:</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-quote">&gt; 先重构用户模块</span>
[完成后]
<span class="hljs-quote">&gt; 现在添加测试</span>
[完成后]
<span class="hljs-quote">&gt; 优化性能</span>
</code></pre>
<p><strong>技巧 3: 使用缓存</strong></p>
<p>在 15 分钟内反复引用同一文件:</p>
<pre><code class="hljs language-css" lang="css">&gt; 查看 User<span class="hljs-selector-class">.ts</span> 的结构
<span class="hljs-selector-attr">[首次 Read,缓存文件]</span>

&gt; User<span class="hljs-selector-class">.ts</span> 中的 validateEmail 方法怎么实现的?
<span class="hljs-selector-attr">[使用缓存,快速响应]</span>
</code></pre>
<h3 data-id="heading-31">6.2 避免上下文浪费</h3>
<p><strong>问题场景</strong>:</p>
<pre><code class="hljs language-scss" lang="scss">&gt; 帮我分析这 <span class="hljs-number">10</span> 个文件的依赖关系
<span class="hljs-selector-attr">[读取 10 个文件,消耗大量 tokens]</span>

&gt; (<span class="hljs-number">5</span>分钟后) 第一个文件有什么问题?
<span class="hljs-selector-attr">[上下文已压缩,需要重新读取]</span>
</code></pre>
<p><strong>优化方案</strong>:</p>
<pre><code class="hljs language-css" lang="css">&gt; 先分析 File1<span class="hljs-selector-class">.ts</span> 和 File2<span class="hljs-selector-class">.ts</span> 的依赖
<span class="hljs-selector-attr">[处理 2 个文件,保留详细上下文]</span>

&gt; 再分析 File3<span class="hljs-selector-class">.ts</span> 和 File4<span class="hljs-selector-class">.ts</span>
<span class="hljs-selector-attr">[逐步扩展,保持上下文连续性]</span>
</code></pre>
<h3 data-id="heading-32">6.3 充分利用 Agent</h3>
<p><strong>场景: 首次接触新项目</strong></p>
<p>不要这样:</p>
<pre><code class="hljs language-css" lang="css">&gt; 帮我看看这个项目是做什么的
<span class="hljs-selector-attr">[主 Agent 随机读取文件,效率低]</span>
</code></pre>
<p>应该这样:</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash">/task explore <span class="hljs-string">"全面分析这个项目的架构和技术栈"</span></span>
[Explore Agent 系统化探索,生成完整报告]
</code></pre>
<p><strong>场景: 复杂功能开发</strong></p>
<p>不要这样:</p>
<pre><code class="hljs language-css" lang="css">&gt; 直接帮我实现支付模块
<span class="hljs-selector-attr">[主 Agent 边想边做,容易出错]</span>
</code></pre>
<p>应该这样:</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash">/task plan <span class="hljs-string">"设计支付模块的实现方案"</span></span>
[Plan Agent 先制定详细计划]
<span class="hljs-meta prompt_">
&gt; </span><span class="bash">根据这个计划开始实现</span>
[主 Agent 按计划执行,思路清晰]
</code></pre>
<hr/>
<h2 data-id="heading-33">七、常见问题与调试</h2>
<h3 data-id="heading-34">7.1 为什么 Claude Code "忘记"了之前的内容?</h3>
<p><strong>原因</strong>: 上下文被压缩或超出 Token 限制。</p>
<p><strong>解决方法</strong>:</p>
<ol>
<li>保持对话连续性,避免长时间中断</li>
<li>关键信息写入 <code>claude.md</code> 或 Todo List</li>
<li>使用 <code>/context status</code> 查看上下文使用情况</li>
</ol>
<h3 data-id="heading-35">7.2 为什么有时工具调用失败?</h3>
<p><strong>常见失败原因</strong>:</p>
<ol>
<li>
<p><strong>Edit 工具: 字符串不匹配</strong>
[Tool] Edit failed: old_string not found
原因: 文件内容与 old_string 不完全一致(空格/换行)
解决: Claude Code 会自动 Re-read 后重试</p>
</li>
<li>
<p><strong>Bash 工具: 命令执行错误</strong>
[Tool] Bash failed: npm: command not found
原因: 环境变量未配置
解决: 检查 PATH 或使用完整路径</p>
</li>
<li>
<p><strong>Glob 工具: 未找到文件</strong>
[Tool] Glob result: []
原因: 模式匹配错误或文件不存在
解决: 检查文件路径和模式语法</p>
</li>
</ol>
<h3 data-id="heading-36">7.3 如何查看详细的工具调用日志?</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动 Claude Code 时开启 debug 模式</span>
claude --debug

<span class="hljs-comment"># 或设置环境变量</span>
<span class="hljs-built_in">export</span> CLAUDE_LOG_LEVEL=debug
claude
</code></pre>
<p>输出示例:</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">DEBUG</span>] Tool call: Read
[<span class="hljs-meta">DEBUG</span>]   file_path: src/App.tsx
[<span class="hljs-meta">DEBUG</span>]   tokens: <span class="hljs-number">1</span>,<span class="hljs-number">234</span>
[<span class="hljs-meta">DEBUG</span>]   cache: miss
[<span class="hljs-meta">DEBUG</span>]   duration: <span class="hljs-number">456</span>ms

[<span class="hljs-meta">DEBUG</span>] Tool call: Edit
[<span class="hljs-meta">DEBUG</span>]   old_string length: <span class="hljs-number">45</span> chars
[<span class="hljs-meta">DEBUG</span>]   new_string length: <span class="hljs-number">78</span> chars
[<span class="hljs-meta">DEBUG</span>]   result: success
</code></pre>
<hr/>
<h2 data-id="heading-37">八、总结与展望</h2>
<h3 data-id="heading-38">8.1 核心要点回顾</h3>
<p>通过本文,我们深入理解了 Claude Code 的工作机制:</p>
<p><strong>1. 架构设计</strong></p>
<ul>
<li>分层架构:意图理解 → Agent 编排 → 工具执行 → 上下文管理</li>
<li>每层独立优化,各司其职</li>
</ul>
<p><strong>2. 上下文管理</strong></p>
<ul>
<li>有限 Token 预算(200K)需要智能管理</li>
<li>分层优先级、智能压缩、文件缓存</li>
<li>理解上下文机制,避免"失忆"问题</li>
</ul>
<p><strong>3. 工具系统</strong></p>
<ul>
<li>标准化工具接口,易于扩展</li>
<li>核心工具:Read、Edit、Bash、Task</li>
<li>理解工具调用链路,优化使用策略</li>
</ul>
<p><strong>4. Agent 协作</strong></p>
<ul>
<li>主 Agent + 子 Agent 团队模式</li>
<li>不同 Agent 有不同专长和权限</li>
<li>复杂任务自动调度子 Agent</li>
</ul>
<h3 data-id="heading-39">8.2 实践建议</h3>
<p><strong>立即可用的技巧</strong>:</p>
<ol>
<li>
<p><strong>明确需求,指定路径</strong></p>
<ul>
<li>不要让 Claude Code 盲目搜索</li>
<li>直接指定文件路径,节省时间</li>
</ul>
</li>
<li>
<p><strong>保持对话连续性</strong></p>
<ul>
<li>关键任务不要中断太久</li>
<li>重要信息写入 <code>claude.md</code></li>
</ul>
</li>
<li>
<p><strong>分阶段处理大任务</strong></p>
<ul>
<li>将复杂任务拆分为多个小步骤</li>
<li>每个步骤完成后再进行下一步</li>
</ul>
</li>
<li>
<p><strong>善用 Agent</strong></p>
<ul>
<li>探索项目时使用 Explore Agent</li>
<li>复杂功能开发前使用 Plan Agent</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-40">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fclaude%2Fdocs%2Fclaude-code" target="_blank" title="https://docs.anthropic.com/claude/docs/claude-code" ref="nofollow noopener noreferrer">Claude Code 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.claude.com%2Fdocs%2Fen%2Fget-started" target="_blank" title="https://platform.claude.com/docs/en/get-started" ref="nofollow noopener noreferrer">Anthropic API 上下文指南</a></li>
</ul>
<hr/>
<p>🔗 <strong>相关文章</strong>:</p>
<ul>
<li><a href="https://juejin.cn/post/7600629210155728902" target="_blank" title="https://juejin.cn/post/7600629210155728902">上一篇: Claude Code 初体验</a></li>
</ul>
<hr/>
<blockquote>
<p>💡 <strong>思考题</strong>: 在你的项目中,哪些任务适合使用 Claude Code?哪些不适合?欢迎在评论区分享你的思考!</p>
</blockquote>
<p><em>如果这篇文章对你有帮助,欢迎点赞、收藏、分享!有任何问题或建议,欢迎在评论区留言讨论。让我们一起学习,一起成长!</em></p>
<p><em>也欢迎访问我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>发现更多宝藏资源</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我们来说说 Redis 中 Zset 的底层实现]]></title>    <link>https://juejin.cn/post/7601046076943761423</link>    <guid>https://juejin.cn/post/7601046076943761423</guid>    <pubDate>2026-01-31T12:00:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601046076943761423" data-draft-id="7601046076943745039" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我们来说说 Redis 中 Zset 的底层实现"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-31T12:00:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小假"/> <meta itemprop="url" content="https://juejin.cn/user/2285197690931932"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我们来说说 Redis 中 Zset 的底层实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2285197690931932/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小假
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T12:00:13.000Z" title="Sat Jan 31 2026 12:00:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">核心概括</h3>
<p>Redis 的 Zset 同时具备两个核心特性：</p>
<ol>
<li><strong>有序性</strong>：元素按<strong>分值（score）</strong> 从小到大排列。</li>
<li><strong>唯一性</strong>：集合中的<strong>成员（member）</strong> 是唯一的，但分值可以相同（分值相同时，按成员字典序排列）。</li>
</ol>
<p>为了实现这种高效的、兼具“集合”和“有序”特性的数据结构，Redis 采用了<strong>两种底层数据结构相结合的方案</strong>：</p>
<ul>
<li><strong>ziplist（压缩列表）或 listpack（紧凑列表）</strong> ：用于元素数量少、元素体积小的场景，以节省内存。</li>
<li><strong>skiplist（跳跃表） + dict（哈希表）</strong> ：用于通用场景，以提供高效的查询和范围操作。</li>
</ul>
<p>这种根据条件动态切换底层结构的设计，体现了 Redis 在性能与内存之间做出的精妙权衡。</p>
<h3 data-id="heading-1">一、两种编码方式</h3>
<p>在 Redis 内部，Zset 有两种编码方式，通过配置项 <code>zset-max-ziplist-entries</code> 和 <code>zset-max-ziplist-value</code> 来控制。</p>
<h4 data-id="heading-2">1. <strong>ziplist / listpack 编码</strong></h4>
<p>在 Redis 早期版本使用 ziplist，新版本（7.0+）逐渐用 <strong>listpack</strong> 替代 ziplist。我们以 listpack 为例讲解。</p>
<p><strong>适用条件（同时满足）：</strong></p>
<ul>
<li>有序集合保存的 <strong>元素数量</strong> 小于 <code>zset-max-ziplist-entries</code> （默认 128）。</li>
<li>每个 <strong>成员（member）的字符串长度</strong> 小于 <code>zset-max-ziplist-value</code> （默认 64 字节）。</li>
</ul>
<p><strong>内存布局：</strong><br/>
listpack 是一个紧凑的、连续内存块，它按 <code>[member1, score1, member2, score2, ...]</code> 的顺序，成对存储成员和分值。</p>
<ul>
<li><strong>按分值排序</strong>：所有元素在 listpack 内部就是严格按照分值升序排列的。</li>
<li><strong>查找方式</strong>：由于是紧凑数组，查找需要 <strong>线性遍历</strong>。但因为元素少，且内存连续，缓存友好，效率仍然可以接受。</li>
<li><strong>插入/删除</strong>：需要移动后续元素，时间复杂度 O(N)。同样因为元素少，成本可控。</li>
</ul>
<p><strong>目的</strong>：在元素少且小的场景下，这种结构避免了额外的指针开销，<strong>极大地节约了内存</strong>。</p>
<h4 data-id="heading-3">2. <strong>skiplist 编码</strong></h4>
<p>当不满足上述任一条件时，Zset 会自动转换为 skiplist 编码。这才是 Zset 的“完全体”和核心实现。</p>
<p>它实际上是一个 <strong>复合结构</strong>，包含一个 <strong>跳跃表（skiplist）</strong> 和一个 <strong>字典（dict）</strong> 。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">zset</span> {
    dict *dict;          <span class="hljs-comment">// 哈希字典</span>
    zskiplist *zsl;      <span class="hljs-comment">// 跳跃表</span>
} zset;
</code></pre>
<h5 data-id="heading-4"><strong>为什么需要两种结构？</strong></h5>
<ul>
<li><strong>跳跃表（zskiplist）</strong> ：核心作用在于<strong>维护元素的有序性</strong>，支持高效的<strong>范围查询</strong>（如 ZRANGE, ZRANK）和插入/删除操作（平均 O(logN)）。</li>
<li><strong>字典（dict）</strong> ：核心作用在于提供 <strong>O(1) 时间复杂度的成员查询</strong>（如 ZSCORE 命令，直接根据 member 获取其 score）。</li>
</ul>
<p>如果只用跳跃表，查询成员分值需要 O(logN)。<br/>
如果只用字典，无法进行高效的范围操作。</p>
<p>因此，这种 <strong>“空间换时间”</strong> 的设计，让 Zset 既能快速进行单点查询，又能高效进行范围操作，是工程上的经典取舍。</p>
<h3 data-id="heading-5">二、核心数据结构剖析</h3>
<h4 data-id="heading-6">1. <strong>跳跃表（Skip List）详解</strong></h4>
<p>跳跃表是一种多层级的<strong>有序链表</strong>，是平衡树的一种概率替代方案，实现更简单，在并发环境下也更有优势。</p>
<p><strong>结构：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">zskiplist</span> {
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">zskiplistNode</span> *header, *tail; <span class="hljs-comment">// 头尾指针</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> length;                <span class="hljs-comment">// 节点总数</span>
    <span class="hljs-type">int</span> level;                           <span class="hljs-comment">// 当前最大层数</span>
} zskiplist;

<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">zskiplistNode</span> {
    sds ele;                             <span class="hljs-comment">// 成员（SDS字符串）</span>
    <span class="hljs-type">double</span> score;                        <span class="hljs-comment">// 分值</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">zskiplistNode</span> *backward;      <span class="hljs-comment">// 后向指针（L0层，用于逆序）</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">zskiplistLevel</span> {
        <span class="hljs-keyword">struct</span> <span class="hljs-title class_">zskiplistNode</span> *forward;   <span class="hljs-comment">// 该层的前进指针</span>
        <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> span;              <span class="hljs-comment">// 该层到下一个节点的跨度（用于排名）</span>
    } level[];                           <span class="hljs-comment">// 柔性数组，表示节点的层级</span>
} zskiplistNode;
</code></pre>
<p><strong>关键特性：</strong></p>
<ul>
<li><strong>多层链表</strong>：每个节点随机一个层高（1-32）。<code>level</code> 数组长度即为层高。</li>
<li><strong>有序性</strong>：节点首先按 <code>score</code> 排序，<code>score</code> 相同时，按 <code>ele</code> 的字典序排序。</li>
<li><strong>查找路径</strong>：从最高层（header的最高层）开始，向右遍历找到最后一个 <code>score</code> 小于目标（或 <code>score</code> 相等但 <code>ele</code> 小于目标）的节点，然后下降一层继续。如此反复，直到第0层。这个过程时间复杂度平均 O(logN)。</li>
<li><strong>跨度（span）</strong> ：<code>level[i].span</code> 记录了从当前节点到 <code>level[i].forward</code> 节点之间，跨越了第0层的多少个节点。<strong>这是 ZRANK 命令（获取排名）能够 O(logN) 完成的关键</strong>。计算排名时，只需将搜索路径上所有符合方向的跨度累加即可。</li>
<li><strong>后向指针（backward）</strong> ：用于从尾到头遍历，支持 <code>ZREVRANGE</code> 等逆序操作。</li>
</ul>
<h4 data-id="heading-7">2. <strong>字典（Dict）</strong></h4>
<p>就是一个标准的 Redis 哈希表，其作用是：</p>
<ul>
<li><strong>键（Key）</strong> ：存储成员（member）。</li>
<li><strong>值（Value）</strong> ：存储该成员对应的分值（score，一个 double 类型）。</li>
<li>这个字典确保了对任意成员的 <strong>O(1) 时间复杂度</strong> 的访问。</li>
</ul>
<h3 data-id="heading-8">三、操作流程示例</h3>
<p>假设我们执行 <code>ZADD myzset 10 “alice” 20 “bob” 30 “charlie”</code>。</p>
<p>在 skiplist 编码下，内存结构示意图如下：</p>
<pre><code class="hljs language-sql" lang="sql">            zset
        <span class="hljs-operator">/</span>          \
      dict         zskiplist (header)
       <span class="hljs-operator">|</span>                (level<span class="hljs-operator">=</span><span class="hljs-number">5</span>)
  "alice"  <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span>        <span class="hljs-operator">|</span>
  "bob"    <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-number">20</span>        <span class="hljs-operator">|</span>
  "charlie"<span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-number">30</span>        V
                    <span class="hljs-operator">+</span><span class="hljs-comment">-------+-------+-------+</span>
                    <span class="hljs-operator">|</span> Span  <span class="hljs-operator">|</span> ...   <span class="hljs-operator">|</span> Span  <span class="hljs-operator">|</span>  (高层，稀疏指针，快速跳跃)
                    <span class="hljs-operator">+</span><span class="hljs-comment">-------+-------+-------+</span>
                         <span class="hljs-operator">|</span>          <span class="hljs-operator">|</span>
                         V          V
                    <span class="hljs-operator">+</span><span class="hljs-comment">-------+-------+-------+</span>
                    <span class="hljs-operator">|</span> score <span class="hljs-operator">|</span> ele   <span class="hljs-operator">|</span> level <span class="hljs-operator">|</span> <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> Node(<span class="hljs-number">10</span>, "alice")
                    <span class="hljs-operator">|</span>   <span class="hljs-number">10</span>  <span class="hljs-operator">|</span>"alice"<span class="hljs-operator">|</span>   <span class="hljs-number">2</span>   <span class="hljs-operator">|</span>
                    <span class="hljs-operator">+</span><span class="hljs-comment">-------+-------+-------+</span>
                         <span class="hljs-operator">|</span>               <span class="hljs-operator">|</span>
                         V (L0)          V (L1)
                    <span class="hljs-operator">+</span><span class="hljs-comment">-------+-------+-------+-------+-------+-------+</span>
                    <span class="hljs-operator">|</span> score <span class="hljs-operator">|</span> ele   <span class="hljs-operator">|</span> level <span class="hljs-operator">|</span> score <span class="hljs-operator">|</span> ele   <span class="hljs-operator">|</span> level <span class="hljs-operator">|</span> <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> Node(<span class="hljs-number">20</span>, "bob")
                    <span class="hljs-operator">|</span>   <span class="hljs-number">20</span>  <span class="hljs-operator">|</span>"bob"  <span class="hljs-operator">|</span>   <span class="hljs-number">3</span>   <span class="hljs-operator">|</span>   <span class="hljs-number">20</span>  <span class="hljs-operator">|</span>"bob"  <span class="hljs-operator">|</span>   <span class="hljs-number">3</span>   <span class="hljs-operator">|</span>
                    <span class="hljs-operator">+</span><span class="hljs-comment">-------+-------+-------+-------+-------+-------+</span>
                         <span class="hljs-operator">|</span>               <span class="hljs-operator">|</span>
                         V (L0)          V (L1)
                    <span class="hljs-operator">+</span><span class="hljs-comment">-------+-------+-------+-------+-------+-------+</span>
                    <span class="hljs-operator">|</span> score <span class="hljs-operator">|</span> ele   <span class="hljs-operator">|</span> level <span class="hljs-operator">|</span> score <span class="hljs-operator">|</span> ele   <span class="hljs-operator">|</span> level <span class="hljs-operator">|</span> <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> Node(<span class="hljs-number">30</span>, "charlie")
                    <span class="hljs-operator">|</span>   <span class="hljs-number">30</span>  <span class="hljs-operator">|</span>"char" <span class="hljs-operator">|</span>   <span class="hljs-number">1</span>   <span class="hljs-operator">|</span>   <span class="hljs-number">30</span>  <span class="hljs-operator">|</span>"char" <span class="hljs-operator">|</span>   <span class="hljs-number">1</span>   <span class="hljs-operator">|</span>
                    <span class="hljs-operator">+</span><span class="hljs-comment">-------+-------+-------+-------+-------+-------+</span>
                         <span class="hljs-operator">|</span>
                         V (L0)
                         <span class="hljs-keyword">NULL</span>
</code></pre>
<p><strong>关键操作如何工作：</strong></p>
<ol>
<li><strong>ZSCORE myzset "bob"</strong> ：直接在 <code>dict</code> 中查找键 "bob"，立即返回其值 20。<strong>O(1)</strong> 。</li>
<li><strong>ZRANGE myzset 1 2</strong>：从 <code>zskiplist</code> 的 header 出发，利用高层指针快速定位到起始节点（"bob"），然后沿低层指针遍历输出。<strong>O(logN + M)</strong> ，M为返回元素个数。</li>
<li><strong>ZRANK myzset "charlie"</strong> ：从 <code>zskiplist</code> 的 header 出发，搜索 "charlie" 的路径，同时累加沿途的 <code>span</code> 值。最终得到的累加和就是其排名（从0开始）。<strong>O(logN)</strong> 。</li>
<li><strong>ZADD myzset 15 "david"</strong> ：</li>
</ol>
<ul>
<li>
<ul>
<li>先在 <code>dict</code> 中检查 "david" 是否存在（保证唯一性）。</li>
<li>然后在 <code>zskiplist</code> 中执行标准的跳表插入操作（O(logN)），找到插入位置。</li>
<li>最后，在 <code>dict</code> 中插入 "david" -&gt; 15 的键值对。</li>
<li>整个操作 <strong>O(logN)</strong> 。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-9">四、ZSET ZRANGE 操作序列图</h3>
<p>下面这个序列图展示了当执行 <code>ZRANGE myzset 1 3</code> 命令时，Redis 内部不同组件之间的交互流程：</p>
<h3 data-id="heading-10"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ce883892aef49fa92d35dea7f1f334a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5YGH:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770465616&amp;x-signature=4mMHoT32v9C6ujZcFLRPr3KMlTo%3D" alt="" loading="lazy"/></h3>
<h3 data-id="heading-11">五、总结与要点</h3>
<ol>
<li><strong>双编码策略</strong>：Zset 是智能的，小数据用紧凑的 listpack 省内存，大数据用功能强大的“跳表+哈希”组合保性能。</li>
<li><strong>核心复合结构</strong>：<code>skiplist + dict</code> 是 Zset 的灵魂。<strong>skiplist 负责排序和范围操作</strong>，<strong>dict 负责快速单点访问</strong>。二者通过共享成员和分值的指针来保证数据一致性，没有冗余存储。</li>
<li><strong>跳跃表的角色</strong>：它不仅是一个有序链表，其<strong>跨度（span）</strong> 属性是实现 O(logN) 复杂度的排名查询的关键。</li>
<li><strong>时间复杂度</strong>：</li>
</ol>
<ul>
<li>
<ul>
<li>添加/删除/按分值查询：平均 <strong>O(logN)</strong> 。</li>
<li>按成员查分值：<strong>O(1)</strong> 。</li>
<li>范围查询（如 ZRANGE）：<strong>O(logN + M)</strong> 。</li>
<li>获取排名（ZRANK）：<strong>O(logN)</strong> 。</li>
</ul>
</li>
</ul>
<ol start="5">
<li><strong>选择原因</strong>：相比于红黑树等严格平衡树，跳跃表实现简单，区间查询更直观，且在并发环境下更容易实现无锁优化。</li>
</ol>
<h3 data-id="heading-12">面试回答</h3>
<p>它的底层实现其实采用了两种数据结构相结合的 <strong>‘混合’策略</strong>，目的是在内存使用和性能之间取得一个平衡。具体来说，它同时使用了：</p>
<ol>
<li><strong>跳跃表（Skip List）</strong></li>
<li><strong>字典（或哈希表，Hash Table）</strong></li>
</ol>
<p>这两种结构会<strong>共享</strong>集合中元素（成员）和分数（分值）的数据，但通过指针引用，所以不会造成双倍的内存开销。</p>
<hr/>
<p><strong>为什么需要两种结构呢？</strong><br/>
这主要是为了应对 Zset 不同的操作场景，让它们都能非常高效：</p>
<ul>
<li><strong>跳跃表</strong> 的核心作用是<strong>维持元素的有序性</strong>。它的结构像多层链表，上层是“快速通道”，下层是“精确通道”。这使得<strong>范围型操作，</strong> 以及插入、删除的平均时间复杂度都能在 <strong>O(log N)</strong> 级别，效率很高。</li>
<li><strong>字典</strong> 的核心作用是提供 <strong>‘成员 -&gt; 分数’ 的快速映射</strong>。当我们执行像去获取某个成员的分数或者更新一个已有成员这类操作时，如果能直接通过成员名（key）在哈希表里 <strong>O(1)</strong> 时间复杂度查到它的分数，那就太快了。如果只用跳跃表，这个查询就需要 O(log N)。</li>
</ul>
<p>所以，简单来讲，可以把 Zset 想象成 <strong>一个用哈希表做‘索引’，用跳跃表做‘排序清单’的组合体</strong>。哈希表保证了点查的极致速度，跳跃表保证了范围操作的效率。</p>
<p>不过，在 Redis 的后续版本中（我记得是 7.0 之后），为了进一步节省内存，还有另一种编码方式，叫 <code>Ziplist</code>（紧凑列表）。</p>
<ul>
<li>当 Zset 同时满足两个条件时：1. 元素数量较少（默认 ≤ 128 个）；2. 每个成员字符串长度较短（默认 ≤ 64 字节），Redis 会使用一块<strong>连续内存</strong>的 <code>ziplist</code> 来存储。在这个链表里，成员和分数是挨个交替存放的，它因为少了跳跃表和哈希表的结构开销，所以<strong>非常节省内存</strong>。</li>
<li>一旦不满足上述任一条件，它就会自动<strong>转换</strong>成标准的“跳跃表+字典”结构。这个转换对使用者是无感的。</li>
</ul>
<hr/>
<p><strong>总结一下</strong>，我的理解是：<br/>
Zset 的底层会根据数据规模灵活选择：</p>
<ul>
<li>对于<strong>小型集合</strong>，使用内存紧凑的 <code>ziplist</code>。</li>
<li>对于<strong>通用集合</strong>，使用 <strong>‘跳跃表 + 字典’</strong> 的双结构，同时保证高效的<strong>范围操作</strong>和<strong>单点查询</strong>。这也是一个在工程上非常经典的， <strong>‘用空间换时间’和‘空间时间平衡’</strong> 的设计思路。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Model Context Protocol (MCP) 架构详解]]></title>    <link>https://juejin.cn/post/7601044684774277158</link>    <guid>https://juejin.cn/post/7601044684774277158</guid>    <pubDate>2026-01-31T10:05:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601044684774277158" data-draft-id="7601044684774244390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Model Context Protocol (MCP) 架构详解"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-31T10:05:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="舒一笑不秃头"/> <meta itemprop="url" content="https://juejin.cn/user/4257747754552599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Model Context Protocol (MCP) 架构详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4257747754552599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    舒一笑不秃头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T10:05:09.000Z" title="Sat Jan 31 2026 10:05:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Model Context Protocol (MCP) 架构详解</h2>
<h3 data-id="heading-1">简介</h3>
<p>Model Context Protocol (MCP) 是一个开放协议，用于连接 AI 应用程序与外部数据源和工具。通过 MCP，AI 应用可以安全地访问各种上下文信息，执行操作，并与外部系统交互。</p>
<h3 data-id="heading-2">项目组成</h3>
<p>MCP 包含以下项目组件：</p>

























<table><thead><tr><th>组件</th><th>说明</th></tr></thead><tbody><tr><td><strong>MCP 规范</strong></td><td>定义 MCP 的实现规范，概述客户端和服务器的实现要求</td></tr><tr><td><strong>MCP SDK</strong></td><td>为不同编程语言提供的 MCP 实现 SDK</td></tr><tr><td><strong>MCP 开发工具</strong></td><td>用于开发 MCP 服务器和客户端的工具，包括 MCP Inspector</td></tr><tr><td><strong>MCP 参考服务器实现</strong></td><td>MCP 服务器的参考实现</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-3">核心概念</h3>
<h4 data-id="heading-4">参与者</h4>
<p>MCP 采用<strong>客户端-服务器架构</strong>，其中 MCP 主机（如 Claude Code 或 Claude Desktop 等 AI 应用）与一个或多个 MCP 服务器建立连接。MCP 主机通过为每个 MCP 服务器创建一个 MCP 客户端来实现这一点。每个 MCP 客户端与其对应的 MCP 服务器维持专用连接。</p>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────────────┐
│                        <span class="hljs-function">MCP <span class="hljs-title">Host</span> <span class="hljs-params">(AI 应用)</span>                         │
│                     <span class="hljs-params">(Claude Desktop / VSCode)</span>                     │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  MCP <span class="hljs-built_in">Client</span>  │  │  MCP <span class="hljs-built_in">Client</span>  │  │  MCP <span class="hljs-built_in">Client</span>  │  ...      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
└─────────┼──────────────────┼──────────────────┼─────────────────┘
          │                  │                  │
          ▼                  ▼                  ▼
  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
  │  MCP <span class="hljs-built_in">Server</span>  │  │  MCP <span class="hljs-built_in">Server</span>  │  │  MCP <span class="hljs-built_in">Server</span>  │
  │  <span class="hljs-params">(Filesystem)</span>│  │   <span class="hljs-params">(Sentry)</span>   │  │   <span class="hljs-params">(Database)</span> │
  └──────────────┘  └──────────────┘  └──────────────┘
</span></code></pre>
<h5 data-id="heading-5">MCP 架构中的关键角色</h5>





















<table><thead><tr><th>角色</th><th>说明</th></tr></thead><tbody><tr><td><strong>MCP 主机 (Host)</strong></td><td>协调和管理的 AI 应用程序，管理一个或多个 MCP 客户端</td></tr><tr><td><strong>MCP 客户端 (Client)</strong></td><td>维护与 MCP 服务器连接的组件，从 MCP 服务器获取上下文供主机使用</td></tr><tr><td><strong>MCP 服务器 (Server)</strong></td><td>向 MCP 客户端提供上下文的程序</td></tr></tbody></table>
<h5 data-id="heading-6">服务器类型</h5>
<p>MCP 服务器可以<strong>本地运行</strong>或<strong>远程运行</strong>：</p>
<ul>
<li>
<p><strong>本地 MCP 服务器</strong>：使用 STDIO 传输层，通常在同一台机器上运行，服务单个 MCP 客户端</p>
<ul>
<li>示例：Claude Desktop 启动的文件系统服务器</li>
</ul>
</li>
<li>
<p><strong>远程 MCP 服务器</strong>：使用 Streamable HTTP 传输层，通常运行在远程平台上，服务多个 MCP 客户端</p>
<ul>
<li>示例：运行在 Sentry 平台上的官方 Sentry MCP 服务器</li>
</ul>
</li>
</ul>
<h5 data-id="heading-7">实例说明</h5>
<p>以 Visual Studio Code 为例：</p>
<ol start="0">
<li>VSCode 作为 MCP 主机</li>
<li>当 VSCode 连接到 Sentry MCP 服务器时，VSCode 运行时创建一个 MCP 客户端对象来维护连接</li>
<li>当 VSCode 再连接到本地文件系统服务器时，创建另一个 MCP 客户端对象来维护此连接</li>
</ol>
<hr/>
<h3 data-id="heading-8">协议层级</h3>
<p>MCP 由两个层级组成：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                     Transport Layer (传输层)                   │
│  ┌──────────────────────┐  ┌──────────────────────────────┐ │
│  │   Stdio Transport    │  │  Streamable HTTP Transport   │ │
│  │  (标准输入/输出流)     │  │  (HTTP POST + SSE)           │ │
│  └──────────────────────┘  └──────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                      Data Layer (数据层)                      │
│              基于 JSON-RPC <span class="hljs-number">2.0</span> 的交换协议                      │
├─────────────────────────────────────────────────────────────┤
│  Lifecycle  │  Server  │  Client  │  Utility  │  Primitives │
│  Management │ Features │ Features │ Features  │             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-9">数据层 (Data Layer)</h4>
<p>数据层实现基于 <strong>JSON-RPC 2.0</strong> 的交换协议，定义消息结构和语义：</p>

























<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td><strong>生命周期管理</strong></td><td>处理客户端和服务器之间的连接初始化、能力协商和连接终止</td></tr><tr><td><strong>服务器功能</strong></td><td>服务器提供的核心功能：工具、资源、提示模板</td></tr><tr><td><strong>客户端功能</strong></td><td>客户端提供的功能：LLM 采样、用户输入请求、日志记录</td></tr><tr><td><strong>实用功能</strong></td><td>通知（实时更新）和进度跟踪（长时间运行操作）</td></tr></tbody></table>
<h4 data-id="heading-10">传输层 (Transport Layer)</h4>
<p>传输层管理客户端和服务器之间的通信通道和身份验证：</p>

















<table><thead><tr><th>传输机制</th><th>说明</th></tr></thead><tbody><tr><td><strong>Stdio 传输</strong></td><td>使用标准输入/输出流进行本地进程间通信，无网络开销，性能最优</td></tr><tr><td><strong>Streamable HTTP 传输</strong></td><td>使用 HTTP POST 发送消息，支持 Server-Sent Events 流式传输，支持远程服务器通信，支持标准 HTTP 身份验证</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">数据层协议</h3>
<h4 data-id="heading-12">原语 (Primitives)</h4>
<p>MCP 原语是 MCP 中最重要的概念，定义了客户端和服务器可以相互提供的内容。</p>
<h5 data-id="heading-13">服务器原语</h5>
<p>服务器可以暴露的三种核心原语：</p>

























<table><thead><tr><th>原语</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>工具 (Tools)</strong></td><td>AI 应用可调用的可执行函数</td><td>文件操作、API 调用、数据库查询</td></tr><tr><td><strong>资源 (Resources)</strong></td><td>提供上下文信息的数据源</td><td>文件内容、数据库记录、API 响应</td></tr><tr><td><strong>提示 (Prompts)</strong></td><td>构建语言模型交互的可重用模板</td><td>系统提示、少样本示例</td></tr></tbody></table>
<p>每个原语类型都有相关方法用于发现（<code>*/list</code>）、检索（<code>*/get</code>），有些情况下还包括执行（<code>tools/call</code>）。</p>
<p><strong>示例：数据库 MCP 服务器</strong></p>
<p>一个提供数据库上下文的 MCP 服务器可以暴露：</p>
<ul>
<li><strong>工具</strong>：查询数据库</li>
<li><strong>资源</strong>：数据库架构</li>
<li><strong>提示</strong>：与工具交互的少样本示例</li>
</ul>
<h5 data-id="heading-14">客户端原语</h5>
<p>客户端可以暴露的原语，允许 MCP 服务器作者构建更丰富的交互：</p>

























<table><thead><tr><th>原语</th><th>说明</th><th>方法</th></tr></thead><tbody><tr><td><strong>采样 (Sampling)</strong></td><td>服务器请求客户端 AI 应用提供语言模型补全</td><td><code>sampling/complete</code></td></tr><tr><td><strong>引出 (Elicitation)</strong></td><td>服务器请求用户提供额外信息或确认操作</td><td><code>elicitation/request</code></td></tr><tr><td><strong>日志 (Logging)</strong></td><td>服务器向客户端发送日志消息用于调试和监控</td><td>日志消息</td></tr></tbody></table>
<h5 data-id="heading-15">实用原语</h5>
<p>跨越服务器和客户端的实用原语：</p>













<table><thead><tr><th>原语</th><th>说明</th></tr></thead><tbody><tr><td><strong>任务 (Tasks)</strong></td><td>实验性功能：持久执行包装器，支持延迟结果检索和状态跟踪</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-16">通知 (Notifications)</h4>
<p>协议支持<strong>实时通知</strong>，实现服务器和客户端之间的动态更新。</p>
<p>例如：</p>
<ul>
<li>当服务器的可用工具发生变化时（新功能可用或现有工具被修改）</li>
<li>服务器可以发送工具更新通知，告知连接的客户端这些变化</li>
</ul>
<p>通知作为 <strong>JSON-RPC 2.0 通知消息</strong>发送（不期望响应），使 MCP 服务器能够向连接的客户端提供实时更新。</p>
<hr/>
<h3 data-id="heading-17">工作流程示例</h3>
<h4 data-id="heading-18">数据层交互流程</h4>
<p>以下是 MCP 客户端-服务器交互的分步演示：</p>
<pre><code class="hljs language-vbscript" lang="vbscript"><span class="hljs-number">1.</span> 初始化 (Initialize)
   Client → <span class="hljs-built_in">Server</span>: initialize
   <span class="hljs-built_in">Server</span> → Client: initialize <span class="hljs-built_in">response</span> (capabilities)
​
<span class="hljs-number">2.</span> 发现工具 (List Tools)
   Client → <span class="hljs-built_in">Server</span>: tools/list
   <span class="hljs-built_in">Server</span> → Client: tools/list <span class="hljs-built_in">response</span> (available tools)
​
<span class="hljs-number">3.</span> 调用工具 (<span class="hljs-keyword">Call</span> Tool)
   Client → <span class="hljs-built_in">Server</span>: tools/<span class="hljs-keyword">call</span>
   <span class="hljs-built_in">Server</span> → Client: tools/<span class="hljs-keyword">call</span> <span class="hljs-built_in">response</span> (result)
​
<span class="hljs-number">4.</span> 接收通知 (Notification)
   <span class="hljs-built_in">Server</span> → Client: notification (tool list changed)
</code></pre>
<p>这个流程展示了：</p>
<ol start="0">
<li><strong>生命周期序列</strong>：连接初始化和能力协商</li>
<li><strong>工具操作</strong>：发现和执行</li>
<li><strong>通知</strong>：动态更新机制</li>
</ol>
<hr/>
<h3 data-id="heading-19">总结</h3>
<p>Model Context Protocol (MCP) 的架构设计具有以下特点：</p>





























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>模块化</strong></td><td>数据层与传输层分离，支持多种传输机制</td></tr><tr><td><strong>可扩展</strong></td><td>通过原语机制，服务器可以灵活提供功能</td></tr><tr><td><strong>标准化</strong></td><td>基于 JSON-RPC 2.0，易于实现和互操作</td></tr><tr><td><strong>实时性</strong></td><td>支持通知机制，实现动态更新</td></tr><tr><td><strong>安全</strong></td><td>传输层支持多种身份验证机制</td></tr></tbody></table>
<p>对于开发者来说，<strong>数据层协议</strong>（特别是原语机制）是最值得关注的部分，因为它定义了开发者可以从 MCP 服务器向 MCP 客户端共享上下文的方式。</p>
<hr/>
<h3 data-id="heading-20">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fdocs" target="_blank" title="https://modelcontextprotocol.io/docs" ref="nofollow noopener noreferrer">MCP 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fspec.modelcontextprotocol.io%2F" target="_blank" title="https://spec.modelcontextprotocol.io/" ref="nofollow noopener noreferrer">MCP 规范</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fdocs%2Fsdk" target="_blank" title="https://modelcontextprotocol.io/docs/sdk" ref="nofollow noopener noreferrer">MCP SDK 文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[语音识别变天了：阿里Qwen3-ASR开源，Whisper迎来最强对手]]></title>    <link>https://juejin.cn/post/7600994087588773907</link>    <guid>https://juejin.cn/post/7600994087588773907</guid>    <pubDate>2026-01-31T10:20:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600994087588773907" data-draft-id="7600986495928074281" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="语音识别变天了：阿里Qwen3-ASR开源，Whisper迎来最强对手"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-31T10:20:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            语音识别变天了：阿里Qwen3-ASR开源，Whisper迎来最强对手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T10:20:03.000Z" title="Sat Jan 31 2026 10:20:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开源语音识别领域，OpenAI的Whisper系列曾经是绕不开的大山。但就在2026年1月，阿里云通义千问团队甩出了一张王炸——Qwen3-ASR系列。这不仅仅是一次常规的版本更新，更像是一场针对真实应用场景的精准降维打击。</p>
<p>如果你是一名开发者，或者对语音技术稍有关注，你可能会问：这套模型凭什么挑战现有的秩序？答案藏在它的细节里。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fhdsfghbfgvbn-1024x375.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/hdsfghbfgvbn-1024x375.webp" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5ad97f7b2d04e62a7204828f5c576b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770459602&amp;x-signature=yul5NTonQ2uKjW4QeaAOxmoDZYk%3D" alt="hdsfghbfgvbn" loading="lazy"/></a></p>
<p><strong>听得懂方言，才算真听懂</strong></p>
<p>以往的ASR模型，处理标准普通话或广播级英语通常不在话下，但一旦遇到口音浓重的方言，往往就会闹笑话。Qwen3-ASR最让我惊喜的，是它那股接地气的劲儿。</p>
<p>它不仅支持52种语言，更硬核的是它针对22种中文方言进行了深度优化。不管你是讲粤语、闽南话，还是四川话、东北话，甚至带口音的英语（比如印度口音或英式口音），Qwen3-ASR-1.7B都能照单全收。在实测数据中，它的方言识别错误率相比商业API降低了约20%。这意味着，那个需要用户字正腔圆说话的时代，可能要过去了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fgdsagdfg-1024x418.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/gdsagdfg-1024x418.webp" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c9fc842f49b41168186ab16bc9db7bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770459602&amp;x-signature=%2FN5TrigRTLOfZRzMg2%2BdL9J%2FXsM%3D" alt="gdsagdfg" loading="lazy"/></a></p>
<p><strong>在KTV和工地都能干活的AI</strong></p>
<p>真实世界不是录音棚，背景里总是有各种噪音。Qwen3-ASR在鲁棒性上下了狠功夫。</p>
<p>有两个场景特别值得一提。第一是噪杂环境，哪怕是在地铁、工地这种高噪背景下，它依然能稳住识别率。第二是歌声识别，这通常是ASR的噩梦，因为背景音乐会严重干扰人声提取。但Qwen3-ASR却能做到带BGM的整首歌曲转写，中英文歌词的词错误率被压到了15%以下。对于做字幕组或音乐类应用的朋友来说，这绝对是个福音。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasfdsafsd-1024x572.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asfdsafsd-1024x572.webp" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72b54514f083482da47de9bd24e9b381~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770459602&amp;x-signature=hPZm9Jh6T6pYMty2qeDOGMpyMJ0%3D" alt="asfdsafsd" loading="lazy"/></a></p>
<p><strong>快，极其的快</strong></p>
<p>对于工程落地来说，精度是上限，效率是底线。通义团队这次很聪明地把模型分成了两个梯队。</p>
<p>除了追求极致精度的1.7B版本，还有一个0.6B的轻量化版本，它是专门为生产环境准备的。在128并发的异步推理下，这个小家伙能跑出2000倍的吞吐加速。换句话说，处理5个小时的音频，它只需要10秒钟。这种效率对于需要实时处理海量数据的客服质检或直播字幕场景来说，极具诱惑力。</p>
<p><strong>不只是识别，还有精准的时间尺</strong></p>
<p>除了识别模型，这次开源包里还附带了一个彩蛋：Qwen3-ForcedAligner。</p>
<p>这是一个专门用于强制对齐的0.6B模型。它的任务不是生成文本，而是把文本和音频的时间轴精准对应起来。它的时间戳预测精度直接超越了WhisperX等传统方案。对于视频创作者来说，这意味着自动生成的字幕不再是大概对齐，而是能精确到字、词级别，后期校对的工作量将大幅减少。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasdgjhj-1024x1004.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asdgjhj-1024x1004.webp" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36b2bafa4e3a40f4a7fde5a1111da5b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770459602&amp;x-signature=x%2BZFHVSWOjME5nCgAk27ACJQ47o%3D" alt="asdgjhj" loading="lazy"/></a></p>
<p><strong>写在最后</strong></p>
<p>Qwen3-ASR系列的出现，补齐了开源社区在多方言和复杂声学场景下的短板。更重要的是，通义团队非常大方地采用了Apache 2.0协议，代码、权重、推理框架全套开源。</p>
<p>无论是想在本地部署一个能听懂家乡话的语音助手，还是想构建一个工业级的高并发转写服务，Qwen3-ASR都提供了一个现成且强大的选项。语音识别的下半场，随着Qwen3的入局，变得越来越有看头了。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在 React 中使用 reduce 方法处理复杂的对象数据？]]></title>    <link>https://juejin.cn/post/7600986495927828521</link>    <guid>https://juejin.cn/post/7600986495927828521</guid>    <pubDate>2026-01-31T08:40:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600986495927828521" data-draft-id="7600994087588577299" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在 React 中使用 reduce 方法处理复杂的对象数据？"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-31T08:40:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户22176592792"/> <meta itemprop="url" content="https://juejin.cn/user/4461135061323432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在 React 中使用 reduce 方法处理复杂的对象数据？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4461135061323432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户22176592792
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T08:40:43.000Z" title="Sat Jan 31 2026 08:40:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你想了解的是在 React + TypeScript 环境下，如何用 <code>reduce</code> 方法处理结构更复杂的对象数据（而非简单数组），我会通过<strong>分层拆解 + 实战案例</strong>的方式，带你掌握处理复杂对象数据的核心思路和技巧。</p>
<h3 data-id="heading-0">一、核心思路：reduce 处理复杂对象的本质</h3>
<p><code>reduce</code> 不仅能处理数组，也能通过遍历对象的 <code>key/value</code> 转化为数组后再处理。核心逻辑是：</p>
<ol>
<li>将复杂对象<strong>解构 / 转化为可遍历的数组</strong>（如 <code>Object.entries()</code>/<code>Object.values()</code>）；</li>
<li>用 <code>reduce</code> 的累加器（<code>acc</code>）构建目标数据结构；</li>
<li>结合 TypeScript 类型约束，避免复杂数据的类型错误；</li>
<li>在 React 组件中，通常将处理逻辑封装为函数，配合状态 / Props 使用。</li>
</ol>
<h3 data-id="heading-1">二、实战案例：处理多层嵌套的复杂对象</h3>
<p>假设你有一份 “电商订单 + 商品” 的复杂数据，需要用 <code>reduce</code> 完成：</p>
<ul>
<li>统计每个用户的订单总金额</li>
<li>按商品分类汇总销量</li>
<li>过滤出金额 &gt; 100 的有效订单</li>
</ul>
<h4 data-id="heading-2">步骤 1：定义 TypeScript 类型（约束复杂数据）</h4>
<p>先明确数据结构，避免后续处理时类型混乱：</p>
<p>tsx</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-comment">// 商品信息</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Product</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">category</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 商品分类（电子/服饰/食品）</span>
  <span class="hljs-attr">price</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">quantity</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 购买数量</span>
}

<span class="hljs-comment">// 订单信息</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Order</span> {
  <span class="hljs-attr">orderId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">userName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">createTime</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">products</span>: <span class="hljs-title class_">Product</span>[]; <span class="hljs-comment">// 订单包含的商品（嵌套数组）</span>
  <span class="hljs-attr">status</span>: <span class="hljs-string">'paid'</span> | <span class="hljs-string">'unpaid'</span> | <span class="hljs-string">'cancelled'</span>; <span class="hljs-comment">// 订单状态</span>
}

<span class="hljs-comment">// 最终统计结果类型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderStats</span> {
  <span class="hljs-attr">userTotal</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;; <span class="hljs-comment">// 用户名 -&gt; 总消费金额</span>
  <span class="hljs-attr">categorySales</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt;; <span class="hljs-comment">// 商品分类 -&gt; 总销量</span>
  <span class="hljs-attr">validOrders</span>: <span class="hljs-title class_">Order</span>[]; <span class="hljs-comment">// 有效订单（paid + 金额&gt;100）</span>
}
</code></pre>
<h4 data-id="heading-3">步骤 2：编写 reduce 处理逻辑（React 组件内）</h4>
<p>tsx</p>
<pre><code class="hljs language-css" lang="css">const ComplexReduceDemo: React.FC = () =&gt; {
  // 模拟复杂的订单数据（多层嵌套）
  const rawOrders: Order[] = [
    {
      orderId: <span class="hljs-string">'O001'</span>,
      userId: <span class="hljs-string">'U001'</span>,
      userName: <span class="hljs-string">'张三'</span>,
      createTime: <span class="hljs-string">'2026-01-01'</span>,
      status: <span class="hljs-string">'paid'</span>,
      products: [
        { id: <span class="hljs-string">'P001'</span>, name: <span class="hljs-string">'手机'</span>, category: <span class="hljs-string">'电子'</span>, price: <span class="hljs-number">2999</span>, quantity: <span class="hljs-number">1</span> },
        { id: <span class="hljs-string">'P002'</span>, name: <span class="hljs-string">'T恤'</span>, category: <span class="hljs-string">'服饰'</span>, price: <span class="hljs-number">99</span>, quantity: <span class="hljs-number">2</span> },
      ],
    },
    {
      orderId: <span class="hljs-string">'O002'</span>,
      userId: <span class="hljs-string">'U001'</span>,
      userName: <span class="hljs-string">'张三'</span>,
      createTime: <span class="hljs-string">'2026-01-05'</span>,
      status: <span class="hljs-string">'unpaid'</span>,
      products: [
        { id: <span class="hljs-string">'P003'</span>, name: <span class="hljs-string">'面包'</span>, category: <span class="hljs-string">'食品'</span>, price: <span class="hljs-number">15</span>, quantity: <span class="hljs-number">5</span> },
      ],
    },
    {
      orderId: <span class="hljs-string">'O003'</span>,
      userId: <span class="hljs-string">'U002'</span>,
      userName: <span class="hljs-string">'李四'</span>,
      createTime: <span class="hljs-string">'2026-01-10'</span>,
      status: <span class="hljs-string">'paid'</span>,
      products: [
        { id: <span class="hljs-string">'P001'</span>, name: <span class="hljs-string">'手机'</span>, category: <span class="hljs-string">'电子'</span>, price: <span class="hljs-number">2999</span>, quantity: <span class="hljs-number">2</span> },
        { id: <span class="hljs-string">'P004'</span>, name: <span class="hljs-string">'裤子'</span>, category: <span class="hljs-string">'服饰'</span>, price: <span class="hljs-number">199</span>, quantity: <span class="hljs-number">1</span> },
      ],
    },
  ];

  // 核心：用一次 reduce 完成多维度统计（避免多次遍历）
  const stats: OrderStats = rawOrders.<span class="hljs-built_in">reduce</span>((acc, order) =&gt; {
    // <span class="hljs-number">1</span>. 计算当前订单的总金额（嵌套 products 数组的 reduce）
    const orderTotal = <span class="hljs-attribute">order</span><span class="hljs-selector-class">.products</span><span class="hljs-selector-class">.reduce</span>((sum, product) =&gt; {
      return sum + product<span class="hljs-selector-class">.price</span> * product<span class="hljs-selector-class">.quantity</span>;
    }, <span class="hljs-number">0</span>);

    // <span class="hljs-number">2</span>. 统计用户总消费（仅已支付订单）
    if (<span class="hljs-attribute">order</span><span class="hljs-selector-class">.status</span> === 'paid') {
      acc<span class="hljs-selector-class">.userTotal</span><span class="hljs-selector-attr">[order.userName]</span> = (acc<span class="hljs-selector-class">.userTotal</span><span class="hljs-selector-attr">[order.userName]</span> || <span class="hljs-number">0</span>) + orderTotal;
    }

    // <span class="hljs-number">3</span>. 按商品分类汇总销量（所有订单，无论状态）
    <span class="hljs-attribute">order</span><span class="hljs-selector-class">.products</span><span class="hljs-selector-class">.forEach</span>((product) =&gt; {
      acc<span class="hljs-selector-class">.categorySales</span><span class="hljs-selector-attr">[product.category]</span> = (acc<span class="hljs-selector-class">.categorySales</span><span class="hljs-selector-attr">[product.category]</span> || <span class="hljs-number">0</span>) + product<span class="hljs-selector-class">.quantity</span>;
    });

    // <span class="hljs-number">4</span>. 筛选有效订单（已支付 + 金额&gt;<span class="hljs-number">100</span>）
    if (<span class="hljs-attribute">order</span><span class="hljs-selector-class">.status</span> === 'paid' &amp;&amp; orderTotal &gt; <span class="hljs-number">100</span>) {
      acc<span class="hljs-selector-class">.validOrders</span><span class="hljs-selector-class">.push</span>({ ..<span class="hljs-selector-class">.order</span>, // 深拷贝避免原数据污染
        products: [...order.products] 
      });
    }

    return acc;
  }, {
    userTotal: {},
    categorySales: {},
    validOrders: [],
  } as OrderStats); // 显式指定累加器类型，TypeScript 更友好

  // 渲染统计结果
  return (
    &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">padding</span>: <span class="hljs-number">20</span> }}&gt;
      &lt;<span class="hljs-selector-tag">h2</span>&gt;复杂对象的 reduce 处理示例&lt;/<span class="hljs-selector-tag">h2</span>&gt;
      
      &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">margin</span>: <span class="hljs-number">10</span>  marginTop: <span class="hljs-number">20</span> }}&gt;
        &lt;<span class="hljs-selector-tag">h3</span>&gt;<span class="hljs-number">1</span>. 用户总消费&lt;/<span class="hljs-selector-tag">h3</span>&gt;
        &lt;<span class="hljs-selector-tag">ul</span>&gt;
          {<span class="hljs-selector-tag">Object</span><span class="hljs-selector-class">.entries</span>(stats<span class="hljs-selector-class">.userTotal</span>)<span class="hljs-selector-class">.map</span>((<span class="hljs-selector-attr">[user, total]</span>) =&gt; (
            &lt;<span class="hljs-selector-tag">li</span> key={user}&gt;{user}：¥{total}&lt;/<span class="hljs-selector-tag">li</span>&gt;
          ))}
        &lt;/<span class="hljs-selector-tag">ul</span>&gt;
      &lt;/<span class="hljs-selector-tag">div</span>&gt;

      &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">margin</span>: <span class="hljs-number">10</span>  marginTop: <span class="hljs-number">20</span> }}&gt;
        &lt;<span class="hljs-selector-tag">h3</span>&gt;<span class="hljs-number">2</span>. 商品分类销量&lt;/<span class="hljs-selector-tag">h3</span>&gt;
        &lt;<span class="hljs-selector-tag">ul</span>&gt;
          {<span class="hljs-selector-tag">Object</span><span class="hljs-selector-class">.entries</span>(stats<span class="hljs-selector-class">.categorySales</span>)<span class="hljs-selector-class">.map</span>((<span class="hljs-selector-attr">[category, sales]</span>) =&gt; (
            &lt;<span class="hljs-selector-tag">li</span> key={category}&gt;{category}：{sales} 件&lt;/<span class="hljs-selector-tag">li</span>&gt;
          ))}
        &lt;/<span class="hljs-selector-tag">ul</span>&gt;
      &lt;/<span class="hljs-selector-tag">div</span>&gt;

      &lt;<span class="hljs-selector-tag">div</span> style={{ <span class="hljs-attribute">margin</span>: <span class="hljs-number">10</span>  marginTop: <span class="hljs-number">20</span> }}&gt;
        &lt;<span class="hljs-selector-tag">h3</span>&gt;<span class="hljs-number">3</span>. 有效订单（已支付 + 金额&gt;<span class="hljs-number">100</span>）&lt;/<span class="hljs-selector-tag">h3</span>&gt;
        &lt;<span class="hljs-selector-tag">ul</span>&gt;
          {stats<span class="hljs-selector-class">.validOrders</span><span class="hljs-selector-class">.map</span>((<span class="hljs-attribute">order</span>) =&gt; (
            &lt;<span class="hljs-selector-tag">li</span> key={<span class="hljs-attribute">order</span><span class="hljs-selector-class">.orderId</span>}&gt;
              订单{<span class="hljs-attribute">order</span><span class="hljs-selector-class">.orderId</span>}（{<span class="hljs-attribute">order</span><span class="hljs-selector-class">.userName</span>}）：¥{
                <span class="hljs-attribute">order</span><span class="hljs-selector-class">.products</span><span class="hljs-selector-class">.reduce</span>((sum, <span class="hljs-selector-tag">p</span>) =&gt; sum + <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.price</span> * <span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.quantity</span>, <span class="hljs-number">0</span>)
              }
            &lt;/<span class="hljs-selector-tag">li</span>&gt;
          ))}
        &lt;/<span class="hljs-selector-tag">ul</span>&gt;
      &lt;/<span class="hljs-selector-tag">div</span>&gt;
    &lt;/<span class="hljs-selector-tag">div</span>&gt;
  );
};

export default ComplexReduceDemo;
</code></pre>
<h4 data-id="heading-4">步骤 3：在 React 中使用该组件</h4>
<p>将组件添加到路由（参考上一篇教程的 <code>routes.ts</code> 配置），启动项目后就能看到复杂数据处理后的结果。</p>
<h3 data-id="heading-5">三、处理复杂对象的关键技巧</h3>
<ol>
<li><strong>嵌套 reduce</strong>：当对象包含多层数组（如订单→商品），可在 <code>reduce</code> 回调中嵌套另一个 <code>reduce</code> 处理子数组；</li>
<li><strong>累加器初始化</strong>：复杂场景下，累加器（<code>acc</code>）要初始化为目标结构（如示例中的 <code>OrderStats</code>），并通过 TypeScript 显式指定类型；</li>
<li><strong>避免原数据污染</strong>：处理嵌套对象时，用 <code>...</code> 扩展运算符深拷贝（简单场景）或 <code>structuredClone</code>（复杂场景），避免修改原始数据；</li>
<li><strong>多维度统计</strong>：尽量在一次 <code>reduce</code> 中完成所有统计（而非多次遍历数组），提升性能；</li>
<li><strong>空值处理</strong>：用 <code>|| 0</code> 处理累加器中可能的 <code>undefined</code>（如 <code>acc.userTotal[user] || 0</code>），避免 NaN。</li>
</ol>
<h3 data-id="heading-6">总结</h3>
<ol>
<li>处理复杂对象数据的核心是：先通过 <code>Object.entries()</code>/<code>Object.values()</code> 将对象转为可遍历数组，再用 <code>reduce</code> 累加器构建目标结构；</li>
<li>React + TypeScript 场景下，<strong>先定义完整的类型接口</strong>是避免复杂数据处理出错的关键；</li>
<li>复杂嵌套数据可通过<strong>嵌套 reduce</strong> 处理，且尽量在一次遍历中完成多维度统计，兼顾代码简洁性和性能。</li>
</ol>
<p>如果需要处理更复杂的场景（如多层嵌套的树形数据），可以基于这个思路，在 <code>reduce</code> 中增加递归逻辑即可。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从远程组件到极致性能：一次低代码架构的再思考]]></title>    <link>https://juejin.cn/post/7601077764423647282</link>    <guid>https://juejin.cn/post/7601077764423647282</guid>    <pubDate>2026-01-31T08:21:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601077764423647282" data-draft-id="7601169987396386867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从远程组件到极致性能：一次低代码架构的再思考"/> <meta itemprop="keywords" content="Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2026-01-31T08:21:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小蜗1号"/> <meta itemprop="url" content="https://juejin.cn/user/835284568117806"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从远程组件到极致性能：一次低代码架构的再思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/835284568117806/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小蜗1号
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T08:21:37.000Z" title="Sat Jan 31 2026 08:21:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前段时间突然回顾了一下之前做过的一件事：上一份工作的核心任务之一，其实就是一个可视化 / 低代码平台。</p>
<p>当时受限于时间和复杂度，整体方案基本是基于 <code>vue-sfc-playground</code> 这一套思路，通过 iframe + 浏览器端编译的方式来实现远程组件的扩展能力。虽然最终把功能跑通了，但在真实使用过程中，这套方案逐渐暴露出不少问题。</p>
<p>比较典型的有：</p>
<ol>
<li><strong>iframe 性能较差</strong>，通信成本高，调试也不友好</li>
<li><strong>引入的模块必须支持 ESM</strong>，且兼容性受限</li>
<li><strong>模块之间存在前置依赖</strong>，需要人工维护依赖关系</li>
<li><strong>代码补全、Lint、插件能力受限</strong>，开发体验远不如本地 IDE</li>
<li>以及一系列零散但很消耗心智的问题</li>
</ol>
<p>站在现在这个时间点回看，我觉得这个问题本身并不复杂，只是当时的实现方式并不优雅——<strong>它其实是有更好的解法的。</strong></p>
<h2 data-id="heading-0">需求假设与目标拆解</h2>
<p>为了方便后续讨论，我们先假定一个明确的需求：</p>
<blockquote>
<p><strong>低代码平台需要支持挂载任意自定义组件，用来组合实现业务功能，而不是只能使用平台内置的物料。</strong></p>
</blockquote>
<p>在这个前提下，我给自己定了几个明确的目标：</p>
<ul>
<li><strong>开发阶段</strong>：本地 IDE 编写组件，修改后可以快速预览</li>
<li><strong>生产环境</strong>：极致的运行性能和尽可能小的包体积</li>
<li><strong>整体策略</strong>：放弃“纯在线编写组件”，全部基于本地开发来解决问题</li>
</ul>
<p>原因也很现实：<br/>
在线写组件这条路，优化成本太高了，一旦引入复杂依赖、真实业务代码，维护难度会指数级上升。</p>
<h2 data-id="heading-1">开发阶段：追求极致的反馈速度</h2>
<p>开发阶段整体的数据流和职责关系如下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
  IDE[本地 IDE]
  IDE --&gt;|文件变更| Rsbuild
  Rsbuild --&gt;|HMR / WS| Renderer
  Renderer --&gt;|defineAsyncComponent| VueRuntime
</code></pre>
<p>开发阶段的核心诉求其实很简单：</p>
<blockquote>
<p><strong>我在本地改代码，页面要立刻有反馈。</strong></p>
</blockquote>
<p>如果你看过 Vue 3 的官方文档，会发现它提供了一个非常关键的能力：<code>defineAsyncComponent</code>，用于异步加载组件。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { defineAsyncComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">AsyncComp</span> = <span class="hljs-title function_">defineAsyncComponent</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-comment">// 从服务端获取组件</span>
    <span class="hljs-title function_">resolve</span>(<span class="hljs-comment">/* 组件对象 */</span>);
  });
});
</code></pre>
<blockquote>
<p>推荐阅读：
<a href="https://juejin.cn/post/7399986979729424418" target="_blank" title="https://juejin.cn/post/7399986979729424418">给我 5 分钟，保证教会你在 Vue3 中动态加载远程组件</a>
这篇文章可以帮助理解如何结合本地 Node 服务来挂载远程组件。</p>
</blockquote>
<p>需要注意的一点是：
<code>resolve</code> 返回的并不是字符串形式的源码，而是<strong>经过编译后的组件对象</strong>，本质上类似于 <code>vue-loader</code> 处理后的产物。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d7313ead637419c9b99a56fa401ced8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP6JyXMeWPtw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770452497&amp;x-signature=lpwZSFlqD%2FL%2FZ581EUxBQp0Lq1Q%3D" alt="compiler-remote-comp" loading="lazy"/></p>
<p>到这里，背景铺垫就结束了。</p>
<h2 data-id="heading-2">开发态整体架构设计</h2>
<p>在开发阶段，我选择 <strong>Rsbuild</strong> 作为构建核心，整体思路大致如下：</p>
<ol>
<li><strong>维护一个模板工程（template）</strong>
用于提前约定好组件开发所需的基础配置。</li>
<li><strong>编写 Rsbuild 插件</strong>
<ul>
<li>插件会结合用户的 <code>API Key</code> 和 <code>Project ID</code></li>
<li>在本地开发阶段，通过 HMR / WebSocket 将组件的最新编译结果推送到平台面板</li>
<li>在生产阶段，则负责将源码和构建产物上传到 OSS</li>
</ul>
</li>
<li><strong>渲染器（低代码核心）</strong>
<ul>
<li>渲染器内部会固定一个 Vue 版本，作为所有组件的公共依赖</li>
<li>接收由 Rsbuild 编译后的 JS 模块</li>
<li>再通过 <code>defineAsyncComponent</code> 动态注入组件</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">约定与约束</h3>
<p>除此之外，还需要提前定义一些结构和规范，例如：</p>
<ul>
<li><code>global.css</code>：用于声明全局样式</li>
<li><code>composes/</code>：用于存放多个自定义组件</li>
</ul>
<p>在 <code>dev</code> 模式启动后，插件会：</p>
<ul>
<li>开启 CORS</li>
<li>向渲染器推送当前可用的组件列表及版本号</li>
<li>文件变更后重新计算版本，并通知渲染器刷新</li>
</ul>
<h3 data-id="heading-4">两个关键限制</h3>
<p>这里有两个非常重要的点：</p>
<ol>
<li><strong>样式约束</strong>
在 Vue SFC 中禁止书写全局 <code>style</code>，一旦检测到直接报错，防止出现难以审查和回滚的样式污染。</li>
<li><strong>依赖处理策略</strong>
在开发阶段，仅将 <code>vue</code> 本身 external 掉。
其他依赖（如 <code>dayjs</code>、UI 框架等）直接打进包里。</li>
</ol>
<p>虽然这样会导致 JS 体积偏大，但这是开发态，为了效率和稳定性，这个代价是完全可以接受的。</p>
<h2 data-id="heading-5">为什么不用 <code>vue3-sfc-loader</code>？</h2>
<p>一个常见的问题是：
<strong>为什么不直接使用 <code>vue3-sfc-loader</code> 在浏览器端加载 SFC？</strong></p>
<p>核心原因在于依赖管理。</p>
<p><code>vue3-sfc-loader</code> 需要手动维护 <code>moduleCache</code>，而一旦涉及真实项目，就必然要引入大量第三方包。这就意味着你需要结合 <code>importmap</code> 来管理依赖关系和版本冲突。</p>
<p>例如：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"importmap"</span>&gt;</span><span class="javascript">
  {
    <span class="hljs-string">"imports"</span>: {
      <span class="hljs-string">"vue"</span>: <span class="hljs-string">"https://play.vuejs.org/vue.runtime.esm-browser.js"</span>,
      <span class="hljs-string">"vue/server-renderer"</span>: <span class="hljs-string">"https://play.vuejs.org/server-renderer.esm-browser.js"</span>
    }
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>这种方式在 Demo 场景下还可以接受，但在真实低代码平台中，维护成本会非常高，几乎不可控。</p>
<h2 data-id="heading-6">Build 阶段：为极致性能服务</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
  subgraph Dev[开发阶段]
    IDE --&gt; Rsbuild
    Rsbuild --&gt; Renderer
    Renderer --&gt; Browser
  end

  subgraph Prod[生产阶段]
    Config[JSON / DSL]
    Config --&gt; Monorepo
    Monorepo --&gt; Build
    Build --&gt; OSS
    OSS --&gt; Browser
  end

</code></pre>
<p>生产环境的目标只有一个：<strong>性能。</strong></p>
<p>整体思路是结合 <strong>Monorepo</strong>，将低代码平台中的配置还原为一个真实可构建的工程。</p>
<h3 data-id="heading-7">工程还原策略</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
  Root[monorepo]
  Root --&gt; Composes[composes/* 组件包]
  Root --&gt; Apps[apps/platform]
  Apps --&gt; Pages[页面还原]

</code></pre>
<ul>
<li>每一个自定义组件，都被放置在 <code>components/</code> 目录下，作为 Monorepo 的子包</li>
<li>在 <code>apps/platform</code> 中，根据平台生成的 JSON 配置：
<ul>
<li>还原页面结构</li>
<li>将对应的子包注册到 <code>package.json</code> 依赖中</li>
</ul>
</li>
</ul>
<p>随后直接执行 <code>build</code>。</p>
<p>由于使用的是基于 Rust 的构建工具（如 Rsbuild / Rspack），即使是全量构建，耗时也基本控制在 <strong>30 秒以内</strong>。</p>
<h3 data-id="heading-8">带来的收益</h3>
<ul>
<li><strong>Tree Shaking</strong>：未使用代码会被自动移除</li>
<li><strong>更小的包体积</strong></li>
<li><strong>更好的缓存命中率</strong>：结合分包策略，可最大化利用 HTTP 缓存</li>
</ul>
<h2 data-id="heading-9">多页面与路由加载</h2>
<p>对于支持多页面的低代码平台来说，结合这种拆分方式，每一个页面本质上只包含自己的业务代码。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">"/remote-js"</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"https://my-server.com/assets/RemoteComponent.js"</span>),
  },
];
</code></pre>
<p>浏览器原生已经支持通过 <code>import()</code> 加载远程 ESM 模块，只要返回的是一个 Promise，Vue Router 就可以正常工作。</p>
<blockquote>
<p>参考文档：
<a href="https://link.juejin.cn?target=https%3A%2F%2Frouter.vuejs.org%2Fzh%2Fguide%2Fadvanced%2Flazy-loading.html" target="_blank" title="https://router.vuejs.org/zh/guide/advanced/lazy-loading.html" ref="nofollow noopener noreferrer">Vue Router 路由懒加载</a></p>
</blockquote>
<h2 data-id="heading-10">最后</h2>
<p>这套方案更多是一次<strong>架构思路的延展</strong>，以及一些关键落地点的总结。</p>
<p>真正落地时，依然会有很多细节需要打磨，例如：</p>
<ul>
<li>沙箱与安全隔离</li>
<li>组件版本管理</li>
<li>发布与回滚策略</li>
</ul>
<p>不过整体主线是清晰的：</p>
<blockquote>
<p><strong>开发态为体验让路，生产态为性能让路。</strong></p>
</blockquote>
<p>如果你对其中某些设计有不同的想法，或者有类似的实践经验，也欢迎交流一波。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS动画的灵动之吻：从代码到情感的生动演绎]]></title>    <link>https://juejin.cn/post/7600986495927894057</link>    <guid>https://juejin.cn/post/7600986495927894057</guid>    <pubDate>2026-01-31T09:01:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600986495927894057" data-draft-id="7601034810312605750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS动画的灵动之吻：从代码到情感的生动演绎"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2026-01-31T09:01:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lee川"/> <meta itemprop="url" content="https://juejin.cn/user/2402874087453658"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS动画的灵动之吻：从代码到情感的生动演绎
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2402874087453658/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lee川
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T09:01:35.000Z" title="Sat Jan 31 2026 09:01:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>CSS动画的灵动之吻：从代码到情感的生动演绎</strong></h2>
<p>在Web前端的世界里，CSS不仅仅是定义颜色和布局的工具，它更是一门能够赋予静态元素生命与情感的艺术。今天，我们将通过一个名为“双球亲吻”的生动案例，深入剖析如何利用CSS关键帧动画（<code>@keyframes</code>）和精细的类名设计，让两个简单的圆形化身为含情脉脉的男女主角，上演一场温馨的互动。</p>
<h3 data-id="heading-1"><strong>一、 动画蓝图：整体构思与HTML结构</strong></h3>
<p>任何精彩的动画都始于一个清晰的故事板。我们的故事很简单：画面中央，代表“女主”的白色圆球（<code>#l-ball</code>）在原地微微靠近又远离，而代表“男主”的圆球（<code>#r-ball</code>）则会主动“亲吻”女主。</p>
<p><strong>HTML结构</strong>（文档1）体现了“面向对象CSS（OOCSS）”的思想，这是代码严谨性的基石：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 女主 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ball"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"l-ball"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 男主 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ball"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"r-ball"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>设计解析：</strong></p>
<ul>
<li><strong>容器居中</strong>：<code>.container</code>使用了经典的“绝对定位 + <code>transform: translate</code>”方法实现水平垂直居中，这是一种与元素尺寸无关的优雅居中方案。</li>
<li><strong>类名复用</strong>：两个球都使用了 <code>.ball</code>基类，定义了它们共有的样式：尺寸、圆形边框、白色背景等。这遵循了“不要重复自己（DRY）”原则，避免了代码冗余。</li>
<li><strong>ID与角色</strong>：通过 <code>#l-ball</code>和 <code>#r-ball</code>这两个ID，我们为两个角色赋予了独立的“身份”，以便后续为它们定制不同的动画行为。</li>
</ul>
<h3 data-id="heading-2"><strong>二、 角色塑造：面相与情绪的CSS实现</strong></h3>
<p>角色的“面部”细节（眼睛、嘴巴、腮红）是传递情绪的关键。这里大量运用了CSS伪元素和“多态”类名。</p>
<p><strong>1. 面部基类与“腮红”特效</strong></p>
<p><code>.face</code>类是所有面部元素的定位上下文。其最巧妙的设计在于使用 <code>::before</code>和 <code>::after</code>伪元素来创建腮红。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.face</span><span class="hljs-selector-pseudo">::after</span>, <span class="hljs-selector-class">.face</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>; <span class="hljs-comment">/* 必须存在 */</span>
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">18px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">8px</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#badc58</span>; <span class="hljs-comment">/* 腮红颜色 */</span>
    <span class="hljs-attribute">top</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
}
</code></pre>
<ul>
<li><strong>为什么用伪元素？</strong> ​ 腮红是纯粹的装饰性内容，不应污染HTML结构。伪元素完美解决了这个问题，使得HTML保持简洁。</li>
<li><strong>定位</strong>：通过 <code>right: -8px</code>和 <code>left: -5px</code>将两个腮红定位在面部元素之外，模拟出球体上的红晕。</li>
</ul>
<p><strong>2. 眼睛与嘴巴的“多态”</strong></p>
<p>眼睛（<code>.eye</code>）通过边框（<code>border-bottom</code>）巧妙地画出了下半圆，营造出可爱的感觉。而男主的眼睛需要表现出与女主不同的神态（比如挑眉），这里通过“多态”类名 <code>.eye-r-p</code>来实现。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.eye</span> {
    <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">5px</span> solid; <span class="hljs-comment">/* 默认向下看 */</span>
}
<span class="hljs-selector-class">.eye-r-p</span> {
    <span class="hljs-attribute">border-top</span>: <span class="hljs-number">5px</span> solid; <span class="hljs-comment">/* 改为向上看 */</span>
    <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">0px</span> solid;
}
</code></pre>
<p><strong>设计解析</strong>：<code>.eye</code>是基类，定义了眼睛的基本形状。<code>.eye-r-p</code>是一个修饰类，通过覆盖边框样式，改变了眼睛的方向。这种设计使得我们只需在HTML中为男主的眼睛添加这个类，就能轻松改变其神态，这正是“多态”的威力。</p>
<h3 data-id="heading-3"><strong>三、 生命注入：核心动画的时序与协作逻辑</strong></h3>
<p>整个动画的精髓在于四个核心动画的精密配合，它们共享一个4秒（<code>4s</code>）的周期并无限循环（<code>infinite</code>），但各自的节奏（关键帧百分比）不同。</p>
<p><strong>1. 女主的矜持：靠近与停留（<code>#l-ball</code>与 <code>.face-l</code>）</strong></p>
<ul>
<li>
<p><strong>身体动画 (<code>#l-ball</code>- <code>close</code>)</strong> ：</p>
<ul>
<li><code>0%-20%</code>： 从原点平滑向右移动20px（向男主靠近）。</li>
<li><code>20%-35%</code>： <strong>在右侧停留</strong>。这个停留至关重要，它为男主的亲吻动作创造了“目标”和“时机”。</li>
<li><code>35%-55%</code>： 平滑返回原点。</li>
<li><code>55%-100%</code>： 在原点长时间停留，等待下一个周期。</li>
</ul>
</li>
<li>
<p><strong>面部动画 (<code>.face-l</code>- <code>face</code>)</strong> ：</p>
<p>这个动画让女主的头部在移动时伴有轻微的转动（<code>rotate</code>），增加了拟人化的生动感。其关键帧与身体动画同步，在<code>20%</code>和<code>35%</code>（即身体停留时）触发头部微调，仿佛在害羞地调整姿态。</p>
</li>
</ul>
<p><strong>为什么这样设计？</strong> ​ 将身体和面部的动画分离，符合“单一职责原则”。<code>#l-ball</code>控制宏观位移，<code>.face-l</code>控制细微表情。两者协同，共同塑造出一个完整、生动的角色。</p>
<p><strong>2. 男主的主动：亲吻的爆发（<code>#r-ball</code>及其组件）</strong></p>
<p>男主的动画是故事的高潮，由三个部分精密协作完成：</p>
<ul>
<li>
<p><strong>身体冲刺 (<code>#r-ball</code>- <code>kiss</code>)</strong> ：</p>
<ul>
<li><code>40%-50%</code>： 在女主停留的期间（<code>20%-35%</code>之后），男主迅速向右移动并旋转，做出“探头亲吻”的动作。</li>
<li><code>50%-60%</code>： 快速向左回弹（<code>translate(-33px)</code>），这个回弹的幅度甚至超过了初始位置，模拟出亲吻的冲击力。</li>
<li><code>67%-77%</code>： 缓慢移回原点。</li>
</ul>
</li>
<li>
<p><strong>嘴巴消失与爱心出现（<code>.mouth-r</code>和 <code>.kiss-m</code>）</strong> ：</p>
<p>这是最精彩的部分，通过<strong>透明度（<code>opacity</code>）</strong> ​ 的切换实现“变脸”。</p>
<ul>
<li><strong>嘴巴 (.mouth-r - <code>mouth-m</code>)</strong> ： 在 <code>55%</code>关键帧瞬间变为透明（<code>opacity: 0</code>），在 <code>66%</code>关键帧瞬间恢复。这意味着在亲吻动作发生时，男主的嘴巴“消失”了。</li>
<li><strong>爱心 (.kiss-m - <code>kiss-m</code>)</strong> ： 它的显示（<code>opacity: 1</code>）时间被精确地设置在 <code>66%</code>，仅持续0.1%的时间（约0.004秒）。同时，嘴巴在 <code>66%</code>恢复。</li>
</ul>
</li>
</ul>
<p><strong>为什么这样设计？</strong> ​ 这创造了一个视觉魔术：在 <code>55%</code>到 <code>66%</code>之间，嘴巴消失，爱心出现。虽然爱心只闪现了一瞬间，但由于人眼的“视觉暂留”效应，我们会感觉在亲吻的刹那，男主的嘴巴变成了一颗爱心。这种通过极短时间显示替代元素来制造特效的手法，在CSS动画中非常经典且高效。</p>
<h3 data-id="heading-4"><strong>四、 深度优化：Z轴与时序的严谨性</strong></h3>
<ol>
<li><strong>层级控制 (Z-index)</strong> ： 为 <code>#l-ball</code>设置了较大的 <code>z-index: 100</code>，确保女主始终在前景。这样在男主亲吻回弹时，不会出现不合理的重叠穿帮，保证了视觉逻辑的正确。</li>
<li><strong>时序的严谨性</strong>： 所有动画的 <code>animation-timing-function</code>都设置为 <code>ease</code>，这使得动作的开始和结束更平滑自然，符合真实物体的运动规律。关键帧百分比的设定需要反复调试，以达到动作间无缝衔接的效果。</li>
</ol>
<h3 data-id="heading-5"><strong>总结与复习指南</strong></h3>
<p>这个“双球亲吻”动画是一个绝佳的CSS动画综合练习案例。要复习此项目，您可以遵循以下步骤：</p>
<ol>
<li>
<p><strong>重构HTML</strong>： 根据文档1，仅凭记忆写出结构清晰的HTML，注意基类与修饰类的应用。</p>
</li>
<li>
<p><strong>还原静态样式</strong>： 先实现两个球的静态样式，包括居中、基本形状、面部五官。重点练习伪元素（腮红）和边框画图法（眼睛）。</p>
</li>
<li>
<p><strong>分步添加动画</strong>：</p>
<ul>
<li><strong>第一步</strong>：实现女主球的水平移动动画（<code>close</code>）。</li>
<li><strong>第二步</strong>：为女主添加面部微动画（<code>face</code>），注意与身体动画的同步。</li>
<li><strong>第三步</strong>：实现男主球的冲刺与回弹动画（<code>kiss</code>）。</li>
<li><strong>第四步（关键）</strong> ：实现嘴巴和爱心的透明度切换动画，仔细体会 <code>mouth-m</code>和 <code>kiss-m</code>中关键帧百分比的设计意图，理解“视觉暂留”特效的实现原理。</li>
</ul>
</li>
</ol>
<p>通过这样的分解与重构，您不仅能牢固掌握这个动画的制作过程，更能深刻理解CSS动画设计的核心思想：<strong>将复杂动作拆解为独立的、可复用的属性变化，并通过精确的时序控制将它们组合起来，最终赋予元素生命。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 适配器模式浅析]]></title>    <link>https://juejin.cn/post/7601077764423696434</link>    <guid>https://juejin.cn/post/7601077764423696434</guid>    <pubDate>2026-01-31T08:31:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601077764423696434" data-draft-id="7601077764423499826" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 适配器模式浅析"/> <meta itemprop="keywords" content="Android,设计模式"/> <meta itemprop="datePublished" content="2026-01-31T08:31:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yen"/> <meta itemprop="url" content="https://juejin.cn/user/4037062426633214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 适配器模式浅析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4037062426633214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T08:31:07.000Z" title="Sat Jan 31 2026 08:31:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、基本概念</h2>
<h3 data-id="heading-1">定义</h3>
<p><strong>适配器模式</strong>将一个类的接口转换成客户端所期望的另一个接口，使得原本由于接口不兼容而不能一起工作的类可以一起工作。</p>
<h3 data-id="heading-2">核心思想</h3>
<ol>
<li><strong>接口转换</strong>：将一个接口转换为另一个客户端期望的接口</li>
<li><strong>兼容性</strong>：让不兼容的接口能够协同工作</li>
<li><strong>包装器</strong>：适配器本质是一个包装器</li>
</ol>
<h3 data-id="heading-3">两种实现方式</h3>
<ul>
<li><strong>类适配器</strong>：通过继承实现（Kotlin/Java不支持多重继承，限制较多）</li>
<li><strong>对象适配器</strong>：通过组合实现（推荐使用）</li>
</ul>
<h2 data-id="heading-4">二、基本结构</h2>
<h3 data-id="heading-5">三个核心角色</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. Target (目标接口) - 客户端期望的接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">MediaPlayer</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">play</span><span class="hljs-params">(audioType: <span class="hljs-type">String</span>, fileName: <span class="hljs-type">String</span>)</span></span>
}

<span class="hljs-comment">// 2. Adaptee (适配者) - 需要被适配的现有类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AdvancedMediaPlayer</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">playVlc</span><span class="hljs-params">(fileName: <span class="hljs-type">String</span>)</span></span> {
        println(<span class="hljs-string">"播放VLC文件: <span class="hljs-variable">$fileName</span>"</span>)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">playMp4</span><span class="hljs-params">(fileName: <span class="hljs-type">String</span>)</span></span> {
        println(<span class="hljs-string">"播放MP4文件: <span class="hljs-variable">$fileName</span>"</span>)
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">playAvi</span><span class="hljs-params">(fileName: <span class="hljs-type">String</span>)</span></span> {
        println(<span class="hljs-string">"播放AVI文件: <span class="hljs-variable">$fileName</span>"</span>)
    }
}

<span class="hljs-comment">// 3. Adapter (适配器) - 将Adaptee适配到Target</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaAdapter</span> : <span class="hljs-type">MediaPlayer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> advancedPlayer = AdvancedMediaPlayer()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">play</span><span class="hljs-params">(audioType: <span class="hljs-type">String</span>, fileName: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">when</span> (audioType.toLowerCase()) {
            <span class="hljs-string">"vlc"</span> -&gt; advancedPlayer.playVlc(fileName)
            <span class="hljs-string">"mp4"</span> -&gt; advancedPlayer.playMp4(fileName)
            <span class="hljs-string">"avi"</span> -&gt; advancedPlayer.playAvi(fileName)
            <span class="hljs-keyword">else</span> -&gt; println(<span class="hljs-string">"不支持的格式: <span class="hljs-variable">$audioType</span>"</span>)
        }
    }
}

<span class="hljs-comment">// 客户端使用</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> player: MediaPlayer = MediaAdapter()
    player.play(<span class="hljs-string">"mp4"</span>, <span class="hljs-string">"movie.mp4"</span>)
    player.play(<span class="hljs-string">"vlc"</span>, <span class="hljs-string">"music.vlc"</span>)
    player.play(<span class="hljs-string">"avi"</span>, <span class="hljs-string">"video.avi"</span>)
    player.play(<span class="hljs-string">"mp3"</span>, <span class="hljs-string">"song.mp3"</span>) <span class="hljs-comment">// 不支持的格式</span>
}
</code></pre>
<h2 data-id="heading-6">三、Android中的适配器模式</h2>
<h3 data-id="heading-7">1. RecyclerView.Adapter - 最经典的适配器模式</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 数据模型</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Long</span>,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> email: String,
    <span class="hljs-keyword">val</span> avatarUrl: String
)

<span class="hljs-comment">// ViewHolder</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserViewHolder</span>(view: View) : RecyclerView.ViewHolder(view) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> nameTextView: TextView = view.findViewById(R.id.tv_name)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> emailTextView: TextView = view.findViewById(R.id.tv_email)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> avatarImageView: ImageView = view.findViewById(R.id.iv_avatar)
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bind</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span> {
        nameTextView.text = user.name
        emailTextView.text = user.email
        Glide.with(avatarImageView.context)
            .load(user.avatarUrl)
            .placeholder(R.drawable.avatar_placeholder)
            .into(avatarImageView)
    }
}

<span class="hljs-comment">// 适配器 - 将List&lt;User&gt;适配到RecyclerView</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> users: List&lt;User&gt;) : 
    RecyclerView.Adapter&lt;UserViewHolder&gt;() {
    
    <span class="hljs-comment">// 将数据项转换为View</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: UserViewHolder {
        <span class="hljs-keyword">val</span> view = LayoutInflater.from(parent.context)
            .inflate(R.layout.item_user, parent, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> UserViewHolder(view)
    }
    
    <span class="hljs-comment">// 将数据绑定到View</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">UserViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> user = users[position]
        holder.bind(user)
    }
    
    <span class="hljs-comment">// 返回数据项数量</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = users.size
    
    <span class="hljs-comment">// 可选：多类型视图适配</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemViewType</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (users[position].id % <span class="hljs-number">2</span> == <span class="hljs-number">0L</span>) VIEW_TYPE_EVEN <span class="hljs-keyword">else</span> VIEW_TYPE_ODD
    }
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> VIEW_TYPE_EVEN = <span class="hljs-number">0</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> VIEW_TYPE_ODD = <span class="hljs-number">1</span>
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> users = listOf(
    User(<span class="hljs-number">1</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"zhangsan@example.com"</span>, <span class="hljs-string">"https://example.com/avatar1.jpg"</span>),
    User(<span class="hljs-number">2</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"lisi@example.com"</span>, <span class="hljs-string">"https://example.com/avatar2.jpg"</span>)
)

<span class="hljs-keyword">val</span> adapter = UserAdapter(users)
recyclerView.adapter = adapter
recyclerView.layoutManager = LinearLayoutManager(context)
</code></pre>
<h3 data-id="heading-8">2. PagerAdapter (ViewPager适配器)</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ImagePagerAdapter</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> imageUrls: List&lt;String&gt;
) : PagerAdapter() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">instantiateItem</span><span class="hljs-params">(container: <span class="hljs-type">ViewGroup</span>, position: <span class="hljs-type">Int</span>)</span></span>: Any {
        <span class="hljs-keyword">val</span> imageView = ImageView(context).apply {
            layoutParams = ViewGroup.LayoutParams(
                ViewGroup.LayoutParams.MATCH_PARENT,
                ViewGroup.LayoutParams.MATCH_PARENT
            )
            scaleType = ImageView.ScaleType.CENTER_CROP
        }
        
        Glide.with(context)
            .load(imageUrls[position])
            .into(imageView)
        
        container.addView(imageView)
        <span class="hljs-keyword">return</span> imageView
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">destroyItem</span><span class="hljs-params">(container: <span class="hljs-type">ViewGroup</span>, position: <span class="hljs-type">Int</span>, `<span class="hljs-keyword">object</span>`: <span class="hljs-type">Any</span>)</span></span> {
        container.removeView(`<span class="hljs-keyword">object</span>` <span class="hljs-keyword">as</span> View)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = imageUrls.size
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isViewFromObject</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, `<span class="hljs-keyword">object</span>`: <span class="hljs-type">Any</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> view == `<span class="hljs-keyword">object</span>`
    }
}
</code></pre>
<h2 data-id="heading-9">四、适配器模式的变体</h2>
<h3 data-id="heading-10">1. 双向适配器</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 两个不兼容的接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">EuropeanPlug</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">useTwoPins</span><span class="hljs-params">()</span></span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ChineseSocket</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">acceptThreePins</span><span class="hljs-params">()</span></span>
}

<span class="hljs-comment">// 欧洲插头实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">EuropeanPlugImpl</span> : <span class="hljs-type">EuropeanPlug</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">useTwoPins</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"使用两脚插头"</span>)
    }
}

<span class="hljs-comment">// 中国插座实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChineseSocketImpl</span> : <span class="hljs-type">ChineseSocket</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">acceptThreePins</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"接受三脚插头"</span>)
    }
}

<span class="hljs-comment">// 双向适配器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PlugSocketAdapter</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> plug: EuropeanPlug,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> socket: ChineseSocket
) : EuropeanPlug <span class="hljs-keyword">by</span> plug, ChineseSocket <span class="hljs-keyword">by</span> socket {
    
    <span class="hljs-comment">// 添加额外的转换逻辑</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">connect</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"适配器开始工作..."</span>)
        useTwoPins()
        println(<span class="hljs-string">"转换为三脚接口..."</span>)
        acceptThreePins()
        println(<span class="hljs-string">"连接成功！"</span>)
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> plug = EuropeanPlugImpl()
<span class="hljs-keyword">val</span> socket = ChineseSocketImpl()
<span class="hljs-keyword">val</span> adapter = PlugSocketAdapter(plug, socket)
adapter.connect()
</code></pre>
<h3 data-id="heading-11">2. 类适配器 (通过接口继承实现)</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 目标接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">NewSystem</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">newRequest</span><span class="hljs-params">()</span></span>: String
}

<span class="hljs-comment">// 被适配的类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OldSystem</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">oldRequest</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"来自旧系统的数据"</span>
    }
}

<span class="hljs-comment">// 类适配器（Kotlin中通过委托实现类似效果）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> oldSystem: OldSystem) : NewSystem {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">newRequest</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-comment">// 调用旧系统的方法并适配</span>
        <span class="hljs-keyword">val</span> oldResult = oldSystem.oldRequest()
        <span class="hljs-keyword">return</span> <span class="hljs-string">"适配后的数据: <span class="hljs-variable">$oldResult</span>"</span>
    }
}
</code></pre>
<h3 data-id="heading-12">3. 默认适配器 (Adapter接口的空实现)</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 接口有多个方法，但通常只用到少数几个</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">OnClickListener</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLongClick</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDoubleClick</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span>
}

<span class="hljs-comment">// 默认适配器（提供空实现）</span>
<span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultOnClickListener</span> : <span class="hljs-type">OnClickListener</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span> {
        <span class="hljs-comment">// 空实现</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLongClick</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-comment">// 空实现</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDoubleClick</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span> {
        <span class="hljs-comment">// 空实现</span>
    }
}

<span class="hljs-comment">// 使用时只需重写需要的方法</span>
button.setOnClickListener(<span class="hljs-keyword">object</span> : DefaultOnClickListener() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onClick</span><span class="hljs-params">(view: <span class="hljs-type">View</span>)</span></span> {
        Toast.makeText(view.context, <span class="hljs-string">"点击"</span>, Toast.LENGTH_SHORT).show()
    }
})
</code></pre>
<h2 data-id="heading-13">五、Android开发中的实际应用</h2>
<h3 data-id="heading-14">1. 数据源适配器</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 将不同数据源适配为统一接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">DataSource</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getData</span><span class="hljs-params">()</span></span>: List&lt;Any&gt;
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span>
}

<span class="hljs-comment">// 数据库数据源</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseDataSource</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) : DataSource {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> databaseHelper = DatabaseHelper(context)
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getData</span><span class="hljs-params">()</span></span>: List&lt;Any&gt; {
        <span class="hljs-keyword">return</span> databaseHelper.getAllUsers()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> databaseHelper.getUserCount()
    }
}

<span class="hljs-comment">// 网络数据源</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkDataSource</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> apiService: ApiService) : DataSource {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cachedData: List&lt;Any&gt; = emptyList()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getData</span><span class="hljs-params">()</span></span>: List&lt;Any&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> response = apiService.getUsers().execute()
            <span class="hljs-keyword">if</span> (response.isSuccessful) {
                cachedData = response.body() ?: emptyList()
                cachedData
            } <span class="hljs-keyword">else</span> {
                emptyList()
            }
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            emptyList()
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> cachedData.size
    }
}

<span class="hljs-comment">// 本地文件数据源</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FileDataSource</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context, <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> fileName: String) : DataSource {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getData</span><span class="hljs-params">()</span></span>: List&lt;Any&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> json = context.assets.<span class="hljs-keyword">open</span>(fileName).bufferedReader().use { it.readText() }
            <span class="hljs-keyword">val</span> type = <span class="hljs-keyword">object</span> : TypeToken&lt;List&lt;User&gt;&gt;() {}.type
            Gson().fromJson(json, type)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            emptyList()
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> getData().size
    }
}

<span class="hljs-comment">// 统一适配器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UniversalAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dataSource: DataSource) : RecyclerView.Adapter&lt;RecyclerView.ViewHolder&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateViewHolder</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, viewType: <span class="hljs-type">Int</span>)</span></span>: RecyclerView.ViewHolder {
        <span class="hljs-comment">// 根据数据类型创建不同的ViewHolder</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (viewType) {
            TYPE_USER -&gt; UserViewHolder(inflateView(parent, R.layout.item_user))
            TYPE_PRODUCT -&gt; ProductViewHolder(inflateView(parent, R.layout.item_product))
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-keyword">throw</span> IllegalArgumentException(<span class="hljs-string">"未知的视图类型"</span>)
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onBindViewHolder</span><span class="hljs-params">(holder: <span class="hljs-type">RecyclerView</span>.<span class="hljs-type">ViewHolder</span>, position: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> item = dataSource.getData()[position]
        <span class="hljs-keyword">when</span> (holder) {
            <span class="hljs-keyword">is</span> UserViewHolder -&gt; holder.bind(item <span class="hljs-keyword">as</span> User)
            <span class="hljs-keyword">is</span> ProductViewHolder -&gt; holder.bind(item <span class="hljs-keyword">as</span> Product)
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemCount</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> = dataSource.getCount()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getItemViewType</span><span class="hljs-params">(position: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">val</span> item = dataSource.getData()[position]
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (item) {
            <span class="hljs-keyword">is</span> User -&gt; TYPE_USER
            <span class="hljs-keyword">is</span> Product -&gt; TYPE_PRODUCT
            <span class="hljs-keyword">else</span> -&gt; TYPE_UNKNOWN
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">inflateView</span><span class="hljs-params">(parent: <span class="hljs-type">ViewGroup</span>, layoutId: <span class="hljs-type">Int</span>)</span></span>: View {
        <span class="hljs-keyword">return</span> LayoutInflater.from(parent.context).inflate(layoutId, parent, <span class="hljs-literal">false</span>)
    }
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TYPE_USER = <span class="hljs-number">0</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TYPE_PRODUCT = <span class="hljs-number">1</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TYPE_UNKNOWN = -<span class="hljs-number">1</span>
    }
}
</code></pre>
<h3 data-id="heading-15">2. API版本适配器</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不同API版本的相机功能适配</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">CameraSystem</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">takePhoto</span><span class="hljs-params">()</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">recordVideo</span><span class="hljs-params">()</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchCamera</span><span class="hljs-params">()</span></span>
}

<span class="hljs-comment">// Android 5.0+ 的相机实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModernCamera</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) : CameraSystem {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cameraManager = context.getSystemService(Context.CAMERA_SERVICE) <span class="hljs-keyword">as</span> CameraManager
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">takePhoto</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
            cameraManager.openCamera(<span class="hljs-string">"0"</span>, <span class="hljs-keyword">object</span> : CameraDevice.StateCallback() {
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onOpened</span><span class="hljs-params">(camera: <span class="hljs-type">CameraDevice</span>)</span></span> {
                    <span class="hljs-comment">// 现代API拍照逻辑</span>
                    println(<span class="hljs-string">"使用现代API拍照"</span>)
                }
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDisconnected</span><span class="hljs-params">(camera: <span class="hljs-type">CameraDevice</span>)</span></span> {}
                <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onError</span><span class="hljs-params">(camera: <span class="hljs-type">CameraDevice</span>, error: <span class="hljs-type">Int</span>)</span></span> {}
            }, <span class="hljs-literal">null</span>)
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">recordVideo</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"使用现代API录制视频"</span>)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchCamera</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"使用现代API切换相机"</span>)
    }
}

<span class="hljs-comment">// Android 5.0 以下的相机实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LegacyCamera</span> : <span class="hljs-type">CameraSystem</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> camera: android.hardware.Camera
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">takePhoto</span><span class="hljs-params">()</span></span> {
        camera = android.hardware.Camera.<span class="hljs-keyword">open</span>()
        <span class="hljs-comment">// 传统API拍照逻辑</span>
        println(<span class="hljs-string">"使用传统API拍照"</span>)
        camera.release()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">recordVideo</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"使用传统API录制视频"</span>)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchCamera</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"使用传统API切换相机"</span>)
    }
}

<span class="hljs-comment">// 相机适配器 - 根据API版本选择实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CameraAdapter</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) : CameraSystem {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> cameraSystem: CameraSystem <span class="hljs-keyword">by</span> lazy {
        <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
            ModernCamera(context)
        } <span class="hljs-keyword">else</span> {
            LegacyCamera()
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">takePhoto</span><span class="hljs-params">()</span></span> {
        cameraSystem.takePhoto()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">recordVideo</span><span class="hljs-params">()</span></span> {
        cameraSystem.recordVideo()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchCamera</span><span class="hljs-params">()</span></span> {
        cameraSystem.switchCamera()
    }
}

<span class="hljs-comment">// 使用 - 无需关心API版本</span>
<span class="hljs-keyword">val</span> camera = CameraAdapter(context)
camera.takePhoto()
</code></pre>
<h3 data-id="heading-16">3. 第三方库适配器</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 图片加载库适配器</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ImageLoader</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(url: <span class="hljs-type">String</span>, imageView: <span class="hljs-type">ImageView</span>)</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(url: <span class="hljs-type">String</span>, imageView: <span class="hljs-type">ImageView</span>, placeholder: <span class="hljs-type">Int</span>)</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(url: <span class="hljs-type">String</span>, imageView: <span class="hljs-type">ImageView</span>, placeholder: <span class="hljs-type">Int</span>, error: <span class="hljs-type">Int</span>)</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">preload</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearCache</span><span class="hljs-params">()</span></span>
}

<span class="hljs-comment">// Glide适配器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GlideImageLoader</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) : ImageLoader {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(url: <span class="hljs-type">String</span>, imageView: <span class="hljs-type">ImageView</span>)</span></span> {
        Glide.with(context)
            .load(url)
            .into(imageView)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(url: <span class="hljs-type">String</span>, imageView: <span class="hljs-type">ImageView</span>, placeholder: <span class="hljs-type">Int</span>)</span></span> {
        Glide.with(context)
            .load(url)
            .placeholder(placeholder)
            .into(imageView)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(url: <span class="hljs-type">String</span>, imageView: <span class="hljs-type">ImageView</span>, placeholder: <span class="hljs-type">Int</span>, error: <span class="hljs-type">Int</span>)</span></span> {
        Glide.with(context)
            .load(url)
            .placeholder(placeholder)
            .error(error)
            .into(imageView)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">preload</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span> {
        Glide.with(context)
            .load(url)
            .preload()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearCache</span><span class="hljs-params">()</span></span> {
        Glide.<span class="hljs-keyword">get</span>(context).clearMemory()
        GlobalScope.launch(Dispatchers.IO) {
            Glide.<span class="hljs-keyword">get</span>(context).clearDiskCache()
        }
    }
}

<span class="hljs-comment">// Picasso适配器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PicassoImageLoader</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) : ImageLoader {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(url: <span class="hljs-type">String</span>, imageView: <span class="hljs-type">ImageView</span>)</span></span> {
        Picasso.<span class="hljs-keyword">get</span>()
            .load(url)
            .into(imageView)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(url: <span class="hljs-type">String</span>, imageView: <span class="hljs-type">ImageView</span>, placeholder: <span class="hljs-type">Int</span>)</span></span> {
        Picasso.<span class="hljs-keyword">get</span>()
            .load(url)
            .placeholder(placeholder)
            .into(imageView)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">load</span><span class="hljs-params">(url: <span class="hljs-type">String</span>, imageView: <span class="hljs-type">ImageView</span>, placeholder: <span class="hljs-type">Int</span>, error: <span class="hljs-type">Int</span>)</span></span> {
        Picasso.<span class="hljs-keyword">get</span>()
            .load(url)
            .placeholder(placeholder)
            .error(error)
            .into(imageView)
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">preload</span><span class="hljs-params">(url: <span class="hljs-type">String</span>)</span></span> {
        Picasso.<span class="hljs-keyword">get</span>()
            .load(url)
            .fetch()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearCache</span><span class="hljs-params">()</span></span> {
        Picasso.<span class="hljs-keyword">get</span>()
            .invalidate(url)
    }
}

<span class="hljs-comment">// 统一图片加载器工厂</span>
<span class="hljs-keyword">object</span> ImageLoaderFactory {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentLoader: ImageLoader? = <span class="hljs-literal">null</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getImageLoader</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span>: ImageLoader {
        <span class="hljs-keyword">if</span> (currentLoader == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 根据配置或环境选择加载器</span>
            currentLoader = <span class="hljs-keyword">if</span> (useGlide()) {
                GlideImageLoader(context.applicationContext)
            } <span class="hljs-keyword">else</span> {
                PicassoImageLoader(context.applicationContext)
            }
        }
        <span class="hljs-keyword">return</span> currentLoader!!
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">switchLoader</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, useGlide: <span class="hljs-type">Boolean</span>)</span></span> {
        currentLoader = <span class="hljs-keyword">if</span> (useGlide) {
            GlideImageLoader(context.applicationContext)
        } <span class="hljs-keyword">else</span> {
            PicassoImageLoader(context.applicationContext)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">useGlide</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-comment">// 根据配置决定使用哪个库</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// 默认使用Glide</span>
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> imageLoader = ImageLoaderFactory.getImageLoader(context)
imageLoader.load(<span class="hljs-string">"https://example.com/image.jpg"</span>, imageView, R.drawable.placeholder)
</code></pre>
<h2 data-id="heading-17">六、Kotlin中的适配器模式优化</h2>
<h3 data-id="heading-18">1. 使用扩展函数作为适配器</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 现有类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LegacyUser</span>(<span class="hljs-keyword">val</span> firstName: String, <span class="hljs-keyword">val</span> lastName: String, <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>)

<span class="hljs-comment">// 新接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ModernUser</span> {
    <span class="hljs-keyword">val</span> fullName: String
    <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">val</span> isAdult: <span class="hljs-built_in">Boolean</span>
}

<span class="hljs-comment">// 使用扩展函数适配</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> LegacyUser.<span class="hljs-title">toModernUser</span><span class="hljs-params">()</span></span>: ModernUser {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">object</span> : ModernUser {
        <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> fullName: String
            <span class="hljs-keyword">get</span>() = <span class="hljs-string">"<span class="hljs-variable">$firstName</span> <span class="hljs-variable">$lastName</span>"</span>
        <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>
            <span class="hljs-keyword">get</span>() = <span class="hljs-keyword">this</span><span class="hljs-symbol">@toModernUser</span>.age
        <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> isAdult: <span class="hljs-built_in">Boolean</span>
            <span class="hljs-keyword">get</span>() = age &gt;= <span class="hljs-number">18</span>
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">val</span> legacyUser = LegacyUser(<span class="hljs-string">"张"</span>, <span class="hljs-string">"三"</span>, <span class="hljs-number">25</span>)
<span class="hljs-keyword">val</span> modernUser: ModernUser = legacyUser.toModernUser()
println(<span class="hljs-string">"<span class="hljs-subst">${modernUser.fullName}</span> 是成年人吗？<span class="hljs-subst">${modernUser.isAdult}</span>"</span>)
</code></pre>
<h3 data-id="heading-19">2. 使用高阶函数简化适配器</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 函数式适配器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">FunctionalAdapter</span>&lt;<span class="hljs-type">T, R</span>&gt;(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: List&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> transform: (T) -&gt; R
) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getAdaptedData</span><span class="hljs-params">()</span></span>: List&lt;R&gt; {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">data</span>.map(transform)
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiUser</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> username: String, <span class="hljs-keyword">val</span> createdAt: String)
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DomainUser</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> joinDate: Date)

<span class="hljs-keyword">val</span> apiUsers = listOf(
    ApiUser(<span class="hljs-number">1</span>, <span class="hljs-string">"user1"</span>, <span class="hljs-string">"2023-01-01"</span>),
    ApiUser(<span class="hljs-number">2</span>, <span class="hljs-string">"user2"</span>, <span class="hljs-string">"2023-02-01"</span>)
)

<span class="hljs-keyword">val</span> dateFormat = SimpleDateFormat(<span class="hljs-string">"yyyy-MM-dd"</span>, Locale.getDefault())

<span class="hljs-keyword">val</span> adapter = FunctionalAdapter(apiUsers) { apiUser -&gt;
    DomainUser(
        id = apiUser.id,
        name = apiUser.username,
        joinDate = dateFormat.parse(apiUser.createdAt) ?: Date()
    )
}

<span class="hljs-keyword">val</span> domainUsers = adapter.getAdaptedData()
</code></pre>
<h2 data-id="heading-20">七、适配器模式的优缺点</h2>
<h3 data-id="heading-21">✅ 优点</h3>
<ol>
<li><strong>提高复用性</strong>：可以复用现有的类，无需修改其代码</li>
<li><strong>提高灵活性</strong>：通过适配器可以灵活地使用不同的类</li>
<li><strong>解耦</strong>：客户端与具体实现解耦</li>
<li><strong>符合开闭原则</strong>：可以随时增加新的适配器，无需修改现有代码</li>
<li><strong>统一接口</strong>：可以将多个不同的接口统一为一个接口</li>
</ol>
<h3 data-id="heading-22">❌ 缺点</h3>
<ol>
<li><strong>增加复杂性</strong>：增加了额外的类和对象</li>
<li><strong>可能降低性能</strong>：适配器调用会增加一层间接调用</li>
<li><strong>过度使用</strong>：如果系统中到处都是适配器，会变得难以理解</li>
<li><strong>不是银弹</strong>：对于简单的接口转换，可能过度设计</li>
</ol>
<h2 data-id="heading-23">八、与其他模式的对比</h2>
<h3 data-id="heading-24">适配器模式 vs 装饰器模式</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 适配器模式：转换接口，让不兼容的接口能一起工作</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Adapter</span>(oldSystem: OldSystem) : NewSystem {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">newMethod</span><span class="hljs-params">()</span></span> {
        oldSystem.oldMethod() <span class="hljs-comment">// 只是调用，不增强功能</span>
    }
}

<span class="hljs-comment">// 装饰器模式：增强功能，不改变接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Decorator</span>(system: System) : System <span class="hljs-keyword">by</span> system {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">method</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"开始执行"</span>)
        <span class="hljs-keyword">super</span>.method() <span class="hljs-comment">// 调用原有方法并增强</span>
        println(<span class="hljs-string">"执行结束"</span>)
    }
}
</code></pre>
<h3 data-id="heading-25">适配器模式 vs 外观模式</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 适配器模式：主要解决接口不兼容问题</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaAdapter</span> : <span class="hljs-type">MediaPlayer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> advancedPlayer = AdvancedMediaPlayer()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">play</span><span class="hljs-params">(type: <span class="hljs-type">String</span>, file: <span class="hljs-type">String</span>)</span></span> {
        <span class="hljs-keyword">when</span> (type) {
            <span class="hljs-string">"mp4"</span> -&gt; advancedPlayer.playMp4(file) <span class="hljs-comment">// 一对一转换</span>
        }
    }
}

<span class="hljs-comment">// 外观模式：简化复杂系统的接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HomeTheaterFacade</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dvd = DvdPlayer()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> projector = Projector()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> lights = Lights()
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">watchMovie</span><span class="hljs-params">(movie: <span class="hljs-type">String</span>)</span></span> {
        lights.dim(<span class="hljs-number">10</span>)
        projector.on()
        projector.setInput(<span class="hljs-string">"DVD"</span>)
        dvd.on()
        dvd.play(movie) <span class="hljs-comment">// 简化多个系统的调用</span>
    }
}
</code></pre>
<h3 data-id="heading-26">适配器模式 vs 桥接模式</h3>
<pre><code class="hljs language-js" lang="js"/></pre>
<pre><code class="hljs language-text" lang="text">// 适配器模式：事后补救，让两个已有接口能一起工作
// 通常是在设计完成后的修改

// 桥接模式：事前设计，将抽象与实现分离
// 通常在系统设计时就考虑扩展性
</code></pre>
<h2 data-id="heading-27">九、最佳实践指南</h2>
<h3 data-id="heading-28">何时使用适配器模式？</h3>
<p>✅ <strong>适用场景</strong>：</p>
<ol>
<li><strong>系统升级</strong>：使用新的类库替换旧的类库时</li>
<li><strong>第三方集成</strong>：集成第三方库，但接口不兼容时</li>
<li><strong>统一接口</strong>：多个类有相似功能但接口不同，需要统一接口时</li>
<li><strong>数据转换</strong>：将一种数据格式转换为另一种格式时</li>
<li><strong>API版本适配</strong>：处理不同版本API的兼容性问题</li>
</ol>
<p>❌ <strong>避免使用场景</strong>：</p>
<ol>
<li>接口本来就兼容，不需要适配</li>
<li>可以通过重构统一接口</li>
<li>系统设计初期，可以直接设计统一的接口</li>
<li>过度使用会导致系统复杂性增加</li>
</ol>
<h3 data-id="heading-29">Android开发建议</h3>
<ol>
<li><strong>优先使用对象适配器</strong>：比类适配器更灵活</li>
<li><strong>合理使用RecyclerView.Adapter</strong>：这是Android中最常用的适配器</li>
<li><strong>考虑使用Kotlin扩展函数</strong>：对于简单的适配，扩展函数更简洁</li>
<li><strong>注意内存泄漏</strong>：适配器中持有Context或View引用时要小心</li>
<li><strong>性能优化</strong>：对于列表适配器，使用ViewHolder模式优化性能</li>
</ol>
<h3 data-id="heading-30">实现技巧</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 使用泛型增加灵活性</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Adapter</span>&lt;<span class="hljs-type">in T, out R</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">adapt</span><span class="hljs-params">(source: <span class="hljs-type">T</span>)</span></span>: R
}

<span class="hljs-comment">// 2. 支持链式适配</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChainAdapter</span>&lt;<span class="hljs-type">T, R, S</span>&gt;(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> adapter1: Adapter&lt;T, R&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> adapter2: Adapter&lt;R, S&gt;
) : Adapter&lt;T, S&gt; {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">adapt</span><span class="hljs-params">(source: <span class="hljs-type">T</span>)</span></span>: S {
        <span class="hljs-keyword">return</span> adapter2.adapt(adapter1.adapt(source))
    }
}

<span class="hljs-comment">// 3. 可配置的适配器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurableAdapter</span>&lt;<span class="hljs-type">T</span>&gt;(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> rules: Map&lt;String, (T) -&gt; Any&gt;
) {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">adapt</span><span class="hljs-params">(source: <span class="hljs-type">T</span>, config: <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, Any&gt;)</span></span>: Map&lt;String, Any&gt; {
        <span class="hljs-keyword">return</span> rules.mapValues { (key, transform) -&gt;
            <span class="hljs-keyword">if</span> (config.containsKey(key)) config[key] <span class="hljs-keyword">else</span> transform(source)
        }
    }
}
</code></pre>
<h2 data-id="heading-31">十、总结</h2>
<p>适配器模式是Android开发中<strong>最常用</strong>的设计模式之一，特别是在以下场景：</p>
<ol>
<li><strong>数据绑定</strong>：RecyclerView.Adapter是适配器模式的完美体现</li>
<li><strong>API兼容</strong>：处理不同Android版本的API差异</li>
<li><strong>第三方集成</strong>：集成不同库的统一接口</li>
<li><strong>架构优化</strong>：在不同层之间转换数据模型</li>
</ol>
<p><strong>关键点</strong>：</p>
<ul>
<li><strong>适配器是转换器</strong>：将一个接口转换为另一个接口</li>
<li><strong>两种实现方式</strong>：对象适配器（推荐）和类适配器</li>
<li><strong>不是装饰器</strong>：适配器改变接口，装饰器增强功能</li>
<li><strong>Android中无处不在</strong>：从RecyclerView到数据转换都在使用</li>
</ul>
<p><strong>在Android中的实际应用</strong>：</p>
<ul>
<li><strong>RecyclerView.Adapter</strong>：将数据适配到视图</li>
<li><strong>PagerAdapter</strong>：将数据适配到ViewPager</li>
<li><strong>资源适配</strong>：不同屏幕尺寸、语言、方向的资源适配</li>
</ul>
<p><strong>Kotlin优化</strong>：</p>
<ul>
<li><strong>扩展函数</strong>：简化简单适配</li>
<li><strong>高阶函数</strong>：函数式适配器实现</li>
</ul>
<p>适配器模式是解决接口不兼容问题的利器，合理使用可以显著提高代码的复用性和可维护性。在Android开发中，掌握适配器模式是每个开发者必备的技能</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain与LangGraph生产环境下的工程化实践]]></title>    <link>https://juejin.cn/post/7601041482892181554</link>    <guid>https://juejin.cn/post/7601041482892181554</guid>    <pubDate>2026-01-31T08:44:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601041482892181554" data-draft-id="7601041482892165170" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain与LangGraph生产环境下的工程化实践"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-31T08:44:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户023823762876"/> <meta itemprop="url" content="https://juejin.cn/user/590883624856458"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain与LangGraph生产环境下的工程化实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/590883624856458/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户023823762876
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T08:44:56.000Z" title="Sat Jan 31 2026 08:44:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么 90% 的 LangChain 项目无法进入生产环境？</h2>
<p>LangChain 与 LangGraph 的组件化能力，降低了 AI Agent 的原型构建门槛。但在项目迈向生产环境时，AI Agent 工程化落地还存在一些问题。今天想在这里分享一下，作者本人在实际生产环境中 AI Agent 开发过程中所遇到的问题和几点经验。</p>
<p>一切都以实际需求为准，那么就以实际需求为切入点，徐徐展开。</p>
<h3 data-id="heading-1">1. 多租户 API 配置的动态切换</h3>
<h4 data-id="heading-2">需求场景</h4>
<p>在 SaaS 场景下，把 Agent 封装成 API 服务对外提供时，会出现不同用户需要使用不同 LLM 配置的情况：</p>
<ul>
<li><strong>费用隔离</strong> - 企业客户自带 API Key，按自己的额度计费</li>
<li><strong>数据安全</strong> - 部分用户要求接入私有化部署的模型</li>
<li><strong>A/B 测试</strong> - 同一服务对不同请求使用不同模型对比效果</li>
</ul>
<p>除这三个常见的以外，可能还有其他的使用场景。总之，每个请求需要能够动态指定 <code>model</code>、<code>base_url</code> 和 <code>api_key</code>。</p>
<h4 data-id="heading-3">LangChain 原生实现的问题</h4>
<p>先看看 LangChain 原生是怎么做的：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-comment"># 初始化时就要绑定配置</span>
llm = ChatOpenAI(
    model=<span class="hljs-string">"gpt-4"</span>,
    api_key=<span class="hljs-string">"sk-xxx"</span>,
    base_url=<span class="hljs-string">"https://api.openai.com/v1"</span>
)
</code></pre>
<p>这样写在单用户场景没问题，但放到多租户 Web 服务里就有几个问题：</p>
<ol>
<li><strong>配置在初始化时绑定，实例创建后无法切换</strong>：<code>ChatOpenAI</code> 的 <code>model</code>、<code>openai_api_base</code>、<code>openai_api_key</code> 都是构造参数，一旦实例创建完成，配置就固定了。如果要切换到另一个服务商或 API Key，就必须创建新实例</li>
<li><strong>频繁创建实例</strong>：每来一个用户请求，就得 <code>new</code> 一个新的 <code>ChatOpenAI</code> 实例</li>
<li><strong>HTTP 连接无法复用</strong>：每个实例会独立创建底层 HTTP 连接，高并发时连接数不可控，可能导致资源耗尽</li>
</ol>
<h4 data-id="heading-4">解决方案</h4>
<p>核心思路是<strong>Agent 复用，Client 按需创建，HTTP 连接池共享</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> httpx
<span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> AsyncOpenAI

<span class="hljs-comment"># ========== 1. 全局 HTTP 连接池（单例）==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalHTTPFactory</span>:
    _client = <span class="hljs-literal">None</span>
    
<span class="hljs-meta">    @classmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_client</span>(<span class="hljs-params">cls</span>):
        <span class="hljs-keyword">if</span> cls._client <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            cls._client = httpx.AsyncClient(
                limits=httpx.Limits(max_connections=<span class="hljs-number">50</span>),
                http2=<span class="hljs-literal">True</span>
            )
        <span class="hljs-keyword">return</span> cls._client


<span class="hljs-comment"># ========== 2. Agent 基类 ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, default_config=<span class="hljs-literal">None</span></span>):
        self.default_config = default_config <span class="hljs-keyword">or</span> {}
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_openai_client</span>(<span class="hljs-params">self, runtime_config=<span class="hljs-literal">None</span></span>):
        <span class="hljs-comment"># 合并配置：运行时配置覆盖默认配置</span>
        config = {**self.default_config, **runtime_config} <span class="hljs-keyword">if</span> runtime_config <span class="hljs-keyword">else</span> self.default_config
        
        <span class="hljs-comment"># 复用全局 HTTP 连接池</span>
        shared_http = <span class="hljs-keyword">await</span> GlobalHTTPFactory.get_client()
        
        <span class="hljs-keyword">return</span> AsyncOpenAI(
            api_key=config[<span class="hljs-string">"api_key"</span>],
            base_url=config[<span class="hljs-string">"base_url"</span>],
            http_client=shared_http  <span class="hljs-comment"># 关键：注入共享的 HTTP 客户端</span>
        )
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, text, **runtime_config</span>):
        client = <span class="hljs-keyword">await</span> self.get_openai_client(runtime_config)
        <span class="hljs-comment"># 调用 LLM...</span>


<span class="hljs-comment"># ========== 3. Web 服务层 ==========</span>
<span class="hljs-comment"># 服务启动时，创建一次 Agent</span>
agent = BaseAgent()

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/chat"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">request</span>):
    <span class="hljs-comment"># 每个请求传入自己的配置</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> agent.run(
        text=request.text,
        model=request.model,
        base_url=request.base_url,
        api_key=request.api_key
    )
</code></pre>
<p>整个设计的要点：</p>
<ol>
<li><strong>Agent 只创建一次</strong>，服务启动时初始化，全局复用</li>
<li><strong>OpenAI 客户端按需创建</strong>，每个请求根据传入的配置生成</li>
<li><strong>HTTP 连接池全局共享</strong>，通过 <code>http_client</code> 参数注入，避免连接数爆炸，极大降低运行所需内存</li>
</ol>
<blockquote>
<p><strong>为什么不用全局连接池内存会一直累加？</strong></p>
<p>每次 <code>new AsyncOpenAI()</code> 都会创建一个内部的 HTTP 连接池。如果请求完成后没有显式调用 <code>close()</code>，底层连接不会立即释放。加上 Python GC 的延迟、HTTP Keep-alive 保持连接、异步对象可能存在的循环引用等因素，这些连接池会不断累积，最终导致内存持续增长甚至 OOM。使用全局连接池后，只维护一个实例，连接数有上限，问题解决。</p>
</blockquote>
<h3 data-id="heading-5">2. 模型思考过程的流式透传</h3>
<h4 data-id="heading-6">需求场景</h4>
<p>DeepSeek-R1、GLM-4 等推理模型在生成最终答案之前，会先进行一段"思考"。这个思考过程对用户来说是有价值的——它能让用户看到模型是如何分析问题的，增强可信度。</p>
<p>把 Agent 封装成 API 服务时，需要把这个思考过程实时流式地透传给前端：</p>
<ul>
<li><strong>实时展示</strong>：用户能看到模型"正在思考"，而不是干等</li>
<li><strong>区分内容</strong>：前端需要区分"思考内容"和"最终回答"，分别展示</li>
<li><strong>多模型兼容</strong>：不同模型厂商的思考参数格式不同（DeepSeek、GLM、Qwen 各有各的写法）</li>
</ul>
<h4 data-id="heading-7">问题在哪</h4>
<p>OpenAI SDK 返回的流式 chunk 结构是这样的：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 普通内容在 delta.content</span>
<span class="hljs-comment"># 思考内容在 delta.reasoning_content（这是 DeepSeek 扩展的字段）</span>
chunk.choices[<span class="hljs-number">0</span>].delta.content           <span class="hljs-comment"># 最终回答</span>
chunk.choices[<span class="hljs-number">0</span>].delta.reasoning_content  <span class="hljs-comment"># 思考过程</span>
</code></pre>
<p>问题是：</p>
<ol>
<li><strong><code>reasoning_content</code> 不是标准字段</strong>：LangChain 原生不认识这个字段，会直接丢弃</li>
<li><strong>不同模型参数不同</strong>：DeepSeek 用 <code>reasoning_content</code>，GLM 用 <code>thinking.type</code>，Qwen 用 <code>enable_thinking</code></li>
<li><strong>需要手动解析 chunk</strong>：拿到 chunk 后，要自己判断是思考内容还是正式内容</li>
</ol>
<h4 data-id="heading-8">解决方案</h4>
<p>核心问题是：LangChain 的 <code>AIMessageChunk</code> 只保留 <code>content</code>，会把 <code>reasoning_content</code> 丢掉。</p>
<p>解决思路是<strong>自定义消息类型 + 自定义 ChatModel</strong>，把 OpenAI 原始响应完整保留下来：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.messages <span class="hljs-keyword">import</span> BaseMessageChunk
<span class="hljs-keyword">from</span> langchain_core.language_models.chat_models <span class="hljs-keyword">import</span> BaseChatModel

<span class="hljs-comment"># ========== 1. 自定义消息类型，保留完整的 OpenAI 原始响应 ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatMessageChunk</span>(<span class="hljs-title class_ inherited__">BaseMessageChunk</span>):
    <span class="hljs-string">"""关键：把 OpenAI 的原始 chunk 完整保留下来"""</span>
    chat_completion_chunk: <span class="hljs-type">Optional</span>[ChatCompletionChunk] = <span class="hljs-literal">None</span>


<span class="hljs-comment"># ========== 2. 自定义 ChatModel，流式时用自定义消息类型包装 ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LLMClientChatModel</span>(<span class="hljs-title class_ inherited__">BaseChatModel</span>):
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_astream</span>(<span class="hljs-params">self, messages, **kwargs</span>):
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> self.client.astream(messages):
            <span class="hljs-comment"># 用自定义消息包装，不让 LangChain 丢掉 reasoning_content</span>
            message = ChatMessageChunk(content=<span class="hljs-string">""</span>, chat_completion_chunk=chunk)
            <span class="hljs-keyword">yield</span> ChatGenerationChunk(message=message)


<span class="hljs-comment"># ========== 3. Agent 中解析 chunk，区分思考/内容 ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAgent</span>:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_stream</span>(<span class="hljs-params">self, text, **kwargs</span>):
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> self.graph.astream_events(inputs, config):
            <span class="hljs-keyword">if</span> event[<span class="hljs-string">"event"</span>] == <span class="hljs-string">"on_chat_model_stream"</span>:
                chunk = event[<span class="hljs-string">"data"</span>][<span class="hljs-string">"chunk"</span>]
                <span class="hljs-comment"># 因为保留了完整 chunk，这里能拿到 reasoning_content</span>
                delta = chunk.message.chat_completion_chunk.choices[<span class="hljs-number">0</span>].delta
                
                <span class="hljs-keyword">if</span> delta.reasoning_content:
                    <span class="hljs-keyword">yield</span> StreamChunk(<span class="hljs-built_in">type</span>=<span class="hljs-string">"thinking"</span>, content=delta.reasoning_content)
                <span class="hljs-keyword">elif</span> delta.content:
                    <span class="hljs-keyword">yield</span> StreamChunk(<span class="hljs-built_in">type</span>=<span class="hljs-string">"content"</span>, content=delta.content)


<span class="hljs-comment"># ========== 4. 不同模型的思考参数统一管理 ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ThinkingConfig</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.model_params = {
            <span class="hljs-string">"glm"</span>: {<span class="hljs-string">"thinking"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"enabled"</span>}},
            <span class="hljs-string">"deepseek"</span>: {},  <span class="hljs-comment"># DeepSeek 默认支持</span>
            <span class="hljs-string">"qwen"</span>: {<span class="hljs-string">"enable_thinking"</span>: <span class="hljs-literal">True</span>}
        }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_params</span>(<span class="hljs-params">self, model_name, enable</span>):
        model_type = self._detect_model_type(model_name)
        <span class="hljs-keyword">return</span> self.model_params.get(model_type, {}) <span class="hljs-keyword">if</span> enable <span class="hljs-keyword">else</span> {}
</code></pre>
<p>整个设计的要点：</p>
<ol>
<li><strong>自定义消息类型</strong>：<code>ChatMessageChunk</code> 保留完整的 <code>ChatCompletionChunk</code>，不让 LangChain 丢弃扩展字段</li>
<li><strong>自定义 ChatModel</strong>：<code>LLMClientChatModel</code> 在流式输出时用自定义消息包装</li>
<li><strong>Agent 层解析</strong>：从保留的完整 chunk 中取出 <code>reasoning_content</code>，区分类型输出</li>
<li><strong>统一配置管理</strong>：<code>ThinkingConfig</code> 封装不同模型的参数差异</li>
</ol>
<h3 data-id="heading-9">3. 中间执行路径的可观测性</h3>
<h4 data-id="heading-10">需求场景</h4>
<p>以一个<strong>智能研报生成 Agent</strong> 为例，它的执行流程比较复杂：</p>
<pre><code class="hljs language-css" lang="css">输入解析 → 多源数据采集（并行）→ 数据交叉验证 → 深度分析 → 观点提炼 → 报告生成 → 合规审查 → 输出
              ↓                      ↓
         <span class="hljs-selector-attr">[财报API]</span>              <span class="hljs-selector-attr">[验证失败则重试]</span>
         <span class="hljs-selector-attr">[新闻API]</span>
         <span class="hljs-selector-attr">[行情API]</span>
</code></pre>
<p>用户调用 API 生成一份研报时，可能需要等待 30 秒以上。如果这期间前端只显示一个转圈动画，用户体验会很差。我们需要把执行进度实时透传出来：</p>
<ul>
<li><strong>实时反馈</strong>：用户能看到「正在采集财报数据 (2/3)」「正在进行深度分析」，而不是干等</li>
<li><strong>并行任务状态</strong>：多个数据源并行采集时，分别展示各自的进度</li>
<li><strong>条件分支可见</strong>：数据验证失败触发重试时，用户能知道发生了什么</li>
<li><strong>调试定位</strong>：出问题时能快速定位是哪个节点、哪个数据源出错</li>
</ul>
<h4 data-id="heading-11">问题在哪</h4>
<p>LangGraph 的 <code>ainvoke()</code> 方法只返回最终结果，中间过程完全是黑盒：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 只能拿到最终结果，中间 30 秒发生了什么完全不知道</span>
result = <span class="hljs-keyword">await</span> graph.ainvoke(inputs)
</code></pre>
<p>虽然 LangGraph 提供了 <code>astream_events()</code> 方法，但它的事件类型很多，需要自己过滤和解析：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># astream_events 会抛出各种事件：on_chain_start, on_chain_end, on_chat_model_stream...</span>
<span class="hljs-comment"># 需要自己判断哪些是节点事件，哪些是 LLM 事件，哪些是子图事件</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> graph.astream_events(inputs):
    <span class="hljs-comment"># 怎么过滤？怎么区分主图和子图？怎么处理并行节点？</span>
    <span class="hljs-keyword">pass</span>
</code></pre>
<h4 data-id="heading-12">解决方案</h4>
<p>核心是监听 <code>on_chain_start</code> / <code>on_chain_end</code> 事件，结合节点元数据，输出结构化的进度信息：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Literal</span>
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum

<span class="hljs-comment"># ========== 1. 统一的流式输出格式 ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ChunkType</span>(<span class="hljs-built_in">str</span>, Enum):
    PROCESSING = <span class="hljs-string">"processing"</span>   <span class="hljs-comment"># 执行进度</span>
    THINKING = <span class="hljs-string">"thinking"</span>       <span class="hljs-comment"># 思考过程</span>
    CONTENT = <span class="hljs-string">"content"</span>         <span class="hljs-comment"># 正式内容</span>
    FINAL = <span class="hljs-string">"final"</span>             <span class="hljs-comment"># 最终结果</span>
    ERROR = <span class="hljs-string">"error"</span>             <span class="hljs-comment"># 错误信息</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamChunk</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""流式输出块，前端按 type 分别处理"""</span>
    <span class="hljs-built_in">type</span>: ChunkType
    content: <span class="hljs-built_in">str</span>
    metadata: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">dict</span>] = <span class="hljs-literal">None</span>


<span class="hljs-comment"># ========== 2. 节点进度配置（可配置化）==========</span>
NODE_PROGRESS_MAP = {
    <span class="hljs-comment"># 节点名 -&gt; (进度描述, 预估耗时秒, 所属阶段)</span>
    <span class="hljs-string">"parse_input"</span>: (<span class="hljs-string">"解析用户输入"</span>, <span class="hljs-number">1</span>, <span class="hljs-string">"准备阶段"</span>),
    <span class="hljs-string">"fetch_financial_data"</span>: (<span class="hljs-string">"采集财报数据"</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"数据采集"</span>),
    <span class="hljs-string">"fetch_news_data"</span>: (<span class="hljs-string">"采集新闻资讯"</span>, <span class="hljs-number">3</span>, <span class="hljs-string">"数据采集"</span>),
    <span class="hljs-string">"fetch_market_data"</span>: (<span class="hljs-string">"采集行情数据"</span>, <span class="hljs-number">2</span>, <span class="hljs-string">"数据采集"</span>),
    <span class="hljs-string">"validate_data"</span>: (<span class="hljs-string">"交叉验证数据"</span>, <span class="hljs-number">3</span>, <span class="hljs-string">"数据处理"</span>),
    <span class="hljs-string">"deep_analysis"</span>: (<span class="hljs-string">"深度分析"</span>, <span class="hljs-number">10</span>, <span class="hljs-string">"智能分析"</span>),
    <span class="hljs-string">"extract_insights"</span>: (<span class="hljs-string">"提炼核心观点"</span>, <span class="hljs-number">5</span>, <span class="hljs-string">"智能分析"</span>),
    <span class="hljs-string">"generate_report"</span>: (<span class="hljs-string">"生成研报内容"</span>, <span class="hljs-number">8</span>, <span class="hljs-string">"报告生成"</span>),
    <span class="hljs-string">"compliance_check"</span>: (<span class="hljs-string">"合规性审查"</span>, <span class="hljs-number">3</span>, <span class="hljs-string">"质量保障"</span>),
}


<span class="hljs-comment"># ========== 3. Agent 中监听节点事件 ==========</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResearchReportAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        self.parallel_tasks = {}  <span class="hljs-comment"># 跟踪并行任务状态</span>
        self.retry_count = {}     <span class="hljs-comment"># 跟踪重试次数</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_stream</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, **kwargs</span>):
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> event <span class="hljs-keyword">in</span> self.graph.astream_events(inputs, config):
            event_type = event.get(<span class="hljs-string">"event"</span>, <span class="hljs-string">""</span>)
            node_name = event.get(<span class="hljs-string">"name"</span>, <span class="hljs-string">""</span>)
            
            <span class="hljs-comment"># ===== 节点开始事件 =====</span>
            <span class="hljs-keyword">if</span> event_type == <span class="hljs-string">"on_chain_start"</span>:
                <span class="hljs-keyword">if</span> node_name <span class="hljs-keyword">in</span> NODE_PROGRESS_MAP:
                    desc, est_time, stage = NODE_PROGRESS_MAP[node_name]
                    
                    <span class="hljs-comment"># 处理重试场景</span>
                    retry = self.retry_count.get(node_name, <span class="hljs-number">0</span>)
                    retry_hint = <span class="hljs-string">f"（第 <span class="hljs-subst">{retry + <span class="hljs-number">1</span>}</span> 次尝试）"</span> <span class="hljs-keyword">if</span> retry &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
                    
                    <span class="hljs-keyword">yield</span> StreamChunk(
                        <span class="hljs-built_in">type</span>=ChunkType.PROCESSING,
                        content=<span class="hljs-string">f"[<span class="hljs-subst">{stage}</span>] <span class="hljs-subst">{desc}</span><span class="hljs-subst">{retry_hint}</span>..."</span>,
                        metadata={
                            <span class="hljs-string">"node"</span>: node_name,
                            <span class="hljs-string">"stage"</span>: stage,
                            <span class="hljs-string">"estimated_seconds"</span>: est_time,
                            <span class="hljs-string">"retry_count"</span>: retry
                        }
                    )
                    
                <span class="hljs-comment"># 处理并行数据采集节点</span>
                <span class="hljs-keyword">elif</span> node_name == <span class="hljs-string">"parallel_data_fetch"</span>:
                    self.parallel_tasks = {<span class="hljs-string">"financial"</span>: <span class="hljs-string">"pending"</span>, <span class="hljs-string">"news"</span>: <span class="hljs-string">"pending"</span>, <span class="hljs-string">"market"</span>: <span class="hljs-string">"pending"</span>}
                    <span class="hljs-keyword">yield</span> StreamChunk(
                        <span class="hljs-built_in">type</span>=ChunkType.PROCESSING,
                        content=<span class="hljs-string">"[数据采集] 正在并行采集多源数据..."</span>,
                        metadata={<span class="hljs-string">"parallel_status"</span>: self.parallel_tasks}
                    )
            
            <span class="hljs-comment"># ===== 节点结束事件 =====</span>
            <span class="hljs-keyword">elif</span> event_type == <span class="hljs-string">"on_chain_end"</span>:
                <span class="hljs-comment"># 更新并行任务状态</span>
                <span class="hljs-keyword">if</span> node_name == <span class="hljs-string">"fetch_financial_data"</span>:
                    self.parallel_tasks[<span class="hljs-string">"financial"</span>] = <span class="hljs-string">"completed"</span>
                    <span class="hljs-keyword">yield</span> StreamChunk(
                        <span class="hljs-built_in">type</span>=ChunkType.PROCESSING,
                        content=<span class="hljs-string">"[数据采集] 财报数据采集完成 ✓"</span>,
                        metadata={<span class="hljs-string">"parallel_status"</span>: self.parallel_tasks.copy()}
                    )
                
                <span class="hljs-comment"># 处理验证失败触发重试的场景</span>
                <span class="hljs-keyword">elif</span> node_name == <span class="hljs-string">"validate_data"</span>:
                    output = event.get(<span class="hljs-string">"data"</span>, {}).get(<span class="hljs-string">"output"</span>, {})
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> output.get(<span class="hljs-string">"is_valid"</span>, <span class="hljs-literal">True</span>):
                        failed_sources = output.get(<span class="hljs-string">"failed_sources"</span>, [])
                        <span class="hljs-keyword">for</span> src <span class="hljs-keyword">in</span> failed_sources:
                            self.retry_count[<span class="hljs-string">f"fetch_<span class="hljs-subst">{src}</span>_data"</span>] = self.retry_count.get(<span class="hljs-string">f"fetch_<span class="hljs-subst">{src}</span>_data"</span>, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>
                        <span class="hljs-keyword">yield</span> StreamChunk(
                            <span class="hljs-built_in">type</span>=ChunkType.PROCESSING,
                            content=<span class="hljs-string">f"[数据处理] 验证未通过，<span class="hljs-subst">{failed_sources}</span> 将重新采集..."</span>,
                            metadata={<span class="hljs-string">"retry_sources"</span>: failed_sources}
                        )
                
                <span class="hljs-comment"># 图执行完毕，输出最终结果</span>
                <span class="hljs-keyword">elif</span> node_name == <span class="hljs-string">"LangGraph"</span>:
                    final_output = event[<span class="hljs-string">"data"</span>][<span class="hljs-string">"output"</span>]
                    <span class="hljs-keyword">yield</span> StreamChunk(
                        <span class="hljs-built_in">type</span>=ChunkType.FINAL,
                        content=<span class="hljs-string">""</span>,
                        metadata={<span class="hljs-string">"report"</span>: final_output}
                    )
            
            <span class="hljs-comment"># ===== LLM 流式输出事件 =====</span>
            <span class="hljs-keyword">elif</span> event_type == <span class="hljs-string">"on_chat_model_stream"</span>:
                chunk = event[<span class="hljs-string">"data"</span>][<span class="hljs-string">"chunk"</span>]
                delta = chunk.message.chat_completion_chunk.choices[<span class="hljs-number">0</span>].delta
                
                <span class="hljs-keyword">if</span> delta.reasoning_content:
                    <span class="hljs-keyword">yield</span> StreamChunk(<span class="hljs-built_in">type</span>=ChunkType.THINKING, content=delta.reasoning_content)
                <span class="hljs-keyword">elif</span> delta.content:
                    <span class="hljs-keyword">yield</span> StreamChunk(<span class="hljs-built_in">type</span>=ChunkType.CONTENT, content=delta.content)
</code></pre>
<p>前端拿到的流式输出会是这样：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[准备阶段] 解析用户输入..."</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"parse_input"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"stage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"准备阶段"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"estimated_seconds"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[数据采集] 正在并行采集多源数据..."</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"parallel_status"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"financial"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pending"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pending"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"market"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pending"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[数据采集] 采集新闻资讯..."</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fetch_news_data"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"stage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"数据采集"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[数据采集] 采集财报数据..."</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fetch_financial_data"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"stage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"数据采集"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[数据采集] 新闻数据采集完成 ✓"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"parallel_status"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"financial"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pending"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"completed"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"market"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pending"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[数据采集] 财报数据采集完成 ✓"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"parallel_status"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"financial"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"completed"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"completed"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"market"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pending"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[数据采集] 行情数据采集完成 ✓"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"parallel_status"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"financial"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"completed"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"news"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"completed"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"market"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"completed"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[数据处理] 交叉验证数据..."</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"validate_data"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[数据处理] 验证未通过，['market'] 将重新采集..."</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"retry_sources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"market"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[数据采集] 采集行情数据（第 2 次尝试）..."</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fetch_market_data"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"retry_count"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[智能分析] 深度分析..."</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"deep_analysis"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"estimated_seconds"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"thinking"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我需要从多个维度分析这家公司..."</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"thinking"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首先看财务数据，营收同比增长..."</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"content"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"## 一、公司概况\n\n"</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"content"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"该公司是国内领先的..."</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[智能分析] 提炼核心观点..."</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"extract_insights"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[报告生成] 生成研报内容..."</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"generate_report"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"processing"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"[质量保障] 合规性审查..."</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"compliance_check"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"final"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"metadata"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"report"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"XX公司深度研究报告"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"sections"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>...<span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<p>整个设计的要点：</p>
<ol>
<li><strong>统一输出格式</strong>：<code>StreamChunk</code> 定义 <code>type</code> 字段，前端按类型分别处理</li>
<li><strong>节点配置可扩展</strong>：<code>NODE_PROGRESS_MAP</code> 集中管理节点描述，新增节点只需加一行配置</li>
<li><strong>并行任务可追踪</strong>：通过 <code>parallel_status</code> 字段，前端可以渲染多任务进度条</li>
<li><strong>重试过程透明</strong>：验证失败、重新采集等异常流程对用户可见，增强可信度</li>
<li><strong>预估时间可用</strong>：<code>estimated_seconds</code> 可用于前端渲染预估进度条</li>
</ol>
<hr/>
<h3 data-id="heading-13">总结</h3>
<p>本文分享了在开发 <code>open-pilot-agent</code> 过程中遇到的三个生产级挑战，以及对应的解决方案：</p>
<ol>
<li><strong>多租户 API 配置的动态切换</strong>：通过 Agent 复用 + Client 按需创建 + HTTP 连接池共享，解决配置动态切换和资源管理问题</li>
<li><strong>模型思考过程的流式透传</strong>：通过自定义消息类型和 ChatModel，保留 OpenAI 原始响应中的 <code>reasoning_content</code> 字段</li>
<li><strong>中间执行路径的可观测性</strong>：通过监听 LangGraph 的 <code>astream_events</code>，将节点执行进度实时透传给前端</li>
</ol>
<p>后续作者将会继续分享生产级 Agent 的实际工程经验。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于spring boot3 + websocket + stomp + 集群会话管理 + token 认证 + ack 消息确认，完成服务器单向消息推送]]></title>    <link>https://juejin.cn/post/7601169987396665395</link>    <guid>https://juejin.cn/post/7601169987396665395</guid>    <pubDate>2026-01-31T09:17:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601169987396665395" data-draft-id="7601077764423876658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于spring boot3 + websocket + stomp + 集群会话管理 + token 认证 + ack 消息确认，完成服务器单向消息推送"/> <meta itemprop="keywords" content="WebSocket,Spring Boot"/> <meta itemprop="datePublished" content="2026-01-31T09:17:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户9743697072528"/> <meta itemprop="url" content="https://juejin.cn/user/2007041425282698"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于spring boot3 + websocket + stomp + 集群会话管理 + token 认证 + ack 消息确认，完成服务器单向消息推送
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2007041425282698/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户9743697072528
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T09:17:40.000Z" title="Sat Jan 31 2026 09:17:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p align="center">
  </p><p align="center">
    基于 Spring Boot 3 + WebSocket STOMP + Redis 的企业级实时消息推送系统
    <br/>
    <strong>已在生产环境验证，轻松应对万级日活用户</strong>
  </p>
<p/>
<p align="center">
  <a href="#特性" title="#特性">特性</a> •
  <a href="#快速开始" title="#快速开始">快速开始</a> •
  <a href="#核心功能详解" title="#核心功能详解">核心功能详解</a> •
  <a href="#接入指南" title="#接入指南">接入指南</a> •
  <a href="#api-文档" title="#api-文档">API 文档</a>
</p>
<hr/>
<ul>
<li>GitHub地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyangli-stu%2Fquick-notify" target="_blank" title="https://github.com/yangli-stu/quick-notify" ref="nofollow noopener noreferrer">github.com/yangli-stu/…</a></li>
</ul>
<h2 data-id="heading-0">特性</h2>

































<table><thead><tr><th>特性</th><th>描述</th></tr></thead><tbody><tr><td><strong>实时推送</strong></td><td>基于 WebSocket + STOMP 协议，毫秒级消息送达</td></tr><tr><td><strong>Token 认证</strong></td><td>支持 JWT 等多种认证方式，安全可靠</td></tr><tr><td><strong>消息确认 (ACK)</strong></td><td>自动重试机制，确保消息可靠送达</td></tr><tr><td><strong>集群支持</strong></td><td>基于 Redis Pub/Sub，支持多节点水平扩展</td></tr><tr><td><strong>消息持久化</strong></td><td>支持历史消息存储与查询</td></tr><tr><td><strong>开箱即用</strong></td><td>完整的前后端示例，5 分钟快速上手</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-1">技术栈</h2>













































<table><thead><tr><th>技术</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td>Spring Boot</td><td>3.2.11</td><td>应用框架</td></tr><tr><td>Java</td><td>21</td><td>开发语言</td></tr><tr><td>WebSocket + STOMP</td><td>-</td><td>实时通信协议</td></tr><tr><td>SockJS</td><td>1.x</td><td>浏览器兼容降级</td></tr><tr><td>Redisson</td><td>3.37.0</td><td>Redis 客户端 + 分布式支持</td></tr><tr><td>CosId</td><td>2.8.1</td><td>分布式雪花 ID 生成</td></tr><tr><td>Spring Data JPA</td><td>-</td><td>数据持久化</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">快速开始</h2>
<h3 data-id="heading-3">环境要求</h3>
<ul>
<li>Java 21+</li>
<li>Maven 3.8+</li>
<li>Redis 6+ (或 Docker)</li>
</ul>
<h3 data-id="heading-4">1. 启动 Redis</h3>
<pre><code class="hljs language-bash" lang="bash">docker run -d --name redis -p 6379:6379 redis
</code></pre>
<h3 data-id="heading-5">2. 克隆并运行</h3>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/your-repo/quick-notify.git
<span class="hljs-built_in">cd</span> quick-notify
mvn spring-boot:run
</code></pre>
<h3 data-id="heading-6">3. 打开测试页面</h3>
<p>浏览器访问 <code>http://localhost:2025/stomp-websocket-sockjs.html</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff172b98ac824291a92981c8a8878ef7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3OTc0MzY5NzA3MjUyOA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770455860&amp;x-signature=PvDYYhH7MWFMWeX4tIjFR0DBytg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-7">4. 发送测试消息(模拟服务器推送消息)</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 发送给指定用户</span>
curl -X POST -d <span class="hljs-string">"Hello World"</span> http://localhost:2025/vh-stomp-wsend/push_all_obj/test1

<span class="hljs-comment"># 广播给所有在线用户</span>
curl -X POST -d <span class="hljs-string">"广播消息"</span> http://localhost:2025/vh-stomp-wsend/push_all_obj
</code></pre>
<hr/>
<h2 data-id="heading-8">核心功能详解</h2>
<h3 data-id="heading-9">1. Token 认证</h3>
<h4 data-id="heading-10">认证流程</h4>
<pre><code class="hljs language-sql" lang="sql">┌──────────────┐                              ┌──────────────┐
│    客户端     │                              │    服务端     │
└──────┬───────┘                              └──────┬───────┘
       │                                             │
       │  <span class="hljs-number">1.</span> STOMP <span class="hljs-keyword">CONNECT</span>                           │
       │  ┌─────────────────────────────┐            │
       │  │ <span class="hljs-keyword">CONNECT</span>                      │           │
       │  │ <span class="hljs-keyword">Authorization</span>: Bearer <span class="hljs-operator">&lt;</span>JWT<span class="hljs-operator">&gt;</span>  │           │
       │  │ accept<span class="hljs-operator">-</span>version: <span class="hljs-number">1.2</span>          │           │
       │  └─────────────────────────────┘            │
       │ ─────────────────────────────────────────<span class="hljs-operator">&gt;</span>  │
       │                                             │
       │                    <span class="hljs-number">2.</span> StompWebsocketInterceptor 拦截
       │                       ├─ 提取 <span class="hljs-keyword">Authorization</span> 头
       │                       ├─ 解析 Token 获取 userId
       │                       ├─ 校验用户连接数 (≤<span class="hljs-number">10</span>)
       │                       └─ 绑定 Principal 到会话
       │                                             │
       │  <span class="hljs-number">3.</span> STOMP CONNECTED                         │
       │ <span class="hljs-operator">&lt;</span>─────────────────────────────────────────  │
       │                                             │
       │  <span class="hljs-number">4.</span> 后续消息自动携带用户身份                    │
       │ ─────────────────────────────────────────<span class="hljs-operator">&gt;</span>  │
</code></pre>
<h4 data-id="heading-11">核心代码</h4>
<p><strong>服务端拦截器</strong> (<code>StompWebsocketInterceptor.java</code>)：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StompWebsocketInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ChannelInterceptor</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Message&lt;?&gt; preSend(Message&lt;?&gt; message, MessageChannel channel) {
        <span class="hljs-type">StompHeaderAccessor</span> <span class="hljs-variable">accessor</span> <span class="hljs-operator">=</span> MessageHeaderAccessor.getAccessor(
            message, StompHeaderAccessor.class);
        
        <span class="hljs-keyword">if</span> (StompCommand.CONNECT.equals(accessor.getCommand())) {
            <span class="hljs-comment">// 1. 从请求头提取 Token</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> accessor.getNativeHeader(<span class="hljs-string">"Authorization"</span>).get(<span class="hljs-number">0</span>);
            
            <span class="hljs-comment">// 2. 解析 Token 获取用户ID（支持 JWT 或自定义方式）</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> extractUserFromToken(token);
            
            <span class="hljs-comment">// 3. 校验用户连接数限制</span>
            List&lt;String&gt; existingSessions = Optional
                .ofNullable(simpUserRegistry.getUser(userId))
                .map(SimpUser::getSessions)
                .map(sessions -&gt; sessions.stream().map(SimpSession::getId).toList())
                .orElse(List.of());
                
            <span class="hljs-keyword">if</span> (existingSessions.size() &gt; <span class="hljs-number">10</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"用户连接数超限"</span>);
            }
            
            <span class="hljs-comment">// 4. 绑定用户身份到 WebSocket 会话</span>
            accessor.setUser(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyPrincipal</span>(userId));
        }
        <span class="hljs-keyword">return</span> message;
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">extractUserFromToken</span><span class="hljs-params">(String token)</span> {
        <span class="hljs-comment">// 开发环境：直接使用 token 作为用户ID</span>
        <span class="hljs-keyword">if</span> (SpringContextUtil.isDevEnv() &amp;&amp; token.startsWith(<span class="hljs-string">"test"</span>)) {
            <span class="hljs-keyword">return</span> token;
        }
        <span class="hljs-comment">// 生产环境：解析 JWT</span>
        <span class="hljs-keyword">return</span> SpringContextUtil.getBean(JwtDecoder.class)
            .decode(token).getSubject();
    }
}
</code></pre>
<p><strong>客户端连接</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> stompClient = <span class="hljs-title class_">Stomp</span>.<span class="hljs-title function_">over</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SockJS</span>(<span class="hljs-string">'/stomp-ws'</span>));

stompClient.<span class="hljs-title function_">connect</span>(
    { <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">'Bearer eyJhbGciOiJIUzI1NiJ9...'</span> },  <span class="hljs-comment">// JWT Token</span>
    <span class="hljs-keyword">function</span>(<span class="hljs-params">frame</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'连接成功，用户身份已绑定'</span>);
    },
    <span class="hljs-keyword">function</span>(<span class="hljs-params">error</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'连接失败:'</span>, error);
    }
);
</code></pre>
<h4 data-id="heading-12">自定义认证方式</h4>
<p>如需接入其他认证系统，修改 <code>extractUserFromToken</code> 方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> String <span class="hljs-title function_">extractUserFromToken</span><span class="hljs-params">(String token)</span> {
    <span class="hljs-comment">// 方式1：JWT 解析</span>
    <span class="hljs-keyword">return</span> jwtDecoder.decode(token).getSubject();
    
    <span class="hljs-comment">// 方式2：调用用户中心验证</span>
    <span class="hljs-keyword">return</span> userCenterClient.validateToken(token).getUserId();
    
    <span class="hljs-comment">// 方式3：Redis Session 验证</span>
    <span class="hljs-keyword">return</span> redisTemplate.opsForValue().get(<span class="hljs-string">"session:"</span> + token);
}
</code></pre>
<hr/>
<h3 data-id="heading-13">2. 消息确认机制 (ACK)</h3>
<h4 data-id="heading-14">设计目标</h4>
<p>解决以下场景的消息丢失问题：</p>
<ul>
<li>网络抖动导致消息未送达</li>
<li>客户端崩溃未处理消息</li>
<li>多设备同步确保每个设备都收到</li>
</ul>
<h4 data-id="heading-15">工作流程</h4>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────────────┐
│                        消息发送阶段                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  sendMessageWithAck(message)                                        │
│         │                                                           │
│         ├──────────────────────────────────────────────────────┐    │
│         │                                                      │    │
│         ▼                                                      ▼    │
│  ┌─────────────────┐                              ┌─────────────────┐
│  │ 推送到 WebSocket │                              │ 创建 ACK 记录    │
│  │ /user/queue/msg │                              │ Redis Hash      │
│  └────────┬────────┘                              └────────┬────────┘
│           │                                                │        │
│           │  Key: stomp::pending_messages                  │        │
│           │  Field: {msgId}::{sessionId}                   │        │
│           │  Value: NotifyMessage 对象                      │        │
│           │                                                │        │
└───────────┼────────────────────────────────────────────────┼────────┘
            │                                                │
            ▼                                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        客户端处理阶段                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  客户端收到消息                                                       │
│         │                                                           │
│         ├─&gt; 处理业务逻辑（需做幂等处理）                                 │
│         │                                                           │
│         └─&gt; 发送 ACK 确认                                            │
│              stompClient.<span class="hljs-built_in">send</span>(<span class="hljs-string">'/app/ack'</span>, {}, messageId)            │
│                     │                                               │
│                     ▼                                               │
│              服务端收到 ACK                                           │
│                     │                                               │
│                     └─&gt; 从 Redis 移除 ACK 记录                        │
│                         log: [ACK-REDIS] 确认成功                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
            │
            │ 如果客户端未发送 ACK
            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        定时重试阶段（每 <span class="hljs-number">5</span> 秒）                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  @<span class="hljs-built_in">Scheduled</span>(fixedDelay = <span class="hljs-number">5000</span>)                                      │
│  <span class="hljs-built_in">retryRedisMessages</span>()                                               │
│         │                                                           │
│         ├─&gt; 遍历 Redis 中所有待确认消息                                │
│         │                                                           │
│         ├─&gt; 检查条件：                                                │
│         │   • 创建时间 &gt; <span class="hljs-number">5</span>秒（等待窗口）                                │
│         │   • 重试次数 &lt; <span class="hljs-number">12</span>次                                         │
│         │   • 总时长 &lt; <span class="hljs-number">60</span>秒                                           │
│         │   • 目标 Session 仍在线                                     │
│         │                                                           │
│         ├─&gt; 符合条件：重新发送消息，retryCount++                        │
│         │                                                           │
│         └─&gt; 超过限制：移除记录，log: [ACK-REDIS] 消息过期                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-16">配置参数</h4>









































<table><thead><tr><th>参数</th><th>默认值</th><th>说明</th><th>修改位置</th></tr></thead><tbody><tr><td><code>ACK_CHECK_WAIT_MS</code></td><td>5000ms</td><td>首次检查等待时间</td><td><code>StompWebSocketHandler.java:38</code></td></tr><tr><td><code>ACK_RETRY_INTERVAL_MS</code></td><td>5000ms</td><td>重试间隔</td><td><code>StompWebSocketHandler.java:39</code></td></tr><tr><td><code>ACK_MESSAGE_TTL_MS</code></td><td>60000ms</td><td>消息最大存活时间</td><td><code>StompWebSocketHandler.java:40</code></td></tr><tr><td><code>ACK_MAX_RETRY_COUNT</code></td><td>12</td><td>最大重试次数（自动计算）</td><td><code>StompWebSocketHandler.java:41</code></td></tr><tr><td><code>enableLocalAck</code></td><td>false</td><td>是否使用本地缓存</td><td><code>StompWebSocketHandler.java:44</code></td></tr></tbody></table>
<h4 data-id="heading-17">核心代码</h4>
<p><strong>发送带 ACK 的消息</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessageWithAck</span><span class="hljs-params">(NotifyMessage message)</span> {
    <span class="hljs-type">SimpUser</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userRegistry.getUser(message.getReceiver());
    <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span> &amp;&amp; user.hasSessions()) {
        <span class="hljs-comment">// 为用户的每个会话（多设备）分别创建 ACK 记录</span>
        <span class="hljs-keyword">for</span> (SimpSession session : user.getSessions()) {
            <span class="hljs-comment">// 1. 发送消息到指定 Session</span>
            sendMessage(message, session.getId());
            <span class="hljs-comment">// 2. 创建 ACK 追踪记录</span>
            addAckMessageRecord(message, session.getId());
        }
    }
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addToRedis</span><span class="hljs-params">(NotifyMessage message, String sessionId)</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">ackKey</span> <span class="hljs-operator">=</span> buildAckKey(message.getId(), sessionId);  <span class="hljs-comment">// msgId::sessionId</span>
    RMap&lt;String, NotifyMessage&gt; map = redisson.getMap(PENDING_MAP_KEY);
    
    message.setCreated(System.currentTimeMillis());
    message.setAckRetryCount(<span class="hljs-number">0</span>);
    message.setAckLastSent(System.currentTimeMillis());
    
    map.put(ackKey, message);
    log.info(<span class="hljs-string">"[ACK-REDIS] 消息入队, msgId {}, sessionId {}, receiver {}"</span>,
        message.getId(), sessionId, message.getReceiver());
}
</code></pre>
<p><strong>客户端 ACK 处理</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript">stompClient.<span class="hljs-title function_">subscribe</span>(<span class="hljs-string">'/user/queue/msg'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(message.<span class="hljs-property">body</span>);
    
    <span class="hljs-comment">// 1. 幂等处理（防止重复消息）</span>
    <span class="hljs-keyword">if</span> (processedIds.<span class="hljs-title function_">has</span>(data.<span class="hljs-property">id</span>)) {
        stompClient.<span class="hljs-title function_">send</span>(<span class="hljs-string">'/app/ack'</span>, {}, data.<span class="hljs-property">id</span>);  <span class="hljs-comment">// 仍需发送 ACK</span>
        <span class="hljs-keyword">return</span>;
    }
    processedIds.<span class="hljs-title function_">add</span>(data.<span class="hljs-property">id</span>);
    
    <span class="hljs-comment">// 2. 处理业务逻辑</span>
    <span class="hljs-title function_">handleNotification</span>(data);
    
    <span class="hljs-comment">// 3. 发送 ACK 确认（重要！）</span>
    stompClient.<span class="hljs-title function_">send</span>(<span class="hljs-string">'/app/ack'</span>, {}, data.<span class="hljs-property">id</span>);
});
</code></pre>
<h4 data-id="heading-18">监控日志</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 消息入队</span>
[<span class="hljs-meta">ACK-REDIS</span>] 消息入队, msgId msg<span class="hljs-number">-123</span>, sessionId sess<span class="hljs-number">-456</span>, receiver user<span class="hljs-number">-789</span>

<span class="hljs-meta"># 确认成功</span>
[<span class="hljs-meta">ACK-REDIS</span>] 确认成功, msgId msg<span class="hljs-number">-123</span>, sessionId sess<span class="hljs-number">-456</span>, retryCount <span class="hljs-number">0</span>

<span class="hljs-meta"># 重试发送</span>
[<span class="hljs-meta">ACK-REDIS</span>] 重发, msgId msg<span class="hljs-number">-123</span>, sessionId sess<span class="hljs-number">-456</span>, retryCount <span class="hljs-number">3</span>

<span class="hljs-meta"># 定时任务汇总</span>
[<span class="hljs-meta">ACK-REDIS</span>] 定时处理完成, total <span class="hljs-number">10</span>, retried <span class="hljs-number">2</span>, expired <span class="hljs-number">1</span>, <span class="hljs-keyword">not</span> online <span class="hljs-number">0</span>
</code></pre>
<hr/>
<h3 data-id="heading-19">3. 集群消息推送</h3>
<h4 data-id="heading-20">问题场景</h4>
<p>在多节点部署时，用户可能连接到任意节点：</p>
<pre><code class="hljs language-css" lang="css">用户 <span class="hljs-selector-tag">A</span> 连接到 ──&gt; 节点 <span class="hljs-number">1</span>
用户 <span class="hljs-selector-tag">B</span> 连接到 ──&gt; 节点 <span class="hljs-number">2</span>

业务系统调用节点 <span class="hljs-number">1</span> 发送消息给用户 <span class="hljs-selector-tag">B</span>
问题：节点 <span class="hljs-number">1</span> 没有用户 <span class="hljs-selector-tag">B</span> 的 WebSocket 会话，如何推送？
</code></pre>
<h4 data-id="heading-21">解决方案</h4>
<p>使用 Redis Pub/Sub 实现跨节点消息转发：</p>
<pre><code class="hljs language-csharp" lang="csharp">┌─────────────────────────────────────────────────────────────────────┐
│                           业务调用                                   │
│                                                                     │
│  notifyManager.saveAndPublish(message)  <span class="hljs-comment">// 发送给用户 B               │</span>
│         │                                                           │
└─────────┼───────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         节点 <span class="hljs-number">1</span> 处理                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  StompNotifyEventListener.handler(<span class="hljs-keyword">event</span>)                            │
│         │                                                           │
│         ├─&gt; 检查本地是否有用户 B 的会话                                 │
│         │   hasSession(<span class="hljs-string">"userB"</span>) == <span class="hljs-literal">false</span>                            │
│         │                                                           │
│         └─&gt; 发布事件到 Redis Topic                                    │
│             topic.publish(NotifyMessageEvent)                       │
│                     │                                               │
│                     │  Topic: stomp::ws_notify_topic                │
│                     │                                               │
└─────────────────────┼───────────────────────────────────────────────┘
                      │
                      │ Redis Pub/Sub 广播到所有订阅节点
                      │
          ┌───────────┴───────────┐
          │                       │
          ▼                       ▼
┌─────────────────────┐ ┌─────────────────────┐
│      节点 <span class="hljs-number">1</span>         │ │      节点 <span class="hljs-number">2</span>         │
│                     │ │                     │
│  收到事件           │ │  收到事件           │
│  hasSession = <span class="hljs-literal">false</span> │ │  hasSession = <span class="hljs-literal">true</span>  │
│  忽略               │ │                     │
│                     │ │  sendMessageWithAck │
│                     │ │  推送给用户 B       │
└─────────────────────┘ └─────────────────────┘
</code></pre>
<h4 data-id="heading-22">核心代码</h4>
<p><strong>事件监听器</strong> (<code>StompNotifyEventListener.java</code>)：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StompNotifyEventListener</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">NOTIFY_TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"stomp::ws_notify_topic"</span>;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StompWebSocketHandler stompWebSocketHandler;
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Redisson redisson;

    <span class="hljs-comment">// 监听本地 Spring 事件</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-meta">@TransactionalEventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handler</span><span class="hljs-params">(NotifyMessageEvent event)</span> {
        handlerEvent(event, <span class="hljs-literal">true</span>);  <span class="hljs-comment">// isLocalEvent = true</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlerEvent</span><span class="hljs-params">(NotifyMessageEvent event, <span class="hljs-type">boolean</span> isLocalEvent)</span> {
        <span class="hljs-type">NotifyMessage</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> event.notifyMessageLog().convert();
        
        <span class="hljs-keyword">if</span> (isLocalEvent) {
            <span class="hljs-comment">// 本地事件：广播到 Redis，让集群所有节点都能处理</span>
            publishClusterEvent(event);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 集群事件：检查本地是否有目标用户的会话</span>
        <span class="hljs-keyword">if</span> (stompWebSocketHandler.hasSession(msg.getReceiver())) {
            log.debug(<span class="hljs-string">"本地有会话，直接推送, msgId: {}, receiver: {}"</span>, 
                msg.getId(), msg.getReceiver());
            stompWebSocketHandler.sendMessageWithAck(msg);
        } <span class="hljs-keyword">else</span> {
            log.debug(<span class="hljs-string">"本地无会话，忽略, msgId: {}, receiver: {}"</span>,
                msg.getId(), msg.getReceiver());
        }
    }

    <span class="hljs-comment">// 发布到 Redis Topic</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publishClusterEvent</span><span class="hljs-params">(NotifyMessageEvent event)</span> {
        <span class="hljs-type">RTopic</span> <span class="hljs-variable">topic</span> <span class="hljs-operator">=</span> redisson.getTopic(NOTIFY_TOPIC);
        topic.publish(event);
    }

    <span class="hljs-comment">// 启动时订阅 Redis Topic</span>
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">subscribeToTopic</span><span class="hljs-params">()</span> {
        <span class="hljs-type">RTopic</span> <span class="hljs-variable">topic</span> <span class="hljs-operator">=</span> redisson.getTopic(NOTIFY_TOPIC);
        topic.addListener(NotifyMessageEvent.class, 
            (channel, event) -&gt; handlerEvent(event, <span class="hljs-literal">false</span>));  <span class="hljs-comment">// isLocalEvent = false</span>
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-23">4. 消息持久化</h3>
<h4 data-id="heading-24">持久化流程</h4>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────────────────────────┐
│                        NotifyManager.saveAndPublish()               │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  <span class="hljs-variable">@Transactional</span>                                                     │
│  public NotifyMessageLog saveAndPublish(NotifyMessageLog msg) {     │
│         │                                                           │
│         ├─<span class="hljs-operator">&gt;</span> <span class="hljs-number">1.</span> 类型校验                                              │
│         │   NotifyType.valueOf(msg.getType()).checkDataType(data)   │
│         │                                                           │
│         ├─<span class="hljs-operator">&gt;</span> <span class="hljs-number">2.</span> 持久化到数据库                                         │
│         │   notifyMessageLogRepository.save(msg)                    │
│         │   • 自动生成雪花 ID                                         │
│         │   • 自动填充 created<span class="hljs-operator">/</span>lastModified                          │
│         │                                                           │
│         └─<span class="hljs-operator">&gt;</span> <span class="hljs-number">3.</span> 发布事件（触发 WebSocket 推送）                         │
│             SpringContextUtil.publishEvent(<span class="hljs-keyword">new</span> NotifyMessageEvent)  │
│                                                                     │
│  }                                                                  │
└─────────────────────────────────────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        数据库表结构                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> notify_log (                                          │
│      id           <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">PRIMARY</span> KEY,  <span class="hljs-comment">-- 雪花ID，前缀: ntf_     │</span>
│      type         <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,     <span class="hljs-comment">-- 消息类型              │</span>
│      receiver     <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,     <span class="hljs-comment">-- 接收者用户ID          │</span>
│      data         JSON,                     <span class="hljs-comment">-- 消息内容              │</span>
│      viewed       <span class="hljs-type">BOOLEAN</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-literal">FALSE</span>,    <span class="hljs-comment">-- 是否已读              │</span>
│      version      <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,         <span class="hljs-comment">-- 乐观锁版本            │</span>
│      created      <span class="hljs-type">BIGINT</span>,                   <span class="hljs-comment">-- 创建时间戳            │</span>
│      last_modified <span class="hljs-type">BIGINT</span>,                  <span class="hljs-comment">-- 最后修改时间戳         │</span>
│                                                                     │
│      INDEX idx_receiver_viewed_created (receiver, viewed, created)  │
│  );                                                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-25">核心代码</h4>
<p><strong>消息实体</strong> (<code>NotifyMessageLog.java</code>)：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "notify_log", indexes = {
    @Index(columnList = "receiver, viewed, created")
})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotifyMessageLog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Entity</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(generator = "prefixed-id-generator")</span>
    <span class="hljs-meta">@GenericGenerator(name = "prefixed-id-generator",
        parameters = @Parameter(name = "prefix", value = "ntf_"),
        type = CustomizedIdGenerator.class)</span>
    <span class="hljs-keyword">private</span> String id;

    <span class="hljs-meta">@Column(nullable = false)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> NotifyType.STRING_MSG.name();

    <span class="hljs-meta">@Column(nullable = false)</span>
    <span class="hljs-keyword">private</span> String receiver;

    <span class="hljs-meta">@Convert(converter = ObjectToJsonConverter.class)</span>
    <span class="hljs-meta">@JdbcTypeCode(SqlTypes.JSON)</span>
    <span class="hljs-keyword">private</span> Object data;

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">viewed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 转换为 WebSocket 消息格式</span>
    <span class="hljs-keyword">public</span> NotifyMessage <span class="hljs-title function_">convert</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> NotifyMessage.builder()
            .id(getId())
            .type(getType())
            .data(getData())
            .receiver(getReceiver())
            .viewed(isViewed())
            .created(getCreated())  <span class="hljs-comment">// 继承自 Entity 基类</span>
            .build();
    }
}
</code></pre>
<p><strong>历史消息查询</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取用户的历史消息（按创建时间倒序）</span>
<span class="hljs-keyword">public</span> Page&lt;NotifyMessageLog&gt; <span class="hljs-title function_">getHistoryNotifyByCreated</span><span class="hljs-params">(
    String userId, <span class="hljs-type">long</span> created, PageRequest page)</span> {
    <span class="hljs-keyword">return</span> repository.findByReceiverAndCreatedLessThanOrderByCreatedDesc(
        userId, created, page);
}

<span class="hljs-comment">// 标记消息已读</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">markMessagesAsRead</span><span class="hljs-params">(String userId, List&lt;String&gt; ids)</span> {
    repository.updateViewedTrueByReceiverAndIdIn(userId, ids);
    
    <span class="hljs-comment">// 推送已读状态变更通知（同步到其他设备）</span>
    <span class="hljs-type">NotifyMessageLog</span> <span class="hljs-variable">notify</span> <span class="hljs-operator">=</span> NotifyMessageLog.builder()
        .type(NotifyType.NOTIFY_VIEWED.name())
        .data(NotifyType.NotifyUpdateRsp.builder().ids(ids).build())
        .receiver(userId)
        .build();
    publish(notify);  <span class="hljs-comment">// 不持久化，仅推送</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-26">接入指南</h2>
<h3 data-id="heading-27">场景：订单状态变更通知</h3>
<p>以下示例展示如何在你的项目中接入 Quick-Notify，实现订单状态变更的实时推送。</p>
<h4 data-id="heading-28">Step 1：定义消息类型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 定义订单状态消息结构</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderStatusData</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> String orderId;
    <span class="hljs-keyword">private</span> String status;      <span class="hljs-comment">// PAID, SHIPPED, DELIVERED</span>
    <span class="hljs-keyword">private</span> String description;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}

<span class="hljs-comment">// 2. 在 NotifyType 中注册新类型</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">NotifyType</span> {
    STRING_MSG(String.class),
    NOTIFY_VIEWED(NotifyUpdateRsp.class),
    NOTIFY_DELETED(NotifyUpdateRsp.class),
    
    <span class="hljs-comment">// 新增：订单状态通知</span>
    ORDER_STATUS(OrderStatusData.class);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; dataClass;
    
    NotifyType(Class&lt;?&gt; dataClass) {
        <span class="hljs-built_in">this</span>.dataClass = dataClass;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkDataType</span><span class="hljs-params">(Object data)</span> {
        <span class="hljs-keyword">if</span> (data != <span class="hljs-literal">null</span> &amp;&amp; !<span class="hljs-built_in">this</span>.dataClass.isInstance(data)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"数据类型不匹配: "</span> + <span class="hljs-built_in">this</span>.name());
        }
    }
}
</code></pre>
<h4 data-id="heading-29">Step 2：业务代码发送通知</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> NotifyManager notifyManager;

    <span class="hljs-comment">/**
     * 订单状态变更时发送通知
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateOrderStatus</span><span class="hljs-params">(String orderId, String userId, String newStatus)</span> {
        <span class="hljs-comment">// 1. 更新订单状态（你的业务逻辑）</span>
        orderRepository.updateStatus(orderId, newStatus);
        
        <span class="hljs-comment">// 2. 构建通知消息</span>
        <span class="hljs-type">OrderStatusData</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> OrderStatusData.builder()
            .orderId(orderId)
            .status(newStatus)
            .description(getStatusDescription(newStatus))
            .updateTime(LocalDateTime.now())
            .build();
        
        <span class="hljs-type">NotifyMessageLog</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> NotifyMessageLog.builder()
            .receiver(userId)                      <span class="hljs-comment">// 接收者用户ID</span>
            .type(NotifyType.ORDER_STATUS.name())  <span class="hljs-comment">// 消息类型</span>
            .data(data)                            <span class="hljs-comment">// 消息内容</span>
            .viewed(<span class="hljs-literal">false</span>)                         <span class="hljs-comment">// 未读状态</span>
            .build();
        
        <span class="hljs-comment">// 3. 保存并推送（一行代码搞定）</span>
        notifyManager.saveAndPublish(message);
        
        log.info(<span class="hljs-string">"订单状态通知已发送, orderId: {}, userId: {}, status: {}"</span>, 
            orderId, userId, newStatus);
    }
}
</code></pre>
<h4 data-id="heading-30">Step 3：完整消息流转过程</h4>
<pre><code class="hljs language-ini" lang="ini">┌─────────────────────────────────────────────────────────────────────┐
│ 1. 业务调用                                                          │
│    orderService.updateOrderStatus("ORD_001", "user_123", "SHIPPED") │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 2. NotifyManager.saveAndPublish()                                   │
│                                                                     │
│    ┌─────────────────────────────────────────────────────────────┐  │
│    │ 2.1 类型校验                                                 │  │
│    │     NotifyType.ORDER_STATUS.checkDataType(OrderStatusData)  │  │
│    │     ✓ 通过                                                   │  │
│    └─────────────────────────────────────────────────────────────┘  │
│                                    │                                │
│    ┌─────────────────────────────────────────────────────────────┐  │
│    │ 2.2 持久化到数据库                                            │  │
│    │     INSERT INTO notify_log VALUES (                         │  │
│    │       <span class="hljs-attr">id</span> = <span class="hljs-string">'ntf_1234567890'</span>,                                │  │
│    │       <span class="hljs-attr">type</span> = <span class="hljs-string">'ORDER_STATUS'</span>,                                │  │
│    │       <span class="hljs-attr">receiver</span> = <span class="hljs-string">'user_123'</span>,                                │  │
│    │       <span class="hljs-attr">data</span> = <span class="hljs-string">'{"orderId":"ORD_001","status":"SHIPPED",...}'</span>,│  │
│    │       <span class="hljs-attr">viewed</span> = <span class="hljs-literal">false</span>,                                       │  │
│    │       <span class="hljs-attr">created</span> = <span class="hljs-number">1704067200000</span>                               │  │
│    │     )                                                       │  │
│    └─────────────────────────────────────────────────────────────┘  │
│                                    │                                │
│    ┌─────────────────────────────────────────────────────────────┐  │
│    │ 2.3 发布 Spring 事件                                         │  │
│    │     SpringContextUtil.publishEvent(NotifyMessageEvent)      │  │
│    └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 3. StompNotifyEventListener.handler() <span class="hljs-section">[异步执行]</span>                     │
│                                                                     │
│    ┌─────────────────────────────────────────────────────────────┐  │
│    │ 3.1 发布到 Redis Topic                                       │  │
│    │     topic: stomp::ws_notify_topic                           │  │
│    │     payload: NotifyMessageEvent                             │  │
│    └─────────────────────────────────────────────────────────────┘  │
│                                    │                                │
│                     ┌──────────────┴──────────────┐                 │
│                     │ Redis Pub/Sub 广播          │                  │
│                     └──────────────┬──────────────┘                 │
│              ┌─────────────────────┼─────────────────────┐          │
│              ▼                     ▼                     ▼          │
│    ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐  │
│    │ 节点1 收到事件   │   │ 节点2 收到事件   │   │ 节点N 收到事件   │  │
│    │ hasSession?     │   │ hasSession?     │   │ hasSession?     │  │
│    │ ✗ 忽略          │   │ ✓ 有会话        │   │ ✗ 忽略          │  │
│    └─────────────────┘   └────────┬────────┘   └─────────────────┘  │
│                                   │                                 │
└───────────────────────────────────┼─────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 4. StompWebSocketHandler.sendMessageWithAck() <span class="hljs-section">[节点2执行]</span>            │
│                                                                     │
│    用户 user_123 有 2 个在线会话（手机 + 电脑）                          │
│                                                                     │
│    ┌─────────────────────────────────────────────────────────────┐  │
│    │ 4.1 Session 1 (手机)                                         │  │
│    │     • 发送消息到 /user/user_123/queue/msg                     │  │
│    │     • 创建 ACK 记录: ntf_1234567890::sess_mobile             │  │
│    │     • log: <span class="hljs-section">[ACK-REDIS]</span> 消息入队                              │  │
│    └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│    ┌─────────────────────────────────────────────────────────────┐  │
│    │ 4.2 Session 2 (电脑)                                         │  │
│    │     • 发送消息到 /user/user_123/queue/msg                     │  │
│    │     • 创建 ACK 记录: ntf_1234567890::sess_desktop            │  │
│    │     • log: <span class="hljs-section">[ACK-REDIS]</span> 消息入队                              │  │
│    └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 5. 客户端接收并确认                                                    │
│                                                                     │
│    ┌─────────────────────────────────────────────────────────────┐  │
│    │ 5.1 手机端收到消息                                            │  │
│    │     stompClient.subscribe('/user/queue/msg', <span class="hljs-attr">msg</span> =&gt; {       │  │
│    │       // 收到: {id:'ntf_123..', type:'ORDER_STATUS', ...}   │  │
│    │       showToast('您的订单已发货')<span class="hljs-comment">;                            │  │</span>
│    │       stompClient.send('/app/ack', {}, 'ntf_1234567890')<span class="hljs-comment">;   │  │</span>
│    │     })<span class="hljs-comment">;                                                     │  │</span>
│    │                                                             │  │
│    │     服务端: <span class="hljs-section">[ACK-REDIS]</span> 确认成功, msgId ntf_123.., sess_mobile│  │
│    └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│    ┌─────────────────────────────────────────────────────────────┐  │
│    │ 5.2 电脑端收到消息                                            │  │
│    │     // 同样流程...                                           │  │
│    │                                                             │  │
│    │     服务端: <span class="hljs-section">[ACK-REDIS]</span> 确认成功, msgId ntf_123.., sess_desk  │  │
│    └─────────────────────────────────────────────────────────────┘  │
│                                                                     │
│    ✓ 所有 ACK 记录已清理，消息投递完成                                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-31">Step 4：前端处理不同消息类型</h4>
<pre><code class="hljs language-javascript" lang="javascript">stompClient.<span class="hljs-title function_">subscribe</span>(<span class="hljs-string">'/user/queue/msg'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">message</span>) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(message.<span class="hljs-property">body</span>);
    
    <span class="hljs-comment">// 根据消息类型分发处理</span>
    <span class="hljs-keyword">switch</span> (data.<span class="hljs-property">type</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">'ORDER_STATUS'</span>:
            <span class="hljs-title function_">handleOrderStatus</span>(data.<span class="hljs-property">data</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'STRING_MSG'</span>:
            <span class="hljs-title function_">handleStringMessage</span>(data.<span class="hljs-property">data</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">'NOTIFY_VIEWED'</span>:
            <span class="hljs-title function_">handleViewedSync</span>(data.<span class="hljs-property">data</span>.<span class="hljs-property">ids</span>);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-attr">default</span>:
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'未知消息类型:'</span>, data.<span class="hljs-property">type</span>);
    }
    
    <span class="hljs-comment">// 发送 ACK（所有类型都需要）</span>
    stompClient.<span class="hljs-title function_">send</span>(<span class="hljs-string">'/app/ack'</span>, {}, data.<span class="hljs-property">id</span>);
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleOrderStatus</span>(<span class="hljs-params">orderData</span>) {
    <span class="hljs-comment">// orderData = { orderId, status, description, updateTime }</span>
    <span class="hljs-title function_">showNotification</span>({
        <span class="hljs-attr">title</span>: <span class="hljs-string">'订单状态更新'</span>,
        <span class="hljs-attr">body</span>: <span class="hljs-string">`订单 <span class="hljs-subst">${orderData.orderId}</span> <span class="hljs-subst">${orderData.description}</span>`</span>,
        <span class="hljs-attr">icon</span>: <span class="hljs-title function_">getStatusIcon</span>(orderData.<span class="hljs-property">status</span>)
    });
    
    <span class="hljs-comment">// 更新页面上的订单状态</span>
    <span class="hljs-title function_">updateOrderUI</span>(orderData.<span class="hljs-property">orderId</span>, orderData.<span class="hljs-property">status</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-32">API 文档</h2>
<h3 data-id="heading-33">REST API</h3>








































<table><thead><tr><th>方法</th><th>路径</th><th>说明</th></tr></thead><tbody><tr><td>POST</td><td><code>/vh-stomp-wsend/push_all_obj</code></td><td>广播消息</td></tr><tr><td>POST</td><td><code>/vh-stomp-wsend/push_all_obj/{userId}</code></td><td>发送给指定用户</td></tr><tr><td>POST</td><td><code>/vh-stomp-wsend/cluster/notify/{userId}</code></td><td>集群消息（持久化）</td></tr><tr><td>GET</td><td><code>/api/notify/history</code></td><td>获取历史消息</td></tr><tr><td>POST</td><td><code>/api/notify/viewed</code></td><td>标记消息已读</td></tr><tr><td>DELETE</td><td><code>/api/notify/delete</code></td><td>删除消息</td></tr></tbody></table>
<h3 data-id="heading-34">STOMP 路径</h3>






























<table><thead><tr><th>路径</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>/user/queue/msg</code></td><td>订阅</td><td>接收个人消息</td></tr><tr><td><code>/topic/messages</code></td><td>订阅</td><td>接收广播消息</td></tr><tr><td><code>/app/sendMessage</code></td><td>发送</td><td>发送消息到广播</td></tr><tr><td><code>/app/ack</code></td><td>发送</td><td>消息确认</td></tr></tbody></table>
<h3 data-id="heading-35">消息格式</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ntf_1234567890"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ORDER_STATUS"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"receiver"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user_123"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"orderId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ORD_001"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"status"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SHIPPED"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"您的订单已发货"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"updateTime"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-01-01T12:00:00"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"viewed"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"created"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1704067200000</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-36">常见问题</h2>
<h3 data-id="heading-37">Q: 客户端收到重复消息怎么办？</h3>
<p>由于 ACK 重试机制，网络波动时可能收到重复消息。客户端应基于消息 ID 实现幂等处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> processedIds = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleMessage</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-keyword">if</span> (processedIds.<span class="hljs-title function_">has</span>(data.<span class="hljs-property">id</span>)) {
        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 跳过重复消息</span>
    }
    processedIds.<span class="hljs-title function_">add</span>(data.<span class="hljs-property">id</span>);
    <span class="hljs-comment">// 处理消息...</span>
}
</code></pre>
<h3 data-id="heading-38">Q: 如何扩展消息类型？</h3>
<p>参考上面「接入指南」的 Step 1，在 <code>NotifyType</code> 枚举中添加新类型即可。</p>
<h3 data-id="heading-39">Q: 消息发送失败如何处理？</h3>
<p><code>saveAndPublish</code> 方法是事务性的，如果数据库保存失败会自动回滚。如果需要自定义错误处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> {
    notifyManager.saveAndPublish(message);
} <span class="hljs-keyword">catch</span> (Exception e) {
    log.error(<span class="hljs-string">"消息发送失败"</span>, e);
    <span class="hljs-comment">// 记录失败日志或加入重试队列</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue2（三）——模板语法]]></title>    <link>https://juejin.cn/post/7601053058856353798</link>    <guid>https://juejin.cn/post/7601053058856353798</guid>    <pubDate>2026-01-31T09:18:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601053058856353798" data-draft-id="7601034810312622134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue2（三）——模板语法"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-31T09:18:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神魔皆以血饲"/> <meta itemprop="url" content="https://juejin.cn/user/2432580855018542"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue2（三）——模板语法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2432580855018542/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神魔皆以血饲
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T09:18:29.000Z" title="Sat Jan 31 2026 09:18:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.cn.vuejs.org%2Fv2%2Fguide%2Fsyntax.html" target="_blank" title="https://v2.cn.vuejs.org/v2/guide/syntax.html" ref="nofollow noopener noreferrer">v2.cn.vuejs.org/v2/guide/sy…</a></p>
<blockquote>
<p>Vue.js 使用了基于 HTML 的模板语法，允许开发者声明式地将 DOM 绑定至底层 Vue 实例的数据。所有 Vue.js 的模板都是合法的 HTML，所以能被遵循规范的浏览器和 HTML 解析器解析。</p>
<p>在底层的实现上，Vue 将模板编译成虚拟 DOM 渲染函数。结合响应系统，Vue 能够智能地计算出最少需要重新渲染多少组件，并把 DOM 操作次数减到最少。</p>
<p>如果你熟悉虚拟 DOM 并且偏爱 JavaScript 的原始力量，你也可以不用模板，<a href="https://link.juejin.cn?target=https%3A%2F%2Fv2.cn.vuejs.org%2Fv2%2Fguide%2Frender-function.html" target="_blank" title="https://v2.cn.vuejs.org/v2/guide/render-function.html" ref="nofollow noopener noreferrer">直接写渲染 (render) 函数</a>，使用可选的 JSX 语法。</p>
</blockquote>
<hr/>
<p>上面这段原封不动，来自官方，我比较菜，看不懂，下面AI的分析</p>
<h3 data-id="heading-0">第一层：写什么？—— 声明式模板 (Declarative Templates)</h3>
<p><strong>原文：</strong> “Vue.js 使用了基于 HTML 的模板语法... 声明式地将 DOM 绑定至数据... 所有模板都是合法的 HTML。”</p>
<p>这讲的是 Vue 的**“门面”**。</p>
<ol>
<li><strong>声明式 (Declarative) vs 命令式 (Imperative)：</strong></li>
</ol>
<ul>
<li>
<ul>
<li><strong>命令式（如 jQuery）：</strong> 你需要一步步告诉浏览器怎么做（“找到 id 为 app 的 div，清空内容，插入一个 span，设置 span 的文字...”）。</li>
<li><strong>声明式（Vue）：</strong> 你只告诉 Vue <strong>你想要什么结果</strong>（“这里要显示 <code>{{ message }}</code>”），具体的脏活累活（DOM 操作）交给 Vue 去处理。</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>基于 HTML：</strong></li>
</ol>
<ul>
<li>
<ul>
<li>这大大降低了学习门槛。设计师或后端开发人员也能看懂 Vue 代码，因为它长得就像普通的 HTML。</li>
<li>这也意味着现有的 HTML 解析器都能处理它，不会像某些非标语法那样导致编辑器报错。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-1">第二层：怎么变？—— 编译与虚拟 DOM (Compilation &amp; VDOM)</h3>
<p><strong>原文：</strong> “在底层的实现上，Vue 将模板编译成虚拟 DOM 渲染函数。”</p>
<p>这讲的是 Vue 的**“转换过程”**。浏览器其实看不懂 <code>v-if</code> 或 <code>{{ }}</code>，所以 Vue 在代码运行前（或运行时）做了一次“翻译”。</p>
<ol>
<li><strong>编译 (Compile)：</strong></li>
</ol>
<p>Vue 有一个编译器，它会把你的 HTML 模板字符串“翻译”成一段 JavaScript 代码。这段代码就叫 <strong>渲染函数 (Render Function)</strong> 。</p>
<ol start="2">
<li><strong>虚拟 DOM (Virtual DOM)：</strong></li>
</ol>
<p>渲染函数执行后，不会直接去动真的 DOM（因为操作真 DOM 很慢），而是生成一个 <strong>JavaScript 对象树</strong>，这个对象树就是虚拟 DOM。它就像是真实 DOM 的一份“轻量级蓝图”。</p>
<p><strong>举个例子：</strong></p>
<ul>
<li><strong>你的模板：</strong></li>
</ul>
<p>HTML</p>
<pre><code class="hljs language-ruby" lang="ruby">&lt;div <span class="hljs-symbol">:id=<span class="hljs-string">"dynamicId"</span>&gt;Hello&lt;/div&gt;</span>
</code></pre>
<ul>
<li><strong>Vue 编译后的渲染函数 (伪代码)：</strong></li>
</ul>
<p>JavaScript</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">function <span class="hljs-title">render</span>()</span> {
  <span class="hljs-keyword">return</span> h(<span class="hljs-string">'div'</span>, { id: <span class="hljs-keyword">this</span>.dynamicId }, <span class="hljs-string">'Hello'</span>)
}
</code></pre>
<hr/>
<h3 data-id="heading-2">第三层：怎么跑？—— 响应式与智能更新 (Reactivity &amp; Diffing)</h3>
<p><strong>原文：</strong> “结合响应系统，Vue 能够智能地计算出... 把 DOM 操作次数减到最少。”</p>
<p>这讲的是 Vue 的**“超能力”**。</p>
<ol>
<li><strong>响应系统 (Reactivity)：</strong></li>
</ol>
<p>Vue 会“监视”你的数据。当数据变化时，它不仅知道数据变了，还精确地知道<strong>哪个组件</strong>依赖了这个数据。</p>
<ol start="2">
<li><strong>Diff 算法 (最小化更新)：</strong></li>
</ol>
<p>当数据变化，渲染函数会重新执行，生成<strong>新的</strong>虚拟 DOM 树。</p>
<p>Vue 会拿着 <strong>新树</strong> 和 <strong>旧树</strong> 做对比（Diff）。</p>
<ul>
<li>
<ul>
<li>Vue 发现： <em>“哦，只有这个</em> <code>div</code> <em>的</em> <code>class</code> <em>变了，其他都没变。”</em></li>
<li>结果：Vue 只去更新真实 DOM 里那个 <code>div</code> 的 <code>class</code>，其他不动。</li>
</ul>
</li>
</ul>
<p>这就是为什么 Vue 即使在处理庞大页面时依然很快的原因。</p>
<hr/>
<h3 data-id="heading-3">第四层：给高手的“后门” —— Render 函数 &amp; JSX</h3>
<p><strong>原文：</strong> “如果你熟悉虚拟 DOM 并且偏爱 JavaScript 的原始力量... 直接写渲染 (render) 函数...”</p>
<p>这段话是说，模板虽然好用，但有时候不够灵活。</p>
<ul>
<li><strong>模板的局限：</strong> 比如你要写一个组件，根据 props 动态生成 <code>h1</code> 到 <code>h6</code> 标签。用模板写，你可能得写 6 个 <code>v-if</code>。</li>
<li><strong>JS 的力量：</strong> 如果用渲染函数，你只需要写一行 JS：<code>return h('h' + this.level, ...)</code>。</li>
</ul>
<p>Vue 并不强迫你用模板，它完全支持你像 React 那样写代码（JSX），这给了高级开发者极大的灵活性。</p>
<h3 data-id="heading-4">总结分析</h3>
<p>这段话其实揭示了 Vue 的<strong>架构分层</strong>：</p>






























<table><thead><tr><th><strong>层次</strong></th><th><strong>作用</strong></th><th><strong>对应原文</strong></th></tr></thead><tbody><tr><td><strong>顶层 (API)</strong></td><td><strong>易用性</strong></td><td>基于 HTML 的模板，声明式绑定</td></tr><tr><td><strong>中间层 (Compiler)</strong></td><td><strong>转化</strong></td><td>模板 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 渲染函数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">→</span></span></span></span></span> 虚拟 DOM</td></tr><tr><td><strong>底层 (Engine)</strong></td><td><strong>性能</strong></td><td>响应式系统 + 智能 Diff 计算</td></tr><tr><td><strong>扩展层 (Flexibility)</strong></td><td><strong>灵活性</strong></td><td>可选 JSX / Render 函数</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-5">插值</h2>
<h3 data-id="heading-6">文本</h3>
<p>双大括号 Mustache</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">span</span>&gt;Message: {{ msg }}&lt;/<span class="hljs-selector-tag">span</span>&gt;
</code></pre>
<p>Mustache 标签将会被替代为对应数据对象上 <code>msg</code> property 的值。无论何时，绑定的数据对象上 <code>msg</code> property 发生了改变，插值处的内容都会更新。</p>
<p>可以使用v-once ,只执行一次插值，后面值变化不会更新</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">span</span> v-once&gt;这个将不会改变: {{ msg }}&lt;/<span class="hljs-selector-tag">span</span>&gt;
</code></pre>
<h3 data-id="heading-7">原始HTML</h3>
<p>v-html</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Using mustaches: {{ rawHtml }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Using v-html directive: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-html</span>=<span class="hljs-string">"rawHtml"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
</code></pre>
<p>整个span 的内容 会被替换成 property 值 <code>rawHtml</code>直接作为 HTML</p>
<p>注意：XSS 攻击，并且只支持常规html，不支持解析自定义组件</p>
<h3 data-id="heading-8">Attribute</h3>
<p>v-bind 执行 绑定 Attribute</p>
<pre><code class="hljs language-bash" lang="bash">&lt;div v-bind:<span class="hljs-built_in">id</span>=<span class="hljs-string">"dynamicId"</span>&gt;&lt;/div&gt;
</code></pre>
<p><strong>注意与 HTML的不同 (</strong> <a href="https://juejin.cn/post/7598447519823101993" target="_blank" title="https://juejin.cn/post/7598447519823101993"><strong>https://juejin.cn/post/7598447519823101993</strong></a> <strong>里面的布尔属性提到了)</strong></p>
<p>对于布尔 attribute (它们只要存在就意味着值为 <code>true</code>)，<code>v-bind</code> 有不同，在这个例子中：</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">button</span> v-bind<span class="hljs-selector-pseudo">:disabled</span>="isButtonDisabled"&gt;<span class="hljs-selector-tag">Button</span>&lt;/<span class="hljs-selector-tag">button</span>&gt;
</code></pre>
<p>如果 <code>isButtonDisabled</code> 的值是 <code>null</code>、<code>undefined</code> 或 <code>false</code>，则 <code>disabled</code> attribute 甚至不会被包含在渲染出来的 <code>&lt;button&gt;</code> 元素中。</p>
<h3 data-id="heading-9">使用 JavaScript 表达式</h3>
<p>插值模板还支持三目运算符和数学表达式，以及库函数操作</p>
<pre><code class="hljs language-bash" lang="bash">{{ number + 1 }}

{{ ok ? <span class="hljs-string">'YES'</span> : <span class="hljs-string">'NO'</span> }}

{{ message.split(<span class="hljs-string">''</span>).reverse().<span class="hljs-built_in">join</span>(<span class="hljs-string">''</span>) }}

&lt;div v-bind:<span class="hljs-built_in">id</span>=<span class="hljs-string">"'list-' + id"</span>&gt;&lt;/div&gt;
</code></pre>
<p>错误例子</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 这是语句，不是表达式 --&gt;</span>
{{ var a = 1 }}

<span class="hljs-comment">&lt;!-- 流控制也不会生效，请使用三元表达式 --&gt;</span>
{{ if (ok) { return message } }}
</code></pre>
<p>模板表达式都被放在沙盒中，只能访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fvue%2Fblob%2Fv2.6.10%2Fsrc%2Fcore%2Finstance%2Fproxy.js%23L9" target="_blank" title="https://github.com/vuejs/vue/blob/v2.6.10/src/core/instance/proxy.js#L9" ref="nofollow noopener noreferrer">全局变量的一个白名单</a>，如 <code>Math</code> 和 <code>Date</code> 。你不应该在模板表达式中试图访问用户定义的全局变量。</p>
<p>大白话就是指定访问 new Vue({}) 时传入的对象里面的 data,methods computed等，以及库函数，外部定义的变量，只要没传入 new Vue({}) 里面就不能访问</p>
<h2 data-id="heading-10">指令</h2>
<p>指令 (Directives) 是带有 <code>v-</code> 前缀的特殊 attribute。</p>
<p>指令 attribute 的值预期是<strong>单个 JavaScript 表达式</strong> (<code>v-for</code> 是例外情况，稍后我们再讨论)。</p>
<p>当表达式的值改变时，将影响DOM</p>
<p>即 Model 影响 -&gt; DOM</p>
<pre><code class="hljs language-ini" lang="ini">&lt;p <span class="hljs-attr">v-if</span>=<span class="hljs-string">"seen"</span>&gt;现在你看到我了&lt;/p&gt;
</code></pre>
<p><code>v-if</code> 指令将根据表达式 <code>seen</code> 的值的真假来插入/移除 <code>&lt;p&gt;</code> 元素</p>
<h3 data-id="heading-11">参数</h3>
<p>一些指令能够接收一个“参数”，在指令名称之后以冒号表示。</p>
<p>例如，<code>v-bind</code> 指令可以用于响应式地更新 HTML attribute：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;a v-bind:<span class="hljs-attr">href</span>=<span class="hljs-string">"url"</span>&gt;...&lt;/a&gt;
</code></pre>
<p>在这里 <code>href</code> 是参数，告知 <code>v-bind</code> 指令将该元素的 <code>href</code> attribute 与表达式 <code>url</code> 的值绑定。</p>
<p>另一个例子是 <code>v-on</code> 指令，它用于监听 DOM 事件：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;a v-on:<span class="hljs-attr">click</span>=<span class="hljs-string">"doSomething"</span>&gt;...&lt;/a&gt;
</code></pre>
<p>在这里参数是监听的事件名。我们也会更详细地讨论事件处理。</p>
<h3 data-id="heading-12">动态参数</h3>
<p>用方括号括起来的 JavaScript 表达式作为一个指令的参数：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!--
注意，参数表达式的写法存在一些约束，如之后的“对动态参数表达式的约束”章节所述。
--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">v-bind:</span>[<span class="hljs-attr">attributeName</span>]=<span class="hljs-string">"url"</span>&gt;</span> ... <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>
<p>这里的 <code>attributeName</code> 会被作为一个 JavaScript 表达式进行动态求值，求得的值将会作为最终的参数来使用。例如，如果你的 Vue 实例有一个 <code>data</code> property <code>attributeName</code>，其值为 <code>"href"</code>，那么这个绑定将等价于 <code>v-bind:href</code>。</p>
<p>使用动态参数为一个动态的事件名绑定处理函数：</p>
<pre><code class="hljs language-less" lang="less">&lt;<span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">v-on</span>:<span class="hljs-selector-attr">[eventName]</span>="<span class="hljs-selector-tag">doSomething</span>"&gt; ... &lt;/<span class="hljs-selector-tag">a</span>&gt;
</code></pre>
<p>在这个示例中，当 <code>eventName</code> 的值为 <code>"focus"</code> 时，<code>v-on:[eventName]</code> 将等价于 <code>v-on:focus</code>。</p>
<p>动态参数值的约束</p>
<ul>
<li>预期是求出一个字符串</li>
<li>异常情况为null，null表示移除该绑定</li>
<li>动态参数表达式有一些语法约束，因为某些字符，如空格和引号，放在 HTML attribute 名里是无效的。</li>
</ul>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 这会触发一个编译警告 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">v-bind:</span>['<span class="hljs-attr">foo</span>' + <span class="hljs-attr">bar</span>]=<span class="hljs-string">"value"</span>&gt;</span> ... <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>
<p>使用没有空格或引号的表达式，或者计算属性替代。</p>
<p>在 DOM 中使用模板时 (直接在一个 HTML 文件里撰写模板)，还需要避免使用大写字符来命名键名，因为浏览器会把 attribute 名全部强制转为小写：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!--
在 DOM 中使用模板时这段代码会被转换为 `v-bind:[someattr]`。
除非在实例中有一个名为“someattr”的 property，否则代码不会工作。
--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">v-bind:</span>[<span class="hljs-attr">someAttr</span>]=<span class="hljs-string">"value"</span>&gt;</span> ... <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>
<p>例子如下</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 开发环境版本，包含了有帮助的命令行警告 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">v-bind:</span>[<span class="hljs-attr">someAttr</span>]=<span class="hljs-string">"value"</span>&gt;</span>掘金<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">var</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
      <span class="hljs-attr">el</span>: <span class="hljs-string">"#app"</span>,
      <span class="hljs-attr">data</span>: {
        <span class="hljs-attr">value</span>: <span class="hljs-string">"https://https://juejin.cn/"</span>,
        <span class="hljs-attr">someAttr</span>: <span class="hljs-string">"href"</span>,
      },
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/694b4e907bc14c3793c167bfadd5bebf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We6a2U55qG5Lul6KGA6aWy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770455909&amp;x-signature=%2BIjFJCU4jJGIdVSN6QUb1ur1WQk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/caeec377800546dd906e304383d5243c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We6a2U55qG5Lul6KGA6aWy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770455909&amp;x-signature=QimeV3uxHmPgboyQgw6vIwAfMIs%3D" alt="" loading="lazy"/></p>
<p>修改之后的代码</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!doctype <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 开发环境版本，包含了有帮助的命令行警告 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">v-bind:</span>[<span class="hljs-attr">someAttr</span>]=<span class="hljs-string">"value"</span>&gt;</span>掘金<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">var</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
      <span class="hljs-attr">el</span>: <span class="hljs-string">"#app"</span>,
      <span class="hljs-attr">data</span>: {
        <span class="hljs-attr">value</span>: <span class="hljs-string">"https://https://juejin.cn/"</span>,
        <span class="hljs-attr">someattr</span>: <span class="hljs-string">"href"</span>,
      },
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a660c541193745048750d58ade857963~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We6a2U55qG5Lul6KGA6aWy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770455909&amp;x-signature=Mor6%2BQGbCHlh7nINR7RIU3I4K9A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da14149a696149cdb037a7dd1127f933~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56We6a2U55qG5Lul6KGA6aWy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770455909&amp;x-signature=2IiiQ8aa%2Bh4aC8q7dvuTEa%2FDMM0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">修饰符</h3>
<p>修饰符 (modifier) 是以半角句号 <code>.</code> 指明的特殊后缀</p>
<p>可以用于阻止事件冒泡或者阻止表单提交</p>
<p>例如，<code>.prevent</code> 修饰符告诉 <code>v-on</code> 指令对于触发的事件调用 <code>event.preventDefault()</code>：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;form v-on:<span class="hljs-attr">submit.prevent</span>=<span class="hljs-string">"onSubmit"</span>&gt;...&lt;/form&gt;
</code></pre>
<h2 data-id="heading-14">缩写</h2>
<p>缩写不是必须的</p>
<p><code>v-bind</code> 缩写</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 完整语法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">v-bind:href</span>=<span class="hljs-string">"url"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 缩写 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">:href</span>=<span class="hljs-string">"url"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 动态参数的缩写 (2.6.0+) --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">:</span>[<span class="hljs-attr">key</span>]=<span class="hljs-string">"url"</span>&gt;</span> ... <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>
<p><code>v-on</code> 缩写</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 完整语法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">v-on:click</span>=<span class="hljs-string">"doSomething"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 缩写 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"doSomething"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 动态参数的缩写 (2.6.0+) --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> @[<span class="hljs-attr">event</span>]=<span class="hljs-string">"doSomething"</span>&gt;</span> ... <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nest 的中间件 Middleware ？]]></title>    <link>https://juejin.cn/post/7601077290681270324</link>    <guid>https://juejin.cn/post/7601077290681270324</guid>    <pubDate>2026-01-31T09:30:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601077290681270324" data-draft-id="7599294170001522739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nest 的中间件 Middleware ？"/> <meta itemprop="keywords" content="前端,NestJS,Node.js"/> <meta itemprop="datePublished" content="2026-01-31T09:30:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端付豪"/> <meta itemprop="url" content="https://juejin.cn/user/1741228277763278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nest 的中间件 Middleware ？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1741228277763278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端付豪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T09:30:20.000Z" title="Sat Jan 31 2026 09:30:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>新建项目</p>
<pre><code class="hljs language-arduino" lang="arduino">nest <span class="hljs-keyword">new</span> middleware-demo
</code></pre>
<p>创建一个中间件</p>
<pre><code class="hljs language-css" lang="css">nest g middleware aaa <span class="hljs-attr">--no-spec</span> <span class="hljs-attr">--flat</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d34d6af1693d40dd9ca58869196c7449~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770456624&amp;x-signature=DFqonXwuwIicr77aUbXIm%2B9vR%2Bs%3D" alt="image.png" loading="lazy"/></p>
<p>加下打印</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestMiddleware</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Request</span>, <span class="hljs-title class_">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AaaMiddleware</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestMiddleware</span> {
  <span class="hljs-title function_">use</span>(<span class="hljs-params">req: Request, res: Response, next: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'brefore'</span>);
    <span class="hljs-title function_">next</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'after'</span>);
  }
}

</code></pre>
<p>在 Module 里这样使用</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MiddlewareConsumer</span>, <span class="hljs-title class_">Module</span>, <span class="hljs-title class_">NestModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.controller'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AaaMiddleware</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./aaa.middleware'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [],
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AppController</span>],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AppService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestModule</span> {
  <span class="hljs-title function_">configure</span>(<span class="hljs-params">consumer: MiddlewareConsumer</span>) {
    consumer.<span class="hljs-title function_">apply</span>(<span class="hljs-title class_">AaaMiddleware</span>).<span class="hljs-title function_">forRoutes</span>(<span class="hljs-string">'*'</span>);
  }
}

</code></pre>
<p>跑起来看看</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0233610b6205421ba3f9eb7dad0931df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770456624&amp;x-signature=W6aefhfB%2FmI4KLP4FhiWWr5TvIg%3D" alt="image.png" loading="lazy"/></p>
<p>可以指定更精确的路由，添加几个 handler</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> { Controller, Get } from <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { AppService } from <span class="hljs-string">'./app.service'</span>;

<span class="hljs-meta">@Controller()</span>
export <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppController</span> {
  <span class="hljs-keyword">constructor</span>(<span class="hljs-keyword">private</span> readonly appService: AppService) {}

  <span class="hljs-meta">@Get(<span class="hljs-string">'hello'</span>)</span>
  getHello(): string {
    console.log(<span class="hljs-string">'hello'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.appService.getHello();
  }

  <span class="hljs-meta">@Get(<span class="hljs-string">'hello2'</span>)</span>
  getHello2(): string {
    console.log(<span class="hljs-string">'hello2'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.appService.getHello();
  }

  <span class="hljs-meta">@Get(<span class="hljs-string">'hi'</span>)</span>
  getHi(): string {
    console.log(<span class="hljs-string">'hi'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.appService.getHello();
  }

  <span class="hljs-meta">@Get(<span class="hljs-string">'hi1'</span>)</span>
  getHi1(): string {
    console.log(<span class="hljs-string">'hi1'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.appService.getHello();
  }
}

</code></pre>
<p>module 匹配更新下</p>
<pre><code class="hljs language-php" lang="php">import { AaaMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">'./aaa.middleware'</span>;
import {
  MiddlewareConsumer,
  Module,
  NestModule,
  RequestMethod,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
import { AppController } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.controller'</span>;
import { AppService } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;

@<span class="hljs-title function_ invoke__">Module</span>({
  <span class="hljs-attr">imports</span>: [],
  <span class="hljs-attr">controllers</span>: [AppController],
  <span class="hljs-attr">providers</span>: [AppService],
})
export <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppModule</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">NestModule</span> </span>{
  <span class="hljs-title function_ invoke__">configure</span>(<span class="hljs-attr">consumer</span>: MiddlewareConsumer) {
    consumer
      .<span class="hljs-title function_ invoke__">apply</span>(AaaMiddleware)
      .<span class="hljs-title function_ invoke__">forRoutes</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'hello/*path'</span>, <span class="hljs-attr">method</span>: RequestMethod.GET });
    consumer
      .<span class="hljs-title function_ invoke__">apply</span>(AaaMiddleware)
      .<span class="hljs-title function_ invoke__">forRoutes</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'hi1'</span>, <span class="hljs-attr">method</span>: RequestMethod.GET });
  }
}

</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bdeabc99286a4a0e87fea84cff3eb5e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770456624&amp;x-signature=N2fiakfYO%2BPJd5RQIMZccKLQUKI%3D" alt="image.png" loading="lazy"/></p>
<p>Nest 为什么要把 Middleware 做成 class 呢？</p>
<p>为了依赖注入！</p>
<p>通过 @Inject 注入 AppService 到 middleware 里</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Inject</span>, <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestMiddleware</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Request</span>, <span class="hljs-title class_">Response</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AaaMiddleware</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestMiddleware</span> {
  <span class="hljs-meta">@Inject</span>(<span class="hljs-title class_">AppService</span>)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">appService</span>: <span class="hljs-title class_">AppService</span>;

  <span class="hljs-title function_">use</span>(<span class="hljs-params">req: Request, res: Response, next: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'brefore'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'-------'</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">appService</span>.<span class="hljs-title function_">getHello</span>());
    <span class="hljs-title function_">next</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'after'</span>);
  }
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d810b764ecec470abd59be46a3173d9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5LuY6LGq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770456624&amp;x-signature=RHzpA5634p%2BIR%2BMyZcN8MrjcwBY%3D" alt="image.png" loading="lazy"/></p>
<p>这就是 Nest 注入的依赖</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[VertexID节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7601041482892329010</link>    <guid>https://juejin.cn/post/7601041482892329010</guid>    <pubDate>2026-01-31T09:51:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601041482892329010" data-draft-id="7601044684774195238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[VertexID节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2026-01-31T09:51:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[VertexID节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T09:51:35.000Z" title="Sat Jan 31 2026 09:51:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<p>在Unity的可编程渲染管线中，Shader Graph为开发者提供了可视化编写着色器的能力，而Vertex ID节点则是其中一个功能强大但常被忽视的重要工具。Vertex ID节点允许着色器访问当前处理的顶点或片元的唯一标识符，为各种高级渲染技术提供了基础支持。</p>
<h2 data-id="heading-0">Vertex ID节点概述</h2>
<p><img src="https://docs.unity.cn/cn/Packages-cn/com.unity.shadergraph@14.0/manual/images/VertexIDNodeThumb.png" alt="" loading="lazy"/></p>
<p>Vertex ID节点的核心功能是输出当前正在处理的顶点或片元在网格中的索引值。这个索引值从0开始，按照网格顶点缓冲区的顺序递增。在顶点着色器阶段，它代表顶点的索引；在片元着色器阶段，它代表生成该片元的顶点的索引。</p>
<h3 data-id="heading-1">工作原理与底层机制</h3>
<p>Vertex ID的实现依赖于GPU的顶点着色器输入语义。在HLSL中，这通常对应着<code>SV_VertexID</code>系统值语义。当Unity提交绘制调用时，GPU会为每个处理的顶点分配一个唯一的ID，这个ID基于顶点在顶点缓冲区中的位置。</p>
<p>在传统的编写着色器代码方式中，开发者会这样声明和使用Vertex ID：</p>
<pre><code class="hljs language-c" lang="c">HLSL

truct appdata
{
    uint vertexID : SV_VertexID;
};
</code></pre>
<p>而在Shader Graph中，这个过程被简化为简单地添加和连接Vertex ID节点，大大降低了使用门槛。</p>
<h3 data-id="heading-2">节点特性与限制</h3>
<p>Vertex ID节点有几个重要特性需要注意：</p>
<ul>
<li>输出值为浮点数类型，范围从0到网格顶点数减1</li>
<li>在顶点着色器和片元着色器中均可使用</li>
<li>值在单个绘制调用中保持唯一性和连续性</li>
<li>不受网格变形或动画影响，始终反映原始网格的顶点顺序</li>
</ul>
<p>同时也有一些使用限制：</p>
<ul>
<li>不能用于计算着色器</li>
<li>在某些移动设备上可能有限制或性能考虑</li>
<li>对于动态批处理的物体，Vertex ID可能不会按预期工作</li>
</ul>
<h2 data-id="heading-3">Vertex ID节点的应用场景</h2>
<p>Vertex ID节点在Shader Graph中有着广泛的应用场景，从简单的效果到复杂的渲染技术都能发挥作用。</p>
<h3 data-id="heading-4">顶点级动画与变形</h3>
<p>利用Vertex ID可以实现基于顶点索引的动画效果，比如波浪效果、随机偏移等。由于每个顶点都有唯一的ID，可以基于ID计算不同的变换参数。</p>
<pre><code class="hljs language-c" lang="c">HLSL

<span class="hljs-comment">// 伪代码示例：基于Vertex ID的波浪动画</span>
<span class="hljs-type">float</span> wave = <span class="hljs-built_in">sin</span>(_Time.y * _WaveSpeed + vertexID * _WaveDensity);
float3 offset = float3(<span class="hljs-number">0</span>, wave * _WaveHeight, <span class="hljs-number">0</span>);
position.xyz += offset;
</code></pre>
<h3 data-id="heading-5">程序化纹理坐标生成</h3>
<p>当网格缺乏合适的UV坐标时，可以使用Vertex ID来生成程序化的纹理映射。这在处理程序化生成的几何体时特别有用。</p>
<pre><code class="hljs language-c" lang="c">HLSL

<span class="hljs-comment">// 伪代码示例：基于Vertex ID生成UV</span>
float2 uv = float2(frac(vertexID * _UVScale), <span class="hljs-built_in">floor</span>(vertexID * _UVScale) / _GridSize);
</code></pre>
<h3 data-id="heading-6">实例化与批量渲染优化</h3>
<p>在GPU实例化场景中，Vertex ID可以与其他系统值（如Instance ID）结合使用，实现高效的批量渲染和数据索引。</p>
<h3 data-id="heading-7">调试与可视化工具</h3>
<p>Vertex ID是强大的调试工具，可以用于：</p>
<ul>
<li>可视化顶点分布和顺序</li>
<li>检测顶点缓冲区问题</li>
<li>理解网格拓扑结构</li>
</ul>
<h2 data-id="heading-8">实际应用示例</h2>
<p>下面通过几个具体的Shader Graph设置示例，展示Vertex ID节点的实际应用。</p>
<h3 data-id="heading-9">波浪地形效果</h3>
<p>创建一个基于Vertex ID的波浪地形效果：</p>
<ul>
<li>首先在Shader Graph中创建Vertex ID节点</li>
<li>将输出连接到Custom Function节点进行波浪计算</li>
<li>使用Time节点提供动画参数</li>
<li>将计算结果连接到Position节点的偏移量</li>
</ul>
<p>关键节点设置：</p>
<ul>
<li>Vertex ID → Custom Function (波浪计算) → Add to Position</li>
<li>Time → Multiply (控制速度) → Custom Function</li>
<li>参数输入：波浪幅度、频率、传播速度</li>
</ul>
<p>这种设置可以实现流畅的波浪动画，每个顶点基于其ID产生相位偏移，形成自然的波浪传播效果。</p>
<h3 data-id="heading-10">顶点颜色渐变</h3>
<p>使用Vertex ID创建沿着顶点顺序的颜色渐变：</p>
<ul>
<li>Vertex ID节点输出除以网格顶点总数，归一化到[0,1]范围</li>
<li>将归一化值输入到Gradient节点</li>
<li>将Gradient输出连接到Base Color</li>
</ul>
<p>这种方法特别适合线框渲染或几何可视化，可以清晰展示顶点的顺序和分布。</p>
<h3 data-id="heading-11">程序化网格变形</h3>
<p>结合Vertex ID和数学节点创建复杂的网格变形：</p>
<ul>
<li>使用Vertex ID作为噪声函数的输入种子</li>
<li>通过不同的数学运算（sin、cos、fract等）创建各种变形模式</li>
<li>将变形结果应用到顶点位置</li>
</ul>
<p>这种技术可以创建有机的、程序化的形状变化，无需额外的纹理或顶点数据。</p>
<h2 data-id="heading-12">性能优化与最佳实践</h2>
<p>正确使用Vertex ID节点需要考虑性能因素和最佳实践。</p>
<h3 data-id="heading-13">性能考虑</h3>
<ul>
<li>在移动平台上，尽量减少基于Vertex ID的复杂计算</li>
<li>避免在片元着色器中使用Vertex ID进行每帧重计算</li>
<li>考虑使用顶点着色器计算并将结果传递给片元着色器</li>
</ul>
<h3 data-id="heading-14">兼容性处理</h3>
<ul>
<li>使用Shader Graph的节点功能检查目标平台的兼容性</li>
<li>为不支持Vertex ID的平台提供fallback方案</li>
<li>测试在不同图形API下的行为一致性</li>
</ul>
<h3 data-id="heading-15">调试技巧</h3>
<ul>
<li>使用Vertex ID可视化来理解网格结构</li>
<li>结合RenderDoc等工具分析实际的Vertex ID分布</li>
<li>创建调试着色器来验证Vertex ID的预期行为</li>
</ul>
<h2 data-id="heading-16">高级应用技巧</h2>
<h3 data-id="heading-17">与其他系统值的结合</h3>
<p>Vertex ID可以与其他系统值结合使用，创造更复杂的效果：</p>
<ul>
<li>结合Instance ID实现每实例的顶点变形</li>
<li>与Primitive ID配合实现基于图元的特效</li>
<li>和Screen Position结合创建屏幕相关的顶点动画</li>
</ul>
<h3 data-id="heading-18">自定义函数封装</h3>
<p>对于复杂的Vertex ID应用，可以创建自定义HLSL函数节点：</p>
<pre><code class="hljs language-c" lang="c">HLSL

<span class="hljs-type">void</span> <span class="hljs-title function_">VertexIDAnimation_float</span><span class="hljs-params">(<span class="hljs-type">float</span> VertexID, <span class="hljs-type">float</span> Time, <span class="hljs-type">float</span> Amplitude, <span class="hljs-type">float</span> Frequency, out float3 Offset)</span>
{
    <span class="hljs-type">float</span> phase = VertexID * Frequency + Time;
    Offset = float3(<span class="hljs-number">0</span>, <span class="hljs-built_in">sin</span>(phase) * Amplitude, <span class="hljs-number">0</span>);
}
</code></pre>
<p>这样可以在多个Shader Graph中重用复杂的Vertex ID逻辑。</p>
<h3 data-id="heading-19">数据驱动的方法</h3>
<p>将Vertex ID与外部数据结合：</p>
<ul>
<li>使用Compute Buffer存储每顶点的动画参数</li>
<li>通过MaterialPropertyBlock传递顶点级别的数据</li>
<li>结合Scriptable Renderer Features实现更高级的渲染管线集成</li>
</ul>
<h2 data-id="heading-20">故障排除与常见问题</h2>
<h3 data-id="heading-21">Vertex ID输出异常</h3>
<p>当Vertex ID不按预期工作时，可能的原因包括：</p>
<ul>
<li>网格被动态批处理，改变了顶点顺序</li>
<li>使用了不支持的渲染路径</li>
<li>图形API限制</li>
</ul>
<p>解决方案：</p>
<ul>
<li>禁用动态批处理</li>
<li>检查目标平台的图形API支持</li>
<li>使用Shader Variant收集器确保所有需要的变体都被编译</li>
</ul>
<h3 data-id="heading-22">性能问题</h3>
<p>基于Vertex ID的效果导致性能下降时的优化策略：</p>
<ul>
<li>将计算从片元着色器移到顶点着色器</li>
<li>使用LOD系统在远距离简化效果</li>
<li>预计算静态效果到顶点颜色或纹理中</li>
</ul>
<h3 data-id="heading-23">平台兼容性</h3>
<p>处理不同平台的兼容性问题：</p>
<ul>
<li>为OpenGL ES 2.0等老旧平台提供简化版本</li>
<li>使用Shader Graph的Keyword系统管理平台特定代码</li>
<li>进行充分的跨平台测试</li>
</ul>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何设计一个可扩展的短信发送队列模块]]></title>    <link>https://juejin.cn/post/7601053058856419334</link>    <guid>https://juejin.cn/post/7601053058856419334</guid>    <pubDate>2026-01-31T09:47:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601053058856419334" data-draft-id="7600986495928008745" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何设计一个可扩展的短信发送队列模块"/> <meta itemprop="keywords" content="Go,后端"/> <meta itemprop="datePublished" content="2026-01-31T09:47:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="echo本尊47218"/> <meta itemprop="url" content="https://juejin.cn/user/2541726614162446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何设计一个可扩展的短信发送队列模块
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2541726614162446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    echo本尊47218
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T09:47:50.000Z" title="Sat Jan 31 2026 09:47:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">如何设计一个可扩展的短信发送队列模块</h2>
<h3 data-id="heading-1">项目地址</h3>
<ul>
<li>前端地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fqxkjsoft%2Fginfast-ui" target="_blank" title="https://github.com/qxkjsoft/ginfast-ui" ref="nofollow noopener noreferrer">github.com/qxkjsoft/gi…</a></li>
<li>后端地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fqxkjsoft%2Fginfast" target="_blank" title="https://github.com/qxkjsoft/ginfast" ref="nofollow noopener noreferrer">github.com/qxkjsoft/gi…</a></li>
</ul>
<h3 data-id="heading-2">前言</h3>
<p>在日常开发中，短信发送是一个非常常见的功能需求。无论是用户注册验证码、密码重置，还是营销通知，短信服务都扮演着重要角色。然而，直接调用短信服务商的 API 往往会带来一些问题：</p>
<ol>
<li><strong>网络延迟影响用户体验</strong>：同步发送短信会阻塞请求，导致响应变慢</li>
<li><strong>高并发场景下的限流问题</strong>：短信服务商通常有 QPS 限制</li>
<li><strong>发送失败需要重试</strong>：网络抖动或服务商临时故障可能导致发送失败</li>
<li><strong>多服务商切换成本高</strong>：不同服务商的 API 接口差异大，切换时需要大量修改代码</li>
</ol>
<p>本文将基于 gin-fast-tenant 项目中的短信插件模块，分享如何设计一个可扩展的短信发送队列模块。</p>
<hr/>
<h3 data-id="heading-3">一、整体架构设计</h3>
<h4 data-id="heading-4">1.1 核心设计理念</h4>
<p>我们的设计遵循以下几个核心原则：</p>
<ul>
<li><strong>接口驱动</strong>：通过接口抽象，实现与具体实现的解耦</li>
<li><strong>生产者-消费者模式</strong>：异步处理短信发送任务</li>
<li><strong>单例模式</strong>：确保队列全局唯一，避免资源浪费</li>
<li><strong>回调机制</strong>：灵活处理发送结果</li>
</ul>
<h4 data-id="heading-5">1.2 模块结构</h4>
<pre><code class="hljs language-bash" lang="bash">plugins/plusms/smshelper/
├── smsqueue/          <span class="hljs-comment"># 核心队列模块（与具体服务商无关）</span>
│   ├── interfaces.go  <span class="hljs-comment"># 接口定义</span>
│   ├── queue.go       <span class="hljs-comment"># 队列实现</span>
│   ├── callback.go    <span class="hljs-comment"># 回调函数</span>
│   ├── errors.go      <span class="hljs-comment"># 错误定义</span>
│   └── global.go      <span class="hljs-comment"># 全局队列</span>
└── alisms/            <span class="hljs-comment"># 阿里云短信实现</span>
    ├── alisms.go      <span class="hljs-comment"># 阿里云客户端</span>
    └── queue.go       <span class="hljs-comment"># 阿里云队列封装</span>
</code></pre>
<p>这种分层设计使得核心队列逻辑与具体短信服务商完全解耦，未来要接入腾讯云、华为云等服务商，只需实现相应的 Provider 即可。</p>
<hr/>
<h3 data-id="heading-6">二、核心接口设计</h3>
<h4 data-id="heading-7">2.1 TemplateConfig 接口</h4>
<p>所有短信模板必须实现此接口：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// TemplateConfig 短信模板配置接口</span>
<span class="hljs-keyword">type</span> TemplateConfig <span class="hljs-keyword">interface</span> {
    Json() <span class="hljs-type">string</span>            <span class="hljs-comment">// 返回模板参数的JSON字符串</span>
    GetTemplateCode() <span class="hljs-type">string</span> <span class="hljs-comment">// 返回模板代码</span>
    GetSignName() <span class="hljs-type">string</span>     <span class="hljs-comment">// 返回签名名称</span>
}
</code></pre>
<p><strong>设计思路</strong>：不同短信服务商的模板参数格式可能不同，但通过统一的接口，我们可以让上层代码无需关心底层差异。</p>
<p><strong>示例实现</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> TemplateDemo1 <span class="hljs-keyword">struct</span> {
    Code <span class="hljs-type">string</span> <span class="hljs-string">`json:"code"`</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *TemplateDemo1)</span></span> Json() <span class="hljs-type">string</span> {
    b, _ := json.Marshal(t)
    <span class="hljs-keyword">return</span> <span class="hljs-type">string</span>(b)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *TemplateDemo1)</span></span> GetTemplateCode() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"SMS_218038860"</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *TemplateDemo1)</span></span> GetSignName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"奇讯科技"</span>
}
</code></pre>
<h4 data-id="heading-8">2.2 SMSProvider 接口</h4>
<p>短信提供商必须实现此接口：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// SMSProvider 短信提供者接口</span>
<span class="hljs-keyword">type</span> SMSProvider <span class="hljs-keyword">interface</span> {
    Send(phoneNumbers <span class="hljs-type">string</span>, tpl TemplateConfig) (SMSResponse, <span class="hljs-type">error</span>)
}
</code></pre>
<p><strong>设计思路</strong>：这是整个模块最核心的抽象。通过这个接口，我们可以轻松切换不同的短信服务商，而无需修改上层调用代码。</p>
<p><strong>阿里云实现示例</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> AliSMS <span class="hljs-keyword">struct</span> {
    Debug           <span class="hljs-type">bool</span>
    AccessKeyId     <span class="hljs-type">string</span>
    AccessKeySecret <span class="hljs-type">string</span>
    *dysmsapi20170525.Client
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ali *AliSMS)</span></span> Send(phoneNumbers <span class="hljs-type">string</span>, tpl smsqueue.TemplateConfig) (res smsqueue.SMSResponse, _err <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">if</span> ali.Debug {
        <span class="hljs-comment">// 调试模式，不实际发送</span>
        <span class="hljs-keyword">return</span>
    }
    sendSmsRequest := &amp;dysmsapi20170525.SendSmsRequest{
        SignName:      tea.String(tpl.GetSignName()),
        TemplateCode:  tea.String(tpl.GetTemplateCode()),
        PhoneNumbers:  tea.String(phoneNumbers),
        TemplateParam: tea.String(tpl.Json()),
    }
    <span class="hljs-comment">// 调用阿里云 API...</span>
}
</code></pre>
<h4 data-id="heading-9">2.3 Callback 接口</h4>
<p>回调函数接口：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Callback 回调函数接口</span>
<span class="hljs-keyword">type</span> Callback <span class="hljs-keyword">interface</span> {
    OnSuccess(task *SMSTask, response SMSResponse) <span class="hljs-comment">// 发送成功时调用</span>
    OnError(task *SMSTask, err <span class="hljs-type">error</span>)              <span class="hljs-comment">// 发送失败时调用</span>
}
</code></pre>
<p><strong>设计思路</strong>：回调机制让调用方可以灵活处理发送结果，比如记录日志、更新数据库状态等。</p>
<p><strong>函数适配器</strong>：</p>
<p>为了让普通函数也能作为回调使用，我们提供了 <code>CallbackFunc</code> 适配器：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> CallbackFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(task *SMSTask, response SMSResponse, err <span class="hljs-type">error</span>)</span></span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f CallbackFunc)</span></span> OnSuccess(task *SMSTask, response SMSResponse) {
    f(task, response, <span class="hljs-literal">nil</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f CallbackFunc)</span></span> OnError(task *SMSTask, err <span class="hljs-type">error</span>) {
    f(task, <span class="hljs-literal">nil</span>, err)
}
</code></pre>
<p>这样，我们可以用更简洁的方式创建回调：</p>
<pre><code class="hljs language-go" lang="go">callback := smsqueue.NewCallback(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(task *smsqueue.SMSTask, response smsqueue.SMSResponse, err <span class="hljs-type">error</span>)</span></span> {
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Printf(<span class="hljs-string">"发送失败: %v\n"</span>, err)
        <span class="hljs-keyword">return</span>
    }
    fmt.Printf(<span class="hljs-string">"发送成功: BizId=%s\n"</span>, response.GetBizId())
})
</code></pre>
<hr/>
<h3 data-id="heading-10">三、队列实现详解</h3>
<h4 data-id="heading-11">3.1 队列结构</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> smsQueue <span class="hljs-keyword">struct</span> {
    mu               sync.RWMutex
    taskChan         <span class="hljs-keyword">chan</span> *SMSTask    <span class="hljs-comment">// 任务通道</span>
    workerNum        <span class="hljs-type">int</span>              <span class="hljs-comment">// 工作协程数量</span>
    stopChan         <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}    <span class="hljs-comment">// 停止信号</span>
    wg               sync.WaitGroup   <span class="hljs-comment">// 等待组</span>
    defaultProvider  SMSProvider      <span class="hljs-comment">// 默认短信提供者</span>
    globalCallbacks  []Callback       <span class="hljs-comment">// 全局回调</span>
    isRunning        <span class="hljs-type">bool</span>             <span class="hljs-comment">// 运行状态</span>
    maxQueueSize     <span class="hljs-type">int</span>              <span class="hljs-comment">// 队列最大容量</span>
    currentQueueSize <span class="hljs-type">int</span>              <span class="hljs-comment">// 当前队列大小</span>
}
</code></pre>
<h4 data-id="heading-12">3.2 创建队列</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewSMSQueue</span><span class="hljs-params">(workerNum <span class="hljs-type">int</span>, maxQueueSize <span class="hljs-type">int</span>)</span></span> Queue {
    <span class="hljs-keyword">if</span> workerNum &lt;= <span class="hljs-number">0</span> {
        workerNum = <span class="hljs-number">3</span>
    }
    <span class="hljs-keyword">return</span> &amp;smsQueue{
        taskChan:         <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> *SMSTask, maxQueueSize),
        workerNum:        workerNum,
        stopChan:         <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}),
        maxQueueSize:     maxQueueSize,
        currentQueueSize: <span class="hljs-number">0</span>,
        globalCallbacks:  <span class="hljs-built_in">make</span>([]Callback, <span class="hljs-number">0</span>),
    }
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ul>
<li>使用带缓冲的 channel 作为任务队列，避免阻塞</li>
<li><code>maxQueueSize</code> 为 0 时表示无限制</li>
<li>默认 3 个工作协程，可根据实际需求调整</li>
</ul>
<h4 data-id="heading-13">3.3 添加任务</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *smsQueue)</span></span> AddTask(task *SMSTask) <span class="hljs-type">error</span> {
    q.mu.Lock()
    <span class="hljs-keyword">defer</span> q.mu.Unlock()

    <span class="hljs-comment">// 检查队列容量</span>
    <span class="hljs-keyword">if</span> q.maxQueueSize &gt; <span class="hljs-number">0</span> &amp;&amp; q.currentQueueSize &gt;= q.maxQueueSize {
        <span class="hljs-keyword">return</span> ErrQueueFull
    }

    <span class="hljs-comment">// 生成任务ID（如果未设置）</span>
    <span class="hljs-keyword">if</span> task.ID == <span class="hljs-string">""</span> {
        task.ID = generateTaskID()
    }

    <span class="hljs-comment">// 设置默认重试次数</span>
    <span class="hljs-keyword">if</span> task.MaxRetries &lt;= <span class="hljs-number">0</span> {
        task.MaxRetries = <span class="hljs-number">3</span>
    }

    <span class="hljs-comment">// 尝试将任务推送到任务通道</span>
    <span class="hljs-keyword">select</span> {
    <span class="hljs-keyword">case</span> q.taskChan &lt;- task:
        q.currentQueueSize++
    <span class="hljs-keyword">case</span> &lt;-time.After(<span class="hljs-number">5</span> * time.Second):
        <span class="hljs-keyword">return</span> ErrQueueFull
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ul>
<li>使用 <code>select</code> + <code>time.After</code> 实现超时机制</li>
<li>自动生成任务 ID，便于追踪</li>
<li>默认重试 3 次</li>
</ul>
<h4 data-id="heading-14">3.4 启动工作协程</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *smsQueue)</span></span> Start() {
    q.mu.Lock()
    <span class="hljs-keyword">defer</span> q.mu.Unlock()

    <span class="hljs-keyword">if</span> q.isRunning {
        <span class="hljs-keyword">return</span>
    }

    q.isRunning = <span class="hljs-literal">true</span>

    <span class="hljs-comment">// 启动工作协程</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; q.workerNum; i++ {
        q.wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> q.worker()
    }
}
</code></pre>
<h4 data-id="heading-15">3.5 工作协程实现</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *smsQueue)</span></span> worker() {
    <span class="hljs-keyword">defer</span> q.wg.Done()

    <span class="hljs-keyword">for</span> {
        <span class="hljs-keyword">select</span> {
        <span class="hljs-keyword">case</span> &lt;-q.stopChan:
            <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">case</span> task, ok := &lt;-q.taskChan:
            <span class="hljs-keyword">if</span> !ok {
                <span class="hljs-keyword">return</span>
            }
            <span class="hljs-comment">// 任务已从通道取出，减少队列大小</span>
            q.mu.Lock()
            q.currentQueueSize--
            q.mu.Unlock()
            q.processTask(task)
        }
    }
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ul>
<li>使用 <code>select</code> 监听停止信号和任务通道</li>
<li>任务取出后立即减少队列计数</li>
<li>使用 <code>WaitGroup</code> 确保所有协程优雅退出</li>
</ul>
<h4 data-id="heading-16">3.6 任务处理与重试机制</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *smsQueue)</span></span> processTask(task *SMSTask) {
    <span class="hljs-comment">// 选择提供者</span>
    provider := task.Provider
    <span class="hljs-keyword">if</span> provider == <span class="hljs-literal">nil</span> {
        provider = q.defaultProvider
    }

    <span class="hljs-keyword">if</span> provider == <span class="hljs-literal">nil</span> {
        q.handleError(task, ErrNoProvider)
        <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 发送短信</span>
    response, err := provider.Send(task.PhoneNumbers, task.Template)

    <span class="hljs-comment">// 处理结果</span>
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-comment">// 发送失败，检查是否需要重试</span>
        <span class="hljs-keyword">if</span> task.RetryCount &lt; task.MaxRetries {
            task.RetryCount++
            <span class="hljs-comment">// 延迟重试（指数退避）</span>
            time.Sleep(time.Duration(task.RetryCount) * time.Second)
            <span class="hljs-comment">// 重新加入队列</span>
            <span class="hljs-keyword">if</span> err := q.AddTask(task); err != <span class="hljs-literal">nil</span> {
                q.handleError(task, err)
            }
            <span class="hljs-keyword">return</span>
        }
        q.handleError(task, err)
    } <span class="hljs-keyword">else</span> {
        q.handleSuccess(task, response)
    }
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ul>
<li>支持任务级 Provider，可以为不同任务指定不同的服务商</li>
<li>自动重试机制，默认重试 3 次</li>
<li>指数退避策略，避免短时间内频繁重试</li>
</ul>
<h4 data-id="heading-17">3.7 回调处理</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *smsQueue)</span></span> handleSuccess(task *SMSTask, response SMSResponse) {
    <span class="hljs-comment">// 调用任务级回调</span>
    <span class="hljs-keyword">if</span> task.Callback != <span class="hljs-literal">nil</span> {
        task.Callback.OnSuccess(task, response)
    }
    <span class="hljs-comment">// 调用全局回调</span>
    <span class="hljs-keyword">for</span> _, cb := <span class="hljs-keyword">range</span> q.globalCallbacks {
        cb.OnSuccess(task, response)
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(q *smsQueue)</span></span> handleError(task *SMSTask, err <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 调用任务级回调</span>
    <span class="hljs-keyword">if</span> task.Callback != <span class="hljs-literal">nil</span> {
        task.Callback.OnError(task, err)
    }
    <span class="hljs-comment">// 调用全局回调</span>
    <span class="hljs-keyword">for</span> _, cb := <span class="hljs-keyword">range</span> q.globalCallbacks {
        cb.OnError(task, err)
    }
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ul>
<li>先调用任务级回调，再调用全局回调</li>
<li>全局回调可以用于统一记录日志、更新数据库等</li>
</ul>
<hr/>
<h3 data-id="heading-18">四、单例模式与封装</h3>
<h4 data-id="heading-19">4.1 阿里云队列单例</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> (
    aliQueue     smsqueue.Queue
    aliQueueOnce sync.Once
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetQueue</span><span class="hljs-params">()</span></span> smsqueue.Queue {
    aliQueueOnce.Do(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 创建队列，3个工作协程，队列容量100</span>
        aliQueue = smsqueue.NewSMSQueue(<span class="hljs-number">3</span>, <span class="hljs-number">100</span>)
        <span class="hljs-comment">// 设置默认提供者为阿里云短信服务</span>
        aliQueue.SetDefaultProvider(GetSingletonAliSMS())
        <span class="hljs-comment">// 启动队列</span>
        aliQueue.Start()
    })
    <span class="hljs-keyword">return</span> aliQueue
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ul>
<li>使用 <code>sync.Once</code> 确保队列只初始化一次</li>
<li>懒加载，首次调用时才创建队列</li>
</ul>
<h4 data-id="heading-20">4.2 便捷发送函数</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Send</span><span class="hljs-params">(ctx context.Context, phoneNumbers <span class="hljs-type">string</span>, template smsqueue.TemplateConfig, callback ...smsqueue.Callback)</span></span> <span class="hljs-type">error</span> {
    <span class="hljs-keyword">var</span> cb smsqueue.Callback
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(callback) &gt; <span class="hljs-number">0</span> {
        cb = callback[<span class="hljs-number">0</span>]
    }
    task := &amp;smsqueue.SMSTask{
        PhoneNumbers: phoneNumbers,
        Template:     template,
        Callback:     cb,
        Context:      ctx,
    }
    <span class="hljs-keyword">return</span> GetQueue().AddTask(task)
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ul>
<li>使用可变参数，回调函数可选</li>
<li>自动创建任务并添加到队列</li>
</ul>
<hr/>
<h3 data-id="heading-21">五、配置管理</h3>
<h4 data-id="heading-22">5.1 配置文件</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># config/sms.yml</span>
<span class="hljs-attr">alisms:</span>
  <span class="hljs-attr">AccessKeyId:</span> <span class="hljs-string">""</span>      <span class="hljs-comment"># 阿里云短信服务AccessKeyId</span>
  <span class="hljs-attr">AccessKeySecret:</span> <span class="hljs-string">""</span>  <span class="hljs-comment"># 阿里云短信服务AccessKeySecret</span>
  <span class="hljs-attr">Debug:</span> <span class="hljs-literal">false</span>         <span class="hljs-comment"># 是否开启调试模式</span>
</code></pre>
<h4 data-id="heading-23">5.2 配置读取</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewAliSMS</span><span class="hljs-params">()</span></span> *AliSMS {
    AccessKeyId := smsconfig.GetSmsConfig().GetString(<span class="hljs-string">"alisms.AccessKeyId"</span>)
    AccessKeySecret := smsconfig.GetSmsConfig().GetString(<span class="hljs-string">"alisms.AccessKeySecret"</span>)
    Debug := smsconfig.GetSmsConfig().GetBool(<span class="hljs-string">"alisms.Debug"</span>)

    config := &amp;openapi.Config{
        AccessKeyId:     tea.String(AccessKeyId),
        AccessKeySecret: tea.String(AccessKeySecret),
    }
    config.Endpoint = tea.String(<span class="hljs-string">"dysmsapi.aliyuncs.com"</span>)
    client, err := dysmsapi20170525.NewClient(config)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)
    }
    <span class="hljs-keyword">return</span> &amp;AliSMS{
        Debug:           Debug,
        AccessKeyId:     AccessKeyId,
        AccessKeySecret: AccessKeySecret,
        Client:          client,
    }
}
</code></pre>
<p><strong>设计要点</strong>：</p>
<ul>
<li>调试模式下不实际发送短信，方便开发测试</li>
<li>配置与代码分离，便于部署</li>
</ul>
<hr/>
<h3 data-id="heading-24">六、使用示例</h3>
<h4 data-id="heading-25">6.1 基础用法</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">import</span> <span class="hljs-string">"gin-fast/plugins/plusms/smshelper/alisms"</span>

<span class="hljs-comment">// 发送验证码短信</span>
err := alisms.Send(context.Background(), <span class="hljs-string">"13800138000"</span>, &amp;alisms.TemplateDemo1{
    Code: <span class="hljs-string">"123456"</span>,
})
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-comment">// 处理错误</span>
}
</code></pre>
<h4 data-id="heading-26">6.2 使用回调</h4>
<pre><code class="hljs language-go" lang="go">callback := smsqueue.NewCallback(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(task *smsqueue.SMSTask, response smsqueue.SMSResponse, err <span class="hljs-type">error</span>)</span></span> {
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        fmt.Printf(<span class="hljs-string">"发送失败: %v\n"</span>, err)
        <span class="hljs-keyword">return</span>
    }
    fmt.Printf(<span class="hljs-string">"发送成功: BizId=%s\n"</span>, response.GetBizId())
})

err := alisms.Send(context.Background(), <span class="hljs-string">"13800138000"</span>, &amp;alisms.TemplateDemo1{Code: <span class="hljs-string">"123456"</span>}, callback)
</code></pre>
<h4 data-id="heading-27">6.3 注册全局回调</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 注册全局回调（所有短信发送都会调用）</span>
alisms.RegisterGlobalCallback(&amp;MyGlobalCallback{})
</code></pre>
<h4 data-id="heading-28">6.4 自定义短信提供商</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> MySMSProvider <span class="hljs-keyword">struct</span>{}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *MySMSProvider)</span></span> Send(phoneNumbers <span class="hljs-type">string</span>, tpl smsqueue.TemplateConfig) (smsqueue.SMSResponse, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 实现发送逻辑</span>
    <span class="hljs-keyword">return</span> &amp;myResponse{}, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 设置为默认提供者</span>
alisms.SetDefaultProvider(&amp;MySMSProvider{})
</code></pre>
<hr/>
<h3 data-id="heading-29">七、设计亮点总结</h3>
<h4 data-id="heading-30">7.1 高度解耦</h4>
<p>通过接口抽象，核心队列逻辑与具体短信服务商完全解耦。未来要接入新的服务商，只需实现 <code>SMSProvider</code> 接口即可，无需修改队列代码。</p>
<h4 data-id="heading-31">7.2 灵活的回调机制</h4>
<p>支持任务级回调和全局回调，可以灵活处理发送结果，满足不同业务场景的需求。</p>
<h4 data-id="heading-32">7.3 可靠的重试机制</h4>
<p>自动重试 + 指数退避策略，有效应对网络抖动和临时故障。</p>
<h4 data-id="heading-33">7.4 优雅的并发控制</h4>
<p>使用 channel + worker pool 模式，有效控制并发度，避免资源耗尽。</p>
<h4 data-id="heading-34">7.5 易于测试</h4>
<p>通过接口抽象，可以轻松 mock Provider 和 Queue，便于单元测试。</p>
<hr/>
<h3 data-id="heading-35">八、扩展建议</h3>
<h4 data-id="heading-36">8.1 优先级队列</h4>
<p>当前实现是 FIFO 队列，如果需要支持优先级，可以考虑：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> PriorityTask <span class="hljs-keyword">struct</span> {
    *SMSTask
    Priority <span class="hljs-type">int</span>
}

<span class="hljs-comment">// 使用 heap 实现优先级队列</span>
<span class="hljs-keyword">type</span> PriorityQueue []*PriorityTask

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pq PriorityQueue)</span></span> Len() <span class="hljs-type">int</span> { <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(pq) }
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pq PriorityQueue)</span></span> Less(i, j <span class="hljs-type">int</span>) <span class="hljs-type">bool</span> {
    <span class="hljs-keyword">return</span> pq[i].Priority &lt; pq[j].Priority
}
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pq PriorityQueue)</span></span> Swap(i, j <span class="hljs-type">int</span>) { pq[i], pq[j] = pq[j], pq[i] }
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pq *PriorityQueue)</span></span> Push(x <span class="hljs-keyword">interface</span>{}) { *pq = <span class="hljs-built_in">append</span>(*pq, x.(*PriorityTask)) }
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(pq *PriorityQueue)</span></span> Pop() <span class="hljs-keyword">interface</span>{} {
    old := *pq
    n := <span class="hljs-built_in">len</span>(old)
    item := old[n<span class="hljs-number">-1</span>]
    *pq = old[<span class="hljs-number">0</span> : n<span class="hljs-number">-1</span>]
    <span class="hljs-keyword">return</span> item
}
</code></pre>
<h4 data-id="heading-37">8.2 持久化队列</h4>
<p>当前队列是内存队列，应用重启会丢失任务。可以考虑：</p>
<ul>
<li>使用 Redis 作为任务队列</li>
<li>使用数据库存储任务状态</li>
<li>实现任务恢复机制</li>
</ul>
<h4 data-id="heading-38">8.3 限流控制</h4>
<p>在 <code>AddTask</code> 中增加限流逻辑：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> RateLimiter <span class="hljs-keyword">struct</span> {
    tokens <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewRateLimiter</span><span class="hljs-params">(qps <span class="hljs-type">int</span>)</span></span> *RateLimiter {
    rl := &amp;RateLimiter{
        tokens: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}, qps),
    }
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; qps; i++ {
        rl.tokens &lt;- <span class="hljs-keyword">struct</span>{}{}
    }
    <span class="hljs-keyword">go</span> rl.refill()
    <span class="hljs-keyword">return</span> rl
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rl *RateLimiter)</span></span> refill() {
    ticker := time.NewTicker(time.Second / time.Duration(<span class="hljs-built_in">cap</span>(rl.tokens)))
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">range</span> ticker.C {
        <span class="hljs-keyword">select</span> {
        <span class="hljs-keyword">case</span> rl.tokens &lt;- <span class="hljs-keyword">struct</span>{}{}:
        <span class="hljs-keyword">default</span>:
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rl *RateLimiter)</span></span> Acquire() {
    &lt;-rl.tokens
}
</code></pre>
<h4 data-id="heading-39">8.4 监控指标</h4>
<p>增加监控指标：</p>
<ul>
<li>队列长度</li>
<li>发送成功率</li>
<li>平均响应时间</li>
<li>重试次数</li>
</ul>
<hr/>
<h3 data-id="heading-40">结语</h3>
<p>本文分享了一个可扩展的短信发送队列模块的设计思路和实现细节。通过接口抽象、生产者-消费者模式、回调机制等设计模式，我们构建了一个既简单又强大的短信发送系统。</p>
<p>这个模块的核心价值在于：</p>
<ol>
<li><strong>开箱即用</strong>：简单的 API 设计，几行代码即可发送短信</li>
<li><strong>易于扩展</strong>：通过接口抽象，轻松接入新的短信服务商</li>
<li><strong>可靠稳定</strong>：自动重试、并发控制、优雅停止等机制保证系统稳定性</li>
</ol>
<p>希望本文能对大家有所帮助，欢迎交流讨论！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JWT 双 Token 无感刷新：兼顾安全与体验的全栈认证方案]]></title>    <link>https://juejin.cn/post/7601034810312704054</link>    <guid>https://juejin.cn/post/7601034810312704054</guid>    <pubDate>2026-01-31T09:56:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601034810312704054" data-draft-id="7600994087588659219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JWT 双 Token 无感刷新：兼顾安全与体验的全栈认证方案"/> <meta itemprop="keywords" content="全栈,NestJS,React.js"/> <meta itemprop="datePublished" content="2026-01-31T09:56:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xhxxx"/> <meta itemprop="url" content="https://juejin.cn/user/3235201610941578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JWT 双 Token 无感刷新：兼顾安全与体验的全栈认证方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3235201610941578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xhxxx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T09:56:50.000Z" title="Sat Jan 31 2026 09:56:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">全栈项目中的 JWT 双 Token 无感刷新认证方案</h2>
<p>在构建 Web 应用时，用户认证（Authentication）就像是给你的系统装一扇门。如何既保证这扇门足够安全（不让坏人进），又让它足够智能（不让好人每次进出都掏钥匙），是每个开发者都要面对的挑战。</p>
<p>在我们的全栈项目中，我们经历了一个从 Mock 单 Token 到生产级双 Token 的演进过程。本文将带你深入这套机制的每一个齿轮，揭示它是如何平衡“安全性”与“体验感”的。</p>
<hr/>
<h3 data-id="heading-1">单 Token 的认证机制</h3>
<p>最初写项目时，我们在 mock 中使用了单 Token 的机制，通过 <code>sign</code> 直接签发一个长期的 Token，而拦截器中只要碰到 <code>401</code>，就直接强制登出，返回登录页：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">token</span> = jwt.<span class="hljs-title function_ invoke__">sign</span>({
  <span class="hljs-attr">user</span>: { // json 对象
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'admin'</span>,
    <span class="hljs-attr">avatar</span>: <span class="hljs-string">"https://p9-passport.byteacctimg.com/img/user-avatar/09aff03aaa33dd9d311511bcbd12535f~50x50.awebp"</span>
  }
  // 加盐  
}, secret, {
  <span class="hljs-attr">expiresIn</span>: <span class="hljs-number">86400</span> * <span class="hljs-number">7</span> // 有效时间 <span class="hljs-number">7</span>天
});
</code></pre>
<p>这样的单 Token 模式却暴露了很多缺陷：</p>
<ol>
<li><strong>安全性问题</strong>：长期 Token 存在被截获后被冒用的风险</li>
<li><strong>用户体验问题</strong>：用户每次操作都需要重新登录，影响用户体验</li>
<li><strong>服务端压力问题</strong>：每次请求都需要验证 Token，服务端压力增大</li>
</ol>
<hr/>
<h3 data-id="heading-2">进阶：JWT 双 Token 认证机制</h3>
<p>在单 Token 时代，我们总是面临一个两难的选择：Token 有效期设短了，用户体验差；设长了，安全风险大。<strong>双 Token 机制</strong>巧妙地引入了两把不同用途的“钥匙”来解决这个问题。</p>
<h4 data-id="heading-3">后端部分核心实现</h4>
<p>后端部分负责 Token 的签发与验证。</p>
<h5 data-id="heading-4">Token 的签发</h5>
<p>每当用户进行登录时，会同时签发一对 Token：</p>
<ul>
<li><strong>Access Token</strong>：短期 Token，就像是用户的临时密码，用于验证用户身份。所有的操作都只需要验证 Access Token 即可。</li>
<li><strong>Refresh Token</strong>：长期 Token，就像是用户的长期密码，用于刷新 Access Token。</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// AuthService: 生成双 Token</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">generateTokens</span>(<span class="hljs-params">userId: <span class="hljs-built_in">string</span>, username: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-comment">// Payload (载荷)：钥匙里包裹的信息</span>
  <span class="hljs-keyword">const</span> payload = { <span class="hljs-attr">sub</span>: userId, <span class="hljs-attr">name</span>: username };

  <span class="hljs-comment">// 使用 Promise.all 并行执行，效率翻倍</span>
  <span class="hljs-keyword">const</span> [at, rt] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([
    <span class="hljs-comment">// 制作手环 (Access Token)：15分钟过期</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">signAsync</span>(payload, {
      <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">'15m'</span>,
      <span class="hljs-attr">secret</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">TOKEN_SECRET</span>
    }),
    <span class="hljs-comment">// 制作凭证 (Refresh Token)：7天过期</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">signAsync</span>(payload, {
      <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">'7d'</span>,
      <span class="hljs-attr">secret</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">TOKEN_SECRET</span>
    })
  ]);

  <span class="hljs-keyword">return</span> { <span class="hljs-attr">access_token</span>: at, <span class="hljs-attr">refresh_token</span>: rt };
}
</code></pre>
<p><strong>核心代码分析</strong>：</p>
<ul>
<li><code>jwtService</code>：这是 NestJS 中提供的 JWT 服务，用于签发 Token</li>
<li><code>signAsync</code>：JWT 服务提供的异步方法，用于签发 Token</li>
<li><code>expiresIn</code>：Token 的过期时间。15 分钟用于短期认证，7 天用于长期存储</li>
<li><code>secret</code>：Token 的密钥，用于签名，确保安全性（保存在 <code>.env</code> 文件中）</li>
<li><code>payload</code>：Token 中包含的信息。<code>sub</code> 是标准 JWT Subject 字段，表示用户 ID</li>
<li><code>Promise.all</code>：并行签发两个 Token，提高效率，只有两者都成功才返回前端</li>
</ul>
<blockquote>
<p>短期的 Token 通常以分钟为单位，长期的 Token 通常以天为单位，根据实际情况进行设置。</p>
</blockquote>
<hr/>
<h5 data-id="heading-5">Token 的刷新</h5>
<p>当 Access Token 过期时，用户可以使用 Refresh Token 来重新颁发一对 Token：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">async</span> <span class="hljs-title function_">refreshToken</span>(<span class="hljs-params">rt: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// decoded</span>
    <span class="hljs-keyword">const</span> payload = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">jwtService</span>.<span class="hljs-title function_">verifyAsync</span>(rt, {
      <span class="hljs-attr">secret</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">TOKEN_SECRET</span>
    });
    <span class="hljs-keyword">if</span> (payload) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateTokens</span>(payload.<span class="hljs-property">sub</span>, payload.<span class="hljs-property">name</span>);
    }
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnauthorizedException</span>(<span class="hljs-string">'Refresh token 已失效，请重新登录'</span>);
  }
}
</code></pre>
<p><strong>核心代码解析</strong>：</p>
<ul>
<li><code>verifyAsync</code> 方法：NestJS JWT 服务提供的异步方法，用于验证 Refresh Token 的有效性</li>
<li><code>payload</code>：若能成功解码并获取用户信息，说明 Refresh Token 有效，即可调用 <code>generateTokens</code> 重新签发</li>
</ul>
<hr/>
<h5 data-id="heading-6">NestJS 鉴权处理：策略与守卫</h5>
<h6 data-id="heading-7">配备守卫</h6>
<p>NestJS 提供了默认的 Guard，用于解析 <code>req.headers.Authorization</code> 中的 Token。我们只需继承该 Guard，并指定使用 JWT 策略：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@nestjs/common"</span>;
<span class="hljs-comment">// NestJS 默认提供的 guard，自动解析 req Authorization</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AuthGuard</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@nestjs/passport"</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtAuthGuard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AuthGuard</span>(<span class="hljs-string">'jwt'</span>) {}
</code></pre>
<p>只需在需要鉴权的路由上加上装饰器即可：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-meta">@UseGuards</span>(<span class="hljs-title class_">JwtAuthGuard</span>)  <span class="hljs-comment">// 路由守卫</span>
<span class="hljs-title function_">createPost</span>(<span class="hljs-params">
  <span class="hljs-meta">@Body</span>(<span class="hljs-string">'title'</span>) title: <span class="hljs-built_in">string</span>,
  <span class="hljs-meta">@Body</span>(<span class="hljs-string">'content'</span>) content: <span class="hljs-built_in">string</span>,
  <span class="hljs-meta">@Req</span>() req
</span>) {...}
</code></pre>
<h6 data-id="heading-8">制定策略</h6>
<p>仅有守卫还不够，我们还需要制定一套规则，让系统知道如何鉴权：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-comment">// 定义和集成 Passport 身份验证策略的基类</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PassportStrategy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/passport'</span>;
<span class="hljs-comment">// 身份验证策略选择 jwt</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Strategy</span>, <span class="hljs-title class_">ExtractJwt</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'passport-jwt'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JwtStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PassportStrategy</span>(<span class="hljs-title class_">Strategy</span>) {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>({
      <span class="hljs-attr">jwtFromRequest</span>: <span class="hljs-title class_">ExtractJwt</span>.<span class="hljs-title function_">fromAuthHeaderAsBearerToken</span>(),
      <span class="hljs-attr">secretOrKey</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">TOKEN_SECRET</span> || <span class="hljs-string">""</span>
    });
  }

  <span class="hljs-comment">// JWT 用户对象</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">payload</span>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">id</span>: payload.<span class="hljs-property">sub</span>,
      <span class="hljs-attr">name</span>: payload.<span class="hljs-property">name</span>
    };
  }
}
</code></pre>
<p><strong>核心代码解析</strong>：</p>
<ul>
<li><code>PassportStrategy(Strategy)</code>：NestJS 提供的基类，用于定义 Passport 策略</li>
<li><code>Strategy</code>：来自 <code>passport-jwt</code>，表示使用 JWT 策略</li>
<li><code>jwtFromRequest</code>：指定从 <code>Authorization</code> Header 中提取 Bearer Token</li>
<li><code>secretOrKey</code>：用于验证 Token 签名的密钥（来自环境变量）</li>
<li><code>validate</code>：验证成功后返回用户上下文，挂载到 <code>req.user</code> 上</li>
</ul>
<p>例如，在业务代码中可直接使用：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-meta">@Post</span>()
<span class="hljs-meta">@UseGuards</span>(<span class="hljs-title class_">JwtAuthGuard</span>)
<span class="hljs-title function_">createPost</span>(<span class="hljs-params">
  <span class="hljs-meta">@Body</span>(<span class="hljs-string">'title'</span>) title: <span class="hljs-built_in">string</span>,
  <span class="hljs-meta">@Body</span>(<span class="hljs-string">'content'</span>) content: <span class="hljs-built_in">string</span>,
  <span class="hljs-meta">@Req</span>() req
</span>) {
  <span class="hljs-keyword">const</span> { user } = req;
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">postsService</span>.<span class="hljs-title function_">createPost</span>({
    title,
    content,
    <span class="hljs-attr">userId</span>: user.<span class="hljs-property">id</span>
  });
}
</code></pre>
<hr/>
<h4 data-id="heading-9">前端部分核心实现</h4>
<p>前端的挑战在于如何管理这些 Token，并在 Token 过期时“悄无声息”地完成刷新，让用户感觉不到任何中断。</p>
<h5 data-id="heading-10">Token 的存储与状态管理</h5>
<p>我们使用 <strong>Zustand</strong> 库进行状态管理，因为它轻量且支持中间件。</p>
<p>关键代码解析 (<code>useUserStore</code>)：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useUserStore = <span class="hljs-title function_">create</span>(
  <span class="hljs-title function_">persist</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
    <span class="hljs-attr">accessToken</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">refreshToken</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-comment">// ...</span>
  }), {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'user-store'</span>, <span class="hljs-comment">// LocalStorage 中的 key</span>
    <span class="hljs-attr">partialize</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ 
      <span class="hljs-comment">// 白名单：只持久化这两个 Token，不持久化临时状态</span>
      <span class="hljs-attr">accessToken</span>: state.<span class="hljs-property">accessToken</span>,
      <span class="hljs-attr">refreshToken</span>: state.<span class="hljs-property">refreshToken</span>,
    })
  })
);
</code></pre>
<ul>
<li><strong>持久化 (Persist)</strong> ：确保刷新页面后，用户依然是登录状态。Token 自动保存到 <code>localStorage</code>。</li>
<li><strong>白名单 (Partialize)</strong> ：最佳实践。只存 Token，避免将临时状态（如 <code>isLoading</code>）误存，导致状态错乱。</li>
</ul>
<hr/>
<h5 data-id="heading-11">拦截器实现 Token 无感刷新</h5>
<p><strong>为什么在拦截器里做？</strong><br/>
因为拦截器是所有 HTTP 请求的<strong>总关口</strong>。在这里处理，可以统一拦截所有 API 的 <code>401</code> 错误，业务代码完全不需要关心 Token 是否过期，做到了<strong>逻辑解耦</strong>。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store/useUserStore'</span>;

<span class="hljs-keyword">const</span> instance = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'http://localhost:5173/api'</span>
});

<span class="hljs-comment">// 每次请求自动带上 token</span>
instance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> token = useUserStore.<span class="hljs-title function_">getState</span>().<span class="hljs-property">accessToken</span>;
  <span class="hljs-keyword">if</span> (token) {
    config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
  }
  <span class="hljs-keyword">return</span> config;
});

<span class="hljs-keyword">let</span> isRefreshing = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">requestsQueue</span>: <span class="hljs-built_in">any</span>[] = []; 

<span class="hljs-comment">// 响应拦截器</span>
instance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>;
}, <span class="hljs-keyword">async</span> (err) =&gt; {
  <span class="hljs-keyword">const</span> { config, response } = err;
  <span class="hljs-comment">// _retry 刻意标记是否是重试的请求，避免 retry 死循环</span>
  <span class="hljs-keyword">if</span> (response?.<span class="hljs-property">status</span> === <span class="hljs-number">401</span> &amp;&amp; !config.<span class="hljs-property">_retry</span>) {
    <span class="hljs-comment">// 如果在刷新中，把后续请求放到队列中</span>
    <span class="hljs-keyword">if</span> (isRefreshing) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
        requestsQueue.<span class="hljs-title function_">push</span>(<span class="hljs-function">(<span class="hljs-params">token: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
          config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
          <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">instance</span>(config));
        });
      });
    }

    config.<span class="hljs-property">_retry</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// retry 开关 </span>
    isRefreshing = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { refreshToken } = useUserStore.<span class="hljs-title function_">getState</span>();
      <span class="hljs-keyword">if</span> (refreshToken) {
        <span class="hljs-comment">// 无感刷新 token</span>
        <span class="hljs-keyword">const</span> { access_token, refresh_token } = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">post</span>(<span class="hljs-string">'auth/refresh'</span>, {
          <span class="hljs-attr">refresh_token</span>: refreshToken
        });

        useUserStore.<span class="hljs-title function_">setState</span>({
          <span class="hljs-attr">accessToken</span>: access_token,
          <span class="hljs-attr">refreshToken</span>: refresh_token,
          <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">true</span>
        });

        requestsQueue.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> <span class="hljs-title function_">callback</span>(access_token));
        requestsQueue = [];

        config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${access_token}</span>`</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">instance</span>(config);
      }
    } <span class="hljs-keyword">catch</span> (err) {
      useUserStore.<span class="hljs-title function_">getState</span>().<span class="hljs-title function_">logout</span>();
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err);
    } <span class="hljs-keyword">finally</span> {
      isRefreshing = <span class="hljs-literal">false</span>;
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err);
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> instance;
</code></pre>
<h6 data-id="heading-12">代码拆解讲解</h6>
<ol>
<li>
<p><strong>请求拦截器</strong><br/>
让每次请求都自动带上 Token：</p>
<pre><code class="hljs language-tsx" lang="tsx">instance.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> token = useUserStore.<span class="hljs-title function_">getState</span>().<span class="hljs-property">accessToken</span>;
  <span class="hljs-keyword">if</span> (token) {
    config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
  }
  <span class="hljs-keyword">return</span> config;
});
</code></pre>
</li>
<li>
<p><strong>响应拦截器</strong></p>
<p><strong>关键变量</strong>：</p>
<ul>
<li><code>isRefreshing</code>：是否正在刷新 Token</li>
<li><code>requestsQueue</code>：等待刷新完成后的请求队列</li>
</ul>
<p><strong>为什么需要这个队列？</strong><br/>
当多个并发请求因 Token 过期失败时，不能每个都去刷新 Token。应只触发一次刷新，其余请求排队等待新 Token。</p>
<p><strong>逻辑步骤</strong>：</p>
<ul>
<li>
<p><strong>判断是否需要刷新 Token</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">if</span> (response?.<span class="hljs-property">status</span> === <span class="hljs-number">401</span> &amp;&amp; !config.<span class="hljs-property">_retry</span>) { ... }
</code></pre>
<blockquote>
<p><code>_retry</code> 标记防止死循环：若重试后仍 401，不再重复刷新。</p>
</blockquote>
</li>
<li>
<p><strong>处理并发请求</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">if</span> (isRefreshing) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    requestsQueue.<span class="hljs-title function_">push</span>(<span class="hljs-function">(<span class="hljs-params">token: <span class="hljs-built_in">string</span></span>) =&gt;</span> {
      config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
      <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">instance</span>(config));
    });
  });
}
config.<span class="hljs-property">_retry</span> = <span class="hljs-literal">true</span>;
isRefreshing = <span class="hljs-literal">true</span>;
</code></pre>
</li>
<li>
<p><strong>签发新 Token</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { refreshToken } = useUserStore.<span class="hljs-title function_">getState</span>();
<span class="hljs-keyword">if</span> (refreshToken) {
  <span class="hljs-keyword">const</span> { access_token, refresh_token } = <span class="hljs-keyword">await</span> instance.<span class="hljs-title function_">post</span>(<span class="hljs-string">'auth/refresh'</span>, {
    <span class="hljs-attr">refresh_token</span>: refreshToken
  });
  useUserStore.<span class="hljs-title function_">setState</span>({
    <span class="hljs-attr">accessToken</span>: access_token,
    <span class="hljs-attr">refreshToken</span>: refresh_token,
    <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">true</span>
  });
}
</code></pre>
</li>
<li>
<p><strong>重放排队请求</strong></p>
<pre><code class="hljs language-tsx" lang="tsx">requestsQueue.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">callback</span> =&gt;</span> <span class="hljs-title function_">callback</span>(access_token));
requestsQueue = [];
</code></pre>
</li>
<li>
<p><strong>重试当前请求</strong></p>
<pre><code class="hljs language-tsx" lang="tsx">config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${access_token}</span>`</span>;
<span class="hljs-keyword">return</span> <span class="hljs-title function_">instance</span>(config);
</code></pre>
</li>
<li>
<p><strong>处理刷新失败</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">catch</span> (err) {
  useUserStore.<span class="hljs-title function_">getState</span>().<span class="hljs-title function_">logout</span>();
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err);
} <span class="hljs-keyword">finally</span> {
  isRefreshing = <span class="hljs-literal">false</span>;
}
</code></pre>
</li>
<li>
<p><strong>拦截器出口</strong></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err);
</code></pre>
</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-13">总结</h3>
<p>JWT 双 Token 无感刷新机制，本质上是一种在安全性和用户体验之间取得精妙平衡的工程实践。通过将认证职责拆分为短期有效的 Access Token 与长期有效的 Refresh Token，我们既避免了长期持有敏感凭证带来的安全风险，又消除了用户频繁登录的体验断层。</p>
<p>后端通过 NestJS 的守卫（Guard）与策略（Strategy）体系，构建了一套清晰、可复用的鉴权基础设施；前端则借助 Axios 拦截器与状态管理库 Zustand，在请求层面实现了“透明”的 Token 刷新逻辑——业务代码无需感知认证细节，所有 401 错误都被拦截器自动处理，真正做到了“无感”。</p>
<p>这套方案的核心价值在于：<strong>安全不妥协，体验不打折</strong>。Access Token 的短生命周期极大降低了泄露后的危害窗口，而 Refresh Token 的独立存储与严格校验则保障了凭证刷新的安全边界。同时，通过队列机制与重试标记，前端有效解决了并发请求下的 Token 竞态问题，确保系统在高负载下依然稳定可靠。</p>
<p>当然，任何方案都不是银弹。双 Token 机制虽好，仍需配合以下措施，才能构筑起完整的认证安全防线：</p>
<ul>
<li><strong>HTTPS 传输</strong>：防止 Token 在传输中被窃听</li>
<li><strong>Refresh Token 黑名单或数据库记录</strong>：支持主动吊销</li>
<li><strong>合理的过期策略</strong>：根据业务敏感度调整时效</li>
<li><strong>客户端安全存储</strong>：如使用 <code>HttpOnly</code> Cookie 防 XSS（若适用）</li>
</ul>
<p>但在大多数中大型全栈应用中，这套 <strong>双 Token + 无感刷新</strong> 的组合，无疑是当前兼顾<strong>安全性、可维护性与用户体验</strong>的优选方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git 深度学习笔记：从初始化到核心操作机制解析]]></title>    <link>https://juejin.cn/post/7601069677566263342</link>    <guid>https://juejin.cn/post/7601069677566263342</guid>    <pubDate>2026-01-31T09:58:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601069677566263342" data-draft-id="7601020578491072521" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git 深度学习笔记：从初始化到核心操作机制解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-31T09:58:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是店小二呀"/> <meta itemprop="url" content="https://juejin.cn/user/4132386718619243"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git 深度学习笔记：从初始化到核心操作机制解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4132386718619243/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是店小二呀
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T09:58:13.000Z" title="Sat Jan 31 2026 09:58:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/211a215fb4c64d8b95a93fbe0a23b5c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=iq0dUj8d3%2FmQlSt4BWbUwGCCEHs%3D" alt="" loading="lazy"/>
在现代软件开发中，版本控制系统是不可或缺的基石。Git 作为目前最主流的分布式版本控制工具，其强大的分支管理、历史追溯以及协作能力，极大地提升了开发效率。本文将基于实际操作流程，深入剖析 Git 从仓库初始化、配置管理、核心区域交互到版本回退与文件操作的完整链路，并重点探讨其背后的工作原理。</p>
<h2 data-id="heading-0">一、仓库初始化与环境搭建</h2>
<h3 data-id="heading-1">1.1 初始化的两种路径</h3>
<p>在开始一个项目时，通常面临两种情况：一种是全新的项目，从零开始；另一种是接手现有的项目。Git 提供了 <code>git init</code> 和 <code>git clone</code> 两种指令来应对这两种场景。</p>
<p><strong>本地初始化：从零开始</strong>
当在本地创建一个新的文件夹，或者基于已有的本地代码想要纳入版本控制时，使用初始化命令是第一步。</p>
<p>在目标目录下执行：</p>
<pre><code class="hljs language-bash" lang="bash">git init
</code></pre>
<p>执行该指令后，Git 会立刻给出反馈，表明已在当前路径下初始化了一个空的 Git 仓库。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f8e397f7a7c4cf4a3a15be3989bbcff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=P%2FY7pES7F7L7VB5amclznTQjehs%3D" alt="image.png" loading="lazy"/></p>
<p>此时，虽然文件夹看起来没有什么变化，但如果开启隐藏文件显示，会发现当前目录下多了一个名为 <code>.git</code> 的隐藏目录。这个目录是 Git 的核心，它记录了版本库的所有信息。</p>
<p><strong><code>git init</code> 与 <code>git clone</code> 的深度对比</strong>
虽然两者都能获得一个 Git 仓库，但在底层逻辑和后续操作上有着本质区别。</p>
<ul>
<li>
<p><strong>git init</strong>：这就好比去文具店买了一本空白的笔记本。</p>
<ul>
<li><strong>适用场景</strong>：这是<strong>从零创建新项目</strong>的起点。当电脑上有一个文件夹（无论是空的还是刚写了几行代码），希望把它变成一个受控的 Git 仓库时使用。</li>
<li><strong>仓库状态</strong>：初始化后的仓库是<strong>全新</strong>的，没有任何提交历史（Log），它仅仅是一个拥有 <code>.git</code> 目录的空壳。</li>
<li><strong>远程连接</strong>：<strong>默认没有关联远程仓库</strong>。如果后续想要推送到 GitHub 或 Gitee，必须手动执行 <code>git remote add origin &lt;url&gt;</code> 来建立连接。</li>
<li><strong>操作流向</strong>：通常遵循 <strong>本地 -&gt; 远程</strong> (Local first) 的开发模式。</li>
</ul>
</li>
<li>
<p><strong>git clone</strong>：这类似于去复印店，把别人已经写满内容的笔记本<strong>完整复印</strong>了一份带回家。</p>
<ul>
<li><strong>适用场景</strong>：用于<strong>获取已有项目</strong>。当代码已经存在于远程服务器（如 GitHub、GitLab 或公司私有服务器）上，需要将其下载到本地进行开发或审查时使用。我个人感觉直接 <code>git clone</code> 在多人协作中更加高效，因为它省去了配置远程连接的步骤。</li>
<li><strong>仓库状态</strong>：下载下来的仓库包含<strong>完整的历史记录</strong>、所有的分支信息、标签等数据。</li>
<li><strong>远程连接</strong>：<strong>自动关联远程仓库</strong>。默认已经配置好了名为 <code>origin</code> 的远程连接，在有权限的情况下，可以直接执行 <code>git pull</code> 或 <code>git push</code>。</li>
<li><strong>操作流向</strong>：通常遵循 <strong>远程 -&gt; 本地</strong> (Remote first) 的模式。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">1.2 剖析 <code>.git</code> 目录结构</h3>
<p>理解 <code>.git</code> 目录是理解 Git 原理的关键。执行 <code>git init</code> 后，生成的这个隐藏目录并非黑盒，我们可以通过 <code>tree</code> 命令来一探究竟。</p>
<p>指令：</p>
<pre><code class="hljs language-bash" lang="bash">tree .git/
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d8dc43c30c24fda834fbf3438908518~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=2IenImE3AROmUNTFCeh%2B%2BSH5qm0%3D" alt="image.png" loading="lazy"/></p>
<p>如上图所示，<code>.git</code> 目录包含了一系列核心组件，它们共同支撑起了 Git 的版本控制功能：</p>
<ul>
<li><strong>hooks/</strong>: 存放钩子脚本（hook scripts）。Git 提供了强大的钩子机制，允许在特定的重要动作发生前后（如 commit 前、push 后）自动触发脚本。这对代码风格检查、自动部署等自动化流程至关重要。</li>
<li><strong>info/</strong>: 包含一个全局性的排除文件。如果有些文件不希望被 Git 管理，但又不想写在 <code>.gitignore</code> 文件中（以免提交给其他人），就可以写在这里。</li>
<li><strong>objects/</strong>: 这是 Git 的<strong>对象库</strong>，也是 Git 存储数据的核心区域。在 Git 的世界里，所有的文件内容、目录结构、提交信息都被抽象为“对象”（Blob 对象存储文件内容, Tree 对象存储目录结构, Commit 对象存储提交信息）。所有的历史数据都以哈希值索引的方式存储于此。</li>
<li><strong>refs/</strong>: 存储指向数据（提交对象）的指针。我们常说的“分支”和“标签”，在本质上就是存储在这个目录下的文本文件，它们的内容就是一个 Commit ID（哈希值）。</li>
<li><strong>HEAD</strong>: 这是一个非常关键的文本文件，它<strong>指向当前所在的分支</strong>。Git 通过它来知道用户当前处于哪个时间节点或哪个分支之上。</li>
<li><strong>config</strong>: 包含了项目特有的配置选项。比如这个仓库特定的远程地址、特定的用户信息等。</li>
<li><strong>description</strong>: 仅供 GitWeb 程序使用，用于显示仓库的描述信息，在日常命令行操作中较少用到。</li>
</ul>
<h2 data-id="heading-3">二、身份配置与管理</h2>
<p>在使用 Git 提交代码之前，必须先自报家门。Git 需要知道“是谁”做了这次修改，以便在历史记录中进行追溯。</p>
<h3 data-id="heading-4">2.1 本地仓库配置</h3>
<p>可以在当前仓库下单独配置用户名和邮箱，这种配置的优先级高于全局配置，但仅对当前仓库有效。</p>
<pre><code class="hljs language-shell" lang="shell">git config --global user.name 'yummy小二' 
git config --global user.email '934679045@qq.com'
</code></pre>
<p><em>注：上述命令虽然加了 <code>--global</code>，但在实际针对特定仓库配置时，应去掉 <code>--global</code> 参数。根据提供的笔记内容，这里展示的是全局配置的命令格式，但如果要在<code>.git/config</code>中生效，则不加 global。</em></p>
<p>配置信息会存储在当前项目的 <code>.git/config</code> 文件中。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/694c0816e1f4430d8ef2a2a4a8d9fa2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=tg6e3U1wKePiZwmAGFY03iWbESw%3D" alt="image.png" loading="lazy"/></p>
<p>如果需要删除本地配置，可以使用 <code>--unset</code> 参数：</p>
<pre><code class="hljs language-bash" lang="bash">git config --<span class="hljs-built_in">unset</span> user.name
git config --<span class="hljs-built_in">unset</span> user.email
</code></pre>
<h3 data-id="heading-5">2.2 全局配置</h3>
<p>在大多数开发场景下，我们希望所有仓库都使用同一套身份信息，这时就需要使用全局配置。</p>
<pre><code class="hljs language-shell" lang="shell">git config --global user.name "yummy小二"
git config --global user.email "934679045@qq.com"
</code></pre>
<p>全局配置信息存储在用户主目录下的 <code>.gitconfig</code> 文件中（例如 Linux 或 macOS 下的 <code>~/.gitconfig</code>）。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b686ffffe9674430a6a0cfe3c02d59c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=aG%2F6mow%2FWpeEhRnMsUC%2F09jkywI%3D" alt="image.png" loading="lazy"/></p>
<p>需要注意的是，针对全局配置项的删除，必须严格同时指定 <code>--global</code> 和 <code>--unset</code> 参数。如果仅使用 <code>--unset</code> 而忽略 <code>--global</code>，Git 会默认尝试在本地仓库配置中查找并删除该项，导致操作失败或不符合预期。</p>
<pre><code class="hljs language-bash" lang="bash">git config --global --<span class="hljs-built_in">unset</span> user.name
</code></pre>
<h2 data-id="heading-6">三、核心架构：Git 的三个工作区</h2>
<p>理解 Git 的三个工作区域是掌握其所有操作逻辑的前提。Git 将文件的生命周期划分为三个区域：<strong>工作区（Working Directory）</strong>、<strong>暂存区（Stage/Index）</strong> 和 <strong>版本库（Repository）</strong>。</p>
<h3 data-id="heading-7">3.1 工作区 (Working Directory)</h3>
<p>这是我们在电脑文件管理器里能看到的目录，也是开发人员实际编辑代码的地方。
首先在仓库中创建一个名为 <code>README.md</code> (自述文件) 的文件。此时，该文件仅存在于文件系统中，Git 尚未对其进行跟踪管理，它仅仅是磁盘上的一个普通文件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbc7ee10aa154a1ca2510fbb9b7dace8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=2kpw5vAKRAY%2FqCrDor84a1Dz3Jw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">3.2 暂存区 (Stage/Index)</h3>
<p>暂存区是 Git 架构中最为精妙的设计之一。它充当了工作区与版本库之间的缓冲区。
<strong>暂存区并不保存文件的完整内容，而是存储修改对象的索引</strong>。这意味着，当你把文件加入暂存区时，Git 实际上是先生成了一个对象存储文件内容，然后在暂存区的列表里记下了这个对象的指纹（哈希值）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8287fc90b1154a39a8b7ee2f732d130f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=qtcgCxtsIfsamOqyrWrzPC6PecE%3D" alt="image.png" loading="lazy"/></p>
<p>上图清晰地展示了 Git 的三层流转架构：</p>
<ul>
<li><strong>左侧为工作区</strong>：此时文件可能处于“已修改”或“未跟踪”状态。</li>
<li><strong>中间为 Stage（暂存区）</strong>：通过 <code>git add</code> 命令，工作区的修改被写入对象库，同时暂存区更新索引以指向这些新对象。</li>
<li><strong>右侧为 Master（版本库分支）</strong>：通过 <code>git commit</code> 命令，暂存区的索引树被提交到 master 分支，形成永久的历史记录。</li>
</ul>
<h3 data-id="heading-9">3.3 提交操作实战</h3>
<p>将代码保存到版本库需要两步走：</p>
<p><strong>第一步</strong>：使用 <code>git add</code> 将修改添加到暂存区。</p>
<pre><code class="hljs language-shell" lang="shell">git add .
</code></pre>
<p>这一步会将文件的快照写入 <code>.git/objects</code> 目录，并更新 <code>.git/index</code> 文件。</p>
<p><strong>第二步</strong>：使用 <code>git commit</code> 将暂存区的内容提交到当前分支（通常是 master）。</p>
<pre><code class="hljs language-shell" lang="shell">git commit -m "对提交文件的描述信息"
</code></pre>
<p>这里的 <code>-m</code> 参数用于添加提交说明（Commit Message）。这是版本回溯时的重要依据，就相当于是开发日志，记录了每次修改的目的。如果不写清楚，后续回顾历史时将寸步难行。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f9975dac1f341bba796402eec1ce4e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=rLJ4QTKzboPInrkkf92p9B76N78%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-10">四、状态追踪与历史审计</h2>
<p>随着提交次数的增加，查看历史记录和分析文件状态变得必不可少。</p>
<h3 data-id="heading-11">4.1 查看提交日志</h3>
<p>使用 <code>git log</code> 可以查看版本库的提交历史。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78b41930ac0246f7b684ffe7e41a68ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=kaIu5tlYnEUPA%2Brbq7W7ELcaIO0%3D" alt="image.png" loading="lazy"/></p>
<p>日志信息包含以下关键要素：</p>
<ul>
<li><strong>Commit</strong>: 一个 40 位的 SHA-1 哈希值。这是 Git 区别于其他版本控制系统的特征，它唯一标识一次提交，保证了数据的完整性和不可篡改性。</li>
<li><strong>Author</strong>: 提交者的姓名和邮箱，用于责任追溯。</li>
<li><strong>Date</strong>: 提交的时间戳。</li>
<li><strong>Message</strong>: 提交时填写的描述信息。</li>
</ul>
<p>为了获取更简洁的视图，可以使用 <code>--pretty=oneline</code> 参数，将每条日志压缩为一行显示：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">log</span> --pretty=oneline
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e6cf3cc847841759e21a922ce81ad3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=UH%2F3ORQ%2Bd8GCjbpRKzAvKOe5IAU%3D" alt="image.png" loading="lazy"/>
这种格式极大地节省了屏幕空间，便于快速浏览大量的版本历史。</p>
<h3 data-id="heading-12">4.2 索引与对象追踪</h3>
<p>当执行 <code>git add</code> 后，<code>.git</code> 目录下会生成或更新 <code>index</code> 文件。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43c70b1a762f44f2a29d773b15490d73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=w4bGLD3HpjhUJPJVxlwReJj%2FkUQ%3D" alt="image.png" loading="lazy"/></p>
<p><code>.git</code> 目录下的文件列表中，<code>index</code> 文件即为暂存区的实体。这再次印证了 Git 追踪管理的核心在于“修改”而非“文件”本身。每一次修改被 add 后，都会生成一个新的 Git 对象，Git 通过索引指向这些对象来构建文件系统的快照。</p>
<h3 data-id="heading-13">4.3 差异对比与状态监控</h3>
<p>在开发过程中，经常需要确认工作区所做的修改与暂存区或版本库中的内容有何不同。<code>git diff</code> 命令便是用于此目的。我们将代码上传到版本库后，通过 diff 可以清晰地看到每一行代码的增删变动，这对于代码审查（Code Review）至关重要。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1914f42e27dd4bb698c43d64b7a0012e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=HzivtlR2lCdZfWq3dFEsI9eVrJs%3D" alt="image.png" loading="lazy"/></p>
<p>同时，<code>git status</code> 命令是日常开发中使用频率最高的命令之一，用于查看工作区、暂存区与本地仓库之间的状态同步情况。</p>
<pre><code class="hljs language-bash" lang="bash">git status
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b5d6e6cc7ee40e4aa8609e30a4712c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=u4AaIxFB42jRHGDrjJfEOq04UdY%3D" alt="image.png" loading="lazy"/>
通过 <code>git status</code>，我们可以随时知道哪些文件被修改了但还没暂存，哪些文件已暂存但还没提交。</p>
<h2 data-id="heading-14">五、版本回退机制</h2>
<p>版本回退是 Git 最强大的功能之一，允许开发者在历史版本之间自由穿梭，提供了极大的容错空间。其核心命令是 <code>git reset</code>。</p>
<h3 data-id="heading-15">5.1 回退原理与参数详解</h3>
<p><code>git reset</code> 的本质是移动 <code>HEAD</code> 指针，并根据参数决定是否更新暂存区和工作区。<code>HEAD</code> 指向当前分支的最新提交，通过改变 <code>HEAD</code> 的指向，即可实现版本库的回退。</p>
<p>该命令有三个核心参数，对应不同的回退深度：</p>
<pre><code class="hljs language-bash" lang="bash">git reset [--soft | --mixed | --hard] [HEAD]
</code></pre>
<p>为了理解这三个参数，我们需要建立一个概念模型：</p>
<ul>
<li><strong>git</strong> 代表旧版本的内容（回退的目标）。</li>
<li><strong>git world</strong> 代表新版本的内容（当前尚未提交或刚提交的内容）。</li>
</ul>








































<table><thead><tr><th align="left">工作区 (Working Dir)</th><th align="left">暂存区 (Staging Area)</th><th align="left">版本库 (Repository)</th><th align="left">参数选项</th><th align="left">深度解析</th></tr></thead><tbody><tr><td align="left"><strong>git world</strong></td><td align="left"><strong>git world</strong></td><td align="left"><strong>git world</strong></td><td align="left">(起始状态)</td><td align="left">三个区域内容一致，通常是刚 commit 完的状态。</td></tr><tr><td align="left"><strong>git world</strong></td><td align="left"><strong>git world</strong></td><td align="left"><strong>git</strong></td><td align="left"><code>--soft</code></td><td align="left"><strong>软重置</strong>。仅回退版本库的 HEAD 指针。暂存区和工作区保留当前修改。这意味着刚才提交的内容回到了“已 add 但未 commit”的状态。常用于修正上一次提交的 Message 或合并多个提交。</td></tr><tr><td align="left"><strong>git world</strong></td><td align="left"><strong>git</strong></td><td align="left"><strong>git</strong></td><td align="left"><code>--mixed</code></td><td align="left"><strong>混合重置（默认）</strong>。回退版本库和暂存区。仅保留工作区的修改。这意味着刚才提交的内容回到了“已修改但未 add”的状态。</td></tr><tr><td align="left"><strong>git</strong></td><td align="left"><strong>git</strong></td><td align="left"><strong>git</strong></td><td align="left"><code>--hard</code></td><td align="left"><strong>硬重置</strong>。彻底回退。版本库、暂存区、工作区全部还原为旧版本。这是毁灭性的操作，工作区中未提交的代码将永久丢失，无法找回。使用前必须确认当前工作区无重要未备份代码。</td></tr></tbody></table>
<h3 data-id="heading-16">5.2 版本回退实战</h3>
<p>假设当前 <code>README.md</code> 经历了多次修改和提交，存在两个版本。通过 <code>git log</code> 查看当前的提交历史，可见存在两次提交记录。现在需要回退到上一个版本。</p>
<p>执行硬重置命令，指定目标版本的 Commit ID（或使用 <code>HEAD^</code>）：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c66d42efe1f5434ba7f46eb95a362505~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=NWl7UN2H4vthyaKfExK20oNtTwA%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash">git reset --hard 4de2ec06ec660056f50a1efd1778cec2f5ffbf8d
</code></pre>
<p>执行后，再次查看状态：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f9474f4e8b846f79c2a9f29aa9f82a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=PrI6svPl%2FdPi2R96v1iQIIyzPlA%3D" alt="image.png" loading="lazy"/>
<code>HEAD</code> 已经指向了指定的提交，系统提示 <code>HEAD is now at...</code>。
这里需要深入理解的是，虽然我们常说“回退”，但 Git 的本质是<strong>指针移动</strong>。<code>git reset</code> 实际上是让 <code>HEAD</code> 指针指向了旧的 Commit 对象，同时根据参数（如 <code>--hard</code>）强制刷新了暂存区和工作区，使其与该 Commit 的内容保持一致。</p>
<h3 data-id="heading-17">5.3 Reflog：后悔药机制</h3>
<p>如果执行了 <code>git reset --hard</code> 后发现“回退错了”，普通的 <code>git log</code> 已经无法查看到那个被丢弃的 Commit ID 了。此时，Git 提供了一剂“后悔药” —— <code>git reflog</code>。</p>
<p><code>git reflog</code> 记录了 HEAD 指针的所有移动历史，包括 reset、commit、checkout 等操作。它保留了操作的短哈希值。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23dc0af55144417184bc571399f5e2b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=MjDwCx7oTpptKzVNVd51cndHvQ8%3D" alt="image.png" loading="lazy"/></p>
<p>如上图所示，可以看见 HEAD 曾经指向的位置。只要找到那个“未来的版本”的哈希值，依然可以执行 <code>git reset --hard</code> 跳回去，从而实现“反悔”。这说明 Git 的版本回退在本质上是通过哈希值在时间轴上的任意跳转。</p>
<h2 data-id="heading-18">六、撤销修改操作</h2>
<p>在开发过程中，针对不同阶段的错误修改，Git 提供了不同层级的撤销方案。</p>
<h3 data-id="heading-19">场景一：仅撤销工作区代码</h3>
<p>当修改了文件但尚未执行 <code>git add</code> 时，文件修改仅存在于工作区。
例如，对 <code>README.md</code> 进行了一行错误的修改。若要丢弃该修改，恢复到最近一次 add 或 commit 的状态，使用以下命令：</p>
<pre><code class="hljs language-bash" lang="bash">git checkout -- README.md
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0455423bab3495db27834e9765bd085~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=Fp%2FJ%2FICKGkSA8nyR84DYjVsgG0A%3D" alt="image.png" loading="lazy"/>
执行该命令意味着，之前的修改彻底消失了。这主要用于拉取了版本库代码后，在本地进行调试或尝试性修改，最终发现思路错误，想要一键还原的场景。一般建议最好另外开启一个分支或文件夹进行实验，而不是直接在主项目上操作。
<em>注意：<code>--</code> 后面需要有空格，这是为了防止文件名与分支名混淆。</em></p>
<h3 data-id="heading-20">场景二：撤销工作区与暂存区代码</h3>
<p>当修改文件后已经执行了 <code>git add</code>，此时修改已进入暂存区。要撤销需要分两步走。</p>
<p><strong>第一步</strong>：将文件从暂存区移出，放回工作区。使用默认的 <code>git reset</code>（相当于 <code>--mixed</code>）：</p>
<pre><code class="hljs language-bash" lang="bash">git reset HEAD AIGameDemo.cpp
</code></pre>
<p>HEAD 表示当前版本。如果要回退到上一个版本使用 <code>HEAD^</code>，上两个版本使用 <code>HEAD^^</code>。
执行后，暂存区被清空，修改回到了工作区。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0190c61d6ca344e992f6072b813db5c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=Y641YfFsGyFpLwPH9Y0sw4MQ%2FNM%3D" alt="image.png" loading="lazy"/>
状态变为 <code>Changes not staged for commit</code>，验证了撤销暂存区的操作成功。</p>
<p><strong>第二步</strong>：继续处理工作区的残留修改，将其彻底丢弃：</p>
<pre><code class="hljs language-bash" lang="bash">git checkout -- AIGameDemo.cpp
</code></pre>
<p>此时工作区也恢复干净，所有修改均已被撤销。</p>
<h3 data-id="heading-21">场景三：全链路回退（工作区、暂存区、版本库）</h3>
<p>当修改已经 commit 到了本地版本库，但尚未 push 到远程仓库时，可以通过版本回退来撤销本次提交。</p>
<p>首先制造一个已提交的状态：修改文件 -&gt; add -&gt; commit。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bac63bfe354413abfa0f242fa51043a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=3Adu32%2Flmq9ldNx9wDyff7E%2FMk8%3D" alt="image.png" loading="lazy"/>
此时三个区域都包含该修改。为了彻底消除这次提交的影响，使用 <code>--hard</code> 模式：</p>
<pre><code class="hljs language-bash" lang="bash">git reset --hard HEAD^
</code></pre>
<p><code>HEAD^</code> 指向当前版本的父版本（上一个版本）。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eaa3480822e484ea393f292a41c0bc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=rSKpxTMqE2khXQS2f26dGd7rL2c%3D" alt="image.png" loading="lazy"/>
<strong>必须再次强调，前提是该提交尚未推送到远程仓库。</strong> 如果代码已经推送到远程，使用 <code>reset</code> 强行回退并强制推送（force push）可能会导致多人协作时的版本冲突，造成严重的团队事故。</p>
<h2 data-id="heading-22">七、文件的删除与恢复</h2>
<p>在 Git 中，删除文件不仅仅是删除磁盘上的文件，还需要更新暂存区和版本库的记录，这是一个完整的事务。</p>
<h3 data-id="heading-23">7.1 常规删除流程</h3>
<p>假设仓库中存在 <code>file1</code> 文件。如果在文件管理器或使用系统命令 <code>rm</code> 删除了该文件，Git 会检测到工作区的变化。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32ea4125f09249bcba5b66b082aef23f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv5bqX5bCP5LqM5ZGA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770458293&amp;x-signature=Ic7ILPhKy9T5J1l%2Fp3x1FpjRhnU%3D" alt="image.png" loading="lazy"/>
上图显示 <code>file</code> 处于 <code>deleted</code> 状态，但这仅仅是工作区的变动。为了确认删除，需要执行 <code>git add</code> 将删除操作暂存：</p>
<pre><code class="hljs language-bash" lang="bash">git add file
</code></pre>
<p>此时 Git 知道这个文件被删除了。最后提交到版本库：</p>
<pre><code class="hljs language-bash" lang="bash">git commit -m <span class="hljs-string">"delete file"</span>
</code></pre>
<p>这样才算完成了一次完整的删除提交。</p>
<h3 data-id="heading-24">7.2 高效删除命令 <code>git rm</code></h3>
<p>Git 提供了 <code>git rm</code> 命令，将上述的“删除工作区文件”和“暂存删除操作”合并为一步。</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">rm</span> file
</code></pre>
<p>执行该命令后，文件会直接从磁盘删除，并且该删除操作会被立即放入暂存区。执行后无需再次 <code>git add</code>，直接进行 <code>git commit</code> 即可完成整个删除流程。这种方式更加简洁高效，是管理文件删除的推荐做法。</p>
<h3 data-id="heading-25">7.3 误删恢复</h3>
<p>如果是不小心删错了文件，想要找回来，可以使用 <code>restore</code> 命令（这是新版 Git 推荐用来替代 checkout 处理文件的命令）。</p>
<p><strong>情况 A：文件仅在工作区被删，尚未 add</strong></p>
<pre><code class="hljs language-bash" lang="bash">git restore file
</code></pre>
<p>这将从暂存区（index）恢复文件到工作区。</p>
<p><strong>情况 B：文件已被删，且已 add 到暂存区</strong>
此时查看状态，会显示绿色的 <code>deleted: file</code>。
我们需要先将这个“删除操作”从暂存区撤回：</p>
<pre><code class="hljs language-bash" lang="bash">git restore --staged file
</code></pre>
<p>执行完这句后，文件状态变回工作区被删（红色的 deleted）。接着再执行：</p>
<pre><code class="hljs language-bash" lang="bash">git restore file
</code></pre>
<p>文件就会奇迹般地回到文件夹中。这里体现了 Git 对文件状态的精细控制能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Pandas 入门指南]]></title>    <link>https://juejin.cn/post/7600989427906609206</link>    <guid>https://juejin.cn/post/7600989427906609206</guid>    <pubDate>2026-01-31T08:08:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600989427906609206" data-draft-id="7600999271770570752" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Pandas 入门指南"/> <meta itemprop="keywords" content="Python,pandas"/> <meta itemprop="datePublished" content="2026-01-31T08:08:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小张说故事"/> <meta itemprop="url" content="https://juejin.cn/user/741501567509111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Pandas 入门指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/741501567509111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小张说故事
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T08:08:25.000Z" title="Sat Jan 31 2026 08:08:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 库的概览与核心价值</h2>
<p>想象一下，在数据分析工作中，如果你需要处理百万行 Excel 表格、清洗杂乱的数据、计算复杂的统计指标，就像用一把小勺子在挖土堆，不仅效率低下还容易出错。<code>Pandas</code> 正是为解决这个痛点而生的工具——它是 Python 数据分析领域的"瑞士军刀"。</p>
<p>Pandas 是基于 NumPy 构建的开源数据分析库，专门用于处理结构化数据。它填补了 NumPy 在处理非数值数据和混合类型数据方面的空白，让数据分析变得像操作 Excel 表格一样简单直观，同时具备处理大规模数据的高性能。</p>
<p>在 Python 数据科学生态中，Pandas 处于核心地位：上游连接数据源（CSV、Excel、SQL、JSON 等多种格式），下游衔接 NumPy（数值计算）、Matplotlib（可视化）和 Scikit-learn（机器学习）。掌握了 Pandas，你就拥有了从数据获取到建模准备的全流程能力。</p>
<h2 data-id="heading-1">2. 环境搭建与 "Hello, World"</h2>
<h3 data-id="heading-2">安装 Pandas</h3>
<p>Pandas 的安装非常简单，支持多种安装方式：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式1：使用 pip 安装（推荐）</span>
pip install pandas

<span class="hljs-comment"># 方式2：使用 conda 安装</span>
conda install pandas

<span class="hljs-comment"># 国内用户可使用镜像源加速</span>
pip install pandas -i https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre>
<p>安装完成后，在 Python 环境中导入并验证：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入 pandas（约定俗成使用 pd 作为别名）</span>
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-comment"># 打印版本号（确保安装成功）</span>
<span class="hljs-built_in">print</span>(pd.__version__)  <span class="hljs-comment"># 输出版本号，如 2.3.0</span>
</code></pre>
<h3 data-id="heading-3">Hello World 示例</h3>
<p>让我们通过一个简单的示例来体验 Pandas 的核心功能：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd

<span class="hljs-comment"># 创建一个简单的字典数据</span>
data = {
    <span class="hljs-string">'姓名'</span>: [<span class="hljs-string">'张三'</span>, <span class="hljs-string">'李四'</span>, <span class="hljs-string">'王五'</span>],
    <span class="hljs-string">'年龄'</span>: [<span class="hljs-number">25</span>, <span class="hljs-number">30</span>, <span class="hljs-number">28</span>],
    <span class="hljs-string">'城市'</span>: [<span class="hljs-string">'北京'</span>, <span class="hljs-string">'上海'</span>, <span class="hljs-string">'广州'</span>]
}

<span class="hljs-comment"># 将字典转换为 DataFrame（表格）</span>
df = pd.DataFrame(data)

<span class="hljs-comment"># 打印结果</span>
<span class="hljs-built_in">print</span>(df)
</code></pre>
<p><strong>逐行解释</strong>：</p>
<ul>
<li><code>import pandas as pd</code>：导入 Pandas 库，使用 <code>pd</code> 作为别名，这是 Python 社区的约定</li>
<li><code>data = {...}</code>：创建一个字典，包含姓名、年龄、城市三个字段的数据</li>
<li><code>df = pd.DataFrame(data)</code>：将字典转换为 <code>DataFrame</code> 对象，这是 Pandas 的核心数据结构，类似 Excel 表格</li>
<li><code>print(df)</code>：输出表格内容</li>
</ul>
<p><strong>运行结果</strong>：</p>
<pre><code class="hljs">   姓名  年龄   城市
0  张三  25  北京
1  李四  30  上海
2  王五  28  广州
</code></pre>
<p>看到这个结果，你可能已经发现了 Pandas 的优势：它自动为数据添加了行索引（0, 1, 2），并以整齐的表格形式展示数据，比 Python 原生的列表或字典直观得多。</p>
<h2 data-id="heading-4">3. 核心概念解析</h2>
<p>Pandas 的两大核心数据结构是 <code>Series</code>（一维序列）和 <code>DataFrame</code>（二维表格）。理解它们的区别和联系是掌握 Pandas 的关键。</p>
<h3 data-id="heading-5">Series：一维带标签数组</h3>
<p><code>Series</code> 是一个一维的带标签数组，可以理解为"带索引的列表"。每个元素都有一个对应的索引标签，默认是 0 开始的整数，也可以自定义。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建 Series</span>
s = pd.Series([<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">30</span>], index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>], name=<span class="hljs-string">'数值'</span>)
<span class="hljs-built_in">print</span>(s)
</code></pre>
<p>输出：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span>    <span class="hljs-number">10</span>
<span class="hljs-selector-tag">b</span>    <span class="hljs-number">20</span>
c    <span class="hljs-number">30</span>
Name: 数值, dtype: int64
</code></pre>
<p><strong>核心属性</strong>：</p>
<ul>
<li><code>values</code>：获取数据值（返回 NumPy 数组）</li>
<li><code>index</code>：获取索引标签</li>
<li><code>dtype</code>：数据类型（如 int64、float64、object 等）</li>
</ul>
<h3 data-id="heading-6">DataFrame：二维表格型数据</h3>
<p><code>DataFrame</code> 是二维的表格结构，可以理解为"多个 Series 按列组合而成"。它既有行索引也有列索引，类似 Excel 表格或数据库表。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 从字典创建 DataFrame</span>
data = {
    <span class="hljs-string">'姓名'</span>: [<span class="hljs-string">'张三'</span>, <span class="hljs-string">'李四'</span>, <span class="hljs-string">'王五'</span>],
    <span class="hljs-string">'年龄'</span>: [<span class="hljs-number">25</span>, <span class="hljs-number">30</span>, <span class="hljs-number">28</span>],
    <span class="hljs-string">'薪资'</span>: [<span class="hljs-number">15000</span>, <span class="hljs-number">20000</span>, <span class="hljs-number">18000</span>]
}
df = pd.DataFrame(data)
<span class="hljs-built_in">print</span>(df)
</code></pre>
<p>输出：</p>
<pre><code class="hljs">   姓名  年龄   薪资
0  张三  25  15000
1  李四  30  20000
2  王五  28  18000
</code></pre>
<p><strong>核心属性</strong>：</p>
<ul>
<li><code>shape</code>：数据维度（行数，列数）</li>
<li><code>columns</code>：列名（类似索引）</li>
<li><code>index</code>：行索引</li>
<li><code>values</code>：底层数据数组</li>
</ul>
<h3 data-id="heading-7">概念关系图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[NumPy数组] --&gt; B[Series 一维序列]
    B --&gt; C[DataFrame 二维表格]
    C --&gt; D[数据分析操作]
    C --&gt; E[数据可视化]
    C --&gt; F[机器学习]
    
    B -.-&gt;|组合成| C
    C -.-&gt;|提取为| B
    
    style B fill:#e1f5ff
    style C fill:#ffe1e1
</code></pre>
<p>这个图展示了 Pandas 的数据结构层级关系：</p>
<ul>
<li><code>Series</code> 基于 NumPy 数组构建，增加了标签索引功能</li>
<li><code>DataFrame</code> 由多个 <code>Series</code> 按列组合而成</li>
<li>从 <code>DataFrame</code> 中提取单列会返回 <code>Series</code></li>
<li><code>Series</code> 可以通过 <code>to_frame()</code> 方法转换为 <code>DataFrame</code></li>
</ul>
<p><strong>关键特性</strong>：</p>
<ul>
<li><strong>索引对齐</strong>：Pandas 运算时自动按索引对齐，即使顺序不同也能正确计算</li>
<li><strong>缺失值处理</strong>：自动识别和处理 <code>NaN</code>（Not a Number）缺失值</li>
<li><strong>灵活的数据类型</strong>：支持数值、字符串、日期等多种数据类型</li>
<li><strong>向量化操作</strong>：类似 NumPy，支持高效的向量化运算</li>
</ul>
<h2 data-id="heading-8">4. 实战演练：解决一个典型问题</h2>
<p>让我们通过一个完整的实战项目来体验 Pandas 的强大功能。假设我们有一份销售数据，需要进行分析和统计。</p>
<h3 data-id="heading-9">需求分析</h3>
<p>我们有某公司 2024 年上半年的销售数据，需要完成以下任务：</p>
<ol>
<li>查看数据概况</li>
<li>筛选高销售额订单</li>
<li>按月份统计销售总额</li>
<li>找出最佳销售员</li>
</ol>
<h3 data-id="heading-10">方案设计</h3>
<p>我们将使用 Pandas 的以下功能：</p>
<ul>
<li>数据读取：从 CSV 读取数据</li>
<li>数据查看：<code>head()</code>、<code>info()</code>、<code>describe()</code></li>
<li>数据筛选：布尔索引</li>
<li>数据分组：<code>groupby()</code> + 聚合函数</li>
<li>数据排序：<code>sort_values()</code></li>
</ul>
<h3 data-id="heading-11">代码实现</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-comment"># 步骤1：创建模拟销售数据</span>
data = {
    <span class="hljs-string">'日期'</span>: pd.to_datetime([<span class="hljs-string">'2024-01-15'</span>, <span class="hljs-string">'2024-01-20'</span>, <span class="hljs-string">'2024-02-10'</span>, <span class="hljs-string">'2024-02-25'</span>, 
                           <span class="hljs-string">'2024-03-05'</span>, <span class="hljs-string">'2024-03-18'</span>, <span class="hljs-string">'2024-04-12'</span>, <span class="hljs-string">'2024-04-28'</span>,
                           <span class="hljs-string">'2024-05-08'</span>, <span class="hljs-string">'2024-05-22'</span>, <span class="hljs-string">'2024-06-05'</span>, <span class="hljs-string">'2024-06-18'</span>]),
    <span class="hljs-string">'销售员'</span>: [<span class="hljs-string">'张三'</span>, <span class="hljs-string">'李四'</span>, <span class="hljs-string">'王五'</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-string">'李四'</span>, <span class="hljs-string">'王五'</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-string">'李四'</span>, <span class="hljs-string">'王五'</span>, <span class="hljs-string">'张三'</span>, <span class="hljs-string">'李四'</span>, <span class="hljs-string">'王五'</span>],
    <span class="hljs-string">'产品'</span>: [<span class="hljs-string">'产品A'</span>, <span class="hljs-string">'产品B'</span>, <span class="hljs-string">'产品A'</span>, <span class="hljs-string">'产品C'</span>, <span class="hljs-string">'产品B'</span>, <span class="hljs-string">'产品A'</span>, <span class="hljs-string">'产品C'</span>, <span class="hljs-string">'产品B'</span>, <span class="hljs-string">'产品A'</span>, <span class="hljs-string">'产品C'</span>, <span class="hljs-string">'产品B'</span>, <span class="hljs-string">'产品A'</span>],
    <span class="hljs-string">'销售额'</span>: [<span class="hljs-number">15000</span>, <span class="hljs-number">20000</span>, <span class="hljs-number">18000</span>, <span class="hljs-number">25000</span>, <span class="hljs-number">22000</span>, <span class="hljs-number">16000</span>, <span class="hljs-number">28000</span>, <span class="hljs-number">24000</span>, <span class="hljs-number">19000</span>, <span class="hljs-number">30000</span>, <span class="hljs-number">26000</span>, <span class="hljs-number">17000</span>]
}

<span class="hljs-comment"># 创建 DataFrame</span>
df = pd.DataFrame(data)

<span class="hljs-comment"># 步骤2：查看数据概况</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 数据概况 ==="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据形状：<span class="hljs-subst">{df.shape}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n前5行数据：\n<span class="hljs-subst">{df.head()}</span>"</span>)

<span class="hljs-comment"># 步骤3：计算基本统计信息</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 销售额统计 ==="</span>)
<span class="hljs-built_in">print</span>(df[<span class="hljs-string">'销售额'</span>].describe())

<span class="hljs-comment"># 步骤4：筛选高销售额订单（&gt;20000）</span>
high_sales = df[df[<span class="hljs-string">'销售额'</span>] &gt; <span class="hljs-number">20000</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 高销售额订单（&gt;20000）==="</span>)
<span class="hljs-built_in">print</span>(high_sales[[<span class="hljs-string">'销售员'</span>, <span class="hljs-string">'产品'</span>, <span class="hljs-string">'销售额'</span>]])

<span class="hljs-comment"># 步骤5：按月份统计销售总额</span>
df[<span class="hljs-string">'月份'</span>] = df[<span class="hljs-string">'日期'</span>].dt.to_period(<span class="hljs-string">'M'</span>)
monthly_sales = df.groupby(<span class="hljs-string">'月份'</span>)[<span class="hljs-string">'销售额'</span>].<span class="hljs-built_in">sum</span>()
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 月度销售总额 ==="</span>)
<span class="hljs-built_in">print</span>(monthly_sales)

<span class="hljs-comment"># 步骤6：统计各销售员的总销售额</span>
salesman_total = df.groupby(<span class="hljs-string">'销售员'</span>)[<span class="hljs-string">'销售额'</span>].<span class="hljs-built_in">sum</span>().sort_values(ascending=<span class="hljs-literal">False</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 销售员业绩排名 ==="</span>)
<span class="hljs-built_in">print</span>(salesman_total)

<span class="hljs-comment"># 步骤7：找出最佳销售员</span>
best_salesman = salesman_total.index[<span class="hljs-number">0</span>]
best_total = salesman_total.iloc[<span class="hljs-number">0</span>]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n最佳销售员是：<span class="hljs-subst">{best_salesman}</span>，总销售额：<span class="hljs-subst">{best_total:,}</span>"</span>)
</code></pre>
<h3 data-id="heading-12">运行说明</h3>
<p>将上述代码保存为 <code>.py</code> 文件并运行，你会看到如下输出：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">===</span> <span class="hljs-string">数据概况</span> <span class="hljs-string">===</span>
<span class="hljs-string">数据形状：(12,</span> <span class="hljs-number">4</span><span class="hljs-string">)</span>

<span class="hljs-string">前5行数据：</span>
        <span class="hljs-string">日期</span> <span class="hljs-string">销售员</span>   <span class="hljs-string">产品</span>   <span class="hljs-string">销售额</span>
<span class="hljs-number">0</span> <span class="hljs-number">2024-01-15</span>  <span class="hljs-string">张三</span>  <span class="hljs-string">产品A</span>  <span class="hljs-number">15000</span>
<span class="hljs-number">1</span> <span class="hljs-number">2024-01-20</span>  <span class="hljs-string">李四</span>  <span class="hljs-string">产品B</span>  <span class="hljs-number">20000</span>
<span class="hljs-number">2</span> <span class="hljs-number">2024-02-10</span>  <span class="hljs-string">王五</span>  <span class="hljs-string">产品A</span>  <span class="hljs-number">18000</span>
<span class="hljs-number">3</span> <span class="hljs-number">2024-02-25</span>  <span class="hljs-string">张三</span>  <span class="hljs-string">产品C</span>  <span class="hljs-number">25000</span>
<span class="hljs-number">4</span> <span class="hljs-number">2024-03-05</span>  <span class="hljs-string">李四</span>  <span class="hljs-string">产品B</span>  <span class="hljs-number">22000</span>

<span class="hljs-string">===</span> <span class="hljs-string">销售额统计</span> <span class="hljs-string">===</span>
<span class="hljs-string">count</span>       <span class="hljs-number">12.000000</span>
<span class="hljs-string">mean</span>     <span class="hljs-number">21833.333333</span>
<span class="hljs-string">std</span>       <span class="hljs-number">4783.921287</span>
<span class="hljs-string">min</span>      <span class="hljs-number">15000.000000</span>
<span class="hljs-number">25</span><span class="hljs-string">%</span>      <span class="hljs-number">18250.000000</span>
<span class="hljs-number">50</span><span class="hljs-string">%</span>      <span class="hljs-number">21500.000000</span>
<span class="hljs-number">75</span><span class="hljs-string">%</span>      <span class="hljs-number">25500.000000</span>
<span class="hljs-string">max</span>      <span class="hljs-number">30000.000000</span>
<span class="hljs-attr">Name:</span> <span class="hljs-string">销售额,</span> <span class="hljs-attr">dtype:</span> <span class="hljs-string">float64</span>

<span class="hljs-string">===</span> <span class="hljs-string">高销售额订单（&gt;20000）===</span>
   <span class="hljs-string">销售员</span>   <span class="hljs-string">产品</span>   <span class="hljs-string">销售额</span>
<span class="hljs-number">3</span>   <span class="hljs-string">张三</span>  <span class="hljs-string">产品C</span>  <span class="hljs-number">25000</span>
<span class="hljs-number">4</span>   <span class="hljs-string">李四</span>  <span class="hljs-string">产品B</span>  <span class="hljs-number">22000</span>
<span class="hljs-number">6</span>   <span class="hljs-string">张三</span>  <span class="hljs-string">产品C</span>  <span class="hljs-number">28000</span>
<span class="hljs-number">7</span>   <span class="hljs-string">李四</span>  <span class="hljs-string">产品B</span>  <span class="hljs-number">24000</span>
<span class="hljs-number">9</span>   <span class="hljs-string">张三</span>  <span class="hljs-string">产品C</span>  <span class="hljs-number">30000</span>
<span class="hljs-number">10</span>  <span class="hljs-string">李四</span>  <span class="hljs-string">产品B</span>  <span class="hljs-number">26000</span>

<span class="hljs-string">===</span> <span class="hljs-string">月度销售总额</span> <span class="hljs-string">===</span>
<span class="hljs-string">月份</span>
<span class="hljs-number">2024-01    </span><span class="hljs-number">35000</span>
<span class="hljs-number">2024-02    </span><span class="hljs-number">43000</span>
<span class="hljs-number">2024-03    </span><span class="hljs-number">38000</span>
<span class="hljs-number">2024-04    </span><span class="hljs-number">52000</span>
<span class="hljs-number">2024-05    </span><span class="hljs-number">49000</span>
<span class="hljs-number">2024-06    </span><span class="hljs-number">43000</span>
<span class="hljs-attr">Freq:</span> <span class="hljs-string">M,</span> <span class="hljs-attr">Name:</span> <span class="hljs-string">销售额,</span> <span class="hljs-attr">dtype:</span> <span class="hljs-string">int64</span>

<span class="hljs-string">===</span> <span class="hljs-string">销售员业绩排名</span> <span class="hljs-string">===</span>
<span class="hljs-string">销售员</span>
<span class="hljs-string">张三</span>    <span class="hljs-number">98000</span>
<span class="hljs-string">李四</span>    <span class="hljs-number">92000</span>
<span class="hljs-string">王五</span>    <span class="hljs-number">70000</span>
<span class="hljs-attr">Name:</span> <span class="hljs-string">销售额,</span> <span class="hljs-attr">dtype:</span> <span class="hljs-string">int64</span>

<span class="hljs-string">最佳销售员是：张三，总销售额：98,000</span>
</code></pre>
<h3 data-id="heading-13">结果分析</h3>
<p>通过这个实战案例，我们完成了：</p>
<ol>
<li><strong>数据创建与查看</strong>：使用字典创建 DataFrame，用 <code>head()</code> 快速预览</li>
<li><strong>统计分析</strong>：用 <code>describe()</code> 获得销售额的全面统计（均值、最值、标准差等）</li>
<li><strong>数据筛选</strong>：用布尔索引 <code>df['销售额'] &gt; 20000</code> 筛选高价值订单</li>
<li><strong>时间序列处理</strong>：用 <code>dt.to_period('M')</code> 提取月份</li>
<li><strong>分组聚合</strong>：用 <code>groupby()</code> + <code>sum()</code> 按月份和销售员统计</li>
<li><strong>数据排序</strong>：用 <code>sort_values()</code> 找出业绩最好的销售员</li>
</ol>
<p>这个项目涵盖了 Pandas 最核心的操作流程，展示了如何用简洁的代码完成复杂的数据分析任务。</p>
<h2 data-id="heading-14">5. 最佳实践与常见陷阱</h2>
<h3 data-id="heading-15">常见错误及规避方法</h3>
<p><strong>错误 1：链式赋值导致 SettingWithCopyWarning</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ❌ 错误做法</span>
df[df[<span class="hljs-string">'年龄'</span>] &gt; <span class="hljs-number">30</span>][<span class="hljs-string">'薪资'</span>] = <span class="hljs-number">0</span>  <span class="hljs-comment"># 可能报警告，且不会生效</span>

<span class="hljs-comment"># ✅ 正确做法</span>
df.loc[df[<span class="hljs-string">'年龄'</span>] &gt; <span class="hljs-number">30</span>, <span class="hljs-string">'薪资'</span>] = <span class="hljs-number">0</span>  <span class="hljs-comment"># 使用 loc 直接修改</span>
</code></pre>
<p><strong>错误 2：混淆 iloc 和 loc</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ❌ 错误做法</span>
df[<span class="hljs-number">0</span>:<span class="hljs-number">3</span>, <span class="hljs-string">'姓名'</span>]  <span class="hljs-comment"># 语法错误，不能同时用位置和标签</span>

<span class="hljs-comment"># ✅ 正确做法</span>
df.iloc[<span class="hljs-number">0</span>:<span class="hljs-number">3</span>][<span class="hljs-string">'姓名'</span>]  <span class="hljs-comment"># 按位置选择</span>
df.loc[<span class="hljs-number">0</span>:<span class="hljs-number">2</span>, <span class="hljs-string">'姓名'</span>]    <span class="hljs-comment"># 按标签选择</span>
</code></pre>
<p><strong>错误 3：忘记处理缺失值</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ❌ 错误做法</span>
df[<span class="hljs-string">'年龄'</span>].mean()  <span class="hljs-comment"># 如果有 NaN，结果也是 NaN</span>

<span class="hljs-comment"># ✅ 正确做法</span>
df[<span class="hljs-string">'年龄'</span>].fillna(<span class="hljs-number">0</span>).mean()  <span class="hljs-comment"># 先填充再计算</span>
<span class="hljs-comment"># 或</span>
df[<span class="hljs-string">'年龄'</span>].mean(skipna=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 跳过缺失值</span>
</code></pre>
<h3 data-id="heading-16">最佳实践建议</h3>
<ol>
<li><strong>使用高效数据类型</strong>：对于大型数据集，将整数列从 <code>int64</code> 降级为 <code>int32</code> 可节省 50% 内存</li>
<li><strong>优先使用向量化操作</strong>：避免用 <code>for</code> 循环处理数据，向量化操作快 10-100 倍</li>
<li><strong>分块读取大文件</strong>：处理千万级数据时，用 <code>read_csv(chunksize=100000)</code> 分块加载</li>
<li><strong>显式创建副本</strong>：修改筛选后的数据时，用 <code>copy()</code> 避免链式赋值警告</li>
<li><strong>统一时间格式</strong>：日期数据尽早转为 <code>datetime</code> 类型，便于后续时间序列分析</li>
</ol>
<h2 data-id="heading-17">6. 进阶指引</h2>
<p>Pandas 的功能远不止于此，掌握基础后你可以继续探索：</p>
<p><strong>高级功能</strong>：</p>
<ul>
<li>时间序列分析：强大的日期处理和时间窗口操作</li>
<li>数据透视表：<code>pivot_table()</code> 实现复杂的数据重组</li>
<li>多表合并：<code>merge()</code>、<code>join()</code>、<code>concat()</code> 实现类似 SQL 的连接操作</li>
<li>性能优化：使用 <code>eval()</code>、<code>query()</code> 加速复杂计算</li>
</ul>
<p><strong>生态扩展</strong>：</p>
<ul>
<li><strong>数据可视化</strong>：集成 Matplotlib、Seaborn 快速绘图</li>
<li><strong>大数据处理</strong>：Dask、Modin 扩展 Pandas 处理能力到 TB 级数据</li>
<li><strong>机器学习</strong>：与 Scikit-learn 无缝衔接，用于特征工程</li>
</ul>
<p><strong>学习路径</strong>：</p>
<ol>
<li>掌握 Series/DataFrame 基础操作（创建、选择、筛选）</li>
<li>熟练数据清洗（缺失值、重复值、类型转换）</li>
<li>深入数据聚合与分组分析</li>
<li>学习时间序列和多表合并</li>
<li>探索性能优化和高级特性</li>
</ol>
<p><strong>推荐资源</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpandas.pydata.org%2Fdocs%2F" target="_blank" title="https://pandas.pydata.org/docs/" ref="nofollow noopener noreferrer">Pandas 官方文档</a>（最权威的参考）</li>
<li>《Python for Data Analysis》by Wes McKinney（Pandas 创始人的经典著作）</li>
<li>Kaggle Learn 的 Pandas 课程（免费实战教程）</li>
<li>实战项目：从真实数据集（如泰坦尼克号、房价预测）开始练习</li>
</ul>
<p>掌握 Pandas 是数据分析师的必备技能，它能让你的数据分析工作从"手工操作"升级为"自动化处理"，效率提升何止十倍！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始打造你的第一个AI智能体（Agent）——小白入门实战指南]]></title>    <link>https://juejin.cn/post/7601020578490581001</link>    <guid>https://juejin.cn/post/7601020578490581001</guid>    <pubDate>2026-01-31T07:17:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601020578490581001" data-draft-id="7601077764423254066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始打造你的第一个AI智能体（Agent）——小白入门实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-31T07:17:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大黄评测"/> <meta itemprop="url" content="https://juejin.cn/user/714024404135696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始打造你的第一个AI智能体（Agent）——小白入门实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/714024404135696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大黄评测
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:17:40.000Z" title="Sat Jan 31 2026 07:17:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在人工智能迅猛发展的今天，"Agent"（智能体）已成为AI开发中的热门概念。无论你是编程新手，还是刚接触AI领域的爱好者，亲手创建一个属于自己的AI智能体，不仅能加深对AI工作原理的理解，还能为后续深入学习打下坚实基础。本文将手把手带你完成你的第一个AI Agent示例，全程使用通俗易懂的语言，无需高深背景知识。</p>
<h3 data-id="heading-0">什么是AI Agent？</h3>
<p>简单来说，AI Agent 是一个能感知环境、做出决策并执行动作的程序。它可以是一个聊天机器人、一个自动订票助手，甚至是一个能玩棋类游戏的AI对手。核心要素包括：</p>
<ul>
<li><strong>感知（Perception）</strong> ：接收外部输入（如用户问题、传感器数据等）</li>
<li><strong>思考（Reasoning）</strong> ：基于规则或模型处理信息</li>
<li><strong>行动（Action）</strong> ：输出响应或执行操作</li>
</ul>
<h3 data-id="heading-1">开发环境准备</h3>
<p>我们使用 Python 作为开发语言，因为它拥有丰富的AI生态库，且语法简洁。你需要安装以下工具：</p>
<pre><code class="hljs">pip install langchain openai python-dotenv
</code></pre>
<blockquote>
<p>注：如果你没有 OpenAI API Key，也可以使用开源模型（如 Ollama + Llama3）替代，本文以 OpenAI 为例。</p>
</blockquote>
<p>同时，在项目根目录创建 <code>.env</code> 文件，填入你的 API 密钥：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">OPENAI_API_KEY</span>=your-api-key-here
</code></pre>
<h3 data-id="heading-2">第一步：定义工具（Tools）</h3>
<p>Agent 的能力往往依赖于“工具”。比如，它可以调用计算器、搜索网页或查询数据库。我们先创建一个简单的“回声”工具：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> Tool

<span class="hljs-keyword">def</span> <span class="hljs-title function_">echo_tool</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"你说了：<span class="hljs-subst">{query}</span>"</span>

tools = [
    Tool(
        name=<span class="hljs-string">"Echo"</span>,
        func=echo_tool,
        description=<span class="hljs-string">"重复用户输入的内容"</span>
    )
]
</code></pre>
<h3 data-id="heading-3">第二步：初始化大语言模型（LLM）</h3>
<p>我们使用 OpenAI 的 GPT 模型作为 Agent 的“大脑”：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> <span class="hljs-title class_">ChatOpenAI</span>
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">import</span> os

<span class="hljs-title function_">load_dotenv</span>()
llm = <span class="hljs-title class_">ChatOpenAI</span>(model=<span class="hljs-string">"gpt-3.5-turbo"</span>, temperature=<span class="hljs-number">0</span>)
</code></pre>
<h3 data-id="heading-4">第三步：创建并运行 Agent</h3>
<p>使用 LangChain 提供的 <code>create_react_agent</code> 快速构建一个 ReAct（Reason + Act）风格的智能体：</p>
<pre><code class="hljs language-ini" lang="ini">from langchain import hub
from langchain.agents import create_react_agent, AgentExecutor

<span class="hljs-comment"># 获取预设的 prompt 模板</span>
<span class="hljs-attr">prompt</span> = hub.pull(<span class="hljs-string">"hwchase17/react"</span>)

<span class="hljs-comment"># 创建 Agent</span>
<span class="hljs-attr">agent</span> = create_react_agent(llm, tools, prompt)

<span class="hljs-comment"># 创建执行器</span>
<span class="hljs-attr">agent_executor</span> = AgentExecutor(agent=agent, tools=tools, verbose=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 运行！</span>
<span class="hljs-attr">response</span> = agent_executor.invoke({<span class="hljs-string">"input"</span>: <span class="hljs-string">"你好，请重复我说的话：今天天气真好！"</span>})
print(response<span class="hljs-section">["output"]</span>)
</code></pre>
<p>运行后，你会看到类似这样的输出：</p>
<pre><code class="hljs">你说了：今天天气真好！
</code></pre>
<p>恭喜！你刚刚创建了一个具备基本感知-思考-行动能力的AI Agent！</p>
<h3 data-id="heading-5">扩展思路</h3>
<p>这个示例虽然简单，但已具备Agent的核心结构。你可以在此基础上：</p>
<ul>
<li>添加更多工具（如天气查询、数学计算）</li>
<li>接入本地知识库实现问答</li>
<li>部署为 Web 应用（使用 Flask 或 FastAPI）</li>
<li>使用记忆模块让 Agent 记住对话历史</li>
</ul>
<h3 data-id="heading-6">结语</h3>
<p>AI Agent 并非遥不可及的黑科技，而是一套清晰可构建的系统。通过这个“Hello World”级别的示例，希望你能迈出AI开发的第一步。记住：每一个复杂的智能系统，都始于一行简单的代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SQLcl：不只是 SQL*Plus 的升级版，更是 AI 时代数据库开发的智能连接器]]></title>    <link>https://juejin.cn/post/7600982613654913074</link>    <guid>https://juejin.cn/post/7600982613654913074</guid>    <pubDate>2026-01-31T07:23:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600982613654913074" data-draft-id="7601020578490695689" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SQLcl：不只是 SQL*Plus 的升级版，更是 AI 时代数据库开发的智能连接器"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-31T07:23:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大黄评测"/> <meta itemprop="url" content="https://juejin.cn/user/714024404135696"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SQLcl：不只是 SQL*Plus 的升级版，更是 AI 时代数据库开发的智能连接器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/714024404135696/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大黄评测
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:23:23.000Z" title="Sat Jan 31 2026 07:23:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Oracle 数据库工具演进史上，SQL<em>Plus 曾是无数 DBA 和开发者的“老战友”——简洁、稳定、无依赖。但随着 AI 与云原生时代的到来，命令行工具也需要进化。Oracle 推出的 <strong>SQLcl</strong>（SQL Developer Command Line）不仅全面兼容 SQL</em>Plus 语法，更以现代化交互、脚本扩展能力和原生 AI 集成，重新定义了数据库命令行体验。</p>
<p>它不再只是一个查询终端，而是连接开发者、数据库与生成式 AI 的<strong>智能桥梁</strong>。</p>
<hr/>
<h3 data-id="heading-0">一、从 SQL*Plus 到 SQLcl：不止是“更好看”</h3>
<p>SQLcl 延续了 SQL*Plus 的轻量与跨平台特性（基于 Java，支持 Windows/Linux/macOS），但在用户体验上实现了质的飞跃：</p>
<ul>
<li>✅ <strong>语法高亮与自动补全</strong>：输入 <code>SELECT * FROM emp</code> 时，表名、列名自动提示</li>
<li>✅ <strong>多行编辑与历史回溯</strong>：像现代 Shell 一样流畅编辑复杂语句</li>
<li>✅ <strong>内置 REST、JSON、CSV 支持</strong>：直接导出为结构化格式，无需额外脚本</li>
<li>✅ <strong>脚本语言支持 JavaScript / TypeScript</strong>：用 JS 编写数据库自动化任务</li>
</ul>
<p>例如，用 JavaScript 脚本一键生成表结构文档：</p>
<pre><code class="hljs language-lua" lang="lua">// table_info.js
var tables = db.<span class="hljs-built_in">execute</span>(<span class="hljs-string">"SELECT table_name FROM user_tables"</span>);
tables.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(row)</span></span> {
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">"=== "</span> + row[<span class="hljs-number">0</span>] + <span class="hljs-string">" ==="</span>);
    db.<span class="hljs-built_in">execute</span>(<span class="hljs-string">"DESC "</span> + row[<span class="hljs-number">0</span>]).<span class="hljs-built_in">print</span>();
});
</code></pre>
<p>运行：<code>sql /nolog @table_info.js</code></p>
<p>这种灵活性让 SQLcl 成为 DevOps 和数据工程流水线的理想组件。</p>
<hr/>
<h3 data-id="heading-1">二、AI 时代的全新角色：SQLcl × Oracle AI</h3>
<p>真正让 SQLcl 脱颖而出的，是它与 <strong>Oracle Cloud Infrastructure（OCI）Generative AI 服务</strong>的深度集成。从 v23.4 开始，SQLcl 内置了 <code>AI</code> 命令，让你在命令行中直接调用大模型！</p>
<h4 data-id="heading-2">场景1：自然语言生成 SQL</h4>
<p>不会写复杂查询？直接问 AI：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">SQL&gt; </span><span class="bash">AI <span class="hljs-string">"列出过去30天销售额最高的5个客户，包括客户名和总金额"</span></span>
</code></pre>
<p>SQLcl 会调用 OCI 上的 Llama 或 Cohere 模型，返回可执行的 SQL 语句，并询问是否立即运行。</p>
<h4 data-id="heading-3">场景2：解释执行计划</h4>
<p>看不懂 <code>EXPLAIN PLAN</code> 的输出？让 AI 帮你解读：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> EXPLAIN PLAN <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'SHIPPED'</span>;
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> AI EXPLAIN
</code></pre>
<p>AI 会用通俗语言说明：“该查询使用了索引 IDX_ORD_STATUS，预计返回约12万行……”</p>
<h4 data-id="heading-4">场景3：自动生成测试数据或修复建议</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">SQL&gt; </span><span class="bash">AI <span class="hljs-string">"为 employees 表生成10条符合 HR 规则的测试数据"</span></span>
<span class="hljs-meta prompt_">SQL&gt; </span><span class="bash">AI <span class="hljs-string">"为什么这个 INSERT 报 ORA-02291？请给出解决方案"</span></span>
</code></pre>
<p>所有 AI 交互均通过企业级 OCI 服务完成，<strong>数据不经过公有大模型</strong>，保障安全合规。</p>
<hr/>
<h3 data-id="heading-5">三、为什么 SQLcl 是 AI 时代的“连接器”？</h3>



































<table><thead><tr><th>能力</th><th>传统工具（如 SQL*Plus）</th><th>SQLcl</th></tr></thead><tbody><tr><td>交互体验</td><td>纯文本，无提示</td><td>智能补全、语法高亮</td></tr><tr><td>脚本能力</td><td>仅 PL/SQL 或 Shell</td><td>支持 JavaScript/TypeScript</td></tr><tr><td>数据格式</td><td>仅文本表格</td><td>原生支持 JSON/CSV/XML</td></tr><tr><td>AI 集成</td><td>无</td><td>内置 <code>AI</code> 命令，直连 OCI GenAI</td></tr><tr><td>安全性</td><td>本地运行</td><td>支持 Wallet、OCI Auth、Vault 集成</td></tr></tbody></table>
<p>更重要的是，SQLcl <strong>无缝融入现有工作流</strong>。你无需放弃熟悉的 <code>/</code> 执行、<code>@script.sql</code> 调用等习惯，就能获得 AI 增强能力。</p>
<hr/>
<h3 data-id="heading-6">四、快速上手：三步启用 AI 功能</h3>
<ol>
<li>
<p><strong>安装 SQLcl</strong>（需 23.4+）<br/>
从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oracle.com%2Fdatabase%2Ftechnologies%2Fappdev%2Fsqlcl.html" target="_blank" title="https://www.oracle.com/database/technologies/appdev/sqlcl.html" ref="nofollow noopener noreferrer">Oracle 官网</a> 下载</p>
</li>
<li>
<p><strong>配置 OCI 凭据</strong><br/>
设置环境变量或使用 <code>oci setup config</code> 生成配置文件</p>
</li>
<li>
<p><strong>在 SQLcl 中启用 AI</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">SET</span> AI <span class="hljs-keyword">ON</span>
<span class="hljs-keyword">SQL</span><span class="hljs-operator">&gt;</span> AI "显示当前用户有哪些表"
</code></pre>
</li>
</ol>
<p>首次使用会引导你选择模型（如 <code>meta/llama-3-70b-instruct</code>）和区域。</p>
<hr/>
<h3 data-id="heading-7">结语：命令行从未如此智能</h3>
<p>SQLcl 的使命，不只是取代 SQL*Plus，而是成为 <strong>AI 原生数据库开发的新入口</strong>。它让 DBA 从“记忆语法”转向“描述意图”，让开发者用自然语言与数据库对话，同时坚守企业对安全、可控和效率的要求。</p>
<p>在这个 AI 重构一切的时代，最强大的工具往往不是最炫的 GUI，而是那个你每天都在用、却悄然进化了的命令行——<br/>
<strong>SQLcl，正站在这个转折点上</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文搞懂Python装饰器]]></title>    <link>https://juejin.cn/post/7601000638344953871</link>    <guid>https://juejin.cn/post/7601000638344953871</guid>    <pubDate>2026-01-31T07:40:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601000638344953871" data-draft-id="7601077290680877108" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文搞懂Python装饰器"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-31T07:40:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Kevin666"/> <meta itemprop="url" content="https://juejin.cn/user/1549628692501449"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文搞懂Python装饰器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1549628692501449/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Kevin666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:40:03.000Z" title="Sat Jan 31 2026 07:40:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F12722799041" target="_blank" title="https://zhuanlan.zhihu.com/p/12722799041" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/127227990…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D251567592%26content_type%3DArticle%26match_order%3D1%26q%3DPython%25E8%25A3%2585%25E9%25A5%25B0%25E5%2599%25A8%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=251567592&amp;content_type=Article&amp;match_order=1&amp;q=Python%E8%A3%85%E9%A5%B0%E5%99%A8&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Python装饰器</a>是一个相对难以理解的概念，Up在初次接触时也觉得晦涩。本文尽可能用通俗易懂的语言和例子，解释清楚Python装饰器。</p>
<h3 data-id="heading-0">提前划重点</h3>
<ul>
<li>装饰器为什么难理解</li>
<li>先搞懂闭包</li>
<li>装饰器就是一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D251567592%26content_type%3DArticle%26match_order%3D1%26q%3D%25E8%25AF%25AD%25E6%25B3%2595%25E7%25B3%2596%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=251567592&amp;content_type=Article&amp;match_order=1&amp;q=%E8%AF%AD%E6%B3%95%E7%B3%96&amp;zhida_source=entity" ref="nofollow noopener noreferrer">语法糖</a></li>
<li>装饰器的应用场景</li>
</ul>
<h3 data-id="heading-1">装饰器的为什么难理解</h3>
<p>我们先来看一个简单的例子，这个例子里我们定义了一个装饰器，用于在greet()函数执行前后各打印一条消息。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 定义一个简单的装饰器</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_decorator</span>(<span class="hljs-params">func</span>):     <span class="hljs-comment"># 传入一个函数作为参数</span>
    <span class="hljs-comment"># 包装原始函数的内部函数</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"即将执行函数..."</span>)
        func()                  <span class="hljs-comment"># 执行原始函数</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"函数执行完毕。"</span>)
    <span class="hljs-keyword">return</span> wrapper

<span class="hljs-comment"># 使用装饰器</span>
<span class="hljs-meta">@simple_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"你好！"</span>)

<span class="hljs-comment"># 调用被装饰的函数</span>
greet()

-------------------------
<span class="hljs-comment">## 打印</span>
即将执行函数...
你好！
函数执行完毕。
</code></pre>
<p>如果你是第一次接触装饰器，你一定觉得这个这个语法很难理解</p>
<ul>
<li>定义装饰器的时候，为什么simple_decorator函数里面，居然还有一个wrapper内部函数，并且返回值还是这个wrapper函数？？？</li>
<li>greet函数上面使用@simple_decorator是个什么用法？从来没见过</li>
</ul>
<p>没关系，大家可以先建立一个印象，大概这个装饰器是怎么用的。下面我们来一一拆解，<strong>并没有那么复杂！</strong></p>
<h3 data-id="heading-2">先搞懂闭包</h3>
<p>理解Python装饰器的前提是，我们先要搞懂<strong>闭包</strong>这个概念。</p>
<p>通俗来说，闭包就是<strong>函数</strong>及其<strong>周边环境</strong>的组合。（在<strong>本文语境下</strong>，你可以暂时理解<strong>周边环境就是一些外部的变量</strong>）</p>
<p>闭包通常涉及到一个内部函数，内部函数可以访问（或者说‘记住’）<strong>外部函数的局部变量</strong>，<strong>即使外部函数已经执行完毕</strong>。</p>
<p>这么说可能还是有点抽象，我们回到开头那个例子，wrapper就是一个内部函数，当我们调用simple_decorator(greet)会返回wrapper。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_decorator</span>(<span class="hljs-params">func</span>): <span class="hljs-comment"># 传入一个函数作为参数</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"即将执行函数..."</span>)
        func()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"函数执行完毕。"</span>)
    <span class="hljs-keyword">return</span> wrapper <span class="hljs-comment"># 返回wrapper</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"你好！"</span>)

closure = simple_decorator(greet) <span class="hljs-comment"># simple_decorator(greet)会返回wrapper，这就是一个闭包实例</span>
</code></pre>
<p>这个closure就是一个闭包实例！</p>
<p>我们来理解一下，通常我们觉得wrapper这种函数就是它定义的代码吗，很简单：</p>
<pre><code class="hljs language-scss" lang="scss">def <span class="hljs-built_in">wrapper</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"即将执行函数..."</span>)
    <span class="hljs-built_in">func</span>()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"函数执行完毕。"</span>)
</code></pre>
<p>但是当wrapper作为内部函数的时候，调用simple_decorator(greet)返回的wrapper是一个闭包，除了上面定义的代码，它还能<strong>记住外层函数的变量</strong>，没错就是func变量，具体到这次调用就是我们传入的greet函数。<strong>即使simple_decorator已经执行完了，依然可以记住greet。</strong> 这个记住外部变量是大家不太熟悉的或者难以理解的原因。</p>
<p>所以，当我们调用closure()时：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">closure</span>()

-------
# 本质是执行了以下代码
<span class="hljs-built_in">print</span>("即将执行函数...")
<span class="hljs-built_in">greet</span>() # greet会被记住
<span class="hljs-built_in">print</span>("函数执行完毕。")

-------
## 打印
即将执行函数...
你好！
函数执行完毕。
</code></pre>
<h3 data-id="heading-3">装饰器就是一个语法糖</h3>
<p>下面我们再说说，@simple_decorator</p>
<p>通过上面的分析相信大家已经看出来了，这两种写法貌似是等效的：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 写法一</span>
<span class="hljs-meta">@simple_decorator</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">greet</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"你好！"</span>)

greet() <span class="hljs-comment"># 调用greet</span>

<span class="hljs-comment"># 写法二</span>
closure = simple_decorator(greet)
closure() <span class="hljs-comment"># 调用closure</span>
</code></pre>
<p>我们再进一步，其实写法二没必要引入一个新的变量closure，我们完全可以复用greet。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">写法三</span>
greet = simple_decorator(greet)
greet() # greet
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># greet本身指向自己定义的代码</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># simple_decorator(greet) 返回wrapper，这是一个闭包</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 直接让greet指向新的闭包</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 这样调用greet()的时候，相当于调用的是闭包</span></span>
</code></pre>
<p>我们抽象一点，@这个用法本质就是一个语法糖，让程序员写代码更方便的一种写法而已：</p>
<pre><code class="hljs language-lua" lang="lua">@decorator
def <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>:
    ...

<span class="hljs-comment">------------   </span>
本质上就是
<span class="hljs-function"><span class="hljs-keyword">function</span> = <span class="hljs-title">decorator</span><span class="hljs-params">(function)</span></span>
</code></pre>
<h3 data-id="heading-4">装饰器的应用场景</h3>
<p>通过上述分析，我们可以看到，装饰器似乎提供了<strong>一种动态修改或者说加强函数的能力</strong>，通过使用装饰器，你可以在原函数的基础上增加一些逻辑。</p>
<p>那装饰器主要可以用在哪些场景呢</p>
<ol>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D251567592%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2597%25A5%25E5%25BF%2597%25E8%25AE%25B0%25E5%25BD%2595%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=251567592&amp;content_type=Article&amp;match_order=1&amp;q=%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95&amp;zhida_source=entity" ref="nofollow noopener noreferrer">日志记录</a></strong>：在函数执行前后自动添加日志记录，方便调试和监控程序行为。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D251567592%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%2580%25A7%25E8%2583%25BD%25E6%25B5%258B%25E8%25AF%2595%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=251567592&amp;content_type=Article&amp;match_order=1&amp;q=%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95&amp;zhida_source=entity" ref="nofollow noopener noreferrer">性能测试</a></strong>：装饰器可以用来测量函数的执行时间，帮助识别性能瓶颈。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D251567592%26content_type%3DArticle%26match_order%3D1%26q%3D%25E6%259D%2583%25E9%2599%2590%25E9%25AA%258C%25E8%25AF%2581%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=251567592&amp;content_type=Article&amp;match_order=1&amp;q=%E6%9D%83%E9%99%90%E9%AA%8C%E8%AF%81&amp;zhida_source=entity" ref="nofollow noopener noreferrer">权限验证</a></strong>：在Web开发中，装饰器可以用于检查用户是否有权访问某个资源或执行特定操作。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D251567592%26content_type%3DArticle%26match_order%3D1%26q%3D%25E7%25BC%2593%25E5%25AD%2598%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=251567592&amp;content_type=Article&amp;match_order=1&amp;q=%E7%BC%93%E5%AD%98&amp;zhida_source=entity" ref="nofollow noopener noreferrer">缓存</a>（Memoization）</strong> ：通过装饰器实现函数结果的缓存，避免重复计算相同的输入值，从而提高效率。</li>
</ol>
<p>等等等等..</p>
<p>当你使用装饰器实现了这些功能，只需要使用@在想要增强的函数前面声明一下，可以<strong>非常清晰的表示你在本身函数业务的基础上，增加了什么逻辑</strong>。如果没有装饰器，你必须写到函数本身的代码里，这会不利于理解和复用，让这种增强逻辑和本身业务逻辑耦合。所以装饰器，<strong>也可以理解成一种优雅的语法，帮助程序变得清晰解耦。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 HTML 中引入 JavaScript 有哪几种方式？它们各自的优缺点是什么？]]></title>    <link>https://juejin.cn/post/7601020578490679305</link>    <guid>https://juejin.cn/post/7601020578490679305</guid>    <pubDate>2026-01-31T07:22:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601020578490679305" data-draft-id="7601077764423335986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 HTML 中引入 JavaScript 有哪几种方式？它们各自的优缺点是什么？"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-31T07:22:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Smilezyl"/> <meta itemprop="url" content="https://juejin.cn/user/3438928103504088"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 HTML 中引入 JavaScript 有哪几种方式？它们各自的优缺点是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3438928103504088/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Smilezyl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:22:47.000Z" title="Sat Jan 31 2026 07:22:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">在 HTML 中引入 JavaScript 有哪几种方式？它们各自的优缺点是什么？</h2>
<h3 data-id="heading-1">核心答案</h3>
<p>在 HTML 中引入 JavaScript 有 <strong>3 种主要方式</strong>：</p>

























<table><thead><tr><th>方式</th><th>语法</th><th>主要场景</th></tr></thead><tbody><tr><td><strong>1. 行内式</strong></td><td><code>&lt;div onclick="alert('hi')"&gt;</code></td><td>极少使用，不推荐</td></tr><tr><td><strong>2. 内嵌式</strong></td><td><code>&lt;script&gt;alert('hi')&lt;/script&gt;</code></td><td>小型脚本、单页应用</td></tr><tr><td><strong>3. 外链式</strong></td><td><code>&lt;script src="app.js"&gt;&lt;/script&gt;</code></td><td><strong>生产环境首选</strong></td></tr></tbody></table>
<p><strong>核心原则</strong>：生产环境优先使用外链式，配合 <code>defer</code> 或 <code>async</code> 优化加载性能。</p>
<hr/>
<h3 data-id="heading-2">深入解析</h3>
<h4 data-id="heading-3">1. 三种方式详解</h4>
<h5 data-id="heading-4">方式一：行内式（Inline）</h5>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 直接在 HTML 属性中写 JS --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"alert('点击了！')"</span>&gt;</span>点击我<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"javascript:void(0)"</span> <span class="hljs-attr">onmouseover</span>=<span class="hljs-string">"console.log('悬停')"</span>&gt;</span>链接<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>快速测试、简单直观</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ HTML 和 JS 强耦合，难以维护</li>
<li>❌ 无法复用逻辑</li>
<li>❌ 代码混乱，可读性差</li>
<li>❌ 存在 XSS 安全风险</li>
<li>❌ 无法利用浏览器缓存</li>
</ul>
<hr/>
<h5 data-id="heading-5">方式二：内嵌式（Internal / Embedded）</h5>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="xml">
        // JS 代码写在 <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"> 标签内
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面初始化'</span>);
        }
    </span></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>内嵌式示例<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>✓ 适合单页应用或小型项目</li>
<li>✓ HTML 和 JS 在同一文件，便于调试</li>
<li>✓ 可以访问页面中的所有元素</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ HTML 文件体积变大</li>
<li>❌ 无法被浏览器缓存（每次加载 HTML 都要重新加载 JS）</li>
<li>❌ 多个页面无法共享同一份 JS 代码</li>
<li>❌ 不符合关注点分离原则</li>
</ul>
<hr/>
<h5 data-id="heading-6">方式三：外链式（External）⭐ <strong>推荐</strong></h5>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 基础用法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 推荐用法：配合 defer --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/app.js"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 或者 async（取决于场景） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/analytics.js"</span> <span class="hljs-attr">async</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>✅ <strong>HTML 与 JS 分离</strong>，结构清晰</li>
<li>✅ <strong>可复用</strong>：多个页面共享同一个 JS 文件</li>
<li>✅ <strong>可缓存</strong>：浏览器缓存 JS 文件，提升加载速度</li>
<li>✅ <strong>便于维护</strong>：代码独立管理</li>
<li>✅ <strong>支持模块化</strong>：方便团队协作</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>⚠️ 需要额外的 HTTP 请求（但可通过缓存和打包优化）</li>
</ul>
<hr/>
<h4 data-id="heading-7">2. <code>&lt;script&gt;</code> 标签的关键属性</h4>
<h5 data-id="heading-8"><code>defer</code> 和 <code>async</code> 的区别</h5>
<pre><code class="hljs language-less" lang="less">页面解析流程对比：

无属性（默认）:
<span class="hljs-selector-tag">HTML</span>解析 → 遇到<span class="hljs-selector-tag">script</span> → 停止解析 → 下载<span class="hljs-selector-tag">JS</span> → 执行<span class="hljs-selector-tag">JS</span> → 继续解析<span class="hljs-selector-tag">HTML</span>
                ↑ 阻塞页面渲染 ↑

<span class="hljs-selector-tag">defer</span>:
<span class="hljs-selector-tag">HTML</span>解析 → 并行下载<span class="hljs-selector-tag">JS</span> → <span class="hljs-selector-tag">HTML</span>解析完成 → 按顺序执行<span class="hljs-selector-tag">JS</span> → <span class="hljs-selector-tag">DOMContentLoaded</span>
            ↓ 不阻塞解析 ↓

<span class="hljs-selector-tag">async</span>:
<span class="hljs-selector-tag">HTML</span>解析 → 并行下载<span class="hljs-selector-tag">JS</span> → 下载完立即执行 → 继续解析<span class="hljs-selector-tag">HTML</span>
            ↓ 执行时机不确定 ↓
</code></pre>





























<table><thead><tr><th>属性</th><th>执行时机</th><th>顺序保证</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>无属性</strong></td><td>立即执行，阻塞解析</td><td>✅ 按顺序</td><td>无</td></tr><tr><td><strong>defer</strong></td><td>HTML 解析完成后，<code>DOMContentLoaded</code> 前</td><td>✅ 按顺序</td><td><strong>DOM 操作脚本</strong></td></tr><tr><td><strong>async</strong></td><td>下载完成后立即执行</td><td>❌ 无顺序保证</td><td><strong>独立脚本</strong>（如统计、广告）</td></tr></tbody></table>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- defer 推荐用法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"main.js"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"utils.js"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 保证：utils.js 一定在 main.js 之前执行 --&gt;</span>

<span class="hljs-comment">&lt;!-- async 用法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"analytics.js"</span> <span class="hljs-attr">async</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"ads.js"</span> <span class="hljs-attr">async</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 不保证执行顺序，谁先下载完谁先执行 --&gt;</span>
</code></pre>
<h5 data-id="heading-9">其他重要属性</h5>






























<table><thead><tr><th>属性</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>type</code></td><td>指定脚本类型</td><td><code>type="module"</code>（ES 模块）</td></tr><tr><td><code>crossorigin</code></td><td>CORS 配置</td><td><code>crossorigin="anonymous"</code></td></tr><tr><td><code>integrity</code></td><td>SRI（子资源完整性校验）</td><td><code>integrity="sha384-..."</code></td></tr><tr><td><code>nomodule</code></td><td>不支持模块的浏览器才执行</td><td><code>&lt;script nomodule src="legacy.js"&gt;&lt;/script&gt;</code></td></tr></tbody></table>
<hr/>
<h4 data-id="heading-10">3. 底层机制：浏览器如何加载和执行脚本</h4>
<pre><code class="hljs language-xml" lang="xml">┌─────────────────────────────────────────────────────────┐
│                    浏览器渲染流程                         │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  1. HTML Parser ──→ 构建 DOM 树                          │
│         ↓                                                 │
│  2. CSS Parser ──→ 构建 CSSOM 树                         │
│         ↓                                                 │
│  3. 合并 ──→ 渲染树（Render Tree）                        │
│         ↓                                                 │
│  4. Layout（布局）                                        │
│         ↓                                                 │
│  5. Paint（绘制）                                         │
│                                                          │
└─────────────────────────────────────────────────────────┘

遇到 <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"> 时：

默认行为：
┌─────────┐
│ 停止解析 │ ← 阻塞 <span class="hljs-variable constant_">DOM</span> 构建
└────┬────┘
     ↓
┌─────────┐
│ 下载 <span class="hljs-variable constant_">JS</span> │ ← 如果是外链脚本
└────┬────┘
     ↓
┌─────────┐
│ 执行 <span class="hljs-variable constant_">JS</span> │ ← 阻塞渲染
└────┬────┘
     ↓
┌─────────┐
│ 继续解析 │
└─────────┘

使用 defer/<span class="hljs-keyword">async</span>：
┌─────────┐      ┌─────────┐
 │继续解析 │ ←→   │并行下载 │  ← 不阻塞
└─────────┘      └─────────┘
</span></code></pre>
<hr/>
<h4 data-id="heading-11">4. 最佳实践</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>最佳实践示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- CSS 放在 head 中 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"styles.css"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 预加载关键脚本 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"critical.js"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"script"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 页面内容 --&gt;</span>

    <span class="hljs-comment">&lt;!-- 方案1：现代浏览器推荐 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"main.js"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"app.js"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 方案2：需要立即执行的脚本（如 polyfill） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 同步执行的小型脚本</span>
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 方案3：独立第三方脚本 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"analytics.js"</span> <span class="hljs-attr">async</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 方案4：ES 模块 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"module.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 方案5：模块降级方案 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"modern.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nomodule</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"legacy.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<hr/>
<h4 data-id="heading-12">5. 常见误区</h4>
<blockquote>
<p>❌ <strong>误区1</strong>：<code>defer</code> 和 <code>async</code> 功能一样</p>
<p>✅ <strong>纠正</strong>：<code>defer</code> 保证顺序且在 DOMContentLoaded 前执行，<code>async</code> 不保证顺序</p>
</blockquote>
<blockquote>
<p>❌ <strong>误区2</strong>：把所有 <code>&lt;script&gt;</code> 都放在 <code>&lt;head&gt;</code> 里</p>
<p>✅ <strong>纠正</strong>：传统放 <code>&lt;/body&gt;</code> 前，现代用 <code>defer</code> 可放 <code>head</code></p>
</blockquote>
<blockquote>
<p>❌ <strong>误区3</strong>：<code>defer</code> 的脚本一定在 <code>DOMContentLoaded</code> 前执行</p>
<p>✅ <strong>纠正</strong>：大部分情况是的，但如果脚本很大或网络慢，可能在之后</p>
</blockquote>
<blockquote>
<p>❌ <strong>误区4</strong>：多个 <code>async</code> 脚本按书写顺序执行</p>
<p>✅ <strong>纠正</strong>：<code>async</code> 脚本按下载完成顺序执行，顺序不可控</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">代码示例</h3>
<h4 data-id="heading-14">示例1：三种引入方式对比</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>JS 引入方式对比<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 方式1：行内式（不推荐） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"handleClick()"</span>&gt;</span>行内式按钮<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 方式2：内嵌式 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'内嵌式函数被调用'</span>);
        }

        <span class="hljs-comment">// 内嵌式可以直接操作页面</span>
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'DOM 加载完成'</span>);
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 方式3：外链式（推荐） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"js/utils.js"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>三种引入方式<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 行内式的完整示例 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">onmouseover</span>=<span class="hljs-string">"this.style.background='yellow'"</span>
         <span class="hljs-attr">onmouseout</span>=<span class="hljs-string">"this.style.background='white'"</span>&gt;</span>
        鼠标悬停变色
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-15">示例2：defer vs async 实际效果</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>defer vs async<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>页面标题<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>内容...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 同步脚本：阻塞后续渲染</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1. 同步脚本开始'</span>);
        <span class="hljs-comment">// 模拟耗时操作</span>
        <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
        <span class="hljs-keyword">while</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start &lt; <span class="hljs-number">2000</span>) {}
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'2. 同步脚本结束（阻塞了2秒）'</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这行内容被延迟显示了<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- defer 脚本 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"defer1.js"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"defer2.js"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 保证：defer1.js 在 defer2.js 之前执行 --&gt;</span>

    <span class="hljs-comment">&lt;!-- async 脚本 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"async1.js"</span> <span class="hljs-attr">async</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"async2.js"</span> <span class="hljs-attr">async</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 不保证：谁先下载完谁先执行 --&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'3. DOMContentLoaded 触发'</span>);
        });

        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'4. 页面完全加载完成'</span>);
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-16">示例3：现代项目的标准引入方式</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>现代项目<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 预连接到 CDN --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preconnect"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.example.com"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 预加载关键资源 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"critical.css"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"style"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"critical.js"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"script"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 关键 CSS --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"critical.css"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Polyfill：需要立即执行且不依赖 DOM --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 检测和添加必要的 polyfill</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span>) {
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">'&lt;script src="polyfills/promise.js"&gt;&lt;\/script&gt;'</span>);
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 主要应用脚本：使用 defer --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"vendors.js"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"main.js"</span> <span class="hljs-attr">defer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 第三方统计：使用 async --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"analytics.js"</span> <span class="hljs-attr">async</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- ES 模块 + 降级方案 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"modern-app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nomodule</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"legacy-app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-17">示例4：动态加载脚本</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 动态创建 script 标签</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">loadScript</span>(<span class="hljs-params">url, options = {}</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
        script.<span class="hljs-property">src</span> = url;

        <span class="hljs-comment">// 设置属性</span>
        <span class="hljs-keyword">if</span> (options.<span class="hljs-property">async</span>) script.<span class="hljs-property">async</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (options.<span class="hljs-property">defer</span>) script.<span class="hljs-property">defer</span> = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (options.<span class="hljs-property">type</span>) script.<span class="hljs-property">type</span> = options.<span class="hljs-property">type</span>;

        <span class="hljs-comment">// 事件监听</span>
        script.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(script);
        script.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Failed to load <span class="hljs-subst">${url}</span>`</span>));

        <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(script);
    });
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">initApp</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadScript</span>(<span class="hljs-string">'/utils.js'</span>, { <span class="hljs-attr">defer</span>: <span class="hljs-literal">true</span> });
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">loadScript</span>(<span class="hljs-string">'/main.js'</span>, { <span class="hljs-attr">defer</span>: <span class="hljs-literal">true</span> });
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有脚本加载完成'</span>);
    } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'脚本加载失败:'</span>, error);
    }
}

<span class="hljs-comment">// 条件加载</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'IntersectionObserver'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
    <span class="hljs-comment">// 支持，加载现代版本</span>
    <span class="hljs-title function_">loadScript</span>(<span class="hljs-string">'/modern-image-lazy-load.js'</span>);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 不支持，加载 polyfill</span>
    <span class="hljs-title function_">loadScript</span>(<span class="hljs-string">'/polyfills/intersection-observer.js'</span>)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">loadScript</span>(<span class="hljs-string">'/legacy-image-lazy-load.js'</span>));
}
</code></pre>
<hr/>
<h3 data-id="heading-18">面试技巧</h3>
<h4 data-id="heading-19">面试官可能的追问</h4>
<ol>
<li>
<p><strong>"为什么传统建议把 <code>&lt;script&gt;</code> 放在 <code>&lt;/body&gt;</code> 之前？"</strong></p>
<ul>
<li>避免阻塞页面渲染，让用户先看到内容</li>
</ul>
</li>
<li>
<p><strong>"现在有了 <code>defer</code>，还需要放 <code>&lt;/body&gt;</code> 前吗？"</strong></p>
<ul>
<li>不需要，<code>defer</code> 可放 <code>head</code>，效果相同且更早开始下载</li>
</ul>
</li>
<li>
<p><strong>"什么情况下用 <code>async</code>？"</strong></p>
<ul>
<li>独立脚本：统计代码、广告脚本、不依赖其他代码的库</li>
</ul>
</li>
<li>
<p><strong>"多个 <code>defer</code> 脚本的执行顺序？"</strong></p>
<ul>
<li>按在 HTML 中的出现顺序执行</li>
</ul>
</li>
<li>
<p><strong>"<code>defer</code> 和 <code>DOMContentLoaded</code> 的关系？"</strong></p>
<ul>
<li><code>defer</code> 脚本在 DOMContentLoaded 之前执行</li>
</ul>
</li>
<li>
<p><strong>"什么是脚本阻塞（render blocking）？"</strong></p>
<ul>
<li>解释浏览器解析 HTML 时遇到 <code>&lt;script&gt;</code> 停止渲染的机制</li>
</ul>
</li>
</ol>
<h4 data-id="heading-20">如何展示深度理解</h4>
<ol>
<li>
<p><strong>谈性能优化</strong>：</p>
<ul>
<li>关键渲染路径优化</li>
<li>资源预加载（preload/prefetch）</li>
<li>代码分割（code splitting）</li>
</ul>
</li>
<li>
<p><strong>谈实际项目经验</strong>：</p>
<ul>
<li>如何处理第三方脚本（如 Google Analytics）</li>
<li>如何优化首屏加载时间</li>
<li>使用过哪些构建工具的优化</li>
</ul>
</li>
<li>
<p><strong>谈浏览器兼容性</strong>：</p>
<ul>
<li><code>defer</code>/<code>async</code> 的浏览器支持情况</li>
<li>如何为老浏览器做降级处理</li>
</ul>
</li>
<li>
<p><strong>谈安全</strong>：</p>
<ul>
<li>SRI（Subresource Integrity）</li>
<li>nonce/CSP（Content Security Policy）</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-21">一句话总结</h3>
<blockquote>
<p><strong>外链式 + <code>defer</code> 是现代网页引入 JavaScript 的最佳实践，它实现了代码分离、可缓存、不阻塞渲染的完美平衡。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[什么是"阻塞渲染"？如何避免 JavaScript 代码阻塞页面渲染？]]></title>    <link>https://juejin.cn/post/7600982613654929458</link>    <guid>https://juejin.cn/post/7600982613654929458</guid>    <pubDate>2026-01-31T07:24:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600982613654929458" data-draft-id="7601077764423401522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="什么是&quot;阻塞渲染&quot;？如何避免 JavaScript 代码阻塞页面渲染？"/> <meta itemprop="keywords" content="面试,JavaScript"/> <meta itemprop="datePublished" content="2026-01-31T07:24:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Smilezyl"/> <meta itemprop="url" content="https://juejin.cn/user/3438928103504088"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            什么是"阻塞渲染"？如何避免 JavaScript 代码阻塞页面渲染？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3438928103504088/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Smilezyl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:24:32.000Z" title="Sat Jan 31 2026 07:24:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">什么是"阻塞渲染"？如何避免 JavaScript 代码阻塞页面渲染？</h2>
<h3 data-id="heading-1">核心答案</h3>
<p><strong>阻塞渲染</strong>是指浏览器在解析 HTML 构建 DOM 树的过程中，遇到 <code>&lt;script&gt;</code> 标签时会暂停 DOM 解析，等待脚本下载并执行完毕后才继续解析。这是因为 JavaScript 可能会修改 DOM 结构（如 <code>document.write</code>），浏览器必须确保 DOM 的正确性。</p>
<p><strong>避免阻塞的核心方法：</strong></p>
<ol>
<li>使用 <code>async</code> 属性：脚本异步下载，下载完立即执行</li>
<li>使用 <code>defer</code> 属性：脚本异步下载，DOM 解析完成后按顺序执行</li>
<li>将脚本放在 <code>&lt;/body&gt;</code> 前</li>
<li>动态创建 script 标签</li>
</ol>
<h3 data-id="heading-2">深入解析</h3>
<h4 data-id="heading-3">浏览器渲染流程</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">HTML</span> → DOM Tree
                  → Render Tree → Layout → Paint
CSS  → CSSOM
</code></pre>
<h4 data-id="heading-4">阻塞机制详解</h4>
<p><strong>1. JavaScript 阻塞 DOM 解析</strong></p>
<pre><code class="hljs language-xml" lang="xml">HTML解析 → 遇到<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span> → 暂停解析 → 下载JS → 执行JS → 继续解析
</code></pre>
<p><strong>2. CSS 也会间接阻塞</strong></p>
<ul>
<li>CSS 本身不阻塞 DOM 解析，但阻塞渲染</li>
<li>如果 JS 在 CSS 之后，JS 会等待 CSSOM 构建完成（因为 JS 可能访问样式）</li>
</ul>
<h4 data-id="heading-5">async vs defer 的区别</h4>






























<table><thead><tr><th>特性</th><th>async</th><th>defer</th></tr></thead><tbody><tr><td>下载</td><td>异步，不阻塞解析</td><td>异步，不阻塞解析</td></tr><tr><td>执行时机</td><td>下载完立即执行</td><td>DOM 解析完成后执行</td></tr><tr><td>执行顺序</td><td>不保证顺序</td><td>保证顺序</td></tr><tr><td>适用场景</td><td>独立脚本（统计、广告）</td><td>有依赖关系的脚本</td></tr></tbody></table>
<h4 data-id="heading-6">常见误区</h4>
<ol>
<li>
<p><strong>误区：async 和 defer 可以同时使用</strong></p>
<ul>
<li>实际：同时存在时，现代浏览器优先使用 async</li>
</ul>
</li>
<li>
<p><strong>误区：内联脚本可以使用 async/defer</strong></p>
<ul>
<li>实际：async/defer 只对外部脚本有效</li>
</ul>
</li>
<li>
<p><strong>误区：放在 body 底部就不会阻塞</strong></p>
<ul>
<li>实际：仍会阻塞，只是此时 DOM 已基本解析完成，影响较小</li>
</ul>
</li>
</ol>
<h3 data-id="heading-7">代码示例</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 1. 阻塞渲染（默认行为） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 2. async：异步下载，下载完立即执行 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"analytics.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 3. defer：异步下载，DOM 解析后按顺序执行 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">defer</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"vendor.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">defer</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"app.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 保证在 vendor.js 之后执行 --&gt;</span>

<span class="hljs-comment">&lt;!-- 4. 动态加载脚本 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
  script.<span class="hljs-property">src</span> = <span class="hljs-string">'lazy-module.js'</span>;
  script.<span class="hljs-property">async</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 保证顺序执行</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 5. 模块脚本（默认 defer 行为） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"app.mjs"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 6. 预加载关键资源 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"critical.js"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"script"</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">现代优化方案</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 Intersection Observer 懒加载脚本</span>
<span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
      <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
      script.<span class="hljs-property">src</span> = entry.<span class="hljs-property">target</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">src</span>;
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script);
      observer.<span class="hljs-title function_">unobserve</span>(entry.<span class="hljs-property">target</span>);
    }
  });
});

<span class="hljs-comment">// 使用 requestIdleCallback 在空闲时加载</span>
<span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>);
  script.<span class="hljs-property">src</span> = <span class="hljs-string">'non-critical.js'</span>;
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script);
});
</code></pre>
<h3 data-id="heading-9">面试技巧</h3>
<h4 data-id="heading-10">可能的追问方向</h4>
<ol>
<li>
<p><strong>"async 和 defer 的执行时机具体是什么？"</strong></p>
<ul>
<li>async：下载完成后立即执行，可能在 DOMContentLoaded 之前或之后</li>
<li>defer：在 DOMContentLoaded 事件之前执行</li>
</ul>
</li>
<li>
<p><strong>"CSS 会阻塞 JS 执行吗？"</strong></p>
<ul>
<li>会。如果 <code>&lt;script&gt;</code> 在 <code>&lt;link&gt;</code> 之后，JS 会等待 CSSOM 构建完成</li>
</ul>
</li>
<li>
<p><strong>"如何检测和量化阻塞时间？"</strong></p>
<ul>
<li>Performance API、Lighthouse、Chrome DevTools Performance 面板</li>
</ul>
</li>
<li>
<p><strong>"type="module" 的脚本有什么特点？"</strong></p>
<ul>
<li>默认 defer 行为、严格模式、独立作用域、支持 import/export</li>
</ul>
</li>
</ol>
<h4 data-id="heading-11">展示深度的回答技巧</h4>
<ul>
<li>提及浏览器的预解析器（Preload Scanner）会提前扫描并下载资源</li>
<li>讨论 Critical Rendering Path 优化策略</li>
<li>结合实际项目经验，如 Webpack 的代码分割、动态 import</li>
</ul>
<h3 data-id="heading-12">一句话总结</h3>
<blockquote>
<p><strong>JS 阻塞 DOM 解析是因为可能修改 DOM；用 defer 保顺序、async 求速度、动态加载最灵活。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue视频播放器：基于vue-video-player的自定义视频播放器实现]]></title>    <link>https://juejin.cn/post/7601053058856157190</link>    <guid>https://juejin.cn/post/7601053058856157190</guid>    <pubDate>2026-01-31T07:32:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601053058856157190" data-draft-id="7601053058856042502" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue视频播放器：基于vue-video-player的自定义视频播放器实现"/> <meta itemprop="keywords" content="前端框架"/> <meta itemprop="datePublished" content="2026-01-31T07:32:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户943339501512"/> <meta itemprop="url" content="https://juejin.cn/user/1496911244173812"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue视频播放器：基于vue-video-player的自定义视频播放器实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1496911244173812/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户943339501512
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:32:36.000Z" title="Sat Jan 31 2026 07:32:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<h3 data-id="heading-1">目标</h3>
<p>实现类似el-image组件的视频查看器，支持预览和切换。但 element -ui 中没有封装对于视频的查看组件，在多方调研后，引入<code>vue-video-player</code>实现这一功能。</p>
<h3 data-id="heading-2">功能介绍</h3>
<p><code>vue-video-player</code> 是一个基于 <strong>Video.js</strong> 封装的 Vue 组件库，旨在为 Vue 开发者提供一套简洁、可复用的视频播放器集成方案。其本质是将 Video.js 的强大功能（如 HLS 支持、字幕加载、全屏控制等）通过 Vue 的组件化机制进行封装，从而实现声明式调用和响应式更新。</p>
<h2 data-id="heading-3">官方文档</h2>
<ol>
<li>vue-video-player：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsurmon-china%2Fvideojs-player" target="_blank" title="https://github.com/surmon-china/videojs-player" ref="nofollow noopener noreferrer">github.com/surmon-chin…</a></li>
<li>video.js：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.videojs.com%2Fdocs%2Fapi%2Fplayer.html" target="_blank" title="https://docs.videojs.com/docs/api/player.html" ref="nofollow noopener noreferrer">docs.videojs.com/docs/api/pl…</a></li>
</ol>
<h2 data-id="heading-4">安装</h2>
<h3 data-id="heading-5">版本兼容性</h3>
<p>随着 Vue3 的发布及其 Composition API 的普及，vue-video-player 的维护团队逐步将开发重心转向 Vue3 生态。对于新版本有如下改变：</p>
<ul>
<li>6.x 及以上版本开始依赖 Vue3 的 runtime-core 和新的组件模型；</li>
<li>不再支持<code>Vue.use()</code>这种全局注册方式；</li>
<li>使用了 Vue3 特有的响应式系统（Proxy 代替 defineProperty）；</li>
<li>构建工具链升级至 Vite，导致与 Vue2 项目的 webpack 配置存在冲突风险。</li>
</ul>
<h3 data-id="heading-6">版本选择策略</h3>























<table><thead><tr><th>需求场景</th><th>建议版本</th><th>安装命令</th><th>引入方式</th></tr></thead><tbody><tr><td>Vue2 项目</td><td>^5.0.2</td><td><code>npm install vue-video-player@^5.0.2</code></td><td><code>Vue.use(VueVideoPlayer)</code></td></tr><tr><td>Vue3 项目</td><td>^6.0.0</td><td><code>npm install vue-video-player@latest</code></td><td><code>app.use(VueVideoPlayer)</code></td></tr></tbody></table>
<h3 data-id="heading-7">错误使用案例</h3>
<ol>
<li>在安装依赖时未注意<code>版本约束</code>，导致运行时报错：</li>
</ol>

<pre><code class="hljs language-markdown" lang="markdown">[<span class="hljs-symbol">Vue warn</span>]: <span class="hljs-link">Unknown custom element: &lt;video-player&gt;</span>
Did you register the component correctly?
</code></pre>
<p>2.  Vue2 版本最佳实践建议：</p>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// package.json 中显式锁定版本</span>
<span class="hljs-string">"dependencies"</span>: {
  <span class="hljs-string">"vue-video-player"</span>: <span class="hljs-string">"^5.0.2"</span>,
  <span class="hljs-string">"video.js"</span>: <span class="hljs-string">"^7.10.2"</span>
}

<span class="hljs-comment">// main.js 中正确引入</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueVideoPlayer</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-video-player'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'vue-video-player/node_modules/video.js/dist/video-js.css'</span>

<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueVideoPlayer</span>)
</code></pre>
<h2 data-id="heading-8">使用</h2>
<h3 data-id="heading-9">基本用法</h3>
<ol>
<li>属性配置</li>
</ol>
<p>我们可以通过playerOptions配置自定义属性，关键属性包括<code>src</code>（视频地址）、<code>:controls</code>（是否显示控制栏）、<code>:autoplay</code>（自动播放）、<code>:loop</code>（循环播放）以及<code>:volume</code>（音量设置）等。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"visible"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"video-mask-wrapper"</span> <span class="hljs-attr">tabindex</span>=<span class="hljs-string">"0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"viewer-wrapper"</span> @<span class="hljs-attr">click.self</span>=<span class="hljs-string">"handleClose"</span>&gt;</span>
         ……
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"video-player-wrapper"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"videoBoxStyle"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">video-player</span>
          <span class="hljs-attr">:key</span>=<span class="hljs-string">"`${index}-${viewerData.subLink}`"</span>
          <span class="hljs-attr">ref</span>=<span class="hljs-string">"videoPlayer"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"video-player"</span>
          <span class="hljs-attr">:options</span>=<span class="hljs-string">"playerOptions"</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: {
    ……
  },
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">playerOptions</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">autoplay</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 自动播放</span>
        <span class="hljs-attr">controls</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 显示播放控制条</span>
        <span class="hljs-attr">preload</span>: <span class="hljs-string">'metadata'</span>,
        <span class="hljs-attr">fluid</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 自适应容器，设为false，使用自定义css样式控制</span>
        <span class="hljs-attr">sources</span>: [{ <span class="hljs-attr">src</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">viewerData</span>.<span class="hljs-property">subLink</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'video/mp4'</span> }],
        <span class="hljs-attr">controlBar</span>: {
          <span class="hljs-attr">volumePanel</span>: { <span class="hljs-attr">inline</span>: <span class="hljs-literal">false</span> }, <span class="hljs-comment">// 音量面板，inline置为false时：点击音量图标时弹出独立的垂直滑块</span>
          <span class="hljs-attr">playToggle</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 控制条的播放暂停按钮</span>
        },
        <span class="hljs-attr">bigPlayButton</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 隐藏大播放按钮</span>
      };
    },
  },
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.video-mask-wrapper</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">2000</span>;
  <span class="hljs-attribute">outline</span>: none;
  <span class="hljs-selector-class">.viewer-wrapper</span> {
    <span class="hljs-attribute">position</span>: absolute;
    inset: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">2002</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">justify-content</span>: center;
    <span class="hljs-selector-class">.video-player-wrapper</span> {
      <span class="hljs-attribute">position</span>: relative;
      <span class="hljs-attribute">max-width</span>: <span class="hljs-number">1000px</span>;
      <span class="hljs-attribute">max-height</span>: <span class="hljs-number">850px</span>;
      <span class="hljs-selector-class">.video-player</span> {
        <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
      }
    }
  }
}
::v-deep .video-js {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span> <span class="hljs-meta">!important</span>;
}
::v-deep .video-js .vjs-tech {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">object-fit</span>: contain;
  <span class="hljs-attribute">background-color</span>: transparent;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>2.  方法</p>

<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">player</span> = this.<span class="hljs-variable">$refs</span>.videoPlayer &amp;&amp; this.<span class="hljs-variable">$refs</span>.videoPlayer.player<span class="hljs-comment">;</span>

player.pause()<span class="hljs-comment">;</span>
player.load()<span class="hljs-comment">;</span>
player.src(<span class="hljs-section">[{ src: newSrc, type: 'video/mp4' }]</span>)<span class="hljs-comment">;</span>
</code></pre>
<ul>
<li><code>addTextTrack()</code>：向音频/视频添加新的文本轨道。</li>
<li><code>canPlayType()</code>：检测浏览器是否能播放指定的音频/视频类型。</li>
<li><code>load()</code>：重新加载音频/视频元素。</li>
<li><code>play()</code>：开始播放音频/视频。</li>
<li><code>pause()</code>：暂停当前播放的音频/视频。</li>
<li>……</li>
</ul>
<ol start="3">
<li>事件</li>
</ol>
<ul>
<li><code>waiting</code>：当视频由于需要缓冲下一帧而停止时触发。</li>
<li><code>canplay</code>：当浏览器可以开始播放音频/视频时触发。</li>
<li><code>error</code>：当在音频/视频加载期间发生错误时触发。</li>
<li><code>loadedmetadata</code>：当浏览器已加载音频/视频的元数据时触发。</li>
<li>……</li>
</ul>
<ol start="4">
<li>支持的视频格式</li>
</ol>
<ul>
<li>可参考文档【测试说明】部分，<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.tencent.com%2Fdeveloper%2Farticle%2F1186216" target="_blank" title="https://cloud.tencent.com/developer/article/1186216" ref="nofollow noopener noreferrer">cloud.tencent.com/developer/a…</a></li>
<li>若要播放m3u8视频流：1、需要引入<code>video.js</code>并绑定到window上；2、安装依赖<code>videojs-contrib-hls</code>并引入；3、sources 要指定<code>type: application/x-mpegURL</code></li>
</ul>
<h3 data-id="heading-10">二次封装</h3>
<p>基于用户操作习惯，我们需要对播放器进行二次封装，主要包括：</p>
<h4 data-id="heading-11">播放器动态宽高</h4>
<ol>
<li>解决什么问题
<ul>
<li>播放器配置项中自带的<code>fluid</code> 属性,可以调整视频比例来自适应容器大小，但这会导致与原始比例严重失调，比如在网页上通常是宽〉高，但如果视频是竖屏的，这时就会压缩视频高度适应容器，视觉效果大打折扣。</li>
<li>视频不足以撑满整个容器时，会存在黑边</li>
</ul>
</li>
<li>解决方案：如下流程图所示，基于当前传入的视频原始尺寸、视窗宽高、设定的最大宽高，动态计算当前视频下播放器的宽高，实现在设定的最大宽高范围内：
<ul>
<li>视频宽或者高大于设定最大宽高，基于比例缩放视频宽高</li>
<li>视频宽和高都不超过设定的最大宽高，使用原始视频宽高</li>
</ul>
</li>
<li>实现效果
<ul>
<li>视频宽高和播放器宽高完全一致，避免存在黑边的现象</li>
<li>缩放后依然保持视频原始比例，保证视觉效果</li>
<li>通过CSS 样式调整，可以将播放器背景设置为transparent，当视频加载时，就不会一直呈现黑色背景</li>
</ul>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00f5c22ab42a4f0a842f34f36341d1fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3OTQzMzM5NTAxNTEy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449555&amp;x-signature=2995oLrjOolCGlR78maaSUZ7tGU%3D" alt="动态计算播放器尺寸.jpg" loading="lazy"/>
4.  部分代码</p>
<pre><code class="hljs language-ini" lang="ini"> computed: {
    // 将动态计算的视频宽高绑定到播放容器
    getVideoBoxStyle() {
      const <span class="hljs-attr">w</span> = this.boxWidth || <span class="hljs-number">0</span><span class="hljs-comment">;</span>
      const <span class="hljs-attr">h</span> = this.boxHeight || <span class="hljs-number">0</span><span class="hljs-comment">;</span>
      const <span class="hljs-attr">style</span> = {}<span class="hljs-comment">;</span>

      if (w &gt; 0 &amp;&amp; h &gt; 0) {
        <span class="hljs-attr">style.width</span> = w + <span class="hljs-string">'px'</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">style.height</span> = h + <span class="hljs-string">'px'</span><span class="hljs-comment">;</span>
      }

      return style<span class="hljs-comment">;</span>
    },
  },    
methods:{
    // 基于原始尺寸和当前可用空间，计算播放器尺寸    
    handleBoxSizeResize() {
      const { w, h } = this.naturalVideo || {}<span class="hljs-comment">;</span>
      const { LIMIT_W, LIMIT_H } = this<span class="hljs-comment">;</span>

      // 取视窗宽高与设置的最大宽高的最小值，作为播放器的最大宽高
      const <span class="hljs-attr">maxW</span> = Math.min(window.innerWidth, LIMIT_W)<span class="hljs-comment">;</span>
      const <span class="hljs-attr">maxH</span> = Math.min(window.innerHeight, LIMIT_H)<span class="hljs-comment">;</span>

      // 取宽度、高度缩放比例的最小值，保证视频完整显示
      const <span class="hljs-attr">scale</span> = Math.min(<span class="hljs-number">1</span>, Math.min(maxW / w, maxH / h))<span class="hljs-comment">;</span>

      <span class="hljs-attr">this.boxWidth</span> = Math.max(<span class="hljs-number">0</span>, Math.round(w * (isFinite(scale) ? scale : <span class="hljs-number">1</span>)))<span class="hljs-comment">;</span>
      <span class="hljs-attr">this.boxHeight</span> = Math.max(<span class="hljs-number">0</span>, Math.round(h * (isFinite(scale) ? scale : <span class="hljs-number">1</span>)))<span class="hljs-comment">;</span>
    },

    // 基于最大宽高，动态计算视频宽高
    getVideoContainerSize() {
      const <span class="hljs-attr">player</span> = this.<span class="hljs-variable">$refs</span>.videoPlayer.player<span class="hljs-comment">;</span>
      const <span class="hljs-attr">node</span> = player.el().querySelector(<span class="hljs-string">'video'</span>)<span class="hljs-comment">;</span>

      const <span class="hljs-attr">compute</span> = () =&gt; {
        const <span class="hljs-attr">originVideoWidth</span> = node.videoWidth<span class="hljs-comment">;</span>
        const <span class="hljs-attr">originVideoHeight</span> = node.videoHeight<span class="hljs-comment">;</span>
        <span class="hljs-attr">this.naturalVideo</span> = { w: originVideoWidth, h: originVideoHeight }<span class="hljs-comment">;</span>
        this.handleBoxSizeResize()<span class="hljs-comment">;</span>
      }<span class="hljs-comment">;</span>

      // 若已加载元数据，直接计算；否则监听到加载后，执行compute
      if (node &amp;&amp; node.readyState &gt;= 1) {
        compute()<span class="hljs-comment">;</span>
      } else if (node) {
        node.addEventListener('loadedmetadata', compute, { once: true })<span class="hljs-comment">;</span>
      }
    },
}
</code></pre>
<h4 data-id="heading-12">多视频切换播放</h4>
<ol>
<li>解决什么问题：当前业务背景下，多个视频在弹窗内按顺序排列，如果要查看其他视频，需要退出当前视频后，再点击另一个视频查看，操作麻烦</li>
<li>解决方案：
<ul>
<li>在视频预览页面增加左、右箭头icon，绑定click事件，基于当前视频索引，当切换上一条视频时，父组件将index-1索引的视频信息传入播放器组件，播放器重新渲染；切换下一条视频时，同理。</li>
<li>监听<code>keyDown</code>事件，按下键盘左箭头、右箭头时，同上面逻辑。</li>
<li>增加<code>watch</code>监听，当监听到视频数据 viewerData 更新时，<code>重置视频预览数据</code>，同时进行<code>视频切源</code></li>
</ul>
</li>
<li>实现效果
<ul>
<li>点击左右箭头，支持上一条/下一条切换视频</li>
<li>监听键盘事件，支持键盘左右箭头事件来切换视频</li>
</ul>
</li>
<li>部分代码</li>
</ol>

<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 重置视频状态</span>
    handleVideoStateReset() {
      <span class="hljs-keyword">this</span>.boxWidth = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">this</span>.boxHeight = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">this</span>.naturalVideo = { w: <span class="hljs-number">0</span>, h: <span class="hljs-number">0</span> };
      <span class="hljs-keyword">this</span>.isLoading = <span class="hljs-literal">true</span>;
      <span class="hljs-keyword">this</span>.loadError = <span class="hljs-literal">false</span>;
    },
    <span class="hljs-comment">// 视频切源</span>
    handleVideoCutResource() {
      <span class="hljs-keyword">const</span> player = <span class="hljs-keyword">this</span>.$refs.videoPlayer &amp;&amp; <span class="hljs-keyword">this</span>.$refs.videoPlayer.player;
      <span class="hljs-keyword">const</span> newSrc = <span class="hljs-keyword">this</span>.viewerData &amp;&amp; <span class="hljs-keyword">this</span>.viewerData.subLink;

      <span class="hljs-keyword">if</span> (player &amp;&amp; newSrc) {
        player.pause();
        player.src([{ src: newSrc, type: <span class="hljs-string">'video/mp4'</span> }]);
        player.load();

        <span class="hljs-comment">// 监听视频事件</span>
        <span class="hljs-keyword">this</span>.bindVideoEvents(player);

        player.one(<span class="hljs-string">'loadedmetadata'</span>, () =&gt; {
          <span class="hljs-keyword">this</span>.getVideoContainerSize();
        });
      }
    },    
    <span class="hljs-comment">// 上一个视频</span>
    handlePreVideoChange(index) {
      <span class="hljs-keyword">this</span>.handleVideoSwitch(index, -<span class="hljs-number">1</span>, <span class="hljs-keyword">this</span>.dialogData.carveUrlList.length);
    },
    <span class="hljs-comment">// 下一个视频</span>
    handleNextVideoChange(index) {
      <span class="hljs-keyword">this</span>.handleVideoSwitch(index, <span class="hljs-number">1</span>, <span class="hljs-keyword">this</span>.dialogData.carveUrlList.length);
    },
    <span class="hljs-comment">// 键盘左右箭头切换视频</span>
    handleVideoKeyDown(event) {
      <span class="hljs-keyword">const</span> length = <span class="hljs-keyword">this</span>.dialogData.carveUrlList.length;
      <span class="hljs-keyword">const</span> index = Number(<span class="hljs-keyword">this</span>.videoSafeAreaViewer.index) || <span class="hljs-number">0</span>;

    <span class="hljs-comment">// 视频查看器未渲染、视频列表为空、只有一个视频时，不执行切换事件</span>
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.videoSafeAreaViewer.visible || !length || length === <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-keyword">if</span> (event.key === <span class="hljs-string">'ArrowRight'</span>) {
        <span class="hljs-keyword">this</span>.handleVideoSwitch(index, <span class="hljs-number">1</span>, length);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event.key === <span class="hljs-string">'ArrowLeft'</span>) {
        <span class="hljs-keyword">this</span>.handleVideoSwitch(index, -<span class="hljs-number">1</span>, length);
      }
    },
    <span class="hljs-comment">// 切换视频</span>
    handleVideoSwitch(index, step, len) {
      <span class="hljs-keyword">const</span> videoList = <span class="hljs-keyword">this</span>.dialogData.carveUrlList || [];
      <span class="hljs-keyword">const</span> idx = (index + step + len) % len;

      <span class="hljs-keyword">this</span>.handleVideoPreview(videoList[idx], idx, <span class="hljs-keyword">this</span>.dialogData.carveUrlList);
    },
</code></pre>
<h4 data-id="heading-13">视频加载提示</h4>
<ol>
<li>解决什么问题
<ul>
<li>视频加载时，页面没有内容显示，用户对视频加载无感知</li>
</ul>
</li>
<li>解决方案：在视频播放器容器中，增加提示块
<ul>
<li>视频加载中，设置 isLoading: true，渲染提示块，提示内容：视频正在加载中，请稍后……</li>
<li>视频加载失败，设置 loadingError: true，渲染提示块，提示内容：视频加载失败；增加<code>el-icon-refresh-left</code>图标，绑定click事件支持重新加载</li>
<li>重新加载事件包括：1、重置预览数据，2、视频切源</li>
<li>视频加载完成，提示块不可见，播放视频</li>
</ul>
</li>
<li>实现效果
<ul>
<li>视频加载中、加载失败提示，用户可感知视频加载进度</li>
<li>加载失败时支持重新加载，避免因偶发网络原因导致的失败，用户无需刷新/退出就能再次尝试加载视频</li>
</ul>
</li>
<li>部分代码</li>
</ol>

<pre><code class="hljs language-xml" lang="xml"> <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"video-player-wrapper"</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"getVideoBoxStyle"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 视频加载提示 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"isLoading || loadingError"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"video-status-tip"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-content"</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 加载中 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLoading &amp;&amp; !loadingError"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"loading-state"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-icon-loading status-icon"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-text"</span>&gt;</span>视频正在加载中，请稍后...<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 加载失败 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"loadingError"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"error-state"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"status-text"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"color: #f56c6c"</span>
                &gt;</span>视频加载失败<span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-icon-refresh-left"</span> @<span class="hljs-attr">click.stop</span>=<span class="hljs-string">"handleVideoReload"</span>&gt;</span>&lt;/i
              &gt;<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 视频播放器 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">video-player</span>
          <span class="hljs-attr">:key</span>=<span class="hljs-string">"`${index}-${viewerData.subLink}`"</span>
          <span class="hljs-attr">ref</span>=<span class="hljs-string">"videoPlayer"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"video-player"</span>
          <span class="hljs-attr">:options</span>=<span class="hljs-string">"playerOptions"</span>
          @<span class="hljs-attr">dblclick.native</span>=<span class="hljs-string">"toggleFullscreen"</span>
          @<span class="hljs-attr">waiting</span>=<span class="hljs-string">"handleVideoWaiting"</span>
          @<span class="hljs-attr">canplay</span>=<span class="hljs-string">"handleVideoCanPlay"</span>
          @<span class="hljs-attr">loadeddata</span>=<span class="hljs-string">"handleVideoLoadedData"</span>
          @<span class="hljs-attr">error</span>=<span class="hljs-string">"handleVideoError"</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-14">双击进入/退出全屏</h4>
<ol>
<li>解决什么问题：video-player组件未显示配置双击进入/退出全屏事件，需要手动绑定dbclick事件</li>
<li>解决方案：为视频播放器绑定dbclick事件</li>
<li>实现效果：非全屏状态下双击全屏播放，反之退出全屏状态</li>
<li>部分代码</li>
</ol>

<pre><code class="hljs language-ini" lang="ini">  // 双击切换全屏
    toggleFullscreen() {
      const <span class="hljs-attr">videoPlayer</span> = this.<span class="hljs-variable">$refs</span>.videoPlayer<span class="hljs-comment">;</span>
      const <span class="hljs-attr">player</span> = videoPlayer &amp;&amp; videoPlayer.player<span class="hljs-comment">;</span>

      if (!player) {
        console.warn('<span class="hljs-section">[MKVideoSafeAreaViewer]</span> toggleFullscreen: player not ready')<span class="hljs-comment">;</span>
        return<span class="hljs-comment">;</span>
      }

      if (player.isFullscreen()) {
        player.exitFullscreen()<span class="hljs-comment">;</span>
      } else {
        player.requestFullscreen()<span class="hljs-comment">;</span>
      }
    },
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-appD4（uni-forms学习与回顾）]]></title>    <link>https://juejin.cn/post/7601044684773883942</link>    <guid>https://juejin.cn/post/7601044684773883942</guid>    <pubDate>2026-01-31T07:33:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601044684773883942" data-draft-id="7599634796583960582" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-appD4（uni-forms学习与回顾）"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2026-01-31T07:33:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱泡脚的鸡腿"/> <meta itemprop="url" content="https://juejin.cn/user/4466663535419179"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-appD4（uni-forms学习与回顾）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4466663535419179/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱泡脚的鸡腿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:33:45.000Z" title="Sat Jan 31 2026 07:33:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.补充小程序路由跳转方式</h2>
<p><strong>·wx.navigateTo：</strong> 按照顺序向页面栈中放入打开过的页面</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43cafe65021b42249ecc99940ac716d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=5R0oOb%2F7cV8sWmJkzJ%2FVKPpDcAg%3D" alt="image.png" loading="lazy"/> <strong>·wx.redierctTo：</strong> 先把上一个页面删掉，再把自己页面放入栈内</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a24954e26404475af5c49f34f3a29f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=W75oxZoWq46clwuEO21nKP4feDI%3D" alt="image.png" loading="lazy"/></p>
<p><strong>·wx.reLaunch：</strong> 清空页面栈</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46b7b99c955747b4aaf3faa50f4a8d1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=nLhkjbqfKYCNjqmLc%2F2jMFmPf%2FQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2. uni-file-picker：实现文件上传功能</h2>
<h3 data-id="heading-2">2.1 开通uniCloud Web云存储空间</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.dcloud.net.cn%2F" target="_blank" title="https://dev.dcloud.net.cn/" ref="nofollow noopener noreferrer">dev.dcloud.net.cn/</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91ccabdb148e4ea58c65e1828c5369b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=Mn1DAul8DG%2BKxzPY0jg5ny7BWh8%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 在项目中与云空间关联</h3>
<p>先创建云开发环境
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52e83cff49fb4d07bbc2ea7a8a062599~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=s9kC6aXT2fnUI6aLo7jnrS8x1uY%3D" alt="image.png" loading="lazy"/>
再点击关联</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4b0a252df69459993bf71a45aa929cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=8weVuhl7OD32II8H3ZA0Q1kup%2BU%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/730194352ffa4408986f656db1ba4eef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=vMWoGaHeiLb0vShb%2FpdEZr0g2FE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-4">2.3 使用uni-file-picker</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Fcomponent%2Funiui%2Funi-file-picker.html" target="_blank" title="https://uniapp.dcloud.net.cn/component/uniui/uni-file-picker.html" ref="nofollow noopener noreferrer">uni-app官网</a>
上传结果可以使用v-model获取</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aa3625cc1e84d23a402ba4c074287ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=QlLeodt6Dfse81dGxQxasuz%2Fo%2BM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">2.3.1 验证</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c3871ba486b4ed48a36f949427c8627~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=XTEpWN9PVQ4Xv0uP8Ghn0wY0tew%3D" alt="image.png" loading="lazy"/><br/>
<strong>上面的数组和下方的数组必须至少都要有一个单元，否则‘提交’按钮不高亮</strong></p>
<h5 data-id="heading-6">2.3.1.1 定义上凭证与下凭证数组</h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c937fe481414434a93ef540c0957175c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=ChPdiP1k5CX8i7Dsr5T2NxCuis8%3D" alt="image.png" loading="lazy"/>
<strong>做判断，当两个数组都有数据时才不禁用button</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce2badfd1e9e4ce29379764d83f2f8f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=2aD04h8te2vo3fETMgRw4pt63sw%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">2.4 接口只需要url，所以要处理掉其他的字段</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54a3c9d3d3784bb88e7330d07946f54e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=c2CoJF90KlR2bWWr%2Fh7viYFg%2BbU%3D" alt="image.png" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f889657491d147dd9298dfc3fb482551~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=6R6huxVJTr5mq1DUlbbE8XoIWpE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/764ebf173f954fc7a122fa3b641f5535~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=zrOhv%2FWlqmlLz4kKDGh13%2F0mjWs%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4023b67ff0c542e99db974d25b35b62c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=1Ucjlv36PTzrqDkfEl3Qt930Yzs%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">2.5 当用户点击提交的时候，调用接口，提交数组的url</h3>
<h4 data-id="heading-9">2.5.1 封装接口</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/886403218b664269bdb0c59ad14291f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=r7nz4K3kvf5ovQqq85Z9aBikjX4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">2.5.2 监听按钮</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95c614b61d6641e9b6b5ad81ace1e73d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=3VzlTwArXxQv8vtXXMcGFWk4BWQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c2d89725607488eb1ee22a77b334892~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=S8qp5IggS1JVKi%2BKk%2BJJ4QAFnsc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-11">3 在途</h2>
<p>注意：是一对一运送，所以在途最多只能有一条任务</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be0aa6ffb125412d85c45897bdadd102~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=cTQ5tCxHncxOgmGk4Gh%2BQswrxLk%3D" alt="image.png" loading="lazy"/>
实现组件一加载就执行逻辑
<strong>获取接口数据</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9bd2b5ee10a41f2826e91f7cb8aa32e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=NMLyBSovM1ag4wL6z77IagxWid8%3D" alt="image.png" loading="lazy"/>
<strong>渲染数据</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04d0fce3cf08464f849fafdfcfe5944e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=4%2B%2FJWRZmwDmCNxV8kqa1UGlSYsI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48549e4772744da98ae0e1781e1e537f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=%2BRUSn65i6sNYRDj6hPO6WJHdlXw%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-12">4 异常上报</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad8f1b3487a84c5b9bf995c6e0ff5a41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=UscvTdvzQEavNgjqWdOQNjXRuyk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">4.1 异常时间</h3>
<p>使用到uni-datetime-picker和uni-list组件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3834044bc66940f690e625cd8d10d3d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=xmrdDOlYi2uXZ5SJ0kRefp1Iqw4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0283692e9a67492b96f8ece6b6ab9e5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=qwmpiaFPMnLvVjx%2F3Dcv42L4cJ8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/062e9898e75746d8b678ec43f976309c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=W9wH52xCD3udA05WllskoM96pnY%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-14">4.2 上报位置</h3>
<p>需要调用wx.chooseLocation和wx.chooseLocation</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6efd3ca87c00466fba56da5c647c8b0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=vEoNcr42NlYCNxY1bx1QHowrwrg%3D" alt="image.png" loading="lazy"/>
去腾讯申请key</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d987c9069314400bb908331ce7f463a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=NToQ7MUAvSVgLml4NbvY1bn9hv4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/652b68bb52af4fb0a9b65452325697cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=spMIMMdfSUO%2FW0F%2FNSC2AfLQ8Vw%3D" alt="image.png" loading="lazy"/>
拿到用户选择的地址，渲染到页面上
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b9dab8f44614e5781927b4e2fc393cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=ZgzD0isYR4HgIhA5dPy9r7BQyrQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-15">4.3 异常类型</h3>
<p>使用change事件监听用户有没有选择或者有没有取消</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bd12f666cb7424380585e92e77450b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=f8F0Ej35HhxaIcUkIp4SPCgZhzQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fad193d5c4a45cfba6ff1af433692a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=clIIJ%2FRK3ZtuQWO2qrmslfnFd8E%3D" alt="image.png" loading="lazy"/>
监听事件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73e8688b2bea41b89fff2f16ac6e646e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=MktKcq2P%2FQZ4oOiEFZCkaRIvhbc%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e305494cfdf04e6a965b0eab662197ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=xyQ9tD5SYnuWCndJKxKdPLvmuNE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5746e2562cfc4c749aa45649a162fb77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=LymK6LA6J8%2FPESvhtoMIZCBFlos%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/778c5fe29a084aa8b89aaa21258b9fd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=b3dzsKIVs%2FxUW90FqjtkXWfBJ%2FU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-16">4.4 异常描述</h3>
<p>使用v-model获取即可</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5801d1ed7acd47f1ab82f019d9356be1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=sKM8CLJo%2FwNNkA9qIRAYD4khmAY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3c74b439a4b469dab44cd327d1200ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=vYEdjgKolkpnMQMPpHBEuUfmxkU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-17">4.5 异常图片</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c0f4561bf8a42e4b45706b52b609ba3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=%2FnCmpuMES9gB%2FpgErOFXg%2BA0j5Y%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6656266056834da5b84d60131d503c1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=EAyb54U1liSnjc4uBQwt5ZAqybg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-18">4.6 调用接口用于提交数据</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80785df083b943e7af7a44cd9eedcc46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=ighVrhHBg3ifuj7p3f7x47vclNI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67c77e47ac1d451e92be7f26c97a8fb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=6L%2F4dT%2BeMtRZXNi4jPYD2QCmtFg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-19">4.7 用户选择异常类型，并且回显到页面</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9b107c2623443cfba3d655b8af23a1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=rdCTzjfSAWaXQww0vIZUR4nkHvs%3D" alt="image.png" loading="lazy"/>
<strong>渲染回显</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/004d8ed45d2d468f9dfc433276fd69cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=270tFMszEnOaO1PnWVp1SRAfq4E%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f34c61f2ce34c9daa143dda0a6d51ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=8XO2NcIPtcY9hbu5fcZOKHtwZ1Q%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fdfb63665e5f42a6ba26d422a7df2f4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=C8zgBHsd1rZVkhYpBl23WVIVAk0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-20">4.8 调用接口</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8236d40f03be4ed68dbee8087cec5606~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=9AAIm%2F9o1jVaMaGgdp%2FRJH3vqH8%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/934cbc30c2a74b1f9aff04befc02b736~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=X%2Blmik5iNW3vFX26j18%2FApL7EAg%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ed825c0068f4b50a19d1e2caf7e4edf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=IPjuCdJcr%2BFqgCD%2FKziqHCmHoB8%3D" alt="image.png" loading="lazy"/>
其中传过去的id要从url中获取，所以又要使用onLoad，来获取id（这里的id对应的参数名为transportTaskId）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afc8df7be1e24b3388f101ccb2809df3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=bOLkESwWpq9mB1yCiNzpxgpS3TU%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19141a7f8d2447fca7f3705e13eab317~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=Xj1aFI1%2FXBktAXRJTpvDcOPAwmQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f99b5b332f04986a96974df1a798537~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=kjbS1DQj9FxpaYP6n%2BJEtkSPOrY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-21">5 异常信息存在就显示，没有则隐藏</h2>
<p><strong>渲染数据</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9b3465f645f450987b2b88c9699f91b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rOh6ISa55qE6bih6IW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770449630&amp;x-signature=W63pothzIH6JQXykhmAdjIKtsmg%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS伪元素：给HTML穿上"隐形斗篷"的魔法]]></title>    <link>https://juejin.cn/post/7601053058856206342</link>    <guid>https://juejin.cn/post/7601053058856206342</guid>    <pubDate>2026-01-31T07:46:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601053058856206342" data-draft-id="7600994087588495379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" CSS伪元素：给HTML穿上&quot;隐形斗篷&quot;的魔法"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-31T07:46:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lee川"/> <meta itemprop="url" content="https://juejin.cn/user/2402874087453658"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             CSS伪元素：给HTML穿上"隐形斗篷"的魔法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2402874087453658/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lee川
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:46:01.000Z" title="Sat Jan 31 2026 07:46:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CSS伪元素：给HTML穿上"隐形斗篷"的魔法</h2>
<h3 data-id="heading-1">引言：一场看不见的化妆舞会</h3>
<p>想象一下，你在参加一场化妆舞会，但规则很特别：你<strong>不能</strong>给自己戴上面具或穿上戏服，只能请一位"魔法化妆师"（CSS）在你身上直接绘制妆容。这位化妆师手法高超，他能凭空在你耳边画上耳环，在额头点上装饰——而这一切都不需要你真正佩戴任何实物。</p>
<p>这就是<strong>CSS伪元素</strong>的魔法！它们就像HTML元素的"隐形斗篷"，让我们在不修改HTML结构的情况下，为页面添加各种装饰效果。</p>
<h3 data-id="heading-2">第一章：认识"双胞胎幽灵"——::before和::after</h3>
<p>伪元素中最常用的就是这对"双胞胎兄弟"：<code>::before</code>和 <code>::after</code>。它们不是HTML中真实存在的元素，而是CSS创造的"幽灵元素"。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 魔法咒语的基本格式 */</span>
.元素<span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>; <span class="hljs-comment">/* 魔法的核心：必须念出咒语 */</span>
    <span class="hljs-comment">/* 其他样式属性 */</span>
}

.元素<span class="hljs-selector-pseudo">::after</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>; <span class="hljs-comment">/* 同样需要咒语 */</span>
    <span class="hljs-comment">/* 其他样式属性 */</span>
}
</code></pre>
<h4 data-id="heading-3">魔法规则第一条：content咒语</h4>
<p><code>content</code>属性是开启伪元素魔法的<strong>钥匙</strong>。即使你想创建空的内容，也必须写上 <code>content: ""</code>，就像念咒语一样，不念就没魔法！</p>
<h3 data-id="heading-4">第二章：伪元素的实战魔法——创建笑脸表情</h3>
<p>让我们回到文章开头的代码，看看这个"笑脸魔法"是如何实现的：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 基础的脸部 */</span>
<span class="hljs-selector-class">.face</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffdd59</span>; <span class="hljs-comment">/* 阳光黄色 */</span>
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>; <span class="hljs-comment">/* 变成圆形 */</span>
    <span class="hljs-attribute">position</span>: relative; <span class="hljs-comment">/* 重要：为伪元素设置舞台 */</span>
}

<span class="hljs-comment">/* 召唤两只"幽灵眼睛" */</span>
<span class="hljs-selector-class">.face</span><span class="hljs-selector-pseudo">::after</span>, <span class="hljs-selector-class">.face</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>; <span class="hljs-comment">/* 念咒语：创造存在 */</span>
    <span class="hljs-attribute">position</span>: absolute; <span class="hljs-comment">/* 让它们漂浮在脸部上 */</span>
    <span class="hljs-attribute">width</span>: <span class="hljs-number">18px</span>;  <span class="hljs-comment">/* 眼睛宽度 */</span>
    <span class="hljs-attribute">height</span>: <span class="hljs-number">8px</span>;  <span class="hljs-comment">/* 眼睛高度 */</span>
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#badc58</span>; <span class="hljs-comment">/* 清新的黄绿色 */</span>
    <span class="hljs-attribute">top</span>: <span class="hljs-number">20px</span>; <span class="hljs-comment">/* 从头顶往下20像素 */</span>
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>; <span class="hljs-comment">/* 椭圆形的眼睛 */</span>
}

<span class="hljs-comment">/* 右眼：调皮地往右看 */</span>
<span class="hljs-selector-class">.face</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">right</span>: -<span class="hljs-number">8px</span>; <span class="hljs-comment">/* 从右边往左偏移8px，稍微突出 */</span>
}

<span class="hljs-comment">/* 左眼：俏皮地往左看 */</span>
<span class="hljs-selector-class">.face</span><span class="hljs-selector-pseudo">::after</span> {
    <span class="hljs-attribute">left</span>: -<span class="hljs-number">5px</span>; <span class="hljs-comment">/* 从左边往右偏移5px，稍微突出 */</span>
}
</code></pre>
<h4 data-id="heading-5">魔法效果可视化：</h4>
<pre><code class="hljs language-scss" lang="scss">👁️          😊         👁️
      (::before)   (.face)    (::after)
       右眼幽灵      笑脸主体    左眼幽灵
       向右突出                向左突出
</code></pre>
<p>这个笑脸最妙的地方在于：HTML只需要一个简单的 <code>&lt;div class="face"&gt;&lt;/div&gt;</code>，所有的眼睛装饰都由CSS凭空创造！</p>
<h3 data-id="heading-6">第三章：为什么不用真实元素？——魔法的智慧</h3>
<p>你可能会问："为什么不用真实的 <code>&lt;span&gt;</code>元素来当眼睛呢？"</p>
<p>让我们对比一下两种方式：</p>
<h4 data-id="heading-7">方式A：使用真实元素（麻瓜方法）</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"face"</span>&gt;
    &lt;span <span class="hljs-attr">class</span>=<span class="hljs-string">"eye left"</span>&gt;&lt;/span&gt;
    &lt;span <span class="hljs-attr">class</span>=<span class="hljs-string">"eye right"</span>&gt;&lt;/span&gt;
&lt;/div&gt;
</code></pre>
<h4 data-id="heading-8">方式B：使用伪元素（巫师方法）</h4>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"face"</span>&gt;&lt;/div&gt;
</code></pre>
<p><strong>巫师的三大理由：</strong></p>
<ol>
<li><strong>HTML保持纯净</strong>：HTML应该只关心<strong>内容结构</strong>，而不是<strong>表现装饰</strong>。眼睛是装饰，不是内容。</li>
<li><strong>维护更容易</strong>：想改变眼睛样式？只需修改CSS，完全不用碰HTML。</li>
<li><strong>性能更优</strong>：伪元素不会增加真实的DOM节点，浏览器渲染起来更轻快。</li>
</ol>
<h3 data-id="heading-9">第四章：伪元素的更多魔法应用</h3>
<p>伪元素的魔法远不止画眼睛！它们在Web设计中无处不在：</p>
<h4 data-id="heading-10">魔法1：优雅的引用标记</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">blockquote</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">"“"</span>; <span class="hljs-comment">/* 左引号 */</span>
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">3em</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#ccc</span>;
}

<span class="hljs-selector-tag">blockquote</span><span class="hljs-selector-pseudo">::after</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">"”"</span>; <span class="hljs-comment">/* 右引号 */</span>
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">3em</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#ccc</span>;
}
</code></pre>
<h4 data-id="heading-11">魔法2：自定义列表图标</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">li</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">"✨"</span>; <span class="hljs-comment">/* 星星图标 */</span>
    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">10px</span>;
}
</code></pre>
<h4 data-id="heading-12">魔法3：工具提示的小箭头</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.tooltip</span><span class="hljs-selector-pseudo">::after</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-comment">/* 绘制三角形箭头 */</span>
    <span class="hljs-attribute">border</span>: <span class="hljs-number">10px</span> solid transparent;
    <span class="hljs-attribute">border-top-color</span>: <span class="hljs-number">#333</span>;
}
</code></pre>
<h3 data-id="heading-13">第五章：伪元素的工作原理——魔法的科学</h3>
<p>虽然叫"伪元素"，但它们在浏览器中表现得像真实元素一样：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 浏览器眼中的伪元素 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"face"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 这是::before --&gt;</span>
    😉
    <span class="hljs-comment">&lt;!-- 这是元素的实际内容（如果有的话） --&gt;</span>
    😊
    <span class="hljs-comment">&lt;!-- 这是::after --&gt;</span>
    😉
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-14">位置关系三兄弟：</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 源代码顺序 */</span>
.元素<span class="hljs-selector-pseudo">::before</span> { <span class="hljs-comment">/* 大哥：在最前面 */</span> }
.元素 { <span class="hljs-comment">/* 二弟：实际内容 */</span> }
.元素<span class="hljs-selector-pseudo">::after</span> { <span class="hljs-comment">/* 三弟：在最后面 */</span> }
</code></pre>
<h3 data-id="heading-15">第六章：伪元素 vs 伪类——不要搞混的魔法</h3>
<p>新手常把伪元素和伪类搞混，记住这个简单区别：</p>
<ul>
<li>
<p><strong>伪元素</strong>：<code>::before</code>、<code>::after</code>、<code>::first-line</code></p>
<ul>
<li><strong>创造</strong>新的虚拟元素</li>
<li>双冒号 <code>::</code>（CSS3规范，兼容单冒号<code>:</code>）</li>
</ul>
</li>
<li>
<p><strong>伪类</strong>：<code>:hover</code>、<code>:focus</code>、<code>:nth-child()</code></p>
<ul>
<li><strong>选择</strong>元素的特定状态</li>
<li>单冒号 <code>:</code></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 伪类：鼠标悬停时变色 */</span>
<span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">background-color</span>: blue;
}

<span class="hljs-comment">/* 伪元素：添加装饰性内容 */</span>
<span class="hljs-selector-tag">button</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">"👉 "</span>;
}
</code></pre>
<h3 data-id="heading-16">第七章：魔法的局限与禁忌</h3>
<p>虽然伪元素很强大，但也不是万能的：</p>
<h4 data-id="heading-17">可以用伪元素（装饰性内容）：</h4>
<p>✅ 装饰性图标、角标</p>
<p>✅ 工具提示的箭头</p>
<p>✅ 引用符号</p>
<p>✅ 清除浮动的空元素</p>
<p>✅ <strong>我们的笑脸眼睛</strong></p>
<h4 data-id="heading-18">不要用伪元素（重要内容）：</h4>
<p>❌ 重要的导航链接</p>
<p>❌ 需要被搜索引擎收录的文字</p>
<p>❌ 需要JavaScript交互的元素</p>
<p>❌ 对可访问性重要的内容</p>
<h3 data-id="heading-19">第八章：现代魔法进阶</h3>
<h4 data-id="heading-20">组合魔法：多重伪元素</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/* 创建更复杂的装饰 */</span>
.icon::before {
    <span class="hljs-comment">/* 背景层 */</span>
}
.icon::after {
    <span class="hljs-comment">/* 前景层 */</span>
}
</code></pre>
<h4 data-id="heading-21">动态魔法：结合CSS变量</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.face</span><span class="hljs-selector-pseudo">::before</span> {
    <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-built_in">var</span>(--eye-size, <span class="hljs-number">18px</span>);
    <span class="hljs-attribute">height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-built_in">var</span>(--eye-size, <span class="hljs-number">18px</span>) * <span class="hljs-number">0.444</span>);
}
</code></pre>
<h3 data-id="heading-22">结语：成为CSS魔法师</h3>
<p>CSS伪元素就像Web开发中的"隐形画笔"，让我们能够：</p>
<ol>
<li><strong>保持HTML的语义纯净</strong>——内容就是内容，装饰交给CSS</li>
<li><strong>实现优雅的视觉效果</strong>——无需污染DOM结构</li>
<li><strong>提高代码维护性</strong>——所有样式集中管理</li>
<li><strong>优化页面性能</strong>——减少不必要的DOM节点</li>
</ol>
<p>记住这个魔法口诀：</p>
<blockquote>
<p><strong>"content不可少，定位要记牢，装饰用伪元，内容用标签"</strong></p>
</blockquote>
<p>下次当你想要添加一些装饰性元素时，先问问自己："这可以用伪元素实现吗？" 很多时候，答案都是肯定的！</p>
<p>现在，拿起你的CSS魔杖（键盘），开始用伪元素创造更多神奇的Web魔法吧！🎩✨</p>
<hr/>
<p><strong>魔法小测验</strong>：你能只用CSS伪元素创建一个完整的太阳系动画吗？提示：一个div代表太阳，伪元素代表行星... 无限创意等着你！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从入门到落地：MindSpore实战指南与经验总结]]></title>    <link>https://juejin.cn/post/7600999271770537984</link>    <guid>https://juejin.cn/post/7600999271770537984</guid>    <pubDate>2026-01-31T07:50:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600999271770537984" data-draft-id="7601049142865625088" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从入门到落地：MindSpore实战指南与经验总结"/> <meta itemprop="keywords" content="人工智能,机器学习"/> <meta itemprop="datePublished" content="2026-01-31T07:50:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="skytier"/> <meta itemprop="url" content="https://juejin.cn/user/2067496505970135"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从入门到落地：MindSpore实战指南与经验总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2067496505970135/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    skytier
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:50:21.000Z" title="Sat Jan 31 2026 07:50:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>MindSpore是华为自研全场景AI框架，覆盖开发、训练、部署全链路，适配多领域需求，助力新手入门与资深开发者落地项目。</p>
<p>本文精简提炼入门准备、核心实操、模型部署、性能优化、问题排查五大模块的实战要点，帮助开发者快速上手、少走弯路。</p>
<h2 data-id="heading-0">一、入门准备：找准方向，快速搭建可用环境</h2>
<p>新手入门核心原则：先明确框架定位，再按需搭建环境，避免无效投入。</p>
<h3 data-id="heading-1">1. 先搞懂：MindSpore的核心优势与适用场景</h3>
<p>MindSpore核心优势与适用场景：</p>






























<table><thead><tr><th>核心特性</th><th>核心价值</th><th>适用场景</th></tr></thead><tbody><tr><td>动静态图统一</td><td>调试便捷、执行高效，一键切换</td><td>研发调试、量产部署</td></tr><tr><td>全场景部署</td><td>端边云无缝迁移，一次开发多端部署</td><td>边缘推理、云端训练</td></tr><tr><td>自动并行</td><td>无需手动编写并行逻辑</td><td>大规模训练任务</td></tr><tr><td>自动微分</td><td>省去手动反向传播代码</td><td>各类深度学习模型开发</td></tr></tbody></table>
<p>新手建议：优先掌握动态图模式与基础流程，再学静态图优化。</p>
<h3 data-id="heading-2">2. 环境搭建：3步搞定，避开版本兼容坑</h3>
<p>新手优先选CPU版本快速验证，环境搭建关键步骤：</p>
<h4 data-id="heading-3">（1）版本选型与安装</h4>
<p>核心注意：Python需3.7~3.9，推荐清华源安装：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 核心安装命令（三选一）﻿</span>
pip install <span class="hljs-attr">mindspore-cpu</span>==<span class="hljs-number">2.2</span>.<span class="hljs-number">10</span> -i https://pypi.tuna.tsinghua.edu.cn/simple
pip install <span class="hljs-attr">mindspore-gpu</span>==<span class="hljs-number">2.2</span>.<span class="hljs-number">10</span> -i https://pypi.tuna.tsinghua.edu.cn/simple
pip install <span class="hljs-attr">mindspore-ascend</span>==<span class="hljs-number">2.2</span>.<span class="hljs-number">10</span> -i https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre>
<h4 data-id="heading-4">（2）环境验证</h4>
<p>环境验证（输出(32, 1)即正常）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> mindspore <span class="hljs-keyword">as</span> ms
<span class="hljs-keyword">import</span> mindspore.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

ms.set_context(mode=ms.PYNATIVE_MODE, device_target=<span class="hljs-string">"CPU"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleNet</span>(nn.Cell):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.linear = nn.Dense(<span class="hljs-number">10</span>, <span class="hljs-number">1</span>)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self, x</span>):
        <span class="hljs-keyword">return</span> self.linear(x)

<span class="hljs-built_in">print</span>(SimpleNet()(ms.Tensor(np.random.randn(<span class="hljs-number">32</span>, <span class="hljs-number">10</span>), ms.float32)).shape)
</code></pre>
<h4 data-id="heading-5">（3）避坑要点</h4>
<ul>
<li>安装失败先查Python版本，冲突用虚拟环境；</li>
<li>昇腾版本需匹配驱动与CANN工具包。</li>
</ul>
<h3 data-id="heading-6">3. 工具选型：3个核心工具提升开发效率</h3>
<p>核心开发工具（3个）：</p>

























<table><thead><tr><th>工具名称</th><th>核心功能</th><th>入门用法</th></tr></thead><tbody><tr><td>MindStudio</td><td>集成开发、调试、部署</td><td>选MindSpore模板，断点调试</td></tr><tr><td>MindSpore Hub</td><td>提供预训练模型</td><td>直接加载微调</td></tr><tr><td>MindSpore Profiler</td><td>性能分析</td><td>定位训练/推理瓶颈</td></tr></tbody></table>
<h2 data-id="heading-7">二、核心功能实操：从数据到模型的全流程拆解</h2>
<p>核心开发流程：数据处理→模型构建→训练推理，以下为精简实操要点。</p>
<h3 data-id="heading-8">1. 数据处理：用Dataset模块高效搞定数据加载</h3>
<p>数据处理核心：Dataset模块，重点掌握两种场景。</p>
<h4 data-id="heading-9">（1）基础数据集加载（以CIFAR-10为例）</h4>
<p>基础数据集加载（CIFAR-10）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> mindspore.dataset <span class="hljs-keyword">as</span> ds
<span class="hljs-keyword">import</span> mindspore.dataset.vision <span class="hljs-keyword">as</span> vision

<span class="hljs-comment"># 加载并预处理</span>
train_dataset = ds.Cifar10Dataset(<span class="hljs-string">"./cifar10"</span>, usage=<span class="hljs-string">"train"</span>, shuffle=<span class="hljs-literal">True</span>)
train_dataset = train_dataset.<span class="hljs-built_in">map</span>([vision.Resize((<span class="hljs-number">224</span>,<span class="hljs-number">224</span>)), 
                                   vision.Normalize([<span class="hljs-number">0.485</span>,<span class="hljs-number">0.456</span>,<span class="hljs-number">0.406</span>],[<span class="hljs-number">0.229</span>,<span class="hljs-number">0.224</span>,<span class="hljs-number">0.225</span>]),
                                   vision.HWC2CHW()], <span class="hljs-string">"image"</span>).batch(<span class="hljs-number">32</span>)
</code></pre>
<h4 data-id="heading-10">（2）自定义数据集（加载本地图片文件夹）</h4>
<p>自定义数据集核心代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> cv2
<span class="hljs-keyword">import</span> mindspore.dataset <span class="hljs-keyword">as</span> ds
<span class="hljs-keyword">import</span> mindspore <span class="hljs-keyword">as</span> ms

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomDataset</span>(ds.Dataset):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, image_paths, labels</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.image_paths, self.labels = image_paths, labels
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, i</span>):
        img = cv2.imread(self.image_paths[i])
        img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
        img = cv2.resize(img, (<span class="hljs-number">224</span>,<span class="hljs-number">224</span>))/<span class="hljs-number">255.0</span>
        <span class="hljs-keyword">return</span> ms.Tensor(img.astype(np.float32)), ms.Tensor(self.labels[i], ms.int32)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.image_paths)
</code></pre>
<h4 data-id="heading-11">避坑要点</h4>
<ul>
<li>保证数据格式与模型要求一致（默认CHW）；</li>
<li>大规模数据用shard+多进程提升效率。</li>
</ul>
<h3 data-id="heading-12">2. 模型构建：继承Cell类快速搭建网络</h3>
<p>模型构建核心：继承nn.Cell，在construct定义前向传播。</p>
<h4 data-id="heading-13">（1）基础网络构建（简化版ResNet18）</h4>
<p>基础网络构建（简化ResNet）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> mindspore.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">from</span> mindspore.common.initializer <span class="hljs-keyword">import</span> HeNormal

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BasicBlock</span>(nn.Cell):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, in_c, out_c, stride=<span class="hljs-number">1</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.conv1 = nn.Conv2d(in_c, out_c, <span class="hljs-number">3</span>, stride, <span class="hljs-number">1</span>, weight_init=HeNormal())
        self.bn1 = nn.BatchNorm2d(out_c)
        self.conv2 = nn.Conv2d(out_c, out_c, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, weight_init=HeNormal())
        self.bn2 = nn.BatchNorm2d(out_c)
        self.shortcut = nn.SequentialCell([nn.Conv2d(in_c, out_c, <span class="hljs-number">1</span>, stride), nn.BatchNorm2d(out_c)]) <span class="hljs-keyword">if</span> stride!=<span class="hljs-number">1</span> <span class="hljs-keyword">or</span> in_c!=out_c <span class="hljs-keyword">else</span> nn.Identity()
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self, x</span>):
        out = self.relu(self.bn1(self.conv1(x)))
        <span class="hljs-keyword">return</span> self.relu(self.bn2(self.conv2(out)) + self.shortcut(x))

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleResNet</span>(nn.Cell):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, num_classes=<span class="hljs-number">10</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.conv1 = nn.Conv2d(<span class="hljs-number">3</span>, <span class="hljs-number">64</span>, <span class="hljs-number">7</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
        self.layer1 = self._make_layer(<span class="hljs-number">64</span>, <span class="hljs-number">2</span>)
        self.layer2 = self._make_layer(<span class="hljs-number">128</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)
        self.avgpool = nn.AdaptiveAvgPool2d((<span class="hljs-number">1</span>,<span class="hljs-number">1</span>))
        self.fc = nn.Dense(<span class="hljs-number">128</span>, num_classes)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_make_layer</span>(<span class="hljs-params">self, out_c, blocks, stride=<span class="hljs-number">1</span></span>):
        layers = [BasicBlock(self.in_c, out_c, stride)]
        self.in_c = out_c
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, blocks):
            layers.append(BasicBlock(self.in_c, out_c))
        <span class="hljs-keyword">return</span> nn.SequentialCell(layers)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self, x</span>):
        x = self.relu(self.bn1(self.conv1(x)))
        x = self.maxpool(x)
        x = self.layer1(x); x = self.layer2(x)
        <span class="hljs-keyword">return</span> self.fc(self.avgpool(x).view(x.shape[<span class="hljs-number">0</span>],-<span class="hljs-number">1</span>))
</code></pre>
<h4 data-id="heading-14">（2）复用预训练模型（迁移学习）</h4>
<p>预训练模型复用（迁移学习）：</p>
<pre><code class="hljs language-ini" lang="ini">import mindspore_hub as mshub

<span class="hljs-comment"># 加载并冻结主干</span>
<span class="hljs-attr">net</span> = mshub.load(<span class="hljs-string">"resnet50_ascend_v130_imagenet2012"</span>, num_classes=<span class="hljs-number">10</span>)
for param in net.get_parameters():
    if "fc" not in param.name:
        <span class="hljs-attr">param.requires_grad</span> = <span class="hljs-literal">False</span>
</code></pre>
<h4 data-id="heading-15">避坑要点</h4>
<ul>
<li>construct仅用MindSpore算子，避免Python原生循环；</li>
<li>合理初始化参数，避免训练不收敛。</li>
</ul>
<h3 data-id="heading-16">3. 训练与推理：用Model类简化流程</h3>
<p>用Model类简化训练推理流程。</p>
<h4 data-id="heading-17">（1）基础训练流程</h4>
<pre><code class="hljs language-ini" lang="ini">import mindspore as ms
from mindspore import Model, nn

ms.set_context(<span class="hljs-attr">mode</span>=ms.PYNATIVE_MODE, device_target=<span class="hljs-string">"CPU"</span>)

<span class="hljs-comment"># 初始化组件并训练</span>
<span class="hljs-attr">net</span> = SimpleResNet(<span class="hljs-number">10</span>)
<span class="hljs-attr">model</span> = Model(net, nn.SoftmaxCrossEntropyWithLogits(<span class="hljs-literal">True</span>, <span class="hljs-string">"mean"</span>), 
              nn.Adam(net.trainable_params(), 0.001), {"accuracy"})
model.train(10, train_dataset, <span class="hljs-attr">dataset_sink_mode</span>=<span class="hljs-literal">False</span>)
</code></pre>
<p>评估与推理核心代码：</p>
<pre><code class="hljs language-scss" lang="scss">import mindspore<span class="hljs-selector-class">.ops</span> as ops

# 评估
test_dataset = ds<span class="hljs-selector-class">.Cifar10Dataset</span>("./cifar10", "test")<span class="hljs-selector-class">.map</span>(transform, "image")<span class="hljs-selector-class">.batch</span>(<span class="hljs-number">32</span>)
<span class="hljs-built_in">print</span>("准确率:", model.eval(test_dataset)<span class="hljs-selector-attr">[<span class="hljs-string">"accuracy"</span>]</span>)

# 单图推理
def <span class="hljs-built_in">predict</span>(img_path):
    img = cv2.<span class="hljs-built_in">imread</span>(img_path)
    img = ms.<span class="hljs-built_in">Tensor</span>(cv2.<span class="hljs-built_in">resize</span>(cv2.<span class="hljs-built_in">cvtColor</span>(img, cv2.COLOR_BGR2RGB), (<span class="hljs-number">224</span>,<span class="hljs-number">224</span>))/<span class="hljs-number">255.0</span>).<span class="hljs-built_in">unsqueeze</span>(<span class="hljs-number">0</span>)
    return ops.<span class="hljs-built_in">Argmax</span>(<span class="hljs-number">1</span>)(model.<span class="hljs-built_in">predict</span>(ops.<span class="hljs-built_in">transpose</span>(img, (<span class="hljs-number">0</span>,<span class="hljs-number">3</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>)))).<span class="hljs-built_in">asnumpy</span>()[<span class="hljs-number">0</span>]

<span class="hljs-built_in">print</span>(<span class="hljs-string">"预测类别:"</span>, <span class="hljs-built_in">predict</span>(<span class="hljs-string">"./test.jpg"</span>))
</code></pre>
<h4 data-id="heading-18">避坑要点</h4>
<ul>
<li>调试设dataset_sink_mode=False，量产设True；</li>
<li>推理预处理与训练一致。</li>
</ul>
<h2 data-id="heading-19">三、模型部署：全场景落地的关键步骤</h2>
<p>部署核心流程：模型导出→格式转换→部署执行，聚焦两大场景。</p>
<h3 data-id="heading-20">1. 第一步：模型导出（导出为ONNX/MINDIR格式）</h3>
<p>模型导出（ONNX/MINDIR）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> mindspore <span class="hljs-keyword">as</span> ms
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

input_tensor = ms.Tensor(np.random.randn(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">224</span>,<span class="hljs-number">224</span>), ms.float32)
ms.export(net, input_tensor, <span class="hljs-string">"simple_resnet.onnx"</span>, <span class="hljs-string">"ONNX"</span>)  <span class="hljs-comment"># 多框架适配</span>
ms.export(net, input_tensor, <span class="hljs-string">"simple_resnet.mindir"</span>, <span class="hljs-string">"MINDIR"</span>)  <span class="hljs-comment"># 昇腾适配</span>
</code></pre>
<p>避坑：导出输入形状与训练一致。</p>
<h3 data-id="heading-21">2. 昇腾硬件部署（边缘/云端）</h3>
<p>昇腾部署：MINDIR转OM后部署。</p>
<h4 data-id="heading-22">（1）模型转换（MINDIR→OM）</h4>
<p>使用昇腾ATC工具转换，命令如下：</p>
<pre><code class="hljs language-css" lang="css"># 昇腾ATC转换命令
atc <span class="hljs-attr">--model</span>=simple_resnet<span class="hljs-selector-class">.mindir</span> <span class="hljs-attr">--framework</span>=<span class="hljs-number">5</span> <span class="hljs-attr">--output</span>=simple_resnet_om <span class="hljs-attr">--input_format</span>=NCHW <span class="hljs-attr">--input_shape</span>="<span class="hljs-selector-tag">input</span>:<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">224</span>,<span class="hljs-number">224</span><span class="hljs-string">" --device_target=Ascend
</span></code></pre>
<h4 data-id="heading-23">（2）推理部署</h4>
<p>通过Ascend CL API加载OM模型执行推理，核心流程与CANN部署一致，可复用官方提供的推理模板代码。</p>
<h3 data-id="heading-24">3. 端侧部署（手机/嵌入式设备）</h3>
<p>端侧部署：先量化轻量化，再导出部署。</p>
<h4 data-id="heading-25">（1）模型轻量化（INT8量化）</h4>
<p>使用MindSpore的model_compression模块实现量化，减少模型体积与计算量，代码如下：</p>
<pre><code class="hljs language-makefile" lang="makefile">from mindspore import model_compression

<span class="hljs-comment"># INT8量化并导出</span>
quant_net = model_compression.quantize(net, model_compression.QuantConfig(), train_dataset)
ms.<span class="hljs-keyword">export</span>(quant_net, input_tensor, <span class="hljs-string">"simple_resnet_quant.mindir"</span>, <span class="hljs-string">"MINDIR"</span>)
</code></pre>
<h4 data-id="heading-26">（2）端侧推理</h4>
<p>使用MindSpore Lite将MINDIR模型转换为端侧专用格式，再通过端侧推理引擎（如Android/iOS SDK）执行推理。</p>
<h2 data-id="heading-27">四、性能优化：4个维度提升训练/推理效率</h2>
<p>性能优化核心：4个维度提升效率。</p>
<h3 data-id="heading-28">1. 数据加载优化：提升吞吐量</h3>
<ul>
<li>数据加载：开启数据下沉、多进程、预取；</li>
<li>模型结构：切换静态图、开启算子融合、用轻量化网络；</li>
<li>训练策略：优化Batch Size、选对优化器、开启自动并行。</li>
</ul>
<h2 data-id="heading-29">五、常见问题排查：高频坑与解决方案</h2>
<p>高频问题排查精简：</p>





























<table><thead><tr><th>常见问题</th><th>解决方案</th></tr></thead><tbody><tr><td>训练不收敛</td><td>合理初始化参数、调整学习率、检查数据预处理</td></tr><tr><td>算子不支持</td><td>用MindSpore内置算子、升级框架版本</td></tr><tr><td>导出形状不匹配</td><td>保证导出与训练输入形状一致</td></tr><tr><td>训练速度慢</td><td>开启数据下沉、多进程、切换静态图</td></tr><tr><td>昇腾OM转换失败</td><td>重新导出MINDIR、匹配版本</td></tr></tbody></table>
<p>排查技巧：优先查看MindSpore日志定位问题。</p>
<h2 data-id="heading-30">六、总结：MindSpore学习的核心心法</h2>
<p>学习心法：循序渐进，实战为王。按“环境搭建→核心流程→项目落地→优化”推进。</p>
<p>MindSpore核心价值：简化开发、全场景适配。希望本文助力开发者快速掌握、落地项目。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[腾讯云部署openclaw（QQ机器人）]]></title>    <link>https://juejin.cn/post/7601046076943220751</link>    <guid>https://juejin.cn/post/7601046076943220751</guid>    <pubDate>2026-01-31T07:53:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601046076943220751" data-draft-id="7601018079620677647" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="腾讯云部署openclaw（QQ机器人）"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-01-31T07:53:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Annie619"/> <meta itemprop="url" content="https://juejin.cn/user/4024631837330760"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            腾讯云部署openclaw（QQ机器人）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4024631837330760/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Annie619
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:53:39.000Z" title="Sat Jan 31 2026 07:53:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.选择镜像OpenClaw</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bee8277fba9247eb9a5c206406dd1fd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5uaWU2MTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770450819&amp;x-signature=HyuHkqBYTazQ1s2Pv%2F44Nr0JiwY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">2.## 配置OpenClaw的Channel QQ</h2>
<p>先去qq开放平台注册qq机器人<a href="https://link.juejin.cn?target=https%3A%2F%2Fq.qq.com%2F%23%2F" target="_blank" title="https://q.qq.com/#/" ref="nofollow noopener noreferrer">q.qq.com/#/</a>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a16a8cb3e0c4a17afff12bd7499157d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5uaWU2MTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770450819&amp;x-signature=pOUQzfWLqMVRajR%2FTYQuwzUAGGM%3D" alt="image.png" loading="lazy"/></p>
<p>登录服务武器，使用命令行进行操作，如图
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c3f05e1080a4f188d031841869699b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5uaWU2MTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770450819&amp;x-signature=Bhi79p%2FuKW2tsfN5pHhE%2BrU%2F2AQ%3D" alt="image.png" loading="lazy"/>
配置中使用上下箭头进行选择，多选选中使用空格进行选中、取消。
可以先选择模型以及QQ这两个，其他的可以先跳过(<strong>我当前选择的是智谱的套餐，每天几十亿的token根本用不完</strong>)
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bigmodel.cn%2Fglm-coding%3Fic%3D3MXTC3M7RE" target="_blank" title="https://www.bigmodel.cn/glm-coding?ic=3MXTC3M7RE" ref="nofollow noopener noreferrer">www.bigmodel.cn/glm-coding?…</a></p>
<h2 data-id="heading-2">3.让OpenClaw在后台保持运行</h2>
<pre><code class="hljs language-bash" lang="bash">loginctl enable-linger $(<span class="hljs-built_in">whoami</span>) &amp;&amp; <span class="hljs-built_in">export</span> XDG_RUNTIME_DIR=/run/user/$(<span class="hljs-built_in">id</span> -u)
</code></pre>
<p>运行完之后没有输出
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4e1900f9c9f40ab86316b0c06bb6cc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5uaWU2MTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770450819&amp;x-signature=94OFPZiDPv6IKdyhrUTUq9L4lh0%3D" alt="image.png" loading="lazy"/>
先安装</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot daemon install
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9edceffcfbf45eaa95197526006dcda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5uaWU2MTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770450819&amp;x-signature=%2FgfjqyRs6pqxMh2hzD%2F2lV8GPJ8%3D" alt="image.png" loading="lazy"/></p>
<p>继续在终端进行输入</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot daemon start
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a461f5d36d640b7a62d6e2d55439ea5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5uaWU2MTk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770450819&amp;x-signature=e6WWaXWlMikoef4f6nzj3Fo%2BLfs%3D" alt="image.png" loading="lazy"/>
验证是否正常</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot daemon status
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Clawdbot (Moltbot) 保姆级安装教程]]></title>    <link>https://juejin.cn/post/7601077290680909876</link>    <guid>https://juejin.cn/post/7601077290680909876</guid>    <pubDate>2026-01-31T08:00:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601077290680909876" data-draft-id="7601046076943237135" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Clawdbot (Moltbot) 保姆级安装教程"/> <meta itemprop="keywords" content="Claude,AIGC"/> <meta itemprop="datePublished" content="2026-01-31T08:00:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深藏blue47"/> <meta itemprop="url" content="https://juejin.cn/user/4339135019760265"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Clawdbot (Moltbot) 保姆级安装教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4339135019760265/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深藏blue47
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T08:00:10.000Z" title="Sat Jan 31 2026 08:00:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近，<strong>Clawdbot</strong> 在技术圈彻底火了！这种热度让人联想到去年 <strong>Manus</strong> 发布时的盛况，几乎在一夜之间引爆了互联网。</p>
<p>值得注意的是，Clawdbot 现已正式更名为 <strong>Moltbot</strong>，Logo 也从一只完整的小龙虾变成了一只“脱壳”的小龙虾。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cecbe428b1dc4188901bf82733aaa1fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex6JePYmx1ZTQ3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770451213&amp;x-signature=Gj9oSUBEcbri22Xscz7LZfcrrJY%3D" alt="Moltbot" loading="lazy"/></p>
<blockquote>
<p><strong>💡 关于命名：</strong>
Moltbot 意为“蜕皮”，取自龙虾的脱壳行为。这不仅保留了原有的龙虾元素，还巧妙地规避了与 Claude 的商标冲突问题。</p>
</blockquote>
<h2 data-id="heading-0">什么是 Clawdbot (Moltbot)？它能做什么？</h2>
<p><strong>Clawdbot</strong>（现称 Moltbot）不仅仅是一个聊天机器人，它是一个可以部署在本地电脑或服务器上的 <strong>AI Agent（智能体）</strong>。</p>
<p>通俗来说，你可以把它理解为一个<strong>拥有系统超级权限（Root 权限）的超级助理</strong>。如果你熟悉 Claude Code，那么 Clawdbot 就是一个拥有丰富 Skills（技能）且能够调用各种 MCP 服务来闭环完成复杂任务的进阶版。</p>
<p><strong>它的核心功能包括但不限于：</strong></p>
<ul>
<li>自动整理邮件与日程管理</li>
<li>股票市场分析与操作</li>
<li>自动化撰写推文与社交媒体运营</li>
<li>读取并总结 PPT/PDF 文档</li>
<li><strong>24小时后台运行</strong>，随时待命</li>
</ul>
<blockquote>
<p><strong>⚠️ 高危预警（必读）：</strong>
由于 Clawdbot 拥有极高的系统权限（Shell 访问权），<strong>请务必谨慎操作！</strong> 一旦指令错误，可能会误删系统关键文件。
此外，Clawdbot 的网关默认暴露在公网且缺乏严格的身份验证，安全性存在挑战。<strong>强烈建议在虚拟机（VM）或闲置的 Mac 电脑上进行部署</strong>，防止黑客入侵。</p>
</blockquote>
<h2 data-id="heading-1">第一步：环境准备与安装要求</h2>
<p>在开始安装 Clawdbot 之前，请确保您的电脑满足以下环境要求：</p>
<ul>
<li><strong>Node.js 版本：</strong> &gt;= 22.0</li>
<li><strong>Git：</strong> 必须安装</li>
</ul>
<p><strong>系统建议：</strong></p>
<ul>
<li><strong>Windows 用户：</strong> 强烈建议使用 <strong>WSL2</strong>（推荐 Ubuntu 系统），体验更佳。</li>
<li><strong>Mac 用户：</strong> 直接使用终端即可，开箱即用。</li>
</ul>
<h2 data-id="heading-2">第二步：Clawdbot (Moltbot) 安装教程</h2>
<p>安装过程非常简单，根据您的操作系统复制以下 Shell 命令即可一键安装。</p>
<h3 data-id="heading-3">1. macOS / Linux / Ubuntu / Debian 安装命令（推荐）</h3>
<p>打开终端（Terminal），输入：</p>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://molt.bot/install.sh | bash

</code></pre>
<h3 data-id="heading-4">2. Windows (PowerShell) 安装命令（推荐）</h3>
<p>打开 PowerShell，输入：</p>
<pre><code class="hljs language-powershell" lang="powershell">iwr -useb https://molt.bot/install.ps1 | iex

</code></pre>
<h3 data-id="heading-5">3. 安装 Beta 测试版（尝鲜用户）</h3>
<p>如果您想体验最新的功能，可以使用以下指令：</p>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://molt.bot/install.sh | bash -s -- --beta

</code></pre>
<h3 data-id="heading-6">4. 使用 Npm 包管理器安装（备选）</h3>
<p><em>注意：npm 版本为官方刚发布，可能存在不稳定性，建议优先使用上述 curl/iwr 脚本安装。</em></p>
<pre><code class="hljs language-bash" lang="bash">npm i -g moltbot@latest

</code></pre>
<p><em>提示：如果 npm 安装后找不到 <code>moltbot</code> 指令，请尝试使用 <code>clawdbot</code> 指令。</em></p>
<hr/>
<h2 data-id="heading-7">第三步：实战部署演示（以 Mac 系统为例）</h2>
<p>以下演示基于 <strong>Node.js 22.15</strong> 版本。</p>
<p>执行安装命令后，系统会自动克隆 Github 仓库。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/beff76dac6ec4f0c8fd87bafe0c293e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex6JePYmx1ZTQ3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770451213&amp;x-signature=mZnVhpPaC5mMd2qStmqzf8EjjOA%3D" alt="2.png" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash">curl -fsSL https://molt.bot/install.sh | bash

</code></pre>
<h3 data-id="heading-8">1. 风险确认与初始化</h3>
<p>安装完成后，系统会提示 Clawdbot 的高风险性。</p>
<ul>
<li>输入 <code>yes</code> 继续。</li>
<li>选择 <strong>QuickStart</strong> 模式，加载默认配置。</li>
</ul>
<p>Clawdbot 默认分配端口为 <code>18789</code>。</p>
<h3 data-id="heading-9">2. 配置 AI 模型授权 (OAuth)</h3>
<p><strong>Clawdbot 的一大亮点是支持 ChatGPT 和 Claude 的 OAuth 授权登录。</strong> 这意味着你无需购买昂贵的 API Key，直接使用网页版会员权限（如 Plus、Team、Pro）即可驱动 AI。</p>
<blockquote>
<p><strong>🛑 避坑指南：</strong>
尽量避免使用 Claude 授权登录，因为 Claude 官方风控较严，可能会限制非 Claude Code 的调用。如果你必须用 Claude 但没有账号，可以参考这里：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffe.dtyuedan.cn%2Fshop%2Fjackma" target="_blank" title="https://fe.dtyuedan.cn/shop/jackma" ref="nofollow noopener noreferrer">Claude 账号获取渠道</a></p>
</blockquote>
<p><strong>推荐方案：使用 OpenAI (Codex) 授权</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0f0d254472f498e8044a4c89ce03424~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex6JePYmx1ZTQ3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770451213&amp;x-signature=Pbk62Ju97OuYEq4hFwlij0T%2FyJQ%3D" alt="3.png" loading="lazy"/></p>
<p>只要你是 ChatGPT Plus、Business 或 Pro 会员，都可以直接使用。</p>
<p>为了演示方便，我们在配置界面选择 <strong>第 2 种</strong> 授权方式（浏览器授权）。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6ef31842263490d839e17f90ea76e50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex6JePYmx1ZTQ3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770451213&amp;x-signature=NxMX6cqido3IYWoeThKWjprNabY%3D" alt="4.png" loading="lazy"/></p>
<p>终端会生成一条 ChatGPT 授权链接，浏览器会自动弹出，选择你的会员账号登录即可。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43f5e978e09f48ad8c8f207f7d70cc71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex6JePYmx1ZTQ3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770451213&amp;x-signature=8dR8NKS1e25fTZoMrBuJA7BVlOM%3D" alt="5.png" loading="lazy"/></p>
<p>这里我使用的是 <strong>ChatGPT Business 会员</strong>。</p>
<ul>
<li><strong>原因：</strong> Business 会员目前性价比极高，几十块钱就能享受跟 Plus 会员一样的 Codex 额度，非常适合跑这种耗 Token 的 Agent。</li>
</ul>
<blockquote>
<p><strong>💰 省钱技巧：</strong>
高性价比体验 Clawdbot，推荐使用 ChatGPT Business 账号。
<strong>优惠开通地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgptplus.org.cn" target="_blank" title="https://gptplus.org.cn" ref="nofollow noopener noreferrer">gptplus.org.cn</a>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf9bbf3914db4664b1f61bad1551fa6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex6JePYmx1ZTQ3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770451213&amp;x-signature=O10%2FLKQY%2FlUJw4as0FXQ7qJgguA%3D" alt="6.png" loading="lazy"/></p>
</blockquote>
<p>点击“继续”，授权成功后回到终端查看状态。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af3cd0c82459409088f687a7a1a57eea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex6JePYmx1ZTQ3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770451213&amp;x-signature=J%2BTbMiwxnXRavZZfeUanlxfxETU%3D" alt="7.png" loading="lazy"/></p>
<p><strong>PS：</strong> 如果终端没有自动抓取到 Token，请手动复制浏览器地址栏中 <code>localhost</code> 开头的完整回调地址，粘贴到终端即可。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7bba517ee5644cca94cbcb6987ca63f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex6JePYmx1ZTQ3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770451213&amp;x-signature=jF9FeOqHrs%2BEcjcI5JcT7abG6vY%3D" alt="8.png" loading="lazy"/></p>
<h3 data-id="heading-10">3. 选择模型与频道</h3>
<p>默认选择 <code>GPT-5.2-Codex</code> 模型。你可以选择跳过，或配置其他频道。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/332fb74da4ef42ea9e0a217f08e4ab18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex6JePYmx1ZTQ3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770451213&amp;x-signature=bHRAWil3dOR8bqtNagQbxGSaaS0%3D" alt="9.png" loading="lazy"/></p>
<h3 data-id="heading-11">4. 配置 Skills (技能)</h3>
<p>这就是 AI Agent 的灵魂所在。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/054dc1bf5248408991f8006e98207dc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex6JePYmx1ZTQ3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770451213&amp;x-signature=sW1XZRbhaJaM7BhdHjcHrLXy1Sg%3D" alt="10.png" loading="lazy"/></p>
<p>选择包管理工具（默认 npm 即可）。系统会推荐一些基础 Skills，你可以按需选择，也可以全部跳过。
<strong>最酷的是：</strong> 后续你需要什么功能，直接在对话框跟 Clawdbot 说“帮我安装某某 skill”，它就会自动安装，无需手动操作！
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f9e1d1a1fb84f1d99a5ee4a2b177f60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex6JePYmx1ZTQ3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770451213&amp;x-signature=K7XG7052onk%2FImSjxpKui64WOCk%3D" alt="11.png" loading="lazy"/></p>
<p>如果遇到 API Key 设置（如生图服务），没有的话直接回车 <code>No</code> 跳过。</p>
<h3 data-id="heading-12">5. 开启 Hooks (自动化钩子)</h3>
<p>最后，系统会询问是否开启内置钩子脚本（Hooks），建议<strong>全部开启</strong>以获得完整体验：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3913df2f1f534f30a3fc3af3a32536a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex6JePYmx1ZTQ3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770451213&amp;x-signature=iAdgWsq6UsW6UN5CTQ0xOBNySNc%3D" alt="12.png" loading="lazy"/></p>
<ul>
<li><strong>boot-md：</strong> 网关启动后自动执行 <code>BOOT.md</code> 中的引导指令。</li>
<li><strong>command-logger：</strong> 审计日志，记录所有执行过的命令（安全审计必备）。</li>
<li><strong>session-memory：</strong> 会话记忆功能，输入 <code>/new</code> 时自动保存当前上下文快照。</li>
</ul>
<h2 data-id="heading-13">第四步：启动 Web UI 控制台</h2>
<p>对于新手用户，强烈建议选择 <strong>Web UI</strong> 模式，可视化的网页操作界面比纯命令行更友好。</p>
<p>配置完成后，执行以下指令启动控制台：</p>
<pre><code class="hljs language-bash" lang="bash">clawdbot dashboard

</code></pre>
<ul>
<li><strong>本地访问地址：</strong> <code>http://127.0.0.1:18789</code></li>
</ul>
<blockquote>
<p><strong>📝 重要提示：</strong>
虽然工具已更名为 Moltbot，但部分旧版指令尚未完全更新。如果 <code>moltbot</code> 指令无效，请尝试替换为 <code>clawdbot</code> 运行，通常能解决问题。</p>
</blockquote>
<p>现在，你的专属 AI 超级员工已经就位！如果你没有 OpenAI 或 Claude 账号，也可以在配置中绑定第三方 API Key，使用国内大模型来驱动 Clawdbot。</p>
<p>快去探索 Clawdbot (Moltbot) 的强大能力吧！</p>
<hr/>
<p>文章来源:<a href="https://link.juejin.cn?target=https%3A%2F%2Fgptplus.org.cn%2Fhandbook%2Fclawdbot.html" target="_blank" title="https://gptplus.org.cn/handbook/clawdbot.html" ref="nofollow noopener noreferrer">Clawdbot (Moltbot) 保姆级安装教程</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Markdown 写稿，Word 交稿？用 Pandoc + 脚本一键转换，告别格式焦虑]]></title>    <link>https://juejin.cn/post/7601020578490761225</link>    <guid>https://juejin.cn/post/7601020578490761225</guid>    <pubDate>2026-01-31T07:39:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601020578490761225" data-draft-id="7601169987396288563" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Markdown 写稿，Word 交稿？用 Pandoc + 脚本一键转换，告别格式焦虑"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-31T07:39:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大尚来也"/> <meta itemprop="url" content="https://juejin.cn/user/1681597639955488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Markdown 写稿，Word 交稿？用 Pandoc + 脚本一键转换，告别格式焦虑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1681597639955488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大尚来也
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:39:20.000Z" title="Sat Jan 31 2026 07:39:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否也经历过这样的场景？</p>
<ul>
<li>用 Markdown 写技术文档、论文或周报，思路流畅、版本清晰；</li>
<li>上级/客户/期刊却明确要求提交 <code>.docx</code> 格式；</li>
<li>手动复制粘贴到 Word 后，格式错乱、标题层级丢失、代码块变乱码……</li>
</ul>
<p>别再忍受这种“生产力倒退”！其实，只需一个开源工具 <strong>Pandoc</strong> 加几行脚本，就能实现 <strong>Markdown → 高质量 Word 文档</strong> 的自动化转换——全程免费、跨平台、可定制，真正实现“写得爽，交得稳”。</p>
<p>本文将手把手教你搭建一套零成本、高效率的 Markdown 到 Word 自动化工作流。</p>
<hr/>
<h3 data-id="heading-0">一、为什么 Pandoc 是最佳选择？</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpandoc.org%2F" target="_blank" title="https://pandoc.org/" ref="nofollow noopener noreferrer">Pandoc</a> 被誉为“文档格式的瑞士军刀”，由 Haskell 编写，支持 <strong>40+ 种格式互转</strong>，包括：</p>
<ul>
<li>Markdown ↔ Word (.docx)</li>
<li>Markdown ↔ PDF (via LaTeX)</li>
<li>Markdown ↔ HTML / EPUB / PowerPoint 等</li>
</ul>
<p>它的核心优势在于：</p>
<ul>
<li><strong>开源免费</strong>，无任何商业限制</li>
<li><strong>保留语义结构</strong>：标题、列表、表格、代码块等自动映射为 Word 样式</li>
<li><strong>高度可定制</strong>：通过模板、CSS 或元数据控制输出样式</li>
<li><strong>命令行驱动</strong>：天然适合脚本化和自动化</li>
</ul>
<blockquote>
<p>💡 小知识：许多知名项目（如 GitBook、Obsidian 导出插件）底层都依赖 Pandoc。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">二、三步搭建你的自动转换脚本</h3>
<h4 data-id="heading-2">第一步：安装 Pandoc</h4>
<ul>
<li>
<p><strong>macOS</strong>（推荐用 Homebrew）：</p>
<pre><code class="hljs">brew install pandoc
</code></pre>
</li>
<li>
<p><strong>Windows</strong>：从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpandoc.org%2Finstalling.html" target="_blank" title="https://pandoc.org/installing.html" ref="nofollow noopener noreferrer">pandoc.org/installing.…</a> 下载安装包</p>
</li>
<li>
<p><strong>Linux</strong>（Ubuntu/Debian）：</p>
<pre><code class="hljs">sudo apt install pandoc
</code></pre>
</li>
</ul>
<blockquote>
<p>✅ 验证安装：终端输入 <code>pandoc --version</code>，看到版本号即成功。</p>
</blockquote>
<h4 data-id="heading-3">第二步：准备你的 Markdown 文件</h4>
<p>建议在文件开头加入 <strong>YAML 元数据块</strong>，用于控制文档属性：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">title:</span> <span class="hljs-string">"2026年Q1技术规划"</span>
<span class="hljs-attr">author:</span> <span class="hljs-string">张三</span>
<span class="hljs-attr">date:</span> <span class="hljs-number">2026-01-31</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment"># 引言</span>

<span class="hljs-string">本文档旨在...</span>
</code></pre>
<h4 data-id="heading-4">第三步：编写一键转换脚本</h4>
<h5 data-id="heading-5">▶ macOS / Linux（<code>md2docx.sh</code>）：</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
INPUT=<span class="hljs-string">"<span class="hljs-variable">$1</span>"</span>
OUTPUT=<span class="hljs-string">"<span class="hljs-variable">${INPUT%.md}</span>.docx"</span>

pandoc <span class="hljs-string">"<span class="hljs-variable">$INPUT</span>"</span> \
  -o <span class="hljs-string">"<span class="hljs-variable">$OUTPUT</span>"</span> \
  --reference-doc=default.docx \
  --highlight-style=pygments

<span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 已生成：<span class="hljs-variable">$OUTPUT</span>"</span>
</code></pre>
<h5 data-id="heading-6">▶ Windows（<code>md2docx.bat</code>）：</h5>
<pre><code class="hljs language-arduino" lang="arduino">@echo off
set <span class="hljs-literal">INPUT</span>=%<span class="hljs-number">1</span>
set <span class="hljs-literal">OUTPUT</span>=%<span class="hljs-literal">INPUT</span>:.md=.docx%

pandoc <span class="hljs-string">"%INPUT%"</span> -o <span class="hljs-string">"%OUTPUT%"</span> --reference-doc=<span class="hljs-keyword">default</span>.docx --highlight-style=pygments
echo ✅ 已生成：%<span class="hljs-literal">OUTPUT</span>%
</code></pre>
<blockquote>
<p>📌 权限设置（macOS/Linux）：<br/>
<code>chmod +x md2docx.sh</code><br/>
使用方式：<code>./md2docx.sh report.md</code></p>
</blockquote>
<hr/>
<h3 data-id="heading-7">三、进阶技巧：让 Word 输出更专业</h3>
<h4 data-id="heading-8">1. 自定义样式：使用 <code>--reference-doc</code></h4>
<p>Pandoc 默认的 Word 样式较朴素。你可以：</p>
<ol>
<li>
<p>在 Word 中新建一个 <code>.docx</code> 文件，设置好标题、正文、代码块等样式；</p>
</li>
<li>
<p>保存为 <code>my-style.docx</code>；</p>
</li>
<li>
<p>转换时指定：</p>
<pre><code class="hljs language-lua" lang="lua">pandoc <span class="hljs-built_in">input</span>.md -o <span class="hljs-built_in">output</span>.docx <span class="hljs-comment">--reference-doc=my-style.docx</span>
</code></pre>
</li>
</ol>
<p>这样，所有 Markdown 元素都会套用你预设的 Word 样式，完美匹配公司模板！</p>
<h4 data-id="heading-9">2. 代码高亮：启用语法着色</h4>
<p>添加 <code>--highlight-style=tango</code> 或 <code>pygments</code>，让代码块在 Word 中带颜色（需 Word 支持）。</p>
<h4 data-id="heading-10">3. 插入目录、页眉页脚</h4>
<p>通过 <code>--toc</code> 生成目录；更复杂的排版可结合 LaTeX 中间格式，但对大多数办公场景，<code>reference-doc</code> 已足够。</p>
<hr/>
<h3 data-id="heading-11">四、集成到你的写作环境</h3>
<ul>
<li><strong>VS Code 用户</strong>：安装 “Markdown Preview Enhanced” 插件，支持一键导出 DOCX。</li>
<li><strong>Obsidian 用户</strong>：使用社区插件 “Pandoc Plugin” 直接调用本地 Pandoc。</li>
<li><strong>终端党</strong>：将脚本加入 PATH，全局可用。</li>
</ul>
<p>甚至可以配合 <strong>GitHub Actions</strong> 实现“推送 Markdown 自动发布 Word 版本”！</p>
<hr/>
<h3 data-id="heading-12">结语：掌控格式，而非被格式掌控</h3>
<p>在内容创作日益去中心化的今天，<strong>用最舒服的方式写作，用最合规的方式交付</strong>，不该是奢望。借助 Pandoc 这样成熟、稳定、免费的工具，我们完全可以在保持 Markdown 高效写作体验的同时，无缝满足传统办公格式的要求。</p>
<blockquote>
<p><strong>真正的效率，不是妥协于工具，而是让工具为你服务。</strong></p>
</blockquote>
<p>现在就花 10 分钟配置这套脚本——从此，Markdown 是你的笔，Word 只是你的信封。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Terraform 实践课 -优课IT分享]]></title>    <link>https://juejin.cn/post/7600999271770701824</link>    <guid>https://juejin.cn/post/7600999271770701824</guid>    <pubDate>2026-01-31T08:17:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600999271770701824" data-draft-id="7601049142865739776" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Terraform 实践课 -优课IT分享"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-31T08:17:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户71791708027"/> <meta itemprop="url" content="https://juejin.cn/user/801974450660393"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Terraform 实践课 -优课IT分享
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/801974450660393/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户71791708027
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T08:17:38.000Z" title="Sat Jan 31 2026 08:17:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Terraform 实践课---获课：youkeit.xyz/15400/</strong></p>
<h2 data-id="heading-0">安全左移下的 Terraform：未来 IaC 安全合规与漏洞前置检测的实践发展方向</h2>
<p>在云原生时代，基础设施即代码（IaC）已成为企业自动化管理的核心工具，而 Terraform 作为行业标杆，其安全性直接影响云基础设施的可靠性。随着安全左移理念的普及，如何在 IaC 开发阶段前置检测安全漏洞与合规风险，成为提升云安全效率的关键。本文结合 Terraform 的最新实践，探讨安全左移下的技术演进方向，并提供可落地的代码示例。</p>
<h3 data-id="heading-1">一、安全左移的核心价值：从“事后修复”到“事前预防”</h3>
<p>传统 IaC 安全模式依赖部署后的扫描工具（如 OPA、Checkov），存在两大痛点：</p>
<ol>
<li><strong>滞后性</strong>：漏洞发现时可能已造成资源创建或数据泄露；</li>
<li><strong>成本高</strong>：修复已部署资源的成本远高于开发阶段调整代码。</li>
</ol>
<p>安全左移通过将安全检测嵌入 IaC 开发流程，实现以下目标：</p>
<ul>
<li><strong>代码级检测</strong>：在提交前识别敏感信息泄露、权限过配等风险；</li>
<li><strong>自动化合规</strong>：强制执行企业安全策略（如禁止公网暴露数据库）；</li>
<li><strong>成本优化</strong>：避免因安全问题导致的资源重建或数据迁移。</li>
</ul>
<h3 data-id="heading-2">二、Terraform 安全左移的三大技术方向</h3>
<h4 data-id="heading-3">1. 静态代码分析：前置拦截基础漏洞</h4>
<p>通过集成静态分析工具（如 tfsec、KICS），在代码编写阶段检测以下问题：</p>
<ul>
<li><strong>敏感信息硬编码</strong>：如直接在 <code>.tf</code> 文件中写入 AWS Access Key；</li>
<li><strong>资源权限过配</strong>：如 S3 桶未启用加密或允许公开访问；</li>
<li><strong>依赖项漏洞</strong>：使用含已知漏洞的 Provider 版本。</li>
</ul>
<p><strong>代码示例：使用 tfsec 检测 S3 桶配置</strong></p>
<pre><code class="hljs language-ini" lang="ini">hcl
1<span class="hljs-comment"># main.tf</span>
2resource "aws_s3_bucket" "example" {
3  <span class="hljs-attr">bucket</span> = <span class="hljs-string">"my-bucket"</span>
4  <span class="hljs-attr">acl</span>    = <span class="hljs-string">"public-read"</span>  <span class="hljs-comment"># tfsec:ignore:AWS002 触发警告：禁止公网访问</span>
5}
6
7resource "aws_s3_bucket_server_side_encryption_configuration" "example" {
8  <span class="hljs-attr">bucket</span> = aws_s3_bucket.example.bucket
9  rule {
10    apply_server_side_encryption_by_default {
11      <span class="hljs-attr">sse_algorithm</span> = <span class="hljs-string">"AES256"</span>
12    }
13  }
14}
15
</code></pre>
<p><strong>执行检测</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">bash
1tfsec . --soft-fail  <span class="hljs-comment"># 输出警告但不中断流程</span>
2
</code></pre>
<p><strong>输出结果</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">1</span>[AWS002][ERROR] S3 bucket <span class="hljs-string">'my-bucket'</span> has ACL set to <span class="hljs-string">'public-read'</span>
<span class="hljs-number">2</span>
</code></pre>
<h4 data-id="heading-4">2. 策略即代码（Policy as Code）：强制合规约束</h4>
<p>通过 Open Policy Agent（OPA）或 Sentinel 定义安全策略，在 <code>terraform plan</code> 阶段拦截违规操作。例如，禁止创建未加密的 EBS 卷：</p>
<p><strong>代码示例：OPA 策略规则</strong></p>
<pre><code class="hljs language-lua" lang="lua">rego
<span class="hljs-number">1</span># policy.rego
<span class="hljs-number">2</span><span class="hljs-built_in">package</span> terraform.aws.ebs
<span class="hljs-number">3</span>
<span class="hljs-number">4</span>deny[msg] {
<span class="hljs-number">5</span>  <span class="hljs-built_in">input</span>.<span class="hljs-built_in">type</span> == <span class="hljs-string">"aws_ebs_volume"</span>
<span class="hljs-number">6</span>  <span class="hljs-keyword">not</span> <span class="hljs-built_in">input</span>.encrypted
<span class="hljs-number">7</span>  msg := <span class="hljs-string">"EBS volumes must be encrypted"</span>
<span class="hljs-number">8</span>}
<span class="hljs-number">9</span>
</code></pre>
<p><strong>集成到 Terraform 工作流</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">bash
1<span class="hljs-comment"># 安装 OPA</span>
2curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
3chmod +x opa
4
5<span class="hljs-comment"># 执行策略检查</span>
6opa <span class="hljs-built_in">eval</span> --input ./plan.json --data policy.rego <span class="hljs-string">"data.terraform.aws.ebs.deny"</span>
7
</code></pre>
<h4 data-id="heading-5">3. 动态漏洞扫描：模拟攻击验证安全性</h4>
<p>结合漏洞扫描工具（如 Trivy、Snyk），在 CI/CD 流水线中模拟攻击者行为，检测以下风险：</p>
<ul>
<li><strong>依赖项漏洞</strong>：Provider 或模块含已知 CVE；</li>
<li><strong>配置错误</strong>：如 Kubernetes Pod 未启用网络策略；</li>
<li><strong>运行时风险</strong>：如容器镜像含恶意软件。</li>
</ul>
<p><strong>代码示例：GitHub Actions 集成 Trivy 扫描</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">yaml</span>
<span class="hljs-number">1</span><span class="hljs-comment"># .github/workflows/terraform-security.yml</span>
<span class="hljs-attr">2name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Security</span> <span class="hljs-string">Scan</span>
<span class="hljs-attr">3on:</span> [<span class="hljs-string">push</span>]
<span class="hljs-number">4</span>
<span class="hljs-attr">5jobs:</span>
<span class="hljs-attr">6  scan:</span>
<span class="hljs-attr">7    runs-on:</span> <span class="hljs-string">ubuntu-latest</span>
<span class="hljs-attr">8    steps:</span>
<span class="hljs-attr">9      - uses:</span> <span class="hljs-string">actions/checkout@v4</span>
<span class="hljs-attr">10      - name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">up</span> <span class="hljs-string">Terraform</span>
<span class="hljs-attr">11        uses:</span> <span class="hljs-string">hashicorp/setup-terraform@v2</span>
<span class="hljs-attr">12      - name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Init</span>
<span class="hljs-attr">13        run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">init</span>
<span class="hljs-attr">14      - name:</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Plan</span>
<span class="hljs-attr">15        run:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">plan</span> <span class="hljs-string">-out=plan.tfplan</span>
<span class="hljs-attr">16      - name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Trivy</span>
<span class="hljs-attr">17        run:</span> <span class="hljs-string">|</span>
<span class="hljs-number">18</span>          <span class="hljs-string">curl</span> <span class="hljs-string">-sfL</span> <span class="hljs-string">https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh</span> <span class="hljs-string">|</span> <span class="hljs-string">sh</span> <span class="hljs-string">-s</span> <span class="hljs-string">--</span> <span class="hljs-string">-b</span> <span class="hljs-string">/usr/local/bin</span>
<span class="hljs-attr">19      - name:</span> <span class="hljs-string">Scan</span> <span class="hljs-string">Terraform</span> <span class="hljs-string">Plan</span>
<span class="hljs-attr">20        run:</span> <span class="hljs-string">|</span>
<span class="hljs-number">21</span>          <span class="hljs-string">trivy</span> <span class="hljs-string">fs</span> <span class="hljs-string">--severity</span> <span class="hljs-string">CRITICAL,HIGH</span> <span class="hljs-string">.</span> <span class="hljs-string">--skip-dirs=".terraform"</span>
<span class="hljs-number">22</span>
</code></pre>
<h3 data-id="heading-6">三、未来趋势：AI 驱动的智能安全左移</h3>
<p>随着 AI 技术的成熟，Terraform 安全左移将向智能化演进：</p>
<ol>
<li><strong>自动修复建议</strong>：AI 分析漏洞上下文，生成修复代码（如自动替换硬编码密钥为 Vault 引用）；</li>
<li><strong>预测性安全</strong>：基于历史数据预测潜在风险（如识别频繁变更的资源可能存在配置错误）；</li>
<li><strong>跨云合规</strong>：通过动态标准库（如 IACheck）自动适配不同云厂商的合规要求。</li>
</ol>
<p><strong>代码示例：AI 辅助修复硬编码密钥（伪代码）</strong></p>
<pre><code class="hljs language-python" lang="python">python
<span class="hljs-number">1</span><span class="hljs-comment"># AI 修复逻辑示例</span>
<span class="hljs-number">2</span><span class="hljs-keyword">def</span> fix_hardcoded_secrets(tf_content):
<span class="hljs-number">3</span>    <span class="hljs-keyword">import</span> re
<span class="hljs-number">4</span>    patterns = [
<span class="hljs-number">5</span>        <span class="hljs-string">r'access_key\s*=\s*"([^"]+)"'</span>,  <span class="hljs-comment"># AWS Access Key</span>
<span class="hljs-number">6</span>        <span class="hljs-string">r'password\s*=\s*"([^"]+)"'</span>     <span class="hljs-comment"># 数据库密码</span>
<span class="hljs-number">7</span>    ]
<span class="hljs-number">8</span>    <span class="hljs-keyword">for</span> pattern <span class="hljs-keyword">in</span> patterns:
<span class="hljs-number">9</span>        matches = re.findall(pattern, tf_content)
<span class="hljs-number">10</span>        <span class="hljs-keyword">for</span> secret <span class="hljs-keyword">in</span> matches:
<span class="hljs-number">11</span>            <span class="hljs-comment"># 调用 Vault API 存储密钥并生成引用</span>
<span class="hljs-number">12</span>            vault_path = store_in_vault(secret)
<span class="hljs-number">13</span>            tf_content = tf_content.replace(<span class="hljs-string">f'"<span class="hljs-subst">{secret}</span>"'</span>, <span class="hljs-string">f'$<span class="hljs-subst">{vault(<span class="hljs-string">"{vault_path}"</span>)}</span>'</span>)
<span class="hljs-number">14</span>    <span class="hljs-keyword">return</span> tf_content
<span class="hljs-number">15</span>
</code></pre>
<h3 data-id="heading-7">四、实践建议：构建安全左移的 Terraform 工作流</h3>
<ol>
<li>
<p><strong>分层检测</strong>：</p>
<ul>
<li><strong>开发阶段</strong>：使用 tfsec + Pre-commit 钩子拦截基础错误；</li>
<li><strong>CI 阶段</strong>：通过 OPA 策略检查强制合规；</li>
<li><strong>CD 阶段</strong>：结合 Trivy 扫描运行时风险。</li>
</ul>
</li>
<li>
<p><strong>工具链整合</strong>：</p>
<pre><code class="hljs language-css" lang="css">mermaid
<span class="hljs-number">1</span>graph <span class="hljs-selector-tag">TD</span>
<span class="hljs-number">2</span>  <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[Code Commit]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[tfsec]</span>
<span class="hljs-number">3</span>  <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[OPA Policy Check]</span>
<span class="hljs-number">4</span>  C --&gt; D<span class="hljs-selector-attr">[Trivy Scan]</span>
<span class="hljs-number">5</span>  D --&gt; E<span class="hljs-selector-attr">[Deploy to Cloud]</span>
<span class="hljs-number">6</span>
</code></pre>
</li>
<li>
<p><strong>团队培训</strong>：</p>
<ul>
<li>将安全左移纳入开发者日常流程（如 Git 提交前自动检测）；</li>
<li>定期更新安全策略以适配新漏洞（如 Log4j2 事件后的依赖检查）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">结语</h3>
<p>安全左移下的 Terraform 实践，本质是将安全从“事后处理”转变为“内生能力”。通过静态分析、策略约束和动态扫描的三层防护，结合 AI 技术的智能化演进，企业可显著降低云基础设施的安全风险，同时提升开发效率。未来，随着 IaC 生态的完善，安全左移将成为云原生安全的标配能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建无障碍组件之Breadcrumb Pattern]]></title>    <link>https://juejin.cn/post/7601169987396436019</link>    <guid>https://juejin.cn/post/7601169987396436019</guid>    <pubDate>2026-01-31T08:32:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601169987396436019" data-draft-id="7600982613655126066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建无障碍组件之Breadcrumb Pattern"/> <meta itemprop="keywords" content="前端,设计,HTML"/> <meta itemprop="datePublished" content="2026-01-31T08:32:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="anOnion"/> <meta itemprop="url" content="https://juejin.cn/user/553809592722589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建无障碍组件之Breadcrumb Pattern
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/553809592722589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    anOnion
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T08:32:47.000Z" title="Sat Jan 31 2026 08:32:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Breadcrumb Pattern 详解：构建无障碍面包屑导航</h2>
<p>面包屑导航是 Web 页面中不可或缺的导航组件，它以层级链接的形式展示当前页面在网站结构中的位置，帮助用户快速了解自己所处的位置并轻松返回上级页面。根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FWAI%2FARIA%2Fapg%2Fpatterns%2Fbreadcrumb%2F" target="_blank" title="https://www.w3.org/WAI/ARIA/apg/patterns/breadcrumb/" ref="nofollow noopener noreferrer">W3C WAI-ARIA Breadcrumb Pattern</a> 规范，正确实现的面包屑导航不仅要提供清晰的层级导航路径，更要确保所有用户都能顺利使用，包括依赖屏幕阅读器等辅助技术的用户。本文将深入探讨 Breadcrumb Pattern 的核心概念、实现要点以及最佳实践。</p>
<h3 data-id="heading-1">一、面包屑导航的定义与核心功能</h3>
<p>面包屑导航（Breadcrumb Trail）是由一系列指向父级页面的链接组成的导航路径，按照层级顺序展示当前页面在网站架构中的位置。它的主要功能是帮助用户了解自己在网站中的位置，并在需要时快速返回上级页面。面包屑导航通常水平放置在页面主体内容之前，为用户提供清晰的导航参考。</p>
<p>在实际应用中，面包屑导航广泛应用于内容层级较深的网站，例如电商平台的产品分类页、博客文章的分类归档页、企业官网的产品介绍页等。一个设计良好的面包屑导航能够显著提升用户体验，降低用户的迷失感，同时也有利于搜索引擎更好地理解网站的结构层次。</p>
<h3 data-id="heading-2">二、键盘交互规范</h3>
<p>面包屑导航的键盘交互具有特殊性。由于面包屑导航仅由静态链接组成，用户不需要进行任何特殊的键盘操作来与之交互。链接本身已经支持标准的键盘导航行为，用户可以通过 Tab 键在各个链接之间切换，通过 Enter 键激活链接进行页面跳转。这种标准的行为已经满足了键盘可访问性的要求，无需额外的键盘事件处理。</p>
<p>因此，Breadcrumb Pattern 规范明确指出，面包屑导航不需要特殊的键盘交互支持。开发者只需要确保链接元素是标准的 HTML 元素，即可获得完整的键盘可访问性支持。这一特点使得面包屑导航的实现相对简单，重点应放在正确的语义标记和 ARIA 属性使用上。</p>
<h3 data-id="heading-3">三、WAI-ARIA 角色、状态和属性</h3>
<p>正确使用 WAI-ARIA 属性是构建无障碍面包屑导航的技术基础。虽然面包屑导航不涉及复杂的交互逻辑，但正确的语义标记对于屏幕阅读器用户理解导航结构至关重要。</p>
<h4 data-id="heading-4">3.1 导航容器标记</h4>
<p>面包屑导航必须放置在导航地标区域（Navigation Landmark）内。这可以通过使用 nav 元素或为其他元素添加 role="navigation" 来实现。导航地标区域需要通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23aria-label" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#aria-label" ref="nofollow noopener noreferrer">aria-label</a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23aria-labelledby" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#aria-labelledby" ref="nofollow noopener noreferrer">aria-labelledby</a> 进行标记，以便屏幕阅读器向用户描述这个导航区域的用途。</p>
<p>示例：使用 nav 元素包裹面包屑导航：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"面包屑导航"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/products/"</span>&gt;</span>产品<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/products/electronics/"</span>&gt;</span>电子产品<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">aria-current</span>=<span class="hljs-string">"page"</span>&gt;</span>笔记本电脑<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
</code></pre>
<p>示例：使用 role 属性定义导航地标：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">role</span>=<span class="hljs-string">"navigation"</span>
  <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"面包屑导航"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/blog/"</span>&gt;</span>博客<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">aria-current</span>=<span class="hljs-string">"page"</span>&gt;</span>2025 年技术趋势<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-5">3.2 当前页面状态标记</h4>
<p>面包屑导航中的当前页面链接需要使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23aria-current" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#aria-current" ref="nofollow noopener noreferrer">aria-current</a> 属性来标识。aria-current="page" 明确告诉辅助技术当前元素代表的是用户正在浏览的页面。这一属性对于屏幕阅读器用户理解面包屑导航的结构非常重要，使他们能够区分可导航的父级页面和当前所在页面。</p>
<p>值得注意的是，如果代表当前页面的元素不是链接（例如使用 span 或其他元素呈现），那么 aria-current 属性是可选的。但为了保持一致性，建议始终为当前页面元素添加 aria-current="page"。</p>
<p>示例：当前页面为链接时的标记：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"面包屑导航"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/docs/"</span>&gt;</span>文档<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/docs/guides/"</span>&gt;</span>指南<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">a</span>
        <span class="hljs-attr">href</span>=<span class="hljs-string">"/docs/guides/getting-started/"</span>
        <span class="hljs-attr">aria-current</span>=<span class="hljs-string">"page"</span>
        &gt;</span>快速入门&lt;/a
      &gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
</code></pre>
<p>示例：当前页面为非链接元素时的标记：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"面包屑导航"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/shop/"</span>&gt;</span>商店<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/shop/clothing/"</span>&gt;</span>服装<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">aria-current</span>=<span class="hljs-string">"page"</span>&gt;</span>春季新品<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">四、完整示例</h3>
<p>以下是使用不同方式实现面包屑导航的完整示例，展示了标准的 HTML 结构、ARIA 属性应用以及样式设计：</p>
<h4 data-id="heading-7">4.1 基础面包屑导航实现</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"面包屑导航"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ol</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/products/"</span>&gt;</span>所有产品<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/products/electronics/"</span>&gt;</span>电子产品<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">aria-current</span>=<span class="hljs-string">"page"</span>&gt;</span>智能手表<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">4.2 带分隔符的面包屑导航</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>
  <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"面包屑导航"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb-nav"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ol</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb-list"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">a</span>
        <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb-link"</span>
        &gt;</span>首页&lt;/a
      &gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb-separator"</span>
      <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">"true"</span>&gt;</span>
      /
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">a</span>
        <span class="hljs-attr">href</span>=<span class="hljs-string">"/categories/"</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb-link"</span>
        &gt;</span>分类&lt;/a
      &gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb-separator"</span>
      <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">"true"</span>&gt;</span>
      /
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">a</span>
        <span class="hljs-attr">href</span>=<span class="hljs-string">"/categories/books/"</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb-link"</span>
        &gt;</span>图书&lt;/a
      &gt;
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb-separator"</span>
      <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">"true"</span>&gt;</span>
      /
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb-item"</span>
      <span class="hljs-attr">aria-current</span>=<span class="hljs-string">"page"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb-current"</span>&gt;</span>编程指南<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
</code></pre>
<h4 data-id="heading-9">4.3 电商网站产品页面包屑导航</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">nav</span>
  <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"商品位置"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"product-breadcrumb"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://www.example.com/"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://www.example.com/electronics/"</span>&gt;</span>家用电器<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://www.example.com/electronics/kitchen/"</span>&gt;</span>厨房电器<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://www.example.com/electronics/kitchen/coffee/"</span>&gt;</span>咖啡机<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">aria-current</span>=<span class="hljs-string">"page"</span>&gt;</span>全自动咖啡机 X2000<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">五、最佳实践</h3>
<h4 data-id="heading-11">5.1 语义化 HTML 结构</h4>
<p>面包屑导航应使用语义化的 HTML 元素构建。使用 nav 元素定义导航区域，使用 ol 或 ul 元素创建有序或无序列表，使用 li 元素包含各个导航项。这种结构不仅对搜索引擎友好，也便于屏幕阅读器向用户传达导航的层级关系。</p>
<p>在列表的选择上，ol 元素更适合面包屑导航，因为它能够传达各个项之间的顺序关系。但如果网站没有强制的层级顺序要求，ul 元素同样可以接受。无论选择哪种列表元素，都要确保列表项之间的逻辑顺序与面包屑导航的层级结构保持一致。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 推荐做法：使用语义化元素 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"面包屑导航"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/docs/"</span>&gt;</span>文档<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">aria-current</span>=<span class="hljs-string">"page"</span>&gt;</span>当前页面<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
</code></pre>
<h4 data-id="heading-12">5.2 正确使用 ARIA 属性</h4>
<p>面包屑导航的 ARIA 属性使用相对简单，但有几个关键点需要注意。首先，导航容器必须使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23aria-label" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#aria-label" ref="nofollow noopener noreferrer">aria-label</a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23aria-labelledby" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#aria-labelledby" ref="nofollow noopener noreferrer">aria-labelledby</a> 进行标记，以便用户了解这个导航区域的用途。其次，当前页面项必须使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23aria-current" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#aria-current" ref="nofollow noopener noreferrer">aria-current</a>="page" 进行标记。最后，确保分隔符元素使用 aria-hidden="true"，以避免辅助技术用户听到不必要的标点符号朗读。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- ARIA 属性使用规范 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"面包屑导航"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ol</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">"true"</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/blog/"</span>&gt;</span>博客<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">"true"</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">aria-current</span>=<span class="hljs-string">"page"</span>&gt;</span>文章标题<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">ol</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
</code></pre>
<h4 data-id="heading-13">5.3 响应式设计考虑</h4>
<p>面包屑导航在移动设备上可能面临空间受限的挑战。对于层级较深的导航，可以考虑以下策略：一是使用省略号隐藏中间层级，只保留首页和最后几级；二是允许用户展开查看完整路径；三是将面包屑导航改为垂直布局。无论采用哪种策略，都要确保用户能够访问完整的导航信息。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 响应式面包屑导航 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">768px</span>) {
  <span class="hljs-selector-class">.breadcrumb-list</span> {
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">gap</span>: <span class="hljs-number">4px</span>;
  }

  <span class="hljs-selector-class">.breadcrumb-separator</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">rotate</span>(<span class="hljs-number">90deg</span>);
  }
}
</code></pre>
<h3 data-id="heading-14">六、面包屑导航与主导航的区别</h3>
<p>面包屑导航和主导航栏虽然都是网站导航的重要组成部分，但它们服务于不同的目的，理解这种区别对于正确使用这两种导航组件至关重要。</p>
<p>面包屑导航的主要作用是展示用户在网站层级结构中的当前位置，它反映的是网站的逻辑结构，而非用户的浏览历史。面包屑导航通常只出现在层级较深的页面中，帮助用户理解当前位置与网站整体结构的关系。相比之下，主导航栏提供的是网站的整体架构概览，允许用户直接跳转到任何主要版块，而不考虑当前的层级位置。</p>
<p>从实现角度来看，面包屑导航强调的是层级关系，因此通常使用有序列表（ol）来体现这种顺序性。而主导航栏更强调功能分区的划分，可能使用无序列表（ul）或更复杂的布局结构。两者在 ARIA 属性使用上也不同：面包屑导航需要明确标记当前页面（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23aria-current" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#aria-current" ref="nofollow noopener noreferrer">aria-current</a>="page"），而主导航栏通常不需要这种标记。</p>
<h3 data-id="heading-15">七、总结</h3>
<p>构建无障碍的面包屑导航需要关注语义化结构、ARIA 属性应用和视觉样式三个层面的细节。从语义化角度，应使用 nav 元素定义导航区域，使用 ol 或 ul 元素创建列表结构。从 ARIA 属性角度，需要使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23aria-label" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#aria-label" ref="nofollow noopener noreferrer">aria-label</a> 为导航区域提供标签，使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fwai-aria-1.2%2F%23aria-current" target="_blank" title="https://www.w3.org/TR/wai-aria-1.2/#aria-current" ref="nofollow noopener noreferrer">aria-current</a>="page" 标记当前页面。从视觉样式角度，应确保链接易于识别，分隔符清晰，当前页面状态明确。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FWAI%2FARIA%2Fapg%2Fpatterns%2Fbreadcrumb%2F" target="_blank" title="https://www.w3.org/WAI/ARIA/apg/patterns/breadcrumb/" ref="nofollow noopener noreferrer">WAI-ARIA Breadcrumb Pattern</a> 为我们提供了清晰的指导方针，遵循这些规范能够帮助我们创建更加包容和易用的 Web 应用。每一个正确实现的面包屑导航组件，都是提升用户体验和网站可访问性的重要一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CMakeLists.txt命令全面解析]]></title>    <link>https://juejin.cn/post/7600986495927877673</link>    <guid>https://juejin.cn/post/7600986495927877673</guid>    <pubDate>2026-01-31T08:58:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600986495927877673" data-draft-id="7600986495927844905" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CMakeLists.txt命令全面解析"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2026-01-31T08:58:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="黑夜给了我黑色的眼睛"/> <meta itemprop="url" content="https://juejin.cn/user/3690408471177224"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CMakeLists.txt命令全面解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3690408471177224/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    黑夜给了我黑色的眼睛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T08:58:55.000Z" title="Sat Jan 31 2026 08:58:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、CMake 核心基础（必学，占80%使用场景）</h2>
<h3 data-id="heading-1">1. 版本声明（脚本第一行必写）</h3>
<h4 data-id="heading-2">命令格式</h4>
<pre><code class="hljs language-cmake" lang="cmake">cmake_minimum_required(VERSION &lt;版本号&gt;)
</code></pre>
<h4 data-id="heading-3">示例（你的代码）</h4>
<pre><code class="hljs language-cmake" lang="cmake">cmake_minimum_required(VERSION 3.10)    # Abseil项目最低版本
cmake_minimum_required(VERSION 3.22.1) # nativesdk项目最低版本
cmake_minimum_required(VERSION 3.5)     # utf8_range项目最低版本
</code></pre>
<h4 data-id="heading-4">作用</h4>
<p>指定运行当前CMake脚本所需的最低CMake版本，低于该版本会直接报错，确保脚本兼容性。</p>
<h3 data-id="heading-5">2. 项目声明</h3>
<h4 data-id="heading-6">命令格式</h4>
<pre><code class="hljs language-cmake" lang="cmake">project(&lt;项目名&gt; [LANGUAGES &lt;语言列表&gt;] [VERSION &lt;版本号&gt;])
</code></pre>
<h4 data-id="heading-7">示例（你的代码）</h4>
<pre><code class="hljs language-cmake" lang="cmake">project(absl LANGUAGES CXX VERSION 20230802)  # 仅C++，指定版本
project(nativesdk)                             # 默认语言（C/C++），无版本
project(utf8_range C CXX)                     # 同时支持C和C++
</code></pre>
<h4 data-id="heading-8">作用</h4>
<ul>
<li>定义项目名称，是CMake脚本的核心标识；</li>
<li><code>LANGUAGES</code>：指定项目支持的编译语言（CXX=C++，C=C，不写则默认C/C++）；</li>
<li><code>VERSION</code>：给项目标注版本号（仅发布库时有用）；</li>
</ul>
<h4 data-id="heading-9">自动生成变量（常用）</h4>
<ul>
<li><code>${PROJECT_NAME}</code>：当前项目名（如absl、nativesdk）；</li>
<li><code>${PROJECT_SOURCE_DIR}</code>：项目源码根目录。</li>
</ul>
<h3 data-id="heading-10">3. 变量设置（存储路径/开关/参数）</h3>
<h4 data-id="heading-11">命令格式</h4>
<pre><code class="hljs language-cmake" lang="cmake"># 基础赋值
set(&lt;变量名&gt; &lt;变量值&gt;)
# 缓存变量（强制覆盖默认值）
set(&lt;变量名&gt; &lt;值&gt; CACHE &lt;类型&gt; "&lt;描述&gt;" FORCE)
</code></pre>
<h4 data-id="heading-12">示例（你的代码）</h4>
<pre><code class="hljs language-cmake" lang="cmake"># 基础变量：编译标准、平台配置
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_ANDROID_STL_TYPE c++_static)

# 缓存变量：关闭第三方库测试/示例
set(ABSL_BUILD_TESTING OFF CACHE BOOL "" FORCE)
set(protobuf_USE_LITE_RUNTIME ON CACHE BOOL "" FORCE)

# 路径变量：拼接路径
set(UTF8_RANGE_SRC_DIR "${protobuf_SOURCE_DIR}/third_party/utf8_range")
</code></pre>
<h4 data-id="heading-13">核心说明</h4>
<ul>
<li>变量引用方式：<code>${变量名}</code>（如<code>${CMAKE_CXX_STANDARD}</code>）；</li>
<li>常用类型：<code>BOOL</code>（布尔值，值为ON/OFF，非true/false）；</li>
<li><code>FORCE</code>：强制覆盖CMake默认的变量值（比如关闭Abseil的测试编译）；</li>
<li>路径拼接：用双引号包裹（<code>"${A}/${B}"</code>），避免路径含空格时出错。</li>
</ul>
<h3 data-id="heading-14">4. 编译库/可执行文件（核心编译命令）</h3>
<h4 data-id="heading-15">（1）编译库：<code>add_library</code></h4>
<h5 data-id="heading-16">命令格式</h5>
<pre><code class="hljs language-cmake" lang="cmake">add_library(&lt;库名&gt; &lt;库类型&gt; &lt;源码文件列表&gt;)
</code></pre>
<h5 data-id="heading-17">示例（你的代码）</h5>
<pre><code class="hljs language-cmake" lang="cmake"># 静态库（STATIC）：生成.a/.lib文件
add_library(utf8_range STATIC naive.c range2-neon.c)

# 动态库（SHARED）：生成.so/.dll文件
add_library(nativesdk SHARED ${ALL_SRC})
</code></pre>
<h5 data-id="heading-18">核心说明</h5>
<ul>
<li>库类型：
<ul>
<li><code>STATIC</code>：静态库，编译时打包进可执行文件，不依赖外部库；</li>
<li><code>SHARED</code>：动态库，运行时加载，需配套发布.so/.dll；</li>
<li><code>INTERFACE</code>：仅头文件库（无源码，仅提供头文件）；</li>
</ul>
</li>
<li>源码列表：可直接写文件名（如<code>naive.c</code>），也可引用变量（如<code>${ALL_SRC}</code>）。</li>
</ul>
<h4 data-id="heading-19">（2）编译可执行文件：<code>add_executable</code></h4>
<h5 data-id="heading-20">命令格式</h5>
<pre><code class="hljs language-cmake" lang="cmake">add_executable(&lt;程序名&gt; &lt;源码文件列表&gt;)
</code></pre>
<h5 data-id="heading-21">示例（你的代码）</h5>
<pre><code class="hljs language-cmake" lang="cmake">add_executable(tests utf8_validity_test.cc)  # 编译测试程序
</code></pre>
<h5 data-id="heading-22">作用</h5>
<p>生成可运行的程序（如测试程序、工具程序），仅在需要可执行文件时使用。</p>
<h3 data-id="heading-23">5. 头文件目录配置</h3>
<h4 data-id="heading-24">命令格式</h4>
<pre><code class="hljs language-cmake" lang="cmake"># 全局头文件（所有目标生效）
include_directories(&lt;目录列表&gt;)
# 目标专属头文件（推荐，精准）
target_include_directories(&lt;目标名&gt; &lt;作用域&gt; &lt;目录列表&gt;)
</code></pre>
<h4 data-id="heading-25">示例（你的代码）</h4>
<pre><code class="hljs language-cmake" lang="cmake"># 全局头文件
include_directories(${UTF8_RANGE_SRC_DIR})

# 目标专属头文件（PRIVATE仅当前目标可用）
target_include_directories(nativesdk PRIVATE
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${abseil-cpp_SOURCE_DIR}
)
</code></pre>
<h4 data-id="heading-26">核心说明</h4>
<ul>
<li>作用域：
<ul>
<li><code>PRIVATE</code>：仅当前目标可用（如nativesdk自己的头文件）；</li>
<li><code>PUBLIC</code>：当前目标 + 依赖该目标的其他目标可用；</li>
<li><code>INTERFACE</code>：仅依赖该目标的其他目标可用；</li>
</ul>
</li>
<li>核心作用：告诉编译器「去哪里找#include的头文件」，避免「头文件找不到」错误。</li>
</ul>
<h3 data-id="heading-27">6. 库链接（关联依赖库）</h3>
<h4 data-id="heading-28">命令格式</h4>
<pre><code class="hljs language-cmake" lang="cmake">target_link_libraries(&lt;目标名&gt; &lt;作用域&gt; &lt;库名列表&gt;)
</code></pre>
<h4 data-id="heading-29">示例（你的代码）</h4>
<pre><code class="hljs language-cmake" lang="cmake">target_link_libraries(nativesdk PRIVATE
  absl::base absl::strings
  protobuf::libprotobuf-lite
  utf8_range
  log z atomic m
)

target_link_libraries(utf8_validity PUBLIC absl::strings)
</code></pre>
<h4 data-id="heading-30">核心说明</h4>
<ul>
<li>作用：告诉编译器「当前目标需要链接哪些库」，解决编译时的「未定义符号」错误；</li>
<li>库名类型：
<ul>
<li>自定义库（如<code>utf8_range</code>）；</li>
<li>第三方库别名（如<code>absl::base</code>、<code>protobuf::libprotobuf-lite</code>）；</li>
<li>系统库（如Android的<code>log</code>、<code>z</code>、<code>atomic</code>）；</li>
</ul>
</li>
<li>作用域：同<code>target_include_directories</code>（PRIVATE/PUBLIC/INTERFACE）。</li>
</ul>
<h3 data-id="heading-31">7. 条件判断（控制编译逻辑）</h3>
<h4 data-id="heading-32">命令格式</h4>
<pre><code class="hljs language-cmake" lang="cmake">if(&lt;条件&gt;)
  # 满足条件执行的命令
elseif(&lt;其他条件&gt;)
  # 其他条件执行的命令
else()
  # 都不满足执行的命令
endif()
</code></pre>
<h4 data-id="heading-33">示例（你的代码）</h4>
<pre><code class="hljs language-cmake" lang="cmake"># 检查是否存在目标
if (NOT TARGET absl::strings)
  if (NOT ABSL_ROOT_DIR)
    find_package(absl REQUIRED CONFIG)
  else ()
    add_subdirectory(${ABSL_ROOT_DIR} third_party/abseil-cpp)
  endif ()
endif ()

# 检查编译开关
if (${ABSL_BUILD_DLL})
  absl_make_dll()
endif ()
</code></pre>
<h4 data-id="heading-34">常用条件</h4>
<ul>
<li><code>NOT</code>：取反（如<code>NOT TARGET absl::strings</code> = 不存在absl::strings目标）；</li>
<li><code>MATCHES</code>：字符串匹配（如<code>"${CMAKE_CXX_COMPILER_ID}" MATCHES "Clang"</code>）；</li>
<li>变量判断（如<code>${ABSL_BUILD_DLL}</code> = ON时执行）；</li>
</ul>
<h4 data-id="heading-35">作用</h4>
<p>实现「跨平台编译」「按需编译」（比如Android和Linux编译逻辑不同、是否编译测试代码）。</p>
<h2 data-id="heading-36">二、CMake 进阶命令（你的代码高频使用）</h2>
<h3 data-id="heading-37">1. 第三方库拉取：<code>FetchContent</code>（自动下载/编译）</h3>
<h4 data-id="heading-38">命令组合</h4>
<pre><code class="hljs language-cmake" lang="cmake"># 声明要拉取的库
FetchContent_Declare(
  &lt;库名&gt;
  GIT_REPOSITORY &lt;Git仓库地址&gt;
  GIT_TAG &lt;版本标签/分支&gt;
  GIT_SHALLOW &lt;ON/OFF&gt;
)
# 初始化并编译库
FetchContent_MakeAvailable(&lt;库名1&gt; &lt;库名2&gt;)
</code></pre>
<h4 data-id="heading-39">示例（你的代码）</h4>
<pre><code class="hljs language-cmake" lang="cmake">FetchContent_Declare(
  abseil-cpp
  GIT_REPOSITORY https://github.com/abseil/abseil-cpp.git
  GIT_TAG 20240116.0
  GIT_SHALLOW OFF
)
FetchContent_MakeAvailable(abseil-cpp protobuf)
</code></pre>
<h4 data-id="heading-40">核心说明</h4>
<ul>
<li>作用：无需手动下载第三方库源码，CMake自动从Git拉取、编译，简化依赖管理；</li>
<li><code>GIT_TAG</code>：必须指定（如版本号、标签），避免拉取最新代码导致兼容问题；</li>
<li>拉取的库会存到构建目录的<code>_deps</code>子目录下。</li>
</ul>
<h3 data-id="heading-41">2. 查找系统库：<code>find_package</code>（找已安装的库）</h3>
<h4 data-id="heading-42">命令格式</h4>
<pre><code class="hljs language-cmake" lang="cmake">find_package(&lt;库名&gt; [REQUIRED] [CONFIG])
</code></pre>
<h4 data-id="heading-43">示例（你的代码）</h4>
<pre><code class="hljs language-cmake" lang="cmake">find_package(Threads REQUIRED)    # 查找线程库，找不到则报错
find_package(GTest REQUIRED)      # 查找GoogleTest库
find_package(absl REQUIRED CONFIG) # 按配置文件查找Abseil
</code></pre>
<h4 data-id="heading-44">核心说明</h4>
<ul>
<li><code>REQUIRED</code>：标记为必选依赖，找不到库则直接报错；</li>
<li><code>CONFIG</code>：按库的CMake配置文件查找（而非系统默认路径）；</li>
<li>区别：<code>FetchContent</code>是「下载并编译」，<code>find_package</code>是「找已安装的库」。</li>
</ul>
<h3 data-id="heading-45">3. 子目录编译：<code>add_subdirectory</code></h3>
<h4 data-id="heading-46">命令格式</h4>
<pre><code class="hljs language-cmake" lang="cmake">add_subdirectory(&lt;子目录路径&gt; [编译输出目录])
</code></pre>
<h4 data-id="heading-47">示例（你的代码）</h4>
<pre><code class="hljs language-cmake" lang="cmake">add_subdirectory(absl)                  # 编译Abseil主目录
add_subdirectory(base)                  # 编译Abseil的base子模块
add_subdirectory(${ABSL_ROOT_DIR} third_party/abseil-cpp) # 指定输出目录
</code></pre>
<h4 data-id="heading-48">作用</h4>
<p>进入子目录，执行该目录下的<code>CMakeLists.txt</code>，适合拆分大型项目（如Abseil按模块拆分编译）。</p>
<h3 data-id="heading-49">4. 编译宏定义：<code>target_compile_definitions</code></h3>
<h4 data-id="heading-50">命令格式</h4>
<pre><code class="hljs language-cmake" lang="cmake">target_compile_definitions(&lt;目标名&gt; &lt;作用域&gt; &lt;宏名1&gt; &lt;宏名2=值&gt;)
</code></pre>
<h4 data-id="heading-51">示例（你的代码）</h4>
<pre><code class="hljs language-cmake" lang="cmake">target_compile_definitions(nativesdk PRIVATE
  PROTOBUF_USE_LITE_RUNTIME
  GOOGLE_PROTOBUF_NO_RTTI
  PROTOBUF_DISABLE_JSON=1
)
</code></pre>
<h4 data-id="heading-52">作用</h4>
<p>给编译器传递宏定义，代码中可通过<code>#ifdef</code>判断（如<code>PROTOBUF_USE_LITE_RUNTIME</code>启用Protobuf Lite版本）。</p>
<h3 data-id="heading-53">5. 文件批量查找：<code>file(GLOB)</code></h3>
<h4 data-id="heading-54">命令格式</h4>
<pre><code class="hljs language-cmake" lang="cmake">file(GLOB &lt;变量名&gt; &lt;文件匹配规则&gt;)
</code></pre>
<h4 data-id="heading-55">示例（你的代码）</h4>
<pre><code class="hljs language-cmake" lang="cmake">file(GLOB ALL_SRC
  ${CMAKE_CURRENT_SOURCE_DIR}/core/*.cpp
  ${CMAKE_CURRENT_SOURCE_DIR}/proto/*.pb.cc
)
</code></pre>
<h4 data-id="heading-56">核心说明</h4>
<ul>
<li>作用：批量匹配文件（如所有<code>.cpp</code>、<code>.pb.cc</code>），避免手动罗列所有源码；</li>
<li>匹配规则：<code>*.cpp</code>（所有cpp文件）、<code>core/*.cpp</code>（core目录下的cpp文件）；</li>
<li>注意：新增文件后需重新执行<code>cmake ..</code>才能识别。</li>
</ul>
<h3 data-id="heading-57">6. CMake策略配置：<code>cmake_policy</code></h3>
<h4 data-id="heading-58">命令格式</h4>
<pre><code class="hljs language-cmake" lang="cmake">cmake_policy(SET &lt;策略ID&gt; &lt;NEW/OLD&gt;)
</code></pre>
<h4 data-id="heading-59">示例（你的代码）</h4>
<pre><code class="hljs language-cmake" lang="cmake">cmake_policy(SET CMP0025 NEW)  # Apple Clang编译器标识修正
cmake_policy(SET CMP0077 NEW)  # option命令尊重变量值
</code></pre>
<h4 data-id="heading-60">作用</h4>
<p>兼容不同CMake版本的行为差异（如旧版本CMake的某些命令逻辑和新版本不同，通过策略统一）。</p>
<h2 data-id="heading-61">三、CMake 实战场景（结合你的代码）</h2>
<h3 data-id="heading-62">场景1：编译Android动态库（nativesdk）</h3>
<p>核心命令流程：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 1. 基础配置
cmake_minimum_required(VERSION 3.22.1)
project(nativesdk)
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_ANDROID_STL_TYPE c++_static)

# 2. 拉取第三方依赖
FetchContent_Declare(abseil-cpp ...)
FetchContent_Declare(protobuf ...)
FetchContent_MakeAvailable(abseil-cpp protobuf)

# 3. 收集源码
file(GLOB ALL_SRC core/*.cpp jni/*.cpp proto/*.pb.cc)

# 4. 编译动态库
add_library(nativesdk SHARED ${ALL_SRC})

# 5. 配置头文件
target_include_directories(nativesdk PRIVATE ${CMAKE_CURRENT_SOURCE_DIR} ${abseil-cpp_SOURCE_DIR})

# 6. 定义编译宏
target_compile_definitions(nativesdk PRIVATE PROTOBUF_USE_LITE_RUNTIME)

# 7. 链接依赖库
target_link_libraries(nativesdk PRIVATE absl::base protobuf::libprotobuf-lite)
</code></pre>
<h3 data-id="heading-63">场景2：编译静态库（utf8_range）</h3>
<p>核心命令流程：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 1. 基础配置
cmake_minimum_required(VERSION 3.5)
project(utf8_range C CXX)

# 2. 编译静态库
add_library(utf8_range STATIC naive.c range2-neon.c)

# 3. 查找/编译Abseil依赖
if (NOT TARGET absl::strings)
  find_package(absl REQUIRED CONFIG)
endif()

# 4. 链接Abseil
target_link_libraries(utf8_validity PUBLIC absl::strings)
</code></pre>
<h2 data-id="heading-64">四、避坑指南</h2>
<ol>
<li>路径引用：所有路径用<code>${}</code>包裹，拼接时加双引号（如<code>"${A}/${B}"</code>）；</li>
<li>布尔值：CMake中用<code>ON/OFF</code>，而非<code>true/false</code>；</li>
<li>作用域：优先用<code>PRIVATE</code>（仅当前目标生效），避免<code>PUBLIC</code>导致的全局污染；</li>
<li>第三方库：<code>FetchContent</code>指定<code>GIT_TAG</code>，避免拉取最新代码引发兼容问题；</li>
<li>错误排查：
<ul>
<li>头文件找不到：检查<code>target_include_directories</code>；</li>
<li>链接错误：检查<code>target_link_libraries</code>（库名是否正确、顺序是否合理）。</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官：多节点争抢资源， Redis 分布式锁是怎么实现的？]]></title>    <link>https://juejin.cn/post/7600999271770341376</link>    <guid>https://juejin.cn/post/7600999271770341376</guid>    <pubDate>2026-01-31T07:07:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600999271770341376" data-draft-id="7601018079620612111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官：多节点争抢资源， Redis 分布式锁是怎么实现的？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-31T07:07:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小林coding"/> <meta itemprop="url" content="https://juejin.cn/user/1750078243734029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官：多节点争抢资源， Redis 分布式锁是怎么实现的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1750078243734029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小林coding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:07:58.000Z" title="Sat Jan 31 2026 07:07:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">多节点争抢资源， Redis 分布式锁是怎么实现的？</h2>
<p>大家好，今天给大家分享 Redis 里的一个知识点 — Redis 分布式锁。</p>
<p><strong>在分布式系统的世界里，Redis 就像一座高效运转的共享仓库</strong> — 多个节点通过共享数据协同发力，左手接过业务系统的海量读写请求，右手以毫秒级速度完成数据交付。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b8e5942e4b7439dbdf3a911a642b973~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=cLjG0a%2BPRLw%2FXLxtzn%2FlKj18tEk%3D" alt="图片" loading="lazy"/></p>
<p>可再默契的团队，如果没有统一的行动准则，也难免遇到“抢活干”的问题。而 Redis 分布式锁，就像是分布式世界里的 “秩序守护者”。它会清晰地告诉每个节点：</p>
<p><strong>什么时候能操作数据、能不能同时操作，把数据操作的边界和顺序划分得明明白白，从根源上杜绝争抢。</strong></p>
<p>接下来，我们就来看看 — Redis 分布式锁是怎么给多节点系统 “立规矩” 的。</p>
<h3 data-id="heading-1">谁在给 Redis 锁制造冲突？</h3>
<p>Redis 锁的核心目标，是在分布式环境中建立"共享资源访问规则"，让锁机制井然有序运行。但在实际落地时，总有些问题在制造冲突：</p>
<h4 data-id="heading-2"><strong>问题一：锁争抢 — 多人抢同一把锁，导致数据错乱</strong></h4>
<p>节点想要拿到锁，得经历两步操作：</p>
<p><strong>先判断这把锁当前有没有被人占用，确认空闲后再动手抢占锁。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e1c99f39e86408f8ccba4b03fa78801~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=PP87Yp%2FstrXKiEUno7iUXjcoz9g%3D" alt="图片" loading="lazy"/></p>
<p>但问题恰恰出在这两步是分开做的 — 哪怕中间只隔了一瞬间的空隙，也足以埋下隐患。</p>
<p>想象一下这样的场景：有好几个节点同时要抢同一把锁。节点 A 先查询了锁的状态，发现 “没人占用”，正准备动手抢占时，节点 B 几乎在同一时间也查了锁的状态，得到了同样的结果。</p>
<p><strong>接下来，两个节点都顺利完成了抢占操作，以至于每个节点都觉得自己抢到了唯一的锁。</strong> 进而同时去操作同一个共享资源，最终引发数据错乱、操作冲突。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f66119c9f8f48979c684ff6f670f7d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=FMX0vlpTrA3UD%2B%2BTE4YGYnWOMy4%3D" alt="图片" loading="lazy"/></p>
<p>锁争抢就是典型的“多人抢锁”乱象，而当锁被某一节点占用后，又可能面临「锁不释放」的情况，这便是“僵尸锁”带来的挑战。</p>
<h4 data-id="heading-3"><strong>问题二：僵尸锁 — 锁不释放，导致业务流程阻塞</strong></h4>
<p>某个节点拿到锁后，粗心地忘了给锁设定过期时间，紧接着又因为节点宕机或程序报错，没法主动释放这把锁。</p>
<p><strong>于是这条锁记录就彻底赖在 Redis 里不走了，变成没人管的 “僵尸锁”</strong> — 牢牢霸占着对应的共享资源，后面不管哪个节点想操作这个资源，全被它拦在门外，直接影响整个系统正常干活。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9a7ca5685914e74ba2edc4f311ed93d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=nY3ShMQeOSldclx3%2BM7pSKW2DzY%3D" alt="图片" loading="lazy"/></p>
<p>为了解决“僵尸”锁问题，给锁设置过期时间成为必然选择，但这一解决方案又会催生新的矛盾，即锁过期的问题。</p>
<h4 data-id="heading-4"><strong>问题三：锁过期 — 过期时间与任务时长不匹配</strong></h4>
<p>某个节点拿到锁并且设置完过期时间后，马上投入业务处理，可偏偏业务还没做完，锁的过期时间就到了。</p>
<p>Redis 见状直接自动释放了锁，而原来拿锁的节点对此毫无察觉，还在闷头干活。这时，其他节点一看锁没了，立刻一拥而上把锁抢到手，然后操作同一个资源 — <strong>结果就是两个节点同时改一个数据，直接造成并发冲突。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93ffd17aae7841b2b4dde3173051c346~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=LrCcH3yQvrKIhE%2BNfr7%2BgrpZtdQ%3D" alt="图片" loading="lazy"/></p>
<p>但无论是锁争抢、僵尸锁，还是锁过期导致的冲突，都有一个前提：<strong>锁的存储节点足够稳定。</strong> 而当 Redis 架构本身出现隐患时，上述所有问题都可能升级为影响整个系统的故障。</p>
<h4 data-id="heading-5"><strong>问题四：锁存储不可靠 — 单节点部署的隐患</strong></h4>
<p>当存储分布式锁的 Redis 只用单节点部署时，无异于把所有 “锁管理大权” 交给了唯一的管理员。一旦这个管理员突然 “罢工”（比如宕机），那么所有加锁、解锁、查锁状态的操作都会彻底卡壳，直接导致整个分布式锁机制瘫痪。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/082d1d1ef93e43f9b74a02607da4ba98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=HyqxKo5idEewq5JTel10zxMH0NM%3D" alt="图片" loading="lazy"/></p>
<p>到头来，共享资源要么没人敢碰，要么大家一窝蜂乱抢，场面完全失控。</p>
<p>这些问题就像横亘在我们面前的四座大山，要构建可靠的分布式锁，就必须逐一攻克。接下来，我们就来看业务层面如何借助 Redis 的核心特性来实现分布式锁的。</p>
<h3 data-id="heading-6">Redis 锁的“秩序构建术”</h3>
<p>面对分布式环境的复杂挑战，Redis 锁通过分层设计构建了一套完整的"秩序体系"。从加锁到释放锁，每个环节都蕴含着精妙的设计思想。</p>
<h4 data-id="heading-7">1、加锁机制：从单节点到高可用</h4>
<p>加锁的核心目标是保证同一时间只有一个业务能操作共享资源，Redis 锁通过两层设计来实现这个目标：</p>
<h5 data-id="heading-8"><strong>第一层：单节点锁 — 破解“锁争抢”和“僵尸锁”</strong></h5>
<p>Redis 单节点锁的核心命令看似简单：<strong>SET lock_key unique_value NX EX 30。</strong> 但这条命令里藏着解决两大基础难题的巧思。我们逐一拆开来看：</p>
<p>先看 unique_value，它是给每个节点生成的唯一标识，就像给每个节点发了一张专属入场券。释放锁的时候，节点必须出示这张入场券，只有校验通过，才能删除自己持有的锁，绝不会误删别人的锁。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b0018c43c024f3595f7ec732de17771~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=O%2Bcaajp%2F13TRZMBnZEtsjvXsoEw%3D" alt="图片" loading="lazy"/></p>
<p>再看 NX（Not eXists），它的意思是仅当锁对应的 lock_key 不存在时，才执行加锁操作。这就像只有空座位才能入座，直接保证了锁的互斥性 — 同一时间，只有一个节点能成功获取锁，从根源上解决了大家抢着用资源的锁争抢问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54d07138cc8046a598c898f5beeca4e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=6oxfNv979x7RYsdSnLP6FUI9RKU%3D" alt="图片" loading="lazy"/></p>
<p>然后是 EX 30，它的作用是给锁设置 30 秒的过期时间。好比座位有最长占用时限，超时后自动 “让座”，不会一直占着资源不释放，从根本上避免了节点宕机等异常情况导致的“僵尸锁”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a81e6d6157144c0ad94699dd91848c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=0hy2mcGzgZQclmTQO2VDukvo55Q%3D" alt="图片" loading="lazy"/></p>
<p>而这条 SET 命令的关键，就是把抢锁（NX）和设过期时间（EX），变成了一步完成的原子操作，中间没有任何可中断的间隙：</p>
<p><strong>要么</strong> ***** *指令未执行，<strong><strong>锁没抢到；要么</strong></strong>指令完整执行，**<strong>抢到的锁已经自带过期时间。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/880940ce307d40649577b26c3bfb5814~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=o6NToasotnpO3wd8%2FALtdWoXzt8%3D" alt="图片" loading="lazy"/></p>
<p>这就从机制上杜绝了因分步执行而引发的各类异常。</p>
<p>不过单节点 Redis 锁虽然简单高效，但存在一个致命弱点：<strong>如果 Redis 节点宕机，整个锁机制就会失效。</strong> 因此，为了提升锁机制的高可用性，需要一种能突破单节点依赖的解决方案 — 高可用锁。</p>
<h5 data-id="heading-9"><strong>第二层：高可用锁 —</strong> <strong>解决单点依赖</strong></h5>
<p>为了破解单节点锁的可用性瓶颈，Redis 的作者 Antirez 提出了 Redlock 算法。其核心思想是：</p>
<p><strong>给 Redis 锁部署至少 3 个独立的节点（实际常用 5 个），只有超过半数节点都成功给资源加锁时，资源才算真的拿到了有效锁。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a67b3c92f6c84806871d5cdbf1fcf634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=etw89iF1%2Fa6fPsHTJijAolA9mxI%3D" alt="图片" loading="lazy"/></p>
<p>Redlock 算法的执行步骤如下：</p>
<ol>
<li>向 N 个独立的 Redis 锁节点依次发送 <code>SET NX EX</code> 加锁请求，实际应用中通常会部署 5 个；</li>
<li>统计成功给资源加锁的节点数量，若成功数量超过 N/2，比如部署 5 个节点时至少有 3 个成功，就判定加锁成功；</li>
<li>如果成功数量少于半数，则说明加锁失败，立即向所有锁节点释放锁，避免产生"僵尸锁"。</li>
</ol>
<p>这种设计的精妙之处在于，即便部分锁节点宕机（不超过半数），剩余的多数锁节点仍能正常提供锁服务，从根本上规避了单点故障风险。这就像开会投票，只要超过半数人同意，决议就能生效，少数人的缺席不会影响整体决策。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca4d0368df6c4b3ebfbd445374503ddc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=19gaFmSh5MFPzQpEeL74PaR8dIo%3D" alt="图片" loading="lazy"/></p>
<p>通过 Redlock 算法的加锁机制，我们确保了分布式环境下资源的互斥访问，但锁的释放环节同样需要谨慎处理，毕竟一旦释放逻辑出现疏漏，就可能引发新的并发混乱。</p>
<h4 data-id="heading-10">2、释放锁机制：先 “验身份” 再删锁</h4>
<p>先前加锁时，我们会针对要保护的共享资源，在锁节点存入一把 “带身份标识的锁” — unique_value，就像给这把锁刻上了自己的 “专属名字”。等业务要释放共享资源时，不能直接删锁，得先去锁节点验证：</p>
<p><strong>“这把锁是不是我的？”</strong></p>
<p>确认无误后，才能删除锁，也就是真正释放锁。</p>
<p>但这里有个关键问题：如果 “先查身份、再删锁” 分成两步做，中间就会有个 “时间差漏洞”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/031f1a150fd4452e9ea0d143b150cbf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=IugstHWOFWzGyv%2Frou1SWvACTI8%3D" alt="图片" loading="lazy"/></p>
<p>比如你刚查完，确认这把锁是自己的，可还没来得及删，这把锁的过期时间就到了，系统自动把它释放了；而就在这一瞬间，其他业务刚好抢到了这把锁。等你反应过来执行删除操作时，删的已经不是自己的锁，而是别人刚抢到的新锁了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6970c2962a64fcd89d2e2c873f029ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=eIbcaMcCNl4XSoluMePOZ%2FvLCJM%3D" alt="图片" loading="lazy"/></p>
<p>这一下就出大问题了：<strong>不仅误删了别人的锁，还让共享资源失去了保护</strong> — 没有锁的约束，其他业务可能会一窝蜂地操作这个资源，最后很可能导致数据错乱。</p>
<p>为了规避这种风险，Redis 提供了 Lua 脚本支持，能将判断和删除这两个操作封装成一个原子操作。对应的脚本如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d9f12d8ae7941e898cea83c42d60cbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=Vxw78sUJ8Z9GCFrKXRXTz9FveZU%3D" alt="图片" loading="lazy"/></p>
<p>这段脚本相当于让 「验锁 + 删锁」 一步到位，安全可靠！</p>
<p>最终，从单节点锁到 Redlock 算法，从加锁到释放锁，Redis 为我们构建了完整的分布式锁理论基础。接下来，我们将这些理论转化为实践，看看如何在项目中正确落地。</p>
<h3 data-id="heading-11">Redis 锁的落地指南</h3>
<p>分布式锁的落地从来不是一刀切的，而是要"因地制宜" — 简单场景用单节点锁高效落地，核心业务靠高可用锁保驾护航。下面我们结合不同的业务场景，拆解对应的 Redis 锁实践方案：</p>
<h4 data-id="heading-12">1、简单场景：单节点锁轻量高效</h4>
<p>如果你的业务不是支付、下单这种核心场景，那单节点 Redis 锁就完全够用了，简单还不占资源。例如我们要给 1001 号商品的库存加锁，核心命令如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89e2e6eefce44698b78b3d5c2cb3fd13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=2Zh6oFqoYGkPDhe7yGM%2FCObG4ZY%3D" alt="图片" loading="lazy"/></p>
<p>使用时需要注意三个关键细节，不然容易出问题：</p>
<p><strong>第一个细节是 unique_value 必须独一无二。</strong></p>
<p>命令里的 "node1_uuid_12345" 可不是随便填的字符串，它是每个加锁请求的专属 “身份证”，得保证全网唯一。核心目的就是让后续解锁时，能准确识别出 “这把锁是我加的”，避免误解锁别人的锁。</p>
<p><strong>第二个是过期时间 <code>EX 30 </code>的设置，得合理预留缓冲。</strong></p>
<p>比如你预估一个任务平均 10 秒能完成，那过期时间就别设 10 秒，建议设 30 秒。多出来的 20 秒是缓冲，万一某个任务因为网络延迟、数据量稍大慢了点，也不会出现 “任务还没做完，锁就过期了” 的情况。</p>
<p><strong>第三个是加锁失败后别做无效等待。</strong></p>
<p>如果执行上面的 SET 命令后，返回的是<code>nil，说明锁已经被别人占用了。这时候别一直死等，要么设置最多重试 3 次（每次间隔几百毫秒），要么直接返回 “操作失败，请稍后再试”，避免浪费服务器资源。</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef37c653312442a5863383fed6bb6a9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=LlyX4r7vOrthp16RsQPZN0LGn7E%3D" alt="图片" loading="lazy"/></p>
<p>基础版的单节点锁用起来简单又高效，但如果任务执行时间不确定，很可能出现“任务还没做完，锁就过期了”的情况。这时，“看门狗（Watch Dog）” 机制就能派上用场。</p>
<h4 data-id="heading-13">2、长任务场景：用“看门狗”给锁自动续期</h4>
<p>看门狗机制的工作原理其实很简单：</p>
<p>当业务节点成功抢到锁之后，系统会在这个节点上启动一个后台线程，就像给业务栓了一只尽职尽责的看门狗。这只 “看门狗” 会按固定时间（比如每隔 10 秒）主动检查：</p>
<p><strong>“主人，你还在使用这把锁吗？”</strong></p>
<p>如果发现业务还在正常执行，它就会立刻给锁 “续期”，比如把锁的过期时间再延长 30 秒，不让锁提前过期被别人抢走。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82d3a0ff5bde4e5aab508c2c01c284a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=NgAw0N9aZ9aNW3gtfBAnpgSVufw%3D" alt="图片" loading="lazy"/></p>
<p>目前主流的开源框架 Redisson 已经内置了这个看门狗机制，使用起来十分便捷。</p>
<p>不过要注意，不管是基础版单节点锁，还是带看门狗的锁，都只是解决了单节点场景的锁问题。如果是支付、下单这类核心业务，我们需要更高的可用性保障，这时候基于<strong>Redlock 算法</strong>的高可用部署方案就成了首选。</p>
<h4 data-id="heading-14">3、核心场景：高可用锁守住业务“生命线”</h4>
<p>针对支付、下单等核心业务场景，建议直接采用 Redlock 算法，并部署至少 3 个独立的 Redis 锁节点。具体部署建议如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dc877311f6d44baa97ba3b522ef2746~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=75GfxDjuodiDdz%2FtUrVMt00B9x0%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>节点数量选择奇数</strong>：优先选择 3、5、7 个节点，便于快速计算 “超过半数” 的成功条件，确保锁机制的有效性；</li>
<li><strong>保证节点独立性</strong>：节点之间不能有主从复制关系，最好分布在不同物理机或机房，避免因机房断电、网络故障等问题导致多个节点同时失效；</li>
<li><strong>合理设置请求超时</strong>：向每个节点发送加锁请求时，建议设置 50-100ms 的超时时间，避免单个节点响应缓慢拖垮整个加锁流程。</li>
</ul>
<p>总之，从基础单节点锁到高可用部署，Redis 提供了灵活多样的锁解决方案。但要真正用好这些方案，避免实际应用中出现隐患，还需要注意一些关键细节。</p>
<h3 data-id="heading-15">Redis 锁的隐形“陷阱”</h3>
<p>分布式锁看着简单好上手，但实际落地时，稍有疏忽整个锁机制就可能 “罢工”。今天就来聊聊几个必须盯紧的关键细节，帮你避开常见陷阱：</p>
<h4 data-id="heading-16">陷阱一：看门狗不是万能的</h4>
<p>先说说大家常依赖的看门狗机制 — 它确实能自动给锁续期，但并非绝对可靠。如果持有锁的服务器突然宕机，看门狗线程会随之终止，无法继续给锁续期，锁最终还是会因过期而释放。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eaee9ce56ac42aa9bba9f5267a3ba50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=VKvT6nN5kzSXQjSPHhSFK5Ik0S0%3D" alt="图片" loading="lazy"/></p>
<p>所以我们设计业务逻辑时，尽量要 “短平快”，能尽快释放锁就别长时间占用；同时做好异常兜底方案，避免锁过期后不同线程同时操作数据，导致数据不一致的问题。</p>
<h4 data-id="heading-17">陷阱二：Redlock 切勿滥用</h4>
<p>Redlock 算法的可靠性确实更高，但相比单节点锁，它需要访问多个节点来确认锁的状态，性能开销更大。对于非核心业务场景，「单节点锁 + 看门狗」的组合已经能满足需求，不必过度追求高可用而采用 Redlock，否则会造成性能浪费。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0281046ab830442c98263b5e33f2c912~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=AAMeh5RwF0nzjWaZFAD95TApwZ0%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-18">陷阱三：锁的粒度要把握适中</h4>
<p>最后是锁的粒度设计，这直接关系到系统的运行效率。</p>
<ul>
<li><strong>粒度太粗</strong>，比如整个系统共用一把锁，会导致所有请求排队等待，引发严重的性能瓶颈；</li>
<li><strong>粒度太细</strong>，比如为每个数据项都单独设锁，则会增加系统复杂性和运维开销，还可能出现 "锁爆炸" 问题。建议根据实际业务场景合理设计锁粒度，在并发安全和系统性能之间找到平衡点。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91f75b59743a44cd90398544f56ea366~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6XY29kaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770448078&amp;x-signature=7AW5FoM%2BD4eOMbJpPV7XQl8fDyw%3D" alt="图片" loading="lazy"/></p>
<p>掌握这些最佳实践后，我们才能真正构建出既可靠又高效的分布式锁系统。</p>
<h3 data-id="heading-19">Redis 锁 — 分布式世界的“秩序守护者”</h3>
<p>从单节点锁的「先到先得」逻辑，到 Redlock 算法的「少数服从多数」原则；从 <code>NX EX</code> 原子命令的精妙设计，到 Lua 脚本保障的安全释放，Redis 分布式锁用简洁而优雅的实现，精准解决了分布式系统的三大核心难题 — <strong>互斥性、防死锁、高可用</strong>。</p>
<p>下一次当你遇到分布式定时任务重复执行、核心数据同步错乱等并发问题时，不妨先问问自己：</p>
<p>我的系统中，分布式锁真的用对了吗？核心资源真的被有效 “锁住” 了吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 进程、网络相关命令大全]]></title>    <link>https://juejin.cn/post/7601046076943171599</link>    <guid>https://juejin.cn/post/7601046076943171599</guid>    <pubDate>2026-01-31T07:28:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601046076943171599" data-draft-id="7601000638344871951" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 进程、网络相关命令大全"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2026-01-31T07:28:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 进程、网络相关命令大全
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:28:16.000Z" title="Sat Jan 31 2026 07:28:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 进程管理核心命令</h2>
<p>进程是计算机中正在运行的程序的实例。每个进程都有自己的内存空间、寄存器和文件描述符等资源。在 Linux 中，进程可以处于运行（Running）、睡眠（Sleeping）、停止（Stopped）或僵尸（Zombie）等状态。</p>
<h3 data-id="heading-1">1.1 进程查看命令</h3>
<p><strong>ps（进程状态）</strong></p>
<p>ps 是最基础的进程查看命令，用于显示当前时刻的进程状态快照。</p>
<pre><code class="hljs language-ini" lang="ini">ps aux        <span class="hljs-comment"># 显示所有用户的所有进程（BSD风格）</span>
ps -ef        <span class="hljs-comment"># 全格式显示所有进程（System V风格）</span>
ps -ejH       <span class="hljs-comment"># 显示进程树结构</span>
ps aux <span class="hljs-attr">--sort</span>=-%mem  <span class="hljs-comment"># 按内存使用率降序排列</span>
</code></pre>
<p>常用字段说明：</p>
<ul>
<li>USER：进程所有者</li>
<li>PID：进程ID</li>
<li>%CPU：CPU使用率</li>
<li>%MEM：内存使用率</li>
<li>VSZ：虚拟内存大小</li>
<li>RSS：物理内存大小</li>
<li>STAT：进程状态（R=运行, S=睡眠, Z=僵尸）</li>
<li>COMMAND：启动命令</li>
</ul>
<p><strong>top（实时进程监控）</strong></p>
<p>top 提供动态实时视图，显示系统资源使用情况和进程列表。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">top</span>                    # 默认启动，按CPU排序
<span class="hljs-attribute">top</span> -u username        # 仅显示指定用户的进程
<span class="hljs-attribute">top</span> -<span class="hljs-selector-tag">p</span> <span class="hljs-number">1234</span>,<span class="hljs-number">5678</span>       # 监控指定PID的进程
</code></pre>
<p>交互操作（运行中按键）：</p>
<ul>
<li>P：按CPU使用率排序</li>
<li>M：按内存使用率排序</li>
<li>T：按运行时间排序</li>
<li>k：终止指定进程</li>
<li>u：按用户过滤</li>
<li>q：退出</li>
</ul>
<p><strong>htop（增强版top）</strong></p>
<p>htop 是 top 的增强版，提供更直观的界面和更多功能。</p>
<pre><code class="hljs language-bash" lang="bash">sudo apt install htop    <span class="hljs-comment"># Debian/Ubuntu安装</span>
htop -t                 <span class="hljs-comment"># 树状显示进程</span>
htop -s cpu            <span class="hljs-comment"># 按CPU使用率排序</span>
</code></pre>
<p>优势特性：</p>
<ul>
<li>彩色显示，支持鼠标操作</li>
<li>直接F9发送信号，F5进程树视图</li>
<li>显示CPU核心分布和内存条形图</li>
</ul>
<p><strong>pgrep 和 pidof（进程查找）</strong></p>
<pre><code class="hljs language-bash" lang="bash">pgrep firefox                 <span class="hljs-comment"># 查找firefox进程PID</span>
pgrep -u root -f <span class="hljs-string">"nginx"</span>     <span class="hljs-comment"># 查找root用户的nginx进程</span>
pidof bash                   <span class="hljs-comment"># 查找bash进程PID</span>
</code></pre>
<h3 data-id="heading-2">1.2 进程控制命令</h3>
<p><strong>kill 和 killall（进程终止）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">kill</span> 1234              <span class="hljs-comment"># 默认发送SIGTERM(15)，正常终止</span>
<span class="hljs-built_in">kill</span> -9 1234           <span class="hljs-comment"># 发送SIGKILL(9)，强制终止</span>
<span class="hljs-built_in">kill</span> -TERM $(pgrep nginx)  <span class="hljs-comment"># 优雅终止所有nginx进程</span>
killall firefox        <span class="hljs-comment"># 终止所有firefox进程</span>
pkill -f <span class="hljs-string">"python script.py"</span>  <span class="hljs-comment"># 终止匹配模式的进程</span>
</code></pre>
<p>常用信号说明：</p>
<ul>
<li>SIGTERM(15)：请求正常终止（默认）</li>
<li>SIGKILL(9)：强制立即终止，无法阻塞</li>
<li>SIGINT(2)：中断进程（相当于Ctrl+C）</li>
<li>SIGSTOP(19)：暂停进程</li>
<li>SIGCONT(18)：恢复暂停的进程</li>
</ul>
<p><strong>nice 和 renice（优先级调整）</strong></p>
<p>Linux进程优先级范围-20（最高）到19（最低）。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">nice</span> -n 10 <span class="hljs-built_in">command</span>     <span class="hljs-comment"># 以优先级10启动进程</span>
renice 15 -p 1234      <span class="hljs-comment"># 修改已运行进程的优先级</span>
renice -u username -5  <span class="hljs-comment"># 修改用户所有进程的优先级</span>
</code></pre>
<h3 data-id="heading-3">1.3 前后台作业管理</h3>
<p><strong>jobs、fg、bg（作业控制）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">sleep</span> 100 &amp;            <span class="hljs-comment"># 后台运行</span>
<span class="hljs-built_in">jobs</span> -l               <span class="hljs-comment"># 查看后台任务列表及PID</span>
<span class="hljs-built_in">fg</span> %1                 <span class="hljs-comment"># 将作业1调至前台</span>
<span class="hljs-built_in">bg</span> %2                 <span class="hljs-comment"># 让暂停的作业2在后台继续</span>
</code></pre>
<p><strong>nohup 和 disown（终端退出保活）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">nohup</span> python script.py &gt; output.log 2&gt;&amp;1 &amp;  <span class="hljs-comment"># 终端退出后继续运行</span>
python script.py &amp;      <span class="hljs-comment"># 先后台启动</span>
<span class="hljs-built_in">disown</span> %1              <span class="hljs-comment"># 从作业列表移除，终端关闭不影响</span>
</code></pre>
<h2 data-id="heading-4">2 网络管理核心命令</h2>
<h3 data-id="heading-5">2.1 网络配置命令</h3>
<p><strong>ip（现代网络配置）</strong></p>
<p>ip 命令已逐渐取代 ifconfig，是更强大的网络配置工具。</p>
<pre><code class="hljs language-bash" lang="bash">ip addr show           <span class="hljs-comment"># 显示所有网络接口信息</span>
ip -4 addr             <span class="hljs-comment"># 仅显示IPv4信息</span>
ip route show         <span class="hljs-comment"># 显示路由表</span>
ip neighbor show      <span class="hljs-comment"># 显示ARP表（邻接表）</span>
</code></pre>
<p><strong>nmcli（NetworkManager控制）</strong></p>
<pre><code class="hljs language-bash" lang="bash">nmcli connection show           <span class="hljs-comment"># 显示网络连接</span>
nmcli device status            <span class="hljs-comment"># 显示设备状态</span>
nmcli connection add <span class="hljs-built_in">type</span> wifi ifname wlan0 ssid <span class="hljs-string">"MyWifi"</span> password <span class="hljs-string">"password"</span>  <span class="hljs-comment"># 添加WiFi连接</span>
</code></pre>
<h3 data-id="heading-6">2.2 网络诊断命令</h3>
<p><strong>ping 和 traceroute（连通性测试）</strong></p>
<pre><code class="hljs language-r" lang="r">ping <span class="hljs-operator">-</span><span class="hljs-built_in">c</span> <span class="hljs-number">4</span> baidu.com           <span class="hljs-comment"># 发送4个测试包</span>
ping6 target.ipv6.com         <span class="hljs-comment"># IPv6测试</span>
traceroute <span class="hljs-operator">-</span>n baidu.com       <span class="hljs-comment"># 追踪路径，以IP显示节点</span>
mtr baidu.com                <span class="hljs-comment"># 更强大的路径追踪工具</span>
</code></pre>
<p><strong>ss 和 netstat（连接统计）</strong></p>
<p>ss 是 netstat 的现代替代品，速度更快。</p>
<pre><code class="hljs language-perl" lang="perl">ss -tuln                      <span class="hljs-comment"># 查看所有监听端口</span>
ss -t -a                      <span class="hljs-comment"># 所有TCP连接</span>
netstat -anp | <span class="hljs-keyword">grep</span> :<span class="hljs-number">80</span>       <span class="hljs-comment"># 传统方式查看80端口进程</span>
netstat -s                    <span class="hljs-comment"># 显示协议统计信息</span>
</code></pre>
<p>输出字段说明：</p>
<ul>
<li>State：连接状态（ESTABLISHED, LISTEN等）</li>
<li>Recv-Q/Send-Q：接收/发送队列大小</li>
<li>Local Address:Port：本地地址端口</li>
<li>Peer Address:Port：对端地址端口</li>
<li>PID/Program name：进程信息</li>
</ul>
<h3 data-id="heading-7">2.3 网络服务与安全</h3>
<p><strong>iptables（防火墙规则）</strong></p>
<pre><code class="hljs language-css" lang="css">iptables -L                    # 列出当前规则
iptables -<span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">INPUT</span> -<span class="hljs-selector-tag">p</span> tcp <span class="hljs-attr">--dport</span> <span class="hljs-number">22</span> -j ACCEPT  # 允许SSH连接
iptables -<span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">INPUT</span> -<span class="hljs-selector-tag">i</span> lo -j ACCEPT              # 允许环回接口
</code></pre>
<p><strong>tcpdump 和 wireshark（流量分析）</strong></p>
<pre><code class="hljs language-bash" lang="bash">tcpdump -i eth0 port 80        <span class="hljs-comment"># 捕获80端口流量</span>
tcpdump -w capture.pcap -i eth0 <span class="hljs-comment"># 保存到文件</span>
tshark -i eth0 -f <span class="hljs-string">"port 53"</span>    <span class="hljs-comment"># wireshark命令行版，捕获DNS查询</span>
</code></pre>
<p><strong>curl 和 wget（网络请求）</strong></p>
<pre><code class="hljs language-bash" lang="bash">curl -I http://example.com     <span class="hljs-comment"># 仅获取HTTP头</span>
curl -O http://example.com/file.zip  <span class="hljs-comment"># 下载文件</span>
wget -c http://example.com/largefile.iso  <span class="hljs-comment"># 断点续传</span>
wget -r -l1 http://example.com  <span class="hljs-comment"># 递归下载一级目录</span>
</code></pre>
<h2 data-id="heading-8">3 实用场景与技巧</h2>
<h3 data-id="heading-9">3.1 服务故障排查流程</h3>
<ol>
<li>
<p><strong>检查服务进程状态</strong></p>
<pre><code class="hljs language-perl" lang="perl">ps aux | <span class="hljs-keyword">grep</span> nginx         <span class="hljs-comment"># 查找nginx进程</span>
systemctl status nginx      <span class="hljs-comment"># 检查服务状态</span>
</code></pre>
</li>
<li>
<p><strong>验证端口监听</strong></p>
<pre><code class="hljs language-perl" lang="perl">ss -tuln | <span class="hljs-keyword">grep</span> :<span class="hljs-number">80</span>         <span class="hljs-comment"># 检查80端口监听</span>
netstat -anp | <span class="hljs-keyword">grep</span> :<span class="hljs-number">80</span>     <span class="hljs-comment"># 传统方式检查</span>
</code></pre>
</li>
<li>
<p><strong>测试网络连通性</strong></p>
<pre><code class="hljs language-r" lang="r">ping <span class="hljs-operator">-</span><span class="hljs-built_in">c</span> <span class="hljs-number">3</span> target_server     <span class="hljs-comment"># 基础连通性</span>
traceroute target_server    <span class="hljs-comment"># 路径分析</span>
telnet target_server <span class="hljs-number">80</span>     <span class="hljs-comment"># 端口连通性</span>
</code></pre>
</li>
<li>
<p><strong>检查DNS解析</strong></p>
<pre><code class="hljs language-bash" lang="bash">nslookup example.com        <span class="hljs-comment"># DNS解析检查</span>
dig A example.com          <span class="hljs-comment"># 更详细的DNS信息</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-10">3.2 资源监控与优化</h3>
<p><strong>找出资源占用最高的进程</strong></p>
<pre><code class="hljs language-perl" lang="perl">top -o %CPU                    <span class="hljs-comment"># 按CPU使用率排序</span>
ps aux --<span class="hljs-keyword">sort</span>=-%mem | head -<span class="hljs-number">10</span> <span class="hljs-comment"># 内存使用前10的进程</span>
iotop                         <span class="hljs-comment"># 磁盘I/O监控（需安装）</span>
</code></pre>
<p><strong>自动化监控脚本</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># 进程监控脚本</span>
PROCESS_NAME=<span class="hljs-string">"nginx"</span>
INTERVAL=60

<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> ! pgrep -x <span class="hljs-string">"<span class="hljs-variable">$PROCESS_NAME</span>"</span> &gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-subst">$(date)</span>: 进程 <span class="hljs-variable">$PROCESS_NAME</span> 已停止，尝试重启"</span>
        systemctl restart <span class="hljs-variable">$PROCESS_NAME</span>
    <span class="hljs-keyword">fi</span>
    <span class="hljs-built_in">sleep</span> <span class="hljs-variable">$INTERVAL</span>
<span class="hljs-keyword">done</span>
</code></pre>
<h3 data-id="heading-11">3.3 安全最佳实践</h3>
<ol>
<li>
<p><strong>定期检查异常连接</strong></p>
<pre><code class="hljs language-perl" lang="perl">ss -tuln | <span class="hljs-keyword">grep</span> LISTEN      <span class="hljs-comment"># 检查监听端口</span>
lsof -i -P | <span class="hljs-keyword">grep</span> ESTABLISHED <span class="hljs-comment"># 查看所有活跃连接</span>
</code></pre>
</li>
<li>
<p><strong>监控系统负载</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">uptime</span>                      <span class="hljs-comment"># 查看负载平均值</span>
<span class="hljs-built_in">cat</span> /proc/loadavg           <span class="hljs-comment"># 系统负载详情</span>
</code></pre>
</li>
<li>
<p><strong>限制进程资源</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">ulimit</span> -a                   <span class="hljs-comment"># 显示当前限制</span>
<span class="hljs-built_in">ulimit</span> -n 2048             <span class="hljs-comment"># 设置最大文件描述符数</span>
</code></pre>
</li>
</ol>
<h2 data-id="heading-12">4 总结</h2>
<p>Linux 进程和网络管理命令是系统管理员和开发人员必须掌握的核心技能。本文介绍的命令覆盖了日常管理和故障排查的绝大多数场景。实际使用中，建议结合具体需求灵活组合这些命令，并养成查看手册（man command）的习惯以获得更深入的理解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[man command详解与应用实战]]></title>    <link>https://juejin.cn/post/7601000638344937487</link>    <guid>https://juejin.cn/post/7601000638344937487</guid>    <pubDate>2026-01-31T07:39:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601000638344937487" data-draft-id="7601000638344921103" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="man command详解与应用实战"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2026-01-31T07:39:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            man command详解与应用实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T07:39:41.000Z" title="Sat Jan 31 2026 07:39:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>man</code>命令是 Linux 系统中不可或缺的<strong>官方手册查看工具</strong>，它能提供关于命令、系统调用、库函数、配置文件等的详尽说明。下面这张表总结了其核心用法，方便你快速查阅。</p>
<h3 data-id="heading-0">🔍 核心语法与选项</h3>








































<table><thead><tr><th>用途</th><th>命令示例</th><th>说明</th></tr></thead><tbody><tr><td><strong>查看命令手册</strong></td><td><code>man ls</code></td><td>查看 <code>ls</code>命令的详细手册。</td></tr><tr><td><strong>指定章节</strong></td><td><code>man 2 open</code></td><td>查看第2章节（系统调用）关于 <code>open</code>的说明。</td></tr><tr><td><strong>关键字搜索</strong></td><td><code>man -k network</code></td><td>在所有手册页中搜索包含 "network" 的条目。</td></tr><tr><td><strong>显示简要描述</strong></td><td><code>man -f passwd</code></td><td>显示名为 <code>passwd</code>的所有手册条目的简短描述。</td></tr><tr><td><strong>显示所有匹配</strong></td><td><code>man -a passwd</code></td><td>依次显示所有章节中名为 <code>passwd</code>的手册页。</td></tr><tr><td><strong>显示手册路径</strong></td><td><code>man -w ls</code></td><td>显示 <code>ls</code>命令手册页的磁盘存储路径。</td></tr></tbody></table>
<h3 data-id="heading-1">📚 理解手册章节</h3>
<p>Linux 的手册页（man pages）按照主题分为多个章节，这是高效使用 <code>man</code>命令的关键。当你使用 <code>man passwd</code>时，默认会显示排在首位的章节（通常是第1章）的内容。但如果想查看 <code>/etc/passwd</code>文件格式的说明，就需要指定第5章节：<code>man 5 passwd</code>。</p>
<p>以下是常见的章节划分：</p>








































<table><thead><tr><th>章节编号</th><th>内容类型</th><th>示例</th></tr></thead><tbody><tr><td><strong>1</strong></td><td>用户命令（普通用户可执行的命令）</td><td><code>ls</code>, <code>cp</code>, <code>mkdir</code></td></tr><tr><td><strong>2</strong></td><td>系统调用（由内核提供的函数）</td><td><code>open</code>, <code>fork</code>, <code>read</code></td></tr><tr><td><strong>3</strong></td><td>库函数（标准库中的函数）</td><td><code>printf</code>, <code>malloc</code>, <code>fopen</code></td></tr><tr><td><strong>4</strong></td><td>特殊文件（通常指 <code>/dev</code>下的设备文件）</td><td><code>null</code>, <code>zero</code>, <code>tty</code></td></tr><tr><td><strong>5</strong></td><td>文件格式和约定（配置文件格式）</td><td><code>passwd</code>, <code>fstab</code>, <code>hosts</code></td></tr><tr><td><strong>8</strong></td><td>系统管理命令（通常需要 root 权限）</td><td><code>systemctl</code>, <code>fdisk</code>, <code>iptables</code></td></tr></tbody></table>
<h3 data-id="heading-2">🔧 实用操作技巧</h3>
<p>进入手册页后，你可以使用以下快捷键进行导航和搜索，这能极大提升查阅效率：</p>













































<table><thead><tr><th>操作</th><th>快捷键</th><th>说明</th></tr></thead><tbody><tr><td><strong>向下翻页</strong></td><td><code>空格键</code>或 <code>Page Down</code></td><td>查看下一屏内容。</td></tr><tr><td><strong>向上翻页</strong></td><td><code>b</code>或 <code>Page Up</code></td><td>查看上一屏内容。</td></tr><tr><td><strong>退出</strong></td><td><code>q</code></td><td>退出手册页，回到命令行。</td></tr><tr><td><strong>向下搜索</strong></td><td><code>/关键词</code></td><td>从当前位置向下搜索特定关键词，如 <code>/option</code>。</td></tr><tr><td><strong>向上搜索</strong></td><td><code>?关键词</code></td><td>从当前位置向上搜索。</td></tr><tr><td><strong>下一个匹配</strong></td><td><code>n</code></td><td>跳转到下一个搜索结果。</td></tr><tr><td><strong>上一个匹配</strong></td><td><code>N</code></td><td>跳转到上一个搜索结果。</td></tr></tbody></table>
<h3 data-id="heading-3">🚀 高级应用与实战</h3>
<h4 data-id="heading-4">1. 获取中文手册</h4>
<p>如果你的系统环境是中文，或者希望阅读中文手册，可以安装中文手册包。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 在 Debian/Ubuntu 系统上安装中文手册页</span>
sudo apt-<span class="hljs-keyword">get</span> install manpages-zh
</code></pre>
<p>安装后，你可以通过设置语言环境来查看中文手册，例如 <code>LANG=zh_CN.UTF-8 man ls</code>。需要注意的是，中文翻译可能滞后于英文原版。</p>
<h4 data-id="heading-5">2. 更新手册数据库</h4>
<p>当系统安装新软件后，其手册页信息需要更新到 <code>man</code>的数据库中，<code>-k</code>和 <code>-f</code>选项才能正常识别。可以使用以下命令更新：</p>
<pre><code class="hljs">sudo mandb
</code></pre>
<h4 data-id="heading-6">3. 导出手册内容</h4>
<p>有时你可能希望将手册页的内容保存到文件中以便离线阅读或打印。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将 ls 命令的手册页导出为纯文本文件</span>
man <span class="hljs-built_in">ls</span> &gt; ls_manual.txt

<span class="hljs-comment"># 如果需要格式更好的版本，可以先转换为 PostScript 再转为 PDF</span>
man -t <span class="hljs-built_in">ls</span> &gt; ls.ps
ps2pdf ls.ps ls.pdf
</code></pre>
<h3 data-id="heading-7">💡 实战场景举例</h3>
<ul>
<li>
<p><strong>场景1：快速了解未知命令</strong></p>
<p>当你第一次遇到 <code>chmod</code>命令时，直接输入 <code>man chmod</code>。重点阅读 <strong>SYNOPSIS</strong>（语法）和 <strong>DESCRIPTION</strong>（描述）部分，了解其基本用法和参数含义。</p>
</li>
<li>
<p><strong>场景2：查询函数用法</strong></p>
<p>在编写C程序时，需要了解 <code>printf</code>函数的详细用法和头文件，应使用 <code>man 3 printf</code>查看库函数章节的说明。</p>
</li>
<li>
<p><strong>场景3：排查网络问题</strong></p>
<p>如果想查看服务器上哪些端口正在监听，可以使用 <code>man netstat</code>查询 <code>-tuln</code>选项的具体含义，确保命令使用正确。</p>
</li>
<li>
<p><strong>场景4：理解配置文件</strong></p>
<p>当需要修改 <code>/etc/ssh/sshd_config</code>文件时，使用 <code>man 5 sshd_config</code>可以查看该配置文件中每个选项的详细解释。</p>
</li>
</ul>
<h3 data-id="heading-8">⚠️ 注意事项</h3>
<ul>
<li><strong>手册页可能缺失</strong>：某些精简版系统或第三方软件可能没有安装完整的手册页。如果 <code>man</code>命令提示找不到条目，可以尝试使用软件包管理器安装 <code>man-pages</code>或类似软件包。</li>
<li><strong>信息可能过时</strong>：手册页是随软件包一起发布的，有时可能无法完全跟上某个命令最新版本的所有变化。此时，结合命令的 <code>--help</code>选项或查阅官方在线文档是很好的补充。</li>
<li><strong>善用 SEE ALSO</strong>：手册页末尾的 <strong>SEE ALSO</strong>（参见）部分非常有用，它会指引你查看相关的命令或文件，帮助你构建更完整的知识网络。</li>
</ul>
<p><code>man</code>命令是探索和理解 Linux 世界的可靠地图。熟练掌握它，你将能更自信、独立地解决遇到的各种问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据“显微镜”：蜂群图让每个数据点都发声]]></title>    <link>https://juejin.cn/post/7601018079620530191</link>    <guid>https://juejin.cn/post/7601018079620530191</guid>    <pubDate>2026-01-31T06:21:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601018079620530191" data-draft-id="7601049142865477632" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据“显微镜”：蜂群图让每个数据点都发声"/> <meta itemprop="keywords" content="Python,数据可视化,数据分析"/> <meta itemprop="datePublished" content="2026-01-31T06:21:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据“显微镜”：蜂群图让每个数据点都发声
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T06:21:08.000Z" title="Sat Jan 31 2026 06:21:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>想象一下夏日的花丛中，成群的蜜蜂围绕着花朵忙碌地飞舞。每只蜜蜂都是一个独立的数据点，它们既保持群体聚集的形态，又不会完全重叠在一起。</p>
<p>这就是<strong>蜂群图</strong>（<code>Swarm Plot</code>）的<strong>核心理念</strong>——在有限的空间内展示所有数据点，让每个点都能被清晰看见。</p>
<p><strong>蜂群图</strong>是一种特殊的数据可视化图表，它将分类数据与数值数据结合起来，展示数据的分布情况。</p>
<p>与传统的条形图或箱线图不同，蜂群图不进行任何数据聚合，而是展示每一个原始数据点，避免了信息丢失。</p>
<h2 data-id="heading-0">1. 蜂群图核心特点</h2>
<p><strong>蜂群图</strong>最巧妙的地方在于它的布局算法。</p>
<p>当多个数据点具有相似数值时，它们不会简单地重叠在一起，而是像有“排斥力”一样，在垂直方向（或水平方向）上轻微偏移，形成一个类似蜂群的分布。</p>
<p>比如，下面是<strong>同一组数据</strong>在<strong>散点图</strong>和<strong>蜂群图</strong>中展示的效果。</p>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4caf03d4b0d24f74842c22c27c2a702e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770445271&amp;x-signature=0MjPiDO20sLmLVRzrLMrrIF6Wwk%3D" alt="" loading="lazy"/></p>
<p>从中可以看出蜂群图的核心特点有：</p>
<ol>
<li><strong>绝不重叠</strong>： 它通过算法检测数据点的重叠情况，一旦发现两个点数值相近，就会自动把它们向水平方向推开。</li>
<li><strong>保留分布形态</strong>： 散开后的形状，天然形成了一种类似“小提琴”或“山峰”的轮廓，直观地展示了数据的密度。</li>
<li><strong>参数调整</strong>： 我们可以调整点的大小（marker size）和排列的紧密程度。点越大，视觉冲击力越强，但需要的水平空间也越多。</li>
</ol>
<h2 data-id="heading-1">2. 蜂群图 vs. 条形图：从摘要到细节</h2>
<p><strong>条形图</strong>就像是一份数据摘要报告，它告诉我们每个类别的平均值或总计值，但隐藏了数据内部的分布细节。</p>
<p>而<strong>蜂群图</strong>则像是一次数据点的全员大会，每个数据点都有发言的机会。</p>
<p>下面针对同一组数据，我们分别绘制了<strong>条形图</strong>、<strong>箱线图</strong>和<strong>蜂群图</strong>，一起来感受一下它们之间不同的展示效果。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 生成示例数据</span>
np.random.seed(<span class="hljs-number">123</span>)
categories = [<span class="hljs-string">"产品A"</span>, <span class="hljs-string">"产品B"</span>, <span class="hljs-string">"产品C"</span>, <span class="hljs-string">"产品D"</span>]
data_comparison = []
<span class="hljs-keyword">for</span> category <span class="hljs-keyword">in</span> categories:
    n_points = <span class="hljs-number">40</span>
    <span class="hljs-keyword">if</span> category == <span class="hljs-string">"产品A"</span>:
        values = np.random.normal(<span class="hljs-number">75</span>, <span class="hljs-number">8</span>, n_points)
    <span class="hljs-keyword">elif</span> category == <span class="hljs-string">"产品B"</span>:
        values = np.random.normal(<span class="hljs-number">82</span>, <span class="hljs-number">12</span>, n_points)
    <span class="hljs-keyword">elif</span> category == <span class="hljs-string">"产品C"</span>:
        values = np.random.normal(<span class="hljs-number">65</span>, <span class="hljs-number">5</span>, n_points)
    <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># 产品D</span>
        <span class="hljs-comment"># 创建一个双峰分布</span>
        values1 = np.random.normal(<span class="hljs-number">55</span>, <span class="hljs-number">6</span>, n_points // <span class="hljs-number">2</span>)
        values2 = np.random.normal(<span class="hljs-number">85</span>, <span class="hljs-number">7</span>, n_points // <span class="hljs-number">2</span>)
        values = np.concatenate([values1, values2])

    <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> values:
        data_comparison.append({<span class="hljs-string">"产品"</span>: category, <span class="hljs-string">"用户评分"</span>: value})

<span class="hljs-comment"># 1. 条形图（平均值）</span>
means = []
<span class="hljs-keyword">for</span> category <span class="hljs-keyword">in</span> categories:
    cat_data = [d[<span class="hljs-string">"用户评分"</span>] <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> data_comparison <span class="hljs-keyword">if</span> d[<span class="hljs-string">"产品"</span>] == category]
    means.append(np.mean(cat_data))

bars = axes[<span class="hljs-number">0</span>].bar(
    categories, means, color=[<span class="hljs-string">"#1f77b4"</span>, <span class="hljs-string">"#ff7f0e"</span>, <span class="hljs-string">"#2ca02c"</span>, <span class="hljs-string">"#d62728"</span>]
)


<span class="hljs-comment"># 在条形上标注平均值</span>
<span class="hljs-comment"># 省略...</span>

<span class="hljs-comment"># 2. 箱线图</span>
box_data = []
<span class="hljs-keyword">for</span> category <span class="hljs-keyword">in</span> categories:
    cat_data = [d[<span class="hljs-string">"用户评分"</span>] <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> data_comparison <span class="hljs-keyword">if</span> d[<span class="hljs-string">"产品"</span>] == category]
    box_data.append(cat_data)

boxplot = axes[<span class="hljs-number">1</span>].boxplot(
    box_data, tick_labels=categories, patch_artist=<span class="hljs-literal">True</span>, boxprops=<span class="hljs-built_in">dict</span>(facecolor=<span class="hljs-string">"lightblue"</span>)
)
<span class="hljs-comment"># 省略...</span>

<span class="hljs-comment"># 3. 蜂群图</span>
data_df = pd.DataFrame(data_comparison)
sns.swarmplot(
    x=<span class="hljs-string">"产品"</span>,
    y=<span class="hljs-string">"用户评分"</span>,
    hue=<span class="hljs-string">"产品"</span>,
    data=data_df,
    ax=axes[<span class="hljs-number">2</span>],
    size=<span class="hljs-number">5</span>,
    palette=<span class="hljs-string">"Set2"</span>,
    edgecolor=<span class="hljs-string">"black"</span>,
    linewidth=<span class="hljs-number">0.5</span>,
)
<span class="hljs-comment"># 省略...</span>

plt.tight_layout()
plt.show()

</code></pre>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f95d09191b174b04afe13368017263c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770445271&amp;x-signature=SWcMKvD0V3DjIb2CgnNpxYsZJRc%3D" alt="" loading="lazy"/></p>
<p>绘制蜂群图可以用<code>seaborn</code>这个库中的<code>swarmplot</code>函数。</p>
<p>从上面的对比可以看出：</p>
<ul>
<li><strong>条形图</strong>告诉我们产品D的平均分约为70分</li>
<li><strong>箱线图</strong>提示产品D的数据分布范围很广</li>
<li>但只有<strong>蜂群图</strong>清晰地揭示了产品D实际上有两个明显的用户群体：一个低评分群体和一个高评分群体</li>
</ul>
<h2 data-id="heading-2">3. 蜂群图 vs. 散点图：从混乱到有序</h2>
<p>传统<strong>散点图</strong>在处理分类数据时，常常导致数据点大量重叠，形成"黑团"，我们无法看清数据点的真实分布。</p>
<p><strong>蜂群图</strong>通过智能布局算法解决了这个问题。</p>
<p>下面构造一个不同密度的数据，看看蜂群图和散点图的展示效果。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 比较散点图与蜂群图的视觉效果</span>
fig, axes = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">6</span>))

<span class="hljs-comment"># 生成具有不同密度的数据</span>
np.random.seed(<span class="hljs-number">42</span>)
density_data = []
categories = [<span class="hljs-string">"低密度"</span>, <span class="hljs-string">"中等密度"</span>, <span class="hljs-string">"高密度"</span>]
<span class="hljs-keyword">for</span> i, category <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(categories):
    n_points = <span class="hljs-number">20</span> + i * <span class="hljs-number">30</span>  <span class="hljs-comment"># 不同密度</span>
    <span class="hljs-keyword">if</span> category == <span class="hljs-string">"低密度"</span>:
        values = np.random.normal(<span class="hljs-number">50</span>, <span class="hljs-number">15</span>, n_points)
    <span class="hljs-keyword">elif</span> category == <span class="hljs-string">"中等密度"</span>:
        values = np.random.normal(<span class="hljs-number">50</span>, <span class="hljs-number">8</span>, n_points)
    <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># 高密度</span>
        values = np.random.normal(<span class="hljs-number">50</span>, <span class="hljs-number">4</span>, n_points)

    <span class="hljs-keyword">for</span> value <span class="hljs-keyword">in</span> values:
        density_data.append({<span class="hljs-string">"类别"</span>: category, <span class="hljs-string">"数值"</span>: value})

<span class="hljs-comment"># 左侧：传统散点图</span>
<span class="hljs-keyword">for</span> i, category <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(categories):
    cat_data = [d[<span class="hljs-string">"数值"</span>] <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> density_data <span class="hljs-keyword">if</span> d[<span class="hljs-string">"类别"</span>] == category]
    x_positions = np.full(<span class="hljs-built_in">len</span>(cat_data), i)
    axes[<span class="hljs-number">0</span>].scatter(x_positions, cat_data, alpha=<span class="hljs-number">0.6</span>, s=<span class="hljs-number">60</span>, label=category)

<span class="hljs-comment">#省略...</span>

<span class="hljs-comment"># 右侧：蜂群图</span>
density_data_df = pd.DataFrame(density_data)
sns.swarmplot(
    x=<span class="hljs-string">"类别"</span>,
    y=<span class="hljs-string">"数值"</span>,
    hue=<span class="hljs-string">"类别"</span>,
    data=density_data_df,
    ax=axes[<span class="hljs-number">1</span>],
    size=<span class="hljs-number">6</span>,
    palette=<span class="hljs-string">"coolwarm"</span>,
    edgecolor=<span class="hljs-string">"black"</span>,
    linewidth=<span class="hljs-number">0.5</span>,
)
<span class="hljs-comment">#省略...</span>

plt.tight_layout()
plt.show()
</code></pre>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e57e532d22f4ad4a068c2c244080e88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770445271&amp;x-signature=5%2BeEHyWRB4VpR%2BOvr3UTi4Y%2BqGw%3D" alt="" loading="lazy"/></p>
<p><strong>蜂群图</strong>解决了 <strong>“重叠（Overplotting）”</strong> 的问题。在数据量适中（几百到几千个点）时，它是展示分布密度的最佳选择。</p>
<h2 data-id="heading-3">4. 蜂群图的适用场景</h2>
<p><strong>蜂群图</strong>并不是为了取代<strong>条形图</strong>或<strong>散点图</strong>，它有自己的适用场景和局限性。</p>
<p>适合使用<strong>蜂群图</strong>的场景：</p>
<ul>
<li>样本量适中（通常少于几百个点）时，展示完整数据分布</li>
<li>需要同时看到整体趋势和个体数据点</li>
<li>数据有多个分类变量，需要比较不同类别分布</li>
<li>希望发现异常值或特殊模式（如双峰分布）</li>
</ul>
<p/>
<p><strong>蜂群图</strong>的<strong>局限性</strong>主要有：</p>
<ol>
<li>大数据集可能导致图表过于拥挤</li>
<li>对于非常大规模数据，箱线图或小提琴图可能更合适</li>
<li>精确的数值比较不如条形图直观</li>
</ol>
<h2 data-id="heading-4">5. 总结</h2>
<p><strong>蜂群图</strong>就像数据可视化领域的"显微镜"，它让我们既能观察到数据的整体分布形态，又能看到每一个数据点的具体位置。</p>
<p>与只能显示摘要信息的<strong>条形图</strong>和容易产生重叠的<strong>散点图</strong>相比，<strong>蜂群图</strong>在显示中小型数据集的完整分布信息方面具有独特优势。</p>
<p>在数据可视化实践中，选择正确的图表类型就像选择正确的工具一样重要。</p>
<p>当下一次你需要展示分类数据的分布时，不妨尝试一下蜂群图，它可能会揭示出你从未注意到的数据秘密。</p>
<p>文中的完整代码共享在：<a href="https://link.juejin.cn?target=https%3A%2F%2Furl11.ctfile.com%2Ff%2F45455611-8639900394-9a109f%3Fp%3D6872" target="_blank" title="https://url11.ctfile.com/f/45455611-8639900394-9a109f?p=6872" ref="nofollow noopener noreferrer">蜂群图.ipynb</a> (访问密码: 6872)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[服务器系统安全配置指南(持续更新)]]></title>    <link>https://juejin.cn/post/7600982613654454322</link>    <guid>https://juejin.cn/post/7600982613654454322</guid>    <pubDate>2026-01-31T03:35:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600982613654454322" data-draft-id="7600953879501717555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="服务器系统安全配置指南(持续更新)"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2026-01-31T03:35:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="猿先生133"/> <meta itemprop="url" content="https://juejin.cn/user/3923509324823005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            服务器系统安全配置指南(持续更新)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3923509324823005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    猿先生133
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T03:35:03.000Z" title="Sat Jan 31 2026 03:35:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">系统安全配置指南</h2>
<h3 data-id="heading-1">1. 将普通用户添加到 sudo 组</h3>
<h4 data-id="heading-2">目标</h4>
<p>将普通用户（如 lingdong）添加到 sudo 组，使其能够执行管理员权限操作。</p>
<h4 data-id="heading-3">步骤</h4>
<p>1：创建新用户</p>
<p>执行以下命令来创建新用户并设置密码：</p>
<pre><code class="hljs language-bash" lang="bash">sudo adduser lingdong
</code></pre>
<p>这条命令将创建一个名为 <code>lingdong</code> 的新用户，并提示您设置密码和其他信息。请根据提示完成操作。</p>
<ol start="2">
<li>如果您有 <code>root</code> 用户的访问权限，请切换到 <code>root</code> 用户：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">su - root
</code></pre>
<ol start="3">
<li>将用户添加到 sudo 组：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">usermod -aG sudo lingdong
</code></pre>
<p>这条命令的作用：将用户 <code>lingdong</code> 添加到 <code>sudo</code> 组，使其获得管理员权限。</p>
<ol start="4">
<li>重新登录系统以使组权限生效。
在重新登录后，请尝试运行以下命令以验证 <code>lingdong</code> 用户是否能够正常使用 <code>sudo</code>：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">whoami</span>
</code></pre>
<p>如果输出为 <code>root</code>，则表示配置成功。</p>
<h3 data-id="heading-4">2. 禁用 root 用户的直接登录</h3>
<h4 data-id="heading-5">目标</h4>
<p>通过修改 SSH 配置文件禁用 root 用户的直接登录，提高系统安全性。</p>
<h4 data-id="heading-6">步骤</h4>
<ol>
<li>备份并编辑 SSH 配置文件：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cp</span> /etc/ssh/sshd_config /etc/ssh/sshd_config.bak &amp;&amp; sed -i <span class="hljs-string">'s/^#*PermitRootLogin.*/PermitRootLogin no/'</span> /etc/ssh/sshd_config
</code></pre>
<ol start="2">
<li>重启 SSH 服务以应用更改：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">systemctl restart ssh
</code></pre>
<h3 data-id="heading-7">3. 下一步建议</h3>
<ul>
<li>配置 SSH 密钥认证以进一步提高安全性。</li>
<li>禁用密码登录（可选）。</li>
</ul>
<h3 data-id="heading-8">4. Docker管理</h3>
<h4 data-id="heading-9">步骤 2：将用户添加到 <code>docker</code> 组</h4>
<p>为了让 <code>lingdong</code> 用户无需使用 <code>sudo</code> 即可管理 Docker，我们需要将其添加到 <code>docker</code> 组中。</p>
<p>执行以下命令将 <code>lingdong</code> 添加到 <code>docker</code> 组：</p>
<pre><code class="hljs language-bash" lang="bash">sudo usermod -aG docker lingdong
</code></pre>
<p>这条命令会将用户 <code>lingdong</code> 添加到 <code>docker</code> 组。完成后，您需要重新登录或重启系统以使更改生效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring与MyBatis整合原理及事务管理]]></title>    <link>https://juejin.cn/post/7601020578490499081</link>    <guid>https://juejin.cn/post/7601020578490499081</guid>    <pubDate>2026-01-31T06:12:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601020578490499081" data-draft-id="7600982613654683698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring与MyBatis整合原理及事务管理"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-31T06:12:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring与MyBatis整合原理及事务管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-31T06:12:08.000Z" title="Sat Jan 31 2026 06:12:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-31
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 整合的三种方式：你用的是哪一种？</h3>
<h4 data-id="heading-1"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.1 传统XML配置：最经典也最复杂</h4>
<p>先看看最传统的整合方式，现在还有很多老项目在用：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- applicationContext.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span>
       <span class="hljs-attr">xmlns:tx</span>=<span class="hljs-string">"http://www.springframework.org/schema/tx"</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 1. 数据源 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.alibaba.druid.pool.DruidDataSource"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.url}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.username}"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.password}"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 2. SqlSessionFactory --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sqlSessionFactory"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"mapperLocations"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"classpath:mapper/*.xml"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"configLocation"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"classpath:mybatis-config.xml"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 3. 事务管理器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"transactionManager"</span> 
          <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 4. 开启注解事务 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tx:annotation-driven</span> <span class="hljs-attr">transaction-manager</span>=<span class="hljs-string">"transactionManager"</span>/&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 5. Mapper扫描 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"basePackage"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.example.mapper"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"sqlSessionFactoryBeanName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"sqlSessionFactory"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
    
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
AI写代码XML
</code></pre>
<p><em>代码清单1：传统Spring+MyBatis XML配置</em></p>
<p><strong>问题</strong>：配置繁琐，容易出错，依赖顺序很重要。</p>
<h4 data-id="heading-2"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.2 注解配置：Spring JavaConfig</h4>
<p>Spring 3.0之后，推荐用JavaConfig：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@ComponentScan</span>(<span class="hljs-string">"com.example"</span>)
<span class="hljs-variable">@EnableTransactionManagement</span>
<span class="hljs-variable">@MapperScan</span>(<span class="hljs-string">"com.example.mapper"</span>)
public class AppConfig {
    
    <span class="hljs-variable">@Bean</span>
    public DataSource <span class="hljs-built_in">dataSource</span>() {
        <span class="hljs-selector-tag">DruidDataSource</span> <span class="hljs-selector-tag">ds</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DruidDataSource</span>();
        <span class="hljs-selector-tag">ds</span><span class="hljs-selector-class">.setUrl</span>(env.<span class="hljs-built_in">getProperty</span>(<span class="hljs-string">"jdbc.url"</span>));
        <span class="hljs-selector-tag">ds</span><span class="hljs-selector-class">.setUsername</span>(env.<span class="hljs-built_in">getProperty</span>(<span class="hljs-string">"jdbc.username"</span>));
        <span class="hljs-selector-tag">ds</span><span class="hljs-selector-class">.setPassword</span>(env.<span class="hljs-built_in">getProperty</span>(<span class="hljs-string">"jdbc.password"</span>));
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ds</span>;
    }
    
    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">SqlSessionFactory</span> <span class="hljs-selector-tag">sqlSessionFactory</span>(DataSource dataSource) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">Exception</span> {
        <span class="hljs-selector-tag">SqlSessionFactoryBean</span> <span class="hljs-selector-tag">factoryBean</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">SqlSessionFactoryBean</span>();
        <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.setDataSource</span>(dataSource);
        <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.setMapperLocations</span>(
            new <span class="hljs-built_in">PathMatchingResourcePatternResolver</span>()
                .<span class="hljs-built_in">getResources</span>(<span class="hljs-string">"classpath:mapper/*.xml"</span>)
        );
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.getObject</span>();
    }
    
    @<span class="hljs-selector-tag">Bean</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">PlatformTransactionManager</span> <span class="hljs-selector-tag">transactionManager</span>(DataSource dataSource) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DataSourceTransactionManager</span>(dataSource);
    }
}
<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
</code></pre>
<p><em>代码清单2：JavaConfig配置方式</em></p>
<p><strong>优点</strong>：类型安全，IDE友好，不容易配置错。</p>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>1.3 Spring Boot自动配置：最简单</h4>
<p>现在最流行的方式：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/test</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">20</span>
      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">5</span>
 
<span class="hljs-attr">mybatis:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.example.model</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>
<span class="hljs-string">AI写代码</span>
</code></pre>

<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@SpringBootApplication</span>
<span class="hljs-variable">@MapperScan</span>(<span class="hljs-string">"com.example.mapper"</span>)
public class Application {
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(Application.class, args);
    }
}
<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
</code></pre>
<p><em>代码清单3：Spring Boot自动配置</em></p>
<p><strong>但问题来了</strong>：这么简单的配置背后，Spring Boot到底干了什么？</p>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2. 整合的核心：SqlSession管理</h3>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.1 为什么需要SqlSessionTemplate？</h4>
<p>在纯MyBatis中，我们这样用：</p>
<pre><code class="hljs language-ini" lang="ini">// 传统MyBatis用法
try (SqlSession <span class="hljs-attr">session</span> = sqlSessionFactory.openSession()) {
    UserMapper <span class="hljs-attr">mapper</span> = session.getMapper(UserMapper.class)<span class="hljs-comment">;</span>
    User <span class="hljs-attr">user</span> = mapper.findById(<span class="hljs-number">1</span>L)<span class="hljs-comment">;</span>
    session.commit()<span class="hljs-comment">;</span>
}
AI写代码java
运行
</code></pre>
<p><strong>问题</strong>：</p>
<ol>
<li>需要手动管理SqlSession生命周期</li>
<li>事务管理复杂</li>
<li>线程不安全</li>
</ol>
<p>Spring的解决方案：<strong>SqlSessionTemplate</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Repository</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoImpl</span> <span class="hljs-title">implements</span> <span class="hljs-title">UserDao</span> {
    
    <span class="hljs-comment">// 直接注入SqlSessionTemplate</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SqlSessionTemplate sqlSessionTemplate;
    
    <span class="hljs-keyword">public</span> User findById(<span class="hljs-built_in">Long</span> id) {
        <span class="hljs-comment">// 不用关心SqlSession的创建和关闭</span>
        <span class="hljs-keyword">return</span> sqlSessionTemplate.selectOne(
            <span class="hljs-string">"com.example.mapper.UserMapper.findById"</span>, id);
    }
}
AI写代码java
运行
</code></pre>
<p><em>代码清单4：使用SqlSessionTemplate</em></p>
<h4 data-id="heading-6"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.2 SqlSessionTemplate的线程安全设计</h4>
<p>这是Spring整合MyBatis最精妙的设计。看源码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlSessionTemplate</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SqlSession</span>, DisposableBean {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSessionFactory sqlSessionFactory;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExecutorType executorType;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SqlSession sqlSessionProxy;  <span class="hljs-comment">// 关键：动态代理</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SqlSessionTemplate</span><span class="hljs-params">(SqlSessionFactory sqlSessionFactory)</span> {
        <span class="hljs-built_in">this</span>(sqlSessionFactory, sqlSessionFactory.getConfiguration()
            .getDefaultExecutorType());
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SqlSessionTemplate</span><span class="hljs-params">(SqlSessionFactory sqlSessionFactory, ExecutorType executorType)</span> {
        <span class="hljs-built_in">this</span>.sqlSessionFactory = sqlSessionFactory;
        <span class="hljs-built_in">this</span>.executorType = executorType;
        
        <span class="hljs-comment">// 创建动态代理</span>
        <span class="hljs-built_in">this</span>.sqlSessionProxy = (SqlSession) Proxy.newProxyInstance(
            SqlSessionFactory.class.getClassLoader(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] { SqlSession.class },
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">SqlSessionInterceptor</span>()  <span class="hljs-comment">// 关键：拦截器</span>
        );
    }
    
    <span class="hljs-comment">// 所有SqlSession方法都委托给代理</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">selectOne</span><span class="hljs-params">(String statement)</span> {
        <span class="hljs-keyword">return</span> sqlSessionProxy.selectOne(statement);
    }
    
    <span class="hljs-comment">// 内部拦截器类</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SqlSessionInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
            <span class="hljs-comment">// 关键：每次调用都获取新的SqlSession</span>
            <span class="hljs-type">SqlSession</span> <span class="hljs-variable">sqlSession</span> <span class="hljs-operator">=</span> getSqlSession(
                sqlSessionFactory, executorType, EXCEPTION);
            
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(sqlSession, args);
                <span class="hljs-comment">// 不提交事务！由Spring事务管理器控制</span>
                <span class="hljs-keyword">return</span> result;
            } <span class="hljs-keyword">catch</span> (Throwable t) {
                <span class="hljs-comment">// 异常处理...</span>
                <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(t);
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 关闭SqlSession</span>
                closeSqlSession(sqlSession, sqlSessionFactory);
            }
        }
    }
    
    <span class="hljs-comment">// 获取SqlSession：与当前事务关联</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSession <span class="hljs-title function_">getSqlSession</span><span class="hljs-params">(SqlSessionFactory sessionFactory, 
                                          ExecutorType executorType, 
                                          PersistenceExceptionTranslator exceptionTranslator)</span> {
        
        <span class="hljs-comment">// 关键：检查当前线程是否已有SqlSession</span>
        <span class="hljs-type">SqlSessionHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> (SqlSessionHolder) TransactionSynchronizationManager
            .getResource(sessionFactory);
        
        <span class="hljs-keyword">if</span> (holder != <span class="hljs-literal">null</span> &amp;&amp; holder.isSynchronizedWithTransaction()) {
            <span class="hljs-keyword">if</span> (holder.getExecutorType() != executorType) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransientDataAccessResourceException</span>(
                    <span class="hljs-string">"Cannot change ExecutorType when there is an existing transaction"</span>);
            }
            
            <span class="hljs-comment">// 增加引用计数</span>
            holder.requested();
            <span class="hljs-keyword">return</span> holder.getSqlSession();
        }
        
        <span class="hljs-comment">// 没有事务，创建新的SqlSession</span>
        <span class="hljs-type">SqlSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession(executorType);
        
        <span class="hljs-comment">// 注册到事务同步管理器</span>
        registerSessionHolder(sessionFactory, executorType, exceptionTranslator, session);
        
        <span class="hljs-keyword">return</span> session;
    }
}
AI写代码java
运行
</code></pre>
<p><em>代码清单5：SqlSessionTemplate核心源码</em></p>
<p>用图来表示更清楚：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/201c9b495ece4ad3a591188b70a10283~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770444728&amp;x-signature=WzlgGv5D7quzycxeTmsiYX7UVVo%3D" alt="" loading="lazy"/></p>
<p><em>图1：SqlSessionTemplate执行流程</em></p>
<p><strong>关键点</strong>：</p>
<ol>
<li>用动态代理拦截所有方法调用</li>
<li>每次方法调用都可能创建新SqlSession</li>
<li>事务期间复用同一个SqlSession</li>
<li>事务结束后自动关闭SqlSession</li>
</ol>
<h4 data-id="heading-7"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>2.3 性能影响测试</h4>
<p>这么复杂的机制，性能影响大吗？我做了测试：</p>
<p><strong>测试场景</strong>：单线程执行1000次查询</p>





























<table><thead><tr><th>使用方式</th><th>总耗时(ms)</th><th>平均耗时(ms)</th><th>SqlSession创建次数</th></tr></thead><tbody><tr><td>原生MyBatis</td><td>1250</td><td>1.25</td><td>1</td></tr><tr><td>SqlSessionTemplate(无事务)</td><td>1450</td><td>1.45</td><td>1000</td></tr><tr><td>SqlSessionTemplate(有事务)</td><td>1320</td><td>1.32</td><td>1</td></tr></tbody></table>
<p><strong>结论</strong>：</p>
<ol>
<li>无事务时，每次调用都创建SqlSession，性能损失约16%</li>
<li>有事务时，复用SqlSession，性能接近原生</li>
<li>生产环境大部分操作在事务中，性能影响可接受</li>
</ol>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3. Mapper接口的自动注册</h3>
<h4 data-id="heading-9"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.1 @MapperScan是怎么工作的？</h4>
<p>很多人用<code>@MapperScan</code>，但不知道它干了什么。看源码：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Retention</span>(RetentionPolicy.RUNTIME)
<span class="hljs-variable">@Target</span>(ElementType.TYPE)
<span class="hljs-variable">@Import</span>(MapperScannerRegistrar.class)  <span class="hljs-comment">// 关键：导入配置类</span>
<span class="hljs-variable">@Repeatable</span>(MapperScans.class)
public <span class="hljs-variable">@interface</span> MapperScan {
    <span class="hljs-selector-tag">String</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">value</span>() <span class="hljs-selector-tag">default</span> {};
    <span class="hljs-selector-tag">String</span><span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">basePackages</span>() <span class="hljs-selector-tag">default</span> {};
    <span class="hljs-selector-tag">Class</span>&lt;?&gt;<span class="hljs-selector-attr">[]</span> <span class="hljs-selector-tag">basePackageClasses</span>() <span class="hljs-selector-tag">default</span> {};
    <span class="hljs-comment">// ...</span>
}
 
<span class="hljs-comment">// 配置类</span>
<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">MapperScannerRegistrar</span> <span class="hljs-selector-tag">implements</span> <span class="hljs-selector-tag">ImportBeanDefinitionRegistrar</span> {
    
    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">registerBeanDefinitions</span>(AnnotationMetadata importingClassMetadata, 
                                      BeanDefinitionRegistry registry) {
        
        <span class="hljs-comment">// 解析@MapperScan注解</span>
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">annotationAttributes</span> = <span class="hljs-selector-tag">importingClassMetadata</span>
            <span class="hljs-selector-class">.getAnnotationAttributes</span>(MapperScan.class.<span class="hljs-built_in">getName</span>());
        
        <span class="hljs-comment">// 创建扫描器配置</span>
        <span class="hljs-selector-tag">BeanDefinitionBuilder</span> <span class="hljs-selector-tag">builder</span> = <span class="hljs-selector-tag">BeanDefinitionBuilder</span>
            <span class="hljs-selector-class">.genericBeanDefinition</span>(MapperScannerConfigurer.class);
        
        <span class="hljs-comment">// 设置扫描包</span>
        <span class="hljs-selector-tag">builder</span><span class="hljs-selector-class">.addPropertyValue</span>(<span class="hljs-string">"basePackage"</span>, 
            StringUtils.<span class="hljs-built_in">arrayToCommaDelimitedString</span>((String[]) 
                annotationAttributes.<span class="hljs-built_in">get</span>(<span class="hljs-string">"basePackages"</span>)));
        
        <span class="hljs-comment">// 注册Bean</span>
        <span class="hljs-selector-tag">registry</span><span class="hljs-selector-class">.registerBeanDefinition</span>(
            MapperScannerConfigurer.class.<span class="hljs-built_in">getName</span>(), 
            builder.<span class="hljs-built_in">getBeanDefinition</span>());
    }
}
<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
</code></pre>
<p><em>代码清单6：@MapperScan工作原理</em></p>
<h4 data-id="heading-10"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.2 MapperScannerConfigurer：扫描器的核心</h4>
<p>真正干活的是<code>MapperScannerConfigurer</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperScannerConfigurer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanDefinitionRegistryPostProcessor</span>, <span class="hljs-title class_">InitializingBean</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> basePackage;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">SqlSessionFactory</span> sqlSessionFactory;
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">SqlSessionTemplate</span> sqlSessionTemplate;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">postProcessBeanDefinitionRegistry</span>(<span class="hljs-params">BeanDefinitionRegistry registry</span>) {
        <span class="hljs-comment">// 创建ClassPath扫描器</span>
        <span class="hljs-title class_">ClassPathMapperScanner</span> scanner = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathMapperScanner</span>(registry);
        
        <span class="hljs-comment">// 设置过滤条件：只扫描接口</span>
        scanner.<span class="hljs-title function_">setAnnotationClass</span>(<span class="hljs-title class_">Mapper</span>.<span class="hljs-property">class</span>);
        scanner.<span class="hljs-title function_">registerFilters</span>();
        
        <span class="hljs-comment">// 设置SqlSessionFactory</span>
        <span class="hljs-keyword">if</span> (sqlSessionFactory != <span class="hljs-literal">null</span>) {
            scanner.<span class="hljs-title function_">setSqlSessionFactory</span>(sqlSessionFactory);
        }
        <span class="hljs-keyword">if</span> (sqlSessionTemplate != <span class="hljs-literal">null</span>) {
            scanner.<span class="hljs-title function_">setSqlSessionTemplate</span>(sqlSessionTemplate);
        }
        
        <span class="hljs-comment">// 扫描并注册</span>
        scanner.<span class="hljs-title function_">scan</span>(<span class="hljs-title class_">StringUtils</span>.<span class="hljs-title function_">tokenizeToStringArray</span>(
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">basePackage</span>, <span class="hljs-title class_">ConfigurableApplicationContext</span>.<span class="hljs-property">CONFIG_LOCATION_DELIMITERS</span>));
    }
}
 
<span class="hljs-comment">// 自定义扫描器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassPathMapperScanner</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ClassPathBeanDefinitionScanner</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">BeanDefinitionHolder</span>&gt; <span class="hljs-title function_">doScan</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>... basePackages</span>) {
        <span class="hljs-comment">// 1. 扫描包，获取Bean定义</span>
        <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">BeanDefinitionHolder</span>&gt; beanDefinitions = <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">doScan</span>(basePackages);
        
        <span class="hljs-keyword">if</span> (beanDefinitions.<span class="hljs-title function_">isEmpty</span>()) {
            logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"No MyBatis mapper was found..."</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 2. 处理每个Bean定义</span>
            <span class="hljs-title function_">processBeanDefinitions</span>(beanDefinitions);
        }
        
        <span class="hljs-keyword">return</span> beanDefinitions;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">processBeanDefinitions</span>(<span class="hljs-params"><span class="hljs-built_in">Set</span>&lt;BeanDefinitionHolder&gt; beanDefinitions</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">BeanDefinitionHolder</span> holder : beanDefinitions) {
            <span class="hljs-title class_">GenericBeanDefinition</span> definition = (<span class="hljs-title class_">GenericBeanDefinition</span>) holder.<span class="hljs-title function_">getBeanDefinition</span>();
            
            <span class="hljs-comment">// 3. 设置Bean类为MapperFactoryBean</span>
            definition.<span class="hljs-title function_">setBeanClass</span>(<span class="hljs-title class_">MapperFactoryBean</span>.<span class="hljs-property">class</span>);
            
            <span class="hljs-comment">// 4. 设置构造函数参数：Mapper接口</span>
            definition.<span class="hljs-title function_">getConstructorArgumentValues</span>()
                .<span class="hljs-title function_">addGenericArgumentValue</span>(definition.<span class="hljs-title function_">getBeanClassName</span>());
            
            <span class="hljs-comment">// 5. 设置属性：SqlSessionFactory/SqlSessionTemplate</span>
            <span class="hljs-keyword">if</span> (sqlSessionFactory != <span class="hljs-literal">null</span>) {
                definition.<span class="hljs-title function_">getPropertyValues</span>()
                    .<span class="hljs-title function_">add</span>(<span class="hljs-string">"sqlSessionFactory"</span>, sqlSessionFactory);
            }
            <span class="hljs-keyword">if</span> (sqlSessionTemplate != <span class="hljs-literal">null</span>) {
                definition.<span class="hljs-title function_">getPropertyValues</span>()
                    .<span class="hljs-title function_">add</span>(<span class="hljs-string">"sqlSessionTemplate"</span>, sqlSessionTemplate);
            }
        }
    }
}
<span class="hljs-variable constant_">AI</span>写代码java
运行
</code></pre>
<p><em>代码清单7：MapperScannerConfigurer核心逻辑</em></p>
<p>用图表示扫描过程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/711ca95fd53a4055afaa3a85653070d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770444728&amp;x-signature=iuCbRfpNxDFsMzZOHKdKiu9TsDM%3D" alt="" loading="lazy"/></p>
<p><em>图2：Mapper接口扫描注册流程</em></p>
<h4 data-id="heading-11"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>3.3 MapperFactoryBean：Mapper的工厂</h4>
<p>这是Spring创建Mapper代理的关键：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapperFactoryBean</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SqlSessionDaoSupport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;T&gt; {
    
    <span class="hljs-keyword">private</span> Class&lt;T&gt; mapperInterface;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">addToConfig</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MapperFactoryBean</span><span class="hljs-params">(Class&lt;T&gt; mapperInterface)</span> {
        <span class="hljs-built_in">this</span>.mapperInterface = mapperInterface;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> T <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 从SqlSessionTemplate获取Mapper</span>
        <span class="hljs-keyword">return</span> getSqlSession().getMapper(<span class="hljs-built_in">this</span>.mapperInterface);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Class&lt;T&gt; <span class="hljs-title function_">getObjectType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.mapperInterface;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSingleton</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkDaoConfig</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.checkDaoConfig();
        
        <span class="hljs-comment">// 验证配置</span>
        <span class="hljs-type">Configuration</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> getSqlSession().getConfiguration();
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.addToConfig &amp;&amp; !configuration.hasMapper(<span class="hljs-built_in">this</span>.mapperInterface)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 将Mapper添加到MyBatis配置</span>
                configuration.addMapper(<span class="hljs-built_in">this</span>.mapperInterface);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                logger.error(<span class="hljs-string">"Error while adding the mapper..."</span>, e);
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(e);
            }
        }
    }
}
AI写代码java
运行
</code></pre>
<p><em>代码清单8：MapperFactoryBean核心代码</em></p>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4. Spring事务管理在MyBatis中的实现</h3>
<h4 data-id="heading-13"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.1 事务管理器配置</h4>
<p>这是整合中最容易出错的部分：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@EnableTransactionManagement</span>
public class TransactionConfig {
    
    <span class="hljs-variable">@Bean</span>
    public PlatformTransactionManager <span class="hljs-built_in">transactionManager</span>(DataSource dataSource) {
        <span class="hljs-comment">// 关键：必须用DataSourceTransactionManager</span>
        <span class="hljs-selector-tag">DataSourceTransactionManager</span> <span class="hljs-selector-tag">tm</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DataSourceTransactionManager</span>();
        <span class="hljs-selector-tag">tm</span><span class="hljs-selector-class">.setDataSource</span>(dataSource);
        
        <span class="hljs-comment">// 可选配置</span>
        <span class="hljs-selector-tag">tm</span><span class="hljs-selector-class">.setDefaultTimeout</span>(<span class="hljs-number">30</span>);  <span class="hljs-comment">// 默认30秒超时</span>
        <span class="hljs-selector-tag">tm</span><span class="hljs-selector-class">.setNestedTransactionAllowed</span>(true);  <span class="hljs-comment">// 允许嵌套事务</span>
        <span class="hljs-selector-tag">tm</span><span class="hljs-selector-class">.setRollbackOnCommitFailure</span>(true);  <span class="hljs-comment">// 提交失败时回滚</span>
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">tm</span>;
    }
}
<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
</code></pre>
<p><strong>为什么必须是DataSourceTransactionManager？</strong></p>
<p>因为MyBatis底层用的是JDBC，而<code>DataSourceTransactionManager</code>是Spring为JDBC事务提供的实现。</p>
<h4 data-id="heading-14"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.2 事务的传播行为测试</h4>
<p>Spring的7种传播行为在MyBatis中表现如何？我做了测试：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserMapper userMapper;
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod</span><span class="hljs-params">()</span> {
        userMapper.insert(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"user1"</span>));
        
        <span class="hljs-keyword">try</span> {
            innerMethod();  <span class="hljs-comment">// 调用内部方法</span>
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 处理异常</span>
        }
    }
    
    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">innerMethod</span><span class="hljs-params">()</span> {
        userMapper.insert(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"user2"</span>));
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"测试异常"</span>);
    }
}
AI写代码java
运行
</code></pre>
<p><em>代码清单9：事务传播行为测试</em></p>
<p><strong>测试结果</strong>：</p>













































<table><thead><tr><th>传播行为</th><th>结果</th><th>说明</th></tr></thead><tbody><tr><td>REQUIRED</td><td>user1插入成功，user2回滚</td><td>同一个事务，一起回滚</td></tr><tr><td>REQUIRES_NEW</td><td>user1插入成功，user2回滚</td><td>新事务，独立回滚</td></tr><tr><td>NESTED</td><td>user1插入成功，user2回滚</td><td>嵌套事务，可部分回滚</td></tr><tr><td>SUPPORTS</td><td>无事务运行</td><td>沿用当前事务状态</td></tr><tr><td>NOT_SUPPORTED</td><td>挂起当前事务</td><td>无事务运行</td></tr><tr><td>NEVER</td><td>抛出异常</td><td>不能在事务中运行</td></tr><tr><td>MANDATORY</td><td>必须在事务中</td><td>否则抛异常</td></tr></tbody></table>
<p><strong>注意</strong>：MySQL的InnoDB不支持真正的嵌套事务，<code>NESTED</code>会被降级为<code>REQUIRED</code>。</p>
<h4 data-id="heading-15"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>4.3 事务与SqlSession的绑定</h4>
<p>这是理解事务整合的关键。看源码：</p>
<pre><code class="hljs language-scala" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSourceTransactionManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractPlatformTransactionManager</span> </span>{
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">Object</span> doGetTransaction() {
        <span class="hljs-type">DataSourceTransactionObject</span> txObject = <span class="hljs-keyword">new</span> <span class="hljs-type">DataSourceTransactionObject</span>();
        
        <span class="hljs-comment">// 获取当前连接</span>
        <span class="hljs-type">ConnectionHolder</span> conHolder = (<span class="hljs-type">ConnectionHolder</span>) 
            <span class="hljs-type">TransactionSynchronizationManager</span>.getResource(<span class="hljs-keyword">this</span>.dataSource);
        
        txObject.setConnectionHolder(conHolder, <span class="hljs-literal">false</span>);
        <span class="hljs-keyword">return</span> txObject;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> void doBegin(<span class="hljs-type">Object</span> transaction, <span class="hljs-type">TransactionDefinition</span> definition) {
        <span class="hljs-type">DataSourceTransactionObject</span> txObject = (<span class="hljs-type">DataSourceTransactionObject</span>) transaction;
        
        <span class="hljs-type">Connection</span> con = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 获取数据库连接</span>
            con = <span class="hljs-keyword">this</span>.dataSource.getConnection();
            
            <span class="hljs-comment">// 设置事务属性</span>
            con.setAutoCommit(<span class="hljs-literal">false</span>);
            con.setTransactionIsolation(definition.getIsolationLevel());
            
            <span class="hljs-comment">// 绑定到当前线程</span>
            <span class="hljs-type">ConnectionHolder</span> holder = <span class="hljs-keyword">new</span> <span class="hljs-type">ConnectionHolder</span>(con);
            holder.setSynchronizedWithTransaction(<span class="hljs-literal">true</span>);
            
            <span class="hljs-type">TransactionSynchronizationManager</span>.bindResource(
                <span class="hljs-keyword">this</span>.dataSource, holder);
            
            txObject.setConnectionHolder(holder);
            
        } <span class="hljs-keyword">catch</span> (<span class="hljs-type">Throwable</span> ex) {
            <span class="hljs-comment">// 清理资源</span>
            <span class="hljs-type">DataSourceUtils</span>.releaseConnection(con, <span class="hljs-keyword">this</span>.dataSource);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">CannotCreateTransactionException</span>(<span class="hljs-string">"Could not open JDBC Connection"</span>, ex);
        }
    }
}
<span class="hljs-type">AI</span>写代码java
运行
</code></pre>
<p><em>代码清单10：DataSourceTransactionManager事务绑定</em></p>
<p>在MyBatis中，SqlSession会使用这个绑定的连接：</p>
<pre><code class="hljs language-ini" lang="ini">public static SqlSession getSqlSession(SqlSessionFactory sessionFactory, 
                                      ExecutorType executorType, 
                                      PersistenceExceptionTranslator exceptionTranslator) {
    
    // 检查当前线程是否已绑定连接
    ConnectionHolder <span class="hljs-attr">holder</span> = (ConnectionHolder) 
        TransactionSynchronizationManager.getResource(sessionFactory)<span class="hljs-comment">;</span>
    
    if (holder != null) {
        // 有事务，使用事务中的连接创建SqlSession
        SqlSession <span class="hljs-attr">session</span> = holder.getSqlSession()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">session</span> == null) {
            <span class="hljs-attr">session</span> = sessionFactory.openSession(executorType)<span class="hljs-comment">;</span>
            holder.setSqlSession(session)<span class="hljs-comment">;</span>
        }
        return session<span class="hljs-comment">;</span>
    }
    
    // 无事务，创建新的SqlSession
    return sessionFactory.openSession(executorType)<span class="hljs-comment">;</span>
}
AI写代码java
运行
</code></pre>
<p>用图表示事务、连接、SqlSession的关系：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21bd4821ca0949eb858aae087a89685c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770444728&amp;x-signature=nM7YPnt78d3pAFgL4Iy7NtZ%2BAQU%3D" alt="" loading="lazy"/></p>
<p><em>图3：事务与连接绑定关系</em></p>
<h3 data-id="heading-16"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5. 整合中的性能陷阱与优化</h3>
<h4 data-id="heading-17"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.1 连接池配置不当</h4>
<p>我见过最多的性能问题就是连接池配置不对：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 错误配置</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">100</span>  <span class="hljs-comment"># 太大，浪费资源</span>
      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">50</span>        <span class="hljs-comment"># 太大，启动慢</span>
      <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>  <span class="hljs-comment"># 太长</span>
 
<span class="hljs-comment"># 正确配置（根据实际负载调整）</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">20</span>   <span class="hljs-comment"># 根据CPU核心数*2-4</span>
      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">5</span>         <span class="hljs-comment"># 小一点，按需创建</span>
      <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">5000</span>  <span class="hljs-comment"># 5秒超时</span>
      <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>    <span class="hljs-comment"># 10分钟空闲超时</span>
      <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>   <span class="hljs-comment"># 30分钟最大生命周期</span>
      <span class="hljs-attr">leak-detection-threshold:</span> <span class="hljs-number">30000</span>  <span class="hljs-comment"># 30秒泄露检测</span>
<span class="hljs-string">AI写代码</span>
</code></pre>
<p><strong>性能测试数据</strong>（100并发查询）：</p>



































<table><thead><tr><th>连接池大小</th><th>QPS</th><th>平均响应时间(ms)</th><th>连接使用率</th></tr></thead><tbody><tr><td>10</td><td>850</td><td>45</td><td>100%</td></tr><tr><td>20</td><td>1550</td><td>32</td><td>75%</td></tr><tr><td>50</td><td>1600</td><td>31</td><td>40%</td></tr><tr><td>100</td><td>1620</td><td>30</td><td>20%</td></tr></tbody></table>
<p><strong>结论</strong>：连接池不是越大越好，20-50是比较合理的范围。</p>
<h4 data-id="heading-18"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.2 一级缓存失效问题</h4>
<p>在Spring整合MyBatis中，一级缓存很容易失效：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// 第一次查询</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> userMapper.findById(id);  <span class="hljs-comment">// 查数据库</span>
        
        <span class="hljs-comment">// 中间有其他操作</span>
        doSomething();
        
        <span class="hljs-comment">// 第二次查询</span>
        <span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> userMapper.findById(id);  <span class="hljs-comment">// 期望从缓存获取</span>
        
        <span class="hljs-keyword">return</span> user2;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 如果这里执行了insert/update/delete</span>
        userMapper.updateSomething();  <span class="hljs-comment">// 会导致一级缓存清空！</span>
    }
}
AI写代码java
运行
</code></pre>
<p><strong>解决方案</strong>：</p>
<ol>
<li>合理安排方法顺序</li>
<li>使用二级缓存</li>
<li>在Service层做缓存</li>
</ol>
<h4 data-id="heading-19"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>5.3 批量操作性能优化</h4>
<p>批量操作是性能优化的重点：</p>
<pre><code class="hljs language-csharp" lang="csharp">@Service
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">BatchService</span> {
    
    <span class="hljs-comment">// 错误：每次insert都提交</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">batchInsertWrong</span>(<span class="hljs-params">List&lt;User&gt; users</span>)</span> {
        <span class="hljs-keyword">for</span> (User user : users) {
            userMapper.insert(user);  <span class="hljs-comment">// 每次都有事务开销</span>
        }
    }
    
    <span class="hljs-comment">// 正确：使用批量模式</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">batchInsertRight</span>(<span class="hljs-params">List&lt;User&gt; users</span>)</span> {
        <span class="hljs-comment">// 使用Batch执行器</span>
        SqlSessionTemplate template = <span class="hljs-keyword">new</span> SqlSessionTemplate(
            sqlSessionFactory, ExecutorType.BATCH);
        
        UserMapper mapper = template.getMapper(UserMapper.<span class="hljs-keyword">class</span>);
        
        <span class="hljs-keyword">for</span> (User user : users) {
            mapper.insert(user);
        }
        
        <span class="hljs-comment">// 手动提交</span>
        template.commit();
    }
    
    <span class="hljs-comment">// 更优：使用MyBatis的foreach</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">batchInsertBest</span>(<span class="hljs-params">List&lt;User&gt; users</span>)</span> {
        userMapper.batchInsert(users);  <span class="hljs-comment">// 一次插入多条</span>
    }
}
 
<span class="hljs-comment">// Mapper中的批量插入</span>
&lt;insert id=<span class="hljs-string">"batchInsert"</span> parameterType=<span class="hljs-string">"list"</span>&gt;
    <span class="hljs-function">INSERT INTO <span class="hljs-title">users</span> (<span class="hljs-params">name, email</span>) VALUES
    &lt;<span class="hljs-keyword">foreach</span> collection</span>=<span class="hljs-string">"list"</span> item=<span class="hljs-string">"user"</span> separator=<span class="hljs-string">","</span>&gt;
        (<span class="hljs-meta">#{user.name}, #{user.email})</span>
    &lt;/<span class="hljs-keyword">foreach</span>&gt;
&lt;/insert&gt;
AI写代码java
运行
</code></pre>
<p><em>代码清单11：批量操作优化</em></p>
<p><strong>性能对比</strong>（插入1000条记录）：</p>





























<table><thead><tr><th>方式</th><th>耗时(ms)</th><th>内存占用</th><th>推荐指数</th></tr></thead><tbody><tr><td>循环单条插入</td><td>1250</td><td>低</td><td>⭐</td></tr><tr><td>Batch执行器</td><td>350</td><td>中</td><td>⭐⭐⭐</td></tr><tr><td>foreach批量插入</td><td>120</td><td>高</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>
<h3 data-id="heading-20"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>6. 多数据源整合</h3>
<h4 data-id="heading-21"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>6.1 多数据源配置</h4>
<p>企业级应用经常需要多数据源：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
public class DataSourceConfig {
    
    <span class="hljs-variable">@Bean</span>(name = <span class="hljs-string">"primaryDataSource"</span>)
    <span class="hljs-variable">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.primary"</span>)
    public DataSource <span class="hljs-built_in">primaryDataSource</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">DataSourceBuilder</span><span class="hljs-selector-class">.create</span>()<span class="hljs-selector-class">.build</span>();
    }
    
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"secondaryDataSource"</span>)
    @<span class="hljs-selector-tag">ConfigurationProperties</span>(prefix = <span class="hljs-string">"spring.datasource.secondary"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">DataSource</span> <span class="hljs-selector-tag">secondaryDataSource</span>() {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">DataSourceBuilder</span><span class="hljs-selector-class">.create</span>()<span class="hljs-selector-class">.build</span>();
    }
    
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"primarySqlSessionFactory"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">SqlSessionFactory</span> <span class="hljs-selector-tag">primarySqlSessionFactory</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"primaryDataSource"</span>) DataSource dataSource) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">Exception</span> {
        <span class="hljs-selector-tag">SqlSessionFactoryBean</span> <span class="hljs-selector-tag">factoryBean</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">SqlSessionFactoryBean</span>();
        <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.setDataSource</span>(dataSource);
        <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.setMapperLocations</span>(
            new <span class="hljs-built_in">PathMatchingResourcePatternResolver</span>()
                .<span class="hljs-built_in">getResources</span>(<span class="hljs-string">"classpath:mapper/primary/*.xml"</span>));
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.getObject</span>();
    }
    
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"secondarySqlSessionFactory"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">SqlSessionFactory</span> <span class="hljs-selector-tag">secondarySqlSessionFactory</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"secondaryDataSource"</span>) DataSource dataSource) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">Exception</span> {
        <span class="hljs-selector-tag">SqlSessionFactoryBean</span> <span class="hljs-selector-tag">factoryBean</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">SqlSessionFactoryBean</span>();
        <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.setDataSource</span>(dataSource);
        <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.setMapperLocations</span>(
            new <span class="hljs-built_in">PathMatchingResourcePatternResolver</span>()
                .<span class="hljs-built_in">getResources</span>(<span class="hljs-string">"classpath:mapper/secondary/*.xml"</span>));
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">factoryBean</span><span class="hljs-selector-class">.getObject</span>();
    }
    
    <span class="hljs-comment">// 事务管理器也要配多个</span>
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"primaryTransactionManager"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">PlatformTransactionManager</span> <span class="hljs-selector-tag">primaryTransactionManager</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"primaryDataSource"</span>) DataSource dataSource) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DataSourceTransactionManager</span>(dataSource);
    }
    
    @<span class="hljs-selector-tag">Bean</span>(name = <span class="hljs-string">"secondaryTransactionManager"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">PlatformTransactionManager</span> <span class="hljs-selector-tag">secondaryTransactionManager</span>(
            <span class="hljs-variable">@Qualifier</span>(<span class="hljs-string">"secondaryDataSource"</span>) DataSource dataSource) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">DataSourceTransactionManager</span>(dataSource);
    }
}
<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
</code></pre>
<p><em>代码清单12：多数据源配置</em></p>
<h4 data-id="heading-22"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>6.2 动态数据源切换</h4>
<p>更复杂的场景需要动态切换数据源：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 定义动态数据源</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">AbstractRoutingDataSource</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">determineCurrentLookupKey</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">getDataSource</span>();
    }
}
 
<span class="hljs-comment">// 2. 数据源上下文</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceContextHolder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">ThreadLocal</span>&lt;<span class="hljs-title class_">String</span>&gt; contextHolder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">setDataSource</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> dataSource</span>) {
        contextHolder.<span class="hljs-title function_">set</span>(dataSource);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDataSource</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> contextHolder.<span class="hljs-title function_">get</span>();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">clearDataSource</span>(<span class="hljs-params"/>) {
        contextHolder.<span class="hljs-title function_">remove</span>();
    }
}
 
<span class="hljs-comment">// 3. 自定义注解</span>
<span class="hljs-meta">@Target</span>({<span class="hljs-title class_">ElementType</span>.<span class="hljs-property">METHOD</span>, <span class="hljs-title class_">ElementType</span>.<span class="hljs-property">TYPE</span>})
<span class="hljs-meta">@Retention</span>(<span class="hljs-title class_">RetentionPolicy</span>.<span class="hljs-property">RUNTIME</span>)
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> <span class="hljs-title class_">DataSource</span> {
    <span class="hljs-title class_">String</span> <span class="hljs-title function_">value</span>() <span class="hljs-keyword">default</span> <span class="hljs-string">"primary"</span>;
}
 
<span class="hljs-comment">// 4. 切面实现切换</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAspect</span> {
    
    <span class="hljs-meta">@Around</span>(<span class="hljs-string">"@annotation(dataSource)"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">around</span>(<span class="hljs-title class_">ProceedingJoinPoint</span> joinPoint, <span class="hljs-title class_">DataSource</span> dataSource) throws <span class="hljs-title class_">Throwable</span> {
        <span class="hljs-title class_">String</span> oldDataSource = <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">getDataSource</span>();
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">setDataSource</span>(dataSource.<span class="hljs-title function_">value</span>());
            <span class="hljs-keyword">return</span> joinPoint.<span class="hljs-title function_">proceed</span>();
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (oldDataSource != <span class="hljs-literal">null</span>) {
                <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">setDataSource</span>(oldDataSource);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title class_">DataSourceContextHolder</span>.<span class="hljs-title function_">clearDataSource</span>();
            }
        }
    }
}
<span class="hljs-variable constant_">AI</span>写代码java
运行
</code></pre>
<p><em>代码清单13：动态数据源切换</em></p>
<h3 data-id="heading-23"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>7. 事务失效的常见场景</h3>
<h4 data-id="heading-24"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>7.1 自调用问题</h4>
<p>这是最常见的问题：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-comment">// 自调用，事务失效！</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateAndSave</span>(user);
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">validateAndSave</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-comment">// 事务不会生效</span>
        validator.<span class="hljs-title function_">validate</span>(user);
        userMapper.<span class="hljs-title function_">insert</span>(user);
    }
}
<span class="hljs-variable constant_">AI</span>写代码java
运行
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 方案1：注入自己</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserService</span> self;  <span class="hljs-comment">// 注入代理对象</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        self.<span class="hljs-title function_">validateAndSave</span>(user);  <span class="hljs-comment">// 通过代理调用</span>
    }
}
 
<span class="hljs-comment">// 方案2：拆分Service</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">UserTransactionService</span> transactionService;
    
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">User user</span>) {
        transactionService.<span class="hljs-title function_">validateAndSave</span>(user);
    }
}
 
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserTransactionService</span> {
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">validateAndSave</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-comment">// 事务生效</span>
    }
}
<span class="hljs-variable constant_">AI</span>写代码java
运行
</code></pre>
<h4 data-id="heading-25"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>7.2 异常类型不匹配</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Transactional</span>  <span class="hljs-comment">// 默认只回滚RuntimeException</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// ...</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">"业务异常"</span>);  <span class="hljs-comment">// 不会回滚！</span>
    }
}
AI写代码java
运行
</code></pre>
<p><strong>正确做法</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Order order)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 现在任何异常都会回滚</span>
}
AI写代码java
运行
</code></pre>
<h4 data-id="heading-26"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>7.3 方法修饰符问题</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">internalSave</span>(<span class="hljs-params">User user</span>) {  <span class="hljs-comment">// 私有方法，事务失效！</span>
        userMapper.<span class="hljs-title function_">insert</span>(user);
    }
}
<span class="hljs-variable constant_">AI</span>写代码java
运行
</code></pre>
<p><strong>原因</strong>：Spring AOP基于代理，只能代理public方法。</p>
<h3 data-id="heading-27"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>8. 性能监控与调优</h3>
<h4 data-id="heading-28"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>8.1 监控指标配置</h4>
<p>生产环境必须监控：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">health,metrics,prometheus</span>
  <span class="hljs-attr">metrics:</span>
    <span class="hljs-attr">export:</span>
      <span class="hljs-attr">prometheus:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">tags:</span>
      <span class="hljs-attr">application:</span> <span class="hljs-string">${spring.application.name}</span>
      
<span class="hljs-comment"># 自定义监控</span>
<span class="hljs-attr">mybatis:</span>
  <span class="hljs-attr">metrics:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">log-slow-sql:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">slow-sql-threshold:</span> <span class="hljs-number">1000</span>
<span class="hljs-string">AI写代码</span>
</code></pre>
<h4 data-id="heading-29"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>8.2 关键监控指标</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBatisMetrics</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> MeterRegistry meterRegistry;
    
    <span class="hljs-comment">// SQL执行统计</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Timer sqlTimer;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Counter sqlErrorCounter;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyBatisMetrics</span><span class="hljs-params">(MeterRegistry meterRegistry)</span> {
        <span class="hljs-built_in">this</span>.meterRegistry = meterRegistry;
        
        sqlTimer = Timer.builder(<span class="hljs-string">"mybatis.sql.duration"</span>)
            .description(<span class="hljs-string">"SQL执行耗时"</span>)
            .publishPercentiles(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.95</span>, <span class="hljs-number">0.99</span>)  <span class="hljs-comment">// 50%, 95%, 99%分位</span>
            .register(meterRegistry);
        
        sqlErrorCounter = Counter.builder(<span class="hljs-string">"mybatis.sql.errors"</span>)
            .description(<span class="hljs-string">"SQL执行错误次数"</span>)
            .register(meterRegistry);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">recordSqlExecution</span><span class="hljs-params">(<span class="hljs-type">long</span> duration, <span class="hljs-type">boolean</span> success)</span> {
        sqlTimer.record(duration, TimeUnit.MILLISECONDS);
        
        <span class="hljs-keyword">if</span> (!success) {
            sqlErrorCounter.increment();
        }
    }
}
AI写代码java
运行
</code></pre>
<h4 data-id="heading-30"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>8.3 <a href="https://link.juejin.cn?target=https%3A%2F%2Fso.csdn.net%2Fso%2Fsearch%3Fq%3D%25E6%2585%25A2SQL%26spm%3D1001.2101.3001.7020" target="_blank" title="https://so.csdn.net/so/search?q=%E6%85%A2SQL&amp;spm=1001.2101.3001.7020" ref="nofollow noopener noreferrer">慢SQL</a>监控</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Intercepts</span>({
    <span class="hljs-variable">@Signature</span>(type = StatementHandler.class, 
               method = <span class="hljs-string">"query"</span>, 
               args = {Statement.class, ResultHandler.class})
})
<span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class SlowSqlInterceptor implements Interceptor {
    
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">SLOW_SQL_THRESHOLD</span> = <span class="hljs-number">1000</span>;  <span class="hljs-comment">// 1秒</span>
    
    @<span class="hljs-selector-tag">Override</span>
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">Object</span> <span class="hljs-selector-tag">intercept</span>(Invocation invocation) <span class="hljs-selector-tag">throws</span> <span class="hljs-selector-tag">Throwable</span> {
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">startTime</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();
        
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">invocation</span><span class="hljs-selector-class">.proceed</span>();
        } <span class="hljs-selector-tag">finally</span> {
            <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">costTime</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>() <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">startTime</span>;
            
            <span class="hljs-selector-tag">if</span> (costTime &gt; SLOW_SQL_THRESHOLD) {
                <span class="hljs-selector-tag">StatementHandler</span> <span class="hljs-selector-tag">handler</span> = (StatementHandler) <span class="hljs-selector-tag">invocation</span><span class="hljs-selector-class">.getTarget</span>();
                <span class="hljs-selector-tag">BoundSql</span> <span class="hljs-selector-tag">boundSql</span> = <span class="hljs-selector-tag">handler</span><span class="hljs-selector-class">.getBoundSql</span>();
                
                <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.warn</span>(<span class="hljs-string">"慢SQL检测 - 耗时: {}ms, SQL: {}, 参数: {}"</span>, 
                    costTime, boundSql.<span class="hljs-built_in">getSql</span>(), boundSql.<span class="hljs-built_in">getParameterObject</span>());
                
                <span class="hljs-comment">// 发送告警</span>
                <span class="hljs-selector-tag">alertSlowSql</span>(boundSql.<span class="hljs-built_in">getSql</span>(), costTime);
            }
        }
    }
}
<span class="hljs-selector-tag">AI</span>写代码<span class="hljs-selector-tag">java</span>
运行
</code></pre>
<h3 data-id="heading-31"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>9. 企业级最佳实践</h3>
<h4 data-id="heading-32"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>9.1 我的"整合配置军规"</h4>
<p>经过多年实践，我总结了一套最佳实践：</p>
<h5 data-id="heading-33">📜 第一条：明确数据源配置</h5>
<ul>
<li>生产环境必须用连接池（HikariCP）</li>
<li>根据实际负载调整连接数</li>
<li>开启监控和泄露检测</li>
</ul>
<h5 data-id="heading-34">📜 第二条：合理使用事务</h5>
<ul>
<li>事务要短小，不要在事务中做RPC调用</li>
<li>明确指定回滚异常类型</li>
<li>合理设置事务超时时间</li>
</ul>
<h5 data-id="heading-35">📜 第三条：监控到位</h5>
<ul>
<li>监控SQL执行时间</li>
<li>监控连接池使用情况</li>
<li>设置慢SQL告警</li>
</ul>
<h5 data-id="heading-36">📜 第四条：代码规范</h5>
<ul>
<li>Mapper接口要有@Repository或@Mapper注解</li>
<li>SQL写在XML中，复杂的用动态SQL</li>
<li>使用resultMap明确映射关系</li>
</ul>
<h5 data-id="heading-37">📜 第五条：测试充分</h5>
<ul>
<li>单元测试要覆盖事务场景</li>
<li>集成测试要验证多数据源</li>
<li>性能测试要模拟生产负载</li>
</ul>
<h4 data-id="heading-38"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>9.2 生产环境配置模板</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application-prod.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://${DB_HOST:localhost}:3306/${DB_NAME}?useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">${DB_USER}</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">${DB_PASSWORD}</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">pool-name:</span> <span class="hljs-string">HikariPool</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">20</span>
      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">5</span>
      <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">5000</span>
      <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
      <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
      <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">leak-detection-threshold:</span> <span class="hljs-number">30000</span>
      
<span class="hljs-attr">mybatis:</span>
  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mapper/**/*.xml</span>
  <span class="hljs-attr">type-aliases-package:</span> <span class="hljs-string">com.example.model</span>
  <span class="hljs-attr">configuration:</span>
    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">cache-enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">lazy-loading-enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">aggressive-lazy-loading:</span> <span class="hljs-literal">false</span>
    <span class="hljs-attr">default-statement-timeout:</span> <span class="hljs-number">30</span>
    
<span class="hljs-attr">management:</span>
  <span class="hljs-attr">endpoints:</span>
    <span class="hljs-attr">web:</span>
      <span class="hljs-attr">exposure:</span>
        <span class="hljs-attr">include:</span> <span class="hljs-string">health,metrics,prometheus</span>
  <span class="hljs-attr">metrics:</span>
    <span class="hljs-attr">export:</span>
      <span class="hljs-attr">prometheus:</span>
        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
<span class="hljs-string">AI写代码</span>
</code></pre>
<h3 data-id="heading-39"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>10. 故障排查指南</h3>
<h4 data-id="heading-40"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>10.1 常见问题排查清单</h4>
<h5 data-id="heading-41">问题1：事务不生效</h5>
<ol>
<li>检查是否配置了<code>@EnableTransactionManagement</code></li>
<li>检查方法是否是public</li>
<li>检查是否自调用</li>
<li>检查异常类型是否匹配</li>
</ol>
<h5 data-id="heading-42">问题2：连接泄露</h5>
<ol>
<li>检查是否在事务外使用了SqlSession</li>
<li>检查连接池配置</li>
<li>使用Druid的监控界面查看</li>
<li>检查是否有未关闭的ResultSet/Statement</li>
</ol>
<h5 data-id="heading-43">问题3：性能下降</h5>
<ol>
<li>检查SQL是否有全表扫描</li>
<li>检查是否缺少索引</li>
<li>检查连接池是否过小</li>
<li>检查是否有N+1查询问题</li>
</ol>
<h4 data-id="heading-44"><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/>10.2 调试技巧</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 开启MyBatis日志</span>
logging:
  level:
    com.example.mapper: DEBUG
    org.mybatis: DEBUG
    org.springframework.jdbc: DEBUG
 
<span class="hljs-comment">// 查看事务状态</span>
@Component
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TransactionDebug</span> {
    
    @Autowired
    <span class="hljs-keyword">private</span> PlatformTransactionManager transactionManager;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">debugTransaction</span>()</span> {
        TransactionStatus status = transactionManager.getTransaction(
            <span class="hljs-keyword">new</span> DefaultTransactionDefinition());
        
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"是否新事务: "</span> + status.isNewTransaction());
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"是否有保存点: "</span> + status.hasSavepoint());
        
        transactionManager.commit(status);
    }
}
AI写代码
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 vite-plugin-vue-devtools 实现 IDE 一键打开选中组件]]></title>    <link>https://juejin.cn/post/7600982613654028338</link>    <guid>https://juejin.cn/post/7600982613654028338</guid>    <pubDate>2026-01-30T16:33:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600982613654028338" data-draft-id="7600955777316339750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 vite-plugin-vue-devtools 实现 IDE 一键打开选中组件"/> <meta itemprop="keywords" content="前端,Vite"/> <meta itemprop="datePublished" content="2026-01-30T16:33:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LaLu"/> <meta itemprop="url" content="https://juejin.cn/user/739350236891191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 vite-plugin-vue-devtools 实现 IDE 一键打开选中组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/739350236891191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LaLu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T16:33:32.000Z" title="Fri Jan 30 2026 16:33:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用 vite-plugin-vue-devtools 实现 IDE 一键打开选中组件</h2>
<blockquote>
<p>在 Vue 项目开发中，快速定位组件源码是提升开发效率的关键。本文将介绍如何使用 <code>vite-plugin-vue-devtools</code> 插件，实现在浏览器中选中组件后一键在 IDE 中打开对应源码文件。</p>
</blockquote>
<h3 data-id="heading-1">一、背景与痛点</h3>
<p>大型 Vue 项目，我们经常会遇到以下场景：</p>
<ul>
<li>页面上有一个组件需要修改，但不知道它对应的源文件在哪里</li>
<li>项目组件层级很深，手动查找费时费力</li>
<li>新接手项目，对代码结构不熟悉</li>
</ul>
<p><strong>vite-plugin-vue-devtools</strong> 正是解决这个问题的利器。</p>
<h3 data-id="heading-2">二、vite-plugin-vue-devtools作用</h3>
<p><code>vite-plugin-vue-devtools</code> 是一个为 Vue 3 + Vite 项目设计的开发工具插件，它提供了：</p>
<ul>
<li>📍 <strong>组件检查器</strong>：在页面上悬停/点击组件，查看组件信息</li>
<li>🔗 <strong>一键跳转</strong>：点击组件直接在 IDE 中打开源码文件</li>
<li>📊 <strong>组件树可视化</strong>：查看组件的层级关系</li>
<li>🔧 <strong>状态调试</strong>：实时查看和修改组件状态</li>
<li>⚡ <strong>性能分析</strong>：分析组件渲染性能</li>
</ul>
<p>这里只做IDE跳转文件的分享</p>
<h3 data-id="heading-3">三、安装和配置</h3>
<h4 data-id="heading-4">3.1 安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm</span>
npm install vite-plugin-vue-devtools -D

<span class="hljs-comment"># yarn</span>
yarn add vite-plugin-vue-devtools -D

<span class="hljs-comment"># pnpm</span>
pnpm add vite-plugin-vue-devtools -D
</code></pre>
<h4 data-id="heading-5">3.2 配置 vite.config.js</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { fileURLToPath, <span class="hljs-variable constant_">URL</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>

<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueDevTools</span>  <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-vue-devtools'</span>

<span class="hljs-comment">// https://vite.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title class_">VueDevTools</span> ({
      <span class="hljs-attr">launchEditor</span>: <span class="hljs-string">'webstorm64'</span>, <span class="hljs-comment">//这里很关键，windows下看IDE安装目录的exe文件名</span>
    }),
  ],
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./src'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))
    },
  },
})
</code></pre>
<h4 data-id="heading-6">3.3 launchEditor 支持的编辑器</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyyx990803%2Flaunch-editor%3Ftab%3Dreadme-ov-file%23supported-editors" target="_blank" title="https://github.com/yyx990803/launch-editor?tab=readme-ov-file#supported-editors" ref="nofollow noopener noreferrer">github.com/yyx990803/l…</a></p>
<h3 data-id="heading-7">四、使用方法</h3>
<h4 data-id="heading-8">4.1 启动开发服务器</h4>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<p>启动后，你会在页面底部看到一个 Vue DevTools 的悬浮按钮，点击定位图标，就可以直接选中页面上的元素跳转IDE对应的文件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7d3d1ae094a4893b4dddb8683b77751~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGFMdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770395612&amp;x-signature=vq451iBiFliRHaJXFmTodrXKsOo%3D" alt="PixPin_2026-01-31_00-24-38.gif" loading="lazy"/></p>
<h3 data-id="heading-9">五、常见问题与解决方案</h3>
<h4 data-id="heading-10">5.1 点击组件后 IDE 没有反应</h4>
<p><strong>可能原因</strong>：</p>
<ol>
<li><code>launchEditor</code> 配置的编辑器名称不正确</li>
<li>编辑器没有加入系统环境变量</li>
</ol>
<p><strong>解决方案</strong>：</p>
<p>方案一：使用完整路径</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">VueDevTools</span>({
  <span class="hljs-attr">launchEditor</span>: <span class="hljs-string">'C:\\Program Files\\JetBrains\\WebStorm\\bin\\webstorm64.exe'</span>,
})
</code></pre>
<p>方案二：检查环境变量
确保在命令行中可以直接运行 webstorm64 或 code 命令，这个主要看IDE在bin目录下exe对应的文件名叫什么，例如我的文件名是webstorm64，配置里面就写的就是launchEditor: 'webstorm64'</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1252d6bd4454cf6a16fd656d8df711c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTGFMdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770395612&amp;x-signature=s8FK%2FQ1NuAtl4%2B65soc3B2FJ0Do%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-11">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fdevtools-next" target="_blank" title="https://github.com/vuejs/devtools-next" ref="nofollow noopener noreferrer">vite-plugin-vue-devtools GitHub</a></li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器缓存：从底层原理到最佳实践]]></title>    <link>https://juejin.cn/post/7601028900886265902</link>    <guid>https://juejin.cn/post/7601028900886265902</guid>    <pubDate>2026-01-30T23:29:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7601028900886265902" data-draft-id="7601169987395321907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器缓存：从底层原理到最佳实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T23:29:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器缓存：从底层原理到最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T23:29:46.000Z" title="Fri Jan 30 2026 23:29:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>缓存是前端性能优化的核心，但我们真的理解各种缓存之间的关系吗？本篇文章将彻底解析浏览器缓存机制，帮我们建立完整的知识体系。</p>
</blockquote>
<h2 data-id="heading-0">缓存全景图：一张图看懂所有缓存关系</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/945540c1c7194db1ae267ecc305c764c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3VoZW5fbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770420589&amp;x-signature=aY%2Bq3L4eLvFbDdyiDHGySAUDNHQ%3D" alt="缓存全景图" loading="lazy"/></p>
<h2 data-id="heading-1">HTTP缓存：强缓存 vs 协商缓存</h2>
<p>HTTP缓存是浏览器缓存体系的核心，分为两大策略：<strong>强缓存</strong> 和 <strong>协商缓存</strong>。</p>
<h3 data-id="heading-2">强缓存：浏览器自主决策</h3>
<p>浏览器检查本地缓存是否在有效期内，若有效则直接使用，不发送任何网络请求。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第一次请求：服务器设置缓存策略</span>
GET /static/logo.png
HTTP/1.1 200 OK
Cache-Control: max-age=31536000, public
Expires: Mon, 01 Jan 2024 00:00:00 GMT

<span class="hljs-comment"># 后续请求：浏览器自主决策（在有效期内）</span>
GET /static/logo.png
<span class="hljs-comment"># 浏览器检查：max-age=31536000 → 还有效！</span>
<span class="hljs-comment"># 直接从缓存返回，不发送网络请求</span>
</code></pre>
<h3 data-id="heading-3">协商缓存：服务端验证</h3>
<p>当请求资源时，浏览器携带缓存标识询问服务器资源是否变更，若没有变更，直接从缓存中读取资源。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第一次请求：服务器返回资源标识</span>
GET /api/user/profile
HTTP/1.1 200 OK
ETag: <span class="hljs-string">"abc123xyz"</span>
Last-Modified: Wed, 21 Oct 2022 07:28:00 GMT
Cache-Control: no-cache

<span class="hljs-comment"># 第二次请求：带上标识询问服务器</span>
GET /api/user/profile
If-None-Match: <span class="hljs-string">"abc123xyz"</span>
If-Modified-Since: Wed, 21 Oct 2022 07:28:00 GMT

<span class="hljs-comment"># 服务器响应</span>
HTTP/1.1 304 Not Modified
<span class="hljs-comment"># 资源未变，使用本地缓存</span>
</code></pre>
<h3 data-id="heading-4">强缓存 vs 协商缓存对比：</h3>













































<table><thead><tr><th>特性</th><th>强缓存</th><th>协商缓存</th></tr></thead><tbody><tr><td>决策机制</td><td>浏览器自己决定</td><td>浏览器和服务器协商</td></tr><tr><td>检查时机</td><td>优先检查</td><td>强缓存失效后检查</td></tr><tr><td>网络请求</td><td>可能完全不发请求</td><td>一定发送请求（验证）</td></tr><tr><td>典型状态码</td><td>200 (from cache)</td><td>304 (Not Modified)</td></tr><tr><td>响应速度</td><td>极快（直接本地读取）</td><td>较慢（需要网络往返）</td></tr><tr><td>适用场景</td><td>版本固定的静态资源</td><td>频繁更新的动态资源</td></tr><tr><td>更新时机</td><td>缓存过期时更新</td><td>每次请求都验证</td></tr></tbody></table>
<h2 data-id="heading-5">浏览器缓存：Memory Cache vs Disk Cache</h2>
<h3 data-id="heading-6">Memory Cache：高速内存缓存</h3>
<ul>
<li>位置：浏览器进程内存空间</li>
<li>容量：有限，依赖设备内存</li>
<li>生命周期：会话级别，标签页关闭则释放</li>
<li>特点：读取速度极快（纳秒级）</li>
</ul>
<h4 data-id="heading-7">适用场景</h4>
<ul>
<li>当前页面已加载的资源</li>
<li>预加载的脚本和样式</li>
<li>小体积的Base64图片</li>
</ul>
<h3 data-id="heading-8">Disk Cache：持久化磁盘缓存</h3>
<ul>
<li>位置：用户磁盘的缓存目录</li>
<li>容量：较大（通常数百MB到数GB）</li>
<li>生命周期：长期持久化</li>
<li>特点：读取速度较慢（毫秒级），但容量大</li>
</ul>
<h4 data-id="heading-9">适用场景</h4>
<ul>
<li>大体积静态资源（图片、字体、视频）</li>
<li>跨会话共享的资源</li>
<li>低频访问但需要持久化的内容</li>
</ul>
<h2 data-id="heading-10">Service Worker：应用层缓存控制</h2>
<p><code>Service Worker</code> 运行在浏览器后台，作为<strong>代理服务器</strong>，赋予开发者完全控制缓存的能力。</p>
<h3 data-id="heading-11">Service Worker 缓存特点</h3>
<ol>
<li>独立线程运行，不阻塞主线程</li>
<li>完全控制网络请求，可自定义缓存策略</li>
<li>支持离线体验，是PWA的核心技术</li>
<li>生命周期独立，可长期缓存资源</li>
</ol>
<h3 data-id="heading-12">Service Worker 缓存策略</h3>
<p>Service Worker 使用的是典型的缓存优先策略：</p>
<pre><code class="hljs language-javascript" lang="javascript">self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
  event.<span class="hljs-title function_">respondWith</span>(
    caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cachedResponse</span> =&gt;</span> {
        <span class="hljs-comment">// 1. 缓存优先</span>
        <span class="hljs-keyword">if</span> (cachedResponse) {
          <span class="hljs-comment">// 后台更新缓存</span>
          event.<span class="hljs-title function_">waitUntil</span>(
            <span class="hljs-title function_">updateCache</span>(event.<span class="hljs-property">request</span>)
          );
          <span class="hljs-keyword">return</span> cachedResponse;
        }
        
        <span class="hljs-comment">// 2. 网络回退</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>)
          .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">networkResponse</span> =&gt;</span> {
            <span class="hljs-comment">// 缓存新资源</span>
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">cacheResponse</span>(event.<span class="hljs-property">request</span>, networkResponse);
          })
          .<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 3. 回退到离线页面</span>
            <span class="hljs-keyword">return</span> caches.<span class="hljs-title function_">match</span>(<span class="hljs-string">'/offline.html'</span>);
          });
      })
  );
});
</code></pre>
<h3 data-id="heading-13">Service Worker 使用场景</h3>






























<table><thead><tr><th>场景</th><th>策略</th><th>优势</th></tr></thead><tbody><tr><td>离线应用</td><td>Cache-First + Network-Fallback</td><td>提供完整的离线体验</td></tr><tr><td>性能优化</td><td>Stale-While-Revalidate</td><td>快速响应+后台更新</td></tr><tr><td>资源预加载</td><td>Precache + Runtime Caching</td><td>减少关键资源加载时间</td></tr><tr><td>不可靠网络</td><td>Network-First + Cache-Fallback</td><td>提升弱网环境体验</td></tr></tbody></table>
<h2 data-id="heading-14">缓存查找顺序</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchWithCache</span>(<span class="hljs-params">request</span>) {
  <span class="hljs-comment">// 1. Service Worker 拦截（最高优先级）</span>
  <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">serviceWorker</span>?.<span class="hljs-property">controller</span>) {
    <span class="hljs-keyword">const</span> swResponse = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkServiceWorkerCache</span>(request);
    <span class="hljs-keyword">if</span> (swResponse) <span class="hljs-keyword">return</span> swResponse;
  }
  
  <span class="hljs-comment">// 2. Memory Cache 检查（最快路径）</span>
  <span class="hljs-keyword">const</span> memoryCached = memoryCache.<span class="hljs-title function_">get</span>(request.<span class="hljs-property">url</span>);
  <span class="hljs-keyword">if</span> (memoryCached &amp;&amp; !<span class="hljs-title function_">isExpired</span>(memoryCached)) {
    <span class="hljs-title function_">reportCacheHit</span>(<span class="hljs-string">'memory'</span>);
    <span class="hljs-keyword">return</span> memoryCached;
  }
  
  <span class="hljs-comment">// 3. Disk Cache 检查（强缓存验证）</span>
  <span class="hljs-keyword">const</span> diskCached = <span class="hljs-keyword">await</span> <span class="hljs-title function_">checkDiskCache</span>(request);
  <span class="hljs-keyword">if</span> (diskCached) {
    <span class="hljs-keyword">if</span> (diskCached.<span class="hljs-property">cacheControl</span> === <span class="hljs-string">'immutable'</span> || 
        !<span class="hljs-title function_">isExpired</span>(diskCached)) {
      <span class="hljs-comment">// 更新 Memory Cache 提升后续访问速度</span>
      memoryCache.<span class="hljs-title function_">set</span>(request.<span class="hljs-property">url</span>, diskCached);
      <span class="hljs-title function_">reportCacheHit</span>(<span class="hljs-string">'disk'</span>);
      <span class="hljs-keyword">return</span> diskCached;
    }
  }
  
  <span class="hljs-comment">// 4. 准备网络请求（设置协商缓存头）</span>
  <span class="hljs-keyword">const</span> init = <span class="hljs-title function_">prepareRequest</span>(request);
  
  <span class="hljs-comment">// 5. 发起网络请求</span>
  <span class="hljs-keyword">let</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(request, init);
  
  <span class="hljs-comment">// 6. 处理响应，决定是否缓存</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">shouldCache</span>(response)) {
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">cacheInLayers</span>(request, response.<span class="hljs-title function_">clone</span>());
  }
  
  <span class="hljs-keyword">return</span> response;
}

</code></pre>
<blockquote>
<ul>
<li>强缓存资源：可以同时存在于Memory和Disk Cache，浏览器根据大小和类型智能分配</li>
<li>协商缓存资源：主要在Disk Cache，Memory Cache可能不存储或短期存储</li>
<li>开发者控制策略：通过HTTP头控制缓存策略，浏览器自动选择存储位置</li>
<li>性能考量：小文件强缓存 → Memory Cache极速；大文件强缓存 → Disk Cache持久</li>
</ul>
</blockquote>
<h2 data-id="heading-15">本地存储体系</h2>















































<table><thead><tr><th>存储类型</th><th>容量</th><th>生命周期</th><th>同步性</th><th>使用场景</th></tr></thead><tbody><tr><td>Cookie</td><td>4KB</td><td>可设置过期时间</td><td>每次请求自动携带</td><td>用户认证、服务端状态</td></tr><tr><td>LocalStorage</td><td>5-10MB</td><td>永久（除非手动清除）</td><td>同步阻塞</td><td>用户偏好、应用配置</td></tr><tr><td>SessionStorage</td><td>5-10MB</td><td>标签页关闭时清除</td><td>同步阻塞</td><td>表单草稿、临时状态</td></tr><tr><td>IndexedDB</td><td>数百MB</td><td>永久</td><td>异步非阻塞</td><td>大量结构化数据</td></tr><tr><td>Cache API</td><td>依赖设备</td><td>Service Worker控制</td><td>异步</td><td>网络资源缓存、PWA</td></tr></tbody></table>
<h2 data-id="heading-16">Chrome DevTools中的缓存标识</h2>
<p>在Chrome开发者工具中，不同缓存来源有不同的标识：</p>









































<table><thead><tr><th>Size列显示</th><th>状态码</th><th>含义</th><th>缓存来源</th></tr></thead><tbody><tr><td>(memory cache)</td><td>200</td><td>内存缓存</td><td>Memory Cache</td></tr><tr><td>(disk cache)</td><td>200</td><td>磁盘缓存</td><td>Disk Cache</td></tr><tr><td>(ServiceWorker)</td><td>200</td><td>Service Worker缓存</td><td>Service Worker Cache</td></tr><tr><td>文件大小</td><td>304</td><td>协商缓存生效</td><td>服务器验证通过</td></tr><tr><td>文件大小</td><td>200</td><td>新请求</td><td>网络获取</td></tr></tbody></table>
<h2 data-id="heading-17">现代框架下的缓存最佳实践</h2>
<h3 data-id="heading-18">Vue 3 + Vite 缓存配置</h3>
<p><code>vite.config.js</code> 中配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">build</span>: {
    <span class="hljs-comment">// 生成带hash的文件名，实现长期缓存</span>
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">entryFileNames</span>: <span class="hljs-string">'assets/[name]-[hash].js'</span>,
        <span class="hljs-attr">chunkFileNames</span>: <span class="hljs-string">'assets/[name]-[hash].js'</span>,
        <span class="hljs-attr">assetFileNames</span>: <span class="hljs-string">'assets/[name]-[hash].[ext]'</span>
      }
    }
  },
  
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-comment">// 开发环境：禁用缓存</span>
      <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'no-store'</span>
    }
  }
});
</code></pre>
<p>生产环境 <code>Nginx</code> 配置：</p>
<pre><code class="hljs language-bash" lang="bash">server {
    <span class="hljs-comment"># HTML文件：短缓存 + 协商缓存</span>
    location = /index.html {
        add_header Cache-Control <span class="hljs-string">"public, max-age=300, must-revalidate"</span>;
    }
    
    <span class="hljs-comment"># 带hash的静态资源：长期缓存 + 不可变</span>
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff2)$ {
        <span class="hljs-comment"># 匹配带hash的文件名</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_uri</span> ~* <span class="hljs-string">"\.([0-9a-f]{8,})\.(js|css|png|jpg|jpeg|gif|ico|svg|woff2)$"</span>) {
            add_header Cache-Control <span class="hljs-string">"public, max-age=31536000, immutable"</span>;
        }
        <span class="hljs-comment"># 无hash的资源使用协商缓存</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$request_uri</span> !~* <span class="hljs-string">"\.([0-9a-f]{8,})\.(js|css|png|jpg|jpeg|gif|ico|svg|woff2)$"</span>) {
            add_header Cache-Control <span class="hljs-string">"public, max-age=604800, must-revalidate"</span>;
        }
    }
    
    <span class="hljs-comment"># API请求：不缓存或短缓存</span>
    location /api/ {
        add_header Cache-Control <span class="hljs-string">"no-store, no-cache, must-revalidate"</span>;
        proxy_pass http://api-backend;
    }
}
</code></pre>
<h3 data-id="heading-19">React 缓存策略建议</h3>
<p>使用 <code>React Query</code> 进行数据缓存管理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useQuery, <span class="hljs-title class_">QueryClient</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@tanstack/react-query'</span>;

<span class="hljs-keyword">const</span> queryClient = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryClient</span>({
  <span class="hljs-attr">defaultOptions</span>: {
    <span class="hljs-attr">queries</span>: {
      <span class="hljs-attr">staleTime</span>: <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 5分钟</span>
      <span class="hljs-attr">cacheTime</span>: <span class="hljs-number">10</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 10分钟</span>
      <span class="hljs-attr">retry</span>: <span class="hljs-number">1</span>,
    },
  },
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ userId }</span>) {
  <span class="hljs-keyword">const</span> { data, isLoading } = <span class="hljs-title function_">useQuery</span>({
    <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">'user'</span>, userId],
    <span class="hljs-attr">queryFn</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchUser</span>(userId),
    <span class="hljs-comment">// 根据用户交互决定缓存策略</span>
    <span class="hljs-attr">cacheTime</span>: userId ? <span class="hljs-number">15</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> : <span class="hljs-number">0</span>, <span class="hljs-comment">// 登录用户缓存15分钟</span>
  });
  
  <span class="hljs-comment">// 预加载相关数据</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">prefetchPosts</span> = (<span class="hljs-params"/>) =&gt; {
    queryClient.<span class="hljs-title function_">prefetchQuery</span>({
      <span class="hljs-attr">queryKey</span>: [<span class="hljs-string">'posts'</span>, userId],
      <span class="hljs-attr">queryFn</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchUserPosts</span>(userId),
    });
  };
}
</code></pre>
<h2 data-id="heading-20">常见问题与解决方案</h2>
<h3 data-id="heading-21">用户反映看到的是旧版本页面</h3>
<p>原因：HTML文件被缓存，导致加载的是旧版本的静态资源引用。
解决方案：在nginx中配置合理的缓存策略：</p>
<pre><code class="hljs language-bash" lang="bash">location / {
    <span class="hljs-comment"># HTML文件：短时间缓存 + 协商缓存</span>
    add_header Cache-Control <span class="hljs-string">"public, max-age=300, must-revalidate"</span>;
}

location /assets/ {
    <span class="hljs-comment"># 静态资源：长时间缓存 + 文件hash</span>
    add_header Cache-Control <span class="hljs-string">"public, max-age=31536000, immutable"</span>;
}
</code></pre>
<h3 data-id="heading-22">如何优雅地清除缓存？</h3>
<p><code>vite/webpack</code> 会自动生成文件hash，以此进行清除。</p>
<h2 data-id="heading-23">缓存最佳实践总结</h2>















































<table><thead><tr><th>资源类型</th><th>推荐策略</th><th>缓存时间</th><th>更新机制</th></tr></thead><tbody><tr><td>HTML入口文件</td><td>协商缓存</td><td>短时间（5分钟）</td><td>内容hash或版本号</td></tr><tr><td>JS/CSS（带hash）</td><td>强缓存</td><td>长期（1年）</td><td>文件名hash变更</td></tr><tr><td>图片/字体</td><td>强缓存</td><td>中期（1个月）</td><td>URL变更或版本控制</td></tr><tr><td>API数据（列表）</td><td>内存缓存</td><td>短期（1-5分钟）</td><td>时间过期或主动失效</td></tr><tr><td>用户偏好配置</td><td>LocalStorage</td><td>永久</td><td>用户操作触发更新</td></tr><tr><td>离线资源</td><td>Service Worker</td><td>长期</td><td>版本化预缓存</td></tr></tbody></table>
<h2 data-id="heading-24">未来趋势</h2>
<ul>
<li>HTTP/3的缓存改进：更智能的缓存协商机制</li>
<li>AI驱动的缓存策略：根据用户行为预测缓存需求</li>
<li>边缘计算缓存：CDN与浏览器缓存的深度融合</li>
<li>隐私保护的缓存：沙盒化缓存防止指纹追踪</li>
</ul>
<h2 data-id="heading-25">结语</h2>
<p>浏览器缓存是一个多层次的复杂系统，理解各层缓存的工作原理、生命周期和适用场景是进行有效缓存管理的关键，对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>