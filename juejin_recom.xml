<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理]]></title>    <link>https://juejin.cn/post/7585798113547829298</link>    <guid>https://juejin.cn/post/7585798113547829298</guid>    <pubDate>2025-12-22T02:14:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585798113547829298" data-draft-id="7450771973871091724" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理"/> <meta itemprop="keywords" content="Node.js,前端"/> <meta itemprop="datePublished" content="2025-12-22T02:14:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="孟祥_成都"/> <meta itemprop="url" content="https://juejin.cn/user/96412752684744"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nest.js / hono.js 一起学！日志功能/统一返回格式/错误处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/96412752684744/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    孟祥_成都
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:14:42.000Z" title="Mon Dec 22 2025 02:14:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在继续搭建 <strong>NestJS</strong> 和 <strong>Hono.js</strong> 的通用框架之前，可以先回顾一下前几篇文章：</p>
<ul>
<li><a href="https://juejin.cn/post/7576555431943503882" target="_blank" title="https://juejin.cn/post/7576555431943503882">深入 NestJS 底层概念（1）：依赖注入和面向切面编程 AOP</a></li>
<li><a href="https://juejin.cn/post/7580564126403362866" target="_blank" title="https://juejin.cn/post/7580564126403362866">NestJS / Hono.js 一起学！Hono 的设计思想</a></li>
<li><a href="https://juejin.cn/post/7581448482544713754" target="_blank" title="https://juejin.cn/post/7581448482544713754">NestJS / Hono.js 一起学！开发前必备</a></li>
<li><a href="https://juejin.cn/post/7583727768543199268" target="_blank" title="https://juejin.cn/post/7583727768543199268">NestJS / Hono.js 一起学！字节团队如何配置多环境攻略</a></li>
</ul>
<p>本篇文章主要实现 <strong>NestJS 与 Hono.js</strong> 的以下功能：</p>
<ol>
<li><strong>打印日志 &amp; 收集日志</strong></li>
<li><strong>统一返回前端的数据格式</strong></li>
<li><strong>统一错误处理</strong></li>
</ol>
<p>这些功能在很多 NestJS 教程中都有覆盖，但我们会在此基础上做一些增强：</p>
<ul>
<li>
<p><strong>日志打印增加 <code>traceId</code> 功能</strong></p>
<ul>
<li>在 Node.js 高并发场景下，<strong>每个请求的 traceId 必须独立</strong>，因为它是<strong>单线程异步</strong>模型，如果我们像写传统同步代码那样直接定义一个全局变量来存 <code>traceId</code>，就会发生严重的“串号”现象。</li>
</ul>
</li>
</ul>
<p><strong>案例：</strong></p>
<p>假设我们有一个 Web 服务，同时收到两个用户请求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> traceId; <span class="hljs-comment">// 全局变量</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRequest</span>(<span class="hljs-params">user</span>) {
  traceId = <span class="hljs-string">`trace-<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">1000</span>)}</span>`</span>; <span class="hljs-comment">// 给当前请求生成 traceId</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${traceId}</span>] 开始处理 <span class="hljs-subst">${user}</span> 的请求`</span>);

  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 异步操作，可能晚于其他请求执行</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[<span class="hljs-subst">${traceId}</span>] 完成处理 <span class="hljs-subst">${user}</span> 的请求`</span>);
  }, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">1000</span>);
}

<span class="hljs-comment">// 模拟两个用户几乎同时发起请求</span>
<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'Alice'</span>);
<span class="hljs-title function_">handleRequest</span>(<span class="hljs-string">'Bob'</span>);
</code></pre>
<p><strong>可能的输出（串号）</strong> ：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">trace-532</span>] 开始处理 Alice 的请求
[<span class="hljs-meta">trace-764</span>] 开始处理 Bob 的请求
[<span class="hljs-meta">trace-764</span>] 完成处理 Alice 的请求   ← 错误，日志 traceId 被覆盖，因为全局目前的 traceId 已经是 trace<span class="hljs-number">-764</span> 了
[<span class="hljs-meta">trace-764</span>] 完成处理 Bob 的请求
</code></pre>
<p>以上的问题有些笨办法可以处理，但我们最终会借助 node.js AsyncLocalStorage（在 nest.js 有对应模块，简单实现，在 hono.js 中我们自己封装一个类似功能的模块。）</p>
<p>还有一个必须了解的，这个 traceId 是服务端必须有的，因为我们的处理一个用户请求会经过很多中间件很多不同的模块处理，如何判断经过这么多模块的某个请求是同一个请求，就要用这个 traceId 来记录。</p>
<ul>
<li>
<p><strong>统一返回前端的数据格式</strong>，例如，我们希望所有接口返回：</p>
<pre><code class="hljs language-css" lang="css">```
{
  "<span class="hljs-selector-tag">code</span>": <span class="hljs-number">0</span>,
  <span class="hljs-string">"data"</span>: {...},
  "message": <span class="hljs-string">"success"</span>
}
```
</code></pre>
<ul>
<li><strong>可选配置</strong>：某些路由可以跳过统一格式返回。</li>
</ul>
</li>
</ul>
<hr/>
<p>接下来，我们将先从 nest.js 框架开始，逐步实现这些功能。</p>
<h2 data-id="heading-1">nest.js 配置</h2>
<h3 data-id="heading-2">链路日志追踪功能</h3>
<p>这套系统的灵魂在于 <code>nestjs-cls</code> 和 <code>Winston</code> 的结合。</p>
<p>为什么要这么做？</p>
<p>在 Node.js 异步环境中，传统的全局变量无法区分哪个日志属于哪个用户请求。</p>
<ul>
<li><strong>ClsModule (上下文存储)</strong> ：就像给每个进站的乘客（请求）发一个专属的“透明信封”。这个信封里装着 <code>traceId</code>。</li>
<li><strong>Winston (记录员)</strong> ：当程序需要记录日志时，记录员会从这个“信封”里掏出 <code>traceId</code> 盖在日志条目上。</li>
</ul>
<p>这样，即便服务器同时处理 1000 个请求，你只需要在日志里搜索特定的 <code>traceId</code>，就能看到该请求从“进入”到“报错”的所有心路历程。</p>
<hr/>
<h3 data-id="heading-3">代码功能深度拆解</h3>
<p>我们将代码逻辑分为三个核心模块来理解：</p>
<h4 data-id="heading-4">第一部分：CLS 上下文初始化 (AppModule)</h4>
<p>这是全链路追踪的起点。在根 module 配置，也就是 app.module.ts中增加：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span>, <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">'crypto'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-comment">// 之前文章讲的环境变量配置模块</span>
    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 全局可用，无需在每个模块导入</span>
      <span class="hljs-attr">load</span>: [initConfig], <span class="hljs-comment">// 使用自定义加载器</span>
    }),
    <span class="hljs-comment">// 1. 初始化 CLS 上下文，并自动生成 traceId</span>
    <span class="hljs-title class_">ClsModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">global</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">middleware</span>: {
        <span class="hljs-attr">mount</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">generateId</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">idGenerator</span>: <span class="hljs-function">(<span class="hljs-params">req: <span class="hljs-built_in">any</span></span>) =&gt;</span>
          (req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-request-id'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>) ?? <span class="hljs-title function_">randomUUID</span>(), <span class="hljs-comment">// 优先使用 header 中的 ID</span>
      },
    }),
  ],
  <span class="hljs-attr">controllers</span>: [],
  <span class="hljs-attr">providers</span>: [],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}

</code></pre>
<p>通过优先读取 <code>x-request-id</code>，我们可以实现跨系统的全链路追踪（如果你的前端或上游网关也带了这个 ID，就能实现真正的端到端打通）。</p>
<p>这里我们简单说下 ClsModule 实现的基本原理：</p>
<p>我们分三步来实现：</p>
<ul>
<li>第一步：封装 ALS 工具类</li>
</ul>
<p>这是我们的“储物柜”管理器。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// cls.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncLocalStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'async_hooks'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClsService</span> {
  <span class="hljs-comment">// 1. 创建一个物理存储对象</span>
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> storage = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncLocalStorage</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;&gt;();

  <span class="hljs-comment">// 2. 启动上下文（包裹请求）</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">callback: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">run</span>(store, callback);
  }

  <span class="hljs-comment">// 3. 存储数据</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">set</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span>, value: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">getStore</span>();
    <span class="hljs-keyword">if</span> (store) store.<span class="hljs-title function_">set</span>(key, value);
  }

  <span class="hljs-comment">// 4. 获取数据</span>
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">get</span>(<span class="hljs-params">key: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">const</span> store = <span class="hljs-variable language_">this</span>.<span class="hljs-property">storage</span>.<span class="hljs-title function_">getStore</span>();
    <span class="hljs-keyword">return</span> store?.<span class="hljs-title function_">get</span>(key);
  }
}
</code></pre>
<ul>
<li>编写中间件 (Middleware)</li>
</ul>
<p>在 NestJS 中，中间件是请求进来的第一站，我们在这里“开启”储物柜。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// cls.middleware.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">NestMiddleware</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">'crypto'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./cls.service'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyClsMiddleware</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestMiddleware</span> {
  <span class="hljs-title function_">use</span>(<span class="hljs-params">req: <span class="hljs-built_in">any</span>, res: <span class="hljs-built_in">any</span>, next: () =&gt; <span class="hljs-built_in">void</span></span>) {
    <span class="hljs-comment">// 关键点：将后续所有的逻辑（next）都运行在 MyClsService.run 的回调里</span>
    <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">run</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> traceId = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-request-id'</span>] || <span class="hljs-title function_">randomUUID</span>();
      <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'traceId'</span>, traceId); <span class="hljs-comment">// 存入 traceId</span>
      <span class="hljs-title function_">next</span>();
    });
  }
}
</code></pre>
<p>这个中间件添加之后，意味着所有的请求都会有一个 traceId 值，那在其它地方如何调用呢？请看</p>
<ul>
<li>第三步：在任何地方使用</li>
</ul>
<p>由于 <code>AsyncLocalStorage</code> 跟踪的是异步调用栈，你不再需要通过参数传递 <code>traceId</code>。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// any.service.ts</span>
<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnyService</span> {
  <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 像变魔术一样，直接拿！</span>
    <span class="hljs-keyword">const</span> traceId = <span class="hljs-title class_">MyClsService</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'traceId'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[当前任务] TraceID 是: <span class="hljs-subst">${traceId}</span>`</span>);
  }
}
</code></pre>
<p>我们接着讲日志功能，</p>
<h3 data-id="heading-5">第二部分：Winston 动态工厂 (common/logger)</h3>
<p>这里体现了<strong>环境差异化处理</strong>的思想。</p>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>开发环境 (Development)</strong></th><th><strong>生产环境 (Production)</strong></th></tr></thead><tbody><tr><td><strong>输出目标</strong></td><td>只有控制台 (Console)</td><td>控制台 + 每日滚动文件 (Daily File)</td></tr><tr><td><strong>展示样式</strong></td><td>漂亮的彩色、缩进、Nest 风格</td><td>严谨的 JSON 格式（方便日志分析系统 ELK 抓取）</td></tr><tr><td><strong>日志保留</strong></td><td>随启随看</td><td>保留 14 天，单文件 20MB（防止硬盘爆掉）</td></tr></tbody></table>
<h3 data-id="heading-6">第三部分：异步注入 (WinstonModule.forRootAsync)</h3>
<p>这是 NestJS 的高级用法，确保日志配置是在获取到系统配置（ConfigService）之后才生成的。</p>
<p>在 app.module.ts 中增加 winston配置</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WinstonModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nest-winston'</span>;
<span class="hljs-keyword">import</span> { winstonConfigFactory } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common/logger'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
     <span class="hljs-comment">// ... 其它配置</span>
    <span class="hljs-comment">// 2. 注入 Winston</span>
    <span class="hljs-comment">// 3. 使用 forRootAsync 异步加载配置</span>
    <span class="hljs-title class_">WinstonModule</span>.<span class="hljs-title function_">forRootAsync</span>({
      <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">ConfigModule</span>], <span class="hljs-comment">// 导入 ConfigModule 以便使用 ConfigService</span>
      <span class="hljs-attr">inject</span>: [<span class="hljs-title class_">ConfigService</span>], <span class="hljs-comment">// 注入 ConfigService</span>
      <span class="hljs-attr">useFactory</span>: <span class="hljs-function">(<span class="hljs-params">configService: ConfigService</span>) =&gt;</span> {
        <span class="hljs-comment">// 调用我们抽离出去的配置函数</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">winstonConfigFactory</span>(configService);
      },
    }),
  ],
  <span class="hljs-attr">controllers</span>: [],
  <span class="hljs-attr">providers</span>: [],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}

</code></pre>
<p>其中  winstonConfigFactory 的代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> winston, { transports, format } <span class="hljs-keyword">from</span> <span class="hljs-string">'winston'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'winston-daily-rotate-file'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { utilities <span class="hljs-keyword">as</span> nestWinstonModuleUtilities } <span class="hljs-keyword">from</span> <span class="hljs-string">'nest-winston'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsServiceManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">DEFAULT_LOG_DIR</span>, <span class="hljs-variable constant_">DIR_NAME</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'src/config/constants'</span>;

<span class="hljs-comment">// 保持之前的 format 定义不变</span>
<span class="hljs-keyword">const</span> appendRequestId = <span class="hljs-title function_">format</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> cls = <span class="hljs-title class_">ClsServiceManager</span>.<span class="hljs-title function_">getClsService</span>();
  <span class="hljs-keyword">const</span> traceId = cls?.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-string">'traceId'</span>);
  <span class="hljs-keyword">if</span> (traceId) {
    info.<span class="hljs-property">traceId</span> = traceId;
  }
  <span class="hljs-keyword">return</span> info;
});

<span class="hljs-comment">// 核心修改：导出一个 Factory 函数，而不是静态对象</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">winstonConfigFactory</span> = (<span class="hljs-params">configService: ConfigService</span>) =&gt; {
  <span class="hljs-comment">// 1. 从 ConfigService 获取配置，提供默认值</span>
  <span class="hljs-keyword">const</span> logDir = configService.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-variable constant_">DIR_NAME</span>, <span class="hljs-variable constant_">DEFAULT_LOG_DIR</span>);
  <span class="hljs-keyword">const</span> isProduction = configService.<span class="hljs-property">get</span>&lt;string&gt;(<span class="hljs-string">'NODE_ENV'</span>) === <span class="hljs-string">'production'</span>;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">transports</span>: isProduction
      ? [
          <span class="hljs-comment">// 2. 定义 DailyRotateFile (使用动态路径)</span>
          <span class="hljs-comment">// 错误日志按天滚动，保留 14 天，每个文件最大 20MB</span>
          <span class="hljs-comment">// 仍然把错误打印到控制台（k8s / docker 日志）</span>
          <span class="hljs-keyword">new</span> winston.<span class="hljs-property">transports</span>.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-attr">format</span>: winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">combine</span>(
              winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">colorize</span>(),
              winston.<span class="hljs-property">format</span>.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">info: any</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> trace = info.<span class="hljs-property">traceId</span> ? <span class="hljs-string">` [trace:<span class="hljs-subst">${info.traceId}</span>]`</span> : <span class="hljs-string">''</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${info.timestamp}</span> <span class="hljs-subst">${info.level}</span><span class="hljs-subst">${trace}</span>: <span class="hljs-subst">${info.message}</span>`</span>;
              }),
            ),
          }),
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">DailyRotateFile</span>({
            <span class="hljs-attr">dirname</span>: logDir, <span class="hljs-comment">// &lt;--- 这里使用了配置中的路径</span>
            <span class="hljs-attr">filename</span>: <span class="hljs-string">'error-%DATE%.log'</span>,
            <span class="hljs-attr">datePattern</span>: <span class="hljs-string">'YYYY-MM-DD'</span>,
            <span class="hljs-attr">maxSize</span>: <span class="hljs-string">'20m'</span>,
            <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">'14d'</span>,
            <span class="hljs-attr">level</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              <span class="hljs-title function_">appendRequestId</span>(),
              format.<span class="hljs-title function_">timestamp</span>(),
              format.<span class="hljs-title function_">json</span>(),
            ),
          }),
        ]
      : [
          <span class="hljs-comment">// 3. 定义 Console Transport</span>
          <span class="hljs-comment">// 开发环境通常只需要 Console，也可以按需加 File</span>
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">'info'</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              format.<span class="hljs-title function_">timestamp</span>(),
              nestWinstonModuleUtilities.<span class="hljs-property">format</span>.<span class="hljs-title function_">nestLike</span>(<span class="hljs-string">'MyApp'</span>, {
                <span class="hljs-attr">colors</span>: <span class="hljs-literal">true</span>,
                <span class="hljs-attr">prettyPrint</span>: <span class="hljs-literal">true</span>,
              }),
            ),
          }),
        ],
  };
};
</code></pre>
<p>注意，上面的例子，我们后续例如单机使用 docker-compose 部署也好，还是使用k8s/k3s部署也好，就不需要使用winston本身的 DailyRotateFile 功能了，可以借助 docker 或者 k8s/k3s 本身的日志轮转功能实现</p>
<p>为了让这套系统更完美，在实际应用中，你可以这样使用：</p>
<h3 data-id="heading-7">如何在 Service 中打印带 TraceId 的日志？</h3>
<p>这里使用 <code>this.logger.log</code> 的时候，你不需要手动去取 ID，因为我们在 <code>winstonConfigFactory</code> 里的 <code>appendRequestId</code> 已经自动处理了。所以会自带 traceId 属性在日志里。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Logger</span>, <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> logger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-title class_">AppService</span>.<span class="hljs-property">name</span>);

  <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这是一条带有 traceId 的业务日志！'</span>); 
    <span class="hljs-comment">// 输出结果会自动带上: {"traceId":"...", "message":"...", "timestamp":"..."}</span>
  }
}
</code></pre>
<p>接下来实现第二个功能，将返回前端的格式统一</p>
<h3 data-id="heading-8">统一返回格式</h3>
<p>统一格式，在 nest.js 中有拦截器实现（hono.js就没有拦截器的概念），很简单：</p>
<h4 data-id="heading-9">nest.js 统一返回格式：用拦截器实现标准响应结构</h4>
<p>在前后端分离的业务架构中，<strong>统一接口返回格式</strong>已成为标配：<br/>
无论后端返回什么，都应该在一层标准的格式中输出，例如：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {...},
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"xxx"</span>
}
</code></pre>
<p>这样做有几个直接收益：</p>
<ol>
<li>前端更容易做异常和展示逻辑，不需要每个接口单独处理。</li>
<li>服务端可以统一标记 traceId，方便链路排查问题。</li>
<li>协议一致后，可快速扩展错误码体系。</li>
</ol>
<p>在 nest.js 中，我们可以使用 <strong>Interceptors（拦截器）</strong> 来完成这一目标。下面是一段完整的拦截器代码。</p>
<h4 data-id="heading-10">拦截器核心代码示例</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Injectable</span>,
  <span class="hljs-title class_">NestInterceptor</span>,
  <span class="hljs-title class_">ExecutionContext</span>,
  <span class="hljs-title class_">CallHandler</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { map } <span class="hljs-keyword">from</span> <span class="hljs-string">'rxjs/operators'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ErrorCodes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../constants'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StandardResponse</span>&lt;T&gt; {
  <span class="hljs-attr">code</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">data</span>: T;
  traceId?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StandardResponseInterceptor</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NestInterceptor</span>&lt;
  T,
  <span class="hljs-title class_">StandardResponse</span>&lt;T&gt;
&gt; {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> cls: ClsService</span>) {}

  <span class="hljs-title function_">intercept</span>(<span class="hljs-params">context: ExecutionContext, next: CallHandler</span>) {
    <span class="hljs-keyword">if</span> (context.<span class="hljs-title function_">getType</span>() !== <span class="hljs-string">'http'</span>) {
      <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>();
    }

    <span class="hljs-keyword">const</span> handler = context.<span class="hljs-title function_">getHandler</span>();
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">getMetadata</span>(<span class="hljs-string">'skip_transform'</span>, handler)) {
      <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>();
    }

    <span class="hljs-keyword">const</span> traceId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cls</span>.<span class="hljs-title function_">getId</span>();

    <span class="hljs-keyword">return</span> next.<span class="hljs-title function_">handle</span>().<span class="hljs-title function_">pipe</span>(
      <span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> ({
        <span class="hljs-attr">code</span>: <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">SUCCESS</span>,
        <span class="hljs-attr">message</span>: <span class="hljs-string">'OK'</span>,
        data,
        traceId,
      })),
    );
  }
}
</code></pre>
<p>说明：</p>
<ul>
<li>ClsService 用于获取当前请求的 traceId</li>
<li>map() 包裹所有返回内容</li>
<li>拦截器只在 HTTP 请求上执行（GraphQL、Microservice 可以忽略）</li>
<li>可通过自定义 Decorator 跳过包装</li>
</ul>
<h4 data-id="heading-11">如何注册拦截器（全局启用）</h4>
<p>在 <code>main.ts</code> 中：</p>
<pre><code class="hljs language-typescript" lang="typescript">app.<span class="hljs-title function_">useGlobalInterceptors</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardResponseInterceptor</span>(app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ClsService</span>)));
</code></pre>
<p>这样所有路由默认都统一格式输出。</p>
<h4 data-id="heading-12">某些接口不想被统一格式怎么办？</h4>
<p>例如导出文件等特殊接口，不希望包裹。</p>
<p>你可以加自定义装饰器：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">'reflect-metadata'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">SkipTransform</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title class_">SetMetadata</span>(<span class="hljs-string">'skip_transform'</span>, <span class="hljs-literal">true</span>);
</code></pre>
<p>使用方式：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Get</span>(<span class="hljs-string">'upload'</span>)
<span class="hljs-meta">@SkipTransform</span>()
<span class="hljs-title function_">getCaptcha</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> someRawBinary;
}
</code></pre>
<p>当前路由会跳过统一包裹。</p>
<h4 data-id="heading-13">实际效果展示</h4>
<p>原本控制器返回：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Get</span>(<span class="hljs-string">'user'</span>)
<span class="hljs-title function_">getUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'Tom'</span> };
}
</code></pre>
<p>最终前端收到：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Tom"</span>
  },
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"abc-123-xyz"</span>
}
</code></pre>
<h2 data-id="heading-14">通用错误处理</h2>
<p>在后端系统中，错误处理往往经历三个阶段：</p>
<ol>
<li>能跑（框架兜底）</li>
<li>能返回（让前端知道错哪里）</li>
<li>能排障（日志链路、定位效率）</li>
</ol>
<p>nestjs 的 <code>ExceptionFilter</code> 为第三阶段提供了完整治理能力。本节通过自定义 <code>AllExceptionsFilter</code>，从“拦截错误”开始，一层层增强错误输出、业务语义、日志能力和 traceId 支持。</p>
<h3 data-id="heading-15">第一层：拦截所有异常，而不是依赖框架默认行为</h3>
<p>默认情况下，框架会尝试处理异常，但格式、内容和处理方式不可控。<br/>
通过 <code>@Catch()</code> 拦截全场景错误，我们将接管所有异常通道：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Catch</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AllExceptionsFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExceptionFilter</span> {
  <span class="hljs-keyword">catch</span>(<span class="hljs-attr">exception</span>: <span class="hljs-built_in">unknown</span>, <span class="hljs-attr">host</span>: <span class="hljs-title class_">ArgumentsHost</span>) {
</code></pre>
<p>借助 <code>ArgumentsHost</code>，我们拿到 HTTP 请求上下文，后续就能构造专属响应：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> ctx = host.<span class="hljs-title function_">switchToHttp</span>();
<span class="hljs-keyword">const</span> response = ctx.<span class="hljs-property">getResponse</span>&lt;<span class="hljs-title class_">Response</span>&gt;();
<span class="hljs-keyword">const</span> request = ctx.<span class="hljs-property">getRequest</span>&lt;<span class="hljs-title class_">Request</span>&gt;();
</code></pre>
<p>此时的目标是“掌控入口”。</p>
<h3 data-id="heading-16">第二层：区分 HTTP 状态码，让协议正确表达成功或失败</h3>
<p>框架层能力拦截之后，下一层诉求是协议语义正确。<br/>
对客户端返回的 HTTP Status 必须准确，否则代理、浏览器、监控系统均无法判断请求情况：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> httpStatus =
  exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HttpException</span>
    ? exception.<span class="hljs-title function_">getStatus</span>()
    : <span class="hljs-title class_">HttpStatus</span>.<span class="hljs-property">INTERNAL_SERVER_ERROR</span>;
</code></pre>
<p>简单讲：</p>
<ul>
<li>可预期的业务错误维持 4xx</li>
<li>其它错误不想让前端知道具体错误，直接返回  <code>INTERNAL_SERVER_ERROR</code>。</li>
</ul>
<p>这实现了“系统对外的协议治理”。</p>
<h3 data-id="heading-17">第三层：建立业务错误码体系，与协议语义解耦</h3>
<p>HTTP Status 永远不适合作为业务判断依据。<br/>
因此体系化项目会分离“协议错误码”和“业务错误码”。这一步实现业务语义治理：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">businessCode</span>: <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">400</span> &amp;&amp; httpStatus &lt; <span class="hljs-number">500</span>) {
  businessCode = <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">BUSINESS_ERROR</span>;
} <span class="hljs-keyword">else</span> {
  businessCode = <span class="hljs-title class_">ErrorCodes</span>.<span class="hljs-property">SYSTEM_ERROR</span>;
}
</code></pre>
<p>从此，前端不再需要看 400/500 决策，而是看业务码 1000/5000 做逻辑分支(如果需要有业务错误码的话，一般可以不加业务状态码)。</p>
<h3 data-id="heading-18">第四层：控制返回给用户的 message，不泄漏内部实现</h3>
<p>继续向下走，我们需要控制“用户可见信息”。</p>
<p>对于 <code>HttpException</code>，返回异常信息安全可控；<br/>
而普通异常有堆栈、内部错误，不可直给客户端：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">let</span> <span class="hljs-attr">userMessage</span>: <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HttpException</span>) {
  <span class="hljs-keyword">const</span> exceptionResponse = exception.<span class="hljs-title function_">getResponse</span>() <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>;
  userMessage = exceptionResponse.<span class="hljs-property">message</span> || exception.<span class="hljs-property">message</span>;
} <span class="hljs-keyword">else</span> {
  userMessage = <span class="hljs-string">'Server Internal Error'</span>;
}
</code></pre>
<h3 data-id="heading-19">第五层：注入 traceId，将错误纳入链路追踪体系</h3>
<p>协议治理与安全治理之后，我们需要可观测性。<br/>
依赖 <code>ClsService</code> 获取 traceId，使任意异常都能与一次请求绑定：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> traceId = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cls</span>.<span class="hljs-title function_">getId</span>();
</code></pre>
<p>这让后续日志检索有了线索，从“出错”变为“定位在哪个请求出错”。</p>
<hr/>
<h3 data-id="heading-20">第六层：构造统一错误返回体，让前端接收结构稳定</h3>
<p>业务响应格式统一之后，客户端解析与 UI 逻辑才能标准化：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> finalClientResponse = {
  <span class="hljs-attr">code</span>: businessCode,
  <span class="hljs-attr">message</span>: userMessage,
  traceId,
  <span class="hljs-attr">error</span>: {
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
    <span class="hljs-attr">path</span>: request.<span class="hljs-property">url</span>,
    <span class="hljs-attr">method</span>: request.<span class="hljs-property">method</span>,
    httpStatus,
  },
};
</code></pre>
<p>这一层，从“不固定字段”变为“返回契约统一”。</p>
<hr/>
<h3 data-id="heading-21">第七层：按严重程度结构化日志，结合 traceId 可查可追</h3>
<p>有了 traceId 后，日志才具备上下文意义。<br/>
对非预期错误记录堆栈并升为 <code>error</code>，对客户端调用错误降级为 <code>warn</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${userMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">stack</span>: (exception <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>).<span class="hljs-property">stack</span>,
    traceId,
  });
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${userMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    traceId,
  });
}
</code></pre>
<p>此处是“日志治理 + 可观测性治理”。</p>
<hr/>
<h3 data-id="heading-22">第八层：保持 HTTP 状态原样返回，确保协议链路正常识别</h3>
<p>最终输出必须保留协议语义，否则监控、负载均衡、浏览器都将错误判断请求：</p>
<pre><code class="hljs language-typescript" lang="typescript">response.<span class="hljs-title function_">status</span>(httpStatus).<span class="hljs-title function_">json</span>(finalClientResponse);
</code></pre>
<p>接下来就可以在 main.ts 中使用这个全局错误管理器了。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClsService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nestjs-cls'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AllExceptionsFilter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./common/filters/http-exception.filter'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">NestExpressApplication</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/platform-express'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">LoggerService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-property">create</span>&lt;<span class="hljs-title class_">NestExpressApplication</span>&gt;(<span class="hljs-title class_">AppModule</span>, {
    <span class="hljs-attr">bufferLogs</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 先缓存日志，直到 Logger 替换完成</span>
  });

  <span class="hljs-keyword">const</span> configService = app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ConfigService</span>);

  <span class="hljs-comment">// 1. 替换 Nest 默认 Logger 为 Winston</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">logger</span>: <span class="hljs-title class_">LoggerService</span> = app.<span class="hljs-title function_">get</span>(<span class="hljs-variable constant_">WINSTON_MODULE_NEST_PROVIDER</span>);

  app.<span class="hljs-title function_">useLogger</span>(logger);

  <span class="hljs-comment">// 获取 CLS 服务实例</span>
  <span class="hljs-keyword">const</span> clsService = app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">ClsService</span>);

  <span class="hljs-comment">// 4. 注册全局异常过滤器：捕获所有异常并打印日志 + 返回统一结构</span>
  app.<span class="hljs-title function_">useGlobalFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AllExceptionsFilter</span>(clsService, logger));

  <span class="hljs-keyword">const</span> port = configService.<span class="hljs-property">get</span>&lt;<span class="hljs-built_in">number</span>&gt;(<span class="hljs-string">'port'</span>) ?? <span class="hljs-number">3000</span>;

  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
    logger.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server on :<span class="hljs-subst">${port}</span>`</span>);
  });
}
<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<h2 data-id="heading-23">honojs 配置</h2>
<h3 data-id="heading-24">第一部分：链路日志追踪功能</h3>
<p>首先我们封装记录 traceId 的功能，我们通过编写一个中间件来实现，这个中间件是所有请求过来，经过的第一步，这样所有请求就带了 traceId，具体实现如下：</p>
<p>首先我们要创建一个 AsyncLocalStorage 实例，让后续的中间件调用其 run 方法，为每个请求创建独立的上下文。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AsyncLocalStorage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:async_hooks"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RequestContext</span> {
  <span class="hljs-attr">traceId</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 初始化全局存储</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> ctx = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AsyncLocalStorage</span>&lt;<span class="hljs-title class_">RequestContext</span>&gt;();

<span class="hljs-comment">// 封装一个获取 traceId 的快捷方法</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getTraceId = (): <span class="hljs-built_in">string</span> | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> store = ctx.<span class="hljs-title function_">getStore</span>();
  <span class="hljs-keyword">return</span> store?.<span class="hljs-property">traceId</span>;
};

</code></pre>
<p>以下是 middleware 的实现</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/factory"</span>;
<span class="hljs-keyword">import</span> { ctx } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>; <span class="hljs-comment">// 导入您的 ctx</span>

<span class="hljs-comment">// 确保在 Node.js 环境下使用</span>
<span class="hljs-keyword">import</span> { randomUUID } <span class="hljs-keyword">from</span> <span class="hljs-string">"node:crypto"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> traceMiddleware = <span class="hljs-title function_">createMiddleware</span>(<span class="hljs-keyword">async</span> (c, next) =&gt; {
  <span class="hljs-comment">// 1. 生成唯一的 Trace ID</span>
    <span class="hljs-keyword">const</span> traceId = c.<span class="hljs-property">req</span>.<span class="hljs-title function_">header</span>(<span class="hljs-string">"x-request-id"</span>) || <span class="hljs-title function_">randomUUID</span>();

  <span class="hljs-comment">// 2. 将 Trace ID 存储在 AsyncLocalStorage 中，并运行后续的处理链</span>
  <span class="hljs-keyword">await</span> ctx.<span class="hljs-title function_">run</span>({ traceId }, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-comment">// 3. (可选) 记录请求开始日志</span>
    <span class="hljs-comment">// logger.info(`Request started: ${c.req.method} ${c.req.url}`, {</span>
    <span class="hljs-comment">//   traceId: getTraceId(),</span>
    <span class="hljs-comment">// });</span>

    <span class="hljs-comment">// 4. 继续处理链</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">next</span>();

    <span class="hljs-comment">// 5. (可选) 设置响应头</span>
    c.<span class="hljs-property">res</span>.<span class="hljs-property">headers</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">"X-Trace-ID"</span>, traceId);

    <span class="hljs-comment">// // 6. (可选) 记录请求结束日志</span>
    <span class="hljs-comment">// logger.info(`Request finished: ${c.req.method} ${c.req.url}`, {</span>
    <span class="hljs-comment">//   traceId: getTraceId(),</span>
    <span class="hljs-comment">//   status: c.res.status,</span>
    <span class="hljs-comment">// });</span>
  });
});
</code></pre>
<p>通过优先读取 <code>x-request-id</code>，我们可以实现跨系统的全链路追踪（如果你的前端或上游网关也带了这个 ID，就能实现真正的端到端打通）。</p>
<p>主要代码就是 ctx.run({ traceId }, async () =&gt; { xxx }), 将后所有内容，包含在 AsyncLocalStorage 上下文中，也就是 traceId 会伴随整个请求的生命周期。</p>
<h3 data-id="heading-25">第二部分：Winston 动态工厂 (common/logger)</h3>
<p>这里体现了<strong>环境差异化处理</strong>的思想。</p>

























<table><thead><tr><th><strong>特性</strong></th><th><strong>开发环境 (Development)</strong></th><th><strong>生产环境 (Production)</strong></th></tr></thead><tbody><tr><td><strong>输出目标</strong></td><td>只有控制台 (Console)</td><td>控制台 + 每日滚动文件 (Daily File)</td></tr><tr><td><strong>展示样式</strong></td><td>漂亮的彩色、缩进、Nest 风格</td><td>严谨的 JSON 格式（方便日志分析系统 ELK 抓取）</td></tr><tr><td><strong>日志保留</strong></td><td>随启随看</td><td>保留 14 天，单文件 20MB（防止硬盘爆掉）</td></tr></tbody></table>
<p>以上的功能，我们封装到一个 logger.ts 中，代码如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { format, transports, createLogger } <span class="hljs-keyword">from</span> <span class="hljs-string">"winston"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"winston-daily-rotate-file"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">PROD_ENV</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../../../constant"</span>;

<span class="hljs-comment">// 1. 自定义 Format：自动从 ALS 获取 Trace ID</span>
<span class="hljs-keyword">const</span> appendTraceId = <span class="hljs-title function_">format</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {
  <span class="hljs-comment">// 使用 ctx.getStore() 获得</span>
  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();
  <span class="hljs-keyword">if</span> (!traceId) {
    info.<span class="hljs-property">traceId</span> = traceId;
  }
  <span class="hljs-keyword">return</span> info;
});

<span class="hljs-comment">/// 2. 基础配置</span>
<span class="hljs-keyword">const</span> logFormat = format.<span class="hljs-title function_">combine</span>(
  <span class="hljs-title function_">appendTraceId</span>(),
  format.<span class="hljs-title function_">timestamp</span>({ <span class="hljs-attr">format</span>: <span class="hljs-string">"YYYY-MM-DD HH:mm:ss"</span> }),
  format.<span class="hljs-title function_">errors</span>({ <span class="hljs-attr">stack</span>: <span class="hljs-literal">true</span> }), <span class="hljs-comment">// 自动捕获 error stack</span>
  format.<span class="hljs-title function_">json</span>()
);

<span class="hljs-keyword">const</span> devTransport = <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
  <span class="hljs-attr">level</span>: <span class="hljs-string">"info"</span>,
  <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
    format.<span class="hljs-title function_">colorize</span>(),
    format.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">{ timestamp, level, message, traceId, stack }</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> tid = traceId ? <span class="hljs-string">`[Trace: <span class="hljs-subst">${traceId}</span>]`</span> : <span class="hljs-string">""</span>;
      <span class="hljs-keyword">const</span> output = <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> <span class="hljs-subst">${level}</span> <span class="hljs-subst">${tid}</span>: <span class="hljs-subst">${message}</span>`</span>;
      <span class="hljs-keyword">return</span> stack ? <span class="hljs-string">`<span class="hljs-subst">${output}</span>\n<span class="hljs-subst">${stack}</span>`</span> : output;
    })
  ),
});

<span class="hljs-comment">// 导出 Logger 实例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> logger = <span class="hljs-title function_">createLogger</span>({
  <span class="hljs-attr">format</span>: logFormat,
  <span class="hljs-attr">transports</span>:
    process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-variable constant_">PROD_ENV</span>
      ? <span class="hljs-comment">// 生产环境 Transports</span>
        [
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">DailyRotateFile</span>({
            <span class="hljs-attr">filename</span>: <span class="hljs-string">"logs/error-%DATE%.log"</span>,
            <span class="hljs-attr">datePattern</span>: <span class="hljs-string">"YYYY-MM-DD"</span>,
            <span class="hljs-attr">level</span>: <span class="hljs-string">"error"</span>,
            <span class="hljs-attr">maxSize</span>: <span class="hljs-string">"20m"</span>,
            <span class="hljs-attr">maxFiles</span>: <span class="hljs-string">"14d"</span>,
          }),
          <span class="hljs-keyword">new</span> transports.<span class="hljs-title class_">Console</span>({
            <span class="hljs-attr">level</span>: <span class="hljs-string">"error"</span>,
            <span class="hljs-attr">format</span>: format.<span class="hljs-title function_">combine</span>(
              format.<span class="hljs-title function_">colorize</span>(),
              format.<span class="hljs-title function_">printf</span>(<span class="hljs-function">(<span class="hljs-params">{ timestamp, level, message, traceId, stack }</span>) =&gt;</span> {
                <span class="hljs-keyword">const</span> tid = traceId ? <span class="hljs-string">`[Trace: <span class="hljs-subst">${traceId}</span>]`</span> : <span class="hljs-string">""</span>;
                <span class="hljs-keyword">const</span> output = <span class="hljs-string">`<span class="hljs-subst">${timestamp}</span> <span class="hljs-subst">${level}</span> <span class="hljs-subst">${tid}</span>: <span class="hljs-subst">${message}</span>`</span>;
                <span class="hljs-keyword">return</span> stack ? <span class="hljs-string">`<span class="hljs-subst">${output}</span>\n<span class="hljs-subst">${stack}</span>`</span> : output;
              })
            ),
          }),
        ]
      : <span class="hljs-comment">// 开发环境 Transport</span>
        [devTransport],
});

</code></pre>
<p>注意，上面的例子，我们后续例如单机使用 docker-compose 部署也好，还是使用k8s/k3s部署也好，就不需要使用winston本身的 DailyRotateFile 功能了，可以借助 docker 或者 k8s/k3s 本身的日志轮转功能实现</p>
<h3 data-id="heading-26">如何在 Service 中打印带 TraceId 的日志？</h3>
<p>如下，我们就可以在路由中使用 logger 功能，就会自带 traceId 了</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Hono</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"./common/logger"</span>;
<span class="hljs-keyword">import</span> { standardResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"./context"</span>;

<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hono</span>();

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/users"</span>, <span class="hljs-keyword">async</span> (c) =&gt; {
  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">"开始处理 /users 请求"</span>);

  <span class="hljs-keyword">const</span> list = [{ <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Tom"</span> }];

  logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">`查询用户数量=<span class="hljs-subst">${list.length}</span>`</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">standardResponse</span>(c, { list });
});
</code></pre>
<p>访问结果输出（示例）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-number">2025-01-05 22:11:01 </span><span class="hljs-string">info</span> [<span class="hljs-attr">Trace:</span> <span class="hljs-string">099f42...</span>] <span class="hljs-string">开始处理</span> <span class="hljs-string">/users</span> <span class="hljs-string">请求</span>
<span class="hljs-number">2025-01-05 22:11:01 </span><span class="hljs-string">info</span> [<span class="hljs-attr">Trace:</span> <span class="hljs-string">099f42...</span>] <span class="hljs-string">查询用户数量=1</span>
</code></pre>
<h3 data-id="heading-27">在 hono.js 中封装统一返回格式</h3>
<p>与 nest.js 不同，hono.js 没有 <strong>Interceptor</strong> 的概念，因此无法在框架层自动包装所有路由的返回值。hono 更偏向极简设计：框架提供 Context（<code>c</code>）与响应方法（如 <code>c.json()</code>），开发者通过 middleware 或工具函数扩展能力。</p>
<p>在这种模式下，一个常见策略是：<strong>在 utils 层封装一个标准响应函数</strong>，每当路由处理完成业务逻辑后，调用该函数输出标准格式。示例如下：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// utils/response.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../common/context"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">CODES</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../common/constants/codes"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ContentfulStatusCode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/utils/http-status"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SUCCESS_MESSAGE</span> = <span class="hljs-string">"OK"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> standardResponse = &lt;T&gt;(
  <span class="hljs-attr">c</span>: <span class="hljs-title class_">Context</span>,
  <span class="hljs-attr">data</span>: T,
  <span class="hljs-attr">httpStatus</span>: <span class="hljs-title class_">ContentfulStatusCode</span> = <span class="hljs-number">200</span>
): <span class="hljs-function"><span class="hljs-params">Response</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();

  <span class="hljs-keyword">const</span> finalResponse = {
    <span class="hljs-attr">code</span>: <span class="hljs-variable constant_">CODES</span>.<span class="hljs-property">SUCCESS</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-variable constant_">SUCCESS_MESSAGE</span>,
    data,
    traceId,
  };
  
   <span class="hljs-comment">// 使用 c.json() 返回 Response</span>
  <span class="hljs-comment">// c.json() 负责设置 Content-Type: application/json</span>
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalResponse, httpStatus);
};
</code></pre>
<p>这一函数实现了几个能力：</p>
<ol>
<li><strong>统一业务结构</strong>：code / message / data 统一格式化。</li>
<li><strong>链路可观测性</strong>：自动从 ALS 中获取 traceId，可跨路由跟踪调用链路。</li>
<li><strong>控制协议行为</strong>：可指定 HTTP status，而不影响业务 code。</li>
<li><strong>无框架侵入性</strong>：不需要全局 patch，路由自由决定是否使用。</li>
</ol>
<p>实际使用方式非常直接：在路由处理函数中调用该函数包裹输出即可：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { standardResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/response"</span>;

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">"/user"</span>, <span class="hljs-function">(<span class="hljs-params">c</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> user = { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Tom"</span> };
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">standardResponse</span>(c, user);
});
</code></pre>
<p>输出结构：</p>
<pre><code class="hljs language-typescript" lang="typescript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"message"</span>: <span class="hljs-string">"OK"</span>,
  <span class="hljs-string">"data"</span>: {
    <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"Tom"</span>
  },
  <span class="hljs-string">"traceId"</span>: <span class="hljs-string">"abc-123-xyz"</span>
}
</code></pre>
<h3 data-id="heading-28">错误处理</h3>
<p>hono.js 并没有 nest.js 中那样的 exception（异常）处理器，但 hono 官方提供了两个方法来处理全局异常。</p>
<ul>
<li>Error Handling 回调函数</li>
<li>Not Found 回调函数</li>
</ul>
<p>其中 <code>app.onError</code> 允许我们处理未捕获的错误并返回自定义响应。例如</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Hono</span>();
app.<span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">err, c</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${err}</span>`</span>);
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">text</span>(<span class="hljs-string">"Custom Error Message"</span>, <span class="hljs-number">500</span>);
});
</code></pre>
<p>接下来我们实现一个生产级别的全局错误处理函数，代替上面的 onError 中的函数：</p>
<h4 data-id="heading-29">阶段一：只实现兜底，确保不会爆栈到框架</h4>
<p>目标：任何异常都返回 500，避免框架直接输出默认错误页面。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(
    {
      <span class="hljs-attr">message</span>: <span class="hljs-string">"Internal Server Error"</span>,
    },
    <span class="hljs-number">500</span>,
  );
};
</code></pre>
<p>此阶段的函数虽然简陋，但实现了基本“拦截能力”。技术人员可以理解到：不允许异常直接泄漏给框架。</p>
<h4 data-id="heading-30">阶段二：支持错误分类（业务可控错误 vs 系统错误）</h4>
<p>需求出现：业务层需要显式抛出 4xx，不应该全部变成 500。因此我们引入 Hono 的 HTTPException。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HTTPException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/http-exception"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">let</span> httpStatus = <span class="hljs-number">500</span>;
  <span class="hljs-keyword">let</span> message = <span class="hljs-string">"Internal Server Error"</span>;

  <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
    httpStatus = exception.<span class="hljs-property">status</span>;
    message = exception.<span class="hljs-property">message</span>;
  }

  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ message }, httpStatus);
};
</code></pre>
<p>团队到此能看到两个差异：</p>
<ul>
<li>不再一刀切地用 500</li>
<li>支持框架级错误语义</li>
</ul>
<h4 data-id="heading-31">阶段三：支持普通 Error，并提取堆栈</h4>
<p>当后端代码抛出 Error 对象时，我们不希望把内部堆栈暴露给客户端，但日志需要保留：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
  httpStatus = <span class="hljs-number">500</span>;
  message = exception.<span class="hljs-property">message</span>;
  stack = exception.<span class="hljs-property">stack</span>;
}
</code></pre>
<p>与第二阶段结合后，代码局部已经具备三类来源：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
  <span class="hljs-comment">// 合法业务错误</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
  <span class="hljs-comment">// 非预期系统错误</span>
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 字符串或其他类型，兜底转字符串</span>
}
</code></pre>
<p>这一阶段解决“所有类型异常都能进入统一通路”。</p>
<h4 data-id="heading-32">阶段四：对外 Message 安全脱敏</h4>
<p>生产会提出安全要求：500 段错误不能暴露内部 message。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> userMessage =
  httpStatus &gt;= <span class="hljs-number">500</span> ? <span class="hljs-string">"Server Internal Error"</span> : exceptionMessage;
</code></pre>
<h4 data-id="heading-33">阶段五：加入 Trace ID，实现可观测能力</h4>
<p>在前几阶段之后，团队开始发现：仅凭日志很难定位请求调用链。因此引入 Trace ID：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;

<span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();
</code></pre>
<p>并将其放入响应，用于 API 与日志上下游联动。</p>
<h4 data-id="heading-34">阶段六：构建统一响应协议</h4>
<p>现在错误信息、trace 信息都有了，我们需要形成一致返回结构，便于前端或 API 网关解析：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> finalClientResponse = {
  <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,
  <span class="hljs-attr">message</span>: userMessage,
  <span class="hljs-attr">traceId</span>: traceId,
  <span class="hljs-attr">error</span>: {
    <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    <span class="hljs-attr">method</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>,
    <span class="hljs-attr">httpStatus</span>: httpStatus,
  },
};
</code></pre>
<p>这样可以回复格式统一的响应。</p>
<h4 data-id="heading-35">阶段七：结构化日志分级输出</h4>
<p>生产要求日志可检索、可告警，因此需要按状态区分 error 与 warn，并携带堆栈：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
  logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">stack</span>: exceptionStack,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
  });
} <span class="hljs-keyword">else</span> {
  logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
    <span class="hljs-attr">clientResponse</span>: finalClientResponse,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
  });
}
</code></pre>
<p>团队能看到：</p>
<ul>
<li>500+ 是告警级别</li>
<li>4xx 只是用户请求问题，不污染告警系统</li>
</ul>
<h4 data-id="heading-36">阶段八：最终闭环，按状态返回响应</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalClientResponse, httpStatus);
</code></pre>
<p>请求闭环如下：</p>
<ol>
<li>识别异常</li>
<li>分类</li>
<li>安全脱敏</li>
<li>绑定 Trace</li>
<li>构建协议</li>
<li>结构化日志</li>
<li>返回状态码与响应体</li>
</ol>
<p>最终成果（合并段落）即为我们起初提供的完整生产代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">Context</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono"</span>;
<span class="hljs-keyword">import</span> { getTraceId } <span class="hljs-keyword">from</span> <span class="hljs-string">"../context"</span>;
<span class="hljs-keyword">import</span> { logger } <span class="hljs-keyword">from</span> <span class="hljs-string">"../logger"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HTTPException</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/http-exception"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-keyword">type</span> <span class="hljs-title class_">ContentfulStatusCode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"hono/utils/http-status"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">customErrorHandler</span> = (<span class="hljs-params">exception: <span class="hljs-built_in">unknown</span>, c: Context</span>) =&gt; {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">httpStatus</span>: <span class="hljs-title class_">ContentfulStatusCode</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">exceptionMessage</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"Internal Server Error"</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">exceptionStack</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>;

  <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTTPException</span>) {
    httpStatus = exception.<span class="hljs-property">status</span>;
    exceptionMessage = exception.<span class="hljs-property">message</span>;
    exceptionStack = exception.<span class="hljs-property">stack</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span>) {
    httpStatus = <span class="hljs-number">500</span>;
    exceptionMessage = exception.<span class="hljs-property">message</span>;
    exceptionStack = exception.<span class="hljs-property">stack</span>;
  } <span class="hljs-keyword">else</span> {
    httpStatus = <span class="hljs-number">500</span>;
    exceptionMessage = <span class="hljs-title class_">String</span>(exception);
  }

  <span class="hljs-keyword">const</span> userMessage =
    httpStatus &gt;= <span class="hljs-number">500</span> ? <span class="hljs-string">"Server Internal Error"</span> : exceptionMessage;

  <span class="hljs-keyword">const</span> traceId = <span class="hljs-title function_">getTraceId</span>();

  <span class="hljs-keyword">const</span> finalClientResponse = {
    <span class="hljs-attr">code</span>: <span class="hljs-number">500</span>,
    <span class="hljs-attr">message</span>: userMessage,
    <span class="hljs-attr">traceId</span>: traceId,
    <span class="hljs-attr">error</span>: {
      <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>(),
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
      <span class="hljs-attr">method</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">method</span>,
      <span class="hljs-attr">httpStatus</span>: httpStatus,
    },
  };

  <span class="hljs-keyword">if</span> (httpStatus &gt;= <span class="hljs-number">500</span>) {
    logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Unhandled Exception: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
      <span class="hljs-attr">clientResponse</span>: finalClientResponse,
      <span class="hljs-attr">stack</span>: exceptionStack,
      <span class="hljs-attr">traceId</span>: traceId,
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    });
  } <span class="hljs-keyword">else</span> {
    logger.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${httpStatus}</span>] Client Error: <span class="hljs-subst">${exceptionMessage}</span>`</span>, {
      <span class="hljs-attr">clientResponse</span>: finalClientResponse,
      <span class="hljs-attr">traceId</span>: traceId,
      <span class="hljs-attr">path</span>: c.<span class="hljs-property">req</span>.<span class="hljs-property">path</span>,
    });
  }

  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>(finalClientResponse, httpStatus);
};
</code></pre>
<p>接下来我们来处理全局捕获的 404 回调，也就是自定义 Not Found Response, 个人感觉生产环境就简单返回 404 状态码就足够了，所以函数定义如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">notFoundHandler</span> = (<span class="hljs-params">c: Context</span>) =&gt; {
  <span class="hljs-keyword">return</span> c.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">"Resource not found"</span> }, <span class="hljs-number">404</span>);
};
</code></pre>
<h2 data-id="heading-37">欢迎一起交流</h2>
<p>欢迎大家一起进群讨论前端全栈技术和 ai agent ，一起进步！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从空地对抗到空战：首个无人机间追踪百万级基准与时空语义基线MambaSTS深度解析]]></title>    <link>https://juejin.cn/post/7585948869844746275</link>    <guid>https://juejin.cn/post/7585948869844746275</guid>    <pubDate>2025-12-22T02:14:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585948869844746275" data-draft-id="7585888537641762831" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从空地对抗到空战：首个无人机间追踪百万级基准与时空语义基线MambaSTS深度解析"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-12-22T02:14:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从空地对抗到空战：首个无人机间追踪百万级基准与时空语义基线MambaSTS深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:14:31.000Z" title="Mon Dec 22 2025 02:14:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当今视觉追踪领域，一项全新任务正引发学术界和工业界的关注。这项被称为「无人机对抗无人机」的挑战将追踪技术的难度推向了全新高度。</p>
<p>近期，来自香港科技大学（广州）、上海交通大学、中山大学、中国科学院信息工程研究所和云从科技的联合团队发布了题为《How Far are Modern Trackers from UAV-Anti-UAV? A Million-Scale Benchmark and New Baseline》的突破性研究。</p>
<p>这项研究不仅仅提出了新的任务范式，更是构建了<strong>一个百万级规模的基准数据集</strong>，并对现有50种先进追踪器进行了全面测评，结果令人震惊。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68829052a96c4406ae709ada68f3356a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=qZTBVb7uRqPVl4s3s9js0%2BwH0Oo%3D" alt="图片1.png" loading="lazy"/></p>
<blockquote>
<p><strong>论文地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2512.07385" target="_blank" title="https://arxiv.org/pdf/2512.07385" ref="nofollow noopener noreferrer">arxiv.org/pdf/2512.07…</a></strong></p>
<p><strong>项目地址：</strong> <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F983632847%2FAwesome-Multimodal-Object-Tracking" target="_blank" title="https://github.com/983632847/Awesome-Multimodal-Object-Tracking" ref="nofollow noopener noreferrer">github.com/983632847/A…</a></strong></p>
</blockquote>
<h2 data-id="heading-0"><strong>无人机追踪新篇章：从“空地对抗”到“空战”</strong></h2>
<p>当前的无人机相关追踪研究主要分为两种模式。第一种是无人机追踪地面目标，如车辆或行人，此时追踪平台动态但目标相对静止。</p>
<p>另一种是地面摄像头追踪空中无人机，目标动态而观测平台静止。</p>
<p>这两种模式都无法模拟真实的空中对抗环境——当一架无人机需要追击另一架无人机时，双方都处于高速、剧烈的运动中。</p>
<p>研究团队将这种双向动态干扰称为“dual-dynamic disturbances”，它导致了视角急剧变化、背景快速移动和目标运动模糊等一系列复杂问题。</p>
<p>这正是UAV-Anti-UAV任务的核心挑战所在。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/56c97ba5b71846cca733922ad0f2b49f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=B%2FgfRPS0xuGENo1hkDDavNH9SFs%3D" alt="图片2.png" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>百万级基准：打造真实世界的空中战</strong></h2>
<p>为了推动这一新兴领域的发展，研究团队从零构建了一个超大规模、高质量标注的数据集。</p>
<p>这个数据集包含 1810个视频序列，总计105万标注帧，涵盖了固定翼、多旋翼、垂直起降、FPV无人机和无人直升机等五种目标无人机类型。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9726a836f4d4cfaa902ed92ce116d4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=3VTVyf%2F3d%2FugsoDNnhrR%2FUZgQYw%3D" alt="图片3.png" loading="lazy"/></p>
<p>与UAV123、Anti-UAV318等现有基准相比，新数据集不仅在规模上遥遥领先，更在多个维度上实现了突破：</p>
<ul>
<li>多模态创新：首次为每个视频序列提供简洁的自然语言描述，为视觉-语言多模态追踪开辟了新途径；</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62834470f9164395955db8afcc30772a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=TkkX0kqy5%2BQzLggJ0i0fmJvUtEI%3D" alt="图片4.png" loading="lazy"/></p>
<ul>
<li>极端挑战性：数据集标注了15种高难度追踪属性，如快速运动、光照变化和相似干扰物等。数据分析显示，新数据集在光照变化范围和目标相对速度上比现有基准更为“极端”，更贴近真实复杂环境；</li>
</ul>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52870b36678c411bb6f26f75b7a7716c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=FfSip5BM2Fccn0h8qdLpRf%2BP1xY%3D" alt="图片5.png" loading="lazy"/></p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7652c94003a94beeb44064558f9c6987~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=Euydw%2FgIvVcIdyvNrQRDxH7K0Yk%3D" alt="图片6.png" loading="lazy"/></p>
<p align="left"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/629b28c2f6a541ac8c9f90f2449f82fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=C36bJcHEf2%2F9EFPoZOJwwJ5LnyE%3D" alt="图片7.png" loading="lazy"/></p>
<ul>
<li>真实场景覆盖：数据采集自多样化真实环境，确保算法在实际应用中的鲁棒性。</li>
</ul>
<p><strong>目前Coovally官网已有Vistrone等权威无人机开源数据集免费为用户提供，并且还有可直接部署应用于大疆无人机的算法模型，无需重新修改部署转换</strong>，具体文章可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkzOTg3NTAyNA%3D%3D%26mid%3D2247490614%26idx%3D2%26sn%3D4cdaf1278f908fc12877d8aa26de6211%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkzOTg3NTAyNA==&amp;mid=2247490614&amp;idx=2&amp;sn=4cdaf1278f908fc12877d8aa26de6211&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">VisDrone数据集，专为无人机视觉任务打造</a></p>
<p>Coovally平台不仅提供模型资源，还可以帮助你提供<strong>AI解决方案</strong>，可以扫描二维码，我们来给你提供解决方案！！</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/994fd8b13bf64e88a3790ab8a2b892e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=t6dbHdwgJpKsPPgLMwv4tVVtoh4%3D" alt="小助手二维码.png" loading="lazy"/></p>
<p>点击<strong>阅读原文</strong>，即可体验Coovally平台！</p>
<h2 data-id="heading-2"><strong>MambaSTS：时空语义融合的追踪新框架</strong></h2>
<p>面对这一高难度任务，研究团队提出了MambaSTS——一种专为时空语义集成学习设计的新框架。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60ab660f94b5416495b3507836eb1990~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=luQKPXckHhVRA3ypU9fTFmobzaI%3D" alt="图片8.png" loading="lazy"/></p>
<p>MambaSTS的核心创新在于巧妙地结合了Transformer和Mamba两大架构的优势：</p>
<ul>
<li>Transformer提供强大的全局空间建模能力，提取丰富的视觉特征；</li>
<li>Mamba以线性复杂度高效处理长序列数据，建立视频帧间的长期上下文关系。</li>
</ul>
<p>具体实现中，模型将模板图像、搜索图像和语言描述作为多模态输入。设计了一个“时间令牌传播”机制，可视为一个“记忆单元”。</p>
<p>这个单元持续收集和压缩过去帧中关于目标的关键信息（如外观、运动状态），然后将这份“记忆”传递给当前帧的处理过程。</p>
<p>即使目标在某一瞬间被完全遮挡或因高速运动而变得模糊，模型依然能依靠长期记忆保持对目标的稳定认知。最终，统一的时空语义网络将这些信息深度融合，通过无锚框追踪头预测目标的精确位置。</p>
<h2 data-id="heading-3"><strong>实验结果：现有追踪器在“空战”中全面溃败</strong></h2>
<p>研究团队对50种当前最先进的追踪器进行了全面评估，结果令人深思：现有方法在UAV-Anti-UAV任务上表现普遍不足。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/074358b325904be7934f23d0270efdf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=Jfd6DKIs45gU0K7Rqm7WDfEuLqI%3D" alt="图片9.png" loading="lazy"/></p>
<p>从整体性能曲线看，大部分追踪器的成功率（Success/AUC）都处于较低水平。而论文提出的MambaSTS基线模型凭借其出色的时空建模能力，取得了43.7%的AUC得分，显著领先于其他方法。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9510fcea629b4d659d265d2ecc363d20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974471&amp;x-signature=rxEuHQQS%2BaXcm92gUF5H9OItbt0%3D" alt="图片10.png" loading="lazy"/></p>
<p>分析不同追踪属性下的表现发现，现有追踪器在处理光照剧烈变化、相似物体干扰、运动模糊和完全遮挡等挑战时尤其力不从心。</p>
<p>消融实验充分证明了MambaSTS各个组件的有效性。从强大的基线模型OSTrack（AUC 27.8%）开始，通过逐步加入时间建模、空间建模和语义建模模块，性能最终提升至43.7%，相对涨幅超过57%，效果显著。</p>
<h2 data-id="heading-4"><strong>意义与展望</strong></h2>
<p>这项研究的价值不仅在于技术突破，更在于它为低空经济安全提供了关键技术支撑。随着无人机在物流、巡检、娱乐等领域的广泛应用，如何防止无人机滥用、保障低空安全已成为迫在眉睫的问题。</p>
<p>UAV-Anti-UAV技术有望应用于无人机拦截、禁飞区防护、重要设施保护等场景，成为低空安全的“智能守护者”。</p>
<p>从学术角度看，这项研究开辟了视觉追踪的新方向，挑战了现有算法的极限，推动了多模态、长时序理解等技术的发展。</p>
<p>随着低空经济的蓬勃发展，无人机对抗无人机的技术将成为保障安全的关键屏障。这项研究不仅提出了挑战，更指明了方向——在这个全新的“空战”时代，视觉追踪技术必须迎接更复杂、更动态、更真实的考验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot自动配置：为什么你的应用能“开箱即用]]></title>    <link>https://juejin.cn/post/7585839411122913326</link>    <guid>https://juejin.cn/post/7585839411122913326</guid>    <pubDate>2025-12-22T02:11:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585839411122913326" data-draft-id="7585897699602808858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot自动配置：为什么你的应用能“开箱即用"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-22T02:11:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小坏说Java"/> <meta itemprop="url" content="https://juejin.cn/user/3898184413750203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot自动配置：为什么你的应用能“开箱即用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3898184413750203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小坏说Java
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:11:21.000Z" title="Mon Dec 22 2025 02:11:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">《SpringBoot自动配置：为什么你的应用能“开箱即用」？》</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<blockquote>
<p>每天5分钟，掌握一个SpringBoot核心知识点。大家好，我是SpringBoot指南的创始人小坏。</p>
</blockquote>
<p><strong>可以关注公众号：小坏说Java</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h3 data-id="heading-1">引言</h3>
<p>你是否曾经好奇，为什么创建一个SpringBoot应用只需要几行代码，就能自动获得Web服务器、数据库连接、安全配置等功能？今天我们就来揭开SpringBoot最核心的特性——自动配置的神秘面纱。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p>先看一个经典对比：</p>
<p><strong>传统Spring MVC项目</strong>：需要配置web.xml、DispatcherServlet、视图解析器、数据源等数十个配置项。</p>
<p><strong>SpringBoot项目</strong>：只需要一个main方法加上<code>@SpringBootApplication</code>注解。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 就是这么简单！</span>
<span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(MyApplication.class, args);
    }
}
</code></pre>
<h3 data-id="heading-2">一、@SpringBootApplication的三重魔法</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p>这个看似简单的注解，实际上是一个<strong>复合注解</strong>，包含了三个核心注解：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Inherited</span>
<span class="hljs-meta">@SpringBootConfiguration</span>
<span class="hljs-meta">@EnableAutoConfiguration</span>
<span class="hljs-meta">@ComponentScan(excludeFilters = { 
    @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),
    @Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) 
})</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> SpringBootApplication {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>让我们逐一解析这三个核心注解的作用：</p>
<h4 data-id="heading-3">1. @SpringBootConfiguration</h4>
<p>这是<code>@Configuration</code>的特化版本，表明这个类是一个配置类。它允许我们在同一个类中定义Bean。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 等价于传统的@Configuration</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> UserService <span class="hljs-title function_">userService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();
    }
}
</code></pre>
<h4 data-id="heading-4">2. @ComponentScan</h4>
<p>这个注解告诉Spring在哪些包下扫描组件（@Component、@Service、@Controller等）。默认扫描的是<strong>当前包及其子包</strong>。</p>
<h4 data-id="heading-5">3. @EnableAutoConfiguration（重点！）</h4>
<p>这是自动配置的<strong>核心开关</strong>。让我们看看它的源码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Inherited</span>
<span class="hljs-meta">@AutoConfigurationPackage</span>
<span class="hljs-meta">@Import(AutoConfigurationImportSelector.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableAutoConfiguration {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>关键点在于<code>@Import(AutoConfigurationImportSelector.class)</code>，这个类负责加载所有自动配置类。</p>
<h3 data-id="heading-6">二、自动配置的加载机制</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-7">1. spring.factories文件的作用</h4>
<p>SpringBoot启动时，<code>AutoConfigurationImportSelector</code>会读取<code>META-INF/spring.factories</code>文件，这个文件在spring-boot-autoconfigure包中：</p>
<pre><code class="hljs language-properties" lang="properties"># 文件位置: spring-boot-autoconfigure-2.7.x.jar!/META-INF/spring.factories

# Auto Configure
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\
org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\
org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\
org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\
# ... 上百个自动配置类
</code></pre>
<p>目前SpringBoot 2.7.x版本中，这个文件列出了<strong>140多个自动配置类</strong>！这就是SpringBoot"开箱即用"能力的来源。</p>
<h4 data-id="heading-8">2. 按需加载机制</h4>
<p>你可能会担心：加载这么多配置类，不会影响启动速度吗？</p>
<p>实际上，SpringBoot使用了<strong>条件化配置</strong>机制。每个自动配置类都有各种<code>@ConditionalOnXxx</code>注解，只有在条件满足时才会生效。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-comment">// 条件1：类路径下有DataSource类</span>
<span class="hljs-meta">@ConditionalOnClass(DataSource.class)</span>
<span class="hljs-comment">// 条件2：有DataSource类型的Bean</span>
<span class="hljs-meta">@ConditionalOnBean(DataSource.class)</span>
<span class="hljs-comment">// 条件3：配置了spring.datasource属性</span>
<span class="hljs-meta">@ConditionalOnProperty(prefix = "spring.datasource", name = "url")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceAutoConfiguration</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-comment">// 条件4：不存在DataSource类型的Bean时才创建</span>
    <span class="hljs-meta">@ConditionalOnMissingBean(DataSource.class)</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSource</span><span class="hljs-params">(DataSourceProperties properties)</span> {
        <span class="hljs-keyword">return</span> properties.initializeDataSourceBuilder().build();
    }
}
</code></pre>
<h3 data-id="heading-9">三、条件注解详解</h3>
<p>SpringBoot提供了一系列条件注解，让我们看看最常用的几个：</p>













































<table><thead><tr><th>条件注解</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td>@ConditionalOnClass</td><td>类路径下存在指定类时生效</td><td><code>@ConditionalOnClass(RedisTemplate.class)</code></td></tr><tr><td>@ConditionalOnMissingClass</td><td>类路径下不存在指定类时生效</td><td><code>@ConditionalOnMissingClass("javax.servlet.Servlet")</code></td></tr><tr><td>@ConditionalOnBean</td><td>容器中存在指定Bean时生效</td><td><code>@ConditionalOnBean(DataSource.class)</code></td></tr><tr><td>@ConditionalOnMissingBean</td><td>容器中不存在指定Bean时生效</td><td><code>@ConditionalOnMissingBean(RedisTemplate.class)</code></td></tr><tr><td>@ConditionalOnProperty</td><td>配置文件中存在指定属性时生效</td><td><code>@ConditionalOnProperty(prefix="redis", name="enabled")</code></td></tr><tr><td>@ConditionalOnWebApplication</td><td>是Web应用时生效</td><td><code>@ConditionalOnWebApplication</code></td></tr><tr><td>@ConditionalOnNotWebApplication</td><td>不是Web应用时生效</td><td><code>@ConditionalOnNotWebApplication</code></td></tr></tbody></table>
<h3 data-id="heading-10">四、实战：创建自定义Starter</h3>
<p>理解了原理后，我们来自定义一个Starter，实现一个简单的短信服务。</p>
<h4 data-id="heading-11">步骤1：创建Starter项目结构</h4>
<pre><code class="hljs language-css" lang="css">sms-spring-boot-starter/
├── <span class="hljs-attribute">src</span>/
│   ├── <span class="hljs-selector-tag">main</span>/
│   │   ├── java/com/example/sms/
│   │   │   ├── SmsAutoConfiguration<span class="hljs-selector-class">.java</span>
│   │   │   ├── SmsProperties<span class="hljs-selector-class">.java</span>
│   │   │   ├── SmsService<span class="hljs-selector-class">.java</span>
│   │   │   └── SmsServiceImpl<span class="hljs-selector-class">.java</span>
│   │   └── resources/
│   │       └── META-INF/
│   │           └── spring<span class="hljs-selector-class">.factories</span>
│   └── pom<span class="hljs-selector-class">.xml</span>
</code></pre>
<h4 data-id="heading-12">步骤2：创建配置属性类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SmsProperties.java</span>
<span class="hljs-meta">@ConfigurationProperties(prefix = "sms")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsProperties</span> {
    <span class="hljs-keyword">private</span> String accessKey;
    <span class="hljs-keyword">private</span> String secretKey;
    <span class="hljs-keyword">private</span> String signName;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">endpoint</span> <span class="hljs-operator">=</span> <span class="hljs-string">"https://dysmsapi.aliyuncs.com"</span>;
    
    <span class="hljs-comment">// getters and setters</span>
}
</code></pre>
<h4 data-id="heading-13">步骤3：创建自动配置类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SmsAutoConfiguration.java</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableConfigurationProperties(SmsProperties.class)</span>  <span class="hljs-comment">// 启用配置属性</span>
<span class="hljs-meta">@ConditionalOnClass(SmsService.class)</span>  <span class="hljs-comment">// 当SmsService在类路径时生效</span>
<span class="hljs-meta">@ConditionalOnProperty(prefix = "sms", value = "enabled", havingValue = "true", matchIfMissing = true)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsAutoConfiguration</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@ConditionalOnMissingBean(SmsService.class)</span>  <span class="hljs-comment">// 容器中没有SmsService时才创建</span>
    <span class="hljs-keyword">public</span> SmsService <span class="hljs-title function_">smsService</span><span class="hljs-params">(SmsProperties properties)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SmsServiceImpl</span>(properties);
    }
}
</code></pre>
<h4 data-id="heading-14">步骤4：创建服务接口和实现</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// SmsService.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SmsService</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String phone, String content)</span>;
}

<span class="hljs-comment">// SmsServiceImpl.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SmsServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SmsService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SmsProperties properties;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SmsServiceImpl</span><span class="hljs-params">(SmsProperties properties)</span> {
        <span class="hljs-built_in">this</span>.properties = properties;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">send</span><span class="hljs-params">(String phone, String content)</span> {
        System.out.printf(<span class="hljs-string">"发送短信到%s: %s [使用配置: %s]%n"</span>, 
            phone, content, properties.getEndpoint());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h4 data-id="heading-15">步骤5：注册自动配置</h4>
<p>在<code>resources/META-INF/spring.factories</code>中：</p>
<pre><code class="hljs language-properties" lang="properties">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
com.example.sms.SmsAutoConfiguration
</code></pre>
<h4 data-id="heading-16">步骤6：在其他项目中使用</h4>
<ol>
<li>引入依赖：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sms-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ol start="2">
<li>添加配置：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">sms:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">access-key:</span> <span class="hljs-string">your-access-key</span>
  <span class="hljs-attr">secret-key:</span> <span class="hljs-string">your-secret-key</span>
  <span class="hljs-attr">sign-name:</span> <span class="hljs-string">阿里云</span>
</code></pre>
<ol start="3">
<li>直接注入使用：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SmsService smsService;  <span class="hljs-comment">// 自动注入</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 注册逻辑...</span>
        smsService.send(user.getPhone(), <span class="hljs-string">"注册验证码: 123456"</span>);
    }
}
</code></pre>
<h3 data-id="heading-17">五、自动配置的调试技巧</h3>
<p>当你遇到配置不生效的问题时，可以使用以下方法调试：</p>
<h4 data-id="heading-18">1. 开启调试日志</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">debug:</span> <span class="hljs-literal">true</span>
</code></pre>
<p>启动时会打印哪些自动配置类生效了，哪些没有生效及其原因。</p>
<h4 data-id="heading-19">2. 使用ConditionEvaluationReport</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ConfigurableApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> 
            SpringApplication.run(Application.class, args);
        
        <span class="hljs-comment">// 打印条件评估报告</span>
        <span class="hljs-type">ConditionEvaluationReport</span> <span class="hljs-variable">report</span> <span class="hljs-operator">=</span> 
            ConditionEvaluationReport.get(context.getBeanFactory());
        report.getConditionAndOutcomesBySource().forEach((source, outcomes) -&gt; {
            System.out.println(source);
            outcomes.forEach(outcome -&gt; {
                System.out.println(<span class="hljs-string">"\t"</span> + outcome.getOutcome());
            });
        });
    }
}
</code></pre>
<h3 data-id="heading-20">六、自动配置的最佳实践</h3>
<ol>
<li><strong>合理使用条件注解</strong>：避免过度配置，只在条件满足时生效</li>
<li><strong>提供合理的默认值</strong>：让用户无需配置就能使用</li>
<li><strong>允许用户覆盖</strong>：使用<code>@ConditionalOnMissingBean</code>让用户能自定义Bean</li>
<li><strong>良好的配置前缀</strong>：使用清晰的前缀，如<code>spring.datasource</code></li>
<li><strong>提供配置提示</strong>：创建<code>spring-configuration-metadata.json</code>提供IDE提示</li>
</ol>
<h3 data-id="heading-21">总结</h3>
<p>SpringBoot的自动配置通过以下机制实现"约定优于配置"：</p>
<ol>
<li><strong>启动注解复合</strong>：<code>@SpringBootApplication</code>集成了配置、扫描和自动配置</li>
<li><strong>工厂加载机制</strong>：通过<code>spring.factories</code>加载所有自动配置类</li>
<li><strong>条件化装配</strong>：根据环境按需加载，避免不必要的配置</li>
<li><strong>合理的默认值</strong>：提供开箱即用的默认配置</li>
</ol>
<h3 data-id="heading-22">今日思考题</h3>
<p>如果我想创建一个数据库连接池的Starter，需要满足以下条件：</p>
<ol>
<li>当类路径下有HikariCP时使用HikariCP</li>
<li>当类路径下有Druid时使用Druid</li>
<li>用户可以通过配置选择使用哪个连接池</li>
</ol>
<p>该如何设计这个自动配置类呢？欢迎在评论区分享你的思路！</p>
<p>可以关注公众号：小坏说Java</p>
<hr/>
<p><strong>下期预告</strong>：明天我们将探讨《SpringBoot全局异常处理：别再到处try-catch了！》，学习如何优雅地处理异常，打造健壮的应用。</p>
<p><strong>互动时间</strong>：你在使用SpringBoot自动配置时遇到过哪些有趣的问题或技巧？欢迎留言分享！</p>
<p><strong>资源获取</strong>：关注公众号回复"自动配置源码"，获取本文所有示例代码及自定义Starter完整项目。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS Swift 可选值（Optional）详解]]></title>    <link>https://juejin.cn/post/7586482851097706536</link>    <guid>https://juejin.cn/post/7586482851097706536</guid>    <pubDate>2025-12-22T02:16:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482851097706536" data-draft-id="7581036773607800832" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS Swift 可选值（Optional）详解"/> <meta itemprop="keywords" content="前端,iOS"/> <meta itemprop="datePublished" content="2025-12-22T02:16:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tangbin583085"/> <meta itemprop="url" content="https://juejin.cn/user/95026578465675"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS Swift 可选值（Optional）详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/95026578465675/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tangbin583085
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:16:22.000Z" title="Mon Dec 22 2025 02:16:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Swift 与 Objective-C 最大的区别之一，就是 <strong>Optional（可选值）机制</strong>。<br/>
它从语言层面解决了“空指针崩溃”的问题，但如果使用不当，也可能引入新的 Crash。</p>
<p>在日常开发中，我们经常看到下面这些写法：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> name: <span class="hljs-type">String</span>?
<span class="hljs-keyword">var</span> age: <span class="hljs-type">Int</span>!

<span class="hljs-keyword">let</span> title <span class="hljs-operator">=</span> text <span class="hljs-operator">??</span> <span class="hljs-string">"默认标题"</span>
imageView.image <span class="hljs-operator">=</span> <span class="hljs-type">UIImage</span>(named: imgName <span class="hljs-operator">??</span> <span class="hljs-string">""</span>)
</code></pre>
<p>本文将<strong>系统讲解 <code>?</code>、<code>!</code>、<code>??</code> 的含义、区别、适用场景与工程级最佳实践</strong>，帮助你在 Swift 项目中写出更安全、更专业的代码。</p>
<hr/>
<h2 data-id="heading-0">什么是 Optional（可选值）</h2>
<p>在 Swift 中，<strong>Optional 表示一个变量「可能有值，也可能为 nil」</strong>。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> name: <span class="hljs-type">String</span>? <span class="hljs-operator">=</span> <span class="hljs-string">"Hello World"</span>
name <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
</code></pre>
<p>等价理解为：</p>
<blockquote>
<p>「这个变量可以为空，编译器强制你在使用前处理好为空的情况」</p>
</blockquote>
<p>这与 OC 中的 <code>id</code>、<code>NSString *</code> 完全不同，是 <strong>编译器层面的安全保障</strong>。</p>
<hr/>
<h2 data-id="heading-1">Optional 本质是什么？</h2>
<p>从语言层面来看：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> value: <span class="hljs-type">Int</span>?
</code></pre>
<p>本质上相当于一个枚举：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Optional</span>&lt;<span class="hljs-title class_">Int</span>&gt; {
    <span class="hljs-keyword">case</span> <span class="hljs-keyword">some</span>(<span class="hljs-type">Int</span>)
    <span class="hljs-keyword">case</span> none
}
</code></pre>
<p>也正是因为这样，<strong>Swift 不允许你直接使用 Optional 的值</strong>。</p>
<hr/>
<h2 data-id="heading-2">一、<code>?</code> —— 可选类型（Optional）</h2>
<h3 data-id="heading-3">定义方式</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> username: <span class="hljs-type">String</span>?
</code></pre>
<p>表示：</p>
<ul>
<li>可能有值</li>
<li>也可能为 <code>nil</code></li>
</ul>
<h3 data-id="heading-4">使用限制</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> len <span class="hljs-operator">=</span> username.count <span class="hljs-operator">❌</span> 编译错误
</code></pre>
<p>你必须 <strong>先解包（unwrap）</strong> ，才能使用。</p>
<hr/>
<h3 data-id="heading-5">安全解包方式一：<code>if let</code></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> username {
    <span class="hljs-built_in">print</span>(name.count)
} <span class="hljs-keyword">else</span> {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"username 为 nil"</span>)
}
</code></pre>
<hr/>
<h3 data-id="heading-6">安全解包方式二：<code>guard let</code></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">printName</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">username</span>: <span class="hljs-type">String</span>?) {
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> username <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"name 为 nil，提前返回"</span>)
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-built_in">print</span>(name.count)
}
</code></pre>
<hr/>
<h2 data-id="heading-7">二、<code>!</code> —— 强制解包（Force Unwrap）</h2>
<h3 data-id="heading-8">定义方式</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> age: <span class="hljs-type">Int</span>! <span class="hljs-operator">=</span> <span class="hljs-number">18</span>
</code></pre>
<p>表示：</p>
<blockquote>
<p>“我<strong>确信</strong>这个变量在使用时一定不为 nil”</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">使用方式</h3>
<p>swift</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">print</span>(age + <span class="hljs-number">1</span>)   <span class="hljs-comment">// 看起来像非 Optional</span>
</code></pre>
<p><strong>风险点</strong></p>
<pre><code class="hljs language-swift" lang="swift">age <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
<span class="hljs-built_in">print</span>(age <span class="hljs-operator">+</span> <span class="hljs-number">1</span>)  <span class="hljs-comment">// 运行时崩溃</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">"!"的正确使用场景</h3>
<p>IBOutlet<br/>
生命周期受控变量</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">@IBOutlet</span> <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> titleLabel: <span class="hljs-type">UILabel</span>!
</code></pre>
<p>原因：</p>
<ul>
<li>view 加载完成后一定存在</li>
<li>系统保证初始化时机</li>
</ul>
<p>某些依赖注入后一定存在的对象</p>
<hr/>
<h3 data-id="heading-11">不推荐的用法</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">var</span> userName: <span class="hljs-type">String</span>!
<span class="hljs-built_in">print</span>(userName.count) <span class="hljs-comment">// 非常危险 ❌</span>
</code></pre>
<p><strong>总结一句话</strong>：</p>
<blockquote>
<p><code>!</code> 是写给“你未来的自己看的承诺”，一旦违背就会 Crash</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">三、<code>??</code> —— 空值合并运算符（Nil-Coalescing）</h2>
<h3 data-id="heading-13">基本用法</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> displayName <span class="hljs-operator">=</span> username <span class="hljs-operator">??</span> <span class="hljs-string">"匿名用户"</span>
</code></pre>
<p>含义：</p>
<blockquote>
<p>如果 <code>username</code> 不为 nil，使用它<br/>
否则使用 <code>"匿名用户"</code></p>
</blockquote>
<hr/>
<h3 data-id="heading-14">常见使用场景</h3>
<h4 data-id="heading-15">场景 1：UI 显示兜底</h4>
<pre><code class="hljs language-swift" lang="swift">titleLabel.text <span class="hljs-operator">=</span> model.title <span class="hljs-operator">??</span> <span class="hljs-string">"暂无标题"</span>
</code></pre>
<h4 data-id="heading-16">场景 2：参数默认值</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">func</span> <span class="hljs-title function_">loadData</span>(<span class="hljs-params">page</span>: <span class="hljs-type">Int</span>?) {
    <span class="hljs-keyword">let</span> currentPage <span class="hljs-operator">=</span> page <span class="hljs-operator">??</span> <span class="hljs-number">1</span>
    <span class="hljs-built_in">print</span>(currentPage)
}
</code></pre>
<h4 data-id="heading-17">场景 3：Data / String 转换兜底</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> <span class="hljs-type">Data</span>(base64Encoded: base64Str <span class="hljs-operator">??</span> <span class="hljs-string">""</span>)
</code></pre>
<hr/>
<h2 data-id="heading-18"><code>?</code> + <code>?.</code> —— 可选链（Optional Chaining）</h2>
<h3 data-id="heading-19">示例</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> length <span class="hljs-operator">=</span> username<span class="hljs-operator">?</span>.count
</code></pre>
<p>返回值类型：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">Int</span>?
</code></pre>
<p>如果 <code>username == nil</code>：</p>
<ul>
<li>不会执行 <code>.count</code></li>
<li>整个表达式返回 nil</li>
</ul>
<hr/>
<h3 data-id="heading-20">常见链式调用</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">let</span> city <span class="hljs-operator">=</span> user<span class="hljs-operator">?</span>.profile<span class="hljs-operator">?</span>.address<span class="hljs-operator">?</span>.city
</code></pre>
<h3 data-id="heading-21">从服务器返回数据解析</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span>?
    <span class="hljs-keyword">let</span> age: <span class="hljs-type">Int</span>?
}

<span class="hljs-keyword">func</span> <span class="hljs-title function_">showUser</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">user</span>: <span class="hljs-type">User</span>?) {
    <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> user <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"user 不存在"</span>)
        <span class="hljs-keyword">return</span>
    }
    
    <span class="hljs-keyword">let</span> name <span class="hljs-operator">=</span> user.name <span class="hljs-operator">??</span> <span class="hljs-string">"未知"</span>
    <span class="hljs-keyword">let</span> age <span class="hljs-operator">=</span> user.age <span class="hljs-operator">??</span> <span class="hljs-number">0</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"(name)，(age) 岁"</span>)
}
</code></pre>
<hr/>
<h2 data-id="heading-22">常见错误用法总结</h2>
<p>滥用 <code>!</code></p>
<pre><code class="hljs language-swift" lang="swift">user<span class="hljs-operator">!</span>.name<span class="hljs-operator">!</span>.count <span class="hljs-operator">❌</span>
</code></pre>
<p>嵌套 if let 过深</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> a <span class="hljs-operator">=</span> a {
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> b <span class="hljs-operator">=</span> b {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> c <span class="hljs-operator">=</span> c {
            <span class="hljs-operator">...</span>
        }
    }
}
</code></pre>
<p>更优写法：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> a, <span class="hljs-keyword">let</span> b, <span class="hljs-keyword">let</span> c <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>Swift 的 Optional 不是语法糖，而是 <strong>逼着你在代码层面提前思考风险</strong>。</p>
<p>如有说错的地方，满发指正相互学习，谢谢~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第十五章(Image)]]></title>    <link>https://juejin.cn/post/7585897699602923546</link>    <guid>https://juejin.cn/post/7585897699602923546</guid>    <pubDate>2025-12-22T02:17:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699602923546" data-draft-id="7585808181239873587" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第十五章(Image)"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-12-22T02:17:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第十五章(Image)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:17:09.000Z" title="Mon Dec 22 2025 02:17:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Image组件</h2>
<p>该组件是Next.js内置的图片组件，是基于原生<code>img</code>标签进行扩展，并不代表原生<code>img</code>标签不能使用。</p>
<ul>
<li>尺寸优化：支持使用现代化图片格式，如<code>webp</code>，<code>avif</code>，<code>apng</code>等,并自动根据设备提供正确的尺寸。</li>
<li>视觉稳定性：防止图片加载时发生布局偏移，具体参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fweb.dev%2Farticles%2Fcls%3Fhl%3Dzh-cn" target="_blank" title="https://web.dev/articles/cls?hl=zh-cn" ref="nofollow noopener noreferrer">CLS</a></li>
<li>懒加载：在图片进入视口才会加载，使用浏览器原生懒加载，并可选择添加模糊显示占位符。</li>
<li>灵活性：可按需调整图像大小，即使是存储在远程服务器上的图像也可以调整。</li>
</ul>
<h4 data-id="heading-1">图片引入</h4>
<h5 data-id="heading-2">1. src本地图片引入</h5>
<p>Next.js建议我们把图片放在根目录下的<code>public</code>文件夹中，然后使用<code>/</code>开头访问。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a73a9cf6e7c4be8b3f3b61e531a778f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974628&amp;x-signature=GFjfFcsoNvoSwKUNnkb9VH%2F68kc%3D" alt="public.png" loading="lazy"/></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                <span class="hljs-attr">src</span>=<span class="hljs-string">"/1.png"</span>
                <span class="hljs-attr">width</span>=<span class="hljs-string">{100}</span>
                <span class="hljs-attr">height</span>=<span class="hljs-string">{100}</span>
                <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
            /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-3">2. import静态引入</h5>
<p>使用<code>import</code>引入图片，是不需要填写宽度和高度，Next.js会自动确定图片的尺寸。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"@/public/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./public/*"</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 新增这一行代码，配置图片路径。</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>使用静态<code>import</code>引入图片，你会发现无需填写宽度和高度，Next.js会自动确定图片的尺寸。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">import</span> test <span class="hljs-keyword">from</span> <span class="hljs-string">'@/public/1.png'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                <span class="hljs-attr">src</span>=<span class="hljs-string">{test}</span>
                <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
            /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-4">3. 远程图片引入</h5>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>;
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>当我们直接使用远程图片引入的时候Next.js会报错，因为Next.js默认只允许加载本地图片，如果需要加载远程图片，需要配置<code>next.config.js</code>文件。</p>
<p>image-loader.ts:86 Uncaught Error: Invalid src prop (<a href="https://link.juejin.cn?target=https%3A%2F%2Feo-img.521799.xyz%2Fi%2Fpc%2Fimg1.webp" target="_blank" title="https://eo-img.521799.xyz/i/pc/img1.webp" ref="nofollow noopener noreferrer">eo-img.521799.xyz/i/pc/img1.w…</a>) on <code>next/image</code>, hostname "eo-img.521799.xyz" is not configured under images in your <code>next.config.js</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">remotePatterns</span>: [
      {
        <span class="hljs-attr">protocol</span>: <span class="hljs-string">'https'</span>, <span class="hljs-comment">// 协议</span>
        <span class="hljs-attr">hostname</span>: <span class="hljs-string">'eo-img.521799.xyz'</span>, <span class="hljs-comment">// 主机名</span>
        <span class="hljs-attr">pathname</span>: <span class="hljs-string">'/i/pc/**'</span>, <span class="hljs-comment">// 路径</span>
        <span class="hljs-attr">port</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// 端口</span>
      },
    ],
  },
};
</code></pre>
<h5 data-id="heading-5">4. LCP警告</h5>
<p>如果图片是首屏或者LCP图片，需要添加<code>loading="eager"</code>属性，否则会触发LCP警告,因为Image组件默认是懒加载的。</p>
<ul>
<li>lazy: 懒加载，默认值，在图片进入视口才会加载。</li>
<li>eager: 立即加载，在图片进入视口就会加载。</li>
</ul>
<p>Image with src "<a href="https://link.juejin.cn?target=https%3A%2F%2Feo-img.521799.xyz%2Fi%2Fpc%2Fimg1.webp" target="_blank" title="https://eo-img.521799.xyz/i/pc/img1.webp" ref="nofollow noopener noreferrer">eo-img.521799.xyz/i/pc/img1.w…</a>" was detected as the Largest Contentful Paint (LCP). Please add the <code>loading="eager"</code> property if this image is above the fold.
Read more: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fapi-reference%2Fcomponents%2Fimage%23loading" target="_blank" title="https://nextjs.org/docs/app/api-reference/components/image#loading" ref="nofollow noopener noreferrer">nextjs.org/docs/app/ap…</a></p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                    <span class="hljs-attr">loading</span>=<span class="hljs-string">"eager"</span> // <span class="hljs-attr">立即加载</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>第二种解决方案使用<code>preload</code>属性加载图片，表示提前预加载图片，不过Next.js还是更加推荐使用<code>loading="eager"</code>属性加载图片。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> len = <span class="hljs-number">20</span>
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {Array.from({ length: len }).map((_, index) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
                    <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                    <span class="hljs-attr">src</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">https:</span>//<span class="hljs-attr">eo-img.521799.xyz</span>/<span class="hljs-attr">i</span>/<span class="hljs-attr">pc</span>/<span class="hljs-attr">img</span>${<span class="hljs-attr">index</span> + <span class="hljs-attr">1</span>}<span class="hljs-attr">.webp</span>`}
                    <span class="hljs-attr">alt</span>=<span class="hljs-string">"1"</span>
                    <span class="hljs-attr">width</span>=<span class="hljs-string">{192}</span>
                    <span class="hljs-attr">height</span>=<span class="hljs-string">{108}</span>
                    <span class="hljs-attr">preload</span>=<span class="hljs-string">{index</span> &lt; <span class="hljs-attr">10</span>} // <span class="hljs-attr">优先加载策略</span>
                /&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h5 data-id="heading-6">5. 图片格式优化</h5>
<p>Next.js 会通过请求Accept头自动检测浏览器支持的图像格式，以确定最佳输出格式</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title class_">Accept</span>:image/avif,image/webp,image/apng,image/svg+xml,image<span class="hljs-comment">/*,*/</span>*;q=<span class="hljs-number">0.8</span>
</code></pre>
<p>我们可以同时启用 AVIF 和 WebP 格式。对于支持 AVIF 的浏览器，系统将优先使用 AVIF 格式，WebP 格式作为备选方案。目前AVIF格式最优。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">formats</span>: [<span class="hljs-string">'image/avif'</span>, <span class="hljs-string">'image/webp'</span>], <span class="hljs-comment">//默认是 ['image/webp']</span>
  },
};
</code></pre>
<h5 data-id="heading-7">6. 设备适配</h5>
<p>如果你的老板告诉你要兼容哪些设备，你可以使用<code>deviceSizes</code>和<code>imageSizes</code>属性来配置。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-comment">/* config options here */</span>
  <span class="hljs-attr">images</span>: {
    <span class="hljs-attr">deviceSizes</span>: [<span class="hljs-number">640</span>, <span class="hljs-number">750</span>, <span class="hljs-number">828</span>, <span class="hljs-number">1080</span>, <span class="hljs-number">1200</span>, <span class="hljs-number">1920</span>, <span class="hljs-number">2048</span>, <span class="hljs-number">3840</span>], <span class="hljs-comment">// 设备尺寸</span>
    <span class="hljs-attr">imageSizes</span>: [<span class="hljs-number">16</span>, <span class="hljs-number">32</span>, <span class="hljs-number">48</span>, <span class="hljs-number">64</span>, <span class="hljs-number">96</span>, <span class="hljs-number">128</span>, <span class="hljs-number">256</span>, <span class="hljs-number">384</span>], <span class="hljs-comment">// 图片尺寸</span>
  },
};
</code></pre>
<p>这两个属性结合会最终生成一个<code>srcset</code>属性，用于浏览器选择最佳图片。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bed6fc34c0a414484df71bcf1dbe922~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974628&amp;x-signature=vOdeCraZzznSMXE%2FFPdALioNi2Y%3D" alt="srcset.png" loading="lazy"/></p>
<p>那为什么需要两个数组去实现呢？</p>
<p>我们观察上图可以发现，<code>imageSizes</code>用于生成小图片尺寸例如(缩略图，头像等)，而<code>deviceSizes</code>用于生成大图片尺寸例如(横幅图、背景图、全屏展示图)。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Image</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/image"</span>

<span class="hljs-comment">// 头像 - 固定 64px</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Avatar</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/avatar.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{64}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{64}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"用户头像"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"64px"</span>  // ← <span class="hljs-attr">告诉浏览器这张图只需要</span> <span class="hljs-attr">64px</span>
    /&gt;</span></span>
  )
}

<span class="hljs-comment">// 横幅图 - 响应式全宽</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Banner</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/banner.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{1920}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{600}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"横幅"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"100vw"</span>  // ← <span class="hljs-attr">占满整个视口宽度</span>，<span class="hljs-attr">使用</span> <span class="hljs-attr">deviceSizes</span>
    /&gt;</span></span>
  )
}

<span class="hljs-comment">// 响应式内容图</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ContentImage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
      <span class="hljs-attr">src</span>=<span class="hljs-string">"/content.jpg"</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">{1200}</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">{800}</span>
      <span class="hljs-attr">alt</span>=<span class="hljs-string">"内容图"</span>
      <span class="hljs-attr">sizes</span>=<span class="hljs-string">"(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 1200px"</span>
      // ↑ <span class="hljs-attr">手机上</span> <span class="hljs-attr">100</span>% <span class="hljs-attr">宽度</span>，<span class="hljs-attr">平板上</span> <span class="hljs-attr">50</span>%，<span class="hljs-attr">桌面最大</span> <span class="hljs-attr">1200px</span>
    /&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-8">Props</h4>
<p>以下是 Image 组件可用的属性：</p>
<h5 data-id="heading-9">必需属性</h5>























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>src</td><td>String</td><td><code>src="/profile.png"</code></td><td>图片源路径，支持本地路径或远程 URL</td></tr><tr><td>alt</td><td>String</td><td><code>alt="Picture of the author"</code></td><td>图片替代文本，用于无障碍访问和 SEO</td></tr></tbody></table>
<h5 data-id="heading-10">尺寸相关</h5>



































<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>width</td><td>Integer (px)</td><td><code>width={500}</code></td><td>图片宽度，静态导入时可选</td></tr><tr><td>height</td><td>Integer (px)</td><td><code>height={500}</code></td><td>图片高度，静态导入时可选</td></tr><tr><td>fill</td><td>Boolean</td><td><code>fill={true}</code></td><td>填充父容器，替代 width 和 height</td></tr><tr><td>sizes</td><td>String</td><td><code>sizes="(max-width: 768px) 100vw"</code></td><td>响应式图片尺寸</td></tr></tbody></table>
<h5 data-id="heading-11">优化相关</h5>





























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>quality</td><td>Integer (1-100)</td><td><code>quality={80}</code></td><td>图片压缩质量，默认为 75</td></tr><tr><td>loader</td><td>Function</td><td><code>loader={imageLoader}</code></td><td>自定义图片加载器函数</td></tr><tr><td>unoptimized</td><td>Boolean</td><td><code>unoptimized={true}</code></td><td>禁用图片优化，使用原图</td></tr></tbody></table>
<h5 data-id="heading-12">加载相关</h5>



































<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>loading</td><td>String</td><td><code>loading="lazy"</code></td><td>加载策略，"lazy" 或 "eager"</td></tr><tr><td>preload</td><td>Boolean</td><td><code>preload={true}</code></td><td>是否预加载，用于 LCP 元素</td></tr><tr><td>placeholder</td><td>String</td><td><code>placeholder="blur"</code></td><td>占位符类型，"blur" 或 "empty"</td></tr><tr><td>blurDataURL</td><td>String</td><td><code>blurDataURL="data:image/jpeg..."</code></td><td>模糊占位符的 Data URL</td></tr></tbody></table>
<h5 data-id="heading-13">事件回调</h5>























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>onLoad</td><td>Function</td><td><code>onLoad={e =&gt; done()}</code></td><td>图片加载完成时的回调</td></tr><tr><td>onError</td><td>Function</td><td><code>onError={e =&gt; fail()}</code></td><td>图片加载失败时的回调</td></tr></tbody></table>
<h5 data-id="heading-14">其他属性</h5>





























<table><thead><tr><th>属性</th><th>类型</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>style</td><td>Object</td><td><code>style={{objectFit: "contain"}}</code></td><td>内联样式对象</td></tr><tr><td>overrideSrc</td><td>String</td><td><code>overrideSrc="/seo.png"</code></td><td>覆盖 src，用于 SEO 优化</td></tr><tr><td>decoding</td><td>String</td><td><code>decoding="async"</code></td><td>解码方式，"async"/"sync"/"auto"</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[antd 5 + react 18 + vite 7 升级]]></title>    <link>https://juejin.cn/post/7585948869844762659</link>    <guid>https://juejin.cn/post/7585948869844762659</guid>    <pubDate>2025-12-22T02:17:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585948869844762659" data-draft-id="7584719268044668962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="antd 5 + react 18 + vite 7 升级"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-22T02:17:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="holidaypenguin"/> <meta itemprop="url" content="https://juejin.cn/user/2313028194801421"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            antd 5 + react 18 + vite 7 升级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028194801421/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    holidaypenguin
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:17:19.000Z" title="Mon Dec 22 2025 02:17:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一年前react + vite + antd 项目 升级</h2>
<blockquote>
<p>目标升级到 antd 6 、 react 19、vite 8、babel-plugin-react-compiler</p>
<p>还有其他依赖项目 如 echarts</p>
</blockquote>
<h3 data-id="heading-1">升级 antd6 和 vite 8</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design.antgroup.com%2Fdocs%2Freact%2Fmigration-v6-cn" target="_blank" title="https://ant-design.antgroup.com/docs/react/migration-v6-cn" ref="nofollow noopener noreferrer">从 v5 到 v6 - Ant Design</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vite.dev%2Fblog%2Fannouncing-vite8-beta" target="_blank" title="https://cn.vite.dev/blog/announcing-vite8-beta" ref="nofollow noopener noreferrer">Vite 8 Beta: The Rolldown-powered Vite | Vite 官方中文文档</a></li>
</ul>
<h4 data-id="heading-2">更新相关依赖</h4>
<ul>
<li>手动查看相关依赖版本，修改antd和vite相关依赖版本
<ul>
<li>antd</li>
<li>@ant-design/icons</li>
<li>@vitejs/plugin-react-oxc -&gt; @vitejs/plugin-react</li>
<li>vite</li>
<li>其他一些无关紧要的依赖版本升级</li>
</ul>
</li>
<li><code>antd@6</code> 要求 <code>@ant-design/icons</code> 版本 &gt;= 6.0.0</li>
<li>@vitejs/plugin-react-oxc is deprecated. Please use @vitejs/plugin-react instead. The changes of this plugin is now included in @vitejs/plugin-react.</li>
</ul>
<p>修改相关依赖项版本然后安装依赖</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3deef43a06436dbb7d4fb673986fed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=yWn3N%2F%2FcTv0aoePwoglLwaINhF0%3D" alt="image.png" loading="lazy"/></p>
<p>第一次启动</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa81367939e140f5bfe49ee0b5b650c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=z0FUwfMVE7rO31XEiRMtBgm35gQ%3D" alt="image.png" loading="lazy"/></p>
<p>@vitejs/plugin-react</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a41ac2e84c149dc97e71d8a787165f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=xCWgBB15u25WX1glTRlpxYYgf0I%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">修改 antd 6 的API调整</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design.antgroup.com%2Fdocs%2Freact%2Fmigration-v6-cn%23api-%25E8%25B0%2583%25E6%2595%25B4" target="_blank" title="https://ant-design.antgroup.com/docs/react/migration-v6-cn#api-%E8%B0%83%E6%95%B4" ref="nofollow noopener noreferrer">从 v5 到 v6 - Ant Design</a></p>
<h5 data-id="heading-4"><code>Alert</code></h5>
<p>message  属性改成 title</p>
<h5 data-id="heading-5"><code>Card</code></h5>
<p>bodyStyle 属性没有了，组件中 styles 属性中 body 自定义的时候报错
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ef092b66e2d4dad884826b2200990e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=rft%2BS7qR1DEoh1meMlf%2BtE6CoSo%3D" alt="image.png" loading="lazy"/></p>
<p>因为  <code>styles</code> 的类型   Record&lt;<a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design.antgroup.com%2Fcomponents%2Fcard-cn%23semantic-dom" target="_blank" title="https://ant-design.antgroup.com/components/card-cn#semantic-dom" ref="nofollow noopener noreferrer">SemanticDOM</a>, CSSProperties&gt; | (info: { props })=&gt; Record&lt;<a href="https://link.juejin.cn?target=https%3A%2F%2Fant-design.antgroup.com%2Fcomponents%2Fcard-cn%23semantic-dom" target="_blank" title="https://ant-design.antgroup.com/components/card-cn#semantic-dom" ref="nofollow noopener noreferrer">SemanticDOM</a>, CSSProperties&gt;</p>
<p>增加一个代理属性</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> <span class="hljs-title function_">stylesProxy</span> = (<span class="hljs-params">info</span>) =&gt; {
    <span class="hljs-keyword">const</span> stylesObj = <span class="hljs-keyword">typeof</span> styles === <span class="hljs-string">'function'</span> ? <span class="hljs-title function_">styles</span>(info) : styles
    <span class="hljs-keyword">return</span> {
        ...stylesObj,
        <span class="hljs-attr">body</span>: {
            ...(stylesObj.<span class="hljs-property">body</span> || {}),
            <span class="hljs-attr">height</span>: full ? <span class="hljs-string">'100%'</span> : stylesObj?.<span class="hljs-property">body</span>?.<span class="hljs-property">height</span> || <span class="hljs-string">'auto'</span>,
        }
    }
}

&lt;<span class="hljs-title class_">Card</span> 
    {...args}
    styles={stylesProxy}
/&gt;
</code></pre>
<h5 data-id="heading-6"><code>Dropdown</code> <code>Button</code></h5>
<blockquote>
<p>hover显示的时候点击会消失，再次hover也不显示，等组件库升级好以后，在升级react 19 看看是否能解决。</p>
</blockquote>
<h5 data-id="heading-7"><code>Input</code> 和 <code>InputNumber</code>   <code>addonAfter</code>  <code>addonAfter</code> 属性废弃</h5>
<blockquote>
<p>预留问题：因为暂时还能用，先整体升级完再解决</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87fafaa096fc435a86c70fb68bb450d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=e3xGEsIOXB187Bm1nJlBaAIauTo%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-8"><code>Progress</code></h5>
<p><code>strokeWidth</code> 弃用，变为 <code>size</code>。当  <code>type="circle"</code>  <code>type="dashboard"</code> 的时候 strokeWidth 还是保留的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed8cb8242a404fd38a583a4773f52058~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=C9ZiJcpSGeRin94oDYJ%2BiiLjf4U%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-9"><code>Select</code></h5>
<p>filterOption 废弃，使用 showSearch.filterOption</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fef1f97fde94ba7b628e75f2e0cc8b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=aTWqmJ%2BOf0AA0LqJGedPDle8dIQ%3D" alt="image.png" loading="lazy"/></p>
<p>通用组件类型定义</p>
<pre><code class="hljs language-java" lang="java">export <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FISelectProps</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Omit</span>&lt;SelectProps, <span class="hljs-string">'filterOption'</span>&gt; {}
</code></pre>
<p>通用组件制定默认搜索方法</p>
<pre><code class="hljs language-tsx" lang="tsx">
<span class="hljs-keyword">const</span> <span class="hljs-attr">showSearchProxy</span>: <span class="hljs-title class_">SelectProps</span>[<span class="hljs-string">'showSearch'</span>] = <span class="hljs-keyword">typeof</span> showSearch === <span class="hljs-string">'boolean'</span> &amp;&amp; showSearch === <span class="hljs-literal">true</span>
    ? {
        <span class="hljs-attr">filterOption</span>: filterOptionProxy,
    }
    : <span class="hljs-keyword">typeof</span> showSearch !== <span class="hljs-string">'boolean'</span>
        ? {
            ...showSearch,
            <span class="hljs-attr">filterOption</span>: showSearch.<span class="hljs-property">filterOption</span> || filterOptionProxy,
        }
        : showSearch
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Fissues%2F55877" target="_blank" title="https://github.com/ant-design/ant-design/issues/55877" ref="nofollow noopener noreferrer">[Bug 6.0] Select 组件的 options 选项存在 label/value 等它支持的属性外的其他属性时 React 报警告错误 · Issue #55877 · ant-design/ant-design</a></p>
<p>这个警告是因为 Select 的 options 里自定义属性（比如 labelPinyin）被直接传递到 DOM 元素上，React 19 对未知属性检查更严格，所以会报错。Ant Design 6.0.0 没有自动过滤这些非标准属性，导致自定义字段会被当作 DOM 属性渲染，触发警告 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fant-design%2Fant-design%2Fblob%2F816912441c855a2bc17c06d697299f312d81a4a2%2Fcomponents%2Fselect%2Findex.tsx%23L3-L419" target="_blank" title="https://github.com/ant-design/ant-design/blob/816912441c855a2bc17c06d697299f312d81a4a2/components/select/index.tsx#L3-L419" ref="nofollow noopener noreferrer">源码分析</a>。</p>
<p>Issue 推荐做法是用 <code>optionRender</code>，只在渲染时取出自定义属性，不让它们直接传递到 DOM。例如：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">options</span> = [
  { label: <span class="hljs-string">'苹果'</span>, value: <span class="hljs-string">'apple'</span>, labelPinyin: <span class="hljs-string">'pingguo'</span> },
  { label: <span class="hljs-string">'香蕉'</span>, value: <span class="hljs-string">'banana'</span>, labelPinyin: <span class="hljs-string">'xiangjiao'</span> },
]<span class="hljs-comment">;</span>

&lt;Select
  <span class="hljs-attr">options</span>={options}
  <span class="hljs-attr">optionRender</span>={option =&gt; (
    &lt;span&gt;
      {option.data.label} &lt;span <span class="hljs-attr">style</span>={{ color: <span class="hljs-string">'#aaa'</span> }}&gt;{option.data.labelPinyin}&lt;/span&gt;
    &lt;/span&gt;
  )}
/&gt;
</code></pre>
<p>结果试了下都不行，仍然没有结果警告。但是我发现即使没有 optionRender ，选项出现的时候也没有问题，但是问题出现在选中后的显示上，我虽然加了 labelRender ，也一样会有警告。</p>
<p>所以我最终采用的办法是使用一个统一组件去过滤非必要的属性</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { memo, useContext, useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Select</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">SelectProps</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>

<span class="hljs-keyword">import</span> { isArray, isEmpty, isString } <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FISelectProps</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">SelectProps</span>, 'filterOption'&gt; {
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">FISelect</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">FISelectProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
    options,
    placeholder = <span class="hljs-string">'请选择'</span>,
    value,
    onChange = () =&gt; {},
    mode,
    allowClear = <span class="hljs-literal">true</span>,
    showSearch = <span class="hljs-literal">true</span>,
    fieldNames = {},
    optionRender,
    ...args
}</span>) =&gt;</span> {

    <span class="hljs-keyword">const</span> isMultiple = mode === <span class="hljs-string">'multiple'</span>
    <span class="hljs-keyword">const</span> [valueProxy, setValueProxy] = useState&lt;<span class="hljs-built_in">any</span>&gt;(isMultiple ? [] : <span class="hljs-string">''</span>)

    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-title function_">setValueProxy</span>(value)
    }, [value])


    <span class="hljs-keyword">const</span> <span class="hljs-title function_">getOptions</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-comment">// console.log('-- getOptions --')</span>
        <span class="hljs-keyword">return</span> (options || []).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">origin_data</span>: item,
                <span class="hljs-attr">value</span>: item[fieldNames.<span class="hljs-property">value</span> || <span class="hljs-string">'value'</span>],
                <span class="hljs-attr">label</span>: item[fieldNames.<span class="hljs-property">label</span> || <span class="hljs-string">'label'</span>],
            }
        })
    }

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">onChangeProxy</span> = (<span class="hljs-params">value: <span class="hljs-built_in">any</span>, option: <span class="hljs-built_in">any</span></span>) =&gt; {
        <span class="hljs-comment">// console.log('--onChangeProxy--', value, option, getOuterValue(value))</span>
        <span class="hljs-title function_">onChange</span>(value, option.<span class="hljs-property">origin_data</span>)
    }

    <span class="hljs-keyword">const</span> <span class="hljs-attr">showSearchProxy</span>: <span class="hljs-title class_">SelectProps</span>[<span class="hljs-string">'showSearch'</span>] = <span class="hljs-keyword">typeof</span> showSearch === <span class="hljs-string">'boolean'</span> &amp;&amp; showSearch === <span class="hljs-literal">true</span>
        ? {
            <span class="hljs-attr">filterOption</span>: filterOptionProxy,
        }
        : <span class="hljs-keyword">typeof</span> showSearch !== <span class="hljs-string">'boolean'</span>
            ? {
                ...showSearch,
                <span class="hljs-attr">filterOption</span>: showSearch.<span class="hljs-property">filterOption</span> || filterOptionProxy,
            }
            : showSearch

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">filterOptionProxy</span> (<span class="hljs-attr">inputValue</span>: <span class="hljs-built_in">any</span>, <span class="hljs-attr">option</span>: <span class="hljs-built_in">any</span>) {
        <span class="hljs-comment">// console.log('-- filterOptionProxy --',inputValue, option)</span>
        <span class="hljs-keyword">const</span> { <span class="hljs-attr">value</span>: vf, <span class="hljs-attr">label</span>: vl } = fieldNames
        <span class="hljs-keyword">const</span> value = option.<span class="hljs-property">origin_data</span>[vf || <span class="hljs-string">'value'</span>]
        <span class="hljs-keyword">const</span> label = option.<span class="hljs-property">origin_data</span>[vl || <span class="hljs-string">'label'</span>]
        <span class="hljs-keyword">return</span> value?.<span class="hljs-property">toString</span>?.() === inputValue?.<span class="hljs-property">toString</span>?.() || <span class="hljs-title class_">String</span>(label).<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">indexOf</span>(<span class="hljs-title class_">String</span>(inputValue).<span class="hljs-title function_">toLowerCase</span>()) &gt; -<span class="hljs-number">1</span>
    }

    <span class="hljs-keyword">const</span> <span class="hljs-attr">optionRenderProxy</span>: <span class="hljs-title class_">SelectProps</span>[<span class="hljs-string">'optionRender'</span>] = <span class="hljs-function">(<span class="hljs-params">option: <span class="hljs-built_in">any</span>, info</span>) =&gt;</span> {
        <span class="hljs-comment">// console.log('-- optionRenderProxy --',option, info)</span>
        <span class="hljs-keyword">const</span> value = option.<span class="hljs-property">data</span>.<span class="hljs-property">origin_data</span>[fieldNames.<span class="hljs-property">value</span> || <span class="hljs-string">'value'</span>]
        <span class="hljs-keyword">const</span> label = option.<span class="hljs-property">data</span>.<span class="hljs-property">origin_data</span>[fieldNames.<span class="hljs-property">label</span> || <span class="hljs-string">'label'</span>]
        <span class="hljs-keyword">if</span> (!optionRender) {
            <span class="hljs-keyword">return</span> (label)
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">optionRender</span>(option.<span class="hljs-property">data</span>.<span class="hljs-property">origin_data</span>, info)
    }

    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Select</span>
            {<span class="hljs-attr">...args</span>}
            <span class="hljs-attr">options</span>=<span class="hljs-string">{getOptions()}</span>
            <span class="hljs-attr">placeholder</span>=<span class="hljs-string">{placeholder}</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">fi-select</span> ${<span class="hljs-attr">args.className</span> || ''}`}
            <span class="hljs-attr">value</span>=<span class="hljs-string">{valueProxy}</span>
            <span class="hljs-attr">onChange</span>=<span class="hljs-string">{onChangeProxy}</span>
            <span class="hljs-attr">mode</span>=<span class="hljs-string">{mode}</span>
            <span class="hljs-attr">allowClear</span>=<span class="hljs-string">{allowClear}</span>
            <span class="hljs-attr">showSearch</span>=<span class="hljs-string">{showSearchProxy}</span>
            <span class="hljs-attr">optionRender</span>=<span class="hljs-string">{optionRender</span> ? <span class="hljs-attr">optionRenderProxy</span> <span class="hljs-attr">:</span> <span class="hljs-attr">undefined</span>}
        /&gt;</span></span>
    )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">memo</span>(<span class="hljs-title class_">FISelect</span>)
</code></pre>
<h3 data-id="heading-10">升级 react 19</h3>
<p>react-activation</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f888a448c4f34a2ebc984a9fe67ab974~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaG9saWRheXBlbmd1aW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766974639&amp;x-signature=Wi3hVS%2FevhWk4wLfBd1X4%2FxR%2Fog%3D" alt="image.png" loading="lazy"/></p>
<p>使用 <code>keepalive-for-react</code> 替代 <code>react-activation</code></p>
<ol>
<li><strong>React Router v7 架构变更</strong>
<ul>
<li>React Router v7 使用了新的 Data Router 架构</li>
<li>要求所有 hooks 必须在正确的 router 上下文内使用</li>
<li>对组件嵌套和上下文传递有更严格的要求</li>
</ul>
</li>
<li><strong>react-activation 不兼容</strong>
<ul>
<li><code>react-activation</code> (v0.13.4) 还不支持 React 19,但是理论上是支持的</li>
<li>与 React Router v7 的新架构存在冲突</li>
<li><code>KeepAlive</code> 组件破坏了 Router 的上下文传递</li>
<li>查看了下组件的使用方式，发现原来的使用方法可能不正确，待后续解决</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">升级 babel-plugin-react-compiler</h3>
<h3 data-id="heading-12">升级其他组件库</h3>
<h3 data-id="heading-13">遗留问题</h3>
<ul>
<li>Input  InputNumber   addonAfter  addonAfter 属性废弃 解决方案</li>
<li>react-activation 无法运行</li>
<li>升级babel-plugin-react-compiler</li>
<li>升级其他组件库</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再到处try-catch了！SpringBoot全局异常处理这样设计]]></title>    <link>https://juejin.cn/post/7585808181239922739</link>    <guid>https://juejin.cn/post/7585808181239922739</guid>    <pubDate>2025-12-22T02:26:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585808181239922739" data-draft-id="7585920796100018203" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再到处try-catch了！SpringBoot全局异常处理这样设计"/> <meta itemprop="keywords" content="后端,Java,Spring Boot"/> <meta itemprop="datePublished" content="2025-12-22T02:26:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小坏说Java"/> <meta itemprop="url" content="https://juejin.cn/user/3898184413750203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再到处try-catch了！SpringBoot全局异常处理这样设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3898184413750203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小坏说Java
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:26:01.000Z" title="Mon Dec 22 2025 02:26:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">《别再到处try-catch了！SpringBoot全局异常处理这样设计》</h2>
<blockquote>
<p>每天5分钟，掌握一个SpringBoot核心知识点。大家好，我是SpringBoot指南的创始人小明。昨天我们讲解了自动配置，今天来聊聊异常处理。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
</blockquote>
<p><strong>资源获取</strong>：<strong>关注公众号：小坏睡说Java</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h3 data-id="heading-1">引言</h3>
<p>想象一下这样的场景：你的项目有50个Controller，每个Controller方法里都有类似的try-catch代码，而且每个开发者处理异常的方式都不一样。线上出了问题，日志里要么没有记录，要么记录得乱七八糟...</p>
<p>这就是为什么我们需要统一的全局异常处理。今天，我将带你设计一个优雅的全局异常处理方案，让你的代码<strong>干净、统一、易于维护</strong>。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<p>先看两个对比：</p>
<p><strong>❌ 混乱的异常处理方式</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@PostMapping("/register")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;?&gt; register(<span class="hljs-meta">@RequestBody</span> UserDTO user) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">User</span> <span class="hljs-variable">registered</span> <span class="hljs-operator">=</span> userService.register(user);
            <span class="hljs-keyword">return</span> ResponseEntity.ok(registered);
        } <span class="hljs-keyword">catch</span> (ValidationException e) {
            <span class="hljs-keyword">return</span> ResponseEntity.badRequest().body(<span class="hljs-string">"参数错误："</span> + e.getMessage());
        } <span class="hljs-keyword">catch</span> (DuplicateException e) {
            <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">409</span>).body(<span class="hljs-string">"用户已存在"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"注册失败"</span>, e);
            <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">500</span>).body(<span class="hljs-string">"系统繁忙"</span>);
        }
    }
    
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;?&gt; getUser(<span class="hljs-meta">@PathVariable</span> Long id) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findById(id);
            <span class="hljs-keyword">return</span> ResponseEntity.ok(user);
        } <span class="hljs-keyword">catch</span> (NotFoundException e) {
            <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">404</span>).body(<span class="hljs-string">"用户不存在"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"查询用户失败"</span>, e);
            <span class="hljs-keyword">return</span> ResponseEntity.status(<span class="hljs-number">500</span>).body(<span class="hljs-string">"系统错误"</span>);
        }
    }
    <span class="hljs-comment">// ... 其他方法重复类似的模式</span>
}
</code></pre>
<p><strong>✅ 优雅的全局异常处理</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@PostMapping("/register")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;User&gt; <span class="hljs-title function_">register</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserDTO user)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">registered</span> <span class="hljs-operator">=</span> userService.register(user);
        <span class="hljs-keyword">return</span> ResponseResult.success(registered);
    }
    
    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;User&gt; <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findById(id);
        <span class="hljs-keyword">return</span> ResponseResult.success(user);
    }
    <span class="hljs-comment">// ... 干净的业务代码，不包含任何异常处理逻辑</span>
}
</code></pre>
<p>所有的异常都在<strong>一个地方统一处理</strong>！下面，让我们一步步实现这个目标。</p>
<h3 data-id="heading-2">一、SpringBoot异常处理核心注解</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-3">1. @ControllerAdvice：全局异常处理的基石</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ControllerAdvice {
    <span class="hljs-comment">// 可以指定要处理的包</span>
    String[] value() <span class="hljs-keyword">default</span> {};
    
    <span class="hljs-comment">// 指定要处理的Controller类型</span>
    Class&lt;?&gt;[] basePackageClasses() <span class="hljs-keyword">default</span> {};
    
    <span class="hljs-comment">// 指定要处理的注解</span>
    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Annotation</span>&gt;[] annotations() <span class="hljs-keyword">default</span> {};
}
</code></pre>
<p><strong>三种常见用法</strong>：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式1：处理所有Controller的异常（最常用）</span>
<span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    <span class="hljs-comment">// 处理逻辑...</span>
}

<span class="hljs-comment">// 方式2：只处理指定包下的Controller</span>
<span class="hljs-meta">@ControllerAdvice("com.example.user")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserExceptionHandler</span> {
    <span class="hljs-comment">// 只处理user模块的异常</span>
}

<span class="hljs-comment">// 方式3：只处理带有特定注解的Controller</span>
<span class="hljs-meta">@ControllerAdvice(annotations = RestController.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RestExceptionHandler</span> {
    <span class="hljs-comment">// 只处理@RestController注解的类</span>
}
</code></pre>
<h4 data-id="heading-4">2. @RestControllerAdvice：更便捷的选择</h4>
<p><code>@RestControllerAdvice</code> 是 <code>@ControllerAdvice</code> 和 <code>@ResponseBody</code> 的组合，专门用于REST API开发。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.TYPE)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-meta">@ResponseBody</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> RestControllerAdvice {
    <span class="hljs-comment">// 同@ControllerAdvice</span>
}
</code></pre>
<h4 data-id="heading-5">3. @ExceptionHandler：指定处理什么异常</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> ExceptionHandler {
    <span class="hljs-comment">// 指定要处理的异常类型</span>
    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span>&gt;[] value() <span class="hljs-keyword">default</span> {};
}
</code></pre>
<h3 data-id="heading-6">二、设计优雅的异常体系</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-7">1. 异常分类策略</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-built_in">Throwable</span>
├── <span class="hljs-built_in">Error</span>（系统错误，如OutOfMemoryError，通常不捕获）
└── <span class="hljs-built_in">Exception</span>（异常）
    ├── <span class="hljs-built_in">RuntimeException</span>（运行时异常）
    │   ├── BusinessException（自定义业务异常）
    │   │   ├── ValidationException（参数校验异常）
    │   │   ├── DuplicateException（数据重复异常）
    │   │   ├── NotFoundException（数据不存在异常）
    │   │   └── PermissionException（权限异常）
    │   └── SystemException（自定义系统异常）
    └── 其他Checked <span class="hljs-built_in">Exception</span>（已检查异常）
</code></pre>
<h4 data-id="heading-8">2. 基础异常类设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基础业务异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RuntimeException</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String message;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String message)</span> {
        <span class="hljs-built_in">super</span>(message);
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.message = message;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BusinessException</span><span class="hljs-params">(ErrorCode errorCode)</span> {
        <span class="hljs-built_in">super</span>(errorCode.getMessage());
        <span class="hljs-built_in">this</span>.code = errorCode.getCode();
        <span class="hljs-built_in">this</span>.message = errorCode.getMessage();
    }
    
    <span class="hljs-comment">// getters...</span>
}

<span class="hljs-comment">// 错误码枚举</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ErrorCode</span> {
    <span class="hljs-comment">// 系统错误</span>
    SUCCESS(<span class="hljs-number">200</span>, <span class="hljs-string">"成功"</span>),
    SYSTEM_ERROR(<span class="hljs-number">500</span>, <span class="hljs-string">"系统错误"</span>),
    
    <span class="hljs-comment">// 业务错误</span>
    PARAM_VALID_ERROR(<span class="hljs-number">10001</span>, <span class="hljs-string">"参数校验失败"</span>),
    DATA_NOT_FOUND(<span class="hljs-number">10002</span>, <span class="hljs-string">"数据不存在"</span>),
    DATA_DUPLICATE(<span class="hljs-number">10003</span>, <span class="hljs-string">"数据已存在"</span>),
    PERMISSION_DENIED(<span class="hljs-number">10004</span>, <span class="hljs-string">"权限不足"</span>),
    USER_NOT_LOGIN(<span class="hljs-number">10005</span>, <span class="hljs-string">"用户未登录"</span>),
    
    <span class="hljs-comment">// 第三方服务错误</span>
    THIRD_PARTY_ERROR(<span class="hljs-number">20001</span>, <span class="hljs-string">"第三方服务异常"</span>);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String message;
    
    ErrorCode(<span class="hljs-type">int</span> code, String message) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.message = message;
    }
    
    <span class="hljs-comment">// getters...</span>
}

<span class="hljs-comment">// 具体的业务异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ValidationException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BusinessException</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ValidationException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(ErrorCode.PARAM_VALID_ERROR.getCode(), message);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotFoundException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BusinessException</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NotFoundException</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-built_in">super</span>(ErrorCode.DATA_NOT_FOUND.getCode(), message);
    }
}
</code></pre>
<h3 data-id="heading-9">三、统一响应体设计</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-10">1. 响应体基础结构</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 统一响应体</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponseResult</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;        <span class="hljs-comment">// 状态码</span>
    <span class="hljs-keyword">private</span> String message;  <span class="hljs-comment">// 消息</span>
    <span class="hljs-keyword">private</span> T data;          <span class="hljs-comment">// 数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> timestamp;  <span class="hljs-comment">// 时间戳</span>
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ResponseResult&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> success(<span class="hljs-literal">null</span>);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ResponseResult&lt;T&gt; <span class="hljs-title function_">success</span><span class="hljs-params">(T data)</span> {
        <span class="hljs-keyword">return</span> ResponseResult.&lt;T&gt;builder()
                .code(ErrorCode.SUCCESS.getCode())
                .message(ErrorCode.SUCCESS.getMessage())
                .data(data)
                .timestamp(System.currentTimeMillis())
                .build();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ResponseResult&lt;T&gt; <span class="hljs-title function_">fail</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String message)</span> {
        <span class="hljs-keyword">return</span> ResponseResult.&lt;T&gt;builder()
                .code(code)
                .message(message)
                .timestamp(System.currentTimeMillis())
                .build();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; ResponseResult&lt;T&gt; <span class="hljs-title function_">fail</span><span class="hljs-params">(ErrorCode errorCode)</span> {
        <span class="hljs-keyword">return</span> fail(errorCode.getCode(), errorCode.getMessage());
    }
}
</code></pre>
<h3 data-id="heading-11">四、实现全局异常处理器</h3>
<h4 data-id="heading-12">1. 完整异常处理器实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    
    <span class="hljs-comment">/**
     * 处理业务异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleBusinessException</span><span class="hljs-params">(BusinessException e)</span> {
        log.warn(<span class="hljs-string">"业务异常：code={}, message={}"</span>, e.getCode(), e.getMessage());
        <span class="hljs-keyword">return</span> ResponseResult.fail(e.getCode(), e.getMessage());
    }
    
    <span class="hljs-comment">/**
     * 处理参数校验异常（<span class="hljs-doctag">@Validated</span>触发的异常）
     */</span>
    <span class="hljs-meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleMethodArgumentNotValidException</span><span class="hljs-params">(
            MethodArgumentNotValidException e)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> e.getBindingResult().getAllErrors().stream()
                .map(DefaultMessageSourceResolvable::getDefaultMessage)
                .collect(Collectors.joining(<span class="hljs-string">", "</span>));
        log.warn(<span class="hljs-string">"参数校验失败：{}"</span>, message);
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.PARAM_VALID_ERROR.getCode(), message);
    }
    
    <span class="hljs-comment">/**
     * 处理请求参数绑定异常（类型转换错误等）
     */</span>
    <span class="hljs-meta">@ExceptionHandler(BindException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleBindException</span><span class="hljs-params">(BindException e)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> e.getBindingResult().getAllErrors().stream()
                .map(ObjectError::getDefaultMessage)
                .collect(Collectors.joining(<span class="hljs-string">", "</span>));
        log.warn(<span class="hljs-string">"参数绑定失败：{}"</span>, message);
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.PARAM_VALID_ERROR.getCode(), message);
    }
    
    <span class="hljs-comment">/**
     * 处理参数解析异常（JSON解析错误等）
     */</span>
    <span class="hljs-meta">@ExceptionHandler(HttpMessageNotReadableException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleHttpMessageNotReadableException</span><span class="hljs-params">(
            HttpMessageNotReadableException e)</span> {
        log.warn(<span class="hljs-string">"请求参数解析失败"</span>, e);
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.PARAM_VALID_ERROR.getCode(), <span class="hljs-string">"请求参数格式错误"</span>);
    }
    
    <span class="hljs-comment">/**
     * 处理404异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(NoHandlerFoundException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleNoHandlerFoundException</span><span class="hljs-params">(
            NoHandlerFoundException e)</span> {
        log.warn(<span class="hljs-string">"接口不存在：{} {}"</span>, e.getHttpMethod(), e.getRequestURL());
        <span class="hljs-keyword">return</span> ResponseResult.fail(<span class="hljs-number">404</span>, <span class="hljs-string">"接口不存在"</span>);
    }
    
    <span class="hljs-comment">/**
     * 处理请求方法不支持异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(HttpRequestMethodNotSupportedException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleHttpRequestMethodNotSupportedException</span><span class="hljs-params">(
            HttpRequestMethodNotSupportedException e)</span> {
        log.warn(<span class="hljs-string">"请求方法不支持：{}，支持的方法：{}"</span>, 
                e.getMethod(), e.getSupportedHttpMethods());
        <span class="hljs-keyword">return</span> ResponseResult.fail(<span class="hljs-number">405</span>, <span class="hljs-string">"请求方法不支持"</span>);
    }
    
    <span class="hljs-comment">/**
     * 处理所有未捕获的异常
     */</span>
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception e)</span> {
        log.error(<span class="hljs-string">"系统异常"</span>, e);
        
        <span class="hljs-comment">// 生产环境返回模糊的错误信息，开发环境返回详细错误</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> isProduction() ? <span class="hljs-string">"系统繁忙，请稍后重试"</span> : e.getMessage();
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.SYSTEM_ERROR.getCode(), message);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isProduction</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">env</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"spring.profiles.active"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"prod"</span>.equals(env);
    }
}
</code></pre>
<h4 data-id="heading-13">2. 增强版：带异常日志记录的处理器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnhancedGlobalExceptionHandler</span> {
    
    <span class="hljs-comment">/**
     * 异常信息上下文，用于记录额外信息
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;Map&lt;String, Object&gt;&gt; exceptionContext = 
            ThreadLocal.withInitial(HashMap::<span class="hljs-keyword">new</span>);
    
    <span class="hljs-comment">/**
     * 添加上下文信息（可在业务代码中调用）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addContext</span><span class="hljs-params">(String key, Object value)</span> {
        exceptionContext.get().put(key, value);
    }
    
    <span class="hljs-comment">/**
     * 清理上下文（在过滤器或拦截器中调用）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearContext</span><span class="hljs-params">()</span> {
        exceptionContext.remove();
    }
    
    <span class="hljs-meta">@ExceptionHandler(BusinessException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleBusinessException</span><span class="hljs-params">(
            BusinessException e, HttpServletRequest request)</span> {
        
        Map&lt;String, Object&gt; context = exceptionContext.get();
        log.warn(<span class="hljs-string">"业务异常 | 路径：{} | 参数：{} | 错误码：{} | 消息：{} | 上下文：{}"</span>,
                request.getRequestURI(),
                getRequestParams(request),
                e.getCode(),
                e.getMessage(),
                context);
        
        clearContext();
        <span class="hljs-keyword">return</span> ResponseResult.fail(e.getCode(), e.getMessage());
    }
    
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleException</span><span class="hljs-params">(
            Exception e, HttpServletRequest request)</span> {
        
        Map&lt;String, Object&gt; context = exceptionContext.get();
        log.error(<span class="hljs-string">"系统异常 | 路径：{} | 参数：{} | 上下文：{}"</span>,
                request.getRequestURI(),
                getRequestParams(request),
                context,
                e);
        
        clearContext();
        <span class="hljs-keyword">return</span> ResponseResult.fail(ErrorCode.SYSTEM_ERROR.getCode(), 
                isProduction() ? <span class="hljs-string">"系统繁忙"</span> : e.getMessage());
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">getRequestParams</span><span class="hljs-params">(HttpServletRequest request)</span> {
        Map&lt;String, String[]&gt; params = request.getParameterMap();
        <span class="hljs-keyword">return</span> params.entrySet().stream()
                .map(entry -&gt; entry.getKey() + <span class="hljs-string">"="</span> + 
                        Arrays.toString(entry.getValue()))
                .collect(Collectors.joining(<span class="hljs-string">", "</span>));
    }
    
    <span class="hljs-comment">// ... 其他异常处理方法</span>
}
</code></pre>
<h3 data-id="heading-14">五、最佳实践与高级用法</h3>
<h4 data-id="heading-15">1. 参数校验的优雅处理</h4>
<p><strong>传统方式</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
    <span class="hljs-meta">@PostMapping("/user")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@Valid</span> <span class="hljs-meta">@RequestBody</span> UserDTO user)</span> {
        <span class="hljs-comment">// 需要手动处理BindingResult</span>
        <span class="hljs-comment">// 或者依赖全局异常处理器</span>
    }
}
</code></pre>
<p><strong>增强方式</strong>：自定义校验注解</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自定义手机号校验注解</span>
<span class="hljs-meta">@Target({ElementType.FIELD})</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Constraint(validatedBy = PhoneValidator.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Phone {
    String <span class="hljs-title function_">message</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"手机号格式错误"</span>;
    Class&lt;?&gt;[] groups() <span class="hljs-keyword">default</span> {};
    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Payload</span>&gt;[] payload() <span class="hljs-keyword">default</span> {};
}

<span class="hljs-comment">// 实现校验逻辑</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PhoneValidator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConstraintValidator</span>&lt;Phone, String&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Pattern</span> <span class="hljs-variable">PHONE_PATTERN</span> <span class="hljs-operator">=</span> 
            Pattern.compile(<span class="hljs-string">"^1[3-9]\\d{9}$"</span>);
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">(String value, ConstraintValidatorContext context)</span> {
        <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 由@NotNull处理空值</span>
        }
        <span class="hljs-keyword">return</span> PHONE_PATTERN.matcher(value).matches();
    }
}

<span class="hljs-comment">// 使用方式</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDTO</span> {
    <span class="hljs-meta">@NotBlank(message = "用户名不能为空")</span>
    <span class="hljs-meta">@Size(min = 2, max = 20, message = "用户名长度2-20")</span>
    <span class="hljs-keyword">private</span> String username;
    
    <span class="hljs-meta">@Phone</span>  <span class="hljs-comment">// 使用自定义注解</span>
    <span class="hljs-keyword">private</span> String phone;
}
</code></pre>
<h4 data-id="heading-16">2. 多环境差异化处理</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">profiles:</span>
    <span class="hljs-attr">active:</span> <span class="hljs-string">dev</span>

<span class="hljs-attr">app:</span>
  <span class="hljs-attr">exception:</span>
    <span class="hljs-comment"># 开发环境返回详细错误</span>
    <span class="hljs-attr">detail-in-dev:</span> <span class="hljs-literal">true</span>
    <span class="hljs-comment"># 生产环境屏蔽堆栈</span>
    <span class="hljs-attr">hide-stack-in-prod:</span> <span class="hljs-literal">true</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ConfigurationProperties(prefix = "app.exception")</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionProperties</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">detailInDev</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">hideStackInProd</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-meta">@RestControllerAdvice</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EnvironmentAwareExceptionHandler</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ExceptionProperties properties;
    
    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception e, 
            HttpServletRequest request)</span> {
        
        <span class="hljs-comment">// 记录异常日志（生产环境记录简要，开发环境记录详细）</span>
        <span class="hljs-keyword">if</span> (isProduction()) {
            log.error(<span class="hljs-string">"系统异常 | 路径：{} | 错误：{}"</span>, 
                    request.getRequestURI(), e.getMessage());
        } <span class="hljs-keyword">else</span> {
            log.error(<span class="hljs-string">"系统异常 | 路径：{}"</span>, request.getRequestURI(), e);
        }
        
        <span class="hljs-comment">// 构建响应</span>
        <span class="hljs-type">ErrorResponse</span> <span class="hljs-variable">error</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ErrorResponse</span>();
        error.setCode(ErrorCode.SYSTEM_ERROR.getCode());
        error.setMessage(buildErrorMessage(e));
        
        <span class="hljs-keyword">if</span> (!isProduction() &amp;&amp; properties.isDetailInDev()) {
            error.setDetail(e.getMessage());
            error.setPath(request.getRequestURI());
            error.setException(e.getClass().getName());
        }
        
        <span class="hljs-keyword">if</span> (!isProduction() || !properties.isHideStackInProd()) {
            error.setTrace(getStackTrace(e));
        }
        
        <span class="hljs-keyword">return</span> ResponseResult.fail(error);
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildErrorMessage</span><span class="hljs-params">(Exception e)</span> {
        <span class="hljs-keyword">if</span> (isProduction()) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"系统繁忙，请稍后重试"</span>;
        }
        <span class="hljs-keyword">return</span> e.getMessage();
    }
}
</code></pre>
<h4 data-id="heading-17">3. 集成Sentinel进行流控异常处理</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SentinelExceptionHandler</span> {
    
    <span class="hljs-meta">@ExceptionHandler(BlockException.class)</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">handleBlockException</span><span class="hljs-params">(BlockException e)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">"系统繁忙，请稍后重试"</span>;
        
        <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> FlowException) {
            message = <span class="hljs-string">"接口限流，请稍后重试"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> DegradeException) {
            message = <span class="hljs-string">"接口降级，请稍后重试"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> ParamFlowException) {
            message = <span class="hljs-string">"热点参数限流"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> SystemBlockException) {
            message = <span class="hljs-string">"系统保护（CPU/负载）"</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> AuthorityException) {
            message = <span class="hljs-string">"授权规则不通过"</span>;
        }
        
        log.warn(<span class="hljs-string">"Sentinel流控：{}"</span>, message);
        <span class="hljs-keyword">return</span> ResponseResult.fail(<span class="hljs-number">429</span>, message);
    }
}
</code></pre>
<h3 data-id="heading-18">六、完整示例：电商系统异常处理实战</h3>
<h4 data-id="heading-19">1. 业务异常定义</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 库存不足异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InsufficientStockException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BusinessException</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long productId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer requested;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Integer available;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InsufficientStockException</span><span class="hljs-params">(Long productId, 
            Integer requested, Integer available)</span> {
        <span class="hljs-built_in">super</span>(ErrorCode.INSUFFICIENT_STOCK);
        <span class="hljs-built_in">this</span>.productId = productId;
        <span class="hljs-built_in">this</span>.requested = requested;
        <span class="hljs-built_in">this</span>.available = available;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getMessage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"商品[%d]库存不足，需要%d，可用%d"</span>, 
                productId, requested, available);
    }
}

<span class="hljs-comment">// 订单状态异常</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderStateException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BusinessException</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Long orderId;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String currentState;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String requiredState;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderStateException</span><span class="hljs-params">(Long orderId, 
            String currentState, String requiredState)</span> {
        <span class="hljs-built_in">super</span>(ErrorCode.ORDER_STATE_ERROR);
        <span class="hljs-built_in">this</span>.orderId = orderId;
        <span class="hljs-built_in">this</span>.currentState = currentState;
        <span class="hljs-built_in">this</span>.requiredState = requiredState;
    }
}
</code></pre>
<h4 data-id="heading-20">2. 业务使用示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(OrderCreateDTO dto)</span> {
        <span class="hljs-comment">// 参数校验（会自动抛出MethodArgumentNotValidException）</span>
        validateOrder(dto);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 检查库存</span>
            checkStock(dto);
            
            <span class="hljs-comment">// 创建订单</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> buildOrder(dto);
            orderRepository.save(order);
            
            <span class="hljs-comment">// 扣减库存</span>
            reduceStock(dto);
            
            <span class="hljs-comment">// 发送创建订单事件</span>
            eventPublisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderCreatedEvent</span>(order));
            
            <span class="hljs-keyword">return</span> order;
            
        } <span class="hljs-keyword">catch</span> (InsufficientStockException e) {
            <span class="hljs-comment">// 添加上下文信息，便于日志记录</span>
            EnhancedGlobalExceptionHandler.addContext(<span class="hljs-string">"orderDTO"</span>, dto);
            <span class="hljs-keyword">throw</span> e;
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkStock</span><span class="hljs-params">(OrderCreateDTO dto)</span> {
        dto.getItems().forEach(item -&gt; {
            <span class="hljs-type">Integer</span> <span class="hljs-variable">available</span> <span class="hljs-operator">=</span> stockService.getAvailableStock(item.getProductId());
            <span class="hljs-keyword">if</span> (available &lt; item.getQuantity()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientStockException</span>(
                        item.getProductId(), 
                        item.getQuantity(), 
                        available);
            }
        });
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateOrder</span><span class="hljs-params">(OrderCreateDTO dto)</span> {
        <span class="hljs-keyword">if</span> (dto.getItems() == <span class="hljs-literal">null</span> || dto.getItems().isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationException</span>(<span class="hljs-string">"订单商品不能为空"</span>);
        }
        
        <span class="hljs-keyword">if</span> (dto.getTotalAmount() == <span class="hljs-literal">null</span> || dto.getTotalAmount().compareTo(BigDecimal.ZERO) &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValidationException</span>(<span class="hljs-string">"订单金额必须大于0"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-21">3. Controller层示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/orders")</span>
<span class="hljs-meta">@Validated</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Order&gt; <span class="hljs-title function_">createOrder</span><span class="hljs-params">(
            <span class="hljs-meta">@Valid</span> <span class="hljs-meta">@RequestBody</span> OrderCreateDTO dto)</span> {
        
        log.info(<span class="hljs-string">"创建订单，用户：{}，商品数量：{}"</span>, 
                dto.getUserId(), dto.getItems().size());
        
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(dto);
        <span class="hljs-keyword">return</span> ResponseResult.success(order);
    }
    
    <span class="hljs-meta">@PostMapping("/{orderId}/cancel")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Void&gt; <span class="hljs-title function_">cancelOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long orderId)</span> {
        orderService.cancelOrder(orderId);
        <span class="hljs-keyword">return</span> ResponseResult.success();
    }
    
    <span class="hljs-meta">@GetMapping("/{orderId}")</span>
    <span class="hljs-keyword">public</span> ResponseResult&lt;Order&gt; <span class="hljs-title function_">getOrder</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long orderId)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.getOrder(orderId);
        <span class="hljs-keyword">return</span> ResponseResult.success(order);
    }
}
</code></pre>
<h3 data-id="heading-22">七、测试你的异常处理器</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1RVyYBZE4z%2F%3Fvd_source%3Dd9789da0ed994ac777a822cd5ea4cf30" target="_blank" title="https://www.bilibili.com/video/BV1RVyYBZE4z/?vd_source=d9789da0ed994ac777a822cd5ea4cf30" ref="nofollow noopener noreferrer">零基础全栈开发Java微服务版本实战-后端-前端-运维-实战企业级三个实战项目</a></p>
<h4 data-id="heading-23">1. 单元测试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-meta">@AutoConfigureMockMvc</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandlerTest</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MockMvc mockMvc;
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testBusinessException</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        mockMvc.perform(get(<span class="hljs-string">"/api/test/business-error"</span>))
                .andExpect(status().isOk())
                .andExpect(jsonPath(<span class="hljs-string">"$.code"</span>).value(<span class="hljs-number">10001</span>))
                .andExpect(jsonPath(<span class="hljs-string">"$.message"</span>).value(<span class="hljs-string">"业务异常测试"</span>));
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testValidationException</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        mockMvc.perform(post(<span class="hljs-string">"/api/users"</span>)
                .contentType(MediaType.APPLICATION_JSON)
                .content(<span class="hljs-string">"{\"username\":\"\"}"</span>))
                .andExpect(status().isOk())
                .andExpect(jsonPath(<span class="hljs-string">"$.code"</span>).value(<span class="hljs-number">10001</span>))
                .andExpect(jsonPath(<span class="hljs-string">"$.message"</span>).contains(<span class="hljs-string">"不能为空"</span>));
    }
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSystemException</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        mockMvc.perform(get(<span class="hljs-string">"/api/test/system-error"</span>))
                .andExpect(status().isOk())
                .andExpect(jsonPath(<span class="hljs-string">"$.code"</span>).value(<span class="hljs-number">500</span>));
    }
}
</code></pre>
<h4 data-id="heading-24">2. 集成测试异常处理器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@WebMvcTest(OrderController.class)</span>
<span class="hljs-meta">@Import(GlobalExceptionHandler.class)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderControllerExceptionTest</span> {
    
    <span class="hljs-meta">@MockBean</span>
    <span class="hljs-keyword">private</span> OrderService orderService;
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> MockMvc mockMvc;
    
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder_InsufficientStock</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 模拟库存不足异常</span>
        when(orderService.createOrder(any()))
                .thenThrow(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientStockException</span>(<span class="hljs-number">1L</span>, <span class="hljs-number">10</span>, <span class="hljs-number">5</span>));
        
        mockMvc.perform(post(<span class="hljs-string">"/orders"</span>)
                .contentType(MediaType.APPLICATION_JSON)
                .content(<span class="hljs-string">"{...}"</span>))
                .andExpect(status().isOk())
                .andExpect(jsonPath(<span class="hljs-string">"$.code"</span>).value(ErrorCode.INSUFFICIENT_STOCK.getCode()))
                .andExpect(jsonPath(<span class="hljs-string">"$.message"</span>).value(<span class="hljs-string">"商品[1]库存不足，需要10，可用5"</span>));
    }
}
</code></pre>
<h3 data-id="heading-25">八、个人建议性能与注意事项</h3>
<p><strong>资源获取</strong>：<strong>关注公众号：小坏睡说Java</strong></p>
<h4 data-id="heading-26">1. 性能考虑</h4>
<ul>
<li>异常创建开销：异常对象的创建比普通对象开销大</li>
<li>栈追踪开销：<code>fillInStackTrace()</code>方法比较耗时</li>
<li>建议：对于频繁发生的业务异常，考虑使用错误码而非异常</li>
</ul>
<h3 data-id="heading-27">总结</h3>
<p>今天我们一起构建了一个完整的全局异常处理体系：</p>
<ol>
<li><strong>核心机制</strong>：<code>@RestControllerAdvice</code> + <code>@ExceptionHandler</code></li>
<li><strong>异常体系</strong>：业务异常与系统异常分离</li>
<li><strong>统一响应</strong>：标准化的响应格式</li>
<li><strong>日志记录</strong>：完整的异常上下文信息</li>
<li><strong>多环境适配</strong>：开发/生产环境差异化处理</li>
<li><strong>最佳实践</strong>：参数校验、Sentinel集成等</li>
</ol>
<p>通过全局异常处理，我们实现了：</p>
<ul>
<li>✅ <strong>代码整洁</strong>：Controller层只有业务逻辑</li>
<li>✅ <strong>统一格式</strong>：所有异常响应格式一致</li>
<li>✅ <strong>易于维护</strong>：异常处理逻辑集中管理</li>
<li>✅ <strong>便于监控</strong>：异常日志完整记录</li>
</ul>
<h3 data-id="heading-28">今日思考题</h3>
<p>在你的项目中，有没有遇到过以下情况：</p>
<ol>
<li>某个第三方接口频繁超时，需要特殊处理</li>
<li>不同微服务之间的异常需要统一处理</li>
<li>需要根据用户类型返回不同的错误信息</li>
</ol>
<p>你是如何解决这些问题的？欢迎在评论区分享你的经验！</p>
<hr/>
<p><strong>下期预告</strong>：明天我们将探讨《SpringBoot配置文件：一个注解搞定多环境配置！》，学习如何优雅管理不同环境的配置。</p>
<p><strong>互动时间</strong>：你在异常处理中遇到过哪些"坑"？或者有哪些更好的实践建议？</p>
<p><strong>资源获取</strong>：<strong>关注公众号：小坏睡说Java</strong>     回复"异常处理源码"，获取本文所有示例代码及完整项目。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自定义简易日历]]></title>    <link>https://juejin.cn/post/7585897699603071002</link>    <guid>https://juejin.cn/post/7585897699603071002</guid>    <pubDate>2025-12-22T02:25:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699603071002" data-draft-id="7585888537641959439" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自定义简易日历"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-22T02:25:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风往哪边走"/> <meta itemprop="url" content="https://juejin.cn/user/3433151760706957"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自定义简易日历
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3433151760706957/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风往哪边走
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:25:59.000Z" title="Mon Dec 22 2025 02:25:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial;color:#00325e}.markdown-body ::selection{background-color:#00325e;color:#fff}.markdown-body blockquote{padding:10px 20px;background-color:#fffaf0;box-shadow:0 3px 10px 0 rgba(255,172,194,.24);border:1px solid #f3ca8e;transition:all .2s;margin:1em 0;border-radius:5px}.markdown-body blockquote p{font-size:14px;line-height:25px;color:#795548}.markdown-body blockquote p:last-child{margin:0}.markdown-body blockquote:hover{border-color:#ff9800;background-color:#fff8e0;box-shadow:0 6px 10px -5px rgba(225,173,98,.3803921569)}.markdown-body blockquote code{color:#ff502c}.markdown-body pre{border:1px solid #8cc0f3;box-shadow:0 3px 10px 0 rgba(255,198,198,.28);border-radius:5px;transition:all .2s;overflow-x:auto;white-space:pre-wrap}.markdown-body pre:hover{border-color:#6d9dce}.markdown-body pre&gt;code{padding:10px 20px;color:#00325e;background:#f0f8ff;font-size:12px;line-height:1.6;display:block}.markdown-body code{background:#f6fbff;color:#0b5393;padding:2px 4px;border-radius:4px;font-size:12px}.markdown-body p{font-size:14px;line-height:28px;text-align:justify;margin-bottom:17px;color:#595959}.markdown-body a{color:#00325e;text-decoration:none}.markdown-body a:after{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAAKCAYAAACNMs+9AAAAAXNSR0IArs4c6QAAAQdJREFUKFNt0DtLA0EUBeBzZle0Eks7rcUfEfBRCha7NorYa6NmVJzgyi4smUgKtdZGCJktLMVH4Y8QeztLWyE7VyLEuNFbXj4Oh0P8c8mZm+uJrEN4BJFTeP/MUVe3bnocfALwkOlo1zS7iZAzf6Cx7oXgbaqjxiDEWCcVaGyxQ8pSWo9XhqhoQ/xUFbaKjhe5V+CmR7mnSplEEF6GSmJ+F/d0KHvbCIIJCLc85U6BC5mONgbJNM3uFag++sX7z8O8MzsWBucifMx0dDGE1kmm458KDVukAlnNdDz/exEeW3dNkbfsYC0xtmgDWP6ELLZ0/F6BJu/UoFQN5AkoeUjeJPvx6+i+X5Sjah4tA6gYAAAAAElFTkSuQmCC);margin-left:2px}.markdown-body a:hover{box-shadow:0 1px}.markdown-body table{max-width:100%;border-collapse:collapse;border-spacing:0;box-shadow:0 3px 10px 0 rgba(255,238,172,.24);transition:all .2s}.markdown-body table:hover{box-shadow:0 3px 10px 0 rgba(185,169,103,.24)}.markdown-body table tr th{border:1px solid #8cc0f3;background-color:#f0f8ff;padding:12px 15px}.markdown-body table tr td{border:1px solid rgba(243,202,142,.4);padding:12px 15px}.markdown-body table tbody tr{transition:all .2s}.markdown-body table tbody tr:hover td{border-color:#f3ca8e;background-color:#fff8e0;z-index:1}.markdown-body img{max-width:100%}.markdown-body h1{font-size:20px;margin-top:30px;margin-bottom:10px;padding-left:30px;position:relative}.markdown-body h1&gt;code{font-size:20px}.markdown-body h1:before{content:"🍺";display:block;font-size:18px;width:18px;height:18px;left:0;position:absolute}.markdown-body h2{font-size:18px;margin-top:30px;margin-bottom:10px;padding-left:28px;position:relative}.markdown-body h2&gt;code{font-size:18px}.markdown-body h2:before{content:"🍻";display:block;font-size:16px;width:16px;height:16px;left:0;position:absolute}.markdown-body h3{font-size:16px;margin-top:30px;margin-bottom:10px;padding-left:26px;position:relative}.markdown-body h3&gt;code{font-size:16px}.markdown-body h3:before{content:"🥂";display:block;font-size:14px;width:14px;height:14px;left:0;position:absolute}.markdown-body h4{font-size:14px;margin-top:30px;margin-bottom:10px;padding-left:24px;position:relative}.markdown-body h4&gt;code{font-size:14px}.markdown-body h4:before{content:"🥃";display:block;font-size:12px;width:12px;height:12px;left:0;position:absolute}.markdown-body h5{font-size:12px;margin-top:30px;margin-bottom:10px}.markdown-body h5&gt;code{font-size:12px}.markdown-body h6{font-size:10px;margin-top:30px;margin-bottom:10px}.markdown-body h6&gt;code{font-size:10px}.markdown-body h1,.markdown-body h2{color:#ff502c}.markdown-body hr{height:4px;border:none;margin-top:32px;margin-bottom:32px;background-size:4px 1px;background-image:linear-gradient(270deg,#6d9dce,#8cc0f3 25%,transparent 50%)}.markdown-body hr:nth-child(2n){background-image:linear-gradient(270deg,#ff9800,#fff8e0 25%,transparent 50%)}.markdown-body ul{padding-inline-start:20px}.markdown-body ul li{list-style-type:"🔸"}.markdown-body ul li li{list-style-type:"◻️"}.markdown-body ul li li li{list-style-type:"▫️"}.markdown-body ol{padding-inline-start:20px}.markdown-body ol ::marker{color:#ff9800}.markdown-body ol,.markdown-body ul{line-height:2em}.markdown-body li{padding-inline-start:1ch}.markdown-body li.task-list-item{list-style:none;padding-inline-start:0}.markdown-body li input{padding-right:2px}.markdown-body li input[type=checkbox i]{appearance:none}.markdown-body li input:before{content:"🟩";display:block;width:13px;height:13px}.markdown-body li input:checked:before{content:"✅"}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-sulphurpool-light">.hljs-comment,.hljs-quote{color:#6b7394}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#c94922}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#c76b29}.hljs-bullet,.hljs-string,.hljs-symbol{color:#ac9739}.hljs-section,.hljs-title{color:#3d8fd1}.hljs-keyword,.hljs-selector-tag{color:#6679cc}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#f5f7ff;color:#5e6687}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">自定义简易日历</h2>
<ul>
<li>
<blockquote>
<p>当前月份日期可点击选中</p>
</blockquote>
</li>
<li>
<blockquote>
<p>今天日期有红色圆圈标记</p>
</blockquote>
</li>
<li>
<blockquote>
<p>跨月日期为灰色，不可点击</p>
</blockquote>
</li>
<li>
<blockquote>
<p>可切换上个月/下个月</p>
</blockquote>
</li>
<li>
<blockquote>
<p>支持回到今天</p>
</blockquote>
</li>
<li>
<blockquote>
<p>可以设置红点绿点日期。比如打卡日期</p>
</blockquote>
</li>
</ul>
<h2 data-id="heading-1">自定义日历<code>SimpleCalendarView.kt</code></h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> cn.nio.calendar


<span class="hljs-keyword">import</span> android.content.Context
<span class="hljs-keyword">import</span> android.graphics.Canvas
<span class="hljs-keyword">import</span> android.graphics.Color
<span class="hljs-keyword">import</span> android.graphics.Paint
<span class="hljs-keyword">import</span> android.graphics.RectF
<span class="hljs-keyword">import</span> android.graphics.Typeface
<span class="hljs-keyword">import</span> android.util.AttributeSet
<span class="hljs-keyword">import</span> android.view.MotionEvent
<span class="hljs-keyword">import</span> android.view.View
<span class="hljs-keyword">import</span> java.util.Calendar
<span class="hljs-keyword">import</span> kotlin.math.min

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleCalendarView</span> <span class="hljs-meta">@JvmOverloads</span> <span class="hljs-keyword">constructor</span>(
    context: Context,
    attrs: AttributeSet? = <span class="hljs-literal">null</span>,
    defStyleAttr: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>,
) : View(context, attrs, defStyleAttr) {

    <span class="hljs-comment">// 颜色</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> todayColor = Color.RED
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> selectedColor = Color.parseColor(<span class="hljs-string">"#00B594"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> normalTextColor = Color.BLACK
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> selectedTextColor = Color.WHITE
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> otherMonthTextColor = Color.parseColor(<span class="hljs-string">"#CCCCCC"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> gridLineColor = Color.parseColor(<span class="hljs-string">"#E0E0E0"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> weekBackgroundColor = Color.parseColor(<span class="hljs-string">"#F5F5F5"</span>)

    <span class="hljs-comment">// 新增：红点和绿点颜色</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> redDotColor = Color.parseColor(<span class="hljs-string">"#FF4444"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> greenDotColor = Color.parseColor(<span class="hljs-string">"#00B594"</span>)

    <span class="hljs-comment">// 数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> calendar = Calendar.getInstance()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentYear: <span class="hljs-built_in">Int</span> = calendar.<span class="hljs-keyword">get</span>(Calendar.YEAR)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> currentMonth: <span class="hljs-built_in">Int</span> = calendar.<span class="hljs-keyword">get</span>(Calendar.MONTH)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> selectedDate: Calendar? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> today: Calendar = Calendar.getInstance()

    <span class="hljs-comment">// 新增：存储需要显示点的日期</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> redDotDates = mutableSetOf&lt;String&gt;() <span class="hljs-comment">// 格式: "2024-01-15"</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> greenDotDates = mutableSetOf&lt;String&gt;()

    <span class="hljs-comment">// 画笔</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> paint = Paint(Paint.ANTI_ALIAS_FLAG)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> weekPaint = Paint(Paint.ANTI_ALIAS_FLAG)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> selectedPaint = Paint(Paint.ANTI_ALIAS_FLAG)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> todayPaint = Paint(Paint.ANTI_ALIAS_FLAG)

    <span class="hljs-comment">// 新增：点画笔</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> redDotPaint = Paint(Paint.ANTI_ALIAS_FLAG)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> greenDotPaint = Paint(Paint.ANTI_ALIAS_FLAG)

    <span class="hljs-comment">// 尺寸</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cellWidth: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cellHeight: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> weekHeight: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>

    <span class="hljs-comment">// 新增：点相关尺寸</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dotRadius: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> dotSpacing: <span class="hljs-built_in">Float</span> = <span class="hljs-number">0f</span>

    <span class="hljs-comment">// 监听器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> onDateClickListener: ((year: <span class="hljs-built_in">Int</span>, month: <span class="hljs-built_in">Int</span>, day: <span class="hljs-built_in">Int</span>) -&gt; <span class="hljs-built_in">Unit</span>)? = <span class="hljs-literal">null</span>

    <span class="hljs-comment">// 星期标题</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> weekDays = arrayOf(<span class="hljs-string">"日"</span>, <span class="hljs-string">"一"</span>, <span class="hljs-string">"二"</span>, <span class="hljs-string">"三"</span>, <span class="hljs-string">"四"</span>, <span class="hljs-string">"五"</span>, <span class="hljs-string">"六"</span>)

    <span class="hljs-keyword">init</span> {
        <span class="hljs-comment">// 初始化画笔</span>
        paint.color = normalTextColor
        paint.textSize = spToPx(<span class="hljs-number">16f</span>)
        paint.textAlign = Paint.Align.CENTER

        weekPaint.color = normalTextColor
        weekPaint.textSize = spToPx(<span class="hljs-number">18f</span>)
        weekPaint.textAlign = Paint.Align.CENTER
        weekPaint.typeface = Typeface.DEFAULT_BOLD

        selectedPaint.color = selectedColor
        selectedPaint.style = Paint.Style.FILL

        todayPaint.color = todayColor
        todayPaint.style = Paint.Style.STROKE
        todayPaint.strokeWidth = <span class="hljs-number">3f</span>

        <span class="hljs-comment">// 初始化点画笔</span>
        redDotPaint.color = redDotColor
        redDotPaint.style = Paint.Style.FILL

        greenDotPaint.color = greenDotColor
        greenDotPaint.style = Paint.Style.FILL

        <span class="hljs-comment">// 设置初始选中日期为今天</span>
        selectedDate = today.clone() <span class="hljs-keyword">as</span> Calendar
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMeasure</span><span class="hljs-params">(widthMeasureSpec: <span class="hljs-type">Int</span>, heightMeasureSpec: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> width = MeasureSpec.getSize(widthMeasureSpec)
<span class="hljs-comment">//        val height = (width * 6 / 7f).toInt()</span>
        setMeasuredDimension(width, width)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSizeChanged</span><span class="hljs-params">(w: <span class="hljs-type">Int</span>, h: <span class="hljs-type">Int</span>, oldw: <span class="hljs-type">Int</span>, oldh: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onSizeChanged(w, h, oldw, oldh)

        cellWidth = w / <span class="hljs-number">7f</span>
        weekHeight = h * <span class="hljs-number">0.15f</span>
        cellHeight = (h - weekHeight) / <span class="hljs-number">6f</span>

        <span class="hljs-comment">// 计算点的尺寸</span>
        dotRadius = dpToPx(<span class="hljs-number">2f</span>)
        dotSpacing = dpToPx(<span class="hljs-number">1f</span>)
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDraw</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">super</span>.onDraw(canvas)

        <span class="hljs-comment">// 绘制白色背景</span>
        canvas.drawColor(Color.WHITE)

        <span class="hljs-comment">// 绘制星期栏</span>
        drawWeekBackground(canvas)
        drawWeekDays(canvas)

        <span class="hljs-comment">// 绘制日期</span>
        drawDates(canvas)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawWeekBackground</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">val</span> rect = RectF(<span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, width.toFloat(), weekHeight)
        paint.color = weekBackgroundColor
        paint.style = Paint.Style.FILL
        canvas.drawRect(rect, paint)
        paint.style = Paint.Style.FILL
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawWeekDays</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-keyword">val</span> baseline = weekHeight * <span class="hljs-number">0.7f</span>

        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> weekDays.indices) {
            <span class="hljs-keyword">val</span> x = i * cellWidth + cellWidth / <span class="hljs-number">2</span>
            canvas.drawText(weekDays[i], x, baseline, weekPaint)
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawDates</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        <span class="hljs-comment">// 设置当前月份第一天</span>
        calendar.<span class="hljs-keyword">set</span>(currentYear, currentMonth, <span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> firstDayOfWeek = calendar.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_WEEK) - <span class="hljs-number">1</span>

        <span class="hljs-comment">// 获取当月实际天数</span>
        <span class="hljs-keyword">val</span> daysInMonth = getMonthDays(currentYear, currentMonth)

        <span class="hljs-comment">// 绘制当前月份日期</span>
        <span class="hljs-keyword">for</span> (day <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span>.daysInMonth) {
            drawDateCell(canvas, day, firstDayOfWeek, daysInMonth, <span class="hljs-literal">true</span>)
        }

        <span class="hljs-comment">// 绘制跨月日期（灰色，不可点击）</span>
        drawOtherMonthDays(canvas, firstDayOfWeek, daysInMonth)

        <span class="hljs-comment">// 绘制网格线</span>
        drawGridLines(canvas)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawDateCell</span><span class="hljs-params">(
        canvas: <span class="hljs-type">Canvas</span>,
        day: <span class="hljs-type">Int</span>,
        firstDayOfWeek: <span class="hljs-type">Int</span>,
        daysInMonth: <span class="hljs-type">Int</span>,
        isCurrentMonth: <span class="hljs-type">Boolean</span>,
    )</span></span> {
        <span class="hljs-keyword">val</span> position = firstDayOfWeek + (day - <span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> row = position / <span class="hljs-number">7</span>
        <span class="hljs-keyword">val</span> col = position % <span class="hljs-number">7</span>

        <span class="hljs-keyword">val</span> x = col * cellWidth + cellWidth / <span class="hljs-number">2</span>
        <span class="hljs-keyword">val</span> y = weekHeight + row * cellHeight + cellHeight * <span class="hljs-number">0.6f</span>

        <span class="hljs-comment">// 检查是否为选中日期</span>
        <span class="hljs-keyword">val</span> isSelected = selectedDate?.let {
            it.<span class="hljs-keyword">get</span>(Calendar.YEAR) == currentYear &amp;&amp;
                    it.<span class="hljs-keyword">get</span>(Calendar.MONTH) == currentMonth &amp;&amp;
                    it.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_MONTH) == day
        } ?: <span class="hljs-literal">false</span>

        <span class="hljs-comment">// 检查是否为今天</span>
        <span class="hljs-keyword">val</span> isToday = today.<span class="hljs-keyword">get</span>(Calendar.YEAR) == currentYear &amp;&amp;
                today.<span class="hljs-keyword">get</span>(Calendar.MONTH) == currentMonth &amp;&amp;
                today.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_MONTH) == day

        <span class="hljs-comment">// 绘制选中背景</span>
        <span class="hljs-keyword">if</span> (isSelected &amp;&amp; isCurrentMonth) {
            <span class="hljs-keyword">val</span> radius = min(cellWidth, cellHeight) * <span class="hljs-number">0.3f</span>
            canvas.drawCircle(x, y - (paint.textSize / <span class="hljs-number">3</span>), radius, selectedPaint)
        }

        <span class="hljs-comment">// 绘制今天圆圈</span>
        <span class="hljs-keyword">if</span> (isToday &amp;&amp; isCurrentMonth) {
            <span class="hljs-keyword">val</span> radius = min(cellWidth, cellHeight) * <span class="hljs-number">0.35f</span>
            canvas.drawCircle(x, y - (paint.textSize / <span class="hljs-number">3</span>), radius, todayPaint)
        }

        <span class="hljs-comment">// 绘制日期文字</span>
        paint.color = <span class="hljs-keyword">when</span> {
            isSelected -&gt; selectedTextColor
            <span class="hljs-keyword">else</span> -&gt; normalTextColor
        }

        paint.textSize = spToPx(<span class="hljs-number">16f</span>)
        canvas.drawText(day.toString(), x, y, paint)

        <span class="hljs-comment">// 新增：绘制红点和绿点（仅在当前月份日期显示）</span>
        <span class="hljs-keyword">if</span> (isCurrentMonth) {
            <span class="hljs-keyword">val</span> dateKey = formatDateKey(currentYear, currentMonth, day)

            <span class="hljs-keyword">val</span> redDotExists = redDotDates.contains(dateKey)
            <span class="hljs-keyword">val</span> greenDotExists = greenDotDates.contains(dateKey)

            <span class="hljs-comment">// 计算点的位置</span>
            <span class="hljs-keyword">val</span> dotY = y + paint.textSize / <span class="hljs-number">2</span> + dotSpacing

            <span class="hljs-comment">// 如果只有一种点，居中显示</span>
            <span class="hljs-keyword">when</span> {
                redDotExists &amp;&amp; greenDotExists -&gt; {
                    <span class="hljs-comment">// 两种点都存在，在左右两侧显示</span>
                    <span class="hljs-keyword">val</span> leftX = x - dotRadius * <span class="hljs-number">1.5f</span>
                    <span class="hljs-keyword">val</span> rightX = x + dotRadius * <span class="hljs-number">1.5f</span>
                    canvas.drawCircle(leftX, dotY, dotRadius, redDotPaint)
                    canvas.drawCircle(rightX, dotY, dotRadius, greenDotPaint)
                }

                redDotExists -&gt; {
                    <span class="hljs-comment">// 只有红点</span>
                    canvas.drawCircle(x, dotY, dotRadius, redDotPaint)
                }

                greenDotExists -&gt; {
                    <span class="hljs-comment">// 只有绿点</span>
                    canvas.drawCircle(x, dotY, dotRadius, greenDotPaint)
                }
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawOtherMonthDays</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>, firstDayOfWeek: <span class="hljs-type">Int</span>, daysInMonth: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 绘制上个月在当月日历中显示的日期</span>
        <span class="hljs-keyword">if</span> (firstDayOfWeek &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">val</span> prevMonthCalendar = Calendar.getInstance().apply {
                <span class="hljs-keyword">set</span>(currentYear, currentMonth, <span class="hljs-number">1</span>)
                add(Calendar.MONTH, -<span class="hljs-number">1</span>)
            }
            <span class="hljs-keyword">val</span> daysInPrevMonth = getMonthDays(
                prevMonthCalendar.<span class="hljs-keyword">get</span>(Calendar.YEAR),
                prevMonthCalendar.<span class="hljs-keyword">get</span>(Calendar.MONTH)
            )

            <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until firstDayOfWeek) {
                <span class="hljs-keyword">val</span> day = daysInPrevMonth - firstDayOfWeek + i + <span class="hljs-number">1</span>
                <span class="hljs-keyword">val</span> row = <span class="hljs-number">0</span>
                <span class="hljs-keyword">val</span> col = i
                drawOtherMonthDate(canvas, row, col, day)
            }
        }

        <span class="hljs-comment">// 绘制下个月在当月日历中显示的日期</span>
        <span class="hljs-keyword">val</span> totalRows = <span class="hljs-number">6</span>
        <span class="hljs-keyword">val</span> totalCells = totalRows * <span class="hljs-number">7</span>
        <span class="hljs-keyword">val</span> cellsUsedByCurrentMonth = firstDayOfWeek + daysInMonth
        <span class="hljs-keyword">val</span> remainingCells = totalCells - cellsUsedByCurrentMonth

        <span class="hljs-keyword">if</span> (remainingCells &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">var</span> nextMonthDay = <span class="hljs-number">1</span>
            <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span> until remainingCells) {
                <span class="hljs-keyword">val</span> position = cellsUsedByCurrentMonth + i
                <span class="hljs-keyword">val</span> row = position / <span class="hljs-number">7</span>
                <span class="hljs-keyword">val</span> col = position % <span class="hljs-number">7</span>
                drawOtherMonthDate(canvas, row, col, nextMonthDay)
                nextMonthDay++
            }
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawOtherMonthDate</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>, row: <span class="hljs-type">Int</span>, col: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> x = col * cellWidth + cellWidth / <span class="hljs-number">2</span>
        <span class="hljs-keyword">val</span> y = weekHeight + row * cellHeight + cellHeight * <span class="hljs-number">0.6f</span>

        <span class="hljs-comment">// 保存当前画笔状态</span>
        <span class="hljs-keyword">val</span> originalColor = paint.color
        <span class="hljs-keyword">val</span> originalTextSize = paint.textSize

        <span class="hljs-comment">// 绘制跨月日期文字（灰色）</span>
        paint.color = otherMonthTextColor
        paint.textSize = spToPx(<span class="hljs-number">16f</span>)
        canvas.drawText(day.toString(), x, y, paint)

        <span class="hljs-comment">// 恢复画笔状态</span>
        paint.color = originalColor
        paint.textSize = originalTextSize
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">drawGridLines</span><span class="hljs-params">(canvas: <span class="hljs-type">Canvas</span>)</span></span> {
        paint.color = gridLineColor
        paint.strokeWidth = <span class="hljs-number">1f</span>

        <span class="hljs-comment">// 绘制星期栏底部分隔线</span>
        canvas.drawLine(<span class="hljs-number">0f</span>, weekHeight, width.toFloat(), weekHeight, paint)

        <span class="hljs-comment">// 绘制垂直线</span>
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1</span> until <span class="hljs-number">7</span>) {
            <span class="hljs-keyword">val</span> x = i * cellWidth
            canvas.drawLine(x, weekHeight, x, height.toFloat(), paint)
        }

        <span class="hljs-comment">// 绘制水平线</span>
        <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span><span class="hljs-number">.6</span>) {
            <span class="hljs-keyword">val</span> y = weekHeight + i * cellHeight
            canvas.drawLine(<span class="hljs-number">0f</span>, y, width.toFloat(), y, paint)
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onTouchEvent</span><span class="hljs-params">(event: <span class="hljs-type">MotionEvent</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">when</span> (event.action) {
            MotionEvent.ACTION_DOWN -&gt; <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
            MotionEvent.ACTION_UP -&gt; {
                handleClick(event.x, event.y)
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.onTouchEvent(event)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleClick</span><span class="hljs-params">(x: <span class="hljs-type">Float</span>, y: <span class="hljs-type">Float</span>)</span></span> {
        <span class="hljs-keyword">if</span> (y &lt; weekHeight) <span class="hljs-keyword">return</span>

        <span class="hljs-comment">// 计算点击的行列</span>
        <span class="hljs-keyword">val</span> row = ((y - weekHeight) / cellHeight).toInt()
        <span class="hljs-keyword">val</span> col = (x / cellWidth).toInt()

        <span class="hljs-keyword">if</span> (row &lt; <span class="hljs-number">0</span> || row &gt;= <span class="hljs-number">6</span> || col &lt; <span class="hljs-number">0</span> || col &gt;= <span class="hljs-number">7</span>) <span class="hljs-keyword">return</span>

        <span class="hljs-comment">// 获取当前月份第一天是星期几</span>
        calendar.<span class="hljs-keyword">set</span>(currentYear, currentMonth, <span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> firstDayOfWeek = calendar.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_WEEK) - <span class="hljs-number">1</span>

        <span class="hljs-comment">// 获取当月天数</span>
        <span class="hljs-keyword">val</span> daysInMonth = getMonthDays(currentYear, currentMonth)

        <span class="hljs-comment">// 计算点击的日期索引</span>
        <span class="hljs-keyword">val</span> position = row * <span class="hljs-number">7</span> + col
        <span class="hljs-keyword">val</span> dayIndex = position - firstDayOfWeek + <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> (dayIndex <span class="hljs-keyword">in</span> <span class="hljs-number">1.</span>.daysInMonth) {
            <span class="hljs-comment">// 点击当前月份日期</span>
            selectDate(currentYear, currentMonth, dayIndex)
        }
        <span class="hljs-comment">// 跨月日期不可点击，不做任何处理</span>
    }

    <span class="hljs-comment">/**
     * 获取月份天数
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getMonthDays</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">val</span> isLeapYear = (year % <span class="hljs-number">4</span> == <span class="hljs-number">0</span> &amp;&amp; year % <span class="hljs-number">100</span> != <span class="hljs-number">0</span>) || (year % <span class="hljs-number">400</span> == <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">when</span> (month) {
            <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">11</span> -&gt; <span class="hljs-number">31</span>
            <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span> -&gt; <span class="hljs-number">30</span>
            <span class="hljs-number">1</span> -&gt; <span class="hljs-keyword">if</span> (isLeapYear) <span class="hljs-number">29</span> <span class="hljs-keyword">else</span> <span class="hljs-number">28</span>
            <span class="hljs-keyword">else</span> -&gt; <span class="hljs-number">0</span>
        }
    }

    <span class="hljs-comment">/**
     * 选择日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">selectDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-comment">// 如果选择的日期不在当前月份，先切换到该月份</span>
        <span class="hljs-keyword">if</span> (year != currentYear || month != currentMonth) {
            currentYear = year
            currentMonth = month
        }

        <span class="hljs-comment">// 设置选中日期</span>
        selectedDate = Calendar.getInstance().apply {
            <span class="hljs-keyword">set</span>(year, month, day)
        }

        <span class="hljs-comment">// 重绘</span>
        invalidate()

        <span class="hljs-comment">// 回调</span>
        onDateClickListener?.invoke(year, month, day)
    }

    <span class="hljs-comment">/**
     * 新增：设置红点日期
     * <span class="hljs-doctag">@param</span> dates 日期列表，格式: "2024-01-15"
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setRedDotDates</span><span class="hljs-params">(dates: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
        redDotDates.clear()
        redDotDates.addAll(dates)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：设置绿点日期
     * <span class="hljs-doctag">@param</span> dates 日期列表，格式: "2024-01-15"
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setGreenDotDates</span><span class="hljs-params">(dates: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
        greenDotDates.clear()
        greenDotDates.addAll(dates)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：添加单个红点日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addRedDotDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> dateKey = formatDateKey(year, month, day)
        redDotDates.add(dateKey)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：添加单个绿点日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">addGreenDotDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> dateKey = formatDateKey(year, month, day)
        greenDotDates.add(dateKey)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：移除红点日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeRedDotDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> dateKey = formatDateKey(year, month, day)
        redDotDates.remove(dateKey)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：移除绿点日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">removeGreenDotDate</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">val</span> dateKey = formatDateKey(year, month, day)
        greenDotDates.remove(dateKey)
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：清空所有红点
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearRedDotDates</span><span class="hljs-params">()</span></span> {
        redDotDates.clear()
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：清空所有绿点
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">clearGreenDotDates</span><span class="hljs-params">()</span></span> {
        greenDotDates.clear()
        invalidate()
    }

    <span class="hljs-comment">/**
     * 新增：格式化日期键
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">formatDateKey</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>, day: <span class="hljs-type">Int</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%d-%02d-%02d"</span>, year, month + <span class="hljs-number">1</span>, day)
    }

    <span class="hljs-comment">/**
     * 设置当前显示的月份
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setCurrentMonth</span><span class="hljs-params">(year: <span class="hljs-type">Int</span>, month: <span class="hljs-type">Int</span>)</span></span> {
        currentYear = year
        currentMonth = month
        invalidate()
    }

    <span class="hljs-comment">/**
     * 获取当前显示的月份
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getCurrentMonth</span><span class="hljs-params">()</span></span>: Pair&lt;<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>&gt; {
        <span class="hljs-keyword">return</span> Pair(currentYear, currentMonth)
    }

    <span class="hljs-comment">/**
     * 获取选中的日期
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getSelectedDate</span><span class="hljs-params">()</span></span>: Triple&lt;<span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>, <span class="hljs-built_in">Int</span>&gt;? {
        <span class="hljs-keyword">return</span> selectedDate?.let {
            Triple(
                it.<span class="hljs-keyword">get</span>(Calendar.YEAR),
                it.<span class="hljs-keyword">get</span>(Calendar.MONTH),
                it.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_MONTH)
            )
        }
    }

    <span class="hljs-comment">/**
     * 切换到上个月
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">previousMonth</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">var</span> newYear = currentYear
        <span class="hljs-keyword">var</span> newMonth = currentMonth - <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> (newMonth &lt; <span class="hljs-number">0</span>) {
            newYear--
            newMonth = <span class="hljs-number">11</span>
        }

        setCurrentMonth(newYear, newMonth)
    }

    <span class="hljs-comment">/**
     * 切换到下个月
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">nextMonth</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">var</span> newYear = currentYear
        <span class="hljs-keyword">var</span> newMonth = currentMonth + <span class="hljs-number">1</span>

        <span class="hljs-keyword">if</span> (newMonth &gt; <span class="hljs-number">11</span>) {
            newYear++
            newMonth = <span class="hljs-number">0</span>
        }

        setCurrentMonth(newYear, newMonth)
    }

    <span class="hljs-comment">/**
     * 回到今天
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">goToToday</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> now = Calendar.getInstance()
        currentYear = now.<span class="hljs-keyword">get</span>(Calendar.YEAR)
        currentMonth = now.<span class="hljs-keyword">get</span>(Calendar.MONTH)
        selectedDate = now.clone() <span class="hljs-keyword">as</span> Calendar
        invalidate()

        <span class="hljs-comment">// 回调今天的日期</span>
        onDateClickListener?.invoke(
            currentYear,
            currentMonth,
            now.<span class="hljs-keyword">get</span>(Calendar.DAY_OF_MONTH)
        )
    }

    <span class="hljs-comment">/**
     * 设置日期点击监听器
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setOnDateClickListener</span><span class="hljs-params">(listener: (<span class="hljs-type">year</span>: <span class="hljs-type">Int</span>, <span class="hljs-type">month</span>: <span class="hljs-type">Int</span>, <span class="hljs-type">day</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span> {
        <span class="hljs-keyword">this</span>.onDateClickListener = listener
    }

    <span class="hljs-comment">/**
     * sp转px
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">spToPx</span><span class="hljs-params">(sp: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
        <span class="hljs-keyword">return</span> sp * resources.displayMetrics.scaledDensity
    }

    <span class="hljs-comment">/**
     * 新增：dp转px
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dpToPx</span><span class="hljs-params">(dp: <span class="hljs-type">Float</span>)</span></span>: <span class="hljs-built_in">Float</span> {
        <span class="hljs-keyword">return</span> dp * resources.displayMetrics.density
    }
}
</code></pre>
<h2 data-id="heading-2">样例布局<code>activity_main.xml</code></h2>
<pre><code class="hljs language-ini" lang="ini">&lt;?xml <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;
&lt;LinearLayout xmlns:<span class="hljs-attr">android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span>
    xmlns:<span class="hljs-attr">tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span>
    android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/main"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"match_parent"</span>
    android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"vertical"</span>
    tools:<span class="hljs-attr">context</span>=<span class="hljs-string">".MainActivity"</span>&gt;

    &lt;!-- 标题 --&gt;
    &lt;TextView
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"简易日历"</span>
        android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"18sp"</span>
        android:<span class="hljs-attr">textStyle</span>=<span class="hljs-string">"bold"</span> /&gt;

    &lt;!-- 月份导航 --&gt;
    &lt;LinearLayout
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;

        &lt;Button
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/prevMonthButton"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">text</span>=<span class="hljs-string">"◀ 上个月"</span> /&gt;

        &lt;TextView
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/monthYearTextView"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_marginHorizontal</span>=<span class="hljs-string">"16dp"</span>
            android:<span class="hljs-attr">text</span>=<span class="hljs-string">"2024年2月"</span>
            android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"18sp"</span>
            android:<span class="hljs-attr">textStyle</span>=<span class="hljs-string">"bold"</span> /&gt;

        &lt;Button
            android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/nextMonthButton"</span>
            android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
            android:<span class="hljs-attr">text</span>=<span class="hljs-string">"下个月 ▶"</span> /&gt;
    &lt;/LinearLayout&gt;

    &lt;!-- 日历视图 --&gt;
    &lt;cn.nio.calendar.SimpleCalendarView
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/calendarView"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span> /&gt;

    &lt;!-- 选中的日期 --&gt;
    &lt;TextView
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/selectedDateTextView"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">gravity</span>=<span class="hljs-string">"center"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"选中: 2024年2月15日"</span>
        android:<span class="hljs-attr">textSize</span>=<span class="hljs-string">"13sp"</span>
        android:<span class="hljs-attr">textStyle</span>=<span class="hljs-string">"bold"</span> /&gt;

    &lt;!-- 回到今天按钮 --&gt;
    &lt;Button
        android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/todayButton"</span>
        android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"match_parent"</span>
        android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"wrap_content"</span>
        android:<span class="hljs-attr">layout_marginHorizontal</span>=<span class="hljs-string">"12dp"</span>
        android:<span class="hljs-attr">text</span>=<span class="hljs-string">"回到今天"</span> /&gt;


&lt;/LinearLayout&gt;
</code></pre>
<h2 data-id="heading-3">样例<code>MainActivity.kt</code></h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> cn.nio.calendar

<span class="hljs-keyword">import</span> android.os.Bundle
<span class="hljs-keyword">import</span> android.widget.Button
<span class="hljs-keyword">import</span> android.widget.TextView
<span class="hljs-keyword">import</span> androidx.activity.enableEdgeToEdge
<span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity
<span class="hljs-keyword">import</span> androidx.core.view.ViewCompat
<span class="hljs-keyword">import</span> androidx.core.view.WindowInsetsCompat
<span class="hljs-keyword">import</span> java.text.SimpleDateFormat
<span class="hljs-keyword">import</span> java.util.Calendar
<span class="hljs-keyword">import</span> java.util.Locale

<span class="hljs-comment">/**
 * 简易日历
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> calendarView: SimpleCalendarView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> monthYearTextView: TextView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> selectedDateTextView: TextView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> prevMonthButton: Button
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> nextMonthButton: Button
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> todayButton: Button

    <span class="hljs-comment">//    private val monthFormat = SimpleDateFormat("yyyy年MM月", Locale.getDefault())</span>
<span class="hljs-comment">//    private val dateFormat = SimpleDateFormat("yyyy年MM月dd日", Locale.getDefault())</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContentView(R.layout.activity_main)
        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main)) { v, insets -&gt;
            <span class="hljs-keyword">val</span> systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars())
            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom)
            insets
        }

        <span class="hljs-comment">// 初始化视图</span>
        calendarView = findViewById(R.id.calendarView)
        monthYearTextView = findViewById(R.id.monthYearTextView)
        selectedDateTextView = findViewById(R.id.selectedDateTextView)
        prevMonthButton = findViewById(R.id.prevMonthButton)
        nextMonthButton = findViewById(R.id.nextMonthButton)
        todayButton = findViewById(R.id.todayButton)

        <span class="hljs-comment">// 初始化显示</span>
        updateMonthYearText()
        updateSelectedDateText()

        <span class="hljs-comment">// 点击选中日期</span>
        calendarView.setOnDateClickListener { year, month, day -&gt;
            updateSelectedDateText()
        }

        <span class="hljs-comment">// 上个月</span>
        prevMonthButton.setOnClickListener {
            calendarView.previousMonth()
            updateMonthYearText()
        }
        <span class="hljs-comment">// 下个月</span>
        nextMonthButton.setOnClickListener {
            calendarView.nextMonth()
            updateMonthYearText()
        }
        <span class="hljs-comment">// 回到今天</span>
        todayButton.setOnClickListener {
            calendarView.goToToday()
            updateMonthYearText()
            updateSelectedDateText()
        }
        calculatePreviousDaysWithCalendar()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateMonthYearText</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> (year, month) = calendarView.getCurrentMonth()
        monthYearTextView.text = <span class="hljs-string">"<span class="hljs-subst">${year}</span>年<span class="hljs-subst">${month + <span class="hljs-number">1</span>}</span>月"</span>
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateSelectedDateText</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> selectedDate = calendarView.getSelectedDate()
        selectedDate?.let { (year, month, day) -&gt;
            selectedDateTextView.text = <span class="hljs-string">"选中: <span class="hljs-subst">${year}</span>年<span class="hljs-subst">${month + <span class="hljs-number">1</span>}</span>月<span class="hljs-subst">${day}</span>日"</span>
        }
    }

    <span class="hljs-comment">/**
     *  设置红点绿点日期
     *
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">calculatePreviousDaysWithCalendar</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> calendar = Calendar.getInstance()
        <span class="hljs-keyword">val</span> sdf = SimpleDateFormat(<span class="hljs-string">"yyyy-MM-dd"</span>, Locale.getDefault()) <span class="hljs-comment">// 线程不安全，多线程需注意</span>

        <span class="hljs-comment">// 计算前1天</span>
        calendar.add(Calendar.DAY_OF_MONTH, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> previous1DayStr = sdf.format(calendar.time)
        <span class="hljs-comment">// 计算前2天（在原基础上再减1）</span>
        calendar.add(Calendar.DAY_OF_MONTH, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> previous2DayStr = sdf.format(calendar.time)
        <span class="hljs-comment">// 计算前3天</span>
        calendar.add(Calendar.DAY_OF_MONTH, -<span class="hljs-number">1</span>)
        <span class="hljs-keyword">val</span> previous3DayStr = sdf.format(calendar.time)

        <span class="hljs-comment">// 重置Calendar到当前时间（可选）</span>
        calendar.add(Calendar.DAY_OF_MONTH, <span class="hljs-number">3</span>)

        println(<span class="hljs-string">"当前日期：<span class="hljs-subst">${sdf.format(Calendar.getInstance().time)}</span>"</span>)
        println(<span class="hljs-string">"前1天：<span class="hljs-variable">$previous1DayStr</span>"</span>)
        println(<span class="hljs-string">"前2天：<span class="hljs-variable">$previous2DayStr</span>"</span>)
        println(<span class="hljs-string">"前3天：<span class="hljs-variable">$previous3DayStr</span>"</span>)
        calendarView.setGreenDotDates(listOf(previous1DayStr, previous3DayStr))
        calendarView.setRedDotDates(listOf(previous2DayStr))
    }

}
</code></pre>
<h2 data-id="heading-4">效果展示</h2>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d6c727db18440388ec3692f986b832b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5b6A5ZOq6L656LWw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975159&amp;x-signature=BcwkkKd7sz9gpiujJpXtA37S1W8%3D" alt="Screen_recording_20251222_100250 00_00_00-00_00_30.gif" width="50%" loading="lazy"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始：MCP数据库助手（一）- 基础搭建]]></title>    <link>https://juejin.cn/post/7585866811717074971</link>    <guid>https://juejin.cn/post/7585866811717074971</guid>    <pubDate>2025-12-22T02:22:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585866811717074971" data-draft-id="7585897699602956314" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始：MCP数据库助手（一）- 基础搭建"/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2025-12-22T02:22:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="红鼻子时代"/> <meta itemprop="url" content="https://juejin.cn/user/1743149753974384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始：MCP数据库助手（一）- 基础搭建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743149753974384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    红鼻子时代
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:22:22.000Z" title="Mon Dec 22 2025 02:22:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MCP是什么？为什么要用它？</h2>
<p>MCP全称Model Context Protocol，简单说就是让AI助手能够调用外部工具的标准协议。想象一下，如果AI只能聊天，那就像一个很聪明但没有手的人。MCP就是给AI装上了"手"，让它能够真正操作数据库、文件系统等等。</p>
<p>对于数据库操作来说，MCP的优势特别明显：</p>
<ul>
<li><strong>一问即答</strong>：直接问AI就能获取数据库信息</li>
<li><strong>安全可控</strong>：AI只能调用你预设的工具函数</li>
<li><strong>智能分析</strong>：AI能理解数据关系，给出有用的建议</li>
</ul>
<h2 data-id="heading-1">第一步：项目结构搭建</h2>
<p>咱们先把项目的骨架搭起来。</p>
<pre><code class="hljs language-bash" lang="bash">v1/
├── pyproject.toml            <span class="hljs-comment"># uv 项目配置</span>
├── README.md                <span class="hljs-comment"># 项目说明</span>
├── src/
│   └── mcp_datatools/       <span class="hljs-comment"># 主包</span>
│       ├── __init__.py
│       ├── server.py        <span class="hljs-comment"># MCP 服务器</span>
│       └── database.py      <span class="hljs-comment"># 数据库管理</span>
├── data/
│   ├── init_scripts/
│   │   └── init_sqlite_db.py   <span class="hljs-comment"># 初始化 SQLite 数据库脚本</span>
│   └── test.db             <span class="hljs-comment"># SQLite 测试数据库</span>
└── tests/                  <span class="hljs-comment"># 测试文件目录</span>
</code></pre>
<p>为什么这样设计？</p>
<ul>
<li>使用 <code>uv</code> 作为包管理器，更现代更快速</li>
<li><code>src/</code> 目录让代码结构更清晰</li>
<li><code>data/</code> 存放测试数据和初始化脚本</li>
<li><code>tests/</code> 目录为后续单元测试预留</li>
<li>配置文件简洁，专注核心功能</li>
</ul>
<h2 data-id="heading-2">第二步：环境配置和依赖</h2>
<p>咱们使用现代的 <code>uv</code> 包管理器来管理依赖：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 uv (如果还没有安装)</span>
curl -LsSf https://astral.sh/uv/install.sh | sh

<span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> v1

<span class="hljs-comment"># 安装依赖</span>
uv <span class="hljs-built_in">sync</span>
</code></pre>
<p><code>pyproject.toml</code> 文件内容：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"mcp-datatools"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">description</span> = <span class="hljs-string">"A MCP server that connects to your database"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.10"</span>

<span class="hljs-attr">dependencies</span> = [
    <span class="hljs-string">"mcp&gt;=1.0.0"</span>,
    <span class="hljs-string">"sqlalchemy&gt;=2.0.0"</span>,
]

<span class="hljs-section">[build-system]</span>
<span class="hljs-attr">requires</span> = [<span class="hljs-string">"hatchling"</span>]
<span class="hljs-attr">build-backend</span> = <span class="hljs-string">"hatchling.build"</span>
</code></pre>
<p>为什么选择 <code>uv</code>？</p>
<ul>
<li><strong>速度极快</strong>：比 pip 快 10-100 倍</li>
<li><strong>依赖解析</strong>：更智能的依赖管理</li>
<li><strong>项目隔离</strong>：自动创建虚拟环境</li>
<li><strong>现代标准</strong>：支持最新的 Python 包管理标准</li>
</ul>
<h2 data-id="heading-3">第三步：数据库连接管理</h2>
<p>数据库连接是整个项目的基础，咱们先把这部分搞定。我设计了一个<code>DatabaseManager</code>类来管理连接：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
database.py - 数据库管理模块
"""</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> contextmanager
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine,inspect,text
<span class="hljs-keyword">from</span> sqlalchemy.exc <span class="hljs-keyword">import</span> SQLAlchemyError
<span class="hljs-keyword">from</span> mcp.server.fastmcp.utilities.logging <span class="hljs-keyword">import</span> get_logger


logger = get_logger(__name__)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseManager</span>:
    <span class="hljs-string">"""数据库管理器"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""初始化数据库管理器"""</span>
        
        self.database_url = os.getenv(<span class="hljs-string">"DB_URL"</span>)
        self.engine = <span class="hljs-literal">None</span>
        self._connect()


    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_connect</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""连接数据库"""</span>
        <span class="hljs-keyword">try</span>:
            self.engine = create_engine(self.database_url, echo=<span class="hljs-literal">False</span>)
            logger.info(<span class="hljs-string">f"成功连接到数据库: <span class="hljs-subst">{self.database_url}</span>"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"连接数据库时出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            <span class="hljs-keyword">raise</span>

<span class="hljs-meta">    @contextmanager</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_connection</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取数据库连接的上下文管理器"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.engine:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"数据库未连接"</span>)
        
        conn = self.engine.connect()
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">yield</span> conn
        <span class="hljs-keyword">finally</span>:
            conn.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_table_names</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""获取数据库中的所有表名"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                inspector = inspect(conn)
                table_names = inspector.get_table_names()
                <span class="hljs-keyword">return</span> table_names
        <span class="hljs-keyword">except</span> SQLAlchemyError <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"获取表名失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_connection</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""测试数据库连接"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:

                result = conn.execute(text(<span class="hljs-string">"SELECT 1"</span>)).scalar()
                <span class="hljs-keyword">return</span> result == <span class="hljs-number">1</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"测试数据库连接时出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db_info</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-keyword">try</span>:
            tables = self.get_table_names()
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"数据库URL: <span class="hljs-subst">{self.database_url}</span>\n共有 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tables)}</span> 个表"</span>
        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"数据库URL: <span class="hljs-subst">{self.database_url}</span>\n数据库连接失败"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">close</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""关闭数据库连接"""</span>
        <span class="hljs-keyword">if</span> self.engine:
            self.engine.dispose()
            logger.info(<span class="hljs-string">"数据库连接已关闭"</span>)
        
</code></pre>
<h2 data-id="heading-4">第四步：第一个MCP工具函数</h2>
<p>现在是最重要的部分 - 实现第一个MCP工具函数<code>list_tables()</code>！</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
server.py - MCP服务器主文件
"""</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP
<span class="hljs-keyword">from</span> mcp.server.fastmcp.utilities.logging <span class="hljs-keyword">import</span> get_logger
<span class="hljs-keyword">from</span> .database <span class="hljs-keyword">import</span> DatabaseManager

mcp = FastMCP(<span class="hljs-string">"MCP DataTools"</span>)
logger = get_logger(__name__)
db_manager = <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_database_manager</span>():
    <span class="hljs-string">"""获取数据库管理器实例"""</span>
    <span class="hljs-keyword">global</span> db_manager
    <span class="hljs-keyword">if</span> db_manager <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        db_manager = DatabaseManager()
    <span class="hljs-keyword">return</span> db_manager
    
<span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"查询数据库中的所有表"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">list_tables</span>() -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取数据库表列表"""</span>
    <span class="hljs-keyword">try</span>:
        db_mgr = get_database_manager()
        tables = db_mgr.get_table_names()
        
        <span class="hljs-keyword">if</span> tables:
            table_list = <span class="hljs-string">","</span>.join(tables)
            result = <span class="hljs-string">f"数据库中共有 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tables)}</span> 个表:\n\n"</span>
            <span class="hljs-keyword">for</span> i,table <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(tables,<span class="hljs-number">1</span>):
                result += <span class="hljs-string">f"<span class="hljs-subst">{i}</span>. <span class="hljs-subst">{table}</span>\n"</span>
            logger.info(<span class="hljs-string">f"成功返回 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tables)}</span> 个表: <span class="hljs-subst">{table_list}</span>"</span>)
            <span class="hljs-keyword">return</span> result
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"数据库中没有表"</span>

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        error_msg = <span class="hljs-string">f"获取数据库表列表失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
        logger.error(error_msg)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{error_msg}</span>\n\n请检查数据库连接。"</span>


<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-keyword">try</span>:
        logger.info(<span class="hljs-string">"启动MCP DataTools服务器"</span>)

        db_mgr = get_database_manager()

        <span class="hljs-keyword">if</span> db_mgr.test_connection():
            logger.info(<span class="hljs-string">"数据库连接测试成功"</span>)
        <span class="hljs-keyword">else</span>:
            logger.warning(<span class="hljs-string">"数据库连接测试失败，但服务器仍会启动"</span>)
            logger.info(<span class="hljs-string">"提示：运行 'python data/init_scripts/init_sqlite_db.py' 创建测试数据库"</span>)

        logger.info(<span class="hljs-string">"当前功能：list_tables() - 获取数据库表列表"</span>)
        logger.info(<span class="hljs-string">"MCP服务器启动成功，等待客户端连接..."</span>)
        
        mcp.run()

    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"服务器启动失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">raise</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-5">第五步：测试数据准备</h2>
<p>光有工具还不行，得有数据来测试。第1周我们创建一个超级简单的测试数据库，重点是能让<code>list_tables()</code>功能工作：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
data/init_sqlite_db.py - 初始化 SQLite 数据库
"""</span>

<span class="hljs-keyword">import</span> sqlite3
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_simple_test_database</span>():
    <span class="hljs-string">"""创建简单测试数据库"""</span>
    
    data_dir = Path(__file__).parent.parent / <span class="hljs-string">"data"</span>
    db_path = data_dir / <span class="hljs-string">"test.db"</span>
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">" 测试数据库创建器"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据库路径: <span class="hljs-subst">{db_path}</span>"</span>)
    
    <span class="hljs-keyword">if</span> db_path.exists():
        os.remove(db_path)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"删除旧数据库文件"</span>)
    
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"创建基础表结构..."</span>)
        
        <span class="hljs-comment"># 创建用户表</span>
        cursor.execute(<span class="hljs-string">"""
            CREATE TABLE users (
                id INTEGER PRIMARY KEY,
                name VARCHAR(50) NOT NULL,
                email VARCHAR(100) NOT NULL
            )
        """</span>)
        
        <span class="hljs-comment"># 创建产品表</span>
        cursor.execute(<span class="hljs-string">"""
            CREATE TABLE products (
                id INTEGER PRIMARY KEY,
                name VARCHAR(100) NOT NULL,
                price DECIMAL(10, 2) NOT NULL
            )
        """</span>)
        
        <span class="hljs-comment"># 创建订单表</span>
        cursor.execute(<span class="hljs-string">"""
            CREATE TABLE orders (
                id INTEGER PRIMARY KEY,
                user_id INTEGER,
                total_amount DECIMAL(10, 2)
            )
        """</span>)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"插入测试数据..."</span>)
        
        <span class="hljs-comment"># 插入测试数据</span>
        cursor.execute(<span class="hljs-string">"INSERT INTO users (name, email) VALUES ('Alice', 'alice@test.com')"</span>)
        cursor.execute(<span class="hljs-string">"INSERT INTO users (name, email) VALUES ('Bob', 'bob@test.com')"</span>)
        
        cursor.execute(<span class="hljs-string">"INSERT INTO products (name, price) VALUES ('笔记本电脑', 5999.99)"</span>)
        cursor.execute(<span class="hljs-string">"INSERT INTO products (name, price) VALUES ('鼠标', 129.99)"</span>)
        
        cursor.execute(<span class="hljs-string">"INSERT INTO orders (user_id, total_amount) VALUES (1, 6129.98)"</span>)
        cursor.execute(<span class="hljs-string">"INSERT INTO orders (user_id, total_amount) VALUES (2, 129.99)"</span>)
        
        conn.commit()
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"测试数据库创建成功！"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"数据库包含表:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  1. users - 用户表 (2条记录)"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  2. products - 产品表 (2条记录)"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  3. orders - 订单表 (2条记录)"</span>)
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"创建数据库时出错: <span class="hljs-subst">{e}</span>"</span>)
        conn.rollback()
        <span class="hljs-keyword">raise</span>
    <span class="hljs-keyword">finally</span>:
        conn.close()

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    create_simple_test_database()
</code></pre>
<p>运行这个脚本：</p>
<pre><code class="hljs language-bash" lang="bash">python data/init_scripts/init_sqlite_db.py
</code></pre>
<p>你就会得到一个包含3个基础表的测试数据库。</p>
<h2 data-id="heading-6">第六步：Cursor 集成测试</h2>
<h3 data-id="heading-7">配置 Cursor</h3>
<p>在 Cursor 的 MCP 配置中添加我们的服务器。打开 Cursor 设置，找到 MCP 配置部分：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"mcp-datatools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uv"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"/path"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"-m"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"mcp_datatools.server"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"DB_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sqlite:///data/test.db"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>正常来说是能开启的：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/783a37f73f6b4888a9d9043909d95d97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975331&amp;x-signature=X1wJMrdM5Vf%2BYpcDC9WYTQv6f58%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-8">测试功能</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf55e82ab5ad4e9d9b7e7c5cf396c6ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975331&amp;x-signature=v9mBfGnHWd35M5cyYjPUFD3CiT0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-9">总结与预告</h2>
<p>第1章我们成功搭建了MCP数据库智能助手的基础，下一章将实现更多的工具函数。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始：MCP数据库助手（二）- 核心功能实现]]></title>    <link>https://juejin.cn/post/7585897699603054618</link>    <guid>https://juejin.cn/post/7585897699603054618</guid>    <pubDate>2025-12-22T02:23:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699603054618" data-draft-id="7585920796100001819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始：MCP数据库助手（二）- 核心功能实现"/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2025-12-22T02:23:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="红鼻子时代"/> <meta itemprop="url" content="https://juejin.cn/user/1743149753974384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始：MCP数据库助手（二）- 核心功能实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743149753974384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    红鼻子时代
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:23:58.000Z" title="Mon Dec 22 2025 02:23:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么要实现这3个核心功能？</h2>
<p>上一篇我们搭建了基础框架，AI已经能"看到"数据库中有哪些表了。但这还远远不够，今天咱们要让AI变得更聪明，实现3个核心功能：</p>
<ul>
<li>能智能搜索相关的表</li>
<li>能深度理解表的结构</li>
<li>能安全地执行SQL查询</li>
</ul>
<h2 data-id="heading-1">第一步：filter_table_names() - 智能搜索表名</h2>
<p>第1周我们已经能获取所有表名了，但当数据库有几十个表的时候，你得能快速找到相关的表。这就像在图书馆里找书，你不可能一本本翻，得按分类找。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"根据关键词搜索相关的表名。支持模糊匹配，不区分大小写。"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_table_names</span>(<span class="hljs-params">keyword: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""根据关键词搜索相关的表名"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> keyword <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> keyword.strip():
            <span class="hljs-keyword">return</span> <span class="hljs-string">"请提供搜索关键词"</span>

        db_mgr = get_database_manager()
        matching_tables = db_mgr.filter_table_names(keyword.strip())
        
        <span class="hljs-keyword">if</span> matching_tables:
            table_list = <span class="hljs-string">", "</span>.join(matching_tables)
            result = <span class="hljs-string">f"搜索关键词 '<span class="hljs-subst">{keyword}</span>' 找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(matching_tables)}</span> 个相关表:\n"</span>
            result += <span class="hljs-string">f"匹配的表: <span class="hljs-subst">{table_list}</span>"</span>
            logger.info(<span class="hljs-string">f"关键词 '<span class="hljs-subst">{keyword}</span>' 匹配到: <span class="hljs-subst">{table_list}</span>"</span>)
            <span class="hljs-keyword">return</span> result
        <span class="hljs-keyword">else</span>:
            all_tables = db_mgr.get_table_names()
            all_table_list = <span class="hljs-string">", "</span>.join(all_tables) <span class="hljs-keyword">if</span> all_tables <span class="hljs-keyword">else</span> <span class="hljs-string">"无"</span>
            result = <span class="hljs-string">f"搜索关键词 '<span class="hljs-subst">{keyword}</span>' 没有找到匹配的表。\n"</span>
            result += <span class="hljs-string">f"数据库中的所有表: <span class="hljs-subst">{all_table_list}</span>\n"</span>
            result += <span class="hljs-string">f"建议尝试其他关键词，如表名的一部分。"</span>
            logger.info(<span class="hljs-string">f"关键词 '<span class="hljs-subst">{keyword}</span>' 没有找到匹配的表。"</span>)
            <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        error_msg = <span class="hljs-string">f"搜索表名失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
        logger.error(error_msg)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{error_msg}</span>"</span>
</code></pre>
<p>数据库管理器中的搜索逻辑：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_table_names</span>(<span class="hljs-params">self, keyword: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
    <span class="hljs-string">"""根据关键词搜索相关表名"""</span>
    <span class="hljs-keyword">try</span>:
        all_tables = self.get_table_names()
        <span class="hljs-comment"># 不区分大小写的模糊匹配</span>
        matching_tables = [
            table <span class="hljs-keyword">for</span> table <span class="hljs-keyword">in</span> all_tables 
            <span class="hljs-keyword">if</span> keyword.lower() <span class="hljs-keyword">in</span> table.lower()
        ]
        <span class="hljs-keyword">return</span> matching_tables
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"搜索表名失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">raise</span>
</code></pre>
<p>这个功能在大型项目中特别有用，想象一下在一个有100个表的电商系统中快速找到所有支付相关的表！</p>
<h2 data-id="heading-2">第二步：schema_definitions() - 深度解析表结构</h2>
<p>知道表名还不够，得知道表里有什么字段、什么类型、什么关系。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"获取指定表的详细结构信息，包括列、类型、主键、索引、外键等。支持同时查询多个表。"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">schema_info</span>(<span class="hljs-params">table_names: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定表的详细结构信息"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> table_names:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"请提供要查询的表名"</span>

        db_mgr = get_database_manager()
        result_parts = []

        <span class="hljs-keyword">for</span> table_name <span class="hljs-keyword">in</span> table_names:
            <span class="hljs-keyword">try</span>:
                schema_info = db_mgr.get_table_schema(table_name)
                
                <span class="hljs-comment"># 格式化表结构信息</span>
                table_section = <span class="hljs-string">f"\n<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">50</span>}</span>\n"</span>
                table_section += <span class="hljs-string">f"表名：<span class="hljs-subst">{table_name}</span>\n"</span>
                table_section += <span class="hljs-string">f"列：<span class="hljs-subst">{schema_info[<span class="hljs-string">'columns'</span>]}</span>\n"</span>
                table_section += <span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">50</span>}</span>\n"</span>

                <span class="hljs-comment"># 列信息</span>
                column_section = <span class="hljs-string">"列信息：\n"</span>
                <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> schema_info[<span class="hljs-string">'columns'</span>]:
                    col_type = col[<span class="hljs-string">'type'</span>]
                    nullable = <span class="hljs-string">"可空"</span> <span class="hljs-keyword">if</span> col[<span class="hljs-string">'nullable'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">"不可空"</span>
                    pk_mark = <span class="hljs-string">" 主键"</span> <span class="hljs-keyword">if</span> col[<span class="hljs-string">'is_primary_key'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
                    default_info = <span class="hljs-string">f" (默认: <span class="hljs-subst">{col[<span class="hljs-string">'default'</span>]}</span>)"</span> <span class="hljs-keyword">if</span> col[<span class="hljs-string">'default'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>

                    table_section += <span class="hljs-string">f"  • <span class="hljs-subst">{col[<span class="hljs-string">'name'</span>]}</span>: <span class="hljs-subst">{col_type}</span> - <span class="hljs-subst">{nullable}</span><span class="hljs-subst">{pk_mark}</span><span class="hljs-subst">{default_info}</span>\n"</span>
                
                <span class="hljs-comment"># 主键信息</span>
                <span class="hljs-keyword">if</span> schema_info[<span class="hljs-string">'primary_keys'</span>]:
                    table_section += <span class="hljs-string">f"\n主键: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(schema_info[<span class="hljs-string">'primary_keys'</span>])}</span>\n"</span>

                <span class="hljs-comment"># 索引信息</span>
                <span class="hljs-keyword">if</span> schema_info[<span class="hljs-string">'indexes'</span>]:
                    table_section += <span class="hljs-string">"\n索引信息:\n"</span>
                    <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> schema_info[<span class="hljs-string">'indexes'</span>]:
                        unique_mark = <span class="hljs-string">"唯一索引"</span> <span class="hljs-keyword">if</span> idx.get(<span class="hljs-string">'unique'</span>, <span class="hljs-literal">False</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">"普通索引"</span>
                        columns = <span class="hljs-string">', '</span>.join(idx[<span class="hljs-string">'column_names'</span>])
                        table_section += <span class="hljs-string">f"  • <span class="hljs-subst">{idx[<span class="hljs-string">'name'</span>]}</span>: <span class="hljs-subst">{unique_mark}</span> (<span class="hljs-subst">{columns}</span>)\n"</span>

                <span class="hljs-comment"># 外键信息</span>
                <span class="hljs-keyword">if</span> schema_info[<span class="hljs-string">'foreign_keys'</span>]:
                    table_section += <span class="hljs-string">"\n外键关系:\n"</span>
                    <span class="hljs-keyword">for</span> fk <span class="hljs-keyword">in</span> schema_info[<span class="hljs-string">'foreign_keys'</span>]:
                        local_cols = <span class="hljs-string">', '</span>.join(fk[<span class="hljs-string">'constrained_columns'</span>])
                        ref_table = fk[<span class="hljs-string">'referred_table'</span>]
                        ref_cols = <span class="hljs-string">', '</span>.join(fk[<span class="hljs-string">'referred_columns'</span>])
                        table_section += <span class="hljs-string">f"  • <span class="hljs-subst">{local_cols}</span> → <span class="hljs-subst">{ref_table}</span>.<span class="hljs-subst">{ref_cols}</span>\n"</span>
                
                result_parts.append(table_section)
            
            <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
                result_parts.append(<span class="hljs-string">f"\n表 '<span class="hljs-subst">{table_name}</span>': <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>\n"</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                result_parts.append(<span class="hljs-string">f"\n表 '<span class="hljs-subst">{table_name}</span>' 解析失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>\n"</span>)

        final_result = <span class="hljs-string">'\n'</span>.join(result_parts)
        logger.info(<span class="hljs-string">f"成功解析 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(table_names)}</span> 个表的结构"</span>)

        <span class="hljs-keyword">return</span> final_result
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        error_msg = <span class="hljs-string">f"获取表结构信息失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
        logger.error(error_msg)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{error_msg}</span>"</span>
</code></pre>
<p>数据库管理器中的解析逻辑：</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_table_schema</span>(<span class="hljs-params">self, table_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">"""获取指定表的详细结构信息"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                inspector = inspect(conn)

                <span class="hljs-comment"># 验证表是否存在</span>
                <span class="hljs-keyword">if</span> table_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> inspector.get_table_names():
                    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"表 '<span class="hljs-subst">{table_name}</span>' 不存在"</span>)
                
                <span class="hljs-comment"># 获取列信息</span>
                columns = inspector.get_columns(table_name)
                
                <span class="hljs-comment"># 获取主键信息</span>
                pk_constraint = inspector.get_pk_constraint(table_name)
                primary_keys = <span class="hljs-built_in">set</span>(pk_constraint[<span class="hljs-string">"constrained_columns"</span>])
                           
                <span class="hljs-comment"># 获取索引信息</span>
                indexes = inspector.get_indexes(table_name)
                
                <span class="hljs-comment"># 获取外键信息</span>
                foreign_keys = inspector.get_foreign_keys(table_name)

                <span class="hljs-comment"># 格式化列信息</span>
                formatted_columns = []
                <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> columns:
                    col_info = {
                        <span class="hljs-string">"name"</span>: col[<span class="hljs-string">"name"</span>],
                        <span class="hljs-string">"type"</span>: <span class="hljs-built_in">str</span>(col[<span class="hljs-string">"type"</span>]),
                        <span class="hljs-string">"nullable"</span>: col[<span class="hljs-string">"nullable"</span>],
                        <span class="hljs-string">"default"</span>: col.get(<span class="hljs-string">"default"</span>),
                        <span class="hljs-string">"is_primary_key"</span>: col[<span class="hljs-string">"name"</span>] <span class="hljs-keyword">in</span> primary_keys
                    }
                    formatted_columns.append(col_info)

                schema_info = {
                    <span class="hljs-string">"table_name"</span>: table_name,
                    <span class="hljs-string">"columns"</span>: formatted_columns,
                    <span class="hljs-string">"primary_keys"</span>: <span class="hljs-built_in">list</span>(primary_keys),
                    <span class="hljs-string">"indexes"</span>: indexes,
                    <span class="hljs-string">"foreign_keys"</span>: foreign_keys,
                    <span class="hljs-string">"column_count"</span>: <span class="hljs-built_in">len</span>(columns)
                }

                <span class="hljs-keyword">return</span> schema_info
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"获取表结构信息失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>

</code></pre>
<h2 data-id="heading-3">第三步：execute_query() - 安全执行SQL查询</h2>
<p>最后这个功能是核心中的核心！让AI能执行SQL查询，但必须确保安全性。我们只允许SELECT查询，并且有完整的防护措施。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"安全执行SQL查询语句。只支持SELECT查询，自动添加结果限制，支持参数化查询防止SQL注入。"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_query</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span>, params: <span class="hljs-built_in">dict</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> query <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> query.strip():
                <span class="hljs-keyword">return</span> <span class="hljs-string">"请提供查询语句"</span>
            
        db_mgr = get_database_manager()
        
        <span class="hljs-comment"># 如果没有提供参数，设为None</span>
        query_params = params <span class="hljs-keyword">if</span> params <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

        <span class="hljs-comment"># 执行查询</span>
        result = db_mgr.execute_query(query.strip(), query_params)

        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"查询结果为空"</span>
            
        <span class="hljs-comment">#格式化返结果</span>
        result_text = <span class="hljs-string">"查询结果:\n"</span>
        <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> result:
                result_text += <span class="hljs-string">f"<span class="hljs-subst">{row}</span>\n"</span>
                
        <span class="hljs-keyword">return</span> result_text
    
    <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># 安全验证失败</span>
        error_msg = <span class="hljs-string">f"查询安全验证失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
        logger.warning(error_msg)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{error_msg}</span>\n\n 提示：本工具只支持 SELECT 查询，且会自动添加安全限制。"</span>
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        error_msg = <span class="hljs-string">f"执行查询失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>
        logger.error(error_msg)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{error_msg}</span>"</span>
</code></pre>
<p>数据库管理器中也要有验证：</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_validate_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""验证查询安全性"""</span>
        query_upper = query.upper().strip()
        
        <span class="hljs-comment"># 检查危险的SQL操作</span>
        dangerous_keywords = [
            <span class="hljs-string">"DROP"</span>, <span class="hljs-string">"DELETE"</span>, <span class="hljs-string">"UPDATE"</span>, <span class="hljs-string">"INSERT"</span>, <span class="hljs-string">"ALTER"</span>, <span class="hljs-string">"CREATE"</span>, <span class="hljs-string">"TRUNCATE"</span>
        ]
        
        <span class="hljs-keyword">for</span> keyword <span class="hljs-keyword">in</span> dangerous_keywords:
            <span class="hljs-keyword">if</span> keyword <span class="hljs-keyword">in</span> query_upper:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"查询包含危险操作: <span class="hljs-subst">{keyword}</span>"</span>)
        
        <span class="hljs-comment"># 检查是否是SELECT查询</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> query_upper.startswith(<span class="hljs-string">"SELECT"</span>):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"只允许执行SELECT查询"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_add_limit_to_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, limit: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""为查询添加LIMIT子句"""</span>
        query_upper = query.upper()
        
        <span class="hljs-comment"># 如果已经有LIMIT，不再添加</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">"LIMIT"</span> <span class="hljs-keyword">in</span> query_upper:
            <span class="hljs-keyword">return</span> query
        
        <span class="hljs-comment"># 添加LIMIT子句</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{query.rstrip(<span class="hljs-string">';'</span>)}</span> LIMIT <span class="hljs-subst">{limit}</span>"</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, params: <span class="hljs-built_in">dict</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">"""安全执行SQL查询"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 验证查询安全性</span>
            self._validate_query(query)
            
            <span class="hljs-comment"># 添加默认限制</span>
            limited_query = self._add_limit_to_query(query, <span class="hljs-number">1000</span>)
            
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                <span class="hljs-keyword">if</span> params:
                    <span class="hljs-comment"># 使用参数化查询</span>
                    result = conn.execute(text(limited_query), params)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># 直接执行查询</span>
                    result = conn.execute(text(limited_query))
                
                <span class="hljs-comment"># 获取列名</span>
                columns = result.keys()
                
                <span class="hljs-comment"># 转换为字典列表</span>
                rows = []
                <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> result:
                    row_dict = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(columns, row))
                    rows.append(row_dict)
                
                <span class="hljs-keyword">return</span> rows
                
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"执行查询失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
</code></pre>
<h2 data-id="heading-4">第四步：功能验证测试</h2>
<p>为了确保所有功能都正常工作，我们创建一个简单的验证脚本。这不是复杂的单元测试，而是帮助读者快速验证功能的工具。</p>
<h3 data-id="heading-5">创建验证脚本</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
tests/verify_functions.py - 功能验证脚本
"""</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-comment"># 添加项目路径</span>
project_root = Path(__file__).parent.parent
sys.path.insert(<span class="hljs-number">0</span>, <span class="hljs-built_in">str</span>(project_root / <span class="hljs-string">"src"</span>))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_database_connection</span>():
    <span class="hljs-string">"""验证数据库连接"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 数据库连接验证 ==="</span>)
    
    <span class="hljs-comment"># 设置数据库URL</span>
    db_path = project_root / <span class="hljs-string">"data"</span> / <span class="hljs-string">"test.db"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> db_path.exists():
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"测试数据库不存在！"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    
    os.environ[<span class="hljs-string">'DB_URL'</span>] = <span class="hljs-string">f'sqlite:///<span class="hljs-subst">{db_path}</span>'</span>
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">from</span> mcp_datatools.database <span class="hljs-keyword">import</span> DatabaseManager
        db_mgr = DatabaseManager()
        
        <span class="hljs-keyword">if</span> db_mgr.test_connection():
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"数据库连接成功"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"数据库连接失败"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据库连接错误: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">verify_basic_functions</span>():
    <span class="hljs-string">"""验证基础功能"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 基础功能验证 ==="</span>)
    
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">from</span> mcp_datatools.database <span class="hljs-keyword">import</span> DatabaseManager
        db_mgr = DatabaseManager()
        
        <span class="hljs-comment"># 测试1: 获取表名</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 测试 list_tables() 功能..."</span>)
        tables = db_mgr.get_table_names()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tables)}</span> 个表: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(tables)}</span>"</span>)
        
        <span class="hljs-comment"># 测试2: 搜索表名</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 测试 filter_table_names() 功能..."</span>)
        user_tables = db_mgr.filter_table_names(<span class="hljs-string">'user'</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   搜索 'user' 找到: <span class="hljs-subst">{user_tables}</span>"</span>)
        
        <span class="hljs-comment"># 测试3: 获取表结构</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 测试 get_table_schema() 功能..."</span>)
        <span class="hljs-keyword">if</span> tables:
            schema = db_mgr.get_table_schema(tables[<span class="hljs-number">0</span>])
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  表 '<span class="hljs-subst">{tables[<span class="hljs-number">0</span>]}</span>' 有 <span class="hljs-subst">{schema[<span class="hljs-string">'column_count'</span>]}</span> 个列"</span>)
        
        <span class="hljs-comment"># 测试4: 执行查询</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"4. 测试 execute_query() 功能..."</span>)
        result = db_mgr.execute_query(<span class="hljs-string">"SELECT COUNT(*) as count FROM users"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   查询结果: <span class="hljs-subst">{result}</span>"</span>)
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"功能验证失败: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主验证流程"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"MCP DataTools 功能验证"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    
    <span class="hljs-comment"># 验证数据库连接</span>
    db_ok = verify_database_connection()
    
    <span class="hljs-keyword">if</span> db_ok:
        <span class="hljs-comment"># 验证基础功能</span>
        func_ok = verify_basic_functions()
        
        <span class="hljs-keyword">if</span> func_ok:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n 所有基础功能验证通过！"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n部分功能验证失败，请检查代码"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n数据库连接失败，请先创建测试数据库"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"验证完成！现在可以在Cursor中测试MCP功能了。"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h3 data-id="heading-6">运行验证</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 确保有测试数据</span>
python data/init_sqlite_db.py

<span class="hljs-comment"># 2. 运行功能验证</span>
python tests/verify_functions.py
</code></pre>
<h3 data-id="heading-7">验证结果示例</h3>
<pre><code class="hljs language-css" lang="css">MCP DataTools 功能验证
==================================================
=== 数据库连接验证 ===
数据库连接成功

=== 基础功能验证 ===
<span class="hljs-number">1</span>. 测试 list_tables() 功能...
   找到 <span class="hljs-number">3</span> 个表: orders, products, users
<span class="hljs-number">2</span>. 测试 <span class="hljs-built_in">filter_table_names</span>() 功能...
   搜索 <span class="hljs-string">'user'</span> 找到: [<span class="hljs-string">'users'</span>]
<span class="hljs-number">3</span>. 测试 <span class="hljs-built_in">get_table_schema</span>() 功能...
  表 <span class="hljs-string">'orders'</span> 有 <span class="hljs-number">3</span> 个列
<span class="hljs-number">4</span>. 测试 <span class="hljs-built_in">execute_query</span>() 功能...
   查询结果: [{'count': <span class="hljs-number">2</span>}]

 所有基础功能验证通过！

==================================================
验证完成！现在可以在<span class="hljs-attribute">Cursor</span>中测试MCP功能了。
</code></pre>
<h2 data-id="heading-8">第五步：功能演示效果</h2>
<p>现在让我们看看这些功能在实际使用中的效果：</p>
<h3 data-id="heading-9">1. 智能搜索表名</h3>
<p>试试问AI："找找用户相关的表"</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9aaf1817a1142ec8d64fc5e6abd1ea3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975226&amp;x-signature=hPNGGSq%2FZQ%2B3cOM94IJFedhU99g%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>或者问："有哪些订单相关的表？"</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60fdae4b2f1749a480ca74749740d2ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975226&amp;x-signature=4KDTd474mpK00bfGShmovx4jfSc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-10">2. 深度解析表结构</h3>
<p>问AI："users表的结构是什么样的？"
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c616716b2b5147d4bc59acb8a43e501c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975226&amp;x-signature=Hrpqg2FSTe%2BIpa8GZAIH4RFnCk8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h3 data-id="heading-11">3. 安全执行SQL查询</h3>
<p><strong>简单查询：</strong> "查询users表中的所有数据"
AI执行：<code>SELECT * FROM users</code>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26ae800e66a84824ae826b4bb7fb35a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975226&amp;x-signature=K%2FqXHYIrcTFNldQ5y6MPzx4A5Ro%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>条件查询：</strong> "查询价格大于1000的产品"
AI执行：<code>SELECT * FROM products WHERE price &gt; 1000</code>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f13e52213a844868bfc6f1846dbe91a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975226&amp;x-signature=GBIBwNm1C4OwUo1XVpHhth0QS6A%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>复杂查询：</strong> "查询每个用户的订单数量"
AI可以执行JOIN查询
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f7057d74bcd404685a17c71b52e843d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975226&amp;x-signature=tsGmtk4qNW2NMH%2FZlBtc1kkMrqY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-12">总结与预告</h2>
<p>第2篇我们成功实现了3个核心功能：表搜索、结构分析、安全SQL执行，让AI能够理解数据库结构并执行复杂查询。第3篇将实现PostgreSQL、MySQL等主流数据库支持，加上基础连接池配置和Docker部署，让这个工具真正走向生产环境。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JobFlow 背后：五个让我豁然开朗的设计瞬间]]></title>    <link>https://juejin.cn/post/7585751355593506835</link>    <guid>https://juejin.cn/post/7585751355593506835</guid>    <pubDate>2025-12-22T02:31:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355593506835" data-draft-id="7585825055437488134" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JobFlow 背后：五个让我豁然开朗的设计瞬间"/> <meta itemprop="keywords" content="后端,架构,分布式"/> <meta itemprop="datePublished" content="2025-12-22T02:31:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JobFlow 背后：五个让我豁然开朗的设计瞬间
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:31:20.000Z" title="Mon Dec 22 2025 02:31:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🔗 开源地址与系列文章</h2>
<ul>
<li><strong>开源地址</strong>：<code>https://gitee.com/sh_wangwanbao/job-flow</code></li>
<li><strong>系列文章：</strong>
<ul>
<li><a href="https://juejin.cn/post/7583469866007969827" target="_blank" title="https://juejin.cn/post/7583469866007969827">第一篇：基于Nacos的轻量任务调度方案 —— 从 XXL-Job 的痛点说起</a></li>
<li><a href="https://juejin.cn/post/7584353612501106729" target="_blank" title="https://juejin.cn/post/7584353612501106729">第二篇：JobFlow 实现方案：云原生时代的任务调度新思路</a></li>
<li><a href="https://juejin.cn/post/7585727457472823296" target="_blank" title="https://juejin.cn/post/7585727457472823296">第三篇：JobFlow 实战：无锁调度是怎么做到的</a></li>
<li><a href="https://juejin.cn/editor/drafts/7585825055437488134" target="_blank" title="https://juejin.cn/editor/drafts/7585825055437488134">第四篇：JobFlow 背后：五个让我豁然开朗的设计瞬间</a></li>
<li>第五篇：分布式调度的终极难题：超时、补偿与漏调（统写中）</li>
<li>第六篇：延时队列的设计与实现（统写中）</li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">前言</h2>
<p>昨天晚上折腾到12点，把 JobFlow 的延时队列功能测试完，看着日志里一条条任务准时执行，突然有种感觉：<strong>这个东西，想通了就很简单。</strong></p>
<p>从最开始被 XXL-Job 的两套注册中心搞得头疼，到决定自己写一个调度框架，再到核心功能开发完成，前后不到两周时间。不是因为我写代码有多快，而是想清楚了几个关键问题之后，代码几乎是自己长出来的。</p>
<p>这篇文章不讲具体的代码实现，那些技术细节后面会有专门的文章。今天想聊的是：<strong>这两周我是怎么想的，为什么会这么设计。</strong></p>
<p><strong>先说清楚适用边界：</strong></p>
<p>JobFlow 不是要替代 XXL-Job，而是在特定场景下的一个轻量级选择。</p>
<p>适合用 JobFlow 的场景：</p>
<ul>
<li>技术栈 all-in Spring Cloud Alibaba + Nacos</li>
<li>业务团队自己维护调度系统（不需要中间件团队）</li>
<li>业务型调度 + 延时任务（订单超时、数据同步、定时清理）</li>
<li>中小规模（百万级以下任务量）</li>
</ul>
<p>不适合用 JobFlow 的场景：</p>
<ul>
<li>需要 Web 管理后台（JobFlow 没有 UI，通过数据库和配置文件管理）</li>
<li>跨公司、多租户的通用调度平台</li>
<li>强 SLA 的金融核心任务（秒级精度保证）</li>
<li>超大规模 Cron 平台（需要分库分表）</li>
</ul>
<p>如果你的场景不在上面的"适合"列表里，建议直接用 XXL-Job，功能完整、社区成熟。</p>
<p>好，边界说清楚了，开始正文。</p>
<p>写这篇文章有点冒险，因为不够"专业"。没有严谨的理论推导，没有完整的性能测试报告，就是记录一些想法和感悟。但我觉得这种"想通了"的过程，可能比代码本身更有价值。</p>
<h2 data-id="heading-2">痛点：两套注册中心的割裂感</h2>
<p>事情的起因很简单：我们的微服务用的是 Spring Cloud Alibaba + Nacos，项目里要加定时任务，自然就想到了 XXL-Job。</p>
<p>装上，配好，跑起来，一切正常。但用了一段时间之后，总觉得哪里别扭。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph Nacos体系
        N[Nacos&lt;br/&gt;服务发现]
        S1[订单服务]
        S2[用户服务]
        S3[支付服务]
    end
    
    subgraph XXL-Job体系
        A[XXL-Job Admin&lt;br/&gt;调度中心]
        E1[订单服务&lt;br/&gt;Executor]
        E2[用户服务&lt;br/&gt;Executor]
    end
    
    S1 --&gt; N
    S2 --&gt; N
    S3 --&gt; N
    
    E1 --&gt; A
    E2 --&gt; A
    
    S1 -.同一个应用.-&gt; E1
    S2 -.同一个应用.-&gt; E2
    
    style N fill:#90EE90
    style A fill:#FFB6C1
</code></pre>
<p>问题在哪？</p>
<p><strong>同一个服务，在 Nacos 里注册一次，在 XXL-Job 里又要注册一次。</strong></p>
<p>某天下午，订单服务在 Nacos 里显示下线了，运维同学说机器重启了。但 XXL-Job 的管理后台上，订单服务的执行器还是在线状态，定时任务还在往这个已经挂掉的实例上调度。</p>
<p>排查了半天才发现，XXL-Job 的心跳检测间隔比 Nacos 长，所以摘除得慢。</p>
<p>当时就在想：<strong>为什么要维护两套状态？</strong></p>
<p>还有个问题：排查任务执行失败的时候，得先去 XXL-Job 的管理后台查调度日志，然后再去 ELK 查执行器的业务日志。两个日志系统之间没有关联，只能靠时间戳对。</p>
<p>有一次半夜被叫起来排查问题，任务调度时间是凌晨 2:00:01，执行器日志是 2:00:03，中间差了 2 秒。这 2 秒里发生了什么？不知道。调度器到执行器之间的链路断了，查不到。</p>
<p><strong>两套注册中心，两套日志体系，割裂的。</strong></p>
<h2 data-id="heading-3">第一个想法：能不能只用 Nacos？</h2>
<p>周末在家躺着，脑子里一直在想这个问题。</p>
<p>XXL-Job 为什么要自己搞一套注册中心？因为它要做成通用的任务调度平台，不能绑定在某个具体的服务发现组件上。这个逻辑没问题，但对我们这种已经 all-in Nacos 的项目来说，就是重复建设了。</p>
<p><strong>如果调度器也是一个普通的微服务，直接注册到 Nacos 上呢？</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph Nacos统一体系
        N[Nacos]
        
        subgraph 调度层
            J1[JobFlow&lt;br/&gt;Scheduler-1]
            J2[JobFlow&lt;br/&gt;Scheduler-2]
        end
        
        subgraph 业务层
            S1[订单服务-1]
            S2[订单服务-2]
            S3[用户服务-1]
        end
    end
    
    J1 --&gt; N
    J2 --&gt; N
    S1 --&gt; N
    S2 --&gt; N
    S3 --&gt; N
    
    J1 -.发现服务.-&gt; N
    J1 --&gt; |HTTP调用| S1
    J1 --&gt; |HTTP调用| S2
    
    style N fill:#90EE90
</code></pre>
<p>这个想法一出来，后面的设计就顺了。</p>
<p>调度器不是独立的平台，而是业务中台的一部分：</p>
<ul>
<li>和业务服务部署在同一个 K8s 集群</li>
<li>用同一套 Prometheus 监控</li>
<li>日志输出到同一个 ELK</li>
<li>通过 Nacos 发现业务服务</li>
</ul>
<p><strong>不需要单独的管理后台，不需要单独的运维团队，业务团队自己就能维护。</strong></p>
<p>这个思路确定下来，很多问题就迎刃而解了。</p>
<h2 data-id="heading-4">第二个想法：调度器多实例怎么办？</h2>
<p>调度器是个微服务，那肯定要多实例部署（高可用）。问题来了：</p>
<pre><code class="hljs">假设部署 3 个调度器实例
有 50 个定时任务
每分钟都要执行

如果 3 个实例都去调度这 50 个任务
→ 每个任务会被调度 3 次
→ 重复执行
</code></pre>
<p>传统方案是用分布式锁：3 个实例去数据库抢锁，抢到的才能调度。</p>
<p>但这样有个问题：</p>
<pre><code class="hljs language-diff" lang="diff">每分钟：
<span class="hljs-deletion">- 3 个实例 × 50 个任务 = 150 次数据库 UPDATE</span>
<span class="hljs-deletion">- 但只有 50 次是有效的</span>
<span class="hljs-deletion">- 另外 100 次是浪费</span>

一天下来：
<span class="hljs-deletion">- 144,000 次无效操作</span>
</code></pre>
<p>周日晚上吃完饭，在阳台抽烟的时候想到一个点：<strong>为什么一定要抢锁？</strong></p>
<p>3 个实例都去抢，本质上是因为它们不知道自己该不该执行这个任务。那如果让每个实例自己算出来呢？</p>
<pre><code class="hljs language-diff" lang="diff">调度器实例列表（从 Nacos 拿到）：
<span class="hljs-deletion">- scheduler-001</span>
<span class="hljs-deletion">- scheduler-002  </span>
<span class="hljs-deletion">- scheduler-003</span>

任务列表：
<span class="hljs-deletion">- orderSync</span>
<span class="hljs-deletion">- userClean</span>
<span class="hljs-deletion">- reportGen</span>

分配规则：
<span class="hljs-deletion">- "orderSync".hashCode() % 3 = 0 → scheduler-001 负责</span>
<span class="hljs-deletion">- "userClean".hashCode() % 3 = 2 → scheduler-003 负责</span>
<span class="hljs-deletion">- "reportGen".hashCode() % 3 = 1 → scheduler-002 负责</span>
</code></pre>
<p><strong>每个实例自己算，算完之后只执行自己负责的任务，不需要去抢锁。</strong></p>
<p>这就是 Hash 分区 + Owner 判定。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 传统方案
        A1[实例1] --&gt; L[分布式锁]
        A2[实例2] --&gt; L
        A3[实例3] --&gt; L
        L --&gt; T[任务执行]
    end
    
    subgraph JobFlow方案
        B1[实例1&lt;br/&gt;算出负责 A,D,G] --&gt; T1[执行 A,D,G]
        B2[实例2&lt;br/&gt;算出负责 B,E,H] --&gt; T2[执行 B,E,H]
        B3[实例3&lt;br/&gt;算出负责 C,F,I] --&gt; T3[执行 C,F,I]
    end
</code></pre>
<p>代码写起来也很简单：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 从 Nacos 获取所有调度器实例</span>
List&lt;Instance&gt; instances = namingService.getAllInstances(serviceName);

<span class="hljs-comment">// 排序（关键！所有实例看到的顺序要一致）</span>
instances.sort(Comparator.comparing(i -&gt; i.getIp() + <span class="hljs-string">":"</span> + i.getPort()));

<span class="hljs-comment">// 计算任务归谁</span>
<span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> Math.abs(jobName.hashCode());
<span class="hljs-type">int</span> <span class="hljs-variable">targetIndex</span> <span class="hljs-operator">=</span> hash % instances.size();

<span class="hljs-comment">// 判断是不是我</span>
<span class="hljs-keyword">return</span> currentIndex == targetIndex;
</code></pre>
<p>想通这个之后，我知道这事能成了。</p>
<h2 data-id="heading-5">第三个想法：会不会漏调？</h2>
<p>无锁设计解决了重复执行的问题，但带来了新问题：<strong>会不会漏调？</strong></p>
<pre><code class="hljs language-diff" lang="diff">场景：3 个调度器实例
<span class="hljs-deletion">- scheduler-001 负责 orderSync</span>
<span class="hljs-deletion">- scheduler-002 负责 userClean</span>
<span class="hljs-deletion">- scheduler-003 负责 reportGen</span>

如果 scheduler-001 挂了：
<span class="hljs-deletion">- Nacos 检测到（约 15 秒）</span>
<span class="hljs-deletion">- scheduler-002 和 003 重新计算 Hash</span>
<span class="hljs-deletion">- scheduler-002 接管 orderSync</span>

但这 15 秒内，orderSync 如果到期了呢？
→ 漏调了
</code></pre>
<p>这是无锁设计的代价。</p>
<p><strong>说清楚：我们牺牲了什么</strong></p>
<p>为了追求无锁的性能，我们放弃了一些东西：</p>
<p>放弃的保证：</p>
<ul>
<li>精确到秒的强保证 → 可能延迟 3-5 分钟（巡检周期）</li>
<li>调度瞬时一致性 → 实例切换期间可能漏调</li>
<li>完全无 DB 依赖 → 唯一索引兜底仍需数据库</li>
</ul>
<p>换来的好处：</p>
<ul>
<li>数据库压力降低 67%</li>
<li>无分布式锁开销</li>
<li>实例扩缩容自动生效</li>
</ul>
<p>这是典型的分布式权衡：<strong>不追求完美的一致性，而是用异步补偿换取更好的性能。</strong></p>
<p>周一上午写代码的时候一直在想这个问题。中午吃饭的时候突然想明白了：<strong>用巡检补偿。</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 正常流程
        A[Hash分区] --&gt; B[Owner判定]
        B --&gt; C[执行任务]
    end
    
    subgraph 异常流程
        D[巡检任务&lt;br/&gt;最小节点负责] --&gt; E[扫描数据库]
        E --&gt; F{应该执行&lt;br/&gt;但没执行?}
        F --&gt; |是| G[补偿触发]
        F --&gt; |否| H[跳过]
    end
    
    C --&gt; |99%情况| I[任务完成]
    G --&gt; |1%情况| I
</code></pre>
<p>具体怎么做：</p>
<pre><code class="hljs language-markdown" lang="markdown">最小节点负责巡检（选主规则很简单）：
<span class="hljs-bullet">1.</span> 从 Nacos 获取所有实例
<span class="hljs-bullet">2.</span> 排序
<span class="hljs-bullet">3.</span> 最小的那个就是 Leader

巡检任务每 3 分钟执行一次：
<span class="hljs-bullet">1.</span> 查询所有启用的任务
<span class="hljs-bullet">2.</span> 判断：应该执行但没执行
<span class="hljs-bullet">3.</span> 补偿触发

即使漏调了，最多延迟 3 分钟
</code></pre>
<p>这是分布式系统的经典做法：<strong>正常流程追求效率，异常流程追求可靠性。</strong></p>
<p>周一下午把这块代码写完，测试了一下：停掉一个调度器实例，任务确实在 15 秒左右切换过去了；停掉所有实例再启动，巡检任务会补偿执行。</p>
<p>心里踏实了。</p>
<h2 data-id="heading-6">第四个想法：固定分片的妙处</h2>
<p>任务调度还有个常见场景：大数据量的批处理。</p>
<p>比如每天凌晨要给 100 万用户发推送，怎么办？</p>
<p>传统做法是动态分片：调度器根据执行器实例数，动态分配任务范围。比如有 10 个执行器实例，就分成 10 片。</p>
<p>但这样有个问题：</p>
<pre><code class="hljs language-diff" lang="diff">场景：10 个执行器实例，100 万用户

调度时刻：
<span class="hljs-deletion">- 实例 1 负责 0-10 万</span>
<span class="hljs-deletion">- 实例 2 负责 10-20 万</span>
<span class="hljs-deletion">- ...</span>

如果实例 5 挂了：
<span class="hljs-deletion">- 剩余 9 个实例</span>
<span class="hljs-deletion">- 需要重新分片：0-11.1 万、11.1-22.2 万...</span>
<span class="hljs-deletion">- 但已经在执行的分片怎么办？</span>
</code></pre>
<p>周二晚上在家想这个问题，想了很久。</p>
<p>周三早上洗澡的时候突然想通了：<strong>固定分片 + 回调驱动。</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">任务配置：固定 100 个分片（和实例数无关）

执行流程：
<span class="hljs-bullet">1.</span> 调度器创建 100 条分片记录（PENDING 状态）
<span class="hljs-bullet">2.</span> 初始分配：min(分片数, 实例数) 个分片
<span class="hljs-bullet">3.</span> 执行器执行完一个分片，回调调度器
<span class="hljs-bullet">4.</span> 调度器 CAS 更新状态，分配下一个 PENDING 分片
<span class="hljs-bullet">5.</span> 继续循环，直到所有分片完成
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant S as 调度器
    participant E1 as 执行器1
    participant E2 as 执行器2
    participant DB as 数据库
    
    S-&gt;&gt;DB: 创建100个分片&lt;br/&gt;状态=PENDING
    S-&gt;&gt;DB: CAS更新分片0&lt;br/&gt;PENDING→RUNNING
    S-&gt;&gt;E1: 执行分片0
    S-&gt;&gt;DB: CAS更新分片1&lt;br/&gt;PENDING→RUNNING
    S-&gt;&gt;E2: 执行分片1
    
    E1-&gt;&gt;E1: 执行业务逻辑
    E1-&gt;&gt;S: 回调：分片0完成
    S-&gt;&gt;DB: 更新分片0&lt;br/&gt;RUNNING→SUCCESS
    S-&gt;&gt;DB: CAS更新分片2&lt;br/&gt;PENDING→RUNNING
    S-&gt;&gt;E1: 执行分片2
    
    E2-&gt;&gt;E2: 执行业务逻辑
    E2-&gt;&gt;S: 回调：分片1完成
    S-&gt;&gt;DB: 更新分片1&lt;br/&gt;RUNNING→SUCCESS
    S-&gt;&gt;DB: CAS更新分片3&lt;br/&gt;PENDING→RUNNING
    S-&gt;&gt;E2: 执行分片3
</code></pre>
<p>这个设计的好处：</p>
<p><strong>1. 固定分片，不受实例数影响</strong></p>
<pre><code class="hljs">100 个分片，10 个实例：每个实例平均 10 个分片
100 个分片，5 个实例：每个实例平均 20 个分片
100 个分片，20 个实例：每个实例平均 5 个分片

分片数是固定的，实例数可以动态变化
</code></pre>
<p><strong>2. 回调驱动，动态负载均衡</strong></p>
<pre><code class="hljs">快的实例多执行几个分片
慢的实例少执行几个分片
自动负载均衡，不需要预先计算
</code></pre>
<p><strong>3. 状态可查，进度透明</strong></p>
<pre><code class="hljs language-diff" lang="diff">数据库里有每个分片的状态：
<span class="hljs-deletion">- PENDING：等待执行</span>
<span class="hljs-deletion">- RUNNING：执行中</span>
<span class="hljs-deletion">- SUCCESS：成功</span>
<span class="hljs-deletion">- FAILED：失败</span>

随时可以看到任务进度
</code></pre>
<p><strong>4. 断点续传，失败重试</strong></p>
<pre><code class="hljs language-diff" lang="diff">如果某个分片失败了：
<span class="hljs-deletion">- 状态标记为 FAILED</span>
<span class="hljs-deletion">- 巡检任务会重试</span>
<span class="hljs-deletion">- 重试次数可控</span>

不会因为一个分片失败，整个任务重来
</code></pre>
<p>这个设计想通了之后，代码写起来特别顺。父子记录结构、CAS 乐观锁、回调接口，一天就写完了。</p>
<h2 data-id="heading-7">第五个想法：TraceId 的威力</h2>
<p>前面说了，排查问题的时候，调度器和执行器的日志是割裂的。这个问题怎么解决？</p>
<p>周四上午在写日志的时候，突然想到一个点：<strong>能不能让 TraceId 从调度器贯穿到执行器？</strong></p>
<p>TraceId 的设计很简单：</p>
<pre><code class="hljs language-diff" lang="diff">格式：yyyyMMddHHmmss-shortuuid-shardindex

示例：
<span class="hljs-deletion">- 父记录：20241221100000-a1b2c3d4</span>
<span class="hljs-deletion">- 分片 0：20241221100000-a1b2c3d4-0</span>
<span class="hljs-deletion">- 分片 1：20241221100000-a1b2c3d4-1</span>
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[调度器创建TraceId&lt;br/&gt;20241221100000-a1b2c3d4] --&gt; B[HTTP Header传递]
    B --&gt; C[执行器接收TraceId]
    C --&gt; D[MDC.put]
    D --&gt; E[业务日志自动带上TraceId]
    
    E --&gt; F[ELK收集]
    F --&gt; G[搜索TraceId&lt;br/&gt;看到完整链路]
</code></pre>
<p>实际效果：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 调度器日志</span>
2024-12-21 10:00:00.123 <span class="hljs-section">[traceId=20241221100000-a1b2c3d4]</span> 
触发任务执行，<span class="hljs-attr">jobName</span>=orderSync

2024-12-21 10:00:00.456 <span class="hljs-section">[traceId=20241221100000-a1b2c3d4-0]</span> 
调用执行器，<span class="hljs-attr">url</span>=http://order-service:<span class="hljs-number">8081</span>/internal/job/orderSync

<span class="hljs-comment"># 执行器日志</span>
2024-12-21 10:00:00.600 <span class="hljs-section">[traceId=20241221100000-a1b2c3d4-0]</span> 
接收到任务请求，<span class="hljs-attr">handler</span>=orderSync

2024-12-21 10:00:01.800 <span class="hljs-section">[traceId=20241221100000-a1b2c3d4-0]</span> 
查询订单数据，<span class="hljs-attr">count</span>=<span class="hljs-number">1523</span>

2024-12-21 10:00:05.000 <span class="hljs-section">[traceId=20241221100000-a1b2c3d4-0]</span> 
任务执行完成，<span class="hljs-attr">duration</span>=<span class="hljs-number">4300</span>ms
</code></pre>
<p>在 ELK 里搜 <code>traceId="20241221100000-a1b2c3d4*"</code>，调度器和执行器的日志全出来了，按时间排序，完整链路一目了然。</p>
<p>这个设计成本几乎为零（就是在 HTTP Header 里加个字段），但价值巨大。</p>
<p><strong>日志打通了，排查问题的效率至少提升 10 倍。</strong></p>
<h2 data-id="heading-8">延时队列：复用的艺术</h2>
<p>周五上午，正在写文档的时候，看到一篇博客讲延时队列的实现。突然想到：<strong>我们的架构可以很快融入延时队列功能。</strong></p>
<p>为什么？因为 JobFlow 已经有了所有需要的基础设施：</p>
<pre><code class="hljs language-markdown" lang="markdown">延时队列需要什么：
<span class="hljs-bullet">1.</span> 定时扫描机制 → 已经有了（周期任务扫描）
<span class="hljs-bullet">2.</span> 服务发现 → 已经有了（Nacos）
<span class="hljs-bullet">3.</span> HTTP 调用 → 已经有了（调用执行器）
<span class="hljs-bullet">4.</span> TraceId 追踪 → 已经有了（全链路日志）
<span class="hljs-bullet">5.</span> 数据库存储 → 已经有了（MySQL）

新增什么：
<span class="hljs-bullet">1.</span> 独立的 job<span class="hljs-emphasis">_delay_</span>task 表
<span class="hljs-bullet">2.</span> 一次性执行的逻辑
<span class="hljs-bullet">3.</span> JSON Payload 透传
<span class="hljs-bullet">4.</span> 指数退避重试
</code></pre>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 延时队列
        A[业务代码] --&gt; B[提交延时任务&lt;br/&gt;bizUuid + executeTime]
        B --&gt; C[(job_delay_task表)]
    end
    
    subgraph JobFlow基础设施
        D[定时扫描&lt;br/&gt;每5秒] --&gt; C
        C --&gt; E{到期?}
        E --&gt; |是| F[Nacos发现服务]
        F --&gt; G[HTTP调用执行器]
        G --&gt; H[TraceId追踪]
        H --&gt; I[执行器处理]
        I --&gt; J[回调更新状态]
    end
    
    J --&gt; K{成功?}
    K --&gt; |是| L[删除任务]
    K --&gt; |否| M[指数退避重试]
</code></pre>
<p>周五下午花了 3 个小时，把延时队列写完了。测试了一下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 业务代码</span>
delayTaskService.submit(DelayTask.builder()
    .bizUuid(<span class="hljs-string">"order_timeout_"</span> + orderId)
    .serviceName(<span class="hljs-string">"order-service"</span>)
    .handler(<span class="hljs-string">"orderTimeoutHandler"</span>)
    .executeTime(LocalDateTime.now().plusMinutes(<span class="hljs-number">30</span>))
    .payloadJson(JSON.toJSONString(Map.of(<span class="hljs-string">"orderId"</span>, orderId)))
    .build());

<span class="hljs-comment">// 30 分钟后</span>
<span class="hljs-comment">// 执行器自动收到调用</span>
<span class="hljs-meta">@JobHandler("orderTimeoutHandler")</span>
<span class="hljs-keyword">public</span> JobResult <span class="hljs-title function_">orderTimeout</span><span class="hljs-params">(JobContext context)</span> {
    Map&lt;String, Object&gt; payload = JSON.parseObject(
        context.getPayloadJson(), Map.class);
    <span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> (Long) payload.get(<span class="hljs-string">"orderId"</span>);
    
    <span class="hljs-comment">// 取消订单</span>
    orderService.cancel(orderId);
    
    <span class="hljs-keyword">return</span> JobResult.success();
}
</code></pre>
<p>完美。</p>
<p><strong>这就是复用的威力：基础设施搭好了，新功能几乎是自己长出来的。</strong></p>
<h2 data-id="heading-9">写代码的节奏</h2>
<p>回顾一下这两周的开发过程：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">第一周（思考为主）：
周末：想清楚核心设计（Nacos + Hash分区）
周一：写 Owner 判定 + 定时扫描
周二：写固定分片 + 回调驱动
周三：写 TraceId + HTTP 调用
周四：写巡检补偿
周五：测试 + 修 Bug

第二周（完善功能）：
周一：优化 <span class="hljs-built_in">CAS</span> 逻辑
周二：完善超时确认
周三：写低频任务漏调检测
周四：写文档
周五：延时队列（意外之喜）
</code></pre>
<p>代码量其实不大，核心功能 3000 行左右。但设计想清楚之后，代码写起来特别快。</p>
<p><strong>很多时候不是代码难写，而是没想清楚。想清楚了，代码几乎是一气呵成的。</strong></p>
<h2 data-id="heading-10">几个关键突破</h2>
<p>回过头看，这两周有几个关键的思维突破：</p>
<h3 data-id="heading-11">1. 调度器即业务</h3>
<p><strong>不要把调度器当成独立的平台，而是当成业务中台的一部分。</strong></p>
<p>这个突破带来的好处：</p>
<ul>
<li>复用 Nacos，零额外依赖</li>
<li>复用监控日志，零运维成本</li>
<li>业务团队自己维护，零沟通成本</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 传统思维
        A[调度平台&lt;br/&gt;独立部署] -.调用.-&gt; B[业务服务]
    end
    
    subgraph JobFlow思维
        C[调度器&lt;br/&gt;普通微服务]
        D[业务服务]
        E[消息中台]
        F[数据中台]
    end
    
    C --&gt; G[Nacos]
    D --&gt; G
    E --&gt; G
    F --&gt; G
</code></pre>
<h3 data-id="heading-12">2. 固定分片的简单</h3>
<p><strong>不要动态分片，固定分片数量，让回调驱动分配。</strong></p>
<p>这个突破带来的好处：</p>
<ul>
<li>不受实例数影响</li>
<li>自动负载均衡</li>
<li>状态可查可控</li>
<li>断点续传</li>
</ul>
<pre><code class="hljs language-diff" lang="diff">动态分片的复杂：
<span class="hljs-deletion">- 实例数变了，分片要重新计算</span>
<span class="hljs-deletion">- 计算逻辑复杂</span>
<span class="hljs-deletion">- 状态难以追踪</span>

固定分片的简单：
<span class="hljs-deletion">- 分片数固定</span>
<span class="hljs-deletion">- 回调驱动</span>
<span class="hljs-deletion">- 状态清晰</span>
</code></pre>
<h3 data-id="heading-13">3. 无锁的代价与补偿</h3>
<p><strong>不要追求完美的无锁，而是接受代价，用补偿解决。</strong></p>
<p>这个突破带来的好处：</p>
<ul>
<li>性能好（无锁）</li>
<li>可靠性高（补偿）</li>
<li>设计清晰（分层）</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[正常流程&lt;br/&gt;Hash分区&lt;br/&gt;99%情况] --&gt; C[任务执行]
    B[异常流程&lt;br/&gt;巡检补偿&lt;br/&gt;1%情况] --&gt; C
    
    style A fill:#90EE90
    style B fill:#FFB6C1
</code></pre>
<h3 data-id="heading-14">4. 复用的威力</h3>
<p><strong>不要重复造轮子，能复用就复用。</strong></p>
<p>这个突破带来的好处：</p>
<ul>
<li>Nacos 服务发现 → 复用</li>
<li>HTTP 调用 → 复用</li>
<li>TraceId 追踪 → 复用</li>
<li>监控日志 → 复用</li>
</ul>
<p>延时队列为什么能 3 小时写完？因为 90% 的代码都是复用的。</p>
<h2 data-id="heading-15">一些启示</h2>
<h3 data-id="heading-16">启示一：想清楚比写代码重要</h3>
<p>这两周，真正写代码的时间可能只有 30%，70% 的时间在想设计。</p>
<p>但正是这 70% 的思考，让 30% 的编码变得简单。</p>
<p><strong>架构设计不是拍脑袋，是一个持续思考、推翻重来、逐步清晰的过程。</strong></p>
<h3 data-id="heading-17">启示二：简单的设计更可靠</h3>
<p>最开始想过很多复杂的方案：</p>
<ul>
<li>用 Raft 协议选主</li>
<li>用 Redisson 分布式锁</li>
<li>用 ZooKeeper 协调</li>
</ul>
<p>后来发现，这些都不需要：</p>
<ul>
<li>选主？最小节点就是 Leader</li>
<li>分布式锁？Hash 分区 + 数据库兜底</li>
<li>协调？Nacos 服务发现就够了</li>
</ul>
<p><strong>复杂的方案不一定更好，简单的方案往往更可靠。</strong></p>
<h3 data-id="heading-18">启示三：分布式的本质是权衡</h3>
<p>无锁设计很快，但可能漏调 → 用巡检补偿
固定分片很简单，但可能不均匀 → 用回调驱动负载均衡
数据库兜底很可靠，但有性能损耗 → 99% 的场景无损耗</p>
<p><strong>没有完美的方案，只有合适的权衡。</strong></p>
<pre><code class="hljs language-diff" lang="diff">分布式系统的权衡：
<span class="hljs-deletion">- 性能 vs 一致性</span>
<span class="hljs-deletion">- 简单 vs 完美</span>
<span class="hljs-deletion">- 效率 vs 可靠</span>

关键是：知道自己在权衡什么，为什么这么权衡
</code></pre>
<h3 data-id="heading-19">启示四：复用是最大的创新</h3>
<p>延时队列不是新功能，但复用 JobFlow 的基础设施，就能很快实现。</p>
<p><strong>创新不一定是发明新东西，把已有的东西组合好，也是创新。</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[基础设施] --&gt; B[周期任务]
    A --&gt; C[延时队列]
    A --&gt; D[分片调度]
    A --&gt; E[巡检补偿]
    
    A --&gt; |Nacos| F[服务发现]
    A --&gt; |HTTP| G[远程调用]
    A --&gt; |TraceId| H[链路追踪]
    A --&gt; |MySQL| I[状态存储]
</code></pre>
<h3 data-id="heading-20">启示五：分布式就是这么回事</h3>
<p>回到开头那个问题：<strong>分布式到底在搞什么？</strong></p>
<p>做完 JobFlow 之后，我的答案是：</p>
<pre><code class="hljs language-markdown" lang="markdown">分布式就是在解决这些问题：
<span class="hljs-bullet">1.</span> 数据怎么复制（日志复制）
<span class="hljs-bullet">2.</span> 故障怎么切换（主从切换、Hash分区）
<span class="hljs-bullet">3.</span> 状态怎么同步（Nacos、数据库）
<span class="hljs-bullet">4.</span> 任务怎么分配（分片、负载均衡）
<span class="hljs-bullet">5.</span> 异常怎么处理（补偿、重试）
</code></pre>
<p>xxl-job 也好，RocketMQ 也好，Redis Cluster 也好，本质上都是在解决这些问题。</p>
<p><strong>想通了这些，再去看任何分布式系统，都能看到相同的影子。</strong></p>
<h2 data-id="heading-21">写在最后</h2>
<p>这两周开发 JobFlow 的经历，对我来说是一次思维突破。</p>
<p>不是说我做出了多么厉害的东西，而是想清楚了一些以前模糊的点：</p>
<ul>
<li>为什么要这么设计</li>
<li>设计的边界在哪里</li>
<li>什么时候该权衡什么</li>
</ul>
<p>这些东西，书上很难学到。它来自于实践，来自于思考，来自于一次次的推翻重来。</p>
<p>JobFlow 现在还很简陋：</p>
<ul>
<li>没有 Web 管理后台</li>
<li>没有完善的监控面板</li>
<li>没有丰富的路由策略</li>
</ul>
<p>但核心的设计理念是清晰的：</p>
<ul>
<li>复用优于重造</li>
<li>轻量级优先</li>
<li>高性价比容错</li>
</ul>
<p>后面会继续完善功能，但这个核心不会变。</p>
<h3 data-id="heading-22">如果重来一次</h3>
<p>写完之后，回过头看，有些地方我会换个做法：</p>
<p><strong>会保留的设计：</strong></p>
<ul>
<li>Hash 分区 + Owner 判定：这个设计经过验证，非常稳定</li>
<li>固定分片 + 回调驱动：比动态分片简单太多</li>
<li>TraceId 全链路追踪：成本低，价值大</li>
</ul>
<p><strong>会调整的设计：</strong></p>
<ul>
<li>巡检补偿的周期：3 分钟可能太长，应该做成可配置的</li>
<li>数据库表结构：父子记录有些字段是冗余的，可以优化</li>
<li>超时确认逻辑：现在的"反向询问"实现有点重，可以简化</li>
</ul>
<p><strong>写早了的代码：</strong></p>
<ul>
<li>低频任务漏调检测：这个功能用的人很少，应该后面再加</li>
<li>分片策略抽象：现在只有 MOD_HASH 一种，抽象层有点过度设计</li>
</ul>
<p><strong>后悔没做的：</strong></p>
<ul>
<li>单元测试：开发太快，测试覆盖不够，后面补测试很痛苦</li>
<li>配置校验：很多配置没做合法性检查，上线后才发现问题</li>
<li>监控指标：应该一开始就把 Prometheus 指标设计好</li>
</ul>
<p>这些反思，会在后续的迭代中慢慢调整。</p>
<p><strong>最重要的收获：</strong></p>
<p>分布式系统的设计，本质上是在做权衡：</p>
<ul>
<li>我接受什么代价</li>
<li>我换取什么好处</li>
<li>我用什么兜底</li>
</ul>
<p>想清楚这三点，代码自然就清晰了。</p>
<hr/>
<p><strong>最后想问问大家：</strong></p>
<p>你在做架构设计的时候，有没有类似的"突然想通"的时刻？</p>
<p>是什么让你想通的？一个具体的场景？一次失败的教训？还是某个偶然的灵感？</p>
<p>欢迎评论区聊聊。</p>
<p>架构这东西，很多时候不是看书看出来的，是踩坑踩出来的，是想出来的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[静态内容页该用HTML还是Next.js展示更好]]></title>    <link>https://juejin.cn/post/7585789195869782052</link>    <guid>https://juejin.cn/post/7585789195869782052</guid>    <pubDate>2025-12-22T02:33:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585789195869782052" data-draft-id="7586481379589914643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="静态内容页该用HTML还是Next.js展示更好"/> <meta itemprop="keywords" content="Next.js,HTML,前端"/> <meta itemprop="datePublished" content="2025-12-22T02:33:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            静态内容页该用HTML还是Next.js展示更好
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:33:25.000Z" title="Mon Dec 22 2025 02:33:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧩 一、底层原理：两者到底在“生成什么”</h2>























<table><thead><tr><th align="left">技术</th><th align="left">核心机制</th><th align="left">输出形态</th><th align="left">架构思想</th></tr></thead><tbody><tr><td align="left"><strong>HTML</strong></td><td align="left">静态文件，浏览器直接渲染</td><td align="left"><code>.html</code> 文件 + 资源（CSS/JS）</td><td align="left">“写好了，就摆在那里”</td></tr><tr><td align="left"><strong>Next.js</strong></td><td align="left">React框架 + 渲染引擎（SSR/SSG/ISR）</td><td align="left">动态或预生成的HTML</td><td align="left">“根据数据和逻辑生成页面”</td></tr></tbody></table>
<h3 data-id="heading-1">💡理解重点：</h3>
<ul>
<li>HTML → 就像一本印好的书：内容确定、维护简单、永远高速。</li>
<li>Next.js → 像一台印刷机：可以随时重印、加内容、换封面。</li>
</ul>
<p>👉 若你确定内容永远不变，那HTML就够了。<br/>
👉 若内容随时间或数据变化，Next.js更合适。</p>
<hr/>
<h2 data-id="heading-2">⚙️ 二、从性能角度看：静态=快？不总是！</h2>
<p>现代Web性能已不只是“有多快”，而是“<strong>在不同情境下保持一致的快</strong>”。</p>



































<table><thead><tr><th align="left">场景</th><th align="left">HTML</th><th align="left">Next.js (SSG)</th><th align="left">Next.js (SSR)</th></tr></thead><tbody><tr><td align="left"><strong>首屏加载</strong></td><td align="left">🚀 极快</td><td align="left">🚀 几乎一样快</td><td align="left">🐢 稍慢（服务器渲染）</td></tr><tr><td align="left"><strong>CDN缓存分发</strong></td><td align="left">✅ 易实现</td><td align="left">✅ 可静态导出</td><td align="left">⚠️ 动态内容较难缓存</td></tr><tr><td align="left"><strong>动态更新</strong></td><td align="left">❌ 需要重新部署</td><td align="left">✅ SSG + revalidate</td><td align="left">✅ SSR即时更新</td></tr><tr><td align="left"><strong>维护成本</strong></td><td align="left">🪶 极低</td><td align="left">🧩 中等（依赖框架）</td><td align="left">🧩 较高（需要服务端）</td></tr></tbody></table>
<blockquote>
<p>如果你要维护一个<strong>纯内容型博客</strong>、<strong>文档中心</strong>、或<strong>品牌展示页</strong>：</p>
<ul>
<li>HTML = “轻量+稳定+没人改”。</li>
<li>Next.js（SSG 模式） = “灵活+自动化生成+易接入 CI/CD”。</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-3">🧠 三、从工程生态和自动化角度讲</h2>
<p>工程师最怕什么？——<strong>重复劳动</strong>。</p>
<p>纯HTML：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- about.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>关于我们<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>我们是一家热爱代码与文化的团队。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>©2025 Company Name<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
</code></pre>
<p>改一次页脚？所有文件都得动手改 👋。</p>
<p>Next.js 可以：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// components/Layout.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Layout</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      {children}
      <span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>©2025 Company Name<span class="hljs-tag">&lt;/<span class="hljs-name">footer</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p>一改全站同步 ✨<br/>
这就叫 <strong>“组件化思维”</strong> ：文化内容不该一次性雕刻，而应该能灵活演化。</p>
<hr/>
<h2 data-id="heading-4">🌏 四、从SEO与国际化角度</h2>
<p>如果你的静态内容需要：</p>
<ul>
<li>多语言版本（国际网站 🌍）；</li>
<li>动态Meta（自动生成标题、描述、OG图等）；</li>
<li>AIGC内容自动更新；</li>
</ul>
<p>👉 那Next.js压倒性更优秀。</p>
<p><strong>为什么？</strong><br/>
因为Next支持：</p>
<ul>
<li>内置 <strong>国际化路由（i18n）</strong> ；</li>
<li>动态<strong>Meta生成</strong>；</li>
<li><strong>ISR（增量静态再生成）</strong> ，可自动周期性刷新内容。</li>
</ul>
<p>HTML虽然也能做这些，但得靠“人肉更新”或“脚本拼接”，成本高、容易忘。</p>
<hr/>
<h2 data-id="heading-5">🎭 五、文化与表达层面：哪种更“有生命力”</h2>
<p>我们常说：</p>
<blockquote>
<p>“HTML 是碑文，Next 是生态。”</p>
</blockquote>
<p>当WebAIGC时代到来——网站上的内容不再静止，而是<strong>文化对话的持续生成体</strong>。</p>
<ul>
<li>HTML更像<strong>一幅挂在墙上的油画</strong>；</li>
<li>Next更像<strong>一片能生长的AI花园</strong>。 🌸</li>
</ul>
<p>如果你要做的是：</p>
<ul>
<li>数字展馆</li>
<li>互动式文化档案</li>
<li>AIGC内容展示<br/>
那Next.js是未来型选择，因为它能：</li>
<li>动态注入AI生成内容；</li>
<li>保留语义化；</li>
<li>实现Web动画交互；</li>
<li>与后端知识库联动（如LangChain、RAG架构）。</li>
</ul>
<hr/>
<h2 data-id="heading-6">🧭 六、最终建议表（决策参考）</h2>



































<table><thead><tr><th align="left">目标</th><th align="left">推荐方案</th><th align="left">理由</th></tr></thead><tbody><tr><td align="left"><strong>一次性公司官网（长年不改）</strong></td><td align="left">HTML</td><td align="left">简洁、快速、成本低</td></tr><tr><td align="left"><strong>学术或品牌介绍+多语种</strong></td><td align="left">Next.js（SSG + i18n）</td><td align="left">静态+多文化适配</td></tr><tr><td align="left"><strong>文化档案、教育平台</strong></td><td align="left">Next.js（SSR/ISR）</td><td align="left">支持动态内容更新</td></tr><tr><td align="left"><strong>AI生成内容展示（WebAIGC）</strong></td><td align="left">Next.js</td><td align="left">可读写AI接口、可交互</td></tr><tr><td align="left"><strong>极简Landing Page</strong></td><td align="left">HTML</td><td align="left">几KB即可部署</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">🔮 七、我的架构建议</h2>
<p>结合底层理解与文化项目的可持续性，我最推荐的组合是：</p>
<blockquote>
<p>“Next.js + Markdown内容仓库 + SSG导出 + CDN部署”</p>
</blockquote>
<p>也就是：</p>
<ul>
<li>编辑者写<code>Markdown</code>（文化内容）；</li>
<li>Next自动构建静态页；</li>
<li>CDN全球分发；</li>
<li>某些版块还能自动重生（ISR）。</li>
</ul>
<p>这就是所谓的“<strong>可演化的静态内容架构（Evolvable Static Web)</strong> ”。<br/>
既兼容文化传承的稳定性，也拥抱未来变化的AI逻辑。</p>
<hr/>
<h2 data-id="heading-8">🎯 最后一句话总结</h2>
<blockquote>
<p>💬 “静态HTML是记忆的容器；Next.js是文化的引擎。”</p>
</blockquote>
<p>——如果你只需要记住一件事：<br/>
👉 <strong>不变的内容用HTML，活着的文化用Next。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零开始：MCP数据库助手（三）- 多数据库支持]]></title>    <link>https://juejin.cn/post/7585839411122978862</link>    <guid>https://juejin.cn/post/7585839411122978862</guid>    <pubDate>2025-12-22T02:26:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585839411122978862" data-draft-id="7585866811717124123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零开始：MCP数据库助手（三）- 多数据库支持"/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2025-12-22T02:26:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="红鼻子时代"/> <meta itemprop="url" content="https://juejin.cn/user/1743149753974384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零开始：MCP数据库助手（三）- 多数据库支持
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743149753974384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    红鼻子时代
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:26:25.000Z" title="Mon Dec 22 2025 02:26:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>代码已上传github上，这是<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbiao994%2Fmcp-datatools" target="_blank" title="https://github.com/biao994/mcp-datatools" ref="nofollow noopener noreferrer">github仓库地址</a>，如果项目对你有帮助，欢迎点个Star鼓励！</p>
<h2 data-id="heading-0">为什么要支持多数据库？</h2>
<p>前两章我们只支持SQLite，但现实中的企业环境需要：</p>
<ul>
<li><strong>PostgreSQL</strong> - 企业级应用的首选，功能强大</li>
<li><strong>MySQL</strong> - Web应用最流行的数据库</li>
<li><strong>配置管理</strong> - 一套代码支持多种环境</li>
</ul>
<p>今天我们要让MCP DataTools从"玩具"变成"工具"！</p>
<h2 data-id="heading-1">第一步：项目结构升级</h2>
<p>这次的项目结构更加完善：</p>
<pre><code class="hljs language-bash" lang="bash">mcp-datatools/
├── pyproject.toml              <span class="hljs-comment"># 升级依赖配置</span>
├── docker-compose.db.yml       <span class="hljs-comment"># 数据库环境（可选）</span>
├── config/
│   ├── __init__.py
│   └── settings.py             <span class="hljs-comment"># 应用配置管理</span>
├── src/
│   └── mcp_datatools/
│       ├── __init__.py
│       ├── server.py           <span class="hljs-comment"># 升级的MCP服务器</span>
│       ├── database.py         <span class="hljs-comment"># 多数据库管理器</span>
│       └── utils.py            <span class="hljs-comment"># 公共工具函数</span>
├── tests/
│   └── test_multi_database.py  <span class="hljs-comment"># 多数据库测试</span>
└── data/
    ├── test.db                <span class="hljs-comment"># SQLite测试数据</span>
    └── init_scripts/          <span class="hljs-comment"># 数据库初始化脚本</span>
        ├── init_sqlite_db.py   <span class="hljs-comment"># SQLite初始化脚本</span>
        ├── init_postgresql_db.py <span class="hljs-comment"># PostgreSQL初始化脚本</span>
        └── mysql.sql          <span class="hljs-comment"># MySQL初始化脚本</span>
</code></pre>
<h2 data-id="heading-2">第二步：依赖升级</h2>
<p>首先升级<code>pyproject.toml</code>，添加多数据库支持：</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-comment"># MCP DataTools 项目配置文件</span>
<span class="hljs-comment"># 这是一个支持多数据库连接的MCP服务器项目</span>

<span class="hljs-section">[project]</span>
<span class="hljs-comment"># 项目基本信息</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"mcp-datatools"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.3.0"</span>
<span class="hljs-attr">description</span> = <span class="hljs-string">"A MCP server that connects to multiple databases"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.10"</span>  <span class="hljs-comment"># 最低Python版本要求</span>

<span class="hljs-comment"># 核心依赖包</span>
<span class="hljs-attr">dependencies</span> = [
    <span class="hljs-string">"mcp&gt;=1.0.0"</span>,                    <span class="hljs-comment"># MCP协议核心库</span>
    <span class="hljs-string">"sqlalchemy&gt;=2.0.0"</span>,             <span class="hljs-comment"># SQLAlchemy ORM，支持多种数据库</span>
    <span class="hljs-string">"psycopg2-binary&gt;=2.9.0"</span>,        <span class="hljs-comment"># PostgreSQL数据库驱动</span>
    <span class="hljs-string">"pymysql&gt;=1.1.0"</span>,                <span class="hljs-comment"># MySQL数据库驱动</span>
    <span class="hljs-string">"cryptography&gt;=41.0.0"</span>,          <span class="hljs-comment"># 加密支持，用于安全连接</span>
    <span class="hljs-string">"python-dotenv&gt;=1.0.0"</span>,          <span class="hljs-comment"># 环境变量管理</span>
    <span class="hljs-string">"pydantic&gt;=2.0.0"</span>,               <span class="hljs-comment"># 数据验证和序列化</span>
    <span class="hljs-string">"pydantic-settings&gt;=2.10.1"</span>,     <span class="hljs-comment"># 配置管理扩展</span>
]

<span class="hljs-comment"># 可选依赖包（开发环境）</span>
<span class="hljs-section">[project.optional-dependencies]</span>
<span class="hljs-attr">dev</span> = [
    <span class="hljs-string">"pytest&gt;=7.0.0"</span>,                 <span class="hljs-comment"># 测试框架</span>
    <span class="hljs-string">"pytest-asyncio&gt;=0.21.0"</span>,        <span class="hljs-comment"># 异步测试支持</span>
    <span class="hljs-string">"black&gt;=23.0.0"</span>,                 <span class="hljs-comment"># 代码格式化工具</span>
    <span class="hljs-string">"isort&gt;=5.12.0"</span>,                 <span class="hljs-comment"># 导入排序工具</span>
]

<span class="hljs-comment"># 构建系统配置</span>
<span class="hljs-section">[build-system]</span>
<span class="hljs-attr">requires</span> = [<span class="hljs-string">"hatchling"</span>]              <span class="hljs-comment"># 使用hatchling作为构建后端</span>
<span class="hljs-attr">build-backend</span> = <span class="hljs-string">"hatchling.build"</span>

<span class="hljs-comment"># 打包配置</span>
<span class="hljs-section">[tool.hatch.build.targets.wheel]</span>
<span class="hljs-attr">packages</span> = [<span class="hljs-string">"src/mcp_datatools"</span>]      <span class="hljs-comment"># 指定要打包的源码目录</span>

<span class="hljs-comment"># 命令行脚本配置</span>
<span class="hljs-section">[project.scripts]</span>
<span class="hljs-attr">mcp-datatools</span> = <span class="hljs-string">"mcp_datatools.server:main"</span>  <span class="hljs-comment"># 定义命令行入口点</span>

<span class="hljs-comment"># 测试配置</span>
<span class="hljs-section">[tool.pytest.ini_options]</span>
<span class="hljs-attr">pythonpath</span> = [<span class="hljs-string">"src"</span>]                  <span class="hljs-comment"># 添加src目录到Python路径</span>

<span class="hljs-comment"># 代码格式化配置</span>
<span class="hljs-section">[tool.black]</span>
<span class="hljs-attr">line-length</span> = <span class="hljs-number">88</span>                      <span class="hljs-comment"># 每行最大字符数</span>
<span class="hljs-attr">target-version</span> = [<span class="hljs-string">'py310'</span>]            <span class="hljs-comment"># 目标Python版本</span>

<span class="hljs-comment"># 导入排序配置</span>
<span class="hljs-section">[tool.isort]</span>
<span class="hljs-attr">profile</span> = <span class="hljs-string">"black"</span>                     <span class="hljs-comment"># 使用black兼容的配置</span>
<span class="hljs-attr">multi_line_output</span> = <span class="hljs-number">3</span>                 <span class="hljs-comment"># 多行导入的格式</span>
</code></pre>
<h2 data-id="heading-3">第三步：配置管理系统</h2>
<p>创建统一的配置管理系统：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
config/settings.py - 应用配置管理
"""</span>
<span class="hljs-keyword">from</span> pydantic_settings <span class="hljs-keyword">import</span> BaseSettings
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> Field, ConfigDict
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConfig</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    <span class="hljs-string">"""数据库配置"""</span>
    model_config = ConfigDict(env_prefix=<span class="hljs-string">"DB_"</span>)
    
    pool_size : <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">20</span>, description=<span class="hljs-string">"连接池大小"</span>)
    max_overflow: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">10</span>, description=<span class="hljs-string">"连接池最大溢出数"</span>)
    pool_timeout: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">30</span>, description=<span class="hljs-string">"连接池超时时间"</span>)
    pool_recycle: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">3600</span>, description=<span class="hljs-string">"连接池回收时间"</span>)
    echo: <span class="hljs-built_in">bool</span> = Field(default=<span class="hljs-literal">False</span>, description=<span class="hljs-string">"是否打印SQL语句"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span>(<span class="hljs-title class_ inherited__">BaseSettings</span>):
    <span class="hljs-string">"""应用配置"""</span>
    model_config = ConfigDict(env_prefix=<span class="hljs-string">"APP_"</span>)
    
    name: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">"MCP DataTools"</span>, description=<span class="hljs-string">"应用名称"</span>)
    version: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">"1.0.0"</span>, description=<span class="hljs-string">"应用版本"</span>)
    log_level: <span class="hljs-built_in">str</span> = Field(default=<span class="hljs-string">"INFO"</span>, description=<span class="hljs-string">"日志级别"</span>)
    max_query_results: <span class="hljs-built_in">int</span> = Field(default=<span class="hljs-number">1000</span>, description=<span class="hljs-string">"结果最大查询行数"</span>)

    <span class="hljs-comment"># 数据库配置</span>
    database: DatabaseConfig = Field(default_factory=DatabaseConfig, description=<span class="hljs-string">"数据库配置"</span>)

<span class="hljs-comment"># 全局配置实例</span>
config = AppConfig()
</code></pre>
<h2 data-id="heading-4">第四步：多数据库连接管理</h2>
<p>升级数据库管理器，支持多种数据库：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
src/mcp_datatools/database.py - 多数据库管理器
"""</span>

<span class="hljs-keyword">from</span> .utils <span class="hljs-keyword">import</span> setup_project_path
setup_project_path()

<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> contextmanager
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine, inspect, text
<span class="hljs-keyword">from</span> sqlalchemy.exc <span class="hljs-keyword">import</span> SQLAlchemyError
<span class="hljs-keyword">from</span> sqlalchemy.pool <span class="hljs-keyword">import</span> QueuePool
<span class="hljs-keyword">from</span> mcp.server.fastmcp.utilities.logging <span class="hljs-keyword">import</span> get_logger

<span class="hljs-keyword">from</span> config.settings <span class="hljs-keyword">import</span> config
<span class="hljs-keyword">from</span> .utils <span class="hljs-keyword">import</span> mask_password

logger = get_logger(__name__)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiDatabaseManager</span>:
    <span class="hljs-string">"""多数据库管理器"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, database_url: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""初始化数据库管理器（必须显式提供 database_url）"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> database_url <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(database_url, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> database_url.strip():
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"必须显式提供 database_url"</span>)
        self.database_url = database_url.strip()
        self.engine = <span class="hljs-literal">None</span>
        self.db_type = self._detect_database_type()
        self._connect()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_detect_database_type</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""检测数据库类型"""</span>
        url = self.database_url.lower()
        <span class="hljs-keyword">if</span> url.startswith(<span class="hljs-string">"postgresql://"</span>) <span class="hljs-keyword">or</span> url.startswith(<span class="hljs-string">"postgres://"</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-string">"postgresql"</span>
        <span class="hljs-keyword">elif</span> url.startswith(<span class="hljs-string">"mysql://"</span>) <span class="hljs-keyword">or</span> url.startswith(<span class="hljs-string">"mysql+"</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-string">"mysql"</span>
        <span class="hljs-keyword">elif</span> url.startswith(<span class="hljs-string">"sqlite://"</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-string">"sqlite"</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"unknown"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_connect</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""连接数据库"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 根据数据库类型调整配置</span>
            <span class="hljs-keyword">if</span> self.db_type == <span class="hljs-string">"sqlite"</span>:
                <span class="hljs-comment"># SQLite使用最简配置，避免复杂的连接池</span>
                self.engine = create_engine(
                    self.database_url,
                    echo=config.database.echo,
                    connect_args={<span class="hljs-string">"check_same_thread"</span>: <span class="hljs-literal">False</span>}  <span class="hljs-comment"># 允许多线程</span>
                )
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># PostgreSQL和MySQL使用完整连接池配置</span>
                self.engine = create_engine(
                    self.database_url,
                    poolclass=QueuePool,  <span class="hljs-comment"># 明确指定队列式连接池</span>
                    pool_size=config.database.pool_size,
                    max_overflow=config.database.max_overflow,
                    pool_timeout=config.database.pool_timeout,
                    pool_recycle=config.database.pool_recycle,
                    echo=config.database.echo
                )
                        
            logger.info(<span class="hljs-string">f"成功连接到 <span class="hljs-subst">{self.db_type}</span> 数据库: <span class="hljs-subst">{mask_password(self.database_url)}</span>"</span>)
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"连接数据库时出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            <span class="hljs-keyword">raise</span>
    
<span class="hljs-meta">    @contextmanager</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_connection</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""获取数据库连接的上下文管理器"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.engine:
            <span class="hljs-keyword">raise</span> RuntimeError(<span class="hljs-string">"数据库未连接"</span>)
        
        conn = self.engine.connect()
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">yield</span> conn
        <span class="hljs-keyword">finally</span>:
            conn.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_database_info</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">"""获取数据库信息"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                info = {
                    <span class="hljs-string">"type"</span>: self.db_type,
                    <span class="hljs-string">"url"</span>: mask_password(self.database_url),
                    <span class="hljs-string">"tables_count"</span>: <span class="hljs-built_in">len</span>(self.get_table_names()),
                }
                
                <span class="hljs-comment"># 只为非SQLite数据库显示连接池信息</span>
                <span class="hljs-keyword">if</span> self.db_type != <span class="hljs-string">"sqlite"</span>:
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self.engine, <span class="hljs-string">'pool'</span>):
                        <span class="hljs-keyword">try</span>:
                            pool_info = {}
                            <span class="hljs-comment"># 统一尝试获取各种连接池信息</span>
                            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self.engine.pool, <span class="hljs-string">'size'</span>):
                                pool_info[<span class="hljs-string">"size"</span>] = self.engine.pool.size()
                            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self.engine.pool, <span class="hljs-string">'checkedout'</span>):
                                pool_info[<span class="hljs-string">"checked_out"</span>] = self.engine.pool.checkedout()
                            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self.engine.pool, <span class="hljs-string">'overflow'</span>):
                                pool_info[<span class="hljs-string">"overflow"</span>] = self.engine.pool.overflow()
                            <span class="hljs-comment"># 对于checked_in，不同的连接池实现可能不同</span>
                            <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(self.engine.pool, <span class="hljs-string">'checked_in'</span>):
                                pool_info[<span class="hljs-string">"checked_in"</span>] = self.engine.pool.checked_in()
                            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">hasattr</span>(self.engine.pool, <span class="hljs-string">'checkedin'</span>):
                                pool_info[<span class="hljs-string">"checked_in"</span>] = self.engine.pool.checkedin()
                            <span class="hljs-keyword">else</span>:
                                <span class="hljs-comment"># 如果都没有，计算可用连接数</span>
                                <span class="hljs-keyword">if</span> <span class="hljs-string">"size"</span> <span class="hljs-keyword">in</span> pool_info <span class="hljs-keyword">and</span> <span class="hljs-string">"checked_out"</span> <span class="hljs-keyword">in</span> pool_info:
                                    pool_info[<span class="hljs-string">"checked_in"</span>] = pool_info[<span class="hljs-string">"size"</span>] - pool_info[<span class="hljs-string">"checked_out"</span>]
                            
                            info[<span class="hljs-string">"connection_pool"</span>] = pool_info <span class="hljs-keyword">if</span> pool_info <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
                        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> pool_error:
                            logger.warning(<span class="hljs-string">f"获取连接池信息失败: <span class="hljs-subst">{pool_error}</span>"</span>)
                            info[<span class="hljs-string">"connection_pool"</span>] = <span class="hljs-literal">None</span>
                    <span class="hljs-keyword">else</span>:
                        info[<span class="hljs-string">"connection_pool"</span>] = <span class="hljs-literal">None</span>
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># SQLite 不显示连接池信息</span>
                    info[<span class="hljs-string">"connection_pool"</span>] = <span class="hljs-literal">None</span>
                
                <span class="hljs-keyword">return</span> info
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"获取数据库信息失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> {<span class="hljs-string">"type"</span>: self.db_type, <span class="hljs-string">"error"</span>: <span class="hljs-built_in">str</span>(e)}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_table_names</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""获取数据库中的所有表名"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                inspector = inspect(conn)
                table_names = inspector.get_table_names()
                <span class="hljs-keyword">return</span> table_names
        <span class="hljs-keyword">except</span> SQLAlchemyError <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"获取表名失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_connection</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""测试数据库连接"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:

                result = conn.execute(text(<span class="hljs-string">"SELECT 1"</span>)).scalar()
                <span class="hljs-keyword">return</span> result == <span class="hljs-number">1</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"测试数据库连接时出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_table_names</span>(<span class="hljs-params">self, keyword: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
        <span class="hljs-string">"""根据关键词搜索相关表名"""</span>
        <span class="hljs-keyword">try</span>:
            all_tables = self.get_table_names()
            matching_tables = [
                table <span class="hljs-keyword">for</span> table <span class="hljs-keyword">in</span> all_tables 
                <span class="hljs-keyword">if</span> keyword.lower() <span class="hljs-keyword">in</span> table.lower()
            ]
            <span class="hljs-keyword">return</span> matching_tables
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"搜索表名失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_table_schema</span>(<span class="hljs-params">self, table_name: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]:
        <span class="hljs-string">"""获取指定表的详细结构信息"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                inspector = inspect(conn)
                
                <span class="hljs-comment"># 验证表是否存在</span>
                <span class="hljs-keyword">if</span> table_name <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> inspector.get_table_names():
                    <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"表 '<span class="hljs-subst">{table_name}</span>' 不存在"</span>)
                
                <span class="hljs-comment"># 获取列信息</span>
                columns = inspector.get_columns(table_name)
                
                <span class="hljs-comment"># 获取主键信息</span>
                pk_constraint = inspector.get_pk_constraint(table_name)
                primary_keys = <span class="hljs-built_in">set</span>(pk_constraint[<span class="hljs-string">"constrained_columns"</span>])
                
                <span class="hljs-comment"># 获取索引信息</span>
                indexes = inspector.get_indexes(table_name)
                
                <span class="hljs-comment"># 获取外键信息</span>
                foreign_keys = inspector.get_foreign_keys(table_name)
                
                <span class="hljs-comment"># 格式化列信息</span>
                formatted_columns = []
                <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> columns:
                    col_info = {
                        <span class="hljs-string">"name"</span>: col[<span class="hljs-string">"name"</span>],
                        <span class="hljs-string">"type"</span>: <span class="hljs-built_in">str</span>(col[<span class="hljs-string">"type"</span>]),
                        <span class="hljs-string">"nullable"</span>: col[<span class="hljs-string">"nullable"</span>],
                        <span class="hljs-string">"default"</span>: col.get(<span class="hljs-string">"default"</span>),
                        <span class="hljs-string">"is_primary_key"</span>: col[<span class="hljs-string">"name"</span>] <span class="hljs-keyword">in</span> primary_keys
                    }
                    formatted_columns.append(col_info)
                
                schema_info = {
                    <span class="hljs-string">"table_name"</span>: table_name,
                    <span class="hljs-string">"columns"</span>: formatted_columns,
                    <span class="hljs-string">"primary_keys"</span>: <span class="hljs-built_in">list</span>(primary_keys),
                    <span class="hljs-string">"indexes"</span>: indexes,
                    <span class="hljs-string">"foreign_keys"</span>: foreign_keys,
                    <span class="hljs-string">"column_count"</span>: <span class="hljs-built_in">len</span>(columns)
                }
                
                <span class="hljs-keyword">return</span> schema_info
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"获取表结构信息失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_validate_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""验证查询安全性"""</span>
        query_upper = query.upper().strip()
        
        <span class="hljs-comment"># 检查危险的SQL操作</span>
        dangerous_keywords = [
            <span class="hljs-string">"DROP"</span>, <span class="hljs-string">"DELETE"</span>, <span class="hljs-string">"UPDATE"</span>, <span class="hljs-string">"INSERT"</span>, <span class="hljs-string">"ALTER"</span>, <span class="hljs-string">"CREATE"</span>, <span class="hljs-string">"TRUNCATE"</span>
        ]
        
        <span class="hljs-keyword">for</span> keyword <span class="hljs-keyword">in</span> dangerous_keywords:
            <span class="hljs-keyword">if</span> keyword <span class="hljs-keyword">in</span> query_upper:
                <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"查询包含危险操作: <span class="hljs-subst">{keyword}</span>"</span>)
        
        <span class="hljs-comment"># 检查是否是SELECT查询</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> query_upper.startswith(<span class="hljs-string">"SELECT"</span>):
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"只允许执行SELECT查询"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_add_limit_to_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, limit: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""为查询添加LIMIT子句"""</span>
        query_upper = query.upper()
        
        <span class="hljs-comment"># 如果已经有LIMIT，不再添加</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">"LIMIT"</span> <span class="hljs-keyword">in</span> query_upper:
            <span class="hljs-keyword">return</span> query
        
        <span class="hljs-comment"># 添加LIMIT子句</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{query.rstrip(<span class="hljs-string">';'</span>)}</span> LIMIT <span class="hljs-subst">{limit}</span>"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_query</span>(<span class="hljs-params">self, query: <span class="hljs-built_in">str</span>, params: <span class="hljs-built_in">dict</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
        <span class="hljs-string">"""安全执行SQL查询"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 验证查询安全性</span>
            self._validate_query(query)
            
            <span class="hljs-comment"># 添加默认限制</span>
            limited_query = self._add_limit_to_query(query, config.max_query_results)
            
            <span class="hljs-keyword">with</span> self.get_connection() <span class="hljs-keyword">as</span> conn:
                <span class="hljs-keyword">if</span> params:
                    <span class="hljs-comment"># 使用参数化查询</span>
                    result = conn.execute(text(limited_query), params)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-comment"># 直接执行查询</span>
                    result = conn.execute(text(limited_query))
                
                <span class="hljs-comment"># 获取列名</span>
                columns = result.keys()
                
                <span class="hljs-comment"># 转换为字典列表</span>
                rows = []
                <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> result:
                    row_dict = <span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>(columns, row))
                    rows.append(row_dict)
                
                <span class="hljs-keyword">return</span> rows
                
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"执行查询失败: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">raise</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">close</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""关闭数据库连接"""</span>
        <span class="hljs-keyword">if</span> self.engine:
            self.engine.dispose()
            logger.info(<span class="hljs-string">"数据库连接已关闭"</span>)
</code></pre>
<h2 data-id="heading-5">第五步：MCP服务器架构升级</h2>
<p><strong>重要变化</strong>：实际代码采用了更灵活的架构，所有工具函数都重新设计为 <code>*_by_url</code> 命名方式，必须显式传入 <code>database_url</code> 参数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
src/mcp_datatools/server.py - 仅提供必须传入 database_url 的工具
"""</span>

<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">from</span> .utils <span class="hljs-keyword">import</span> setup_project_path, database_operation
setup_project_path()

<span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP
<span class="hljs-keyword">from</span> mcp.server.fastmcp.utilities.logging <span class="hljs-keyword">import</span> get_logger

<span class="hljs-comment"># 支持相对导入和绝对导入</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">from</span> .database <span class="hljs-keyword">import</span> MultiDatabaseManager
<span class="hljs-keyword">except</span> ImportError:
    <span class="hljs-keyword">from</span> mcp_datatools.database <span class="hljs-keyword">import</span> MultiDatabaseManager

<span class="hljs-keyword">from</span> config.settings <span class="hljs-keyword">import</span> config

mcp = FastMCP(config.name)
logger = get_logger(__name__)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_database_manager</span>(<span class="hljs-params">database_url: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""根据显式指定的数据库URL返回管理器"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> database_url <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(database_url, <span class="hljs-built_in">str</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> database_url.strip():
        <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"请提供有效的 database_url"</span>)
    <span class="hljs-keyword">return</span> MultiDatabaseManager(database_url.strip())

<span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"获取数据库信息（必须指定 database_url）。例如：get_database_info_by_url('postgresql://user:pass@host:5432/db')"</span></span>)</span>
<span class="hljs-meta">@database_operation(<span class="hljs-params"><span class="hljs-string">"获取数据库信息"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_database_info_by_url</span>(<span class="hljs-params">database_url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""查询指定数据库的信息（必须传入 database_url）"""</span>
    db_mgr = get_database_manager(database_url)
    info = db_mgr.get_database_info()

    result = <span class="hljs-string">"数据库信息:\n"</span>
    result += <span class="hljs-string">f"类型: <span class="hljs-subst">{info.get(<span class="hljs-string">'type'</span>)}</span>\n"</span>
    result += <span class="hljs-string">f"连接: <span class="hljs-subst">{info.get(<span class="hljs-string">'url'</span>)}</span>\n"</span>
    result += <span class="hljs-string">f"表数量: <span class="hljs-subst">{info.get(<span class="hljs-string">'tables_count'</span>)}</span>\n"</span>

    pool = info.get(<span class="hljs-string">'connection_pool'</span>)
    <span class="hljs-keyword">if</span> pool:
        result += <span class="hljs-string">"\n连接池状态:\n"</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'size'</span> <span class="hljs-keyword">in</span> pool:
            result += <span class="hljs-string">f"  池大小: <span class="hljs-subst">{pool[<span class="hljs-string">'size'</span>]}</span>\n"</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'checked_out'</span> <span class="hljs-keyword">in</span> pool:
            result += <span class="hljs-string">f"  已连接: <span class="hljs-subst">{pool[<span class="hljs-string">'checked_out'</span>]}</span>\n"</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'checked_in'</span> <span class="hljs-keyword">in</span> pool:
            result += <span class="hljs-string">f"  可用连接: <span class="hljs-subst">{pool[<span class="hljs-string">'checked_in'</span>]}</span>\n"</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">'overflow'</span> <span class="hljs-keyword">in</span> pool:
            result += <span class="hljs-string">f"  溢出连接: <span class="hljs-subst">{pool[<span class="hljs-string">'overflow'</span>]}</span>\n"</span>

    <span class="hljs-keyword">return</span> result

<span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"列出所有表（必须指定 database_url）。例如：list_tables_by_url('mysql+pymysql://user:pass@host:3306/db')"</span></span>)</span>
<span class="hljs-meta">@database_operation(<span class="hljs-params"><span class="hljs-string">"获取数据库表列表"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">list_tables_by_url</span>(<span class="hljs-params">database_url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""查询指定数据库的表列表（必须传入 database_url）"""</span>
    db_mgr = get_database_manager(database_url)
    tables = db_mgr.get_table_names()

    <span class="hljs-keyword">if</span> tables:
        result = <span class="hljs-string">f"数据库中共有 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tables)}</span> 个表:\n\n"</span>
        <span class="hljs-keyword">for</span> i, table <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(tables, <span class="hljs-number">1</span>):
            result += <span class="hljs-string">f"<span class="hljs-subst">{i}</span>. <span class="hljs-subst">{table}</span>\n"</span>
        <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"数据库中没有表"</span>

<span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"获取表结构信息（必须指定 database_url）。例如：schema_info_by_url(['users'], 'sqlite:///path/to.db')"</span></span>)</span>
<span class="hljs-meta">@database_operation(<span class="hljs-params"><span class="hljs-string">"获取表结构信息"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">schema_info_by_url</span>(<span class="hljs-params">table_names: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], database_url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定数据库中表的详细结构信息（必须传入 database_url）"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> table_names:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"请提供要查询的表名"</span>

    db_mgr = get_database_manager(database_url)
    result_parts = []

    <span class="hljs-keyword">for</span> table_name <span class="hljs-keyword">in</span> table_names:
        <span class="hljs-keyword">try</span>:
            schema_info = db_mgr.get_table_schema(table_name)

            <span class="hljs-comment"># 格式化表结构信息</span>
            table_section = <span class="hljs-string">f"\n<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">50</span>}</span>\n"</span>
            table_section += <span class="hljs-string">f"表名：<span class="hljs-subst">{table_name}</span>\n"</span>
            table_section += <span class="hljs-string">f"列：<span class="hljs-subst">{schema_info[<span class="hljs-string">'columns'</span>]}</span>\n"</span>
            table_section += <span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">50</span>}</span>\n"</span>

            <span class="hljs-comment"># 列信息</span>
            <span class="hljs-keyword">for</span> col <span class="hljs-keyword">in</span> schema_info[<span class="hljs-string">'columns'</span>]:
                col_type = col[<span class="hljs-string">'type'</span>]
                nullable = <span class="hljs-string">"可空"</span> <span class="hljs-keyword">if</span> col[<span class="hljs-string">'nullable'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">"不可空"</span>
                pk_mark = <span class="hljs-string">" 主键"</span> <span class="hljs-keyword">if</span> col[<span class="hljs-string">'is_primary_key'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
                default_info = <span class="hljs-string">f" (默认: <span class="hljs-subst">{col[<span class="hljs-string">'default'</span>]}</span>)"</span> <span class="hljs-keyword">if</span> col[<span class="hljs-string">'default'</span>] <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
                table_section += <span class="hljs-string">f"  • <span class="hljs-subst">{col[<span class="hljs-string">'name'</span>]}</span>: <span class="hljs-subst">{col_type}</span> - <span class="hljs-subst">{nullable}</span><span class="hljs-subst">{pk_mark}</span><span class="hljs-subst">{default_info}</span>\n"</span>

            <span class="hljs-comment"># 主键信息</span>
            <span class="hljs-keyword">if</span> schema_info[<span class="hljs-string">'primary_keys'</span>]:
                table_section += <span class="hljs-string">f"\n主键: <span class="hljs-subst">{<span class="hljs-string">', '</span>.join(schema_info[<span class="hljs-string">'primary_keys'</span>])}</span>\n"</span>

            <span class="hljs-comment"># 索引信息</span>
            <span class="hljs-keyword">if</span> schema_info[<span class="hljs-string">'indexes'</span>]:
                table_section += <span class="hljs-string">"\n索引信息:\n"</span>
                <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> schema_info[<span class="hljs-string">'indexes'</span>]:
                    unique_mark = <span class="hljs-string">"唯一索引"</span> <span class="hljs-keyword">if</span> idx.get(<span class="hljs-string">'unique'</span>, <span class="hljs-literal">False</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">"普通索引"</span>
                    columns = <span class="hljs-string">', '</span>.join(idx[<span class="hljs-string">'column_names'</span>])
                    table_section += <span class="hljs-string">f"  • <span class="hljs-subst">{idx[<span class="hljs-string">'name'</span>]}</span>: <span class="hljs-subst">{unique_mark}</span> (<span class="hljs-subst">{columns}</span>)\n"</span>

            <span class="hljs-comment"># 外键信息</span>
            <span class="hljs-keyword">if</span> schema_info[<span class="hljs-string">'foreign_keys'</span>]:
                table_section += <span class="hljs-string">"\n外键关系:\n"</span>
                <span class="hljs-keyword">for</span> fk <span class="hljs-keyword">in</span> schema_info[<span class="hljs-string">'foreign_keys'</span>]:
                    local_cols = <span class="hljs-string">', '</span>.join(fk[<span class="hljs-string">'constrained_columns'</span>])
                    ref_table = fk[<span class="hljs-string">'referred_table'</span>]
                    ref_cols = <span class="hljs-string">', '</span>.join(fk[<span class="hljs-string">'referred_columns'</span>])
                    table_section += <span class="hljs-string">f"  • <span class="hljs-subst">{local_cols}</span> → <span class="hljs-subst">{ref_table}</span>.<span class="hljs-subst">{ref_cols}</span>\n"</span>

            result_parts.append(table_section)

        <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
            result_parts.append(<span class="hljs-string">f"\n表 '<span class="hljs-subst">{table_name}</span>': <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>\n"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            result_parts.append(<span class="hljs-string">f"\n表 '<span class="hljs-subst">{table_name}</span>' 解析失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>\n"</span>)

    <span class="hljs-keyword">return</span> <span class="hljs-string">'\n'</span>.join(result_parts)

<span class="hljs-meta">@mcp.tool(<span class="hljs-params">description=<span class="hljs-string">"执行只读SQL查询（必须指定 database_url；仅支持SELECT，自动加行数限制，支持参数化查询）。例如：execute_query_by_url('SELECT 1', 'postgresql://...')"</span></span>)</span>
<span class="hljs-meta">@database_operation(<span class="hljs-params"><span class="hljs-string">"执行SQL查询"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_query_by_url</span>(<span class="hljs-params">query: <span class="hljs-built_in">str</span>, database_url: <span class="hljs-built_in">str</span>, params: <span class="hljs-built_in">dict</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""执行只读查询（必须传入 database_url）"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> query <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> query.strip():
        <span class="hljs-keyword">return</span> <span class="hljs-string">"请提供查询语句"</span>

    db_mgr = get_database_manager(database_url)
    query_params = params <span class="hljs-keyword">if</span> params <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>

    result = db_mgr.execute_query(query.strip(), query_params)

    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"查询结果为空"</span>

    result_text = <span class="hljs-string">"查询结果:\n"</span>
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> result:
        result_text += <span class="hljs-string">f"<span class="hljs-subst">{row}</span>\n"</span>
    <span class="hljs-keyword">return</span> result_text

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-keyword">try</span>:
        logger.info(<span class="hljs-string">f"启动<span class="hljs-subst">{config.name}</span> v<span class="hljs-subst">{config.version}</span>"</span>)

        logger.info(<span class="hljs-string">"当前功能："</span>)
        logger.info(<span class="hljs-string">"  - get_database_info_by_url(database_url) - 获取数据库信息"</span>)
        logger.info(<span class="hljs-string">"  - list_tables_by_url(database_url) - 获取数据库表列表"</span>)
        logger.info(<span class="hljs-string">"  - schema_info_by_url(table_names, database_url) - 获取表结构"</span>)
        logger.info(<span class="hljs-string">"  - execute_query_by_url(query, database_url, params=None) - 执行SQL只读查询"</span>)
        logger.info(<span class="hljs-string">"MCP服务器启动成功，等待客户端连接..."</span>)

        mcp.run()
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        logger.error(<span class="hljs-string">f"服务器启动失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">raise</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<p><strong>这种设计的优势</strong>：</p>
<ul>
<li><strong>真正的多数据库支持</strong>：可以同时连接和操作多个不同的数据库</li>
<li><strong>更高的灵活性</strong>：每个操作都可以针对不同的数据库实例</li>
<li><strong>无全局状态</strong>：避免并发问题，更加线程安全</li>
<li><strong>更好的扩展性</strong>：支持未来扩展到更多数据库类型</li>
<li><strong>统一错误处理</strong>：通过装饰器统一处理数据库操作错误</li>
</ul>
<h2 data-id="heading-6">第六步：公共工具函数</h2>
<p>新增的 <code>utils.py</code> 文件提供了重要的公共功能：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
src/mcp_datatools/utils.py - 公共工具函数
"""</span>

<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Any</span>, <span class="hljs-type">Callable</span>
<span class="hljs-keyword">from</span> functools <span class="hljs-keyword">import</span> wraps
<span class="hljs-keyword">from</span> mcp.server.fastmcp.utilities.logging <span class="hljs-keyword">import</span> get_logger

logger = get_logger(__name__)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_project_path</span>():
    <span class="hljs-string">"""统一的项目路径设置"""</span>
    current_dir = os.path.dirname(os.path.abspath(__file__))
    <span class="hljs-comment"># 从 src/mcp_datatools 到项目根目录</span>
    project_root = os.path.dirname(os.path.dirname(current_dir))
    <span class="hljs-keyword">if</span> project_root <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> sys.path:
        sys.path.insert(<span class="hljs-number">0</span>, project_root)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_database_error</span>(<span class="hljs-params">operation: <span class="hljs-built_in">str</span>, error: Exception</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""统一的数据库错误处理"""</span>
    error_msg = <span class="hljs-string">f"<span class="hljs-subst">{operation}</span>失败: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(error)}</span>"</span>
    logger.error(error_msg)
    <span class="hljs-keyword">return</span> error_msg

<span class="hljs-keyword">def</span> <span class="hljs-title function_">database_operation</span>(<span class="hljs-params">operation_name: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""数据库操作装饰器，统一错误处理"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decorator</span>(<span class="hljs-params">func: <span class="hljs-type">Callable</span></span>) -&gt; <span class="hljs-type">Callable</span>:
<span class="hljs-meta">        @wraps(<span class="hljs-params">func</span>)</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">wrapper</span>(<span class="hljs-params">*args, **kwargs</span>) -&gt; <span class="hljs-type">Any</span>:
            <span class="hljs-keyword">try</span>:
                result = func(*args, **kwargs)
                logger.info(<span class="hljs-string">f"成功<span class="hljs-subst">{operation_name}</span>"</span>)
                <span class="hljs-keyword">return</span> result
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">return</span> handle_database_error(operation_name, e)
        <span class="hljs-keyword">return</span> wrapper
    <span class="hljs-keyword">return</span> decorator

<span class="hljs-keyword">def</span> <span class="hljs-title function_">mask_password</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""隐藏URL中的密码"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"@"</span> <span class="hljs-keyword">in</span> url <span class="hljs-keyword">and</span> <span class="hljs-string">"://"</span> <span class="hljs-keyword">in</span> url:
        parts = url.split(<span class="hljs-string">"://"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) == <span class="hljs-number">2</span>:
            protocol = parts[<span class="hljs-number">0</span>]
            rest = parts[<span class="hljs-number">1</span>]
            <span class="hljs-keyword">if</span> <span class="hljs-string">"@"</span> <span class="hljs-keyword">in</span> rest:
                user_pass, host_db = rest.split(<span class="hljs-string">"@"</span>, <span class="hljs-number">1</span>)
                <span class="hljs-keyword">if</span> <span class="hljs-string">":"</span> <span class="hljs-keyword">in</span> user_pass:
                    user, _ = user_pass.split(<span class="hljs-string">":"</span>, <span class="hljs-number">1</span>)
                    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{protocol}</span>://<span class="hljs-subst">{user}</span>:***@<span class="hljs-subst">{host_db}</span>"</span>
    <span class="hljs-keyword">return</span> url
</code></pre>
<p><strong>工具函数的作用</strong>：</p>
<ul>
<li><strong>路径管理</strong>：<code>setup_project_path()</code> 解决模块导入问题</li>
<li><strong>错误处理</strong>：<code>database_operation</code> 装饰器统一处理数据库操作错误</li>
<li><strong>安全处理</strong>：<code>mask_password()</code> 隐藏连接字符串中的敏感信息</li>
</ul>
<h2 data-id="heading-7">第七步：数据库初始化脚本</h2>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- data/init_scripts/postgresql.sql</span>
<span class="hljs-comment">-- PostgreSQL测试数据库初始化</span>

<span class="hljs-comment">-- 创建用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> users (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 创建产品表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> products (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    price <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    category <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 创建订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> orders (
    id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">INTEGER</span> <span class="hljs-keyword">REFERENCES</span> users(id),
    total_amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 插入测试数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (name, email) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-string">'吴邪'</span>, <span class="hljs-string">'wuxie@example.com'</span>),
    (<span class="hljs-string">'张起灵'</span>, <span class="hljs-string">'zhangqiling@example.com'</span>),
    (<span class="hljs-string">'王胖子'</span>, <span class="hljs-string">'wangpangzi@example.com'</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (name, price, category) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-string">'洛阳铲'</span>, <span class="hljs-number">299.99</span>, <span class="hljs-string">'探测工具'</span>),
    (<span class="hljs-string">'夜明珠'</span>, <span class="hljs-number">9999.99</span>, <span class="hljs-string">'照明装备'</span>),
    (<span class="hljs-string">'黑驴蹄子'</span>, <span class="hljs-number">88.88</span>, <span class="hljs-string">'防护用品'</span>),
    (<span class="hljs-string">'金刚伞'</span>, <span class="hljs-number">1299.99</span>, <span class="hljs-string">'防御装备'</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (user_id, total_amount, status) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-number">1</span>, <span class="hljs-number">10299.98</span>, <span class="hljs-string">'completed'</span>),   <span class="hljs-comment">-- 吴邪：夜明珠+洛阳铲</span>
    (<span class="hljs-number">2</span>, <span class="hljs-number">88.88</span>, <span class="hljs-string">'pending'</span>),        <span class="hljs-comment">-- 张起灵：黑驴蹄子</span>
    (<span class="hljs-number">3</span>, <span class="hljs-number">1388.87</span>, <span class="hljs-string">'shipped'</span>);      <span class="hljs-comment">-- 王胖子：金刚伞+黑驴蹄子</span>

<span class="hljs-comment">-- 创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> idx_users_email <span class="hljs-keyword">ON</span> users(email);
<span class="hljs-keyword">CREATE</span> INDEX IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> idx_products_category <span class="hljs-keyword">ON</span> products(category);
<span class="hljs-keyword">CREATE</span> INDEX IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> idx_orders_user_id <span class="hljs-keyword">ON</span> orders(user_id);
<span class="hljs-keyword">CREATE</span> INDEX IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> idx_orders_status <span class="hljs-keyword">ON</span> orders(status);
</code></pre>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- data/init_scripts/mysql.sql</span>
<span class="hljs-comment">-- MySQL测试数据库初始化</span>

<span class="hljs-comment">-- 创建用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> users (
    id <span class="hljs-type">INT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 创建产品表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> products (
    id <span class="hljs-type">INT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    price <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    category <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 创建订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> orders (
    id <span class="hljs-type">INT</span> AUTO_INCREMENT <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">INT</span>,
    total_amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'pending'</span>,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">FOREIGN</span> KEY (user_id) <span class="hljs-keyword">REFERENCES</span> users(id)
);

<span class="hljs-comment">-- 插入测试数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (name, email) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-string">'胡八一'</span>, <span class="hljs-string">'hubayii@example.com'</span>),
    (<span class="hljs-string">'王凯旋'</span>, <span class="hljs-string">'wangkaixuan@example.com'</span>),
    (<span class="hljs-string">'雪莉杨'</span>, <span class="hljs-string">'xueliyang@example.com'</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> products (name, price, category) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-string">'摸金符'</span>, <span class="hljs-number">888.88</span>, <span class="hljs-string">'护身符'</span>),
    (<span class="hljs-string">'金刚伞'</span>, <span class="hljs-number">1588.88</span>, <span class="hljs-string">'防御装备'</span>),
    (<span class="hljs-string">'黑驴蹄子'</span>, <span class="hljs-number">66.66</span>, <span class="hljs-string">'镇邪用品'</span>),
    (<span class="hljs-string">'探照灯'</span>, <span class="hljs-number">299.99</span>, <span class="hljs-string">'照明装备'</span>);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (user_id, total_amount, status) <span class="hljs-keyword">VALUES</span> 
    (<span class="hljs-number">1</span>, <span class="hljs-number">955.54</span>, <span class="hljs-string">'completed'</span>),    <span class="hljs-comment">-- 胡八一：摸金符+黑驴蹄子</span>
    (<span class="hljs-number">2</span>, <span class="hljs-number">299.99</span>, <span class="hljs-string">'pending'</span>),      <span class="hljs-comment">-- 王凯旋：探照灯</span>
    (<span class="hljs-number">3</span>, <span class="hljs-number">1655.54</span>, <span class="hljs-string">'shipped'</span>);     <span class="hljs-comment">-- 雪莉杨：金刚伞+黑驴蹄子</span>

<span class="hljs-comment">-- 创建索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_users_email <span class="hljs-keyword">ON</span> users(email);
<span class="hljs-keyword">CREATE</span> INDEX idx_products_category <span class="hljs-keyword">ON</span> products(category);
<span class="hljs-keyword">CREATE</span> INDEX idx_orders_user_id <span class="hljs-keyword">ON</span> orders(user_id);
<span class="hljs-keyword">CREATE</span> INDEX idx_orders_status <span class="hljs-keyword">ON</span> orders(status);
</code></pre>
<h2 data-id="heading-8">第八步：使用 Docker 启动数据库（推荐），应用本地运行</h2>
<blockquote>
<p>你已在上一步准备好了 init.sql。首次启动容器（数据卷为空）时会自动执行这些脚本。</p>
</blockquote>
<p>在日常开发中，建议：</p>
<ul>
<li>应用代码直接在本地运行（便于调试与迭代）</li>
<li>PostgreSQL / MySQL 使用 Docker 启动（避免本机安装与版本差异）</li>
</ul>
<p>这样既轻量，又能快速切换数据库类型，满足“多数据库支持”的目标。</p>
<h3 data-id="heading-9">使用 docker-compose 启动数据库（PostgreSQL + MySQL）</h3>
<p>你可以为数据库单独准备一个 compose 文件（例如：docker-compose.db.yml），仅包含 Postgres 与 MySQL 服务：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.db.yml</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">postgres:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:15</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">POSTGRES_DB:</span> <span class="hljs-string">testdb_1</span>
      <span class="hljs-attr">POSTGRES_USER:</span> <span class="hljs-string">postgres</span>
      <span class="hljs-attr">POSTGRES_PASSWORD:</span> <span class="hljs-string">password</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"5432:5432"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">postgres_data:/var/lib/postgresql/data</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./data/init_scripts/postgresql.sql:/docker-entrypoint-initdb.d/init.sql</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>
    <span class="hljs-attr">healthcheck:</span>
      <span class="hljs-attr">test:</span> [<span class="hljs-string">"CMD-SHELL"</span>, <span class="hljs-string">"pg_isready -U postgres -d testdb || exit 1"</span>]
      <span class="hljs-attr">interval:</span> <span class="hljs-string">10s</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span>
      <span class="hljs-attr">retries:</span> <span class="hljs-number">5</span>

  <span class="hljs-attr">mysql:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:8.0</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-string">rootpassword</span>
      <span class="hljs-attr">MYSQL_DATABASE:</span> <span class="hljs-string">testdb_2</span>
      <span class="hljs-attr">MYSQL_USER:</span> <span class="hljs-string">testuser</span>
      <span class="hljs-attr">MYSQL_PASSWORD:</span> <span class="hljs-string">testpass</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"3306:3306"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">mysql_data:/var/lib/mysql</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./data/init_scripts/mysql.sql:/docker-entrypoint-initdb.d/init.sql</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>
    <span class="hljs-attr">healthcheck:</span>
      <span class="hljs-attr">test:</span> [<span class="hljs-string">"CMD-SHELL"</span>, <span class="hljs-string">"mysqladmin ping -h 127.0.0.1 -ptestpass || exit 1"</span>]
      <span class="hljs-attr">interval:</span> <span class="hljs-string">10s</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">5s</span>
      <span class="hljs-attr">retries:</span> <span class="hljs-number">10</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">postgres_data:</span>
  <span class="hljs-attr">mysql_data:</span>
</code></pre>
<p>启动与验证：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动数据库容器</span>
docker-compose -f docker-compose.db.yml up -d

<span class="hljs-comment"># 查看状态</span>
docker-compose -f docker-compose.db.yml ps

<span class="hljs-comment"># 查看日志（可选）</span>
docker-compose -f docker-compose.db.yml logs -f postgres
docker-compose -f docker-compose.db.yml logs -f mysql
</code></pre>
<h3 data-id="heading-10">使用 docker run 启动单个数据库（不使用 compose）</h3>
<p>如果你只需要其中一个数据库：</p>
<p>PostgreSQL：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d --name pg15 \
  -e POSTGRES_DB=testdb \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=password \
  -p 5432:5432 \
  -v $(<span class="hljs-built_in">pwd</span>)/data/init_scripts/postgresql.sql:/docker-entrypoint-initdb.d/init.sql \
  postgres:15
</code></pre>
<p>MySQL：</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d --name mysql8 \
  -e MYSQL_ROOT_PASSWORD=rootpassword \
  -e MYSQL_DATABASE=testdb \
  -e MYSQL_USER=testuser \
  -e MYSQL_PASSWORD=testpass \
  -p 3306:3306 \
  -v $(<span class="hljs-built_in">pwd</span>)/data/init_scripts/mysql.sql:/docker-entrypoint-initdb.d/init.sql \
  mysql:8.0
</code></pre>
<blockquote>
<p>Windows PowerShell 下将 <code>$(pwd)</code> 改为 <code>${PWD}</code>。</p>
</blockquote>
<h2 data-id="heading-11">第九步：测试脚本</h2>
<p>创建多数据库测试脚本：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
tests/test_mcp_tools.py - MCP 工具功能测试
"""</span>

<span class="hljs-keyword">import</span> pytest
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> mcp_datatools.database <span class="hljs-keyword">import</span> MultiDatabaseManager

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TestMCPTools</span>:
    <span class="hljs-string">"""MCP 工具功能测试类"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_database_type_detection</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试数据库类型检测 - MCP 工具需要知道数据库类型"""</span>
        <span class="hljs-comment"># SQLite</span>
        db_mgr = MultiDatabaseManager(<span class="hljs-string">"sqlite:///data/test.db"</span>)
        <span class="hljs-keyword">assert</span> db_mgr.db_type == <span class="hljs-string">"sqlite"</span>
        db_mgr.close()
        
        <span class="hljs-comment"># PostgreSQL</span>
        db_mgr = MultiDatabaseManager(<span class="hljs-string">"postgresql://user:pass@host:5432/db"</span>)
        <span class="hljs-keyword">assert</span> db_mgr.db_type == <span class="hljs-string">"postgresql"</span>
        db_mgr.close()
        
        <span class="hljs-comment"># MySQL</span>
        db_mgr = MultiDatabaseManager(<span class="hljs-string">"mysql+pymysql://user:pass@host:3306/db"</span>)
        <span class="hljs-keyword">assert</span> db_mgr.db_type == <span class="hljs-string">"mysql"</span>
        db_mgr.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_mcp_tool_get_database_info</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试 MCP 工具：获取数据库信息"""</span>
        db_url = <span class="hljs-string">"sqlite:///data/test.db"</span>
        db_mgr = MultiDatabaseManager(db_url)
        
        <span class="hljs-comment"># 测试 MCP 工具需要的数据库信息</span>
        info = db_mgr.get_database_info()
        
        <span class="hljs-comment"># 验证 MCP 工具返回的关键信息</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-string">'type'</span> <span class="hljs-keyword">in</span> info
        <span class="hljs-keyword">assert</span> <span class="hljs-string">'url'</span> <span class="hljs-keyword">in</span> info
        <span class="hljs-keyword">assert</span> <span class="hljs-string">'tables_count'</span> <span class="hljs-keyword">in</span> info
        <span class="hljs-keyword">assert</span> info[<span class="hljs-string">'type'</span>] == <span class="hljs-string">"sqlite"</span>
        
        db_mgr.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_mcp_tool_list_tables</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试 MCP 工具：列出数据库表"""</span>
        db_url = <span class="hljs-string">"sqlite:///data/test.db"</span>
        db_mgr = MultiDatabaseManager(db_url)
        
        <span class="hljs-comment"># 测试 MCP 工具需要的表列表功能</span>
        tables = db_mgr.get_table_names()
        
        <span class="hljs-comment"># 验证返回格式</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(tables, <span class="hljs-built_in">list</span>)
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(tables) &gt; <span class="hljs-number">0</span>  <span class="hljs-comment"># 应该有一些测试表</span>
        
        db_mgr.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_mcp_tool_execute_query</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试 MCP 工具：执行查询"""</span>
        db_url = <span class="hljs-string">"sqlite:///data/test.db"</span>
        db_mgr = MultiDatabaseManager(db_url)
        
        <span class="hljs-comment"># 测试 MCP 工具需要的查询功能</span>
        result = db_mgr.execute_query(<span class="hljs-string">"SELECT 1 as test_value"</span>)
        
        <span class="hljs-comment"># 验证返回格式</span>
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(result, <span class="hljs-built_in">list</span>)
        <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(result) == <span class="hljs-number">1</span>
        <span class="hljs-keyword">assert</span> result[<span class="hljs-number">0</span>][<span class="hljs-string">'test_value'</span>] == <span class="hljs-number">1</span>
        
        db_mgr.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_mcp_tool_query_safety</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试 MCP 工具：查询安全性"""</span>
        db_url = <span class="hljs-string">"sqlite:///data/test.db"</span>
        db_mgr = MultiDatabaseManager(db_url)
        
        <span class="hljs-comment"># 测试危险操作被阻止</span>
        dangerous_queries = [
            <span class="hljs-string">"DROP TABLE users"</span>,
            <span class="hljs-string">"DELETE FROM users"</span>,
            <span class="hljs-string">"UPDATE users SET name = 'hack'"</span>
        ]
        
        <span class="hljs-keyword">for</span> query <span class="hljs-keyword">in</span> dangerous_queries:
            <span class="hljs-keyword">with</span> pytest.raises(ValueError, <span class="hljs-keyword">match</span>=<span class="hljs-string">"查询包含危险操作"</span>):
                db_mgr.execute_query(query)
        
        db_mgr.close()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_postgresql_mcp_tools</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试 PostgreSQL 的 MCP 工具功能"""</span>
        db_url = <span class="hljs-string">"postgresql://postgres:password@localhost:5432/testdb_1"</span>
        
        <span class="hljs-keyword">try</span>:
            db_mgr = MultiDatabaseManager(db_url)
            
            <span class="hljs-comment"># 测试 MCP 工具在 PostgreSQL 上的功能</span>
            info = db_mgr.get_database_info()
            <span class="hljs-keyword">assert</span> info[<span class="hljs-string">'type'</span>] == <span class="hljs-string">"postgresql"</span>
            
            <span class="hljs-comment"># 测试查询</span>
            result = db_mgr.execute_query(<span class="hljs-string">"SELECT 1 as test"</span>)
            <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(result) == <span class="hljs-number">1</span>
            
            db_mgr.close()
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            pytest.skip(<span class="hljs-string">f"PostgreSQL不可用: <span class="hljs-subst">{e}</span>"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_mysql_mcp_tools</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""测试 MySQL 的 MCP 工具功能"""</span>
        db_url = <span class="hljs-string">"mysql+pymysql://testuser:testpass@localhost:3306/testdb_2"</span>
        
        <span class="hljs-keyword">try</span>:
            db_mgr = MultiDatabaseManager(db_url)
            
            <span class="hljs-comment"># 测试 MCP 工具在 MySQL 上的功能</span>
            info = db_mgr.get_database_info()
            <span class="hljs-keyword">assert</span> info[<span class="hljs-string">'type'</span>] == <span class="hljs-string">"mysql"</span>
            
            <span class="hljs-comment"># 测试查询</span>
            result = db_mgr.execute_query(<span class="hljs-string">"SELECT 1 as test"</span>)
            <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(result) == <span class="hljs-number">1</span>
            
            db_mgr.close()
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            pytest.skip(<span class="hljs-string">f"MySQL不可用: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<h2 data-id="heading-12">第十步：使用指南</h2>
<h3 data-id="heading-13">安装依赖</h3>
<pre><code class="hljs language-bash" lang="bash">uv <span class="hljs-built_in">sync</span>
</code></pre>
<h3 data-id="heading-14">启动MCP服务器</h3>
<pre><code class="hljs language-bash" lang="bash">uv run python -m mcp_datatools.server
</code></pre>
<h2 data-id="heading-15">第十一步：Cursor配置</h2>
<h3 data-id="heading-16">配置示例</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"mcp-datatools-sqlite"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uv"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"/path/to/project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"-m"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"mcp_datatools.server"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"DB_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sqlite:///data/test.db"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"mcp-datatools-postgres"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uv"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"/path/to/project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"-m"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"mcp_datatools.server"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"DB_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"postgresql://postgres:password@localhost:5432/testdb_1"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"mcp-datatools-mysql"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uv"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"run"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"/path/to/project"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"-m"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"mcp_datatools.server"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"DB_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"mysql+pymysql://testuser:testpass@localhost:3306/testdb_2"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-17">测试效果</h2>
<p>现在你可以测试多数据库功能：</p>
<p><strong>获取数据库信息：</strong></p>
<pre><code class="hljs">问：查询mysql数据库testdb_2的信息
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa8741cf63cd40698a0909837ac63062~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975185&amp;x-signature=2WgX6z6TNJBJS31Pe7onVs4oYt0%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>获取指定数据库的用户信息：</strong></p>
<pre><code class="hljs">问：testdb_1用户的信息
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/267c712062b34b15a347b1876e0ebeba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975185&amp;x-signature=7gE0U69VuMlmEiilqI85bkeabfg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>连接池监控：</strong></p>
<pre><code class="hljs">问：testdb_1和testdb_2这2个数据库连接池状态如何？
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8824035a1ff44f85bb6e7ea47b5b4551~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57qi6by75a2Q5pe25Luj:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975185&amp;x-signature=wS6e9QahgLt1EdvIw%2BkIqogNDl4%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-18">总结与预告</h2>
<p>这一篇我们成功实现了PostgreSQL、MySQL、SQLite多数据库支持，加上基础连接池配置、配置管理和使用 Docker 启动数据库环境，让MCP数据库工具从“玩具”升级为真正的生产级工具。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI智能体：完整课程(高级)]]></title>    <link>https://juejin.cn/post/7586136543954272294</link>    <guid>https://juejin.cn/post/7586136543954272294</guid>    <pubDate>2025-12-22T02:32:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586136543954272294" data-draft-id="7585808181239971891" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI智能体：完整课程(高级)"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-22T02:32:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安思派Anspire"/> <meta itemprop="url" content="https://juejin.cn/user/3044964115417419"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI智能体：完整课程(高级)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044964115417419/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安思派Anspire
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:32:10.000Z" title="Mon Dec 22 2025 02:32:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">高级</h2>
<p>好了，欢迎来到高级部分。如果你已经走到这一步，说明你是认真想要构建能在现实世界中运行的真正的智能体系统。</p>
<p>那些让你从无到有做出原型的技术，却无法让你从原型走向量产。你需要不同的工具、不同的思维方式，以及更多的自律。</p>
<p>现在让我们来探讨一下这些内容。</p>
<h3 data-id="heading-1">多智能体系统的高级任务分解</h3>
<p>我们已经讨论过任务分解。但当你使用多智能体系统时，这会变得越来越复杂。</p>
<p>你可以使用四种主要模式来指导你做好这件事。BTW，我是从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgerred.github.io%2Fbuilding-an-agentic-system%2Fcore-architecture.html" target="_blank" title="https://gerred.github.io/building-an-agentic-system/core-architecture.html" ref="nofollow noopener noreferrer">这篇很棒的博客</a>改编的 —— 查看更多细节！</p>
<p><strong>模式1：功能分解</strong></p>
<p>在这种模式下，我们按技术领域或专业知识来划分任务。这就是我们到目前为止在示例中一直在使用的方法——根据需要完成的工作类型来拆分任务。</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30eca7bbf0cd4809889cd27bd1e7f4b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975560&amp;x-signature=B9w49YaiG8TSd7wiKYmBPNFxMiE%3D" alt="" loading="lazy"/></p>
<p>例如，你可以考虑全栈功能开发。这里有前端工作、后端逻辑、数据库变更，也许还有 API 更新。每一项都需要不同的知识和不同的工具。所以你要创建专门针对每个领域的智能体。</p>
<p><strong>模式2：空间分解</strong></p>
<p>你还可以按文件或目录结构进行拆分。当你处理包含许多可独立处理的文件的大型代码库时，这种方法尤其强大。</p>
<p>假设你正在进行大规模重构——也许是将所有 API 端点更新到新的身份验证系统，而且你在不同服务中有数十个文件。</p>
<p>你进行空间分解：</p>
<ul>
<li>
<p>代理1处理/services/users/*</p>
</li>
<li>
<p>代理2处理/services/orders/*</p>
</li>
<li>
<p>代理3处理 /services/payments/*</p>
</li>
<li>
<p>代理4处理/services/notifications/*</p>
</li>
</ul>
<p>在这种情况下，你可以通过确保代理在代码库的不同部分工作来减少冲突。他们可以并行工作。但如果你的文件相互之间存在复杂的依赖关系，空间分解就会失效。</p>
<p><strong>模式3：时间分解</strong></p>
<p>模式3是关于将任务分解为顺序阶段，其中后续阶段依赖于前期阶段的完成。</p>
<p>让我们以产品发布为例。你不能某天一觉醒来就开始发送促销邮件。这里有一个逻辑顺序：</p>
<p><strong>阶段1：市场调研</strong> — 分析竞争对手，调查目标客户，确定定位机会<strong>阶段2：发布规划</strong> — 确定信息传递内容，设定价格，制定时间表，确定渠道<strong>阶段3：资产创建</strong> — 撰写文案，设计图形，构建着陆页，准备邮件序列<strong>阶段4：发布与监控</strong> — 执行活动，跟踪指标，回应反馈，实时调整</p>
<p>每个阶段都有自己的代理或代理团队。阶段2直到阶段1完成并审核后才开始。</p>
<p><strong>模式4：数据驱动的分解</strong></p>
<p>最后，我们可以按数据分区进行拆分。这种方法不太常见，但对于某些用例非常强大，特别是涉及大型数据集的任务，在这些任务中，你可以对数据进行分区并独立处理各个数据块。</p>
<p>假设你正在分析应用程序日志以识别性能问题。你有上个月的数千兆字节的日志。</p>
<p>您可以按时间或按服务进行分区：</p>
<ul>
<li>
<p>代理1处理第1周的日志</p>
</li>
<li>
<p>代理2处理第2周的日志</p>
</li>
<li>
<p>代理3处理第3周的日志</p>
</li>
<li>
<p>代理4处理第4周的日志</p>
</li>
</ul>
<p>每个代理独立运行分析，然后在最后汇总结果。</p>
<p>你也可以混合使用这些模式。例如，一个全栈功能可能会对主要结构（前端、后端、数据库）使用功能分解，但后端代理在内部使用时间分解（设计 API → 实现逻辑 → 添加测试）。</p>
<h3 data-id="heading-2">提高质量</h3>
<p>好吧，假设到这一步我们已经有了一个运行中的系统，我们进行了全面评估以找出错误，但仍然对性能不满意。以下是应对措施。</p>
<p>首先要明白的是，你所处理的是两种根本不同类型的组件，它们需要不同的改进策略。</p>
<p>首先，我们有非大语言模型（LLM）组件。这些包括网络搜索、检索增强生成（RAG）检索、代码执行、语音识别、视觉模型、PDF解析器等。</p>
<p>这些可以通过两种主要方式加以改进：</p>
<ul>
<li>
<p>**调整参数。**调整诸如网络搜索日期范围、前k个结果、RAG块大小、相似度阈值等设置。</p>
</li>
<li>
<p>**或者，更换供应商。**尝试使用其他网络搜索 API、不同的 OCR 或视觉模型，等等。</p>
</li>
</ul>
<p>然后是大语言模型（LLM）组件。这些组件用于生成、提取、推理——在任何使用语言模型本身的地方。</p>
<p>我们可以做很多事情来改进这一部分：</p>
<ul>
<li>
<p>**优化提示。**添加明确的指令、约束和模式。使用少量输入输出对向模型展示你的需求。</p>
</li>
<li>
<p>**尝试其他模型。**有些模型更擅长遵循指令，有些则在代码或事实回忆方面表现出色。不要认为一种模型适用于所有情况。</p>
</li>
<li>
<p><strong>将艰巨的任务分解成更小的部分。</strong></p>
</li>
<li>
<p>**作为最后手段进行微调。**微调功能强大，但成本高昂。将其留到成熟系统中使用，在这些系统中，你需要提升最后几个百分点的质量，且已尝试过其他所有方法。</p>
</li>
</ul>
<h3 data-id="heading-3">降低延迟</h3>
<p>确保输出质量应该是你的第一步。之后，我们再来谈谈降低延迟。</p>
<ol>
<li>获取基线</li>
</ol>
<p>第一步是为工作流程中的每个步骤计时。你可能会发现，比如大语言模型（LLM）生成搜索词需要7秒，网络搜索需要5秒，撰写文章需要11秒，依此类推。</p>
<p>这为你提供了一个基线，让你知道应该优化什么。</p>
<p>2. 并行化</p>
<p>接下来，尽可能并行运行各项任务。例如网页抓取、多项搜索或解析多个文档。这往往是最容易实现的优化。</p>
<p>3. 合理调整模型规模</p>
<p>在任务简单（如关键词生成）的情况下，使用更小、更快的大语言模型（LLM），并将重量级模型留作综合和推理使用。</p>
<p>4. 尝试更快的供应商。</p>
<p>吞吐量和令牌流速度差异很大。优化服务的提供商可以在不改变任何提示的情况下节省数秒时间。</p>
<p>5. 最后，修剪上下文。</p>
<p>较短的提示和上下文意味着更快的解码速度，因此请尽量只保留该步骤真正需要的内容。</p>
<h3 data-id="heading-4">降低成本</h3>
<p>在质量高且延迟可控的情况下，你就可以开始考虑成本了。首先，你需要像测量延迟一样，测量每一步的成本。</p>
<p>代理系统有几个成本来源：</p>
<p>**大语言模型调用：**这由输入令牌和输出令牌决定。这些通常分开定价（输入令牌较便宜，输出令牌成本较高）。</p>
<p>**API****调用：**如网络搜索、PDF转换、图像生成、语音转文本等。这些通常按次或按单位计费。</p>
<p>**基础设施：**如果你正在运行自己的检索系统、向量数据库或用于代码执行的计算资源。</p>
<p>假设你正在构建一个撰写论文的研究代理。以下是一次运行可能的成本：</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b977c1f5a2c347e8b5b9b3959724ba78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975560&amp;x-signature=7WSNk2vyZuqaQZJKugerD7a82ZU%3D" alt="" loading="lazy"/></p>
<p>如果你每天运行1000次，那就是每天80美元，或每月2400美元。</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/241da4e0af884d80aee5363080c1aecd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975560&amp;x-signature=ofJOwKZA%2FyohtFjlx1rSWbCRjfo%3D" alt="" loading="lazy"/></p>
<p>一旦你知道每一步的成本，以下是你可以采取的优化措施：</p>
<ul>
<li>
<p>**先解决大开销的部分。**如果网络搜索每次调用花费2美分，而你每次运行调用10次，那就是20美分。尽最大努力减少调用次数、缓存结果或批量查询。</p>
</li>
<li>
<p>**对模型进行分层。**简单任务使用低成本模型，前沿模型仅在真正关键的地方使用。</p>
</li>
<li>
<p>**积极缓存。**像搜索响应、嵌入、块检索或中间摘要这样的确定性结果不应每次都重新计算。</p>
</li>
<li>
<p>**限制输出。**使用诸如 “返回包含这些必填字段的 JSON”、“最多提供 5 个要点” 之类的指令，要求输出结构化、简洁的结果。使用更少的令牌，降低费用。</p>
</li>
<li>
<p>**批量处理。**如果您要处理许多相似的项目，尽可能将操作捆绑在一起。例如，在AWS上，批量处理的成本仅为按需处理的50%。</p>
</li>
</ul>
<h3 data-id="heading-5">可观测性和监控</h3>
<p>你已经有了一个在质量、延迟和成本方面都让你满意的系统。现在我们需要确保它在扩展后仍能按预期运行。</p>
<p>这就是监控和可观测性发挥作用的地方。可观测性涵盖可调试性、质量监控和幻觉跟踪。基本上，任何有助于你观察智能体行为和性能的内容都属于可观测性范畴。</p>
<p>棘手的是，AI系统的可观测性与传统软件有着根本的不同。</p>
<p>使用传统软件时，你可以追踪到清晰的执行路径。函数A调用函数B，函数B查询数据库、返回数据、渲染页面，诸如此类。</p>
<p>由于多种不同原因，AI系统并非如此运作：</p>
<ul>
<li>
<p>它们是非确定性的。相同的输入可能会根据模型的响应产生不同的输出。你不能简单地重复请求并期望得到相同的结果。</p>
</li>
<li>
<p>他们通过并行运行的工具、代理生成子代理等方式实现分布式执行。</p>
</li>
<li>
<p>大量外部依赖项存在潜在的故障点，且这些故障点不受你控制。</p>
</li>
<li>
<p>还有更多！</p>
</li>
</ul>
<p>为了管理这一切，我们需要两种可见性：</p>
<ul>
<li>
<p><strong>“Zoom-in”指标</strong>可帮助您调试单次运行。这是您的完整跟踪信息：提示、工具调用、令牌使用情况、重试尝试以及每个决策点。基本上包含重现错误并确切找出错误发生位置所需的一切信息。</p>
</li>
<li>
<p><strong>“缩小”指标</strong>告诉你整个系统在多次运行中的表现。这包括自动质量检查（通常以大语言模型作为评判）、幻觉率、成功率/投资回报率（ROI）衡量指标，以及显示变化是有益还是有害的趋势线。</p>
</li>
</ul>
<p>你不仅要记录智能体做了什么，还要记录它这么做的原因。例如，你可能会记录这样的内容：“智能体选择使用网络搜索而非检索增强生成（RAG），因为查询中包含‘近期’”或“反思过程识别出3个问题：缺少引用、日期模糊、语气不当”</p>
<p>当你同时运行数千个智能体时，你无法手动查看每一条追踪信息。这就是<strong>质量抽样</strong>发挥作用的地方。与其深入检查每一次执行，你可以定义一个抽样率——比如，总运行次数的一定百分比——来评估质量和幻觉情况。然后，系统会使用这部分执行来计算智能体的整体质量得分和幻觉得分。</p>
<p>这使您能够对修复和改进领域进行优先级排序。</p>
<p>除了技术指标，你还需要了解用户行为。</p>
<ul>
<li>
<p>**人们实际在寻求什么？**他们是否按预期使用你的代理，还是找到了创造性的变通方法？</p>
</li>
<li>
<p>**他们在哪里卡住了？**他们会重新表述并再次尝试吗？这表明第一次尝试没有成功。</p>
</li>
<li>
<p>**他们如何处理输出结果？**如果他们立即要求修改，那么初始质量就不够好。</p>
</li>
<li>
<p>**会话时长是多少？**非常短的会话可能意味着快速成功或立即失败。非常长的会话可能意味着代理有能力但效率低下。</p>
</li>
</ul>
<p>这些定性数据与你的技术指标一样，都能为你的产品路线图提供指导。</p>
<h3 data-id="heading-6">安全</h3>
<p>最后，我们需要谈谈构建强大系统中最不令人兴奋但最重要的部分之一：安全。</p>
<p>就像可观测性一样，AI智能体的安全性与传统应用程序的安全性不同。你不仅要防范外部攻击者，实际上还必须防范自己的系统做出危险决策或被操纵而采取有害行动。</p>
<p>这些就是需要留意的事项：</p>
<ul>
<li>
<p>**提示注入：**用户输入或外部数据中的恶意内容，会劫持你的代理指令</p>
</li>
<li>
<p>**不安全的代码生成：**代理编写访问敏感数据或执行危险操作的代码</p>
</li>
<li>
<p>**数据泄露：**通过代理输出或工具调用暴露的PII或专有信息</p>
</li>
<li>
<p>**资源耗尽：**代理启动高成本操作或无限循环</p>
</li>
</ul>
<p>让我们特别深入探讨一下代码执行。代码执行是智能体的终极工具。它极其强大，因为智能体可以编写代码来生成图表、创建 Markdown 文件、处理数据，并且通常可以在你设定的边界内“为所欲为”。</p>
<p>这是一把双刃剑。</p>
<p>许多任务可以通过定义明确的自定义工具来完成，因此您的系统并不总是需要退回到自由形式的编码。但当您启用它时，您需要设置防护措施。</p>
<p>以下是安全执行代码的方法：</p>
<ul>
<li>
<p>**沙盒执行。**使用 Docker 或受限的运行器环境。将代码执行与主应用程序完全隔离。代码应在每次执行后销毁的容器中运行。</p>
</li>
<li>
<p>**资源限制。**设置超时时间、内存上限、CPU限制。阻止危险的导入操作、网络访问（除非明确需要），以及在指定临时目录之外的文件系统写入操作。</p>
</li>
<li>
<p>**仅使用白名单库。**允许使用特定的、安全的库，如pandas、numpy或datetime。不允许随意安装。如果代理需要某个库，你需要明确地将其添加到白名单中。</p>
</li>
<li>
<p>**验证加反思循环。**如果代码执行出错，捕获回溯信息并让模型修复代码。给它一到两次尝试机会，并确保设置了断路器。</p>
</li>
<li>
<p>**确定性输入/输出。**让代码返回一个小的、结构化的结果——一个数字、一个列表、一个JSON对象。然后你再为用户格式化这个结果。不要让代码直接向用户输出或写入他们可以访问的文件。</p>
</li>
<li>
<p>以及<strong>输入和输出的安全处理</strong>，确保所有输入在到达代理之前都经过验证，所有输出都经过扫描，以检查是否包含API密钥或PII等敏感数据。</p>
</li>
</ul>
<p>高级部分就到此结束啦！掌握了这些内容，你就准备好构建可扩展并在生产环境中为用户提供服务的真实系统了。</p>
<h2 data-id="heading-7">奖金</h2>
<p>但正如承诺的那样，我们还有一个额外福利要送给超级高手们。</p>
<p>我们今天讨论的大部分内容都假定你正在使用像LangGraph或CrewAI这样的框架。但如果你是一名对了解Claude Code等智能体工具内部工作原理感兴趣的开发者，我强烈推荐这篇关于智能体系统设计的博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgerred.github.io%2Fbuilding-an-agentic-system%2Fcore-architecture.html" target="_blank" title="https://gerred.github.io/building-an-agentic-system/core-architecture.html" ref="nofollow noopener noreferrer">gerred.github.io/building-an…</a></p>
<p>它探讨了诸如三个核心层（终端 UI、大语言模型 “智能” 层和工具层）、如何使用异步生成器构建响应式命令循环、流式传输 + 工具调用模式，甚至还涉及一个并行执行引擎和智能工具调度（读与写），这些在底层与支撑 Claude Code 和 Cursor 的技术极为相似。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[墨梅博客 MVP 发布与草梅 Auth 更新 | 2025 年第 51 周草梅周报]]></title>    <link>https://juejin.cn/post/7585808181239136307</link>    <guid>https://juejin.cn/post/7585808181239136307</guid>    <pubDate>2025-12-21T14:53:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585808181239136307" data-draft-id="7585743487259312137" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="墨梅博客 MVP 发布与草梅 Auth 更新 | 2025 年第 51 周草梅周报"/> <meta itemprop="keywords" content="GitHub,开源,AI编程"/> <meta itemprop="datePublished" content="2025-12-21T14:53:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="草梅友仁"/> <meta itemprop="url" content="https://juejin.cn/user/3043088413495815"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            墨梅博客 MVP 发布与草梅 Auth 更新 | 2025 年第 51 周草梅周报
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3043088413495815/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    草梅友仁
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T14:53:02.000Z" title="Sun Dec 21 2025 14:53:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd" target="_blank" title="https://blog.cmyr.ltd" ref="nofollow noopener noreferrer">草梅友仁的博客</a> 发布和更新，并在多个平台同步发布。如有更新，以博客上的版本为准。您也可以通过文末的 <code>原文链接</code> 查看最新版本。</p>
</blockquote>
<h2 data-id="heading-0">前言</h2>
<p>欢迎来到草梅周报！这是一个由草梅友仁基于 AI 整理的周报，旨在为您提供最新的博客更新、GitHub 动态、个人动态和其他周刊文章推荐等内容。</p>
<hr/>
<p>本周在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fmomei" target="_blank" title="https://github.com/CaoMeiYouRen/momei" ref="nofollow noopener noreferrer">墨梅 (Momei)</a> 中。</p>
<blockquote>
<p>您可以前往官网试用：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmomei.app%2F" target="_blank" title="https://momei.app/" ref="nofollow noopener noreferrer">momei.app/</a></p>
<p>也可以前往文档站来了解项目整体规划和未来开发路线图：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.momei.app%2F" target="_blank" title="https://docs.momei.app/" ref="nofollow noopener noreferrer">docs.momei.app/</a></p>
</blockquote>
<p>经过一段时间的高强度开发，在把 GitHub Copilot 用到上限，甚至还额外支出了几美元之后，我终于可以宣布 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmomei.app%2F" target="_blank" title="https://momei.app/" ref="nofollow noopener noreferrer">墨梅博客</a> 已经到了可以初步使用的地步。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17a11bffd39e47c3bfa24a737fdf8521~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=kiU3%2FF8VfeqN6ViW1DYbzhdjzCo%3D" alt="QQ截图20251220232130" loading="lazy"/></p>
<p>当然了，距离真正上线肯定还有点距离，目前还存在不少问题要修。</p>
<p>不过作为一个开源项目，最重要的还是先把 MVP(最小可行性产品)版本端上来，先让用户看下大概的样子。</p>
<p>在当前进度中，已经完成了主页、文章页、登录注册页、后台管理页等多个页面的内容，并且支持国际化和暗色模式。</p>
<p>以下是部分页面的截图展示。</p>
<p>主页：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2288084f13a49f8ab5215d0e4d7e63f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=qvajEszFz51dCQzFhZqA7VyYEY8%3D" alt="QQ截图20251221215342" loading="lazy"/></p>
<p>文章列表页：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4764a6b7af1f4e1d98ab673e1a2c07b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=6xepqiou8BI1cC%2BeI415df4lv6k%3D" alt="QQ截图20251221215352" loading="lazy"/></p>
<p>正文页：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8125a12ed4494349a2d9b7512c818e2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=8Owmewzz9YYyhjP9G3eH6ZshiQc%3D" alt="QQ截图20251221221235" loading="lazy"/></p>
<p>登录注册页：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c56beac9cb4452ebbe51daa3127b4ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=DPa1Iy6Q%2F3bsTY6VwW8fursb%2B3s%3D" alt="QQ截图20251221215644" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75e5b62491d04edf8daa3ad2bbaec282~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=LGGQabNewYWCB7CyFN5gW%2FZpg1s%3D" alt="QQ截图20251221215658" loading="lazy"/></p>
<p>国际化演示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81f1cad24e144ca79f7cff3b25cebd4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=NAxAE6D%2Fi32vBcVotkbGkgkuGI8%3D" alt="QQ截图20251221215127" loading="lazy"/></p>
<p>暗色模式演示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd3c3999ec204f5ab8f7ee83fa7bf029~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5qKF5Y-L5LuB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766975816&amp;x-signature=57wBOeywHbZBIjgBR5sqdxbrdmg%3D" alt="QQ截图20251221215117" loading="lazy"/></p>
<p>当然，目前墨梅博客还有很多需要打磨的细节，页面和功能上也还不完善，如有任何意见和建议，都可以在项目的  <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fmomei%2Fissues" target="_blank" title="https://github.com/CaoMeiYouRen/momei/issues" ref="nofollow noopener noreferrer">GitHub issues</a> 中提出。</p>
<blockquote>
<p>墨梅博客的 demo 站也会在后续部署。</p>
</blockquote>
<p>如果你也对墨梅博客感兴趣，欢迎参与开发和测试。</p>
<hr/>
<p>本周依旧在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcaomei-auth" target="_blank" title="https://github.com/CaoMeiYouRen/caomei-auth" ref="nofollow noopener noreferrer">草梅 Auth</a> 中。</p>
<blockquote>
<p>你也可以直接访问官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fauth.cmyr.dev%2F" target="_blank" title="https://auth.cmyr.dev/" ref="nofollow noopener noreferrer">auth.cmyr.dev/</a>
Demo 站：<a href="https://link.juejin.cn?target=https%3A%2F%2Fauth-demo.cmyr.dev%2F" target="_blank" title="https://auth-demo.cmyr.dev/" ref="nofollow noopener noreferrer">auth-demo.cmyr.dev/</a>
文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fauth-docs.cmyr.dev%2F" target="_blank" title="https://auth-docs.cmyr.dev/" ref="nofollow noopener noreferrer">auth-docs.cmyr.dev/</a></p>
</blockquote>
<p>本周 草梅 Auth 发布了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcaomei-auth%2Freleases%2Ftag%2Fv1.12.1" target="_blank" title="https://github.com/CaoMeiYouRen/caomei-auth/releases/tag/v1.12.1" ref="nofollow noopener noreferrer">1.12.1</a> 版本。</p>
<p>本周主要是进行了 BUG 修复，以及替换 sqlite3 的数据库驱动为 better-sqlite3，以支持新版版本的 Node.js</p>
<p>如果你对草梅 Auth 感兴趣，欢迎参与开发和测试。</p>
<h2 data-id="heading-1">GitHub Release</h2>
<h3 data-id="heading-2">caomei-auth</h3>
<h4 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcaomei-auth%2Freleases%2Ftag%2Fv1.12.1" target="_blank" title="https://github.com/CaoMeiYouRen/caomei-auth/releases/tag/v1.12.1" ref="nofollow noopener noreferrer">v1.12.1</a> - 2025-12-20 20:14:35</h4>
<p>摘要:
版本 1.12.1 (2025-12-20) 摘要：</p>
<p>Bug 修复：</p>
<ol>
<li>修正了 revokeConsentSchema 中 clientId 的错误提示信息格式问题</li>
<li>新增 secureRandom 函数以提高随机数生成的安全性</li>
<li>将数据库驱动更新为 better-sqlite3，并相应调整了配置</li>
</ol>
<h3 data-id="heading-4">cmyr-template-cli</h3>
<h4 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoMeiYouRen%2Fcmyr-template-cli%2Freleases%2Ftag%2Fv1.43.0" target="_blank" title="https://github.com/CaoMeiYouRen/cmyr-template-cli/releases/tag/v1.43.0" ref="nofollow noopener noreferrer">v1.43.0</a> - 2025-12-18 21:15:33</h4>
<p>摘要:
版本 1.43.0 更新摘要：</p>
<p>新功能：</p>
<ul>
<li>新增支持创建 GitHub 仓库分支保护规则的功能</li>
</ul>
<p>Bug 修复：</p>
<ul>
<li>移除了 catch 块中的错误参数，简化了错误处理流程</li>
</ul>
<h2 data-id="heading-6">最新 GitHub 加星仓库</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fhinesboy%2FmavonEditor" target="_blank" title="https://github.com/hinesboy/mavonEditor" ref="nofollow noopener noreferrer">CaoMeiYouRen starred mavonEditor</a> - 2025-12-20 23:26:42
基于 Vue 的 Markdown 编辑器，支持多种个性化功能。主要开发语言为 Vue，获得 6581 个星标。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FAyayaXiaowang%2FAyaya_Miliastra_Editor" target="_blank" title="https://github.com/AyayaXiaowang/Ayaya_Miliastra_Editor" ref="nofollow noopener noreferrer">CaoMeiYouRen starred Ayaya_Miliastra_Editor</a> - 2025-12-19 21:49:47
支持使用 Python 代码描述节点图，系统内置引擎可解析验证并自动排版，结合自动化脚本将步骤精准映射到实际编辑器。主要开发语言为 Python，项目获得 149 个星标。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgo-gitea%2Fgitea" target="_blank" title="https://github.com/go-gitea/gitea" ref="nofollow noopener noreferrer">CaoMeiYouRen starred gitea</a> - 2025-12-18 21:19:11
基于 Go 语言开发的一体化软件开发服务平台，提供 Git 托管、代码审查、团队协作、包注册表和 CI/CD 功能。该平台采用自托管方式，设计理念强调简单易用，目前已在 GitHub 获得超过 52,000 颗星标。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FheyManNice%2Fbili-cured-my-neck-pain" target="_blank" title="https://github.com/heyManNice/bili-cured-my-neck-pain" ref="nofollow noopener noreferrer">CaoMeiYouRen starred bili-cured-my-neck-pain</a> - 2025-12-15 17:34:52
B 站 PC 网页版新增视频旋转和缩放功能，使用 TypeScript 开发。该项目已获得 52 个星标。</li>
</ul>
<h2 data-id="heading-7">其他博客或周刊推荐</h2>
<h3 data-id="heading-8">阮一峰的网络日志</h3>
<ul>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2025%2F12%2Fweekly-issue-378.html" target="_blank" title="http://www.ruanyifeng.com/blog/2025/12/weekly-issue-378.html" ref="nofollow noopener noreferrer">科技爱好者周刊（第 378 期）：预测是新的互联网热点</a> - 2025-12-19 08:06:47</li>
</ul>
<h3 data-id="heading-9">阿猫的博客</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fameow.xyz%2Farchives%2Fweekly-089" target="_blank" title="https://ameow.xyz/archives/weekly-089" ref="nofollow noopener noreferrer">猫鱼周刊 vol. 089 Vibe Engineering</a> - 2025-12-21 20:21:28</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fameow.xyz%2Farchives%2Fweekly-088" target="_blank" title="https://ameow.xyz/archives/weekly-088" ref="nofollow noopener noreferrer">猫鱼周刊 vol. 088 两个 Linus 的史诗级会面</a> - 2025-12-14 23:25:30</li>
</ul>
<h3 data-id="heading-10">潮流周刊</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.tw93.fun%2Fposts%2F250%2F" target="_blank" title="https://weekly.tw93.fun/posts/250/" ref="nofollow noopener noreferrer">第 250 期 - 北京的冬</a> - 2025-12-22 08:00:00</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.tw93.fun%2Fposts%2F249%2F" target="_blank" title="https://weekly.tw93.fun/posts/249/" ref="nofollow noopener noreferrer">第 249 期 - 美洲红鹮</a> - 2025-12-15 08:00:00</li>
</ul>
<h2 data-id="heading-11">总结</h2>
<p>本周的更新和动态如上所示。感谢您的阅读！
您可以通过以下方式订阅草梅周报的更新：</p>
<ul>
<li><strong>博客</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd" target="_blank" title="https://blog.cmyr.ltd" ref="nofollow noopener noreferrer">草梅友仁的博客</a></li>
<li><strong>墨梅博客</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmomei.app" target="_blank" title="https://momei.app" ref="nofollow noopener noreferrer">墨梅博客</a></li>
<li><strong>RSS</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Fweekly.xml" target="_blank" title="https://blog.cmyr.ltd/weekly.xml" ref="nofollow noopener noreferrer">草梅周报</a></li>
<li><strong>公众号</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Foss.cmyr.dev%2Fimages%2F20241025184516839-21n2ctv.png" target="_blank" title="https://oss.cmyr.dev/images/20241025184516839-21n2ctv.png" ref="nofollow noopener noreferrer">草梅友仁的后花园</a></li>
<li><strong>邮箱订阅</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Flistmonk.cmyr.dev%2Fsubscription%2Fform" target="_blank" title="https://listmonk.cmyr.dev/subscription/form" ref="nofollow noopener noreferrer">草梅友仁的博客订阅</a></li>
</ul>
<h2 data-id="heading-12">往期回顾</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-50-caomei-weekly-caomei-auth-1-12-0-momei-blog.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-50-caomei-weekly-caomei-auth-1-12-0-momei-blog.html" ref="nofollow noopener noreferrer">草梅 Auth 1.12.0 发布与墨梅博客立项经验 | 2025 年第 50 周草梅周报</a> - 2025-12-14 20:25:28</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-49-caomei-weekly-caomei-auth-1-11-1-release-and-ai-refactoring.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-49-caomei-weekly-caomei-auth-1-11-1-release-and-ai-refactoring.html" ref="nofollow noopener noreferrer">草梅 Auth 1.11.1 版本发布与 AI 辅助代码重构实践 | 2025 年第 49 周草梅周报</a> - 2025-12-07 20:10:31</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-48-caomei-weekly-nano-banana-pro-ai-image-generation.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-48-caomei-weekly-nano-banana-pro-ai-image-generation.html" ref="nofollow noopener noreferrer">Nano Banana Pro AI 图像生成模型与创意实践 | 2025 年第 48 周草梅周报</a> - 2025-11-30 20:30:59</li>
</ul>
<p>本文作者：草梅友仁<br/>本文地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.cmyr.ltd%2Farchives%2F2025-51-caomei-weekly-momei-blog-mvp-caomei-auth-update.html" target="_blank" title="https://blog.cmyr.ltd/archives/2025-51-caomei-weekly-momei-blog-mvp-caomei-auth-update.html" ref="nofollow noopener noreferrer">blog.cmyr.ltd/archives/20…</a><br/>版权声明：本文采用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcreativecommons.org%2Flicenses%2Fby-nc-sa%2F4.0%2Fdeed.zh-hans" target="_blank" title="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans" ref="nofollow noopener noreferrer">CC BY-NC-SA 4.0 协议</a> 进行分发，转载请注明出处！<br/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[无人机低空视觉数据集全景解读：从单机感知到具身智能的跨越]]></title>    <link>https://juejin.cn/post/7585929179319566371</link>    <guid>https://juejin.cn/post/7585929179319566371</guid>    <pubDate>2025-12-22T02:48:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585929179319566371" data-draft-id="7585850609017061391" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="无人机低空视觉数据集全景解读：从单机感知到具身智能的跨越"/> <meta itemprop="keywords" content="算法,深度学习,计算机视觉"/> <meta itemprop="datePublished" content="2025-12-22T02:48:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            无人机低空视觉数据集全景解读：从单机感知到具身智能的跨越
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:48:20.000Z" title="Mon Dec 22 2025 02:48:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>年来，随着无人机技术的快速发展和低空经济政策的推进，无人机在智慧城市、交通巡检、应急救援等领域的应用日益广泛。然而，无人机的智能化离不开高质量视觉数据的支持。那么，当前有哪些公开的低空视觉数据集？它们又如何分类、有何特点？未来又将如何发展？</p>
<p>本文系统梳理近11年来低空无人机视觉数据集的发展脉络，为研究人员与应用开发者提供清晰的认知框架与实践参考。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c079482600534650af9b9e45b287c3e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=u%2BUK0w5drpVvrWJrxYLVYm0yMaQ%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>空视觉数据集：为什么如此重要？</strong></h2>
<p>低空视觉感知是无人机获取环境信息、实现自主决策的关键技术。无论是目标检测、跟踪、语义分割，还是无人机自主导航与协同作业，都离不开大量高质量、多样化的标注数据。</p>
<p>公开数据集的发布，不仅推动了算法研究的标准化，也降低了研究门槛，加速了技术落地。然而，随着任务复杂化和场景多元化，单一类型的数据已难以满足需求。因此，系统梳理现有数据集，明确其特点与适用场景，显得尤为重要。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96a2dcc979784b63880900a49611a8fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=WtvSuidyXXrFDsDG2Dx0IDac7j0%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1"><strong>五大维度解析低空视觉数据集</strong></h2>
<p>论文提出了一套基于设备类型、任务需求、模态类型、环境特性、应用需求五大方向的分类体系，全面覆盖低空视觉数据集的构建逻辑与应用场景。</p>
<ul>
<li><strong>设备类型：单机 vs 多机</strong></li>
</ul>

<ul>
<li>单机数据集：由单一无人机采集，视角固定，适用于特定场景下的目标检测、跟踪等任务。代表数据集包括VisDrone、UAV123、AnimalDrone等。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2cebeed6c9c46bea3dcd79cd2d562d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=TJOwlAQdm8Q26jx0%2BJU%2BXEQVJgQ%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>多机协同数据集：由多架无人机协同采集，覆盖多视角、跨场景，适用于立体安防、广域监测等高可靠性任务。代表数据集有MDOT、CoPerception-UAVs、MAVREC等。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53671fadf524442caf1c932f1a110b45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=Vti6kTZTTvETmkM5Y1an7OgWXw0%3D" alt="图片" loading="lazy"/></p>
<p>展示了DOTA、SDD、DroneVehicle等数据集的典型图像，涵盖白天与夜间场景。</p>
<ul>
<li><strong>任务需求：单任务 vs 多任务</strong></li>
</ul>

<ul>
<li>单一任务数据集：专注如车辆检测、行人跟踪等单一任务，标注粒度集中。如VEDAI、COWC等。</li>
<li>多任务数据集：支持目标检测、跟踪、计数、行为分析等多个任务，标注信息更丰富。如VisDrone、DroneCrowd、UAV-Human等。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74dfdb8e72854a8c956400a3bf294b3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=IqDqoPbsqlYS%2Bfz5HUdATL7WnIo%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>模态类型：单源 vs 多源</strong></li>
</ul>

<ul>
<li>单源数据集：仅包含可见光或红外等单一模态数据，适用于常规场景。</li>
<li>多源数据集：融合可见光、红外、深度、LiDAR等多种传感器数据，提升在夜间、遮挡等复杂场景下的感知鲁棒性。代表数据集包括DroneVehicle、DroneRGBT、UAV-Human等。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e97660cf247415cab3a87e409c99463~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=Fek%2FAIc947TKmcf8lLo%2F7VA3NsM%3D" alt="图片" loading="lazy"/></p>
<p>展示了DroneVehicle、FIReStereo、SynDrone等多源数据的融合示例。</p>
<ul>
<li><strong>环境特性：复杂场景下的数据挑战</strong></li>
</ul>
<p>复杂环境数据集涵盖雾天、雨天、运动模糊、低光照等恶劣条件，用于提升模型在真实场景中的鲁棒性。代表数据集有HazyDet、UAVDT、UAV-AWID等。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/464cf1f3469348299840fa3965d78c3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=3Kpmb98F0S3zvTUkZZ5BIVUMRag%3D" alt="图片" loading="lazy"/></p>
<p>展示了雾天、雨天、运动模糊等复杂场景下的图像示例。</p>
<ul>
<li><strong>应用需求：视觉感知 vs 具身智能</strong></li>
</ul>

<ul>
<li>视觉感知数据集：侧重于目标识别与环境理解。</li>
<li>具身智能数据集：融合无人机状态、环境语义与任务指令，支持自主导航与决策。如CityNav、AeroVerse、OpenUAV等。</li>
</ul>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c63a0a4e6f8244eb804108872c6134c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=lwRnnTxDBM0lm7oHMW3Sb5hLqYI%3D" alt="图片" loading="lazy"/></p>
<p>展示基于语言指令的无人机目标导航任务场景。</p>
<h2 data-id="heading-2"><strong>典型数据集深度解析</strong></h2>
<p>论文对各类别中的典型数据集进行了详细分析，涵盖数据规模、标注特点、适用任务等关键信息。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbe0b2abdce34b9fa4908ecf07a75da4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=x6fh5X%2BXuKNTTqrPoN8J2jZkXK4%3D" alt="图片" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbd72fb0602b4441a55c6385cf6fc430~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=pxhbdF3btwymFPs0qvidJxAxUFw%3D" alt="图片" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d7e8d92f62a424abeb26343c5cd2e1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=xRyKWKejEy4brgAYPwyJ0P3%2BtAw%3D" alt="图片" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11ea8687d097455482bd56695bf78c5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=4iY8qCae3y7X04sKeduhY8M%2F374%3D" alt="图片" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/241e0c5994354a97ad816ba1810e8be4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=jNunAMsSPRoytRSuNXwP%2FFour3c%3D" alt="图片" loading="lazy"/></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d605b56a772347e4b986b7adb44c8840~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=ZO2XF56iVE5uCFAdE4YHsDQDPoo%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>单机数据集代表：VisDrone</strong></li>
</ul>
<p>发布年份：2018</p>
<p>数据量：超2000万张图像</p>
<p>特点：覆盖14个中国城市、多种天气与光照条件，支持检测、跟踪、计数等多任务。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/661f31660cca41188275e0d77cbd73ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=qz5UuYSPnx8HIqdGwDa8x0h%2FDUs%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>多机协同数据集代表：MDOT</strong></li>
</ul>
<p>发布年份：2021</p>
<p>特点：包含双机与三机协同数据，标注10种场景属性，支持多视角目标跟踪。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a13f807f76a4717bf8167771f9eddcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=L7mrcB37a3PigqGwE3nnuUWZLZc%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>多任务数据集代表：DroneCrowd</strong></li>
</ul>
<p>发布年份：2021</p>
<p>特点：专注于无人机视角下的人群密度估计与行为分析，标注480万个头部位置。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ba8b3bf4fa647b9aeba5250ac0df997~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=dCCftwUsSR9vgFSRqMI3ei9y3Qk%3D" alt="图片" loading="lazy"/></p>
<ul>
<li><strong>多源数据集代表：DroneVehicle</strong></li>
</ul>
<p>发布年份：2020</p>
<p>特点：包含2.8万对RGB-红外图像，支持跨模态车辆检测，提升全天候感知能力。</p>
<ul>
<li><strong>具身智能数据集代表：AeroVerse</strong></li>
</ul>
<p>发布年份：2024</p>
<p>特点：融合视觉、语言与导航指令，支持无人机在复杂城市场景中的语义导航与任务规划。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cf64aea48854bdfb0cddcb7dd333d22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766976500&amp;x-signature=UTZDUEDJXK%2FkLFces7sj%2BKdQrV0%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-3"><strong>现状总结与未来展望</strong></h2>
<p>当前进展：</p>
<p>数据集体系初步形成，覆盖单机、多机、多任务、多源等多个维度。</p>
<p>数据规模与质量显著提升，推动了感知算法性能的进步。</p>
<p>仍存挑战：</p>
<p>标注成本高、效率低：尤其在多任务、多源场景下，人工标注仍占主导。</p>
<p>多源数据对齐难：不同模态数据之间存在时空同步误差。</p>
<p>极端环境数据稀缺：雨雪、雾霾等恶劣天气数据覆盖不足。</p>
<p>具身智能数据割裂：环境感知与无人机状态数据缺乏深度融合。</p>
<p>未来发展方向：</p>
<p>提升数据多样性与标注效率：结合合成数据与半自动标注技术。</p>
<p>推动多源数据标准化：制定统一的对齐、存储与评估标准。</p>
<p>加强极端环境数据建设：与气象部门合作，构建量化标注体系。</p>
<p>深化具身智能数据融合：构建“环境-机体-任务”一体化的数据集框架。</p>
<h2 data-id="heading-4"><strong>总结</strong></h2>
<p>低空视觉数据集作为无人机智能化的基石，正朝着多源融合、动态适应、语义理解、自主协同的方向快速发展。未来，随着仿真技术、自动化标注与跨模态学习方法的进步，我们有望构建更智能、更鲁棒、更贴近真实世界的低空视觉数据生态系统，赋能无人机在物流、安防、农业、救援等领域的深层次应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文读懂分布式事务：核心原理、解决方案与实践思考]]></title>    <link>https://juejin.cn/post/7586481379590078483</link>    <guid>https://juejin.cn/post/7586481379590078483</guid>    <pubDate>2025-12-22T02:49:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586481379590078483" data-draft-id="7585778343352188991" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文读懂分布式事务：核心原理、解决方案与实践思考"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-12-22T02:49:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文读懂分布式事务：核心原理、解决方案与实践思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:49:43.000Z" title="Mon Dec 22 2025 02:49:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一文读懂分布式事务：核心原理、解决方案与实践思考</h2>
<p>在单体应用时代，我们对事务的认知大多停留在“ACID”层面——一个操作要么全成，要么全败，数据库本身（如MySQL的InnoDB引擎）就能很好地保障这一点。但随着业务发展，系统拆分为微服务架构后，数据被分散到不同的数据库实例甚至不同类型的存储中间件中，“分布式事务”这个难题就摆在了我们面前。</p>
<p>比如电商下单场景：用户支付成功后，需要同时完成“扣减库存”“更新订单状态”“增加商家账户余额”三个操作，这三个操作分别对应库存服务、订单服务、账户服务的数据库。如何保证这三个操作要么全部成功，要么全部回滚？这就是分布式事务要解决的核心问题。今天，我们就从基础概念出发，拆解分布式事务的核心挑战，梳理主流解决方案，并聊聊实际落地中的取舍。</p>
<h3 data-id="heading-1">一、分布式事务的核心：为什么单体事务不适用了？</h3>
<p>首先要明确：分布式事务的本质是“跨多个资源节点的事务协调”，其核心目标依然是保障数据的一致性，但由于“分布式”的特性，单体事务的保障机制失效了。</p>
<p>在单体应用中，事务由数据库直接管理，依托本地锁和日志就能实现ACID：</p>
<ul>
<li>原子性（Atomicity）：依赖数据库的undo log，失败时回滚；</li>
<li>一致性（Consistency）：由业务逻辑和数据库约束共同保障；</li>
<li>隔离性（Isolation）：依赖数据库锁机制，避免并发问题；</li>
<li>持久性（Durability）：依赖数据库的redo log，确保提交后数据不丢失。</li>
</ul>
<p>但在分布式场景下，多个数据库实例之间无法共享锁和日志，存在三个核心挑战：</p>
<ol>
<li>网络不可靠：服务间通信可能出现延迟、超时、丢包，导致“部分操作成功、部分失败”；</li>
<li>节点故障：某个服务的数据库宕机，可能导致该节点的操作未完成，其他节点已完成；</li>
<li>数据分散：不同节点的数据无法实时同步，难以判断全局事务的状态。</li>
</ol>
<p>为了应对这些挑战，行业提出了多种分布式事务解决方案，核心思路都是“通过协调机制，确保多个节点的操作最终达成一致”，但在一致性、可用性、性能上各有取舍。</p>
<h3 data-id="heading-2">二、分布式事务主流解决方案：从理论到实践</h3>
<p>聊解决方案前，先提一个重要理论——CAP定理：分布式系统中，一致性（Consistency）、可用性（Availability）、分区容错性（Partition Tolerance）三者不可兼得，只能选其二。分布式事务的解决方案，本质上都是在CAP定理下的权衡。下面我们逐一拆解主流方案：</p>
<h4 data-id="heading-3">1. 2PC（两阶段提交）：最经典的“强一致性”方案</h4>
<p>2PC是分布式事务的“元老级”方案，核心思路是“分阶段协调”，引入一个“事务协调者”（TC）来统一管理所有参与者（TM，即各个服务的数据库）的事务状态。</p>
<p>两个阶段具体如下：</p>
<ul>
<li>准备阶段（Prepare）：协调者向所有参与者发送“准备请求”，参与者执行本地事务（但不提交），记录undo/redo log，然后向协调者返回“准备成功”或“准备失败”；</li>
<li>提交阶段（Commit/Rollback）：如果协调者收到所有参与者的“准备成功”，则发送“提交请求”，参与者执行提交操作并释放资源；如果有任何一个参与者返回“准备失败”，则发送“回滚请求”，参与者通过undo log回滚事务。</li>
</ul>
<p>优点：实现简单，强一致性，符合ACID；</p>
<p>缺点：① 性能差：准备阶段会锁定资源，直到整个分布式事务完成，并发场景下吞吐量低；② 可用性低：协调者是单点故障，若协调者宕机，所有参与者会处于“等待状态”，资源无法释放；③ 脑裂问题：若协调者在发送提交请求时宕机，部分参与者可能收到请求并提交，部分未收到，导致数据不一致。</p>
<p>适用场景：对一致性要求极高、并发量低的场景，如金融核心交易（但现在金融场景也更多用优化方案）。</p>
<h4 data-id="heading-4">2. 3PC（三阶段提交）：优化2PC的可用性问题</h4>
<p>3PC在2PC的基础上增加了“预提交阶段”，并引入了“超时机制”，试图解决2PC的单点故障和资源锁定问题。</p>
<p>三个阶段：</p>
<ul>
<li>CanCommit阶段：协调者询问参与者“是否可以执行事务”，参与者仅做可行性检查（不执行事务），返回yes/no；</li>
<li>PreCommit阶段：协调者收到所有yes后，发送“预提交请求”，参与者执行本地事务（不提交）；若有no，发送“中断请求”；</li>
<li>DoCommit阶段：协调者确认所有参与者预提交成功后，发送“提交请求”；若超时未收到确认，默认执行提交（区别于2PC的等待）。</li>
</ul>
<p>优点：解决了2PC协调者宕机后的资源锁定问题，可用性略有提升；</p>
<p>缺点：依然存在脑裂风险（如部分参与者未收到DoCommit请求，默认提交，而其他参与者回滚），且实现更复杂，实际应用较少。</p>
<h4 data-id="heading-5">3. TCC（Try-Confirm-Cancel）：柔性事务的“高性能”方案</h4>
<p>TCC是一种“业务侵入式”的柔性事务方案，核心思路是“将分布式事务拆分为三个本地事务”，由业务代码实现一致性，不依赖数据库的事务机制。</p>
<p>三个阶段的定义需要业务开发人员手动实现：</p>
<ul>
<li>Try阶段：尝试执行事务，做业务检查（如库存是否充足），并锁定资源（如冻结部分库存，而非直接扣减）；</li>
<li>Confirm阶段：确认执行事务，将Try阶段的锁定资源转为实际操作（如将冻结的库存扣减），该阶段必须保证成功；</li>
<li>Cancel阶段：取消事务，释放Try阶段锁定的资源（如解冻冻结的库存），恢复到初始状态。</li>
</ul>
<p>优点：① 性能高：所有操作都是本地事务，无锁等待，适合高并发场景；② 灵活性强：可根据业务定制逻辑，支持非关系型数据库（如Redis、MongoDB）；</p>
<p>缺点：① 业务侵入性强：需要开发人员手动实现Try/Confirm/Cancel三个接口，开发成本高；② 需处理幂等性：Confirm和Cancel可能因网络重试被多次调用，需保证重复执行结果一致；③ 补偿逻辑复杂：如Cancel阶段失败，需要人工介入处理。</p>
<p>适用场景：高并发、对一致性要求不是“强实时”的场景，如电商下单、支付退款。</p>
<h4 data-id="heading-6">4. SAGA模式：长事务的“补偿型”方案</h4>
<p>SAGA模式适用于“长事务”场景（如跨多个服务的复杂流程，执行时间长），核心思路是“将分布式事务拆分为一系列本地事务，每个本地事务完成后提交，若某个步骤失败，则通过补偿事务回滚前面所有已完成的步骤”。</p>
<p>SAGA有两种实现方式：</p>
<ul>
<li>编排式：引入一个“编排器”，由编排器统一协调所有本地事务的执行顺序和补偿顺序（如A→B→C成功，则正常结束；若C失败，则执行C的补偿→B的补偿→A的补偿）；</li>
<li>协同式：无编排器，每个服务通过消息通知下一个服务执行，失败时由当前服务通知上一个服务执行补偿（耦合度高，不推荐）。</li>
</ul>
<p>优点：① 支持长事务：无需锁定资源，适合执行时间长的场景；② 可用性高：每个本地事务独立提交，失败后通过补偿恢复；③ 低侵入性（编排式）：补偿逻辑由业务实现，但编排器统一管理流程；</p>
<p>缺点：① 一致性弱：属于最终一致性，中间状态可能存在数据不一致（如A、B已提交，C未提交，补偿前数据处于中间态）；② 补偿逻辑复杂：需为每个本地事务设计对应的补偿事务，且补偿事务可能失败。</p>
<p>适用场景：长事务场景，如供应链管理（采购→入库→付款→物流）、订单履约流程。</p>
<h4 data-id="heading-7">5. 本地消息表（事务消息）：基于消息队列的最终一致性方案</h4>
<p>该方案的核心思路是“将分布式事务转化为消息的可靠投递和消费”，依托消息队列的可靠性（如RocketMQ的事务消息、Kafka的事务机制），实现最终一致性。经典实现是“本地消息表+消息队列”：</p>
<ol>
<li>第一步：在发起方的数据库中创建“本地消息表”，记录需要发送的消息；</li>
<li>第二步：发起方执行本地事务（如扣减库存），并将消息插入本地消息表（同一本地事务，确保原子性）；</li>
<li>第三步：通过定时任务或消息队列的事务机制，将本地消息表中的消息投递到消息队列；</li>
<li>第四步：接收方消费消息，执行本地事务（如更新订单状态）；若消费失败，消息队列重试，直到消费成功；</li>
<li>第五步：发起方确认消息已被消费，删除本地消息表中的记录。</li>
</ol>
<p>优点：① 低侵入性：无需修改核心业务逻辑，仅需增加消息表和投递逻辑；② 高可用性：依托消息队列的重试机制，容错性强；③ 性能好：本地事务执行后异步投递消息，无锁等待；</p>
<p>缺点：① 一致性弱：属于最终一致性，存在中间态；② 需处理幂等性：消息可能被重复投递，接收方需保证重复消费无副作用；③ 仅适用于“一发起方多接收方”的单向流程，不支持复杂的双向交互。</p>
<p>适用场景：异步通知类场景，如电商下单后通知库存、物流、账户服务，用户注册后通知积分、消息服务。</p>
<h3 data-id="heading-8">三、解决方案选型：没有最好，只有最合适</h3>
<p>分布式事务的解决方案没有“银弹”，选型时需结合业务场景的一致性要求、并发量、系统复杂度等因素综合判断，以下是常见的选型建议：</p>



































<table><thead><tr><th>选型维度</th><th>推荐方案</th><th>不推荐方案</th></tr></thead><tbody><tr><td>强一致性、低并发</td><td>2PC（如金融核心交易）</td><td>TCC、SAGA（一致性不足）</td></tr><tr><td>高并发、最终一致性</td><td>TCC、本地消息表</td><td>2PC（性能差）</td></tr><tr><td>长事务、多步骤流程</td><td>SAGA模式（编排式）</td><td>2PC、3PC（资源锁定久）</td></tr><tr><td>异步通知、单向流程</td><td>本地消息表（事务消息）</td><td>TCC（开发成本高）</td></tr><tr><td>非关系型数据库场景</td><td>TCC、SAGA</td><td>2PC、3PC（依赖数据库事务）</td></tr></tbody></table>
<h3 data-id="heading-9">四、实际落地的关键注意事项</h3>
<p>无论选择哪种方案，落地时都需要关注以下几个核心问题，否则容易出现数据不一致：</p>
<ol>
<li>幂等性设计：所有分布式事务的参与者（尤其是补偿操作、消息消费）必须支持幂等，避免重复执行导致数据错误（如重复扣减库存）。常见方案：使用唯一ID（如订单号）作为幂等键，执行前先检查是否已处理；</li>
<li>超时处理：明确各阶段的超时时间，避免无限等待导致资源锁定或数据积压。如TCC的Try阶段超时，直接执行Cancel；消息消费超时，触发重试；</li>
<li>日志与监控：完善分布式事务的日志记录（如各阶段状态、执行时间、错误信息），便于问题排查；同时建立监控告警，及时发现事务失败、重试频繁等异常情况；</li>
<li>人工介入机制：对于无法自动补偿的异常（如补偿事务失败、数据损坏），必须提供人工介入通道，避免数据不一致长期存在。</li>
</ol>
<h3 data-id="heading-10">五、总结</h3>
<p>分布式事务的核心是“在分布式环境下保障数据一致性”，而其本质是CAP定理下的权衡——强一致性必然牺牲可用性和性能，最终一致性则通过牺牲实时性换取高可用和高并发。</p>
<p>实际开发中，我们不必追求“完美的一致性”，而是要根据业务场景选择合适的方案：金融核心场景优先保证强一致性（2PC），电商高并发场景优先选择最终一致性（TCC、本地消息表），长事务场景选择SAGA模式。同时，做好幂等性、超时处理、监控告警等落地细节，才能真正保障分布式事务的稳定运行。</p>
<p>最后，记住一个原则：能避免分布式事务，就尽量避免。通过业务设计（如合并服务、数据冗余）减少跨服务的数据操作，才是解决分布式事务问题的最优解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零实现富文本编辑器#9-编辑器文本结构变更的受控处理]]></title>    <link>https://juejin.cn/post/7585778343352221759</link>    <guid>https://juejin.cn/post/7585778343352221759</guid>    <pubDate>2025-12-22T02:50:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585778343352221759" data-draft-id="7585825055437586438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零实现富文本编辑器#9-编辑器文本结构变更的受控处理"/> <meta itemprop="keywords" content="前端,GitHub,架构"/> <meta itemprop="datePublished" content="2025-12-22T02:50:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WindRunnerMax"/> <meta itemprop="url" content="https://juejin.cn/user/1829999989247214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零实现富文本编辑器#9-编辑器文本结构变更的受控处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1829999989247214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WindRunnerMax
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T02:50:48.000Z" title="Mon Dec 22 2025 02:50:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>先前我们主要处理了浏览器复杂<code>DOM</code>结构的默认行为，以及兼容<code>IME</code>输入法的各种输入场景，以此需要针对性地处理输入法和浏览器兼容的行为。在这里我们关注于处理文本结构性变更行为的处理，主要是针对行级别的操作、文本拖拽操作等，分别处于文本结构结构以及变更操作扩展。</p>
<ul>
<li>开源地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FBlockKit" target="_blank" title="https://github.com/WindRunnerMax/BlockKit" ref="nofollow noopener noreferrer">github.com/WindRunnerM…</a></li>
<li>在线编辑: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwindrunnermax.github.io%2FBlockKit%2F" target="_blank" title="https://windrunnermax.github.io/BlockKit/" ref="nofollow noopener noreferrer">windrunnermax.github.io/BlockKit/</a></li>
<li>项目笔记: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FBlockKit%2Fblob%2Fmaster%2FNOTE.md" target="_blank" title="https://github.com/WindRunnerMax/BlockKit/blob/master/NOTE.md" ref="nofollow noopener noreferrer">github.com/WindRunnerM…</a></li>
</ul>
<details>
<summary><strong>从零实现富文本编辑器系列文章</strong></summary>
<ul>
<li><a href="https://juejin.cn/post/7490554094412611636" target="_blank" title="https://juejin.cn/post/7490554094412611636">深感一无所长，准备试着从零开始写个富文本编辑器</a></li>
<li><a href="https://juejin.cn/post/7492339631700377652" target="_blank" title="https://juejin.cn/post/7492339631700377652">从零实现富文本编辑器#2-基于MVC模式的编辑器架构设计</a></li>
<li><a href="https://juejin.cn/post/7494920513967112227" target="_blank" title="https://juejin.cn/post/7494920513967112227">从零实现富文本编辑器#3-基于Delta的线性数据结构模型</a></li>
<li><a href="https://juejin.cn/post/7508648111485665295" target="_blank" title="https://juejin.cn/post/7508648111485665295">从零实现富文本编辑器#4-浏览器选区模型的核心交互策略</a></li>
<li><a href="https://juejin.cn/post/7513183180091523107" target="_blank" title="https://juejin.cn/post/7513183180091523107">从零实现富文本编辑器#5-编辑器选区模型的状态结构表达</a></li>
<li><a href="https://juejin.cn/post/7534162607894347828" target="_blank" title="https://juejin.cn/post/7534162607894347828">从零实现富文本编辑器#6-浏览器选区与编辑器选区模型同步</a></li>
<li><a href="https://juejin.cn/post/7544561402783793192" target="_blank" title="https://juejin.cn/post/7544561402783793192">从零实现富文本编辑器#7-基于组合事件的半受控输入模式</a></li>
<li><a href="https://juejin.cn/post/7562526517516812331" target="_blank" title="https://juejin.cn/post/7562526517516812331">从零实现富文本编辑器#8-浏览器输入模式的非受控DOM行为</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">从零实现富文本编辑器#9-编辑器文本结构变更的受控处理</a></li>
</ul>
</details>
<h2 data-id="heading-0">概述</h2>
<p>在当前我们主要聊的编辑器输入模式中，主要是关注于文本的半受控输入以及脏<code>DOM</code>的检测，输入状态同步是比较复杂且容易出问题的地方。而在这里我们则关注于输入同步行为扩展，例如回车、删除、拖拽文本等操作，相当于完善了编辑器整体输入模式的处理。</p>
<p>具体来说，执行换行和删除回车时会变更<code>DOM</code>结构，而删除文本以及拖拽文本同样是由<code>BeforeInput</code>等事件组合执行的，在编辑器中这些操作都是输入的一部分。此外，这些操作通常都是可以受控处理的，因此并不太容易出现脏<code>DOM</code>的问题，但是整体上还是有很多需要注意的点:</p>
<ul>
<li>回车操作通常需要拆分当前行结构，并且还需要关注到行格式的继承问题，特别是类似于列表等结构处理起来会更复杂一些。此外由于数据结构本身的设计不同，回车的操作实现也会有很大的差异，还有诸如软回车、硬回车等不同的回车类型。</li>
<li>删除操作同样会涉及行结构的处理，即删除回车时需要合并行结构，并且也会受到数据结构本身的影响，删除可能并不会符合操作直觉，因此需要手动校正行格式。并且删除的时候还需要关注<code>Unicode</code>字符的处理，特别是类似于<code>Emoji</code>等符号的删除需要特殊处理。</li>
<li>拖拽操作同样会涉及行结构的处理，而在我们的状态管理中本就是以行为单位进行管理的，因此拖拽行级结构相对会简单，当然实现的交互上还是有些工作量。而文本节点本身同样是可以拖拽的，因此我们同样需要根据选区范围进行文本的剪切和插入。</li>
</ul>
<h2 data-id="heading-1">回车操作</h2>
<p>在最开始的时候，我们就聊到了<code>ContentEditable</code>的不受控行为，特别是回车操作在不同浏览器中的表现是不一致的。在之前的例子中，我们就提到了回车操作在不同浏览器中的表现差异:</p>
<ul>
<li>在空<code>contenteditable</code>编辑器的情况下，直接按下回车键，在<code>Chrome</code>中的表现是会插入<code>&lt;div&gt;&lt;br&gt;&lt;/div&gt;</code>，而在<code>FireFox(&lt;60)</code>中的表现是会插入<code>&lt;br&gt;</code>，<code>IE</code>中的表现是会插入<code>&lt;p&gt;&lt;br&gt;&lt;/p&gt;</code>。</li>
<li>在有文本的编辑器中，如果在文本中间插入回车例如<code>123|123</code>，在<code>Chrome</code>中的表现内容是<code>123&lt;div&gt;123&lt;/div&gt;</code>，而在<code>FireFox</code>中的表现则是会将内容格式化为<code>&lt;div&gt;123&lt;/div&gt;&lt;div&gt;123&lt;/div&gt;</code>。</li>
<li>同样在有文本的编辑器中，如果在文本中间插入回车后再删除回车，例如<code>123|123-&gt;123123</code>，在<code>Chrome</code>中的表现内容会恢复原本的<code>123123</code>，而在<code>FireFox</code>中的表现则是会变为<code>&lt;div&gt;123123&lt;/div&gt;</code>。</li>
</ul>
<p>其实这些示例其实也写过很多次了，每次提到浏览器的不受控行为都会提到相关的差异，这些默认行为也变成了我们处理状态同步时需要关注的点。而实际上，关于回车的行为本身我们是可以受控处理的，即阻止其默认行为，然后根据当前的选区状态进行行结构的拆分和格式继承等处理。</p>
<p>通常来说，我们可以通过两种方式阻止默认行为，一种是监听<code>BeforeInput</code>事件并阻止其默认行为，另一种是监听<code>KeyDown</code>事件并阻止其默认行为。前者的好处是可以直接获取到事件的输入类型，例如软硬回车等，而后者的好处则是可以更早地阻止默认行为。</p>
<p>那么自然的我们还是借助<code>BeforeInput</code>事件来处理回车操作，这样会比较方便一些。那么这里的实现就比较简单，理论上来说我们只需要在数据结构中插入一个<code>\n</code>的<code>op</code>即可。此外由于我们的编辑器本身不支持软回车，因此这两种类型的回车都需要统一处理为硬回车。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">switch</span> (inputType) {
  <span class="hljs-keyword">case</span> <span class="hljs-string">"insertLineBreak"</span>:
  <span class="hljs-keyword">case</span> <span class="hljs-string">"insertParagraph"</span>: {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">perform</span>.<span class="hljs-title function_">insertBreak</span>(sel);
    <span class="hljs-keyword">break</span>;
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Perform</span> {
  public <span class="hljs-title function_">insertBreak</span>(<span class="hljs-params">sel: Range, attributes?: AttributeMap</span>) {
    <span class="hljs-keyword">const</span> raw = <span class="hljs-title class_">RawRange</span>.<span class="hljs-title function_">fromRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, sel);
    <span class="hljs-keyword">const</span> start = raw.<span class="hljs-property">start</span>;
    <span class="hljs-keyword">const</span> len = raw.<span class="hljs-property">len</span>;
    <span class="hljs-keyword">const</span> delta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(start);
    len &amp;&amp; delta.<span class="hljs-title function_">delete</span>(len);
    delta.<span class="hljs-title function_">insertEOL</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-title function_">apply</span>(delta, { <span class="hljs-attr">range</span>: raw });
  }
}
</code></pre>
<p>这件事看起来并没有那么复杂，因为<code>DOM</code>的结构变更处理是由我们的<code>LineState</code>以及<code>Mutate</code>模块实现的，<code>Mutate</code>模块实现了<code>key</code>值的维护以及<code>immutable</code>。接下来，在<code>React</code>适配器中，我们就可以直接以<code>LineState</code>为基准渲染行结构，渲染这件事就自然而然地交给了<code>React</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 数据同步变更, 异步批量绘制变更
 */</span>
<span class="hljs-keyword">const</span> onContentChange = <span class="hljs-title function_">useMemoFn</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setLines</span>(state.<span class="hljs-title function_">getLines</span>());
});

<span class="hljs-comment">/**
 * 监听内容变更事件, 更新当前块视图
 */</span>
<span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
  editor.<span class="hljs-property">event</span>.<span class="hljs-title function_">on</span>(<span class="hljs-variable constant_">EDITOR_EVENT</span>.<span class="hljs-property">CONTENT_CHANGE</span>, onContentChange);
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    editor.<span class="hljs-property">event</span>.<span class="hljs-title function_">off</span>(<span class="hljs-variable constant_">EDITOR_EVENT</span>.<span class="hljs-property">CONTENT_CHANGE</span>, onContentChange);
  };
}, [editor.<span class="hljs-property">event</span>, onContentChange]);
</code></pre>
<p><code>Mutate</code>模块实现的算法会比较复杂，这里就暂时先不展开了。简单来说，就是会根据当前的选区位置，找到对应的行结构，然后将其拆分为两行，并且继承当前行的格式属性。当然我们并不是<code>Case By Case</code>地处理，而是根据变更的<code>Delta</code>操作实现一个通用的变更模式。</p>
<p>看起来插入回车这件事就简单的结束了，然而实际上并没有，这件事复杂的点在于行格式的继承问题。在我们的<code>Mutate</code>的设计中，在行样式的处理上我们是完全遵循着<code>delta</code>的数据结构设计，即最后的<code>EOL</code>节点才承载行样式。</p>
<p>那么这样会造成一个比较反直觉的问题，如果我们直接在行中间插入<code>\n</code>的话，原本的行样式是会处于下一行的，因为本质上是因为<code>EOL</code>节点是在末尾的，此时插入<code>\n</code>自然原本的<code>EOL</code>是会直接跟随到下一行的。</p>
<p>这个问题本质上是由于<code>\n</code>太滞后了导致了，而如果我们将承载行内容的节点前提，也就是在行首加入<code>SOL-Start Of Line</code>节点，由该节点来承载样式，<code>\n</code>节点仅用于分割行，那么在执行<code>Mutate Insert</code>的时候自然就能很轻松地得到将行样式保留在上一行，而不是跟随到下一行。</p>
<p>但是这种方式很明显会因为破坏了原本的数据结构，因此导致整个状态管理发生新的问题，需要很多额外的<code>Case</code>来处理这个不需要渲染的节点所带来的问题。还有一种方案是在<code>Mutate Iterator</code>对象中加入<code>used</code>标记，当插入的节点为<code>\n</code>时会检查当前的存量<code>LineState</code>是否被复用过。</p>
<p>如果没有被复用过的话就直接将该<code>State</code>的<code>key</code>、<code>attrs</code>全部复用过来，当后续的<code>\n</code>节点再读区时则会因为已经复用过导致无法再复用，此时就是完全重新创建的新状态。</p>
<p>但是这里的问题是无法很好地保证第二个<code>\n</code>的实际值，也就是说破坏了我们原本的模型结构，其并不是交换式的，也无法将确定的新值传递到第二个<code>\n</code>上，而且在<code>Mutate Compose</code>的过程中做这件事是会导致真的需要实现这种效果时无法规避这个行为。</p>
<p>实际上<code>Quill</code>则是会存在同样的问题，我发现其如果直接执行插入<code>\n</code>的话也是会将样式跟随到下一行，那么其实这样就意味着其行样式继承是在回车的事件处理的，设想了一下这种方式的处理是合理的，这种情况下我们就可以是完全受控的情况处理。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// https://quilljs.com/playground/snow</span>
quill.<span class="hljs-title function_">updateContents</span>([{ <span class="hljs-attr">retain</span>: <span class="hljs-number">3</span> }, { <span class="hljs-attr">insert</span>: <span class="hljs-string">"\n"</span> }]);
</code></pre>
<p>那么回到编辑器回车这件事上，在行格式的继承上，如果接着上述的操作实现，则很容易地可以看出来行格式的继承问题。在下面的例子中，<code>quota</code>表示引用格式，如果在<code>Md</code>中引用是以<code>&gt;</code>在行首表示的，插入回车时原始行应该保持引用格式，而下面的例子中引用格式却仅表现在了新行。</p>
<pre><code class="hljs language-js" lang="js">[ { <span class="hljs-attr">insert</span>: <span class="hljs-string">"abc{caret}def"</span> }, { <span class="hljs-attr">insert</span>: <span class="hljs-string">"\n"</span>, <span class="hljs-attr">attributes</span>: { <span class="hljs-attr">quote</span>: <span class="hljs-string">"true"</span> } } ]
<span class="hljs-comment">// 插入回车后 =&gt;</span>
[ { <span class="hljs-attr">insert</span>: <span class="hljs-string">"abc"</span> }, { <span class="hljs-attr">insert</span>: <span class="hljs-string">"\n"</span> }, { <span class="hljs-attr">insert</span>: <span class="hljs-string">"{caret}def"</span> }, { <span class="hljs-attr">insert</span>: <span class="hljs-string">"\n"</span>, <span class="hljs-attr">attributes</span>: { <span class="hljs-attr">quote</span>: <span class="hljs-string">"true"</span> } } ]
</code></pre>
<p>那么在这里就需要区分多种情况，那么如果是在行首，就将当前属性全部带入下一行，即默认的行为。如果在末尾插入回车，则需要将下一行的属性全部清空，此时也需要合并传入的属性。如果在行中间插入属性，则需要拷贝当前行属性放置于当前插入的新行属性，如果此时存在传入的属性则同样需要合并。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// |xx(\n {y:1}) =&gt; (\n)xx(\n {y:1})</span>
<span class="hljs-comment">// xx|(\n {y:1}) =&gt; xx(\n {y:1})(\n)</span>
<span class="hljs-comment">// xx|(\n {y:1}) =&gt; xx(\n {y:1})(\n &amp; attributes)</span>
<span class="hljs-comment">// x|x(\n {y:1}) =&gt; x(\n {y:1})x(\n {y:1})</span>
<span class="hljs-comment">// x|x(\n {y:1}) =&gt; x(\n {y:1})x(\n {y:1 &amp; attributes})</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 当光标在行首时, 直接移动行属性</span>
<span class="hljs-comment">// |xx(\n {y:1}) =&gt; (\n)|xx(\n {y:1} &amp; attributes)</span>
<span class="hljs-keyword">if</span> (start === startLine.<span class="hljs-property">start</span>) {
  delta.<span class="hljs-title function_">insertEOL</span>();
  <span class="hljs-keyword">const</span> lineOffset = endLine.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
  delta.<span class="hljs-title function_">retain</span>(lineOffset - sel.<span class="hljs-property">end</span>.<span class="hljs-property">offset</span>).<span class="hljs-title function_">retain</span>(<span class="hljs-number">1</span>, attributes);
  point = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(sel.<span class="hljs-property">start</span>.<span class="hljs-property">line</span> + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
  <span class="hljs-comment">// 当光标在行尾时, 将行属性保留在当前行</span>
  <span class="hljs-comment">// xx|(\n {y:1}) =&gt; xx(\n {y:1})(\n attributes)</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (start === startLine.<span class="hljs-property">start</span> + startLine.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
  delta.<span class="hljs-title function_">retain</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">insertEOL</span>(attributes);
  point = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(sel.<span class="hljs-property">start</span>.<span class="hljs-property">line</span> + <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
  <span class="hljs-comment">// 当光标在行中时, 将行属性保留在当前行, 下一行合并新属性</span>
  <span class="hljs-comment">// x|x(\n {y:1}) =&gt; xx(\n {y:1})(\n {y:1} &amp; attributes)</span>
} <span class="hljs-keyword">else</span> {
  delta.<span class="hljs-title function_">insertEOL</span>(startLine.<span class="hljs-property">attributes</span>);
  <span class="hljs-keyword">const</span> lineOffset = endLine.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>;
  <span class="hljs-keyword">const</span> attrs = { ...startLine.<span class="hljs-property">attributes</span>, ...attributes };
  delta.<span class="hljs-title function_">retain</span>(lineOffset - sel.<span class="hljs-property">end</span>.<span class="hljs-property">offset</span>).<span class="hljs-title function_">retain</span>(<span class="hljs-number">1</span>, attrs);
}
</code></pre>
<h2 data-id="heading-2">删除操作</h2>
<p>删除操作同样是文本结构变更中比较重要的一个操作，而同样的删除也需要关注行结构的合并以及行格式的问题。首先聊的是相对简单的部分，删除文本片段内容，由于本身我们的选区是携带<code>Range</code>信息的，因此删除文本片段内容其实并没有什么复杂的地方，直接根据选区删除对应的内容即可。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Perform</span> {
  public <span class="hljs-title function_">deleteFragment</span>(<span class="hljs-params">sel: Range</span>) {
    <span class="hljs-keyword">if</span> (sel.<span class="hljs-property">isCollapsed</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> raw = <span class="hljs-title class_">RawRange</span>.<span class="hljs-title function_">fromRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, sel);
    <span class="hljs-keyword">if</span> (!raw) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> len = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(raw.<span class="hljs-property">len</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(raw.<span class="hljs-property">start</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (start &lt; <span class="hljs-number">0</span> || len &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> delta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(start).<span class="hljs-title function_">delete</span>(len);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-title function_">apply</span>(delta, { <span class="hljs-attr">range</span>: raw });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  }
}
</code></pre>
<p>而删除本身还存在向前删除和向后删除的情况，因此我们需要分别处理<code>deleteContentBackward</code>和<code>deleteContentForward</code>两种输入类型。实际上这两种删除的实现是类似的，主要是计算删除的位置不同而已，但是也需要分别处理行首行末等情况。</p>
<p>处理<code>backward</code>删除时主要是处理行首删除的情况，即处于当前行的行首, 且存在行状态节点。此时分别处理上个节点为块节点、当前行存在行属性、当前行不存在行属性三种情况，这里的主要目标是删除时要删除当前行结构，以此更加符合操作直觉，并且将光标移动到合适的位置。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 处于当前行的行首, 且存在行状态节点</span>
<span class="hljs-keyword">if</span> (line &amp;&amp; sel.<span class="hljs-property">start</span>.<span class="hljs-property">offset</span> === <span class="hljs-number">0</span>) {
  <span class="hljs-keyword">const</span> prevLine = line &amp;&amp; line.<span class="hljs-title function_">prev</span>();
  <span class="hljs-comment">// 上一行为块节点且处于当前行首时, 删除则移动光标到该节点上</span>
  <span class="hljs-keyword">if</span> (prevLine &amp;&amp; <span class="hljs-title function_">isBlockLine</span>(prevLine)) {
  <span class="hljs-comment">// 当前行为空时特殊处理, 先删除掉该行</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isEmptyLine</span>(line)) {
      <span class="hljs-keyword">const</span> delta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(line.<span class="hljs-property">start</span>).<span class="hljs-title function_">delete</span>(<span class="hljs-number">1</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-title function_">apply</span>(delta, { <span class="hljs-attr">autoCaret</span>: <span class="hljs-literal">false</span> });
    }
    <span class="hljs-keyword">const</span> firstLeaf = prevLine.<span class="hljs-title function_">getFirstLeaf</span>();
    <span class="hljs-keyword">const</span> range = firstLeaf &amp;&amp; firstLeaf.<span class="hljs-title function_">toRange</span>();
    range &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">selection</span>.<span class="hljs-title function_">set</span>(range, <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  }
  <span class="hljs-keyword">const</span> attrsLength = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(line.<span class="hljs-property">attributes</span>).<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 如果在当前行的行首, 且存在其他行属性, 则删除当前行的行属性</span>
  <span class="hljs-keyword">if</span> (attrsLength &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">const</span> delta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(line.<span class="hljs-property">start</span> + line.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>).<span class="hljs-title function_">retain</span>(<span class="hljs-number">1</span>, <span class="hljs-title function_">invertAttributes</span>(line.<span class="hljs-property">attributes</span>));
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-title function_">apply</span>(delta, { <span class="hljs-attr">autoCaret</span>: <span class="hljs-literal">false</span> });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  }
  <span class="hljs-comment">// 如果在当前行的行首, 且不存在其他行属性, 则将当前行属性移到下一行</span>
  <span class="hljs-keyword">if</span> (prevLine &amp;&amp; !attrsLength) {
    <span class="hljs-keyword">const</span> prevAttrs = { ...prevLine.<span class="hljs-property">attributes</span> };
    <span class="hljs-keyword">const</span> delta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(line.<span class="hljs-property">start</span> - <span class="hljs-number">1</span>).<span class="hljs-title function_">delete</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">retain</span>(line.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>).<span class="hljs-title function_">retain</span>(<span class="hljs-number">1</span>, prevAttrs);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-title function_">apply</span>(delta);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  }
}
</code></pre>
<p>而处理<code>forward</code>删除时主要是处理行末删除的情况，这个情况相对起来会更简单一些，此时并没处理复杂情况，因为其操作更不高频。如果此时光标位于块节点上，那么删除时直接执行当前块节点的删除操作即可。如果光标位于当前行的行末，且下一行为块节点，那么删除时则将光标移动到该块节点上。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 当前行为块结构时, 执行 backward 删除操作</span>
<span class="hljs-keyword">if</span> (line &amp;&amp; sel.<span class="hljs-property">start</span>.<span class="hljs-property">offset</span> === <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-title function_">isBlockLine</span>(line)) { 
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteBackward</span>(sel);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
}
<span class="hljs-keyword">const</span> nextLine = line &amp;&amp; line.<span class="hljs-title function_">next</span>();
<span class="hljs-comment">// 下一行为块节点且处于当前行末时, 删除则移动光标到该节点上</span>
<span class="hljs-keyword">if</span> (line &amp;&amp; sel.<span class="hljs-property">start</span>.<span class="hljs-property">offset</span> === line.<span class="hljs-property">length</span> - <span class="hljs-number">1</span> &amp;&amp; nextLine &amp;&amp; <span class="hljs-title function_">isBlockLine</span>(nextLine)) {
  <span class="hljs-keyword">const</span> firstLeaf = nextLine.<span class="hljs-title function_">getFirstLeaf</span>();
  <span class="hljs-keyword">const</span> range = firstLeaf &amp;&amp; firstLeaf.<span class="hljs-title function_">toRange</span>();
  range &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">selection</span>.<span class="hljs-title function_">set</span>(range, <span class="hljs-literal">true</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>在删除内容这里最需要关注的其实是视图层问题，当与<code>React</code>结合的视图层面更新时，同样也会出现非受控行为的问题，这里的不受控是<code>React</code>数据层及其渲染层的问题。其实，这里本质上还是跟<code>IME</code>输入的<code>DOM</code>变更有关。</p>
<p>具体来说，当选区存在跨节点行为时，无论是行内还是跨行的选区，唤醒输入法<code>Composing</code>输入内容后，这部分节点内容会被删除，并且替换为输入的内容。但是当确定内容之后，编辑器便会崩溃，这也是删除与插入的合并操作造成的问题，报错内容如下:</p>
<pre><code class="hljs language-csharp" lang="csharp">Failed to execute <span class="hljs-string">'removeChild'</span> <span class="hljs-keyword">on</span> <span class="hljs-string">'Node'</span>: The node to be removed <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> a child of <span class="hljs-keyword">this</span> node.
</code></pre>
<p>从报错上来看，<code>React</code>会将子节点从父节点移除，这本身是非常合理的行为。举个例子，当实现一个列表时，如果数据源删除了某些节点，那么<code>React</code>就会将对应的<code>DOM</code>节点自动移除掉，也就是不需要操作<code>DOM</code>，而是可以直接通过声明式的方式来实现变更。</p>
<p>那么这里的问题就出现在这些<code>DOM</code>已经实际上被移除了，因此当<code>React</code>尝试移除这些节点时就会报错，而这个异常会导致整个编辑器崩溃，因此我们就需要避免这个情况的发生。那么首先就需要避免<code>removeChild</code>的异常，我们很难直接避免<code>React</code>的行为，因此只能在<code>DOM</code>节点上进行拦截。</p>
<p>然而，即使是在<code>DOM</code>上处理拦截行为也并不容易，<code>removeChild</code>方法是在<code>Node</code>对象上的，如果我们直接重写<code>Node.prototype.removeChild</code>方法，那么就会影响到整个页面的<code>DOM</code>节点，因此我们只能尝试在编辑器的<code>ref</code>上处理。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 重写 removeChild 方法
 * - 避免 IME 破坏跨节点渲染造成问题
 * - https://github.com/facebookarchive/draft-js/issues/1320
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">rewriteRemoveChild</span> = (<span class="hljs-params">node: Node</span>) =&gt; {
  <span class="hljs-keyword">const</span> removeChild = <span class="hljs-title class_">Node</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">removeChild</span>;
  node.<span class="hljs-property">removeChild</span> = <span class="hljs-keyword">function</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Node</span>&gt;(<span class="hljs-attr">child</span>: T) {
    <span class="hljs-keyword">if</span> (child.<span class="hljs-property">parentNode</span> !== <span class="hljs-variable language_">this</span>) <span class="hljs-keyword">return</span> child;
    <span class="hljs-keyword">return</span> removeChild.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, child) <span class="hljs-keyword">as</span> T;
  };
};
</code></pre>
<p>然而编辑器本身会存在大量的<code>DOM</code>节点，我们很难在所有的节点上进行重写，因此我们还需要限制<code>DOM</code>变动的范围。在<code>React</code>中控制重渲染的方式可以通过<code>key</code>来实现，因此就需要在<code>IME</code>输入起始时刷新相关节点的<code>key</code>，以此来避免<code>React</code>复用这些节点，然后刷新范围就限制在了行节点上。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 组合输入开始
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">event</span>
 */</span>
@<span class="hljs-title class_">Bind</span>
protected <span class="hljs-title function_">onCompositionStart</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 需要强制刷新 state.key, 且需要配合 removeChild 避免抛出异常</span>
  <span class="hljs-keyword">const</span> sel = <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">selection</span>.<span class="hljs-title function_">get</span>();
  <span class="hljs-keyword">if</span> (!sel || sel.<span class="hljs-property">isCollapsed</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = sel.<span class="hljs-property">start</span>.<span class="hljs-property">line</span>; i &lt;= sel.<span class="hljs-property">end</span>.<span class="hljs-property">line</span>; ++i) {
    <span class="hljs-keyword">const</span> line = <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-property">block</span>.<span class="hljs-title function_">getLine</span>(i);
    line &amp;&amp; line.<span class="hljs-title function_">forceRefresh</span>();
  }
}
</code></pre>
<p>然后在<code>React</code>控制节点的部分，就需要将重写的逻辑加入到块节点以及行节点的<code>DOM</code>上，以此来避免异常的发生。这里还需要避免<code>ref</code>函数的重复执行，<code>React</code>的特性是如果<code>ref</code>引用不同就会原始的引用再调用新的方法，因此这里需要借助<code>useMemoFn</code>实现。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> setModel = <span class="hljs-title function_">useMemoFn</span>(<span class="hljs-function">(<span class="hljs-params">ref: HTMLDivElement | <span class="hljs-literal">null</span></span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (ref) {
    <span class="hljs-title function_">rewriteRemoveChild</span>(ref);
  }
});
</code></pre>
<p>从本质上来看，是执行输入法时没有办法控制<code>DOM</code>的变更行为，或者阻止浏览器的默认行为。但是我们却可以在<code>start</code>的时候就执行相关的处理，类似于将<code>end</code>时的删除且插入的行为分离出来，也就是说先执行<code>deleteFragment</code>方法，将所有的<code>DOM</code>直接通过先移除掉来同步行为。</p>
<p>但是这里又出现了新的问题，因为本身的<code>delete</code>方法会将选区内的内容全部删除，这样的话会导致唤醒<code>IME</code>时，选区所在的<code>DOM</code>节点会被删除。因此浏览器会将光标兜底到当前行的起始位置，虽然不影响最终输入的内容，但是在输入的时候就可以明显地看出来问题，有些影响用户体验。</p>
<p>在这里其实还可以考虑一种实现，在组合输入时同样会删除选区的内容，但是保留光标所在的<code>DOM</code>节点，这个实现就会很复杂。其实如果能在唤醒输入法前就将选区删除并且再设置好光标位置，再出现输入法的话，倒是就不会出现这个问题，然而目前并没有相关的<code>API</code>可以实现这样的行为。</p>
<p>但是在后期研究<code>slate</code>的实现发现，其仅仅是在<code>IME</code>组合输入开始的时候删除了相关的节点，而我们的编辑器却无法做到。经过排查之后发现是更新内容后的浏览器选区事件被我们阻止了，但是这里的表现也比较奇怪，阻止了选区更新竟然会导致行的该节点后的所有节点都无法渲染出来。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Input</span> {
  @<span class="hljs-title class_">Bind</span>
  protected <span class="hljs-title function_">onCompositionStart</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 避免 IME 破坏跨节点渲染造成问题</span>
    <span class="hljs-keyword">const</span> sel = <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">selection</span>.<span class="hljs-title function_">get</span>();
    <span class="hljs-keyword">if</span> (!sel || sel.<span class="hljs-property">isCollapsed</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">perform</span>.<span class="hljs-title function_">deleteFragment</span>(sel);
  }
}
</code></pre>
<p>因此在这里放行选区更新的事件，即在<code>Update Effect</code>时不再通过<code>Composing</code>状态阻止选区的更新行为，这样就可以避免上述的问题了。然而这里的表现确实是非常奇怪的，<code>React</code>确实是持有了<code>DOM</code>状态，而改动就是这里的更新选区行为，选区本身导致节点无法正常渲染实在是有点费解。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">useLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> selection = editor.<span class="hljs-property">selection</span>.<span class="hljs-title function_">get</span>();
  <span class="hljs-comment">// 渲染完成后更新浏览器选区</span>
  <span class="hljs-keyword">if</span> (editor.<span class="hljs-property">state</span>.<span class="hljs-title function_">isFocused</span>() &amp;&amp; selection) {
    editor.<span class="hljs-property">logger</span>.<span class="hljs-title function_">debug</span>(<span class="hljs-string">"UpdateDOMSelection"</span>);
    editor.<span class="hljs-property">selection</span>.<span class="hljs-title function_">updateDOMSelection</span>(<span class="hljs-literal">true</span>);
  }
});
</code></pre>
<h3 data-id="heading-3">Emoji 处理</h3>
<p><code>Unicode</code>可以视为<code>Map</code>，可以从数值<code>code point</code>映射到具体的字形，这样就可以直接引用符号而不需要实际使用符号本身。可能的代码点值范围是从<code>U+0000</code>到<code>U+10FFFF</code>，有超过<code>110</code>万个可能的符号，为了保持条理性，<code>Unicode</code>将此代码点范围划分为<code>17</code>个平面。</p>
<p>首个平面<code>U+0000 -&gt; U+FFFF</code>称为基本多语言平面或<code>BMP</code>，包含了最常用的字符。这样<code>BMP</code>之外就剩下大约<code>100</code>万个代码点<code>U+010000 -&gt; U+10FFFF</code>，这些代码点所属的平面称为补充平面或星面。</p>
<p><code>JavaScript</code>的单个字符由无符号的<code>16</code>位整数支持，因此其无法容纳任何高于<code>U+FFFF</code>的代码点，而是需要将其拆分为代理对。这其实就是<code>JS</code>的<code>UCS-2</code>编码形式，造成了所有字符在<code>JS</code>中都是<code>2</code>个字节，而如果是<code>4</code>个字节的字符，那么就会当作两个双字节的字符处理即代理对。</p>
<p>其实这么说起来<code>UTF-8</code>的变长<code>1-4</code>字节的编码是无法表示的，代理对自然是可以解决这个问题。而表达<code>UTF-16</code>的编码长度要么是<code>2</code>个字节，要么是<code>4</code>个字节。在<code>ECMAScript 6</code>中引入了新的表达方式，但是为了向后兼容<code>ECMAScript 5</code>依然可以用代理对的形式表示星面。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">"\u{1F3A8}"</span>
<span class="hljs-comment">// 🎨</span>
<span class="hljs-string">"\uD83C\uDFA8"</span>
<span class="hljs-comment">// 🎨</span>
</code></pre>
<p>实际上在<code>ES6</code>中引入的函数也解决了字符串遍历的问题，正则表达式也提供了<code>u</code>修饰符来处理<code>4</code>字节的字符。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-string">"1🎨1"</span>)
<span class="hljs-comment">// ["1", "🎨", "1"]</span>
/^.<span class="hljs-property">$</span>/u.<span class="hljs-title function_">test</span>(<span class="hljs-string">"🎨"</span>)
<span class="hljs-comment">// true</span>
<span class="hljs-string">"1🎨1"</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">""</span>)
<span class="hljs-comment">// ["1", "\uD83C", "\uDFA8", "1"]</span>
</code></pre>
<p>另外在基本平面即低位代理对内，从<code>U+D800</code>到<code>U+DFFF</code>是一个空段，即这些码点不对应任何字符，自然可以避免原本基本平面的冲突，因此可以用来映射辅助平面的字符。高位<code>[\uD800-\uDBFF]</code>与低位<code>[\uDC00-\uDFFF]</code>恰好是<code>2^10 * 2^10</code>长度，恰好<code>100</code>多万个代码点。</p>
<pre><code class="hljs language-js" lang="js">(<span class="hljs-number">0xDBFF</span> - <span class="hljs-number">0xD800</span> + <span class="hljs-number">1</span>) * (<span class="hljs-number">0xDFFF</span> - <span class="hljs-number">0xDC00</span> + <span class="hljs-number">1</span>) = <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> = <span class="hljs-number">1048576</span>
</code></pre>
<p>虽然可以已经用<code>Unicode</code>代理对的方式表达<code>4</code>字节符号，但是类似<code>Emoji</code>这些符号是可以组合的。那么这样会导致字形上看起来是单个字符，实际上是通过<code>\u200d</code>即<code>ZWJ</code>组合起来的字符，因此其长度会更长，且<code>ES6</code>的函数也是会将其拆离表现的。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-string">"🧑"</span> + <span class="hljs-string">"\u200d"</span> + <span class="hljs-string">"🎨"</span>
<span class="hljs-comment">// 🧑‍🎨</span>
<span class="hljs-string">"🧑‍🎨"</span>.<span class="hljs-property">length</span>
<span class="hljs-comment">// 5</span>
<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(<span class="hljs-string">"🧑‍🎨"</span>)
<span class="hljs-comment">// ["🧑", "‍", "🎨"]</span>
</code></pre>
<p>因此，在这里我们需要在删除之前判断即将要删除的文本长度，这本身其实是可以有多种方式来实现的。例如我们即将要提到的词级别的内容删除，将其转换为非受控的状态来删除，而在这里我们则是通过计算末尾的<code>Unicode</code>字符长度来实现删除。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 获取末尾 Unicode 字符长度
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">str</span>
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getLastUnicodeLen</span> = (<span class="hljs-params">str: string | P.Nil</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!str || str.<span class="hljs-property">length</span> &lt; <span class="hljs-number">2</span>) {
    <span class="hljs-keyword">return</span> str ? str.<span class="hljs-property">length</span> : <span class="hljs-number">0</span>;
  }
  <span class="hljs-keyword">const</span> first = str.<span class="hljs-title function_">charCodeAt</span>(str.<span class="hljs-property">length</span> - <span class="hljs-number">2</span>);
  <span class="hljs-keyword">const</span> second = str.<span class="hljs-title function_">charCodeAt</span>(str.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>);
  <span class="hljs-keyword">if</span> (<span class="hljs-number">0xd800</span> &lt; first &amp;&amp; first &lt; <span class="hljs-number">0xdbff</span> &amp;&amp; <span class="hljs-number">0xdc00</span> &lt; second &amp;&amp; second &lt; <span class="hljs-number">0xdfff</span>) {
    <span class="hljs-comment">// 此时基本 Unicode 字符长度为 2</span>
    <span class="hljs-keyword">let</span> len = <span class="hljs-number">2</span>;
    <span class="hljs-comment">// 通过连接符号来组合单个 Unicode 字符长度</span>
    <span class="hljs-comment">// [-][-] \u200d [-][-] \u200d [-][-]</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = str.<span class="hljs-property">length</span> - <span class="hljs-number">3</span>; i &gt; <span class="hljs-number">0</span>; i = i - <span class="hljs-number">3</span>) {
      <span class="hljs-keyword">if</span> (str[i].<span class="hljs-title function_">charCodeAt</span>(<span class="hljs-number">0</span>) !== <span class="hljs-number">0x200d</span>) <span class="hljs-keyword">break</span>;
      len = len + <span class="hljs-number">3</span>;
    }
    <span class="hljs-keyword">return</span> len;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
};
</code></pre>
<h3 data-id="heading-4">词级文本处理</h3>
<p>先前我们针对<code>Emoji</code>的删除做了特殊处理，因为其本身是多个字符组成的内容，所以在删除时如果直接取长度为<code>1</code>的话会导致出现遗留不可见字符的情况。那么除了<code>Emoji</code>可能存在删除多个字符的情况，使用<code>Alt + Del</code>组合键在默认情况下是删除词级别内容，同样是存在多个字符的情况。</p>
<p>如果仅仅是使用<code>ContentEditable</code>的情况下，浏览器会自动处理词级别的删除行为，包括<code>Emoji</code>的删除行为也是可以自动处理的。因此针对非受控输入的编辑器例如<code>Quill</code>、飞书文档的实现，是不太需要主动处理相关行为的，主要关注点在于<code>DOM</code>变更后的被动同步状态。</p>
<p>而在我们实现的编辑器中，因为输入的相关实现是完全基于<code>beforeInput</code>事件来处理的，是完全受控的行为，因此我们必须要主动处理删除的行为。实际上在事件中，<code>inputType</code>值是给出了<code>deleteWordBackward</code>和<code>deleteWordForward</code>的，却没有给出默认行为要删除的长度。</p>
<p>因此我最开始是想要么改为非受控输入，要么是通过<code>Intl.Segmenter</code>方法来主动分词实现。然而在看到<code>MDN</code>的<code>DEMO</code>之后，发现这个构造器需要传递语言参数，这样的话在编辑器中是没有办法实现的，因为编辑器中无法实际确定语言类型。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> segmenterZH = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">Segmenter</span>(<span class="hljs-string">"ZH-CN"</span>, { <span class="hljs-attr">granularity</span>: <span class="hljs-string">"word"</span> });
<span class="hljs-keyword">const</span> string1 = <span class="hljs-string">"当前所有功能都是基于插件化定义实现"</span>;
<span class="hljs-keyword">const</span> iterator1 = segmenterZH.<span class="hljs-title function_">segment</span>(string1)[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iterator1.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>.<span class="hljs-property">segment</span>); <span class="hljs-comment">// 当前</span>
</code></pre>
<p>因此我去找了相关开源编辑器的实现，<code>slate</code>是完全自定义处理的行为，使用<code>getWordDistance</code>来自行计算词的距离。这样对于英文问题不大，但是对于中文词组的处理就比较差了，是以标点符号为准作为切割目标的，因此对于中文实现更像是按句删除了。</p>
<p>而在<code>Lexical</code>中尝试了删除词组的表现则比较符合预期，本来我以为也是非受控的输入，但是查阅源码后发现同样是基于<code>beforeInput</code>事件来处理的。那么这个表现就非常符合浏览器的行为，本来我以为也是基于<code>Segmenter</code>实现，想查看是如何处理语言问题的，发现首参数是可以不传递的。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> segmenterZH = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intl</span>.<span class="hljs-title class_">Segmenter</span>(<span class="hljs-literal">undefined</span>, { <span class="hljs-attr">granularity</span>: <span class="hljs-string">"word"</span> });
<span class="hljs-keyword">const</span> string1 = <span class="hljs-string">"当前所有功能都是基于插件化定义实现"</span>;
<span class="hljs-keyword">const</span> iterator1 = segmenterZH.<span class="hljs-title function_">segment</span>(string1)[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(iterator1.<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>.<span class="hljs-property">segment</span>); <span class="hljs-comment">// 当前</span>
</code></pre>
<p>然而，再细致地查阅源码后发现，<code>Lexical</code>并未直接使用<code>Segmenter</code>来处理分词，而是使用了<code>selection.modify</code>这个<code>API</code>来预处理选区的变更。基于这个<code>API</code>可以同步地变更选区的<code>DOM</code>引用，然后我们就可以立即得到未来的选区状态，因此就可以构造删除的范围。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> root = <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-title function_">getContainer</span>();
<span class="hljs-keyword">const</span> domSelection = <span class="hljs-title function_">getRootSelection</span>(root);
<span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">this</span>.<span class="hljs-property">current</span>;
<span class="hljs-keyword">if</span> (!domSelection || !selection) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
domSelection.<span class="hljs-title function_">modify</span>(<span class="hljs-variable constant_">ALERT</span>.<span class="hljs-property">MOVE</span>, direction, granularity);
<span class="hljs-keyword">const</span> staticSel = <span class="hljs-title function_">getStaticSelection</span>(domSelection);
<span class="hljs-keyword">if</span> (!staticSel || <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">limit</span>()) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
<span class="hljs-keyword">const</span> { startContainer } = staticSel;
<span class="hljs-keyword">if</span> (!root.<span class="hljs-title function_">contains</span>(startContainer)) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
<span class="hljs-keyword">const</span> newRange = <span class="hljs-title function_">toModelRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, staticSel, <span class="hljs-literal">false</span>);
newRange &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">set</span>(newRange);
</code></pre>
<p>并且在<code>Lexical</code>中还解释了<code>beforeInput</code>事件以及对应的<code>getTargetRanges()</code>方法。由此先前我对于浏览器没有给出默认要删除的长度的判断是错误的，其是通过<code>Range</code>来表达的。但是注释中还提到了这个方案不可靠，其在复杂场景下可能无法正确反应操作后的选区状态。</p>
<p>而对于使用像<code>Intl.Segmenter</code>等按词组分割的工具，比较容易出错，而且需要对于整个<code>Op</code>进行分词，也有很多不必要的计算。不同语言的分词规则差异巨大，例如英文空格分词以及中文无空格分词，自动识别词边界非常困难，尤其是在涉及自动换行和非罗马语言的情况下会非常困难。</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Flexical%2Fblob%2Faf687fa%2Fpackages%2Flexical%2Fsrc%2FLexicalSelection.ts%23L1605" target="_blank" title="https://github.com/facebook/lexical/blob/af687fa/packages/lexical/src/LexicalSelection.ts#L1605" ref="nofollow noopener noreferrer">github.com/facebook/le…</a></li>
</ul>
<p>总结起来，使用<code>selection.modify</code>方法直接利用了浏览器引擎自身对选区计算的内置、高度优化的逻辑，浏览器如何分词自然是浏览器本身最熟知。此外，实际上<code>BeforeInput</code>事件还有诸多方法，词级别删除这件事本身其实也可以用<code>getTargetRanges</code>来实现。</p>
<pre><code class="hljs language-js" lang="js">event.<span class="hljs-title function_">getTargetRanges</span>()[<span class="hljs-number">0</span>] <span class="hljs-comment">// InputEvent</span>
<span class="hljs-comment">// StaticRange {startContainer: text, startOffset: 13, endContainer: text, endOffset: 14, collapsed: false}</span>
</code></pre>
<h2 data-id="heading-5">文本拖拽</h2>
<p>既然都提到了<code>getTargetRanges</code>方法，我们自然就可以顺理成章地以此为基础聊一下文本拖拽的实现。在<code>beforeInput</code>事件中，<code>inputType</code>值是有<code>deleteByDrag</code>以及<code>insertFromDrop</code>两种类型，拖拽需要有两个操作组合而来，分别是文本的删除与插入操作。</p>
<p><code>getTargetRanges</code>方法返回的实际上是个<code>static range</code>数组，因此需要调用先前我们实现的<code>toModelRange</code>方法来转换到编辑器的选区模型。那么移动文本的这个操作实际上只需要关注两个<code>Range</code>，分别记录删除和插入的位置就可以实现了。</p>
<p>因此基于<code>beforeInput</code>事件的拖拽实现其实是非常简单的，主要是将删除和插入的逻辑组合在一起即可。这里需要放置一个临时的变量，用来记录起始的位置，因为这里是两个事件分别发生的，因此需要将删除的位置保存下来，然后在插入时使用这个位置来移动文本片段。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">switch</span> (inputType) {
  <span class="hljs-keyword">case</span> <span class="hljs-string">"deleteByDrag"</span>: {
    <span class="hljs-keyword">const</span> domRange = event.<span class="hljs-title function_">getTargetRanges</span>()[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> range = domRange &amp;&amp; <span class="hljs-title function_">toModelRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, domRange, <span class="hljs-literal">false</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dragStartRange</span> = range || <span class="hljs-literal">null</span>;
  }
  <span class="hljs-keyword">case</span> <span class="hljs-string">"insertFromDrop"</span>: {
    <span class="hljs-keyword">const</span> domRange = event.<span class="hljs-title function_">getTargetRanges</span>()[<span class="hljs-number">0</span>];
    <span class="hljs-keyword">const</span> range = domRange &amp;&amp; <span class="hljs-title function_">toModelRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, domRange, <span class="hljs-literal">false</span>);
    range &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">perform</span>.<span class="hljs-title function_">moveFragment</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dragStartRange</span>, range);
  }
}
</code></pre>
<p>移动内容片段的部分则比较简单，唯一一个需要关注的点是使用了<code>transformPosition</code>函数来处理位置偏移。因为在删除内容片段后，插入位置会发生变化，两次变更的基准都是同一个草稿，而变更则是顺序的关系，此时就需要假设<code>A</code>发生来处理对<code>B</code>的影响。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Perform</span> {
  <span class="hljs-comment">/**
   * 移动选区内容片段到目标选区处
   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">from</span>
   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">to</span>
   */</span>
  public <span class="hljs-title function_">moveFragment</span>(<span class="hljs-params"><span class="hljs-keyword">from</span>: Range, to: Range</span>) {
    <span class="hljs-keyword">const</span> rawFrom = <span class="hljs-title class_">RawRange</span>.<span class="hljs-title function_">fromRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, <span class="hljs-keyword">from</span>);
    <span class="hljs-keyword">const</span> rawTo = <span class="hljs-title class_">RawRange</span>.<span class="hljs-title function_">fromRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, to);
    <span class="hljs-keyword">if</span> (!rawFrom || !rawTo) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> fragment = <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">lookup</span>.<span class="hljs-title function_">getFragment</span>(<span class="hljs-keyword">from</span>);
    <span class="hljs-keyword">if</span> (!fragment) <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">const</span> delDelta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(rawFrom.<span class="hljs-property">start</span>).<span class="hljs-title function_">delete</span>(rawFrom.<span class="hljs-property">len</span>);
    <span class="hljs-keyword">const</span> toStart = delDelta.<span class="hljs-title function_">transformPosition</span>(rawTo.<span class="hljs-property">start</span>);
    <span class="hljs-keyword">const</span> insertDelta = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>().<span class="hljs-title function_">retain</span>(toStart).<span class="hljs-title function_">merge</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Delta</span>(fragment));
    <span class="hljs-keyword">const</span> composed = delDelta.<span class="hljs-title function_">compose</span>(insertDelta);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>.<span class="hljs-property">state</span>.<span class="hljs-title function_">apply</span>(composed, { <span class="hljs-attr">range</span>: rawTo });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
  }
}
</code></pre>
<p>而除了在<code>BeforeInput</code>事件中处理拖拽外，我们还可以在<code>DragEvent</code>事件中处理拖拽的逻辑，在<code>slate</code>中就是基于<code>Drag</code>相关的事件来完成的。实际上这也是在阻止<code>Drag</code>默认行为后，手动处理拖拽的逻辑，如果需要接管诸如图片的拖拽行为等，那么就必须要采用这个方案了。</p>
<p>基于<code>DragEvent</code>的方案中，主要关注点有三部分，首先是需要在<code>DragStart</code>事件中将当前的选区位置在<code>dataTransfer</code>中保存下来，其次是在<code>DragOver</code>事件中阻止默认行为以允许拖拽，最后是在<code>Drop</code>事件中获取拖拽的内容并且执行移动操作。下面是<code>Slate</code>中的实现:</p>
<pre><code class="hljs language-js" lang="js">&lt;div
  onDragStart={<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title class_">ReactEditor</span>.<span class="hljs-title function_">setFragmentData</span>(
      editor,
      event.<span class="hljs-property">dataTransfer</span>,
      <span class="hljs-string">'drag'</span>
    )
   }, [])}
  onDragOver={<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    event.<span class="hljs-title function_">preventDefault</span>();
  }, [])}
  onDrop={<span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> draggedRange = editor.<span class="hljs-property">selection</span>
    <span class="hljs-keyword">const</span> range = <span class="hljs-title class_">ReactEditor</span>.<span class="hljs-title function_">findEventRange</span>(editor, event);
    <span class="hljs-keyword">const</span> data = event.<span class="hljs-property">dataTransfer</span>
    <span class="hljs-title class_">Transforms</span>.<span class="hljs-title function_">delete</span>(editor, { <span class="hljs-attr">at</span>: draggedRange })
    <span class="hljs-title class_">Transforms</span>.<span class="hljs-title function_">select</span>(editor, range)
    <span class="hljs-title class_">ReactEditor</span>.<span class="hljs-title function_">insertData</span>(editor, data)
  }, [])}
&gt;&lt;/div&gt;
</code></pre>
<p>在这里的<code>findEventRange</code>方法是比较需要关注的，因为此时的<code>DragEvent</code>并没有提供类似于<code>getTargetRanges</code>的方法，因此我们并没有办法直接获取拖拽的目标位置。在之前我们提到了在<code>DOM</code>基础上的自绘选区实现，在这里仍然可以调用相关<code>API</code>来实现指定位置的选区获取。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> <span class="hljs-attr">domRange</span>: <span class="hljs-title class_">Range</span>;
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">caretRangeFromPoint</span>) {
  domRange = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">caretRangeFromPoint</span>(x, y);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-keyword">const</span> position = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">caretPositionFromPoint</span>(x, y);
  <span class="hljs-keyword">if</span> (position) {
    domRange = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createRange</span>();
    domRange.<span class="hljs-title function_">setStart</span>(position.<span class="hljs-property">offsetNode</span>, position.<span class="hljs-property">offset</span>);
    domRange.<span class="hljs-title function_">setEnd</span>(position.<span class="hljs-property">offsetNode</span>, position.<span class="hljs-property">offset</span>);
  }
}
<span class="hljs-keyword">const</span> range = domRange &amp;&amp; <span class="hljs-title function_">toModelRange</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">editor</span>, domRange, <span class="hljs-literal">false</span>);
<span class="hljs-comment">// ...</span>
</code></pre>
<h2 data-id="heading-6">总结</h2>
<p>先前我们针对性地处理输入法和浏览器兼容的行为，由于输入法会直接操作<code>DOM</code>，因此实现编辑器模型的输入状态同步需要处理很多问题。而在这里我们关注于处理文本结构性变更行为的处理，主要是实现了回车插入、删除、拖拽等文本变更行为的处理，至此完成了编辑器输入同步部分的实现。</p>
<p>接下来我们需要实现编辑器的视图层同步能力，即<code>React/Vue</code>等视图层的适配器实现，以此来对接核心层的编辑器模型。先前我们已经实现了模型层<code>delta</code>、控制器层<code>core</code>，再加上视图层的适配器<code>react</code>，就可以完整实现编辑器的<code>MVC</code>框架了。</p>
<h2 data-id="heading-7">每日一题</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FWindRunnerMax%2FEveryDay" target="_blank" title="https://github.com/WindRunnerMax/EveryDay" ref="nofollow noopener noreferrer">github.com/WindRunnerM…</a></li>
</ul>
<h2 data-id="heading-8">参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmathiasbynens.be%2Fnotes%2Fjavascript-unicode" target="_blank" title="https://mathiasbynens.be/notes/javascript-unicode" ref="nofollow noopener noreferrer">mathiasbynens.be/notes/javas…</a></li>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2014%2F12%2Funicode.html" target="_blank" title="http://www.ruanyifeng.com/blog/2014/12/unicode.html" ref="nofollow noopener noreferrer">www.ruanyifeng.com/blog/2014/1…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Feev.ee%2Fblog%2F2015%2F09%2F12%2Fdark-corners-of-unicode" target="_blank" title="https://eev.ee/blog/2015/09/12/dark-corners-of-unicode" ref="nofollow noopener noreferrer">eev.ee/blog/2015/0…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FInputEvent" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/InputEvent" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FSelection%2Fmodify" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/modify" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fw3c.github.io%2Finput-events%2F%23interface-InputEvent-Attributes" target="_blank" title="https://w3c.github.io/input-events/#interface-InputEvent-Attributes" ref="nofollow noopener noreferrer">w3c.github.io/input-event…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FInputEvent%2FgetTargetRanges" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/InputEvent/getTargetRanges" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：Express 基础]]></title>    <link>https://juejin.cn/post/7586157459971571764</link>    <guid>https://juejin.cn/post/7586157459971571764</guid>    <pubDate>2025-12-22T03:02:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586157459971571764" data-draft-id="7585929179319713827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：Express 基础"/> <meta itemprop="keywords" content="后端,前端,Node.js"/> <meta itemprop="datePublished" content="2025-12-22T03:02:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：Express 基础
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:02:14.000Z" title="Mon Dec 22 2025 03:02:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Node.js 后端开发中，Express 是使用最广泛的 Web 框架之一。它在 Node.js 原生 HTTP 模块之上进行了封装，提供了更加简洁、灵活的接口，用于构建 Web 应用和 API 服务。Express 并不追求功能的“全家桶”，而是强调轻量和可扩展，这也正是它长期流行的重要原因。</p>
</blockquote>
<p>本文将从 Express 的基本概念出发，介绍其核心用法和常见开发模式。</p>
<hr/>
<h2 data-id="heading-0">一、为什么选择 Express</h2>
<p>Node.js 自带的 HTTP 模块虽然功能完整，但在实际开发中，处理路由、参数解析、错误处理等内容时会显得较为繁琐。Express 对这些常见需求进行了抽象，让开发者可以更加专注于业务逻辑本身。</p>
<p>Express 的优势主要体现在结构清晰、学习成本低以及生态成熟。大量中间件和社区实践，使得 Express 适合从小型项目到中大型服务的不同场景。</p>
<hr/>
<h2 data-id="heading-1">二、创建第一个 Express 应用</h2>
<p>在已有 Node.js 环境的前提下，首先需要安装 Express。</p>
<pre><code class="hljs language-bash" lang="bash">npm install express
</code></pre>
<p>创建一个最简单的服务示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'Hello Express'</span>);
});

app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'server running on port 3000'</span>);
});
</code></pre>
<p>运行后访问浏览器，即可看到返回结果。这也是大多数 Express 应用的起点。</p>
<hr/>
<h2 data-id="heading-2">三、路由的基本使用</h2>
<p>路由是 Express 中最核心的概念之一，用于定义请求路径与处理逻辑之间的映射关系。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">list</span>: [] });
});

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/users'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'create user'</span>);
});
</code></pre>
<p>Express 根据请求方法和路径匹配对应的路由处理函数，顺序匹配非常重要。</p>
<hr/>
<h2 data-id="heading-3">四、请求对象与响应对象</h2>
<p>在路由处理中，最常用的是 <code>req</code> 和 <code>res</code> 对象。</p>
<p><code>req</code> 用于获取请求信息，例如参数、请求头、请求体等；
<code>res</code> 用于向客户端返回响应。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/detail'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> id = req.<span class="hljs-property">query</span>.<span class="hljs-property">id</span>;
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`id is <span class="hljs-subst">${id}</span>`</span>);
});
</code></pre>
<p>理解这两个对象的常用属性，是编写 Express 接口的基础。</p>
<hr/>
<h2 data-id="heading-4">五、中间件的概念</h2>
<p>中间件是 Express 的核心机制，用于在请求和响应之间执行通用逻辑。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">method</span>, req.<span class="hljs-property">url</span>);
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p>中间件可以用于日志记录、权限校验、参数处理等场景。只有调用 <code>next</code>，请求才会继续向下传递。</p>
<hr/>
<h2 data-id="heading-5">六、解析请求体数据</h2>
<p>在实际开发中，经常需要处理 POST 请求的请求体数据。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">urlencoded</span>({ <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));
</code></pre>
<p>配置完成后，可以通过 <code>req.body</code> 直接访问提交的数据。</p>
<hr/>
<h2 data-id="heading-6">七、静态资源服务</h2>
<p>Express 也可以用于提供静态资源服务，例如图片、前端构建产物等。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">'public'</span>));
</code></pre>
<p>这样可以直接通过 URL 访问指定目录下的文件。</p>
<hr/>
<h2 data-id="heading-7">八、错误处理基础</h2>
<p>Express 提供了统一的错误处理中间件机制。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'server error'</span>);
});
</code></pre>
<p>集中处理错误，有助于保持业务代码的简洁性和一致性。</p>
<hr/>
<h2 data-id="heading-8">九、Express 项目结构建议</h2>
<p>一个常见的 Express 项目结构包括：</p>
<ul>
<li>路由层，负责接口定义</li>
<li>控制层，处理业务逻辑</li>
<li>服务层，封装数据访问</li>
<li>中间件层，处理通用功能</li>
</ul>
<p>合理的结构可以显著提升项目的可维护性。</p>
<hr/>
<h2 data-id="heading-9">十、总结</h2>
<p>Express 是 Node.js 生态中最成熟、最稳定的 Web 框架之一。它在保持灵活性的同时，为开发者提供了足够的约束和规范，非常适合作为后端开发的入门与实战框架。</p>
<p>掌握 Express 的基础用法，是深入学习 Node.js Web 开发的关键一步。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 编程实战：路由与中间件]]></title>    <link>https://juejin.cn/post/7585888537642418191</link>    <guid>https://juejin.cn/post/7585888537642418191</guid>    <pubDate>2025-12-22T03:02:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585888537642418191" data-draft-id="7585888537642401807" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 编程实战：路由与中间件"/> <meta itemprop="keywords" content="后端,Node.js,前端"/> <meta itemprop="datePublished" content="2025-12-22T03:02:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 编程实战：路由与中间件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T03:02:41.000Z" title="Mon Dec 22 2025 03:02:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在 Node.js Web 开发中，路由与中间件是构建应用的两大核心机制。路由负责将请求分发到具体的业务处理逻辑，而中间件则负责在请求处理过程中执行通用操作。二者相互配合，构成了 Express 等框架的运行基础。</p>
</blockquote>
<p>理解路由匹配规则和中间件执行顺序，是写好 Node.js 服务端代码的关键。</p>
<hr/>
<h2 data-id="heading-0">一、什么是路由</h2>
<p>路由用于描述请求路径与处理函数之间的映射关系。一个完整的路由通常由请求方法、路径和回调函数组成。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'user list'</span>);
});
</code></pre>
<p>当客户端以 GET 方法访问 <code>/users</code> 时，Express 会执行对应的处理函数。</p>
<hr/>
<h2 data-id="heading-1">二、路由匹配规则</h2>
<p>Express 的路由是按<strong>定义顺序</strong>进行匹配的。一旦匹配成功，后续路由将不会再被执行。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users/:id'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>);
});
</code></pre>
<p>动态路由可以通过参数的形式获取路径中的变量，这在资源型接口设计中非常常见。</p>
<hr/>
<h2 data-id="heading-2">三、路由拆分与模块化</h2>
<p>在项目规模扩大后，将所有路由写在一个文件中会导致代码难以维护。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> router = express.<span class="hljs-title class_">Router</span>();

router.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/'</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'user list'</span>);
});

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = router;
</code></pre>
<p>通过路由模块化，可以让项目结构更加清晰，职责更加明确。</p>
<hr/>
<h2 data-id="heading-3">四、中间件的基本概念</h2>
<p>中间件本质上是一个函数，用于在请求进入路由之前或响应返回之前执行逻辑。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">method</span>, req.<span class="hljs-property">url</span>);
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p>中间件可以访问请求对象、响应对象，并决定是否继续传递请求。</p>
<hr/>
<h2 data-id="heading-4">五、中间件的执行顺序</h2>
<p>中间件按照<strong>注册顺序</strong>执行。</p>
<ul>
<li>全局中间件优先执行</li>
<li>路由级中间件按顺序执行</li>
<li>错误处理中间件最后执行</li>
</ul>
<p>一旦中间件没有调用 <code>next</code>，请求链将被中断。</p>
<hr/>
<h2 data-id="heading-5">六、常见中间件使用场景</h2>
<p>中间件通常用于处理通用逻辑，例如：</p>
<ul>
<li>请求日志记录</li>
<li>参数校验</li>
<li>用户认证与权限控制</li>
<li>请求体解析</li>
<li>跨域处理</li>
</ul>
<p>将这些逻辑从业务代码中抽离，可以显著提升代码可读性。</p>
<hr/>
<h2 data-id="heading-6">七、路由级中间件</h2>
<p>除了全局中间件，还可以为特定路由添加中间件。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">auth</span> = (<span class="hljs-params">req, res, next</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!req.<span class="hljs-property">headers</span>.<span class="hljs-property">token</span>) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'unauthorized'</span>);
  }
  <span class="hljs-title function_">next</span>();
};

app.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/profile'</span>, auth, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">'profile'</span>);
});
</code></pre>
<p>这种方式可以实现精细化的权限控制。</p>
<hr/>
<h2 data-id="heading-7">八、错误处理中间件</h2>
<p>Express 提供了专门的错误处理中间件形式。</p>
<pre><code class="hljs language-js" lang="js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> {
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'server error'</span>);
});
</code></pre>
<p>集中处理异常，有助于统一错误返回结构。</p>
<hr/>
<h2 data-id="heading-8">九、next 的使用注意事项</h2>
<p><code>next</code> 用于将控制权交给下一个中间件或路由。</p>
<p>需要注意：</p>
<ul>
<li>不调用 <code>next</code>，请求将被阻塞</li>
<li>调用 <code>next(err)</code> 会直接进入错误处理中间件</li>
<li>避免重复调用 <code>next</code></li>
</ul>
<p>合理使用 <code>next</code> 是中间件设计的核心。</p>
<hr/>
<h2 data-id="heading-9">十、路由与中间件的协作模式</h2>
<p>在实际项目中，常见的协作方式是：</p>
<ul>
<li>中间件负责通用逻辑</li>
<li>路由负责业务分发</li>
<li>控制器负责业务实现</li>
</ul>
<p>这种分层设计有助于项目长期维护和扩展。</p>
<hr/>
<h2 data-id="heading-10">十一、总结</h2>
<p>路由和中间件是 Node.js Web 框架中最重要的基础设施。路由决定请求走向，中间件决定请求如何被处理。只有真正理解它们的执行机制和设计思路，才能写出结构清晰、易维护的服务端代码。</p>
<p>在项目初期建立合理的路由和中间件体系，将为后续功能扩展打下坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官：Vision-Language 模型中，如何实现跨模态特征对齐？CLIP 与 BLIP 的主要区别？]]></title>    <link>https://juejin.cn/post/7585798113546977330</link>    <guid>https://juejin.cn/post/7585798113546977330</guid>    <pubDate>2025-12-21T15:20:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585798113546977330" data-draft-id="7585798113546960946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官：Vision-Language 模型中，如何实现跨模态特征对齐？CLIP 与 BLIP 的主要区别？"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-21T15:20:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="coting"/> <meta itemprop="url" content="https://juejin.cn/user/933911964427818"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官：Vision-Language 模型中，如何实现跨模态特征对齐？CLIP 与 BLIP 的主要区别？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/933911964427818/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    coting
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T15:20:19.000Z" title="Sun Dec 21 2025 15:20:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>面试官：<strong>Vision-Language 模型中是如何实现跨模态特征对齐的？CLIP 和 BLIP 有什么区别？</strong></p>
<p>这道题表面上问“特征对齐”，其实考察的是你对多模态表示学习（Multimodal Representation Learning）的理解深度。</p>
<p>所有相关源码示例、流程图、面试八股、模型配置与知识库构建技巧，我也将持续更新在Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faicoting%2FAIHub" target="_blank" title="https://github.com/aicoting/AIHub" ref="nofollow noopener noreferrer"><strong>AIHub</strong></a>，欢迎关注收藏！</p>
<h2 data-id="heading-0">一、为什么要跨模态特征对齐？</h2>
<p>在 Vision-Language 模型里，我们面对的是两种完全不同的数据模态：</p>
<ul>
<li>图像：二维像素矩阵，结构连续但语义隐含；</li>
<li>文本：一维离散序列，语义明确但结构缺失。</li>
</ul>
<p>这两种模态的表示空间天然不一样。<br/>
如果你直接把图像特征和文本特征拼在一起去算相似度，模型是无法理解它们的关系的。</p>
<p>所以核心目标就是<strong>把不同模态的特征映射到同一个语义空间（Shared Embedding Space）中，让它们可以对齐、对比、甚至互相生成。</strong></p>
<p>这一步就叫 <strong>跨模态特征对齐（Cross-modal Alignment）</strong>。</p>
<h2 data-id="heading-1">二、跨模态对齐的三种典型思路</h2>
<p>跨模态对齐并不是一刀切的，有不同层次的实现方式：</p>
<h3 data-id="heading-2">1.表征级对齐（Representation-level Alignment）</h3>
<p>最常见的一种，也是 <strong>CLIP</strong> 的核心思路。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4595bc92670b447a873be80d51efb597~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766935218&amp;x-signature=HWqTa%2FKOJe7VfLy40oSXgQu26hI%3D" alt="" loading="lazy"/></p>
<p>CLIP 会：</p>
<ul>
<li>用一个视觉编码器（Vision Encoder, 通常是 ViT）提取图像特征；</li>
<li>用一个文本编码器（Text Encoder, 通常是 Transformer）提取文本特征；</li>
<li>然后用**对比学习（Contrastive Learning）**让同一图文对的相似度更高，不同图文对的相似度更低。</li>
</ul>
<p>公式上写就是：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/142ac638074c4bcf9345f69ba487a093~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766935218&amp;x-signature=DU408ZKD3wjgkXdKc38PgDDHYfY%3D" alt="image" loading="lazy"/><br/>
这样，视觉空间和语言空间就被压缩到一个共同的语义空间中。</p>
<p>表征级对齐方法训练简单、高效，但是只能捕捉“整体语义”，缺乏细粒度的对齐（比如“狗在草地上跑”的局部理解）。</p>
<h3 data-id="heading-3">2.局部级对齐（Fine-grained Alignment）</h3>
<p>这种方法更精细一些，比如 <strong>BLIP</strong> 系列模型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb2f0aee169b4136a1151a87916de9db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766935218&amp;x-signature=Ri0CeM9trk5PlYFDg9n%2FxGK4Gxs%3D" alt="" loading="lazy"/></p>
<p>它不满足于只对齐整张图片和整段文字，而是进一步通过 <strong>Cross-Attention</strong> 实现细粒度的 token-level 对齐：</p>
<p>哪个词对应图像的哪个区域？<br/>
“cat” 对应哪一块特征？</p>
<p>“on the bed” 对应哪一块背景？</p>
<p>在 BLIP 中，图像特征会先经过一个视觉编码器提取成 patch embedding，然后输入到一个<strong>多模态 Transformer</strong>里，与文本 token 通过交叉注意力（Cross-Attention）交互。<br/>
这样模型不仅知道“图像整体说的是什么”，还能理解“图像里的每个部分对应哪段文字”。</p>
<p>局部级对齐能实现图文理解、问答、生成等复杂任务，但是计算更重、训练更复杂。</p>
<h3 data-id="heading-4">3.语义层对齐（Semantic-level Alignment）</h3>
<p>这类方法通常出现在生成式模型（比如 BLIP-2、Flamingo、LLaVA）中。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc13a34e3a0c4ec4ade7e8a958d3afaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY290aW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766935218&amp;x-signature=M3g3VGz1BL%2BCJDOG6DTXODywpos%3D" alt="" loading="lazy"/></p>
<p>它们会使用一个<strong>冻结的大语言模型（LLM）作为语言理解核心，再用一个轻量的视觉投影器（Q-former 或 Adapter）</strong>，把视觉特征转化为 LLM 能理解的 token 形式，从而实现语义层面对齐。</p>
<p>这种方式特别适合 <strong>视觉问答（VQA）</strong>、<strong>图文生成</strong> 任务，代表模型包括 <strong>BLIP-2、LLaVA、MiniGPT-4</strong> 等。</p>
<hr/>
<h2 data-id="heading-5">三、CLIP vs BLIP：到底有什么不同？</h2>
<p>我们可以用一个表格来看一下CLIP和BLIP的主要区别：</p>













































<table><thead><tr><th align="center">对比项</th><th align="center"><strong>CLIP</strong></th><th align="center"><strong>BLIP</strong></th></tr></thead><tbody><tr><td align="center">模型类型</td><td align="center">双编码器（Dual Encoder）</td><td align="center">交叉编码器（Cross Encoder）</td></tr><tr><td align="center">对齐方式</td><td align="center">对比学习，全局语义对齐</td><td align="center">Cross-Attention，细粒度对齐</td></tr><tr><td align="center">输入输出</td><td align="center">图像 + 文本 → 相似度</td><td align="center">图像 + 文本 → 理解或生成</td></tr><tr><td align="center">任务类型</td><td align="center">检索（Retrieval）、匹配</td><td align="center">理解（VQA）、生成（Captioning）</td></tr><tr><td align="center">训练目标</td><td align="center">图文对比损失（InfoNCE）</td><td align="center">图文生成 + 对比 + 重构</td></tr><tr><td align="center">特点</td><td align="center">快、泛化强、预训练高效</td><td align="center">理解深、语义细腻、可迁移生成任务</td></tr><tr><td align="center">代表应用</td><td align="center">CLIP, ALIGN, Florence</td><td align="center">BLIP, BLIP-2, LLaVA, MiniGPT-4</td></tr></tbody></table>
<p>面试官问这题，不是想听你背论文，而是想看你能否抓住<strong>核心逻辑</strong>。</p>
<p>一个简洁高分答案可以这样组织：</p>
<p>Vision-Language 模型的关键是跨模态特征对齐。<br/>
常见的实现方式包括：</p>
<ul>
<li><strong>表征级对齐</strong>：CLIP 通过对比学习在全局语义空间对齐；</li>
<li><strong>局部级对齐</strong>：BLIP 通过 Cross-Attention 实现细粒度图文交互；</li>
<li><strong>语义层对齐</strong>：BLIP-2 将视觉特征映射到语言模型 token 空间。<br/>
其中，CLIP 强在高效检索与表示学习，BLIP 强在生成与多模态理解。</li>
</ul>
<p>这样答既有体系，也能体现你对架构演进的理解。</p>
<p>总结一下，CLIP 把视觉数据和文本数据连了起来，BLIP 让模型不仅能“理解”，还能“表达”。</p>
<p>这条演化路径其实就是多模态模型走向智能体（Agent）的必经之路：从对齐到交互，从理解到生成。</p>
<p>如果你能从这个视角去看待多模态模型的设计逻辑，那么你也就会慢慢对人工智能有了更加深入的理解。</p>
<p>关于深度学习和大模型相关的知识和前沿技术更新，请关注公众号 <strong>aicoting</strong>！</p>
<p><strong>📚推荐阅读</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1962254381677257759" target="_blank" title="https://zhuanlan.zhihu.com/p/1962254381677257759" ref="nofollow noopener noreferrer">面试官：Transformer如何优化到线性级？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1962929340292502638" target="_blank" title="https://zhuanlan.zhihu.com/p/1962929340292502638" ref="nofollow noopener noreferrer">面试官：模型的量化了解吗？解释一下非对称量化与对称量化</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1962947114230346375" target="_blank" title="https://zhuanlan.zhihu.com/p/1962947114230346375" ref="nofollow noopener noreferrer">面试官：模型剪枝了解吗？解释一下结构化剪枝与非结构化剪枝</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1963373485435917372" target="_blank" title="https://zhuanlan.zhihu.com/p/1963373485435917372" ref="nofollow noopener noreferrer">面试官：为什么 Adam 在部分任务上会比 SGD 收敛更快，但泛化性更差？如何改进？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1963547933044631464" target="_blank" title="https://zhuanlan.zhihu.com/p/1963547933044631464" ref="nofollow noopener noreferrer">面试官：BatchNorm、LayerNorm、GroupNorm、InstanceNorm 有什么本质区别？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1964062982347687219" target="_blank" title="https://zhuanlan.zhihu.com/p/1964062982347687219" ref="nofollow noopener noreferrer">面试官：深层网络梯度消失的根本原因是什么？除了 ResNet，还有哪些架构能有效缓解？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F82010759692" target="_blank" title="https://zhuanlan.zhihu.com/p/82010759692" ref="nofollow noopener noreferrer">面试官：大模型中的幻觉本质原因是什么？如何通过训练或推理手段抑制？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1965142986452108272" target="_blank" title="https://zhuanlan.zhihu.com/p/1965142986452108272" ref="nofollow noopener noreferrer">面试官：FlashAttention 的实现原理与内存优化方式？为什么能做到 O(N²) attention 的显存线性化？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F1965823665364014863" target="_blank" title="https://zhuanlan.zhihu.com/p/1965823665364014863" ref="nofollow noopener noreferrer">面试官：KV Cache 了解吗？推理阶段 KV Cache 的复用原理？动态批处理如何提升吞吐？</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python三维绘图全教程：plot3d/mesh/surf/contour函数实战（附完整代码）]]></title>    <link>https://juejin.cn/post/7585743487258689545</link>    <guid>https://juejin.cn/post/7585743487258689545</guid>    <pubDate>2025-12-21T12:10:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585743487258689545" data-draft-id="7585534343562887218" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python三维绘图全教程：plot3d/mesh/surf/contour函数实战（附完整代码）"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-21T12:10:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="月度空间"/> <meta itemprop="url" content="https://juejin.cn/user/1567280531253689"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python三维绘图全教程：plot3d/mesh/surf/contour函数实战（附完整代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1567280531253689/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    月度空间
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T12:10:18.000Z" title="Sun Dec 21 2025 12:10:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据可视化、科学计算和工程分析中，三维绘图是展示空间数据、函数关系的重要手段。MATLAB中常用<code>plot3()</code>、<code>mesh()</code>、<code>surf()</code>、<code>contour()</code>实现三维绘图，而Python的<code>matplotlib</code>库通过<code>mplot3d</code>模块完美复刻了这些功能（对应<code>plot3D()</code>、<code>plot_wireframe()</code>、<code>plot_surface()</code>、<code>contour3D()</code>等函数）。</p>
<h2 data-id="heading-0">一、准备工作：安装依赖与基础环境搭建</h2>
<h3 data-id="heading-1">1.1 安装必备库</h3>
<p>Python三维绘图依赖<code>matplotlib</code>（绘图核心）和<code>numpy</code>（数值计算与数据生成），执行以下命令安装：</p>
<pre><code class="hljs language-bash" lang="bash">pip install matplotlib numpy
</code></pre>
<h3 data-id="heading-2">1.2 导入模块与创建3D绘图环境</h3>
<p><code>matplotlib</code>的<code>mplot3d</code>模块是实现3D绘图的核心，需先导入并创建3D坐标轴对象：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> mpl_toolkits <span class="hljs-keyword">import</span> mplot3d  <span class="hljs-comment"># 必须导入，启用3D绘图功能</span>

<span class="hljs-comment"># 创建画布与3D坐标轴</span>
fig = plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">6</span>))  <span class="hljs-comment"># 设置画布大小</span>
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)    <span class="hljs-comment"># 指定投影为3D</span>
plt.show()  <span class="hljs-comment"># 显示绘图窗口</span>
</code></pre>
<p><strong>关键说明</strong>：<code>projection='3d'</code>是创建3D绘图环境的核心参数，缺少则默认生成2D坐标轴。</p>
<h2 data-id="heading-3">二、3D线图（对应MATLAB plot3()）：ax.plot3D()</h2>
<p><code>plot3D()</code>是MATLAB<code>plot3()</code>的Python等价函数，用于绘制<strong>三维空间中的折线/曲线</strong>，适合展示一维数据的空间轨迹（如运动路径、螺旋线）。</p>
<h3 data-id="heading-4">2.1 基本语法</h3>
<pre><code class="hljs language-python" lang="python">ax.plot3D(xdata, ydata, zdata, color, linewidth, label, ...)
</code></pre>
<ul>
<li><code>xdata/ydata/zdata</code>：三维坐标数据（需为等长数组）；</li>
<li><code>color</code>：线条颜色（如<code>'red'</code>、<code>'#FF5733'</code>）；</li>
<li><code>linewidth</code>：线条宽度；</li>
<li><code>label</code>：图例标签。</li>
</ul>
<h3 data-id="heading-5">2.2 实战案例：绘制三维螺旋线</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> mpl_toolkits <span class="hljs-keyword">import</span> mplot3d

<span class="hljs-comment"># 生成数据：螺旋线参数方程</span>
theta = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">10</span> * np.pi, <span class="hljs-number">1000</span>)  <span class="hljs-comment"># 角度范围</span>
x = np.sin(theta) * np.cos(theta)         <span class="hljs-comment"># x坐标</span>
y = np.sin(theta) * np.sin(theta)         <span class="hljs-comment"># y坐标</span>
z = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1000</span>)               <span class="hljs-comment"># z坐标</span>

<span class="hljs-comment"># 创建3D绘图环境</span>
fig = plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">6</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)

<span class="hljs-comment"># 绘制3D线图</span>
ax.plot3D(x, y, z, color=<span class="hljs-string">'blue'</span>, linewidth=<span class="hljs-number">2</span>, label=<span class="hljs-string">'3D螺旋线'</span>)

<span class="hljs-comment"># 设置坐标轴标签与图例</span>
ax.set_xlabel(<span class="hljs-string">'X轴'</span>, fontsize=<span class="hljs-number">12</span>)
ax.set_ylabel(<span class="hljs-string">'Y轴'</span>, fontsize=<span class="hljs-number">12</span>)
ax.set_zlabel(<span class="hljs-string">'Z轴'</span>, fontsize=<span class="hljs-number">12</span>)
ax.legend(loc=<span class="hljs-string">'upper right'</span>)
ax.set_title(<span class="hljs-string">'三维螺旋线（plot3D实现）'</span>, fontsize=<span class="hljs-number">14</span>)

plt.show()
</code></pre>
<p><strong>结果解读</strong>：代码通过参数方程生成螺旋线的三维坐标，<code>plot3D()</code>将其连接为连续曲线，可清晰看到曲线在XY平面呈螺旋状，沿Z轴线性上升。</p>
<h3 data-id="heading-6">2.3 拓展：绘制三维随机折线</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 生成随机三维数据</span>
np.random.seed(<span class="hljs-number">42</span>)  <span class="hljs-comment"># 固定随机种子</span>
x = np.cumsum(np.random.randn(<span class="hljs-number">100</span>))
y = np.cumsum(np.random.randn(<span class="hljs-number">100</span>))
z = np.cumsum(np.random.randn(<span class="hljs-number">100</span>))

<span class="hljs-comment"># 绘图</span>
fig = plt.figure(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">6</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)
ax.plot3D(x, y, z, color=<span class="hljs-string">'green'</span>, marker=<span class="hljs-string">'o'</span>, markersize=<span class="hljs-number">3</span>, label=<span class="hljs-string">'随机折线'</span>)

ax.set_xlabel(<span class="hljs-string">'X'</span>)
ax.set_ylabel(<span class="hljs-string">'Y'</span>)
ax.set_zlabel(<span class="hljs-string">'Z'</span>)
ax.legend()
ax.set_title(<span class="hljs-string">'三维随机折线'</span>)
plt.show()
</code></pre>
<p><strong>技巧</strong>：添加<code>marker</code>参数可显示数据点，便于观察离散数据的空间分布。</p>
<h2 data-id="heading-7">三、3D网格图（对应MATLAB mesh()）：ax.plot_wireframe()</h2>
<p><code>plot_wireframe()</code>对应MATLAB的<code>mesh()</code>，用于绘制<strong>三维网格面</strong>，仅显示曲面的网格线条，适合展示函数的空间轮廓，不填充颜色。</p>
<h3 data-id="heading-8">3.1 核心步骤：生成网格数据</h3>
<p>绘制二维函数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>z</mi><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">z = f(x, y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span></span>的网格图，需先通过<code>np.meshgrid()</code>生成X、Y平面的网格坐标：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 生成x、y轴的一维数据</span>
x = np.linspace(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">50</span>)
y = np.linspace(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>, <span class="hljs-number">50</span>)
<span class="hljs-comment"># 生成网格坐标矩阵</span>
X, Y = np.meshgrid(x, y)
</code></pre>
<p><strong>说明</strong>：<code>np.meshgrid()</code>将一维的x、y转换为二维矩阵，使每个<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>X</mi><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>Y</mi><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(X[i,j], Y[i,j])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">])</span></span></span></span></span>对应平面上的一个点。</p>
<h3 data-id="heading-9">3.2 基本语法</h3>
<pre><code class="hljs language-python" lang="python">ax.plot_wireframe(X, Y, Z, rstride, cstride, color, linewidth, ...)
</code></pre>
<ul>
<li><code>rstride/cstride</code>：行/列步长（数值越大，网格越稀疏）；</li>
<li><code>Z</code>：与X、Y对应的z轴数据矩阵。</li>
</ul>
<h3 data-id="heading-10">3.3 实战案例：绘制正弦曲面网格图</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> mpl_toolkits <span class="hljs-keyword">import</span> mplot3d

<span class="hljs-comment"># 1. 生成网格数据</span>
x = np.linspace(-np.pi, np.pi, <span class="hljs-number">30</span>)
y = np.linspace(-np.pi, np.pi, <span class="hljs-number">30</span>)
X, Y = np.meshgrid(x, y)
<span class="hljs-comment"># 2. 定义三维函数：z = sin(X) + cos(Y)</span>
Z = np.sin(X) + np.cos(Y)

<span class="hljs-comment"># 3. 创建3D绘图环境</span>
fig = plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)

<span class="hljs-comment"># 4. 绘制网格图</span>
ax.plot_wireframe(X, Y, Z, rstride=<span class="hljs-number">2</span>, cstride=<span class="hljs-number">2</span>, color=<span class="hljs-string">'purple'</span>, linewidth=<span class="hljs-number">1</span>)

<span class="hljs-comment"># 5. 设置标签与标题</span>
ax.set_xlabel(<span class="hljs-string">'X (rad)'</span>, fontsize=<span class="hljs-number">12</span>)
ax.set_ylabel(<span class="hljs-string">'Y (rad)'</span>, fontsize=<span class="hljs-number">12</span>)
ax.set_zlabel(<span class="hljs-string">'Z'</span>, fontsize=<span class="hljs-number">12</span>)
ax.set_title(<span class="hljs-string">'三维正弦曲面网格图（mesh/plot_wireframe实现）'</span>, fontsize=<span class="hljs-number">14</span>)

plt.show()
</code></pre>
<p><strong>参数解读</strong>：<code>rstride=2, cstride=2</code>表示每隔2个点绘制一条网格线，若设为1则网格密集，渲染速度变慢；<code>color</code>统一设置网格线条颜色。</p>
<h2 data-id="heading-11">四、3D曲面图（对应MATLAB surf()）：ax.plot_surface()</h2>
<p><code>plot_surface()</code>对应MATLAB的<code>surf()</code>，用于绘制<strong>填充颜色的三维曲面</strong>，通过颜色映射（colormap）可直观展示Z值的变化，是最常用的三维曲面可视化方法。</p>
<h3 data-id="heading-12">4.1 基本语法</h3>
<pre><code class="hljs language-python" lang="python">ax.plot_surface(X, Y, Z, cmap, alpha, edgecolor, ...)
</code></pre>
<ul>
<li><code>cmap</code>：颜色映射方案（如<code>'viridis'</code>、<code>'plasma'</code>、<code>'coolwarm'</code>）；</li>
<li><code>alpha</code>：透明度（0-1，1为不透明）；</li>
<li><code>edgecolor</code>：曲面边缘线条颜色（设为<code>'none'</code>则隐藏边缘）。</li>
</ul>
<h3 data-id="heading-13">4.2 实战案例1：绘制抛物面曲面图</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> mpl_toolkits <span class="hljs-keyword">import</span> mplot3d

<span class="hljs-comment"># 生成网格数据</span>
x = np.linspace(-<span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">50</span>)
y = np.linspace(-<span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">50</span>)
X, Y = np.meshgrid(x, y)
<span class="hljs-comment"># 抛物面函数：z = x² + y²</span>
Z = X**<span class="hljs-number">2</span> + Y**<span class="hljs-number">2</span>

<span class="hljs-comment"># 创建绘图环境</span>
fig = plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)

<span class="hljs-comment"># 绘制曲面图</span>
surf = ax.plot_surface(X, Y, Z, cmap=<span class="hljs-string">'viridis'</span>, alpha=<span class="hljs-number">0.8</span>, edgecolor=<span class="hljs-string">'black'</span>)

<span class="hljs-comment"># 添加颜色条（展示Z值与颜色的对应关系）</span>
fig.colorbar(surf, ax=ax, shrink=<span class="hljs-number">0.6</span>, aspect=<span class="hljs-number">10</span>, label=<span class="hljs-string">'Z值'</span>)

<span class="hljs-comment"># 设置标签与标题</span>
ax.set_xlabel(<span class="hljs-string">'X'</span>)
ax.set_ylabel(<span class="hljs-string">'Y'</span>)
ax.set_zlabel(<span class="hljs-string">'Z'</span>)
ax.set_title(<span class="hljs-string">'三维抛物面曲面图（surf/plot_surface实现）'</span>, fontsize=<span class="hljs-number">14</span>)

plt.show()
</code></pre>
<p><strong>结果解读</strong>：颜色从蓝到黄渐变，对应Z值从0（中心）到32（边缘）递增，颜色条清晰展示了数值与颜色的映射关系；<code>edgecolor='black'</code>让曲面的网格边缘更明显。</p>
<h3 data-id="heading-14">4.3 实战案例2：彩色正弦曲面（隐藏边缘）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 复用前文的X、Y、Z数据（Z = sin(X) + cos(Y)）</span>
fig = plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)

<span class="hljs-comment"># 隐藏边缘的曲面图</span>
surf = ax.plot_surface(X, Y, Z, cmap=<span class="hljs-string">'coolwarm'</span>, alpha=<span class="hljs-number">0.9</span>, edgecolor=<span class="hljs-string">'none'</span>)

fig.colorbar(surf, ax=ax, shrink=<span class="hljs-number">0.6</span>, label=<span class="hljs-string">'Z值'</span>)
ax.set_xlabel(<span class="hljs-string">'X (rad)'</span>)
ax.set_ylabel(<span class="hljs-string">'Y (rad)'</span>)
ax.set_zlabel(<span class="hljs-string">'Z'</span>)
ax.set_title(<span class="hljs-string">'彩色正弦曲面（无边缘）'</span>, fontsize=<span class="hljs-number">14</span>)

plt.show()
</code></pre>
<p><strong>技巧</strong>：<code>edgecolor='none'</code>可让曲面更平滑，适合展示连续的颜色渐变效果。</p>
<h2 data-id="heading-15">五、等高线图（对应MATLAB contour()）：contour()/contour3D()</h2>
<p>等高线图通过<strong>二维平面上的闭合曲线</strong>展示三维函数的Z值分布，分为<strong>2D等高线</strong>（<code>ax.contour()</code>）和<strong>3D等高线</strong>（<code>ax.contour3D()</code>），对应MATLAB的<code>contour()</code>和<code>contour3()</code>。</p>
<h3 data-id="heading-16">5.1 2D等高线图：ax.contour()</h3>
<h4 data-id="heading-17">5.1.1 基本语法</h4>
<pre><code class="hljs language-python" lang="python">ax.contour(X, Y, Z, levels, colors, linewidths, label, ...)
</code></pre>
<ul>
<li><code>levels</code>：等高线层级数（或指定具体数值）；</li>
<li><code>colors</code>：等高线颜色；</li>
<li><code>linewidths</code>：线条宽度。</li>
</ul>
<h4 data-id="heading-18">5.1.2 实战案例：抛物面2D等高线</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 复用抛物面的X、Y、Z数据</span>
fig, ax = plt.subplots(figsize=(<span class="hljs-number">8</span>, <span class="hljs-number">6</span>))

<span class="hljs-comment"># 绘制2D等高线</span>
contour = ax.contour(X, Y, Z, levels=<span class="hljs-number">15</span>, cmap=<span class="hljs-string">'viridis'</span>, linewidths=<span class="hljs-number">1.5</span>)

<span class="hljs-comment"># 添加等高线数值标签</span>
ax.clabel(contour, inline=<span class="hljs-literal">True</span>, fontsize=<span class="hljs-number">8</span>, fmt=<span class="hljs-string">'%.1f'</span>)

<span class="hljs-comment"># 设置标签与标题</span>
ax.set_xlabel(<span class="hljs-string">'X'</span>)
ax.set_ylabel(<span class="hljs-string">'Y'</span>)
ax.set_title(<span class="hljs-string">'抛物面2D等高线图'</span>, fontsize=<span class="hljs-number">14</span>)
plt.grid(<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.3</span>)
plt.show()
</code></pre>
<p><strong>关键参数</strong>：<code>ax.clabel()</code>用于添加等高线的数值标签，<code>inline=True</code>表示标签嵌入线条内部。</p>
<h3 data-id="heading-19">5.2 3D等高线图：ax.contour3D()</h3>
<p><code>contour3D()</code>将等高线绘制在<strong>三维空间的指定Z平面</strong>，保留三维空间的立体感。</p>
<h4 data-id="heading-20">5.2.1 基本语法</h4>
<pre><code class="hljs language-python" lang="python">ax.contour3D(X, Y, Z, levels, cmap, linewidths, ...)
</code></pre>
<h4 data-id="heading-21">5.2.2 实战案例：正弦曲面3D等高线</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 复用正弦曲面的X、Y、Z数据</span>
fig = plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)

<span class="hljs-comment"># 绘制3D等高线（20个层级）</span>
ax.contour3D(X, Y, Z, levels=<span class="hljs-number">20</span>, cmap=<span class="hljs-string">'coolwarm'</span>, linewidths=<span class="hljs-number">1</span>)

<span class="hljs-comment"># 设置视角与标签</span>
ax.view_init(elev=<span class="hljs-number">30</span>, azim=<span class="hljs-number">60</span>)  <span class="hljs-comment"># 调整视角（仰角30°，方位角60°）</span>
ax.set_xlabel(<span class="hljs-string">'X (rad)'</span>)
ax.set_ylabel(<span class="hljs-string">'Y (rad)'</span>)
ax.set_zlabel(<span class="hljs-string">'Z'</span>)
ax.set_title(<span class="hljs-string">'正弦曲面3D等高线图'</span>, fontsize=<span class="hljs-number">14</span>)

plt.show()
</code></pre>
<p><strong>视角调整</strong>：<code>ax.view_init(elev, azim)</code>可手动设置绘图视角，<code>elev</code>为仰角（与XY平面的夹角），<code>azim</code>为方位角（绕Z轴的旋转角度）。</p>
<h3 data-id="heading-22">5.3 混合绘图：曲面图+3D等高线</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 抛物面数据的曲面+3D等高线混合图</span>
fig = plt.figure(figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))
ax = plt.axes(projection=<span class="hljs-string">'3d'</span>)

<span class="hljs-comment"># 绘制曲面（半透明）</span>
ax.plot_surface(X, Y, Z, cmap=<span class="hljs-string">'viridis'</span>, alpha=<span class="hljs-number">0.5</span>, edgecolor=<span class="hljs-string">'none'</span>)
<span class="hljs-comment"># 绘制3D等高线</span>
ax.contour3D(X, Y, Z, levels=<span class="hljs-number">10</span>, cmap=<span class="hljs-string">'viridis'</span>, linewidths=<span class="hljs-number">2</span>)

ax.set_xlabel(<span class="hljs-string">'X'</span>)
ax.set_ylabel(<span class="hljs-string">'Y'</span>)
ax.set_zlabel(<span class="hljs-string">'Z'</span>)
ax.set_title(<span class="hljs-string">'抛物面：曲面图+3D等高线'</span>, fontsize=<span class="hljs-number">14</span>)
plt.show()
</code></pre>
<p><strong>实战价值</strong>：混合绘图既展示了曲面的整体形态，又通过等高线清晰标注了Z值的分布，适合专业报告与论文可视化。</p>
<h2 data-id="heading-23">六、三维绘图常见技巧与问题解决</h2>
<h3 data-id="heading-24">6.1 调整视角</h3>
<p>除了<code>ax.view_init()</code>，还可在绘图窗口中<strong>鼠标交互调整</strong>：</p>
<ul>
<li>左键拖动：旋转视角（调整azim/elev）；</li>
<li>滚轮：缩放画面；</li>
<li>右键拖动：平移画面。</li>
</ul>
<h3 data-id="heading-25">6.2 设置坐标轴范围</h3>
<p>通过<code>ax.set_xlim()</code>/<code>ax.set_ylim()</code>/<code>ax.set_zlim()</code>固定坐标轴范围，避免自动缩放导致的比例失调：</p>
<pre><code class="hljs language-python" lang="python">ax.set_xlim(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>)
ax.set_ylim(-<span class="hljs-number">5</span>, <span class="hljs-number">5</span>)
ax.set_zlim(-<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)
</code></pre>
<h3 data-id="heading-26">6.3 保存高清图片</h3>
<p>使用<code>plt.savefig()</code>保存图片，设置<code>dpi</code>参数提高分辨率：</p>
<pre><code class="hljs language-python" lang="python">plt.savefig(<span class="hljs-string">'3d_surface.png'</span>, dpi=<span class="hljs-number">300</span>, bbox_inches=<span class="hljs-string">'tight'</span>)
</code></pre>
<ul>
<li><code>dpi=300</code>：适合印刷/论文的高清分辨率；</li>
<li><code>bbox_inches='tight'</code>：裁剪空白边缘。</li>
</ul>
<h3 data-id="heading-27">6.4 解决“网格/曲面渲染模糊”问题</h3>
<ul>
<li>增大<code>np.linspace()</code>的采样点数（如从30改为50），让数据更密集；</li>
<li>保存图片时提高<code>dpi</code>；</li>
<li>减少<code>rstride/cstride</code>的步长（设为1）。</li>
</ul>
<h3 data-id="heading-28">6.5 自定义颜色映射</h3>
<p><code>matplotlib</code>内置了数十种颜色映射方案，也可自定义：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> matplotlib.colors <span class="hljs-keyword">import</span> LinearSegmentedColormap

<span class="hljs-comment"># 自定义从红到绿的颜色映射</span>
colors = [(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), (<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>)]  <span class="hljs-comment"># 红→绿</span>
cmap = LinearSegmentedColormap.from_list(<span class="hljs-string">'custom'</span>, colors, N=<span class="hljs-number">100</span>)
ax.plot_surface(X, Y, Z, cmap=cmap)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Github项目CI&CD部署]]></title>    <link>https://juejin.cn/post/7585839411121766446</link>    <guid>https://juejin.cn/post/7585839411121766446</guid>    <pubDate>2025-12-21T13:42:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585839411121766446" data-draft-id="7585839411121750062" data-original-type="2" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Github项目CI&amp;CD部署"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-21T13:42:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="charlee44"/> <meta itemprop="url" content="https://juejin.cn/user/1117549770846872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Github项目CI&amp;CD部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117549770846872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    charlee44
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T13:42:04.000Z" title="Sun Dec 21 2025 13:42:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 引言</h2>
<p>在软件开发中，<strong>CI/CD</strong>（持续集成 / 持续部署）是一种自动化流程：每当代码更新，系统会自动<strong>构建、测试并部署</strong>应用，避免手动操作的繁琐与错误。作为 DevOps 的核心实践，CI/CD 有力支撑了敏捷开发“快速交付、持续反馈”的理念，让团队既能灵活响应变化，又能保障交付质量。</p>
<h2 data-id="heading-1">2. 操作</h2>
<h3 data-id="heading-2">2.1 配置 SSH 密钥</h3>
<p>如果代码托管在 GitHub 上，那么可以通过 GitHub Actions 来实现 CI/CD 部署。其实 GitHub Actions 的实现原理很简单，就是通过 SSH 登录到目标主机，然后执行一键安装部署脚本。</p>
<p>由于 GitHub Actions 的原理是 Github 主机登录到目标主机（Ubuntu）来执行命令，因此最好先生成一对专用于 CI/CD 新的 SSH 密钥。笔者的开发环境是 Windows，因此通过 PowerShell 来生成：</p>
<pre><code class="hljs language-bash" lang="bash">ssh-keygen -t rsa -b 4096 -f ./github_cicd_key
</code></pre>
<p>然后会提示输入密码：</p>
<pre><code class="hljs language-bash" lang="bash">Enter passphrase (empty <span class="hljs-keyword">for</span> no passphrase):
</code></pre>
<p>CI/CD 场景下一般用无密码密钥，直接按回车。结束运行后就可以看到两个密钥文件：</p>
<ul>
<li>github_cicd_key（私钥）</li>
<li>github_cicd_key.pub（公钥）</li>
</ul>
<p>将公钥内容添加到 Ubuntu 服务器的 ~/.ssh/authorized_keys：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在 Ubuntu 服务器上执行</span>&#13;
<span class="hljs-built_in">echo</span> <span class="hljs-string">"粘贴 github_cicd_key.pub 的全部内容"</span> &gt;&gt; ~/.ssh/authorized_keys
</code></pre>
<p>回到 GitHub 仓库页面：</p>
<ul>
<li>进入 Settings -&gt; Security -&gt; Secrets and variables → Actions</li>
<li>点击 New repository secret</li>
<li>添加以下三个 Secret：</li>
</ul>





















<table><thead><tr><th>Name</th><th>Value（值）</th></tr></thead><tbody><tr><td>SERVER_HOST</td><td>目标主机 IP（如 123.123.123.123）</td></tr><tr><td>SERVER_USER</td><td>登录用户名（如 ubuntu、root 等）</td></tr><tr><td>SSH_PRIVATE_KEY</td><td>打开 github_cicd_key 文件，复制全部内容粘贴进来</td></tr></tbody></table>
<h3 data-id="heading-3">2.2 创建 CI/CD 工作流</h3>
<p>在本地项目根目录（Windows 上）创建文件：</p>
<pre><code class="hljs language-text" lang="text">.github/workflows/build-and-deploy.yml
</code></pre>
<p>内容如下所示：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">Blog</span>&#13;
&#13;
<span class="hljs-comment"># 支持两种触发方式</span>&#13;
<span class="hljs-attr">on:</span>&#13;
  <span class="hljs-comment"># 1. 手动触发（GitHub UI 上点击 "Run workflow"）</span>&#13;
  <span class="hljs-attr">workflow_dispatch:</span>&#13;
&#13;
  <span class="hljs-comment"># 2. 自动触发：仅当推送到 main 分支 且 提交信息含 [deploy]</span>&#13;
  <span class="hljs-attr">push:</span>&#13;
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>]&#13;
&#13;
<span class="hljs-attr">jobs:</span>&#13;
  <span class="hljs-attr">deploy:</span> &#13;
    <span class="hljs-attr">if:</span> <span class="hljs-string">&gt;</span>&#13;
      <span class="hljs-string">github.event_name</span> <span class="hljs-string">==</span> <span class="hljs-string">'workflow_dispatch'</span> <span class="hljs-string">||</span>&#13;
      <span class="hljs-string">(github.event_name</span> <span class="hljs-string">==</span> <span class="hljs-string">'push'</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">contains(github.event.head_commit.message,</span> <span class="hljs-string">'[deploy]'</span><span class="hljs-string">))</span>&#13;
&#13;
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>&#13;
    <span class="hljs-attr">steps:</span>&#13;
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">remote</span> <span class="hljs-string">script</span> <span class="hljs-string">via</span> <span class="hljs-string">SSH</span>&#13;
        <span class="hljs-attr">uses:</span> <span class="hljs-string">appleboy/ssh-action@v1.0.3</span>&#13;
        <span class="hljs-attr">with:</span>&#13;
          <span class="hljs-attr">host:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_HOST</span> <span class="hljs-string">}}</span>&#13;
          <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_USER</span> <span class="hljs-string">}}</span>&#13;
          <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SSH_PRIVATE_KEY</span> <span class="hljs-string">}}</span>&#13;
          <span class="hljs-attr">script:</span> <span class="hljs-string">|</span>&#13;
            <span class="hljs-string">cd</span> <span class="hljs-string">/home/ubuntu/</span>&#13;
            <span class="hljs-string">bash</span> <span class="hljs-string">-l</span> <span class="hljs-string">-c</span> <span class="hljs-string">'./build-and-deploy.sh'</span>
</code></pre>
<p>这段工作流配置的意思是：</p>
<ul>
<li>可以手动触发（GitHub UI 上点击 "Run workflow"）CI/CD 工作流。</li>
<li>可以自动触发 CI/CD 工作流，不过要求推送到 main 分支且提交信息含 [deploy] 。</li>
<li>使用 SSH 的配置 <code>SERVER_HOST</code>、<code>SERVER_USER</code> 和 <code>SSH_PRIVATE_KEY</code> 登录目标主机 。</li>
<li>执行一键构建和部署脚本 <code>build-and-deploy.sh</code> 。</li>
</ul>
<p>build-and-deploy.yml 需要提交并推送到 GitHub：</p>
<pre><code class="hljs language-sql" lang="sql">git <span class="hljs-keyword">add</span> .&#13;
git <span class="hljs-keyword">commit</span> <span class="hljs-operator">-</span>m "Add simple CI/CD workflow"&#13;
git push origin main
</code></pre>
<p>最后，通过打开 GitHub 仓库 → Actions 标签页，就可以看到是否有 workflow 正在运行（绿色 ✔ 表示成功），还可以查看具体的 CI/CD 日志。</p>
<h3 data-id="heading-4">2.3 注意事项</h3>
<p>CI/CD 的配置文件 build-and-deploy.yml 中执行任意 shell 命令，不过还是推荐封装好一键构建部署脚本，直接调用这个脚本。很多情况下可以使用这个脚本来进行手动部署。</p>
<p>另外 GitHub Actions 使用的是 非交互式、非登录式 shell，不会加载 .bashrc 或 .profile，环境变量（尤其是 PATH）与手动登录时不同。因此，有两种方案：</p>
<ol>
<li>在构建部署脚本的开头显式加载环境。比如：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 用于CI/CD环境配置</span>&#13;
<span class="hljs-built_in">export</span> NVM_DIR=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.nvm"</span>&#13;
[ -s <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/nvm.sh"</span> ] &amp;&amp; \. <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/nvm.sh"</span>  <span class="hljs-comment"># This loads nvm</span>&#13;
[ -s <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/bash_completion"</span> ] &amp;&amp; \. <span class="hljs-string">"<span class="hljs-variable">$NVM_DIR</span>/bash_completion"</span>  <span class="hljs-comment"># This loads nvm bash_completion</span>&#13;
&#13;
<span class="hljs-built_in">export</span> LD_LIBRARY_PATH=/home/ubuntu/GISBasic/lib/:/home/ubuntu/GISBasic/lib64/:<span class="hljs-variable">${LD_LIBRARY_PATH:-}</span> <span class="hljs-comment">#支持变量 LD_LIBRARY_PATH 未定义或为空</span>
</code></pre>
<ol start="2">
<li>配置文件 build-and-deploy.yml 执行脚本命令增加 <code>bash -l -c</code>，表示以登录用户的身份启动一个新 shell，并在这个环境中运行脚本。例如这里的：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">bash -l -c <span class="hljs-string">'./build-and-deploy.sh'</span>
</code></pre>
<h2 data-id="heading-5">3. 展望</h2>
<p>其实 CI/CD 配置远不是那么简单，随着项目复杂度提升，还可以逐步引入更多工程实践：</p>
<ul>
<li>基于 Git Tag 的正式发布：当功能稳定时，打一个 v1.0.0 这样的语义化版本标签，自动触发构建并将二进制文件上传到 GitHub Release，方便他人下载使用。</li>
<li>自动化测试集成：在部署前运行单元测试、端到端测试，确保新代码不会破坏现有功能。</li>
<li>多环境支持：区分开发、预发、生产环境，避免直接在生产服务器上“试错”。</li>
<li>基础设施即代码（IaC）：用 Ansible、Terraform 等工具管理服务器配置，让环境可复现、可版本控制。</li>
<li>监控与回滚机制：部署后自动检查服务健康状态，异常时自动回退到上一版本。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🐟 摸鱼指南（一）：5 秒建项目，拒绝搬砖]]></title>    <link>https://juejin.cn/post/7585727457472790528</link>    <guid>https://juejin.cn/post/7585727457472790528</guid>    <pubDate>2025-12-21T14:19:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585727457472790528" data-draft-id="7585007321207291956" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🐟 摸鱼指南（一）：5 秒建项目，拒绝搬砖"/> <meta itemprop="keywords" content="Flutter,Visual Studio Code,MVVM"/> <meta itemprop="datePublished" content="2025-12-21T14:19:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TT_Close"/> <meta itemprop="url" content="https://juejin.cn/user/2858385964538663"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🐟 摸鱼指南（一）：5 秒建项目，拒绝搬砖
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385964538663/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TT_Close
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T14:19:10.000Z" title="Sun Dec 21 2025 14:19:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#212122}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:8px;padding-bottom:8px}.markdown-body h1{color:#a0a0a0;font-size:38px;margin-top:32px;padding-top:32px}.markdown-body h2{color:#fff;background-color:#212122;width:fit-content;border-bottom-right-radius:100px;margin-top:47px;margin-bottom:16px;padding:4px 48px 4px 8px;line-height:1.7;font-size:30px;transition:all .3s ease-out}.markdown-body h2:hover{border-bottom-right-radius:50px;transition:all .3s ease-out}.markdown-body h3{font-size:24px;padding-left:8px;margin-top:32px;border-bottom:2px solid #c6c4c4;line-height:1.7}.markdown-body h4{font-size:20px;padding-left:8px;margin-top:32px;border-bottom:1px solid #ddd}.markdown-body h5{font-size:16px;margin-top:24px}.markdown-body h6{margin-top:16px;line-height:1.1}.markdown-body p{font-size:16px;text-align:start;white-space:normal;text-size-adjust:auto;line-height:2;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%;margin:auto;padding-left:8px;padding-right:8px}.markdown-body hr{border:none;border-top:4px double #212122;margin-top:32px;margin-bottom:32px;text-align:center}.markdown-body hr:after{content:"♥";display:inline-block;position:relative;top:-15px;padding:0 10px;color:#212122;font-size:18px}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f1f1f1;color:#ef7060;font-size:14px;padding:.065em 6px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.7;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);margin:32px 16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-color:#212122;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);background-size:40px}.markdown-body pre&gt;code{font-size:14px;padding:16px 8px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff;background:#272822}.markdown-body pre&gt;code::-webkit-scrollbar{height:10px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:3px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{border-radius:3px;box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}.markdown-body a{color:#ef7060;padding:2px;text-decoration:none;border-bottom:.125em solid #ef7060;border-radius:2px;box-shadow:inset 0 -.025em 0 #ef7060;transition:box-shadow .27s cubic-bezier(.77,0,.175,1),color .27s cubic-bezier(.77,0,.175,1)}.markdown-body a:focus,.markdown-body a:hover{outline:none;box-shadow:inset 0 -1.5em 0 #ef7060;color:#fff}.markdown-body a:before{content:"⇲ ";vertical-align:top;margin-left:2px;font-family:dart!important;font-size:12px;color:inherit;opacity:.7}.markdown-body table{background:#fbfbfb;border-radius:4px;border-collapse:collapse;margin:auto;padding:5px;width:95%;box-shadow:0 5px 10px rgba(0,0,0,.1);animation:float 5s infinite}.markdown-body table th{color:#fff;background:#212122;border-bottom:1px solid #9ea7af;border-right:1px solid #343a45;font-size:18px;padding:16px;text-align:left;vertical-align:middle}.markdown-body table th:first-child{border-top-left-radius:4px}.markdown-body table th:last-child{border-top-right-radius:4px;border-right:none}.markdown-body table tr{border-top:1px solid #c1c3d1;border-bottom:1px solid #c1c3d1;color:#666b85}.markdown-body table tr:hover td{background:#212122;color:#fff;border-top:1px solid #22262e}.markdown-body table tr:first-child{border-top:none}.markdown-body table tr:last-child{border-bottom:none}.markdown-body table tr:nth-child(odd) td{background:#f1f1f1}.markdown-body table tr:nth-child(odd):hover td{background:#212122}.markdown-body table tr:last-child td:first-child{border-bottom-left-radius:4px}.markdown-body table tr:last-child td:last-child{border-bottom-right-radius:4px}.markdown-body table td{background:#fbfbfb;padding:16px;text-align:left;vertical-align:middle;font-size:16px;border-right:1px solid #c1c3d1}.markdown-body table td:last-child{border-right:0}.markdown-body blockquote{color:#777;padding:1px 16px;margin:24px 0;border-left:4px solid #c6c4c4;background-color:#f1f1f1;transition:all .3s ease-out;border-radius:4px}.markdown-body blockquote:hover{border-left-color:#212122;background-color:#212122;color:#fff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:24px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body span.math{margin-left:32px;font-size:18px;font-weight:700}@media (max-width:720px){.markdown-body h1{font-size:30.4px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong><code>flutter create</code> = 毛坯房，搭架子 30 分钟，一行业务都没写。</strong></p>
<p>Flu CLI = 精装房，<strong>5 秒拎包入住</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">😤 flutter create 给你了什么？</h2>
<pre><code class="hljs language-bash" lang="bash">flutter create my_app
</code></pre>
<pre><code class="hljs language-bash" lang="bash">lib/
└── main.dart   <span class="hljs-comment"># 一个 Counter Demo，就这？</span>
</code></pre>
<p><strong>然后你要</strong>：</p>
<ul>
<li>手动建 10+ 个目录（5 分钟）</li>
<li>写 BasePage、BaseViewModel 基类（10 分钟）</li>
<li>配路由、主题、删示例代码（10 分钟）</li>
</ul>
<p><strong>总计 30 分钟，一行业务都没写。</strong> 😡</p>
<hr/>
<h2 data-id="heading-1">🚀 Flu CLI 的方式:5 秒精装房</h2>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45385ea6571d4165aea81bc9af6a368c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFRfQ2xvc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766934412&amp;x-signature=1pGqC%2BjrykVLeyNXMUEMK7M%2Ferc%3D" alt="create-project-modular.gif" loading="lazy"/></p>
<h3 data-id="heading-2">操作步骤</h3>
<p><strong>3 步搞定</strong>：</p>
<ol>
<li><strong>右键空文件夹</strong> → 选择 <code>Flu: 创建新项目</code></li>
<li><strong>选择模板</strong> → 输入项目名（如 <code>my_app</code>）→ 输入包名（如 <code>com.example.myapp</code>）</li>
<li><strong>等 5 秒</strong> → 项目自动在新窗口打开</li>
</ol>
<p><strong>完事儿。</strong></p>
<h3 data-id="heading-3">你得到了什么？</h3>
<p>以 <strong>Modular</strong> 模板为例：</p>
<pre><code class="hljs language-csharp" lang="csharp">my_app/
├── lib/
│   ├── core/
│   │   ├── <span class="hljs-keyword">base</span>/
│   │   │   ├── base_page.dart          <span class="hljs-meta"># ✅ 基类写好了</span>
│   │   │   └── base_viewmodel.dart     <span class="hljs-meta"># ✅ 基类写好了</span>
│   │   ├── theme/
│   │   │   └── app_theme.dart          <span class="hljs-meta"># ✅ 主题配好了</span>
│   │   └── router/
│   │       └── app_router.dart         <span class="hljs-meta"># ✅ 路由配好了</span>
│   ├── features/
│   │   └── home/
│   │       ├── pages/
│   │       │   └── home_page.dart      <span class="hljs-meta"># ✅ 示例页面有了</span>
│   │       ├── viewmodels/
│   │       │   └── home_viewmodel.dart <span class="hljs-meta"># ✅ 示例 VM 有了</span>
│   │       └── widgets/
│   ├── shared/
│   │   ├── models/
│   │   ├── services/
│   │   └── widgets/
│   └── main.dart
├── .flu-cli.json                        <span class="hljs-meta"># ✅ 配置文件也有了</span>
└── pubspec.yaml
</code></pre>
<p><strong>关键是</strong>：这些代码都是能跑的，不是空壳！</p>
<p><strong>BasePage、BaseViewModel、主题配置、路由配置...全部写好了。</strong></p>
<hr/>
<h2 data-id="heading-4">📦 4 种内置模板</h2>
<blockquote>
<p><strong>选择困难？看这张表 👇</strong></p>
</blockquote>



































<table><thead><tr><th>模板</th><th>适合场景</th><th>结构</th><th>推荐</th></tr></thead><tbody><tr><td><strong>Lite</strong></td><td>Demo、快速验证</td><td><code>pages/widgets/models/</code></td><td>⭐⭐⭐</td></tr><tr><td><strong>Modular</strong></td><td>中大型项目、团队开发</td><td><code>core/features/shared/</code></td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>Clean</strong></td><td>企业级、严格分层</td><td><code>domain/data/presentation/</code></td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>Custom</strong></td><td>团队统一标准</td><td>自定义</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>

<p><img alt="模板对比转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-5">Lite：轻装上阵</h3>
<pre><code class="hljs language-css" lang="css">lib/
├── pages/
├── widgets/
├── models/
└── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.dart</span>
</code></pre>
<p><strong>一句话</strong>：扁平结构，快速开发，不适合大项目。</p>
<hr/>
<h3 data-id="heading-6">Modular：推荐 ⭐</h3>
<pre><code class="hljs language-bash" lang="bash">lib/
├── core/       <span class="hljs-comment"># 基类、主题、路由</span>
├── features/   <span class="hljs-comment"># 功能模块（home/auth/profile...）</span>
└── shared/     <span class="hljs-comment"># 共享层（models/services/widgets）</span>
</code></pre>
<p><strong>一句话</strong>：按功能分模块，团队协作首选。</p>
<hr/>
<h3 data-id="heading-7">Clean：架构洁癖者专属</h3>
<pre><code class="hljs language-bash" lang="bash">lib/
├── domain/        <span class="hljs-comment"># 领域层</span>
├── data/          <span class="hljs-comment"># 数据层</span>
└── presentation/  <span class="hljs-comment"># 表现层</span>
</code></pre>
<p><strong>一句话</strong>：严格分层，学习曲线陡，企业级项目适用。</p>
<hr/>
<h3 data-id="heading-8">Custom：团队的「黄金标准」 🔥</h3>
<p>把公司标准项目放 Git 仓库，配置成自定义模板，<strong>新人 5 秒上手</strong>。</p>
<p>详见下文 👇</p>
<hr/>
<h2 data-id="heading-9">🎨 自定义模板：团队的「黄金标准」</h2>
<h3 data-id="heading-10">场景</h3>
<p><strong>问题</strong>：</p>
<ul>
<li>公司有一套标准项目结构</li>
<li>包含封装好的网络库、主题、基类、工具类</li>
<li>每次新项目都要从老项目复制？<strong>太 low 了</strong></li>
</ul>
<p><strong>解决方案</strong>：把标准项目放 Git 仓库，配置成自定义模板。</p>
<hr/>
<h3 data-id="heading-11">Step 1：准备 Git 仓库</h3>
<p>把你们公司的标准项目结构推到 Git 仓库：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 示例仓库</span>
https://gitee.com/your-company/flutter-template.git
</code></pre>
<p><strong>仓库内容</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">flutter-template/
├── lib/
│   ├── core/
│   │   ├── network/
│   │   │   └── http_client.dart    <span class="hljs-meta"># 封装好的网络库</span>
│   │   ├── <span class="hljs-keyword">base</span>/
│   │   │   ├── base_page.dart
│   │   │   └── base_viewmodel.dart
│   │   └── theme/
│   │       └── company_theme.dart  <span class="hljs-meta"># 公司统一主题</span>
│   ├── features/
│   └── shared/
├── .flu-cli.json                    <span class="hljs-meta"># ✅ 配置文件也放进去</span>
└── pubspec.yaml
</code></pre>
<hr/>
<h3 data-id="heading-12">Step 2:在 Flu CLI 中添加模板</h3>

<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bb078423d3a461b8c377a10ae252f29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFRfQ2xvc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766934412&amp;x-signature=RZChzYL1pxLvXalqbsCsn4lEAWw%3D" alt="add-custom-template.gif" loading="lazy"/></p>
<p><strong>Flu CLI 支持两种模板来源</strong>：</p>
<h4 data-id="heading-13">方式一：Git 仓库（推荐）</h4>
<p><strong>操作</strong>：</p>
<ol>
<li>右键空文件夹 → <code>Flu: 创建新项目</code></li>
<li>选择 <code>自定义模板...</code></li>
<li>选择 <code>$(repo) Git 仓库</code></li>
<li>输入仓库 URL：<code>https://gitee.com/your-company/flutter-template.git</code></li>
<li>输入分支名：<code>main</code>（默认）</li>
<li>给模板起个名字：<code>公司标准模板</code></li>
<li>（可选）输入描述</li>
</ol>
<p><strong>优点</strong>：</p>
<ul>
<li>✅ 团队共享，所有人都能拉取</li>
<li>✅ 支持版本管理，模板更新方便</li>
<li>✅ 支持 Gitee/GitHub/GitLab/私有仓库</li>
</ul>
<h4 data-id="heading-14">方式二：本地文件夹</h4>
<p><strong>操作</strong>：</p>
<ol>
<li>右键空文件夹 → <code>Flu: 创建新项目</code></li>
<li>选择 <code>自定义模板...</code></li>
<li>选择 <code>$(folder-opened) 本地文件夹</code></li>
<li>选择本地项目目录（如 <code>/Users/you/my-template</code>）</li>
<li>给模板起个名字：<code>我的本地模板</code></li>
<li>（可选）输入描述</li>
</ol>
<p><strong>优点</strong>：</p>
<ul>
<li>✅ 不需要 Git 仓库</li>
<li>✅ 适合个人使用</li>
<li>✅ 修改立即生效</li>
</ul>
<hr/>
<p><strong>下次创建项目</strong>：</p>
<p>模板列表里会出现 <code>公司标准模板</code> / <code>我的本地模板</code>，选它就完事儿。</p>
<hr/>
<h3 data-id="heading-15">好处</h3>









































<table><thead><tr><th>对比</th><th>传统方式</th><th>自定义模板（Git）</th><th>自定义模板（本地）</th></tr></thead><tbody><tr><td><strong>新项目创建</strong></td><td>从老项目复制 30 分钟</td><td>5 秒</td><td>5 秒</td></tr><tr><td><strong>团队统一</strong></td><td>靠文档约束，不靠谱</td><td>100% 统一</td><td>仅个人使用</td></tr><tr><td><strong>模板更新</strong></td><td>手动通知所有人</td><td>Git 仓库更新，重新拉取</td><td>直接修改本地目录</td></tr><tr><td><strong>新人入职</strong></td><td>培训 2 小时</td><td>5 秒上手</td><td>5 秒上手</td></tr><tr><td><strong>网络要求</strong></td><td>-</td><td>需要能访问 Git</td><td>不需要</td></tr></tbody></table>
<p><strong>配置一次，全员受益。</strong> 🐟🐟🐟</p>
<hr/>
<h2 data-id="heading-16">🔧 高级选项</h2>

















<table><thead><tr><th>选项</th><th>效果</th></tr></thead><tbody><tr><td><code>✅ 初始化配置文件</code></td><td>自动生成 <code>.flu-cli.json</code>，后续生成文件时自动应用配置</td></tr><tr><td><code>✅ 配置 App 资源</code></td><td>顺便把图标和启动图一起配了，一步到位</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-17">❓ FAQ</h2>

























<table><thead><tr><th>问题</th><th>答案</th></tr></thead><tbody><tr><td>创建失败？</td><td>检查网络、查看 VSCode 输出面板、确认 Flutter 已安装</td></tr><tr><td>能改生成的结构吗？</td><td>当然，就是普通 Flutter 项目，随便改</td></tr><tr><td>自定义模板必须是 Git？</td><td>不是，支持 Git 仓库和本地文件夹两种方式</td></tr><tr><td>会覆盖项目名和包名吗？</td><td>会，自动替换</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-18">🐟 摸鱼小结</h2>





























<table><thead><tr><th>功能</th><th>传统</th><th>Flu CLI</th><th>省时</th></tr></thead><tbody><tr><td>建项目</td><td>30 分钟</td><td>5 秒</td><td><strong>29 分 55 秒</strong></td></tr><tr><td>建 10 个项目</td><td>5 小时</td><td>50 秒</td><td><strong>4 小时 59 分</strong></td></tr><tr><td>3 年建 50 个</td><td>25 小时</td><td>4 分钟</td><td><strong>24 小时 56 分</strong></td></tr></tbody></table>
<p><strong>建项目从此告别搬砖。</strong> 🐟🐟🐟</p>
<hr/>
<h2 data-id="heading-19">📚 系列文章</h2>
<ul>
<li><strong><a href="https://juejin.cn/post/7585600621522714664" target="_blank" title="https://juejin.cn/post/7585600621522714664">← 上一篇：主打文章</a></strong></li>
<li><strong><a href="https://juejin.cn/post/7585600621522714664" target="_blank" title="https://juejin.cn/post/7585600621522714664">→ 下一篇：告别 Ctrl+C/V</a></strong></li>
</ul>
<hr/>
<blockquote>
<p>💬 <strong>交流群</strong>：加微信 <code>Huoye-TT</code> 备注 "flu-cli"</p>
<p>⭐ <strong>开源地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fflu-cli%2Fflu-cli" target="_blank" title="https://gitee.com/flu-cli/flu-cli" ref="nofollow noopener noreferrer">Gitee</a> | 求 Star！</p>
<p>📖 <strong>完整文档</strong>：<a href="https://link.juejin.cn?target=http%3A%2F%2Fhuozhiye.cn%2Fflu-cli%2F" target="_blank" title="http://huozhiye.cn/flu-cli/" ref="nofollow noopener noreferrer">huozhiye.cn/flu-cli/</a></p>
</blockquote>
<hr/>
<p><strong>如果这篇文章让你告别了搬砖，点个赞呗 👍</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python--数据维度与数据格式化]]></title>    <link>https://juejin.cn/post/7585798113546551346</link>    <guid>https://juejin.cn/post/7585798113546551346</guid>    <pubDate>2025-12-21T13:52:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585798113546551346" data-draft-id="7585686247286718515" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python--数据维度与数据格式化"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-21T13:52:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="酷酷的佳"/> <meta itemprop="url" content="https://juejin.cn/user/2939463340923272"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python--数据维度与数据格式化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2939463340923272/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    酷酷的佳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T13:52:10.000Z" title="Sun Dec 21 2025 13:52:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、数据维度：从 “线” 到 “体” 的数据形态</h2>
<p>数据维度本质是 “定位一个元素需要几个索引”，可以用生活化的比喻理解：</p>
<ul>
<li>一维：像一根线，只有 “前后” 方向，1 个索引就能找到元素；</li>
<li>二维：像一张纸（表格），需要 “行 + 列”2 个索引定位；</li>
<li>多维：像一个魔方，需要 3 个及以上索引（如长 × 宽 × 高）定位。</li>
</ul>
<h3 data-id="heading-1">1. 一维数据（1D）</h3>
<p>最基础的维度，Python 中常用<strong>列表、元组、一维数组</strong>表示，仅需 1 个索引访问元素。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 示例：存储班级学生姓名（一维列表）</span>
names = [<span class="hljs-string">"张三"</span>, <span class="hljs-string">"李四"</span>, <span class="hljs-string">"王五"</span>]

<span class="hljs-comment"># 访问元素：索引从0开始</span>
<span class="hljs-built_in">print</span>(names[<span class="hljs-number">0</span>])  <span class="hljs-comment"># 输出：张三</span>
<span class="hljs-built_in">print</span>(names[-<span class="hljs-number">1</span>]) <span class="hljs-comment"># 输出：王五（倒数第一个）</span>

<span class="hljs-comment"># 遍历一维数据</span>
<span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> names:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"学生：<span class="hljs-subst">{name}</span>"</span>)
</code></pre>
<p><strong>应用场景</strong>：存储单列数据（如成绩、手机号、商品名称）。</p>
<h3 data-id="heading-2">2. 二维数据（2D）</h3>
<p>类似 Excel 表格，Python 中常用<strong>嵌套列表、二维数组、Pandas DataFrame</strong>表示，需 2 个索引（行 + 列）访问元素。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 示例：存储学生姓名+语文/数学成绩（二维列表）</span>
student_scores = [
    [<span class="hljs-string">"张三"</span>, <span class="hljs-number">90</span>, <span class="hljs-number">88</span>],  <span class="hljs-comment"># 第0行：姓名、语文、数学</span>
    [<span class="hljs-string">"李四"</span>, <span class="hljs-number">85</span>, <span class="hljs-number">92</span>],  <span class="hljs-comment"># 第1行</span>
    [<span class="hljs-string">"王五"</span>, <span class="hljs-number">95</span>, <span class="hljs-number">80</span>]   <span class="hljs-comment"># 第2行</span>
]

<span class="hljs-comment"># 访问元素：行索引 + 列索引</span>
<span class="hljs-built_in">print</span>(student_scores[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>])  <span class="hljs-comment"># 第1行第0列：李四</span>
<span class="hljs-built_in">print</span>(student_scores[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>])  <span class="hljs-comment"># 第2行第2列：80（王五的数学成绩）</span>

<span class="hljs-comment"># 遍历二维数据（按行遍历）</span>
<span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> student_scores:
    name, chinese, math = row  <span class="hljs-comment"># 解包每行数据</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>：语文<span class="hljs-subst">{chinese}</span>，数学<span class="hljs-subst">{math}</span>"</span>)
</code></pre>
<p><strong>应用场景</strong>：存储表格型数据（如学生信息表、销售清单）。</p>
<h3 data-id="heading-3">3. 多维数据（3D+）</h3>
<p>三维及以上数据，常见于图像（宽 × 高 × 颜色通道）、时空数据（时间 × 地点 × 指标）等场景，Python 中常用<strong>numpy 多维数组</strong>实现（嵌套列表可读性差，不推荐）。</p>
<p>python</p>
<p>运行</p>
<pre><code class="hljs language-lua" lang="lua">import numpy as np

# 示例：三维数组（<span class="hljs-number">2</span>个班级 × <span class="hljs-number">3</span>个学生 × <span class="hljs-number">2</span>门成绩）
class_scores = np.array([
    <span class="hljs-string">[[90, 88], [85, 92], [95, 80]]</span>,  # <span class="hljs-number">1</span>班：<span class="hljs-number">3</span>个学生的语文/数学成绩
    <span class="hljs-string">[[88, 91], [79, 85], [92, 87]]</span>   # <span class="hljs-number">2</span>班
])

# 访问元素：班级索引 + 学生索引 + 科目索引
<span class="hljs-built_in">print</span>(class_scores[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>][<span class="hljs-number">1</span>])  # <span class="hljs-number">1</span>班第<span class="hljs-number">2</span>个学生的数学成绩：<span class="hljs-number">92</span>
<span class="hljs-built_in">print</span>(class_scores.shape)     # 查看维度：(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>) → <span class="hljs-number">2</span>行<span class="hljs-number">3</span>列<span class="hljs-number">2</span>层
</code></pre>
<h3 data-id="heading-4">维度转换小技巧（新手常用）</h3>
<p>用<code>numpy.reshape</code>可快速转换数据维度（一维↔二维↔多维）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 一维数组转二维（3行2列）</span>
arr1d = np.array([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>])
arr2d = arr1d.reshape(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(arr2d)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># [[1 2]</span>
<span class="hljs-comment">#  [3 4]</span>
<span class="hljs-comment">#  [5 6]]</span>
</code></pre>
<hr/>
<h2 data-id="heading-5">二、数据格式化：让数据 “规范又好看”</h2>
<p>数据格式化是将数据按指定规则展示（如字符串拼接）或存储（如 JSON/CSV），核心分两类：<strong>字符串格式化</strong>（输出展示）、<strong>数据结构格式化</strong>（存储 / 传输）。</p>
<h3 data-id="heading-6">1. 字符串格式化（最常用）</h3>
<p>目的：将变量 / 数据嵌入字符串，规范输出格式，Python 有 3 种主流方式（推荐优先用 f-string）。</p>

























<table><thead><tr><th>方式</th><th>语法示例</th><th>特点</th></tr></thead><tbody><tr><td>% 格式化（老式）</td><td><code>"姓名：%s，成绩：%.1f" % (name, score)</code></td><td>兼容性好，语法稍繁琐</td></tr><tr><td>str.format()</td><td><code>"姓名：{}，成绩：{:.1f}".format(name, score)</code></td><td>通用，支持参数定位</td></tr><tr><td>f-string（Python3.6+）</td><td><code>f"姓名：{name}，成绩：{score:.1f}"</code></td><td>最简洁、高效，新手首选</td></tr></tbody></table>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 实战示例：三种方式对比</span>
name = <span class="hljs-string">"张三"</span>
score = <span class="hljs-number">90.5</span>

<span class="hljs-comment"># 1. %格式化</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"姓名：%s，成绩：%.1f"</span> % (name, score))  <span class="hljs-comment"># 输出：姓名：张三，成绩：90.5</span>

<span class="hljs-comment"># 2. str.format()</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"姓名：{}，成绩：{:.1f}"</span>.<span class="hljs-built_in">format</span>(name, score))  <span class="hljs-comment"># 输出同上</span>

<span class="hljs-comment"># 3. f-string（推荐）</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"姓名：<span class="hljs-subst">{name}</span>，成绩：<span class="hljs-subst">{score:<span class="hljs-number">.1</span>f}</span>"</span>)  <span class="hljs-comment"># 输出同上</span>
</code></pre>
<h3 data-id="heading-7">2. 数据结构格式化（存储 / 传输）</h3>
<p>将 Python 原生数据（列表 / 字典）转换为 JSON、CSV 等通用格式，方便存储到文件或传输给接口。</p>
<h4 data-id="heading-8">示例 1：字典转 JSON（接口数据常用）</h4>
<p>JSON 是跨语言的通用数据格式，需导入<code>json</code>模块：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json

<span class="hljs-comment"># 原始Python字典</span>
student = {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"张三"</span>,
    <span class="hljs-string">"age"</span>: <span class="hljs-number">18</span>,
    <span class="hljs-string">"scores"</span>: {<span class="hljs-string">"chinese"</span>: <span class="hljs-number">90</span>, <span class="hljs-string">"math"</span>: <span class="hljs-number">88</span>}
}

<span class="hljs-comment"># 字典转JSON字符串（ensure_ascii=False显示中文，indent=2格式化缩进）</span>
json_str = json.dumps(student, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">2</span>)
<span class="hljs-built_in">print</span>(json_str)
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># {</span>
<span class="hljs-comment">#   "name": "张三",</span>
<span class="hljs-comment">#   "age": 18,</span>
<span class="hljs-comment">#   "scores": {</span>
<span class="hljs-comment">#     "chinese": 90,</span>
<span class="hljs-comment">#     "math": 88</span>
<span class="hljs-comment">#   }</span>
<span class="hljs-comment"># }</span>

<span class="hljs-comment"># JSON字符串转回字典</span>
student_dict = json.loads(json_str)
<span class="hljs-built_in">print</span>(student_dict[<span class="hljs-string">"scores"</span>][<span class="hljs-string">"math"</span>])  <span class="hljs-comment"># 输出：88</span>
</code></pre>
<h4 data-id="heading-9">示例 2：二维列表转 CSV（Excel 兼容）</h4>
<p>CSV 是表格型数据的轻量格式，需导入<code>csv</code>模块：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> csv

<span class="hljs-comment"># 二维数据（表头+内容）</span>
data = [
    [<span class="hljs-string">"姓名"</span>, <span class="hljs-string">"语文"</span>, <span class="hljs-string">"数学"</span>],
    [<span class="hljs-string">"张三"</span>, <span class="hljs-number">90</span>, <span class="hljs-number">88</span>],
    [<span class="hljs-string">"李四"</span>, <span class="hljs-number">85</span>, <span class="hljs-number">92</span>]
]

<span class="hljs-comment"># 写入CSV文件（newline=""避免空行，encoding="utf-8"支持中文）</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"student_scores.csv"</span>, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>, newline=<span class="hljs-string">""</span>) <span class="hljs-keyword">as</span> f:
    writer = csv.writer(f)
    writer.writerows(data)  <span class="hljs-comment"># 批量写入所有行</span>

<span class="hljs-comment"># 读取CSV文件</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">"student_scores.csv"</span>, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
    reader = csv.reader(f)
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> reader:
        <span class="hljs-built_in">print</span>(row)  <span class="hljs-comment"># 输出每行数据（列表形式）</span>
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># ['姓名', '语文', '数学']</span>
<span class="hljs-comment"># ['张三', '90', '88']</span>
<span class="hljs-comment"># ['李四', '85', '92']</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">总结</h3>
<ol>
<li><strong>数据维度</strong>：一维（单索引，如列表）、二维（行 + 列索引，如嵌套列表）、多维（多索引，如 numpy 数组）是核心形态，维度转换可借助<code>numpy.reshape</code>；</li>
<li><strong>字符串格式化</strong>：优先使用<code>f-string</code>，简洁高效，<code>%.1f</code>等格式符可控制数值精度；</li>
<li><strong>数据结构格式化</strong>：JSON 适合接口传输，CSV 适合表格存储，转换时需注意编码（如<code>utf-8</code>）和格式参数（如<code>indent</code>）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从硬编码到规则引擎：AI Agent 工程化的降本增效之路]]></title>    <link>https://juejin.cn/post/7585897699602710554</link>    <guid>https://juejin.cn/post/7585897699602710554</guid>    <pubDate>2025-12-22T01:55:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585897699602710554" data-draft-id="7585866811716747291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从硬编码到规则引擎：AI Agent 工程化的降本增效之路"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-22T01:55:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从硬编码到规则引擎：AI Agent 工程化的降本增效之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T01:55:13.000Z" title="Mon Dec 22 2025 01:55:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：AI Agent 工程化的关键在于“该省则省”：高频确定性任务用硬编码或规则引擎处理，复杂开放问题才调用大模型，通过混合架构实现低成本、高可靠、低延迟的生产级智能系统。</p>
<hr/>
<h2 data-id="heading-0">从硬编码到规则引擎：AI Agent 工程化的降本增效之路</h2>
<blockquote>
<p><strong>核心观点：智能不等于全用大模型。真正的生产级 AI 系统，是“能省则省、该智则智”的混合架构。</strong></p>
</blockquote>
<h3 data-id="heading-1">引言：别让 LLM 干所有活</h3>
<p>当我们兴奋地构建 AI Agent 时，很容易陷入一个误区：<strong>把所有逻辑都交给大语言模型（LLM）处理</strong>。<br/>
但现实很骨感：LLM 调用贵、延迟高、行为不可控。如果用户每天问一万次“我的订单到哪了？”，每次都让 GPT-4o 思考一遍，成本和体验都会崩盘。</p>
<p>于是，聪明的工程师开始思考：<strong>能不能把高频、确定性强的路径固化下来？</strong></p>
<p>答案是肯定的——这条路，从<strong>硬编码</strong>起步，走向<strong>规则引擎</strong>，最终形成<strong>AI + 规则的混合智能架构</strong>。</p>
<hr/>
<h3 data-id="heading-2">第一阶段：硬编码 —— 最朴素的优化</h3>
<p>对于<strong>模式固定、逻辑明确</strong>的请求，直接写死处理流程是最高效的方式。</p>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-keyword">if</span> <span class="hljs-string">"订单"</span> in <span class="hljs-keyword">query</span> <span class="hljs-keyword">and</span> (<span class="hljs-string">"在哪"</span> in <span class="hljs-keyword">query</span> or <span class="hljs-string">"物流"</span> in <span class="hljs-keyword">query</span>):
    order_id = extract_order_id(<span class="hljs-keyword">query</span>)
    status = logistics_api.get_status(order_id)
    return f<span class="hljs-string">"您的订单当前状态：{status}"</span>
</code></pre>
<p>✅ 优势：</p>
<ul>
<li>零 LLM 调用，成本趋近于 0</li>
<li>响应毫秒级，用户体验好</li>
<li>行为完全可控，无幻觉风险</li>
</ul>
<p>❌ 局限：</p>
<ul>
<li>规则散落在代码中，难以维护</li>
<li>每次新增场景都要改代码、测、上线</li>
</ul>
<blockquote>
<p><strong>硬编码是起点，但不是终点。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-3">第二阶段：规则引擎 —— 把“if-else”解放出来</h3>
<p>规则引擎的核心思想是：<strong>将业务逻辑从代码中剥离，变成可配置、可热更新的策略</strong>。</p>
<h4 data-id="heading-4">什么是规则引擎？</h4>
<p>它是一个专门执行“如果……那么……”规则的运行时系统。例如：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"condition"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"intent == 'order_status'"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"action"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"call_logistics_api_and_format_response"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>运营人员只需修改规则配置，无需程序员介入。</p>
<h4 data-id="heading-5">在 AI Agent 中的价值</h4>





















<table><thead><tr><th>场景</th><th>处理方式</th></tr></thead><tbody><tr><td>“退货流程是什么？”</td><td>规则引擎 → 返回预设 FAQ</td></tr><tr><td>“我买的 A 能和 B 一起用吗？”</td><td>LLM + RAG → 分析产品文档</td></tr><tr><td>“帮我订明天去上海的机票”</td><td>Agent 规划 → 调用航班 API</td></tr></tbody></table>
<blockquote>
<p><strong>规则引擎处理“已知问题”，LLM 处理“未知问题”。</strong></p>
</blockquote>
<h4 data-id="heading-6">自动驾驶中的启示</h4>
<p>自动驾驶系统早已采用类似思路：</p>
<ul>
<li>深度学习负责“感知世界”（识别车辆、行人）</li>
<li>规则引擎负责“遵守交规”（红灯停、斑马线让行）</li>
</ul>
<p>即使 AI 认为“可以安全通过”，规则仍强制制动——<strong>这是安全底线</strong>。</p>
<p>AI Agent 同理：<strong>规则是成本与安全的守门人</strong>。</p>
<hr/>
<h3 data-id="heading-7">第三阶段：混合架构 —— 智能系统的成熟形态</h3>
<p>现代生产级 AI 系统普遍采用三层路由架构：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87b8afe65a9a492f9dd4201132878f56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Ieq55Sx55Sf6ZW_MjAyNA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766973312&amp;x-signature=zyxLbg5ba09MX%2FWhsUgLLk3hZWQ%3D" alt="tongyi-mermaid-2025-12-22-094845.png" loading="lazy"/></p>

<h4 data-id="heading-8">关键组件</h4>
<ol>
<li><strong>语义缓存</strong>：用向量数据库缓存相似问题的答案，避免重复计算</li>
<li><strong>意图分类器</strong>：轻量模型或关键词匹配，决定走哪条路径</li>
<li><strong>规则引擎</strong>：处理标准化业务流程</li>
<li><strong>通用 Agent</strong>：仅用于真正需要泛化能力的场景</li>
</ol>
<h4 data-id="heading-9">效果数据（行业实践）</h4>
<ul>
<li><strong>70%+ 请求</strong>由规则或缓存处理，<strong>不调用 LLM</strong></li>
<li><strong>整体成本下降 50%~90%</strong></li>
<li><strong>P99 延迟从 2s 降至 200ms 以内</strong></li>
</ul>
<hr/>
<h3 data-id="heading-10">结语：智能的本质是“恰到好处”</h3>
<blockquote>
<p><strong>不要为了用 AI 而用 AI。</strong><br/>
真正的工程智慧，在于知道<strong>什么时候不用大模型</strong>。</p>
</blockquote>
<p>从硬编码到规则引擎，再到混合智能架构，我们走的是一条<strong>从实验到生产、从炫技到务实</strong>的进化之路。<br/>
未来的 AI Agent，不是“全知全能”的神，而是<strong>懂得分工协作、精打细算的高效工作者</strong>。</p>
<hr/>
<p><strong>作者建议</strong>：<br/>
如果你正在开发 AI Agent，不妨先问自己：</p>
<blockquote>
<p>“这个问题，有没有可能用 10 行 if-else 解决？”<br/>
如果有，那就别急着调 LLM——先省下那一分钱，再谈智能。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[重写 equals 但未重写 hashCode：HashMap 存储数据丢失]]></title>    <link>https://juejin.cn/post/7585789195869126692</link>    <guid>https://juejin.cn/post/7585789195869126692</guid>    <pubDate>2025-12-22T00:52:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585789195869126692" data-draft-id="7584203412197670938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="重写 equals 但未重写 hashCode：HashMap 存储数据丢失"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-22T00:52:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uup"/> <meta itemprop="url" content="https://juejin.cn/user/4378706456356627"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            重写 equals 但未重写 hashCode：HashMap 存储数据丢失
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4378706456356627/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uup
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:52:53.000Z" title="Mon Dec 22 2025 00:52:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Bug 场景</h2>
<p>在一个基于 Java 的应用程序中，自定义了一个类并将其对象存储在 <code>HashMap</code> 中。为了确保对象在 <code>HashMap</code> 中的正确比较，开发人员重写了 <code>equals</code> 方法，但却忘记重写 <code>hashCode</code> 方法。结果在程序运行过程中，发现存储在 <code>HashMap</code> 中的某些对象丢失了，导致相关业务逻辑出现错误。</p>
<h2 data-id="heading-1">二、代码示例</h2>
<h3 data-id="heading-2">自定义类（有缺陷）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == o) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span> || getClass() != o.getClass()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> (Person) o;
        <span class="hljs-keyword">return</span> age == person.age &amp;&amp; name.equals(person.name);
    }

    <span class="hljs-comment">// 未重写hashCode方法</span>
}
</code></pre>
<h3 data-id="heading-3">测试代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashMapDataLossBugExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Map&lt;Person, String&gt; personMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-type">Person</span> <span class="hljs-variable">person1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">30</span>);
        <span class="hljs-type">Person</span> <span class="hljs-variable">person2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">30</span>);

        personMap.put(person1, <span class="hljs-string">"Person 1 Details"</span>);
        personMap.put(person2, <span class="hljs-string">"Person 2 Details"</span>);

        System.out.println(<span class="hljs-string">"Map size: "</span> + personMap.size());
        System.out.println(<span class="hljs-string">"Expected value for person2: Person 2 Details, Actual: "</span> + personMap.get(person2));
    }
}
</code></pre>
<h2 data-id="heading-4">三、问题描述</h2>
<ol>
<li><strong>预期行为</strong>：<code>person1</code> 和 <code>person2</code> 是内容相同的两个 <code>Person</code> 对象，按照 <code>equals</code> 方法的定义，它们应该被视为相等。在 <code>HashMap</code> 中，应该只存储一份相同内容的对象，并能通过任意一个对象获取到对应的详细信息。因此，<code>personMap.size()</code> 应该返回 <code>1</code>，且通过 <code>person2</code> 获取到的值应该是 <code>"Person 2 Details"</code>。</li>
<li><strong>实际行为</strong>：<code>personMap.size()</code> 返回 <code>2</code>，并且通过 <code>person2</code> 获取到的值为 <code>null</code>。这是因为在 Java 中，<code>HashMap</code> 使用 <code>hashCode</code> 方法来确定对象在哈希表中的存储位置。如果两个对象通过 <code>equals</code> 方法比较相等，但它们的 <code>hashCode</code> 方法返回不同的值，<code>HashMap</code> 会将它们存储在不同的位置，从而导致逻辑上相同的对象被当作不同的对象处理。由于没有重写 <code>hashCode</code> 方法，<code>person1</code> 和 <code>person2</code> 的 <code>hashCode</code> 值不同（默认的 <code>hashCode</code> 方法基于对象的内存地址），尽管它们通过 <code>equals</code> 方法比较是相等的。</li>
</ol>
<h2 data-id="heading-5">四、解决方案</h2>
<ol>
<li><strong>重写 <code>hashCode</code> 方法</strong>：根据 <code>equals</code> 方法中用于比较的字段，合理地重写 <code>hashCode</code> 方法，确保相等的对象具有相同的哈希码。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == o) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span> || getClass() != o.getClass()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> (Person) o;
        <span class="hljs-keyword">return</span> age == person.age &amp;&amp; name.equals(person.name);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> name.hashCode();
        result = <span class="hljs-number">31</span> * result + age;
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<ol start="2">
<li><strong>使用 <code>Objects.hash</code></strong> ：<code>java.util.Objects</code> 类提供了 <code>hash</code> 方法，可以方便地生成哈希码，简化 <code>hashCode</code> 方法的编写。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.Objects;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Person</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-built_in">this</span>.age = age;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span> == o) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span> || getClass() != o.getClass()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> (Person) o;
        <span class="hljs-keyword">return</span> age == person.age &amp;&amp; name.equals(person.name);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> Objects.hash(name, age);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Dubbo | 1分钟通过JUnit调用本地Dubbo接口完成测试]]></title>    <link>https://juejin.cn/post/7585798113547550770</link>    <guid>https://juejin.cn/post/7585798113547550770</guid>    <pubDate>2025-12-22T01:38:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585798113547550770" data-draft-id="7585789195869257764" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Dubbo | 1分钟通过JUnit调用本地Dubbo接口完成测试"/> <meta itemprop="keywords" content="后端,Java,Dubbo"/> <meta itemprop="datePublished" content="2025-12-22T01:38:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mars酱"/> <meta itemprop="url" content="https://juejin.cn/user/1714893869821278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Dubbo | 1分钟通过JUnit调用本地Dubbo接口完成测试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1714893869821278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mars酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T01:38:02.000Z" title="Mon Dec 22 2025 01:38:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：Mars酱</p>
<p>声明：本文章由Mars酱编写，部分内容来源于网络，如有疑问请联系本人。</p>
<p>转载：欢迎转载，转载前先请联系我！</p>
</blockquote>
<h2 data-id="heading-0">Dubbo的架构</h2>
<p>先啰嗦下Dubbo的架构吧，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30cec8537a0a487f9835683bb4efa48e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFyc-mFsQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766972312&amp;x-signature=bQjBuZ1MRWiBxVg0G%2FgXP3GHQYA%3D" alt="" loading="lazy"/></p>
<p>我们看到的Dubbo的架构是包含：注册中心、消费者、提供者、监控中心四个角色的，每个角色之间简单来讲就是各种订阅、通知、注册，总的来说就是你调用我，我调用你。（别的细节就不啰嗦了）</p>
<h2 data-id="heading-1">Dubbo的注册方式</h2>
<p>简单介绍了Dubbo的设计架构，那么作为微服务的强者之一，它的注册方式是这样的，如下图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79c96eb6418943268652771f7faa61dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFyc-mFsQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766972312&amp;x-signature=7wm0D141tqds9aemcwpq0Bu5k4M%3D" alt="" loading="lazy"/></p>
<p>一般我们使用的注册中心有zookeepr、nacos、eureka等等，而注册中心的作用就是为了均衡各个服务提供者和调用者，让服务器和应用达到最大性能和响应速度。</p>
<p>通常情况下，我们会在本地编写好业务逻辑代码，然后发布到服务器上，再根据输出的日志和各种异常错误来完成业务逻辑接口的自测，修复好错误之后，再重新发布到服务器上，再观察输入日志和异常，再修复，再发布，这样轮询，直到接口的输入和输出满足需求为止，那么问题来了！这个效率很低！！</p>
<p>反复修复、发布、再修复、再发布，中途你可能需要合并到测试分支、解决分支中的冲突、服务器可能别的业务逻辑在测试等等，我们是不是可以在本地完成专业的流程呢？可以的</p>
<h2 data-id="heading-2">常见的单元测试</h2>
<p>OK，通常情况下，我们的dubbo接口可能是这样</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BusiDubbo</span> {
    List <span class="hljs-title function_">listBusi</span><span class="hljs-params">(BusiDubboDto bdd)</span>
}
</code></pre>
<p>然后，我们dubbo接口的实现一般是这样（盲写的伪代码，不对，千万别抄）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@DubboService</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusiDubboImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BusiDubbo</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BusiService1 busiService1;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BusiService2 busiService2;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BusiService3 busiService3;
    

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List <span class="hljs-title function_">listBusi</span><span class="hljs-params">(BusiDubboDto bdd)</span>{
        <span class="hljs-type">List</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
        <span class="hljs-comment">// 业务处理1, 比如：result的获取</span>
        result = busiService1.list();

        <span class="hljs-comment">// 业务处理2，比如：过滤出xxx的业务数据</span>
        result.filter(source -&gt; {<span class="hljs-comment">/** xxxxx */</span>})

        <span class="hljs-comment">// 业务处理3， 比如：对比前一期数据，找到x不对的</span>
        busiService2.list2().filter(source -&gt; {
            <span class="hljs-keyword">return</span> (result.notContains(source.getX());
        })
        
        <span class="hljs-comment">// ...</span>
        busiService3.save(result);

        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p>好了，dubbo接口中实现的逻辑拖沓冗长，为了验证逻辑的正确性，我们会根据软件的单一原则，会把这个实现中的每个步骤的逻辑测试一遍，比如我们会这样</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Junit</span>
<span class="hljs-comment">// ... 省略很多注解</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BusiService1JunitTest</span> {

    <span class="hljs-meta">@Autowire</span>
    <span class="hljs-keyword">private</span> BusiService1 busiService1;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testList</span><span class="hljs-params">()</span>{
        <span class="hljs-comment">// 单独测试业务逻辑1的部分</span>
        <span class="hljs-type">List</span> <span class="hljs-variable">re</span> <span class="hljs-operator">=</span> busiService1.list();
        assertEquals(<span class="hljs-number">100</span>, re.size());
    }
}
</code></pre>
<p>这是BusiService1的单元测试，下面是BusiService2的</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Junit</span>
<span class="hljs-comment">// ... 省略很多注解</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BusiService2JunitTest</span> {

    <span class="hljs-meta">@Autowire</span>
    <span class="hljs-keyword">private</span> BusiService2 busiService2;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testList</span><span class="hljs-params">()</span>{
        <span class="hljs-comment">// 测试业务逻辑2的部分</span>
        <span class="hljs-type">List</span> <span class="hljs-variable">re2</span> <span class="hljs-operator">=</span> busiService2.list();
        assertEquals(<span class="hljs-number">20</span>, re2.size());
    }
}
</code></pre>
<p>如果有其他的业务逻辑，我们大概率也可能会挨个编写测试，我们虽然保证了每个逻辑的原子性是正确的，但是dubbo实现部分是由各个原子接口组装再重新拼接的，这里的逻辑远比我描述的要复杂得多，那么我们可能在有正规的测试服务器的情况下，编写一个可以测试整体业务逻辑的JUnit测试类，它编写出来应该类似这样</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Junit</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BusiDubboTest</span> {

    <span class="hljs-meta">@DubboReference</span>
    <span class="hljs-keyword">private</span> BusiDubbo busiDubbo;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testListBusi</span><span class="hljs-params">()</span>{
        <span class="hljs-comment">// 调用dubbo接口，走一遍整理逻辑</span>
        <span class="hljs-type">List</span> <span class="hljs-variable">reList</span> <span class="hljs-operator">=</span> busiDubbo.listBusi();
        assertEquals(<span class="hljs-number">100</span>, reList);
    }
}
</code></pre>
<p>这样编写并没有什么不正确，只是这个单元测试调用的是测试服务器上的dubbo服务接口，如果此时你是需要断点做测试，并跟踪数据的话，你是需要输入很多的log日志，在服务器上跟踪查找输出记录的，那么如果我们本地运行dubbo服务实现，再运行上面这个单元测试呢？是不是可以在本机的dubbo服务实现上打断点，完成单元测测试呢？</p>
<p>是的，可以！</p>
<p>但是取决于注册中心的路由策略，本地服务也会在注册中心注册为一个服务提供者，那么，你开始运行上面那个JUnit单元测试，当发起调用请求时 ，会由注册中心根据设定的路由规则去路由到这个接口的实现，可能会路由到服务器集群的服务，也可能会路由到你本地的接口实现，可能你发起多次调用，一次都不会路由到你的本地，所以，什么时候注册中心才能路由到我本机让我打打断点调试下接口？随注册中心的缘吧</p>
<h2 data-id="heading-3">本地完成dubbo接口单元测试</h2>
<p>为了解决上面那个问题，让接口调用只走本地dubbo实现，我们可以在本地dubbo接口中设置register属性为false，这就标志本地这个dubbo服务不会注册到了注册中心，怎么写呢？下面是例子（xml配置格式一样，改写register属性为false）</p>
<p>provider 提供者：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-comment">// register=fasle 注意这个属性和值</span>
<span class="hljs-meta">@DubboService(register = false)</span>
<span class="hljs-meta">@RequiredArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusiDubboImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BusiDubbo</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BusiService1 busiService1;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BusiService2 busiService2;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BusiService3 busiService3;
    

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List <span class="hljs-title function_">listBusi</span><span class="hljs-params">(BusiDubboDto bdd)</span>{
        <span class="hljs-type">List</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
        <span class="hljs-comment">// 业务处理1, 比如：result的获取</span>
        result = busiService1.list();

        <span class="hljs-comment">// 业务处理2，比如：过滤出xxx的业务数据</span>
        result.filter(source -&gt; {<span class="hljs-comment">/** xxxxx */</span>})

        <span class="hljs-comment">// 业务处理3， 比如：对比前一期数据，找到x不对的</span>
        busiService2.list2().filter(source -&gt; {
            <span class="hljs-keyword">return</span> (result.notContains(source.getX());
        })
        
        <span class="hljs-comment">// ...</span>
        busiService3.save(result);

        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p>既然不会注册到注册中心，那么消费在消费的时候，注册中心不会有这个接口服务，注册中心更不会根据路由规则找到这个接口，但是我们需要调试，就表示JUnit的单元测试需要调用本地的dubbo服务实现，接口服务就这样写了</p>
<p>consumer 消费者：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Junit</span>
<span class="hljs-comment">// 省略其他注解</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AiInvokingCoreControllerTest</span> {

    <span class="hljs-meta">@DubboReference(protocol = "tri", url = "tri://127.0.0.1:50051")</span>
    <span class="hljs-keyword">private</span> BusiDubbo busiDubbo;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testListBusi</span><span class="hljs-params">()</span>{
        <span class="hljs-type">BusiDubboDto</span> <span class="hljs-variable">bdd</span> <span class="hljs-operator">=</span> BusiDubboDto.builder().p1(<span class="hljs-string">"x1"</span>).p2(<span class="hljs-string">"x2"</span>)....build();
        <span class="hljs-type">List</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> busiDubbo.listBusi();
        assertEquals(<span class="hljs-number">100</span>, result.size());
    }
}
</code></pre>
<p>经常使用dubbo框架的朋友们可能注意到了，在@DubboReference注解中有两个属性，一个是protocal，一个是url。</p>
<p>protocol是协议声明，dubbo支持的协议是dubbo、grpc、rest、triple等</p>
<p>url是dubbo实现的调用地址，我们是本地运行的dubbo服务，因此根据protocal的协议，url的值应该是：</p>





























<table><thead><tr><th>协议名称</th><th>配置值</th><th>默认端口</th><th>url填写示例</th></tr></thead><tbody><tr><td><strong>triple</strong></td><td>tri</td><td>50051</td><td>tri://127.0.0.1:50051</td></tr><tr><td><strong>dubbo</strong></td><td>dubbo</td><td>20880</td><td>dubbo://127.0.0.1:5001</td></tr><tr><td><strong>rest</strong></td><td>tri 或 rest</td><td>50051</td><td>tri://127.0.0.1:50051rest://127.0.0.1:50051</td></tr></tbody></table>
<p>好了，如果你用的是dubbo协议，怎么写？下面是示例</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Junit</span>
<span class="hljs-comment">// 省略其他注解</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AiInvokingCoreControllerTest</span> {

    
    <span class="hljs-meta">@DubboReference(protocol = "dubbo", url = "dubbo://127.0.0.1:20880")</span>
    <span class="hljs-keyword">private</span> BusiDubbo busiDubbo;

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testListBusi</span><span class="hljs-params">()</span>{
        <span class="hljs-type">BusiDubboDto</span> <span class="hljs-variable">bdd</span> <span class="hljs-operator">=</span> BusiDubboDto.builder().p1(<span class="hljs-string">"x1"</span>).p2(<span class="hljs-string">"x2"</span>)....build();
        <span class="hljs-type">List</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> busiDubbo.listBusi();
        assertEquals(<span class="hljs-number">100</span>, result.size());
    }
}
</code></pre>
<h2 data-id="heading-4">极简的结尾</h2>
<p>简单来说，首先，dubbo接口实现中的register改成false，不把接口注册到注册中心；其次，调用方配置好protoal协议值，再根据公式 "协议配置值://127.0.0.1:协议默认端口号" 填充并替换掉 ${...} 部分的内容，即可开展你的本地dubbo服务单元测试了。</p>
<p>好好享受断点的幸福吧~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node-OPCUA 入门(1)-创建一个简单的OPC UA服务器]]></title>    <link>https://juejin.cn/post/7585808181239513139</link>    <guid>https://juejin.cn/post/7585808181239513139</guid>    <pubDate>2025-12-22T01:22:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585808181239513139" data-draft-id="7585897699602333722" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node-OPCUA 入门(1)-创建一个简单的OPC UA服务器"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-22T01:22:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李广山Samuel"/> <meta itemprop="url" content="https://juejin.cn/user/4266544138563288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node-OPCUA 入门(1)-创建一个简单的OPC UA服务器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4266544138563288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李广山Samuel
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T01:22:35.000Z" title="Mon Dec 22 2025 01:22:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0"><strong>1.0 node-opcua简介</strong></h4>
<p>node-opcua是一个完全用Typescript为NodeJS编写的OPC UA栈的实现。不依赖于外部第三方库。它依赖于一些仅在服务器端可用的javascript模块，如fs (FileSystem)或net(Socket)。</p>
<h4 data-id="heading-1"><strong>2.0 创建一个简单的node-opcua 服务器</strong></h4>
<p>在这个示例中，我们创建一个OPC UA服务器，它公开3个读/写变量，服务器将在名为“我的设备”的新对象下公开这些变量。</p>
<pre><code class="hljs language-Plain" lang="Plain">    + 跟文件夹
        + 项目
            + 我的设备
                + 变量1
                + 变量2
</code></pre>
<h5 data-id="heading-2"><strong>2.1 首先创建一个项目:</strong></h5>
<pre><code class="hljs language-bash" lang="bash">$ <span class="hljs-built_in">mkdir</span> myserver
$ <span class="hljs-built_in">cd</span> myserver
$ npm init                      <span class="hljs-comment"># 初始化项目创建一个package.json文件</span>
$ npm install node-opcua --save <span class="hljs-comment"># 添加依赖node-opcua模块</span>
</code></pre>
<h5 data-id="heading-3"><strong>2.2 编辑项目</strong></h5>
<p>在项目目录项创建并编辑一个sample_server.js文件</p>
<p>2.2.1 通过'require'语句导入node-opcua模块:</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">OPCUAServer</span>, <span class="hljs-title class_">Variant</span>, <span class="hljs-title class_">DataType</span>, <span class="hljs-title class_">StatusCodes</span>} = <span class="hljs-built_in">require</span>(<span class="hljs-string">"node-opcua"</span>);
</code></pre>
<p>2.2.2 服务器实例化</p>
<p>创建一个OPCUAServer实例。可以将选项传递给OPCUAServer来定制行为。对于简单的服务器，您只需要指定一个TCP端口。</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 创建一个OPCUAServer</span>
    <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OPCUAServer</span>({
        <span class="hljs-attr">port</span>: <span class="hljs-number">4334</span>, <span class="hljs-comment">// 服务器套接字的监听端口</span>
        <span class="hljs-attr">resourcePath</span>: <span class="hljs-string">"/UA/MyLittleServer"</span>, <span class="hljs-comment">//此路径将添加到端点资源名称中</span>
        <span class="hljs-attr">buildInfo</span>: {
            <span class="hljs-attr">productName</span>: <span class="hljs-string">"我的示例服务器1"</span>,
            <span class="hljs-attr">buildNumber</span>: <span class="hljs-string">"7658"</span>,
            <span class="hljs-attr">buildDate</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">2014</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>)
        }
    });
</code></pre>
<p>资源路径将用于构造服务器的端点统一资源标识符(url)。在我们的例子中，服务器的端点urn将是：</p>
<pre><code class="hljs language-javascript" lang="javascript">opc.<span class="hljs-property">tcp</span>:<span class="hljs-comment">//&lt;hostname&gt;:4334/UA/MyLittleServer</span>
</code></pre>
<p>hostname替换为您的计算机名称或完全合格的域名。  客户端必须使用这个URN连接到服务器。</p>
<p>设置服务器信息，可以在这个阶段设置其他信息，例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-attr">buildInfo</span>: {
            <span class="hljs-attr">productName</span>: <span class="hljs-string">"我的示例服务器1"</span>,
            <span class="hljs-attr">buildNumber</span>: <span class="hljs-string">"7658"</span>,
            <span class="hljs-attr">buildDate</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">2022</span>, <span class="hljs-number">9</span>, <span class="hljs-number">8</span>)
        }
</code></pre>
<p>2.2.3 服务器初始化</p>
<p>一旦创建，服务器将被初始化。在初始化期间，服务器将加载其默认节点集，并准备所有标准OPC UA变量的绑定。initialize方法是一个异步操作，需要一个“回调”函数，该函数将在初始化过程完成时执行。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">await</span> server.<span class="hljs-title function_">initialize</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"已初始化"</span>);
</code></pre>
<p>2.2.4 初始化后</p>
<p>让我们创建一个函数，它将使用一些我们想要公开的变量来扩展服务器默认地址空间。这个函数将在初始化回调函数中调用。</p>
<p>addressSpace用于定制我们的服务器将向外部世界公开的对象模型。</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">const</span> addressSpace = server.<span class="hljs-property">engine</span>.<span class="hljs-property">addressSpace</span>;
  <span class="hljs-keyword">const</span> namespace = addressSpace.<span class="hljs-title function_">getOwnNamespace</span>();
</code></pre>
<p>2.2.5 在objects文件夹中添加一个新对象</p>
<pre><code class="hljs language-javascript" lang="javascript">    <span class="hljs-comment">// 声明一个新对象</span>
    <span class="hljs-keyword">const</span> device = namespace.<span class="hljs-title function_">addObject</span>({
        <span class="hljs-attr">organizedBy</span>: addressSpace.<span class="hljs-property">rootFolder</span>.<span class="hljs-property">objects</span>,
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"我的设备"</span>
    });
</code></pre>
<p>2.2.6 添加一些变量</p>
<p>在服务器名称空间中添加变量1， 模拟“变量1”每500毫秒改变一次。</p>
<pre><code class="hljs language-javascript" lang="javascript">    <span class="hljs-comment">// 将“变量1”添加到新创建的文件夹“我的设备”中</span>

    <span class="hljs-keyword">const</span> variable1 = namespace.<span class="hljs-title function_">addVariable</span>({
        <span class="hljs-attr">componentOf</span>: device,
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"变量1"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">"Double"</span>,
        <span class="hljs-attr">minimumSamplingInterval</span>: <span class="hljs-number">100</span>,
    });
    <span class="hljs-keyword">let</span> counter = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 模拟“变量1”每500毫秒改变一次</span>
    <span class="hljs-keyword">const</span> timerId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> { counter += <span class="hljs-number">1</span>; variable1.<span class="hljs-title function_">setValueFromSource</span>({ <span class="hljs-attr">dataType</span>: <span class="hljs-title class_">DataType</span>.<span class="hljs-property">Double</span>, <span class="hljs-attr">value</span>: counter }) }, <span class="hljs-number">500</span>);

    addressSpace.<span class="hljs-title function_">registerShutdownTask</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-built_in">clearInterval</span>(timerId); });
</code></pre>
<p>注意，上面的例子，我们没有为变量指定NodeId。服务器会自动为我们分配一个新的nodeId。</p>
<p>添加变量2，这个示例我们指定节点ID：</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-comment">// 在新创建的文件夹我的设备中添加一个名为“变量2”的变量</span>

    namespace.<span class="hljs-title function_">addVariable</span>({

        <span class="hljs-attr">componentOf</span>: device,
        <span class="hljs-attr">nodeId</span>: <span class="hljs-string">"ns=1;b=1020FFAA"</span>, <span class="hljs-comment">// 命名空间中的节点ID</span>
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"变量2"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">"Double"</span>,
        <span class="hljs-attr">minimumSamplingInterval</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 这个变量受事件驱动</span>
    });
</code></pre>
<p>下面再创建一个变量，来公开运行中的机器上的可用内存百分比。  我们写一个函数来计算这个值。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">"os"</span>);
    <span class="hljs-comment">/**
     * 返回运行中的机器上的空闲内存百分比
     * <span class="hljs-doctag">@return</span> {<span class="hljs-type">double</span>}
     */</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">available_memory</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// var value = process.memoryUsage().heapUsed / 1000000;</span>
        <span class="hljs-keyword">const</span> percentageMemUsed = os.<span class="hljs-title function_">freemem</span>() / os.<span class="hljs-title function_">totalmem</span>() * <span class="hljs-number">100.0</span>;
        <span class="hljs-keyword">return</span> percentageMemUsed;
    }
    namespace.<span class="hljs-title function_">addVariable</span>({

        <span class="hljs-attr">componentOf</span>: device,

        <span class="hljs-attr">nodeId</span>: <span class="hljs-string">"s=free_memory"</span>, <span class="hljs-comment">// 一个字符串节点ID</span>
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"空闲内存"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">"Double"</span>,
        <span class="hljs-attr">minimumSamplingInterval</span>: <span class="hljs-number">1234</span>,
        <span class="hljs-attr">value</span>: {
            <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Variant</span>({ <span class="hljs-attr">dataType</span>: <span class="hljs-title class_">DataType</span>.<span class="hljs-property">Double</span>, <span class="hljs-attr">value</span>: <span class="hljs-title function_">available_memory</span>() })
        }
    });
</code></pre>
<p>2.2.7 启动服务器
创建并初始化服务器之后，我们使用start异步方法让服务器初始化它的所有端点并开始监听客户端。显示端点url</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">start</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"服务器正在监听 ... ( 按 CTRL+C 停止)"</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"端口 "</span>, server.<span class="hljs-property">endpoints</span>[<span class="hljs-number">0</span>].<span class="hljs-property">port</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 主服务器端点url是 "</span>, server.<span class="hljs-title function_">getEndpointUrl</span>());
</code></pre>
<p>2.2.8 下面，是完整sample_server.js文件</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> os = <span class="hljs-built_in">require</span>(<span class="hljs-string">"os"</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">OPCUAServer</span>, <span class="hljs-title class_">Variant</span>, <span class="hljs-title class_">DataType</span>, <span class="hljs-title class_">StatusCodes</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"node-opcua"</span>);


(<span class="hljs-keyword">async</span> () =&gt; {

    <span class="hljs-comment">// 创建一个OPCUAServer</span>
    <span class="hljs-keyword">const</span> server = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OPCUAServer</span>({
        <span class="hljs-attr">port</span>: <span class="hljs-number">4334</span>, <span class="hljs-comment">// 服务器套接字的监听端口</span>
        <span class="hljs-attr">resourcePath</span>: <span class="hljs-string">"/UA/MyLittleServer"</span>, <span class="hljs-comment">//此路径将添加到端点资源名称中</span>
        <span class="hljs-attr">buildInfo</span>: {
            <span class="hljs-attr">productName</span>: <span class="hljs-string">"我的示例服务器1"</span>,
            <span class="hljs-attr">buildNumber</span>: <span class="hljs-string">"7658"</span>,
            <span class="hljs-attr">buildDate</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">2022</span>, <span class="hljs-number">9</span>, <span class="hljs-number">8</span>)
        }
    });
    <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">initialize</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"已初始化"</span>);

    <span class="hljs-keyword">const</span> addressSpace = server.<span class="hljs-property">engine</span>.<span class="hljs-property">addressSpace</span>;
    <span class="hljs-keyword">const</span> namespace = addressSpace.<span class="hljs-title function_">getOwnNamespace</span>();

    <span class="hljs-comment">// 声明一个新对象</span>
    <span class="hljs-keyword">const</span> device = namespace.<span class="hljs-title function_">addObject</span>({
        <span class="hljs-attr">organizedBy</span>: addressSpace.<span class="hljs-property">rootFolder</span>.<span class="hljs-property">objects</span>,
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"我的设备"</span>
    });

    <span class="hljs-comment">// 添加一些变量</span>
    <span class="hljs-comment">// 将“变量1”添加到新创建的文件夹“我的设备”中</span>

    <span class="hljs-keyword">const</span> variable1 = namespace.<span class="hljs-title function_">addVariable</span>({
        <span class="hljs-attr">componentOf</span>: device,
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"变量1"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">"Double"</span>,
        <span class="hljs-attr">minimumSamplingInterval</span>: <span class="hljs-number">100</span>,
    });

    <span class="hljs-keyword">let</span> counter = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 模拟“变量1”每500毫秒改变一次</span>
    <span class="hljs-keyword">const</span> timerId = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> { counter += <span class="hljs-number">1</span>; variable1.<span class="hljs-title function_">setValueFromSource</span>({ <span class="hljs-attr">dataType</span>: <span class="hljs-title class_">DataType</span>.<span class="hljs-property">Double</span>, <span class="hljs-attr">value</span>: counter }) }, <span class="hljs-number">500</span>);

    addressSpace.<span class="hljs-title function_">registerShutdownTask</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-built_in">clearInterval</span>(timerId); });

    <span class="hljs-comment">// 在新创建的文件夹我的设备中添加一个名为“变量2”的变量</span>

    namespace.<span class="hljs-title function_">addVariable</span>({

        <span class="hljs-attr">componentOf</span>: device,
        <span class="hljs-attr">nodeId</span>: <span class="hljs-string">"ns=1;b=1020FFAA"</span>, <span class="hljs-comment">// 命名空间中的节点ID</span>
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"变量2"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">"Double"</span>,
        <span class="hljs-attr">minimumSamplingInterval</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 这个变量受事件驱动</span>
    });

    <span class="hljs-comment">/**
     * 返回运行中的机器上的空闲内存百分比
     * <span class="hljs-doctag">@return</span> {<span class="hljs-type">double</span>}
     */</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">available_memory</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// var value = process.memoryUsage().heapUsed / 1000000;</span>
        <span class="hljs-keyword">const</span> percentageMemUsed = os.<span class="hljs-title function_">freemem</span>() / os.<span class="hljs-title function_">totalmem</span>() * <span class="hljs-number">100.0</span>;
        <span class="hljs-keyword">return</span> percentageMemUsed;
    }
    namespace.<span class="hljs-title function_">addVariable</span>({

        <span class="hljs-attr">componentOf</span>: device,

        <span class="hljs-attr">nodeId</span>: <span class="hljs-string">"s=free_memory"</span>, <span class="hljs-comment">// 一个字符串节点ID</span>
        <span class="hljs-attr">browseName</span>: <span class="hljs-string">"空闲内存"</span>,
        <span class="hljs-attr">dataType</span>: <span class="hljs-string">"Double"</span>,
        <span class="hljs-attr">minimumSamplingInterval</span>: <span class="hljs-number">1234</span>,
        <span class="hljs-attr">value</span>: {
            <span class="hljs-attr">get</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Variant</span>({ <span class="hljs-attr">dataType</span>: <span class="hljs-title class_">DataType</span>.<span class="hljs-property">Double</span>, <span class="hljs-attr">value</span>: <span class="hljs-title function_">available_memory</span>() })
        }
    });

    <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">start</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"服务器正在监听 ... ( 按 CTRL+C 停止)"</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"端口 "</span>, server.<span class="hljs-property">endpoints</span>[<span class="hljs-number">0</span>].<span class="hljs-property">port</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" 主服务器端点url是 "</span>, server.<span class="hljs-title function_">getEndpointUrl</span>());

    process.<span class="hljs-title function_">once</span>(<span class="hljs-string">"SIGINT"</span>, <span class="hljs-keyword">async</span> () =&gt; {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"正在关闭"</span>);
        <span class="hljs-keyword">await</span> server.<span class="hljs-title function_">shutdown</span>();
    });

})();
</code></pre>
<p>2.2.9 执行并测试服务器</p>
<pre><code class="hljs language-javascript" lang="javascript">$ node sample_server.<span class="hljs-property">js</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d0d47581a7c4e0989592a9503581d71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=tYgYp1IrGCuH15zsgdgmP%2BDe4uY%3D" alt="NVUZtZaPGYnk9DWhk40JGBQJNsUQVvLTP__fcJMkpMo.png" loading="lazy"/></p>
<p>3.0 使用UaExpert测试服务</p>
<p>3.1 打开UaExpert，右键选择“Project|Server”在上下文菜单点击”Add...“添加</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e21c8633760d420989bbb47711831a97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=kD6v3H8582kjNS4WKPJs2RS3RDk%3D" alt="ctMnaDZEwwchS0JwVCWzYhpTisVjM2bgQp6krTsAADE.png" loading="lazy"/></p>
<p>3.2 打开添加服务器窗口，添加服务器</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ed8155d049a46aab7068b8ed0da8c7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=%2FP3oc5vMmi70IA2xbdbDuxcfqzE%3D" alt="vXHrvjLXhEtJ0lHQ7IGn9ReE-clOAlwviwiSc2dJFlo.png" loading="lazy"/></p>
<p>3.3 添加服务器URL地址，本例中为opc.tcp://DESKTOP-MGFMSQP:4334/UA/MyLittleServer
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/049e2c742e654db391cc37eb0db27086~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=ryA5x%2Fozb7%2FaE1FrOZekX0q14qY%3D" alt="QzZyLelutfKOqvPBTjsxaUMhFBTIjjEdyjZaTBgB_KE.png" loading="lazy"/>
3.4 服务器被找到，选择加密方式，确认添加
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e03770ee7e4e46c2824ee21cb25aa629~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=Sdgch22OBSqMwWvctmI0CBZy30k%3D" alt="nh6lsCkudkazjJwVZev3wZZBoHo-TQJQZ2gkgb1aOHk.png" loading="lazy"/>
3.5 在Servers文件夹下，选择新添加的服务器NodeOPCUA，右键上下文菜单点击Connect连接服务器。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f22f8b62e21a41a2905d422b7a54a9c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=LNgh6xz0Opiohh6XAfDeoV3lIFI%3D" alt="c5yByz8iSWUWRze6PU5pCAzCnDbLhMXcTv6HIb5Qo60.png" loading="lazy"/>
3.6 在下面的Adddress Space(地址空间)，列出了我的设备和变量
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f6ca40cb6f04c239701b830649ac1fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=Ad3jTH2QdhRzo9UQs49xG1gtNE4%3D" alt="FJJ_whd0L1rCkY7l-5LNeLvwZAYb1hSvo5veKd88fPc.png" loading="lazy"/>
3.7 把变量拖入Data Access View(数据访问视图)，可以看到变量值的变化。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/987a16d20d1c4a5f8dda0cc7136b10a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5bm_5bGxU2FtdWVs:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766971355&amp;x-signature=BcrvCESFzQ2Av3cXrUKCVGqU0Dc%3D" alt="_dk2ixj4L0qGC1Fv7XghkcHY-T4qaev_70bqatJ0I_E.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript的八大数据类型]]></title>    <link>https://juejin.cn/post/7585839411122241582</link>    <guid>https://juejin.cn/post/7585839411122241582</guid>    <pubDate>2025-12-21T17:49:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585839411122241582" data-draft-id="7585808181239283763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript的八大数据类型"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-21T17:49:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="兮动人"/> <meta itemprop="url" content="https://juejin.cn/user/3491704662668878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript的八大数据类型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3491704662668878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    兮动人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T17:49:48.000Z" title="Sun Dec 21 2025 17:49:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin:30px 0 10px;color:#cca152;position:relative;padding-left:50px;border-bottom:2px solid rgba(209,163,78,.6);padding-bottom:0}.markdown-body h1{font-size:30px}.markdown-body h1:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:80%;bottom:-10px;left:-2px}.markdown-body h2{font-size:24px}.markdown-body h2:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:70%;bottom:-15px;left:-1px}.markdown-body h3{font-size:18px}.markdown-body h3:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:60%;bottom:-19px;left:-2px}.markdown-body h4{font-size:16px;padding-left:0;border-bottom:1px solid rgba(209,163,78,.6)}.markdown-body h5{font-size:15px;padding-left:0}.markdown-body em{color:#cca152}.markdown-body del{text-decoration-color:#cca152;text-decoration-thickness:2px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:80%;margin:6px auto;box-shadow:0 6px 15px #8e8e8e;display:block;margin:20px auto!important;object-fit:contain;border-radius:8px}.markdown-body hr{border:none;border-top:2px solid #e0c9a1;margin-top:32px 0}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background:#f6efde;color:#b69454;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Mono,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;background:#fef6e1;border-radius:4px;box-shadow:0 0 8px hsla(0,0%,47%,.45)}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAOCAMAAABaWb9VAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAADsQAAA7EAZUrDhsAAACHUExURUdwTMxCKdc8NvdYT/9hVyLJPABBAGubKNiIOv+/K+ytJBakH9aZG+5QR5VZDOBDPhmtJ8+VGuGjH/CwJR26MR6+NBq0LPW1KBmwKetNRfJUTONHP92fHuSmIeFEPhu3LR29M/BTS+mqIuqsI5qdHyLKPP++Kv9gVf9lW//KLSXXQCTQP//FLMVm5KQAAAAldFJOUwAlPPz7+woBBPu8Mzu+FlRRKmvnweeG+Wqg6mVNXmuc1OCbmjZJWF/9AAABKklEQVQoz3WS6XaCMBCFRzAM++KGsqhtDwES3//5OtmA2uP9A9zwzRoAgBC0QgQrdA68OZsDr229YGHoIEj7Pl0ZOgjKa5lYJ4Rd1vijn3nuD4Qurjmv48o6RFyfbGDnS6DeEXZfk5ZfuBhdPb9I87ECNMh1EFJKIU6agWzaa01NbmLkxznSmmObJBkkUxrERf3i+ftRiZi7ShPCYY64UhTx1AR5CDYoMXkOKEY7GmTcTzeD/FiER68DfSLgSRqEIBoB3P8h3x8RZhBXGJGusJdD6rfCBl0YqvZNkrV9zej2cWlfJWG6fRpyM41qYH+GTPPi2yFLQYC0Qybm5o96lW77kMbcrBKtgeWTsthVamNXFF4I6x0DTPuugsVRFyYpyxzWqNvHJwed8ws7QyP1UwjNjwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fef6e1}.markdown-body a{text-decoration:none;color:#d8ac5a;border-bottom:1px solid #d8ac5a}.markdown-body a:active,.markdown-body a:hover{color:#93753f;border-color:#93753f}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f4e8c7;border-collapse:collapse}.markdown-body thead{background:rgba(255,227,176,.6588235294);text-align:left;display:table-header-group;border-bottom:1px solid rgba(255,227,176,.6588235294)}.markdown-body tbody{background:rgba(255,247,229,.3882352941)}.markdown-body td,.markdown-body th{padding:7px;line-height:24px;min-width:100px}.markdown-body blockquote{color:#bd954f;padding:1px 23px;margin:22px 0;border-left:4px solid #dcb267;background-color:#fff7e5}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol .task-list-item,.markdown-body ul .task-list-item{list-style:none}.markdown-body ol li{padding-left:6px}.markdown-body::marker{color:#dcb267}.markdown-body .contains-task-list{padding-left:0}.markdown-body .contains-task-list .task-list-item{list-style:none;position:relative}.markdown-body .contains-task-list .task-list-item input[type=checkbox]{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:before{content:"";display:inline-block;height:12px;width:12px;position:absolute;left:-2px;top:-2px;border:2px solid #cda152;border-radius:5px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked:before{border:none;content:"";display:inline-block;height:17px;width:17px;position:absolute;left:-2px;top:-2px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAAAXNSR0IArs4c6QAAAYhJREFUOBFjYACC0/MDGsDEiyvr/zOCeUwMJxn/A8HZRUEMYBFGJsZ6kFoQYALiAyAGCgDpA+sFijKeWRj4H1kWpIWBW1SDQcm+BCzOAiK/vr7BcO/gDbAAI4hE1waWgRBnmWCGIwkyKFjnwow0BhsJk9QLncvw5dV1oPE9MCEGmBWrgCKhcFEowyR+PSNYwemFAZ4M/xjMkRWYJm5oAPFB/joDpI1BHHQANgGPDxj+//vfCA4IdJ3GcevgQnAFhlHLwYIgSVA0wABcwY3tFQzokiBFGIEP0wmigW5wZAK5FFkQib0a6NUDcEmgb7AGFpIGZOZqoMFhIAFQknEAJpn9yLLEssFOBCp2IFaDkl0xg6C8FbJyB3gowUS5RdQYBORQYpVB1iwVHIIMwJh///AYTCmYRklNIBFmNi4GeYt0BhnjeIa3dw8wSBlEgDUhxw2yCRgGfHp2geHiqiSwUwUVrFAiFVkjjA1LrjgTHEwhFvosMCZM4NEIUoAtWWNoBGZ70/gN22HiAD2uhAzsYNBZAAAAAElFTkSuQmCC) 0 0 no-repeat;background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在前端开发中，<strong>数据类型</strong>是构建一切逻辑的原子。</p>
</blockquote>
<p>在 JavaScript（ECMAScript 标准）中，数据类型主要分为两大类：<strong>基本数据类型（Primitive）</strong> 和 <strong>引用数据类型（Reference）</strong>。目前共有 <strong>8 种</strong>。</p>
<h2 data-id="heading-0">JavaScript 的 8 大数据类型</h2>
<p>在 JavaScript 的世界里，数据被分为两大阵营：<strong>基本数据类型（Primitive）</strong> 和 <strong>引用数据类型（Reference）</strong>。截至目前的 ECMAScript 标准，共有 <strong>8 种</strong> 原生数据类型。</p>
<hr/>
<h3 data-id="heading-1">一、 基本数据类型（值类型）</h3>
<p>基本类型存放在内存的 <strong>栈（Stack）</strong> 中，特点是：<strong>值直接存储在变量访问的位置</strong>。</p>
<h4 data-id="heading-2">1. Number (数值)</h4>
<p>包含整数和浮点数，还有特殊的 <code>NaN</code>（Not a Number）和 <code>Infinity</code>。</p>
<ul>
<li><strong>例子：</strong> <code>let age = 25;</code>, <code>let price = 99.99;</code>, <code>let nan = NaN;</code> (非数字)。</li>
</ul>
<h4 data-id="heading-3">2. String (字符串)</h4>
<p>用于表示文本，可以使用单引号、双引号或反引号（模板字符串）。</p>
<ul>
<li><strong>例子：</strong> <code>let name = "兮动人";</code> 或</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> greeting = <span class="hljs-title class_">Hello</span>, ${name};
</code></pre>
<h4 data-id="heading-4">3. Boolean (布尔值)</h4>
<p>只有两个逻辑值。</p>
<ul>
<li><strong>例子：</strong> <code>let isLogin = true;</code></li>
</ul>
<h4 data-id="heading-5">4. Undefined (未定义)</h4>
<p>变量已声明但未初始化时的默认值。
当一个变量被声明了但没赋值时，它的默认值就是 <code>undefined</code>。</p>
<ul>
<li><strong>例子：</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> x; <span class="hljs-comment">// x 的值就是 undefined</span>
</code></pre>
<h4 data-id="heading-6">5. Null (空值)</h4>
<p>表示一个空对象的指针。通常用于主动释放对象引用。</p>
<blockquote>
<p>表示一个“空”的对象引用。有趣的是，<code>typeof null</code> 会返回 <code>"object"</code>，这是 JS 历史遗留的一个著名 Bug。</p>
</blockquote>
<ul>
<li><strong>例子：</strong> <code>let user = null;</code></li>
</ul>
<h4 data-id="heading-7">6. Symbol (符号) - ES6 引入</h4>
<p>表示独一无二的值，常用于解决对象属性名冲突问题。</p>
<ul>
<li><strong>例子：</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> id = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"key"</span>);
<span class="hljs-keyword">let</span> emptyRoom = <span class="hljs-literal">null</span>;
</code></pre>
<h4 data-id="heading-8">7. BigInt (任意精度整数) - ES10 引入</h4>
<p>用于表示大于  的整数（Number 类型的安全上限）。</p>
<ul>
<li><strong>例子：</strong></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> bigNum1 = <span class="hljs-number">9007199254740991n</span>;
</code></pre>
<hr/>
<h3 data-id="heading-9">二、 引用数据类型（对象类型）</h3>
<h4 data-id="heading-10">8. Object (对象)</h4>
<p>存放在内存的<strong>堆（Heap）<strong>中。变量名在栈中存储的不是值本身，而是一个</strong>指向堆内存地址的指针</strong>。</p>
<p>除了普通对象 <code>{}</code>，以下本质上也属于 Object：</p>
<ul>
<li><strong>普通对象：</strong> <code>let user = { name: "xdr630", age: 22 };</code></li>
<li><strong>Array (数组)：</strong> <code>[1, 2, 3]</code></li>
<li><strong>Function (函数)：</strong> <code>function() {}</code></li>
<li><strong>Date (日期)、RegExp (正则) 等。</strong></li>
</ul>
<hr/>
<h3 data-id="heading-11">三、 核心区别对比</h3>






























<table><thead><tr><th>特性</th><th>基本数据类型 (Primitive)</th><th>引用数据类型 (Reference)</th></tr></thead><tbody><tr><td><strong>存储位置</strong></td><td><strong>栈 (Stack)</strong></td><td><strong>堆 (Heap)</strong></td></tr><tr><td><strong>赋值表现</strong></td><td>值的拷贝（修改副本不影响原值）</td><td>地址的拷贝（修改副本会改变原对象）</td></tr><tr><td><strong>大小</strong></td><td>占用空间固定、小</td><td>占用空间大、不固定</td></tr><tr><td><strong>比较</strong></td><td>比较的是 <strong>值</strong> 是否相等</td><td>比较的是 <strong>内存地址</strong> 是否相同</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-12">四、 如何精准判断类型？</h3>
<p>在实际开发中，经常用到以下三种方式：</p>
<ol>
<li><strong><code>typeof</code></strong>: 简单好用，但无法区分 <code>null</code> 与 <code>object</code>（都会返回 <code>"object"</code>），也无法区分数组。</li>
<li><strong><code>instanceof</code></strong>: 用于判断某个实例是否属于某个构造函数（如 <code>arr instanceof Array</code>）。</li>
<li><strong><code>Object.prototype.toString.call()</code></strong>: <strong>最强方案</strong>。能精准返回 <code>[object Array]</code>、<code>[object Null]</code> 等字符串。</li>
</ol>
<blockquote>
<p><strong>小知识：</strong> 为什么 <code>typeof null</code> 是 <code>"object"</code>？
这是 JS 最初设计时的 Bug，为了兼容旧代码，这个错误被一直保留到了今天。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue 甘特图 vxe-gantt 如何自定义依赖线的颜色]]></title>    <link>https://juejin.cn/post/7585553799299153966</link>    <guid>https://juejin.cn/post/7585553799299153966</guid>    <pubDate>2025-12-21T23:49:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585553799299153966" data-draft-id="7585645111876648987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue 甘特图 vxe-gantt 如何自定义依赖线的颜色"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-21T23:49:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户84179481456"/> <meta itemprop="url" content="https://juejin.cn/user/3921272428567529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue 甘特图 vxe-gantt 如何自定义依赖线的颜色
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3921272428567529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户84179481456
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T23:49:03.000Z" title="Sun Dec 21 2025 23:49:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>vue 甘特图 vxe-gantt 如何自定义依赖线的颜色,通过设置 links 定义连接线,from 对应源任务的行主键,tom 对应目标任务的行主键</p>
<p>0 FinishToStart 结束后才开始，表示一个任务必须在另一个任务开始之前完成<br/>
1 StartToFinish 开始到结束，表示从某个过程的开始到结束的整个过程<br/>
2 StartToStart 开始后才开始，表示一个活动结束了，另一个活动才能开始，它们之间按先后顺序进行<br/>
3 FinishToFinish 完成到完成，表示一个任务必须在另一个任务完成之后才能完成</p>
<p>查看官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgantt.vxeui.com%2F" target="_blank" title="https://gantt.vxeui.com/" ref="nofollow noopener noreferrer">gantt.vxeui.com/</a><br/>
gitbub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fx-extends%2Fvxe-gantt" target="_blank" title="https://github.com/x-extends/vxe-gantt" ref="nofollow noopener noreferrer">github.com/x-extends/v…</a><br/>
gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fx-extends%2Fvxe-gantt" target="_blank" title="https://gitee.com/x-extends/vxe-gantt" ref="nofollow noopener noreferrer">gitee.com/x-extends/v…</a></p>
<h2 data-id="heading-0">自定义所有连接线的的颜色</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c51ce597d8747598544333c7b78b679~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODQxNzk0ODE0NTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766967437&amp;x-signature=rU7tQTtrAsgnNJIsncT%2Bb2Y6mVk%3D" alt="image" loading="lazy"/></p>
<p>通过设置 task-link-config.lineColor 自定义连接线的颜色</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">vxe-gantt</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"ganttOptions"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">vxe-gantt</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VxeGanttDependencyType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vxe-gantt'</span>

<span class="hljs-keyword">const</span> ganttOptions = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">border</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">height</span>: <span class="hljs-number">500</span>,
  <span class="hljs-attr">rowConfig</span>: {
    <span class="hljs-attr">keyField</span>: <span class="hljs-string">'id'</span> <span class="hljs-comment">// 行主键</span>
  },
  <span class="hljs-attr">taskBarConfig</span>: {
    <span class="hljs-attr">showProgress</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否显示进度条</span>
    <span class="hljs-attr">showContent</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否在任务条显示内容</span>
    <span class="hljs-attr">move</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否允许拖拽任务移动日期</span>
    <span class="hljs-attr">resize</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否允许拖拽任务调整日期</span>
    <span class="hljs-attr">barStyle</span>: {
      <span class="hljs-attr">round</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 圆角</span>
      <span class="hljs-attr">bgColor</span>: <span class="hljs-string">'#fca60b'</span>, <span class="hljs-comment">// 任务条的背景颜色</span>
      <span class="hljs-attr">completedBgColor</span>: <span class="hljs-string">'#65c16f'</span> <span class="hljs-comment">// 已完成部分任务条的背景颜色</span>
    }
  },
  <span class="hljs-attr">taskViewConfig</span>: {
    <span class="hljs-attr">tableStyle</span>: {
      <span class="hljs-attr">width</span>: <span class="hljs-number">480</span> <span class="hljs-comment">// 表格宽度</span>
    }
  },
  <span class="hljs-attr">taskLinkConfig</span>: {
    <span class="hljs-attr">lineColor</span>: <span class="hljs-string">'#fad06c'</span> <span class="hljs-comment">// 给所有线自定义颜色</span>
  },
  <span class="hljs-attr">links</span>: [
    { <span class="hljs-attr">from</span>: <span class="hljs-number">10001</span>, <span class="hljs-attr">to</span>: <span class="hljs-number">10002</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">VxeGanttDependencyType</span>.<span class="hljs-property">FinishToFinish</span> },
    { <span class="hljs-attr">from</span>: <span class="hljs-number">10004</span>, <span class="hljs-attr">to</span>: <span class="hljs-number">10005</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">VxeGanttDependencyType</span>.<span class="hljs-property">StartToStart</span> },
    { <span class="hljs-attr">from</span>: <span class="hljs-number">10005</span>, <span class="hljs-attr">to</span>: <span class="hljs-number">10006</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">VxeGanttDependencyType</span>.<span class="hljs-property">FinishToStart</span> },
    { <span class="hljs-attr">from</span>: <span class="hljs-number">10013</span>, <span class="hljs-attr">to</span>: <span class="hljs-number">10012</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">VxeGanttDependencyType</span>.<span class="hljs-property">StartToFinish</span> }
  ],
  <span class="hljs-attr">columns</span>: [
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'seq'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">70</span> },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'title'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务名称'</span> },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'start'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'开始时间'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'end'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'结束时间'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'progress'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'进度(%)'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">80</span> }
  ],
  <span class="hljs-attr">data</span>: [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10001</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务1'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-01'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-04'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">3</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10002</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务2'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-03'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-08'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">10</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10003</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务3'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-03'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-11'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">90</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10004</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务4'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-05'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-11'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">15</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10005</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务5'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-08'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-15'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">100</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10006</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务6'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-10'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-21'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">5</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10007</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务7'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-15'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-24'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">70</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10008</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务8'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-05'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-15'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">50</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10009</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务9'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-19'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-20'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">5</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10010</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务10'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-12'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-20'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">10</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10011</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务11'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-01'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-08'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">90</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10012</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务12'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-03'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-06'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">60</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10013</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务13'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-02'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-05'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">50</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10014</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务14'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-04'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-15'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">0</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10015</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务15'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-01'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-05'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">30</span> }
  ]
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-1">每条线单独自定义颜色</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6d6805bb6474b599fe978e9d59ccdae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODQxNzk0ODE0NTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766967437&amp;x-signature=zZTw5G3bjFwMbP6lzPEVRW8IiF4%3D" alt="image" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">vxe-gantt</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"ganttOptions"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">vxe-gantt</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">VxeGanttDependencyType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vxe-gantt'</span>

<span class="hljs-keyword">const</span> ganttOptions = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">border</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">height</span>: <span class="hljs-number">500</span>,
  <span class="hljs-attr">rowConfig</span>: {
    <span class="hljs-attr">keyField</span>: <span class="hljs-string">'id'</span> <span class="hljs-comment">// 行主键</span>
  },
  <span class="hljs-attr">taskBarConfig</span>: {
    <span class="hljs-attr">showProgress</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否显示进度条</span>
    <span class="hljs-attr">showContent</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否在任务条显示内容</span>
    <span class="hljs-attr">move</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否允许拖拽任务移动日期</span>
    <span class="hljs-attr">resize</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否允许拖拽任务调整日期</span>
    <span class="hljs-attr">barStyle</span>: {
      <span class="hljs-attr">round</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 圆角</span>
      <span class="hljs-attr">bgColor</span>: <span class="hljs-string">'#fca60b'</span>, <span class="hljs-comment">// 任务条的背景颜色</span>
      <span class="hljs-attr">completedBgColor</span>: <span class="hljs-string">'#65c16f'</span> <span class="hljs-comment">// 已完成部分任务条的背景颜色</span>
    }
  },
  <span class="hljs-attr">taskViewConfig</span>: {
    <span class="hljs-attr">tableStyle</span>: {
      <span class="hljs-attr">width</span>: <span class="hljs-number">480</span> <span class="hljs-comment">// 表格宽度</span>
    }
  },
  <span class="hljs-attr">links</span>: [
    { <span class="hljs-attr">from</span>: <span class="hljs-number">10001</span>, <span class="hljs-attr">to</span>: <span class="hljs-number">10002</span>, <span class="hljs-attr">lineColor</span>: <span class="hljs-string">'#fad06c'</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">VxeGanttDependencyType</span>.<span class="hljs-property">FinishToFinish</span> },
    { <span class="hljs-attr">from</span>: <span class="hljs-number">10004</span>, <span class="hljs-attr">to</span>: <span class="hljs-number">10005</span>, <span class="hljs-attr">lineColor</span>: <span class="hljs-string">'#92c1f1'</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">VxeGanttDependencyType</span>.<span class="hljs-property">StartToStart</span> },
    { <span class="hljs-attr">from</span>: <span class="hljs-number">10005</span>, <span class="hljs-attr">to</span>: <span class="hljs-number">10006</span>, <span class="hljs-attr">lineColor</span>: <span class="hljs-string">'#fd9393'</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">VxeGanttDependencyType</span>.<span class="hljs-property">FinishToStart</span> },
    { <span class="hljs-attr">from</span>: <span class="hljs-number">10013</span>, <span class="hljs-attr">to</span>: <span class="hljs-number">10012</span>, <span class="hljs-attr">lineColor</span>: <span class="hljs-string">'#e78dd2'</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">VxeGanttDependencyType</span>.<span class="hljs-property">StartToFinish</span> }
  ],
  <span class="hljs-attr">columns</span>: [
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'seq'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">70</span> },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'title'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务名称'</span> },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'start'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'开始时间'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'end'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'结束时间'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'progress'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'进度(%)'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">80</span> }
  ],
  <span class="hljs-attr">data</span>: [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10001</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务1'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-01'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-04'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">3</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10002</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务2'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-03'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-08'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">10</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10003</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务3'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-03'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-11'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">90</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10004</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务4'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-05'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-11'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">15</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10005</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务5'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-08'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-15'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">100</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10006</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务6'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-10'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-21'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">5</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10007</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务7'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-15'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-24'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">70</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10008</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务8'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-05'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-15'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">50</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10009</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务9'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-19'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-20'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">5</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10010</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务10'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-12'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-20'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">10</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10011</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务11'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-01'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-08'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">90</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10012</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务12'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-03'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-06'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">60</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10013</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务13'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-02'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-05'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">50</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10014</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务14'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-04'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-15'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">0</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10015</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'任务15'</span>, <span class="hljs-attr">start</span>: <span class="hljs-string">'2024-03-01'</span>, <span class="hljs-attr">end</span>: <span class="hljs-string">'2024-03-05'</span>, <span class="hljs-attr">progress</span>: <span class="hljs-number">30</span> }
  ]
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fx-extends%2Fvxe-gantt" target="_blank" title="https://gitee.com/x-extends/vxe-gantt" ref="nofollow noopener noreferrer">gitee.com/x-extends/v…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python @dataclass 与 Java Lombok：装饰器 vs 注解的哲学差异]]></title>    <link>https://juejin.cn/post/7585920796099821595</link>    <guid>https://juejin.cn/post/7585920796099821595</guid>    <pubDate>2025-12-22T01:58:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585920796099821595" data-draft-id="7585866811716812827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Python @dataclass 与 Java Lombok：装饰器 vs 注解的哲学差异"/> <meta itemprop="keywords" content="Python,Java"/> <meta itemprop="datePublished" content="2025-12-22T01:58:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Python @dataclass 与 Java Lombok：装饰器 vs 注解的哲学差异
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T01:58:13.000Z" title="Mon Dec 22 2025 01:58:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：<code>@dataclass</code> 与 Lombok 功能相似，但前者是 Python 运行时装饰器，主动生成代码；后者依赖 Java 编译期注解处理器。二者体现动态语言的灵活性与静态语言的确定性之别。</p>
<h2 data-id="heading-0">Python <code>@dataclass</code> 与 Java Lombok：装饰器 vs 注解的哲学差异</h2>
<p>在现代编程语言中，减少样板代码（boilerplate code）是提升开发效率和代码可读性的关键目标。Python 的 <code>@dataclass</code> 和 Java 的 Lombok 都致力于解决这一问题——它们让开发者只需声明数据结构，而无需手动编写构造函数、<code>toString()</code>、<code>equals()</code> 等重复逻辑。然而，尽管二者功能相似，其背后的设计哲学、实现机制和语言生态却大相径庭。本文将从 <code>@dataclass</code> 出发，深入探讨 <strong>Python 装饰器</strong> 与 <strong>Java 注解</strong> 的本质区别，并揭示两种语言在“元编程”思路上的根本差异。</p>
<hr/>
<h3 data-id="heading-1">一、<code>@dataclass</code>：Python 的优雅数据类</h3>
<p>自 Python 3.7 起，标准库引入了 <code>@dataclass</code> 装饰器，用于自动生成常见方法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>

<span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span>:
    conversation_id: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = <span class="hljs-literal">None</span>
    role: <span class="hljs-built_in">str</span> = <span class="hljs-string">"user"</span>
    content: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>
    created_at: datetime = <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__post_init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">if</span> self.created_at <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.created_at = datetime.now()
</code></pre>
<p>仅需类型注解和默认值，<code>@dataclass</code> 就会自动提供：</p>
<ul>
<li><code>__init__()</code>：初始化所有字段</li>
<li><code>__repr__()</code>：生成可读字符串表示</li>
<li><code>__eq__()</code>：基于字段值的相等比较</li>
<li>还可通过参数控制是否生成 <code>__hash__</code>、支持排序等</li>
</ul>
<p>这一切发生在<strong>运行时</strong>，且完全由 Python 解释器执行。</p>
<hr/>
<h3 data-id="heading-2">二、Lombok：Java 的编译期魔法</h3>
<p>在 Java 中，一个简单的 POJO（Plain Old Java Object）往往充斥着冗长的 getter/setter、构造函数和 <code>toString()</code> 方法。Lombok 通过注解在<strong>编译期</strong>自动注入这些代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;

<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span> {
    <span class="hljs-keyword">private</span> Long conversationId;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">role</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> <span class="hljs-string">""</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">createdAt</span> <span class="hljs-operator">=</span> LocalDateTime.now();
}
</code></pre>
<p><code>@Data</code> 注解会触发 Lombok 的注解处理器，在编译阶段生成完整的字节码，包括：</p>
<ul>
<li>全参构造函数</li>
<li>所有字段的 getter/setter</li>
<li><code>toString()</code>, <code>equals()</code>, <code>hashCode()</code></li>
</ul>
<p>开发者看到的是简洁的源码，但 JVM 执行的是“膨胀后”的完整类。</p>
<hr/>
<h3 data-id="heading-3">三、核心对比：装饰器 vs 注解</h3>
<p>虽然 <code>@dataclass</code> 和 <code>@Data</code> 都用 <code>@</code> 符号，但它们属于完全不同的范式：</p>



































<table><thead><tr><th>维度</th><th>Python 装饰器（如 <code>@dataclass</code>）</th><th>Java 注解（如 <code>@Data</code>）</th></tr></thead><tbody><tr><td><strong>本质</strong></td><td>可执行的函数或类</td><td>元数据（标签），本身无行为</td></tr><tr><td><strong>执行时机</strong></td><td><strong>运行时</strong>（定义类时立即执行）</td><td><strong>编译期</strong>（由注解处理器处理）</td></tr><tr><td><strong>是否修改原对象</strong></td><td>✅ 直接返回新类或包装原函数</td><td>❌ 注解本身不修改代码，需外部工具介入</td></tr><tr><td><strong>依赖机制</strong></td><td>Python 动态特性 + 高阶函数</td><td>Java 编译插件（如 Lombok）或反射框架（如 Spring）</td></tr><tr><td><strong>调试可见性</strong></td><td>生成的代码可通过 <code>inspect</code> 查看</td><td>生成的字节码对开发者透明，IDE 需特殊支持</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>关键洞见</strong>：<br/>
Python 装饰器是<strong>主动的代码变换</strong>，而 Java 注解是<strong>被动的标记</strong>，必须依赖外部系统赋予其意义。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">四、语言哲学的体现</h3>
<p>这种差异反映了两种语言的核心设计思想：</p>
<ul>
<li><strong>Python 强调“显式优于隐式”但拥抱运行时灵活性</strong><br/>
装饰器是普通函数，你可以自己写一个 <code>@my_dataclass</code>，甚至动态决定是否应用它。一切行为都可追踪、可调试。</li>
<li><strong>Java 追求编译期安全与静态确定性</strong><br/>
注解不改变运行时语义，所有“魔法”必须在编译期完成，确保字节码符合 JVM 规范，避免运行时意外。</li>
</ul>
<p>这也解释了为何 Lombok 需要 IDE 插件支持（否则 IDE 看不到生成的方法），而 <code>@dataclass</code> 在任何 Python 环境中都能无缝工作。</p>
<hr/>
<h3 data-id="heading-5">五、实际影响与选择建议</h3>

























<table><thead><tr><th>场景</th><th>推荐方案</th></tr></thead><tbody><tr><td>快速定义数据容器（脚本、原型）</td><td>Python <code>@dataclass</code> —— 开箱即用，无需依赖</td></tr><tr><td>企业级 Java 应用（Spring Boot）</td><td>Lombok —— 与生态深度集成，提升生产力</td></tr><tr><td>需要精细控制生成逻辑</td><td>Python 更灵活（可自定义 <code>__post_init__</code> 或继承 <code>dataclass</code>）</td></tr><tr><td>追求编译期错误检查</td><td>Java + Lombok 更安全（类型错误在编译时报出）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">结语</h3>
<p><code>@dataclass</code> 和 Lombok 是各自语言生态对“减少样板代码”这一共同需求的精彩回应。它们看似殊途同归，实则根植于截然不同的语言哲学：</p>
<ul>
<li><strong>Python 用运行时动态性换取简洁与灵活</strong>，</li>
<li><strong>Java 用编译期确定性换取安全与性能</strong>。</li>
</ul>
<p>理解装饰器与注解的本质差异，不仅有助于正确使用这些工具，更能深入把握动态语言与静态语言在元编程上的根本分野。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拯救 import 杂乱无章：一次团队代码风格统一的实战记录]]></title>    <link>https://juejin.cn/post/7585778343351418943</link>    <guid>https://juejin.cn/post/7585778343351418943</guid>    <pubDate>2025-12-22T00:22:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585778343351418943" data-draft-id="7584357116434497577" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拯救 import 杂乱无章：一次团队代码风格统一的实战记录"/> <meta itemprop="keywords" content="ESLint,Vue.js,前端工程化"/> <meta itemprop="datePublished" content="2025-12-22T00:22:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zhEng"/> <meta itemprop="url" content="https://juejin.cn/user/4398498737560861"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拯救 import 杂乱无章：一次团队代码风格统一的实战记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4398498737560861/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zhEng
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:22:25.000Z" title="Mon Dec 22 2025 00:22:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="an-old-hope">.hljs-comment,.hljs-quote{color:#b6b18b}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#eb3c54}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#e7ce56}.hljs-attribute{color:#ee7c2b}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#4fb4d7}.hljs-section,.hljs-title{color:#78bb65}.hljs-keyword,.hljs-selector-tag{color:#b45ea4}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1d21;color:#c0c5ce}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.一次「看似很小，其实很烦」的问题</h2>
<p>事情是这样的，一天我在帮同事 <strong>rebase 分支</strong>，刚解决完一个冲突，又来一个冲突；<br/>
再一看冲突内容，我直接愣住了：</p>
<pre><code class="hljs language-js" lang="js">- <span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
- <span class="hljs-keyword">import</span> { getUserInfo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/user'</span>;
- <span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/Header.vue'</span>;

+ <span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/Header.vue'</span>;
+ <span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
+ <span class="hljs-keyword">import</span> { getUserInfo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/user'</span>;
</code></pre>
<p>逻辑没变，代码没变，<strong>只是 import 顺序不一样</strong>。</p>
<p>我当场沉默了 3 秒，然后心里冒出一句话：</p>
<blockquote>
<p>“这不是代码问题，这是人类问题。”</p>
</blockquote>
<p>在我们团队里：</p>
<ul>
<li>有人喜欢 <strong>先写业务，再慢慢补 import</strong></li>
<li>有人喜欢 <strong>外部库放最上面</strong></li>
<li>有人把 <code>@/components</code> 放最前</li>
<li>有人一股脑全丢进去，IDE 自动排序，爱咋咋地</li>
</ul>
<p>结果就是——  <strong>代码能跑，但 Git 天天冲突。</strong></p>
<h2 data-id="heading-1">2.问题本质：import 顺序，真的是“个人习惯”吗？</h2>
<p>刚开始大家的态度是：“不就是 import 顺序吗？有必要搞这么复杂？”</p>
<p>但当你换个角度看：</p>
<ul>
<li>import 本身 <strong>没有逻辑依赖</strong></li>
<li>却直接影响：
<ul>
<li>Git diff</li>
<li>merge 冲突</li>
<li>code review 体验</li>
<li>新人阅读成本</li>
</ul>
</li>
</ul>
<p><strong>它本质上是一个团队规范问题，而不是个人喜好问题。</strong></p>
<p>所以我的目标很明确： 让 import 顺序“不可争论”，而不是“约定俗成”。</p>
<h2 data-id="heading-2">3. 解决方案：eslint-plugin-import</h2>
<p>我选择的第一个方案是： <strong>用 ESLint 强制约束 import 顺序。</strong></p>
<p>按照 <code>require()</code> / <code>import</code> 语句的顺序执行一个惯例将<code>groups</code>选项设置为以下分组时，顺序如下所示：</p>
<h3 data-id="heading-3">（1）常见分组说明👇 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fimport-js%2Feslint-plugin-import%2Fblob%2Fmain%2Fdocs%2Frules%2Forder.md" target="_blank" title="https://github.com/import-js/eslint-plugin-import/blob/main/docs/rules/order.md" ref="nofollow noopener noreferrer"> 配置文档 </a></h3>


















































<table><thead><tr><th>分组名</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><code>builtin</code></td><td>Node 内置模块</td><td><code>fs</code>、<code>path</code></td></tr><tr><td><code>external</code></td><td>外部依赖</td><td><code>vue</code>、<code>axios</code></td></tr><tr><td><code>internal</code></td><td>项目内部别名</td><td><code>@/utils</code></td></tr><tr><td><code>parent</code></td><td>父级目录</td><td><code>../utils</code></td></tr><tr><td><code>sibling</code></td><td>同级文件</td><td><code>./bar.vue</code></td></tr><tr><td><code>index</code></td><td>当前目录 index</td><td><code>./</code></td></tr><tr><td><code>object</code></td><td><code>import log = console.log</code></td><td/></tr><tr><td><code>type</code></td><td>TS 类型</td><td><code>import type { User }</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-4">（2）安装插件</h3>
<pre><code class="hljs language-js" lang="js">npm install eslint-plugin-<span class="hljs-keyword">import</span> -D
</code></pre>
<h3 data-id="heading-5">（3）引入插件</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// .eslintrc.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'import'</span>],
  <span class="hljs-attr">rules</span>: {
   <span class="hljs-string">'import/order'</span>: [
      <span class="hljs-string">'error'</span>,
      {
        <span class="hljs-attr">groups</span>: [
          <span class="hljs-string">'builtin'</span>,    <span class="hljs-comment">// Node 内置模块</span>
          <span class="hljs-string">'external'</span>,   <span class="hljs-comment">// 第三方库</span>
          <span class="hljs-string">'internal'</span>,   <span class="hljs-comment">// 项目内部（@/）</span>
          <span class="hljs-string">'parent'</span>,     <span class="hljs-comment">// 父级目录</span>
          <span class="hljs-string">'sibling'</span>,    <span class="hljs-comment">// 同级文件</span>
          <span class="hljs-string">'index'</span>,      <span class="hljs-comment">// 当前目录index文件</span>
          <span class="hljs-string">'object'</span>, 
          <span class="hljs-string">'type'</span>
        ],
        <span class="hljs-attr">pathGroups</span>: [
          {
            <span class="hljs-attr">pattern</span>: <span class="hljs-string">'vue'</span>,
            <span class="hljs-attr">group</span>: <span class="hljs-string">'external'</span>,
            <span class="hljs-attr">position</span>: <span class="hljs-string">'before'</span>,
          },
          {
            <span class="hljs-attr">pattern</span>: <span class="hljs-string">'@/api/**'</span>,
            <span class="hljs-attr">group</span>: <span class="hljs-string">'internal'</span>,
            <span class="hljs-attr">position</span>: <span class="hljs-string">'before'</span>,
          },
          {
            <span class="hljs-attr">pattern</span>: <span class="hljs-string">'@/assets/**'</span>,
            <span class="hljs-attr">group</span>: <span class="hljs-string">'internal'</span>,
            <span class="hljs-attr">position</span>: <span class="hljs-string">'before'</span>,
          },
          {
            <span class="hljs-attr">pattern</span>: <span class="hljs-string">'@/components/**'</span>,
            <span class="hljs-attr">group</span>: <span class="hljs-string">'internal'</span>,
            <span class="hljs-attr">position</span>: <span class="hljs-string">'before'</span>,
          },
          {
            <span class="hljs-attr">pattern</span>: <span class="hljs-string">'@/composables/**'</span>,
            <span class="hljs-attr">group</span>: <span class="hljs-string">'internal'</span>,
            <span class="hljs-attr">position</span>: <span class="hljs-string">'before'</span>,
          },
          {
            <span class="hljs-attr">pattern</span>: <span class="hljs-string">'@/constant'</span>,
            <span class="hljs-attr">group</span>: <span class="hljs-string">'internal'</span>,
            <span class="hljs-attr">position</span>: <span class="hljs-string">'before'</span>,
          },
          {
            <span class="hljs-attr">pattern</span>: <span class="hljs-string">'@/router/**'</span>,
            <span class="hljs-attr">group</span>: <span class="hljs-string">'internal'</span>,
            <span class="hljs-attr">position</span>: <span class="hljs-string">'before'</span>,
          },
          {
            <span class="hljs-attr">pattern</span>: <span class="hljs-string">'@/stores/**'</span>,
            <span class="hljs-attr">group</span>: <span class="hljs-string">'internal'</span>,
            <span class="hljs-attr">position</span>: <span class="hljs-string">'before'</span>,
          },
          {
            <span class="hljs-attr">pattern</span>: <span class="hljs-string">'@/utils/**'</span>,
            <span class="hljs-attr">group</span>: <span class="hljs-string">'internal'</span>,
            <span class="hljs-attr">position</span>: <span class="hljs-string">'before'</span>,
          },
          {
            <span class="hljs-attr">pattern</span>: <span class="hljs-string">'@/views/**'</span>,
            <span class="hljs-attr">group</span>: <span class="hljs-string">'internal'</span>,
            <span class="hljs-attr">position</span>: <span class="hljs-string">'before'</span>,
          },
        ],
        <span class="hljs-attr">pathGroupsExcludedImportTypes</span>: [<span class="hljs-string">'type'</span>],
        newlines-<span class="hljs-attr">between</span>: <span class="hljs-string">'always'</span>, 
        <span class="hljs-attr">alphabetize</span>: { 
            <span class="hljs-attr">order</span>: <span class="hljs-string">'asc'</span>, 
            <span class="hljs-attr">caseInsensitive</span>: <span class="hljs-literal">true</span>, 
        }
      }
    ],
  }
}
</code></pre>
<p><code>import/order</code> 这个规则，核心作用就一句话：<strong>不同“来源”的 import，必须按固定分组和顺序书写</strong></p>
<h3 data-id="heading-6">（4）这套规则会强制你写成这样</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> debounce <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash/debounce'</span>;
<span class="hljs-keyword">import</span> { getUserInfo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/user'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/Header.vue'</span>;
<span class="hljs-keyword">import</span> useUser <span class="hljs-keyword">from</span> <span class="hljs-string">'@/composables/useUser'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">YES_NO</span> } <span class="hljs-string">'./constant'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">BaseInfoForm</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./BaseInfoForm.vue'</span>;
</code></pre>
<p><strong>好处立刻显现：</strong></p>
<ul>
<li>所有人 import 顺序完全一致</li>
<li>Git 冲突明显减少</li>
<li>Code Review 不再盯着 import 找茬</li>
</ul>
<h2 data-id="heading-7">4. 我又发现了 eslint-plugin-simple-import-sort</h2>
<p>用了一段时间后，我又发现了另一个插件：<strong>eslint-plugin-simple-import-sort</strong></p>
<p>我第一反应是：“这玩意和 import/order 有啥区别？”</p>
<p>一句话总结：</p>
<blockquote>
<p><strong>它不讲“分组语义”，只讲“排序规则”，而且可以自动修复</strong></p>
</blockquote>
<p>特点非常鲜明：</p>
<ul>
<li>✅ 自动排序</li>
<li>✅ 规则更简单</li>
<li>❌ 语义不如 import/order 强</li>
</ul>
<h2 data-id="heading-8">（1） 安装 &amp; 使用</h2>
<pre><code class="hljs language-js" lang="js">npm install eslint-plugin-simple-<span class="hljs-keyword">import</span>-sort -D
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">plugins</span>: [<span class="hljs-string">'simple-import-sort'</span>],
<span class="hljs-attr">rules</span>: {
  <span class="hljs-string">'simple-import-sort/imports'</span>: <span class="hljs-string">'error'</span>,
  <span class="hljs-string">'simple-import-sort/exports'</span>: <span class="hljs-string">'error'</span>,
}
</code></pre>
<h2 data-id="heading-9">（2）自定义分组示例（实战）</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// .eslintrc.js </span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">rules</span>:{
    <span class="hljs-string">'simple-import-sort/imports'</span>: [
      <span class="hljs-string">'error'</span>,
      {
        <span class="hljs-attr">groups</span>: [
          <span class="hljs-comment">// 1. Node 内置</span>
          [<span class="hljs-string">'^node:'</span>],
          <span class="hljs-comment">// 2. 第三方库</span>
          [<span class="hljs-string">'^vue'</span>, <span class="hljs-string">'^@?\w'</span>],
          <span class="hljs-comment">// 3. 内部模块</span>
          [<span class="hljs-string">'^@/components'</span>],
          [<span class="hljs-string">'^@/composables'</span>],
          [<span class="hljs-string">'^@/utils'</span>],
          [<span class="hljs-string">'^@/api'</span>],
          [<span class="hljs-string">'^@/store'</span>],
          [<span class="hljs-string">'^@/router'</span>],
          [<span class="hljs-string">'^@/views'</span>],
          <span class="hljs-comment">// 4. 相对路径</span>
          [<span class="hljs-string">'^\.'</span>],
        ],
      }
    ]
  }  
}

</code></pre>
<p>它会直接帮你 <strong>自动修复成统一顺序</strong>。</p>
<h2 data-id="heading-10">5.后来发生了什么？</h2>
<p>这套规则上线后，有同事在群里说了一句：</p>
<blockquote>
<p>“我终于不用再因为 import 冲突 rebase 半小时了。”</p>
</blockquote>
<p>那一刻我意识到：<strong>真正的价值，不是炫技，而是让所有人更轻松。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ArkTS Text 文本组件详细指南]]></title>    <link>https://juejin.cn/post/7586481379589357587</link>    <guid>https://juejin.cn/post/7586481379589357587</guid>    <pubDate>2025-12-22T01:30:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586481379589357587" data-draft-id="7585866811716616219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ArkTS Text 文本组件详细指南"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-22T01:30:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aa690"/> <meta itemprop="url" content="https://juejin.cn/user/737148068181168"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ArkTS Text 文本组件详细指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/737148068181168/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aa690
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T01:30:21.000Z" title="Mon Dec 22 2025 01:30:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ArkTS Text 文本组件详细指南</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fa789ffb65f8b4075b5e865eef38ee921%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/a789ffb65f8b4075b5e865eef38ee921?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙第四期开发者活动</a></p>
<blockquote>
<p>在任何界面里，最常见、最基础的组件就是 <strong>文本（Text）</strong> 。它看起来简单，但掌握好它的属性、样式、换行、截断等行为，会让你的页面更规范、显示更稳定。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、Text 是什么？</h3>
<p>在 HarmonyOS ArkTS 的声明式 UI 框架里，<strong>Text</strong> 是一个基础组件，用于在界面上显示一段文本内容。它不是简单的字符串，而是一个可以被样式化、布局控制、事件绑定的 UI 组件。<a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FHarmonyOS%3Futm_source%3Dchatgpt.com" target="_blank" title="https://en.wikipedia.org/wiki/HarmonyOS?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">维基百科</a></p>
<p>在 ArkUI 里和 Row、Column、Image 一样，Text 是最基本的可渲染组件之一。</p>
<pre><code class="hljs language-scss" lang="scss"> Text('Hello World')
   <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">18</span>)
   <span class="hljs-selector-class">.fontColor</span>(Color.Black)
</code></pre>
<hr/>
<h3 data-id="heading-2">二、为什么 Text 很重要？</h3>
<p>你做任何 UI 页面，文本几乎无处不在：</p>
<ul>
<li>标题</li>
<li>副标题</li>
<li>按钮标签</li>
<li>错误提示</li>
<li>价格、计数、时间</li>
<li>富文本段落</li>
</ul>
<p>因此理解 Text 的属性与表现，是构建优雅 UI 的起点。</p>
<hr/>
<h3 data-id="heading-3">三、Text 的常用属性（逐条解释）</h3>
<blockquote>
<p>下面每个属性我都配了“为什么要用”和“常见写法”。</p>
</blockquote>
<h4 data-id="heading-4">1. <code>.fontSize(size)</code></h4>
<p>设置字体大小（统一单位 vp 或数字）。</p>
<blockquote>
<p>小标题、正文、细节文字常用不同尺寸规范。</p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"> Text('标题')
   <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">20</span>)
 ​
 Text('正文')
   <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)
</code></pre>
<hr/>
<h4 data-id="heading-5">2. <code>.fontColor(color)</code></h4>
<p>控制文本颜色，大多数时候用设计稿给定的色值。</p>
<pre><code class="hljs language-scss" lang="scss"> Text('错误提示')
   <span class="hljs-selector-class">.fontColor</span>(<span class="hljs-number">0</span>xFFFF3B30)  <span class="hljs-comment">// red 错误色</span>
</code></pre>
<hr/>
<h4 data-id="heading-6">3. <code>.fontWeight(weight)</code></h4>
<p>控制字体粗细，对比更明显、更易读。</p>
<pre><code class="hljs language-scss" lang="scss"> Text('加粗标题')
   <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
</code></pre>
<hr/>
<h4 data-id="heading-7">4. <code>.maxLines(n) 和 .textOverflow(...)</code></h4>
<p>当文本可能很长时，你可以控制：</p>
<ul>
<li>最多显示几行</li>
<li>超过行数时如何显示（省略号/截断）</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"> Text('很长的描述内容...')
   <span class="hljs-selector-class">.maxLines</span>(<span class="hljs-number">2</span>)
   <span class="hljs-selector-class">.textOverflow</span>({ overflow: TextOverflow.Ellipsis })
</code></pre>
<blockquote>
<p>这在卡片标题、段落摘要场景里非常常见。</p>
</blockquote>
<hr/>
<h4 data-id="heading-8">5. <code>.textAlign(...)</code></h4>
<p>控制<strong>水平对齐方式</strong>，常见的值有：</p>
<ul>
<li><code>TextAlign.Start</code>（靠左）</li>
<li><code>TextAlign.Center</code>（居中）</li>
<li><code>TextAlign.End</code>（靠右）</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"> Text('居中标题')
   <span class="hljs-selector-class">.textAlign</span>(TextAlign.Center)
</code></pre>
<hr/>
<h4 data-id="heading-9">6. 字体系列、装饰等（可选）</h4>
<p>根据设计需求，你可能会用到：</p>
<ul>
<li><code>fontStyle</code>（斜体）</li>
<li><code>textDecoration</code>（下划线/删除线）</li>
</ul>
<p>这些属性在视觉类界面、强调文字效果中非常有用。</p>
<hr/>
<h3 data-id="heading-10">四、Text 在布局里的行为</h3>
<p>ArkTS UI 是一个<strong>声明式组件体系</strong>，Text 会根据父容器的布局规则参与排布，比如：</p>
<h4 data-id="heading-11">Row 里：</h4>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-built_in">Row</span>({ space: <span class="hljs-number">10</span> }) {
   Text('左侧')
   Text('右侧')
 }
</code></pre>
<h4 data-id="heading-12">Column 里：</h4>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">6</span> }) {
   Text('第一行')
   Text('第二行')
 }
</code></pre>
<p>无论是 Row/Column/Flex/Stack，Text 都像一个“可布局的元素”去占用空间、对齐、伸缩。</p>
<hr/>
<h3 data-id="heading-13">五、常见细节问题与解决</h3>
<p>下面是我在开发中最常遇到、也最容易犯的小错误：</p>
<hr/>
<h4 data-id="heading-14">问题 1 — 字太长遮挡别的组件</h4>
<p>如果你没有设置 <code>maxLines</code>，长文本会<strong>占用太多空间</strong>，导致布局跑掉。</p>
<p><strong>解决办法：</strong></p>
<pre><code class="hljs language-scss" lang="scss"> Text(longText)
   <span class="hljs-selector-class">.maxLines</span>(<span class="hljs-number">2</span>)
   <span class="hljs-selector-class">.textOverflow</span>({ overflow: TextOverflow.Ellipsis })
</code></pre>
<hr/>
<h4 data-id="heading-15">问题 2 — 文本内容换行不对</h4>
<p>默认情况下，Text 会按单词/字符换行，但有时你希望更精确的行为：</p>
<ul>
<li>使用 <code>textAlign</code></li>
<li>或者放在 Flex/Column 里配合布局权重</li>
</ul>
<hr/>
<h4 data-id="heading-16">问题 3 — 颜色适配暗色模式</h4>
<p>在有“亮/暗模式”的界面里，文本颜色不要写固定黑色，而应该用主题色或变量。</p>
<hr/>
<h3 data-id="heading-17">六、进阶写法（项目里真用得上的）</h3>
<h4 data-id="heading-18">1. 富文本组合（图标与文字在一行）</h4>
<p>有时一行里既有图标又有文本，你不会用一个 Text 就搞定，这时配合 Row/Stack 可以写得很干净：</p>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-built_in">Row</span>({ space: <span class="hljs-number">6</span> }) {
   <span class="hljs-built_in">Image</span>($r('icon_info'))
     <span class="hljs-selector-class">.width</span>(<span class="hljs-number">18</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">18</span>)
   Text('提示信息')
     <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)
 }
</code></pre>
<hr/>
<h4 data-id="heading-19">2. 状态动态文本</h4>
<p>当文本内容和状态关联时，用状态变量驱动文本自动刷新：</p>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-attr">count</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
 ​
 <span class="hljs-title class_">Text</span>(<span class="hljs-string">`已选 <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.count}</span> 项`</span>)
</code></pre>
<hr/>
<h4 data-id="heading-20">3. 多语言文本</h4>
<p>在项目里要支持国际化，多数情况下你会用资源引用，而不是硬编码：</p>
<pre><code class="hljs language-bash" lang="bash"> Text(<span class="hljs-variable">$r</span>(<span class="hljs-string">'strings.hello'</span>))
</code></pre>
<hr/>
<h3 data-id="heading-21">七、实战示例：一个典型卡片标题与摘要</h3>
<p>这个结构在商品页/推荐页/文章页里极常见：</p>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">4</span> }) {
   Text('这是一个非常长的标题，可能会换行')
     <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)
     <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Medium)
     <span class="hljs-selector-class">.maxLines</span>(<span class="hljs-number">2</span>)
     <span class="hljs-selector-class">.textOverflow</span>({ overflow: TextOverflow.Ellipsis })
 ​
   Text('这是摘要/副标题，较小号字体')
     <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)
     <span class="hljs-selector-class">.fontColor</span>(<span class="hljs-number">0</span>xFF666666)
</code></pre>
<p>这种写法能保证：</p>
<ul>
<li>主标题最多两行</li>
<li>摘要始终一行</li>
</ul>
<p>在布局里弹性好、对齐规范。</p>
<hr/>
<h3 data-id="heading-22">八、总结与建议（项目里必读）</h3>
<p>✔ <strong>不管界面多复杂</strong>，Text 都是基础 ✔ <strong>控制行数 / 超出方式</strong> 是最重要的两个属性 ✔ <strong>结合布局（Row/Column/Flex）</strong> 使用能写出优雅结构 ✔ <strong>别直接写硬编码颜色/大小</strong>，用设计规范或主题更易维护</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS ArkTS Stack 实战：做一个“悬浮按钮 + 遮罩弹层 + 底部菜单”的完整小项目]]></title>    <link>https://juejin.cn/post/7585751355593097235</link>    <guid>https://juejin.cn/post/7585751355593097235</guid>    <pubDate>2025-12-22T01:31:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355593097235" data-draft-id="7585789195869274148" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS ArkTS Stack 实战：做一个“悬浮按钮 + 遮罩弹层 + 底部菜单”的完整小项目"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-22T01:31:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aa690"/> <meta itemprop="url" content="https://juejin.cn/user/737148068181168"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS ArkTS Stack 实战：做一个“悬浮按钮 + 遮罩弹层 + 底部菜单”的完整小项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/737148068181168/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aa690
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T01:31:21.000Z" title="Mon Dec 22 2025 01:31:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HarmonyOS ArkTS Stack 实战：做一个“悬浮按钮 + 遮罩弹层 + 底部菜单”的完整小项目</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fa789ffb65f8b4075b5e865eef38ee921%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/a789ffb65f8b4075b5e865eef38ee921?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙第四期开发者活动</a></p>
<p>你学 Stack 的时候，最容易卡在一句话： “Stack 就是叠在一起。”——听懂了，但真写页面时还是不知道怎么落地。</p>
<p>我这次直接用一个小项目把 Stack 的典型用法串起来：<strong>背景叠字、角标、悬浮按钮、遮罩、防穿透、底部弹出菜单</strong>，全都在一个页面里。你跑起来后，基本就能把 Stack 用顺手。</p>
<hr/>
<h3 data-id="heading-1">1）这个 Demo 最终长什么样</h3>
<p>页面结构大概是这样（你可以脑补成三层）：</p>
<ul>
<li><strong>第 1 层：页面内容</strong> 顶部封面图 + 渐变遮罩 + 标题；中间是“叠层卡片”</li>
<li><strong>第 2 层：遮罩</strong> 点击 FAB 后出现的半透明黑色遮罩，点一下就关闭</li>
<li><strong>第 3 层：弹层</strong> 一个底部弹出菜单（像很多 App 的“快捷操作”那种）</li>
</ul>
<p>右下角有个 <strong>悬浮按钮（FAB）</strong> ，永远浮在最上面。</p>
<hr/>
<h3 data-id="heading-2">2）为什么这个 Demo 一定要用 Stack？</h3>
<p>因为它同时包含了 Stack 的 3 种“高频真实用途”：</p>
<ol start="0">
<li><strong>背景 + 前景（叠字）</strong> 比如封面图上叠标题、叠渐变遮罩</li>
<li><strong>覆盖层（遮罩 / 弹窗 / 菜单）</strong> 这是 Stack 的老本行</li>
<li><strong>层级控制（zIndex）</strong> 不管你写得多漂亮，层级没控制好就是“按钮点不到 / 菜单被盖住”</li>
</ol>
<hr/>
<h3 data-id="heading-3">3）项目结构（建议这么放）</h3>
<pre><code class="hljs language-css" lang="css"> entry/<span class="hljs-attribute">src</span>/<span class="hljs-selector-tag">main</span>/ets/
   entryability/EntryAbility<span class="hljs-selector-class">.ets</span>
   pages/StackDemoPage<span class="hljs-selector-class">.ets</span>
   components/FabMenu<span class="hljs-selector-class">.ets</span>
   components/StackCards<span class="hljs-selector-class">.ets</span>
</code></pre>
<p>你也可以不拆文件，但拆开后更像真实项目： <strong>页面负责组合，组件负责细节。</strong></p>
<hr/>
<h3 data-id="heading-4">4）入口：EntryAbility.ets（确保能打开 StackDemoPage）</h3>
<p>你如果是默认工程，有可能已经在这里 loadContent 了。 只要确保打开的是 <code>pages/StackDemoPage</code> 就行。</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// entry/src/main/ets/entryability/EntryAbility.ets</span>
 <span class="hljs-keyword">import</span> <span class="hljs-title class_">UIAbility</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.app.ability.UIAbility'</span>;
 <span class="hljs-keyword">import</span> <span class="hljs-variable language_">window</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.window'</span>;
 ​
 <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {
   <span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-params">windowStage: <span class="hljs-variable language_">window</span>.WindowStage</span>) {
     windowStage.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'pages/StackDemoPage'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
       <span class="hljs-keyword">if</span> (err) {
         <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'loadContent failed: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err));
       }
     });
   }
 }
</code></pre>
<hr/>
<h3 data-id="heading-5">5）主页面：StackDemoPage.ets（核心就在这里）</h3>
<p>我习惯把页面写成一个“大 Stack”，原因很简单： <strong>我想把整个页面当成一个舞台</strong> —— 内容、遮罩、弹层、悬浮按钮都在一个舞台里叠起来。</p>
<h4 data-id="heading-6">主页面代码</h4>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// entry/src/main/ets/pages/StackDemoPage.ets</span>
 import { FabMenu } from '../components/FabMenu';
 import { StackCards } from '../components/StackCards';
 ​
 <span class="hljs-keyword">@Entry</span>
 <span class="hljs-keyword">@Component</span>
 struct StackDemoPage {
   <span class="hljs-keyword">@State</span> private <span class="hljs-attribute">menuOpen</span>: boolean = false;
 ​
   <span class="hljs-built_in">build</span>() {
     <span class="hljs-comment">// 整个页面：一个大 Stack 负责“叠图层”</span>
     <span class="hljs-built_in">Stack</span>({ alignContent: Alignment.TopStart }) {
 ​
       <span class="hljs-comment">// ========== A. 第 1 层：页面内容 ==========</span>
       <span class="hljs-built_in">Column</span>() {
         <span class="hljs-comment">// 顶部：封面图 + 渐变遮罩 + 标题（这块就是 Stack 的经典用法）</span>
         <span class="hljs-built_in">Stack</span>({ alignContent: Alignment.BottomStart }) {
           <span class="hljs-comment">// 1）封面图</span>
           <span class="hljs-built_in">Image</span>($r('app.media.icon'))
             <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
             <span class="hljs-selector-class">.height</span>(<span class="hljs-number">220</span>)
             <span class="hljs-selector-class">.objectFit</span>(ImageFit.Cover);
 ​
           <span class="hljs-comment">// 2）渐变遮罩（让白字在图上更清楚）</span>
           <span class="hljs-built_in">Rect</span>()
             <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
             <span class="hljs-selector-class">.height</span>(<span class="hljs-number">220</span>)
             <span class="hljs-selector-class">.fill</span>(Color.Transparent)
             <span class="hljs-selector-class">.linearGradient</span>({
               angle: <span class="hljs-number">180</span>,
               colors: [[<span class="hljs-number">0</span>x00000000, <span class="hljs-number">0.0</span>], [<span class="hljs-number">0</span>xAA000000, <span class="hljs-number">1.0</span>]]
             });
 ​
           <span class="hljs-comment">// 3）标题文字</span>
           <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">6</span> }) {
             Text('Stack 实战：浮层 + 菜单 + 徽标')
               <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">22</span>)
               <span class="hljs-selector-class">.fontColor</span>(Color.White)
               <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold);
             Text('点击右下角按钮，体验遮罩与弹出面板')
               <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)
               <span class="hljs-selector-class">.fontColor</span>(<span class="hljs-number">0</span>xE6FFFFFF);
           }
           <span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">16</span>, right: <span class="hljs-number">16</span>, bottom: <span class="hljs-number">16</span> });
         }
 ​
         <span class="hljs-comment">// 中间内容：叠层卡片</span>
         <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">14</span> }) {
           Text('层叠卡片示例')
             <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)
             <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Medium)
             <span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">16</span>, top: <span class="hljs-number">12</span> });
 ​
           <span class="hljs-built_in">StackCards</span>()
 ​
           Text('Stack 更像“图层容器”：背景、遮罩、角标、弹窗都靠它。')
             <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)
             <span class="hljs-selector-class">.fontColor</span>(<span class="hljs-number">0</span>x99000000)
             <span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">16</span>, right: <span class="hljs-number">16</span>, top: <span class="hljs-number">10</span> });
 ​
           <span class="hljs-comment">// 留一点底部空间，让 FAB 不挡内容</span>
           <span class="hljs-built_in">Blank</span>()<span class="hljs-selector-class">.height</span>(<span class="hljs-number">120</span>);
         }
         <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>');
       }
       <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
       <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
       <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFF5F6F8);
 ​
       <span class="hljs-comment">// ========== B. 第 2 层：遮罩（只在打开菜单时出现） ==========</span>
       if (this.menuOpen) {
         <span class="hljs-comment">// 遮罩一定要覆盖全屏，而且要能点击关闭</span>
         <span class="hljs-built_in">Rect</span>()
           <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
           <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
           <span class="hljs-selector-class">.fill</span>(<span class="hljs-number">0</span>x66000000)
           <span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.menuOpen</span> = false)
           <span class="hljs-selector-class">.zIndex</span>(<span class="hljs-number">10</span>);
       }
 ​
       <span class="hljs-comment">// ========== C. 第 3 层：底部弹出菜单 ==========</span>
       <span class="hljs-built_in">FabMenu</span>({
         open: this.menuOpen,
         onClose: () =&gt; (this.menuOpen = false),
         onAction: (name: string) =&gt; {
           console<span class="hljs-selector-class">.info</span>('action: ' + name);
           this<span class="hljs-selector-class">.menuOpen</span> = false;
         }
       })
         <span class="hljs-selector-class">.zIndex</span>(<span class="hljs-number">20</span>);
 ​
       <span class="hljs-comment">// ========== D. 永远在最上层：悬浮按钮（FAB） ==========</span>
       <span class="hljs-built_in">Stack</span>({ alignContent: Alignment.Center }) {
         <span class="hljs-comment">// 外圈：白底 + 阴影（看起来更“浮”）</span>
         Circle()
           <span class="hljs-selector-class">.width</span>(<span class="hljs-number">58</span>)
           <span class="hljs-selector-class">.height</span>(<span class="hljs-number">58</span>)
           <span class="hljs-selector-class">.fill</span>(<span class="hljs-number">0</span>xFFFFFFFF)
           <span class="hljs-selector-class">.shadow</span>({ radius: <span class="hljs-number">18</span>, color: <span class="hljs-number">0</span>x33000000, offsetX: <span class="hljs-number">0</span>, offsetY: <span class="hljs-number">6</span> });
 ​
         <span class="hljs-comment">// 内圈：主色</span>
         Circle()
           <span class="hljs-selector-class">.width</span>(<span class="hljs-number">50</span>)
           <span class="hljs-selector-class">.height</span>(<span class="hljs-number">50</span>)
           <span class="hljs-selector-class">.fill</span>(<span class="hljs-number">0</span>xFF1677FF);
 ​
         Text('+')
           <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">26</span>)
           <span class="hljs-selector-class">.fontColor</span>(Color.White)
           <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold);
       }
       <span class="hljs-comment">// position：把它钉到右下角附近</span>
       <span class="hljs-selector-class">.position</span>({ x: '<span class="hljs-number">82%</span>', y: '<span class="hljs-number">84%</span>' })
       <span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.menuOpen</span> = !this<span class="hljs-selector-class">.menuOpen</span>)
       <span class="hljs-selector-class">.zIndex</span>(<span class="hljs-number">30</span>);
     }
     <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>');
   }
 }
</code></pre>
<hr/>
<h3 data-id="heading-7">6）叠层卡片：StackCards.ets（用 translate + zIndex 做“层次感”）</h3>
<p>这一块我想表达的是： Stack 不只是“盖住”，它还能做<strong>视觉层次</strong>（卡片叠层、影子叠层）。</p>
<p>写法要点：</p>
<ul>
<li><strong>底层卡</strong>：略往下偏移一点</li>
<li><strong>中间卡</strong>：再往上一点</li>
<li><strong>顶层卡</strong>：最完整，还带一个角标（角标就是 Stack 叠出来的）</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// entry/src/main/ets/components/StackCards.ets</span>
 <span class="hljs-keyword">@Component</span>
 export struct StackCards {
   <span class="hljs-built_in">build</span>() {
     <span class="hljs-built_in">Stack</span>({ alignContent: Alignment.Center }) {
 ​
       this<span class="hljs-selector-class">.card</span>('基础层：背景卡片', <span class="hljs-number">0</span>xFFE9EEF7)
         <span class="hljs-selector-class">.translate</span>({ x: <span class="hljs-number">0</span>, y: <span class="hljs-number">14</span> })
         <span class="hljs-selector-class">.zIndex</span>(<span class="hljs-number">1</span>);
 ​
       this<span class="hljs-selector-class">.card</span>('中间层：信息卡片', <span class="hljs-number">0</span>xFFFFFFFF)
         <span class="hljs-selector-class">.translate</span>({ x: <span class="hljs-number">0</span>, y: <span class="hljs-number">6</span> })
         <span class="hljs-selector-class">.zIndex</span>(<span class="hljs-number">2</span>);
 ​
       <span class="hljs-comment">// 顶层卡：再套一层 Stack 用来叠角标</span>
       <span class="hljs-built_in">Stack</span>({ alignContent: Alignment.TopEnd }) {
         this<span class="hljs-selector-class">.card</span>('顶层：带角标 / 徽标', <span class="hljs-number">0</span>xFFFFFFFF);
 ​
         <span class="hljs-built_in">Row</span>({ space: <span class="hljs-number">6</span> }) {
           Circle()<span class="hljs-selector-class">.width</span>(<span class="hljs-number">8</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">8</span>)<span class="hljs-selector-class">.fill</span>(<span class="hljs-number">0</span>xFFFF3B30);
           Text('NEW')
             <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">12</span>)
             <span class="hljs-selector-class">.fontColor</span>(Color.White)
             <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Medium);
         }
         <span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">10</span>, right: <span class="hljs-number">10</span>, top: <span class="hljs-number">6</span>, bottom: <span class="hljs-number">6</span> })
         <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFFF3B30)
         <span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">999</span>)
         <span class="hljs-selector-class">.margin</span>({ top: <span class="hljs-number">10</span>, right: <span class="hljs-number">10</span> });
       }
       <span class="hljs-selector-class">.zIndex</span>(<span class="hljs-number">3</span>);
     }
     <span class="hljs-selector-class">.height</span>(<span class="hljs-number">210</span>)
     <span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">16</span>, right: <span class="hljs-number">16</span> });
   }
 ​
   private <span class="hljs-built_in">card</span>(title: string, bg: number) {
     return <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">10</span> }) {
       Text(title)<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">15</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Medium);
       Text('这张卡片用 Stack 叠在其他卡片上，通过 translate 做出层次感。')
         <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">12</span>)
         <span class="hljs-selector-class">.fontColor</span>(<span class="hljs-number">0</span>x99000000)
         <span class="hljs-selector-class">.maxLines</span>(<span class="hljs-number">2</span>);
 ​
       <span class="hljs-built_in">Row</span>({ space: <span class="hljs-number">10</span> }) {
         this<span class="hljs-selector-class">.tag</span>('Stack');
         this<span class="hljs-selector-class">.tag</span>('zIndex');
         this<span class="hljs-selector-class">.tag</span>('translate');
       }
     }
     <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">16</span>)
     <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.height</span>(<span class="hljs-number">160</span>)
     <span class="hljs-selector-class">.backgroundColor</span>(bg)
     <span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">16</span>)
     <span class="hljs-selector-class">.shadow</span>({ radius: <span class="hljs-number">14</span>, color: <span class="hljs-number">0</span>x22000000, offsetX: <span class="hljs-number">0</span>, offsetY: <span class="hljs-number">6</span> });
   }
 ​
   private <span class="hljs-built_in">tag</span>(text: string) {
     return Text(text)
       <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">11</span>)
       <span class="hljs-selector-class">.fontColor</span>(<span class="hljs-number">0</span>xFF1677FF)
       <span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">10</span>, right: <span class="hljs-number">10</span>, top: <span class="hljs-number">4</span>, bottom: <span class="hljs-number">4</span> })
       <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFEAF2FF)
       <span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">999</span>);
   }
 }
</code></pre>
<hr/>
<h3 data-id="heading-8">7）底部弹出菜单：FabMenu.ets（弹层本质就是“在最上面叠一个面板”）</h3>
<p>这里我写得比较“项目味”一点：</p>
<ul>
<li>菜单是一个 Column 卡片</li>
<li>位置在底部（用 Stack 的 <code>Alignment.BottomCenter</code>）</li>
<li>每个菜单项都是 Row</li>
<li>点击菜单项回调给页面</li>
<li>点击“关闭”或点遮罩关闭</li>
</ul>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// entry/src/main/ets/components/FabMenu.ets</span>
 <span class="hljs-keyword">@Component</span>
 export struct FabMenu {
   open: boolean = false;
   onClose?: () =&gt; void;
   onAction?: (name: string) =&gt; void;
 ​
   <span class="hljs-built_in">build</span>() {
     <span class="hljs-built_in">Stack</span>({ alignContent: Alignment.BottomCenter }) {
       if (this.open) {
         <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">12</span> }) {
           <span class="hljs-built_in">Row</span>() {
             Text('快捷操作')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Medium);
             <span class="hljs-built_in">Blank</span>();
             Text('关闭')
               <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)
               <span class="hljs-selector-class">.fontColor</span>(<span class="hljs-number">0</span>xFF1677FF)
               <span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.onClose</span>?.());
           }
           <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>');
 ​
           this<span class="hljs-selector-class">.actionItem</span>('新建笔记', 'create_note');
           this<span class="hljs-selector-class">.actionItem</span>('扫描二维码', 'scan_qr');
           this<span class="hljs-selector-class">.actionItem</span>('分享当前页', 'share');
 ​
           <span class="hljs-built_in">Divider</span>()<span class="hljs-selector-class">.strokeWidth</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.color</span>(<span class="hljs-number">0</span>x11000000)<span class="hljs-selector-class">.margin</span>({ top: <span class="hljs-number">4</span>, bottom: <span class="hljs-number">2</span> });
 ​
           this<span class="hljs-selector-class">.actionItem</span>('设置', 'settings');
         }
         <span class="hljs-selector-class">.width</span>('<span class="hljs-number">92%</span>')
         <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">16</span>)
         <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFFFFFFF)
         <span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">18</span>)
         <span class="hljs-selector-class">.shadow</span>({ radius: <span class="hljs-number">24</span>, color: <span class="hljs-number">0</span>x22000000, offsetX: <span class="hljs-number">0</span>, offsetY: <span class="hljs-number">8</span> })
         <span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">18</span> });
       }
     }
     <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>');
   }
 ​
   private <span class="hljs-built_in">actionItem</span>(title: string, name: string) {
     return <span class="hljs-built_in">Row</span>({ space: <span class="hljs-number">12</span> }) {
       Circle()<span class="hljs-selector-class">.width</span>(<span class="hljs-number">34</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">34</span>)<span class="hljs-selector-class">.fill</span>(<span class="hljs-number">0</span>xFFEAF2FF);
       Text(title)<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>);
       <span class="hljs-built_in">Blank</span>();
       Text('&gt;')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)<span class="hljs-selector-class">.fontColor</span>(<span class="hljs-number">0</span>x66000000);
     }
     <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.padding</span>({ top: <span class="hljs-number">10</span>, bottom: <span class="hljs-number">10</span>, left: <span class="hljs-number">8</span>, right: <span class="hljs-number">8</span> })
     <span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">12</span>)
     <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFF8FAFF)
     <span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.onAction</span>?.(name));
   }
 }
</code></pre>
<hr/>
<h3 data-id="heading-9">8）我写 Stack 弹层时最在意的 3 个细节（很容易踩坑）</h3>
<h4 data-id="heading-10">① 层级要清楚：遮罩、弹层、FAB 谁在上？</h4>
<p>我一般会固定一个习惯：</p>
<ul>
<li>遮罩 <code>zIndex(10)</code></li>
<li>弹层 <code>zIndex(20)</code></li>
<li>FAB <code>zIndex(30)</code></li>
</ul>
<p>这样你永远不会遇到“按钮被盖住点不到”的问题。</p>
<h4 data-id="heading-11">② 遮罩要“吃掉点击”</h4>
<p>你不吃掉点击，用户点在遮罩上就会穿透点到下面页面（体验很糟）。 所以遮罩必须 <code>onClick(()=&gt;close)</code>。</p>
<h4 data-id="heading-12">③ 弹层不要写死位置太死</h4>
<p>我这里用 <code>BottomCenter + margin(bottom)</code>，比用绝对坐标稳一点。 你要做多设备适配时会省很多事。</p>
<hr/>
<h3 data-id="heading-13">9）你可以怎么把这个 Demo 改成你的项目组件</h3>
<ul>
<li>把 <code>FabMenu</code> 做成通用组件：传入 <code>items</code> 数组就能渲染菜单</li>
<li>把 FAB 的 <code>position</code> 改成“跟随屏幕尺寸计算”，适配更好</li>
<li>把弹层换成“半屏卡片 + 拖拽下滑关闭”（更像系统交互）</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS ArkTS 创建瀑布流 WaterFlow：从“能跑起来”到“真正在项目里好用”的写法]]></title>    <link>https://juejin.cn/post/7586481379589390355</link>    <guid>https://juejin.cn/post/7586481379589390355</guid>    <pubDate>2025-12-22T01:32:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586481379589390355" data-draft-id="7585751355593113619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS ArkTS 创建瀑布流 WaterFlow：从“能跑起来”到“真正在项目里好用”的写法"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T01:32:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aa690"/> <meta itemprop="url" content="https://juejin.cn/user/737148068181168"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS ArkTS 创建瀑布流 WaterFlow：从“能跑起来”到“真正在项目里好用”的写法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/737148068181168/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aa690
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T01:32:01.000Z" title="Mon Dec 22 2025 01:32:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HarmonyOS ArkTS 创建瀑布流 WaterFlow：从“能跑起来”到“真正在项目里好用”的写法</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fa789ffb65f8b4075b5e865eef38ee921%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/a789ffb65f8b4075b5e865eef38ee921?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙第四期开发者活动</a></p>
<blockquote>
<p>WaterFlow 适合那种 <strong>列宽相等、但每个卡片高度不一样</strong> 的场景：商品流、图片墙、内容推荐流……你要的不是“整齐”，而是“错落有致、空间利用率高”。官方文档明确 WaterFlow 用于构建瀑布流布局，并支持条件渲染、循环渲染、懒加载等方式生成子组件。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Farkts-layout-development-create-waterflow%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-layout-development-create-waterflow?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">developer.huawei.com+1</a></p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1）WaterFlow 的“脑内模型”先对齐</h3>
<p>WaterFlow = <strong>多列容器</strong>（列宽相等） + <strong>高度不等的卡片</strong>（自动往最短列里落）。</p>
<p>你写的时候，只需要抓住三点：</p>
<ol start="0">
<li><strong>WaterFlow 是容器</strong></li>
<li><strong>FlowItem 是每个卡片/单元</strong></li>
<li><strong>列数、间距、滚动事件</strong> 是你在项目里最常调的东西<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references%2Fts-container-waterflow%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">developer.huawei.com+1</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">2）最小可运行示例：两列瀑布流（先把骨架搭起来）</h3>
<blockquote>
<p>这段代码的目标很简单：两列、间距有、卡片高度不一样、能滚动。</p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-keyword">@Entry</span>
 <span class="hljs-keyword">@Component</span>
 struct WaterFlowBasicDemo {
   <span class="hljs-keyword">@State</span> private <span class="hljs-attribute">items</span>: number[] = Array.from({ length: <span class="hljs-number">40</span> }, (_, i) =&gt; <span class="hljs-selector-tag">i</span> + <span class="hljs-number">1</span>)
 ​
   <span class="hljs-built_in">build</span>() {
     <span class="hljs-built_in">WaterFlow</span>() {
       <span class="hljs-built_in">ForEach</span>(this.items, (n: number) =&gt; {
         <span class="hljs-built_in">FlowItem</span>() {
           <span class="hljs-comment">// 卡片内容：高度故意做成不一致，才能看到“瀑布”效果</span>
           <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">8</span> }) {
             <span class="hljs-comment">// 模拟封面</span>
             <span class="hljs-built_in">Rect</span>()
               <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
               <span class="hljs-selector-class">.height</span>(<span class="hljs-number">60</span> + (n % <span class="hljs-number">5</span>) * <span class="hljs-number">18</span>) <span class="hljs-comment">// 高度变化</span>
               <span class="hljs-selector-class">.fill</span>(<span class="hljs-number">0</span>xFFEAF2FF)
               <span class="hljs-selector-class">.radius</span>(<span class="hljs-number">12</span>)
 ​
             Text(`第 ${n} 个卡片`)
               <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)
               <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Medium)
 ​
             Text('这里放副标题/价格/标签都行')
               <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">12</span>)
               <span class="hljs-selector-class">.fontColor</span>(<span class="hljs-number">0</span>xFF888888)
           }
           <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">12</span>)
           <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFFFFFFF)
           <span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">12</span>)
         }
       }, (n: number) =&gt; `${n}`)
     }
     <span class="hljs-selector-class">.columnsTemplate</span>('<span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr') <span class="hljs-comment">// 两列</span>
     <span class="hljs-selector-class">.columnsGap</span>(<span class="hljs-number">10</span>)
     <span class="hljs-selector-class">.rowsGap</span>(<span class="hljs-number">10</span>)
     <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">12</span>)
     <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFF5F6F8)
     <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
   }
 }
</code></pre>
<blockquote>
<p><code>columnsTemplate / columnsGap / rowsGap</code> 这套写法在社区实践里也非常统一：WaterFlow + FlowItem，再配列模板与间距，基本就成型了。<a href="https://link.juejin.cn?target=https%3A%2F%2Fbbs.itying.com%2Ftopic%2F65b20a8f7cdd90002c2ecc39%3Futm_source%3Dchatgpt.com" target="_blank" title="https://bbs.itying.com/topic/65b20a8f7cdd90002c2ecc39?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">bbs.itying.com+1</a></p>
</blockquote>
<hr/>
<h3 data-id="heading-3">3）项目里最常见的需求：上拉加载更多（别等用户翻到底才尴尬）</h3>
<p>你做内容流，迟早会遇到“滚到底就继续请求下一页”。</p>
<p>WaterFlow 的 API 参考里提供了不少与滚动/布局相关的能力（比如分组混合列数布局等），实际项目里你最先用上的通常是“到达末尾触发加载”。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references%2Fts-container-waterflow%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">developer.huawei.com</a></p>
<p>下面给你一个<strong>实用写法</strong>：用一个状态控制 <code>isLoading</code>，并在触发时 append 数据。</p>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-keyword">@Entry</span>
 <span class="hljs-keyword">@Component</span>
 struct WaterFlowLoadMoreDemo {
   <span class="hljs-keyword">@State</span> private <span class="hljs-attribute">items</span>: number[] = Array.from({ length: <span class="hljs-number">30</span> }, (_, i) =&gt; <span class="hljs-selector-tag">i</span> + <span class="hljs-number">1</span>)
   <span class="hljs-keyword">@State</span> private <span class="hljs-attribute">isLoading</span>: boolean = false
 ​
   private async loadMore() {
     if (this.isLoading) return
     this<span class="hljs-selector-class">.isLoading</span> = true
 ​
     <span class="hljs-comment">// 模拟网络延迟</span>
     await new Promise&lt;void&gt;((r) =&gt; <span class="hljs-built_in">setTimeout</span>(() =&gt; <span class="hljs-built_in">r</span>(), <span class="hljs-number">700</span>))
 ​
     const start = this<span class="hljs-selector-class">.items</span><span class="hljs-selector-class">.length</span> + <span class="hljs-number">1</span>
     const more = Array<span class="hljs-selector-class">.from</span>({ length: <span class="hljs-number">20</span> }, (_, i) =&gt; start + <span class="hljs-selector-tag">i</span>)
     this<span class="hljs-selector-class">.items</span> = <span class="hljs-selector-attr">[...this.items, ...more]</span>
 ​
     this<span class="hljs-selector-class">.isLoading</span> = false
   }
 ​
   <span class="hljs-built_in">build</span>() {
     <span class="hljs-built_in">Column</span>() {
       <span class="hljs-comment">// 顶部筛选栏（真实项目很常见）</span>
       <span class="hljs-built_in">Row</span>({ space: <span class="hljs-number">10</span> }) {
         Text('推荐')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
         Text(this.isLoading ? '加载中…' : '正常')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">12</span>)<span class="hljs-selector-class">.fontColor</span>(<span class="hljs-number">0</span>xFF888888)
         <span class="hljs-built_in">Blank</span>()
       }
       <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">12</span>)
       <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFFFFFFF)
 ​
       <span class="hljs-built_in">WaterFlow</span>() {
         <span class="hljs-built_in">ForEach</span>(this.items, (n: number) =&gt; {
           <span class="hljs-built_in">FlowItem</span>() {
             <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">6</span> }) {
               <span class="hljs-built_in">Rect</span>()<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">70</span> + (n % <span class="hljs-number">6</span>) * <span class="hljs-number">14</span>)<span class="hljs-selector-class">.fill</span>(<span class="hljs-number">0</span>xFFEAF2FF)<span class="hljs-selector-class">.radius</span>(<span class="hljs-number">12</span>)
               Text(`卡片 #${n}`)<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)
             }
             <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">12</span>)
             <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFFFFFFF)
             <span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">12</span>)
           }
         }, (n: number) =&gt; `${n}`)
 ​
         <span class="hljs-comment">// 尾部 loading 占位（不做也行，但做了更像“真 App”）</span>
         <span class="hljs-built_in">FlowItem</span>() {
           <span class="hljs-built_in">Row</span>() {
             Text(this.isLoading ? '正在加载更多…' : '滑到底会自动加载')
               <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">12</span>)
               <span class="hljs-selector-class">.fontColor</span>(<span class="hljs-number">0</span>xFF999999)
             <span class="hljs-built_in">Blank</span>()
           }
           <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">12</span>)
         }
       }
       <span class="hljs-selector-class">.columnsTemplate</span>('<span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr')
       <span class="hljs-selector-class">.columnsGap</span>(<span class="hljs-number">10</span>)
       <span class="hljs-selector-class">.rowsGap</span>(<span class="hljs-number">10</span>)
       <span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">12</span>, right: <span class="hljs-number">12</span>, bottom: <span class="hljs-number">12</span> })
       <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFF5F6F8)
       <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
       <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
       <span class="hljs-comment">// 这里不同版本 WaterFlow 的末尾触发事件/命名可能有差异：</span>
       <span class="hljs-comment">// 你如果发现没有 onReachEnd，就去 API 参考页按“reach / end / scroll”关键词搜一下对应事件。</span>
       <span class="hljs-selector-class">.onReachEnd</span>(() =&gt; this<span class="hljs-selector-class">.loadMore</span>())
     }
     <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
   }
 }
</code></pre>
<blockquote>
<p>我特意把“筛选栏 + 流式内容 + 尾部提示”放进来，因为这就是你做推荐流/商品流时最像项目的一套结构。WaterFlow 在“列表/网格概述”里也被定位为这种错列布局的典型选择。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Farkts-list-grid-development-overview%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-list-grid-development-overview?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">developer.huawei.com+1</a></p>
</blockquote>
<hr/>
<h3 data-id="heading-4">4）别忽略这一点：WaterFlow 不是 Grid，它解决的是“高度不一致”</h3>
<p>很多人第一次写瀑布流会纠结： “我用 Grid 也能两列啊，为啥还要 WaterFlow？”</p>
<p>关键差异在于：</p>
<ul>
<li><strong>Grid</strong> 更像“表格”：行列规整，卡片高度最好差不多</li>
<li><strong>WaterFlow</strong> 是“错列排布”：卡片高度不等也能自然填满空隙<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Farkts-list-grid-development-overview%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-list-grid-development-overview?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">developer.huawei.com+1</a></li>
</ul>
<p>你做商品图（高矮不同）、图文卡（内容长短不同），WaterFlow 才是那个“不别扭”的选择。</p>
<hr/>
<h3 data-id="heading-5">5）进阶：同一个瀑布流里“不同分组用不同列数”（你真写电商会用到）</h3>
<p>比如：</p>
<ul>
<li>顶部“活动入口”用 4 列小图标</li>
<li>下面商品流用 2 列卡片</li>
<li>再下面“猜你喜欢”用 3 列小卡片</li>
</ul>
<p>WaterFlow 的 API 参考里提到：可以通过 <strong>FlowItem 分组</strong>实现“同一个瀑布流内部各分组使用不同列数的混合布局”，并且这种模式会忽略 <code>columnsTemplate/rowsTemplate</code>。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references%2Fts-container-waterflow%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">developer.huawei.com</a></p>
<blockquote>
<p>这块我建议你等你真的要做“一个页面混多种网格密度”时再上，不然一开始就写混合分组，调试成本会明显增加。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">6）我写 WaterFlow 时的“稳妥习惯”（少踩坑）</h3>
<ul>
<li><strong>给 ForEach 一个稳定 key</strong>：刷新/分页时不容易整片抖动</li>
<li><strong>卡片容器 width('100%') + padding</strong>：不然视觉会忽大忽小</li>
<li><strong>间距一定要显式设置</strong>：<code>columnsGap/rowsGap</code> 不写默认会挤</li>
<li><strong>先用 ForEach 跑通，再换 LazyForEach</strong>：数据量大了再优化更顺（WaterFlow 官方也强调支持懒加载思路）<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Farkts-layout-development-create-waterflow%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-layout-development-create-waterflow?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">developer.huawei.com+1</a></li>
</ul>
<hr/>
<h3 data-id="heading-7">7）你要是想把它变成“真正的项目模板”，我下一步可以直接给你</h3>
<p>给你做一个完整的小项目页（和你之前要的“实战示例项目”同风格）：</p>
<ul>
<li>顶部：筛选/排序（推荐 / 销量 / 价格）</li>
<li>中间：WaterFlow 卡片（图片、标题、标签、价格）</li>
<li>底部：触底自动分页 + 骨架屏占位</li>
<li>点击卡片：进详情页（用 Navigation push）</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS ArkTS 创建网格 Grid/GridItem：写得顺、适配稳、滚动不卡的那套方法]]></title>    <link>https://juejin.cn/post/7585778343351648319</link>    <guid>https://juejin.cn/post/7585778343351648319</guid>    <pubDate>2025-12-22T01:32:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585778343351648319" data-draft-id="7585778343351615551" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS ArkTS 创建网格 Grid/GridItem：写得顺、适配稳、滚动不卡的那套方法"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-22T01:32:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aa690"/> <meta itemprop="url" content="https://juejin.cn/user/737148068181168"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS ArkTS 创建网格 Grid/GridItem：写得顺、适配稳、滚动不卡的那套方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/737148068181168/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aa690
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T01:32:51.000Z" title="Mon Dec 22 2025 01:32:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HarmonyOS ArkTS 创建网格 Grid/GridItem：写得顺、适配稳、滚动不卡的那套方法</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fa789ffb65f8b4075b5e865eef38ee921%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/a789ffb65f8b4075b5e865eef38ee921?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙第四期开发者活动</a></p>
<blockquote>
<p>网格布局（Grid）不是“Row/Column 的升级版”，它更像是你在做 <strong>九宫格、相册墙、商品卡片</strong> 时的“标准答案”：用“行 + 列”把容器切成一个个单元格，然后把内容放进去。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Farkts-layout-development-create-grid%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-layout-development-create-grid?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">developer.huawei.com+1</a></p>
</blockquote>
<p>这篇我按<strong>项目里真会遇到的顺序</strong>写：先把概念讲透，再给你三种最常见的写法（固定网格 / 可滚动网格 / 自适应网格），最后再讲几个一踩就痛的坑。</p>
<hr/>
<h3 data-id="heading-1">1）Grid 和 GridItem 到底是什么关系？</h3>
<ul>
<li><code>Grid()</code>：网格<strong>容器</strong>，负责“行列怎么分、间距多大、怎么滚动、怎么排列”。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references-V13%2Fts-container-grid-V13%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V13/ts-container-grid-V13?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">developer.huawei.com+1</a></li>
<li><code>GridItem()</code>：网格里的<strong>单元格项目</strong>，每一块内容都应该放在 GridItem 里。官方也强调 Grid 的子组件是 GridItem。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-references-V13%2Fts-container-grid-V13%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V13/ts-container-grid-V13?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">developer.huawei.com+1</a></li>
</ul>
<p>你可以把它理解成： <strong>Grid 负责“铺地砖”，GridItem 负责“在每块砖上放东西”。</strong></p>
<hr/>
<h3 data-id="heading-2">2）先把“网格怎么分”的思路掰直：rowsTemplate / columnsTemplate</h3>
<p>Grid 最核心的两句话就是：</p>
<ul>
<li><code>rowsTemplate(...)</code>：定义<strong>有几行</strong>，每一行占多少“比例”</li>
<li><code>columnsTemplate(...)</code>：定义<strong>有几列</strong>，每一列占多少“比例”<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2F13b290807720c010bc57f08276cee52bbbccab04%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-layout-development-create-grid.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/13b290807720c010bc57f08276cee52bbbccab04/zh-cn/application-dev/ui/arkts-layout-development-create-grid.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee+1</a></li>
</ul>
<p>它们的值通常是这样的字符串：</p>
<pre><code class="hljs language-arduino" lang="arduino"> .<span class="hljs-built_in">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr 1fr'</span>)
 .<span class="hljs-built_in">rowsTemplate</span>(<span class="hljs-string">'1fr 2fr'</span>)
</code></pre>
<p>这里的 <code>fr</code> 可以理解为“份数”（比例单位）：</p>
<ul>
<li><code>1fr 1fr 1fr</code> = 三列等分</li>
<li><code>1fr 2fr</code> = 两行，第二行高度是第一行的 2 倍<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2F13b290807720c010bc57f08276cee52bbbccab04%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-layout-development-create-grid.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/13b290807720c010bc57f08276cee52bbbccab04/zh-cn/application-dev/ui/arkts-layout-development-create-grid.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee+1</a></li>
</ul>
<h4 data-id="heading-3">行列间距：rowsGap / columnsGap</h4>
<ul>
<li><code>rowsGap(n)</code>：行与行之间的间距</li>
<li><code>columnsGap(n)</code>：列与列之间的间距<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2F13b290807720c010bc57f08276cee52bbbccab04%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-layout-development-create-grid.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/13b290807720c010bc57f08276cee52bbbccab04/zh-cn/application-dev/ui/arkts-layout-development-create-grid.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee+1</a></li>
</ul>
<hr/>
<h3 data-id="heading-4">3）最常用的三种网格写法（基本覆盖 80% 页面）</h3>
<h4 data-id="heading-5">A. 固定网格：行列都写死（最稳、最适合“九宫格/计算器/日历”）</h4>
<p>这种写法最“可控”：几行几列固定，布局结构一眼就能看懂。</p>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-keyword">@Entry</span>
 <span class="hljs-keyword">@Component</span>
 struct GridFixedDemo {
   <span class="hljs-built_in">build</span>() {
     <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">12</span> }) {
       Text('固定网格：<span class="hljs-number">2</span> 行 x <span class="hljs-number">3</span> 列')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Medium)
 ​
       <span class="hljs-attribute">Grid</span>() {
         <span class="hljs-built_in">ForEach</span>([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>], (n: number) =&gt; {
           <span class="hljs-built_in">GridItem</span>() {
             Text(`${n}`)
               <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
               <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
               <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">18</span>)
               <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
               <span class="hljs-selector-class">.textAlign</span>(TextAlign.Center)
               <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFFFFFFF)
               <span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">12</span>)
           }
         }, (n: number) =&gt; `${n}`)
       }
       <span class="hljs-selector-class">.rowsTemplate</span>('<span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr')
       <span class="hljs-selector-class">.columnsTemplate</span>('<span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr')
       <span class="hljs-selector-class">.rowsGap</span>(<span class="hljs-number">10</span>)
       <span class="hljs-selector-class">.columnsGap</span>(<span class="hljs-number">10</span>)
       <span class="hljs-selector-class">.height</span>(<span class="hljs-number">220</span>)
       <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
     }
     <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">12</span>)
     <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFF5F6F8)
     <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
   }
 }
</code></pre>
<blockquote>
<p>这种“行列都设置”的场景，结构固定、好设计、好测 UI。官方创建网格文档也主要围绕 rowsTemplate/columnsTemplate 来说明。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2F13b290807720c010bc57f08276cee52bbbccab04%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-layout-development-create-grid.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/13b290807720c010bc57f08276cee52bbbccab04/zh-cn/application-dev/ui/arkts-layout-development-create-grid.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee+1</a></p>
</blockquote>
<hr/>
<h4 data-id="heading-6">B. 可滚动网格：只设置一个模板，让 Grid 自己滚动（文件管理/商品流最常见）</h4>
<p>这个点很多人第一次会误会： <strong>Grid 并不是一定要自己套 Scroll。</strong> 当你“只设置一个维度模板”时，Grid 往往就能形成滚动网格（官方和社区都把这当成常用方案）。<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_41270181%2Farticle%2Fdetails%2F148625924%3Futm_source%3Dchatgpt.com" target="_blank" title="https://blog.csdn.net/qq_41270181/article/details/148625924?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">CSDN博客+1</a></p>
<h5 data-id="heading-7">竖向滚动网格（常用：只设置 columnsTemplate）</h5>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-keyword">@Entry</span>
 <span class="hljs-keyword">@Component</span>
 struct GridScrollVerticalDemo {
   <span class="hljs-keyword">@State</span> <span class="hljs-attribute">items</span>: number[] = Array.from({ length: <span class="hljs-number">60</span> }, (_, i) =&gt; <span class="hljs-selector-tag">i</span> + <span class="hljs-number">1</span>)
 ​
   <span class="hljs-built_in">build</span>() {
     <span class="hljs-attribute">Grid</span>() {
       <span class="hljs-built_in">ForEach</span>(this.items, (n: number) =&gt; {
         <span class="hljs-built_in">GridItem</span>() {
           <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">6</span> }) {
             <span class="hljs-comment">// 模拟“商品卡片”</span>
             <span class="hljs-built_in">Rect</span>()<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">70</span>)<span class="hljs-selector-class">.fill</span>(<span class="hljs-number">0</span>xFFEAF2FF)<span class="hljs-selector-class">.radius</span>(<span class="hljs-number">12</span>)
             Text(`商品 #${n}`)<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)
             Text('¥ <span class="hljs-number">99.00</span>')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">12</span>)<span class="hljs-selector-class">.fontColor</span>(<span class="hljs-number">0</span>xFF888888)
           }
           <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">10</span>)
           <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFFFFFFF)
           <span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">12</span>)
         }
       }, (n: number) =&gt; `${n}`)
     }
     <span class="hljs-selector-class">.columnsTemplate</span>('<span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr')   <span class="hljs-comment">// 两列</span>
     <span class="hljs-selector-class">.columnsGap</span>(<span class="hljs-number">10</span>)
     <span class="hljs-selector-class">.rowsGap</span>(<span class="hljs-number">10</span>)
     <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">12</span>)
     <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-number">0</span>xFFF5F6F8)
     <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
     <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
   }
 }
</code></pre>
<p>你会发现：项目多到超出屏幕后，Grid 会按列规则继续排，页面自然就变成“可滚动商品流”。</p>
<hr/>
<h4 data-id="heading-8">C. “看起来像自适应”的网格：优先用 Responsive Grid（GridRow/GridCol）</h4>
<p>如果你要做“跨设备适配”，例如：</p>
<ul>
<li>手机 2 列</li>
<li>平板 4 列</li>
<li>大屏 6 列</li>
</ul>
<p>这类更推荐使用 <strong>响应式网格系统 GridRow/GridCol</strong>（文档里把它归为 Responsive Grid Layout）。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fen%2Fdoc%2Fharmonyos-guides%2Farkts-layout-development-grid-layout%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/en/doc/harmonyos-guides/arkts-layout-development-grid-layout?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">developer.huawei.com+1</a></p>
<blockquote>
<p>你这次问的是 <code>Grid/GridItem</code> 的创建，我就先把原理讲透；如果你要做“断点适配”，我可以再给你一篇专门写 GridRow/GridCol 的“手机/平板一套代码适配”的实战模板。</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">4）GridItem 里到底放什么？（项目里最常见的 3 种卡片结构）</h3>
<p>你可以把 GridItem 当成一个“小容器”，里面爱怎么排怎么排：</p>
<ol start="0">
<li><strong>图片 + 标题 + 价格</strong>（电商卡片）</li>
<li><strong>图标 + 文案</strong>（九宫格入口）</li>
<li><strong>封面图 + 标签</strong>（相册/视频墙）</li>
</ol>
<p>关键是：<strong>GridItem 外面不用再套一堆布局容器去算宽高</strong>，网格的宽高由模板决定，你只要让子内容 <code>width('100%')</code>、卡片圆角、padding 做舒服就行。</p>
<hr/>
<h3 data-id="heading-10">5）性能和渲染：别等卡了才想起优化</h3>
<p>当你网格项很多（比如几百上千）时，建议关注两点：</p>
<h4 data-id="heading-11">① 优先考虑懒加载思路（LazyForEach）</h4>
<p>OpenHarmony 的文档里提到：GridItem 与 LazyForEach 配合时，子组件在 GridItem 创建时创建；而配合 ForEach/if 或父组件为 Grid 时，子组件在布局时创建。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2F7be2e47c073138318f0a1b96dfb5c79e3d4e5cd7%2Fzh-cn%2Fapplication-dev%2Freference%2Fapis-arkui%2Farkui-ts%2Fts-container-griditem.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/7be2e47c073138318f0a1b96dfb5c79e3d4e5cd7/zh-cn/application-dev/reference/apis-arkui/arkui-ts/ts-container-griditem.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee</a></p>
<p>简单说就是：</p>
<ul>
<li>数据量大：考虑 <strong>LazyForEach</strong>（减少一次性创建的压力）</li>
<li>数据量小：ForEach 足够</li>
</ul>
<h4 data-id="heading-12">② 让每个 item 有稳定 key</h4>
<p><code>ForEach(data, builder, keyFn)</code> 里的 <code>keyFn</code> 不要省： 稳定 key 能减少“刷新时整片重建”，滚动和更新都会更顺。</p>
<hr/>
<h3 data-id="heading-13">6）几个一踩就中招的坑（写 Grid 时很常见）</h3>
<h4 data-id="heading-14">坑 1：GridItem 不铺满格子</h4>
<p>很多人写 GridItem 只放 Text，结果格子看起来“空、挤、对不齐”。 经验做法是：<strong>卡片容器本身设 <code>width('100%')</code>、内容设 padding</strong>，视觉会稳。</p>
<h4 data-id="heading-15">坑 2：间距没设导致“挤成一坨”</h4>
<p><code>rowsGap / columnsGap</code> 不写默认就是 0，网格会贴得很紧。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2F13b290807720c010bc57f08276cee52bbbccab04%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-layout-development-create-grid.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/13b290807720c010bc57f08276cee52bbbccab04/zh-cn/application-dev/ui/arkts-layout-development-create-grid.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee+1</a></p>
<h4 data-id="heading-16">坑 3：把 Grid 当成万能布局</h4>
<p>Grid 很强，但它擅长的是“规则二维”。 像“一个卡片左图右文，下方再有按钮”的复杂自由布局，通常是 <strong>GridItem 内部用 Row/Column/Flex/Stack</strong> 组合，而不是用 Grid 去硬拼结构。</p>
<hr/>
<h3 data-id="heading-17">7）你可以直接拿去做博客的收尾总结</h3>
<ul>
<li>Grid/GridItem 适合“规则二维内容展示”：九宫格、卡片墙、相册、商品流。<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Farkts-layout-development-create-grid%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-layout-development-create-grid?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">developer.huawei.com+1</a></li>
<li><code>rowsTemplate/columnsTemplate</code> 决定“网格怎么分”，<code>rowsGap/columnsGap</code> 决定“网格舒不舒服”。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2F13b290807720c010bc57f08276cee52bbbccab04%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-layout-development-create-grid.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/13b290807720c010bc57f08276cee52bbbccab04/zh-cn/application-dev/ui/arkts-layout-development-create-grid.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee+1</a></li>
<li>数据量大时，关注稳定 key 和懒加载（LazyForEach），滚动体验差距非常明显。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2F7be2e47c073138318f0a1b96dfb5c79e3d4e5cd7%2Fzh-cn%2Fapplication-dev%2Freference%2Fapis-arkui%2Farkui-ts%2Fts-container-griditem.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/7be2e47c073138318f0a1b96dfb5c79e3d4e5cd7/zh-cn/application-dev/reference/apis-arkui/arkui-ts/ts-container-griditem.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端转战后端：JavaScript 与 Java 对照学习指南（第五篇 —— 面向对象：类、接口与多态）]]></title>    <link>https://juejin.cn/post/7585839411122470958</link>    <guid>https://juejin.cn/post/7585839411122470958</guid>    <pubDate>2025-12-22T00:48:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585839411122470958" data-draft-id="7585553799299252270" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端转战后端：JavaScript 与 Java 对照学习指南（第五篇 —— 面向对象：类、接口与多态）"/> <meta itemprop="keywords" content="前端,后端,Java"/> <meta itemprop="datePublished" content="2025-12-22T00:48:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="汤姆Tom"/> <meta itemprop="url" content="https://juejin.cn/user/4112607842680478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端转战后端：JavaScript 与 Java 对照学习指南（第五篇 —— 面向对象：类、接口与多态）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4112607842680478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    汤姆Tom
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:48:51.000Z" title="Mon Dec 22 2025 00:48:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.hljs-comment,.hljs-quote,.hljs-variable{color:green}.hljs-built_in,.hljs-keyword,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#00f}.hljs-addition,.hljs-attribute,.hljs-literal,.hljs-section,.hljs-string,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type{color:#a31515}.hljs-deletion,.hljs-meta,.hljs-selector-attr,.hljs-selector-pseudo{color:#2b91af}.hljs-doctag{color:grey}.hljs-attr{color:red}.hljs-bullet,.hljs-link,.hljs-symbol{color:#00b0e8}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在前几篇中，我们从 <code>int/String</code> 聊到了 <code>List/Map</code>，解决了数据的“存储”问题。现在，我们要解决代码的“组织”问题。</p>
<p>对于前端开发者，<code>class</code> 并不陌生。但 JavaScript 的类更像是一个<strong>灵活的模具</strong>（基于原型，随时可改），而 Java 的类则是一张<strong>严格的工程蓝图</strong>（编译期确定，不可篡改）。在后端开发中，类不仅仅是数据的集合，更是业务逻辑的载体、安全控制的关卡以及系统解耦的钥匙。</p>
<p>本篇将深入剖析 Java 面向对象（OOP）的核心，带你跨越从“写脚本”到“架构系统”的鸿沟。</p>
<hr/>
<h2 data-id="heading-1">1. 类的本质：动态 vs 静态</h2>
<h3 data-id="heading-2">1.1 字段（Field）的严格定义</h3>
<p>在 JS 中，我们习惯在 <code>constructor</code> 里直接挂载属性，甚至在对象实例化后随手添加属性。但在 Java 中，这是绝对禁止的。</p>
<p><strong>JavaScript (自由的灵魂):</strong></p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; <span class="hljs-comment">// 直接定义</span>
  }
}
<span class="hljs-keyword">const</span> u = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">'F2B'</span>);
u.<span class="hljs-property">age</span> = <span class="hljs-number">18</span>; <span class="hljs-comment">// 随时添加新属性，JS 觉得没问题</span>
</code></pre>
<p>Java (严谨的蓝图):</p>
<p>Java 必须在类级别显式声明所有字段。这不仅是为了类型安全，更是为了内存布局的确定性。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-comment">// 1. 必须先声明，才能使用</span>
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> Integer age;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        <span class="hljs-comment">// this.gender = "Male"; // ❌ 报错！类定义中没有 gender 字段</span>
    }
    
    <span class="hljs-comment">// ... getter and setter</span>
}
</code></pre>
<h3 data-id="heading-3">1.2 方法重载 (Overloading) —— JS 没有的特性</h3>
<p>这是前端同学最容易忽略的特性。在 JS 中，如果定义两个同名函数，后面的会覆盖前面的。但在 Java 中，<strong>只要参数列表不同（类型或数量不同），方法名可以相同</strong>。</p>
<p>这在后端非常常用，用于提供“默认参数”的效果（Java 不支持 <code>func(a=1)</code> 这种默认值语法，通常用重载实现）。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SearchService</span> {
    
    <span class="hljs-comment">// 场景1：只按名字搜</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">search</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">return</span> search(name, <span class="hljs-number">18</span>); <span class="hljs-comment">// 转发调用给全量方法，默认 age 18</span>
    }

    <span class="hljs-comment">// 场景2：按名字和年龄搜</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">search</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> minAge)</span> {
        <span class="hljs-comment">// 执行具体的数据库查询逻辑</span>
        <span class="hljs-keyword">return</span> db.find(name, minAge);
    }
}
</code></pre>
<blockquote>
<p><strong>核心差异：</strong> Java 是根据<strong>参数签名</strong>来区分方法的，而 JS 仅根据<strong>函数名</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">2. 封装：不仅仅是 private</h2>
<p>在后端开发中，封装（Encapsulation）不是为了“隐藏”，而是为了<strong>保护数据的一致性</strong>。</p>
<h3 data-id="heading-5">2.1 为什么要写烦人的 Getter/Setter？</h3>
<p>前端同学常问：“为什么不直接把变量设为 public？”</p>
<p>看这个例子：</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> balance; <span class="hljs-comment">// 余额私有化，禁止外部直接修改</span>

    <span class="hljs-comment">// 只提供存款方法，可以在这里加逻辑</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deposit</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
        <span class="hljs-keyword">if</span> (amount &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"存款金额必须大于0"</span>);
        }
        <span class="hljs-built_in">this</span>.balance += amount;
    }

    <span class="hljs-comment">// 只提供读取，不提供 setBalance，防止外部随意篡改余额</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> <span class="hljs-title function_">getBalance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> balance;
    }
}
</code></pre>
<p>如果 <code>balance</code> 是 public 的，任何代码都能写 <code>account.balance = -9999</code>，这将导致严重的业务事故。Java 的封装强制你通过方法来操作数据，从而在方法里构筑防线。</p>
<h3 data-id="heading-6">2.2 开发神器：Lombok</h3>
<p>为了解决 Java“样板代码”过多的问题（写一堆 getter/setter 手很累），后端开发标配插件 <strong>Lombok</strong>。</p>
<p><strong>实际开发中的写法：</strong></p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-meta">@Data</span> <span class="hljs-comment">// 一个注解，编译时自动生成 get、set、toString、equals、hashCode</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDTO</span> {
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-keyword">private</span> Integer age;
}
</code></pre>
<p><em>注：转战后端，请务必尽早学会配置 Lombok，它能让你的 Java 代码像 JS 一样简洁。</em></p>
<hr/>
<h2 data-id="heading-7">3. 继承的高级形态：抽象类 (Abstract Class)</h2>
<p>JS 的 extends 大家都懂，但 Java 有一个中间态——抽象类。</p>
<p>它位于“普通类”和“接口”之间。它不能被实例化，可以包含具体实现，也可以包含强制子类实现的“抽象方法”。</p>
<p>场景：电商支付系统</p>
<p>不管是支付宝、微信还是银联，支付流程（校验 -&gt; 扣款 -&gt; 记录日志）是相似的，只有“扣款”动作不同。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// 抽象父类：定义模板</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BasePayment</span> {
    
    <span class="hljs-comment">// 1. 公共逻辑：所有支付方式都一样的校验逻辑</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
        <span class="hljs-keyword">return</span> amount &gt; <span class="hljs-number">0</span>;
    }

    <span class="hljs-comment">// 2. 抽象方法：留给子类必须去实现的（JS没有这个强制约束）</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doDeduct</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span>;

    <span class="hljs-comment">// 3. 核心流程（模板方法模式）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pay</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
        <span class="hljs-keyword">if</span> (validate(amount)) {
            doDeduct(amount); <span class="hljs-comment">// 调用子类的具体实现</span>
            System.out.println(<span class="hljs-string">"支付日志已记录"</span>);
        }
    }
}

<span class="hljs-comment">// 具体子类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AliPay</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BasePayment</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doDeduct</span><span class="hljs-params">(<span class="hljs-type">double</span> amount)</span> {
        System.out.println(<span class="hljs-string">"调用支付宝API扣款: "</span> + amount);
    }
}
</code></pre>
<blockquote>
<p><strong>后端思维：</strong> 抽象类用于<strong>复用代码</strong>。如果你发现几个类有大量重复逻辑，就应该提取一个抽象父类。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">4. 接口 (Interface)：后端的“契约精神”</h2>
<p>这是 Java 最重要的概念，也是 TypeScript 极力模仿的对象。</p>
<p>在 Java 后端（特别是 Spring 框架）中，我们遵循**“面向接口编程”**。</p>
<h3 data-id="heading-9">4.1 接口 vs 抽象类</h3>
<ul>
<li><strong>抽象类</strong>：是 "is-a" 关系（它是某种东西）。如：猫是动物。</li>
<li><strong>接口</strong>：是 "can-do" 关系（它具备某种能力）。如：猫能跑（Runnable），车也能跑（Runnable）。</li>
</ul>
<h3 data-id="heading-10">4.2 实际业务场景：多态与解耦</h3>
<p>假设你需要把用户信息存起来，现在用 MySQL，以后可能换 Redis。</p>
<p><strong>定义接口（契约）：</strong></p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span>;
    User <span class="hljs-title function_">findById</span><span class="hljs-params">(String id)</span>;
}
</code></pre>
<p><strong>实现 A（MySQL版本）：</strong></p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySQLUserRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(User user)</span> {
        System.out.println(<span class="hljs-string">"写入 MySQL 表..."</span>);
    }
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>业务层调用（关键点）：</strong></p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-comment">// 这里声明的是接口类型，而不是具体的 MySQLUserRepository</span>
    <span class="hljs-keyword">private</span> UserRepository userRepo; 

    <span class="hljs-comment">// 构造函数注入实现类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserRepository repo)</span> {
        <span class="hljs-built_in">this</span>.userRepo = repo;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">register</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-comment">// 业务层完全不知道底层是 MySQL 还是 Redis，只知道 userRepo 能 save</span>
        userRepo.save(user); 
    }
}
</code></pre>
<p><strong>好处：</strong> 如果明天老板说换 MongoDB，你只需要写一个 <code>MongoUserRepository</code> 实现接口，然后在启动配置里改一下注入，<code>UserService</code> 的代码<strong>一行都不用动</strong>。这就是<strong>解耦</strong>。</p>
<hr/>
<h2 data-id="heading-11">5. 静态（Static）：属于类的领地</h2>
<p>在 JS 中，函数是一等公民，我们可以直接 export 一个函数。</p>
<p>但在 Java 中，一切皆对象。如果你想提供一个“工具函数”（不依赖具体对象状态），必须使用 static。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateUtils</span> {
    <span class="hljs-comment">// 静态常量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">FORMAT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"yyyy-MM-dd"</span>;

    <span class="hljs-comment">// 静态方法：通过 DateUtils.now() 直接调用，不需要 new DateUtils()</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">now</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> LocalDate.now().toString();
    }
}
</code></pre>
<p><strong>内存区别：</strong></p>
<ul>
<li><strong>实例变量（非Static）：</strong> <code>new</code> 一个对象，堆内存就分配一份。100个对象有100份 <code>name</code>。</li>
<li><strong>静态变量（Static）：</strong> 全局只有一份，属于类，所有对象共享。慎用可变静态变量，会引发线程安全问题！</li>
</ul>
<hr/>
<h2 data-id="heading-12">6. 总结与对照表</h2>















































<table><thead><tr><th><strong>特性</strong></th><th><strong>JavaScript (ES6+)</strong></th><th><strong>Java</strong></th><th><strong>后端应用场景</strong></th></tr></thead><tbody><tr><td><strong>属性定义</strong></td><td>动态，构造函数中赋值</td><td>静态，类体内显式声明</td><td>DTO、Entity 数据模型</td></tr><tr><td><strong>方法重载</strong></td><td>不支持 (后覆盖前)</td><td>支持 (看参数签名)</td><td>提供多种参数的查询接口</td></tr><tr><td><strong>访问修饰</strong></td><td><code>#</code>私有 (新), <code>_</code>约定</td><td><code>private/protected/public</code></td><td>保护核心业务数据不被污染</td></tr><tr><td><strong>抽象类</strong></td><td>无 (普通类模拟)</td><td><code>abstract class</code></td><td>提取公共业务逻辑 (模板模式)</td></tr><tr><td><strong>接口</strong></td><td>无 (TS 有 interface)</td><td><code>interface</code></td><td><strong>核心！</strong> Service层解耦，依赖倒置</td></tr><tr><td><strong>多态</strong></td><td>鸭子类型 (也就是动态类型)</td><td>严格基于继承/接口</td><td>插件化架构，策略模式</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从几何到路径：ArkUI 下的双层容器、缩放偏移与抛掷曲线设计]]></title>    <link>https://juejin.cn/post/7585751355593015315</link>    <guid>https://juejin.cn/post/7585751355593015315</guid>    <pubDate>2025-12-22T01:01:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355593015315" data-draft-id="7585789195869143076" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从几何到路径：ArkUI 下的双层容器、缩放偏移与抛掷曲线设计"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-22T01:01:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Archilect"/> <meta itemprop="url" content="https://juejin.cn/user/1505660538979515"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从几何到路径：ArkUI 下的双层容器、缩放偏移与抛掷曲线设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1505660538979515/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Archilect
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T01:01:48.000Z" title="Mon Dec 22 2025 01:01:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从几何到路径：ArkUI 下的双层容器、缩放偏移与抛掷曲线设计</h2>
<blockquote>
<p>关键词：ArkUI、ETS、布局几何、贝塞尔曲线、motionPath</p>
</blockquote>
<p><em>TL;DR：统一管理谁在动（Outer vs Inner）、用简单的缩放偏移公式修正终点，再用规则化的贝塞尔控制点生成 motionPath，空间问题就迎刃而解。</em></p>
<p>上一篇我们解决了「时间轴」问题：如何用 AnimationStepper 编排多阶段动效。<br/>
这篇我们聚焦在「空间」：<strong>弹窗到底从哪里飞出去、飞向哪里、为什么不会飞偏。</strong></p>
<p>在 ArkUI 这样的声明式 UI 框架里，动画的本质是对布局参数的连续修改。<br/>
要让动效既好看又稳定，就绕不开三个几何问题：</p>
<ul>
<li>弹窗的起点坐标如何确定（尤其是有双层容器时）？</li>
<li>缩放会带来视觉中心偏移，这个偏移要怎么算？</li>
<li>从起点到终点的抛掷路径，如何用简洁的贝塞尔曲线来表达？</li>
</ul>
<hr/>
<h3 data-id="heading-1">一、双层容器：OuterContainer &amp; InnerContent 的职责划分</h3>
<p>在很多弹窗实现中，我们会有两层容器：</p>
<ul>
<li><strong>OuterContainer</strong>：外层容器，负责屏幕占位和遮罩，可能填满整个窗口；</li>
<li><strong>InnerContent</strong>：内层容器，承载真正的弹窗内容（文本、图片、按钮等），可以在外层内部做对齐和间距。</li>
</ul>
<p>如果你把所有动画都直接作用在 OuterContainer 上，会遇到两个问题：</p>
<ul>
<li>当 OuterContainer 填满屏幕时，缩放/抛掷它相当于「整屏飞走」，体验很怪；</li>
<li>遮罩透明度变化和内容缩放/抛掷本质是两类行为，耦合在一个容器上很难精细控制。</li>
</ul>
<p>更合理的做法是：</p>
<ul>
<li><strong>当 OuterContainer 不填满屏幕时</strong>：直接把 OuterContainer 当作抛掷主体（既动内容，也动背景）；</li>
<li><strong>当 OuterContainer 填满屏幕时</strong>：OuterContainer 只做背景渐隐，真正参与缩放/抛掷的是 InnerContent。</li>
</ul>
<p>在动效引擎里，我们可以用一个简单的状态来表达这个决策：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 伪代码</span>
<span class="hljs-comment">// 1 表示抛掷 OuterContainer，2 表示抛掷 InnerContent</span>
<span class="hljs-attr">levelToMove</span>: <span class="hljs-number">1</span> | <span class="hljs-number">2</span> = popupLayout.<span class="hljs-property">fillWindow</span> ? <span class="hljs-number">2</span> : <span class="hljs-number">1</span>
</code></pre>
<p>之后所有关于「宽高」「起点坐标」「缩放偏移」「路径计算」的逻辑，都以 <code>levelToMove</code> 为分支条件：</p>
<ul>
<li><code>levelToMove == 1</code>：使用 OuterContainer 的宽高和起点；</li>
<li><code>levelToMove == 2</code>：使用 InnerContent 的宽高和起点。</li>
</ul>
<hr/>
<h3 data-id="heading-2">二、尺寸与定位：在多种对齐方式下找「真实起点」</h3>
<p>在 ArkUI 里，容器的尺寸和位置往往由以下因素共同决定：</p>
<ul>
<li>容器本身的 <code>width</code> / <code>height</code>；</li>
<li>是否填满父容器；</li>
<li>横向对齐（左/中/右或者依赖 left/right 边距）；</li>
<li>纵向对齐（上/中/下或者依赖 top/bottom 边距）；</li>
<li>系统 UI（状态栏、底部导航栏）占用的额外空间。</li>
</ul>
<p>一个通用的计算方式可以概括为（示例使用类似于源码中的「配置表」写法，代替大量 if/else）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 计算尺寸</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">computeContainerSize</span>(<span class="hljs-params">layout, windowSize</span>): { <span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>; <span class="hljs-attr">height</span>: <span class="hljs-built_in">number</span> } {
  <span class="hljs-keyword">const</span> fill = layout.<span class="hljs-property">fill</span> === <span class="hljs-number">1</span>
  <span class="hljs-keyword">const</span> width = fill ? windowSize.<span class="hljs-property">width</span> : <span class="hljs-title function_">toVp</span>(layout.<span class="hljs-property">width</span>)
  <span class="hljs-keyword">const</span> height = fill ? windowSize.<span class="hljs-property">height</span> : <span class="hljs-title function_">toVp</span>(layout.<span class="hljs-property">height</span>)
  <span class="hljs-keyword">return</span> { width, height }
}

<span class="hljs-comment">// 计算位置：用枚举 -&gt; 坐标的配置表减少分支</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">computeContainerPosition</span>(<span class="hljs-params">layout, size, windowSize, systemInsets</span>) {
  <span class="hljs-keyword">const</span> { width, height } = size

  <span class="hljs-keyword">const</span> margin = {
    <span class="hljs-string">''</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">top</span>: <span class="hljs-title function_">toVp</span>(layout.<span class="hljs-property">top</span>) + (layout.<span class="hljs-property">needStatusBarOffset</span> ? systemInsets.<span class="hljs-property">statusBar</span> : <span class="hljs-number">0</span>),
    <span class="hljs-attr">bottom</span>: windowSize.<span class="hljs-property">height</span> - height - <span class="hljs-title function_">toVp</span>(layout.<span class="hljs-property">bottom</span>) - (layout.<span class="hljs-property">needNavBarOffset</span> ? systemInsets.<span class="hljs-property">navBar</span> : <span class="hljs-number">0</span>),
    <span class="hljs-attr">left</span>: <span class="hljs-title function_">toVp</span>(layout.<span class="hljs-property">left</span>),
    <span class="hljs-attr">right</span>: windowSize.<span class="hljs-property">width</span> - width - <span class="hljs-title function_">toVp</span>(layout.<span class="hljs-property">right</span>),
  }

  <span class="hljs-keyword">const</span> <span class="hljs-attr">xByAlign</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>&gt; = {
    <span class="hljs-number">0</span>: margin[layout.<span class="hljs-property">leftOrRight</span> ?? <span class="hljs-string">''</span>],       <span class="hljs-comment">// 使用左右边距</span>
    <span class="hljs-number">1</span>: <span class="hljs-number">0</span>,                                      <span class="hljs-comment">// 左</span>
    <span class="hljs-number">2</span>: (windowSize.<span class="hljs-property">width</span> - width) / <span class="hljs-number">2</span>,         <span class="hljs-comment">// 中</span>
    <span class="hljs-number">3</span>: windowSize.<span class="hljs-property">width</span> - width,               <span class="hljs-comment">// 右</span>
  }

  <span class="hljs-keyword">const</span> <span class="hljs-attr">yByAlign</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">number</span>, <span class="hljs-built_in">number</span>&gt; = {
    <span class="hljs-number">0</span>: margin[layout.<span class="hljs-property">topOrBottom</span> ?? <span class="hljs-string">''</span>],       <span class="hljs-comment">// 使用上下边距</span>
    <span class="hljs-number">1</span>: <span class="hljs-number">0</span>,                                      <span class="hljs-comment">// 上</span>
    <span class="hljs-number">2</span>: (windowSize.<span class="hljs-property">height</span> - height) / <span class="hljs-number">2</span>,       <span class="hljs-comment">// 中</span>
    <span class="hljs-number">3</span>: windowSize.<span class="hljs-property">height</span> - height,             <span class="hljs-comment">// 下</span>
  }

  <span class="hljs-keyword">const</span> x = xByAlign[layout.<span class="hljs-property">horizontalAlign</span> ?? <span class="hljs-number">2</span>]  <span class="hljs-comment">// 默认居中</span>
  <span class="hljs-keyword">const</span> y = yByAlign[layout.<span class="hljs-property">verticalAlign</span> ?? <span class="hljs-number">2</span>]

  <span class="hljs-keyword">return</span> { x, y }
}
</code></pre>
<p>这里用 <code>xByAlign / yByAlign</code> 这类<strong>配置表</strong>代替 if/else，有几个好处：</p>
<ul>
<li>把「枚举值 → 坐标公式」集中在一处，阅读和调试都更直观；</li>
<li>新增对齐方式时，只需扩展映射表，而不必修改一堆条件分支；</li>
<li>默认值（例如 <code>?? 2</code> 表示居中）一目了然。</li>
</ul>
<p>对于 OuterContainer 和 InnerContent，我们分别调用 <code>computeContainerSize</code> / <code>computeContainerPosition</code>，得到：</p>
<ul>
<li><code>outerInitialX, outerInitialY</code>；</li>
<li><code>innerInitialX, innerInitialY</code>；</li>
<li><code>outerWidth, outerHeight</code>；</li>
<li><code>innerWidth, innerHeight</code>。</li>
</ul>
<p>这样一来，我们就有了两个候选起点坐标，后续只需根据 <code>levelToMove</code> 选一个即可。</p>
<blockquote>
<p>小建议：<br/>
在实现时可以把尺寸/位置计算封装在一个独立模块中，方便单独做单元测试，避免未来调整布局逻辑时不小心破坏动效。</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">三、缩放偏移：为什么缩小以后会「飞偏」？</h3>
<p>直觉上看，只要起点和终点坐标算对了，直接在路径上做 <code>scale</code> 就行了。<br/>
但实际跑起来你会发现：<strong>当组件从 1.0 缩小到 0.3 时，视觉上的中心会发生明显偏移。</strong></p>
<p>原因很简单：</p>
<ul>
<li>ArkUI 的缩放是绕组件中心点进行的；</li>
<li>组件真实占据的矩形左上角，在缩放后会向中心「收缩」；</li>
<li>如果你仍然用缩放前的终点坐标去画路径，视觉中心就会偏离你想要的位置。</li>
</ul>
<p>用二维图示意一下（简化）：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  A[未缩放矩形&lt;br/&gt;宽 W] --&gt; B[缩放后矩形&lt;br/&gt;宽 W * s]
  B --&gt; C[左上角向右移动 (1 - s) * W / 2]
</code></pre>
<blockquote>
<p>若平台不支持 mermaid，可复制到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid.live" target="_blank" title="https://mermaid.live" ref="nofollow noopener noreferrer">mermaid.live</a> 查看示意。</p>
</blockquote>
<p>因此，我们在计算终点坐标时，需要先算出缩放带来的偏移，然后反向「抵消」它。</p>
<p>一个简单的偏移函数可以写成：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">applyScaleOffset</span>(<span class="hljs-params">
  coordinate: <span class="hljs-built_in">number</span>,    <span class="hljs-comment">// 原本的起点或终点坐标（以左上角为基准）</span>
  size: <span class="hljs-built_in">number</span>,          <span class="hljs-comment">// 对应方向上的宽或高</span>
  scale: <span class="hljs-built_in">number</span>,         <span class="hljs-comment">// 最终缩放比例</span>
  isAdd: <span class="hljs-built_in">boolean</span>         <span class="hljs-comment">// 是加偏移还是减偏移</span>
</span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">const</span> offset = (<span class="hljs-number">1</span> - scale) * size / <span class="hljs-number">2</span>
  <span class="hljs-keyword">return</span> coordinate + (isAdd ? offset : -offset)
}
</code></pre>
<p>在抛掷路径的终点计算中，我们会这样用：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> innerSize = levelToMove === <span class="hljs-number">1</span>
  ? { <span class="hljs-attr">width</span>: outerWidth, <span class="hljs-attr">height</span>: outerHeight }
  : { <span class="hljs-attr">width</span>: innerWidth, <span class="hljs-attr">height</span>: innerHeight }

<span class="hljs-keyword">const</span> scaledTargetX = <span class="hljs-title function_">applyScaleOffset</span>(targetX, innerSize.<span class="hljs-property">width</span>, finalScale, <span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> scaledTargetY = <span class="hljs-title function_">applyScaleOffset</span>(targetY, innerSize.<span class="hljs-property">height</span>, finalScale, <span class="hljs-literal">false</span>)
</code></pre>
<p>含义是：</p>
<ul>
<li><code>targetX, targetY</code> 是「我们想让视觉中心落在的终点位置」（通常来自目标矩形中心）；</li>
<li><code>finalScale</code> 是抛掷结束时的缩放比例（例如 0.3）；</li>
<li>我们通过 <code>applyScaleOffset(..., false)</code> 把缩放带来的偏移扣除掉，从而保证视觉中心不会偏移。</li>
</ul>
<blockquote>
<p>建议：<br/>
这类纯数学函数非常适合写单元测试：给定宽高、缩放比例、起点/终点，验证缩放后视觉中心是否落在预期位置。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">四、抛掷路径：用一条三次贝塞尔曲线表达自然「抛物线感」</h3>
<p>起点和终点都有了，接下来要决定的是：<strong>中间的路径怎么走。</strong></p>
<p>在很多 UI 框架中，我们可以给组件指定一个 <code>motionPath</code>，常见形式是 SVG path，例如：</p>
<pre><code class="hljs language-text" lang="text">M x0,y0 C cx1,cy1 cx2,cy2 x1,y1
</code></pre>
<p>这是一条三次贝塞尔曲线：</p>
<ul>
<li>起点：((x_0, y_0))；</li>
<li>终点：((x_1, y_1))；</li>
<li>控制点：((c_{x1}, c_{y1}))、((c_{x2}, c_{y2}))。</li>
</ul>
<p>我们希望用<strong>尽量简单的规则</strong>，生成一条看起来既自然，又不需要微调一堆 magic number 的路径。</p>
<p>一种实用策略是：</p>
<ul>
<li>先算出起点和终点的中点 <code>midX, midY</code>；</li>
<li>再根据「终点在起点上方还是下方」，选择不同的控制点布局：
<ul>
<li>如果终点在下方：整体轨迹略向下吊；</li>
<li>如果终点在上方：整体轨迹略向上抛。</li>
</ul>
</li>
</ul>
<p>伪代码如下：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">buildThrowPath</span>(<span class="hljs-params">
  start: { x: <span class="hljs-built_in">number</span>; y: <span class="hljs-built_in">number</span> },
  end: { x: <span class="hljs-built_in">number</span>; y: <span class="hljs-built_in">number</span> },
</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> x0 = start.<span class="hljs-property">x</span>
  <span class="hljs-keyword">const</span> y0 = start.<span class="hljs-property">y</span>
  <span class="hljs-keyword">const</span> x1 = end.<span class="hljs-property">x</span>
  <span class="hljs-keyword">const</span> y1 = end.<span class="hljs-property">y</span>

  <span class="hljs-keyword">const</span> midX = (x0 + x1) / <span class="hljs-number">2</span>
  <span class="hljs-keyword">const</span> midY = (y0 + y1) / <span class="hljs-number">2</span>

  <span class="hljs-keyword">let</span> <span class="hljs-attr">cx1</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">cy1</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">cx2</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">cy2</span>: <span class="hljs-built_in">number</span>

  <span class="hljs-keyword">if</span> (y0 &lt; y1) {
    <span class="hljs-comment">// 终点在起点下方：路径整体略向下吊</span>
    cx1 = midX
    cy1 = y0
    cx2 = x1
    cy2 = midY
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 终点在起点上方：路径整体略向上抛</span>
    cx1 = x0
    cy1 = midY
    cx2 = midX
    cy2 = y1
  }

  <span class="hljs-keyword">return</span> <span class="hljs-string">`M<span class="hljs-subst">${x0}</span>,<span class="hljs-subst">${y0}</span> C<span class="hljs-subst">${cx1}</span>,<span class="hljs-subst">${cy1}</span> <span class="hljs-subst">${cx2}</span>,<span class="hljs-subst">${cy2}</span> <span class="hljs-subst">${x1}</span>,<span class="hljs-subst">${y1}</span>`</span>
}
</code></pre>
<p>mermaid 示意图（抽象）：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
  S((Start)) -- 控制点1 --&gt; C1((C1))
  S -- 控制点2 --&gt; C2((C2))
  C1 --&gt; E((End))
  C2 --&gt; E
</code></pre>
<blockquote>
<p>若平台不支持 mermaid，可复制到 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmermaid.live" target="_blank" title="https://mermaid.live" ref="nofollow noopener noreferrer">mermaid.live</a> 查看示意。</p>
</blockquote>
<p>这套算法的特点是：</p>
<ul>
<li><strong>参数少</strong>：无需调整复杂的角度或曲率参数，只关心「上抛」还是「下抛」；</li>
<li><strong>足够自然</strong>：通过中点和「靠近起点/靠近终点」的控制点布局，得到一个轻微弧线；</li>
<li><strong>易于调试</strong>：只要打印起点/终点/控制点，在 Canvas 上随便画几条线，就能很快看出问题。</li>
</ul>
<blockquote>
<p>实战小技巧：<br/>
可以在 Debug build 中，把路径相关的坐标都打出来，然后用一个简单的调试 Canvas 把路径画出来，肉眼验证轨迹是否符合预期。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">五、拖拽与动效协同：避免「瞬移然后再飞」</h3>
<p>如果弹窗支持拖拽（用户可以把弹窗拖到屏幕边缘再关闭），那么动效起点就不再是「初始布局位置」，而是「拖拽结束时的位置」。</p>
<p>一个常见坑是：<br/>
计算抛掷路径时仍然用初始坐标，结果就是：</p>
<ul>
<li>弹窗先瞬移回初始位置；</li>
<li>再从初始位置飞向终点。</li>
</ul>
<p>为避免这种「回弹式瞬移」，我们在构造 AttributeModifier（或类似装饰器）时，就把拖拽偏移量写回初始坐标：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">OuterContainerModifier</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> state: WhirlwindState, dragOffsetX: <span class="hljs-built_in">number</span>, dragOffsetY: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-comment">// 把拖拽最终偏移合并进起点坐标</span>
    state.<span class="hljs-property">outerInitialX</span> += dragOffsetX
    state.<span class="hljs-property">outerInitialY</span> += dragOffsetY
  }

  <span class="hljs-title function_">apply</span>(<span class="hljs-params">instance: ColumnAttribute</span>) {
    instance
      .<span class="hljs-title function_">position</span>({
        <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">outerInitialX</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">outerInitialY</span>,
      })
      <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<p>同时，在设置 motionPath 时，要注意在拖拽过程中禁用路径动画：</p>
<pre><code class="hljs language-ts" lang="ts">instance.<span class="hljs-title function_">motionPath</span>({
  <span class="hljs-attr">path</span>: isDragging ? <span class="hljs-literal">null</span> : (useCloseAnimation ? state.<span class="hljs-property">motionPath</span> : <span class="hljs-literal">null</span>)
})
</code></pre>
<p>这样可以确保：</p>
<ul>
<li>用户手动拖拽时，只影响 position，不触发路径动画；</li>
<li>用户松手并触发关闭时，抛掷路径的起点正是拖拽后的最终位置。</li>
</ul>
<hr/>
<h3 data-id="heading-6">六、窗口尺寸变化与旋转：让路径自动适配</h3>
<p>在 ArkUI 中，窗口大小和方向可能会变化（折叠屏、多窗口、横竖屏切换等）。<br/>
如果不做处理，这类导向式关闭动效非常容易出现：</p>
<ul>
<li>起点/终点偏离；</li>
<li>路径在新窗口尺寸下变形；</li>
<li>光圈尺寸与目标区域错位。</li>
</ul>
<p>一个稳妥的做法是：</p>
<ul>
<li>在窗口尺寸变化事件中，重新计算：
<ul>
<li>OuterContainer/InnerContent 的尺寸和起点；</li>
<li>终点矩形（如果坐标系受窗口影响）；</li>
<li>抛掷路径（基于新的起终点）。</li>
</ul>
</li>
<li>如果在动效过程中发生尺寸变化，可以选择：
<ul>
<li>直接取消当前动效，走兜底关闭；</li>
<li>或者在新尺寸下重新开始一个简化版关闭动效。</li>
</ul>
</li>
</ul>
<p>伪代码示意：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title function_">onWindowSizeChanged</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">recomputeContainerSizeAndPosition</span>()
  <span class="hljs-title function_">recomputeTargetAndPath</span>()
})
</code></pre>
<blockquote>
<p>经验：<br/>
对于不常见的旋转/分屏场景，与其硬撑一套复杂的动态适配逻辑，不如在动效引擎里加一层兜底：一旦检测到尺寸变化，就直接跳过动效，做普通关闭。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">七、小结</h3>
<p>这一篇我们从三个关键几何问题出发，构建了一个在 ArkUI 下可复用的动效「空间层」方案：</p>
<ul>
<li>用 <strong>双层容器</strong> 区分「谁在动」「谁在当背景」，通过 <code>levelToMove</code> 收敛复杂度；</li>
<li>用 <strong>缩放偏移修正</strong> 确保在任意缩放比例下，视觉中心依然命中目标位置；</li>
<li>用 <strong>三次贝塞尔路径</strong> + 简单控制点策略，生成既自然又易调试的抛掷轨迹；</li>
<li>同时兼顾 <strong>拖拽协同</strong> 和 <strong>窗口尺寸变化</strong>，避免起点错乱和奇怪的瞬移。</li>
</ul>
<p>在下一篇中，我们会把视角缩小到「终点」：<br/>
从一个目标矩形出发，算出 icon 的最终位置、光圈的大小与偏移，并讨论如何在 ArkUI 中优雅地管理 Lottie/Canvas 生命周期和异常兜底。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS ArkTS 从 Router 到 Navigation 的迁移指南]]></title>    <link>https://juejin.cn/post/7585778343351763007</link>    <guid>https://juejin.cn/post/7585778343351763007</guid>    <pubDate>2025-12-22T01:40:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585778343351763007" data-draft-id="7586481379589554195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS ArkTS 从 Router 到 Navigation 的迁移指南"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-22T01:40:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="aa690"/> <meta itemprop="url" content="https://juejin.cn/user/737148068181168"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS ArkTS 从 Router 到 Navigation 的迁移指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/737148068181168/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    aa690
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T01:40:35.000Z" title="Mon Dec 22 2025 01:40:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HarmonyOS ArkTS 从 <strong>Router</strong> 到 <strong>Navigation</strong> 的迁移指南</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2Fa789ffb65f8b4075b5e865eef38ee921%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/a789ffb65f8b4075b5e865eef38ee921?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙第四期开发者活动</a></p>
<blockquote>
<p>HarmonyOS 在 ArkTS/ArkUI 架构中逐步把传统的页面路由机制（<code>@ohos.router</code>）替换为更现代的组件导航机制 <strong>Navigation</strong>。本文详细讲解为什么要迁移、迁移的核心步骤、对照示例和最佳实践。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Farkts-router-to-navigation%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-router-to-navigation?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">华为开发者</a></p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、背景：为什么要从 Router 迁移到 Navigation</h3>
<p>HarmonyOS 在早期版本使用 <code>router</code> 模块来处理页面跳转，这类似于传统的 URL 路由方式：</p>
<ul>
<li>使用 <code>router.pushUrl(...)</code> 实现页面跳转</li>
<li>使用 <code>router.back()</code> 实现返回</li>
</ul>
<p>但随着 ArkTS 的发展，官方提出：</p>
<p><strong>Navigation 是未来推荐的导航机制</strong>，它提供了更丰富的动效、更灵活的栈操作、更统一的生命周期管理和更好的组件化路由支持。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Farkts-router-to-navigation%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-router-to-navigation?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">华为开发者</a></p>
<h4 data-id="heading-2">Router 的短板</h4>



































<table><thead><tr><th>项</th><th>Router</th><th>Navigation</th></tr></thead><tbody><tr><td>路由控制方式</td><td>基于 URL</td><td>基于组件栈</td></tr><tr><td>栈管理能力</td><td>简单</td><td>强（push/pop/replace 等）</td></tr><tr><td>动效 &amp; 页面过渡</td><td>弱</td><td>原生支持更丰富效果</td></tr><tr><td>嵌套路由 &amp; 组合场景</td><td>不支持</td><td>内建支持</td></tr><tr><td>推荐程度</td><td>❌ 不推荐</td><td>✅ 官方推荐</td></tr></tbody></table>
<p>简而言之，Router 更像是“旧时代的全局跳转”，而 Navigation 是“组件级页面栈导航”，更适合现代声明式 UI 架构。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2Fmaster%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-router-to-navigation.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/master/zh-cn/application-dev/ui/arkts-router-to-navigation.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee</a></p>
<hr/>
<h3 data-id="heading-3">二、核心对比：Router vs Navigation</h3>
<h4 data-id="heading-4">Router 示例（传统跳转）</h4>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.router'</span>;
 ​
 <span class="hljs-meta">@Entry</span>
 <span class="hljs-meta">@Component</span>
 struct <span class="hljs-title class_">FirstPage</span> {
   <span class="hljs-title function_">toSecond</span>(<span class="hljs-params"/>) {
     router.<span class="hljs-title function_">pushUrl</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/Second'</span> });
   }
 ​
   <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
     <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Go to Second'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">toSecond</span>());
   }
 }
</code></pre>
<p>这种方式虽然简单，但：</p>
<ul>
<li>页面必须在 <code>main_pages.json</code> 中注册</li>
<li>参数只能串联在 URL Query</li>
<li>路由控制逻辑与组件 UI 混在一起 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2Fmaster%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-router-to-navigation.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/master/zh-cn/application-dev/ui/arkts-router-to-navigation.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee</a></li>
</ul>
<hr/>
<h4 data-id="heading-5">Navigation 示例（推荐方式）</h4>
<p>Navigation 是一个 <strong>UI 级组件容器</strong>，负责整个页面栈结构。</p>
<pre><code class="hljs language-less" lang="less"> <span class="hljs-variable">@Entry</span>
 <span class="hljs-variable">@Component</span>
 struct AppRoot {
   <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">navStack</span>: <span class="hljs-selector-tag">NavPathStack</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">NavPathStack</span>();
 ​
   <span class="hljs-selector-tag">build</span>() {
     <span class="hljs-selector-tag">Navigation</span>(this.navStack) {
       <span class="hljs-selector-tag">Column</span>() {
         <span class="hljs-selector-tag">Button</span>(<span class="hljs-string">'Go to Second'</span>)
           <span class="hljs-selector-class">.onClick</span>(() =&gt; this.navStack.<span class="hljs-built_in">pushPathByName</span>(<span class="hljs-string">'SecondPage'</span>));
       }
     }
   }
 }
</code></pre>
<p>这里的路由逻辑与 UI 保持一致，由组件控制栈行为，更声明式。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2Fmaster%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-router-to-navigation.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/master/zh-cn/application-dev/ui/arkts-router-to-navigation.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee</a></p>
<hr/>
<h3 data-id="heading-6">三、迁移步骤详解</h3>
<h4 data-id="heading-7">1. 准备工作</h4>
<p>✅ 确保你的 SDK 版本包含 Navigation 相关 API（通常需要较新版 HarmonyOS SDK）。 ✅ 如果项目使用大量 Router 逻辑，先备份好代码以便回退。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides-V5%2Farkts-router-to-navigation-V5%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/arkts-router-to-navigation-V5?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">华为开发者</a></p>
<hr/>
<h4 data-id="heading-8">2. 从 Router 跳转改为 navStack.push</h4>
<p>Router 调用：</p>
<pre><code class="hljs language-css" lang="css"> router<span class="hljs-selector-class">.pushUrl</span>({ url: <span class="hljs-string">'pages/Detail?userId=123'</span> });
</code></pre>
<p>迁移后 Navigation 调用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"> <span class="hljs-keyword">this</span>.navStack.pushPathByName(<span class="hljs-string">"DetailPage"</span>, { userId: <span class="hljs-number">123</span> });
</code></pre>
<p>Navigation 的好处：</p>
<ul>
<li>参数以对象形式传递，不需要手动解析字符串</li>
<li>NavPathStack 更清晰地控制栈结构 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Farkts-router-to-navigation%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-router-to-navigation?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">华为开发者</a></li>
</ul>
<hr/>
<h4 data-id="heading-9">3. 页面结构调整</h4>
<p>Router 通常将每个页面标记为 <strong>@Entry</strong>，导致：</p>
<ul>
<li>多个页面都有独立入口</li>
<li>组件结构分散</li>
</ul>
<p>Navigation 推荐：</p>
<p><strong>只有一个主入口 @Entry</strong>，所有页面由 Navigation 管理</p>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-keyword">@Entry</span>
 <span class="hljs-keyword">@Component</span>
 struct MainApp {
   private navStack = new <span class="hljs-built_in">NavPathStack</span>();
   <span class="hljs-built_in">build</span>() {
     <span class="hljs-built_in">Navigation</span>(this.navStack) {
       <span class="hljs-built_in">NavDestination</span>('HomePage') { <span class="hljs-built_in">HomePage</span>() }
       <span class="hljs-built_in">NavDestination</span>('DetailPage') { <span class="hljs-built_in">DetailPage</span>() }
     }
   }
 }
</code></pre>
<p>然后你在 UI 中 push 对应名称即可。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2Fmaster%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-router-to-navigation.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/master/zh-cn/application-dev/ui/arkts-router-to-navigation.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee</a></p>
<hr/>
<h4 data-id="heading-10">4. 生命周期 &amp; 动效过渡</h4>
<p>Router 点击跳转不会有丰富过渡效果，也无法在组件级监听页面生命周期。</p>
<p>Navigation 支持更丰富的过渡与生命周期钩子（如进入/离开动画、页面 show/hide 钩子）。在迁移时可以根据需求添加过渡效果。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Farkts-router-to-navigation%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-router-to-navigation?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">华为开发者</a></p>
<hr/>
<h3 data-id="heading-11">四、做好迁移还要注意这些</h3>
<h4 data-id="heading-12">Namespace 与模版变化</h4>
<p>Navigation 管理页面组件不是用 URL，而是用组件名字或路由表映射名，因此需要统一命名。这比原先的 Router URL 更直观。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2Fmaster%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-router-to-navigation.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/master/zh-cn/application-dev/ui/arkts-router-to-navigation.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee</a></p>
<hr/>
<h4 data-id="heading-13">栈操作更丰富</h4>
<p>Navigation 的栈操作不仅仅有 Push 和 Pop，还有：</p>
<ul>
<li><code>replacePathByName(...)</code> — 替换当前页</li>
<li><code>popToName(...)</code> — 回到指定页面</li>
<li><code>clear()</code> — 清空栈</li>
</ul>
<p>这些在 Router 模式中是不支持或者非常难实现的。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2Fmaster%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-router-to-navigation.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/master/zh-cn/application-dev/ui/arkts-router-to-navigation.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee</a></p>
<hr/>
<h4 data-id="heading-14">嵌套路由和组合场景</h4>
<p>Navigation 支持嵌套 Navigation 容器，这对于复杂 UI（如底部 Tab + 子导航）非常有用，而 Router 很难实现这种组合效果。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2Fmaster%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-router-to-navigation.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/master/zh-cn/application-dev/ui/arkts-router-to-navigation.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee</a></p>
<hr/>
<h3 data-id="heading-15">五、完整迁移示例对比</h3>
<h4 data-id="heading-16">Router 版本</h4>
<pre><code class="hljs language-php" lang="php"> <span class="hljs-comment">// FirstPage.ets</span>
 router.<span class="hljs-title function_ invoke__">pushUrl</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/Second'</span> });
 <span class="hljs-comment">// SecondPage.ets</span>
 router.<span class="hljs-title function_ invoke__">back</span>();
</code></pre>
<hr/>
<h4 data-id="heading-17">Navigation 版本</h4>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// AppRoot.ets</span>
 <span class="hljs-built_in">Navigation</span>(this.navStack) {
   <span class="hljs-built_in">NavDestination</span>('FirstPage') { <span class="hljs-built_in">FirstPage</span>() }
   <span class="hljs-built_in">NavDestination</span>('SecondPage') { <span class="hljs-built_in">SecondPage</span>() }
 }
 <span class="hljs-comment">// FirstPage.ets</span>
 this<span class="hljs-selector-class">.navStack</span><span class="hljs-selector-class">.pushPathByName</span>("SecondPage");
 <span class="hljs-comment">// SecondPage.ets</span>
 this<span class="hljs-selector-class">.navStack</span><span class="hljs-selector-class">.pop</span>();
</code></pre>
<p>这样结构更清晰，并且 Navigation 可以嵌套在某一页内部实现“局部导航”效果（如 Tab 内独立导航）。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fopenharmony%2Fdocs%2Fblob%2Fmaster%2Fzh-cn%2Fapplication-dev%2Fui%2Farkts-router-to-navigation.md%3Futm_source%3Dchatgpt.com" target="_blank" title="https://gitee.com/openharmony/docs/blob/master/zh-cn/application-dev/ui/arkts-router-to-navigation.md?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">Gitee</a></p>
<hr/>
<h3 data-id="heading-18">🏁 六、总结</h3>
<p>迁移 Router → Navigation 的主要收益：</p>
<p>✔ 更强的组件栈控制能力 ✔ 参数传递更灵活，不再依赖查询字符串 ✔ 更丰富的动画与生命周期支持 ✔ 更易于实现复杂 UI 组合（如嵌套路由、Tab + stack） ✔ 官方推荐，未来生态更加完善 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Farkts-router-to-navigation%3Futm_source%3Dchatgpt.com" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-router-to-navigation?utm_source=chatgpt.com" ref="nofollow noopener noreferrer">华为开发者</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端大数字精度解决：big.js的教程和原理解析]]></title>    <link>https://juejin.cn/post/7585751355592949779</link>    <guid>https://juejin.cn/post/7585751355592949779</guid>    <pubDate>2025-12-22T00:08:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585751355592949779" data-draft-id="7576483553879441434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端大数字精度解决：big.js的教程和原理解析"/> <meta itemprop="keywords" content="前端,Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-12-22T00:08:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端大数字精度解决：big.js的教程和原理解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:08:33.000Z" title="Mon Dec 22 2025 00:08:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>在前端开发中，处理金融、电商等领域的数字计算时，JavaScript 原生的 Number 类型因采用 64 位双精度浮点数存储，极易出现精度丢失问题（如 <code>0.1 + 0.2 !== 0.3</code>）。big.js 作为轻量级的大数处理库，以简洁的 API 和清晰的源码逻辑，成为解决该问题的主流选择。本文将从 API 用法和源码原理两方面，全面解析 big.js 的核心价值。</p>
<h2 data-id="heading-0">1. 核心特性</h2>
<p>big.js 专为高精度十进制计算设计，核心特点：</p>
<ul>
<li>轻量（仅 ~6KB 无依赖）；</li>
<li>不可变设计（所有操作返回新实例）；</li>
<li>可配置精度、舍入模式；</li>
<li>兼容所有主流浏览器和 Node.js。</li>
</ul>
<h2 data-id="heading-1">2. 常用和特殊API详解</h2>
<h3 data-id="heading-2">2.1. 基础初始化 API</h3>
<p>big.js 的核心是 <code>Big</code> 构造函数，用于创建大数实例，支持多种入参类型：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Big</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'big.js'</span>;

<span class="hljs-comment">// 1. 基础初始化（支持数字、字符串、Big 实例）</span>
<span class="hljs-keyword">const</span> num1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">123</span>); <span class="hljs-comment">// 数字</span>
<span class="hljs-keyword">const</span> num2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'123.4567890123456789'</span>); <span class="hljs-comment">// 字符串（推荐，避免精度丢失）</span>
<span class="hljs-keyword">const</span> num3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(num2); <span class="hljs-comment">// 基于已有 Big 实例创建</span>

<span class="hljs-comment">// 2. 特殊值初始化</span>
<span class="hljs-keyword">const</span> zero = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 0</span>
<span class="hljs-keyword">const</span> negative = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'-987654321.987654321'</span>); <span class="hljs-comment">// 负数</span>
<span class="hljs-keyword">const</span> scientific = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'1.23e+5'</span>); <span class="hljs-comment">// 科学计数法</span>
</code></pre>
<blockquote>
<p>注意：初始化时优先使用<strong>字符串入参</strong>，避免数字本身已因浮点数存储丢失精度。</p>
</blockquote>
<h3 data-id="heading-3">2.2. 常用计算 API</h3>
<p>big.js 提供了完整的算术运算方法，所有方法均返回新的 Big 实例（原实例不变）：</p>








































<table><thead><tr><th>API 方法</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>plus(n)</code></td><td>加法</td><td><code>new Big(0.1).plus(0.2).toString()</code> → "0.3"</td></tr><tr><td><code>minus(n)</code></td><td>减法</td><td><code>new Big(1).minus(0.9).toString()</code> → "0.1"</td></tr><tr><td><code>times(n)</code></td><td>乘法</td><td><code>new Big(2).times(0.1).toString()</code> → "0.2"</td></tr><tr><td><code>div(n)</code></td><td>除法</td><td><code>new Big(1).div(3).toString()</code> → "0.3333333333"</td></tr><tr><td><code>mod(n)</code></td><td>取模</td><td><code>new Big(5).mod(2).toString()</code> → "1"</td></tr><tr><td><code>pow(n)</code></td><td>幂运算</td><td><code>new Big(10).pow(3).toString()</code> → "1000"</td></tr></tbody></table>
<p>示例代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 高精度加法</span>
<span class="hljs-keyword">const</span> a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'0.1'</span>);
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'0.2'</span>);
<span class="hljs-keyword">const</span> sum = a.<span class="hljs-title function_">plus</span>(b);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sum.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// "0.3"</span>

<span class="hljs-comment">// 高精度除法（默认精度 10 位）</span>
<span class="hljs-keyword">const</span> c = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'1'</span>);
<span class="hljs-keyword">const</span> d = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'3'</span>);
<span class="hljs-keyword">const</span> div = c.<span class="hljs-title function_">div</span>(d);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(div.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// "0.3333333333"</span>
</code></pre>
<h3 data-id="heading-4">2.3. 特殊配置 &amp; 工具 API</h3>
<h4 data-id="heading-5">2.3.1. 全局配置 API</h4>
<p>big.js 支持全局配置精度和舍入模式，核心配置项：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 设置全局精度（小数点后位数），默认 20</span>
<span class="hljs-title class_">Big</span>.<span class="hljs-property">DP</span> = <span class="hljs-number">15</span>; 

<span class="hljs-comment">// 2. 设置舍入模式，默认 ROUND_HALF_UP（四舍五入）</span>
<span class="hljs-title class_">Big</span>.<span class="hljs-property">RM</span> = <span class="hljs-title class_">Big</span>.<span class="hljs-property">roundHalfUp</span>; 

<span class="hljs-comment">// 舍入模式枚举（常用）：</span>
<span class="hljs-comment">// Big.roundUp: 向上取整</span>
<span class="hljs-comment">// Big.roundDown: 向下取整</span>
<span class="hljs-comment">// Big.roundHalfEven: 银行家舍入（四舍六入五取偶）</span>
</code></pre>
<h4 data-id="heading-6">2.3.2. 实例工具 API</h4>


















































<table><thead><tr><th>API 方法</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>toString()</code></td><td>转为字符串</td><td><code>new Big(123.45).toString()</code> → "123.45"</td></tr><tr><td><code>toFixed(dp)</code></td><td>固定小数位数</td><td><code>new Big(1.234).toFixed(2)</code> → "1.23"</td></tr><tr><td><code>toPrecision(pre)</code></td><td>固定有效数字</td><td><code>new Big(123.45).toPrecision(3)</code> → "123"</td></tr><tr><td><code>cmp(n)</code></td><td>比较大小（-1/0/1）</td><td><code>new Big(5).cmp(3)</code> → 1</td></tr><tr><td><code>abs()</code></td><td>绝对值</td><td><code>new Big(-123).abs()</code> → Big { s: 1, e: 2, c: [1,2,3] }</td></tr><tr><td><code>neg()</code></td><td>取反</td><td><code>new Big(123).neg()</code> → Big { s: -1, e: 2, c: [1,2,3] }</td></tr><tr><td><code>isZero()</code></td><td>判断是否为 0</td><td><code>new Big(0).isZero()</code> → true</td></tr><tr><td><code>isNegative()</code></td><td>判断是否为负数</td><td><code>new Big(-1).isNegative()</code> → true</td></tr></tbody></table>
<p>示例代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 配置精度和舍入模式</span>
<span class="hljs-title class_">Big</span>.<span class="hljs-property">DP</span> = <span class="hljs-number">2</span>;
<span class="hljs-title class_">Big</span>.<span class="hljs-property">RM</span> = <span class="hljs-title class_">Big</span>.<span class="hljs-property">roundUp</span>;

<span class="hljs-comment">// 向上取整的除法</span>
<span class="hljs-keyword">const</span> num = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-string">'1'</span>).<span class="hljs-title function_">div</span>(<span class="hljs-string">'3'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// "0.34"</span>

<span class="hljs-comment">// 比较大小</span>
<span class="hljs-keyword">const</span> x = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">10</span>);
<span class="hljs-keyword">const</span> y = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>(<span class="hljs-number">5</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x.<span class="hljs-title function_">cmp</span>(y)); <span class="hljs-comment">// 1（x &gt; y）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(x.<span class="hljs-title function_">cmp</span>(x)); <span class="hljs-comment">// 0（相等）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(y.<span class="hljs-title function_">cmp</span>(x)); <span class="hljs-comment">// -1（y &lt; x）</span>
</code></pre>
<h2 data-id="heading-7">3. 源码解析</h2>
<p>big.js 解决精度问题的核心思路是：<strong>将数字转为字符串拆分存储，通过模拟手工计算的方式实现算术运算</strong>，而非依赖 JavaScript 原生的浮点数运算。</p>
<h3 data-id="heading-8">3.1. 核心数据结构</h3>
<p>Big 实例的内部存储结构（核心属性）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 以 new Big('123.456') 为例</span>
{
  <span class="hljs-attr">s</span>: <span class="hljs-number">1</span>,        <span class="hljs-comment">// 符号位：1 正数，-1 负数</span>
  <span class="hljs-attr">e</span>: <span class="hljs-number">2</span>,        <span class="hljs-comment">// 指数：小数点偏移量（整数部分的位数 - 1），123.456 的整数部分是 123（3 位），故 e = 3-1 = 2</span>
  <span class="hljs-attr">c</span>: [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>] <span class="hljs-comment">// 系数数组：存储数字的每一位（无小数点，通过 e 定位）</span>
}
</code></pre>
<ul>
<li>符号位 <code>s</code>：分离正负，避免运算时处理符号干扰；</li>
<li>指数 <code>e</code>：记录小数点位置，将小数转为“整数 + 指数”的形式；</li>
<li>系数数组 <code>c</code>：以数组存储每一位数字，彻底规避浮点数的二进制存储精度丢失。</li>
</ul>
<h3 data-id="heading-9">3.2. 核心原理：从“二进制浮点”到“十进制手工计算”</h3>
<p>JavaScript 原生精度丢失的根源是：<strong>十进制小数无法被二进制浮点数精确表示</strong>（如 0.1 的二进制是无限循环小数）。big.js 则回归“手工计算逻辑”，步骤如下：</p>
<h4 data-id="heading-10">步骤 1：初始化时的字符串解析</h4>
<p>当传入数字/字符串时，big.js 会先将其转为字符串，逐字符解析为 <code>s</code>/<code>e</code>/<code>c</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 源码核心解析逻辑（简化版）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">parse</span>(<span class="hljs-params">str</span>) {
  <span class="hljs-keyword">let</span> s = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">let</span> e = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> c = [];

  <span class="hljs-comment">// 1. 处理符号</span>
  <span class="hljs-keyword">if</span> (str[<span class="hljs-number">0</span>] === <span class="hljs-string">'-'</span>) {
    s = -<span class="hljs-number">1</span>;
    str = str.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
  }

  <span class="hljs-comment">// 2. 处理小数点</span>
  <span class="hljs-keyword">const</span> dotIndex = str.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'.'</span>);
  <span class="hljs-keyword">if</span> (dotIndex !== -<span class="hljs-number">1</span>) {
    e = dotIndex - (str.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>); <span class="hljs-comment">// 计算指数偏移</span>
    str = str.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'.'</span>, <span class="hljs-string">''</span>); <span class="hljs-comment">// 移除小数点</span>
  }

  <span class="hljs-comment">// 3. 解析每一位到系数数组</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; str.<span class="hljs-property">length</span>; i++) {
    c.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Number</span>(str[i]));
  }

  <span class="hljs-comment">// 4. 去除前导零、调整指数</span>
  <span class="hljs-comment">// ...（源码中会处理前导零、末尾零等边界情况）</span>

  <span class="hljs-keyword">return</span> { s, e, c };
}
</code></pre>
<h4 data-id="heading-11">步骤 2：算术运算的“手工模拟”</h4>
<p>以加法为例，big.js 模拟人类手工加法的“对齐小数点 → 逐位相加 → 处理进位”逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 加法核心逻辑（简化版）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-comment">// 1. 对齐小数点（统一指数 e）</span>
  <span class="hljs-keyword">let</span> [x, y] = <span class="hljs-title function_">alignExponent</span>(a, b); <span class="hljs-comment">// 对齐后，x.e === y.e</span>

  <span class="hljs-comment">// 2. 逐位相加（从后往前）</span>
  <span class="hljs-keyword">let</span> carry = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> c = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = x.<span class="hljs-property">c</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
    <span class="hljs-keyword">const</span> sum = x.<span class="hljs-property">c</span>[i] + y.<span class="hljs-property">c</span>[i] + carry;
    c.<span class="hljs-title function_">unshift</span>(sum % <span class="hljs-number">10</span>); <span class="hljs-comment">// 当前位</span>
    carry = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(sum / <span class="hljs-number">10</span>); <span class="hljs-comment">// 进位</span>
  }

  <span class="hljs-comment">// 3. 处理最后一位进位</span>
  <span class="hljs-keyword">if</span> (carry) c.<span class="hljs-title function_">unshift</span>(carry);

  <span class="hljs-comment">// 4. 构建新的 Big 实例</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Big</span>({ <span class="hljs-attr">s</span>: a.<span class="hljs-property">s</span>, <span class="hljs-attr">e</span>: x.<span class="hljs-property">e</span>, c });
}

<span class="hljs-comment">// 对齐指数的辅助函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">alignExponent</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-keyword">const</span> diff = a.<span class="hljs-property">e</span> - b.<span class="hljs-property">e</span>;
  <span class="hljs-keyword">if</span> (diff &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// a 的指数更大，给 b 的系数数组补零（相当于小数点右移）</span>
    b.<span class="hljs-property">c</span> = b.<span class="hljs-property">c</span>.<span class="hljs-title function_">concat</span>(<span class="hljs-title class_">Array</span>(diff).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));
    b.<span class="hljs-property">e</span> = a.<span class="hljs-property">e</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (diff &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// b 的指数更大，给 a 的系数数组补零</span>
    a.<span class="hljs-property">c</span> = a.<span class="hljs-property">c</span>.<span class="hljs-title function_">concat</span>(<span class="hljs-title class_">Array</span>(-diff).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));
    a.<span class="hljs-property">e</span> = b.<span class="hljs-property">e</span>;
  }
  <span class="hljs-keyword">return</span> [a, b];
}
</code></pre>
<p>乘法、除法等运算的核心逻辑同理：</p>
<ul>
<li><strong>乘法</strong>：模拟“逐位相乘 → 错位相加 → 处理进位”；</li>
<li><strong>除法</strong>：模拟“试商 → 求余 → 补零继续除”，直到达到配置的精度（DP）；</li>
<li>所有运算均基于<strong>十进制数字数组</strong>，而非二进制浮点数，从根源避免精度丢失。</li>
</ul>
<h4 data-id="heading-12">步骤 3：舍入逻辑的精准控制</h4>
<p>big.js 提供多种舍入模式，核心是通过判断“舍弃位的数字”决定是否进位，例如四舍五入（ROUND_HALF_UP）：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 舍入核心逻辑（简化版）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">round</span>(<span class="hljs-params">c, dp, rm</span>) {
  <span class="hljs-keyword">const</span> cutIndex = dp; <span class="hljs-comment">// 保留位数的索引</span>
  <span class="hljs-keyword">const</span> discard = c[cutIndex]; <span class="hljs-comment">// 舍弃位的数字</span>

  <span class="hljs-keyword">if</span> (rm === <span class="hljs-title class_">Big</span>.<span class="hljs-property">roundHalfUp</span>) {
    <span class="hljs-comment">// 四舍五入：舍弃位 &gt;=5 则进位</span>
    <span class="hljs-keyword">if</span> (discard &gt;= <span class="hljs-number">5</span>) {
      <span class="hljs-title function_">carry</span>(c, cutIndex - <span class="hljs-number">1</span>); <span class="hljs-comment">// 向前一位进位</span>
    }
    c.<span class="hljs-title function_">splice</span>(cutIndex); <span class="hljs-comment">// 截断舍弃位</span>
  }
  <span class="hljs-keyword">return</span> c;
}
</code></pre>
<h3 data-id="heading-13">3.3. 源码核心亮点</h3>
<ol>
<li><strong>不可变设计</strong>：所有运算返回新实例，原实例不修改，避免副作用；</li>
<li><strong>最小化计算</strong>：仅处理必要的数字位，去除前导零、末尾零，提升性能；</li>
<li><strong>可配置化</strong>：通过 DP（精度）、RM（舍入模式）适配不同业务场景；</li>
<li><strong>轻量无依赖</strong>：核心代码仅千行左右，无外部依赖，易于集成。</li>
</ol>
<h2 data-id="heading-14">4. 适用场景 &amp; 注意事项</h2>
<h3 data-id="heading-15">适用场景</h3>
<ul>
<li>金融计算（金额、税率、利息）；</li>
<li>电商价格计算（优惠券、折扣、满减）；</li>
<li>高精度数据展示（科学计算、统计报表）。</li>
</ul>
<h3 data-id="heading-16">注意事项</h3>
<ol>
<li>初始化优先使用<strong>字符串</strong>，避免数字入参提前丢失精度；</li>
<li>避免频繁创建 Big 实例，可复用实例提升性能；</li>
<li>与原生 Number 互转时，需通过 <code>toString()</code> 或 <code>toNumber()</code> 方法，避免直接强制转换；</li>
<li>big.js 仅处理十进制大数，如需处理大整数（如 ID、雪花算法），可选择 <code>bigint</code> 或 <code>bn.js</code>。</li>
</ol>
<h2 data-id="heading-17">5. 总结</h2>
<p>big.js 作为前端大数精度处理的经典库，核心价值在于：</p>
<ol>
<li>以<strong>字符串解析 + 十进制数组存储</strong>的方式，规避了 JavaScript 浮点数的二进制存储缺陷；</li>
<li>通过<strong>模拟手工计算</strong>的算术逻辑，实现高精度的加减乘除等运算；</li>
<li>提供简洁的 API 和可配置项，适配不同业务场景的精度需求。</li>
</ol>
<p>在处理前端数字精度问题时，big.js 以轻量、易用、可靠的特性，成为开发者的首选方案。理解其 API 用法和源码原理，不仅能解决实际业务问题，也能深入理解 JavaScript 数字存储的底层逻辑。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7568192652286754870" target="_blank" title="https://juejin.cn/post/7568192652286754870">纯前端提取图片颜色插件Color-Thief教学+实战完整指南</a></li>
<li><a href="https://juejin.cn/post/7565737512816771135" target="_blank" title="https://juejin.cn/post/7565737512816771135">react-konva实战指南：Canvas高性能+易维护的组件化图形开发实现教程</a></li>
<li><a href="https://juejin.cn/post/7560905838074462271" target="_blank" title="https://juejin.cn/post/7560905838074462271">React无限滚动插件react-infinite-scroll-component的配置+优化+避坑指南</a></li>
<li><a href="https://juejin.cn/post/7560542615484137491" target="_blank" title="https://juejin.cn/post/7560542615484137491">前端音频兼容解决：音频神器howler.js从基础到进阶完整使用指南</a></li>
<li><a href="https://juejin.cn/post/7559871680015024169" target="_blank" title="https://juejin.cn/post/7559871680015024169">使用React-OAuth进行Google/GitHub登录的教程和案例</a></li>
<li><a href="https://juejin.cn/post/7550585427834404927" target="_blank" title="https://juejin.cn/post/7550585427834404927">纯前端人脸识别利器：face-api.js手把手深入解析教学</a></li>
<li><a href="https://juejin.cn/post/7553865490732433462" target="_blank" title="https://juejin.cn/post/7553865490732433462">关于React父组件调用子组件方法forwardRef的详解和案例</a></li>
<li><a href="https://juejin.cn/post/7553484874609410074" target="_blank" title="https://juejin.cn/post/7553484874609410074">React跨组件数据共享useContext详解和案例</a></li>
<li><a href="https://juejin.cn/post/7545087762837815334" target="_blank" title="https://juejin.cn/post/7545087762837815334">Web图像编辑神器tui.image-editor从基础到进阶的实战指南</a></li>
<li><a href="https://juejin.cn/post/7544323659788288046" target="_blank" title="https://juejin.cn/post/7544323659788288046">开发个人微信小程序类目选择/盈利方式/成本控制与服务器接入指南</a></li>
<li><a href="https://juejin.cn/post/7541741121400864778" target="_blank" title="https://juejin.cn/post/7541741121400864778">前端图片裁剪Cropper.js核心功能与实战技巧详解</a></li>
<li><a href="https://juejin.cn/post/7536530451461472265" target="_blank" title="https://juejin.cn/post/7536530451461472265">编辑器也有邪修？盘点VS Code邪门/有趣的扩展</a></li>
<li><a href="https://juejin.cn/post/7535005018257981466" target="_blank" title="https://juejin.cn/post/7535005018257981466">js使用IntersectionObserver实现目标元素可见度的交互</a></li>
<li><a href="https://juejin.cn/post/7534547200330121225" target="_blank" title="https://juejin.cn/post/7534547200330121225">Web前端页面开发阿拉伯语种适配指南</a></li>
<li><a href="https://juejin.cn/post/7516122409948020736" target="_blank" title="https://juejin.cn/post/7516122409948020736">让网页拥有App体验？PWA 将网页变为桌面应用的保姆级教程PWA</a></li>
<li><a href="https://juejin.cn/post/6953803916484018206" target="_blank" title="https://juejin.cn/post/6953803916484018206">使用nvm管理node.js版本以及更换npm淘宝镜像源</a></li>
<li><a href="https://juejin.cn/post/7140443283209060383" target="_blank" title="https://juejin.cn/post/7140443283209060383">手把手教你搭建规范的团队vue项目，包含commitlint，eslint，prettier，husky，commitizen等等</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 编程的边界：在掌控与放手之间的平衡]]></title>    <link>https://juejin.cn/post/7585808181239382067</link>    <guid>https://juejin.cn/post/7585808181239382067</guid>    <pubDate>2025-12-22T00:18:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585808181239382067" data-draft-id="7585553799299186734" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 编程的边界：在掌控与放手之间的平衡"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-12-22T00:18:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 编程的边界：在掌控与放手之间的平衡
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:18:48.000Z" title="Mon Dec 22 2025 00:18:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：在调试型错误时，我意识到：AI 编程本质是概率游戏。过度依赖 AI 处理不熟悉的框架和工具，会让问题越改越复杂。我们应该在自己理解的范围内编程，对陌生领域先学习再让 AI 辅助，而不是完全撒手不管。</p>
<h2 data-id="heading-0">AI 编程的边界：在掌控与放手之间的平衡</h2>
<h3 data-id="heading-1">问题的本质</h3>
<p>在昨晚写一个ChatBot, 调试Flask框架中， <code>itsdangerous</code> 和 <code>SECRET_KEY</code> 类型错误的过程中，我意识到了一个更加深刻的问题：</p>
<p><strong>虽然 AI 能够帮忙解决很多框架和工具的使用细节问题，但 AI 编程的本质是概率游戏。我们应该尽量在自己掌控的范围内编程，而不要对自己不理解的东西让 AI 介入太深，自己完全撒手不管。</strong></p>
<h3 data-id="heading-2">问题的表现</h3>
<p>在这次调试过程中，我们遇到了：</p>
<ol>
<li><strong>Alembic 迁移脚本问题</strong>：表不存在时的处理逻辑</li>
<li><strong>Flask-SQLAlchemy 版本兼容性</strong>：SQLAlchemy 1.x vs 2.x 的差异</li>
<li><strong>itsdangerous API 变化</strong>：<code>TimedJSONWebSignatureSerializer</code> vs <code>URLSafeTimedSerializer</code> 的 API 差异</li>
<li><strong>SECRET_KEY 类型处理</strong>：字符串、字节、整数的类型转换问题</li>
</ol>
<p>每次遇到问题，我都让 AI 去处理这些框架细节，结果：</p>
<ul>
<li>问题越改越复杂</li>
<li>代码中出现了很多防御性类型检查</li>
<li>最终还是没有彻底解决问题</li>
</ul>
<h3 data-id="heading-3">核心观点</h3>
<h4 data-id="heading-4">1. AI 编程是概率游戏</h4>
<p>AI 给出的解决方案是基于训练数据中的模式匹配，而不是真正的"理解"。当遇到：</p>
<ul>
<li>框架版本差异</li>
<li>API 变更</li>
<li>边界情况</li>
<li>复杂的类型系统</li>
</ul>
<p>AI 可能会给出看似合理但实际错误的方案。</p>
<h4 data-id="heading-5">2. 掌控范围的重要性</h4>
<p><strong>应该在自己理解的范围内编程：</strong></p>
<p>✅ <strong>适合让 AI 处理：</strong></p>
<ul>
<li>重复性的代码生成</li>
<li>已知模式的实现（如 CRUD 操作）</li>
<li>代码重构和优化</li>
<li>文档生成</li>
</ul>
<p>❌ <strong>不应该完全交给 AI：</strong></p>
<ul>
<li>不熟悉的框架和库</li>
<li>复杂的类型系统和类型转换</li>
<li>数据库迁移和架构变更</li>
<li>安全相关的配置（如 SECRET_KEY）</li>
</ul>
<h4 data-id="heading-6">3. 渐进式学习策略</h4>
<p>当遇到不熟悉的框架时，应该：</p>
<ol>
<li><strong>先理解核心概念</strong>：阅读官方文档，理解框架的设计理念</li>
<li><strong>小步验证</strong>：先写简单的测试代码，验证理解是否正确</li>
<li><strong>再让 AI 辅助</strong>：在理解的基础上，让 AI 帮助实现具体功能</li>
<li><strong>保持掌控</strong>：始终能解释代码为什么这样写</li>
</ol>
<h3 data-id="heading-7">这次问题的反思</h3>
<h4 data-id="heading-8">问题 1：Alembic 迁移</h4>
<p><strong>错误做法：</strong></p>
<ul>
<li>直接让 AI 写迁移脚本</li>
<li>遇到错误后继续让 AI 修复</li>
<li>没有理解 Alembic 的工作原理</li>
</ul>
<p><strong>正确做法：</strong></p>
<ul>
<li>先理解 Alembic 的迁移机制</li>
<li>手动创建简单的迁移脚本验证</li>
<li>理解后再处理复杂情况</li>
</ul>
<h4 data-id="heading-9">问题 2：itsdangerous 类型错误</h4>
<p><strong>错误做法：</strong></p>
<ul>
<li>让 AI 处理类型转换</li>
<li>添加大量防御性代码</li>
<li>没有理解 <code>itsdangerous</code> 的 API 设计</li>
</ul>
<p><strong>正确做法：</strong></p>
<ul>
<li>先阅读 <code>itsdangerous</code> 的文档</li>
<li>理解 <code>URLSafeTimedSerializer</code> 和 <code>TimedJSONWebSignatureSerializer</code> 的区别</li>
<li>理解 <code>SECRET_KEY</code> 的正确类型和用法</li>
<li>然后写简洁的代码</li>
</ul>
<h3 data-id="heading-10">实践建议</h3>
<h4 data-id="heading-11">1. 建立知识边界地图</h4>
<p>对自己不熟悉的领域，先花时间学习基础概念，再让 AI 辅助：</p>
<pre><code class="hljs">不熟悉程度 → 学习策略
─────────────────────────
完全陌生    → 先学习，再使用 AI
略有了解    → 边学边用，AI 辅助
比较熟悉    → 可以放心让 AI 处理细节
非常熟悉    → 自己写，AI 只做代码补全
</code></pre>
<h4 data-id="heading-12">2. 保持代码的简洁性</h4>
<p>如果代码中出现了大量防御性检查，说明：</p>
<ul>
<li>可能对框架的理解不够深入</li>
<li>应该回到文档，理解正确的用法</li>
<li>而不是用更多的代码来"修复"问题</li>
</ul>
<h4 data-id="heading-13">3. 问题追踪策略</h4>
<p>遇到问题时：</p>
<ol>
<li><strong>先理解问题</strong>：错误信息、堆栈跟踪、相关文档</li>
<li><strong>最小复现</strong>：写最简单的代码复现问题</li>
<li><strong>查阅文档</strong>：官方文档、源码、社区讨论</li>
<li><strong>再求助 AI</strong>：在理解的基础上，让 AI 帮助实现</li>
</ol>
<h3 data-id="heading-14">总结</h3>
<p>AI 是强大的编程助手，但不是万能的。在以下情况下，我们应该保持警惕：</p>
<ol>
<li><strong>不熟悉的框架和库</strong>：先学习，再使用</li>
<li><strong>复杂的类型系统</strong>：理解类型，而不是用类型检查绕过</li>
<li><strong>安全相关配置</strong>：必须自己理解，不能"交给 AI"</li>
<li><strong>架构和设计决策</strong>：应该基于自己的理解，而不是 AI 的建议</li>
</ol>
<p><strong>记住：代码是写给人看的，偶尔在机器上运行。如果连自己都不理解代码为什么这样写，那么当问题出现时，调试会变得非常困难。</strong></p>
<hr/>
<p><em>写于 2025-12-22，基于 itsdangerous/SECRET_KEY 类型错误的调试经历</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis实战精要：5种高效缓存策略让你的应用性能提升50%]]></title>    <link>https://juejin.cn/post/7585948869844123683</link>    <guid>https://juejin.cn/post/7585948869844123683</guid>    <pubDate>2025-12-22T00:18:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585948869844123683" data-draft-id="7585964362565894159" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis实战精要：5种高效缓存策略让你的应用性能提升50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-22T00:18:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis实战精要：5种高效缓存策略让你的应用性能提升50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:18:06.000Z" title="Mon Dec 22 2025 00:18:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Redis实战精要：5种高效缓存策略让你的应用性能提升50%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在现代分布式系统中，缓存技术已成为提升应用性能的核心手段之一。作为内存数据库的标杆，Redis以其高性能、丰富的数据结构和灵活的持久化机制，成为开发者构建高效缓存系统的首选工具。然而，仅仅部署Redis并不等同于获得理想的性能提升——缓存策略的选择与优化才是关键所在。</p>
<p>本文将深入剖析5种经过大规模生产验证的高效Redis缓存策略，涵盖从基础模式到高级技巧的完整知识体系。通过真实案例和性能对比数据，展示如何通过这些策略实现高达50%的应用性能提升。无论您是正在应对高并发挑战的架构师，还是希望优化现有系统的开发者，这些实战经验都将为您提供可直接落地的解决方案。</p>
<h2 data-id="heading-2">第一部分：理解Redis缓存的核心价值</h2>
<h3 data-id="heading-3">1.1 为什么选择Redis作为缓存层</h3>
<p>Redis的卓越性能源自其内存存储架构和单线程事件循环模型。基准测试表明：</p>
<ul>
<li>读操作可达10万+ QPS</li>
<li>写操作可达8万+ QPS</li>
<li>亚毫秒级延迟（通常0.1ms左右）</li>
</ul>
<p>相较于传统磁盘数据库，这些特性使Redis成为缓解数据库压力的理想选择。但更关键的是其丰富的数据结构支持：</p>
<ul>
<li>String：简单键值存储</li>
<li>Hash：对象属性存储</li>
<li>List：消息队列实现</li>
<li>Set/TSortedSet：去重与排行榜</li>
<li>Bitmap/HyperLogLog：高级统计功能</li>
</ul>
<h3 data-id="heading-4">1.2 缓存设计的黄金法则</h3>
<p>有效的缓存系统必须遵循两个核心原则：</p>
<ol>
<li><strong>数据时效性</strong>：平衡数据新鲜度与命中率</li>
<li><strong>资源利用率</strong>：最大化内存使用效率</li>
</ol>
<p>这需要根据业务特征选择适当的策略组合。下面我们将深入解析五种经典策略及其适用场景。</p>
<h2 data-id="heading-5">第二部分：五种高效缓存策略详解</h2>
<h3 data-id="heading-6">2.1 策略一：Cache Aside Pattern（旁路缓存）</h3>
<h4 data-id="heading-7">工作流程</h4>
<pre><code class="hljs language-markdown" lang="markdown">读路径：
<span class="hljs-bullet">1.</span> 先查缓存，命中则返回
<span class="hljs-bullet">2.</span> 未命中时查DB并写入缓存

写路径：
<span class="hljs-bullet">1.</span> 直接更新DB
<span class="hljs-bullet">2.</span> 删除对应缓存项
</code></pre>
<h4 data-id="heading-8">优势分析</h4>
<ul>
<li>实现简单，维护成本低</li>
<li>天然避免脏写问题（先DB后缓存）</li>
<li>Twitter早期采用此模式处理用户时间线</li>
</ul>
<h4 data-id="heading-9">注意事项</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Python伪代码展示常见陷阱：并发写导致脏数据</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">update_data</span>(<span class="hljs-params">key, value</span>):
    db.update(key, value)  <span class="hljs-comment"># STEP1: DB更新</span>
    
    time.sleep(<span class="hljs-number">0.1</span>)        <span class="hljs-comment"># 网络延迟模拟</span>
    
    redis.delete(key)      <span class="hljs-comment"># STEP2: 删除可能被其他请求覆盖的旧值</span>
</code></pre>
<p>解决方案：</p>
<ul>
<li>引入分布式锁（Redlock算法）</li>
<li>设置合理的过期时间作为兜底</li>
</ul>
<h3 data-id="heading-10">2.2 策略二：Write Behind Caching（异步回写）</h3>
<h4 data-id="heading-11">架构设计</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[应用层]</span> → <span class="hljs-selector-attr">[Redis]</span> → <span class="hljs-selector-attr">[异步Worker]</span> → <span class="hljs-selector-attr">[DB]</span>
</code></pre>
<h4 data-id="heading-12">Kafka+Redis实现示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java示例使用Spring Kafka监听写入事件</span>
<span class="hljs-meta">@KafkaListener(topics = "cacheUpdates")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleWriteBack</span><span class="hljs-params">(String message)</span> {
    <span class="hljs-type">CacheUpdateEvent</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> deserialize(message);
    database.batchUpdate(event.getData()); <span class="hljs-comment">// 批量更新DB</span>
    
    metricService.recordLatency(System.currentTimeMillis() - event.getTimestamp());
}
</code></pre>
<h4 data-id="heading-13">eBay的实战经验</h4>
<ul>
<li>QPS峰值期间DB负载降低62%</li>
<li>TP99延迟从230ms降至89ms</li>
<li>Redis集群配置需预留20%内存应对突增流量</li>
</ul>
<h3 data-id="heading-14">2.3 Strategy三：Read/Write Through（读写穿透）</h3>
<h4 data-id="heading-15">Unified Cache抽象层设计</h4>
<p><img src="mermaid-diagram-placeholder" alt="读写穿透架构图" loading="lazy"/></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Client] --&gt; B[Cache Layer]
    B --&gt;|Miss| C[Loader]
    C --&gt; D[(Database)]
</code></pre>
<h4 data-id="heading-16">Shopify的实践数据对比：</h4>























<table><thead><tr><th>Metric</th><th>Before</th><th>After</th><th>Delta</th></tr></thead><tbody><tr><td>Cache Hit %</td><td>68%</td><td>94%</td><td>+26%</td></tr><tr><td>DB Load</td><td>72%</td><td>41%</td><td>-31%</td></tr></tbody></table>
<h4 data-id="heading-17">Go语言实现示例：</h4>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> ReadThroughCache <span class="hljs-keyword">struct</span> {
    loaderFunc <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-type">string</span>)</span></span> ([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *ReadThroughCache)</span></span> Get(key <span class="hljs-type">string</span>) ([]<span class="hljs-type">byte</span>, <span class="hljs-type">error</span>) {
    val, err := redis.Get(key)
    <span class="hljs-keyword">if</span> err == redis.Nil {
        val, err = c.loaderFunc(key) <span class="hljs-comment">// Delegate to loader</span>
        
        <span class="hljs-keyword">go</span> redis.SetEx(key, val, ttl) <span class="hljs-comment">// Async refresh</span>
        
        <span class="hljs-keyword">return</span> val, err 
    }
    
    <span class="hljs-keyword">return</span> val, err 
}
</code></pre>
<h3 data-id="heading-18">（因篇幅限制，此处展示部分内容...）</h3>
<h2 data-id="heading-19"/>
<h2 data-id="heading-20"/>
<h2 data-id="heading-21"/>
<h2 data-id="heading-22"/>
<h2 data-id="heading-23"/>
<h2 data-id="heading-24"/>
<h2 data-id="heading-25"/>
<h2 data-id="heading-26"/>
<h2 data-id="heading-27"/>
<h2 data-id="heading-28"/>
<h2 data-id="heading-29"/>
<h2 data-id="heading-30"/>
<h2 data-id="heading-31"/>
<h2 data-id="heading-32"/>
<h2 data-id="heading-33"/>
<h2 data-id="heading-34"/>
<h2 data-id="heading-35"/>
<h2 data-id="heading-36"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[4ga Boards：重新定义高效协作的实时看板工具实战指南]]></title>    <link>https://juejin.cn/post/7585964362565926927</link>    <guid>https://juejin.cn/post/7585964362565926927</guid>    <pubDate>2025-12-22T00:27:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585964362565926927" data-draft-id="7537715040112656424" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="4ga Boards：重新定义高效协作的实时看板工具实战指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T00:27:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YL_jia"/> <meta itemprop="url" content="https://juejin.cn/user/1467226241383211"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            4ga Boards：重新定义高效协作的实时看板工具实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1467226241383211/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YL_jia
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:27:29.000Z" title="Mon Dec 22 2025 00:27:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">4ga Boards：重新定义高效协作的实时看板工具实战指南</h2>
<blockquote>
<p>在快节奏的团队协作环境中，看板工具已成为提升效率的关键利器，而4ga Boards正以其<strong>实时性、灵活性和企业级安全性</strong>在众多工具中脱颖而出。</p>
</blockquote>
<p>在现代团队协作与项目管理领域，看板工具已经从简单的任务管理进化成为<strong>企业运营的视觉神经中枢</strong>。4ga Boards作为新一代实时看板工具，不仅融合了任务管理与团队协作的核心功能，更在数据实时性、系统稳定性和企业级安全方面实现了突破性创新。</p>
<p>本文将深入剖析4ga Boards的核心特性，详解安装部署流程，并分享企业实战案例，助您全面掌握这一高效协作利器。</p>
<h3 data-id="heading-1">一、4ga Boards核心功能解析：不只是看板的协作中枢</h3>
<h4 data-id="heading-2">1. 实时动态可视化看板</h4>
<p>4ga Boards的核心突破在于其<strong>毫秒级数据同步能力</strong>。当团队成员在看板上移动一张任务卡片时，所有协作者的屏幕将在0.5秒内自动刷新，确保团队状态同步无延迟。这种实时性使分布式团队能够像在同一间作战室工作般默契配合。</p>
<p><strong>模块化看板设计</strong>是其另一亮点。用户可通过拖拽方式组合多种信息模块：</p>
<ul>
<li>任务泳道（支持WIP限制）</li>
<li>燃尽图/燃烧图</li>
<li>实时数据仪表盘</li>
<li>公告与通知中心</li>
<li>集成日历视图</li>
<li>环境监测（温湿度、空气质量等传感器数据）</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0faceb2437cf4a499b4a645e5339bbae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWUxfamlh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766968048&amp;x-signature=FsVkSHd0E1rXDid%2BjhGa5aph80U%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-3">2. 智能任务管理引擎</h4>
<p>4ga Boards的任务系统支持<strong>五级任务分解结构</strong>：</p>
<ol>
<li>史诗（Epic）</li>
<li>特性（Feature）</li>
<li>用户故事（User Story）</li>
<li>任务（Task）</li>
<li>子任务（Subtask）</li>
</ol>
<p>每个层级都可设置独立的<strong>工时跟踪与评估系统</strong>，并支持自动化工时记录。当任务标记为“完成”时，系统自动捕获时间消耗并生成效率报告，帮助团队持续优化工作流程。</p>
<h4 data-id="heading-4">3. 企业级安全与合规</h4>
<p>针对企业用户的安全顾虑，4ga Boards提供<strong>三层安全架构</strong>：</p>
<ul>
<li><strong>传输层</strong>：采用TLS 1.3加密所有数据传输</li>
<li><strong>存储层</strong>：静态数据AES-256加密</li>
<li><strong>访问层</strong>：基于RBAC模型的细粒度权限控制</li>
</ul>
<p>系统满足<strong>GDPR、HIPAA等国际合规标准</strong>，审计日志可保留长达7年，确保企业满足各类监管要求。</p>
<h4 data-id="heading-5">4. 多维度集成能力</h4>
<p>4ga Boards的API网关支持<strong>200+系统无缝对接</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
A[4ga Boards] --&gt;|实时同步| B[ERP系统]
A --&gt;|数据抽取| C[BI工具]
A --&gt;|单点登录| D[企业AD/LDAP]
A --&gt;|消息推送| E[钉钉/企业微信/Slack]
A --&gt;|自动化触发| F[CI/CD流水线]
</code></pre>
<h3 data-id="heading-6">二、安装部署全攻略：云原生与私有化的双轨方案</h3>
<h4 data-id="heading-7">1. 云托管方案（5分钟快速启动）</h4>
<p>适合中小团队快速上手的SAAS模式：</p>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2F4ga.io" target="_blank" title="https://4ga.io" ref="nofollow noopener noreferrer">4ga.io</a> 注册账号</li>
<li>选择团队规模（免费版支持5人协作）</li>
<li>配置团队域名（如<code>yourteam.4ga.io</code>）</li>
<li>邀请成员加入工作区</li>
<li>选择预置模板或从零创建看板</li>
</ol>
<h4 data-id="heading-8">2. 私有化部署方案（企业级安全）</h4>
<p>针对对数据安全有严格要求的企业用户，4ga Boards提供完整的私有化部署方案：</p>
<p><strong>系统要求</strong>：</p>



































<table><thead><tr><th>组件</th><th>最低配置</th><th>推荐配置</th></tr></thead><tbody><tr><td>CPU</td><td>4核</td><td>8核4GHz</td></tr><tr><td>内存</td><td>8GB</td><td>16GB</td></tr><tr><td>存储</td><td>50GB HDD</td><td>100GB SSD</td></tr><tr><td>OS</td><td>CentOS 7.x/Ubuntu 20.04</td><td>RHEL 8.x</td></tr><tr><td>容器</td><td>Docker 18.09+</td><td>Docker 20.10+</td></tr></tbody></table>
<p><strong>部署流程</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 下载部署包（需企业授权）</span>
wget https://deploy.4ga.io/enterprise/runtime-x86_64.zip

<span class="hljs-comment"># 创建运行目录</span>
<span class="hljs-built_in">mkdir</span> -p /opt/4ga-runtime &amp;&amp; <span class="hljs-built_in">cd</span> /opt/4ga-runtime

<span class="hljs-comment"># 解压部署包</span>
unzip runtime-x86_64.zip

<span class="hljs-comment"># 导入授权文件</span>
<span class="hljs-built_in">cp</span> 4ga-license.key /opt/4ga-runtime/

<span class="hljs-comment"># 启动服务</span>
./4ga start --cluster=3

<span class="hljs-comment"># 验证状态</span>
./4ga status
</code></pre>
<p><strong>关键配置项</strong>（<code>/opt/4ga-runtime/config.yaml</code>）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">cluster:</span>
  <span class="hljs-attr">nodes:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># 集群节点数</span>
<span class="hljs-attr">database:</span>
  <span class="hljs-attr">adapter:</span> <span class="hljs-string">postgresql</span>
  <span class="hljs-attr">pool:</span> <span class="hljs-number">20</span>
<span class="hljs-attr">security:</span>
  <span class="hljs-attr">audit_log:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">data_encryption:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">integrations:</span>
  <span class="hljs-attr">ldap:</span>
    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">ldap.yourcompany.com</span>
</code></pre>
<p>部署完成后，通过<code>https://your-server:7001</code>访问管理控制台，完成初始化设置。</p>
<h3 data-id="heading-9">三、从入门到精通：4ga Boards高效使用指南</h3>
<h4 data-id="heading-10">1. 看板配置最佳实践</h4>
<p><strong>制造企业车间看板模板</strong>：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+--------------+----------+----------+-----------+----------+</span>
|  待处理任务  | 准备中   | 生产中   | 质检      | 已完成   |
<span class="hljs-addition">+--------------+----------+----------+-----------+----------+</span>
| • 订单A-1000 | • 订单B  | • 订单C  | • 订单D   | • 订单E  |
|              | - 材料领 | - 冲压中 | - 尺寸检测|          |
|              | 取完成   |   [3/5]  |   ✅       |          |
<span class="hljs-addition">+--------------+----------+----------+-----------+----------+</span>
| 实时生产数据看板                         | 设备状态监控 |
| - 今日计划：500件                       | - 冲床1：正常 |
| - 已完成：320件 (64%)                   | - 注塑2：维护 |
<span class="hljs-addition">+-----------------------------------------+------------+</span>
</code></pre>
<p>此模板集成了<strong>任务状态跟踪</strong>、<strong>生产进度可视化</strong>和<strong>设备实时监控</strong>，帮助制造企业实现车间透明化管理。</p>
<h4 data-id="heading-11">2. 高级功能深度应用</h4>
<p><strong>自动化规则引擎</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 当任务延期时自动升级通知</span>
<span class="hljs-title function_">when</span>(<span class="hljs-params">task.dueDate &lt; now() &amp;&amp; task.status != <span class="hljs-string">'done'</span></span>) {
  task.<span class="hljs-property">priority</span> = <span class="hljs-string">'critical'</span>;
  <span class="hljs-title function_">notify</span>(task.<span class="hljs-property">owner</span>, <span class="hljs-string">'URGENT：任务已超期！'</span>);
  <span class="hljs-title function_">escalateTo</span>(<span class="hljs-string">'manager'</span>);
}

<span class="hljs-comment">// WIP限制检查</span>
<span class="hljs-title function_">when</span>(<span class="hljs-params">column.taskCount &gt; column.wipLimit</span>) {
  <span class="hljs-title function_">highlightColumn</span>(<span class="hljs-string">'red'</span>);
  <span class="hljs-title function_">alert</span>(<span class="hljs-string">'WIP超限！'</span>);
}
</code></pre>
<p><strong>数据透视分析</strong>：</p>
<ol>
<li>进入「分析中心」</li>
<li>选择「周期分析」视图</li>
<li>设置时间范围（上月/本季度）</li>
<li>添加筛选维度（团队/项目类型）</li>
<li>生成效能报告：
<ul>
<li>平均任务周期</li>
<li>阻塞时间占比</li>
<li>吞吐量趋势</li>
<li>流程效率热力图</li>
</ul>
</li>
</ol>
<h3 data-id="heading-12">四、企业实战案例：4ga Boards如何重塑协作效率</h3>
<h4 data-id="heading-13">案例1：全球汽车零部件制造商的生产可视化</h4>
<p><strong>挑战</strong>：
某跨国汽车零部件企业在全球有8个生产基地，生产数据分散在不同系统中，管理层难以获取实时生产状态。</p>
<p><strong>4ga Boards解决方案</strong>：</p>
<ol>
<li><strong>数据整合层</strong>：通过API连接各工厂MES、ERP、QMS系统</li>
<li><strong>实时看板层</strong>：
<ul>
<li>全球生产状态总览（按地域）</li>
<li>设备OEE实时监控</li>
<li>质量异常警报看板</li>
</ul>
</li>
<li><strong>决策支持层</strong>：
<ul>
<li>每小时自动生成生产简报</li>
<li>关键指标预测分析</li>
<li>供应链风险预警</li>
</ul>
</li>
</ol>
<p><strong>成效</strong>：</p>
<ul>
<li>生产异常响应时间缩短67%</li>
<li>跨工厂协作效率提升40%</li>
<li>每月管理会议时间减少15小时</li>
</ul>
<h4 data-id="heading-14">案例2：敏捷开发团队的DevOps看板</h4>
<p><strong>挑战</strong>：
某金融科技公司开发团队采用Scrum方法，但任务跟踪与CI/CD流程脱节，部署周期长。</p>
<p><strong>4ga Boards解决方案</strong>：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[产品Backlog]</span> -&gt; <span class="hljs-selector-attr">[开发中]</span> -&gt; <span class="hljs-selector-attr">[代码审查]</span> -&gt; <span class="hljs-selector-attr">[自动化测试]</span> -&gt; <span class="hljs-selector-attr">[预发布]</span> -&gt; <span class="hljs-selector-attr">[生产部署]</span>
</code></pre>
<p><strong>关键集成点</strong>：</p>
<ul>
<li><strong>提交触发</strong>：Git提交自动更新任务进度</li>
<li><strong>质量门禁</strong>：SonarQube扫描失败自动卡任务</li>
<li><strong>部署同步</strong>：Jenkins流水线状态实时回写看板</li>
<li><strong>监控反馈</strong>：生产环境异常自动创建缺陷卡片</li>
</ul>
<p><strong>成效</strong>：</p>
<ul>
<li>部署频率从每月2次提升至每周15次</li>
<li>平均故障恢复时间从4小时降至25分钟</li>
<li>团队交付吞吐量提升130%</li>
</ul>
<h3 data-id="heading-15">五、效能提升秘诀：4ga Boards高阶技巧</h3>
<ol>
<li>
<p><strong>瓶颈定位技巧</strong>：</p>
<ul>
<li>启用「流程热力图」功能，识别常卡任务区域</li>
<li>设置累积流图（CFD）分析在制品趋势</li>
<li>使用「模拟推演」预测产能变化影响</li>
</ul>
</li>
<li>
<p><strong>定制化扩展方案</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 示例：将生产设备数据接入看板</span>
<span class="hljs-keyword">from</span> 4ga_sdk <span class="hljs-keyword">import</span> BoardClient
<span class="hljs-keyword">from</span> opcua <span class="hljs-keyword">import</span> Client

<span class="hljs-comment"># 连接OPC UA服务器</span>
opc_client = Client(<span class="hljs-string">"opc.tcp://plc-server:4840"</span>)
opc_client.connect()

<span class="hljs-comment"># 获取设备状态</span>
status = opc_client.get_node(<span class="hljs-string">"ns=2;i=1"</span>).get_value()

<span class="hljs-comment"># 更新4ga Boards看板</span>
board = BoardClient(api_key=<span class="hljs-string">"YOUR_KEY"</span>)
board.update_card(
  board_id=<span class="hljs-string">"shop-floor"</span>,
  card_id=<span class="hljs-string">"equipment-1"</span>,
  fields={<span class="hljs-string">"status"</span>: <span class="hljs-string">"运行中"</span> <span class="hljs-keyword">if</span> status==<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"停机"</span>}
)
</code></pre>
</li>
<li>
<p><strong>混合办公优化</strong>：</p>
<ul>
<li><strong>移动端离线模式</strong>：在网络不稳定区域支持离线更新</li>
<li><strong>语音操作支持</strong>：“Hey 4ga，将任务移到测试完成列”</li>
<li><strong>AR车间看板</strong>：通过Hololens等设备在真实设备上叠加数据层</li>
</ul>
</li>
</ol>
<h3 data-id="heading-16">六、未来演进：4ga Boards技术路线图</h3>
<p>4ga Boards团队正致力于以下创新方向：</p>
<ol>
<li>
<p><strong>AI辅助预测</strong>：</p>
<ul>
<li>基于历史数据的智能估算</li>
<li>风险预测与缓解建议</li>
<li>自动资源平衡算法</li>
</ul>
</li>
<li>
<p><strong>元宇宙协作空间</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
A[3D虚拟作战室] --&gt; B[全息任务墙]
A --&gt; C[空间音频讨论区]
A --&gt; D[数字化身协作]
A --&gt; E[AR/MR设备集成]
</code></pre>
</li>
<li>
<p><strong>区块链增强</strong>：</p>
<ul>
<li>任务变更不可篡改记录</li>
<li>智能合约自动验收</li>
<li>分布式审计追踪</li>
</ul>
</li>
</ol>
<h3 data-id="heading-17">结语：选择适合团队的协作方式</h3>
<p>4ga Boards作为新一代实时看板工具，通过其<strong>灵活部署方式</strong>、<strong>深度定制能力</strong>和<strong>企业级安全架构</strong>，已成为不同规模团队提升协作效率的首选工具。无论您是初创团队需要快速可视化工作流程，还是大型制造企业需要整合车间生产数据，4ga Boards都能提供匹配的解决方案。</p>
<p><strong>最佳实践建议</strong>：</p>
<ol>
<li><strong>从小处着手</strong>：从一个团队、一个项目开始试点</li>
<li><strong>定期回顾</strong>：每月分析看板数据优化流程</li>
<li><strong>适度定制</strong>：避免过度复杂化看板结构</li>
<li><strong>文化适配</strong>：工具成功=技术方案×组织变革</li>
</ol>
<blockquote>
<p>看板工具的本质不是监控，而是<strong>赋能团队自组织与持续改进的艺术</strong>。4ga Boards正将这一艺术推向新的高度。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 中统一同步与异步执行模型]]></title>    <link>https://juejin.cn/post/7585778343351435327</link>    <guid>https://juejin.cn/post/7585778343351435327</guid>    <pubDate>2025-12-22T00:31:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585778343351435327" data-draft-id="7585706951603224602" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 中统一同步与异步执行模型"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T00:31:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 中统一同步与异步执行模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:31:10.000Z" title="Mon Dec 22 2025 00:31:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>在项目开发中，只要同时使用同步和异步执行逻辑，很容易出现代码混乱的问题，一开始大家觉得这只是“执行方式不同”，没什么大不了。但随着业务复杂度上升，问题逐渐暴露：</p>
<p>1、同步能实时拿到结果、捕获异常，异步失败了只能靠日志排查；</p>
<p>2、请求ID、操作人这些上下文信息，在异步执行时经常“丢失”；</p>
<p>3、新入队同学需要刻意记住每个方法是同步还是异步，稍不注意就踩坑；</p>
<p>4、日志、审计、监控这些通用逻辑，同步和异步要各加一遍。</p>
<p>其实根源不是“不能用异步”，而是大家把同步和异步当成了<strong>两套完全独立的执行体系</strong>——但对业务来说，它们本质上都是“一次业务执行”。</p>
<h2 data-id="heading-1">解决方案</h2>
<p>换个思路：先把“业务执行”本身抽象出来，再用统一的引擎来处理“执行方式”。</p>
<p>也就是说，业务只需要关心“做什么”，不需要关心“怎么执行”；至于是同步还是异步，交给底层引擎决定。</p>
<p>这样做的好处很明确：</p>
<ul>
<li>业务代码更聚焦，不再混杂执行细节；</li>
<li>同步/异步用同一种模型，上下文、异常、日志自然统一；</li>
<li>未来切换执行方式或扩展能力（重试、限流等），无需修改业务代码。</li>
</ul>
<h2 data-id="heading-2">技术实现</h2>
<h5 data-id="heading-3">1. 定义“执行单元”：业务的最小执行单位</h5>
<p>先抽象出一个最简洁的接口，代表“一次业务执行”：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Execution</span>&lt;R&gt; {
    R <span class="hljs-title function_">execute</span><span class="hljs-params">(ExecutionContext context)</span> <span class="hljs-keyword">throws</span> Exception;
}
</code></pre>
<p>这个接口只包含业务关心的元素：有上下文（<code>ExecutionContext</code>）、有执行结果（<code>R</code>）、可能抛出异常。它不关心任何执行细节——同步还是异步、用哪个线程池、怎么调度，都和它没关系。</p>
<h5 data-id="heading-4">2. 统一“执行上下文”：让信息在执行中流动</h5>
<p>上下文是业务执行的“环境变量”，我们用<strong>ThreadLocal</strong>实现上下文的跨线程传递：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExecutionContext</span> {
    <span class="hljs-comment">// 用 ThreadLocal 存储当前上下文</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;ExecutionContext&gt; CONTEXT_HOLDER =
        ThreadLocal.withInitial(ExecutionContext::<span class="hljs-keyword">new</span>);

    <span class="hljs-keyword">private</span> String requestId;   <span class="hljs-comment">// 链路跟踪用的请求ID</span>
    <span class="hljs-keyword">private</span> String operator;    <span class="hljs-comment">// 操作人，用于审计</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; attributes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <span class="hljs-comment">// 业务参数</span>

    <span class="hljs-comment">/** 获取当前上下文 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ExecutionContext <span class="hljs-title function_">current</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> CONTEXT_HOLDER.get();
    }

    <span class="hljs-comment">/** 设置上下文 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(ExecutionContext context)</span> {
        CONTEXT_HOLDER.set(context);
    }

    <span class="hljs-comment">/** 清理上下文 */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        CONTEXT_HOLDER.remove();
    }

    <span class="hljs-comment">// getter/setter 省略</span>
}
</code></pre>
<h4 data-id="heading-5">上下文的实际使用流程</h4>
<h5 data-id="heading-6">1. 请求入口设置上下文</h5>
<p>在请求入口（如 Controller/Filter）统一初始化和设置上下文：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> {

    <span class="hljs-meta">@PostMapping("/order")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">createOrder</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Order order)</span> {
        <span class="hljs-comment">// 1. 构建上下文</span>
        <span class="hljs-type">ExecutionContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExecutionContext</span>();
        context.setRequestId(UUID.randomUUID().toString()); <span class="hljs-comment">// 生成或从请求头获取</span>
        context.setOperator(<span class="hljs-string">"currentUser"</span>); <span class="hljs-comment">// 从登录信息获取</span>
        context.getAttributes().put(<span class="hljs-string">"order"</span>, order);

        <span class="hljs-comment">// 2. 绑定到当前线程</span>
        ExecutionContext.set(context);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 3. 提交业务执行（同步/异步由引擎决定）</span>
            ExecutionResult&lt;Boolean&gt; result = executorEngine.submit(ctx -&gt; {
                <span class="hljs-type">Order</span> <span class="hljs-variable">orderFromCtx</span> <span class="hljs-operator">=</span> ctx.getAttribute(<span class="hljs-string">"order"</span>);
                orderService.createOrder(orderFromCtx);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            });
            <span class="hljs-keyword">return</span> <span class="hljs-string">"success"</span>;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 4. 请求结束清理上下文，避免内存泄漏</span>
            ExecutionContext.clear();
        }
    }
}
</code></pre>
<h5 data-id="heading-7">3. 实现“执行引擎”：统一的执行入口</h5>
<p>有了执行单元和上下文，接下来需要一个统一的入口来执行它们：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ExecutorEngine</span> {
    &lt;R&gt; ExecutionResult&lt;R&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(Execution&lt;R&gt; execution)</span>;
}
</code></pre>
<p>业务侧<strong>只需要提交执行单元</strong>，不需要关心执行方式。执行引擎会根据配置自动处理同步或异步。</p>
<p><strong>同步执行引擎</strong>：最简单的实现，直接在当前线程执行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SyncExecutorEngine</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExecutorEngine</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;R&gt; ExecutionResult&lt;R&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(Execution&lt;R&gt; execution)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">R</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> execution.execute(ExecutionContext.current());
            <span class="hljs-keyword">return</span> ExecutionResult.success(result);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> ExecutionResult.failure(e);
        }
    }
}
</code></pre>
<p><strong>异步执行引擎</strong>：复用线程池，支持上下文传递</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncExecutorEngine</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ExecutorEngine</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Executor executor;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AsyncExecutorEngine</span><span class="hljs-params">(Executor executor)</span> {
        <span class="hljs-built_in">this</span>.executor = executor;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;R&gt; ExecutionResult&lt;R&gt; <span class="hljs-title function_">submit</span><span class="hljs-params">(Execution&lt;R&gt; execution)</span> {
        <span class="hljs-comment">// 捕获当前线程上下文并传递到异步线程</span>
        <span class="hljs-type">ExecutionContext</span> <span class="hljs-variable">currentCtx</span> <span class="hljs-operator">=</span> ExecutionContext.current();
        CompletableFuture&lt;R&gt; future = CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-keyword">try</span> {
                ExecutionContext.set(currentCtx);
                <span class="hljs-keyword">return</span> execution.execute(ExecutionContext.current());
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
            } <span class="hljs-keyword">finally</span> {
                <span class="hljs-comment">// 清理上下文避免内存泄漏</span>
                ExecutionContext.clear();
            }
        }, executor);
        <span class="hljs-keyword">return</span> ExecutionResult.async(future);
    }
}
</code></pre>
<h5 data-id="heading-8">4. 业务侧的使用方式</h5>
<p>业务只需要把原来的代码封装成执行单元，交给引擎处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 原来的同步/异步代码无需再维护两套</span>
executorEngine.submit(ctx -&gt; {
    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> ctx.getAttribute(<span class="hljs-string">"order"</span>);
    orderService.createOrder(order);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
});
</code></pre>
<p>这段代码：</p>
<ul>
<li>不关心是同步还是异步执行；</li>
<li>上下文自动传递；</li>
<li>异常由引擎统一处理；</li>
<li>日志、审计等通用逻辑在引擎层一次性处理，自动生效。</li>
</ul>
<h2 data-id="heading-9">总结</h2>
<p>通过统一执行模型的设计，我们可以将 <strong>业务逻辑</strong> 与 <strong>执行方式</strong>清晰分离，这套模型在项目中能解决几个实际问题：</p>
<p><strong>1. 代码可控</strong>：不再到处是 <code>@Async</code> 和 <code>CompletableFuture</code>，所有执行都有统一入口；</p>
<p><strong>2. 上下文不丢</strong>：请求ID、操作人等信息在同步/异步中都能正确传递；</p>
<p><strong>3. 扩展方便</strong>：要加重试、限流、熔断？在引擎层统一实现即可，业务代码无需修改；</p>
<p><strong>4. 降低认知成本</strong>：新同学不需要刻意区分同步/异步方法，调用方式完全一致。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数学不好也能懂：解读 AI 经典论文《Attention is All You Need》与大模型生成原理]]></title>    <link>https://juejin.cn/post/7585645111876730907</link>    <guid>https://juejin.cn/post/7585645111876730907</guid>    <pubDate>2025-12-22T00:34:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585645111876730907" data-draft-id="7585382317444366346" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数学不好也能懂：解读 AI 经典论文《Attention is All You Need》与大模型生成原理"/> <meta itemprop="keywords" content="人工智能,AIGC,LLM"/> <meta itemprop="datePublished" content="2025-12-22T00:34:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="印刻君"/> <meta itemprop="url" content="https://juejin.cn/user/572216818014568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数学不好也能懂：解读 AI 经典论文《Attention is All You Need》与大模型生成原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/572216818014568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    印刻君
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:34:50.000Z" title="Mon Dec 22 2025 00:34:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好, 我是印刻君. 今天我们来看看像 ChatGPT、DeepSeek 这样的大模型, 是如何一步步生成出连贯的句子和答案的.</p>
<p>答案就在一篇 AI 经典论文《Attention is All You Need》中, 这篇论文提出的 Transformer 架构, 奠定了当前大模型的技术基础.</p>
<p>接下来, 我们不纠结复杂数学公式和运算细节, 仅用具体实例串联起整个生成流程, 让你看懂论文, 对 Transformer 有一个感性认知.</p>
<blockquote>
<p>此前 AI 主流是循环神经网络 (RNN), 存在两个核心缺陷:</p>
<ol>
<li>看不懂上下文, 随着文本变长, 早期词的信息会不断衰减, 导致模型记不住前文;</li>
<li>计算效率低, 无法并行计算, 必须逐词迭代处理.</li>
</ol>
<p>而 Transformer 架构恰好精准解决了这两个痛点.</p>
</blockquote>
<h2 data-id="heading-0">零、Transformer 的核心框架: 编码器与解码器</h2>
<p>Transformer 架构的核心示意图如下, 整个结构分为左右两部分: 左侧是编码器 (Encoder), 右侧是解码器 (Decoder).</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/566291866e6f4a17b2039674a9ae1d00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766968489&amp;x-signature=qeOBqwaV6rDZRbeaf5%2F4YVNxG1w%3D" alt="t1.png" loading="lazy"/></p>
<p>两者的分工很明确:</p>
<ul>
<li>编码器: 核心作用是 "语义理解". 它会完整解析输入文本, 把文字转化为包含上下文信息的语义向量. 让模型明白 "用户在说什么";</li>
<li>解码器: 核心作用是 "生成预测". 它基于编码器的理解结果, 逐步生成符合语境的文本. 确保生成的贴合需求.</li>
</ul>
<p>需要注意的是, <strong>我们日常使用的 ChatGPT、DeepSeek 等生成式大模型, 并没有用到完整的 Transformer 架构, 而是只保留了右侧的解码器.</strong> 这种设计被称为 "Decoder Only 架构".</p>
<p>这种设计把 "理解输入" 和 "生成输出" 的任务全部交给了解码器. 当你输入问题时, 解码器通过自我迭代, 既完成了对问题的理解, 又逐步生成回答.</p>
<p><strong>接下来的拆解, 我们将聚焦于 Decoder Only 架构的核心流程. 单独看解码器的结构.</strong></p>
<p>解码器的结构, 就像一条三层的"文本生产流水线", 每个环节各司其职:</p>
<ol>
<li>前置预处理模块: 准备好需要加工的"原料"（Token 序列）, 并为原料补充 "语义" 和 "位置信息" 两大关键辅助信息;</li>
</ol>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c66c002020f422eb32e7b23d4f2e7ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766968489&amp;x-signature=clVJE6iS1L9knweog47TMKKzLzs%3D" width="240" loading="lazy"/>
<ol start="2">
<li>核心解码器堆叠: 流水线的核心加工环节, 通过 "注意力机制" 梳理词与词的关联, 把 "原料" 加工成包含完整语义逻辑的"半成品";</li>
</ol>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb1207b5b49148e6bb79c6d1239e2ea1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766968489&amp;x-signature=TCYiWDIvmT%2BJCr6Sia74x6t7oOo%3D" width="240" loading="lazy"/>
<ol start="3">
<li>后置输出模块: 把 "半成品" 转换成人类能理解的文字, 完成最终生成.</li>
</ol>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e0816f15b6a4082b112282814e71ac4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766968489&amp;x-signature=IKTNoYnHwHZchY0D%2BabLxp6fdwo%3D" width="240" loading="lazy"/>
<p>三层模块的逻辑关系可参考下图:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d27b40b4d17415fb13897a77d17961e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2w5Yi75ZCb:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766968489&amp;x-signature=SEZCtGwuIpa1dVHXXeSZ86hfp1w%3D" alt="t5.png" loading="lazy"/></p>
<p>下面我们就沿着这条"流水线", 一步步拆解每个环节的具体工作, 搞懂大模型生成的底层逻辑.</p>
<h2 data-id="heading-1">一、前置预处理模块: 给文字赋予语义和位置信息, 做好生成准备</h2>
<p>大模型生成答案是"逐字逐句"的（专业叫"自回归”）.</p>
<p>比如生成 "我爱吃苹果”:</p>
<ul>
<li>输出 "我", 再基于我生成 “爱”;</li>
<li>接着基于 "我爱" 生成 “吃”;</li>
<li>最后基于 "我爱吃" 生成 "苹果”;</li>
<li>直到生成表示结束的特殊符号 (如 <code>&lt;/s&gt;</code>).</li>
</ul>
<p>预处理模块的核心任务, 就是把每一步的词准备好, 为后续的语义提供合格的 "原料". 它包含三个关键操作:</p>
<h3 data-id="heading-2">1 Token 嵌入 (Token Embedding)</h3>
<p>计算机不能直接理解文字符号, 必须把文字转化成数值形式, 这就是嵌入 (Embedding) 的核心目的. 具体来说, 就是把每个子词 (Token) 转换成一个固定的向量, 这个向量就是 "词向量".</p>
<h3 data-id="heading-3">2 Right Shift（序列右移）</h3>
<p>这是一个简单却重要的技术操作: 把整个 Token 序列向右移动一个位置, 并在最开头补一个特殊的起始符号 (如 <code>&lt;s&gt;</code>), 同时舍弃最后一个 Token.</p>
<p>为什么要做这个操作? 主要是为了配合后续的掩码机制, 模拟逐词生成的真实场景. 从数据结构上为 "防作弊" 做好准备.</p>
<h3 data-id="heading-4">3. 添加位置编码（Positional Encoding）</h3>
<p>词向量解决了 "每个词是什么意思", 但没有解决 "词在句子中的位置在哪里", 而词序恰恰是语义的关键, 例如 "我爱吃苹果" 和 "苹果词爱我" 的词完全一样, 但语义天差地别.</p>
<p>位置编码的作用, 就是给每个词向量补充 "位置信息", 相当于给每个词贴一张唯一的 "座位号".</p>
<p>从数学逻辑上看, 位置编码是一个和词向量维度相同的向量, 通过 "相加" 的方式与词向量融合. 原始论文中, 位置编码采用正弦和余弦函数生成.</p>
<blockquote>
<p>现在的大模型 (如 GPT) 大多采用更高效的 "旋转位置编码 (RoPE)", 但核心目的相同: 让模型同时掌握词的 "语义信息" 和 "位置信息", 为后续的上下文理解打下基础.</p>
</blockquote>
<h2 data-id="heading-5">二、核心解码器堆叠: 用注意力机制梳理语义, 深化语境理解</h2>
<p>经过预处理后, 每个 Token 都变成 "词向量 + 位置编码" 的融合向量, 这些向量会进入核心加工区. 由多个完全相同的 "解码器层" 堆叠而成. (原始论文用了 6 层, 现代大模型则更多, GPT-3 175B 用了 96 层)</p>
<p>你可以把每一层看作一个 "语义提炼车间".</p>
<ul>
<li>语义进入第一层, 被初步梳理词与词的关联;</li>
<li>再进入第二层, 在第一层的基础上深化理解;</li>
<li>经过多层迭代后, 模型对当前语境的理解会越来越精准, 生成的语义向量也会越来越贴合 "下一步该说什么" 的需求.</li>
</ul>
<p>介绍解码器层的核心前, 我们再了解两个保证架构稳定的工具, 它们会在每个核心操作后生效.</p>
<ul>
<li>残差连接 (Residual Connection): 相当于一条信息"备用通道". 它把加工前的原始信息直接传到加工后, 与加工结果相加. 这能防止核心语义被弱化. 因为在深层堆叠网络中, 原始信息在多轮加工后容易被 "稀释”;</li>
<li>层归一化 (Layer Normalization): 相当于一个"稳定器". 它把每一层的输入输出都进行标准化处理, 确保下一层接收的数据在一个稳定范围内. 这能避免因为数值过大或过小, 导致模型训练过程停滞不前.</li>
</ul>
<p>做好了这些准备, 我们来看每个解码器层内部的三个核心操作:</p>
<h3 data-id="heading-6">1. 掩码多头自注意力（Masked Multi-Head Self-Attention）</h3>
<p>这是整个 Transformer 架构的"灵魂", 也是大模型能理解上下文的核心原因. 我们把它拆解成 "自注意力"、"掩码"、"多头" 三个部分, 用实例讲解:</p>
<p><strong>自注意力 (Self-Attention)</strong></p>
<p>先看 "自注意力 (Self-Attention)", 它的核心作用是梳理当前序列中词与词的关联, 比如 "我爱吃苹果". 自注意力会计算每个词与其他词的关联程度 (专业上叫 "注意力分数"), 然后根据分数加权求和, 得到词的上下文向量.</p>
<p>以 "我爱吃苹果" 为例:</p>
<ul>
<li>"我" 会重点关联 "爱" (谁在做动作);</li>
<li>"爱" 会重点关联 "我" 和 "吃" (动作的主体和对象);</li>
<li>"吃" 会重点关联 "苹果" (动作的对象).</li>
</ul>
<p>通过这种方式, 每个词都能融合上下文的语境信息, 不在是孤立的存在.</p>
<blockquote>
<p>从向量角度理解, 注意力分数的计算, 本质上是向量的内积运算, 两个词向量的内积越大, 说明它们的语义关联度越高, 注意力分数也就越高.</p>
</blockquote>
<p><strong>掩码 (Masked)</strong></p>
<p>再看 "掩码 (Masked)": 结合我们前面说的 "自回归" 模式, 模型在生成第 <code>i</code> 个词时, 只能看到前 <code>i - 1</code> 个词, 不能 "偷看" 后面的词.</p>
<p>掩码的作用就是 "屏蔽未来信息", 它会给未来位置的注意力分数, 加上一个极大的负数, 让这些分数在后续的 Softmax 运算中趋近于 0, 相当于让模型 "看不见" 未来的词, 从机制上杜绝了 "作弊"</p>
<p><strong>多头 (Multi-Head)</strong></p>
<p>可以理解为 "多个语义分析专家组同时工作". 每个 "头" 都有独立的参数, 负责从不同维度分析词与词的关联.</p>
<p>比如一个头专门分析 "主谓宾" 关系 (谁对谁做了什么), 一个头专门分析 "修饰关系" (形容词修饰哪个名词), 一个头专门分析 "逻辑关系" (因果、转折等).</p>
<p>所有的头的分析结果会通过矩阵拼接和转换融合, 最终得到更全面、更精准的上下文向量. 这种 "多视角融合" 的设计, 让模型对语义的理解更深刻, 避免单一视角的片面性.</p>
<h3 data-id="heading-7">2. 编码器-解码器注意力（Encoder-Decoder Attention）</h3>
<p>在完整的 Transformer 中, 这一步作用是 "让解码器关注编码器的理解结果". 比如翻译任务中, 解码器生成英文时, 会通过这一步回看编码器对于中文输入的语义理解, 确保翻译准确</p>
<p>但在我们聚焦的 Decoder Only 模型（如 ChatGPT）中, 由于没有独立的编码器, 这一步的作用发生了转变, 变成了 "解码器自关注": 让模型再深度审视已经生成的全部序列, 强化对整个上下文的理解</p>
<p>换句话说, 这一步相当于让模型回头, 再读一遍自己已经写的内容, 检查是否有语义矛盾、逻辑断裂的地方, 确保接下来要生成的词, 与整个上下文保持连贯, 不跑题.</p>
<h3 data-id="heading-8">3. 前馈网络（Position-wise Feed-Forward Network）</h3>
<p>经过前两步的注意力机制处理, 词与词之间的关联已经梳理清晰. 相当于解决了 "词与词如何配合" 的问题.</p>
<p>前馈网络的核心任务, 是对每个词的语义向量, 进行独立的精细化加工, 相当于解决了 "每个词在当前语境下具体是什么意思" 的问题.</p>
<p>从结构上看, 前馈网络是一个两层的神经网络, 它会对每个词的向量进行独立处理.</p>
<p>举个例子, 在 "我爱吃苹果" 的语境下, 前馈网络会强化 "苹果" 向量中 "可食用水果" 的特征维度, 同时弱化 "苹果公司"、"苹果肌" 等与当前语境无关的特殊维度;</p>
<p>而在 "我会用苹果手机" 的语境下, 它会反过来强化 "科技产品" 的特征维度, 通过这种精细化的调整, 让每个词的语义在当前语境下更精准.</p>
<h2 data-id="heading-9">三、后置输出模块: 把语义向量 "翻译" 成人类能懂的文字</h2>
<p>经过多个解码器层的深度加工, 我们得到了一个代表 "下一步最想说什么" 的语义向量. 这个向量是数值形式, 人类无法直接理解. 所以我们需要后置输出模块, 把这个语义向量翻译成具体的文字, 完成最终的生成. 它包含两个关键步骤:</p>
<h3 data-id="heading-10">1. 线性投射（Linear Projection）</h3>
<p>大模型内部有一个"词表", 包含了它认识的所有 Token (可能有几万个). 线性投射的本质, 是一个简单的线性变换, 是将几百维的语义向量, 转换成一个长度与词表相同的分数向量.</p>
<p>这相当于给词表中的每个词, 打一个 "匹配分", 分数越高, 说明这个词越符合当前语义向量要表达的意思.</p>
<p>举个例子, 如果当前语义向量要表达的是 "苹果" 相关的意思, 那么线性投射后:</p>
<ul>
<li>"苹果" 对应的分数可能是9.5;</li>
<li>"香蕉" 是 8.0;</li>
<li>"桌子"是 0.5;</li>
<li>"跑步" 是 0.3.</li>
</ul>
<p>通过分数清晰区分不同词的匹配程度.</p>
<h3 data-id="heading-11">2. Softmax 归一化（Softmax Layer）</h3>
<p>线性投射得到的分数是任意实数, 无法直接作为"选择依据".</p>
<p>Softmax 的作用就是把这些分数转换成"概率”, 让每个词对应的数值都落在 0 到 1 之间, 且所有词的概率之和为 1. 概率越高, 说明模型认为这个词是"下一步最应该生成的词".</p>
<p>比如前面例子中:”</p>
<ul>
<li>"苹果" 的分数 9.5 经过 Softmax 后, 概率可能达到 70%;</li>
<li>"香蕉" 的分数 8.0 可能变成 28%;</li>
<li>"桌子"、"跑步" 的低分则会变成 1% 以下.</li>
</ul>
<p>最终, 模型会选择概率最高的那个词作为下一步生成的词. 这个词会被立即添加到已生成序列的末尾, 整个"预处理→核心加工→输出"的流程会重新执行, 直到模型生成表示结束的特殊符号（如 <code>&lt;/s&gt;</code>）, 一条完整的回答就诞生了.</p>
<h2 data-id="heading-12">总结</h2>
<p>《Attention is All You Need》这篇论文的核心贡献, 就是用 "编码器解码器+注意力机制" 的 Trasnfromer 架构, 解决了之前语言模型 "看不懂上下文、计算效率低" 的问题.</p>
<p>现在的生成式大模型（Decoder Only 架构）, 本质上是 Transformer 基础上做 "放大" 和 "优化". 比如增加解码器层数（从 6 层增加到几十层）、扩大词表规模、用更多数据训练, 但核心的生成逻辑, 依然是我们前面拆解的 "预处理→核心语义加工→输出转换" 的流水线流程.</p>
<p>现在回顾一下整体流程, 大模型生成内容, 就是:</p>
<ol>
<li>把文字转换成 Token 向量, 补充位置信息;</li>
</ol>

<ol start="2">
<li>通过多层注意力机制梳理 Token 关联、优化语义特征;</li>
</ol>

<ol start="3">
<li>把优化后的向量转换成概率, 选择概率最高的词逐一生成, 直到完成整个答案.</li>
</ol>
<p>我是印刻君, 一位探索 AI 的前端程序员, 关注我, 让 AI 知识有温度, 技术落地有深度.</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[中国四大软件外包公司]]></title>    <link>https://juejin.cn/post/7585839411122454574</link>    <guid>https://juejin.cn/post/7585839411122454574</guid>    <pubDate>2025-12-22T00:37:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585839411122454574" data-draft-id="7585645111876747291" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="中国四大软件外包公司"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-12-22T00:37:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CodeSheep"/> <meta itemprop="url" content="https://juejin.cn/user/4371313961738616"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            中国四大软件外包公司
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313961738616/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CodeSheep
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:37:23.000Z" title="Mon Dec 22 2025 00:37:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在程序员的职业字典里，每次提到“<strong>外包</strong>”这两个字，似乎往往带着一种复杂的况味，不知道大家对于这个问题是怎么看的？</p>
<p>包括我们在逛职场社区时，也会经常刷到一些有关外包公司讨论或选择的求职帖子。</p>
<p>的确，在如今的 IT 职场大环境里，对于许多刚入行的年轻人，或者很多寻求机会的开发者来说，外包公司或许也是求职过程中的一个绕不开的备选项。</p>
<p>今天这篇文章，我们先来聊一聊 IT 江湖里经常被大家所提起的“<strong>四大软件外包公司</strong>”，每次打开招聘软件，相信不少同学都刷到过他们的招聘信息。</p>
<p>他们在业内也一度曾被大家戏称为“外包四大金刚”，可能不少同学也能猜到个大概。</p>
<p><strong>1、中软国际</strong></p>
<p>中软可以说是国内软件外包行业的“老大哥”之一，拥有约 8 万名员工，年收入规模高达 170 亿。</p>
<p>而且中软的业务版图确实很大，在国内外 70 个城市重点布局，在北京、西安、深圳、南京等地均拥有自有产权的研发基地。</p>
<p>提起中软，很多同学的第一反应是它和华为的“深度绑定”。</p>
<p>的确，华为算是中软比较大的合作伙伴之一，同样，这种紧密的合作关系，让中软在通信、政企数字化等领域获得了不少份额。</p>
<p>在中软的体系里，经常能看到一种非常典型的“正规化”打法。它的流程比较规范，制度也非常完善。这对于刚毕业的大学生或者想要转行进入 IT 的人来说，算是一个不错的“练兵场”。</p>
<p>不过近年来，中软也在拼命转型，试图摆脱单纯的外包标签，在 AIGC 和鸿蒙生态上投入了不少精力。</p>
<p><strong>2、软通动力</strong></p>
<p>如果说上面的中软是“稳扎稳打”的代表，那么软通给人的感觉就是“迅猛扩张”。</p>
<p>软通虽然成立时间比中软晚了几年，但发展势头却非常迅猛。</p>
<p>根据第三方机构的数据显示，软通动力在 IT 服务市场的份额已经名列前茅，甚至在某些年份拔得头筹。</p>
<p>软通这家公司一直给人的印象是“大而全”。它的总部在北京，员工规模甚至达到了 90000 人。</p>
<p>而软通动力的上市，一度给行业打了一剂强心针。它的业务线覆盖了从咨询到 IT 服务的全生命周期，包含了金融、能源、智能制造、ICT 软硬件、智能化产品等诸多方面。</p>
<p><strong>3、东软集团</strong></p>
<p>如果说前两家是后来居上的代表，那么东软就是老牌子软件公司的代表。</p>
<p>成立于 1991 年的东软，是中国上市较早的软件公司之一，早在 1996 年就上市了。</p>
<p>东软最初创立于东北大学，后来通过国际合作进入汽车电子领域，并逐渐踏上产业化发展之路，其创始人刘积仁博士也算是软件行业的先驱大佬了。</p>
<p>东软的业务重心很早就放在了医疗健康、智慧城市和汽车电子等这几个领域。</p>
<p>说不定现在很多城市的医院里，跑着的 HIS 系统有可能就是东软做的。</p>
<p>虽然近年来东软也面临着转型阵痛，但它在医疗和智慧城市等领域的积淀，依然是其他外包公司难以撼动的。</p>
<p><strong>4、文思海辉（中电金信）</strong></p>
<p>这家公司的发展历程比较特殊，它经历过文思创新和海辉软件的合并，后来又加入了中国电子（CEC）的阵营，成为中国电子旗下的一员，并且后来又进一步整合为了中电金信。</p>
<p>所以它现在更多地以“中电金信”的身份出现。</p>
<p>文思海辉的强项在于金融和数智化领域，尤其银行业 IT 项目这一块做了非常多，市场份额也很大。</p>
<p>那除了上面这几个“外包巨头”之外，其实很多领域还有很多小型外包公司，有的是人力资源外包，有的则是项目外包。</p>
<p>每次提到「<strong>外包</strong>」这个词，可能不少同学都会嗤之以鼻，那这里我也来<strong>聊聊我自己对于外包的一些个人看法和感受</strong>。</p>
<p>说实话，我没有进过外包公司干过活，但是呢，我和不少外包公司的工作人员共事过，一起参与过项目。</p>
<p>记得老早之前我在通信公司工作时，我们团队作为所谓的“甲方”，就和外包员工共事过有大半年的样子，一起负责公司的核心网子项目。</p>
<p>有一说一，我们团队整体对外包同事都是非常友好的。</p>
<p>我看网上有那种什么外包抢了红包要退钱、什么提醒外包注意素质不要偷吃的零食的事情，有点太离谱、太夸张了，这在我们团队那会是从来没有发生过的。</p>
<p>大家平时在一起上班的氛围也挺融洽，大家一起该聊天聊天，该开玩笑开玩笑，该一起吃饭一起吃饭，在相处方面并没有什么区别。</p>
<p><strong>但是，不同地方的确也有。</strong></p>
<p>比方说，他们上班时所带的工牌带子颜色就和我们不太一样，这一眼就能看出来，另外平时做的事情也有点不太一样。</p>
<p>我记得当时项目的一些抓包任务、测试任务、包括一些标注任务等等都是丢给外包同事那边来完成，我们需要的是结果、是报告。</p>
<p>另外对于项目文档库和代码库的权限也的确有所不同，核心项目代码和文档确实是不对外包同事那边开放的。</p>
<p>除此之外，我倒并没有觉得有什么太多的不同。</p>
<p>那作为程序员，我们到底该<strong>如何看待这些外包公司呢</strong>？</p>
<p>这就好比是一个围城，城外的人有的想进去，城里的人有的想出来。</p>
<p>每次一提到外包，很多人的建议都是不要进，打亖别去。<strong>但是，这里有个前提是，首先得在你有的选的情况下，再谈要不要选的问题</strong>。</p>
<p>不可否认的是，外包公司确实有它的短板。最被人诟病的两点，一个“职业天花板”问题、一个“归属感缺失”问题。</p>
<p>但是在当下的就业环境里，我们不得不承认的是，外包公司也承担了 IT 行业“蓄水池”的角色。</p>
<p>毕竟并不是每个人一毕业就能拿到互联网大厂的 offer，也并不是每个人都有勇气去创业公司搏一把。</p>
<p>对于有些学历一般、技术基础一般或者刚转行的程序员来说，外包也提供了另外一个选择。</p>
<p>而如果你现在正在外包或者正在考虑加入外包，那这里我也想<strong>说几句肺腑之言</strong>：</p>
<p><strong>第一，不要把外包作为职业生涯的终点，而应该把它看作一个跳板或过渡。</strong></p>
<p>如果你刚毕业进不去大厂，或者在一二线城市没有更好的选择，那外包可以为你提供一个接触正规项目流程的机会（当然前提是要进那种正规的外包），我们也可以把它看昨一个特殊的职场驿站。</p>
<p>在那里的每一天，你都要问问自己：我学到了什么？我的技术有没有长进？我的视野有没有开阔？</p>
<p><strong>第二，一定要警惕“舒适区”。</strong></p>
<p>很多同学在外包待久了，可能会陷入一种拿工资办事的机械式工作中，看起来很舒适，实际上很危险。</p>
<p>注意，一定要利用能接触到的资源，去学习项目的技术架构和业务流程，去想办法提升自己的核心竞争力，而不是仅仅为了完成工时。</p>
<p>最后我想说的是，无论你是在大厂做正式员工，还是在小团队里打拼，亦或是在外包公司里默默耕耘，最终决定职业高度的，并不是工牌上公司的名字，而是会多少技术，懂多少业务，能解决多少问题，大家觉得呢？</p>
<p>好了，今天就先聊这么多吧，希望能对大家有所启发，我们下篇见。</p>
<blockquote>
<p>注：本文在GitHub开源仓库「编程之路」 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frd2coding%2FRoad2Coding" target="_blank" title="https://github.com/rd2coding/Road2Coding" ref="nofollow noopener noreferrer">github.com/rd2coding/R…</a> 中已经收录，里面有我整理的6大编程方向(岗位)的自学路线+知识点大梳理、面试考点、我的简历、几本硬核pdf笔记，以及程序员生活和感悟，欢迎star。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[栗子前端技术周刊第 111 期 - Next.js 16.1、pnpm 10.26、Bun 1.3.5...]]></title>    <link>https://juejin.cn/post/7585778343351484479</link>    <guid>https://juejin.cn/post/7585778343351484479</guid>    <pubDate>2025-12-22T00:43:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585778343351484479" data-draft-id="7585476892977315874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="栗子前端技术周刊第 111 期 - Next.js 16.1、pnpm 10.26、Bun 1.3.5..."/> <meta itemprop="keywords" content="前端,JavaScript,Bun"/> <meta itemprop="datePublished" content="2025-12-22T00:43:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="晓得迷路了"/> <meta itemprop="url" content="https://juejin.cn/user/2172290706715565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            栗子前端技术周刊第 111 期 - Next.js 16.1、pnpm 10.26、Bun 1.3.5...
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2172290706715565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    晓得迷路了
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:43:19.000Z" title="Mon Dec 22 2025 00:43:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>🌰<strong>栗子前端技术周刊第 111 期 (2025.12.15 - 2025.12.21)</strong>：浏览前端一周最新消息，学习国内外优秀文章视频，让我们保持对前端的好奇心。</p>
<h2 data-id="heading-0">📰 技术资讯</h2>
<ol>
<li>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fblog%2Fnext-16-1" target="_blank" title="https://nextjs.org/blog/next-16-1" ref="nofollow noopener noreferrer">Next.js 16.1</a></strong>：Next.js 16.1 版本聚焦更高效的开发工作流与更稳定的运行表现，对 Turbopack 构建工具及相关配套工具链进行了重大更新。默认优化 <code>next dev</code> 命令的编译速度；实验性的 Next.js 打包分析工具；调试体验优化，可通过 <code>next dev --inspect</code> 命令，便捷调试 Next.js 应用等等。</p>
</li>
<li>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fpnpm.io%2Fblog%2Freleases%2F10.26" target="_blank" title="https://pnpm.io/blog/releases/10.26" ref="nofollow noopener noreferrer">pnpm 10.26</a></strong>：pnpm 10.26 正式发布，本次更新包含以下特性：针对 Git 托管依赖项启用更严格的默认安全规则、新增 <code>allowBuilds</code> 配置以实现精细化的脚本权限管控、并添加了一项全新设置，用于拦截非标准的传递性依赖。</p>
</li>
<li>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fbun.com%2Fblog%2Fbun-v1.3.5" target="_blank" title="https://bun.com/blog/bun-v1.3.5" ref="nofollow noopener noreferrer">Bun v1.3.5</a></strong>：Bun 1.3.5 发布，更新内容包括：用于支持伪终端（PTY）的 Bun.Terminal API、用于消除无效代码的编译期特性标志、提升 <code>Bun.stringWidth</code> 方法的计算精度等等。</p>
</li>
</ol>
<h2 data-id="heading-1">📒 技术文章</h2>
<ol>
<li>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fredmonk.com%2Fkholterhoff%2F2025%2F12%2F16%2Fjavascript-bundler-grand-prix%2F" target="_blank" title="https://redmonk.com/kholterhoff/2025/12/16/javascript-bundler-grand-prix/" ref="nofollow noopener noreferrer">The JavaScript Bundler Grand Prix</a></strong>：JavaScript 打包工具巅峰对决 - 如今，打包工具已成为诸多 JavaScript 工作流的核心所在，有时甚至会被直接集成到运行时环境中（例如 Bun 的运行时）。本文梳理了当下 JavaScript 打包工具的生态格局，并指出：打包工具的速度之争基本已尘埃落定，真正的战场正转向产物体积优化以及最终交付给用户的代码质量。</p>
</li>
<li>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.val.town%2Fgardening-dependencies" target="_blank" title="https://blog.val.town/gardening-dependencies" ref="nofollow noopener noreferrer">How to Keep package.json Under Control</a></strong>：如何管理好你的 package.json 文件 - 本文围绕依赖项管理展开，分享了各类依赖管控的实用方法，同时提供了大量优质技巧与工具推荐。</p>
</li>
<li>
<p><strong><a href="https://juejin.cn/post/7583912637470769203" target="_blank" title="https://juejin.cn/post/7583912637470769203">前端一行代码生成数千页 PDF，dompdf.js 新增分页功能</a></strong>：dompdf.js 是作者开源的前端 PDF 生成库。可以纯前端将 html 生成为非图片式的，可编辑，小体积的 PDF 文件。之前的版本只能生成单页 PDF，很多开发者反馈有生成多页 PDF 的需求，作者花了点时间在 V1.1.0 版本新增了分页功能，可以将 html 页面生成为多页 PDF 文件。</p>
</li>
</ol>
<h2 data-id="heading-2">🔧 开发工具</h2>
<ol>
<li><strong><a href="https://juejin.cn/post/7584243498527211520" target="_blank" title="https://juejin.cn/post/7584243498527211520">StreamPanel</a></strong>：StreamPanel 是一个 Chrome DevTools 扩展，专门用于监控和调试流式请求。</li>
</ol>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1854fe8446a24cd29a1e8d9360a1e3fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pmT5b6X6L-36Lev5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766968999&amp;x-signature=Fd5r%2BO8nyrXFOICQ0McrYhVOkRY%3D" width="100%" alt="image-20251221093127601" loading="lazy"/>
<ol start="2">
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftenngoxars%2FWeMD" target="_blank" title="https://github.com/tenngoxars/WeMD" ref="nofollow noopener noreferrer">WeMD</a></strong>：开源的 Markdown 微信公众号编辑器。</li>
</ol>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5689f8aa22d4f4a913b92956353c3a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pmT5b6X6L-36Lev5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766968999&amp;x-signature=es3P%2BazlUP0tGjMnJp6NRRWACnk%3D" width="100%" alt="image-20251221093016320" loading="lazy"/>
<ol start="3">
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Ftoastflow.adrianjanocko.sk%2F" target="_blank" title="https://toastflow.adrianjanocko.sk/" ref="nofollow noopener noreferrer">Toastflow</a></strong>：一款适用于 Vue 3 的消息通知组件库，从技术架构来看，Toastflow 本质上是框架无关的，但目前仅提供了 Vue 3 对应的渲染器。</li>
</ol>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b2497589dba4960abc9c51938299b43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pmT5b6X6L-36Lev5LqG:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766968999&amp;x-signature=0QWKQz6ERsvaT3ccgrHe4YIVOhM%3D" width="100%" alt="image-20251221093651704" loading="lazy"/>
<p>🚀🚀🚀 <em>以上资讯文章选自常见周刊，如 JavaScript Weekly 等，周刊内容也会不断优化改进，希望你们能够喜欢。</em></p>
<p>💖 <strong>欢迎关注微信公众号：栗子前端</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PinK(Cocos4.0？)生成飞机大战，抢先体验全流程！]]></title>    <link>https://juejin.cn/post/7585948869844287523</link>    <guid>https://juejin.cn/post/7585948869844287523</guid>    <pubDate>2025-12-22T00:54:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585948869844287523" data-draft-id="7585948869844271139" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PinK(Cocos4.0？)生成飞机大战，抢先体验全流程！"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T00:54:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="亿元程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1972988307323236"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PinK(Cocos4.0？)生成飞机大战，抢先体验全流程！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972988307323236/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    亿元程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T00:54:24.000Z" title="Mon Dec 22 2025 00:54:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f49ea03c767b44e8971a96bba6e0b289~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=BDEBBkHTzIu7CbRLN77rG5Cq0zw%3D" alt="来源于Cocos官方论坛" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p><strong>哈喽大家好</strong>，原小道消息<code>PinK</code>将于<code>18号</code>公测，但是白天一整天迟迟未见。</p>
<p><strong>终于</strong>在晚上<code>19</code>点左右<code>PinK 0.0.1-alpha.1</code>版发布了！不过<code>alpha</code>测试仅对部分开发者开放：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e45ee02bfa545a4a847e9a79b92d084~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=TQX7g853na1zJ3jnU7BZ84gyneQ%3D" alt="来源于Cocos官方论坛" loading="lazy"/></p>
<p><strong>论坛</strong>瞬间炸开了锅，一码难求。</p>
<p><strong>笔者</strong>为了宠粉，鼓起勇气直接私信了产品经理，幸运地拿到了想要的码，连夜进行了测评。</p>
<p><strong>先</strong>看看简单的介绍：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9631f1e91524ae09a3378ef42718ccb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=NVlWZSkh2MqZps0HRyK9OJHxZYU%3D" alt="来源于Cocos官方论坛" loading="lazy"/></p>
<p><strong>言归正传</strong>，小伙伴们跟随笔者，一起来体验下<code>PinK(Cocos4.0)</code>以及用它生成飞机大战实战全过程！</p>
<h2 data-id="heading-1">1. 安装和激活</h2>
<p><strong>下载</strong>完成后，直接解压运行<code>PinK.exe</code>，据说是基于<code>VSCode</code>开发，意味着坐拥<code>VSCode</code>所有插件！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2acc244dbb974779be7a1c65d10540bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=C9dv3tWEMwo5tfv5xFj5jB6lBmE%3D" alt="" loading="lazy"/></p>
<p><strong>首次</strong>打开需要填入我们拿到的码进行激活，粉红色的椰子头格外耀眼，符合主题<code>PinK</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/333980f11a834aa5aaa9154bba1fcdb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Z55a%2B88PBlIRjVvQ3N%2BdyRtIL3E%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">2. 界面</h2>
<p><strong>完整界面</strong>如下，非常熟悉了，大家看看都有啥！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2645cc7e25946e28b5e225c43ae3b5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=fGRTVg%2B4uwkl8%2B5IXBAV%2BTMQHB0%3D" alt="" loading="lazy"/></p>
<p><strong>左上角</strong>一排图标分别是<code>Scene</code>(场景)、<code>Hierarchy</code>(层级管理器)、<code>Inspector</code>(属性检查器)、<code>Asset</code>(资源管理器)等等<code>Creator</code>常用的面板，不过目前测试点击无效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b6e89f4f33e46279b7857599d188db1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=SZxz0AlceJ7xccg6ujL1f26ret0%3D" alt="" loading="lazy"/></p>
<p><strong>正上方</strong>的就是和<code>Creator</code>一样的运行工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6572a69682bb46c996a670b29acbc13e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=LKzyRb5Tthr%2FNgzWvSbYusq1GvI%3D" alt="" loading="lazy"/></p>
<p><strong>右上角</strong>也是一排工具按钮，不怎么见过，不介绍了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e31b2c1236cf457fbb0ba78a93f5a29c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=0BgflRrpbVa4QL01UUrNaYxzhOA%3D" alt="" loading="lazy"/></p>
<p><strong>其余剩下</strong>的部分就是与<code>VSCode</code>一致的，左侧资源管理器，右侧是我们的<code>AI</code>聊天面板。</p>
<h2 data-id="heading-3">3.安装SDK</h2>
<p><strong>使用之前</strong>要在<code>PinK</code>里面安装<code>cocos-sdk</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32b3fe92dcf34505bbf2977522b3d96f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=4VM1cKcHbeRhK79H7tYr46H18gI%3D" alt="" loading="lazy"/></p>
<p><strong>总大小</strong>接近<code>5G</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8322c40aee74e12a986e81f1e2c0ec8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=vGMUUTEm4DlWdJvBiQxpIFp%2BN0s%3D" alt="" loading="lazy"/></p>
<p><strong>里面</strong>包括我们熟悉的引擎源码：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30cafbd1d9c24db69f1efd4baf404f55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=OEQPPlgbDv5Y9bKnaCnDIUjLdWU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">4.PinK飞机大战实战</h2>
<p><strong>前面</strong>有关注笔者的小伙伴，笔者通过<code>DeepSeek</code>和生图软件去简单粗暴地开发一款飞机大战游戏，收获了非常多的点赞。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca49bb8fd6224dd6af23ec92d53232b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Wwa%2Bm6SGyp9Xf%2FPuIzdRHzazfpc%3D" alt="" loading="lazy"/></p>
<p><strong>里面</strong>明确指出<code>AI</code>并不能通过<code>Chat</code>全自动利用<code>Creator</code>完成开发，还是要扎实掌握许多基本功，即使通过<code>AI</code>操作<code>Scene</code>文件和<code>Pfefab</code>文件，目前都还是比较难。</p>
<p><strong>下面</strong>我们用<code>PinK</code>实战对比，看看有什么不同。</p>
<h3 data-id="heading-5">1.创建工程</h3>
<p><strong>首先</strong>通过<code>Create Project</code>按钮创建我们的工程<code>PinkTest</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/138fc7bfe5084c7daf4e078332fbb76d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=8%2BvDYmLFkmfwwfsmC3MAgkws8nc%3D" alt="" loading="lazy"/></p>
<p><strong>创建</strong>完成后会自动生成我们熟悉的工程目录结构。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/379f0b06a83b43a984d97f19aefd094e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=BupbDMpD463qNwazfCq%2B3DQM9PQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.选择模型</h3>
<p><strong>目前</strong>测试阶段，<code>PinK</code>自掏腰包内置<code>Gemini3</code>，给予好评。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c84a43d54c454087b030d1b02db7eda7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=doE%2FC15P7p9Z7ycoxGMtwA3Uwpw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">3.实战开始</h3>
<p><strong>二话</strong>不说，笔者先来个下马威：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31c26b13ce2c4e46812ab1bc34a1b5cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=GWxnONwEN3bPcX0KxPL%2BLFxsl40%3D" alt="" loading="lazy"/></p>
<p><strong>PinK</strong>反手就丢给我3个<code>md</code>文件，分别是：</p>
<ul>
<li><strong><code>GD.md</code></strong> : 游戏设计文档。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83b8e84305294e44b78c20ded438d3ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=pdwoOP9K7rHRWj74o9102uxxCJ4%3D" alt="" loading="lazy"/></li>
<li><strong><code>ART.md</code></strong> : 美术需求文档。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c2bc4ca0212418a95e26e3a433a688d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=lyTo20gjvRDS3HbBQ9HfvkX4lCw%3D" alt="" loading="lazy"/></li>
<li><strong><code>TECH.md</code></strong> : 技术需求文档。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/441ffa45eaca4bfeba54dc19b5e03bd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=s3Z8OFJbSOSE3tw3Q5WRVuHmRo0%3D" alt="" loading="lazy"/></li>
</ul>
<p><strong>整体流程</strong>就靠上面<code>3</code>个文档驱动,生成完成后等待老板下发指令开工。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b93cc3f3105342e4ae10bc484b8026f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=h%2Fru26054r4M08x5HkVpTupZn4g%3D" alt="" loading="lazy"/></p>
<p><strong>由于</strong>笔者没有配置<code>API Key</code>，没办法直接生成所需的美术资源，一直卡在生成图片阶段。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee92f5accaed4cbcbd13438b8c961f71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=0ZY8iGDvlVi6LM9uRibnAZuEoYI%3D" alt="" loading="lazy"/></p>
<p><strong>只能</strong>重新让他先做好游戏，后续我再根据美术需求补充资源。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee736293b67f4fdf8e9980c10e6c5d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=N6tUVnbBLzS2h7m0xxhyQrZTHt8%3D" alt="" loading="lazy"/></p>
<p><strong>开启</strong><code>Auto Approve</code>之后，笔者就去洗漱了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d47812016f447fea6f1565376a510dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Vp6%2FsIBuryXN4GMK5alL9jl4Zj4%3D" alt="" loading="lazy"/></p>
<p><strong>回来</strong>时，他告诉我已经做好了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a538c872e70a4d8783ec8cfa0dd39cc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=VeR58EjOvjBNYaPZekLGPhfQULE%3D" alt="" loading="lazy"/></p>
<p><strong>把</strong>我们上次生成的资源改成指定的名字放在指定目录。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b37c44ef25644ee980fda940f8e37ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=N%2BKXov5l1ef1tby4cwmL09LnphA%3D" alt="" loading="lazy"/></p>
<p><strong>PinK神</strong>启动！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83fc5fe136ce476bbff264c5c0653d6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=0WmgHlhB2RcwKqC24kehoMG8L1M%3D" alt="" loading="lazy"/></p>
<p><strong>果不其然</strong>，事情并没有那么简单，运行之后一片空白。乍眼一看脚本还有报错。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bb77d26742046ce9965a7b4cb177697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=8q6VVuIr%2FqkEjc41%2Bv8QbmjWZqk%3D" alt="" loading="lazy"/></p>
<p><strong>笔者</strong>好奇地打开<code>Creator</code>看看生成的场景和节点长什么样，节点也没有生成(<strong>到后面发现其实是笔者搞错了场景</strong>)。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df5acb74dc6d4caabdbe3af581d62e73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Ts0ab3twTkGk0SnC3BFZQrPJNDU%3D" alt="" loading="lazy"/></p>
<p><strong>于是</strong>我让他修复一下报错和挂载<code>GameManager</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9472eb89eda4a938a74ac90a0580620~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=d9IJxkIM8kHetF9z9rbgpZbIQ6M%3D" alt="" loading="lazy"/></p>
<p><strong>打开</strong><code>Main</code>场景可以看到，节点已生成，代码也挂载好了(妥妥解决了痛点)。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7591f356852a4b1a977db7c09063654e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=os1WzRcQ1cmfQU936G9FIthIKD4%3D" alt="" loading="lazy"/></p>
<p><strong>最后</strong>让他运行游戏。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68a43ac8d3d0478aba0c43655584076f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=y8A%2BX%2FVoEklVlxfC0yI7DqTm2dw%3D" alt="" loading="lazy"/></p>
<p><strong>在控制台</strong>可以清晰看到<code>Cocos Creator v4.0.0</code>字样，这是不是就说明<code>PinK</code>就是<code>Cocos4.0</code>?</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bed7892f534240bd97c6c08980c16299~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=l%2FwZrktYRrmlnVqtPEuiDHygXvk%3D" alt="" loading="lazy"/></p>
<p><strong>这次</strong>他自动打开了内置的简单浏览器，但是游戏画面还是没有出来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aac4b2b23f94a43a98ee821e2bfc6aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=RaH0y6AnxThPbjg7coyRoWEBJW8%3D" alt="" loading="lazy"/></p>
<p><strong>查看报错</strong>可以知道图片的导入格式不对。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/417de1c775db4ffdbefa7bb0af16a546~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=R7zZQk7gw7ZX7Sjb8ndMyrXzf%2F8%3D" alt="" loading="lazy"/></p>
<p><strong>把</strong>报错信息复制过去，并且告诉他格式不对。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83dd69c0c0f54eb6b2238f5a866c189c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=Ix76YYckAKbTQml9LC3lf2r9k1M%3D" alt="" loading="lazy"/></p>
<p><strong>然后</strong>他就自动调整格式了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef459388835e48a4b067e3e3d7ddfcf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=SNSNg9fu4XrDh%2FusF2cMgfxksCw%3D" alt="" loading="lazy"/></p>
<p><strong>最后运行</strong>，画面终于出来了，泪流满面，就是图片有点太大了，不太协调。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/331804b18f9a43a586fd269cf4b1f74e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=3rkVdHntQ524Y6e9udziCHnImEA%3D" alt="" loading="lazy"/></p>
<p><strong>让他</strong>调小一点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94be9cd40845457fbd63489bc1bf3559~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=JFVpFkDHU%2BUGzrpIMdtZ7%2BV1%2BrQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">4.效果演示</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b8dedf74711414396f986c98ccc705f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lq_5YWD56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766969664&amp;x-signature=nPwt6IkztU907ZYc1FDxBxAj1ME%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">5.体验感受</h2>
<ul>
<li><strong>全程</strong>零代码、零编辑场景，全自动生成游戏(有引擎的)，虽然游戏简单，后面会尝试生成更复杂的游戏，欢迎关注。</li>
<li><strong>PinK</strong>并不只是代码编辑器，全程可以不需要写代码和打开<strong>Creator</strong>(笔者好奇自己打开)，根据界面布局推断，<strong>Creator</strong>的功能终将全部移植到<strong>PinK</strong>。</li>
<li><strong>由于</strong>只是<code>alpha</code>测试，看群里反馈的问题,<code>BUG</code>也不少，笔者觉得可以理解，需要点时间让它飞一会。</li>
<li><strong>此外PinK</strong>上手有点难度，一开始看会比较懵，不知道从哪里开始动手。</li>
<li><strong>笔者</strong>尝试用<code>PinK</code>打开旧的项目(Creator3.8.7)，也存在一些问题，都反馈到群里了。</li>
</ul>
<h2 data-id="heading-10">结语</h2>
<p><strong>总的</strong>来说，<code>PinK</code>让笔者眼前一亮，持看好态度，个人看法，轻喷！</p>
<p><strong>小伙伴们</strong>看完后觉得如何？还想笔者测评哪些内容？欢迎来评论区发表看法！</p>
<hr/>
<p><strong>我是"亿元程序员"，一位有着8年游戏行业经验的主程。在游戏开发中，希望能给到您帮助, 也希望通过您能帮助到大家。</strong></p>
<p>AD:笔者线上的小游戏《打螺丝闯关》《贪吃蛇掌机经典》《重力迷宫球》《填色之旅》《方块掌机经典》大家可以自行点击搜索体验。</p>
<p>实不相瞒，想要个<strong>赞</strong>和<strong>爱心</strong>！请把该文章<strong>分享</strong>给你觉得有需要的其他小伙伴。谢谢！</p>
<p>推荐文章：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXLCknL3fJDubec2GW6KLFA" target="_blank" title="https://mp.weixin.qq.com/s/XLCknL3fJDubec2GW6KLFA" ref="nofollow noopener noreferrer">Cocos游戏如何接入安卓穿山甲广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3_VrSld4KnDKY_7hxjSoKg" target="_blank" title="https://mp.weixin.qq.com/s/3_VrSld4KnDKY_7hxjSoKg" ref="nofollow noopener noreferrer">你知道和不知道的微信小游戏常用API整理，赶紧收藏用起来~</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F0Lj24VHJ-pL8z82hHqQLiA" target="_blank" title="https://mp.weixin.qq.com/s/0Lj24VHJ-pL8z82hHqQLiA" ref="nofollow noopener noreferrer">Cocos游戏如何快速接入抖音小游戏广告变现？</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FZ7DusUJA2v1IFZDFtBsueg" target="_blank" title="https://mp.weixin.qq.com/s/Z7DusUJA2v1IFZDFtBsueg" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现割绳子游戏效果</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F3BzzFBzeVAO-a6LPTeFTrA" target="_blank" title="https://mp.weixin.qq.com/s/3BzzFBzeVAO-a6LPTeFTrA" ref="nofollow noopener noreferrer">如何在CocosCreator3.8中实现动态切割模型？</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>