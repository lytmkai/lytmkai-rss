<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[vite-plugin-openapi-ts CLI 使用指南]]></title>    <link>https://juejin.cn/post/7572537221541036047</link>    <guid>https://juejin.cn/post/7572537221541036047</guid>    <pubDate>2025-11-16T07:05:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572537221541036047" data-draft-id="7572534419880263715" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vite-plugin-openapi-ts CLI 使用指南"/> <meta itemprop="keywords" content="前端,Vite"/> <meta itemprop="datePublished" content="2025-11-16T07:05:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="isyuah"/> <meta itemprop="url" content="https://juejin.cn/user/2527090418131764"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vite-plugin-openapi-ts CLI 使用指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2527090418131764/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    isyuah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T07:05:26.000Z" title="Sun Nov 16 2025 07:05:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vite-plugin-openapi-ts CLI 使用指南</h2>
<blockquote>
<p>建议先看插件本体的介绍</p>
</blockquote>
<p>vite-plugin-openapi-ts 除了以 Vite 插件的形式在开发 / 构建阶段自动生成代码外，还提供了一套独立的 <strong>命令行工具（CLI）</strong>。<br/>
CLI 更适合以下场景：</p>
<ul>
<li>在 CI / CD 流水线里，先生成类型和客户端，再进行构建与测试；</li>
<li>在 monorepo 中集中生成，再给多个子应用复用；</li>
<li>本地需要“只生成一次看结果”，不想依赖 Vite 启动过程。</li>
</ul>
<p>下面是这套 CLI 的完整用法说明。</p>
<hr/>
<h3 data-id="heading-1">安装与基础命令</h3>
<p>CLI 入口已经通过 <code>bin</code> 字段绑定为 <code>openapi-ts</code>，安装插件后就可以直接使用：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D vite-plugin-openapi-ts

<span class="hljs-comment"># 本地调用</span>
npx openapi-ts --<span class="hljs-built_in">help</span>
</code></pre>
<p>目前内置的几个核心子命令是：</p>
<ul>
<li><code>openapi-ts generate</code>：从 OpenAPI 规范生成 TypeScript 类型和 API 客户端；</li>
<li><code>openapi-ts clean</code>：清理生成的 <code>schemes.ts</code> / <code>index.ts</code> 以及可选缓存文件；</li>
<li><code>openapi-ts clean-cache</code>：只清理缓存文件 <code>.openapi-cache.json</code>。</li>
</ul>
<p>你也可以使用简写：</p>
<ul>
<li><code>openapi-ts gen</code> 或 <code>openapi-ts g</code> 等价于 <code>openapi-ts generate</code>。</li>
</ul>
<hr/>
<h3 data-id="heading-2">使用 openapi.config.json 进行配置</h3>
<p>CLI 支持从当前工作目录下读取 <code>openapi.config.json</code> 作为默认配置，然后再由命令行参数进行覆盖。</p>
<p>一个典型的 <code>openapi.config.json</code> 示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:8080/v3/api-docs"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://localhost:8080"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"outputDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/openapi"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"enableCache"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"skipTimeout"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"force"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>在有了这个文件之后，你可以直接运行：</p>
<pre><code class="hljs language-bash" lang="bash">npx openapi-ts generate
</code></pre>
<p>此时 CLI 会按如下优先级合并配置：</p>
<ol>
<li>命令行参数（最高优先级）；</li>
<li><code>openapi.config.json</code> 中的字段；</li>
<li>内置默认值（例如 <code>outputDir</code> 默认为 <code>src/openapi</code>）。</li>
</ol>
<p>例如：</p>
<ul>
<li>最终 <code>url</code> 来源：<code>--url</code> &gt; <code>openapi.config.json</code> 中的 <code>url</code>；</li>
<li>最终 <code>baseUrl</code> 来源：<code>--base-url</code> &gt; <code>openapi.config.json.baseUrl</code> &gt;（远程地址时自动从 <code>url</code> 提取）；</li>
<li>最终 <code>outputDir</code> 来源：<code>--output-dir</code> &gt; <code>openapi.config.json.outputDir</code> &gt; 默认值 <code>src/openapi</code>。</li>
</ul>
<p>如果既没有在命令行传 <code>--url</code>，也没有在配置文件里配置 <code>url</code>，CLI 会给出错误提示并退出。</p>
<hr/>
<h3 data-id="heading-3">generate：生成类型和客户端</h3>
<p><code>generate</code> 是 CLI 中最核心的命令，用于根据 OpenAPI 规范生成类型文件和 API 客户端。</p>
<h4 data-id="heading-4">命令参数</h4>
<pre><code class="hljs language-bash" lang="bash">openapi-ts generate \
  --url        &lt;specUrl&gt;   \ <span class="hljs-comment"># OpenAPI 文档地址（JSON 或 YAML）</span>
  --base-url   &lt;baseUrl&gt;   \ <span class="hljs-comment"># API 基础地址，可选</span>
  --output-dir &lt;outputDir&gt; \ <span class="hljs-comment"># 输出目录，默认 src/openapi</span>
  --enable-cache           \ <span class="hljs-comment"># 启用缓存（默认 true）</span>
  --skip-timeout &lt;ms&gt;      \ <span class="hljs-comment"># 跳过超时时间（毫秒）</span>
  --force                    <span class="hljs-comment"># 强制重新生成，忽略缓存</span>
</code></pre>
<p>其中：</p>
<ul>
<li><code>--url</code> / <code>-u</code>：OpenAPI 规范地址，支持 <code>http(s)</code> 和本地文件路径；</li>
<li><code>--base-url</code> / <code>-b</code>：生成客户端时使用的基础地址；
<ul>
<li>如果是远程 <code>http(s)</code> 地址且未显式提供 <code>baseUrl</code>，CLI 会自动尝试从 <code>url</code> 中提取（形如 <code>protocol://host</code>）；</li>
<li>如果是本地文件路径，且未提供 <code>baseUrl</code>，CLI 会提示你必须提供一个 <code>baseUrl</code>（可以写在配置文件中）。</li>
</ul>
</li>
<li><code>--output-dir</code> / <code>-o</code>：生成文件输出目录，默认是 <code>src/openapi</code>；</li>
<li><code>--enable-cache</code> / <code>-c</code>：是否启用缓存，默认开启；缓存文件为 <code>{outputDir}/.openapi-cache.json</code>；</li>
<li><code>--skip-timeout</code> / <code>-t</code>：在启用缓存的情况下，如果与上次生成间隔时间小于该值（毫秒），且 <code>url</code> / <code>baseUrl</code> 未发生改变，则会跳过本次生成；</li>
<li><code>--force</code> / <code>-f</code>：强制重新生成，忽略缓存逻辑。</li>
</ul>
<h4 data-id="heading-5">常见用法示例</h4>
<ol>
<li><strong>完全依赖配置文件：</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">npx openapi-ts generate
</code></pre>
<p>只要在 <code>openapi.config.json</code> 中提供了 <code>url</code>（以及可选的其他字段），就可以这样使用。</p>
<ol start="2">
<li><strong>在配置基础上临时覆盖部分字段：</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">npx openapi-ts generate \
  --url http://localhost:8081/v3/api-docs \
  --force
</code></pre>
<p>这里会覆盖配置文件中的 <code>url</code>，并且强制重新生成（无视缓存）。</p>
<ol start="3">
<li><strong>不使用配置文件，仅命令行参数驱动：</strong></li>
</ol>
<pre><code class="hljs language-bash" lang="bash">npx openapi-ts generate \
  --url ./openapi.yaml \
  --base-url https://api.example.com \
  --output-dir src/openapi
</code></pre>
<p>当 <code>url</code> 是本地文件路径时，<code>baseUrl</code> 必须显式提供（或写在 <code>openapi.config.json</code> 里），否则 CLI 会报错。</p>
<hr/>
<h3 data-id="heading-6">clean：清理生成文件</h3>
<p><code>clean</code> 命令用于清理通过 CLI 或插件生成的文件：</p>
<pre><code class="hljs language-bash" lang="bash">openapi-ts clean \
  --<span class="hljs-built_in">dir</span>         &lt;outputDir&gt; \
  --clean-cache           <span class="hljs-comment"># 是否同时清理缓存，默认 true</span>
</code></pre>
<ul>
<li>默认会删除 <code>{outputDir}/schemes.ts</code> 和 <code>{outputDir}/index.ts</code>；</li>
<li>如果 <code>--clean-cache</code> 为 <code>true</code>（默认），还会删除 <code>{outputDir}/.openapi-cache.json</code>。</li>
</ul>
<p>典型用法：</p>
<pre><code class="hljs language-bash" lang="bash">npx openapi-ts clean
</code></pre>
<p>配合 <code>openapi.config.json</code> 或默认值使用时，会清理 <code>src/openapi</code> 下的生成内容。<br/>
在需要“重新完整生成”或重置生成状态时，这个命令非常有用。</p>
<hr/>
<h3 data-id="heading-7">clean-cache：仅清理缓存</h3>
<p>如果你只想清理缓存文件，而保留已经生成好的类型和客户端，可以使用 <code>clean-cache</code>：</p>
<pre><code class="hljs language-bash" lang="bash">openapi-ts clean-cache --<span class="hljs-built_in">dir</span> src/openapi
</code></pre>
<p>这条命令只会删除指定目录下的 <code>.openapi-cache.json</code>，不会影响已有的 <code>schemes.ts</code> 和 <code>index.ts</code>。</p>
<hr/>
<h3 data-id="heading-8">在 npm scripts / CI 中使用</h3>
<p>推荐把 CLI 命令封装到 <code>package.json</code> 里，方便团队成员统一使用：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"openapi:gen"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"openapi-ts generate"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"openapi:clean"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"openapi-ts clean"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"openapi:clean-cache"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"openapi-ts clean-cache"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后在命令行中直接执行：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm openapi:gen
</code></pre>
<p>在 CI 场景里，可以在构建前插入一段：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm openapi:gen
pnpm build
</code></pre>
<p>这样可以确保生成的类型与服务端 OpenAPI 规范保持最新，从而在前端构建阶段就发现接口不兼容的问题。</p>
<hr/>
<h3 data-id="heading-9">小结</h3>
<ul>
<li>CLI 适合在 Vite 之外的场景使用，例如 CI、独立脚本或 monorepo 根目录；</li>
<li>通过 <code>openapi.config.json</code> + CLI 参数覆盖的机制，可以兼顾“统一配置”和“局部灵活调整”；</li>
<li><code>generate</code> 负责生成，<code>clean</code> / <code>clean-cache</code> 负责回收和重置，搭配使用可以构建出一套比较完整的接口代码生成流程。</li>
</ul>
<p>在更完整的项目介绍 / 推荐文章中，你可以将本文件的内容作为“CLI 使用章节”直接嵌入；如果你只想单独介绍命令行用法，也可以单独发布这一篇。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Android】模板化解决复杂场景的滑动冲突问题]]></title>    <link>https://juejin.cn/post/7572793505899757619</link>    <guid>https://juejin.cn/post/7572793505899757619</guid>    <pubDate>2025-11-16T07:57:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572793505899757619" data-draft-id="7572539461478285355" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Android】模板化解决复杂场景的滑动冲突问题"/> <meta itemprop="keywords" content="Java,Android"/> <meta itemprop="datePublished" content="2025-11-16T07:57:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Propeller"/> <meta itemprop="url" content="https://juejin.cn/user/4311645702612554"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Android】模板化解决复杂场景的滑动冲突问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4311645702612554/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Propeller
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T07:57:02.000Z" title="Sun Nov 16 2025 07:57:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>仿写项目的业务场景刚好覆盖有两种复杂滑动冲突场景：</p>
<p>Horizontal ViewPager2 嵌套 Vertical RecyclerView (<strong>OuterRecyclerView</strong>) 嵌套 Horizontal RecyclerView (<strong>InnerRecyclerView</strong>) 的横纵横场景和</p>
<p>Horizontal ViewPager2 嵌套 Horizontal ViewPager2 (<strong>InnerViewPager</strong>) 嵌套 Vertical RecyclerView 的横横纵场景。</p>
<p>同时要让内层的 InnerRecyclerView 和 InnerViewPager 在横向滑动方向尚可滑动接管事件，不可滑动时将事件交给外层的 Horizontal ViewPager2。</p>
<h2 data-id="heading-0">背景原理</h2>
<p>我们知道 MotionEvent 事件传递是由 DecorView 到 ViewGroup 再到 View，完整事件序列必定由 MotionEvent.DOWN 开始，ViewGroup 在事件传递过程中会判断是否拦截该事件序列，如果 DOWN 被拦截则该 ViewGroup 会完全接管后续所有事件。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> intercepted;
<span class="hljs-keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN
        || mFirstTouchTarget != <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">disallowIntercept</span> <span class="hljs-operator">=</span> (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!disallowIntercept) {
        intercepted = onInterceptTouchEvent(ev);
        ev.setAction(action);
    } <span class="hljs-keyword">else</span> {
        intercepted = <span class="hljs-literal">false</span>;
    }
} <span class="hljs-keyword">else</span> {
    intercepted = <span class="hljs-literal">true</span>;
}
</code></pre>
<p>由外层条件语句知，child 的 requestDisallowInterceptTouchEvent 方法无法影响 ViewGroup 对 DOWN 事件的拦截处理，所以大部分情况 ViewGroup 派生类都不会拦截 DOWN 事件，通常逻辑是让 child 消费 DOWN 事件，再根据后续 MOVE 方向判断是否拦截。</p>
<h3 data-id="heading-1">requestDisallowInterceptTouchEvent</h3>
<p>该方法是 child 发送给父容器的请求，参数的布尔值表示是否期望父容器拦截事件，父容器接收到请求后会将 FLAG_DISALLOW_INTERCELT 标志位设置为 1，内部的 disallowIntercept 字段进而得到 true。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDisallowInterceptTouchEvent</span><span class="hljs-params">(<span class="hljs-type">boolean</span> disallowIntercept)</span> {
    <span class="hljs-keyword">if</span> (mParent != <span class="hljs-literal">null</span>) {
        mParent.requestDisallowInterceptTouchEvent(disallowIntercept);
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDisallowInterceptTouchEvent</span><span class="hljs-params">(<span class="hljs-type">boolean</span> disallowIntercept)</span> {

    <span class="hljs-keyword">if</span> (disallowIntercept == ((mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="hljs-number">0</span>)) {
        <span class="hljs-comment">// We're already in this state, assume our ancestors are too</span>
<span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (disallowIntercept) {
        mGroupFlags |= FLAG_DISALLOW_INTERCEPT;
    } <span class="hljs-keyword">else</span> {
        mGroupFlags &amp;= ~FLAG_DISALLOW_INTERCEPT;
    }

    <span class="hljs-comment">// Pass it up to our parent</span>
<span class="hljs-keyword">if</span> (mParent != <span class="hljs-literal">null</span>) {
        mParent.requestDisallowInterceptTouchEvent(disallowIntercept);
    }
} <span class="hljs-comment">/* mGroupFlags可以看成标记位大集合 */</span>
</code></pre>
<p>所以解决滑动冲突的方法很明确：父布局不要拦截向下传递的 DOWN 事件，让 child 在 DOWN 事件禁止父布局拦截事件，根据后续 MOVE 事件的滑动方向和 child 本身的情况判断是否允许父布局拦截事件，在 CANCEL 或 UP 事件恢复原状。</p>
<h2 data-id="heading-2">横纵横</h2>
<p>InnerRecyclerView 判断是否为横向滑动且滑动方向有内容在屏幕外，是则由自己接管，否则交给 ViewPager2，这里利用 View 树的特点冒泡获得以 ViewPager2 为父容器的 View，对该 View 进行 requestDisallowInterceptTouchEvent，隔离了 OuterRecyclerView 和 ViewPager2。</p>
<p>如果为纵向滑动则设置 requestDisallowInterceptTouchEvent(false)，让 OuterRecyclerView 来禁止父容器拦截，保证了 InnerRecyclerView 和 OuterRecyclerView 互不冲突。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InnerRecyclerView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> x0, y0;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> touchSlop;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InnerRecyclerView</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InnerRecyclerView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InnerRecyclerView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent e)</span> {
        <span class="hljs-type">ViewGroup</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>;
        <span class="hljs-keyword">while</span> (v != <span class="hljs-literal">null</span> &amp;&amp; !(v.getParent() <span class="hljs-keyword">instanceof</span> ViewPager2)) {
            v = (ViewGroup) v.getParent();
        }

        <span class="hljs-keyword">switch</span> (e.getActionMasked()) {
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                x0 = e.getX();
                y0 = e.getY();
                v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
                <span class="hljs-type">double</span> <span class="hljs-variable">dx</span> <span class="hljs-operator">=</span> e.getX() - x0;
                <span class="hljs-type">double</span> <span class="hljs-variable">dy</span> <span class="hljs-operator">=</span> e.getY() - y0;

                <span class="hljs-keyword">if</span> (Math.abs(dx) &lt; touchSlop &amp;&amp; Math.abs(dy) &lt; touchSlop) <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">if</span> (Math.abs(dx) &gt; Math.abs(dy)) {
                    <span class="hljs-keyword">if</span> (dx &gt; <span class="hljs-number">0</span>) {
                        <span class="hljs-keyword">if</span> (!canScrollHorizontally(-<span class="hljs-number">1</span>)) {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                        } <span class="hljs-keyword">else</span> {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                        }
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span> (!canScrollHorizontally(<span class="hljs-number">1</span>)) {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                        } <span class="hljs-keyword">else</span> {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                        }
                    }
                } <span class="hljs-keyword">else</span> {
                    v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_CANCEL:
                v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onInterceptTouchEvent(e);
    }
}
</code></pre>
<p>OuterRecyclerView 判断是否为纵向滑动，是则由自己接管，否则交给 ViewPager2，InnerRecycler 和 OuterRecyclerView 的拦截决策均只影响 ViewPager2 是否拦截，所以保证 ViewPager2 和内层整体互不冲突，进而解决横纵横方向的滑动冲突。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OuterRecyclerView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> x0, y0;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> touchSlop;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OuterRecyclerView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OuterRecyclerView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OuterRecyclerView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@Nullable</span> AttributeSet attrs, <span class="hljs-type">int</span> defStyleAttr)</span> {
        <span class="hljs-built_in">super</span>(context, attrs, defStyleAttr);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent ev)</span> {
        <span class="hljs-keyword">switch</span> (ev.getAction()) {
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                x0 = ev.getX();
                y0 = ev.getY();
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
                <span class="hljs-type">double</span> <span class="hljs-variable">dx</span> <span class="hljs-operator">=</span> ev.getX() - x0;
                <span class="hljs-type">double</span> <span class="hljs-variable">dy</span> <span class="hljs-operator">=</span> ev.getY() - y0;

                <span class="hljs-keyword">if</span> (Math.abs(dx) &lt; touchSlop &amp;&amp; Math.abs(dy) &lt; touchSlop) <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">if</span> (Math.abs(dy) &gt; Math.abs(dx)) {
                    getParent().requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                } <span class="hljs-keyword">else</span> getParent().requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_CANCEL:
                getParent().requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onInterceptTouchEvent(ev);
    }
}
</code></pre>
<h2 data-id="heading-3">横横纵</h2>
<p>因为 ViewPager2 是 final 类，无法通过重写 onInterceptTouchEvent 方法解决冲突，换种思路想，我们可以用 FrameLayout 包裹 InnerPager2，重写 FrameLayout 的 onInterceptTouchEvent 方法来解决，其内部逻辑和横纵横的 InnerRecyclerView 类似。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InnerViewPagerContainer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">FrameLayout</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> touchSlop;
    <span class="hljs-keyword">private</span> <span class="hljs-type">float</span> startX, startY;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InnerViewPagerContainer</span><span class="hljs-params">(Context context)</span> {
        <span class="hljs-built_in">super</span>(context);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InnerViewPagerContainer</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> {
        <span class="hljs-built_in">super</span>(context, attrs);
        touchSlop = ViewConfiguration.get(context).getScaledTouchSlop();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onInterceptTouchEvent</span><span class="hljs-params">(MotionEvent e)</span> {
        <span class="hljs-type">ViewGroup</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>;
        <span class="hljs-keyword">while</span> (v != <span class="hljs-literal">null</span> &amp;&amp; !(v.getParent() <span class="hljs-keyword">instanceof</span> ViewPager2)) {
            v = (ViewGroup) v.getParent();
        }

        <span class="hljs-keyword">switch</span> (e.getActionMasked()) {
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_DOWN:
                startX = e.getX();
                startY = e.getY();
                v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> MotionEvent.ACTION_MOVE:
                <span class="hljs-type">float</span> <span class="hljs-variable">dx</span> <span class="hljs-operator">=</span> e.getX() - startX;
                <span class="hljs-type">float</span> <span class="hljs-variable">dy</span> <span class="hljs-operator">=</span> e.getY() - startY;

                <span class="hljs-keyword">if</span> (Math.abs(dx) &lt; touchSlop &amp;&amp; Math.abs(dy) &lt; touchSlop) <span class="hljs-keyword">break</span>;

                <span class="hljs-keyword">if</span> (Math.abs(dx) &gt; Math.abs(dy)) {
                    <span class="hljs-keyword">if</span> (dx &gt; <span class="hljs-number">0</span>) {
                        <span class="hljs-keyword">if</span> (!getChildAt(<span class="hljs-number">0</span>).canScrollHorizontally(-<span class="hljs-number">1</span>)) {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                        } <span class="hljs-keyword">else</span> {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                        }
                    } <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span> (!getChildAt(<span class="hljs-number">0</span>).canScrollHorizontally(<span class="hljs-number">1</span>)) {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                        } <span class="hljs-keyword">else</span> {
                            v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">true</span>);
                        }
                    }
                } <span class="hljs-keyword">else</span> {
                    v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                }
                <span class="hljs-keyword">break</span>;

            <span class="hljs-keyword">case</span> MotionEvent.ACTION_UP:
            <span class="hljs-keyword">case</span> MotionEvent.ACTION_CANCEL:
                v.requestDisallowInterceptTouchEvent(<span class="hljs-literal">false</span>);
                <span class="hljs-keyword">break</span>;
        }

        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onInterceptTouchEvent(e);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么每个团队都需要一套私有 Context 工程]]></title>    <link>https://juejin.cn/post/7572781559767302194</link>    <guid>https://juejin.cn/post/7572781559767302194</guid>    <pubDate>2025-11-16T08:27:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572781559767302194" data-draft-id="7572749797468864521" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么每个团队都需要一套私有 Context 工程"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-16T08:27:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Vadaski"/> <meta itemprop="url" content="https://juejin.cn/user/1767670428477015"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么每个团队都需要一套私有 Context 工程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767670428477015/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Vadaski
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T08:27:59.000Z" title="Sun Nov 16 2025 08:27:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>如果你已经在工作里频繁用大模型，却总觉得“偶尔很惊艳，大多数时候又累又不稳”，那这篇文章也许值得你花十分钟读完：我会从成本结构、IN→推理→OUT 这个最小单元，以及通用工具在复杂业务中的上限出发，说明一件事——只要你为自己的业务建立一套私有的 Context 工程实践，让构造好 IN 这件事变得有章可循、可复用、可演进，同一批人做同样的事，效率出现 3–5 倍的质变，甚至更高。
本文上篇只回答一个问题：<strong>为什么要做私有 Context 工程</strong>；下篇再谈“应该怎么做”。</p>
<h2 data-id="heading-1">一个直观感受：模型很强，但效率为什么没起来？</h2>
<p>如果你已经在工作中频繁使用大模型，大概率会有一种矛盾体验：</p>
<ul>
<li>它有时候能给出非常惊艳的结果；</li>
<li>但真正放到严肃工作里，要让它持续靠谱，往往需要你花很多时间“喂信息、讲背景、补细节、纠正误解”。</li>
</ul>
<p>我的直观感受是：</p>
<ul>
<li>当只是“临时问两句”的时候，工具很好用；</li>
<li>当指望它跟我一起完成一个完整的产品迭代、系统改造、调研分析时，<strong>上下文准备本身变成了一件很累的事</strong>。</li>
</ul>
<p>反过来，当我开始系统化地思考“到底该给它什么、以什么结构给”，并针对自己的业务搭了一些固定的 Context 模板和整理方式之后：</p>
<ul>
<li>同样的事情，我的效率大概稳定提高在 <strong>3–5倍</strong>；</li>
<li>重点不在于模型变聪明了，而在于：<strong>我和它之间的信息通道变得更合理了</strong>。</li>
</ul>
<p>这背后指向的是一件更底层的事：<strong>智力的成本结构已经被悄悄改写了。</strong></p>
<h2 data-id="heading-2">智力的工业化：成本结构的巨变</h2>
<p>过去，复杂问题的核心成本在于“人脑”：</p>
<ul>
<li>能做泛化推理的只有人；</li>
<li>知识无法低成本复制，只能靠培训、会议、协作一点点传递；</li>
<li>所以绝大多数组织的主要成本，都压在“找人 + 用人 + 协调人”上。</li>
</ul>
<p>大模型把这件事翻转了：</p>
<ul>
<li>推理能力开始像“水电网”一样可以按量付费；</li>
<li>同一份模型能力可以被无数任务重复调用；</li>
<li>我们第一次可以把“部分智力劳动”视为一种基础设施。</li>
</ul>
<p>如果只看账单，你会发现真正开始变贵的不是“推理”，而是：</p>
<ul>
<li>为每一次推理<br/>
<strong>准备、选择、组织、筛选、压缩信息</strong> 的过程。</li>
</ul>
<p>用更直白的话说：</p>
<blockquote>
<p>**聪明本身变便宜了，<br/>
但是这个聪明的人没有记忆， 他需要我们一次又一次的告诉他背景信息， 如果给他说的是错的，那我们一定拿不到好的结果。</p>
</blockquote>
<p>如果工程方法论不跟着这波成本结构的变化调整，我们就会卡在一个奇怪的位置：</p>
<ul>
<li>理论上工具越来越强；</li>
<li>实际上很快就跑出了一堆屎山，没有人能够继续维护下去。</li>
</ul>
<h2 data-id="heading-3">问题解决的最小单元：IN → 推理 → OUT</h2>
<p>不管是写代码、写 PRD、做运营方案，还是做市场分析，本质上都可以压缩成一个最小单元：</p>
<p>[ 输入（IN）→ 推理 → 输出（OUT） ]</p>
<ul>
<li><strong>IN</strong>：这一步你给到模型的一切东西：目标、约束、背景、相关事实、历史决策、示例……</li>
<li><strong>推理</strong>：模型基于这些信息做的理解、拆解、规划、生成。</li>
<li><strong>OUT</strong>：中间结果或最终结果：代码、设计、方案、报告、决策建议等。</li>
</ul>
<p>在今天的模型能力水平下，有两个判断越来越清晰：</p>
<ol>
<li>
<p><strong>推理本身已经不像过去那样稀缺</strong><br/>
在很多任务上，它的整体表现已经超过了普通人类的平均水准。</p>
</li>
<li>
<p><strong>绝大多数失败来自 IN，而不是推理阶段</strong></p>
<ul>
<li>该给的没给：关键前提、重要历史被彻底遗漏；</li>
<li>不该给的给太多：大量噪音占满了有限的注意力；</li>
<li>条件说不清：哪些是强约束、哪些只是偏好，模型分不清。</li>
</ul>
</li>
</ol>
<p>如果再加上前面那句“工程信念”：</p>
<ul>
<li>我们相信：复杂问题可以被拆解为足够多的小问题；</li>
<li>我们也相信：对这些小问题，IN → 推理 → OUT 的最小单元是成立的；</li>
</ul>
<p>那么就可以做出这样一个推演：</p>
<blockquote>
<p><strong>只要我们能持续构造出足够好的 IN，<br/>
理论上，AI 可以被用来完成几乎一切任务。</strong></p>
</blockquote>
<p>这不是一句励志口号，而是一个关于<strong>成本结构 + 工程拆解 + 最小单元</strong>的推理结果。</p>
<h2 data-id="heading-4">工具层的“眼花缭乱”，本质上都是在帮你构造 IN</h2>
<p>这两年围绕大模型已经涌现了大量“辅助工具”和“方法论”，比如：</p>
<ul>
<li>各种规范流程工具（如 spec-kit 等）；</li>
<li>结构化思考/拆解方法（如 bmad-method 等）；</li>
<li>claude code 的 skills / mcp 能力集合；</li>
</ul>
<p>如果只盯着这些工具的名字和形态，很容易有一种“眼花缭乱”的感觉：</p>
<ul>
<li>今天是 A 套件，明天是 B 方法论，后天又冒出一个 C 平台；</li>
<li>似乎不跟一跟最新的工具，就会落伍。</li>
</ul>
<p>但从 <strong>IN → 推理 → OUT</strong> 的角度往回看，这些东西有一个共同的本质：</p>
<blockquote>
<p><strong>它们无一例外，都是在帮你构造一个“更好、更确定的 IN”。</strong></p>
</blockquote>
<p>把脑子里的想法变成真正可交付的结果，本身就是一个“解压缩”的过程：</p>
<ul>
<li>一开始只是模糊直觉和零散想法；</li>
<li>逐步被压成规格更清晰的描述、决策、方案、实现；</li>
<li>在过程中，需要不断对齐（alignment）、修正、补充，最后才收敛为一个可以交付的 OUT。</li>
</ul>
<p>这些工具做的事情其实是：</p>
<ul>
<li>帮你在解压缩的不同阶段，用更结构化的方式表达意图和约束；</li>
<li>在你和模型之间建立更稳定的“对齐机制”；</li>
<li>减少“说不清、说不全、说错了”的概率，从而提高整个链路的确定性。</li>
</ul>
<p>所以，从私有 Context 工程的视角看：</p>
<ul>
<li>
<p>工具自然会不断迭代更新；</p>
</li>
<li>
<p>但只要 <strong>IN → 推理 → OUT</strong> 这个最小单元还成立，这些工具的角色就可以被视为：</p>
<ul>
<li><strong>在不同层次上协助我们构造更好的 IN，减少解压缩过程中的不确定性。</strong></li>
</ul>
</li>
</ul>
<h2 data-id="heading-5">通用上下文工程的边界：面对未知世界的必然策略</h2>
<p>为了帮用户构造更好的 IN，业界提出了“上下文工程”：</p>
<ul>
<li>如何组织系统提示；</li>
<li>如何规划工具；</li>
<li>如何用检索把外部知识接进来；</li>
<li>如何通过压缩和结构化笔记维持长任务的连贯性。</li>
</ul>
<p>这些方法非常有价值，但有一个经常被忽略的前提：</p>
<blockquote>
<p>它们大多站在  <strong>“通用工具提供方”</strong>  的视角。</p>
</blockquote>
<p>在这个视角下，世界是这样的：</p>
<ul>
<li>他们不知道每一个客户的业务结构；</li>
<li>不知道你的代码 / 流程 / 术语；</li>
<li>不知道你有哪些隐含红线和组织约束。</li>
</ul>
<p>于是，他们只能假设：<strong>所有工程都是“未知工程”</strong> 。<br/>
在这种情况下，唯一现实的策略就是：</p>
<ul>
<li>尽可能增强 Search 能力；</li>
<li>提供尽可能多的上下文入口（RAG、MCP、各种工具和技能）；</li>
<li>让模型在运行时自己去探索、自己去拼接、自己去猜。</li>
</ul>
<p>在小场景、简单场景下，这些手段效果很好。<br/>
但一旦业务复杂度上来，你会越来越明显地感受到它们的上限：</p>
<ul>
<li>搜索结果太多或太少，窗口很快被吃满；</li>
<li>复杂流程和规范，很难通过一次性的 prompt 注入模型脑中；</li>
<li>工程越大、上下游越多，“让模型自己去找路”这件事就越不可靠。</li>
</ul>
<p>它们之所以如此，是因为：</p>
<blockquote>
<p><strong>通用上下文工程面对的是“一个所有细节都未知的世界”。<br/>
在这样的世界里，Search + 动态拼接是唯一的通用策略。</strong></p>
</blockquote>
<h2 data-id="heading-6">当这是“我的业务”时：Context 不该继续被当作未知量</h2>
<p>而在一个具体业务团队内部，情况完全不同。</p>
<p>你并不是面对一个完全未知的世界，你知道很多事情：</p>
<ul>
<li>你的业务边界是什么；</li>
<li>关键流程、常见套路、固定步骤有哪些；</li>
<li>哪些规范是红线，哪些是建议；</li>
<li>哪些历史决策、复盘和踩坑记录，值得被长期记住。</li>
</ul>
<p>换句话说，在你的团队里：</p>
<blockquote>
<p><strong>Context 不是一团雾，而是一套可以被设计、被维护、被演进的结构。</strong></p>
</blockquote>
<p>这时还继续完全按照通用范式来用 AI——<br/>
每次都从零开始拼凑上下文，让模型去黑箱式地 Search 和拼接——<br/>
就有点像：</p>
<ul>
<li>你对自己的公司组织结构和流程非常熟；</li>
<li>却每次让一个新人自己从公司大门开始乱逛，希望他能摸索出正确路径。</li>
</ul>
<p><strong>私有 Context 工程实践</strong>想做的，是把这件事反过来：</p>
<ul>
<li>承认我们对自己业务的“先验知识”是宝贵资产；</li>
<li>把这些先验，通过工程方式固化成一整套上下文管理实践；</li>
<li>让模型不再在未经整理的“原始世界”里迷路，而是在这套实践之上工作。</li>
</ul>
<p>它关心的不仅是：</p>
<ul>
<li>“帮我写函数、修 bug”。</li>
</ul>
<p>它关心的是：</p>
<ul>
<li>做一次新业务，应该自动带出哪些历史事实与流程约束；</li>
<li>做一个新活动，应该自动提醒哪些风险点和必经步骤；</li>
<li>做一次分析，应该自动接上哪些指标、报告和过往尝试。</li>
</ul>
<h2 data-id="heading-7">“上下文架构师”：那个重构 IN 的人</h2>
<p>当 Context 被当成工程对象，就会自然冒出来一个新角色：</p>
<blockquote>
<p><strong>上下文架构师（Context Architect）</strong></p>
</blockquote>
<p>这个角色的特点是：</p>
<ul>
<li>
<p><strong>既懂业务，也懂怎么维护上下文</strong><br/>
他知道业务是怎么跑的，也知道什么东西应该长期存在于“可用的 Context 集合”里。</p>
</li>
<li>
<p><strong>工作方式是“先跑业务，再抽象，再反哺 AI”</strong><br/>
一条典型闭环大致是：</p>
<ol>
<li>从真实业务出发，选一个最小闭环，把它先跑到“可用”；</li>
<li>从这个闭环中反推：哪些信息、哪些步骤、哪些约束是可以抽象出来复用的；</li>
<li>把这些抽象整理成结构化的规范和约束，让 AI 在下一次任务中按它们来行动；</li>
<li>在实际执行中观察偏差，微调约束和上下文结构，直到 AI 能长期稳定地按这套方式完成任务。</li>
</ol>
</li>
<li>
<p><strong>更关注“过程是否可复用”，而不仅是某次结果是否凑巧正确</strong><br/>
他的目标不是“这次输出对了就行”，<br/>
而是让这套 Context 设计本身变得可迁移、可复制、可迭代。</p>
</li>
<li>
<p><strong>需要设计一套“像文件系统一样好用的上下文存储结构”</strong><br/>
目标很直接：<br/>
让任何一个业务同学，在开始一件新事之前，可以：</p>
<ul>
<li>一两步拉出这个任务必需的上下文模块；</li>
<li>再补充一下当下特定目标；<br/>
系统就能为模型构造出一份质量足够高的 IN，而不需要每次从头拼凑。</li>
</ul>
</li>
</ul>
<p>在这个意义上，<strong>上下文架构师就是那个重构 IN 的人</strong>。<br/>
他负责的，不是单次产出，而是整个团队未来许多次产出的“上限”。</p>
<h2 data-id="heading-8">写在最后：为什么这是一个“必选项”？</h2>
<p>把上述逻辑压缩成一条链：</p>
<ul>
<li>智力被工业化生产之后，真正昂贵的变成了“构造上下文”；</li>
<li>一切任务都可以看成 IN → 推理 → OUT，当前重要的问题是：<strong>我们用什么方式来构造 IN</strong>；</li>
<li>通用上下文工程面对的是一个未知世界，只能依赖 Search + 动态拼接，在复杂业务里会遇到天花板；</li>
<li>对具体组织而言，Context 是可以被设计、被维护、被演进的资产；</li>
<li>为自己的业务建立一套“私有 Context 工程实践”，不是锦上添花，而是在新的成本结构下 <strong>能否真正用好 AI 的前提条件</strong>；</li>
<li>上下文架构师，则是这套实践的设计者和守门人，通过约束、流程和存储结构，把“与 AI 协作”这件事变成可工程化、可积累的事情。</li>
</ul>
<p>这一篇到这里，我们只回答了一个问题：</p>
<blockquote>
<p>在今天的环境里，<strong>为什么私有 Context 工程是必然会被提出、并且迟早会有人去做的事情</strong>。</p>
</blockquote>
<p>在下篇里，我们可以进一步聊聊私有上下文工程如何落地。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LLM 交互的“省钱”新姿势：JSON 已死，TOON 当立]]></title>    <link>https://juejin.cn/post/7572453554331009024</link>    <guid>https://juejin.cn/post/7572453554331009024</guid>    <pubDate>2025-11-15T03:38:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572453554331009024" data-draft-id="7572408522438344739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LLM 交互的“省钱”新姿势：JSON 已死，TOON 当立"/> <meta itemprop="keywords" content="后端,AIGC"/> <meta itemprop="datePublished" content="2025-11-15T03:38:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小奏技术"/> <meta itemprop="url" content="https://juejin.cn/user/395479918848487"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LLM 交互的“省钱”新姿势：JSON 已死，TOON 当立
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479918848487/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小奏技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T03:38:16.000Z" title="Sat Nov 15 2025 03:38:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>嘿，兄弟！你是不是也感觉 AI 越来越香，但 Token 账单也越来越“烫”？ 💸</p>
<p><code>GPT-4o</code>、<code>Kimi</code> 这些模型的上下文窗口动不动就几十万、上百万 <code>Token</code>，我们恨不得把整个项目都扔进去。但冷静下来看看账单... ... 哇哦</p>
<p><code>LLM</code> 的 <code>Token</code> 每一分都是真金白银啊！</p>
<p>当大家都在想办法优化模型、优化算法时，有没有想过，我们每天都在用的 <code>JSON</code>，可能就是那个“背刺”我们 Token 费用的“内鬼”？</p>
<p>JSON 虽好，但它实在是... ... 太！啰！嗦！了！</p>
<h2 data-id="heading-1">“内鬼”现形：JSON 到底有多浪费</h2>
<p>在 LLM 的世界里，Token 就是钱。表达同样的信息，谁用的 Token 少，谁就是赢家。</p>
<p>不信？我们直接上例子，用事实说话。</p>
<p>假设我们有这样一个简单的用户列表：</p>
<h3 data-id="heading-2">1. 冗长的“老大哥”：JSON</h3>
<p>标准的 JSON 格式，充满了大括号、双引号和逗号，简直是 Token 杀手。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Alice"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">30</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Bob"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">25</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Charlie"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">35</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>（数数看，光是 name 这个词就重复了 3 遍！）</p>
<h3 data-id="heading-3">2. “小清新”但还不够：YAML</h3>
<p>YAML 确实清爽了不少，用缩进代替了括号，也去掉了双引号。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">Alice</span>
  <span class="hljs-attr">age:</span> <span class="hljs-number">30</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">Bob</span>
  <span class="hljs-attr">age:</span> <span class="hljs-number">25</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">Charlie</span>
  <span class="hljs-attr">age:</span> <span class="hljs-number">35</span>
</code></pre>
<p>嗯，进步了，但不多。id, name, age 这些键名还是在无情地重复。</p>
<h3 data-id="heading-4">3. “抠门”的王者：TOON 登场！</h3>
<p>TOON （Token-Oriented Object Notation）闪亮登场，它用了一种近乎“变态”的方式来压缩信息：</p>
<pre><code class="hljs language-TOON" lang="TOON">[3]{id,name,age}:
  1,Alice,30
  2,Bob,25
  3,Charlie,35
</code></pre>
<p>看明白了吗？[3] 表示有3个对象，{id,name,age} 只定义了一次“表头”，后面的数据就像 CSV 一样紧凑排列。</p>
<p>没有对比就没有伤害！ 同样的数据，<code>TOON</code> 的 <code>Token</code> 占用量简直是“骨折价”！</p>
<h2 data-id="heading-5">啥是 TOON？为 LLM 而生的“省钱利器”</h2>
<p><code>TOON</code>（面向 Token 的对象表示法）就是这么一个专为 LLM 提示词而生的、紧凑且人类可读的数据格式。</p>
<p>它能表示和 <code>JSON</code> 一模一样的对象、数组和数据类型，但它的语法就是为了最小化 Token 使用而设计的。</p>
<p>你可以把它理解为 <code>YAML</code> 的嵌套结构 +<code> CSV</code> 的表格布局 = <code>TOON</code></p>
<p>TOON 最擅长处理的场景，就是我们最常见的**“结构一致的对象数组”**。在实现 CSV 般紧凑的同时，它又提供了清晰的结构信息（{key1, key2}:），帮助 LLM 更可靠地解析和验证数据。</p>
<blockquote>
<p>注意： TOON 并非银弹。如果你的数据是深度嵌套或结构极其不统一的，那 JSON 可能还是老老实实的选择。但在“对象数组”这个 LLM 最常见的场景下，TOON 简直无敌。</p>
</blockquote>
<h2 data-id="heading-6">数据为证：TOON 到底有多能打？</h2>
<p>光说不练假把式。<code>Chase Adams</code> 大佬做了一组非常直观的基准测试，对比了 <code>JSON</code>、<code>YAML</code>、<code>TOON</code> 和 <code>CSV</code> 的 <code>Token</code> 效率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fb85506e00a48b19fe5304bcfd16793~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5aWP5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763782696&amp;x-signature=hPM7corj2AoLxlSEq%2BZ16r7lJfQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12f9a5eaf8104b99bbe50a23c0c26149~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5aWP5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763782696&amp;x-signature=Q8OVpSc4uu1YqOfj6VTa3kUyXc4%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>基准测试链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.curiouslychase.com%2Fplayground%2Fformat-tokenization-exploration" target="_blank" title="https://www.curiouslychase.com/playground/format-tokenization-exploration" ref="nofollow noopener noreferrer">www.curiouslychase.com/playground/…</a></p>
</blockquote>
<p>结论一目了然：</p>
<p><code>CSV</code> 是 <code>Token</code> 效率的“天花板”，但它无法表示嵌套结构，而且没有元数据，LLM 很容易“读歪”。</p>
<p><code>TOON</code> 稳坐第二把交椅，效率直逼 CSV，但它保留了完整的结构信息。</p>
<p>J<code>SON</code> 和 <code>YAML</code>... ... 两位老大哥，在 <code>Token</code> 效率上被 <code>TOON</code> 吊打。</p>
<h2 data-id="heading-7">如何在 LLM 中“无痛”用上 TOON？</h2>
<p>你可能会想：“哇，这么牛？那我岂不是要重构整个系统？”</p>
<p>完全不用</p>
<p>官方推荐的架构是这样的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cc3d269124e4fb983ca51c898a65ab1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5aWP5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763782696&amp;x-signature=TeXTKGnpbLsqNdwbD5tpA%2B9zyM8%3D" alt="" loading="lazy"/></p>
<p>看懂了吗？<code>TOON</code> 只是一个**“转换层”**。</p>
<p>你的系统内部，该用 <code>JSON</code> 还是用 <code>JSON</code>，啥也不用改。</p>
<p>在调用 <code>LLM</code> 之前，你只需加一个编码步骤，把 <code>JSON</code> 编码（Encode） 成 <code>TOON</code> 格式再发送。</p>
<p><code>LLM</code> 返回 <code>TOON</code> 格式的数据后，你再解码（Decode） 成 <code>JSON</code> 给系统用。</p>
<p>你就把它当成一个“中间件”，在和 <code>LLM</code> 交互的“最后一公里”上帮你省钱</p>
<h2 data-id="heading-8">别再浪费 Token 了！</h2>
<p>在 <code>LLM</code> 时代，<code>Token</code> 效率就是核心竞争力。</p>
<p><code>JSON</code> 是一个伟大的格式，但在 <code>LLM</code> 交互这个新场景下，它显得既臃肿又昂贵。</p>
<p><code>TOON</code> 提供了一个完美的替代方案：它在保留 <code>JSON</code> 完整表达能力的同时，实现了接近 <code>CSV</code> 的 <code>Token</code> 效率。</p>
<p>如果你还在为高昂的 <code>LLM Token</code> 费用而头疼，如果你还在忍受 <code>JSON</code> 带来的冗余，那么，是时候给你的系统“升个舱”了</p>
<h2 data-id="heading-9">参考</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftoon-format%2Ftoon" target="_blank" title="https://github.com/toon-format/toon" ref="nofollow noopener noreferrer">github.com/toon-format…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.curiouslychase.com%2Fplayground%2Fformat-tokenization-exploration" target="_blank" title="https://www.curiouslychase.com/playground/format-tokenization-exploration" ref="nofollow noopener noreferrer">www.curiouslychase.com/playground/…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[地图引擎性能优化：解决3DTiles加载痛点的六大核心策略]]></title>    <link>https://juejin.cn/post/7572537221541052431</link>    <guid>https://juejin.cn/post/7572537221541052431</guid>    <pubDate>2025-11-16T07:20:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572537221541052431" data-draft-id="7572207610495041570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="地图引擎性能优化：解决3DTiles加载痛点的六大核心策略"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-16T07:20:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            地图引擎性能优化：解决3DTiles加载痛点的六大核心策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T07:20:34.000Z" title="Sun Nov 16 2025 07:20:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>实景三维应用落地绕不开的一个问题就是：<strong>如何高性能加载大规模倾斜数据？</strong></p>
<p>今天这期，我们先来说说如何用好<strong>Mapmost地图引擎</strong>，让您在<strong>大规模倾斜数据的精细呈现</strong>与<strong>设备性能</strong>之间取得平衡，满足开发者和终端用户的需求。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/430c57db068640a4ace8bf84614562f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=x526fbbOZ%2Ff1iqHji8ucsrOPzzI%3D" alt="" loading="lazy"/></p>
<p>Mapmost SDK for WebGL面向<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D266397264%26content_type%3DArticle%26match_order%3D1%26q%3D%25E5%2580%25BE%25E6%2596%259C%25E6%2591%2584%25E5%25BD%25B1%25E6%2595%25B0%25E6%258D%25AE%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=266397264&amp;content_type=Article&amp;match_order=1&amp;q=%E5%80%BE%E6%96%9C%E6%91%84%E5%BD%B1%E6%95%B0%E6%8D%AE&amp;zhida_source=entity" ref="nofollow noopener noreferrer">倾斜摄影数据</a>加载，系统性地开放了<strong>六项关键能力</strong>：</p>
<p><strong><em>1.</em></strong> **自定义内存管理机制：**主动控制资源占用</p>
<p><strong><em>2.</em></strong> **动态瓦片清晰度调整：**倾斜视角智能优化</p>
<p><strong><em>3.</em></strong> **瓦片调度策略优化：**过滤冗余请求</p>
<p><strong><em>4.</em></strong> **场景清晰度调整：**画质精度自己定</p>
<p><strong><em>5.</em></strong> **跳级渲染机制：**提速加载过程</p>
<p><strong><em>6.</em></strong> **目的地预加载机制：**有效减少等待时间</p>
<p>从内存控制、调度策略到渲染机制，帮助用户轻松实现<strong>流畅与精细</strong>兼得的三维体验。</p>
<h2 data-id="heading-0">一、自定义内存管理机制：主动控制资源占用</h2>
<p>✅ <strong>解决问题</strong>：同一场景在不同设备加载时，性能较弱的设备易因内存占用过高导致崩溃。</p>
<p><strong>核心功能</strong>：用户可设置<code>maxMemoryUsage</code>参数，明确限制瓦片数据的最大缓存内存使用量，包括几何体和纹理等资源的存储限制。当缓存数据量超出设定值时，系统会自动卸载不常用的瓦片，同时全屏调整为显示更粗糙的瓦片级别。</p>
<p><strong>使用建议</strong>：<code>maxMemoryUsage</code>参数越大画质越优，但相应会对性能产生更大压力。建议根据实际设备性能情况灵活调整，平衡画质与流畅度。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02060f64b71e4e079282509281b02ebf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=m2nPG8YF5THx%2Be2YQdCmCfO%2FFrM%3D" alt="" loading="lazy"/></p>
<p><em>不开启内存管理机制</em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fca44aff1ec742129402f0b52ed3024b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=JE7tl%2Bf%2FJxClGWXbupucxBDEEwg%3D" alt="" loading="lazy"/></p>
<p><em>开启内存管理机制并设置最大内存为500MB</em></p>
<h2 data-id="heading-1">二、动态瓦片清晰度调整：倾斜视角智能优化</h2>
<p>✅ <strong>解决问题</strong>：相机倾斜时，远处瓦片加载冗余，降低性能。</p>
<p><strong>核心功能</strong>：当用户降低水平视角观察场景时，系统会自动降低远处瓦片的渲染精度，从而节省请求与渲染资源。</p>
<p><strong>适用场景</strong>：大范围倾斜浏览、移动巡检场景</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a6383a0731943b78d10780010fe180b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=EXP0jjoGIJPHT9emw%2FT%2BDTDHTjs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">三、瓦片调度策略优化：过滤冗余请求</h2>
<p>✅ <strong>解决问题</strong>：相机移动时，大量无用瓦片请求占用带宽，拖慢加载速度。</p>
<p><strong>核心功能</strong>：专门针对相机移动过程中的冗余请求进行过滤。在相机移动过程中，系统会根据设置的过滤强度剔除掉因相机移动而实际上不会使用到的瓦片请求，减少不必要的数据加载。</p>
<p><strong>使用建议</strong>：过滤强度值不宜过大，过大的设置可能会导致过度剔除，增加部分瓦片加载时间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c9e9fac536b14bc493963ce86949dc37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=I3WypHO4QXv0%2FTX9f2005cRZF18%3D" alt="" loading="lazy"/></p>
<p><em>关闭瓦片调度策略优化</em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af83f8f29fb24c258700c4513d2d31b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=yQxVrfdIEp5QGXKjA9zFtKrzAjI%3D" alt="" loading="lazy"/></p>
<p><em>开启瓦片调度策略优化</em></p>
<h2 data-id="heading-3">四、场景清晰度调整：画质精度自己定</h2>
<p>✅ <strong>解决问题</strong>：固定精度导致“要么模糊要么卡顿”。</p>
<p><strong>核心功能</strong>：用户可设置<code>maximumScreenSpaceError</code>最大屏幕空间误差参数直观控制模型显示的精细程度。该值越小，同层级下模型越精细，但相应的性能消耗也越大；反之则模型越粗糙，但性能越好。</p>
<p><strong>使用建议</strong>：建议根据项目对细节程度的要求灵活设置。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5aa178c9e31e4443ac7a14d0f2783dc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=umJgZm1Icjm39ujloSrUI6960WE%3D" alt="" loading="lazy"/></p>
<p><em>maximumScreenSpaceError=8</em></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64cad6f2ce09445a89c7262c62eeb1e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=LZmEwT2V2pbRdgxp8GSZGuugRSA%3D" alt="" loading="lazy"/></p>
<p><em>maximumScreenSpaceError=32</em></p>
<h2 data-id="heading-4">五、跳级渲染机制：提速加载过程</h2>
<p>✅ <strong>解决问题</strong>：瓦片逐层加载慢，场景初始化耗时久。</p>
<p><strong>核心功能</strong>：通过优化瓦片渲染顺序，确保用户最可能关注的内容优先加载和渲染，大幅缩短等待时间，提升用户体验。</p>
<p><strong>使用建议</strong>：建议开启。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec40e731f3324589bc2ecfe8dd624947~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=Iw93tkIIdYOCCobPw%2B09uLTAUaU%3D" alt="动图封面" loading="lazy"/></p>
<p>跳级渲染</p>
<p><strong>六、目的地预加载机制：有效减少等待时间</strong></p>
<p>✅ <strong>解决问题</strong>：飞行切换新区域时，瓦片加载滞后，出现卡顿现象。</p>
<p><strong>核心功能</strong>：在飞行过程中提前加载目标区域瓦片数据，实现**“人未到，数据已就位”**，有效减少飞到新区域时的等待时间。</p>
<p><strong>使用建议</strong>：当该机制开启，飞行过程中的帧率可能会有所降低，需要根据实际需求决定是否开启。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3507a6b710c04ea88e5591443c3756e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=h17Nzxh0W7KFYqsAOLB0CObTNm0%3D" alt="动图封面" loading="lazy"/></p>
<p><em>目的地预加载</em></p>
<p><strong>配套数据服务要求：优化效果的基础保障</strong></p>
<p><strong>6大核心能力</strong>的落地，需配合以下数据服务配置，确保性能最大化：</p>
<p>**<em>1.</em> 数据预处理：开启顶层重建，**合并简化底层冗余数据，优化瓦片层级结构。</p>
<p><strong><em>2.</em> 纹理格式：采用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D266397264%26content_type%3DArticle%26match_order%3D1%26q%3DKTX2.0%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=266397264&amp;content_type=Article&amp;match_order=1&amp;q=KTX2.0&amp;zhida_source=entity" ref="nofollow noopener noreferrer">KTX2.0</a></strong></p>
<p>**压缩，**模型纹理需转换为 KTX2.0 格式，替代传统 PNG/JPG。</p>
<p><strong><em>3.</em> 服务分发：使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhida.zhihu.com%2Fsearch%3Fcontent_id%3D266397264%26content_type%3DArticle%26match_order%3D1%26q%3DMapmost%2BStudio%26zhida_source%3Dentity" target="_blank" title="https://zhida.zhihu.com/search?content_id=266397264&amp;content_type=Article&amp;match_order=1&amp;q=Mapmost+Studio&amp;zhida_source=entity" ref="nofollow noopener noreferrer">Mapmost Studio</a></strong></p>
<p>**代理，**通过 Mapmost Studio 对数据进行坐标转换并配置数据代理服务，统一管理瓦片分发。</p>
<h2 data-id="heading-5">场景化配置示例：300 平方公里全园区倾斜模型</h2>
<p>以加载<strong>300平方公里全园区倾斜模型</strong>为例，建议配置如下：</p>
<p><strong>1. 必开能力</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db2e50a4730d4c9e95170d1727435b8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=60KKKWy5IN9ufvnB%2F06USa9IzCU%3D" alt="" loading="lazy"/></p>
<p><strong><em>2.</em> 按需补充</strong>：</p>
<p><strong>目的地预加载机制：<strong>若场景中需要频繁进行</strong>飞行切换区域</strong>（如场景巡检），建议额外开启「目的地预加载机制」，提前加载飞行终点的瓦片，减少飞行落地后的等待时间。</p>
<p>**场景清晰度调整：**根据需求与数据情况调整maximumScreenSpaceError参数，一般保持默认即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1a5ca82aa7b4a668a9770c7f26f76f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763882433&amp;x-signature=Na870qnrWtdKKvq7nkvQ7IzkNa4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">结语</h2>
<p>Mapmost 倾斜加载能力从**“内存适配、性能优化、加载效率”**三大维度出发，无需复杂开发，通过简单参数配置即可实现：</p>
<p>✅ **全设备兼容：**低性能设备也能流畅运行</p>
<p>✅ **画质性能平衡：**按需调整，告别“一刀切”</p>
<p>✅ **操作体验升级：**移动、飞行场景快速加载</p>
<p>这些优化能力全方位提升了大场景倾斜模型的应用体验，让开发者能够更专注于业务逻辑的实现，而不必过度担忧性能瓶颈。Mapmost后续将持续优化三维可视化技术，为行业提供更强大、更易用的开发工具和解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用了这个更厉害的P图AI，我把PS卸了！文字也能无痕修改！1秒救废图（附保姆级教程）]]></title>    <link>https://juejin.cn/post/7572749797468831753</link>    <guid>https://juejin.cn/post/7572749797468831753</guid>    <pubDate>2025-11-16T07:55:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572749797468831753" data-draft-id="7572793505899724851" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用了这个更厉害的P图AI，我把PS卸了！文字也能无痕修改！1秒救废图（附保姆级教程）"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-11-16T07:55:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员X小鹿"/> <meta itemprop="url" content="https://juejin.cn/user/2928754709505608"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用了这个更厉害的P图AI，我把PS卸了！文字也能无痕修改！1秒救废图（附保姆级教程）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2928754709505608/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员X小鹿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T07:55:37.000Z" title="Sun Nov 16 2025 07:55:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是X小鹿。</p>
<p>现在越来越多的人都开始用 AI 来生成图片了，各种海报、电商图等等。</p>
<p>比如我平时用的最多的场景，就是生成封面和文章配图 。</p>
<p>对于一个完全不懂画画的人来说，真的非常方便。</p>
<p>但平时用 AI 画图遇到最多的问题就是：</p>
<p><strong>图片上大部分地方都满意，但往往一个「瑕疵」，坏了整张图片。</strong></p>
<p>不知道大家有没有和我一样的经历。</p>
<p>比如下面这张图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52ad6571b78c4d5c97bda9066ba4d152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=5afNQi1J6vrBxneEesSlEwy42eY%3D" alt="图片" loading="lazy"/></p>
<p>“搞定”两字挤在一起了，而且还想把图中的主、副标题移动个位置。</p>
<p>但用目前主流的一些 AI 绘画工具或图片编辑工具，要么改不了，要么效果不理想。</p>
<p>重新生成，整张图都变了，又得抽一会。</p>
<p>不过最近看 Lovart 上线了「编辑元素」的功能，很好得解决了些问题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8fdbf8240ba45c88dbcc5eb6fce25de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=9l%2FKViWnggStxEqrCY%2F9naaI19g%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p><strong>只需要把修改的图片拖进 Lovart，Lovart 的「编辑元素」功能，就能将图片拆分成多个独立的图层。文字、背景及图片中的主体都可以随修改、删除或移动到任意位置。</strong></p>
</blockquote>
<p>一起来看看吧~</p>
<h2 data-id="heading-0">Lovart 编辑元素</h2>
<p>打开 Lovart：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.lovart.ai%2F" target="_blank" title="https://www.lovart.ai/" ref="nofollow noopener noreferrer">www.lovart.ai/</a></p>
<p>点「项目」-「新建项目」：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4661a6675dfa40fb9d64ddaf350f5962~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=lL58iQEJSXWs%2FbjWFNgjcdmtCkU%3D" alt="图片" loading="lazy"/></p>
<p>将要修改的图片拖进 Lovart，然后点「编辑元素」：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8874b9e2af440878d97f3c3ab000863~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=2ysSWc0%2BIYdMexcFErdrWIYnmCA%3D" alt="图片" loading="lazy"/></p>
<p>稍微等一会，图片就被拆分成了多个可编辑的图层：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb8d372ec576494a98cd59dccaa98728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=xhJPeHJ5jXCAs3hTG4mXJTplPhU%3D" alt="图片" loading="lazy"/></p>
<p>可以随意修改文字内容、颜色、字体、粗细、字号、对齐方式、字间距、行间距等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2905498b37f458cb08379ea4fa438bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=6iuVCyiFDboNeIGgjQyNKi5OBIw%3D" alt="图片" loading="lazy"/></p>
<p>画面中被拆分出来的其他元素，也能随意放大、缩小、删除、移动位置。</p>
<p>修改完成后，<strong>记得先「合并图层」再「下载」</strong>，否则可能仅仅是把某一个图层下载下来了，不完整。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dda05b3edb35453c9e54dc2afc040ef0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYWOWwj-m5vw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763884536&amp;x-signature=OBPHCLnKxXCd0yteWPBmPQY8q5U%3D" alt="图片" loading="lazy"/></p>
<p>虽然有时拆分完，可能会有一些元素丢失，可以再重试一下，不过整体效果还可以。</p>
<p>而且 Lovart 的免费用户，目前每天都有 100 积分，而「编辑元素」，每次只需要消耗 5 积分。</p>
<h2 data-id="heading-1">写在最后</h2>
<p>Lovart，作为全球首个设计智能体，能够将用户的模糊创意一步步转化为专业的设计作品。</p>
<p>还整合了 Nano Banana、Seedream、Midjourney、Sora、Veo、Hailuo、Kling、Tripo 等主流 AI 图片、视频、3D 模型。</p>
<p>除了今天介绍的「编辑元素」外，Lovart 还有很多实用的功能，感兴趣的都可以试试。</p>
<hr/>
<blockquote>
<p>我是<a href="https://juejin.cn/user/2928754709505608/posts" title="https://juejin.cn/user/2928754709505608/posts" target="_blank">程序员X小鹿</a>，前互联网大厂程序员，也是一名 AIGC 爱好者，持续分享更多好用的 AI 工具，欢迎一起交流~</p>
</blockquote>
<p><strong>推荐阅读</strong></p>
<p><a href="https://juejin.cn/post/7454501732203610131" title="https://juejin.cn/post/7454501732203610131" target="_blank">2024年终AI工具汇总：9大AI领域，70+精选AI工具，全都在这了！(建议收藏)</a></p>
<p>更多 AI 工具见<a href="https://juejin.cn/column/7284164153576947724" title="https://juejin.cn/column/7284164153576947724" target="_blank">【AI工具】</a>专栏，持续更新中。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每周AI论文速递（251110-251114）]]></title>    <link>https://juejin.cn/post/7572697146287226930</link>    <guid>https://juejin.cn/post/7572697146287226930</guid>    <pubDate>2025-11-16T06:40:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572697146287226930" data-draft-id="7572749797468684297" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每周AI论文速递（251110-251114）"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-16T06:40:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叶子的技术碎碎念"/> <meta itemprop="url" content="https://juejin.cn/user/2831954919569245"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每周AI论文速递（251110-251114）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2831954919569245/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叶子的技术碎碎念
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T06:40:15.000Z" title="Sun Nov 16 2025 06:40:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Lumine: An Open Recipe for Building Generalist Agents in 3D Open Worlds</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.08892" target="_blank" title="https://arxiv.org/abs/2511.08892" ref="nofollow noopener noreferrer">Lumine: 构建3D开放世界中通用AI智能体的开放方案</a></p>
<p>我们推出Lumine，这是首个用于开发通用AI智能体的开放方案，能够在挑战性3D开放世界环境中实时完成长达数小时的复杂任务。Lumine采用类人交互范式，以视觉语言模型驱动，端到端地统一感知、推理与行动。它以5Hz处理原始像素，生成精确的30Hz键鼠动作，并仅在必要时自适应触发推理。在《原神》中训练后，Lumine成功通关整个五小时蒙德主线剧情，效率达到人类水平，并能遵循自然语言指令，在3D开放世界探索和2D图形界面操作中广泛执行收集、战斗、解谜及NPC交互等任务。除领域内性能外，Lumine还展现出强大的零样本跨游戏泛化能力：无需微调，即可在《鸣潮》中完成100分钟任务，并在《崩坏：星穹铁道》中通关完整五小时第一章。这些显著成果证明了Lumine在不同世界与交互机制中的高效性，标志着开放环境下通用AI智能体发展的实质性进展。</p>
<h2 data-id="heading-1">Grounding Computer Use Agents on Human Demonstrations</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.07332" target="_blank" title="https://arxiv.org/abs/2511.07332" ref="nofollow noopener noreferrer">基于人类演示的计算机使用智能体基础构建</a></p>
<p>构建可靠的计算机使用智能体需要基础化：将自然语言指令与正确的屏幕元素精确关联。尽管已有大量网页和移动交互数据集，但桌面环境的高质量数据资源仍显不足。为填补这一空白，我们推出了 GroundCUA——一个基于专家人类演示构建的大规模桌面基础化数据集。该数据集覆盖 12 个类别下的 87 个应用程序，包含 5.6 万张屏幕截图，所有屏幕元素均经过精细标注，累计人类验证标注量超过 356 万条。基于这些演示，我们生成了涵盖广泛现实任务的多样化指令，为模型训练提供高质量数据支撑。利用 GroundCUA，我们开发了 GroundNext 系列模型，能够将指令映射至对应 UI 元素。在 30 亿和 70 亿参数规模下，通过监督微调，GroundNext 在五项基准测试中均达到最先进水平，且训练数据量不足先前工作的十分之一。后续强化学习进一步提升了模型性能，在 OSWorld 基准的智能体测试环境中，以 o3 作为规划器时，GroundNext 取得了与使用远超其训练数据量的模型相当或更优的结果。这些成果印证了高质量专家驱动数据集对推进通用计算机使用智能体发展的关键作用。</p>
<h2 data-id="heading-2">Tiny Model, Big Logic: Diversity-Driven Optimization Elicits Large-Model Reasoning Ability in VibeThinker-1.5B</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.06221" target="_blank" title="https://arxiv.org/abs/2511.06221" ref="nofollow noopener noreferrer">小模型，大逻辑：多样性驱动优化激发 VibeThinker-1.5B 的大模型级推理能力</a></p>
<p>针对当前普遍认为小模型天生缺乏强大推理能力的共识，本报告提出了 VibeThinker-1.5B，这是一个通过频谱到信号原则 (SSP) 开发的 1.5B 参数密集模型。该模型挑战了通过扩大模型参数来提升能力的流行方法，例如 DeepSeek R1 (671B) 和 Kimi k2 (&gt;1T) 等模型所采用的策略。SSP 框架首先采用两阶段多样性探索蒸馏 (SFT) 生成广泛的解空间，随后通过最大熵引导策略优化 (RL) 强化正确信号。总训练成本仅为 7,800 美元，VibeThinker-1.5B 在推理能力上优于闭源模型如 Magistral Medium 和 Claude Opus 4，并与开源模型 GPT OSS-20B Medium 表现相当。值得注意的是，它在三个数学基准测试中超越了参数规模大 400 倍的 DeepSeek R1：AIME24 (80.3 对 79.8)、AIME25 (74.4 对 70.0) 和 HMMT25 (50.4 对 41.7)。这相对于其基础模型（得分分别为 6.7、4.3 和 0.6）是显著提升。在 LiveCodeBench V6 上，其得分为 51.1，超过 Magistral Medium 的 50.3 及其基础模型的 0.0。这些结果表明，小模型能够实现与大模型相媲美的推理能力，大幅降低训练和推理成本，从而推动先进 AI 研究的普及。</p>
<h2 data-id="heading-3">HaluMem: Evaluating Hallucinations in Memory Systems of Agents</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.03506" target="_blank" title="https://arxiv.org/abs/2511.03506" ref="nofollow noopener noreferrer">HaluMem：评估智能体记忆系统中的幻觉</a></p>
<p>记忆系统是实现大语言模型（LLM）和AI智能体等人工智能系统长期学习与持续交互的关键组件。然而在记忆存储和检索过程中，这些系统常出现记忆幻觉现象，包括虚构、错误、冲突和遗漏等问题。现有对记忆幻觉的评估主要采用端到端问答形式，难以准确定位幻觉在记忆系统内部产生的具体操作环节。为此，我们提出记忆幻觉基准（HaluMem），这是首个专为记忆系统设计的操作级幻觉评估基准。HaluMem定义了记忆提取、记忆更新和记忆问答三项评估任务，全面揭示交互过程中不同操作阶段的幻觉行为。为支持评估，我们构建了以用户为中心的多轮人机交互数据集HaluMem-Medium和HaluMem-Long，两者均包含约1.5万记忆点和3500个多类型问题。每个用户的平均对话轮数分别达到1500轮和2600轮，上下文长度超过100万token（Token），可评估不同上下文规模与任务复杂度下的幻觉现象。基于HaluMem的实证研究表明，现有记忆系统在提取和更新阶段容易产生并积累幻觉，进而将错误传播至问答阶段。未来研究应致力于开发具有可解释性的受约束记忆操作机制，系统性地抑制幻觉并提升记忆可靠性。</p>
<h2 data-id="heading-4">One Small Step in Latent, One Giant Leap for Pixels: Fast Latent Upscale Adapter for Your Diffusion Models</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.10629" target="_blank" title="https://arxiv.org/abs/2511.10629" ref="nofollow noopener noreferrer">潜在空间一小步，像素维度大跨越：扩散模型快速潜在上采样适配器</a></p>
<p>扩散模型难以突破其训练分辨率的限制：直接进行高分辨率采样速度缓慢且计算成本高昂，而后处理的图像超分辨率（ISR）方法需在解码后执行操作，不仅会引入伪影，还会增加额外延迟。本文提出潜在上采样适配器（LUA），该轻量模块可在最终VAE解码步骤之前，直接在生成器的潜在编码上执行超分辨率。LUA以即插即用式组件形式集成，无需修改基础模型结构或增加额外扩散阶段，仅需在潜在空间执行单次前向传播即可实现高分辨率合成。其采用共享式Swin架构骨干网络配合多尺度像素重组头，支持2倍与4倍上采样因子，同时保持与图像空间超分辨率基准的兼容性——在达到相近感知质量的前提下，将解码与上采样时间降低近3倍（从512像素生成1024像素仅需增加0.42秒，而使用相同SwinIR架构的像素空间超分辨率需1.87秒）。此外，LUA在不同VAE的潜在空间均展现出卓越的泛化能力，无需针对每个新解码器重新训练即可快速部署。大量实验表明，LUA在保真度方面可媲美原生高分辨率生成，同时为现代扩散流程中的可扩展高保真图像合成提供了实用高效的解决方案。</p>
<h2 data-id="heading-5">TiDAR: Think in Diffusion, Talk in Autoregression</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.08923" target="_blank" title="https://arxiv.org/abs/2511.08923" ref="nofollow noopener noreferrer">TiDAR: 扩散思考，自回归交谈</a></p>
<p>扩散语言模型具备快速并行生成能力，而自回归 (AR) 模型因其因果结构与语言建模天然契合，通常在生成质量上更优。这引出一个核心问题：能否在实现高吞吐量、更高 GPU 利用率的同时，达到 AR 级别的质量？现有方法均未能有效平衡这两方面：要么采用较弱模型进行顺序草稿生成（推测解码）以优先保障 AR 特性，导致草稿效率低下；要么为扩散模型引入类 AR 的左到右解码逻辑，仍面临质量下降问题且丧失并行潜力。我们提出 TiDAR——一种序列级混合架构，通过专门设计的结构化注意力掩码，在单次前向传播中实现扩散式 token 草稿生成（思考）与自回归最终输出采样（交谈）。该设计充分利用 GPU 闲置计算资源，在草稿生成与验证能力间取得优异平衡。此外，TiDAR 作为独立模型具备低开销的部署友好特性。我们在 1.5B 和 8B 规模下，针对生成与似然任务对 TiDAR、AR 模型、推测解码及扩散变体进行广泛评估。凭借并行草稿生成与采样机制以及精确 KV 缓存支持，TiDAR 在吞吐量上超越推测解码，在效率与质量方面均优于 Dream、Llada 等扩散模型。最显著的是，TiDAR 成为首个在保持每秒生成 4.71-5.91 倍更多 token 的同时，完全弥合与 AR 模型质量差距的架构。</p>
<h2 data-id="heading-6">IterResearch: Rethinking Long-Horizon Agents via Markovian State Reconstruction</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.07327" target="_blank" title="https://arxiv.org/abs/2511.07327" ref="nofollow noopener noreferrer">IterResearch：通过马尔可夫状态重构重新思考长视野智能体</a></p>
<p>深度研究智能体的最新进展表明，通过对外部信息源进行动态推理，有望实现自主知识构建。然而，现有方法采用单上下文范式，将所有信息累积在持续扩展的上下文窗口中，导致上下文拥塞和噪声干扰，从而限制了其在长视野任务中的效能。我们提出 IterResearch，一种新颖的迭代式深度研究范式，将长视野研究重新定义为具有策略性工作区重构的马尔可夫决策过程。该方法通过维护动态演进的报告作为记忆体，并定期整合关键见解，可在任意探索深度下保持稳定的推理能力。我们还开发了效率感知策略优化 (EAPO)，这是一个基于几何奖励衰减机制激励高效探索的强化学习框架，并通过自适应降采样实现稳定的分布式训练。大量实验表明，IterResearch 在六个基准测试中相较现有开源智能体平均提升 14.5 个百分点，显著缩小了与尖端专有系统的差距。值得注意的是，该范式展现出前所未有的交互扩展能力，支持多达 2048 次交互且性能大幅提升（从 3.5% 增至 42.5%），同时作为有效的提示策略，在长视野任务中较 ReAct 将尖端模型性能提升最高达 19.2 个百分点。这些成果确立了 IterResearch 作为长视野推理的多功能解决方案，既可作为训练完备的智能体独立运行，也可作为尖端模型的提示范式使用。</p>
<h2 data-id="heading-7">PAN: A World Model for General, Interactable, and Long-Horizon World Simulation</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.09057" target="_blank" title="https://arxiv.org/abs/2511.09057" ref="nofollow noopener noreferrer">PAN：通用、可交互与长视野的世界模拟模型</a></p>
<p>世界模型使智能体能够想象、预测并推理世界如何随其动作演变，从而进行规划与决策。尽管当前视频生成模型可生成逼真视觉序列，但它们多采用从提示到完整视频的生成模式，缺乏因果控制、交互能力以及目标导向推理所需的长期一致性。而现有世界建模方法常局限于特定领域（如物理、游戏或三维场景动态），深度不足且可控性有限，难以泛化至多样化环境与交互形式。本文提出PAN，一种通用、可交互且支持长视野的世界模型，它基于历史状态与自然语言动作，通过高质量视频模拟预测未来世界状态。PAN采用生成式潜在预测（GLP）架构：其自回归潜在动态主干基于大语言模型（LLM），将模拟锚定于广泛文本知识，并支持语言指定动作的条件控制；视频扩散解码器则重建感知细节丰富且时序一致的视觉观测。该架构实现了潜在空间推理（想象）与可实现世界动态（现实）的统一。通过在大规模跨领域视频-动作对上进行训练，PAN支持开放域的动作条件模拟，并保持连贯的长期动态。大量实验表明，相较于其他视频生成器与世界模型，PAN在动作条件世界模拟、长视野预测及模拟推理任务中均表现优异，为构建通用世界模型迈出关键一步——这类模型能通过对未来状态的预测模拟支持推理与行动决策。</p>
<h2 data-id="heading-8">MADD: Multi-Agent Drug Discovery Orchestra</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.08217" target="_blank" title="https://arxiv.org/abs/2511.08217" ref="nofollow noopener noreferrer">MADD：多智能体药物发现协奏曲</a></p>
<p>苗头化合物识别是早期药物发现的核心挑战，传统方法需耗费大量实验资源。人工智能的最新进展，特别是大语言模型 (LLMs)，催生了可降低成本和提升效率的虚拟筛选方法。然而，这些工具日益复杂，限制了湿实验研究人员的实际使用。多智能体系统通过融合 LLMs 的可解释性与专业模型及工具的精确性，提供了颇具前景的解决方案。本研究提出 MADD——一个能够根据自然语言查询构建并执行定制化苗头化合物识别流程的多智能体系统。MADD 部署四个协同工作的智能体，分别处理从头化合物生成与筛选中的关键子任务。我们在七个药物发现案例中评估 MADD，证明其性能优于现有基于 LLM 的解决方案。借助 MADD，我们率先将 AI 驱动的药物设计应用于五个生物靶标，并公开了已识别的苗头分子。最后，我们建立了包含三百余万种化合物的查询-分子对与对接评分新基准，以推动药物设计迈向智能体主导的未来。</p>
<h2 data-id="heading-9">Too Good to be Bad: On the Failure of LLMs to Role-Play Villains</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.04962" target="_blank" title="https://arxiv.org/abs/2511.04962" ref="nofollow noopener noreferrer">过于良善难成恶：大语言模型在反派角色扮演中的失败</a></p>
<p>大语言模型（LLMs）正日益承担创造性生成任务，包括模拟虚构角色。然而，模型在刻画非亲社会或敌对型角色方面的能力仍鲜有研究。我们假设，现代大语言模型的安全对齐机制与逼真扮演道德模糊或反派角色的任务之间存在根本性冲突。为探究此问题，我们提出了道德角色扮演基准（Moral RolePlay benchmark），该新数据集包含四级道德倾向量表和一个平衡测试集，用于严格评估。我们要求前沿大语言模型扮演从道德楷模到纯粹恶棍的各类角色。大规模评估结果表明，随着角色道德水平的降低，角色扮演的逼真度呈现稳定且单调的下降趋势。模型在与安全原则直接冲突的特质上表现最差，如“欺诈性”和“操纵性”，往往以浅层的攻击性替代复杂的恶意刻画。此外，我们发现通用聊天机器人能力无法有效预测反派扮演水平，高度优化安全的模型表现尤为逊色。本研究首次系统性地揭示了这一关键局限，突显了模型安全性与创造性真实度之间的核心矛盾。所提出的基准和结论为开发更精细、情境感知的对齐方法奠定了基础。</p>
<h2 data-id="heading-10">Time-to-Move: Training-Free Motion Controlled Video Generation via Dual-Clock Denoising</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.08633" target="_blank" title="https://arxiv.org/abs/2511.08633" ref="nofollow noopener noreferrer">Time-to-Move：通过双时钟去噪实现免训练的运动控制视频生成</a></p>
<p>基于扩散模型的视频生成技术能够合成逼真视频，但现有基于图像和文本的条件控制方法无法实现精确的运动控制。以往的运动条件合成方法通常需要对特定模型进行微调，计算成本高昂且适用性受限。本文提出 Time-to-Move (TTM) ，一种免训练、即插即用 (plug-and-play) 的框架，通过图像到视频 (I2V) 扩散模型实现运动与外观可控的视频生成。我们的核心思路是利用通过用户友好操作（如剪切-拖拽 (cut-and-drag) 或基于深度的重投影 (depth-based reprojection)）获得的粗略参考动画。受 SDEdit 利用粗略布局线索 (coarse layout cues) 进行图像编辑的启发，我们将这些粗略动画视为运动线索，并将该机制扩展至视频领域。我们通过图像条件保持外观一致性，并引入双时钟去噪 (dual-clock denoising) —— 一种区域依赖策略，在运动指定区域强制执行严格对齐，同时在其余区域保持灵活性，从而在用户意图忠实度与自然运动动态之间取得平衡。这种对采样过程的轻量级修改无需额外训练或运行时开销，且兼容任何骨干网络。在物体运动和相机运动的基准测试上进行的大量实验表明，TTM 在真实感与运动控制精度方面达到或超越了现有基于训练的基线方法。此外，TTM 还具备独特优势：通过像素级条件控制实现精确的外观调控，突破了纯文本提示的限制。欢迎访问我们的项目页面查看视频示例和代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftime-to-move.github.io%2F%25E3%2580%2582" target="_blank" title="https://time-to-move.github.io/%E3%80%82" ref="nofollow noopener noreferrer">time-to-move.github.io/。</a></p>
<h2 data-id="heading-11">DRIVE: Data Curation Best Practices for Reinforcement Learning with Verifiable Reward in Competitive Code Generation</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.06307" target="_blank" title="https://arxiv.org/abs/2511.06307" ref="nofollow noopener noreferrer">DRIVE: 竞争性代码生成中带可验证奖励的强化学习数据管理最佳实践</a></p>
<p>近期推理优先模型（如 OpenAI o1、DeepSeek R1）重新激发了对 RLVR 的兴趣。然而，相关进展主要集中在数学领域（如 AIME），竞争性编程代码生成方向探索不足，且数据管理受到的关注远少于 RL 算法设计。本研究探讨如何构建 RLVR 数据集（即 RL 提示），并提出在竞争性编程代码生成中实现强劲性能的实用训练技术。我们的流程始于从强开源模型蒸馏得到的监督微调（SFT），并辅以通用型与推理密集型数据进行增强。随后，强化学习采用包含可执行测试用例驱动奖励的两阶段流程：首先，在均匀分布的大规模竞争性编程问题集上，使用组相对策略优化（GRPO）进行训练，每个提示执行 8 次 rollout，并设置较短响应生成窗口（如 SFT 阶段 32k，本阶段 24k）以扩展熵并减少重复与截断问题；其次，执行 \textbf{Pre-GRPO} 阶段：在小型高质量挑战性问题集上，以每个提示 64 次 rollout 的大预算进行更新，采用硬焦点课程策略持续保留训练全程中最困难的实例。我们在 Qwen2.5-32B 上实现该方法，并在 LeetCode 和 Codeforces 周赛中进行评估以避免数据泄露。最终模型在同等规模模型中达到最先进性能，与 DeepSeek v3.1、Doubao-1.5-Thinking 等领先系统表现相当。我们还分析了缩放趋势，在内部大规模混合专家（MoE）模型上观察到显著的 RL 缩放效应。本研究提炼出竞争性编程代码生成中 RLVR 数据管理、熵扩展与课程设计的简洁最佳实践。</p>
<h2 data-id="heading-12">Visual Spatial Tuning</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.05491" target="_blank" title="https://arxiv.org/abs/2511.05491" ref="nofollow noopener noreferrer">视觉空间调优</a></p>
<p>从视觉输入中捕获空间关系是实现人类水平通用智能的关键基础。先前研究多通过引入额外专家编码器来增强视觉语言模型 (VLMs) 的空间感知能力，但这不仅增加了计算开销，还往往损害模型的通用性能。为在通用架构中有效提升空间能力，我们提出视觉空间调优 (VST) 这一综合框架，旨在系统培养 VLMs 从空间感知到推理的类人视觉空间能力。我们首先通过构建大规模数据集 VST-P 来强化空间感知，该数据集包含 410 万样本，覆盖单视图、多图像和视频三大场景下的 19 类空间任务。继而推出 VST-R 精选数据集（含 13.5 万样本），专门训练模型进行空间推理。我们采用渐进式训练策略：先通过监督微调建立空间知识基础，再通过强化学习进阶优化空间推理能力。在保持通用能力不受影响的前提下，VST 在多个空间基准测试中均达到最先进水平，如在 MMSI-Bench 上获得 34.8% 的准确率，在 VSIBench 上达到 61.2%。实验表明，所提出的空间调优范式能显著增强视觉-语言-行动模型，为推动具身智能发展奠定基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Unibest：新一代uni-app工程化最佳实践指南]]></title>    <link>https://juejin.cn/post/7572480736361889798</link>    <guid>https://juejin.cn/post/7572480736361889798</guid>    <pubDate>2025-11-16T06:22:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572480736361889798" data-draft-id="7572539461478170667" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Unibest：新一代uni-app工程化最佳实践指南"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-16T06:22:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="宇余"/> <meta itemprop="url" content="https://juejin.cn/user/2999123453424542"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Unibest：新一代uni-app工程化最佳实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2999123453424542/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    宇余
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T06:22:45.000Z" title="Sun Nov 16 2025 06:22:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在uni-app生态日益成熟的今天，开发者对工程化、性能优化和跨端一致性的需求愈发迫切。Unibest作为一套基于uni-app的企业级工程化方案，整合了路由封装、状态管理、请求拦截、组件规范等核心能力，旨在降低大型项目开发成本，提升团队协作效率。本文将从核心特性、快速上手、实战技巧三个维度，带你全面掌握Unibest的使用方法。</p>
<h2 data-id="heading-0">一、Unibest核心特性解析</h2>
<p>Unibest并非简单的模板集合，而是经过多个生产项目验证的工程化体系，其核心特性可概括为以下四点：</p>
<h3 data-id="heading-1">1.1 开箱即用的工程化方案</h3>
<p>Unibest内置了完整的工程化配置，无需开发者手动搭建：</p>
<ul>
<li>
<p><strong>路由管理</strong>：基于uni-simple-router封装，支持路由守卫、动态路由和路由别名，解决原生uni-app路由跳转繁琐的问题。</p>
</li>
<li>
<p><strong>请求层封装</strong>：统一的request拦截器，支持请求头添加、错误统一处理、loading自动控制，同时兼容mock数据和生产环境切换。</p>
</li>
<li>
<p><strong>代码规范</strong>：集成ESLint + Prettier + Husky，强制代码风格统一，减少团队协作冲突。</p>
</li>
</ul>
<h3 data-id="heading-2">1.2 跨端一致性保障</h3>
<p>针对uni-app跨端开发中常见的样式差异、API兼容性问题，Unibest提供了针对性解决方案：</p>
<ul>
<li>
<p><strong>样式解决方案</strong>：内置px2rpx自动转换，配合scss变量和mixin，确保多端样式一致性；提供适配H5、小程序、App的样式隔离方案。</p>
</li>
<li>
<p><strong>API适配层</strong>：对uni-app原生API进行二次封装，处理不同平台的差异逻辑，如支付、分享等功能的跨端兼容。</p>
</li>
</ul>
<h3 data-id="heading-3">1.3 性能优化内置</h3>
<p>Unibest从初始化阶段就融入了性能优化理念：</p>
<p>核心优化点：页面懒加载、图片懒加载、分包加载配置、大型组件异步引入，启动速度较原生uni-app提升30%+（基于官方测试数据）。</p>
<h3 data-id="heading-4">1.4 丰富的生态集成</h3>
<p>无缝对接uni-app生态的同时，扩展了常用工具库：</p>
<ul>
<li>
<p>状态管理：支持Pinia/Vuex，提供模块化状态管理模板；</p>
</li>
<li>
<p>UI组件：兼容uView、ColorUI等主流UI库，同时提供自定义业务组件模板；</p>
</li>
<li>
<p>工具函数：集成日期处理、加密解密、数据格式化等常用工具。</p>
</li>
</ul>
<h2 data-id="heading-5">二、Unibest快速上手教程</h2>
<p>只需三步，即可搭建基于Unibest的项目：</p>
<h3 data-id="heading-6">2.1 环境准备</h3>
<p>确保已安装以下依赖：</p>
<pre><code class="hljs language-bash" lang="bash">

<span class="hljs-comment"># 安装Node.js（v14+）</span>
<span class="hljs-comment"># 安装uni-app CLI</span>
npm install -g @dcloudio/cli
<span class="hljs-comment"># 安装pnpm（推荐）</span>
npm install -g pnpm
    
</code></pre>
<h3 data-id="heading-7">2.2 创建项目</h3>
<p>使用Unibest模板创建新项目：</p>
<pre><code class="hljs language-bash" lang="bash">

<span class="hljs-comment"># 克隆Unibest模板</span>
git <span class="hljs-built_in">clone</span> https://github.com/unibest-team/unibest.git my-unibest-project
<span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> my-unibest-project
<span class="hljs-comment"># 安装依赖</span>
pnpm install
    
</code></pre>
<h3 data-id="heading-8">2.3 运行项目</h3>
<p>支持多端运行命令：</p>
<pre><code class="hljs language-bash" lang="bash">

<span class="hljs-comment"># 运行到微信小程序</span>
pnpm dev:mp-weixin
<span class="hljs-comment"># 运行到H5</span>
pnpm dev:h5
<span class="hljs-comment"># 运行到App（需配合HBuilderX）</span>
pnpm dev:app-plus
    
</code></pre>
<h3 data-id="heading-9">2.4 目录结构解析</h3>
<p>Unibest采用约定式目录结构，核心目录说明：</p>





























<table><thead><tr><th>目录</th><th>功能说明</th></tr></thead><tbody><tr><td>/src/api</td><td>接口请求封装</td></tr><tr><td>/src/router</td><td>路由配置和守卫</td></tr><tr><td>/src/store</td><td>Pinia/Vuex状态管理</td></tr><tr><td>/src/components</td><td>公共组件和业务组件</td></tr><tr><td>/src/utils</td><td>工具函数集合</td></tr></tbody></table>
<h2 data-id="heading-10">三、Unibest实战技巧</h2>
<h3 data-id="heading-11">3.1 多环境配置</h3>
<p>在<code>/src/env</code>目录下配置不同环境的接口地址：</p>
<pre><code class="hljs language-javascript" lang="javascript">

<span class="hljs-comment">// .env.development</span>
<span class="hljs-variable constant_">VITE_BASE_URL</span> = <span class="hljs-string">'https://dev-api.unibest.com'</span>

<span class="hljs-comment">// .env.production</span>
<span class="hljs-variable constant_">VITE_BASE_URL</span> = <span class="hljs-string">'https://api.unibest.com'</span>
    
</code></pre>
<p>通过命令自动切换环境：</p>
<pre><code class="hljs language-bash" lang="bash">

<span class="hljs-comment"># 开发环境</span>
pnpm dev:mp-weixin --mode development
<span class="hljs-comment"># 生产环境</span>
pnpm build:mp-weixin --mode production
    
</code></pre>
<h3 data-id="heading-12">3.2 组件封装最佳实践</h3>
<p>以自定义按钮组件为例，Unibest推荐的封装方式：</p>
<pre><code class="hljs language-vue" lang="vue">

&lt;template&gt;
  &lt;button 
    class="u-btn" 
    :class="{ 'u-btn--primary': type === 'primary' }"
    @click="handleClick"
  &gt;
    &lt;slot&gt;&lt;/slot&gt;
  &lt;/button&gt;
&lt;/template&gt;

&lt;script setup&gt;
const props = defineProps({
  type: {
    type: String,
    default: 'default'
  }
})

const emit = defineEmits(['click'])

const handleClick = (e) =&gt; {
  emit('click', e)
}
&lt;/script&gt;

&lt;style scoped lang="scss"&gt;
.u-btn {
  padding: 12rpx 24rpx;
  border-radius: 8rpx;
  &amp;--primary {
    background: #007aff;
    color: #fff;
  }
}
&lt;/style&gt;
    
</code></pre>
<h3 data-id="heading-13">3.3 路由守卫应用</h3>
<p>在<code>/src/router/guard.js</code>中配置全局路由守卫：</p>
<pre><code class="hljs language-javascript" lang="javascript">

<span class="hljs-comment">// 登录拦截</span>
router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> token = uni.<span class="hljs-title function_">getStorageSync</span>(<span class="hljs-string">'token'</span>)
  <span class="hljs-keyword">if</span> (to.<span class="hljs-property">meta</span>.<span class="hljs-property">requiresAuth</span> &amp;&amp; !token) {
    <span class="hljs-title function_">next</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'/pages/login/login'</span> })
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">next</span>()
  }
})
    
</code></pre>
<h2 data-id="heading-14">四、总结与展望</h2>
<p>Unibest通过标准化的工程化方案，解决了uni-app开发中的痛点问题，尤其适合中大型团队和复杂项目。目前Unibest已支持Vue3+Vite架构，后续将持续优化跨端性能、扩展生态集成（如微前端方案）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[虚拟列表(Virtual List)组件实现与优化铁臂猿版（简易版）]]></title>    <link>https://juejin.cn/post/7572481101710868534</link>    <guid>https://juejin.cn/post/7572481101710868534</guid>    <pubDate>2025-11-16T06:47:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572481101710868534" data-draft-id="7572002432451100681" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="虚拟列表(Virtual List)组件实现与优化铁臂猿版（简易版）"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-16T06:47:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="西西西西胡萝卜鸡"/> <meta itemprop="url" content="https://juejin.cn/user/2918532014943187"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            虚拟列表(Virtual List)组件实现与优化铁臂猿版（简易版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2918532014943187/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    西西西西胡萝卜鸡
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T06:47:30.000Z" title="Sun Nov 16 2025 06:47:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>引入：本文使用vue3+ts+tailwindcss实现</p>
</blockquote>
<h2 data-id="heading-0">一、为什么需要“虚拟列表”？</h2>
<p>当我们在页面中渲染一个<strong>很长的列表</strong>时（比如上万条数据），普通的<code>v-for</code>会一次性创建上万个DOM节点：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;li v-for="item in 10000"&gt;{{ item }}&lt;/li&gt;
</code></pre>
<p>这会导致：</p>
<ul>
<li>页面加载慢；</li>
<li>内存占用大；</li>
<li>滚动卡顿。</li>
</ul>
<p>于是就有了性能神器——<strong>虚拟列表 (Virtual List)</strong> 。</p>
<h2 data-id="heading-1">二、核心思想</h2>
<p>虚拟列表的核心实现思路其实很简单：</p>
<blockquote>
<p>固定外层盒子的高，通过计算只渲染出可见区域的数据，其余不可见元素用一个占位元素撑出滚动条。</p>
</blockquote>
<h4 data-id="heading-2">可视化理解</h4>
<p>假设列表共有 10000 条，每行高 40px：</p>

























<table><thead><tr><th>区域</th><th>说明</th></tr></thead><tbody><tr><td>可见区域</td><td>一次只显示约 10 行</td></tr><tr><td>缓冲区</td><td>上下各多渲染几行防止闪烁</td></tr><tr><td>占位容器</td><td>用总高度撑出滚动条</td></tr><tr><td>渲染窗口</td><td>动态平移（translateY）到对应位置</td></tr></tbody></table>
<p>这样：</p>
<ul>
<li>页面上<strong>实际只有几十个 DOM</strong>；</li>
<li>但滚动条看起来依然完整；</li>
<li>用户看起来就像全部都渲染出来一样。</li>
</ul>
<h2 data-id="heading-3">三、基础版虚拟列表示例</h2>
<p>我们先用最简单的方法来实现一个简易版的，以便我们更好的理解最底层的思想原理：</p>
<ul>
<li>支持滚动</li>
<li>支持滚动数据切片</li>
<li>支持缓冲区</li>
</ul>
<p><strong>JS部分实现思路：</strong></p>
<blockquote>
<p>用一个固定高度的容器制造滚动条，通过计算只渲染可视区域的数据，并用偏移量让这些数据看起来在正确的位置。</p>
</blockquote>
<h4 data-id="heading-4">1. 主要变量设置，本教程为简易版，默认所有数据项等高</h4>
<pre><code class="hljs language-js" lang="js">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref, computed, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-comment">/**
 * 组件参数（Props）
 */</span>
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">items</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Array</span>, <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> [] }, <span class="hljs-comment">// 数据数组</span>
  <span class="hljs-attr">itemHeight</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>, <span class="hljs-attr">default</span>: <span class="hljs-number">40</span> }, <span class="hljs-comment">// 单行高度</span>
  <span class="hljs-attr">height</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>, <span class="hljs-attr">default</span>: <span class="hljs-number">300</span> },     <span class="hljs-comment">// 容器高度</span>
  <span class="hljs-attr">buffer</span>: { <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>, <span class="hljs-attr">default</span>: <span class="hljs-number">5</span> }        <span class="hljs-comment">// 上下缓冲行数</span>
})
<span class="hljs-comment">/**
 *  状态变量（会随滚动变化）
 */</span>
<span class="hljs-keyword">const</span> containerRef = ref&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;()   <span class="hljs-comment">// 滚动容器 DOM</span>
<span class="hljs-keyword">const</span> scrollTop = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)                     <span class="hljs-comment">// 当前滚动位置</span>
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-5">2.可视区域计算：包括高度计算和偏移量（offset）计算</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 总高度（撑出滚动条）：总数居条数*每一项高度</span>
<span class="hljs-keyword">const</span> totalHeight = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">items</span>.<span class="hljs-property">length</span> * props.<span class="hljs-property">itemHeight</span>)

<span class="hljs-comment">// 当前一屏可显示多少行（加上缓冲）：可视区高度/每一项高度</span>
<span class="hljs-keyword">const</span> visibleCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> base = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(props.<span class="hljs-property">height</span> / props.<span class="hljs-property">itemHeight</span>)
  <span class="hljs-keyword">return</span> base + props.<span class="hljs-property">buffer</span> * <span class="hljs-number">2</span>
})

<span class="hljs-comment">// 可见数据的起止索引：</span>
<span class="hljs-comment">// 1. 当前位置 ÷ 每一项高度 = 当前完全滚过多少项（向下取整得到最完整的已滚过项数）</span>
<span class="hljs-comment">// 2. 减去缓冲区：因为上方缓冲区的内容也需要提前渲染</span>
<span class="hljs-comment">// 3. 确保索引不小于0（边界保护）</span>
<span class="hljs-keyword">const</span> startIndex = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(scrollTop.<span class="hljs-property">value</span> / props.<span class="hljs-property">itemHeight</span>) - props.<span class="hljs-property">buffer</span>
  <span class="hljs-keyword">return</span> start &lt; <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : start
})

<span class="hljs-comment">// 结束索引 = 开始索引 + 要渲染的总数量（可见区+上下缓冲区）</span>
<span class="hljs-comment">// 注意：这里应该加上边界检查，防止超过数组长度</span>
<span class="hljs-keyword">const</span> endIndex = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> end = startIndex.<span class="hljs-property">value</span> + visibleCount.<span class="hljs-property">value</span>
  <span class="hljs-keyword">return</span> end &gt; props.<span class="hljs-property">items</span>.<span class="hljs-property">length</span> ? props.<span class="hljs-property">items</span>.<span class="hljs-property">length</span> : end
})
<span class="hljs-comment">// 当前可见的数据切片</span>
<span class="hljs-keyword">const</span> visibleItems = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">items</span>.<span class="hljs-title function_">slice</span>(startIndex.<span class="hljs-property">value</span>, endIndex.<span class="hljs-property">value</span>))

<span class="hljs-comment">// 平移偏移量（用于 translateY）</span>
<span class="hljs-keyword">const</span> offsetTop = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> startIndex.<span class="hljs-property">value</span> * props.<span class="hljs-property">itemHeight</span>)
</code></pre>
<h4 data-id="heading-6">3.滚动事件监听</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">onScroll</span> = (<span class="hljs-params"/>) =&gt; {
<span class="hljs-comment">//这里加一个判断防止DOM为渲染发生闪烁</span>
  <span class="hljs-keyword">if</span> (!containerRef.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>
  scrollTop.<span class="hljs-property">value</span> = containerRef.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span>
}

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 初始化计算，避免第一次渲染闪烁</span>
  <span class="hljs-title function_">onScroll</span>()
})
</code></pre>
<p><strong>HTML部分实现思路及代码：</strong></p>
<blockquote>
<p>包括三层的盒子：</p>
<p><strong>第一层</strong>：最外层固定高度的盒子，负责滚动
<strong>第二层</strong>：撑开高度，让滚动条看起来像有全部数据
<strong>第三层</strong>：可视区域，只渲染看得见的几条数据，跟着滚动动态移动</p>
</blockquote>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  &lt;!-- 外层容器：固定高度 + 滚动 --&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"containerRef"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"overflow-auto border rounded"</span>
    <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ height: `${props.height}px` }"</span>
    @<span class="hljs-attr">scroll</span>=<span class="hljs-string">"onScroll"</span>
  &gt;</span>
    <span class="hljs-comment">&lt;!-- 占位容器：撑起滚动条 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ height: `${totalHeight}px`, position: 'relative' }"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 渲染窗口：通过 translateY 偏移 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ transform: `translateY(${offsetTop}px)` }"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, idx) in visibleItems"</span>
          <span class="hljs-attr">:key</span>=<span class="hljs-string">"startIndex + idx"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"border-b px-3 flex items-center"</span>
          <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ height: `${props.itemHeight}px` }"</span>
        &gt;</span>
          {{ item }}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;
</code></pre>
<p><strong>父组件使用实例：</strong></p>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">VirtualList</span> <span class="hljs-attr">:items</span>=<span class="hljs-string">"list"</span> <span class="hljs-attr">:height</span>=<span class="hljs-string">"400"</span> <span class="hljs-attr">:itemHeight</span>=<span class="hljs-string">"35"</span> /&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VirtualList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./VirtualList.vue'</span>

<span class="hljs-comment">// 模拟 1 万条数据</span>
<span class="hljs-keyword">const</span> list = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">10000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> <span class="hljs-string">`第 <span class="hljs-subst">${i + <span class="hljs-number">1</span>}</span> 条数据`</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

</code></pre>
<h2 data-id="heading-7">四、优化方案：让虚拟列表更丝滑</h2>
<p>上面的基础版我们已经实现了最底层必要的代码，但在真实项目中可能还有下列问题：</p>
<ul>
<li>滚动事件触发太频繁</li>
<li>容器尺寸改变没有自动适配</li>
<li>想要暴露API比如：“滚动到第N行”</li>
<li>item如果不是字符串而是对象，访问属性会类型报错</li>
</ul>
<p>接下来我们给这个简易版的虚拟列表加点<strong>小优化</strong></p>
<h4 data-id="heading-8">1.使用<code>requestAnimationFrame</code>节流滚动事件</h4>
<p><strong>原因</strong>：
滚动事件（scroll）触发频率极高（每秒上百次），频繁计算会导致页面卡顿。</p>
<p><strong>解决</strong>： 利用浏览器的“下一帧更新”机制</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> <span class="hljs-attr">rafId</span>: number | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">onScroll</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!containerRef.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> top = containerRef.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span>

  <span class="hljs-comment">// 如果上一帧任务还没执行完，就取消它</span>
  <span class="hljs-keyword">if</span> (rafId !== <span class="hljs-literal">null</span>) <span class="hljs-title function_">cancelAnimationFrame</span>(rafId)

  <span class="hljs-comment">// 只保留最后一次</span>
  rafId = <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
    scrollTop.<span class="hljs-property">value</span> = top
    rafId = <span class="hljs-literal">null</span>
  })
}
</code></pre>
<p><strong>原理</strong>：</p>
<ul>
<li><code>requestAnimationFrame</code>让代码在“下一次屏幕绘制”前执行；</li>
<li>每帧约16ms，即使滚动再快，最多60次/秒，性能稳定</li>
</ul>
<h4 data-id="heading-9">2.支持“滚动到指定行”</h4>
<p>想让列表自动滚动第200行怎么做？</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">scrollToIndex</span>(<span class="hljs-params">index: number</span>) {
  <span class="hljs-keyword">if</span> (!containerRef.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>
  containerRef.<span class="hljs-property">value</span>.<span class="hljs-property">scrollTop</span> = index * props.<span class="hljs-property">itemHeight</span>
}
<span class="hljs-title function_">defineExpose</span>({ scrollToIndex })

</code></pre>
<p>父组件调用：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;button @click="goTo200"&gt;滚动到第 200 行&lt;/button&gt;
&lt;VirtualList ref="listRef" :items="list" /&gt;
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> listRef = <span class="hljs-title function_">ref</span>()
<span class="hljs-keyword">const</span> <span class="hljs-title function_">goTo200</span> = (<span class="hljs-params"/>) =&gt; listRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">scrollToIndex</span>(<span class="hljs-number">200</span>)
</code></pre>
<h4 data-id="heading-10">3.类型安全展示（防止TS报错）</h4>
<p>如果数据是对象，直接写<code>item.id</code>会报错（因为<code>item</code>是unknown）
<strong>解决</strong>：封装一个安全函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">displayText</span>(<span class="hljs-params">item: unknown</span>): string {
  <span class="hljs-keyword">if</span> (item &amp;&amp; <span class="hljs-keyword">typeof</span> item === <span class="hljs-string">'object'</span>) {
    <span class="hljs-keyword">const</span> r = item <span class="hljs-keyword">as</span> <span class="hljs-title class_">Record</span>&lt;string, unknown&gt;
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>(r.<span class="hljs-property">label</span> ?? r.<span class="hljs-property">id</span> ?? <span class="hljs-string">'[Object]'</span>)
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>(item)
}
<span class="hljs-comment">//模板</span>
{{ <span class="hljs-title function_">displayText</span>(item) }}
</code></pre>
<h4 data-id="heading-11">4.自动适配容器高度变化</h4>
<p>容器可能因父元素布局变化而高度改变，使用<code>ResizeObserver</code>自动监听。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { onBeforeUnmount } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">let</span> <span class="hljs-attr">resizeObserver</span>: <span class="hljs-title class_">ResizeObserver</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>
<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> el = containerRef.<span class="hljs-property">value</span>
  <span class="hljs-keyword">if</span> (el) {
    resizeObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 重新计算高度</span>
      containerHeight.<span class="hljs-property">value</span> = el.<span class="hljs-property">clientHeight</span>
    })
    resizeObserver.<span class="hljs-title function_">observe</span>(el)
  }
})
<span class="hljs-title function_">onBeforeUnmount</span>(<span class="hljs-function">() =&gt;</span> resizeObserver?.<span class="hljs-title function_">disconnect</span>())
</code></pre>
<h2 data-id="heading-12">五、最终结果</h2>
<p>现在实现的虚拟列表：</p>
<ul>
<li>流畅不卡顿；</li>
<li>类型安全；</li>
<li>可主动滚动；</li>
<li>自适应容器变化；</li>
<li>对象数据、字符串数据都能显示；</li>
<li>真正做到 <strong>性能与体验两不误</strong></li>
</ul>
<h2 data-id="heading-13">六、总结：</h2>
<h3 data-id="heading-14"/>

































<table><thead><tr><th>模块</th><th>作用</th></tr></thead><tbody><tr><td><code>totalHeight</code></td><td>撑出滚动条</td></tr><tr><td><code>visibleItems</code></td><td>控制渲染数量</td></tr><tr><td><code>offsetTop</code></td><td>平移到正确位置</td></tr><tr><td><code>requestAnimationFrame</code></td><td>优化高频滚动性能</td></tr><tr><td><code>scrollToIndex</code></td><td>提供外部控制</td></tr><tr><td><code>ResizeObserver</code></td><td>自适应容器尺寸</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[再见了，claude code]]></title>    <link>https://juejin.cn/post/7572749797468635145</link>    <guid>https://juejin.cn/post/7572749797468635145</guid>    <pubDate>2025-11-16T06:26:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572749797468635145" data-draft-id="7571636682694410280" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="再见了，claude code"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-16T06:26:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="golang学习记"/> <meta itemprop="url" content="https://juejin.cn/user/4371313964100990"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            再见了，claude code
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313964100990/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    golang学习记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T06:26:44.000Z" title="Sun Nov 16 2025 06:26:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🤖 从前，有个程序员，和他那沉默寡言的终端……</h2>
<p>他的终端，只会三件事：</p>
<ul>
<li><code>command not found</code></li>
<li><code>segmentation fault (core dumped)</code></li>
<li><code>Killed</code></li>
</ul>
<p>直到某天，他 <code>curl -fsSL https://opencode.ai/install | bash</code> ——<br/>
<strong>终端突然开口了：</strong></p>
<blockquote>
<p>“您好，检测到您刚写了一个 <code>for (i = 0; i &lt; 10; i++) console.log(i++);</code>……<br/>
您……是想打印偶数，还是单纯想挑战冯·诺依曼的极限？”</p>
</blockquote>
<p>那一刻，他知道：<strong>时代变了</strong>。</p>
<hr/>
<h2 data-id="heading-1">✨ 什么是 OpenCode？—— 你的 <code>bash</code> 终于考上了 AI 研究生</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsst%2Fopencode" target="_blank" title="https://github.com/sst/opencode" ref="nofollow noopener noreferrer">OpenCode</a> 是一个<strong>开源、本地优先、终端原生</strong>的 AI 编码助手。<br/>
它不像 Copilot 那样躲在 VS Code 的角落里当「幽灵实习生」，<br/>
而是直接 <code>cd</code> 进你的工作流，坐你隔壁工位，自带咖啡杯（和纠错本能）。</p>
<h3 data-id="heading-2">🌟 它能干啥？看几个真实场景：</h3>

























<table><thead><tr><th>你敲的命令</th><th>OpenCode 的反应</th></tr></thead><tbody><tr><td><code>opencode fix error in main.go</code></td><td>扫描 <code>main.go</code> → 定位 nil 指针 → 提供带注释的补丁</td></tr><tr><td><code>opencode add login to Express app</code></td><td>自动生成 <code>authMiddleware.js</code> + JWT 秘钥管理建议</td></tr><tr><td><code>opencode explain this function</code></td><td>用「人话」解释你三个月前写的“神逻辑”</td></tr><tr><td><code>opencode review before commit</code></td><td>模拟 PR 评审员：“这段用 <code>map</code> 比 <code>for</code> 更函数式，且少 2 个 bug”</td></tr></tbody></table>
<blockquote>
<p>🎯 关键优势：<strong>不用切窗口</strong>。<br/>
你还在 <code>vim</code> 里挣扎 <code>:wq!</code>，它已经帮你生成了单元测试。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06a7ba660fbc4996bb7b2756bdb89690~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763879203&amp;x-signature=%2FpbGPJ%2B30neOQ%2BKfBF5GDOMJAf8%3D" alt="OpenCode 交互界面" loading="lazy"/></p>
<blockquote>
<p>👆 这不是科幻片——这是你明天早上的终端。</p>
</blockquote>
<hr/>
<h2 data-id="heading-3">🛠️ 三步安装：比配置 <code>.bashrc</code> 还简单</h2>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1️⃣ 一键安装（连 `sudo` 都懒得要）</span>
curl -fsSL https://opencode.ai/install | bash

<span class="hljs-comment"># 2️⃣ 进项目目录</span>
<span class="hljs-built_in">cd</span> my-legacy-node-app-that-still-uses-callbacks

<span class="hljs-comment"># 3️⃣ 启动魔法</span>
opencode
</code></pre>
<p>首次运行时，敲 <code>/init</code>，它会默默读完整个项目（像极了你入职第一天翻三年前的代码），<br/>
然后生成一个 <code>agents.md</code> —— 相当于给 AI 助手发了本《本项目黑话手册》。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4ada58c94764f5a8e935b47e8542787~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29sYW5n5a2m5Lmg6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763879203&amp;x-signature=E9P1Fx7Px8ZOAltheJCY2lyLZdQ%3D" alt="项目初始化后生成 agents.md" loading="lazy"/></p>
<blockquote>
<p>🔍 小幽默时间：<br/>
当你问它：<em>“这个 repo 是干啥的？”</em><br/>
它答：<em>“一个用 React + Express + SQLite 实现的 Todo 应用……作者似乎想证明自己还没忘掉 CRUD。”</em><br/>
—— 精准扎心，还带文献综述 😭</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">🧩 为什么 OpenCode 比 claude code 更靠谱？</h2>






























<table><thead><tr><th>对比维度</th><th>网页版 AI（如 ChatGPT）</th><th>OpenCode</th></tr></thead><tbody><tr><td>上下文</td><td>“上次你说过什么？” ❓</td><td>记得你<code>package.json</code>里用的是<code>express@4.18</code> ✅</td></tr><tr><td>文件感知</td><td>“请粘贴代码” 📋</td><td>自动扫描 <code>./src</code>、<code>git diff</code>、甚至 <code>node_modules/.bin</code> 🔍</td></tr><tr><td>隐私</td><td>代码上云？祈祷 GDPR 吧 ☁️</td><td>默认<strong>本地运行</strong>；连 Ollama 都能塞进去 🔒</td></tr><tr><td>编辑能力</td><td>“复制 → 粘贴 → 手动改缩进” ✂️</td><td><code>accept all</code> → <code>git add .</code> → <code>git commit -m "AI did it"</code> ✅</td></tr></tbody></table>
<blockquote>
<p>💡 它甚至会在修改前问你：<br/>
<em>“我准备把 <code>if (err) throw err</code> 改成 <code>try/catch</code> + 日志记录，接受？[Y/n]”</em><br/>
—— 比某些队友还懂<strong>代码礼仪</strong>。</p>
</blockquote>
<h3 data-id="heading-5">上下文的力量</h3>
<p>OpenCode​ 最大的优势之一在于它如何处理上下文。传统的聊天机器人在几轮对话后会忘记你正在做什么。而 OpenCode 不会。</p>
<p>OpenCode​ 记住你的代码库，理解导入，并跟踪相关文件。这使得它更像一个真正的开发者助手。
假设你告诉它：“为我的 Go 应用添加身份验证。”</p>
<p>OpenCode​ 会扫描你的项目，识别路由定义的位置，创建登录中间件，甚至建议安全存储令牌的位置。正是这种上下文感知与自然语言理解的结合，使得 OpenCode 感觉更像一个队友，而不是一个工具。</p>
<hr/>
<h2 data-id="heading-6">🧪 实测：让 OpenCode 救一个“濒临崩溃”的项目</h2>
<p>假设你接了个老项目：</p>
<ul>
<li>用 <code>callback hell</code> 写的 Node.js 服务</li>
<li>报错：<code>TypeError: Cannot read property 'user' of undefined</code></li>
<li>上一个开发者已离职，GitHub 头像还是默认的章鱼 🐙</li>
</ul>
<h3 data-id="heading-7">操作流程：</h3>
<pre><code class="hljs language-bash" lang="bash">$ opencode explain the error <span class="hljs-keyword">in</span> server.js:42
</code></pre>
<p>→ 它定位到：</p>
<pre><code class="hljs language-js" lang="js">db.<span class="hljs-title function_">query</span>(<span class="hljs-string">"SELECT * FROM users WHERE id = ?"</span>, [req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>], <span class="hljs-function">(<span class="hljs-params">err, rows</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> user = rows[<span class="hljs-number">0</span>]; <span class="hljs-comment">// ← rows 为 [] 时 user = undefined！</span>
  res.<span class="hljs-title function_">json</span>({ <span class="hljs-attr">name</span>: user.<span class="hljs-property">name</span> }); <span class="hljs-comment">// 💥</span>
});
</code></pre>
<h3 data-id="heading-8">然后你输入：</h3>
<pre><code class="hljs language-bash" lang="bash">$ opencode refactor this to use async/await and add null check
</code></pre>
<p>它输出补丁（支持预览 + 一键应用）👇：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">- db.query("SELECT * FROM users WHERE id = ?", [req.params.id], (err, rows) =&gt; {</span>
<span class="hljs-deletion">-   const user = rows[0];</span>
<span class="hljs-deletion">-   res.json({ name: user.name });</span>
<span class="hljs-deletion">- });</span>
<span class="hljs-addition">+ try {</span>
<span class="hljs-addition">+   const [rows] = await db.promise().query(</span>
<span class="hljs-addition">+     "SELECT * FROM users WHERE id = ?",</span>
<span class="hljs-addition">+     [req.params.id]</span>
<span class="hljs-addition">+   );</span>
<span class="hljs-addition">+   if (!rows.length) {</span>
<span class="hljs-addition">+     return res.status(404).json({ error: "User not found" });</span>
<span class="hljs-addition">+   }</span>
<span class="hljs-addition">+   res.json({ name: rows[0].name });</span>
<span class="hljs-addition">+ } catch (err) {</span>
<span class="hljs-addition">+   console.error(err);</span>
<span class="hljs-addition">+   res.status(500).json({ error: "Internal server error" });</span>
<span class="hljs-addition">+ }</span>
</code></pre>
<blockquote>
<p>🎉 整个过程耗时：<strong>47 秒</strong><br/>
你喝了一口咖啡，项目起死回生。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">🛡️ 隐私？我们连 <code>.env</code> 都不偷看</h2>
<p>OpenCode 的座右铭是：</p>
<blockquote>
<p><strong>“你的代码，你的规则——我只负责动嘴，不动手上传。”</strong></p>
</blockquote>
<ul>
<li>✅ 支持本地模型（Ollama / Llama.cpp / vLLM）</li>
<li>✅ 可指定 API 密钥仅用于推理，<strong>不传文件内容</strong>（通过上下文摘要）</li>
<li>✅ 所有修改走 <code>git diff</code> 预览，<strong>人类 veto 权神圣不可侵犯</strong></li>
</ul>
<blockquote>
<p>🙃 开发者真实反馈：<br/>
<em>“终于有个 AI 不会在我写密码时建议‘建议用 bcrypt 加密’……它直接跳过了那行。”</em></p>
</blockquote>
<hr/>
<h2 data-id="heading-10">🎯 结语</h2>
<p>OpenCode 的哲学很简单：</p>
<blockquote>
<p><strong>“让机器干它擅长的——记忆、搜索、试错；<br/>
让人类干我们擅长的——决策、设计、甩锅……啊不，是归因分析。”</strong></p>
</blockquote>
<p>随着 AI 编码代理的成熟，编写代码与描述你想要的内容之间的界限将继续模糊。像 OpenCode​ 这样的工具向我们展示了那个未来可能的样子，一个开发者花费更少时间与语法斗争，而更多时间构建想法的未来。
想象一下，有一天你通过输入：“为带有用户身份验证和 SQLite 支持的待办事项应用创建一个 REST API。”
几秒钟内，你的项目结构、数据库和路由就准备好了，并由你的 AI 助手审查、测试和记录。
这就是 OpenCode​ 正在迈向的愿景：不仅仅是生成代码的 AI 工具，而是理解上下文、处理复杂性，并让人类保持控制的工具</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ChatGPT中的群聊功能试点项目]]></title>    <link>https://juejin.cn/post/7572493520004481058</link>    <guid>https://juejin.cn/post/7572493520004481058</guid>    <pubDate>2025-11-16T06:56:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572493520004481058" data-draft-id="7572714389942911028" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ChatGPT中的群聊功能试点项目"/> <meta itemprop="keywords" content="ChatGPT"/> <meta itemprop="datePublished" content="2025-11-16T06:56:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是魔丸啊"/> <meta itemprop="url" content="https://juejin.cn/user/3217622495411292"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ChatGPT中的群聊功能试点项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3217622495411292/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是魔丸啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T06:56:48.000Z" title="Sun Nov 16 2025 06:56:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fgroup-chats-in-chatgpt%2F" target="_blank" title="https://openai.com/index/group-chats-in-chatgpt/" ref="nofollow noopener noreferrer">原文</a></p>
<blockquote>
<p>群聊开始在移动设备和网页上向日本、新西兰、韩国和台湾。——额。。这是要包围东大吗。。</p>
</blockquote>
<p><strong>发布日期：2025年11月13日</strong>
<strong>分类：产品</strong></p>
<h2 data-id="heading-0">试点ChatGPT群聊功能</h2>
<p>与他人以及ChatGPT在同一对话中协作。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fchatgpt.com%2F%3Fopenaicom-did%3Dd70b6f18-35f1-4245-bcc8-934682ad98b9%26openaicom_referred%3Dtrue" target="_blank" title="https://chatgpt.com/?openaicom-did=d70b6f18-35f1-4245-bcc8-934682ad98b9&amp;openaicom_referred=true" ref="nofollow noopener noreferrer">在ChatGPT中试用</a>（在新窗口中打开）</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23be7d1d1b4e4babb6ef6ae0902939cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763881008&amp;x-signature=wbPFgaYMYnwuRKAesQ76VyYXAIA%3D" alt="图片描述：移动聊天屏幕显示群组对话。聊天顶部，圆形头像照片显示多位参与者。一条消息显示：&quot;是的意大利菜！Casa di Roma看起来很棒。谢谢ChatGPT。&quot;另一位参与者David回复：&quot;我要开始享用意大利面了……&quot;配有食物和笑脸表情符号。柔和的蓝色和紫色渐变背景。" loading="lazy"/></p>
<p>今天，我们开始在少数地区试点一种新体验，让人们能够轻松地彼此协作——以及与ChatGPT协作——在同一对话中。通过群聊，你可以将朋友、家人或同事带入共享空间，一起规划、做出决定或讨论想法。</p>
<p>无论你是在组织团体晚餐还是与同事起草大纲，ChatGPT都能提供帮助。群聊与你的私人对话是分开的，你的个人ChatGPT记忆永远不会与聊天中的任何人分享。</p>
<p>群聊开始在移动设备和网页上向日本、新西兰、韩国和台湾的ChatGPT Free、Go、Plus和Pro计划用户推出。这个试点是ChatGPT共享体验的小小第一步，我们期待从早期用户反馈中学习，以指导我们如何扩展到更多地区和ChatGPT计划。</p>
<h2 data-id="heading-1">与ChatGPT一起协作</h2>
<p>群聊让人们和ChatGPT能够进入同一对话。例如，如果你正在与朋友计划周末旅行，创建一个群聊，让ChatGPT帮助比较目的地、建立行程，并创建行李清单，让每个人都参与其中并跟进行程。</p>
<p>对于更实际的项目，如设计后院花园或为新公寓寻找艺术品，与你的伴侣或室友创建群聊，帮助协作设计想法、偏好和风格。这对于团体决策也很棒，比如找到适合每个人口味的餐厅，或者用公正的裁判解决友好的争论。</p>
<p>群聊也让工作或学校的协作变得更容易。你可以一起起草大纲或研究新话题。分享文章、笔记和问题，ChatGPT可以帮助总结和组织信息。</p>
<h2 data-id="heading-2">工作原理</h2>
<p>要开始群聊，请点击任何新聊天或现有聊天右上角的人员图标。当你将某人添加到现有聊天时，ChatGPT会创建你对话的副本作为新的群聊，这样你的原始对话就保持独立。你可以通过分享链接直接邀请1到20个人，群组中的任何人都可以分享该链接来邀请其他人。当你加入或创建你的第一个群聊时，系统会要求你设置一个包含姓名、用户名和照片的简短档案，这样每个人都知道谁在对话中。群聊可以在侧边栏一个新的清晰标记的部分中找到，方便访问。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2291d2c752cb4347988c22cd018fded7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piv6a2U5Li45ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763881008&amp;x-signature=lyCJz7BHigUgEIygWXVlOKqlEZg%3D" alt="图片描述：四个移动设备截图展示如何在ChatGPT中开始群聊" loading="lazy"/></p>
<p>群聊的工作方式与你平常的ChatGPT对话非常相似——只是现在其他人也可以加入。响应由GPT‑5.1 Auto驱动，它会根据提示以及用户基于其免费、Go、Plus或Pro计划可用的模型来选择最佳响应模型。搜索、图片和文件上传、图片生成和听写功能都已启用。速率限制仅在ChatGPT响应时适用——不适用于群聊中用户之间的消息——ChatGPT的响应计入被响应的人的可用限制。更多详细信息，你可以访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.openai.com%2Fen%2Farticles%2F12703475-group-chats-in-chatgpt" target="_blank" title="https://help.openai.com/en/articles/12703475-group-chats-in-chatgpt" ref="nofollow noopener noreferrer">帮助中心</a>（在新窗口中打开）。</p>
<p>我们还为群聊教给ChatGPT新的社交行为。它跟随对话的流程，并根据群组对话的上下文决定何时响应和何时保持安静。当你希望ChatGPT响应时，总可以在消息中提及"ChatGPT"。我们还赋予了ChatGPT用表情符号响应消息的能力，以及引用头像的功能——这样，当被要求在该群组对话中创建有趣的个性化图像时，它可以使用群组成员的头像。</p>
<p>你也可以管理群组设置——点击参与者图标来命名群组、添加或删除人员，或静音通知。你可以为ChatGPT在每个群聊中的响应方式设置自定义指令，无论是分享更多上下文还是给予特定的语调或个性。</p>
<h2 data-id="heading-3">隐私和控制的按设计实现</h2>
<p>群聊与你的私人对话是分开的。你的个人ChatGPT记忆不会在群聊中使用，ChatGPT也不会从这些对话中创建新的记忆。我们正在探索未来提供更细粒度的控制，这样你就可以选择ChatGPT是否以及如何与群聊使用记忆。</p>
<p>你处于控制之中。你必须接受邀请才能加入群聊。每个人都可以看到谁在聊天中，或随时离开。群组成员可以删除其他参与者，但群组创建者除外，创建者只能通过自己离开来被删除。</p>
<p>为年轻用户提供额外的安全保障。如果18岁以下的人使用群聊，ChatGPT会自动减少聊天中每个人对敏感内容的暴露。父母或监护人可以通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.openai.com%2Fen%2Farticles%2F12315553-parental-controls-on-chatgpt-faq" target="_blank" title="https://help.openai.com/en/articles/12315553-parental-controls-on-chatgpt-faq" ref="nofollow noopener noreferrer">家长控制</a>（在新窗口中打开）完全关闭群聊功能。</p>
<h2 data-id="heading-4">接下来的发展</h2>
<p>群聊只是ChatGPT成为协作和与他人互动的共享空间的开始。随着ChatGPT成为群组对话中更好的伙伴，它将帮助你激发想法、做出决策，并与生活中最重要的人一起表达你的创造力。当我们试点这个体验时，我们将学习人们如何一起使用ChatGPT，并将根据早期反馈继续改进。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Monorepo性能噩梦：一行配置解决VSCode卡顿与TS类型崩溃]]></title>    <link>https://juejin.cn/post/7572434032518807598</link>    <guid>https://juejin.cn/post/7572434032518807598</guid>    <pubDate>2025-11-15T03:44:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572434032518807598" data-draft-id="7572466174224465946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Monorepo性能噩梦：一行配置解决VSCode卡顿与TS类型崩溃"/> <meta itemprop="keywords" content="前端,Visual Studio Code,TypeScript"/> <meta itemprop="datePublished" content="2025-11-15T03:44:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="eason_fan"/> <meta itemprop="url" content="https://juejin.cn/user/2995517308808877"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Monorepo性能噩梦：一行配置解决VSCode卡顿与TS类型崩溃
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2995517308808877/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    eason_fan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T03:44:33.000Z" title="Sat Nov 15 2025 03:44:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    24
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Monorepo性能噩梦：一行配置解决VSCode卡顿与TS类型崩溃</h2>
<h3 data-id="heading-1">前言</h3>
<p>在现代前端开发中，Monorepo已成为管理大型项目的流行方案。它通过将多个项目、库和组件集中在同一个代码仓库中，简化了依赖管理和代码复用。然而，随着项目规模的扩大，Monorepo也可能带来一些意想不到的性能问题。</p>
<p>本文将分享一个我在实际项目中遇到的性能噩梦，以及如何通过一行简单的VSCode配置解决这个问题的经历。</p>
<h3 data-id="heading-2">问题背景</h3>
<p>我所在的项目是一个大型的Monorepo，其中包含一个主项目A，以及从A中拆分出的子包B和十几个组件库C-G。项目的引用关系变得非常复杂，TypeScript配置为直接读取源码进行类型生成，而不是依赖打包后的<code>dist</code>文件。</p>
<p>拆包之后，VSCode的性能急剧下降，出现了以下问题：</p>
<ul>
<li><strong>路径跳转卡顿</strong>：每次安装依赖后，第一次跳转到定义需要等待长达一分钟的初始化时间</li>
<li><strong>类型推断崩溃</strong>：TypeScript类型提示经常失效，导致出现大量<code>unsafe type error</code></li>
<li><strong>编辑器假死</strong>：需要频繁重启VSCode才能恢复正常</li>
</ul>
<p>我尝试了各种方法，包括调整TypeScript配置、升级VSCode、禁用插件等，但都无济于事。</p>
<h3 data-id="heading-3">问题根源</h3>
<p>经过反复排查，我发现问题的根源在于VSCode的<strong>文件监听机制</strong>。</p>
<p>由于我们的TypeScript配置是直接读取源码，<code>dist</code>目录下的打包文件实际上对类型推断是无用的。然而，VSCode的文件监听器（File Watcher）默认会监控项目中的所有文件变化，包括<code>dist</code>目录。</p>
<p>当我们在Monorepo中进行构建或安装依赖时，大量的<code>dist</code>文件会被生成或修改，导致VSCode的文件监听器不堪重负，占用了大量系统资源，从而引发了上述性能问题。</p>
<h3 data-id="heading-4">解决方案</h3>
<p>最终，我通过在项目的<code>.vscode/settings.json</code>文件中添加一行简单的配置，彻底解决了这个问题：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"files.watcherExclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"**/dist/**"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这行配置的作用是告诉VSCode的文件监听器<strong>忽略所有<code>dist</code>目录下的文件变化</strong>。</p>
<h4 data-id="heading-5">为什么这个配置有效？</h4>
<ol>
<li><strong>减少不必要的监听</strong>：排除了对<code>dist</code>目录的监听，大大减少了VSCode需要处理的文件变化事件</li>
<li><strong>释放系统资源</strong>：降低了CPU和内存占用，使VSCode能够更流畅地运行</li>
<li><strong>专注源码</strong>：让VSCode专注于监听源码文件，确保类型推断和路径跳转的性能</li>
</ol>
<h3 data-id="heading-6">总结</h3>
<p>如果你也在使用Monorepo，并且遇到了类似的性能问题，不妨检查一下你的VSCode配置。通过<code>files.watcherExclude</code>配置，排除掉不需要监听的目录，可能会给你带来意想不到的惊喜。</p>
<p>这个经历告诉我们，有时候解决复杂问题的答案可能就隐藏在最简单的配置中。希望这篇文章能帮助你摆脱Monorepo性能噩梦，享受更流畅的开发体验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3.4 正式发布：5个不可错过的性能优化与Composition API新特性]]></title>    <link>https://juejin.cn/post/7572524368879452194</link>    <guid>https://juejin.cn/post/7572524368879452194</guid>    <pubDate>2025-11-16T04:16:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572524368879452194" data-draft-id="7572537221540790287" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3.4 正式发布：5个不可错过的性能优化与Composition API新特性"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-16T04:16:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3.4 正式发布：5个不可错过的性能优化与Composition API新特性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T04:16:24.000Z" title="Sun Nov 16 2025 04:16:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vue 3.4 正式发布：5个不可错过的性能优化与Composition API新特性</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Vue.js 作为当今最流行的前端框架之一，一直在不断演进和完善。2023年底，Vue团队正式发布了Vue 3.4版本（代号"🏀 Slam Dunk"），这次更新带来了多项性能优化和Composition API的增强功能。本文将深入剖析5个最重要的性能改进和3个Composition API新特性，帮助开发者充分利用这些改进来构建更高效的Vue应用。</p>
<h2 data-id="heading-2">一、核心性能优化解析</h2>
<h3 data-id="heading-3">1. 模板编译器性能提升40%</h3>
<p>Vue 3.4对模板编译器进行了全面重写，特别是在大型模板的处理上表现尤为突出：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 旧版编译器处理复杂v-for的逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processFor</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 较慢的递归处理</span>
}

<span class="hljs-comment">// 新版采用线性处理方式</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">optimizeFor</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 基于静态分析的优化路径</span>
}
</code></pre>
<p>关键技术点：</p>
<ul>
<li>AST（抽象语法树）生成速度提升30%</li>
<li>SSR编译时内存占用减少50%</li>
<li>v-if/v-for嵌套处理采用新的启发式算法</li>
</ul>
<p>实测数据表明，在一个包含1000+节点的复杂表单场景下，编译时间从120ms降至72ms。</p>
<h3 data-id="heading-4">2. Reactivity系统微优化</h3>
<p>响应式系统的底层实现有这些改进：</p>
<ul>
<li>Proxy handler调用减少15%</li>
<li>track/tigger操作使用更轻量的数据结构</li>
<li>effect调度器引入优先级队列</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 新版响应式跟踪示例</span>
<span class="hljs-keyword">const</span> proxy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(target, {
  <span class="hljs-title function_">get</span>(<span class="hljs-params">target, key</span>) {
    <span class="hljs-title function_">track</span>(target, key) <span class="hljs-comment">// 更快的路径查找</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">get</span>(...<span class="hljs-variable language_">arguments</span>)
  }
})
</code></pre>
<h3 data-id="heading-5">3. Patch Flag优化策略调整</h3>
<p>虚拟DOM的diffing算法更新：</p>
<ul>
<li>dynamicChildren处理逻辑重构</li>
<li>Block Tree遍历顺序优化</li>
<li>Fragment节点特殊处理</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx">&lt;div&gt;
  &lt;!-- <span class="hljs-keyword">static</span> node --&gt;
  
&lt;/div&gt;
</code></pre>
<h2 data-id="heading-6">Composition API革命性改进</h2>
<h3 data-id="heading-7">setup语法糖的重大升级</h3>
<pre><code class="hljs language-typescript" lang="typescript"/></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PandaCoder：我的个人开发者工具进化之路]]></title>    <link>https://juejin.cn/post/7572525491538624554</link>    <guid>https://juejin.cn/post/7572525491538624554</guid>    <pubDate>2025-11-16T04:31:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572525491538624554" data-draft-id="7572524368879484962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" PandaCoder：我的个人开发者工具进化之路"/> <meta itemprop="keywords" content="后端,IntelliJ IDEA,程序员"/> <meta itemprop="datePublished" content="2025-11-16T04:31:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="舒一笑不秃头"/> <meta itemprop="url" content="https://juejin.cn/user/4257747754552599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             PandaCoder：我的个人开发者工具进化之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4257747754552599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    舒一笑不秃头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T04:31:15.000Z" title="Sun Nov 16 2025 04:31:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：从个人项目到开发者工具的转变</h2>
<p>在技术领域，我常常思考一个问题：什么样的工具才能真正帮助开发者？我意识到真正的价值不在于功能的数量，而在于这些功能是否真正解决了用户的痛点。作为PandaCoder的独立开发者，我的核心理念正是建立在这一认知之上——<strong>与其堆砌功能，不如倾听用户的声音</strong>。</p>
<h3 data-id="heading-1">工具的本质</h3>
<p>正如纳瓦尔所言："工具应该为你工作，而不是你为工具工作。"我设计PandaCoder的初衷是创建一个能够真正理解开发者需求的智能助手，而不是又一个需要复杂配置的负担。</p>
<h2 data-id="heading-2">用户反馈：产品进化的核心驱动力</h2>
<h3 data-id="heading-3">为什么建议比打赏更重要？</h3>
<p>在PandaCoder的设计中，我刻意将"✍️ 插件的建议"功能置于"☕️ 请作者喝杯"之前。这不是偶然，而是基于一个深刻的洞察：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d818826f430d44e9b279fc77876412b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763872275&amp;x-signature=eQdpb9YiOrepJUOiwEYdggGtOWM%3D" alt="" loading="lazy"/></p>
<p><strong>用户的建议是产品进化的燃料，而打赏只是这个过程的副产品。</strong></p>
<p>当开发者愿意花时间提供反馈时，实际上是在投资这个工具的未来。这种投资远比金钱更有价值，因为它包含了真实的用户体验和需求洞察。</p>
<h3 data-id="heading-4">反馈系统的设计哲学</h3>
<p>我设计的反馈系统采用了精心设计的交互体验：</p>
<ul>
<li><strong>智能限流机制</strong>：每日6次反馈限制，确保每一条建议都是经过深思熟虑的</li>
<li><strong>分类反馈</strong>：功能建议、Bug反馈、使用体验、其他，让反馈更有针对性</li>
<li><strong>即时确认</strong>：用户提交后立即收到确认，建立反馈闭环</li>
</ul>
<p>这种设计体现了史蒂文·巴特利特强调的"用户体验即品牌"理念。</p>
<h2 data-id="heading-5">功能演进：从用户需求出发</h2>
<h3 data-id="heading-6">中文编程助手的诞生</h3>
<p>最初的PandaCoder只是一个简单的翻译工具。但通过用户反馈，我发现中国开发者真正需要的是<strong>从中文思维到英文代码的顺畅转换</strong>，而不仅仅是文字翻译。</p>
<p>用户建议促使我开发了：</p>
<ul>
<li>智能命名转换（小驼峰、大驼峰、大写带下划线）</li>
<li>中文类名自动生成</li>
<li>多级翻译引擎（国内大模型 &gt; Google翻译 &gt; 百度翻译）</li>
</ul>
<h3 data-id="heading-7">Jenkins Pipeline支持的进化</h3>
<p>最初只是语法高亮，但用户反馈揭示了更深层次的需求：开发者在编写Pipeline时需要<strong>智能补全、环境变量管理、文档支持</strong>。</p>
<p>这些功能不是凭空想象的，而是来自真实用户的痛点反馈。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1015672231340d7865487387b6ad129~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763872275&amp;x-signature=mIJvodtmHcmN%2BFgM0Id6U7REenc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">SpringBoot配置的可视化</h3>
<p>通过用户建议，我实现了技术栈的智能识别和可视化显示。现在开发者打开配置文件时，能够直观看到使用的技术组件，大大提升了开发效率。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/312d7b796b3046a6b7196b0180b0bdc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763872275&amp;x-signature=%2BjLXoq98pShrk%2FynCPl8lvRWMvU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">数据驱动的产品迭代</h2>
<h3 data-id="heading-10">Git统计分析功能</h3>
<p>用户反馈显示，团队需要更好的代码协作洞察。我开发了：</p>
<ul>
<li>多维度代码统计</li>
<li>可视化图表展示</li>
<li>自动邮件报告系统</li>
</ul>
<p>这些功能帮助团队管理者了解开发进度，识别瓶颈，优化协作流程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/006903a9482d42019a279913d08d8c21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763872275&amp;x-signature=ZbMqjMjCesArBX6Eq1lz%2B%2Bmcf0c%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">实时监控体系的建立</h3>
<p>基于用户对调试效率的需求，我构建了完整的监控体系：</p>
<ul>
<li>Elasticsearch DSL监控</li>
<li>SQL执行监控</li>
<li>API调用链追踪</li>
</ul>
<p>这些功能让开发者能够实时了解应用运行状态，快速定位问题。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6090af814703472184ad9e6cf228f43f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IiS5LiA56yR5LiN56eD5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763872275&amp;x-signature=FbR8BAQcpHP7QV8qg0dwNhiffj0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">社区驱动的技术决策</h2>
<h3 data-id="heading-13">翻译引擎的选择</h3>
<p>最初我只支持百度翻译，但用户反馈显示：</p>
<ul>
<li>国内大模型在某些场景下翻译质量更高</li>
<li>Google翻译在国际化项目中有独特优势</li>
<li>需要多引擎备用确保服务稳定性</li>
</ul>
<p>这些反馈促使我建立了三级翻译引擎系统。</p>
<h3 data-id="heading-14">AI助手功能的扩展</h3>
<p>用户建议让我意识到：开发者需要的不只是翻译，还有<strong>代码审查、技术咨询、学习辅导</strong>等AI能力。</p>
<p>这促使我集成了多种AI模型，包括OpenAI、Ollama本地部署、国内大模型等。</p>
<h2 data-id="heading-15">技术实现背后的思考</h2>
<h3 data-id="heading-16">性能与用户体验的平衡</h3>
<p>在实现功能时，我始终遵循纳瓦尔的建议："在技术决策中，简单性往往比复杂性更有价值。"</p>
<p>例如：</p>
<ul>
<li>使用ConcurrentHashMap确保线程安全</li>
<li>实现延迟加载优化性能</li>
<li>合理的缓存策略提升响应速度</li>
</ul>
<h3 data-id="heading-17">可扩展性设计</h3>
<p>我采用模块化设计，确保新功能能够无缝集成。这种设计理念来源于用户对未来扩展性的需求预期。</p>
<h2 data-id="heading-18">用户参与的价值创造</h2>
<h3 data-id="heading-19">从使用者到共建者</h3>
<p>PandaCoder的成功案例证明：<strong>当用户参与产品设计时，他们从被动的使用者转变为积极的共建者。</strong></p>
<p>这种转变带来的价值是双向的：</p>
<ul>
<li>用户获得更符合需求的工具</li>
<li>我获得真实的用户洞察</li>
<li>整个生态实现良性循环</li>
</ul>
<h3 data-id="heading-20">反馈的乘数效应</h3>
<p>一个用户的建议可能影响数千名其他用户的使用体验。这种乘数效应是开源社区最强大的力量之一。</p>
<h2 data-id="heading-21">未来展望：基于用户需求的持续进化</h2>
<h3 data-id="heading-22">短期规划</h3>
<p>基于当前用户反馈，我计划：</p>
<ul>
<li>增强AI助手功能（代码生成、重构建议）</li>
<li>优化Git统计图表样式</li>
<li>改进邮件模板自定义功能</li>
</ul>
<h3 data-id="heading-23">中长期愿景</h3>
<p>用户建议指引我向更智能化的方向发展：</p>
<ul>
<li>代码智能分析与建议系统</li>
<li>项目健康度评估报告</li>
<li>团队协作效率分析工具</li>
</ul>
<h2 data-id="heading-24">结语：共建更好的开发者工具</h2>
<p>PandaCoder的成长历程印证了一个重要观点：<strong>最好的产品功能来源于真实用户的需求。</strong></p>
<p>我相信，技术工具的价值不在于它拥有多少功能，而在于它是否真正解决了开发者的问题。而了解这些问题的唯一途径，就是倾听用户的声音。</p>
<p>正如史蒂文·巴特利特所说："成功的企业不是那些拥有最好产品的企业，而是那些最了解客户需求的企业。"</p>
<p>我邀请每一位开发者参与PandaCoder的进化之旅。您的每一个建议都可能成为下一个重要功能的灵感来源。</p>
<hr/>
<p><strong>参与方式：</strong></p>
<ul>
<li>在IDE中点击"✍️ 插件的建议"提交反馈</li>
<li>通过GitHub Issues参与讨论</li>
</ul>
<hr/>
<p><em>舒一笑不秃头，生成式AI应用工程师(高级)认证，阿里云博客专家，专注于企业级Java开发和AI应用开发。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ArrayUtils：Java数组操作的瑞士军刀]]></title>    <link>https://juejin.cn/post/7572534419880034339</link>    <guid>https://juejin.cn/post/7572534419880034339</guid>    <pubDate>2025-11-16T03:13:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572534419880034339" data-draft-id="7572534419880017955" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ArrayUtils：Java数组操作的瑞士军刀"/> <meta itemprop="keywords" content="后端,设计,开源"/> <meta itemprop="datePublished" content="2025-11-16T03:13:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白衣鸽子"/> <meta itemprop="url" content="https://juejin.cn/user/3072451409619223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ArrayUtils：Java数组操作的瑞士军刀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3072451409619223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白衣鸽子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T03:13:02.000Z" title="Sun Nov 16 2025 03:13:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 前言</h3>
<blockquote>
<p>本文介绍的 ArrayUtils 以org.apache.commons.collections4.ArrayUtils 为例</p>
<p>源代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fcommons-collections%2Fblob%2Fmaster%2Fsrc%2Fmain%2Fjava%2Forg%2Fapache%2Fcommons%2Fcollections4%2FArrayUtils.java" target="_blank" title="https://github.com/apache/commons-collections/blob/master/src/main/java/org/apache/commons/collections4/ArrayUtils.java" ref="nofollow noopener noreferrer">org.apache.commons.collections4.ArrayUtils</a></p>
<p>自定义特征可以在自己服务内实现</p>
</blockquote>
<p>在Java应用开发中，数组操作是我们日常编码的基础任务之一。你是否曾写过下面这样的代码？</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">findUser</span><span class="hljs-params">(String[] users, String targetUser)</span> {
    <span class="hljs-keyword">if</span> (users == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; users.length; i++) {
        <span class="hljs-keyword">if</span> (targetUser == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">if</span> (users[i] == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (targetUser.equals(users[i])) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findUserIndex</span><span class="hljs-params">(String[] users, String targetUser)</span> {
    <span class="hljs-keyword">if</span> (users == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; users.length; i++) {
        <span class="hljs-comment">// ... 类似的重复代码</span>
    }
    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
}
</code></pre>
<p>这种手动遍历数组的方式不仅繁琐、重复，更重要的是需要处理各种边界情况（如空数组、null元素、起始位置等），容易出错且代码可读性差。一个精心设计的工具类可以封装这些通用逻辑，让数组操作变得简单而安全。本文将深入解析ArrayUtils工具类的实现原理，展示如何通过简洁的API解决数组操作的常见痛点。</p>
<h3 data-id="heading-1">2. 常用方法</h3>
<h4 data-id="heading-2">2.1 包含检查方法</h4>
<h5 data-id="heading-3">2.1.1 方法签名</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(Object[] array, Object objectToFind)</span>
</code></pre>
<h5 data-id="heading-4">2.1.2 应用示范</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayUtilsDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        String[] fruits = {<span class="hljs-string">"apple"</span>, <span class="hljs-string">"banana"</span>, <span class="hljs-string">"orange"</span>, <span class="hljs-literal">null</span>};
        
        <span class="hljs-comment">// 检查元素是否存在</span>
        System.out.println(ArrayUtils.contains(fruits, <span class="hljs-string">"apple"</span>)); <span class="hljs-comment">// true</span>
        System.out.println(ArrayUtils.contains(fruits, <span class="hljs-string">"grape"</span>)); <span class="hljs-comment">// false</span>
        System.out.println(ArrayUtils.contains(fruits, <span class="hljs-literal">null</span>));    <span class="hljs-comment">// true</span>
        
        <span class="hljs-comment">// 处理空数组场景</span>
        String[] emptyArray = <span class="hljs-literal">null</span>;
        System.out.println(ArrayUtils.contains(emptyArray, <span class="hljs-string">"test"</span>)); <span class="hljs-comment">// false</span>
    }
}
</code></pre>
<h5 data-id="heading-5">2.1.3 关键源码</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">contains</span><span class="hljs-params">(Object[] array, Object objectToFind)</span> {
    <span class="hljs-keyword">return</span> indexOf(array, objectToFind) != -<span class="hljs-number">1</span>;
}
</code></pre>
<h4 data-id="heading-6">2.2 索引查找方法</h4>
<h5 data-id="heading-7">2.2.1 方法签名</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> &lt;T&gt; <span class="hljs-type">int</span> <span class="hljs-title function_">indexOf</span><span class="hljs-params">(T[] array, Object objectToFind)</span>
<span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">indexOf</span><span class="hljs-params">(Object[] array, Object objectToFind, <span class="hljs-type">int</span> startIndex)</span>
</code></pre>
<h5 data-id="heading-8">2.2.2 应用示范</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IndexOfDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        Integer[] numbers = {<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>};
        
        <span class="hljs-comment">// 查找元素首次出现位置</span>
        System.out.println(ArrayUtils.indexOf(numbers, <span class="hljs-number">2</span>));     <span class="hljs-comment">// 1</span>
        System.out.println(ArrayUtils.indexOf(numbers, <span class="hljs-number">10</span>));    <span class="hljs-comment">// -1</span>
        System.out.println(ArrayUtils.indexOf(numbers, <span class="hljs-literal">null</span>));  <span class="hljs-comment">// 5</span>
        
        <span class="hljs-comment">// 从指定位置开始查找</span>
        System.out.println(ArrayUtils.indexOf(numbers, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>));  <span class="hljs-comment">// 3</span>
        System.out.println(ArrayUtils.indexOf(numbers, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>));  <span class="hljs-comment">// 6</span>
        
        <span class="hljs-comment">// 处理边界情况</span>
        System.out.println(ArrayUtils.indexOf(<span class="hljs-literal">null</span>, <span class="hljs-number">1</span>));        <span class="hljs-comment">// -1</span>
    }
}
</code></pre>
<h5 data-id="heading-9">2.2.3 关键源码</h5>
<blockquote>
<p>本质比较的是equals方法，如有需要可以重写equals方法</p>
</blockquote>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">indexOf</span><span class="hljs-params">(Object[] array, Object objectToFind, <span class="hljs-type">int</span> startIndex)</span> {
    <span class="hljs-keyword">if</span> (array == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (startIndex &lt; <span class="hljs-number">0</span>) {
            startIndex = <span class="hljs-number">0</span>;
        }

        <span class="hljs-keyword">if</span> (objectToFind == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> startIndex; i &lt; array.length; ++i) {
                <span class="hljs-keyword">if</span> (array[i] == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">return</span> i;
                }
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> startIndex; i &lt; array.length; ++i) {
                <span class="hljs-keyword">if</span> (objectToFind.equals(array[i])) {
                    <span class="hljs-keyword">return</span> i;
                }
            }
        }

        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
    }
}
</code></pre>
<h2 data-id="heading-10">3. 与Stream API的对比</h2>
<h3 data-id="heading-11">3.1 相同功能的不同实现</h3>
<p><strong>ArrayUtils方式：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检查包含</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">contains</span> <span class="hljs-operator">=</span> ArrayUtils.contains(array, target);

<span class="hljs-comment">// 查找索引</span>
<span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> ArrayUtils.indexOf(array, target);
</code></pre>
<p><strong>Stream API方式：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 检查包含</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">contains</span> <span class="hljs-operator">=</span> Arrays.stream(array)
                        .anyMatch(element -&gt; Objects.equals(element, target));

<span class="hljs-comment">// 查找索引（较为繁琐）</span>
<span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> IntStream.range(<span class="hljs-number">0</span>, array.length)
                    .filter(i -&gt; Objects.equals(array[i], target))
                    .findFirst()
                    .orElse(-<span class="hljs-number">1</span>);
</code></pre>
<h3 data-id="heading-12">3.2 性能对比</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceComparison</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        String[] largeArray = createLargeArray(<span class="hljs-number">100000</span>);
        
        <span class="hljs-comment">// ArrayUtils性能测试</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">start1</span> <span class="hljs-operator">=</span> System.nanoTime();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result1</span> <span class="hljs-operator">=</span> ArrayUtils.contains(largeArray, <span class="hljs-string">"target"</span>);
        <span class="hljs-type">long</span> <span class="hljs-variable">time1</span> <span class="hljs-operator">=</span> System.nanoTime() - start1;
        
        <span class="hljs-comment">// Stream API性能测试</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">start2</span> <span class="hljs-operator">=</span> System.nanoTime();
        <span class="hljs-type">boolean</span> <span class="hljs-variable">result2</span> <span class="hljs-operator">=</span> Arrays.stream(largeArray)
                               .anyMatch(<span class="hljs-string">"target"</span>::equals);
        <span class="hljs-type">long</span> <span class="hljs-variable">time2</span> <span class="hljs-operator">=</span> System.nanoTime() - start2;
        
        System.out.println(<span class="hljs-string">"ArrayUtils耗时: "</span> + time1 + <span class="hljs-string">"ns"</span>);
        System.out.println(<span class="hljs-string">"Stream API耗时: "</span> + time2 + <span class="hljs-string">"ns"</span>);
    }
}
</code></pre>
<h3 data-id="heading-13">3.3 适用场景分析</h3>








































<table><thead><tr><th>特性</th><th>ArrayUtils</th><th>Stream API</th></tr></thead><tbody><tr><td><strong>代码简洁性</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td></tr><tr><td><strong>性能</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐</td></tr><tr><td><strong>可读性</strong></td><td>⭐⭐⭐⭐⭐</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>函数式支持</strong></td><td>⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>链式操作</strong></td><td>不支持</td><td>支持</td></tr><tr><td><strong>空安全</strong></td><td>⭐⭐⭐⭐⭐</td><td>需要额外处理</td></tr></tbody></table>
<h2 data-id="heading-14">4. 总结</h2>
<p>ArrayUtils通过简洁的API设计，为我们提供了强大的数组操作能力。它的主要优势包括：</p>
<ol>
<li><strong>代码简洁性</strong>：将常见的数组操作封装成简单的方法调用</li>
<li><strong>空安全</strong>：妥善处理null值场景，提高代码健壮性</li>
<li><strong>灵活性</strong>：支持从指定位置开始搜索，满足不同业务需求</li>
<li><strong>类型安全</strong>：使用泛型确保类型一致性</li>
</ol>
<p>虽然这个工具类功能相对基础，但它体现了良好的设计思想：专注于解决特定问题，保持接口简单，处理边界情况。在实际开发中，我们可以借鉴这种设计思路，创建更多实用的工具类来提升开发效率。</p>
<p><strong>建议使用场景</strong>：适合中小型数组的快速操作，对于性能要求极高的场景建议考虑其他优化方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[linux上gitlab runner部署文档]]></title>    <link>https://juejin.cn/post/7572776177690427401</link>    <guid>https://juejin.cn/post/7572776177690427401</guid>    <pubDate>2025-11-16T04:23:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572776177690427401" data-draft-id="7572776177690411017" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="linux上gitlab runner部署文档"/> <meta itemprop="keywords" content="Java,GitHub"/> <meta itemprop="datePublished" content="2025-11-16T04:23:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="艾迪王"/> <meta itemprop="url" content="https://juejin.cn/user/2744837165290328"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            linux上gitlab runner部署文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2744837165290328/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    艾迪王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T04:23:06.000Z" title="Sun Nov 16 2025 04:23:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025年11月16日</p>
<h2 data-id="heading-0">背景</h2>
<p>平常使用的CI/CD主要是用Jenkins，git的本地hook，但是对于代码上传后执行差异代码优化这个技术场景流程场景来说：</p>
<ol>
<li>Jenkins流程只会做到全量排查，如果中途遇到问题代码导致失败，得不偿失，且一个仓库可能会有不再维护代码与无关代码，造成资源浪费</li>
<li>git本地hook问题在于，更新时每个组员都需要做，并且git commit的时候可以通过--no-verify 规避本地check，同时如果直接在gitlab上面IDE直接修改，则本地git hook脚本不会执行</li>
</ol>
<p>因此为了优化这一块的流水线，避免上述2个问题，我打算通过git合入时通过git 的CI/CD，执行脚本分析差异化文件</p>
<p>（本文因为离职后所有消息记录会被删除，因此图片是没有的，请见谅）</p>
<h2 data-id="heading-1">部署与验证</h2>
<p>gitlab自带部署runner文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.gitlab.cn%2Fdocs%2Fjh%2Finstall%2F" target="_blank" title="https://docs.gitlab.cn/docs/jh/install/" ref="nofollow noopener noreferrer">docs.gitlab.cn/docs/jh/ins…</a> ，同时csdn也有对应的文档可以借鉴 <a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_39826207%2Farticle%2Fdetails%2F144275485" target="_blank" title="https://blog.csdn.net/qq_39826207/article/details/144275485" ref="nofollow noopener noreferrer">blog.csdn.net/qq_39826207…</a> 不过实际上我在开发时也遇到了一点问题，所以也可以通过以下方式部署：</p>
<ol>
<li>
<p>准备Linux环境（Centos为例）</p>
</li>
<li>
<p>通过wget或者离线等方式获取gitlab runner的安装包</p>
</li>
<li>
<pre><code class="hljs language-sh" lang="sh"> <span class="hljs-comment"># 创建专用用户（不创建 home 目录）</span>
 sudo useradd --comment <span class="hljs-string">'GitLab Runner'</span> --create-home gitlab-runner
 ​
 <span class="hljs-comment"># 创建 runner 工作目录</span>
 sudo <span class="hljs-built_in">mkdir</span> /home/gitlab-runner/runner
 ​
 sudo <span class="hljs-built_in">chown</span> gitlab-runner:gitlab-runner /home/gitlab-runner/runner
</code></pre>
</li>
<li>
<p>初始化并启动 GitLab Runner（作为服务）</p>
<p>虽然使用二进制，但建议以系统服务方式运行。</p>
<ol>
<li>
<p>创建 systemd 服务文件</p>
<pre><code class="hljs language-sh" lang="sh"> sudo <span class="hljs-built_in">tee</span> /etc/systemd/system/gitlab-runner.service &lt;&lt;<span class="hljs-string">EOF
 [Unit]
 Description=GitLab Runner
 After=syslog.target network.target
 ConditionFileIsExecutable=/usr/local/bin/gitlab-runner
 ​
 [Service]
 StartLimitInterval=5
 StartLimitBurst=10
 ExecStart=/usr/local/bin/gitlab-runner run --working-directory /home/gitlab-runner/runner
 SuccessExitStatus=0 143
 Restart=always
 RestartSec=5
 KillMode=mixed
 WorkingDirectory=/home/gitlab-runner/runner
 User=gitlab-runner
 Group=gitlab-runner
 Environment=PATH=/bin:/usr/local/bin:/usr/bin
 CacheDirectory=gitlab-runner
 CacheDirectoryMode=0750
 ​
 [Install]
 WantedBy=multi-user.target
 EOF</span>
</code></pre>
</li>
<li>
<p>重载 systemd 并启动服务</p>
<pre><code class="hljs language-bash" lang="bash"> sudo systemctl daemon-reexec
 sudo systemctl daemon-reload
 sudo systemctl <span class="hljs-built_in">enable</span> gitlab-runner
 sudo systemctl start gitlab-runner
</code></pre>
</li>
<li>
<p>检查服务状态</p>
<pre><code class="hljs language-sh" lang="sh"> sudo systemctl status gitlab-runner
</code></pre>
</li>
</ol>
</li>
<li>
<p>注册GitLab Runner 到 GitLab 实例</p>
<p>（如果是多次注册，则需要优先按照第一步切换成对应的gitlab用户进行命令操作，整个的安装流程，我按照官方流程没成功，和当前流程唯一的差别就是官方没有切换到gitlab用户）</p>
<ol>
<li>
<p>获取注册令牌 登录 GitLab Web 界面。 进入你的项目 → Settings → CI / CD → Runners。 复制 Registration token（项目级 Runner）。 或者在 Admin Area → Overview → Runners 获取实例级令牌。</p>
</li>
<li>
<p>运行注册命令： 切换到 gitlab-runner 用户并注册：</p>
<pre><code class="hljs language-sh" lang="sh"> sudo -u gitlab-runner -H /usr/local/bin/gitlab-runner register
</code></pre>
<p>按提示输入：</p>
<ul>
<li>GitLab instance URL: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitlab.com%2F" target="_blank" title="https://gitlab.com/" ref="nofollow noopener noreferrer">gitlab.com</a>（或你的自建 GitLab 地址）</li>
<li>Registration token: 你复制的令牌</li>
<li>Description: my-runner（自定义描述）</li>
<li>Tags: linux,docker（可选，用于任务匹配）</li>
<li>Executor: shell（或 docker, docker+machine 等）</li>
<li>Default Docker image: alpine:latest（如果使用 docker executor）</li>
</ul>
</li>
<li>
<p>按提示输入：</p>
<ul>
<li>GitLab instance URL: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitlab.com%2F" target="_blank" title="https://gitlab.com/" ref="nofollow noopener noreferrer">gitlab.com</a>（或你的自建 GitLab 地址）</li>
<li>Registration token: 你复制的令牌</li>
<li>Description: my-runner（自定义描述）</li>
<li>Tags: linux,docker（可选，用于任务匹配）、</li>
<li>Executor: shell（或 docker, docker+machine 等）</li>
<li>Default Docker image: alpine:latest（如果使用 docker executor）</li>
<li>注册成功后，配置会保存在 /home/gitlab-runner/runner/config.toml。</li>
</ul>
</li>
</ol>
</li>
</ol>
<p>验证注册： 在 GitLab Web 界面的 Runners 页面，应看到新注册的 Runner 处于“在线”状态。</p>
<h2 data-id="heading-2">卸载</h2>
<p>有时候可能是安装错误，可能是需要迁移业务，需要现在原有的环境的服务，可以按照以下步骤</p>
<ol>
<li>
<p>停止并禁用服务</p>
<pre><code class="hljs language-sh" lang="sh"> sudo systemctl stop gitlab-runner
 sudo systemctl <span class="hljs-built_in">disable</span> gitlab-runner
</code></pre>
</li>
<li>
<p>删除服务文件</p>
<pre><code class="hljs language-sh" lang="sh"> sudo <span class="hljs-built_in">rm</span> /etc/systemd/system/gitlab-runner.service
 sudo systemctl daemon-reload
</code></pre>
</li>
<li>
<p>删除二进制文件和用户</p>
<pre><code class="hljs language-sh" lang="sh"> sudo <span class="hljs-built_in">rm</span> /usr/local/bin/gitlab-runner
 <span class="hljs-comment"># -r 删除用户主目录</span>
 sudo userdel -r gitlab-runner  
</code></pre>
</li>
<li>
<p>清理残留文件（可选）</p>
<pre><code class="hljs language-sh" lang="sh">sudo <span class="hljs-built_in">rm</span> -rf /home/gitlab-runner
</code></pre>
</li>
</ol>
<h2 data-id="heading-3">脚本分享</h2>
<h3 data-id="heading-4">.gitlab-ci.yml</h3>
<p>这个是仓库全局的git CI/CD的配置文件，根据触发阶段可以执行对应的script相关的脚本，在该脚本可以执行更多shell脚本，方便管理</p>
<p>该例子是合入时执行2个脚本，可供参考</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">stages:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-string">check</span>

<span class="hljs-comment"># 全局变量</span>
<span class="hljs-attr">variables:</span>
  <span class="hljs-attr">GIT_DEPTH:</span> <span class="hljs-string">""</span>  <span class="hljs-comment"># 完整克隆</span>

<span class="hljs-comment"># 只在 Merge Request 时触发流水线（即“合入前检查”）</span>
<span class="hljs-attr">workflow:</span>
  <span class="hljs-attr">rules:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">if:</span> <span class="hljs-string">$CI_PIPELINE_SOURCE</span> <span class="hljs-string">==</span> <span class="hljs-string">"merge_request_event"</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">when:</span> <span class="hljs-string">never</span>

<span class="hljs-attr">check:</span>
  <span class="hljs-attr">stage:</span> <span class="hljs-string">check</span>
  <span class="hljs-attr">interruptible:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 可中断：当 MR 更新时取消旧流水线</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-comment"># 脚本1：权限/配置检查</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">chmod</span> <span class="hljs-string">+x</span> <span class="hljs-string">./cloud/env/install/script/config_checkstyle.sh</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">./cloud/env/install/script/config_checkstyle.sh</span> <span class="hljs-string">ucs-server</span> <span class="hljs-string">$GITLAB_USER_EMAIL</span> <span class="hljs-string">$CI_MERGE_REQUEST_TARGET_BRANCH_NAME</span>

    <span class="hljs-comment"># 脚本2：另一个检查脚本（示例）</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">chmod</span> <span class="hljs-string">+x</span> <span class="hljs-string">./cloud/env/install/script/another_check.sh</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">./cloud/env/install/script/another_check.sh</span>

  <span class="hljs-comment"># 只在 MR 中运行</span>
  <span class="hljs-attr">only:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">merge_requests</span>

  <span class="hljs-attr">tags:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">ucs_server</span>

  <span class="hljs-comment"># 可选：指定 MR 的目标分支（比如只对 main/develop 的合入做检查）</span>
  <span class="hljs-comment"># rules:</span>
  <span class="hljs-comment">#   - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME =~ /^(main|develop)$/</span>
</code></pre>
<h3 data-id="heading-5">sh脚本文件</h3>
<h4 data-id="heading-6">Java验证差异文件</h4>
<p>用于验证合入时两个分支之间的差异文件，对差异文件进行checkstyle（通过执行jar包）有问题就返回0，无问题会返回1，gitlab合并检测会根据返回值判定流水线成功/失败</p>
<p>原有脚本已经遗失，判断逻辑应当是jar包产生的输出，应当只看[WARN][ERROR]开头的的行是否&gt;0，有则有问题（需要jar包启动checkstyle，需要xml配置文件进行规则配置）</p>
<p>Java程序的checkstyle需要以不同版本为大前提创建各自环境，其他的如本地执行hook，Jenkins执行，git CI/CD执行流程，需要的各种静态资源需要一致</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># ================== 参数校验 ==================</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-variable">$#</span> -ne 4 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: <span class="hljs-variable">$0</span> &lt;namespace&gt; &lt;email&gt; &lt;source_branch&gt; &lt;target_branch&gt;"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Example: <span class="hljs-variable">$0</span> ucs-server dev@example.com feature/add-config main"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

NAMESPACE=<span class="hljs-variable">$1</span>
EMAIL=<span class="hljs-variable">$2</span>
SOURCE_BRANCH=<span class="hljs-variable">$3</span>
TARGET_BRANCH=<span class="hljs-variable">$4</span>

<span class="hljs-comment"># ================== 配置区 ==================</span>
<span class="hljs-comment"># Checkstyle jar 包路径（请根据实际路径修改）</span>
CHECKSTYLE_JAR=<span class="hljs-string">"./cloud/env/install/script/checkstyle.jar"</span>

<span class="hljs-comment"># Checkstyle 配置文件路径（checkstyle.xml）</span>
CHECKSTYLE_CONFIG=<span class="hljs-string">"./cloud/env/install/script/checkstyle.xml"</span>

<span class="hljs-comment"># 临时文件用于保存 Checkstyle 输出</span>
CHECKSTYLE_LOG=<span class="hljs-string">"/tmp/checkstyle_output_$$_<span class="hljs-subst">$(date +%s)</span>.txt"</span>
<span class="hljs-comment"># ===========================================</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Analyzing Java files changed between '<span class="hljs-variable">$SOURCE_BRANCH</span>' and '<span class="hljs-variable">$TARGET_BRANCH</span>'..."</span>

<span class="hljs-comment"># 1. 确保远程分支存在</span>
<span class="hljs-keyword">if</span> ! git rev-parse --verify <span class="hljs-string">"origin/<span class="hljs-variable">$SOURCE_BRANCH</span>"</span> &gt; /dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Error: Remote branch 'origin/<span class="hljs-variable">$SOURCE_BRANCH</span>' not found."</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Available branches:"</span>; git branch -r
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-keyword">if</span> ! git rev-parse --verify <span class="hljs-string">"origin/<span class="hljs-variable">$TARGET_BRANCH</span>"</span> &gt; /dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Error: Remote branch 'origin/<span class="hljs-variable">$TARGET_BRANCH</span>' not found."</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Available branches:"</span>; git branch -r
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 2. 获取两个分支之间变更的 Java 文件</span>
CHANGED_JAVA_FILES=()

<span class="hljs-keyword">while</span> IFS= <span class="hljs-built_in">read</span> -r file; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> == *.java ]] &amp;&amp; [ -f <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> ]; <span class="hljs-keyword">then</span>
        CHANGED_JAVA_FILES+=(<span class="hljs-string">"<span class="hljs-variable">$file</span>"</span>)
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span> &lt; &lt;(git diff --name-only <span class="hljs-string">"origin/<span class="hljs-variable">$TARGET_BRANCH</span>"</span>...origin/<span class="hljs-variable">$SOURCE_BRANCH</span>)

<span class="hljs-comment"># 3. 检查是否有变更的 Java 文件</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-variable">${#CHANGED_JAVA_FILES[@]}</span> -eq 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"No Java files changed between 'origin/<span class="hljs-variable">$TARGET_BRANCH</span>' and 'origin/<span class="hljs-variable">$SOURCE_BRANCH</span>'."</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"No Java changes detected."</span> | mail -s <span class="hljs-string">"<span class="hljs-variable">$NAMESPACE</span>: No Java changes"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span>
    <span class="hljs-built_in">exit</span> 0  <span class="hljs-comment"># 无变更视为通过</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"Found <span class="hljs-variable">${#CHANGED_JAVA_FILES[@]}</span> Java file(s) to check:"</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">'  %s\n'</span> <span class="hljs-string">"<span class="hljs-variable">${CHANGED_JAVA_FILES[@]}</span>"</span>

<span class="hljs-comment"># 4. 执行 Checkstyle 检查（一次性传入所有文件）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Running Checkstyle..."</span>
<span class="hljs-comment"># 使用 -c 指定配置，-f xml 或 summary 可选，这里使用简洁格式</span>
<span class="hljs-comment"># 如果你希望详细输出，可以使用 -f xml 并用 xmllint 格式化</span>
<span class="hljs-keyword">if</span> java -jar <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_JAR</span>"</span> -c <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_CONFIG</span>"</span> <span class="hljs-string">"<span class="hljs-variable">${CHANGED_JAVA_FILES[@]}</span>"</span> &gt; <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span> 2&gt;&amp;1; <span class="hljs-keyword">then</span>
    <span class="hljs-comment"># Checkstyle 命令执行成功（语法正确），但不代表无警告/错误</span>
    OUTPUT=$(<span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>)
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$OUTPUT</span>"</span>

    <span class="hljs-comment"># 检查输出中是否包含违规信息（Checkstyle 通常会在有违规时输出内容）</span>
    <span class="hljs-keyword">if</span> [[ -s <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span> &amp;&amp; <span class="hljs-string">"<span class="hljs-subst">$(echo <span class="hljs-string">"<span class="hljs-variable">$OUTPUT</span>"</span> | grep -v '^$' | wc -l)</span>"</span> -gt 0 ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Checkstyle found issues in changed Java files."</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Checkstyle Report:"</span> | mail -s <span class="hljs-string">"[FAIL] <span class="hljs-variable">$NAMESPACE</span>: Checkstyle failed"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span> -A <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>
        <span class="hljs-built_in">rm</span> -f <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>
        <span class="hljs-built_in">exit</span> 1  <span class="hljs-comment"># 有违规 → 失败</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"All changed Java files passed Checkstyle."</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"No checkstyle violations found."</span> | mail -s <span class="hljs-string">"[OK] <span class="hljs-variable">$NAMESPACE</span>: Checkstyle passed"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span>
        <span class="hljs-built_in">rm</span> -f <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>
        <span class="hljs-built_in">exit</span> 0  <span class="hljs-comment"># 无违规 → 成功</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-comment"># Checkstyle 命令执行失败（如 jar 报错、配置错误等）</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Checkstyle execution failed!"</span>
    <span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Checkstyle execution failed. See details."</span> | mail -s <span class="hljs-string">"[ERROR] <span class="hljs-variable">$NAMESPACE</span>: Checkstyle execution error"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span> -A <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>
    <span class="hljs-built_in">rm</span> -f <span class="hljs-string">"<span class="hljs-variable">$CHECKSTYLE_LOG</span>"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>
</code></pre>
<h4 data-id="heading-7">yml验证差异文件</h4>
<p>与上面的Java验证类似，就是查询差异文件yml与yaml，checkstyle有问题就返回0，无问题会返回1，gitlab合并检测会根据返回值判定流水线成功/失败</p>
<p>（如果是spring可以跳过所有的application.yml文件，因为yml 验证主要是为了交付给运维同事配置文件才会有的流水线步骤）</p>
<p>原有脚本已经遗失，判断逻辑应当通过yamllint进行验证，根据输出产生行数&gt;0则有问题（需要ymlconf文件作为配置规则）</p>
<pre><code class="hljs language-sh" lang="sh"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-keyword">if</span> [ <span class="hljs-variable">$#</span> -ne 2 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"Usage: <span class="hljs-variable">$0</span> &lt;namespace&gt; &lt;email&gt;"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

NAMESPACE=<span class="hljs-variable">$1</span>
EMAIL=<span class="hljs-variable">$2</span>

<span class="hljs-comment"># ================== 配置区 ==================</span>
TARGET_BRANCH=<span class="hljs-string">"main"</span>  <span class="hljs-comment"># 目标合并分支，可根据需要改为 dev、release 等</span>
CONFIG_FILE=<span class="hljs-string">"./cloud/env/install/script/ymlconf"</span>
<span class="hljs-comment"># ===========================================</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"🔍 Checking YAML files changed between current branch and '<span class="hljs-variable">$TARGET_BRANCH</span>'..."</span>

<span class="hljs-comment"># 1. 获取当前分支相对于目标分支的差异文件（仅新增或修改）</span>
<span class="hljs-comment"># 注意：GitLab CI 会自动 fetch 所有分支，可以直接使用</span>
CHANGED_YAML_FILES=()
<span class="hljs-keyword">while</span> IFS= <span class="hljs-built_in">read</span> -r file; <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> == *.yml || <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> == *.yaml ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> ]; <span class="hljs-keyword">then</span>  <span class="hljs-comment"># 确保文件存在（避免删除的文件）</span>
            CHANGED_YAML_FILES+=(<span class="hljs-string">"<span class="hljs-variable">$file</span>"</span>)
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span> &lt; &lt;(git diff --name-only <span class="hljs-string">"origin/<span class="hljs-variable">$TARGET_BRANCH</span>"</span>...HEAD)

<span class="hljs-comment"># 2. 检查是否有变更的 YAML 文件</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-variable">${#CHANGED_YAML_FILES[@]}</span> -eq 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ No YAML files changed. Skipping yamllint."</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"No YAML changes detected."</span> | mail -s <span class="hljs-string">"<span class="hljs-variable">$NAMESPACE</span>: No YAML changes"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span>
    <span class="hljs-built_in">exit</span> 0
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"📄 Found <span class="hljs-variable">${#CHANGED_YAML_FILES[@]}</span> YAML file(s) to check:"</span>
<span class="hljs-built_in">printf</span> <span class="hljs-string">'  %s\n'</span> <span class="hljs-string">"<span class="hljs-variable">${CHANGED_YAML_FILES[@]}</span>"</span>

<span class="hljs-comment"># 3. 对差异文件逐个运行 yamllint</span>
ERRORS_FOUND=<span class="hljs-string">""</span>
<span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${CHANGED_YAML_FILES[@]}</span>"</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">" linting <span class="hljs-variable">$file</span>"</span>
    <span class="hljs-keyword">if</span> ! yamllint -c <span class="hljs-string">"<span class="hljs-variable">$CONFIG_FILE</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$file</span>"</span> &gt; /tmp/yamllint.log 2&gt;&amp;1; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ yamllint failed on <span class="hljs-variable">$file</span>"</span>
        ERRORS_FOUND+=<span class="hljs-string">"<span class="hljs-variable">$file</span>:\n"</span>
        ERRORS_FOUND+=$(<span class="hljs-built_in">cat</span> /tmp/yamllint.log)
        ERRORS_FOUND+=<span class="hljs-string">"\n\n"</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">done</span>

<span class="hljs-comment"># 4. 处理结果</span>
<span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$ERRORS_FOUND</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"YAML file has syntax errors!"</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">$ERRORS_FOUND</span>"</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">$ERRORS_FOUND</span>"</span> | mail -s <span class="hljs-string">"<span class="hljs-variable">$NAMESPACE</span> YAML file has syntax errors!"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span>
    <span class="hljs-built_in">rm</span> -f /tmp/yamllint.log
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ All changed YAML files are valid."</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"All changed YAML files passed lint."</span> | mail -s <span class="hljs-string">"<span class="hljs-variable">$NAMESPACE</span>: YAML lint passed"</span> <span class="hljs-string">"<span class="hljs-variable">$EMAIL</span>"</span>
    <span class="hljs-built_in">rm</span> -f /tmp/yamllint.log
    <span class="hljs-built_in">exit</span> 0
<span class="hljs-keyword">fi</span>
</code></pre>
<h2 data-id="heading-8">其他问题</h2>
<h3 data-id="heading-9">gitlab runner实例在shell模式下怎么占用Centos资源的</h3>
<p>在 shell executor 模式下，GitLab Runner 的工作方式如下：</p>
<ul>
<li>
<p>直接在宿主机（Centos）上执行命令：Runner 会以运行它的用户身份（如 gitlab-runner 用户），在系统 shell 中直接执行 .gitlab-ci.yml 中定义的 script 命令。</p>
</li>
<li>
<p>资源占用特点：</p>
<ul>
<li>CPU/内存：由实际执行的脚本决定（如编译、测试、打包等），直接消耗宿主机资源。</li>
<li>磁盘：会在临时目录（默认 /home/gitlab-runner/builds//...）克隆代码并执行任务，任务结束后默认清理（可通过 builds_dir 配置）。</li>
<li>环境依赖：所有依赖（如 Python、Node.js、Docker CLI 等）必须预先安装在 Centos 系统中。</li>
<li>无隔离性：多个 job 共享同一系统环境，可能互相干扰（比如修改全局 PATH、写文件到 /tmp）。</li>
<li>并发控制：通过 concurrent（全局）和 limit（每个 runner）控制同时运行的 job 数，避免资源耗尽。</li>
</ul>
</li>
</ul>
<p>建议：</p>
<ul>
<li>生产环境慎用 shell 模式，推荐用 docker 或 kubernetes 提供隔离。</li>
<li>如果必须用 shell，确保 runner 用户权限最小化，并监控系统负载。</li>
</ul>
<h3 data-id="heading-10">gitlab CI/CD如果失败，可不可以阻止合并任务</h3>
<p>实现方式：</p>
<ul>
<li>
<p>启用“合并前必须通过流水线”：</p>
<ul>
<li>进入项目 → Settings &gt; General &gt; Merge requests</li>
<li>勾选 Pipelines must succeed</li>
<li>（可选）勾选 Require approval from code owners</li>
</ul>
</li>
<li>
<p>保护目标分支（如 main / develop）：（这个对于有规模的开发团队，已经有CMO进行配置过了）</p>
<ul>
<li>
<p>Settings &gt; Repository &gt; Protected Branches</p>
</li>
<li>
<p>对目标分支设置：</p>
<ul>
<li>Allowed to merge: Maintainers（或指定角色）</li>
<li>Require status checks to pass before merging（如果启用了外部状态检查）</li>
</ul>
</li>
</ul>
</li>
<li>
<p>结果：</p>
<ul>
<li>如果 CI pipeline 失败（任何 job 失败且未被 allow_failure: true 忽略），Merge 按钮变灰，无法合并。</li>
<li>即使有 Approver 同意，只要 pipeline 失败，也无法合并。 工作流程：</li>
</ul>
</li>
<li>
<p>注册：Runner 向 GitLab Server 注册，获得唯一 token，并绑定到项目或 group。</p>
</li>
<li>
<p>轮询/长连接：Runner 定期向 GitLab Server 的 /jobs/request API 发起请求（默认每几秒一次），询问是否有待处理的 job。</p>
</li>
<li>
<p>领取任务：当有匹配标签（tags）的 job 到来，Runner 领取任务（包含 .gitlab-ci.yml 中的 script、variables、artifacts 等信息）。</p>
</li>
<li>
<p>执行任务 ：</p>
<ul>
<li>根据配置的 executor（shell/docker/ssh/k8s 等）启动执行环境；</li>
<li>克隆代码；</li>
<li>执行 before_script → script → after_script；</li>
<li>上传 artifacts/logs；</li>
<li>上报状态（success/failure）。</li>
</ul>
</li>
<li>
<p>释放资源：任务结束，清理临时文件（除非配置保留）。</p>
</li>
</ul>
<h3 data-id="heading-11">gitlab CI/CD，如果要执行脚本，有哪些参数是gitlab这边可以提供</h3>
<p>GitLab 自动注入大量 预定义 CI/CD 变量（Predefined Variables），你可以在脚本中直接使用，例如：</p>
<p>常用内置变量示例：</p>





















<table><thead><tr><th>变量</th><th>说明</th></tr></thead><tbody><tr><td>CI_COMMIT_REF_NAME</td><td>当前分支或 tag 名（如 main, v1.0）</td></tr><tr><td>CI_PROJECT_DIR</td><td>CI 任务的工作目录（代码被 clone 到这里）</td></tr><tr><td>GITLAB_USER_EMAIL</td><td>触发 pipeline 的用户邮箱</td></tr></tbody></table>
<p>其他的像是两个分支的分支hash也可以通过git提供的参数获取到，用于差异文件的排查。更多的可以看官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.gitlab.com%2Fci%2Fvariables%2Fpredefined_variables%2F" target="_blank" title="https://docs.gitlab.com/ci/variables/predefined_variables/" ref="nofollow noopener noreferrer">docs.gitlab.com/ci/variable…</a></p>
<h3 data-id="heading-12">合并任务下，两个分支都有脚本，改用哪一个，如果任意一方缺少脚本，该用哪一个</h3>
<p>GitLab 的规则非常明确： 始终使用 source branch（源分支）中的 .gitlab-ci.yml 文件</p>
<p>详细说明：</p>
<ul>
<li>当你创建一个从 feature → main 的 MR，</li>
<li>GitLab 会 checkout feature 分支的代码，</li>
<li>并读取 feature 分支根目录下的 .gitlab-ci.yml 来执行 pipeline。</li>
<li>不会去读 main 分支的 .gitlab-ci.yml。</li>
</ul>

























<table><thead><tr><th>情况</th><th>使用哪个 .gitlab-ci.yml?</th></tr></thead><tbody><tr><td>feature 有，main 有</td><td>✅ 用 feature 的</td></tr><tr><td>feature 有，main 没有</td><td>✅ 用 feature 的</td></tr><tr><td>feature 没有，main 有</td><td>❌ pipeline 不会触发（因为 source branch 没有 .gitlab-ci.yml）</td></tr><tr><td>两者都没有</td><td>❌ 无 CI pipeline</td></tr></tbody></table>
<h3 data-id="heading-13">gitlab-ci.yml会执行更多脚本，这些脚本/静态资源怎么存放</h3>
<p>推荐将大资源（如git CI/CD可以接入通过checkstyle.jar执行checkstyle，对应的jar文件）放在服务器上，其他的则可以放在各自的代码仓库内</p>
<h3 data-id="heading-14">为什么 GitLab Runner 安装时没有 gitlab-runner 用户就无法注册？这个用户代表什么？</h3>
<p>当你通过官方方式安装 GitLab Runner（如 yum install gitlab-runner 或 dpkg -i gitlab-runner_xxx.deb），安装脚本会自动：</p>
<ol start="0">
<li>创建系统用户 gitlab-runner</li>
<li>以该用户身份运行 runner 服务</li>
<li>Runner 在执行 job 时，所有命令都以 gitlab-runner 身份运行</li>
</ol>
<p>所以如果手动的安装，可能会错过这一步，最终导致无法注册runner到gitlab上面</p>
<h3 data-id="heading-15">.gitlab-ci.yml的完整克隆是什么意思</h3>
<p>答案：GitLab 会完整克隆（checkout）源分支（source branch）的代码，并使用该分支中的 .gitlab-ci.yml 文件</p>
<ul>
<li>
<p>这个过程包括：</p>
<ul>
<li>在 Runner 上执行 git clone </li>
<li>git checkout （例如 feature/add-login 的最新 commit）</li>
<li>读取这个 commit 中的 .gitlab-ci.yml</li>
<li>按照它的定义执行 job</li>
</ul>
</li>
</ul>
<p>所以，“完整克隆”在这里的意思是：</p>
<p>不是只复制 .gitlab-ci.yml 文件，而是把整个源分支的代码仓库完整拉下来，确保 CI 配置和代码版本严格一致。</p>
<p>为什么重要？</p>
<ul>
<li>如果你修改了 .gitlab-ci.yml（比如加了一个测试 job），只有推送到 源分支 才会在 MR 中生效。</li>
<li>目标分支（如 main）的 .gitlab-ci.yml完全不会被使用。</li>
</ul>
<h3 data-id="heading-16">gitlab runner拉代码的时候有什么级别嘛，比如一个级别只拉代码，一个级别把全部的信息都拉取下来？如果有不同级别，gitlabcicd提供的参数还会生效吗？如何配置？如何选择？</h3>
<blockquote>
<p><strong>gitlab runner拉代码的时候有什么级别嘛，比如一个级别只拉代码，一个级别把全部的信息都拉取下来？</strong></p>
</blockquote>
<p>GitLab Runner 在拉取代码时，确实支持“不同深度”的克隆（clone depth），但没有“只拉代码 / 拉全部信息”这种二元级别。</p>
<p>你可以通过以下方式控制 拉取多少 Git 历史（commit history）：</p>
<ul>
<li>浅克隆（shallow clone）：只拉最近 N 个 commit（默认行为）</li>
<li>深克隆（full clone）：拉取完整历史（所有分支、tags、完整 commit graph）</li>
</ul>
<p>注意：无论哪种方式，都会拉取完整的当前 commit 的文件内容（即“代码”）。</p>
<p>所谓“只拉代码”其实是误解 —— 代码文件总是完整的，区别只在 历史记录是否完整。
浅拷贝，深拷贝的在各个方面的不同</p>

























<table><thead><tr><th>配置</th><th>行为</th><th>适用场景</th></tr></thead><tbody><tr><td>GIT_DEPTH: 1（默认）</td><td>浅克隆：只拉当前 commit + 最近 1 层历史</td><td>快速构建、节省带宽</td></tr><tr><td>GIT_DEPTH: 0 或未设置</td><td>深克隆：拉取完整仓库历史（等价于 git clone --mirror）</td><td>需要 git log、git describe、计算版本号等</td></tr><tr><td>GIT_DEPTH: 10</td><td>拉最近 10 个 commit 的历史</td><td>折中方案</td></tr></tbody></table>
<p>不同的配置推荐场景如下：</p>





























<table><thead><tr><th>场景</th><th>推荐配置</th></tr></thead><tbody><tr><td>普通构建、测试、部署</td><td>GIT_DEPTH: 1（默认，最快）</td></tr><tr><td>需要生成版本号（如 v1.2.3-5-gabc123）</td><td>GIT_DEPTH: 0 + git fetch --tags</td></tr><tr><td>需要分析 commit 差异（如 changelog）</td><td>GIT_DEPTH: 0</td></tr><tr><td>使用 Lerna / Nx 等工具依赖 Git 历史</td><td>GIT_DEPTH: 0</td></tr><tr><td>节省 CI 时间和带宽</td><td>保持默认（GIT_DEPTH: 1）</td></tr></tbody></table>
<blockquote>
<p><strong>GitLab CI 提供的参数还会生效吗？</strong></p>
</blockquote>
<p>会！完全不受影响。</p>
<p>无论你用浅克隆还是深克隆，以下内容都 正常可用</p>
<blockquote>
<p>如何配置？</p>
</blockquote>
<p>GitLab CI 通过一个内置变量 GIT_DEPTH 控制克隆深度：</p>
<p>如：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">variables:</span>
  <span class="hljs-attr">GIT_DEPTH:</span> <span class="hljs-number">0</span>  <span class="hljs-comment"># 拉取完整历史</span>

<span class="hljs-attr">build:</span>
  <span class="hljs-attr">script:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">log</span> <span class="hljs-string">--oneline</span> <span class="hljs-string">-n</span> <span class="hljs-number">5</span>   <span class="hljs-comment"># 只有 GIT_DEPTH &gt; 1 或 =0 时才有多个 commit</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">git</span> <span class="hljs-string">describe</span> <span class="hljs-string">--tags</span>      <span class="hljs-comment"># 需要完整 tag 历史</span>
</code></pre>
<blockquote>
<p><strong>默认行为是什么？</strong></p>
</blockquote>
<p>GIT_DEPTH: 1（浅克隆，高效）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude Skills 实战指南：一键生成公众号封面，3D 插画 + 描边标题 3 秒出图]]></title>    <link>https://juejin.cn/post/7572537221540708367</link>    <guid>https://juejin.cn/post/7572537221540708367</guid>    <pubDate>2025-11-16T02:03:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572537221540708367" data-draft-id="7572524368879255586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude Skills 实战指南：一键生成公众号封面，3D 插画 + 描边标题 3 秒出图"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-16T02:03:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wwwzhouhui"/> <meta itemprop="url" content="https://juejin.cn/user/3428746411400537"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude Skills 实战指南：一键生成公众号封面，3D 插画 + 描边标题 3 秒出图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3428746411400537/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wwwzhouhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T02:03:43.000Z" title="Sun Nov 16 2025 02:03:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>你是不是经常为了做一张公众号封面图而烦恼？打开PS或者Figma，调色、排版、找素材，折腾大半天还不一定满意。更糟糕的是，有时候灵感来了想立刻发文，却被封面图卡住了进度。作为一个技术博主，我深有体会——我想专注于写作和分享技术，而不是在设计工具上耗费时间。</p>
<p>好消息是，现在有了AI加持，这个问题可以彻底解决了！我最近开发了一个叫 mp-cover-generator 的工具，它能根据你的文章主题和标题，自动生成可爱的3D插画风格封面图。不需要设计功底，不需要PS技能，只要一句话描述，3秒钟就能搞定。最关键的是，生成的封面图还特别有质感，类似皮克斯动画的那种卡通风格，配上醒目的描边标题，视觉冲击力直接拉满。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c04b4370f2cd4d1cbe37db3280880e3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=Gn0%2FliSmVETPLtJt%2BYo%2BZRbCi%2Fk%3D" alt="image-20251115213038620" loading="lazy"/></p>
<p>这篇文章我就来手把手教你怎么用这个工具，从环境搭建到实际生成封面，全程图文详解。不管你是公众号作者、技术博主，还是运营小伙伴，看完这篇都能立刻上手，彻底告别封面图制作的烦恼！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2176bd82631d436aad500f29e09829b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=ZRgjPcIimOyJAu5hAkEZSZYuKNU%3D" alt="生成过程2" loading="lazy"/></p>
<h2 data-id="heading-1">项目介绍</h2>
<h3 data-id="heading-2">什么是 mp-cover-generator？</h3>
<p>mp-cover-generator（公众号封面生成器）是一个基于 AI 技术的自动化封面图生成工具。它的核心理念很简单：<strong>让内容创作者专注于内容本身，而不是在设计上浪费时间</strong>。</p>
<p>这个工具最大的亮点有三个：</p>
<p><strong>1. AI 驱动的底图生成</strong>
它集成了即梦 AI（字节跳动旗下的多模态 AI 生成平台），能根据你的主题关键词，自动生成可爱圆润的 3D 插画风格底图。你说"MCP 技术教程"，它就给你生成一个带着可爱电脑、AI 大脑、教程书籍的卡通场景。风格类似皮克斯动画，质感柔和，色彩明快，看着就让人舒服。</p>
<p><strong>2. 描边卡通字体，视觉冲击力爆表</strong>
生成的封面标题不是普通的文字，而是带有多层描边效果的卡通字体。主标题用红色配白色描边，副标题用橙黄色配深棕色描边，8 个方向的文字阴影模拟出厚重的轮廓，再加上立体阴影增强视觉冲击力。这种效果在公众号封面上非常吸睛，能大幅提升文章的点击率。</p>
<p><strong>3. 双格式输出，随心所欲</strong>
工具会自动生成 HTML 和高清图片两种格式。HTML 文件可以在浏览器中预览和编辑，图片格式则支持 PNG（无损高质量）和 JPEG（压缩节省空间）两种。最终输出的图片分辨率达到 5120x2916 像素，2 倍像素密度，无论是在手机上看还是打印出来，都非常清晰。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4aefd5cd8faa4ef7962ba252bfbf9a04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=Bjcod5hLugtiEQ6LxrzOzerDCcg%3D" alt="image-20251115212415744" loading="lazy"/></p>
<h3 data-id="heading-3">技术架构</h3>
<p>mp-cover-generator 的技术栈非常现代：</p>
<ul>
<li><strong>AI 图像生成</strong>：基于 jimeng-mcp-server（即梦 AI 的 MCP 协议封装），支持文生图功能</li>
<li><strong>前端技术</strong>：HTML5 + CSS3，使用响应式设计，支持多种屏幕尺寸</li>
<li><strong>截图引擎</strong>：Playwright（微软开源的浏览器自动化工具），实现 HTML 到图片的高质量转换</li>
<li><strong>容器化部署</strong>：jimeng-free-api-all Docker 容器，提供稳定的 AI 图像生成服务</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcae215abf4a4a27baec371892ff0117~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=GWisf%2FDz3jBCQJuLbtLfilRw89g%3D" alt="image-20251115212549474" loading="lazy"/></p>
<p>整个工具的工作流程分为三步：</p>
<ol>
<li>用户提供主题关键词和标题文字</li>
<li>调用 jimeng-mcp-server 生成 3D 插画风格底图（返回 4 张可选）</li>
<li>叠加文字层生成 HTML，使用 Playwright 转换为高清图片</li>
</ol>
<p>这个流程完全自动化，从输入到输出只需要 10-20 秒，效率极高。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6e59aebc79b4eeb95a7279e70d5b88e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=rXvzqOd9hFI6MeXvT7v67HKA4fk%3D" alt="image-20251115212518494" loading="lazy"/></p>
<h3 data-id="heading-4">适用场景</h3>
<p>mp-cover-generator 特别适合以下场景：</p>
<ul>
<li><strong>公众号文章封面</strong>：技术博客、生活分享、行业资讯等各类文章</li>
<li><strong>社交媒体横幅图</strong>：微博、知乎、小红书等平台的配图</li>
<li><strong>技术博客头图</strong>：掘金、CSDN、博客园等技术平台的文章配图</li>
<li><strong>宣传海报快速设计</strong>：活动预告、课程推广等轻量级设计需求</li>
</ul>
<p>只要你需要图文结合的设计，并且想要可爱的 3D 插画风格，mp-cover-generator 都能帮你搞定。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3ec3941f1eb4c5487fb0bfe85a7148f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=pIQjeJYbwGzgL7yfc%2Bl8l3kJ6pw%3D" alt="image-20251115212639081" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4ce1b9421f640279c1de067810d5fd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=4KLzdwVZ7YjvKSLESw5QA26xqqw%3D" alt="image-20251115212704574" loading="lazy"/></p>
<h2 data-id="heading-5">部署实战</h2>
<p>好了，理论讲完了，咱们直接上手操作！下面我会一步步带你完成环境搭建和实际使用。</p>
<h3 data-id="heading-6">第一步：环境准备</h3>
<p>在使用 mp-cover-generator 之前，你需要准备以下环境：</p>
<p><strong>1. 安装 Docker</strong></p>
<p>jimeng-free-api-all 是通过 Docker 容器运行的，所以首先要安装 Docker。</p>
<p>Linux/Mac 用户：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 Docker（以 Ubuntu 为例）</span>
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

<span class="hljs-comment"># 启动 Docker 服务</span>
sudo systemctl start docker
sudo systemctl <span class="hljs-built_in">enable</span> docker
</code></pre>
<p>Windows 用户：
访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.docker.com%2Fproducts%2Fdocker-desktop" target="_blank" title="https://www.docker.com/products/docker-desktop" ref="nofollow noopener noreferrer">Docker Desktop 官网</a> 下载并安装 Docker Desktop。</p>
<p><strong>2. 安装 Node.js</strong></p>
<p>Playwright 需要 Node.js 16+ 环境。我们可以去<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fzh-cn%2Fdownload" target="_blank" title="https://nodejs.org/zh-cn/download" ref="nofollow noopener noreferrer">nodejs.org/zh-cn/downl…</a>  下载</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be9e119e02f24c138a9206c6b72dc66d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=yqAl%2B6YxXrFXtGkjTmEqqhMlrTA%3D" alt="image-20251115201350566" loading="lazy"/></p>
<p>Linux/Mac 用户：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 nvm 安装 Node.js（推荐）</span>
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
<span class="hljs-comment"># in lieu of restarting the shell</span>
\. <span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.nvm/nvm.sh"</span>
<span class="hljs-comment"># Download and install Node.js:</span>
nvm install 22
<span class="hljs-comment"># Verify the Node.js version:</span>
node -v <span class="hljs-comment"># Should print "v22.19.0".</span>
<span class="hljs-comment"># Verify npm version:</span>
npm -v <span class="hljs-comment"># Should print "10.9.3".</span>
</code></pre>
<p>Windows 用户：
访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2F" target="_blank" title="https://nodejs.org/" ref="nofollow noopener noreferrer">Node.js 官网</a> 下载并安装 LTS 版本。</p>
<p><strong>3. 安装 Python 3.10+</strong></p>
<p>jimeng-mcp-server 需要 Python 环境。</p>
<p>Linux/Mac 用户：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查 Python 版本</span>
python3 --version
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abf20da5df664f119a851957834f13c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=xlfUeS7zZc2WLiWJ0eK0c5dOq8M%3D" alt="image-20251115095759755" loading="lazy"/></p>
<p>Windows 用户：
访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.python.org%2F" target="_blank" title="https://www.python.org/" ref="nofollow noopener noreferrer">Python 官网</a> 下载并安装 Python 3.10+。</p>
<h3 data-id="heading-7">第二步：启动 jimeng-free-api-all 容器</h3>
<p>jimeng-free-api-all 是即梦 AI 的免费 API 服务，我们需要先启动这个容器。</p>
<p><strong>下载镜像：</strong></p>
<pre><code class="hljs language-bash" lang="bash">docker pull wwwzhouhui569/jimeng-free-api-all:latest
</code></pre>
<p><strong>启动 Docker 容器：</strong></p>
<pre><code class="hljs language-bash" lang="bash">docker run -it -d --init \
  --name jimeng-free-api-all \
  -p 8001:8000 \
  -e TZ=Asia/Shanghai \
  wwwzhouhui569/jimeng-free-api-all:latest
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ca97c09614047e0a9b3265f25eb8c39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=i8WmfBmFCQ5ohNjdVwsgoyr50xs%3D" alt="启动容器" loading="lazy"/></p>
<p><strong>验证容器状态：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看容器是否启动成功</span>
docker ps | grep jimeng

<span class="hljs-comment"># 测试 API 是否可用</span>
curl http://localhost:8001
</code></pre>
<p>如果看到类似 <code>{"message":"Welcome to Jimeng Free API"}</code> 的响应，说明容器启动成功。</p>
<h3 data-id="heading-8">第三步：获取即梦 API 密钥</h3>
<p>要使用即梦 AI 的图像生成服务，需要获取 API 密钥（即 sessionid）。</p>
<p><strong>获取步骤：</strong></p>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjimeng.jianying.com%2F" target="_blank" title="https://jimeng.jianying.com/" ref="nofollow noopener noreferrer">即梦 AI 官网</a> 并登录（可以用抖音账号登录）</li>
<li>按 <strong>F12</strong> 打开浏览器开发者工具</li>
<li>切换到 <strong>Application</strong> 标签页（Chrome）或 <strong>存储</strong> 标签页（Firefox）</li>
<li>找到 <strong>Cookies</strong> 下的 <strong>sessionid</strong> 值，复制它</li>
<li>将这个值保存下来，后面会用到</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43bdf049f87f417db3f7f66ce50d666f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=t%2Bh2Rc%2Ba%2FstBokMjNx2GdAyKTQE%3D" alt="获取 sessionid" loading="lazy"/></p>
<p><strong>注意：</strong> 即梦 AI 免费层每天提供 <strong>88 积分</strong>，每次生成图片消耗 1-2 积分，完全够日常使用。</p>
<h3 data-id="heading-9">第四步：安装 jimeng-mcp-server</h3>
<p>jimeng-mcp-server 是即梦 AI 的 MCP 协议封装，让我们能在 Claude Code 中直接调用。</p>
<p><strong>克隆项目：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆 jimeng-mcp-server 项目</span>
git <span class="hljs-built_in">clone</span> https://github.com/wwwzhouhui/jimeng-mcp-server.git
<span class="hljs-built_in">cd</span> jimeng-mcp-server
</code></pre>
<p><strong>安装 Python 依赖：</strong></p>
<p>项目使用 <code>uv</code> 作为包管理工具（推荐），也可以使用传统的 pip。</p>
<p><strong>方法一：使用 uv（推荐）</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 uv（如果尚未安装）</span>
curl -LsSf https://astral.sh/uv/install.sh | sh

<span class="hljs-comment"># 创建虚拟环境并安装依赖</span>
uv venv
<span class="hljs-built_in">source</span> .venv/bin/activate  <span class="hljs-comment"># Linux/macOS</span>
<span class="hljs-comment"># 或者在 Windows 上使用: .venv\Scripts\activate</span>

uv pip install -e .
</code></pre>
<p><strong>方法二：使用 pip</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建虚拟环境</span>
python -m venv .venv
<span class="hljs-built_in">source</span> .venv/bin/activate  <span class="hljs-comment"># Linux/macOS</span>
<span class="hljs-comment"># 或者在 Windows 上使用: .venv\Scripts\activate</span>

<span class="hljs-comment"># 安装依赖</span>
pip install -e .
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b27e1dc57e042a3b480ee857eb9e43a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=6Yn0C6d8DJB42cFXDO%2Fd4kHToaE%3D" alt="安装依赖" loading="lazy"/></p>
<p>安装过程中可能需要几分钟时间，请耐心等待。</p>
<p><strong>配置 MCP 服务器：</strong></p>
<p>创建 <code>.env</code> 文件配置后端 API 地址：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">touch</span> .<span class="hljs-built_in">env</span>
</code></pre>
<p>编辑 <code>.env</code> 文件，添加以下内容：</p>
<pre><code class="hljs language-env" lang="env"># 即梦API配置

# 您的即梦API密钥（必需）
JIMENG_API_KEY=你的sessionid值

# API基础URL（可选，默认为 https://jimeng.duckcloud.fun）
JIMENG_API_URL=http://127.0.0.1:8001

# 图像生成的默认模型（可选，默认为 jimeng-4.0）
JIMENG_MODEL=jimeng-3.1
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acb0ce2f23fe45deb9718572b1c18a19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=wxqJMvm%2BKKewYqQSWcnTzcKSJos%3D" alt="配置环境变量" loading="lazy"/></p>
<p><strong>注意：</strong> 将 <code>JIMENG_API_KEY</code> 替换为你在第三步获取的 sessionid 值。</p>
<h3 data-id="heading-10">第五步：Cherry Studio配置</h3>
<p>如果你使用的是 Claude Desktop 或 Cherry Studio，需要配置 MCP 服务器。</p>
<p><strong>Claude Desktop 配置：</strong></p>
<p>找到配置文件（不同操作系统位置不同）：</p>
<ul>
<li><strong>macOS</strong>: <code>~/Library/Application Support/Claude/claude_desktop_config.json</code></li>
<li><strong>Windows</strong>: <code>%APPDATA%\Claude\claude_desktop_config.json</code></li>
<li><strong>Linux</strong>: <code>~/.config/Claude/claude_desktop_config.json</code></li>
</ul>
<p>编辑配置文件，添加以下内容：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"jimeng-mcp-server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"-m"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"jimeng_mcp.server"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"JIMENG_API_KEY"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你的sessionid值"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"JIMENG_API_URL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://127.0.0.1:8001"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>或者，如果你已经配置了 <code>.env</code> 文件，可以直接使用：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"jimeng-mcp-server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"-m"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"jimeng_mcp.server"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Cherry Studio SSE 模式配置：</strong></p>
<p>如果你使用 Cherry Studio，可以用 SSE 模式：</p>
<ol>
<li>启动 SSE 服务器：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> jimeng-mcp-server
<span class="hljs-built_in">source</span> .venv/bin/activate
python -m jimeng_mcp.server --transport sse --port 8080
</code></pre>
<ol start="2">
<li>在 Cherry Studio 中添加 MCP 服务器：</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2a7823b1121428a828fa0739c9a4fb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=xL7EMr0MhTgyZCf%2BS%2BYqVzJO%2B4U%3D" alt="Cherry Studio SSE配置" loading="lazy"/></p>
<p>配置完成后，重启 Claude Desktop 或 Cherry Studio，MCP 服务器就会自动加载。</p>
<h3 data-id="heading-11">第六步：安装 mp-cover-generator</h3>
<p>现在可以安装 mp-cover-generator 了：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆或下载项目</span>
git <span class="hljs-built_in">clone</span> https://github.com/wwwzhouhui/skills_collection.git
<span class="hljs-built_in">cd</span> skills_collection/mp-cover-generator

<span class="hljs-comment"># 安装依赖</span>
npm install

<span class="hljs-comment"># Playwright 会自动安装 Chromium 浏览器</span>
<span class="hljs-comment"># 如果没有自动安装，手动执行：</span>
npx playwright install chromium
</code></pre>
<p>安装完成后，项目目录结构如下：</p>
<pre><code class="hljs language-bash" lang="bash">mp-cover-generator/
├── SKILL.md              <span class="hljs-comment"># Skill 详细文档</span>
├── README.md             <span class="hljs-comment"># 使用说明</span>
├── package.json          <span class="hljs-comment"># npm 配置文件</span>
├── scripts/
│   └── capture.js        <span class="hljs-comment"># HTML 转图片脚本</span>
└── resources/            <span class="hljs-comment"># 示例文件</span>
</code></pre>
<h3 data-id="heading-12">第七步：生成第一张封面图</h3>
<p>环境搭建完成，现在来生成第一张封面图！</p>
<p><strong>在 Claude Code 中直接输入：</strong></p>
<pre><code class="hljs">请使用 mp-cover-generator skill 生成一个 MCP案例分享 claude调用AI生图视频教程 介绍的文章的公众号封面
</code></pre>
<p>Claude 会自动执行以下步骤：</p>
<ol>
<li><strong>调用 jimeng-mcp-server</strong> 生成 3D 插画底图（返回 4 张可选图片）</li>
<li><strong>选择第一张图片</strong>，叠加文字层生成 HTML</li>
<li><strong>使用 Playwright</strong> 转换为 PNG 和 JPEG 图片</li>
</ol>
<p>整个过程大约 <strong>20 秒</strong>，你会得到：</p>
<ul>
<li><code>mcp_tutorial_cover_YYYYMMDD.html</code> - HTML 文件</li>
<li><code>mcp_tutorial_cover_YYYYMMDD.png</code> - PNG 图片（约 4-5 MB）</li>
<li><code>mcp_tutorial_cover_YYYYMMDD.jpg</code> - JPEG 图片（约 1.5 MB）</li>
</ul>
<p><strong>生成过程截图：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e10c33d285f45bba3aca7318e9e19c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=JVZeh0Ycr7bxtUC2nvDRTzAjktE%3D" alt="生成过程1" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91de57866fe84cfdb58c49fe122b7eeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgd3d3emhvdWh1aQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763863423&amp;x-signature=CoHbV3s%2FCvGA1NaZlYUkbHX4m7c%3D" alt="生成过程2" loading="lazy"/></p>
<p><strong>方式二：手动转换 HTML 为图片</strong></p>
<p>如果你已经有了 HTML 文件，想单独转换为图片：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 转换为 PNG（无损高质量）</span>
node scripts/capture.js your_cover.html your_cover.png

<span class="hljs-comment"># 转换为 JPEG（压缩版本）</span>
node scripts/capture.js your_cover.html your_cover.jpg --quality 95

<span class="hljs-comment"># 自定义参数</span>
node scripts/capture.js cover.html cover.png \
  --width 2560 \
  --height 1097 \
  --scale 2 \
  --<span class="hljs-built_in">wait</span> 3000
</code></pre>
<p><strong>参数说明：</strong></p>
<ul>
<li><code>--width</code>: 视口宽度（像素），默认 2560</li>
<li><code>--height</code>: 视口高度（像素），默认 1097</li>
<li><code>--quality</code>: JPEG 质量（1-100），默认 95</li>
<li><code>--wait</code>: 等待时间（毫秒），默认 2000</li>
<li><code>--scale</code>: 设备像素比，默认 2（输出 2 倍高清图）</li>
</ul>
<h3 data-id="heading-13">第八步：查看生成效果</h3>
<p>生成完成后，用浏览器打开 HTML 文件，或者直接查看图片。</p>
<p><strong>封面图特点：</strong></p>
<p><strong>视觉风格：</strong></p>
<ul>
<li>主题风格：可爱、圆润、简洁的 3D 插画</li>
<li>质感：类似皮克斯动画或黏土定格动画</li>
<li>色彩：和谐明快，低饱和度渐变背景</li>
<li>构图：右图左文，主体位于右侧 30-40% 区域</li>
<li>留白：左侧 60-70% 干净留白供文字显示</li>
</ul>
<p><strong>文字样式（核心亮点）：</strong></p>
<ul>
<li><strong>主标题</strong>：红色（#FF3333）+ 白色描边，8 方向文字阴影</li>
<li><strong>副标题</strong>：橙黄色（#FFB84D）+ 深棕色描边，单行不折行</li>
<li><strong>立体感</strong>：多层阴影模拟描边 + 额外立体阴影</li>
<li><strong>位置</strong>：垂直居中（<code>top: 50%; transform: translateY(-50%);</code>）</li>
<li><strong>字号</strong>：5vw（大字体，响应式）</li>
</ul>
<p><strong>自动生成信息：</strong></p>
<ul>
<li><strong>日期</strong>：自动显示当前日期（格式：Fri. 11.15）</li>
<li><strong>作者</strong>：固定显示"O3sky"</li>
<li><strong>分辨率</strong>：5120x2916 像素（完整页面截图，无截断）</li>
</ul>
<p>如果对底图不满意，可以重新生成。jimeng-mcp-server 每次会返回 <strong>4 张不同风格的图片</strong>，你可以选择最喜欢的一张。</p>
<h3 data-id="heading-14">第九步：自定义封面样式</h3>
<p>如果你想自定义封面的样式，可以编辑 HTML 文件。主要可调整的部分：</p>
<p><strong>1. 修改标题颜色</strong>
在 CSS 中找到 <code>.headline-main</code> 和 <code>.headline-secondary</code>，修改 <code>color</code> 属性：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.headline-main</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#FF3333</span>;  <span class="hljs-comment">/* 主标题颜色，改为你喜欢的颜色 */</span>
}

<span class="hljs-selector-class">.headline-secondary</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#FFB84D</span>;  <span class="hljs-comment">/* 副标题颜色 */</span>
}
</code></pre>
<p><strong>2. 调整标题位置</strong>
默认是垂直居中，你也可以改成靠上或靠下：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.headline</span> {
    <span class="hljs-attribute">top</span>: <span class="hljs-number">50%</span>;  <span class="hljs-comment">/* 垂直居中 */</span>
    <span class="hljs-comment">/* top: 20%; 改为靠上 */</span>
    <span class="hljs-comment">/* top: 70%; 改为靠下 */</span>
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">50%</span>);
}
</code></pre>
<p><strong>3. 修改字体大小</strong>
默认字号是 5vw（响应式），可以根据需要调整：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.headline</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">5vw</span>;  <span class="hljs-comment">/* 改为 6vw 会更大，4vw 会更小 */</span>
}
</code></pre>
<p><strong>4. 更换作者名</strong>
在 HTML 中找到 <code>.author</code> 部分，修改文字内容：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"author"</span>&gt;</span>O3sky<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 改为你的名字 --&gt;</span>
</code></pre>
<p>修改完成后，重新运行 capture.js 转换为图片即可。</p>
<h2 data-id="heading-15">总结</h2>
<p>今天主要带大家了解并实现了 <strong>mp-cover-generator（公众号封面生成器）</strong> 的 完整部署与使用流程，该 开源自动化工具 以 "AI图像生成 + 描边卡通字体 + 完整页面截图" 为核心优势，结合 内容创作效率提升 需求，通过 jimeng-mcp-server集成 与 Playwright浏览器自动化，形成了一套从 <strong>AI底图生成</strong> 到 <strong>高清封面输出</strong> 的全链路 <strong>公众号封面制作解决方案</strong>。</p>
<p>通过这套实践方案，公众号作者与技术博主 能够高效突破 传统设计工具学习成本高、制作周期长 的效率瓶颈 —— 借助 三层技术栈（包括 即梦AI图像生成层、HTML/CSS响应式设计层、Playwright截图转换层），无需 掌握PS、Figma等专业设计工具，就能快速 实现AI生成3D插画底图、智能叠加描边字体、自动转换高清图片三大核心功能（如本次演示的 "一句话生成MCP教程封面，20秒拿到HTML+PNG+JPG三种格式"）。无论是 技术博客封面设计、公众号文章配图，还是 社交媒体横幅图、宣传海报快速制作，都能通过 自然语言描述主题 完成，极大 提升内容创作效率和视觉呈现质量。</p>
<p>在实际应用中，该 <strong>封面生成器</strong> 不仅 <strong>支持可爱圆润的3D插画风格（类似皮克斯动画）</strong>，还 <strong>提供多层描边卡通字体效果（8方向文字阴影 + 立体阴影）</strong>，视觉冲击力远优于 <strong>传统纯文字或简单图片叠加方案</strong>；特别是通过 Playwright完整页面截图，有效解决了 传统截图工具内容截断和分辨率不足 的难题（输出分辨率达到 5120x2916像素，2倍像素密度）。同时，方案具备良好的可定制性 —— 小伙伴们可以基于生成的HTML文件自定义 标题颜色、字体大小、位置布局 等样式，进一步发挥 CSS响应式设计能力 在 个人品牌视觉统一、系列文章封面风格一致性 等场景的应用价值。感兴趣的小伙伴可以按照文中提供的步骤进行实践，根据实际 内容主题和视觉需求 调整 主题关键词、标题文字、颜色方案等配置项。今天的分享就到这里结束了，我们下一篇文章见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[什么是RAG？啥又是向量？带你从周杰伦的角度读懂.....]]></title>    <link>https://juejin.cn/post/7572454929145053219</link>    <guid>https://juejin.cn/post/7572454929145053219</guid>    <pubDate>2025-11-15T15:11:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572454929145053219" data-draft-id="7572493520003596322" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="什么是RAG？啥又是向量？带你从周杰伦的角度读懂....."/> <meta itemprop="keywords" content="人工智能,Agent"/> <meta itemprop="datePublished" content="2025-11-15T15:11:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="eacape"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289440478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            什么是RAG？啥又是向量？带你从周杰伦的角度读懂.....
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289440478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    eacape
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T15:11:40.000Z" title="Sat Nov 15 2025 15:11:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>LLM火了这么长时间，RAG、mcp、embedding等技术名词也出现在了日常的公众号文章中，你有了解过这些技术吗？</p>
</blockquote>
<h2 data-id="heading-0">大模型出现幻觉啦</h2>
<p>你可以把大模型想象成：一个知识渊博、口才极佳的“大忽悠”。</p>
<p>这个“大忽悠”脑子里装了海量的知识，所以跟你聊天时总是侃侃而谈，听起来非常有道理。但问题是，<strong>他有一种“无法忍受沉默和不知道”的强迫症</strong>。当你问到一个他不知道或者他记忆模糊的事情时，他不会说“我不知道”，而是会<strong>基于他已有的知识“脑补”出一段听起来极其合理、但完全是编造的内容</strong>，并且用非常自信、肯定的语气告诉你。</p>
<p>这就是大模型的“幻觉”，学术上常称为“胡言乱语”或“虚构”。它指大模型生成的内容在事实层面是错误的、不存在的，但形式上却非常连贯、可信。</p>
<p>比如~我的代码里有一个名为<code>@CustomFilter</code>注解，这个注解大模型肯定不知道吧....下面是大模型的回答，我搜了下 <code>Mybatis-Plus</code> 并没有这个注解。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5be1829eb750432fba924552e311521b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=ZF%2BAyV06mwb6PkDZWZ5BzEVDDvQ%3D" alt="image-20251114230523762" loading="lazy"/></p>
<h2 data-id="heading-1">让大模型别“胡说八道”</h2>
<p>如何不让大模型胡说八道呢？看一下下面这些方式吧，其中 RAG 将会是我们这篇文章讲述的重点。</p>
<h3 data-id="heading-2">Prompt - 在提问时给它立规矩</h3>
<p>通过精心设计你的提问方式，来约束模型的行为。</p>
<ul>
<li>
<p><strong>是什么</strong>：在提问的指令中，明确告诉模型“必须基于已知事实”、“如果不知道就明确说不知道”、“禁止虚构信息”。</p>
</li>
<li>
<p>举例：提示词如下，大模型也给出了“不知道”的回答</p>
<pre><code class="hljs">1.不确定、不清楚、无法确认的内容，一律回答：不知道。
2.不能根据猜测、可能性、假设来回答。
3.所有回答必须基于确定、准确、可靠的知识。
4.不允许编造事实或补充未经确认的信息。
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acc54e7e6b794e65bf56123ddf65135c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=5nlisaPzKRhT%2BoTcMvfmVOGr8dw%3D" alt="image-20251115000335026" loading="lazy"/></p>
</li>
<li>
<p><strong>优点</strong>：零成本，简单易用，对所有模型都有效。</p>
</li>
<li>
<p><strong>缺点</strong>：约束力有限，对于复杂或模型知识盲区的问题，它可能还是会“忍不住”编造，并且<strong>我们是想要它回答的...😭</strong></p>
</li>
</ul>
<hr/>
<h3 data-id="heading-3">Fine-Tuning - 从根本上改变它的知识</h3>
<ul>
<li><strong>是什么</strong>：用大量“高质量、高事实性、相关内容的”的数据对基础模型进行额外的训练，微调其参数。</li>
<li><strong>优点</strong>：能从模型内部提升其事实性和可靠性，效果比较根本。</li>
<li><strong>缺点</strong>：成本高昂（需要大量算力和高质量数据），过程复杂，而且无法教给模型它从未学过的知识（比如最新新闻）。</li>
</ul>
<p>比曾经的AI六小虎，搜狗创始人王小川创立的百川智能已经不再推出通用大模型，转向医疗大模型，背后就是给大模型不断的 Fine-Tuning 医疗相关的数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5210ac765ef4d22bfb16d1a81828dcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=Zb7RTHEAOaYmc4yK0YnnmBUn%2FeY%3D" alt="image-20251114232027429" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-4">RAG - 给它一本“参考答案”，让它照本宣科</h3>
<p>这是目前<strong>最流行、最有效且成本最低</strong>的方法。</p>
<ul>
<li>
<p><strong>是什么</strong>：<strong>检索增强生成</strong>。在让模型回答之前，先从一个你准备好的、可信的知识库（比如公司文档、产品手册、权威论文）里，搜索出与问题最相关的片段，然后把“问题+相关片段”一起交给模型，让它基于这些片段来组织答案。</p>
</li>
<li>
<p><strong>生活比喻</strong>：就像考试时，不允许学生自由发挥，而是发给他一本《标准答案汇编》，要求他所有的回答都必须引用这本汇编里的原话。</p>
</li>
<li>
<p>如何工作：</p>
<ol start="0">
<li><strong>准备知识库</strong>：把你的所有可靠资料（PDF、Word、网页等）处理成可搜索的格式。</li>
<li><strong>用户提问</strong>：用户问：“我们产品的旗舰型号支持哪些AI功能？”</li>
<li><strong>实时检索</strong>：系统立刻在你的产品手册知识库里搜索“旗舰型号”、“AI功能”等关键词，找到最相关的几段描述。</li>
<li><strong>组合并回答</strong>：模型收到的指令实际上是：“请根据以下资料，回答用户的问题。资料：[检索到的产品手册原文]。 问题：我们产品的旗舰型号支持哪些AI功能？”</li>
<li><strong>模型生成</strong>：模型会乖乖地基于你提供的资料，总结、复述生成答案，几乎不会编造。</li>
</ol>
</li>
</ul>
<h2 data-id="heading-5"><strong>检索增强生成</strong></h2>
<p><em>Retrieval-Augmented Generation</em></p>
<ul>
<li><strong>解决思路</strong>：将外部知识库与LLM结合，通过检索获取相关信息，增强生成质量</li>
<li><strong>核心价值</strong>：降低幻觉、提供实时信息、支持私域知识</li>
</ul>
<p>一个RAG系统的基本架构就是如下图所示，分为索引、检索、生成三个步骤，接下来我们娓娓道来</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40c820f6542c433993d27899ffa32688~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=Fent3vMTtx2vVEtIGHFKe%2BQUD4k%3D" alt="image-20251114222532878" loading="lazy"/></p>
<h3 data-id="heading-6">什么是向量？</h3>
<p>想象一下，你正在教一个外星人理解地球语言。这个外星人不懂中文、英文，但它精通数学。你怎么向它解释"苹果"这个词的含义呢？</p>
<p><strong>向量的神奇之处</strong>就在于：它把人类语言中模糊的、主观的语义概念，转换成了精确的、可计算的数学表示(最终形态是 一个固定长度的浮点数数组)。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac16f8e923be4a598ca64e77edd5463a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=W79HqqllpJUWlWSnE98fdF5g%2Bo8%3D" alt="image-20251114234945089" loading="lazy"/></p>
<h3 data-id="heading-7">把你的资料向量化</h3>
<p>在RAG中便是将你所要构建的“知识”文本先切分成很多端的小块，然后将这些小块使用向量模型进行向量化，最后将文本块的向量和文本块同时存到向量数据库当中。</p>
<p><strong>文本块向量和文本块是一种 <code>key-value</code>结构，所以后面我们找到了文本块向量也就找到了文本块。</strong></p>
<p><strong>1. 文本分块处理</strong></p>
<ul>
<li>固定长度分块：按预设字符数均匀切分，适合格式规整的文档</li>
<li>语义分块：基于句子边界和语义完整性进行智能分割</li>
<li>重叠分块：在相邻分块间设置重叠区域，避免关键信息被割裂</li>
<li>自定义分块：可根据段落、章节等文档结构进行灵活划分</li>
</ul>
<p><strong>2. 向量化编码</strong></p>
<ul>
<li>
<p>OpenAI的text-embedding-ada-002等系列</p>
</li>
<li>
<p>Google的BERT及其变体模型</p>
</li>
<li>
<p>Sentence-BERT等专用语义编码模型</p>
</li>
<li>
<p>阿里云的text-embedding系列</p>
</li>
<li>
<p>轻量级本地部署：</p>
<ul>
<li>all-MiniLM-L6-v2等小型模型 （试过了，不好用别用，中小型公司乖乖用厂商的👀）</li>
<li>针对中文优化的m3e等开源模型</li>
</ul>
</li>
</ul>
<p><strong>3. 向量存储方案</strong></p>
<ul>
<li>
<p>Milvus（开源首选，强推，国产之光💪）</p>
</li>
<li>
<p>Pinecone（全托管服务）</p>
</li>
<li>
<p>Chroma（轻量易用）</p>
</li>
<li>
<p>传统数据库扩展</p>
<ul>
<li>ElasticSearch with 向量插件</li>
<li>PostgreSQL + pgvector扩展</li>
<li>Redis 向量搜索模块</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d9d272b1003440eba6d23c8e3650a6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=DW8Or4PaARF9nM09oWsG9zEEspo%3D" alt="image-20251114235538955" loading="lazy"/></p>
<h3 data-id="heading-8">检索向量化后的内容</h3>
<p>那么将原始的文档转换为向量存储后，我们要怎么用呢？其实一个向量可以在一堆向量之间找出他的“哥们”。</p>
<p>举个🌰：假如全世界的人都面部信息是一个向量数据库，我们把周杰伦的脸看作一个向量，那么向量数据库就会很快给我们匹配出“周饼伦“。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d68a8623ce054a508108231596f7975c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=Tp4vRU8F8wzWq7kHzoMJReWkNRE%3D" alt="image-20251115010225934" loading="lazy"/></p>
<p>那么我们想要从向量数据库里匹配出相似的内容，需要以下步骤</p>
<ul>
<li>将查询的内容也转换为向量</li>
<li>计算查询向量与所有文档向量的相似度</li>
<li>返回相似度最高的K个文本块（前面我们讲了向量和文本块是一种key-value结构，我们搜索到了向量，就找到文本块，这里向量起到的是一个索引的作用）</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf2d095ff5d24721a332f8d813a5b1a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=xsdqKMtG1Onk0e8%2FYXa%2Fq6fB3aI%3D" alt="image-20251115002605890" loading="lazy"/></p>
<h3 data-id="heading-9">怎么计算相似度呢</h3>
<p>计算向量相似度常用的算法有三种：分别是点积相似、余弦相似、欧氏距离</p>
<h4 data-id="heading-10">点积相似度</h4>
<p>点积相似的计算方式很简单，就是两个向量对应位置的数值相乘，值越大就是越相似</p>
<pre><code class="hljs language-css" lang="css">点积 = (<span class="hljs-selector-tag">A</span>₁ × <span class="hljs-selector-tag">B</span>₁) + (<span class="hljs-selector-tag">A</span>₂ × <span class="hljs-selector-tag">B</span>₂) + (<span class="hljs-selector-tag">A</span>₃ × <span class="hljs-selector-tag">B</span>₃) + ... + (<span class="hljs-selector-tag">A</span>ₙ × <span class="hljs-selector-tag">B</span>ₙ)  = Σ(<span class="hljs-selector-tag">A</span>ᵢ × <span class="hljs-selector-tag">B</span>ᵢ)  对于 <span class="hljs-selector-tag">i</span> 从 <span class="hljs-number">1</span> 到 n
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20b4df5e25a946ef953f096beddf2504~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=SqkxxlU%2BbpW3FvcZC2VIp%2BIpV8E%3D" alt="image-20251115013647329" loading="lazy"/></p>
<h4 data-id="heading-11">余弦相似度</h4>
<p>其实就是高中学的<strong>计算两个点与原点形成的夹角的余弦值</strong>，比如说<strong>已知平面内两个点</strong> <em>X</em>(<em>x</em>1,<em>y</em>1) 和 <em>Y</em>(<em>x</em>2,<em>y</em>2)，我们就是要计算，这两个点与原点的连接线的夹角的余弦值，最终也是值越大的越相似。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68ea1dfaffa84920b8beb2810da496d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=Dekf4jAwl3Yjq4IDyKBesaI0IBY%3D" alt="image-20251115015359575" loading="lazy"/></p>
<p>公式如下：</p>
<pre><code class="hljs language-css" lang="css">            <span class="hljs-selector-tag">A</span>·<span class="hljs-selector-tag">B</span>
cos(θ) = ———————————————
          |<span class="hljs-selector-tag">A</span>| × |<span class="hljs-selector-tag">B</span>|
​
其中：
<span class="hljs-selector-tag">A</span>·<span class="hljs-selector-tag">B</span> = 向量<span class="hljs-selector-tag">A</span>和<span class="hljs-selector-tag">B</span>的点积
|<span class="hljs-selector-tag">A</span>| = 向量<span class="hljs-selector-tag">A</span>的长度 = √(<span class="hljs-selector-tag">A</span>₁² + <span class="hljs-selector-tag">A</span>₂² + ... + <span class="hljs-selector-tag">A</span>ₙ²)
|<span class="hljs-selector-tag">B</span>| = 向量<span class="hljs-selector-tag">B</span>的长度 = √(<span class="hljs-selector-tag">B</span>₁² + <span class="hljs-selector-tag">B</span>₂² + ... + <span class="hljs-selector-tag">B</span>ₙ²)
​
举个🌰吧
​
假设：
向量<span class="hljs-selector-tag">A</span> = (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)
向量<span class="hljs-selector-tag">B</span> = (<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>)
​
计算步骤：
<span class="hljs-number">1</span>. 点积 <span class="hljs-selector-tag">A</span>·<span class="hljs-selector-tag">B</span> = (<span class="hljs-number">1</span>×<span class="hljs-number">4</span>) + (<span class="hljs-number">2</span>×<span class="hljs-number">5</span>) + (<span class="hljs-number">3</span>×<span class="hljs-number">6</span>) = <span class="hljs-number">4</span> + <span class="hljs-number">10</span> + <span class="hljs-number">18</span> = <span class="hljs-number">32</span>
<span class="hljs-number">2</span>. 向量<span class="hljs-selector-tag">A</span>长度 |<span class="hljs-selector-tag">A</span>| = √(<span class="hljs-number">1</span>² + <span class="hljs-number">2</span>² + <span class="hljs-number">3</span>²) = √(<span class="hljs-number">1</span> + <span class="hljs-number">4</span> + <span class="hljs-number">9</span>) = √<span class="hljs-number">14</span> ≈ <span class="hljs-number">3.74</span>
<span class="hljs-number">3</span>. 向量<span class="hljs-selector-tag">B</span>长度 |<span class="hljs-selector-tag">B</span>| = √(<span class="hljs-number">4</span>² + <span class="hljs-number">5</span>² + <span class="hljs-number">6</span>²) = √(<span class="hljs-number">16</span> + <span class="hljs-number">25</span> + <span class="hljs-number">36</span>) = √<span class="hljs-number">77</span> ≈ <span class="hljs-number">8.77</span>
<span class="hljs-number">4</span>. 余弦相似度 = <span class="hljs-number">32</span> / (<span class="hljs-number">3.74</span> × <span class="hljs-number">8.77</span>) ≈ <span class="hljs-number">32</span> / <span class="hljs-number">32.8</span> ≈ <span class="hljs-number">0.975</span>
​
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61b440edf7cb4759864aa55ffb598e10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=eoX1oB%2BSJjs8SACRkz38os3O2Vk%3D" alt="image-20251115015759265" loading="lazy"/></p>
<h4 data-id="heading-12">欧氏距离</h4>
<p>在语义空间中测量"直线距离"，公式为：距离 = √[(A₁-B₁)² + (A₂-B₂)² + ... + (Aₙ-Bₙ)²]</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09e9e7316f43440f8d710622ce49f7d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=9xuYTSgFkysVosP5YLkipC3Fpiw%3D" alt="image-20251115015900791" loading="lazy"/></p>
<h4 data-id="heading-13">三种方式的适用场景</h4>
<p><strong>余弦相似度</strong>：文本语义比较、文档检索排序、内容推荐系统（多数场景用的都是这个）</p>
<p><strong>欧氏距离</strong>：空间位置测量、聚类分析、异常检测</p>
<p><strong>点积相似度</strong>：快速初步筛选、计算资源有限场景（说白了，就是比较拉）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d9ec75e80ed4bf8a59c3405db71af07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=ZYbUoM%2F5UKgrs7n0MLOcSBZd4j4%3D" alt="image-20251115002350117" loading="lazy"/></p>
<h3 data-id="heading-14">LLM 生成</h3>
<p>好了，经历了上面流程我们基本知道了索引和检索的过程，那么经过检索匹配后的文档就会作为我们跟大模型交互的一部分，这样大模型就会根据我们推荐给它的文档进行思考回复，就避免“胡说八道”。</p>
<p>下面有一个完整的流程图，可以回顾一下~</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d57ed55a36f8427fb7392122ff65fd08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=4rlojaEoNDl1UjDSG7jywxVIQIs%3D" alt="image-20251115021335718" loading="lazy"/></p>
<h2 data-id="heading-15">RAG 实战案例</h2>
<p>为了更深入的了解 RAG 我们就利用 Cherry Studio 这个工具搭建一个最简单的 RAG</p>
<h3 data-id="heading-16">第一步-注册一个阿里百炼的账号</h3>
<p>为什么选择阿里百炼？其实现在的 LLM 差距并不大，我们选择哪家都可以，最主要的百炼平台上有向量模型，我们从上面取一份密钥就可以直接用 LLM 和向量模型啦，比较方便一点（也许腾讯云、百度飞桨、字节火山也会有，但是我并不知道......这个随意）</p>
<p>我们就直接创建一个API 复制就行了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91606eb38d234819920396daae9aa3f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=rGZdyhcw%2BlWF1JKUE68s7TpgkOY%3D" alt="image-20251115223214671" loading="lazy"/></p>
<h3 data-id="heading-17">第二步-打开Cherry Studio进行相关配置</h3>
<p>首先，在模型服务中搜索到“阿里云百炼”，然后填充好刚刚复制好的密钥，检测成功即可</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5e19f12d88f4e6c9955110a35f7c5c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=3Zqmm7fCrE5RuxhmL7DX%2BSsTLj8%3D" alt="image-20251115223906067" loading="lazy"/></p>
<p>然后点击最下方的添加按钮，添加向量模型：text-embedding-v4</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/032f9675807945d09bfa4343173002df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=39S9PkL%2F536%2Ffit3LX%2BgsujZDII%3D" alt="image-20251115224016654" loading="lazy"/></p>
<h3 data-id="heading-18">第三步-添加知识库</h3>
<p>创建知识库，配置向量模型</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6a7c15ca3714b20bb98776e4130c207~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=%2F6W2Q3SXghMEu3L5URWjOnJN0oo%3D" alt="image-20251115224418364" loading="lazy"/></p>
<p>添加要向量化的文件或者目录的位置（我要演示的是 @CustomFilter 这个注解，所以就把有这个注解的MilvusPlus的源码添加进来了），</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/386b1fd3db634f55965134c067faeb92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=coo%2BKZQzguaRTLDLtsI8WJqhosU%3D" alt="image-20251115224610581" loading="lazy"/></p>
<p>这整个过程对应的就是，之前讲的RAG系统中的索引流程</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf16902e695f4ccdb948309be23cb78b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=%2B9xfKlo1aTSc00XHOvH5%2B8Qv3UY%3D" alt="image-20251115224833168" loading="lazy"/></p>
<h3 data-id="heading-19">第四步-配置助手，体验知识库</h3>
<p>首先我们先不给他配置知识库，体验一下他是否会“胡说八道“</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f737791dc5c444958ac9cce4e598f7bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=yYeJzRzZhXgnEMaTyK%2BgvZ7NNW8%3D" alt="image-20251115225044022" loading="lazy"/></p>
<p>确实在胡说八道了。。。。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f43107bda15d4b4c9f980b66942a31e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=%2FTY%2F9NsGPQKPXj4RpkuUUwbtfn4%3D" alt="image-20251115225448855" loading="lazy"/></p>
<p>现在编辑助手，给他安排上知识库看一下，完美撒花🎉</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47657e65337543d58afe4c73fa642eb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZWFjYXBl:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763824300&amp;x-signature=YVoMO5yy%2FQPQJ3g%2B59bj%2FNp3P6g%3D" alt="image-20251115225537768" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ants：强大的高性能与低成本 Go 协程池]]></title>    <link>https://juejin.cn/post/7572524368879075362</link>    <guid>https://juejin.cn/post/7572524368879075362</guid>    <pubDate>2025-11-15T16:14:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572524368879075362" data-draft-id="7572524368879058978" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ants：强大的高性能与低成本 Go 协程池"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-15T16:14:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Panco"/> <meta itemprop="url" content="https://juejin.cn/user/571401778501054"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ants：强大的高性能与低成本 Go 协程池
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/571401778501054/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Panco
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T16:14:48.000Z" title="Sat Nov 15 2025 16:14:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开发高并发程序时，管理并发的能力至关重要。在 Golang 中，虽然可以使用 Go 内置的 goroutines 来处理并发任务，但没有调度和控制的 goroutine 很容易导致系统资源耗尽。为了解决这个问题，ants 是一个高性能且低成本的 Go 协程池库，可以更高效地管理和使用 goroutine。</p>
<p>本文将详细介绍如何使用 ants 作为 goroutine 池来优化 Go 应用程序，包括如何安装 ants、创建池、提交任务、调整参数等，并通过几个示例演示其实际应用。</p>
<h2 data-id="heading-0">安装 ants</h2>
<p>首先，我们需要在项目中安装 ants。这可以通过以下命令完成：</p>
<pre><code class="hljs language-bash" lang="bash">go get -u github.com/panjf2000/ants/v2
</code></pre>
<p>安装完成后，就可以在代码中引用 ants 了。</p>
<h2 data-id="heading-1">基本使用方法</h2>
<p>基本的使用 ants 非常简单。我们可以创建一个 goroutine 池，在池中提交任务，然后关闭池。以下是一个简单的示例：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>
    <span class="hljs-string">"github.com/panjf2000/ants/v2"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    runTask := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">interface</span>{})</span></span> {
        fmt.Printf(<span class="hljs-string">"Running task: %d\n"</span>, i.(<span class="hljs-type">int</span>))
        time.Sleep(<span class="hljs-number">1</span> * time.Second) <span class="hljs-comment">// 模拟任务处理</span>
    }

    <span class="hljs-comment">// 创建一个具有 10 个 goroutines 的池</span>
    p, _ := ants.NewPoolWithFunc(<span class="hljs-number">10</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">interface</span>{})</span></span> {
        runTask(i)
    })
    <span class="hljs-keyword">defer</span> p.Release()

    <span class="hljs-comment">// 提交任务</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++ {
        _ = p.Invoke(i)
    }

    <span class="hljs-comment">// 等待所有任务完成</span>
    p.Wait()
    fmt.Println(<span class="hljs-string">"All tasks completed"</span>)
}
</code></pre>
<p>在这个示例中，我们创建了一个包含 10 个 goroutines 的池，并提交了 30 个任务。ants 会自动调度这些任务，确保并发数不会超过池的大小。</p>
<h2 data-id="heading-2">调整参数</h2>
<p>ants 提供了多种参数来优化池的行为。例如，可以调整池的大小、设置非阻塞模式、以及设置空闲的超时时间等。</p>
<h3 data-id="heading-3">设置池大小</h3>
<p>我们可以创建一个不同大小的池，通过 <code>NewPoolWithFunc</code> 来指定池大小：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">p</span>, _ := ants.<span class="hljs-built_in">NewPoolWithFunc</span>(<span class="hljs-number">20</span>, <span class="hljs-built_in">func</span>(i interface{}) {
    runTask(<span class="hljs-selector-tag">i</span>)
})
</code></pre>
<h3 data-id="heading-4">设置非阻塞模式</h3>
<p>默认情况下，如果池已满，新任务会阻塞直到有空闲 goroutine 可用。我们可以通过设置非阻塞模式来改变这一行为：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">p</span>, _ := ants.<span class="hljs-built_in">NewPoolWithFunc</span>(<span class="hljs-number">10</span>, <span class="hljs-built_in">func</span>(i interface{}) {
    runTask(<span class="hljs-selector-tag">i</span>)
}, ants<span class="hljs-selector-class">.WithNonblocking</span>(true))
</code></pre>
<p>在非阻塞模式下，如果池已满，新任务会立即返回错误，而不是等待。</p>
<h3 data-id="heading-5">设置任务超时</h3>
<p>我们还可以设置池中任务的超时时间，以避免某些任务耗时过长：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">p</span>, _ := ants.<span class="hljs-built_in">NewPoolWithFunc</span>(<span class="hljs-number">10</span>, <span class="hljs-built_in">func</span>(i interface{}) {
    runTask(<span class="hljs-selector-tag">i</span>)
}, ants<span class="hljs-selector-class">.WithExpireDuration</span>(<span class="hljs-number">5</span> * <span class="hljs-selector-tag">time</span><span class="hljs-selector-class">.Second</span>))
</code></pre>
<p>在这个示例中，每个任务最多只能运行 5 秒钟，超过这个时间，任务将被自动终止。</p>
<h2 data-id="heading-6">示例：网络爬虫</h2>
<p>假设我们正在编写一个网络爬虫，需要并发访问多个网页。可以使用 ants 来管理并发连接：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"net/http"</span>
    <span class="hljs-string">"io/ioutil"</span>
    <span class="hljs-string">"github.com/panjf2000/ants/v2"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    urls := []<span class="hljs-type">string</span>{
        <span class="hljs-string">"http://example.com"</span>,
        <span class="hljs-string">"http://example.org"</span>,
        <span class="hljs-string">"http://example.net"</span>,
    }

    fetchURL := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(url <span class="hljs-type">string</span>)</span></span> {
        resp, err := http.Get(url)
        <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
            fmt.Printf(<span class="hljs-string">"Failed to fetch %s: %s\n"</span>, url, err)
            <span class="hljs-keyword">return</span>
        }
        <span class="hljs-keyword">defer</span> resp.Body.Close()
        body, _ := ioutil.ReadAll(resp.Body)
        fmt.Printf(<span class="hljs-string">"Fetched from %s: %d bytes\n"</span>, url, <span class="hljs-built_in">len</span>(body))
    }

    p, _ := ants.NewPoolWithFunc(<span class="hljs-number">5</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">interface</span>{})</span></span> {
        fetchURL(i.(<span class="hljs-type">string</span>))
    })
    <span class="hljs-keyword">defer</span> p.Release()

    <span class="hljs-keyword">for</span> _, url := <span class="hljs-keyword">range</span> urls {
        _ = p.Invoke(url)
    }

    p.Wait()
    fmt.Println(<span class="hljs-string">"All URLs fetched"</span>)
}
</code></pre>
<p>在这个示例中，我们创建了一个网络爬虫，使用 ants 来并发地访问多个网页。爬虫只使用 5 个 goroutines，并发访问多个 URL。</p>
<h2 data-id="heading-7">扩展思路</h2>
<p>除了基本的任务提交和参数调整，还有许多高级用法。下面列举几个：</p>
<h3 data-id="heading-8">动态调整池大小</h3>
<p>有时候，我们需要根据运行时环境动态调整池的大小。ants 支持在运行时调整池大小：</p>
<pre><code class="hljs language-scss" lang="scss">pool<span class="hljs-selector-class">.Tune</span>(<span class="hljs-number">20</span>)
</code></pre>
<h3 data-id="heading-9">性能监控</h3>
<p>ants 内置了一些性能监控功能，可以用来观察池的运行状态：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">fmt</span><span class="hljs-selector-class">.Printf</span>(<span class="hljs-string">"Running goroutines: %d\n"</span>, pool.<span class="hljs-built_in">Running</span>())
<span class="hljs-selector-tag">fmt</span><span class="hljs-selector-class">.Printf</span>(<span class="hljs-string">"Free goroutines: %d\n"</span>, pool.<span class="hljs-built_in">Free</span>())
</code></pre>
<h3 data-id="heading-10">异常处理</h3>
<p>可以为每个任务设置异常处理机制，确保 goroutine 不会因为 panic 而崩溃：</p>
<pre><code class="hljs language-go" lang="go">p, _ := ants.NewPoolWithFunc(<span class="hljs-number">10</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">interface</span>{})</span></span> {
    <span class="hljs-keyword">defer</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> r := <span class="hljs-built_in">recover</span>(); r != <span class="hljs-literal">nil</span> {
            fmt.Println(<span class="hljs-string">"Recovered from panic"</span>, r)
        }
    }()
    runTask(i)
})
</code></pre>
<h2 data-id="heading-11">总结</h2>
<p>使用 ants 可以显著提高 Go 应用程序的并发能力，使得 goroutines 的管理更加高效和可靠。通过调整参数，我们可以更灵活地控制池的行为，以满足不同的应用场景需求。无论是简单的并发任务，还是复杂的并发控制，ants 都提供了强大的支持。</p>
<p>希望通过本文，你能够对 ants 有一个全面的理解，并能在实际项目中灵活运用。🔧🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[241. Java 集合 - 使用 Collections 工厂类处理集合]]></title>    <link>https://juejin.cn/post/7572459757107740726</link>    <guid>https://juejin.cn/post/7572459757107740726</guid>    <pubDate>2025-11-15T23:19:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572459757107740726" data-draft-id="7572465262739701779" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="241. Java 集合 - 使用 Collections 工厂类处理集合"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-11-15T23:19:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Cache技术分享"/> <meta itemprop="url" content="https://juejin.cn/user/1662117313262776"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            241. Java 集合 - 使用 Collections 工厂类处理集合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1662117313262776/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Cache技术分享
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T23:19:05.000Z" title="Sat Nov 15 2025 23:19:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">241. Java 集合 - 使用 <code>Collections</code> 工厂类处理集合</h2>
<p><code>Collections</code> 工厂类提供了一组方法来操作集合及其内容，包含了约 70 个方法。在本节中，我们将重点介绍其中的一部分。</p>
<h4 data-id="heading-1">🏆 提取集合中的最小值或最大值</h4>
<p><code>Collections</code> 类提供了两个方法 <code>min()</code> 和 <code>max()</code> 来提取集合中的最小值和最大值。你可以通过以下两种方式调用它们：</p>
<ol>
<li><strong>不带比较器</strong>：如果没有提供比较器，集合中的元素必须实现 <code>Comparable</code> 接口，否则会抛出 <code>ClassCastException</code> 异常。</li>
<li><strong>带比较器</strong>：如果提供了一个比较器，<code>min()</code> 和 <code>max()</code> 将使用它来确定最小值或最大值，无论集合元素是否实现 <code>Comparable</code>。</li>
</ol>
<h5 data-id="heading-2">示例：获取最小值和最大值</h5>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; numbers = List.of(<span class="hljs-number">5</span>, <span class="hljs-number">2</span>, <span class="hljs-number">9</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>);
<span class="hljs-type">int</span> <span class="hljs-variable">min</span> <span class="hljs-operator">=</span> Collections.min(numbers);
<span class="hljs-type">int</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> Collections.max(numbers);
System.out.println(<span class="hljs-string">"Min: "</span> + min + <span class="hljs-string">", Max: "</span> + max);
</code></pre>
<p><strong>注意</strong>：</p>
<ul>
<li>对于空集合，调用 <code>min()</code> 或 <code>max()</code> 方法会抛出 <code>NoSuchMethodException</code> 异常。</li>
</ul>
<hr/>
<h4 data-id="heading-3">🔍 查找列表中的子列表</h4>
<p><code>Collections</code> 类提供了两个方法来查找子列表在更大列表中的位置：</p>
<ol>
<li><strong><code>indexOfSublist(List&lt;?&gt; source, List&lt;?&gt; target)</code></strong>：返回目标列表中第一个元素在源列表中的索引。如果目标列表不存在，返回 <code>-1</code>。</li>
<li><strong><code>lastIndexOfSublist(List&lt;?&gt; source, List&lt;?&gt; target)</code></strong>：返回目标列表最后一个元素在源列表中的索引。</li>
</ol>
<h5 data-id="heading-4">示例：查找子列表</h5>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; source = List.of(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>, <span class="hljs-string">"e"</span>);
List&lt;String&gt; target = List.of(<span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>);
<span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> Collections.indexOfSubList(source, target);
System.out.println(<span class="hljs-string">"Index of sublist: "</span> + index);
</code></pre>
<p><strong>输出</strong>：</p>
<pre><code class="hljs language-java" lang="java">Index of sublist: <span class="hljs-number">2</span>
</code></pre>
<hr/>
<h4 data-id="heading-5">🔄 更改列表元素的顺序</h4>
<p><code>Collections</code> 类提供了几个方法来改变列表中元素的顺序：</p>
<ol>
<li><strong><code>sort()</code></strong>：按升序排序列表。可以传入一个 <code>Comparator</code>，如果没有，则要求元素必须实现 <code>Comparable</code> 接口。自 Java SE 8 以来，推荐使用 <code>List</code> 接口中的 <code>sort()</code> 方法。</li>
<li><strong><code>shuffle()</code></strong>：随机打乱列表元素的顺序。可以传入一个 <code>Random</code> 实例，如果需要可重复的随机顺序。</li>
<li><strong><code>rotate()</code></strong>：旋转列表的元素。旋转后，索引 0 的元素将移动到索引 1，依此类推，最后的元素将移动到列表的开头。</li>
</ol>
<h5 data-id="heading-6">示例：旋转列表元素</h5>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; strings = Arrays.asList(<span class="hljs-string">"0"</span>, <span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>, <span class="hljs-string">"4"</span>);
System.out.println(<span class="hljs-string">"Before rotate: "</span> + strings);
Collections.rotate(strings, <span class="hljs-number">1</span>); <span class="hljs-comment">// 向右旋转</span>
System.out.println(<span class="hljs-string">"After rotate: "</span> + strings);
</code></pre>
<p><strong>输出</strong>：</p>
<pre><code class="hljs language-java" lang="java">Before rotate: [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]
After rotate: [<span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]
</code></pre>
<ol>
<li><strong><code>reverse()</code></strong>：反转列表中元素的顺序。</li>
<li><strong><code>swap()</code></strong>：交换列表中的两个元素。</li>
</ol>
<h5 data-id="heading-7">示例：反转列表</h5>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; strings = Arrays.asList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>);
Collections.reverse(strings);
System.out.println(<span class="hljs-string">"Reversed list: "</span> + strings);
</code></pre>
<p><strong>输出</strong>：</p>
<pre><code class="hljs language-java" lang="java">Reversed list: [d, c, b, a]
</code></pre>
<hr/>
<h4 data-id="heading-8">🛡️ 包装集合为不可变集合</h4>
<p><code>Collections</code> 工厂类提供了几种方法，用于创建集合的不可变包装器。包装后的集合无法修改，任何修改操作都会抛出异常。重要的是，这些方法返回的是包装器，而不是集合的副本，所以如果原集合被修改，包装器也会反映出这些变化。</p>
<p>这些方法的命名遵循一定规则，通常以 <code>unmodifiable</code> 开头。例如，要创建一个不可变的 <code>List</code> 包装器，你可以使用 <code>unmodifiableList()</code> 方法。</p>
<h5 data-id="heading-9">示例：创建不可变列表</h5>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; strings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="hljs-string">"0"</span>, <span class="hljs-string">"1"</span>, <span class="hljs-string">"2"</span>, <span class="hljs-string">"3"</span>, <span class="hljs-string">"4"</span>));
List&lt;String&gt; immutableStrings = Collections.unmodifiableList(strings);
System.out.println(immutableStrings);
<span class="hljs-comment">// 下面的代码会抛出 UnsupportedOperationException 异常</span>
immutableStrings.add(<span class="hljs-string">"5"</span>);
</code></pre>
<p><strong>输出</strong>：</p>
<pre><code class="hljs language-java" lang="java">[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]
</code></pre>
<p><strong>注意</strong>：如果你修改了原始集合（<code>strings</code>），它也会反映在不可变集合中。这是因为不可变包装器仅仅是原集合的一个视图。</p>
<hr/>
<h4 data-id="heading-10">🔒 包装集合为同步集合</h4>
<p>和创建不可变集合类似，<code>Collections</code> 工厂类还可以创建同步集合的包装器。同步集合确保在多线程环境下安全访问。</p>
<p>同步集合的命名规则为：<code>synchronized</code> 后跟集合类型名称。例如，要创建同步的 <code>List</code>，你可以使用 <code>synchronizedList()</code> 方法。</p>
<h5 data-id="heading-11">示例：创建同步列表</h5>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; synchronizedList = Collections.synchronizedList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(Arrays.asList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>)));
</code></pre>
<p><strong>注意事项</strong>：</p>
<ul>
<li>所有对集合的访问必须通过同步包装器进行。</li>
<li>在遍历集合时，使用迭代器或流时，代码需要进行同步操作，以避免竞态条件。</li>
</ul>
<p>尽管 <code>Collections</code> 提供了同步集合，但 <code>Java.util.concurrent</code> 包中的类通常提供了更好的并发解决方案。</p>
<hr/>
<h4 data-id="heading-12">📜 小结</h4>
<ol>
<li><strong><code>min()</code> 和 <code>max()</code></strong>：提取集合中的最小值和最大值，支持使用比较器。</li>
<li><strong><code>indexOfSubList()</code> 和 <code>lastIndexOfSubList()</code></strong>：查找子列表在大列表中的位置。</li>
<li><strong>排序和顺序操作</strong>：<code>sort()</code>, <code>shuffle()</code>, <code>rotate()</code>, <code>reverse()</code> 和 <code>swap()</code> 提供了多种操作集合顺序的方法。</li>
<li><strong>不可变集合包装</strong>：使用 <code>unmodifiable</code> 系列方法创建不可变集合，修改原集合会反映到不可变集合中。</li>
<li><strong>同步集合包装</strong>：使用 <code>synchronized</code> 系列方法创建同步集合，确保线程安全。</li>
</ol>
<hr/>
<p><strong>问题</strong>：如何通过 <code>Collections</code> 类创建一个不可变的 <code>List</code>？
<strong>答案</strong>：你可以使用 <code>Collections.unmodifiableList()</code> 方法创建一个不可变的 <code>List</code>，但要小心，如果原始集合被修改，包装器也会反映这些变化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 下的端口转发：ssh、socat、iptables 三种方案对比]]></title>    <link>https://juejin.cn/post/7572697146286686258</link>    <guid>https://juejin.cn/post/7572697146286686258</guid>    <pubDate>2025-11-15T23:22:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572697146286686258" data-draft-id="7572714389922447400" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 下的端口转发：ssh、socat、iptables 三种方案对比"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-11-15T23:22:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LCG元"/> <meta itemprop="url" content="https://juejin.cn/user/3097802498120889"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 下的端口转发：ssh、socat、iptables 三种方案对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097802498120889/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LCG元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T23:22:41.000Z" title="Sat Nov 15 2025 23:22:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 端口转发概述</h3>
<p>端口转发（Port Forwarding）是一种将网络数据包从一个网络端口重定向到另一个端口或主机的技术。在Linux环境中，端口转发常用于安全访问、服务暴露、网络调试等场景。本文将详细探讨三种常见的端口转发方案：SSH、socat和iptables，分析各自的优缺点，并提供完整的配置示例。</p>
<h3 data-id="heading-1">2. 环境准备与基础概念</h3>
<h4 data-id="heading-2">2.1 测试环境搭建</h4>
<p>在开始配置之前，我们需要准备测试环境：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建测试目录</span>
<span class="hljs-built_in">mkdir</span> -p ~/port_forwarding_demo
<span class="hljs-built_in">cd</span> ~/port_forwarding_demo

<span class="hljs-comment"># 安装必要工具（基于Ubuntu/Debian）</span>
sudo apt update
sudo apt install -y openssh-client openssh-server socat net-tools iptables-persistent netcat

<span class="hljs-comment"># 验证工具安装</span>
ssh -V
socat -version
iptables --version
</code></pre>
<h4 data-id="heading-3">2.2 网络拓扑说明</h4>
<p>在本文的示例中，我们将使用以下网络配置：</p>
<ul>
<li><strong>本地主机</strong>：127.0.0.1 (localhost)</li>
<li><strong>目标服务</strong>：运行在8080端口的Web服务</li>
<li><strong>中转端口</strong>：9000（用于转发）</li>
<li><strong>远程主机</strong>：192.168.1.100（在实际使用时替换为你的远程服务器IP）</li>
</ul>
<h3 data-id="heading-4">3. SSH端口转发方案</h3>
<h4 data-id="heading-5">3.1 SSH端口转发原理</h4>
<p>SSH端口转发利用SSH协议的安全隧道功能，在客户端和服务器之间建立加密通道。数据流向如下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[客户端应用] --&gt; B[本地SSH客户端];
    B --&gt; C[SSH加密隧道];
    C --&gt; D[远程SSH服务器];
    D --&gt; E[目标服务];
    E --&gt; D;
    D --&gt; C;
    C --&gt; B;
    B --&gt; A;
    
    style A fill:#1e81b0,color:#fff
    style B fill:#1e81b0,color:#fff
    style C fill:#ee6c4d,color:#fff
    style D fill:#1e81b0,color:#fff
    style E fill:#1e81b0,color:#fff
</code></pre>
<h4 data-id="heading-6">3.2 本地端口转发</h4>
<p>本地端口转发将本地端口的流量通过SSH隧道转发到远程服务器。</p>
<p><strong>创建配置文件：local_forward.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># local_forward.sh - SSH本地端口转发示例</span>

<span class="hljs-comment"># 配置参数</span>
REMOTE_USER=<span class="hljs-string">"your_username"</span>
REMOTE_HOST=<span class="hljs-string">"192.168.1.100"</span>
REMOTE_PORT=<span class="hljs-string">"8080"</span>
LOCAL_PORT=<span class="hljs-string">"9000"</span>
SSH_PORT=<span class="hljs-string">"22"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"正在设置SSH本地端口转发..."</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"将本地端口 <span class="hljs-variable">${LOCAL_PORT}</span> 转发到 <span class="hljs-variable">${REMOTE_HOST}</span>:<span class="hljs-variable">${REMOTE_PORT}</span>"</span>

<span class="hljs-comment"># 检查SSH密钥是否存在，如果不存在则生成</span>
<span class="hljs-keyword">if</span> [ ! -f ~/.ssh/id_rsa ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"生成SSH密钥对..."</span>
    ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N <span class="hljs-string">""</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"请将公钥复制到远程服务器："</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"ssh-copy-id <span class="hljs-variable">${REMOTE_USER}</span>@<span class="hljs-variable">${REMOTE_HOST}</span>"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 执行端口转发命令</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动SSH端口转发，按Ctrl+C终止"</span>
ssh -N -L <span class="hljs-variable">${LOCAL_PORT}</span>:127.0.0.1:<span class="hljs-variable">${REMOTE_PORT}</span> <span class="hljs-variable">${REMOTE_USER}</span>@<span class="hljs-variable">${REMOTE_HOST}</span> -p <span class="hljs-variable">${SSH_PORT}</span>

<span class="hljs-comment"># 如果连接失败，提示用户</span>
<span class="hljs-keyword">if</span> [ $? -ne 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"SSH连接失败，请检查："</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 远程服务器地址和用户名是否正确"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"2. SSH服务是否在远程服务器上运行"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 防火墙设置是否允许SSH连接"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"4. 是否已经将SSH公钥添加到远程服务器"</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<p><strong>使用方法：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 给脚本执行权限</span>
<span class="hljs-built_in">chmod</span> +x local_forward.sh

<span class="hljs-comment"># 执行端口转发</span>
./local_forward.sh
</code></pre>
<h4 data-id="heading-7">3.3 远程端口转发</h4>
<p>远程端口转发将远程服务器端口的流量转发到本地服务。</p>
<p><strong>创建配置文件：remote_forward.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># remote_forward.sh - SSH远程端口转发示例</span>

<span class="hljs-comment"># 配置参数</span>
REMOTE_USER=<span class="hljs-string">"your_username"</span>
REMOTE_HOST=<span class="hljs-string">"192.168.1.100"</span>
REMOTE_PORT=<span class="hljs-string">"9000"</span>
LOCAL_PORT=<span class="hljs-string">"8080"</span>
LOCAL_HOST=<span class="hljs-string">"127.0.0.1"</span>
SSH_PORT=<span class="hljs-string">"22"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"正在设置SSH远程端口转发..."</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"将远程服务器 <span class="hljs-variable">${REMOTE_HOST}</span> 的端口 <span class="hljs-variable">${REMOTE_PORT}</span> 转发到本地 <span class="hljs-variable">${LOCAL_HOST}</span>:<span class="hljs-variable">${LOCAL_PORT}</span>"</span>

<span class="hljs-comment"># 检查本地服务是否运行</span>
<span class="hljs-keyword">if</span> ! nc -z <span class="hljs-variable">${LOCAL_HOST}</span> <span class="hljs-variable">${LOCAL_PORT}</span> 2&gt;/dev/null; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告：本地服务 <span class="hljs-variable">${LOCAL_HOST}</span>:<span class="hljs-variable">${LOCAL_PORT}</span> 可能没有运行"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"请确保在继续之前启动本地服务"</span>
    <span class="hljs-built_in">read</span> -p <span class="hljs-string">"是否继续？(y/n): "</span> -n 1 -r
    <span class="hljs-built_in">echo</span>
    <span class="hljs-keyword">if</span> [[ ! <span class="hljs-variable">$REPLY</span> =~ ^[Yy]$ ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 执行远程端口转发</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动SSH远程端口转发，按Ctrl+C终止"</span>
ssh -N -R <span class="hljs-variable">${REMOTE_PORT}</span>:<span class="hljs-variable">${LOCAL_HOST}</span>:<span class="hljs-variable">${LOCAL_PORT}</span> <span class="hljs-variable">${REMOTE_USER}</span>@<span class="hljs-variable">${REMOTE_HOST}</span> -p <span class="hljs-variable">${SSH_PORT}</span>

<span class="hljs-keyword">if</span> [ $? -ne 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"SSH远程端口转发失败"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"请检查："</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 远程服务器的SSH配置是否允许远程端口转发（GatewayPorts选项）"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 远程服务器防火墙设置"</span>
<span class="hljs-keyword">fi</span>
</code></pre>
<h4 data-id="heading-8">3.4 动态端口转发</h4>
<p>动态端口转发创建SOCKS代理服务器。</p>
<p><strong>创建配置文件：dynamic_forward.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># dynamic_forward.sh - SSH动态端口转发示例</span>

<span class="hljs-comment"># 配置参数</span>
REMOTE_USER=<span class="hljs-string">"your_username"</span>
REMOTE_HOST=<span class="hljs-string">"192.168.1.100"</span>
SOCKS_PORT=<span class="hljs-string">"1080"</span>
SSH_PORT=<span class="hljs-string">"22"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"正在设置SSH动态端口转发(SOCKS代理)..."</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"SOCKS代理将在本地端口 <span class="hljs-variable">${SOCKS_PORT}</span> 启动"</span>

<span class="hljs-comment"># 启动动态端口转发</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动SOCKS代理服务器，按Ctrl+C终止"</span>
ssh -N -D 127.0.0.1:<span class="hljs-variable">${SOCKS_PORT}</span> <span class="hljs-variable">${REMOTE_USER}</span>@<span class="hljs-variable">${REMOTE_HOST}</span> -p <span class="hljs-variable">${SSH_PORT}</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"SOCKS代理已停止"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"配置浏览器或其他应用使用SOCKS代理：127.0.0.1:<span class="hljs-variable">${SOCKS_PORT}</span>"</span>
</code></pre>
<h4 data-id="heading-9">3.5 SSH端口转发高级配置</h4>
<p><strong>创建配置文件：ssh_advanced.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># ssh_advanced.sh - SSH高级端口转发配置</span>

<span class="hljs-comment"># 配置参数</span>
REMOTE_USER=<span class="hljs-string">"your_username"</span>
REMOTE_HOST=<span class="hljs-string">"192.168.1.100"</span>
SSH_PORT=<span class="hljs-string">"22"</span>
CONFIG_FILE=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/ssh_forward_config"</span>

<span class="hljs-comment"># 写入SSH客户端配置</span>
<span class="hljs-built_in">cat</span> &gt; <span class="hljs-variable">${CONFIG_FILE}</span> &lt;&lt; <span class="hljs-string">EOF
# SSH端口转发配置
Host forward-server
    HostName ${REMOTE_HOST}
    User ${REMOTE_USER}
    Port ${SSH_PORT}
    ServerAliveInterval 60
    ServerAliveCountMax 3
    Compression yes
    ExitOnForwardFailure yes
    LocalForward 9000 127.0.0.1:8080
    RemoteForward 9001 127.0.0.1:3000
    
# 自动重连配置
Host auto-reconnect
    HostName ${REMOTE_HOST}
    User ${REMOTE_USER}
    Port ${SSH_PORT}
    ServerAliveInterval 30
    ServerAliveCountMax 10
    TCPKeepAlive yes
    ExitOnForwardFailure yes
EOF</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"SSH配置文件已生成: <span class="hljs-variable">${CONFIG_FILE}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"使用方法:"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 本地转发: ssh -L 9000:localhost:8080 <span class="hljs-variable">${REMOTE_USER}</span>@<span class="hljs-variable">${REMOTE_HOST}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 远程转发: ssh -R 9001:localhost:3000 <span class="hljs-variable">${REMOTE_USER}</span>@<span class="hljs-variable">${REMOTE_HOST}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 使用配置文件: ssh -F <span class="hljs-variable">${CONFIG_FILE}</span> forward-server"</span>
</code></pre>
<h3 data-id="heading-10">4. socat端口转发方案</h3>
<h4 data-id="heading-11">4.1 socat工作原理</h4>
<p>socat是一个多功能的网络工具，可以在两个数据流之间建立双向通道。其数据流向如下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[源客户端] --&gt; B[socat进程];
    B --&gt; C[目标服务];
    C --&gt; B;
    B --&gt; A;
    
    style A fill:#1e81b0,color:#fff
    style B fill:#ee6c4d,color:#fff
    style C fill:#1e81b0,color:#fff
</code></pre>
<h4 data-id="heading-12">4.2 基础TCP端口转发</h4>
<p><strong>创建配置文件：socat_basic.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># socat_basic.sh - 基础TCP端口转发</span>

LISTEN_PORT=<span class="hljs-string">"9000"</span>
TARGET_HOST=<span class="hljs-string">"192.168.1.100"</span>
TARGET_PORT=<span class="hljs-string">"8080"</span>
LOG_FILE=<span class="hljs-string">"/tmp/socat_forward.log"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动socat TCP端口转发..."</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"监听端口: <span class="hljs-variable">${LISTEN_PORT}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"目标地址: <span class="hljs-variable">${TARGET_HOST}</span>:<span class="hljs-variable">${TARGET_PORT}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"日志文件: <span class="hljs-variable">${LOG_FILE}</span>"</span>

<span class="hljs-comment"># 检查目标端口是否可达</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"检查目标服务器连通性..."</span>
<span class="hljs-keyword">if</span> ! nc -z <span class="hljs-variable">${TARGET_HOST}</span> <span class="hljs-variable">${TARGET_PORT}</span> 2&gt;/dev/null; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告: 无法连接到目标服务器 <span class="hljs-variable">${TARGET_HOST}</span>:<span class="hljs-variable">${TARGET_PORT}</span>"</span>
    <span class="hljs-built_in">read</span> -p <span class="hljs-string">"是否继续？(y/n): "</span> -n 1 -r
    <span class="hljs-built_in">echo</span>
    <span class="hljs-keyword">if</span> [[ ! <span class="hljs-variable">$REPLY</span> =~ ^[Yy]$ ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 创建日志目录</span>
<span class="hljs-built_in">mkdir</span> -p $(<span class="hljs-built_in">dirname</span> <span class="hljs-variable">${LOG_FILE}</span>)

<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动时间: <span class="hljs-subst">$(date)</span>"</span> &gt;&gt; <span class="hljs-variable">${LOG_FILE}</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动socat进程..."</span>

<span class="hljs-comment"># 启动socat端口转发</span>
socat -d -d -lf <span class="hljs-variable">${LOG_FILE}</span> \
    TCP-LISTEN:<span class="hljs-variable">${LISTEN_PORT}</span>,fork,reuseaddr \
    TCP:<span class="hljs-variable">${TARGET_HOST}</span>:<span class="hljs-variable">${TARGET_PORT}</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"socat进程已停止"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"查看详细日志: tail -f <span class="hljs-variable">${LOG_FILE}</span>"</span>
</code></pre>
<h4 data-id="heading-13">4.3 SSL/TLS加密转发</h4>
<p><strong>创建配置文件：socat_ssl.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># socat_ssl.sh - SSL/TLS加密端口转发</span>

LISTEN_PORT=<span class="hljs-string">"9000"</span>
TARGET_HOST=<span class="hljs-string">"192.168.1.100"</span>
TARGET_PORT=<span class="hljs-string">"8080"</span>
CERT_DIR=<span class="hljs-string">"./ssl_certs"</span>
KEY_FILE=<span class="hljs-string">"<span class="hljs-variable">${CERT_DIR}</span>/server.key"</span>
CERT_FILE=<span class="hljs-string">"<span class="hljs-variable">${CERT_DIR}</span>/server.crt"</span>
LOG_FILE=<span class="hljs-string">"/tmp/socat_ssl.log"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"设置SSL/TLS加密端口转发..."</span>

<span class="hljs-comment"># 创建SSL证书目录</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">${CERT_DIR}</span>

<span class="hljs-comment"># 生成自签名SSL证书（如果不存在）</span>
<span class="hljs-keyword">if</span> [ ! -f <span class="hljs-variable">${KEY_FILE}</span> ] || [ ! -f <span class="hljs-variable">${CERT_FILE}</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"生成自签名SSL证书..."</span>
    openssl req -x509 -newkey rsa:4096 -keyout <span class="hljs-variable">${KEY_FILE}</span> \
        -out <span class="hljs-variable">${CERT_FILE}</span> -days 365 -nodes -subj \
        <span class="hljs-string">"/C=US/ST=State/L=City/O=Organization/CN=localhost"</span>
    
    <span class="hljs-keyword">if</span> [ $? -eq 0 ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"SSL证书已生成:"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"密钥文件: <span class="hljs-variable">${KEY_FILE}</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"证书文件: <span class="hljs-variable">${CERT_FILE}</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"SSL证书生成失败"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动SSL加密转发..."</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"监听端口: <span class="hljs-variable">${LISTEN_PORT}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"目标地址: <span class="hljs-variable">${TARGET_HOST}</span>:<span class="hljs-variable">${TARGET_PORT}</span>"</span>

<span class="hljs-comment"># 启动SSL加密转发</span>
socat -d -d -lf <span class="hljs-variable">${LOG_FILE}</span> \
    openssl-listen:<span class="hljs-variable">${LISTEN_PORT}</span>,fork,reuseaddr,cert=<span class="hljs-variable">${CERT_FILE}</span>,key=<span class="hljs-variable">${KEY_FILE}</span>,verify=0 \
    TCP:<span class="hljs-variable">${TARGET_HOST}</span>:<span class="hljs-variable">${TARGET_PORT}</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"SSL转发进程已停止"</span>
</code></pre>
<h4 data-id="heading-14">4.4 UDP端口转发</h4>
<p><strong>创建配置文件：socat_udp.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># socat_udp.sh - UDP端口转发</span>

LISTEN_PORT=<span class="hljs-string">"9000"</span>
TARGET_HOST=<span class="hljs-string">"192.168.1.100"</span>
TARGET_PORT=<span class="hljs-string">"8080"</span>
PROTOCOL=<span class="hljs-string">"UDP"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动<span class="hljs-variable">${PROTOCOL}</span>端口转发..."</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"监听端口: <span class="hljs-variable">${LISTEN_PORT}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"目标地址: <span class="hljs-variable">${TARGET_HOST}</span>:<span class="hljs-variable">${TARGET_PORT}</span>"</span>

<span class="hljs-comment"># 检查socat版本是否支持UDP</span>
socat -h | grep -q <span class="hljs-string">"UDP4"</span>
<span class="hljs-keyword">if</span> [ $? -ne 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告: 当前socat版本可能不完全支持UDP功能"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动UDP端口转发进程..."</span>

<span class="hljs-comment"># 启动UDP转发</span>
socat -u UDP4-LISTEN:<span class="hljs-variable">${LISTEN_PORT}</span>,fork,reuseaddr \
    UDP4:<span class="hljs-variable">${TARGET_HOST}</span>:<span class="hljs-variable">${TARGET_PORT}</span> &amp;

PID=$!
<span class="hljs-built_in">echo</span> <span class="hljs-string">"UDP转发进程已启动 (PID: <span class="hljs-variable">${PID}</span>)"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"按任意键停止转发..."</span>
<span class="hljs-built_in">read</span> -n 1

<span class="hljs-built_in">kill</span> <span class="hljs-variable">${PID}</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"UDP转发进程已停止"</span>
</code></pre>
<h4 data-id="heading-15">4.5 高级socat配置</h4>
<p><strong>创建配置文件：socat_advanced.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># socat_advanced.sh - 高级socat配置</span>

CONFIG_DIR=<span class="hljs-string">"./socat_configs"</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">${CONFIG_DIR}</span>

<span class="hljs-comment"># 创建多个转发配置</span>
<span class="hljs-built_in">cat</span> &gt; <span class="hljs-variable">${CONFIG_DIR}</span>/web_forward.cfg &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># Web服务转发配置</span>
<span class="hljs-comment"># 监听端口: 9080 -&gt; 目标: 192.168.1.100:80</span>
socat TCP-LISTEN:9080,fork,reuseaddr TCP:192.168.1.100:80
EOF

<span class="hljs-built_in">cat</span> &gt; <span class="hljs-variable">${CONFIG_DIR}</span>/database_forward.cfg &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># 数据库服务转发配置  </span>
<span class="hljs-comment"># 监听端口: 93306 -&gt; 目标: 192.168.1.100:3306</span>
socat TCP-LISTEN:93306,fork,reuseaddr TCP:192.168.1.100:3306
EOF

<span class="hljs-built_in">cat</span> &gt; <span class="hljs-variable">${CONFIG_DIR}</span>/ssl_termination.cfg &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># SSL终止配置</span>
<span class="hljs-comment"># 外部SSL -&gt; 内部明文</span>
socat OPENSSL-LISTEN:9443,fork,reuseaddr,cert=./ssl_certs/server.crt,key=./ssl_certs/server.key,verify=0 TCP:192.168.1.100:443
EOF

<span class="hljs-comment"># 创建启动脚本</span>
<span class="hljs-built_in">cat</span> &gt; <span class="hljs-variable">${CONFIG_DIR}</span>/start_all.sh &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment">#!/bin/bash</span>
<span class="hljs-comment"># 启动所有socat转发</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"启动所有socat转发服务..."</span>

<span class="hljs-comment"># 启动Web转发</span>
socat TCP-LISTEN:9080,fork,reuseaddr TCP:192.168.1.100:80 &amp;
WEB_PID=$!
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Web转发启动 (PID: <span class="hljs-variable">$WEB_PID</span>)"</span>

<span class="hljs-comment"># 启动数据库转发</span>
socat TCP-LISTEN:93306,fork,reuseaddr TCP:192.168.1.100:3306 &amp;
DB_PID=$!
<span class="hljs-built_in">echo</span> <span class="hljs-string">"数据库转发启动 (PID: <span class="hljs-variable">$DB_PID</span>)"</span>

<span class="hljs-comment"># 保存PID文件</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$WEB_PID</span> <span class="hljs-variable">$DB_PID</span>"</span> &gt; /tmp/socat_pids.txt

<span class="hljs-built_in">echo</span> <span class="hljs-string">"所有服务已启动"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"停止所有服务: kill \$(cat /tmp/socat_pids.txt)"</span>
EOF

<span class="hljs-built_in">chmod</span> +x <span class="hljs-variable">${CONFIG_DIR}</span>/start_all.sh

<span class="hljs-built_in">echo</span> <span class="hljs-string">"高级socat配置已生成在: <span class="hljs-variable">${CONFIG_DIR}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"配置文件:"</span>
<span class="hljs-built_in">ls</span> -la <span class="hljs-variable">${CONFIG_DIR}</span>/
</code></pre>
<h3 data-id="heading-16">5. iptables端口转发方案</h3>
<h4 data-id="heading-17">5.1 iptables转发原理</h4>
<p>iptables是Linux内核的包过滤系统，可以用于实现网络地址转换(NAT)和端口转发。其数据流向如下：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[外部客户端] --&gt; B[网络接口];
    B --&gt; C[PREROUTING链];
    C --&gt; D[路由判断];
    D --&gt; E[FORWARD链];
    E --&gt; F[POSTROUTING链];
    F --&gt; G[目标服务];
    G --&gt; F;
    F --&gt; E;
    E --&gt; D;
    D --&gt; C;
    C --&gt; B;
    B --&gt; A;
    
    style A fill:#1e81b0,color:#fff
    style B fill:#ee6c4d,color:#fff
    style C fill:#1e81b0,color:#fff
    style D fill:#1e81b0,color:#fff
    style E fill:#1e81b0,color:#fff
    style F fill:#1e81b0,color:#fff
    style G fill:#1e81b0,color:#fff
</code></pre>
<h4 data-id="heading-18">5.2 基础端口转发配置</h4>
<p><strong>创建配置文件：iptables_basic.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># iptables_basic.sh - 基础iptables端口转发</span>

INTERNAL_HOST=<span class="hljs-string">"192.168.1.100"</span>
INTERNAL_PORT=<span class="hljs-string">"8080"</span>
EXTERNAL_PORT=<span class="hljs-string">"9000"</span>
EXTERNAL_IFACE=<span class="hljs-string">"eth0"</span>  <span class="hljs-comment"># 根据实际情况修改</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"配置iptables端口转发..."</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"外部端口: <span class="hljs-variable">${EXTERNAL_PORT}</span> -&gt; 内部: <span class="hljs-variable">${INTERNAL_HOST}</span>:<span class="hljs-variable">${INTERNAL_PORT}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"网络接口: <span class="hljs-variable">${EXTERNAL_IFACE}</span>"</span>

<span class="hljs-comment"># 检查是否具有root权限</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$EUID</span>"</span> -ne 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"请使用root权限运行此脚本"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用方法: sudo ./iptables_basic.sh"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 启用IP转发</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"启用IP转发..."</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'1'</span> &gt; /proc/sys/net/ipv4/ip_forward
sysctl -w net.ipv4.ip_forward=1

<span class="hljs-comment"># 配置端口转发规则</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"添加iptables规则..."</span>

<span class="hljs-comment"># 1. 在nat表的PREROUTING链中添加DNAT规则</span>
iptables -t nat -A PREROUTING -i <span class="hljs-variable">${EXTERNAL_IFACE}</span> -p tcp --dport <span class="hljs-variable">${EXTERNAL_PORT}</span> \
    -j DNAT --to-destination <span class="hljs-variable">${INTERNAL_HOST}</span>:<span class="hljs-variable">${INTERNAL_PORT}</span>

<span class="hljs-comment"># 2. 在nat表的POSTROUTING链中添加SNAT规则</span>
iptables -t nat -A POSTROUTING -o <span class="hljs-variable">${EXTERNAL_IFACE}</span> -p tcp -d <span class="hljs-variable">${INTERNAL_HOST}</span> --dport <span class="hljs-variable">${INTERNAL_PORT}</span> \
    -j MASQUERADE

<span class="hljs-comment"># 3. 在filter表中允许转发的流量</span>
iptables -A FORWARD -i <span class="hljs-variable">${EXTERNAL_IFACE}</span> -o <span class="hljs-variable">${EXTERNAL_IFACE}</span> -p tcp \
    --dport <span class="hljs-variable">${INTERNAL_PORT}</span> -d <span class="hljs-variable">${INTERNAL_HOST}</span> -j ACCEPT
iptables -A FORWARD -i <span class="hljs-variable">${EXTERNAL_IFACE}</span> -o <span class="hljs-variable">${EXTERNAL_IFACE}</span> -p tcp \
    --sport <span class="hljs-variable">${INTERNAL_PORT}</span> -s <span class="hljs-variable">${INTERNAL_HOST}</span> -j ACCEPT

<span class="hljs-built_in">echo</span> <span class="hljs-string">"iptables规则配置完成"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"当前NAT表规则:"</span>
iptables -t nat -L -n -v

<span class="hljs-built_in">echo</span> <span class="hljs-string">"当前FILTER表规则:"</span>
iptables -L FORWARD -n -v
</code></pre>
<h4 data-id="heading-19">5.3 持久化iptables规则</h4>
<p><strong>创建配置文件：iptables_persistent.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># iptables_persistent.sh - iptables规则持久化</span>

RULES_FILE=<span class="hljs-string">"/etc/iptables/rules.v4"</span>
BACKUP_DIR=<span class="hljs-string">"./iptables_backup"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"配置iptables规则持久化..."</span>

<span class="hljs-comment"># 检查root权限</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$EUID</span>"</span> -ne 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"请使用root权限运行此脚本"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 创建备份目录</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">${BACKUP_DIR}</span>
BACKUP_FILE=<span class="hljs-string">"<span class="hljs-variable">${BACKUP_DIR}</span>/rules.v4.backup.<span class="hljs-subst">$(date +%Y%m%d_%H%M%S)</span>"</span>

<span class="hljs-comment"># 备份当前规则</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"备份当前iptables规则..."</span>
iptables-save &gt; <span class="hljs-variable">${BACKUP_FILE}</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"规则已备份到: <span class="hljs-variable">${BACKUP_FILE}</span>"</span>

<span class="hljs-comment"># 安装iptables-persistent（如果未安装）</span>
<span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v netfilter-persistent &gt; /dev/null; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"安装iptables-persistent..."</span>
    apt update
    apt install -y iptables-persistent
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 保存当前规则</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"保存当前规则到持久化文件..."</span>
iptables-save &gt; <span class="hljs-variable">${RULES_FILE}</span>

<span class="hljs-comment"># 创建系统服务脚本</span>
<span class="hljs-built_in">cat</span> &gt; /etc/systemd/system/iptables-load.service &lt;&lt; <span class="hljs-string">EOF
[Unit]
Description=Load iptables rules
After=network.target

[Service]
Type=oneshot
ExecStart=/sbin/iptables-restore &lt; ${RULES_FILE}
ExecReload=/sbin/iptables-restore &lt; ${RULES_FILE}
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF</span>

<span class="hljs-comment"># 启用服务</span>
systemctl daemon-reload
systemctl <span class="hljs-built_in">enable</span> iptables-load.service

<span class="hljs-built_in">echo</span> <span class="hljs-string">"iptables规则持久化配置完成"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"规则文件: <span class="hljs-variable">${RULES_FILE}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"备份文件: <span class="hljs-variable">${BACKUP_FILE}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"服务状态: systemctl status iptables-load"</span>
</code></pre>
<h4 data-id="heading-20">5.4 高级iptables转发配置</h4>
<p><strong>创建配置文件：iptables_advanced.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># iptables_advanced.sh - 高级iptables转发配置</span>

<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$EUID</span>"</span> -ne 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"请使用root权限运行此脚本"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

CONFIG_DIR=<span class="hljs-string">"./iptables_advanced"</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">${CONFIG_DIR}</span>

<span class="hljs-comment"># 创建端口转发配置函数</span>
<span class="hljs-function"><span class="hljs-title">create_forward_rule</span></span>() {
    <span class="hljs-built_in">local</span> name=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">local</span> ext_port=<span class="hljs-variable">$2</span>
    <span class="hljs-built_in">local</span> int_host=<span class="hljs-variable">$3</span>
    <span class="hljs-built_in">local</span> int_port=<span class="hljs-variable">$4</span>
    <span class="hljs-built_in">local</span> protocol=<span class="hljs-variable">${5:-tcp}</span>
    
    <span class="hljs-built_in">cat</span> &gt; <span class="hljs-variable">${CONFIG_DIR}</span>/forward_<span class="hljs-variable">${name}</span>.sh &lt;&lt; <span class="hljs-string">EOF
# !/bin/bash
# ${name}端口转发配置

echo "配置${name}端口转发..."
echo "外部端口: \${EXT_PORT} -&gt; 内部: \${INT_HOST}:\${INT_PORT}"

# 启用IP转发
echo '1' &gt; /proc/sys/net/ipv4/ip_forward

# 清理旧规则
iptables -t nat -D PREROUTING -p ${protocol} --dport ${ext_port} -j DNAT --to-destination ${int_host}:${int_port} 2&gt;/dev/null
iptables -t nat -D POSTROUTING -p ${protocol} -d ${int_host} --dport ${int_port} -j MASQUERADE 2&gt;/dev/null

# 添加新规则
iptables -t nat -A PREROUTING -p ${protocol} --dport ${ext_port} \\
    -j DNAT --to-destination ${int_host}:${int_port}
iptables -t nat -A POSTROUTING -p ${protocol} -d ${int_host} --dport ${int_port} \\
    -j MASQUERADE

# 允许转发
iptables -A FORWARD -p ${protocol} --dport ${int_port} -d ${int_host} -j ACCEPT
iptables -A FORWARD -p ${protocol} --sport ${int_port} -s ${int_host} -j ACCEPT

echo "${name}转发规则配置完成"
EOF</span>
    
    <span class="hljs-built_in">chmod</span> +x <span class="hljs-variable">${CONFIG_DIR}</span>/forward_<span class="hljs-variable">${name}</span>.sh
}

<span class="hljs-comment"># 创建多个转发规则</span>
create_forward_rule <span class="hljs-string">"web"</span> <span class="hljs-string">"80"</span> <span class="hljs-string">"192.168.1.100"</span> <span class="hljs-string">"8080"</span>
create_forward_rule <span class="hljs-string">"https"</span> <span class="hljs-string">"443"</span> <span class="hljs-string">"192.168.1.100"</span> <span class="hljs-string">"8443"</span>
create_forward_rule <span class="hljs-string">"ssh"</span> <span class="hljs-string">"2222"</span> <span class="hljs-string">"192.168.1.100"</span> <span class="hljs-string">"22"</span>
create_forward_rule <span class="hljs-string">"database"</span> <span class="hljs-string">"3306"</span> <span class="hljs-string">"192.168.1.101"</span> <span class="hljs-string">"3306"</span>

<span class="hljs-comment"># 创建管理脚本</span>
<span class="hljs-built_in">cat</span> &gt; <span class="hljs-variable">${CONFIG_DIR}</span>/manage_forwarding.sh &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment">#!/bin/bash</span>
<span class="hljs-comment"># iptables转发管理脚本</span>

ACTION=<span class="hljs-variable">${1:-status}</span>

<span class="hljs-keyword">case</span> <span class="hljs-variable">$ACTION</span> <span class="hljs-keyword">in</span>
    start)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"启动所有端口转发..."</span>
        <span class="hljs-keyword">for</span> script <span class="hljs-keyword">in</span> <span class="hljs-variable">${CONFIG_DIR}</span>/forward_*.sh; <span class="hljs-keyword">do</span>
            <span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"<span class="hljs-variable">$script</span>"</span> ]; <span class="hljs-keyword">then</span>
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"执行: <span class="hljs-variable">$script</span>"</span>
                <span class="hljs-variable">$script</span>
            <span class="hljs-keyword">fi</span>
        <span class="hljs-keyword">done</span>
        ;;
    stop)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"停止所有端口转发..."</span>
        <span class="hljs-comment"># 清理NAT规则</span>
        iptables -t nat -F PREROUTING
        iptables -t nat -F POSTROUTING
        iptables -F FORWARD
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"所有转发规则已清理"</span>
        ;;
    status)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"当前NAT表规则:"</span>
        iptables -t nat -L -n
        <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"当前FORWARD链规则:"</span>
        iptables -L FORWARD -n
        ;;
    save)
        iptables-save &gt; /etc/iptables/rules.v4
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"规则已保存"</span>
        ;;
    *)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"使用方法: <span class="hljs-variable">$0</span> {start|stop|status|save}"</span>
        <span class="hljs-built_in">exit</span> 1
        ;;
<span class="hljs-keyword">esac</span>
EOF

<span class="hljs-built_in">chmod</span> +x <span class="hljs-variable">${CONFIG_DIR}</span>/manage_forwarding.sh

<span class="hljs-built_in">echo</span> <span class="hljs-string">"高级iptables配置已生成在: <span class="hljs-variable">${CONFIG_DIR}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"管理脚本: <span class="hljs-variable">${CONFIG_DIR}</span>/manage_forwarding.sh"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"使用方法:"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"  sudo <span class="hljs-variable">${CONFIG_DIR}</span>/manage_forwarding.sh start   # 启动所有转发"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"  sudo <span class="hljs-variable">${CONFIG_DIR}</span>/manage_forwarding.sh stop    # 停止所有转发"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"  sudo <span class="hljs-variable">${CONFIG_DIR}</span>/manage_forwarding.sh status  # 查看状态"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"  sudo <span class="hljs-variable">${CONFIG_DIR}</span>/manage_forwarding.sh save    # 保存规则"</span>
</code></pre>
<h3 data-id="heading-21">6. 三种方案对比测试</h3>
<h4 data-id="heading-22">6.1 性能测试脚本</h4>
<p><strong>创建配置文件：performance_test.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># performance_test.sh - 三种方案性能对比测试</span>

TEST_DURATION=30
TARGET_HOST=<span class="hljs-string">"192.168.1.100"</span>
TARGET_PORT=<span class="hljs-string">"8080"</span>
LOCAL_PORT=<span class="hljs-string">"9000"</span>
RESULTS_FILE=<span class="hljs-string">"./performance_results.txt"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始性能测试..."</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"测试时长: <span class="hljs-variable">${TEST_DURATION}</span>秒"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"目标服务: <span class="hljs-variable">${TARGET_HOST}</span>:<span class="hljs-variable">${TARGET_PORT}</span>"</span>

<span class="hljs-comment"># 安装测试工具</span>
<span class="hljs-keyword">if</span> ! <span class="hljs-built_in">command</span> -v ab &gt; /dev/null; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"安装Apache Bench..."</span>
    apt update
    apt install -y apache2-utils
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 清理旧结果</span>
&gt; <span class="hljs-variable">${RESULTS_FILE}</span>

<span class="hljs-function"><span class="hljs-title">test_ssh_forwarding</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"测试SSH端口转发性能..."</span>
    
    <span class="hljs-comment"># 启动SSH转发后台进程</span>
    ssh -N -L <span class="hljs-variable">${LOCAL_PORT}</span>:<span class="hljs-variable">${TARGET_HOST}</span>:<span class="hljs-variable">${TARGET_PORT}</span> user@<span class="hljs-variable">${TARGET_HOST}</span> &amp;
    SSH_PID=$!
    
    <span class="hljs-comment"># 等待连接建立</span>
    <span class="hljs-built_in">sleep</span> 5
    
    <span class="hljs-comment"># 运行性能测试</span>
    ab -n 1000 -c 10 http://127.0.0.1:<span class="hljs-variable">${LOCAL_PORT}</span>/ &gt; /tmp/ssh_test.txt 2&gt;&amp;1
    
    <span class="hljs-comment"># 提取结果</span>
    REQUESTS_PER_SECOND=$(grep <span class="hljs-string">"Requests per second"</span> /tmp/ssh_test.txt | awk <span class="hljs-string">'{print $4}'</span>)
    TIME_PER_REQUEST=$(grep <span class="hljs-string">"Time per request"</span> /tmp/ssh_test.txt | <span class="hljs-built_in">head</span> -1 | awk <span class="hljs-string">'{print $4}'</span>)
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"SSH结果: <span class="hljs-variable">${REQUESTS_PER_SECOND}</span> req/sec, <span class="hljs-variable">${TIME_PER_REQUEST}</span> ms/req"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"SSH: <span class="hljs-variable">${REQUESTS_PER_SECOND}</span> req/sec, <span class="hljs-variable">${TIME_PER_REQUEST}</span> ms/req"</span> &gt;&gt; <span class="hljs-variable">${RESULTS_FILE}</span>
    
    <span class="hljs-comment"># 清理</span>
    <span class="hljs-built_in">kill</span> <span class="hljs-variable">${SSH_PID}</span>
}

<span class="hljs-function"><span class="hljs-title">test_socat_forwarding</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"测试socat端口转发性能..."</span>
    
    <span class="hljs-comment"># 启动socat转发</span>
    socat TCP-LISTEN:<span class="hljs-variable">${LOCAL_PORT}</span>,fork,reuseaddr TCP:<span class="hljs-variable">${TARGET_HOST}</span>:<span class="hljs-variable">${TARGET_PORT}</span> &amp;
    SOCAT_PID=$!
    
    <span class="hljs-built_in">sleep</span> 2
    
    <span class="hljs-comment"># 运行性能测试</span>
    ab -n 1000 -c 10 http://127.0.0.1:<span class="hljs-variable">${LOCAL_PORT}</span>/ &gt; /tmp/socat_test.txt 2&gt;&amp;1
    
    <span class="hljs-comment"># 提取结果</span>
    REQUESTS_PER_SECOND=$(grep <span class="hljs-string">"Requests per second"</span> /tmp/socat_test.txt | awk <span class="hljs-string">'{print $4}'</span>)
    TIME_PER_REQUEST=$(grep <span class="hljs-string">"Time per request"</span> /tmp/socat_test.txt | <span class="hljs-built_in">head</span> -1 | awk <span class="hljs-string">'{print $4}'</span>)
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"socat结果: <span class="hljs-variable">${REQUESTS_PER_SECOND}</span> req/sec, <span class="hljs-variable">${TIME_PER_REQUEST}</span> ms/req"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"socat: <span class="hljs-variable">${REQUESTS_PER_SECOND}</span> req/sec, <span class="hljs-variable">${TIME_PER_REQUEST}</span> ms/req"</span> &gt;&gt; <span class="hljs-variable">${RESULTS_FILE}</span>
    
    <span class="hljs-comment"># 清理</span>
    <span class="hljs-built_in">kill</span> <span class="hljs-variable">${SOCAT_PID}</span>
}

<span class="hljs-function"><span class="hljs-title">test_iptables_forwarding</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"测试iptables端口转发性能..."</span>
    
    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$EUID</span>"</span> -ne 0 ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"需要root权限测试iptables"</span>
        <span class="hljs-built_in">return</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 配置iptables转发</span>
    ./iptables_basic.sh
    
    <span class="hljs-comment"># 运行性能测试</span>
    ab -n 1000 -c 10 http://127.0.0.1:<span class="hljs-variable">${LOCAL_PORT}</span>/ &gt; /tmp/iptables_test.txt 2&gt;&amp;1
    
    <span class="hljs-comment"># 提取结果</span>
    REQUESTS_PER_SECOND=$(grep <span class="hljs-string">"Requests per second"</span> /tmp/iptables_test.txt | awk <span class="hljs-string">'{print $4}'</span>)
    TIME_PER_REQUEST=$(grep <span class="hljs-string">"Time per request"</span> /tmp/iptables_test.txt | <span class="hljs-built_in">head</span> -1 | awk <span class="hljs-string">'{print $4}'</span>)
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"iptables结果: <span class="hljs-variable">${REQUESTS_PER_SECOND}</span> req/sec, <span class="hljs-variable">${TIME_PER_REQUEST}</span> ms/req"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"iptables: <span class="hljs-variable">${REQUESTS_PER_SECOND}</span> req/sec, <span class="hljs-variable">${TIME_PER_REQUEST}</span> ms/req"</span> &gt;&gt; <span class="hljs-variable">${RESULTS_FILE}</span>
    
    <span class="hljs-comment"># 清理规则</span>
    iptables -t nat -F
}

<span class="hljs-comment"># 执行测试</span>
test_ssh_forwarding
test_socat_forwarding
test_iptables_forwarding

<span class="hljs-built_in">echo</span> <span class="hljs-string">"性能测试完成"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"结果保存在: <span class="hljs-variable">${RESULTS_FILE}</span>"</span>
<span class="hljs-built_in">cat</span> <span class="hljs-variable">${RESULTS_FILE}</span>
</code></pre>
<h4 data-id="heading-23">6.2 功能对比表格</h4>
<p><strong>创建配置文件：feature_comparison.md</strong></p>
<h2 data-id="heading-24">三种端口转发方案功能对比</h2>







































































<table><thead><tr><th>特性</th><th>SSH</th><th>socat</th><th>iptables</th></tr></thead><tbody><tr><td><strong>加密支持</strong></td><td>✅ 原生支持</td><td>✅ 需要SSL配置</td><td>❌ 无加密</td></tr><tr><td><strong>认证机制</strong></td><td>✅ 多种认证方式</td><td>❌ 无认证</td><td>❌ 无认证</td></tr><tr><td><strong>配置复杂度</strong></td><td>中等</td><td>简单</td><td>复杂</td></tr><tr><td><strong>性能开销</strong></td><td>高（加密开销）</td><td>中等</td><td>低（内核级）</td></tr><tr><td><strong>持久化</strong></td><td>需要脚本或服务</td><td>需要脚本或服务</td><td>需要额外配置</td></tr><tr><td><strong>跨平台</strong></td><td>✅ 全平台支持</td><td>✅ 全平台支持</td><td>❌ 仅Linux</td></tr><tr><td><strong>UDP支持</strong></td><td>✅ 有限支持</td><td>✅ 完整支持</td><td>✅ 完整支持</td></tr><tr><td><strong>调试能力</strong></td><td>中等</td><td>优秀</td><td>困难</td></tr><tr><td><strong>系统依赖</strong></td><td>SSH客户端/服务</td><td>socat二进制</td><td>iptables工具</td></tr><tr><td><strong>适用场景</strong></td><td>安全远程访问、临时转发</td><td>协议转换、调试工具</td><td>生产环境、网关转发</td></tr></tbody></table>
<h3 data-id="heading-25">推荐使用场景</h3>
<h4 data-id="heading-26">SSH端口转发</h4>
<ul>
<li>需要加密的安全连接</li>
<li>临时性的端口转发需求</li>
<li>跨越防火墙的访问</li>
<li>开发调试环境</li>
</ul>
<h4 data-id="heading-27">socat端口转发</h4>
<ul>
<li>协议转换和调试</li>
<li>复杂的流处理需求</li>
<li>快速测试和原型验证</li>
<li>UDP端口转发</li>
</ul>
<h4 data-id="heading-28">iptables端口转发</h4>
<ul>
<li>生产环境部署</li>
<li>高性能要求的场景</li>
<li>系统级端口转发</li>
<li>网关和路由器配置</li>
</ul>
<h3 data-id="heading-29">7. 实际应用案例</h3>
<h4 data-id="heading-30">7.1 生产环境部署脚本</h4>
<p><strong>创建配置文件：production_deploy.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># production_deploy.sh - 生产环境端口转发部署</span>

<span class="hljs-built_in">set</span> -e  <span class="hljs-comment"># 遇到错误立即退出</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"生产环境端口转发部署脚本"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"================================"</span>

DEPLOY_MODE=<span class="hljs-variable">${1:-"iptables"}</span>  <span class="hljs-comment"># 默认使用iptables</span>
CONFIG_FILE=<span class="hljs-string">"./deploy_config.conf"</span>

<span class="hljs-comment"># 加载配置</span>
<span class="hljs-keyword">if</span> [ -f <span class="hljs-string">"<span class="hljs-variable">${CONFIG_FILE}</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">source</span> <span class="hljs-string">"<span class="hljs-variable">${CONFIG_FILE}</span>"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-comment"># 默认配置</span>
    TARGET_SERVICES=(
        <span class="hljs-string">"web:80:192.168.1.100:8080"</span>
        <span class="hljs-string">"api:8080:192.168.1.101:3000"</span>
        <span class="hljs-string">"db:3306:192.168.1.102:3306"</span>
    )
    MONITOR_PORT=<span class="hljs-string">"9090"</span>
    LOG_DIR=<span class="hljs-string">"/var/log/port_forwarding"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-function"><span class="hljs-title">setup_monitoring</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"设置监控和日志..."</span>
    <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">${LOG_DIR}</span>
    
    <span class="hljs-comment"># 安装监控工具</span>
    apt install -y htop iotop nethogs
    
    <span class="hljs-comment"># 创建监控脚本</span>
    <span class="hljs-built_in">cat</span> &gt; /usr/local/bin/monitor_forwarding.sh &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment">#!/bin/bash</span>
<span class="hljs-comment"># 端口转发监控脚本</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"端口转发状态监控"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=================="</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"当前时间: <span class="hljs-subst">$(date)</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 网络连接统计:"</span>
netstat -tulpn | grep -E <span class="hljs-string">":(9000|8080|3306)"</span> | <span class="hljs-built_in">sort</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 系统资源使用:"</span>
ps aux --<span class="hljs-built_in">sort</span>=-%cpu | <span class="hljs-built_in">head</span> -10
<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 网络流量:"</span>
nethogs -t -d 1 -c 2 | <span class="hljs-built_in">head</span> -20
EOF
    
    <span class="hljs-built_in">chmod</span> +x /usr/local/bin/monitor_forwarding.sh
}

<span class="hljs-function"><span class="hljs-title">deploy_iptables</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"部署iptables端口转发..."</span>
    
    <span class="hljs-comment"># 调用高级配置</span>
    ./iptables_advanced/manage_forwarding.sh start
    
    <span class="hljs-comment"># 设置定时监控</span>
    (crontab -l 2&gt;/dev/null; <span class="hljs-built_in">echo</span> <span class="hljs-string">"*/5 * * * * /usr/local/bin/monitor_forwarding.sh &gt;&gt; <span class="hljs-variable">${LOG_DIR}</span>/monitor.log"</span>) | crontab -
}

<span class="hljs-function"><span class="hljs-title">deploy_socat</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"部署socat端口转发..."</span>
    
    <span class="hljs-comment"># 创建systemd服务</span>
    <span class="hljs-keyword">for</span> service <span class="hljs-keyword">in</span> <span class="hljs-string">"<span class="hljs-variable">${TARGET_SERVICES[@]}</span>"</span>; <span class="hljs-keyword">do</span>
        IFS=<span class="hljs-string">':'</span> <span class="hljs-built_in">read</span> -r name ext_port int_host int_port &lt;&lt;&lt; <span class="hljs-string">"<span class="hljs-variable">$service</span>"</span>
        
        <span class="hljs-built_in">cat</span> &gt; /etc/systemd/system/socat-<span class="hljs-variable">${name}</span>.service &lt;&lt; <span class="hljs-string">EOF
[Unit]
Description=socat port forwarding for ${name}
After=network.target

[Service]
Type=simple
ExecStart=/usr/bin/socat TCP-LISTEN:${ext_port},fork,reuseaddr TCP:${int_host}:${int_port}
Restart=always
RestartSec=3
User=root
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF</span>
        
        systemctl <span class="hljs-built_in">enable</span> socat-<span class="hljs-variable">${name}</span>.service
        systemctl start socat-<span class="hljs-variable">${name}</span>.service
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"服务 socat-<span class="hljs-variable">${name}</span> 已启动"</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-keyword">case</span> <span class="hljs-variable">$DEPLOY_MODE</span> <span class="hljs-keyword">in</span>
    <span class="hljs-string">"iptables"</span>)
        deploy_iptables
        ;;
    <span class="hljs-string">"socat"</span>)
        deploy_socat
        ;;
    <span class="hljs-string">"ssh"</span>)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"SSH转发通常用于临时需求，不建议生产环境持久化部署"</span>
        ;;
    *)
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"未知的部署模式: <span class="hljs-variable">$DEPLOY_MODE</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"可用模式: iptables, socat, ssh"</span>
        <span class="hljs-built_in">exit</span> 1
        ;;
<span class="hljs-keyword">esac</span>

setup_monitoring

<span class="hljs-built_in">echo</span> <span class="hljs-string">"部署完成!"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"监控日志: <span class="hljs-variable">${LOG_DIR}</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"实时监控: /usr/local/bin/monitor_forwarding.sh"</span>
</code></pre>
<h3 data-id="heading-31">8. 故障排除与维护</h3>
<h4 data-id="heading-32">8.1 常见问题诊断脚本</h4>
<p><strong>创建配置文件：troubleshooting.sh</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># troubleshooting.sh - 端口转发故障诊断</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"端口转发故障诊断工具"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"======================"</span>

<span class="hljs-function"><span class="hljs-title">check_connectivity</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 检查基础连通性..."</span>
    
    <span class="hljs-keyword">if</span> ping -c 3 <span class="hljs-variable">$1</span> &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 可以ping通目标主机: <span class="hljs-variable">$1</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 无法ping通目标主机: <span class="hljs-variable">$1</span>"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-keyword">if</span> nc -z <span class="hljs-variable">$1</span> <span class="hljs-variable">$2</span> &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"✅ 目标服务端口可访问: <span class="hljs-variable">$1</span>:<span class="hljs-variable">$2</span>"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"❌ 目标服务端口不可访问: <span class="hljs-variable">$1</span>:<span class="hljs-variable">$2</span>"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-function"><span class="hljs-title">check_forwarding_rules</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"2. 检查转发规则..."</span>
    
    <span class="hljs-keyword">case</span> <span class="hljs-variable">$1</span> <span class="hljs-keyword">in</span>
        <span class="hljs-string">"iptables"</span>)
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"检查iptables规则:"</span>
            iptables -t nat -L -n | grep -E <span class="hljs-string">"DNAT|REDIRECT"</span>
            iptables -L FORWARD -n | <span class="hljs-built_in">head</span> -10
            ;;
        <span class="hljs-string">"socat"</span>)
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"检查socat进程:"</span>
            ps aux | grep socat | grep -v grep
            netstat -tulpn | grep socat
            ;;
        <span class="hljs-string">"ssh"</span>)
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"检查SSH隧道:"</span>
            ps aux | grep <span class="hljs-string">"ssh.*-L\|ssh.*-R"</span> | grep -v grep
            netstat -tulpn | grep ssh
            ;;
    <span class="hljs-keyword">esac</span>
}

<span class="hljs-function"><span class="hljs-title">check_firewall</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"3. 检查防火墙设置..."</span>
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v ufw &gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"UFW状态:"</span>
        ufw status verbose
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v firewall-cmd &gt; /dev/null; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"firewalld状态:"</span>
        firewall-cmd --list-all
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"iptables默认策略:"</span>
    iptables -L | grep <span class="hljs-string">"policy"</span>
}

<span class="hljs-function"><span class="hljs-title">check_system_resources</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"4. 检查系统资源..."</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"内存使用:"</span>
    free -h
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"CPU负载:"</span>
    <span class="hljs-built_in">uptime</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"网络连接数:"</span>
    netstat -an | grep -c ESTABLISHED
}

<span class="hljs-function"><span class="hljs-title">perform_deep_diagnosis</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"5. 深度诊断..."</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"内核参数:"</span>
    sysctl net.ipv4.ip_forward
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"路由表:"</span>
    ip route show
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"网络接口:"</span>
    ip addr show
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"连接跟踪:"</span>
    <span class="hljs-keyword">if</span> [ -f /proc/sys/net/netfilter/nf_conntrack_count ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"连接跟踪数: <span class="hljs-subst">$(cat /proc/sys/net/netfilter/nf_conntrack_count)</span>"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 执行诊断</span>
TARGET_HOST=<span class="hljs-variable">${1:-"192.168.1.100"}</span>
TARGET_PORT=<span class="hljs-variable">${2:-"8080"}</span>
FORWARD_TYPE=<span class="hljs-variable">${3:-"iptables"}</span>

check_connectivity <span class="hljs-variable">$TARGET_HOST</span> <span class="hljs-variable">$TARGET_PORT</span>
check_forwarding_rules <span class="hljs-variable">$FORWARD_TYPE</span>
check_firewall
check_system_resources
perform_deep_diagnosis

<span class="hljs-built_in">echo</span> <span class="hljs-string">""</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"诊断完成!"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"根据上述检查结果排查问题"</span>
</code></pre>
<h3 data-id="heading-33">9. 总结</h3>
<p>本文详细介绍了Linux下三种主要的端口转发方案：SSH、socat和iptables。每种方案都有其独特的优势和适用场景：</p>
<ul>
<li><strong>SSH</strong>：适合需要加密的安全场景和临时转发需求</li>
<li><strong>socat</strong>：功能强大，适合协议转换和复杂的数据流处理</li>
<li><strong>iptables</strong>：性能最佳，适合生产环境的系统级转发</li>
</ul>
<p>通过本文提供的完整配置脚本和详细说明，即使是Linux新手也可以成功部署和使用这些端口转发方案。在实际应用中，建议根据具体需求选择合适的方案，并结合监控和故障排除工具确保服务的稳定性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 Linux 网络命名空间：自己动手实现"虚拟网络"]]></title>    <link>https://juejin.cn/post/7572697146286768178</link>    <guid>https://juejin.cn/post/7572697146286768178</guid>    <pubDate>2025-11-16T01:06:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572697146286768178" data-draft-id="7572497847770398747" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 Linux 网络命名空间：自己动手实现&quot;虚拟网络&quot;"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2025-11-16T01:06:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LCG元"/> <meta itemprop="url" content="https://juejin.cn/user/3097802498120889"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 Linux 网络命名空间：自己动手实现"虚拟网络"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097802498120889/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LCG元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T01:06:55.000Z" title="Sun Nov 16 2025 01:06:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 概述</h2>
<p>Linux 网络命名空间是 Linux 内核提供的一种网络隔离机制，它允许创建完全独立的网络栈实例。每个网络命名空间都有自己的网络设备、IP 地址、路由表、防火墙规则等网络资源。这项技术是容器化技术（如 Docker）和虚拟化的基础。</p>
<h2 data-id="heading-1">2. 环境准备</h2>
<h3 data-id="heading-2">2.1 系统要求</h3>
<ul>
<li>Linux 内核 2.6.24 或更高版本</li>
<li>iproute2 工具包</li>
<li>root 权限或 sudo 权限</li>
</ul>
<h3 data-id="heading-3">2.2 检查系统支持</h3>
<p>创建检查脚本 <code>check_system.sh</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 文件名: check_system.sh</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 系统检查开始 ==="</span>

<span class="hljs-comment"># 检查内核版本</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"1. 检查内核版本:"</span>
<span class="hljs-built_in">uname</span> -r

<span class="hljs-comment"># 检查网络命名空间支持</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n2. 检查网络命名空间支持:"</span>
<span class="hljs-keyword">if</span> [ -e /proc/self/ns/net ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✓ 系统支持网络命名空间"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✗ 系统不支持网络命名空间"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 检查 iproute2 工具</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n3. 检查 iproute2 工具:"</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v ip &gt; /dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✓ iproute2 已安装"</span>
    ip -Version
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✗ iproute2 未安装，请安装: sudo apt-get install iproute2"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 检查用户权限</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n4. 检查用户权限:"</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$EUID</span>"</span> -eq 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✓ 当前为 root 用户"</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠ 当前为非 root 用户，部分操作可能需要 sudo"</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n=== 系统检查完成 ==="</span>
</code></pre>
<p>运行检查脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x check_system.sh
./check_system.sh
</code></pre>
<h2 data-id="heading-4">3. 基础网络命名空间操作</h2>
<h3 data-id="heading-5">3.1 创建和删除网络命名空间</h3>
<p>创建基础操作脚本 <code>basic_namespace_operations.sh</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 文件名: basic_namespace_operations.sh</span>

<span class="hljs-built_in">set</span> -e  <span class="hljs-comment"># 遇到错误立即退出</span>

<span class="hljs-comment"># 颜色定义</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
NC=<span class="hljs-string">'\033[0m'</span> <span class="hljs-comment"># No Color</span>

<span class="hljs-comment"># 打印带颜色的消息</span>
<span class="hljs-function"><span class="hljs-title">print_info</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>[INFO]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">print_warning</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>[WARNING]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">print_error</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>[ERROR]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>
}

<span class="hljs-comment"># 创建网络命名空间</span>
<span class="hljs-function"><span class="hljs-title">create_namespace</span></span>() {
    <span class="hljs-built_in">local</span> ns_name=<span class="hljs-variable">$1</span>
    print_info <span class="hljs-string">"创建网络命名空间: <span class="hljs-variable">$ns_name</span>"</span>
    ip netns add <span class="hljs-variable">$ns_name</span>
    
    <span class="hljs-comment"># 验证创建</span>
    <span class="hljs-keyword">if</span> ip netns list | grep -q <span class="hljs-string">"<span class="hljs-variable">$ns_name</span>"</span>; <span class="hljs-keyword">then</span>
        print_info <span class="hljs-string">"✓ 命名空间 <span class="hljs-variable">$ns_name</span> 创建成功"</span>
    <span class="hljs-keyword">else</span>
        print_error <span class="hljs-string">"✗ 命名空间 <span class="hljs-variable">$ns_name</span> 创建失败"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 在命名空间中执行命令</span>
<span class="hljs-function"><span class="hljs-title">exec_in_namespace</span></span>() {
    <span class="hljs-built_in">local</span> ns_name=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">local</span> <span class="hljs-built_in">command</span>=<span class="hljs-variable">$2</span>
    print_info <span class="hljs-string">"在命名空间 <span class="hljs-variable">$ns_name</span> 中执行: <span class="hljs-variable">$command</span>"</span>
    ip netns <span class="hljs-built_in">exec</span> <span class="hljs-variable">$ns_name</span> <span class="hljs-variable">$command</span>
}

<span class="hljs-comment"># 显示命名空间网络信息</span>
<span class="hljs-function"><span class="hljs-title">show_namespace_network</span></span>() {
    <span class="hljs-built_in">local</span> ns_name=<span class="hljs-variable">$1</span>
    print_info <span class="hljs-string">"=== 命名空间 <span class="hljs-variable">$ns_name</span> 的网络信息 ==="</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"网络接口:"</span>
    exec_in_namespace <span class="hljs-variable">$ns_name</span> <span class="hljs-string">"ip link show"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\nIP 地址:"</span>
    exec_in_namespace <span class="hljs-variable">$ns_name</span> <span class="hljs-string">"ip addr show"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n路由表:"</span>
    exec_in_namespace <span class="hljs-variable">$ns_name</span> <span class="hljs-string">"ip route show"</span>
}

<span class="hljs-comment"># 删除网络命名空间</span>
<span class="hljs-function"><span class="hljs-title">delete_namespace</span></span>() {
    <span class="hljs-built_in">local</span> ns_name=<span class="hljs-variable">$1</span>
    print_info <span class="hljs-string">"删除网络命名空间: <span class="hljs-variable">$ns_name</span>"</span>
    ip netns delete <span class="hljs-variable">$ns_name</span>
    
    <span class="hljs-comment"># 验证删除</span>
    <span class="hljs-keyword">if</span> ! ip netns list | grep -q <span class="hljs-string">"<span class="hljs-variable">$ns_name</span>"</span>; <span class="hljs-keyword">then</span>
        print_info <span class="hljs-string">"✓ 命名空间 <span class="hljs-variable">$ns_name</span> 删除成功"</span>
    <span class="hljs-keyword">else</span>
        print_error <span class="hljs-string">"✗ 命名空间 <span class="hljs-variable">$ns_name</span> 删除失败"</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    print_info <span class="hljs-string">"开始基础网络命名空间操作演示"</span>
    
    <span class="hljs-comment"># 创建两个测试命名空间</span>
    create_namespace <span class="hljs-string">"ns1"</span>
    create_namespace <span class="hljs-string">"ns2"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n"</span>
    print_info <span class="hljs-string">"当前所有网络命名空间:"</span>
    ip netns list
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n"</span>
    <span class="hljs-comment"># 显示默认命名空间信息</span>
    print_info <span class="hljs-string">"=== 默认命名空间网络信息 ==="</span>
    ip <span class="hljs-built_in">link</span> show
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n"</span>
    ip addr show
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n"</span>
    ip route show
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n"</span>
    <span class="hljs-comment"># 显示新创建的命名空间信息</span>
    show_namespace_network <span class="hljs-string">"ns1"</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n"</span>
    show_namespace_network <span class="hljs-string">"ns2"</span>
    
    <span class="hljs-comment"># 清理</span>
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n"</span>
    delete_namespace <span class="hljs-string">"ns1"</span>
    delete_namespace <span class="hljs-string">"ns2"</span>
    
    print_info <span class="hljs-string">"基础网络命名空间操作演示完成"</span>
}

<span class="hljs-comment"># 执行主函数</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<p>运行基础操作脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x basic_namespace_operations.sh
sudo ./basic_namespace_operations.sh
</code></pre>
<h2 data-id="heading-6">4. 创建虚拟网络设备</h2>
<h3 data-id="heading-7">4.1 创建 veth pair</h3>
<p>veth（虚拟以太网设备）总是成对出现，用于连接不同的网络命名空间。</p>
<p>创建 veth 配置脚本 <code>create_veth_network.sh</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 文件名: create_veth_network.sh</span>

<span class="hljs-built_in">set</span> -e

<span class="hljs-comment"># 颜色定义</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
BLUE=<span class="hljs-string">'\033[0;34m'</span>
NC=<span class="hljs-string">'\033[0m'</span>

<span class="hljs-function"><span class="hljs-title">print_info</span></span>() { <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>[INFO]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>; }
<span class="hljs-function"><span class="hljs-title">print_warning</span></span>() { <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>[WARNING]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>; }
<span class="hljs-function"><span class="hljs-title">print_step</span></span>() { <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${BLUE}</span>[STEP]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>; }

<span class="hljs-comment"># 清理函数</span>
<span class="hljs-function"><span class="hljs-title">cleanup</span></span>() {
    print_info <span class="hljs-string">"执行清理操作..."</span>
    
    <span class="hljs-comment"># 删除命名空间（如果存在）</span>
    <span class="hljs-keyword">for</span> ns <span class="hljs-keyword">in</span> ns1 ns2; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> ip netns list | grep -q <span class="hljs-string">"<span class="hljs-variable">$ns</span>"</span>; <span class="hljs-keyword">then</span>
            ip netns delete <span class="hljs-variable">$ns</span> 2&gt;/dev/null || <span class="hljs-literal">true</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 删除 veth 设备（如果存在）</span>
    ip <span class="hljs-built_in">link</span> delete veth1 2&gt;/dev/null || <span class="hljs-literal">true</span>
    ip <span class="hljs-built_in">link</span> delete veth1-br 2&gt;/dev/null || <span class="hljs-literal">true</span>
    ip <span class="hljs-built_in">link</span> delete veth2 2&gt;/dev/null || <span class="hljs-literal">true</span>
    ip <span class="hljs-built_in">link</span> delete veth2-br 2&gt;/dev/null || <span class="hljs-literal">true</span>
    ip <span class="hljs-built_in">link</span> delete br0 2&gt;/dev/null || <span class="hljs-literal">true</span>
}

<span class="hljs-comment"># 捕获退出信号</span>
<span class="hljs-built_in">trap</span> cleanup EXIT

<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    print_info <span class="hljs-string">"开始创建虚拟网络..."</span>
    
    <span class="hljs-comment"># 步骤1: 创建网络命名空间</span>
    print_step <span class="hljs-string">"1. 创建网络命名空间"</span>
    ip netns add ns1
    ip netns add ns2
    print_info <span class="hljs-string">"✓ 创建命名空间: ns1, ns2"</span>
    
    <span class="hljs-comment"># 步骤2: 创建第一对 veth</span>
    print_step <span class="hljs-string">"2. 创建 veth pair: veth1 &lt;-&gt; veth1-br"</span>
    ip <span class="hljs-built_in">link</span> add veth1 <span class="hljs-built_in">type</span> veth peer name veth1-br
    print_info <span class="hljs-string">"✓ 创建 veth pair: veth1 &lt;-&gt; veth1-br"</span>
    
    <span class="hljs-comment"># 步骤3: 创建第二对 veth</span>
    print_step <span class="hljs-string">"3. 创建 veth pair: veth2 &lt;-&gt; veth2-br"</span>
    ip <span class="hljs-built_in">link</span> add veth2 <span class="hljs-built_in">type</span> veth peer name veth2-br
    print_info <span class="hljs-string">"✓ 创建 veth pair: veth2 &lt;-&gt; veth2-br"</span>
    
    <span class="hljs-comment"># 步骤4: 将 veth 设备移动到对应的命名空间</span>
    print_step <span class="hljs-string">"4. 移动 veth 设备到命名空间"</span>
    ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth1 netns ns1
    ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth2 netns ns2
    print_info <span class="hljs-string">"✓ veth1 移动到 ns1"</span>
    print_info <span class="hljs-string">"✓ veth2 移动到 ns2"</span>
    
    <span class="hljs-comment"># 步骤5: 在命名空间中配置网络接口</span>
    print_step <span class="hljs-string">"5. 配置命名空间中的网络接口"</span>
    
    <span class="hljs-comment"># 配置 ns1 中的 veth1</span>
    ip netns <span class="hljs-built_in">exec</span> ns1 ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> lo up
    ip netns <span class="hljs-built_in">exec</span> ns1 ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth1 up
    ip netns <span class="hljs-built_in">exec</span> ns1 ip addr add 10.0.1.10/24 dev veth1
    print_info <span class="hljs-string">"✓ ns1: veth1 配置 IP 10.0.1.10/24"</span>
    
    <span class="hljs-comment"># 配置 ns2 中的 veth2</span>
    ip netns <span class="hljs-built_in">exec</span> ns2 ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> lo up
    ip netns <span class="hljs-built_in">exec</span> ns2 ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth2 up
    ip netns <span class="hljs-built_in">exec</span> ns2 ip addr add 10.0.1.20/24 dev veth2
    print_info <span class="hljs-string">"✓ ns2: veth2 配置 IP 10.0.1.20/24"</span>
    
    <span class="hljs-comment"># 步骤6: 测试连通性</span>
    print_step <span class="hljs-string">"6. 测试直接连通性"</span>
    
    <span class="hljs-comment"># 由于没有桥接，此时应该无法连通</span>
    print_info <span class="hljs-string">"测试 ns1 -&gt; ns2 连通性:"</span>
    <span class="hljs-keyword">if</span> ip netns <span class="hljs-built_in">exec</span> ns1 ping -c 2 -W 1 10.0.1.20 &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
        print_info <span class="hljs-string">"✓ ns1 可以 ping 通 ns2"</span>
    <span class="hljs-keyword">else</span>
        print_warning <span class="hljs-string">"✗ ns1 无法 ping 通 ns2 (正常，因为尚未桥接)"</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 显示网络配置</span>
    print_step <span class="hljs-string">"7. 显示当前网络配置"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n默认命名空间接口:"</span>
    ip <span class="hljs-built_in">link</span> show | grep -E <span class="hljs-string">"(veth|br)"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\nns1 网络配置:"</span>
    ip netns <span class="hljs-built_in">exec</span> ns1 ip addr show
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\nns2 网络配置:"</span>
    ip netns <span class="hljs-built_in">exec</span> ns2 ip addr show
    
    print_info <span class="hljs-string">"虚拟网络创建完成！"</span>
    print_warning <span class="hljs-string">"注意: 由于没有桥接设备，命名空间之间目前无法通信"</span>
}

main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<p>运行 veth 创建脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x create_veth_network.sh
sudo ./create_veth_network.sh
</code></pre>
<h2 data-id="heading-8">5. 构建完整虚拟网络</h2>
<h3 data-id="heading-9">5.1 使用 Linux 网桥连接多个命名空间</h3>
<p>创建完整的虚拟网络脚本 <code>create_complete_network.sh</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 文件名: create_complete_network.sh</span>

<span class="hljs-built_in">set</span> -e

<span class="hljs-comment"># 颜色定义</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
BLUE=<span class="hljs-string">'\033[0;34m'</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
NC=<span class="hljs-string">'\033[0m'</span>

<span class="hljs-function"><span class="hljs-title">print_info</span></span>() { <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>[INFO]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>; }
<span class="hljs-function"><span class="hljs-title">print_warning</span></span>() { <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>[WARNING]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>; }
<span class="hljs-function"><span class="hljs-title">print_step</span></span>() { <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${BLUE}</span>[STEP]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>; }
<span class="hljs-function"><span class="hljs-title">print_error</span></span>() { <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>[ERROR]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>; }

<span class="hljs-comment"># 网络配置</span>
BRIDGE_NAME=<span class="hljs-string">"br0"</span>
BRIDGE_IP=<span class="hljs-string">"10.0.1.1/24"</span>
NS1_IP=<span class="hljs-string">"10.0.1.10/24"</span>
NS2_IP=<span class="hljs-string">"10.0.1.20/24"</span>
NS3_IP=<span class="hljs-string">"10.0.1.30/24"</span>

<span class="hljs-comment"># 清理函数</span>
<span class="hljs-function"><span class="hljs-title">cleanup</span></span>() {
    print_info <span class="hljs-string">"执行清理操作..."</span>
    
    <span class="hljs-comment"># 删除命名空间</span>
    <span class="hljs-keyword">for</span> ns <span class="hljs-keyword">in</span> ns1 ns2 ns3; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> ip netns list | grep -q <span class="hljs-string">"<span class="hljs-variable">$ns</span>"</span>; <span class="hljs-keyword">then</span>
            ip netns delete <span class="hljs-variable">$ns</span> 2&gt;/dev/null || <span class="hljs-literal">true</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 删除网络接口</span>
    <span class="hljs-keyword">for</span> iface <span class="hljs-keyword">in</span> veth1 veth1-br veth2 veth2-br veth3 veth3-br <span class="hljs-variable">$BRIDGE_NAME</span>; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> ip <span class="hljs-built_in">link</span> show <span class="hljs-variable">$iface</span> &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
            ip <span class="hljs-built_in">link</span> delete <span class="hljs-variable">$iface</span> 2&gt;/dev/null || <span class="hljs-literal">true</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 清理 iptables 规则</span>
    iptables -t nat -D POSTROUTING -s 10.0.1.0/24 -j MASQUERADE 2&gt;/dev/null || <span class="hljs-literal">true</span>
}

<span class="hljs-built_in">trap</span> cleanup EXIT

<span class="hljs-comment"># 测试连通性</span>
<span class="hljs-function"><span class="hljs-title">test_connectivity</span></span>() {
    <span class="hljs-built_in">local</span> source_ns=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">local</span> target_ip=<span class="hljs-variable">$2</span>
    <span class="hljs-built_in">local</span> test_name=<span class="hljs-variable">$3</span>
    
    print_info <span class="hljs-string">"测试 <span class="hljs-variable">$test_name</span>: <span class="hljs-variable">$source_ns</span> -&gt; <span class="hljs-variable">$target_ip</span>"</span>
    <span class="hljs-keyword">if</span> ip netns <span class="hljs-built_in">exec</span> <span class="hljs-variable">$source_ns</span> ping -c 2 -W 1 <span class="hljs-variable">$target_ip</span> &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
        print_info <span class="hljs-string">"✓ <span class="hljs-variable">$test_name</span> 成功"</span>
        <span class="hljs-built_in">return</span> 0
    <span class="hljs-keyword">else</span>
        print_error <span class="hljs-string">"✗ <span class="hljs-variable">$test_name</span> 失败"</span>
        <span class="hljs-built_in">return</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    print_info <span class="hljs-string">"开始创建完整虚拟网络..."</span>
    
    <span class="hljs-comment"># 步骤1: 创建网络命名空间</span>
    print_step <span class="hljs-string">"1. 创建三个网络命名空间"</span>
    <span class="hljs-keyword">for</span> ns <span class="hljs-keyword">in</span> ns1 ns2 ns3; <span class="hljs-keyword">do</span>
        ip netns add <span class="hljs-variable">$ns</span>
        print_info <span class="hljs-string">"✓ 创建命名空间: <span class="hljs-variable">$ns</span>"</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 步骤2: 创建 Linux 网桥</span>
    print_step <span class="hljs-string">"2. 创建 Linux 网桥: <span class="hljs-variable">$BRIDGE_NAME</span>"</span>
    ip <span class="hljs-built_in">link</span> add name <span class="hljs-variable">$BRIDGE_NAME</span> <span class="hljs-built_in">type</span> bridge
    ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> <span class="hljs-variable">$BRIDGE_NAME</span> up
    ip addr add <span class="hljs-variable">$BRIDGE_IP</span> dev <span class="hljs-variable">$BRIDGE_NAME</span>
    print_info <span class="hljs-string">"✓ 网桥 <span class="hljs-variable">$BRIDGE_NAME</span> 创建并启动，IP: <span class="hljs-variable">$BRIDGE_IP</span>"</span>
    
    <span class="hljs-comment"># 步骤3: 创建并配置 veth pair</span>
    print_step <span class="hljs-string">"3. 创建和配置 veth pair"</span>
    
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> 1 2 3; <span class="hljs-keyword">do</span>
        <span class="hljs-comment"># 创建 veth pair</span>
        ip <span class="hljs-built_in">link</span> add veth<span class="hljs-variable">$i</span> <span class="hljs-built_in">type</span> veth peer name veth<span class="hljs-variable">$i</span>-br
        print_info <span class="hljs-string">"✓ 创建 veth pair: veth<span class="hljs-variable">$i</span> &lt;-&gt; veth<span class="hljs-variable">$i</span>-br"</span>
        
        <span class="hljs-comment"># 将 veth 一端移动到命名空间</span>
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth<span class="hljs-variable">$i</span> netns ns<span class="hljs-variable">$i</span>
        print_info <span class="hljs-string">"✓ veth<span class="hljs-variable">$i</span> 移动到 ns<span class="hljs-variable">$i</span>"</span>
        
        <span class="hljs-comment"># 将 veth 另一端连接到网桥</span>
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth<span class="hljs-variable">$i</span>-br master <span class="hljs-variable">$BRIDGE_NAME</span>
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth<span class="hljs-variable">$i</span>-br up
        print_info <span class="hljs-string">"✓ veth<span class="hljs-variable">$i</span>-br 连接到网桥 <span class="hljs-variable">$BRIDGE_NAME</span>"</span>
        
        <span class="hljs-comment"># 配置命名空间中的网络</span>
        ip netns <span class="hljs-built_in">exec</span> ns<span class="hljs-variable">$i</span> ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> lo up
        ip netns <span class="hljs-built_in">exec</span> ns<span class="hljs-variable">$i</span> ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth<span class="hljs-variable">$i</span> up
        
        <span class="hljs-comment"># 分配 IP 地址</span>
        <span class="hljs-keyword">case</span> <span class="hljs-variable">$i</span> <span class="hljs-keyword">in</span>
            1) ip netns <span class="hljs-built_in">exec</span> ns<span class="hljs-variable">$i</span> ip addr add <span class="hljs-variable">$NS1_IP</span> dev veth<span class="hljs-variable">$i</span> ;;
            2) ip netns <span class="hljs-built_in">exec</span> ns<span class="hljs-variable">$i</span> ip addr add <span class="hljs-variable">$NS2_IP</span> dev veth<span class="hljs-variable">$i</span> ;;
            3) ip netns <span class="hljs-built_in">exec</span> ns<span class="hljs-variable">$i</span> ip addr add <span class="hljs-variable">$NS3_IP</span> dev veth<span class="hljs-variable">$i</span> ;;
        <span class="hljs-keyword">esac</span>
        
        print_info <span class="hljs-string">"✓ ns<span class="hljs-variable">$i</span>: veth<span class="hljs-variable">$i</span> 配置完成"</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 步骤4: 配置默认网关</span>
    print_step <span class="hljs-string">"4. 配置默认网关"</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> 1 2 3; <span class="hljs-keyword">do</span>
        ip netns <span class="hljs-built_in">exec</span> ns<span class="hljs-variable">$i</span> ip route add default via 10.0.1.1 dev veth<span class="hljs-variable">$i</span>
        print_info <span class="hljs-string">"✓ ns<span class="hljs-variable">$i</span> 默认网关: 10.0.1.1"</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 步骤5: 启用 IP 转发和 NAT</span>
    print_step <span class="hljs-string">"5. 配置系统网络设置"</span>
    <span class="hljs-built_in">echo</span> 1 &gt; /proc/sys/net/ipv4/ip_forward
    iptables -t nat -A POSTROUTING -s 10.0.1.0/24 -j MASQUERADE
    print_info <span class="hljs-string">"✓ 启用 IPv4 转发"</span>
    print_info <span class="hljs-string">"✓ 配置 NAT MASQUERADE"</span>
    
    <span class="hljs-comment"># 步骤6: 测试网络连通性</span>
    print_step <span class="hljs-string">"6. 测试网络连通性"</span>
    
    <span class="hljs-comment"># 测试网桥内部通信</span>
    test_connectivity <span class="hljs-string">"ns1"</span> <span class="hljs-string">"10.0.1.20"</span> <span class="hljs-string">"内部通信 ns1-&gt;ns2"</span>
    test_connectivity <span class="hljs-string">"ns1"</span> <span class="hljs-string">"10.0.1.30"</span> <span class="hljs-string">"内部通信 ns1-&gt;ns3"</span>
    test_connectivity <span class="hljs-string">"ns2"</span> <span class="hljs-string">"10.0.1.10"</span> <span class="hljs-string">"内部通信 ns2-&gt;ns1"</span>
    test_connectivity <span class="hljs-string">"ns3"</span> <span class="hljs-string">"10.0.1.10"</span> <span class="hljs-string">"内部通信 ns3-&gt;ns1"</span>
    
    <span class="hljs-comment"># 测试网关可达性</span>
    test_connectivity <span class="hljs-string">"ns1"</span> <span class="hljs-string">"10.0.1.1"</span> <span class="hljs-string">"网关可达性"</span>
    
    <span class="hljs-comment"># 步骤7: 显示网络拓扑信息</span>
    print_step <span class="hljs-string">"7. 显示网络拓扑信息"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n<span class="hljs-variable">${BLUE}</span>=== 网络拓扑摘要 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"网桥: <span class="hljs-variable">$BRIDGE_NAME</span> (IP: <span class="hljs-variable">$BRIDGE_IP</span>)"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"命名空间:"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  ns1: veth1 (IP: <span class="hljs-variable">$NS1_IP</span>)"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  ns2: veth2 (IP: <span class="hljs-variable">$NS2_IP</span>)"</span> 
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  ns3: veth3 (IP: <span class="hljs-variable">$NS3_IP</span>)"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n<span class="hljs-variable">${BLUE}</span>=== 网桥信息 ===<span class="hljs-variable">${NC}</span>"</span>
    brctl show <span class="hljs-variable">$BRIDGE_NAME</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n<span class="hljs-variable">${BLUE}</span>=== 详细接口信息 ===<span class="hljs-variable">${NC}</span>"</span>
    <span class="hljs-keyword">for</span> ns <span class="hljs-keyword">in</span> ns1 ns2 ns3; <span class="hljs-keyword">do</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n命名空间 <span class="hljs-variable">$ns</span>:"</span>
        ip netns <span class="hljs-built_in">exec</span> <span class="hljs-variable">$ns</span> ip addr show | grep -E <span class="hljs-string">"(inet|veth)"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"路由表:"</span>
        ip netns <span class="hljs-built_in">exec</span> <span class="hljs-variable">$ns</span> ip route show
    <span class="hljs-keyword">done</span>
    
    print_info <span class="hljs-string">"完整虚拟网络创建成功！"</span>
    print_warning <span class="hljs-string">"输入 'sudo ./cleanup_network.sh' 来清理网络"</span>
}

main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<p>运行完整网络创建脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x create_complete_network.sh
sudo ./create_complete_network.sh
</code></pre>
<h3 data-id="heading-10">5.2 网络拓扑可视化</h3>
<p>创建网络拓扑图生成脚本 <code>generate_network_diagram.sh</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 文件名: generate_network_diagram.sh</span>

<span class="hljs-built_in">cat</span> &gt; network_topology.md &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-comment"># 虚拟网络拓扑图</span>

```mermaid
graph TB
    %% 样式定义
    classDef default fill:<span class="hljs-comment">#1e1e1e,stroke:#666,stroke-width:2px,color:#fff;</span>
    classDef namespace fill:<span class="hljs-comment">#2d5a78,stroke:#4ca1cf,stroke-width:2px,color:#fff;</span>
    classDef bridge fill:<span class="hljs-comment">#5d3a6a,stroke:#b57edc,stroke-width:2px,color:#fff;</span>
    classDef veth fill:<span class="hljs-comment">#356635,stroke:#6bc36b,stroke-width:2px,color:#fff;</span>
    
    %% 网桥
    br0[br0&lt;br/&gt;10.0.1.1/24]:::bridge
    
    %% 命名空间1
    subgraph ns1[网络命名空间 ns1]
        veth1_ns[veth1&lt;br/&gt;10.0.1.10/24]:::veth
    end
    
    %% 命名空间2  
    subgraph ns2[网络命名空间 ns2]
        veth2_ns[veth2&lt;br/&gt;10.0.1.20/24]:::veth
    end
    
    %% 命名空间3
    subgraph ns3[网络命名空间 ns3]
        veth3_ns[veth3&lt;br/&gt;10.0.1.30/24]:::veth
    end
    
    %% 连接关系
    veth1_ns -.-&gt;|veth pair| veth1_br
    veth2_ns -.-&gt;|veth pair| veth2_br  
    veth3_ns -.-&gt;|veth pair| veth3_br
    
    veth1_br --&gt; br0
    veth2_br --&gt; br0
    veth3_br --&gt; br0
    
    %% 隐藏的桥接端
    veth1_br:::veth
    veth2_br:::veth
    veth3_br:::veth
    
    %% 样式应用
    class ns1,ns2,ns3 namespace;
</code></pre>
<h2 data-id="heading-11">数据流路径</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[外部网络] &lt;--&gt; B[物理接口 eth0]
    B &lt;--&gt; C[Linux 主机路由]
    C &lt;--&gt; D{NAT 转换iptables}
    D &lt;--&gt; E[网桥 br0 10.0.1.1/24]
    
    E &lt;--&gt; F[veth1-br]
    F &lt;-.-&gt; G[veth1 10.0.1.10/24]
    G &lt;--&gt; H[ns1 应用]
    
    E &lt;--&gt; I[veth2-br]  
    I &lt;-.-&gt; J[veth2 10.0.1.20/24]
    J &lt;--&gt; K[ns2 应用]
    
    E &lt;--&gt; L[veth3-br]
    L &lt;-.-&gt; M[veth3 10.0.1.30/24]
    M &lt;--&gt; N[ns3 应用]
    
   
</code></pre>
<p>EOF</p>
<p>echo "网络拓扑图已生成到 network_topology.md"
echo "可以使用支持 Mermaid 的 Markdown 查看器查看图表"</p>
<p>运行拓扑图生成脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x generate_network_diagram.sh
./generate_network_diagram.sh
</code></pre>
<h2 data-id="heading-12">6. 高级网络配置</h2>
<h3 data-id="heading-13">6.1 VLAN 隔离配置</h3>
<p>创建 VLAN 配置脚本 <code>configure_vlan.sh</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 文件名: configure_vlan.sh</span>

<span class="hljs-built_in">set</span> -e

<span class="hljs-comment"># 颜色定义</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
BLUE=<span class="hljs-string">'\033[0;34m'</span>
NC=<span class="hljs-string">'\033[0m'</span>

<span class="hljs-function"><span class="hljs-title">print_info</span></span>() { <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>[INFO]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>; }
<span class="hljs-function"><span class="hljs-title">print_step</span></span>() { <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${BLUE}</span>[STEP]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>; }

<span class="hljs-function"><span class="hljs-title">cleanup</span></span>() {
    print_info <span class="hljs-string">"清理 VLAN 配置..."</span>
    
    <span class="hljs-comment"># 删除命名空间</span>
    <span class="hljs-keyword">for</span> ns <span class="hljs-keyword">in</span> vlan10-ns1 vlan10-ns2 vlan20-ns1 vlan20-ns2; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> ip netns list | grep -q <span class="hljs-string">"<span class="hljs-variable">$ns</span>"</span>; <span class="hljs-keyword">then</span>
            ip netns delete <span class="hljs-variable">$ns</span> 2&gt;/dev/null || <span class="hljs-literal">true</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 删除 VLAN 接口和网桥</span>
    <span class="hljs-keyword">for</span> br <span class="hljs-keyword">in</span> br-vlan10 br-vlan20; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> ip <span class="hljs-built_in">link</span> show <span class="hljs-variable">$br</span> &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
            ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> <span class="hljs-variable">$br</span> down
            ip <span class="hljs-built_in">link</span> delete <span class="hljs-variable">$br</span> 2&gt;/dev/null || <span class="hljs-literal">true</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 删除物理接口上的 VLAN</span>
    <span class="hljs-keyword">for</span> vlan <span class="hljs-keyword">in</span> 10 20; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">if</span> ip <span class="hljs-built_in">link</span> show eth0.<span class="hljs-variable">$vlan</span> &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
            ip <span class="hljs-built_in">link</span> delete eth0.<span class="hljs-variable">$vlan</span> 2&gt;/dev/null || <span class="hljs-literal">true</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-built_in">trap</span> cleanup EXIT

<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    print_info <span class="hljs-string">"开始配置 VLAN 网络..."</span>
    
    <span class="hljs-comment"># 步骤1: 创建命名空间</span>
    print_step <span class="hljs-string">"1. 创建 VLAN 命名空间"</span>
    <span class="hljs-keyword">for</span> ns <span class="hljs-keyword">in</span> vlan10-ns1 vlan10-ns2 vlan20-ns1 vlan20-ns2; <span class="hljs-keyword">do</span>
        ip netns add <span class="hljs-variable">$ns</span>
        print_info <span class="hljs-string">"✓ 创建命名空间: <span class="hljs-variable">$ns</span>"</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 步骤2: 创建 VLAN 网桥</span>
    print_step <span class="hljs-string">"2. 创建 VLAN 网桥"</span>
    ip <span class="hljs-built_in">link</span> add name br-vlan10 <span class="hljs-built_in">type</span> bridge
    ip <span class="hljs-built_in">link</span> add name br-vlan20 <span class="hljs-built_in">type</span> bridge
    ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> br-vlan10 up
    ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> br-vlan20 up
    print_info <span class="hljs-string">"✓ 创建网桥: br-vlan10, br-vlan20"</span>
    
    <span class="hljs-comment"># 步骤3: 配置 VLAN 接口 (如果物理接口存在)</span>
    print_step <span class="hljs-string">"3. 配置 VLAN 接口"</span>
    PHYSICAL_IFACE=$(ip route | grep default | awk <span class="hljs-string">'{print $5}'</span> | <span class="hljs-built_in">head</span> -1)
    
    <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$PHYSICAL_IFACE</span>"</span> ] &amp;&amp; [ <span class="hljs-string">"<span class="hljs-variable">$PHYSICAL_IFACE</span>"</span> != <span class="hljs-string">"br0"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-comment"># 创建 VLAN 子接口</span>
        ip <span class="hljs-built_in">link</span> add <span class="hljs-built_in">link</span> <span class="hljs-variable">$PHYSICAL_IFACE</span> name <span class="hljs-variable">$PHYSICAL_IFACE</span>.10 <span class="hljs-built_in">type</span> vlan <span class="hljs-built_in">id</span> 10
        ip <span class="hljs-built_in">link</span> add <span class="hljs-built_in">link</span> <span class="hljs-variable">$PHYSICAL_IFACE</span> name <span class="hljs-variable">$PHYSICAL_IFACE</span>.20 <span class="hljs-built_in">type</span> vlan <span class="hljs-built_in">id</span> 20
        
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> <span class="hljs-variable">$PHYSICAL_IFACE</span>.10 up
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> <span class="hljs-variable">$PHYSICAL_IFACE</span>.20 up
        
        <span class="hljs-comment"># 将 VLAN 接口连接到对应的网桥</span>
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> <span class="hljs-variable">$PHYSICAL_IFACE</span>.10 master br-vlan10
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> <span class="hljs-variable">$PHYSICAL_IFACE</span>.20 master br-vlan20
        
        print_info <span class="hljs-string">"✓ 在 <span class="hljs-variable">$PHYSICAL_IFACE</span> 上创建 VLAN 10 和 VLAN 20"</span>
    <span class="hljs-keyword">else</span>
        print_info <span class="hljs-string">"⚠ 未找到合适的物理接口，仅配置内部 VLAN"</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 步骤4: 创建并配置 veth pair</span>
    print_step <span class="hljs-string">"4. 配置 veth pair 和 VLAN 连接"</span>
    
    <span class="hljs-comment"># VLAN 10 的命名空间</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> 1 2; <span class="hljs-keyword">do</span>
        <span class="hljs-comment"># 创建 veth pair</span>
        ip <span class="hljs-built_in">link</span> add veth-vlan10-<span class="hljs-variable">$i</span> <span class="hljs-built_in">type</span> veth peer name veth-vlan10-<span class="hljs-variable">$i</span>-br
        
        <span class="hljs-comment"># 配置命名空间端</span>
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth-vlan10-<span class="hljs-variable">$i</span> netns vlan10-ns<span class="hljs-variable">$i</span>
        ip netns <span class="hljs-built_in">exec</span> vlan10-ns<span class="hljs-variable">$i</span> ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> lo up
        ip netns <span class="hljs-built_in">exec</span> vlan10-ns<span class="hljs-variable">$i</span> ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth-vlan10-<span class="hljs-variable">$i</span> up
        ip netns <span class="hljs-built_in">exec</span> vlan10-ns<span class="hljs-variable">$i</span> ip addr add 10.10.10.$i<span class="hljs-variable">$i</span>/24 dev veth-vlan10-<span class="hljs-variable">$i</span>
        
        <span class="hljs-comment"># 配置网桥端</span>
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth-vlan10-<span class="hljs-variable">$i</span>-br master br-vlan10
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth-vlan10-<span class="hljs-variable">$i</span>-br up
        
        print_info <span class="hljs-string">"✓ 配置 VLAN10: vlan10-ns<span class="hljs-variable">$i</span> -&gt; 10.10.10.$i<span class="hljs-variable">$i</span>"</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># VLAN 20 的命名空间  </span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> 1 2; <span class="hljs-keyword">do</span>
        <span class="hljs-comment"># 创建 veth pair</span>
        ip <span class="hljs-built_in">link</span> add veth-vlan20-<span class="hljs-variable">$i</span> <span class="hljs-built_in">type</span> veth peer name veth-vlan20-<span class="hljs-variable">$i</span>-br
        
        <span class="hljs-comment"># 配置命名空间端</span>
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth-vlan20-<span class="hljs-variable">$i</span> netns vlan20-ns<span class="hljs-variable">$i</span>
        ip netns <span class="hljs-built_in">exec</span> vlan20-ns<span class="hljs-variable">$i</span> ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> lo up
        ip netns <span class="hljs-built_in">exec</span> vlan20-ns<span class="hljs-variable">$i</span> ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth-vlan20-<span class="hljs-variable">$i</span> up
        ip netns <span class="hljs-built_in">exec</span> vlan20-ns<span class="hljs-variable">$i</span> ip addr add 10.10.20.$i<span class="hljs-variable">$i</span>/24 dev veth-vlan20-<span class="hljs-variable">$i</span>
        
        <span class="hljs-comment"># 配置网桥端</span>
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth-vlan20-<span class="hljs-variable">$i</span>-br master br-vlan20
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> veth-vlan20-<span class="hljs-variable">$i</span>-br up
        
        print_info <span class="hljs-string">"✓ 配置 VLAN20: vlan20-ns<span class="hljs-variable">$i</span> -&gt; 10.10.20.$i<span class="hljs-variable">$i</span>"</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-comment"># 步骤5: 配置网桥 IP</span>
    print_step <span class="hljs-string">"5. 配置网桥管理 IP"</span>
    ip addr add 10.10.10.1/24 dev br-vlan10 2&gt;/dev/null || <span class="hljs-literal">true</span>
    ip addr add 10.10.20.1/24 dev br-vlan20 2&gt;/dev/null || <span class="hljs-literal">true</span>
    
    <span class="hljs-comment"># 步骤6: 测试连通性</span>
    print_step <span class="hljs-string">"6. 测试 VLAN 连通性"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n测试 VLAN10 内部通信:"</span>
    <span class="hljs-keyword">if</span> ip netns <span class="hljs-built_in">exec</span> vlan10-ns1 ping -c 2 -W 1 10.10.10.22 &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
        print_info <span class="hljs-string">"✓ VLAN10 内部通信正常"</span>
    <span class="hljs-keyword">else</span>
        print_info <span class="hljs-string">"✗ VLAN10 内部通信失败"</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n测试 VLAN20 内部通信:"</span>
    <span class="hljs-keyword">if</span> ip netns <span class="hljs-built_in">exec</span> vlan20-ns1 ping -c 2 -W 1 10.10.20.22 &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
        print_info <span class="hljs-string">"✓ VLAN20 内部通信正常"</span>
    <span class="hljs-keyword">else</span>
        print_info <span class="hljs-string">"✗ VLAN20 内部通信失败"</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n测试 VLAN 间隔离:"</span>
    <span class="hljs-keyword">if</span> ip netns <span class="hljs-built_in">exec</span> vlan10-ns1 ping -c 2 -W 1 10.10.20.11 &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
        print_info <span class="hljs-string">"✗ VLAN 隔离失败 (异常)"</span>
    <span class="hljs-keyword">else</span>
        print_info <span class="hljs-string">"✓ VLAN 隔离正常"</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 步骤7: 显示配置信息</span>
    print_step <span class="hljs-string">"7. 显示 VLAN 配置信息"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n网桥信息:"</span>
    <span class="hljs-keyword">for</span> br <span class="hljs-keyword">in</span> br-vlan10 br-vlan20; <span class="hljs-keyword">do</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n<span class="hljs-variable">$br</span>:"</span>
        bridge <span class="hljs-built_in">link</span> show dev <span class="hljs-variable">$br</span> 2&gt;/dev/null || brctl show <span class="hljs-variable">$br</span> 2&gt;/dev/null || <span class="hljs-built_in">echo</span> <span class="hljs-string">"无法获取网桥信息"</span>
    <span class="hljs-keyword">done</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\nVLAN 接口:"</span>
    ip <span class="hljs-built_in">link</span> show | grep -E <span class="hljs-string">"vlan|br-vlan"</span>
    
    print_info <span class="hljs-string">"VLAN 配置完成！"</span>
}

main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<p>运行 VLAN 配置脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x configure_vlan.sh
sudo ./configure_vlan.sh
</code></pre>
<h2 data-id="heading-14">7. 网络监控和诊断</h2>
<h3 data-id="heading-15">7.1 网络状态监控脚本</h3>
<p>创建网络监控脚本 <code>network_monitor.sh</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 文件名: network_monitor.sh</span>

<span class="hljs-comment"># 颜色定义</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
BLUE=<span class="hljs-string">'\033[0;34m'</span>
NC=<span class="hljs-string">'\033[0m'</span>

<span class="hljs-function"><span class="hljs-title">print_header</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${BLUE}</span>=== <span class="hljs-variable">$1</span> ===<span class="hljs-variable">${NC}</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">print_success</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>✓ $1<span class="hljs-variable">${NC}</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">print_warning</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>⚠ $1<span class="hljs-variable">${NC}</span>"</span>
}

<span class="hljs-function"><span class="hljs-title">print_error</span></span>() {
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>✗ $1<span class="hljs-variable">${NC}</span>"</span>
}

<span class="hljs-comment"># 监控函数</span>
<span class="hljs-function"><span class="hljs-title">monitor_namespaces</span></span>() {
    print_header <span class="hljs-string">"网络命名空间状态"</span>
    
    <span class="hljs-built_in">local</span> namespaces=$(ip netns list)
    <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$namespaces</span>"</span> ]; <span class="hljs-keyword">then</span>
        print_warning <span class="hljs-string">"没有找到网络命名空间"</span>
        <span class="hljs-built_in">return</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"<span class="hljs-variable">$namespaces</span>"</span> | <span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> ns; <span class="hljs-keyword">do</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n命名空间: <span class="hljs-variable">$ns</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"接口状态:"</span>
        ip netns <span class="hljs-built_in">exec</span> <span class="hljs-variable">$ns</span> ip -o <span class="hljs-built_in">link</span> show | awk <span class="hljs-string">'{print "  " $2 " " $3 " " $9}'</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"IP 地址:"</span>
        ip netns <span class="hljs-built_in">exec</span> <span class="hljs-variable">$ns</span> ip -o addr show | grep -v <span class="hljs-string">"inet6"</span> | awk <span class="hljs-string">'{print "  " $2 " " $4}'</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"路由表:"</span>
        ip netns <span class="hljs-built_in">exec</span> <span class="hljs-variable">$ns</span> ip route show | sed <span class="hljs-string">'s/^/  /'</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-function"><span class="hljs-title">monitor_bridges</span></span>() {
    print_header <span class="hljs-string">"网桥状态"</span>
    
    <span class="hljs-comment"># 尝试使用 bridge 命令</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v bridge &gt; /dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
        bridge <span class="hljs-built_in">link</span> show
    <span class="hljs-keyword">else</span>
        <span class="hljs-comment"># 回退到 brctl</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v brctl &gt; /dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
            brctl show
        <span class="hljs-keyword">else</span>
            print_warning <span class="hljs-string">"未找到 bridge-utils 或 iproute2 bridge 工具"</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-function"><span class="hljs-title">monitor_connections</span></span>() {
    print_header <span class="hljs-string">"活跃连接测试"</span>
    
    <span class="hljs-comment"># 测试本地回环</span>
    <span class="hljs-keyword">if</span> ping -c 1 -W 1 127.0.0.1 &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
        print_success <span class="hljs-string">"本地回环正常"</span>
    <span class="hljs-keyword">else</span>
        print_error <span class="hljs-string">"本地回环异常"</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-comment"># 测试网关连接（如果有默认网关）</span>
    <span class="hljs-built_in">local</span> gateway=$(ip route | grep default | awk <span class="hljs-string">'{print $3}'</span> | <span class="hljs-built_in">head</span> -1)
    <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"<span class="hljs-variable">$gateway</span>"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-keyword">if</span> ping -c 1 -W 1 <span class="hljs-variable">$gateway</span> &gt;/dev/null 2&gt;&amp;1; <span class="hljs-keyword">then</span>
            print_success <span class="hljs-string">"网关 <span class="hljs-variable">$gateway</span> 可达"</span>
        <span class="hljs-keyword">else</span>
            print_warning <span class="hljs-string">"网关 <span class="hljs-variable">$gateway</span> 不可达"</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-function"><span class="hljs-title">monitor_iptables</span></span>() {
    print_header <span class="hljs-string">"防火墙规则"</span>
    
    <span class="hljs-keyword">for</span> table <span class="hljs-keyword">in</span> filter nat mangle; <span class="hljs-keyword">do</span>
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n表: <span class="hljs-variable">$table</span>"</span>
        iptables -t <span class="hljs-variable">$table</span> -L -n 2&gt;/dev/null | <span class="hljs-built_in">head</span> -20
    <span class="hljs-keyword">done</span>
}

<span class="hljs-function"><span class="hljs-title">monitor_system_stats</span></span>() {
    print_header <span class="hljs-string">"系统网络统计"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n网络接口统计:"</span>
    ip -s <span class="hljs-built_in">link</span> show
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n连接统计:"</span>
    ss -s
}

<span class="hljs-comment"># 持续监控模式</span>
<span class="hljs-function"><span class="hljs-title">continuous_monitor</span></span>() {
    <span class="hljs-built_in">local</span> interval=<span class="hljs-variable">${1:-5}</span>
    
    <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
        clear
        print_header <span class="hljs-string">"网络监控 - <span class="hljs-subst">$(date)</span>"</span>
        monitor_namespaces
        monitor_bridges
        monitor_connections
        <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n<span class="hljs-variable">${YELLOW}</span>按 Ctrl+C 退出监控...<span class="hljs-variable">${NC}</span>"</span>
        <span class="hljs-built_in">sleep</span> <span class="hljs-variable">$interval</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-comment"># 主函数</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">${1:-}</span>"</span> <span class="hljs-keyword">in</span>
        <span class="hljs-string">"continuous"</span>|<span class="hljs-string">"cont"</span>|<span class="hljs-string">"c"</span>)
            continuous_monitor <span class="hljs-string">"<span class="hljs-variable">${2:-5}</span>"</span>
            ;;
        <span class="hljs-string">"help"</span>|<span class="hljs-string">"-h"</span>|<span class="hljs-string">"--help"</span>)
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"用法: <span class="hljs-variable">$0</span> [mode]"</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"模式:"</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"  continuous [interval]   持续监控模式，可指定间隔（秒）"</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"  help                    显示此帮助信息"</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"  无参数                  单次监控快照"</span>
            ;;
        *)
            print_header <span class="hljs-string">"网络监控快照 - <span class="hljs-subst">$(date)</span>"</span>
            monitor_namespaces
            monitor_bridges
            monitor_connections
            monitor_iptables
            monitor_system_stats
            ;;
    <span class="hljs-keyword">esac</span>
}

main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<p>运行网络监控：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x network_monitor.sh
<span class="hljs-comment"># 单次监控</span>
sudo ./network_monitor.sh

<span class="hljs-comment"># 持续监控（每5秒刷新）</span>
sudo ./network_monitor.sh continuous 5
</code></pre>
<h2 data-id="heading-16">8. 清理脚本</h2>
<p>创建网络清理脚本 <code>cleanup_network.sh</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># 文件名: cleanup_network.sh</span>

<span class="hljs-built_in">set</span> -e

<span class="hljs-comment"># 颜色定义</span>
GREEN=<span class="hljs-string">'\033[0;32m'</span>
YELLOW=<span class="hljs-string">'\033[1;33m'</span>
RED=<span class="hljs-string">'\033[0;31m'</span>
NC=<span class="hljs-string">'\033[0m'</span>

<span class="hljs-function"><span class="hljs-title">print_info</span></span>() { <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${GREEN}</span>[INFO]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>; }
<span class="hljs-function"><span class="hljs-title">print_warning</span></span>() { <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${YELLOW}</span>[WARNING]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>; }
<span class="hljs-function"><span class="hljs-title">print_error</span></span>() { <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"<span class="hljs-variable">${RED}</span>[ERROR]<span class="hljs-variable">${NC}</span> <span class="hljs-variable">$1</span>"</span>; }

<span class="hljs-function"><span class="hljs-title">confirm_cleanup</span></span>() {
    <span class="hljs-built_in">read</span> -p <span class="hljs-string">"确定要清理所有虚拟网络配置吗？(y/N): "</span> -n 1 -r
    <span class="hljs-built_in">echo</span>
    <span class="hljs-keyword">if</span> [[ ! <span class="hljs-variable">$REPLY</span> =~ ^[Yy]$ ]]; <span class="hljs-keyword">then</span>
        print_info <span class="hljs-string">"取消清理操作"</span>
        <span class="hljs-built_in">exit</span> 0
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-function"><span class="hljs-title">cleanup_namespaces</span></span>() {
    print_info <span class="hljs-string">"清理网络命名空间..."</span>
    
    <span class="hljs-built_in">local</span> namespaces=$(ip netns list | awk <span class="hljs-string">'{print $1}'</span>)
    <span class="hljs-keyword">if</span> [ -z <span class="hljs-string">"<span class="hljs-variable">$namespaces</span>"</span> ]; <span class="hljs-keyword">then</span>
        print_info <span class="hljs-string">"没有找到需要清理的命名空间"</span>
        <span class="hljs-built_in">return</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-keyword">for</span> ns <span class="hljs-keyword">in</span> <span class="hljs-variable">$namespaces</span>; <span class="hljs-keyword">do</span>
        print_info <span class="hljs-string">"删除命名空间: <span class="hljs-variable">$ns</span>"</span>
        ip netns delete <span class="hljs-variable">$ns</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-function"><span class="hljs-title">cleanup_bridges</span></span>() {
    print_info <span class="hljs-string">"清理网桥..."</span>
    
    <span class="hljs-comment"># 获取所有网桥</span>
    <span class="hljs-built_in">local</span> bridges=$(ip <span class="hljs-built_in">link</span> show <span class="hljs-built_in">type</span> bridge | grep -o <span class="hljs-string">"br[^:]*"</span> || <span class="hljs-literal">true</span>)
    
    <span class="hljs-keyword">for</span> br <span class="hljs-keyword">in</span> <span class="hljs-variable">$bridges</span>; <span class="hljs-keyword">do</span>
        <span class="hljs-comment"># 跳过一些系统网桥</span>
        <span class="hljs-keyword">case</span> <span class="hljs-variable">$br</span> <span class="hljs-keyword">in</span>
            <span class="hljs-string">"docker0"</span>|<span class="hljs-string">"virbr0"</span>)
                print_warning <span class="hljs-string">"跳过系统网桥: <span class="hljs-variable">$br</span>"</span>
                <span class="hljs-built_in">continue</span>
                ;;
        <span class="hljs-keyword">esac</span>
        
        print_info <span class="hljs-string">"删除网桥: <span class="hljs-variable">$br</span>"</span>
        ip <span class="hljs-built_in">link</span> <span class="hljs-built_in">set</span> <span class="hljs-variable">$br</span> down
        ip <span class="hljs-built_in">link</span> delete <span class="hljs-variable">$br</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-function"><span class="hljs-title">cleanup_veth_pairs</span></span>() {
    print_info <span class="hljs-string">"清理 veth pair..."</span>
    
    <span class="hljs-comment"># 查找所有 veth 设备</span>
    <span class="hljs-built_in">local</span> veth_devices=$(ip <span class="hljs-built_in">link</span> show | grep -o <span class="hljs-string">"veth[^@]*"</span> | <span class="hljs-built_in">uniq</span> || <span class="hljs-literal">true</span>)
    
    <span class="hljs-keyword">for</span> dev <span class="hljs-keyword">in</span> <span class="hljs-variable">$veth_devices</span>; <span class="hljs-keyword">do</span>
        print_info <span class="hljs-string">"删除 veth 设备: <span class="hljs-variable">$dev</span>"</span>
        ip <span class="hljs-built_in">link</span> delete <span class="hljs-variable">$dev</span> 2&gt;/dev/null || <span class="hljs-literal">true</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-function"><span class="hljs-title">cleanup_vlan_interfaces</span></span>() {
    print_info <span class="hljs-string">"清理 VLAN 接口..."</span>
    
    <span class="hljs-comment"># 查找 VLAN 子接口</span>
    <span class="hljs-built_in">local</span> vlan_ifaces=$(ip <span class="hljs-built_in">link</span> show | grep -o <span class="hljs-string">"[^ ]*\.[0-9]*@[^:]*"</span> | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">'@'</span> -f1 | <span class="hljs-built_in">uniq</span> || <span class="hljs-literal">true</span>)
    
    <span class="hljs-keyword">for</span> iface <span class="hljs-keyword">in</span> <span class="hljs-variable">$vlan_ifaces</span>; <span class="hljs-keyword">do</span>
        print_info <span class="hljs-string">"删除 VLAN 接口: <span class="hljs-variable">$iface</span>"</span>
        ip <span class="hljs-built_in">link</span> delete <span class="hljs-variable">$iface</span> 2&gt;/dev/null || <span class="hljs-literal">true</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-function"><span class="hljs-title">cleanup_iptables_rules</span></span>() {
    print_info <span class="hljs-string">"清理 iptables 规则..."</span>
    
    <span class="hljs-comment"># 清理 NAT 规则</span>
    iptables -t nat -F
    iptables -t mangle -F
    iptables -F
    iptables -X
    
    print_info <span class="hljs-string">"✓ iptables 规则已清理"</span>
}

<span class="hljs-function"><span class="hljs-title">reset_network_settings</span></span>() {
    print_info <span class="hljs-string">"重置网络设置..."</span>
    
    <span class="hljs-comment"># 禁用 IP 转发</span>
    <span class="hljs-built_in">echo</span> 0 &gt; /proc/sys/net/ipv4/ip_forward
    
    <span class="hljs-comment"># 刷新路由缓存</span>
    ip route flush cache
    
    print_info <span class="hljs-string">"✓ 网络设置已重置"</span>
}

<span class="hljs-function"><span class="hljs-title">show_remaining_objects</span></span>() {
    print_info <span class="hljs-string">"检查剩余网络对象..."</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n剩余网络命名空间:"</span>
    ip netns list
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n剩余网桥:"</span>
    ip <span class="hljs-built_in">link</span> show <span class="hljs-built_in">type</span> bridge 2&gt;/dev/null || <span class="hljs-built_in">echo</span> <span class="hljs-string">"无"</span>
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n剩余 veth 设备:"</span>
    ip <span class="hljs-built_in">link</span> show | grep <span class="hljs-string">"veth"</span> || <span class="hljs-built_in">echo</span> <span class="hljs-string">"无"</span>
}

<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 虚拟网络清理工具 ==="</span>
    
    <span class="hljs-comment"># 请求确认</span>
    confirm_cleanup
    
    <span class="hljs-comment"># 执行清理操作</span>
    cleanup_namespaces
    cleanup_bridges
    cleanup_veth_pairs
    cleanup_vlan_interfaces
    cleanup_iptables_rules
    reset_network_settings
    
    <span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\n"</span>
    show_remaining_objects
    
    print_info <span class="hljs-string">"虚拟网络清理完成！"</span>
}

<span class="hljs-comment"># 检查 root 权限</span>
<span class="hljs-keyword">if</span> [ <span class="hljs-string">"<span class="hljs-variable">$EUID</span>"</span> -ne 0 ]; <span class="hljs-keyword">then</span>
    print_error <span class="hljs-string">"请使用 root 权限运行此脚本: sudo <span class="hljs-variable">$0</span>"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<p>运行清理脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x cleanup_network.sh
sudo ./cleanup_network.sh
</code></pre>
<h2 data-id="heading-17">9. 总结</h2>
<p>通过本教程，我们深入学习了 Linux 网络命名空间的各个方面：</p>
<ol>
<li><strong>基础概念</strong>：理解了网络命名空间的隔离机制</li>
<li><strong>实际操作</strong>：掌握了创建、配置和管理网络命名空间的技能</li>
<li><strong>网络构建</strong>：学会了使用 veth pair 和网桥构建复杂虚拟网络</li>
<li><strong>高级特性</strong>：了解了 VLAN 配置和网络隔离</li>
<li><strong>监控诊断</strong>：掌握了网络状态监控和故障诊断方法</li>
</ol>
<p>这些技能为理解容器网络、虚拟化技术和云原生基础设施打下了坚实基础。网络命名空间是现代 Linux 网络虚拟化的核心技术，掌握它对于系统管理员、网络工程师和 DevOps 工程师都至关重要。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java Set集合：你的数据去重神器]]></title>    <link>https://juejin.cn/post/7572776177690116105</link>    <guid>https://juejin.cn/post/7572776177690116105</guid>    <pubDate>2025-11-16T01:22:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572776177690116105" data-draft-id="7572749797468225545" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java Set集合：你的数据去重神器"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2025-11-16T01:22:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="会编程的吕洞宾"/> <meta itemprop="url" content="https://juejin.cn/user/2506542242333832"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java Set集合：你的数据去重神器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2506542242333832/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    会编程的吕洞宾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T01:22:37.000Z" title="Sun Nov 16 2025 01:22:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java Set集合：你的数据去重神器</h2>
<p>各位道友们好，我是会编程的吕洞宾！今天咱们来聊聊Java中的Set集合——这玩意儿就像是数据界的"照妖镜"，专门识别和去除重复元素，让你的数据保持独一无二！</p>
<h3 data-id="heading-1">什么是Set？</h3>
<p>想象一下天庭的仙人名录：每个神仙都是独一无二的，不能有重复。Set就是这样一种不允许重复元素的集合，它就像个严格的守门员，确保每个元素都是"独一份"的。</p>
<h3 data-id="heading-2">三大去重高手</h3>
<h4 data-id="heading-3">1. HashSet - 闪电侠</h4>
<p>HashSet就像是个拥有超快查找能力的闪电侠：</p>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">Set&lt;String&gt; immortalSet = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();
immortalSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"吕洞宾"</span>);
immortalSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"何仙姑"</span>);
immortalSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"铁拐李"</span>);
immortalSet.<span class="hljs-keyword">add</span>(<span class="hljs-string">"吕洞宾"</span>); <span class="hljs-comment">// 这个不会重复添加！</span>

System.<span class="hljs-keyword">out</span>.println(immortalSet.size()); <span class="hljs-comment">// 输出：3</span>
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>基于哈希表，查找速度超快（O(1)时间复杂度）</li>
<li>不保证元素顺序（就像神仙们随意站队）</li>
<li>允许null元素（但只能有一个null）</li>
</ul>
<h4 data-id="heading-4">2. TreeSet - 排序大师</h4>
<p>TreeSet就像是个自动整理队伍的纪律委员：</p>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">Set&lt;String&gt; sortedImmortals = <span class="hljs-keyword">new</span> TreeSet&lt;&gt;();
sortedImmortals.<span class="hljs-keyword">add</span>(<span class="hljs-string">"钟离权"</span>);
sortedImmortals.<span class="hljs-keyword">add</span>(<span class="hljs-string">"蓝采和"</span>);
sortedImmortals.<span class="hljs-keyword">add</span>(<span class="hljs-string">"吕洞宾"</span>);

<span class="hljs-comment">// 自动按字典序排序！</span>
<span class="hljs-keyword">for</span> (String immortal : sortedImmortals) {
    System.<span class="hljs-keyword">out</span>.println(immortal); <span class="hljs-comment">// 输出：蓝采和、吕洞宾、钟离权</span>
}
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>基于红黑树，自动排序</li>
<li>查找速度较快（O(log n)时间复杂度）</li>
<li>不允许null元素</li>
</ul>
<h4 data-id="heading-5">3. LinkedHashSet - 有序去重专家</h4>
<p>LinkedHashSet就像是既保持顺序又去重的完美主义者：</p>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">Set&lt;String&gt; orderedImmortals = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();
orderedImmortals.<span class="hljs-keyword">add</span>(<span class="hljs-string">"吕洞宾"</span>);
orderedImmortals.<span class="hljs-keyword">add</span>(<span class="hljs-string">"何仙姑"</span>);
orderedImmortals.<span class="hljs-keyword">add</span>(<span class="hljs-string">"铁拐李"</span>);

<span class="hljs-comment">// 保持插入顺序！</span>
<span class="hljs-keyword">for</span> (String immortal : orderedImmortals) {
    System.<span class="hljs-keyword">out</span>.println(immortal); <span class="hljs-comment">// 输出顺序和插入顺序一致</span>
}
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>保持插入顺序</li>
<li>去重能力与HashSet相同</li>
<li>查找速度接近HashSet</li>
</ul>
<h3 data-id="heading-6">Set的仙法秘籍</h3>
<h4 data-id="heading-7">基本操作演示</h4>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp">Set&lt;String&gt; eightImmortals = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

<span class="hljs-comment">// 添加元素</span>
eightImmortals.<span class="hljs-keyword">add</span>(<span class="hljs-string">"吕洞宾"</span>);
eightImmortals.<span class="hljs-keyword">add</span>(<span class="hljs-string">"钟离权"</span>);
eightImmortals.<span class="hljs-keyword">add</span>(<span class="hljs-string">"蓝采和"</span>);

<span class="hljs-comment">// 检查存在性</span>
System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"有吕洞宾吗？"</span> + eightImmortals.contains(<span class="hljs-string">"吕洞宾"</span>));

<span class="hljs-comment">// 删除元素</span>
eightImmortals.<span class="hljs-keyword">remove</span>(<span class="hljs-string">"蓝采和"</span>);

<span class="hljs-comment">// 获取大小</span>
System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"当前仙人数量："</span> + eightImmortals.size());

<span class="hljs-comment">// 清空集合</span>
eightImmortals.clear();
</code></pre>
<h4 data-id="heading-8">集合运算（数学课时间）</h4>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">Set&lt;String&gt; <span class="hljs-attr">group1</span> = new HashSet&lt;&gt;(Arrays.asList(<span class="hljs-string">"吕洞宾"</span>, <span class="hljs-string">"何仙姑"</span>, <span class="hljs-string">"铁拐李"</span>))<span class="hljs-comment">;</span>
Set&lt;String&gt; <span class="hljs-attr">group2</span> = new HashSet&lt;&gt;(Arrays.asList(<span class="hljs-string">"钟离权"</span>, <span class="hljs-string">"蓝采和"</span>, <span class="hljs-string">"吕洞宾"</span>))<span class="hljs-comment">;</span>

// 并集（所有不重复的元素）
Set&lt;String&gt; <span class="hljs-attr">union</span> = new HashSet&lt;&gt;(group1)<span class="hljs-comment">;</span>
union.addAll(group2)<span class="hljs-comment">;</span>
System.out.println("所有仙人：" + union)<span class="hljs-comment">;</span>

// 交集（共同拥有的元素）
Set&lt;String&gt; <span class="hljs-attr">intersection</span> = new HashSet&lt;&gt;(group1)<span class="hljs-comment">;</span>
intersection.retainAll(group2)<span class="hljs-comment">;</span>
System.out.println("共同仙人：" + intersection)<span class="hljs-comment">;</span>

// 差集（A有B没有的元素）
Set&lt;String&gt; <span class="hljs-attr">difference</span> = new HashSet&lt;&gt;(group1)<span class="hljs-comment">;</span>
difference.removeAll(group2)<span class="hljs-comment">;</span>
System.out.println("group1独有的仙人：" + difference)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-9">遍历的三种仙术</h3>
<p><strong>方法一：增强for循环（推荐）</strong></p>
<p>java</p>
<pre><code class="hljs language-erlang" lang="erlang"><span class="hljs-function"><span class="hljs-title">for</span> <span class="hljs-params">(String immortal : eightImmortals)</span> {
    S<span class="hljs-title">ystem</span>.<span class="hljs-title">out</span>.<span class="hljs-title">println</span><span class="hljs-params">(<span class="hljs-string">"仙人："</span> + immortal)</span>;
}
</span></code></pre>
<p><strong>方法二：迭代器</strong></p>
<p>java</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">Iterator</span>&lt;<span class="hljs-type">String</span>&gt; <span class="hljs-keyword">iterator</span> = eightImmortals.<span class="hljs-keyword">iterator</span>();
<span class="hljs-keyword">while</span> (<span class="hljs-keyword">iterator</span>.hasNext()) {
    System.out.println(<span class="hljs-string">"仙人："</span> + <span class="hljs-keyword">iterator</span>.<span class="hljs-keyword">next</span>());
}
</code></pre>
<p><strong>方法三：Java 8+ Stream API</strong></p>
<p>java</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">eightImmortals</span><span class="hljs-selector-class">.stream</span>()
    <span class="hljs-selector-class">.filter</span>(immortal -&gt; immortal.<span class="hljs-built_in">startsWith</span>(<span class="hljs-string">"吕"</span>))
    <span class="hljs-selector-class">.forEach</span>(System.<span class="hljs-attribute">out</span>::println);
</code></pre>
<h3 data-id="heading-10">实战应用场景</h3>
<h4 data-id="heading-11">场景1：用户去重</h4>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用户注册时检查用户名是否重复</span>
<span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">String</span>&gt; registeredUsers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();

<span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">registerUser</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> username</span>) {
    <span class="hljs-keyword">return</span> registeredUsers.<span class="hljs-title function_">add</span>(username); <span class="hljs-comment">// 如果已存在返回false</span>
}
</code></pre>
<h4 data-id="heading-12">场景2：标签管理</h4>
<p>java</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 文章标签自动去重</span>
Set&lt;String&gt; articleTags = <span class="hljs-keyword">new</span> TreeSet&lt;&gt;(); <span class="hljs-comment">// 自动排序的标签</span>
articleTags.<span class="hljs-keyword">add</span>(<span class="hljs-string">"Java"</span>);
articleTags.<span class="hljs-keyword">add</span>(<span class="hljs-string">"编程"</span>);
articleTags.<span class="hljs-keyword">add</span>(<span class="hljs-string">"Java"</span>); <span class="hljs-comment">// 这个不会重复添加</span>
</code></pre>
<h4 data-id="heading-13">场景3：权限验证</h4>
<p>java</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检查用户是否有权限</span>
<span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">String</span>&gt; userPermissions = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(<span class="hljs-title class_">Arrays</span>.<span class="hljs-title function_">asList</span>(<span class="hljs-string">"read"</span>, <span class="hljs-string">"write"</span>));
<span class="hljs-keyword">if</span> (userPermissions.<span class="hljs-title function_">contains</span>(<span class="hljs-string">"admin"</span>)) {
    <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"有管理员权限"</span>);
}
</code></pre>
<h3 data-id="heading-14">性能对比表</h3>



































<table><thead><tr><th>操作</th><th>HashSet</th><th>TreeSet</th><th>LinkedHashSet</th></tr></thead><tbody><tr><td>添加元素</td><td>⚡️ 超快</td><td>🐢 较慢（要排序）</td><td>⚡️ 快</td></tr><tr><td>查找元素</td><td>⚡️ 超快</td><td>🐢 较快</td><td>⚡️ 超快</td></tr><tr><td>删除元素</td><td>⚡️ 超快</td><td>🐢 较慢</td><td>⚡️ 快</td></tr><tr><td>保持顺序</td><td>❌ 不保证</td><td>✅ 自动排序</td><td>✅ 插入顺序</td></tr></tbody></table>
<h3 data-id="heading-15">避坑指南</h3>
<h4 data-id="heading-16">自定义对象的去重</h4>
<p>如果Set中存放自定义对象，需要重写equals()和hashCode()方法：</p>
<p>java</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Immortal</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> name;
    <span class="hljs-keyword">private</span> int age;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Immortal</span>(<span class="hljs-title class_">String</span> name, int age) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">equals</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span> o</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span> == o) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (o == <span class="hljs-literal">null</span> || <span class="hljs-title function_">getClass</span>() != o.<span class="hljs-title function_">getClass</span>()) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-title class_">Immortal</span> immortal = (<span class="hljs-title class_">Immortal</span>) o;
        <span class="hljs-keyword">return</span> age == immortal.<span class="hljs-property">age</span> &amp;&amp; <span class="hljs-title class_">Objects</span>.<span class="hljs-title function_">equals</span>(name, immortal.<span class="hljs-property">name</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> int <span class="hljs-title function_">hashCode</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Objects</span>.<span class="hljs-title function_">hash</span>(name, age);
    }
}

<span class="hljs-comment">// 现在可以正确去重了</span>
<span class="hljs-title class_">Set</span>&lt;<span class="hljs-title class_">Immortal</span>&gt; immortals = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
immortals.<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Immortal</span>(<span class="hljs-string">"吕洞宾"</span>, <span class="hljs-number">1000</span>));
immortals.<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Immortal</span>(<span class="hljs-string">"吕洞宾"</span>, <span class="hljs-number">1000</span>)); <span class="hljs-comment">// 这个不会重复添加</span>
</code></pre>
<h3 data-id="heading-17">选择口诀</h3>
<ul>
<li><strong>要最快查找</strong>：用HashSet</li>
<li><strong>要自动排序</strong>：用TreeSet</li>
<li><strong>要保持插入顺序</strong>：用LinkedHashSet</li>
<li><strong>存放自定义对象</strong>：记得重写equals和hashCode！</li>
</ul>
<h3 data-id="heading-18">总结</h3>
<p>Set就像是Java世界的"去重大师"：</p>
<ul>
<li><strong>HashSet</strong>：闪电查找，适合大多数场景</li>
<li><strong>TreeSet</strong>：自动排序，需要有序时使用</li>
<li><strong>LinkedHashSet</strong>：保持顺序，需要记录插入顺序时使用</li>
</ul>
<p>记住：Set的核心使命就是<strong>去重</strong>！当你需要确保元素唯一性时，请毫不犹豫地请出Set大法！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[S2C-SQL DELETE 删除数据完全指南-99%的人忘记WHERE子句，SQL高手却这样写：从基础语法到多表关联的数据删除利器]]></title>    <link>https://juejin.cn/post/7572459217812160575</link>    <guid>https://juejin.cn/post/7572459217812160575</guid>    <pubDate>2025-11-16T01:28:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572459217812160575" data-draft-id="7572465262739734547" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="S2C-SQL DELETE 删除数据完全指南-99%的人忘记WHERE子句，SQL高手却这样写：从基础语法到多表关联的数据删除利器"/> <meta itemprop="keywords" content="SQL"/> <meta itemprop="datePublished" content="2025-11-16T01:28:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="郑恩赐"/> <meta itemprop="url" content="https://juejin.cn/user/2883382090934252"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            S2C-SQL DELETE 删除数据完全指南-99%的人忘记WHERE子句，SQL高手却这样写：从基础语法到多表关联的数据删除利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2883382090934252/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    郑恩赐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T01:28:08.000Z" title="Sun Nov 16 2025 01:28:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读28分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">S2C-SQL DELETE 删除数据完全指南-99%的人忘记WHERE子句，SQL高手却这样写：从基础语法到多表关联的数据删除利器</h2>
<h3 data-id="heading-1">📝 摘要</h3>
<p>99% 的人执行 DELETE 时忘记 WHERE 子句，导致全表数据被误删？SQL 高手却掌握 WHERE 条件、标记删除、数据归档等技巧，数据删除精准安全。本文档用生活化比喻解析 SQL DELETE 删除数据，从基础语法到性能优化，帮你掌握数据删除核心技能，避免数据灾难。</p>
<hr/>
<blockquote>
<p><strong>面试场景</strong>：</p>
<p><strong>面试官</strong>：请你说说 SQL DELETE 语句的基本用法？</p>
<p><strong>求职者 A（错误回答）</strong>：DELETE 就是删除数据，直接写 <code>DELETE FROM table</code> 就行了。</p>
<p><strong>面试官</strong>：如果表里有 10000 条数据，你这样写会怎样？</p>
<p><strong>求职者 A</strong>：呃...应该只会删除一条吧？</p>
<p><strong>面试官</strong>：❌ 错误！这样会删除所有 10000 条数据！这就是为什么 99% 的人会犯的错误。</p>
<p><strong>求职者 B（正确回答）</strong>：DELETE 语句用于删除表中已存在的记录。基本语法是 <code>DELETE FROM table_name WHERE condition</code>。<strong>WHERE 子句非常重要</strong>，它指定哪些记录需要删除。如果省略 WHERE 子句，所有记录都会被删除，这可能导致数据灾难。</p>
<p><strong>面试官</strong>：✅ 正确！看来你掌握了 DELETE 的核心要点。</p>
<p>通过这个面试场景，我们可以看到，掌握 DELETE 语句的关键在于理解 WHERE 子句的重要性，以及如何正确使用各种删除技巧。让我们一起来深入学习 SQL DELETE 语句，从基础语法到性能优化，掌握数据删除的核心技能。</p>
</blockquote>
<h3 data-id="heading-2">📑 目录</h3>
<ul>
<li><a href="#-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E7%82%B9" title="#-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E7%82%B9">🎯 前置知识点</a></li>
<li><a href="#-%E4%BB%80%E4%B9%88%E6%98%AF-delete" title="#-%E4%BB%80%E4%B9%88%E6%98%AF-delete">🔍 什么是 DELETE？</a></li>
<li><a href="#-%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0" title="#-%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0">❓ 问题描述</a></li>
<li><a href="#-%E9%97%AE%E9%A2%98%E8%80%83%E5%AF%9F%E7%82%B9" title="#-%E9%97%AE%E9%A2%98%E8%80%83%E5%AF%9F%E7%82%B9">🎯 问题考察点</a></li>
<li><a href="#-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B" title="#-%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B">⚡ 快速上手</a></li>
<li><a href="#%EF%B8%8F-delete-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95" title="#%EF%B8%8F-delete-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95">🏗️ DELETE 基本语法</a></li>
<li><a href="#-%E5%8D%95%E8%A1%A8%E5%88%A0%E9%99%A4" title="#-%E5%8D%95%E8%A1%A8%E5%88%A0%E9%99%A4">📊 单表删除</a></li>
<li><a href="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5" title="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5">🔍 DELETE 与 WHERE 子句</a></li>
<li><a href="#-delete-%E4%B8%8E%E5%AD%90%E6%9F%A5%E8%AF%A2" title="#-delete-%E4%B8%8E%E5%AD%90%E6%9F%A5%E8%AF%A2">🔗 DELETE 与子查询</a></li>
<li><a href="#-delete-%E4%B8%8E-join" title="#-delete-%E4%B8%8E-join">🔀 DELETE 与 JOIN</a></li>
<li><a href="#-%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%AD%E6%B3%95%E5%B7%AE%E5%BC%82" title="#-%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%AD%E6%B3%95%E5%B7%AE%E5%BC%82">🌐 不同数据库语法差异</a></li>
<li><a href="#%EF%B8%8F-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E5%92%8C%E8%AD%A6%E5%91%8A" title="#%EF%B8%8F-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E5%92%8C%E8%AD%A6%E5%91%8A">⚠️ 注意事项和警告</a></li>
<li><a href="#-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96" title="#-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96">🚀 性能优化</a></li>
<li><a href="#-%E5%AF%B9%E6%AF%94%E7%A4%BA%E4%BE%8B" title="#-%E5%AF%B9%E6%AF%94%E7%A4%BA%E4%BE%8B">🆚 对比示例</a></li>
<li><a href="#-%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E4%B8%8E%E4%BF%AE%E6%AD%A3" title="#-%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E4%B8%8E%E4%BF%AE%E6%AD%A3">🐛 常见错误与修正</a></li>
<li><a href="#-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B" title="#-%E5%AE%9E%E6%88%98%E5%BA%94%E7%94%A8%E6%A1%88%E4%BE%8B">💼 实战应用案例</a></li>
<li><a href="#-%E6%80%BB%E7%BB%93" title="#-%E6%80%BB%E7%BB%93">📚 总结</a></li>
</ul>
<hr/>
<h3 data-id="heading-3">🎯 前置知识点</h3>
<h4 data-id="heading-4">基础知识点（必须掌握）</h4>
<ul>
<li><strong>数据库表结构</strong>：理解表、字段、记录的概念</li>
<li><strong>数据类型</strong>：了解常见数据类型（整数、字符串、日期等）</li>
<li><strong>SQL 基础语法</strong>：理解 SQL 语句的基本结构</li>
<li><strong>WHERE 子句</strong>：掌握 WHERE 条件筛选的基本用法（参见 <a href="https://link.juejin.cn?target=.%2FS1D-SQL%2520WHERE%2520%25E6%259D%25A1%25E4%25BB%25B6%25E7%25AD%259B%25E9%2580%2589%25E5%25AE%258C%25E5%2585%25A8%25E6%258C%2587%25E5%258D%2597-99%2525%25E7%259A%2584%25E4%25BA%25BA%25E5%258F%25AA%25E4%25BC%259A%25E7%2594%25A8%25E7%25AD%2589%25E4%25BA%258E%25E5%2592%258C%25E5%25A4%25A7%25E4%25BA%258E%25EF%25BC%258CSQL%25E9%25AB%2598%25E6%2589%258B%25E5%258D%25B4%25E8%25BF%2599%25E6%25A0%25B7%25E5%2586%2599%25EF%25BC%259A%25E4%25BB%258E%25E5%259F%25BA%25E7%25A1%2580%25E8%25BF%2590%25E7%25AE%2597%25E7%25AC%25A6%25E5%2588%25B0%25E5%25A4%258D%25E6%259D%2582%25E6%259D%25A1%25E4%25BB%25B6%25E7%259A%2584%25E6%2595%25B0%25E6%258D%25AE%25E8%25BF%2587%25E6%25BB%25A4%25E5%2588%25A9%25E5%2599%25A8.md" target="_blank" title="./S1D-SQL%20WHERE%20%E6%9D%A1%E4%BB%B6%E7%AD%9B%E9%80%89%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97-99%25%E7%9A%84%E4%BA%BA%E5%8F%AA%E4%BC%9A%E7%94%A8%E7%AD%89%E4%BA%8E%E5%92%8C%E5%A4%A7%E4%BA%8E%EF%BC%8CSQL%E9%AB%98%E6%89%8B%E5%8D%B4%E8%BF%99%E6%A0%B7%E5%86%99%EF%BC%9A%E4%BB%8E%E5%9F%BA%E7%A1%80%E8%BF%90%E7%AE%97%E7%AC%A6%E5%88%B0%E5%A4%8D%E6%9D%82%E6%9D%A1%E4%BB%B6%E7%9A%84%E6%95%B0%E6%8D%AE%E8%BF%87%E6%BB%A4%E5%88%A9%E5%99%A8.md" ref="nofollow noopener noreferrer">S1D-SQL WHERE 条件筛选完全指南</a>）</li>
</ul>
<h4 data-id="heading-5">进阶知识点（建议了解）</h4>
<ul>
<li><strong>约束（constraint）</strong>：了解主键（primary key）、外键（foreign key）、唯一性约束（unique constraint）的作用</li>
<li><strong>子查询（subquery）</strong>：了解子查询的基本概念和使用方法</li>
<li><strong>多表关联（JOIN）</strong>：了解表与表之间的关联关系</li>
<li><strong>事务（transaction）</strong>：了解事务的基本概念，理解 COMMIT 和 ROLLBACK 的作用</li>
</ul>
<h4 data-id="heading-6">学习建议</h4>
<ul>
<li><strong>小白（零基础）</strong>：先理解表的基本概念，掌握 DELETE 的基本语法，重点理解 WHERE 子句的重要性</li>
<li><strong>初级（刚入门不久）</strong>：学会使用 DELETE 删除单条记录和多条记录，掌握 WHERE 条件的使用</li>
<li><strong>中级（入门一段时间）</strong>：掌握 DELETE 与子查询、多表关联删除、标记删除等高级技巧</li>
<li><strong>高级（资深开发者）</strong>：理解 DELETE 的性能优化、事务处理、数据归档等高级特性</li>
</ul>
<hr/>
<h3 data-id="heading-7">🔍 什么是 DELETE？</h3>
<h4 data-id="heading-8">核心概念</h4>
<p><strong>DELETE（删除）</strong> 是 SQL 中用于删除表中已存在记录的语句。</p>
<p><strong>生活化比喻</strong>：DELETE 就像从图书馆的书籍登记册（表）中删除某条记录。比如某本书已经丢失，需要从登记册中删除这条记录。DELETE 不会删除表结构，只会删除表中的数据记录。</p>
<p>让我们来理解一下 DELETE 语句的本质：它是对表中数据的删除操作，而不是对表结构的修改。</p>
<h4 data-id="heading-9">为什么需要 DELETE？</h4>
<h5 data-id="heading-10">❌ 不使用 DELETE 会怎样？</h5>
<p><strong>问题场景</strong>：学生表中某个学生已经退学，需要删除他的记录</p>
<p><strong>不使用 DELETE</strong>：</p>
<ul>
<li>无法删除已存在的数据</li>
<li>只能手动修改表结构（繁琐且容易出错）</li>
<li>无法批量删除多条记录</li>
<li>无法根据条件选择性删除</li>
</ul>
<h5 data-id="heading-11">✅ 使用 DELETE 的解决方案</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除学生表中 id 为 1 的学生的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 可以直接删除已存在的数据</li>
<li>✅ 操作简单，一条语句即可完成</li>
<li>✅ 可以批量删除多条记录</li>
<li>✅ 可以根据条件选择性删除</li>
<li>✅ 可以配合事务进行回滚操作</li>
</ul>
<hr/>
<h3 data-id="heading-12">❓ 问题描述</h3>
<h4 data-id="heading-13">真实场景</h4>
<p>想象一下这样的场景：你在一家电商公司工作，负责维护订单表。某天，产品经理告诉你："我们需要删除所有已取消且超过 30 天的订单记录。"</p>
<p><strong>新手做法</strong>：</p>
<ul>
<li>先查询所有符合条件的订单</li>
<li>一条一条手动删除每条记录</li>
<li>或者写一个循环，逐条删除</li>
</ul>
<p><strong>问题</strong>：</p>
<ul>
<li>效率低下，如果符合条件的订单有 10000 个，需要执行 10000 次删除操作</li>
<li>容易出错，可能漏掉某些订单</li>
<li>代码复杂，需要写循环逻辑</li>
<li><strong>最危险的是</strong>：如果忘记添加 WHERE 条件，会删除所有订单数据！</li>
</ul>
<p><strong>SQL 高手做法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 一条 DELETE 语句搞定</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'CANCELLED'</span> 
  <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&lt;</span> DATE_SUB(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">30</span> <span class="hljs-keyword">DAY</span>);
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 一条语句完成所有删除</li>
<li>✅ 效率高，数据库自动优化执行</li>
<li>✅ 不会漏掉任何符合条件的记录</li>
<li>✅ 代码简洁，易于维护</li>
<li>✅ 可以先用 SELECT 测试，确认无误后再执行 DELETE</li>
</ul>
<h4 data-id="heading-14">核心痛点</h4>
<ol>
<li><strong>忘记 WHERE 子句</strong>：99% 的人在执行 DELETE 时忘记添加 WHERE 条件，导致全表数据被误删</li>
<li><strong>不知道如何批量删除</strong>：面对大量数据需要删除时，不知道如何高效处理</li>
<li><strong>多表关联删除困难</strong>：需要根据其他表的数据来删除当前表时，不知道如何写 SQL</li>
<li><strong>性能问题</strong>：删除大量数据时，不知道如何优化性能</li>
<li><strong>数据恢复困难</strong>：误删数据后，不知道如何恢复</li>
</ol>
<hr/>
<h3 data-id="heading-15">🎯 问题考察点</h3>
<p>通过本文档的学习，你将掌握以下核心知识点：</p>
<h4 data-id="heading-16">基础能力 🔥 Must</h4>
<ol>
<li><strong>DELETE 基本语法</strong>：掌握 DELETE 语句的基本结构和语法规则</li>
<li><strong>WHERE 子句使用</strong>：理解 WHERE 子句的重要性，掌握条件筛选的写法</li>
<li><strong>单表删除</strong>：学会删除单条记录、多条记录，以及删除前检查的方法</li>
</ol>
<h4 data-id="heading-17">进阶能力 ⭐ Should</h4>
<ol start="4">
<li><strong>子查询删除</strong>：学会使用子查询来删除数据，理解 EXISTS 条件的重要性</li>
<li><strong>多表关联删除</strong>：掌握 MySQL、SQL Server 等不同数据库的多表关联删除语法</li>
<li><strong>标记删除</strong>：理解标记删除 vs 物理删除的区别，掌握标记删除的最佳实践</li>
</ol>
<h4 data-id="heading-18">高级能力 💡 Could</h4>
<ol start="7">
<li><strong>性能优化</strong>：了解 DELETE vs TRUNCATE、数据归档、分批删除、行锁优化等性能优化技巧</li>
<li><strong>不同数据库差异</strong>：了解 MySQL、Oracle、SQL Server、PostgreSQL 等数据库的语法差异</li>
<li><strong>实战应用</strong>：掌握各种实际业务场景下的 DELETE 应用技巧</li>
</ol>
<hr/>
<h3 data-id="heading-19">⚡ 快速上手 🔥 Must</h3>
<p>让我们通过一个最简单的例子来快速了解 DELETE 语句的使用方法。通过这个例子，我们可以快速理解 DELETE 语句的基本用法。</p>
<h4 data-id="heading-20">最简单的 DELETE 示例</h4>
<p>假设我们有一个学生表 <code>students</code>，现在需要删除 id 为 1 的学生的记录。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除学生表中 id 为 1 的学生的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>逐行代码解释</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- DELETE FROM 作用：指定要删除数据的表</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 

<span class="hljs-comment">-- WHERE 作用：指定删除条件，只删除 id 为 1 的记录</span>
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>执行结果</strong>：</p>
<ul>
<li>如果 id 为 1 的记录存在，则删除该记录</li>
<li>如果 id 为 1 的记录不存在，则不删除任何记录（不会报错）</li>
</ul>
<p><strong>重要提醒</strong>：⚠️ <strong>WHERE 子句非常重要！</strong> 如果省略 WHERE 子句，会删除表中的所有记录！详细说明请参见 <a href="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5" title="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5">DELETE 与 WHERE 子句</a> 章节。</p>
<hr/>
<h3 data-id="heading-21">🏗️ DELETE 基本语法 🔥 Must</h3>
<h4 data-id="heading-22">基本语法结构</h4>
<p><strong>标准语法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> table_name 
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">condition</span>;
</code></pre>
<p><strong>语法说明</strong>：</p>
<ul>
<li><code>DELETE FROM</code>：删除命令关键字</li>
<li><code>table_name</code>：要删除数据的表名</li>
<li><code>WHERE condition</code>：删除条件，用于指定哪些数据要删除（<strong>可选，但强烈建议使用</strong>）</li>
</ul>
<h4 data-id="heading-23">参数说明</h4>




















<table><thead><tr><th>参数</th><th>说明</th><th>是否必需</th></tr></thead><tbody><tr><td><code>table_name</code></td><td>要删除数据的表名</td><td>✅ 必需</td></tr><tr><td><code>WHERE condition</code></td><td>删除条件</td><td>⚠️ 可选，但强烈建议使用</td></tr></tbody></table>
<h4 data-id="heading-24">重要提醒</h4>
<p>⚠️ <strong>WHERE 子句的重要性</strong>和<strong>删除前检查</strong>的详细说明，请参见 <a href="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5" title="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5">DELETE 与 WHERE 子句</a> 章节。</p>
<hr/>
<h3 data-id="heading-25">📊 单表删除 🔥 Must</h3>
<h4 data-id="heading-26">删除单条记录</h4>
<p><strong>语法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> table_name 
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">condition</span>;
</code></pre>
<p><strong>示例 1：删除指定 ID 的记录</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除学生表中 id 为 1 的学生的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>示例 2：删除指定姓名的记录</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除学生表中姓名为"张三"的学生的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'张三'</span>;
</code></pre>
<p><strong>示例 3：删除指定条件的记录</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除学生表中成绩小于 60 分的学生的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
</code></pre>
<h4 data-id="heading-27">删除多条记录</h4>
<p><strong>语法</strong>：与删除单条记录相同，WHERE 条件匹配多条记录即可</p>
<p><strong>示例 1：删除符合条件的多条记录</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除学生表中成绩小于 60 分的所有学生的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
</code></pre>
<p><strong>示例 2：使用 IN 删除多条记录</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除学生表中 id 为 1、2、3 的学生的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">IN</span> (<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);
</code></pre>
<p><strong>示例 3：使用 BETWEEN 删除范围内的记录</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除学生表中 id 在 1 到 100 之间的学生的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">100</span>;
</code></pre>
<h4 data-id="heading-28">删除所有记录</h4>
<p><strong>语法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> table_name;
</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除学生表中的所有记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students;
</code></pre>
<p><strong>重要提醒</strong>：</p>
<ul>
<li>⚠️ <strong>这会删除表中的所有记录！</strong></li>
<li>⚠️ <strong>表结构、属性和索引将保持不变</strong></li>
<li>⚠️ <strong>如果要删除所有记录，建议使用 TRUNCATE TABLE（性能更好）</strong></li>
</ul>
<p><strong>TRUNCATE vs DELETE</strong>：</p>
<ul>
<li><code>TRUNCATE TABLE</code> 比 <code>DELETE</code> 更快</li>
<li><code>TRUNCATE TABLE</code> 使用较少的系统和事务日志资源</li>
<li><code>TRUNCATE TABLE</code> 不能回滚（某些数据库）</li>
</ul>
<hr/>
<h3 data-id="heading-29">🔍 DELETE 与 WHERE 子句 🔥 Must</h3>
<h4 data-id="heading-30">WHERE 子句的重要性</h4>
<p><strong>WHERE 子句是 DELETE 语句的核心</strong>，它决定了哪些记录会被删除。我们来深入理解一下 WHERE 子句的重要性。</p>
<p><strong>重要原则</strong>：</p>
<ul>
<li>✅ <strong>始终使用 WHERE 子句</strong>：除非你真的想删除所有记录</li>
<li>✅ <strong>删除前检查</strong>：先用 SELECT 测试 WHERE 条件</li>
<li>✅ <strong>条件要精确</strong>：确保 WHERE 条件准确匹配要删除的记录</li>
</ul>
<h4 data-id="heading-31">使用单个条件</h4>
<p><strong>示例 1：使用等于条件</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除 id 为 1 的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>示例 2：使用大于条件</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除 id 大于 100 的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>;
</code></pre>
<p><strong>示例 3：使用 LIKE 条件</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除姓名以"张"开头的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'张%'</span>;
</code></pre>
<h4 data-id="heading-32">使用多个条件</h4>
<p><strong>示例 1：使用 AND 连接多个条件</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除成绩小于 60 分且年龄大于 20 岁的学生的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span> <span class="hljs-keyword">AND</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">20</span>;
</code></pre>
<p><strong>示例 2：使用 OR 连接多个条件</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除成绩小于 60 分或年龄大于 25 岁的学生的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span> <span class="hljs-keyword">OR</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">25</span>;
</code></pre>
<p><strong>示例 3：使用 NOT 条件</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除成绩不小于 60 分的学生的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
</code></pre>
<h4 data-id="heading-33">使用 NULL 条件</h4>
<p><strong>示例 1：删除 NULL 值</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除 email 为 NULL 的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;
</code></pre>
<p><strong>示例 2：删除非 NULL 值</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除 email 不为 NULL 的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>;
</code></pre>
<h4 data-id="heading-34">删除前检查的最佳实践</h4>
<p><strong>建议流程</strong>：</p>
<ol>
<li><strong>第一步：先用 SELECT 查看会删除哪些记录</strong></li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看要删除的记录</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
</code></pre>
<ol start="2">
<li><strong>第二步：确认记录数量和内容</strong></li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看要删除的记录数量</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
</code></pre>
<ol start="3">
<li><strong>第三步：确认无误后，再执行 DELETE</strong></li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 执行删除</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
</code></pre>
<hr/>
<h3 data-id="heading-35">🔗 DELETE 与子查询 ⭐ Should</h3>
<h4 data-id="heading-36">基于子查询删除</h4>
<p>让我们来看看如何使用子查询来删除数据。通过子查询，我们可以根据其他表的数据来决定要删除哪些记录。</p>
<p><strong>语法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> table_name 
<span class="hljs-keyword">WHERE</span> column_name <span class="hljs-keyword">IN</span> (<span class="hljs-keyword">SELECT</span> column_name <span class="hljs-keyword">FROM</span> other_table <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">condition</span>);
</code></pre>
<p><strong>示例 1：基于另一个表的数据删除</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除销售人员的配额历史记录，这些销售人员的年度销售额超过 2500000</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> Sales.SalesPersonQuotaHistory   
<span class="hljs-keyword">WHERE</span> BusinessEntityID <span class="hljs-keyword">IN</span>   
    (<span class="hljs-keyword">SELECT</span> BusinessEntityID   
     <span class="hljs-keyword">FROM</span> Sales.SalesPerson   
     <span class="hljs-keyword">WHERE</span> SalesYTD <span class="hljs-operator">&gt;</span> <span class="hljs-number">2500000.00</span>);
</code></pre>
<p><strong>示例 2：使用 EXISTS 条件删除</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除存在关联订单的客户记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> customers 
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> 
    <span class="hljs-keyword">FROM</span> orders 
    <span class="hljs-keyword">WHERE</span> orders.customer_id <span class="hljs-operator">=</span> customers.id
);
</code></pre>
<h4 data-id="heading-37">使用 EXISTS 的优势</h4>
<p><strong>EXISTS vs IN</strong>：</p>
<ul>
<li><code>EXISTS</code> 通常比 <code>IN</code> 性能更好</li>
<li><code>EXISTS</code> 在找到第一个匹配项后就会停止搜索</li>
<li><code>IN</code> 需要先执行子查询，然后进行匹配</li>
</ul>
<p><strong>示例：使用 EXISTS 优化删除</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用 EXISTS 删除存在关联订单的客户记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> customers 
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> 
    <span class="hljs-keyword">FROM</span> orders 
    <span class="hljs-keyword">WHERE</span> orders.customer_id <span class="hljs-operator">=</span> customers.id
      <span class="hljs-keyword">AND</span> orders.status <span class="hljs-operator">=</span> <span class="hljs-string">'CANCELLED'</span>
);
</code></pre>
<hr/>
<h3 data-id="heading-38">🔀 DELETE 与 JOIN ⭐ Should</h3>
<h4 data-id="heading-39">MySQL 多表关联删除</h4>
<p><strong>语法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> t1 <span class="hljs-keyword">FROM</span> table1 t1
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> table2 t2 <span class="hljs-keyword">ON</span> t1.id <span class="hljs-operator">=</span> t2.id
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">condition</span>;
</code></pre>
<p><strong>示例 1：使用 INNER JOIN 删除</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除销售人员的配额历史记录，这些销售人员的年度销售额超过 4500000</span>
<span class="hljs-keyword">DELETE</span> sq
<span class="hljs-keyword">FROM</span> Sales.SalesPersonQuotaHistory sq
     <span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> Sales.SalesPerson sp <span class="hljs-keyword">ON</span> sq.BusinessEntityID <span class="hljs-operator">=</span> sp.BusinessEntityID
<span class="hljs-keyword">WHERE</span> sp.SalesYTD <span class="hljs-operator">&gt;</span> <span class="hljs-number">4500000.00</span>;
</code></pre>
<p><strong>示例 2：使用 LEFT JOIN 删除</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除没有关联订单的客户记录</span>
<span class="hljs-keyword">DELETE</span> c
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.id <span class="hljs-operator">=</span> o.customer_id
<span class="hljs-keyword">WHERE</span> o.id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;
</code></pre>
<h4 data-id="heading-40">SQL Server 多表关联删除</h4>
<p><strong>语法 1：使用 FROM 子句</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> table1
<span class="hljs-keyword">FROM</span> table1
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> table2 <span class="hljs-keyword">ON</span> table1.id <span class="hljs-operator">=</span> table2.id
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">condition</span>;
</code></pre>
<p><strong>语法 2：使用 DELETE 别名</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> t1
<span class="hljs-keyword">FROM</span> table1 t1
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> table2 t2 <span class="hljs-keyword">ON</span> t1.id <span class="hljs-operator">=</span> t2.id
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">condition</span>;
</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除销售人员的配额历史记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> Sales.SalesPersonQuotaHistory
<span class="hljs-keyword">FROM</span> Sales.SalesPersonQuotaHistory <span class="hljs-keyword">AS</span> spqh
<span class="hljs-keyword">INNER</span> <span class="hljs-keyword">JOIN</span> Sales.SalesPerson <span class="hljs-keyword">AS</span> sp
<span class="hljs-keyword">ON</span> spqh.BusinessEntityID <span class="hljs-operator">=</span> sp.BusinessEntityID
<span class="hljs-keyword">WHERE</span> sp.SalesYTD <span class="hljs-operator">&gt;</span> <span class="hljs-number">2500000.00</span>;
</code></pre>
<hr/>
<h3 data-id="heading-41">🌐 不同数据库语法差异 💡 Could</h3>
<h4 data-id="heading-42">MySQL</h4>
<p><strong>特点</strong>：</p>
<ul>
<li>支持使用 <code>LIMIT</code> 限制删除的行数</li>
<li>可以通过设置 <code>sql_safe_updates</code> 强制要求 WHERE 条件</li>
<li>DELETE 语句会返回删除的行数</li>
</ul>
<p><strong>安全模式设置</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 开启安全更新模式，强制要求 WHERE 条件</span>
<span class="hljs-keyword">SET</span> sql_safe_updates <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>使用 LIMIT 删除</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除前 100 条符合条件的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>
LIMIT <span class="hljs-number">100</span>;
</code></pre>
<p><strong>返回结果示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除 id=1 的记录</span>
mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span>;
Query OK, <span class="hljs-number">1</span> <span class="hljs-type">row</span> affected (<span class="hljs-number">0.00</span> sec)
<span class="hljs-keyword">Rows</span> matched: <span class="hljs-number">1</span>  Changed: <span class="hljs-number">1</span>  Warnings: <span class="hljs-number">0</span>

<span class="hljs-comment">-- 删除 id=999 的记录（不存在）</span>
mysql<span class="hljs-operator">&gt;</span> <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">WHERE</span> id<span class="hljs-operator">=</span><span class="hljs-number">999</span>;
Query OK, <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span> affected (<span class="hljs-number">0.00</span> sec)
<span class="hljs-keyword">Rows</span> matched: <span class="hljs-number">0</span>  Changed: <span class="hljs-number">0</span>  Warnings: <span class="hljs-number">0</span>
</code></pre>
<h4 data-id="heading-43">SQL Server</h4>
<p><strong>特点</strong>：</p>
<ul>
<li>支持使用 <code>TOP</code> 限制删除的行数</li>
<li>支持使用 <code>OUTPUT</code> 子句返回删除的行</li>
<li>支持使用 CTE（公用表表达式）</li>
<li>支持使用游标进行定位删除</li>
</ul>
<p><strong>TOP 语法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> TOP (<span class="hljs-number">20</span>) <span class="hljs-keyword">FROM</span> table_name <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">condition</span>;
</code></pre>
<p><strong>OUTPUT 语法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> table_name
OUTPUT DELETED.<span class="hljs-operator">*</span>
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">condition</span>;
</code></pre>
<p><strong>示例：使用 OUTPUT 返回删除的行</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除并返回删除的行</span>
<span class="hljs-keyword">DELETE</span> Sales.ShoppingCartItem  
OUTPUT DELETED.<span class="hljs-operator">*</span>   
<span class="hljs-keyword">WHERE</span> ShoppingCartID <span class="hljs-operator">=</span> <span class="hljs-number">20621</span>;
</code></pre>
<h4 data-id="heading-44">Oracle</h4>
<p><strong>特点</strong>：</p>
<ul>
<li>支持使用 <code>ROWNUM</code> 限制删除的行数</li>
<li>语法相对标准</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> table_name
<span class="hljs-keyword">WHERE</span> ROWNUM <span class="hljs-operator">&lt;=</span> <span class="hljs-number">100</span>;
</code></pre>
<h4 data-id="heading-45">PostgreSQL</h4>
<p><strong>特点</strong>：</p>
<ul>
<li>语法相对标准</li>
<li>支持 <code>RETURNING</code> 子句返回删除的行</li>
</ul>
<p><strong>RETURNING 语法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> table_name
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">condition</span>
RETURNING <span class="hljs-operator">*</span>;
</code></pre>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除并返回删除的行</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>
RETURNING <span class="hljs-operator">*</span>;
</code></pre>
<hr/>
<h3 data-id="heading-46">⚠️ 注意事项和警告</h3>
<h4 data-id="heading-47">WHERE 子句的重要性</h4>
<p>⚠️ <strong>重要警告</strong>：在删除记录时要格外小心！因为您不能重来！</p>
<p><strong>核心要点</strong>：</p>
<ul>
<li>如果省略 WHERE 子句，所有的记录都将被删除！</li>
<li>执行没有 WHERE 子句的 DELETE 要慎重，再慎重！</li>
</ul>
<p><strong>详细说明和最佳实践</strong>，请参见 <a href="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5" title="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5">DELETE 与 WHERE 子句</a> 章节。</p>
<h4 data-id="heading-48">删除前检查</h4>
<p><strong>建议</strong>：始终建议从 SELECT 语句开始，然后再删除任何内容，以确保定位的是正确的记录。</p>
<p><strong>详细检查方法和最佳实践</strong>，请参见 <a href="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5" title="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5">DELETE 与 WHERE 子句</a> 章节中的"删除前检查的最佳实践"小节。</p>
<h4 data-id="heading-49">外键约束的影响</h4>
<p><strong>说明</strong>：</p>
<ul>
<li>大多数数据库系统都支持外键约束，因此当删除表中的一行时，外键表中的行也会自动删除（如果设置了 CASCADE）</li>
<li>从逻辑上讲，如果不引用员工，就不能存在依赖关系。换句话说，当删除员工信息时，他/她的家属也必须要删除</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除员工及其相关依赖</span>
<span class="hljs-keyword">DELETE</span>
<span class="hljs-keyword">FROM</span> employees
<span class="hljs-keyword">WHERE</span> employee_id <span class="hljs-operator">=</span> <span class="hljs-number">199</span>;

<span class="hljs-keyword">DELETE</span>
<span class="hljs-keyword">FROM</span> dependents
<span class="hljs-keyword">WHERE</span> employee_id <span class="hljs-operator">=</span> <span class="hljs-number">199</span>;
</code></pre>
<p><strong>注意</strong>：</p>
<ul>
<li>如果表之间存在外键关系，删除主表记录时可能会影响从表记录</li>
<li>需要根据外键约束的配置（CASCADE、SET NULL 等）来处理</li>
</ul>
<h4 data-id="heading-50">事务处理</h4>
<p><strong>使用事务确保数据一致性</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 开始事务</span>
<span class="hljs-keyword">START</span> TRANSACTION;

<span class="hljs-comment">-- 执行删除操作</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">80</span>;

<span class="hljs-comment">-- 检查删除结果</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&gt;=</span> <span class="hljs-number">80</span>;

<span class="hljs-comment">-- 如果结果正确，提交事务</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 如果结果不正确，回滚事务</span>
<span class="hljs-comment">-- ROLLBACK;</span>
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 确保数据一致性</li>
<li>✅ 可以回滚错误的删除</li>
<li>✅ 保证原子性操作</li>
</ul>
<h4 data-id="heading-51">回滚操作</h4>
<p><strong>说明</strong>：</p>
<ul>
<li>由于 DELETE 语句是 DML 操作，它可以在语句中执行时回滚</li>
<li>如果您意外删除记录或需要重复该过程，可以使用 ROLLBACK 命令</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">START</span> TRANSACTION;
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
<span class="hljs-comment">-- 如果需要，可以回滚删除</span>
<span class="hljs-keyword">ROLLBACK</span>;
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>ROLLBACK 命令将撤销 DELETE 语句所做的更改，有效地恢复在事务期间删除的记录</li>
</ul>
<h4 data-id="heading-52">无匹配记录的处理</h4>
<p><strong>说明</strong>：</p>
<ul>
<li>如果 WHERE 条件没有匹配到任何记录，DELETE 语句不会报错，也不会有任何记录被删除</li>
</ul>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除 id 为 999 的记录（假设不存在）</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">999</span>;
</code></pre>
<p><strong>执行结果</strong>：</p>
<ul>
<li>不会报错</li>
<li>不会删除任何记录</li>
<li>MySQL 会返回 <code>Rows matched: 0  Changed: 0</code></li>
</ul>
<p><strong>建议</strong>：</p>
<ul>
<li>如果需要确认是否有记录被删除，可以检查 DELETE 语句的返回结果</li>
</ul>
<h4 data-id="heading-53">触发器的影响</h4>
<p><strong>说明</strong>：</p>
<ul>
<li>DELETE 语句可能会因为违反触发器或尝试删除另一个表中具有 FOREIGN KEY 约束的数据引用的行而失败</li>
<li>如果 DELETE 删除多行，并且任何被删除的行违反触发器或约束，则语句被取消，返回错误，并且不删除任何行</li>
</ul>
<h4 data-id="heading-54">错误处理</h4>
<p><strong>使用 TRY...CATCH 处理错误（SQL Server）</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">BEGIN</span> TRY
    <span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> table_name <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">condition</span>;
<span class="hljs-keyword">END</span> TRY
<span class="hljs-keyword">BEGIN</span> CATCH
    <span class="hljs-comment">-- 错误处理逻辑</span>
    <span class="hljs-keyword">SELECT</span> ERROR_MESSAGE();
<span class="hljs-keyword">END</span> CATCH;
</code></pre>
<hr/>
<h3 data-id="heading-55">🚀 性能优化 💡 Could</h3>
<h4 data-id="heading-56">DELETE vs TRUNCATE</h4>
<p>我们来对比一下 DELETE 和 TRUNCATE 的区别，这对于性能优化非常重要。</p>
<p><strong>区别说明</strong>：</p>
<ol>
<li><strong>对于删除整个表的所有数据时，DELETE 并不会释放表所占用的空间</strong></li>
<li><strong>如果用户确定是删除整表的所有数据，那么使用 TRUNCATE TABLE 速度更快</strong></li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 删除所有部门信息:使用 DELETE</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> table_name;

<span class="hljs-comment">-- 删除所有部门信息:使用 TRUNCATE</span>
<span class="hljs-keyword">TRUNCATE</span> <span class="hljs-keyword">TABLE</span> table_name;
</code></pre>
<p><strong>TRUNCATE TABLE 的优势</strong>：</p>
<ul>
<li>✅ TRUNCATE TABLE 比 DELETE 更快</li>
<li>✅ TRUNCATE TABLE 使用较少的系统和事务日志资源</li>
<li>✅ TRUNCATE TABLE 有限制，例如，表不能参与复制</li>
</ul>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>要删除表中的所有行，请使用 TRUNCATE TABLE</li>
<li>TRUNCATE TABLE 比 DELETE 更快，并且使用较少的系统和事务日志资源</li>
</ul>
<h4 data-id="heading-57">标记删除 vs 物理删除</h4>
<p>让我们来理解一下标记删除和物理删除的区别。这是实际开发中非常重要的最佳实践。</p>
<p><strong>问题</strong>：</p>
<ul>
<li>通过从 InnoDB 存储空间分布，DELETE 对性能的影响可以看到，DELETE 物理删除既不能释放磁盘空间，而且会产生大量的碎片，导致索引频繁分裂，影响 SQL 执行计划的稳定性</li>
<li>同时在碎片回收时，会耗用大量的 CPU，磁盘空间，影响表上正常的 DML 操作</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>在业务代码层面，应该做逻辑标记删除，避免物理删除</li>
</ul>
<p><strong>实现方式</strong>：</p>
<ul>
<li>在 MySQL 数据库建模规范中有 4 个公共字段，基本上每个表必须有的，同时在 create_time 列要创建索引</li>
</ul>
<p><strong>字段定义</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">`id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'主键id'</span>,
`is_deleted` tinyint(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'是否逻辑删除：0：未删除，1：已删除'</span>,
`create_time` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'创建时间'</span>,
`update_time` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'修改时间'</span>
</code></pre>
<p><strong>使用方式</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 有了删除标记，业务接口的 DELETE 操作就可以转换为 UPDATE</span>
<span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">SET</span> is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1213</span>;

<span class="hljs-comment">-- 查询的时候需要带上 is_deleted 过滤</span>
<span class="hljs-keyword">SELECT</span> id, age, phone <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> name <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'lyn12%'</span>;
</code></pre>
<h4 data-id="heading-58">数据归档方式</h4>
<p><strong>通用数据归档方法</strong>：</p>
<p><strong>步骤 1：创建归档表</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `ota_order_bak` (
  <span class="hljs-comment">-- 表结构定义</span>
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (to_days(create_time)) ( 
  <span class="hljs-keyword">PARTITION</span> p201808 <span class="hljs-keyword">VALUES</span> LESS THAN (to_days(<span class="hljs-string">'2018-09-01'</span>)), 
  <span class="hljs-comment">-- 更多分区...</span>
);
</code></pre>
<p><strong>步骤 2：插入原表中无效的数据</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> tbl_p201808 <span class="hljs-keyword">AS</span> 
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> ota_order 
<span class="hljs-keyword">WHERE</span> create_time <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2018-08-01 00:00:00'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2018-08-31 23:59:59'</span>;
</code></pre>
<p><strong>步骤 3：跟归档表分区做分区交换</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> ota_order_bak EXCHANGE <span class="hljs-keyword">PARTITION</span> p201808 <span class="hljs-keyword">WITH</span> <span class="hljs-keyword">TABLE</span> tbl_p201808;
</code></pre>
<p><strong>步骤 4：删除原表中已经归档的数据</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> ota_order 
<span class="hljs-keyword">WHERE</span> create_time <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2018-08-01 00:00:00'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2018-08-31 23:59:59'</span> 
LIMIT <span class="hljs-number">3000</span>;
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>这样原表和归档表都是按月的分区表，只需要创建一个中间普通表，在业务低峰期做两次分区交换，既可以删除无效数据，又能回收空间，而且没有空间碎片，不会影响表上的索引及 SQL 的执行计划</li>
</ul>
<h4 data-id="heading-59">分批删除</h4>
<p><strong>当需要删除大量数据时，可以分批进行删除，避免一次性删除过多数据影响性能</strong></p>
<p><strong>方式 1：使用 LIMIT 分批删除（MySQL）</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 每次只删除 1000 条</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">80</span>
LIMIT <span class="hljs-number">1000</span>;
</code></pre>
<p><strong>方式 2：使用循环分批删除</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 第一次删除 id 1-1000</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">80</span> <span class="hljs-keyword">AND</span> id <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">1000</span>;

<span class="hljs-comment">-- 第二次删除 id 1001-2000</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">80</span> <span class="hljs-keyword">AND</span> id <span class="hljs-keyword">BETWEEN</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> <span class="hljs-number">2000</span>;
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 减少锁表时间</li>
<li>✅ 降低对数据库性能的影响</li>
<li>✅ 可以随时中断和恢复</li>
</ul>
<h4 data-id="heading-60">行锁优化</h4>
<p><strong>在 MySQL 中，当执行 <code>DELETE xxxx WHERE topic_id = xxx</code> 时，MySQL 会对 topic_id 索引加行锁</strong></p>
<p><strong>问题场景</strong>：</p>
<ul>
<li>在高并发场景下，如果多个操作在同一个事务中，行锁的持有时间会延长</li>
<li>可以通过调整操作顺序来降低行锁的持有粒度</li>
</ul>
<p><strong>优化示例</strong>：</p>
<p>原逻辑（性能较差）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">START</span> TRANSACTION;
<span class="hljs-comment">-- 第一步：DELETE（加行锁）</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> topics <span class="hljs-keyword">WHERE</span> topic_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-comment">-- 第二步：INSERT（行锁一直持有，直到事务结束）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> results (topic_id, <span class="hljs-keyword">result</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'AC'</span>);
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<p>优化后（性能更好）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">START</span> TRANSACTION;
<span class="hljs-comment">-- 第一步：INSERT（不加行锁或加锁时间短）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> results (topic_id, <span class="hljs-keyword">result</span>) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">'AC'</span>);
<span class="hljs-comment">-- 第二步：DELETE（行锁持有时间短）</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> topics <span class="hljs-keyword">WHERE</span> topic_id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<h4 data-id="heading-61">索引的使用</h4>
<p><strong>对于 DELETE 语句中涉及的列，确保相应的列上建有索引，以提高检索速度</strong></p>
<p><strong>注意事项</strong>：</p>
<ul>
<li>WHERE 条件中的字段应该有索引</li>
<li>但索引也会影响 DELETE 的性能（需要更新索引）</li>
<li>需要权衡查询速度和删除速度</li>
</ul>
<h4 data-id="heading-62">大数据删除的注意事项</h4>
<p><strong>大数据删除要注意</strong>：</p>
<ul>
<li>✅ <strong>索引</strong>：确保 WHERE 条件字段有索引</li>
<li>✅ <strong>分批删除</strong>：避免一次性删除过多数据</li>
<li>✅ <strong>事务</strong>：使用事务确保数据一致性</li>
</ul>
<p><strong>重要提醒</strong>：</p>
<ul>
<li>⚠️ 如果删除条件不精准，可能导致大面积锁表，影响其他业务</li>
</ul>
<hr/>
<h3 data-id="heading-63">🆚 对比示例 ⭐ Should</h3>
<h4 data-id="heading-64">不使用 DELETE vs 使用 DELETE</h4>
<p><strong>场景</strong>：需要删除学生表中成绩小于 60 分的所有记录</p>
<p><strong>❌ 不使用 DELETE（手动删除）</strong>：</p>
<ul>
<li>需要先查询所有符合条件的记录</li>
<li>然后逐条手动删除</li>
<li>效率低下，容易出错</li>
</ul>
<p><strong>✅ 使用 DELETE（一条语句搞定）</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 一条 DELETE 语句完成所有删除</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 操作简单，一条语句即可完成</li>
<li>✅ 效率高，数据库自动优化执行</li>
<li>✅ 不会漏掉任何符合条件的记录</li>
<li>✅ 代码简洁，易于维护</li>
</ul>
<h4 data-id="heading-65">错误写法 vs 正确写法</h4>
<p><strong>❌ 错误写法 1：忘记 WHERE 子句</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 危险！这会删除所有记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students;
</code></pre>
<p><strong>✅ 正确写法 1：始终使用 WHERE 子句</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 正确：指定删除条件</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>❌ 错误写法 2：删除前不检查</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 危险！可能删除错误的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
</code></pre>
<p><strong>✅ 正确写法 2：删除前先检查</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 第一步：先查询要删除的记录</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;

<span class="hljs-comment">-- 第二步：确认无误后，再执行删除</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
</code></pre>
<p><strong>❌ 错误写法 3：不使用事务</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 危险！如果删除出错，无法回滚</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
</code></pre>
<p><strong>✅ 正确写法 3：使用事务确保安全</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 开始事务</span>
<span class="hljs-keyword">START</span> TRANSACTION;

<span class="hljs-comment">-- 执行删除操作</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;

<span class="hljs-comment">-- 检查删除结果</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&gt;=</span> <span class="hljs-number">60</span>;

<span class="hljs-comment">-- 如果结果正确，提交事务</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 如果结果不正确，回滚事务</span>
<span class="hljs-comment">-- ROLLBACK;</span>
</code></pre>
<h4 data-id="heading-66">物理删除 vs 标记删除</h4>
<p><strong>❌ 物理删除（不推荐）</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 直接删除记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1213</span>;
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>❌ 无法恢复数据</li>
<li>❌ 会产生大量碎片</li>
<li>❌ 影响性能</li>
</ul>
<p><strong>✅ 标记删除（推荐）</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用标记删除</span>
<span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">SET</span> is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1213</span>;

<span class="hljs-comment">-- 查询时过滤已删除的记录</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 可以恢复数据</li>
<li>✅ 不会产生碎片</li>
<li>✅ 性能更好</li>
</ul>
<hr/>
<h3 data-id="heading-67">🐛 常见错误与修正 🔥 Must</h3>
<h4 data-id="heading-68">错误 1：忘记 WHERE 子句</h4>
<p><strong>错误现象</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 危险！这会删除所有记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students;
</code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>这是最常见的错误，99% 的人会犯这个错误</li>
<li>如果省略 WHERE 子句，所有记录都将被删除</li>
</ul>
<p><strong>修正方法和预防措施</strong>，请参见 <a href="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5" title="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5">DELETE 与 WHERE 子句</a> 章节。</p>
<h4 data-id="heading-69">错误 2：删除前不检查</h4>
<p><strong>错误现象</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 危险！可能删除错误的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
</code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>没有先查询要删除的记录，直接执行删除</li>
<li>可能删除错误的记录，无法恢复</li>
</ul>
<p><strong>修正方法和预防措施</strong>，请参见 <a href="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5" title="#-delete-%E4%B8%8E-where-%E5%AD%90%E5%8F%A5">DELETE 与 WHERE 子句</a> 章节中的"删除前检查的最佳实践"小节。</p>
<h4 data-id="heading-70">错误 3：条件不精确</h4>
<p><strong>错误现象</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 危险！可能删除错误的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'张'</span>;
</code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>条件不精确，可能匹配到多条记录</li>
<li>如果只想删除一条记录，应该使用唯一标识（如 id）</li>
</ul>
<p><strong>修正方法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ✅ 正确：使用唯一标识删除</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- ✅ 或者：使用更精确的条件</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> name <span class="hljs-operator">=</span> <span class="hljs-string">'张三'</span> <span class="hljs-keyword">AND</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>预防措施</strong>：</p>
<ul>
<li>尽量使用唯一标识（如主键）删除</li>
<li>如果使用非唯一字段，确保条件足够精确</li>
<li>删除前先查询，确认匹配的记录数量</li>
</ul>
<h4 data-id="heading-71">错误 4：不使用事务</h4>
<p><strong>错误现象</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 危险！如果删除出错，无法回滚</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
</code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>没有使用事务，如果删除出错，无法回滚</li>
<li>对于重要的数据删除操作，应该使用事务</li>
</ul>
<p><strong>修正方法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ✅ 正确：使用事务确保安全</span>
<span class="hljs-keyword">START</span> TRANSACTION;

<span class="hljs-comment">-- 执行删除操作</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;

<span class="hljs-comment">-- 检查删除结果</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> students <span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&gt;=</span> <span class="hljs-number">60</span>;

<span class="hljs-comment">-- 如果结果正确，提交事务</span>
<span class="hljs-keyword">COMMIT</span>;

<span class="hljs-comment">-- 如果结果不正确，回滚事务</span>
<span class="hljs-comment">-- ROLLBACK;</span>
</code></pre>
<p><strong>预防措施</strong>：</p>
<ul>
<li>对于重要的数据删除操作，始终使用事务</li>
<li>删除后检查结果，确认无误后再提交</li>
<li>如果结果不正确，立即回滚</li>
</ul>
<h4 data-id="heading-72">错误 5：性能问题</h4>
<p><strong>错误现象</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 性能问题：一次性删除大量数据</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>;
<span class="hljs-comment">-- 如果符合条件的记录有 100 万条，这会很慢</span>
</code></pre>
<p><strong>问题分析</strong>：</p>
<ul>
<li>一次性删除大量数据，会导致锁表时间过长</li>
<li>影响其他业务的正常执行</li>
</ul>
<p><strong>修正方法</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ✅ 正确：分批删除</span>
<span class="hljs-comment">-- 每次只删除 1000 条</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> score <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span>
LIMIT <span class="hljs-number">1000</span>;

<span class="hljs-comment">-- 重复执行，直到删除完成</span>
</code></pre>
<p><strong>预防措施</strong>：</p>
<ul>
<li>对于大量数据的删除，使用分批删除</li>
<li>在业务低峰期执行删除操作</li>
<li>监控删除进度，确保不影响其他业务</li>
</ul>
<hr/>
<h3 data-id="heading-73">💼 实战应用案例 ⭐ Should</h3>
<h4 data-id="heading-74">案例 1：删除过期订单</h4>
<p><strong>场景</strong>：删除所有已取消且超过 30 天的订单记录</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 第一步：先查询要删除的记录</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'CANCELLED'</span> 
  <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&lt;</span> DATE_SUB(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">30</span> <span class="hljs-keyword">DAY</span>);

<span class="hljs-comment">-- 第二步：确认无误后，执行删除</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'CANCELLED'</span> 
  <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&lt;</span> DATE_SUB(NOW(), <span class="hljs-type">INTERVAL</span> <span class="hljs-number">30</span> <span class="hljs-keyword">DAY</span>);
</code></pre>
<p><strong>优化建议</strong>：</p>
<ul>
<li>如果订单数量很大，建议分批删除</li>
<li>在业务低峰期执行删除操作</li>
<li>使用事务确保数据一致性</li>
</ul>
<h4 data-id="heading-75">案例 2：删除无效用户</h4>
<p><strong>场景</strong>：删除所有注册但从未登录的用户记录</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用子查询删除</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> users 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> user_id 
    <span class="hljs-keyword">FROM</span> login_logs
);
</code></pre>
<p><strong>或者使用 EXISTS</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用 EXISTS 删除（性能更好）</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> users 
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">EXISTS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> 
    <span class="hljs-keyword">FROM</span> login_logs 
    <span class="hljs-keyword">WHERE</span> login_logs.user_id <span class="hljs-operator">=</span> users.id
);
</code></pre>
<h4 data-id="heading-76">案例 3：删除重复数据</h4>
<p><strong>场景</strong>：删除学生表中的重复记录（保留 id 最小的记录）</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用子查询删除重复记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> students 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">MIN</span>(id) 
    <span class="hljs-keyword">FROM</span> students 
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> name, email
);
</code></pre>
<p><strong>或者使用窗口函数（SQL Server）</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用 CTE 和 ROW_NUMBER() 删除重复记录</span>
<span class="hljs-keyword">WITH</span> CTE <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>, 
           <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span>(<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> name, email <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> id) <span class="hljs-keyword">AS</span> Row_Num
    <span class="hljs-keyword">FROM</span> students
)
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> CTE
<span class="hljs-keyword">WHERE</span> Row_Num <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>;
</code></pre>
<h4 data-id="heading-77">案例 4：多表关联删除</h4>
<p><strong>场景</strong>：删除所有没有订单的客户记录</p>
<p><strong>解决方案（MySQL）</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用 LEFT JOIN 删除</span>
<span class="hljs-keyword">DELETE</span> c
<span class="hljs-keyword">FROM</span> customers c
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o <span class="hljs-keyword">ON</span> c.id <span class="hljs-operator">=</span> o.customer_id
<span class="hljs-keyword">WHERE</span> o.id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;
</code></pre>
<p><strong>解决方案（SQL Server）</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用子查询删除</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> customers 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">DISTINCT</span> customer_id 
    <span class="hljs-keyword">FROM</span> orders
);
</code></pre>
<h4 data-id="heading-78">案例 5：标记删除实现</h4>
<p><strong>场景</strong>：实现软删除（标记删除），而不是物理删除</p>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 第一步：在表中添加 is_deleted 字段</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users 
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> is_deleted TINYINT(<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> 
COMMENT <span class="hljs-string">'是否删除：0-未删除，1-已删除'</span>;

<span class="hljs-comment">-- 第二步：删除操作改为更新操作</span>
<span class="hljs-keyword">UPDATE</span> users 
<span class="hljs-keyword">SET</span> is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">1</span> 
<span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-comment">-- 第三步：查询时过滤已删除的记录</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users 
<span class="hljs-keyword">WHERE</span> is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>✅ 可以恢复数据</li>
<li>✅ 不会产生碎片</li>
<li>✅ 性能更好</li>
<li>✅ 可以记录删除时间</li>
</ul>
<hr/>
<h3 data-id="heading-79">📚 总结</h3>
<p>通过本文档的学习，我们掌握了 SQL DELETE 语句的核心技能。让我们来总结一下关键要点：</p>
<h4 data-id="heading-80">核心要点回顾</h4>
<ol>
<li><strong>WHERE 子句的重要性</strong>：⚠️ 这是 DELETE 语句最核心的要点，99% 的人会忘记 WHERE 子句，导致全表数据被误删</li>
<li><strong>删除前检查</strong>：✅ 始终建议从 SELECT 语句开始，然后再删除任何内容，以确保定位的是正确的记录</li>
<li><strong>标记删除 vs 物理删除</strong>：✅ 在业务代码层面，应该做逻辑标记删除，避免物理删除</li>
<li><strong>性能优化</strong>：✅ 对于大量数据的删除，使用分批删除、数据归档等方式优化性能</li>
<li><strong>事务处理</strong>：✅ 对于重要的数据删除操作，始终使用事务，确保数据一致性</li>
</ol>
<h4 data-id="heading-81">最佳实践总结</h4>
<ol>
<li><strong>始终使用 WHERE 子句</strong>：执行没有 WHERE 子句的 DELETE 要慎重，再慎重</li>
<li><strong>删除前检查</strong>：先用 SELECT 测试 WHERE 条件，确认无误后再执行 DELETE</li>
<li><strong>使用标记删除</strong>：在业务代码层面，应该做逻辑标记删除，避免物理删除</li>
<li><strong>数据归档</strong>：为了实现数据归档需求，可以用采用 MySQL 分区表特性来实现</li>
<li><strong>权限控制</strong>：控制业务账号权限，只授予必要的 DML 权限，不授予 DELETE 权限</li>
<li><strong>性能优化</strong>：
<ul>
<li>使用索引提高查询速度</li>
<li>分批删除大量数据</li>
<li>使用事务确保数据一致性</li>
<li>调整操作顺序降低行锁持有粒度</li>
</ul>
</li>
</ol>
<h4 data-id="heading-82">写在最后</h4>
<p>💪 <strong>掌握 DELETE 语句的关键在于理解 WHERE 子句的重要性，以及如何正确使用各种删除技巧。</strong> 通过本文档的学习，相信你已经掌握了 SQL DELETE 语句的核心技能。在实际工作中，记住：<strong>删除数据要谨慎，WHERE 子句不能忘！</strong></p>
<p>🚀 <strong>让我们一起成为 SQL 高手，掌握数据删除的核心技能，避免数据灾难！</strong></p>
<hr/>
<p><strong>作者</strong>：郑恩赐<br/>
<strong>机构</strong>：厦门工学院人工智能创作坊<br/>
<strong>日期</strong>：2025 年 01 月 27 日</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[20251115复盘记录：让分页乖乖“坐好”+ 卡片统一渐变描边与圆角]]></title>    <link>https://juejin.cn/post/7572502156487573530</link>    <guid>https://juejin.cn/post/7572502156487573530</guid>    <pubDate>2025-11-15T16:49:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572502156487573530" data-draft-id="7572566115849191474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="20251115复盘记录：让分页乖乖“坐好”+ 卡片统一渐变描边与圆角"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-15T16:49:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张可爱"/> <meta itemprop="url" content="https://juejin.cn/user/2608489519384504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            20251115复盘记录：让分页乖乖“坐好”+ 卡片统一渐变描边与圆角
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2608489519384504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张可爱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T16:49:23.000Z" title="Sat Nov 15 2025 16:49:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2b8d7f44ed642dcada8b17e3e5d14eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5byg5Y-v54ix:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763830556&amp;x-signature=J7wwUWXxYGX3SvfEEObWNS7kyX8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">🌈 一、这次到底动了啥？（一句话总结）</h2>
<p><strong>分页贴卡片、内容区撑满视窗、卡片统一 4px 圆角 + 1px 渐变描边、去掉原生 number 的上下箭头。</strong></p>
<hr/>
<h2 data-id="heading-1">🧩 二、每个改动点都讲讲（轻松但严谨）</h2>
<h3 data-id="heading-2">🍰 1）分页条乖乖贴在卡片下方</h3>
<p>以前分页掉在页面底部，下面留一块空空的白色区域，看起来有点寂寞。</p>
<p>现在：</p>
<ul>
<li>外层容器：<code>height: calc(100vh - offset)</code></li>
<li>内容区 flex 占满：<code>flex: 1</code></li>
<li>分页区用 <code>margin-top: auto</code> 自动推到底</li>
</ul>
<p><strong>稳了。</strong><br/>
分页终于坐在该坐的位置，像是“好！我贴这儿不动了！”的感觉。</p>
<hr/>
<h3 data-id="heading-3">🎀 2）数字输入框的原生箭头 → bye~</h3>
<p>ElementPlus 的 <code>controls="false"</code> 只是让它不显示组件的按钮，<br/>
但浏览器原生 spinner 还是会偷偷冒出来：</p>
<p>于是补了这段“温柔但有效”的隐藏法术：</p>
<pre><code class="hljs language-ruby" lang="ruby">input[type=<span class="hljs-string">"number"</span>]<span class="hljs-symbol">:</span><span class="hljs-symbol">:-webkit-inner-spin-button</span>,
input[type=<span class="hljs-string">"number"</span>]<span class="hljs-symbol">:</span><span class="hljs-symbol">:-webkit-outer-spin-button</span> {
  -webkit-<span class="hljs-symbol">appearance:</span> none;
  <span class="hljs-symbol">margin:</span> <span class="hljs-number">0</span>;
}

input[type=<span class="hljs-string">"number"</span>] {
  -moz-<span class="hljs-symbol">appearance:</span> textfield;
}
</code></pre>
<p><strong>最终效果：小清爽、小统一、小可爱。</strong></p>
<hr/>
<h3 data-id="heading-4">🧊 3）卡片圆角统一为 4px（再配合 overflow: hidden）</h3>
<p>所有卡片（包括“创建应用”的那块）统一 4px：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;
<span class="hljs-attribute">overflow</span>: hidden;
</code></pre>
<p>背景、图片、阴影都乖乖被圆角裁切，视觉秩序一下子出来了。</p>
<hr/>
<h3 data-id="heading-5">🌈 4）卡片依类型显示「1px 渐变描边」</h3>
<p>两个不同类型的应用 → 两种独立渐变外边框。<br/>
但我没有走“伪元素 + mask”这种偏硬核的路线（lint 还会唠叨我）。</p>
<p>最终方案使用：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid transparent;
<span class="hljs-attribute">border-image</span>: <span class="hljs-built_in">linear-gradient</span>(...) <span class="hljs-number">1</span>;
</code></pre>
<hr/>
<h2 data-id="heading-6">🛠 三、关键改的文件</h2>

















<table><thead><tr><th>文件名</th><th>职责</th></tr></thead><tbody><tr><td><strong>home.vue</strong></td><td>布局、圆角、渐变边框、分页定位全部在这里</td></tr><tr><td><strong>index.vue</strong></td><td>隐藏数字输入 spinner 的 CSS 补充</td></tr></tbody></table>
<p>非常干净，改动范围不乱跑。</p>
<hr/>
<h2 data-id="heading-7">🧠 四、为什么这样实现？（专业但不废话）</h2>
<h3 data-id="heading-8">✔ calc 配合视口</h3>
<p>因为你不想内容区“短一截”，也不想无限撑满，把顶部的导航栏扣掉即可。</p>
<h3 data-id="heading-9">✔ margin-top: auto</h3>
<p>用 flex 让分页乖乖到容器底部，响应式自然又不容易炸。</p>
<h3 data-id="heading-10">✔ border-image 赢麻了</h3>
<ul>
<li>不用写 mask</li>
<li>不用 hack</li>
<li>圆角自然生效</li>
<li>浏览器心情更好（你心情也更好）</li>
</ul>
<h3 data-id="heading-11">✔ 隐藏原生 spinner 的原因</h3>
<p>为了视觉统一和手感更顺滑，是你看不见但会真切感受到的那种小优化。</p>
<hr/>
<h2 data-id="heading-12">🧯 五、踩到的小坑 &amp; 解决办法</h2>
<h3 data-id="heading-13">❗1）CSS 不小心写进了 <code>&lt;script&gt;</code></h3>
<p>页面直接红到发光 ⚠️<br/>
→ 恢复 data() / mounted()，重新整理结构。</p>
<h3 data-id="heading-14">❗2）mask 太爱挑浏览器</h3>
<p>lint 提示 + 圆角锯齿（哎呦）。<br/>
→ 换 border-image，一切回归顺滑。</p>
<h3 data-id="heading-15">❗3）ElementPlus 的圆角覆盖你写的圆角</h3>
<p>→ 调整选择器权重，仅对当前页面作用，必要时加 <code>!important</code>（谨慎使用）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangGraph+BrightData+PaperSearch的研究助理]]></title>    <link>https://juejin.cn/post/7572714389942337588</link>    <guid>https://juejin.cn/post/7572714389942337588</guid>    <pubDate>2025-11-15T17:43:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572714389942337588" data-draft-id="7572524368879108130" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangGraph+BrightData+PaperSearch的研究助理"/> <meta itemprop="keywords" content="MCP,LangChain,爬虫"/> <meta itemprop="datePublished" content="2025-11-15T17:43:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Miku16"/> <meta itemprop="url" content="https://juejin.cn/user/525983678469801"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangGraph+BrightData+PaperSearch的研究助理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/525983678469801/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Miku16
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T17:43:28.000Z" title="Sat Nov 15 2025 17:43:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">LangGraph+BrightData+PaperSearch的研究助理</h2>
<p>摘要：使用LangGraph的ReAct-Agent范式集成了BrightData和PaperSearch的MCP工具，通过搜索和爬取领英和学术网站，实现论文搜索和读取，学者信息提取，邮箱查找等功能。</p>
<p>链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F16Miku%2FAgent-Learning" target="_blank" title="https://github.com/16Miku/Agent-Learning" ref="nofollow noopener noreferrer">github.com/16Miku/Agen…</a></p>
<h3 data-id="heading-1">🚀 前言：我的 AI 助理“精神分裂”了</h3>
<p>大家好，我是你们的技术博主。最近在开发 AI Agent 的时候，我遇到了一个很头疼的问题：<strong>如何让一个 Agent 既能做“正经事”，又能“好好聊天”？</strong></p>
<ul>
<li>当我让它分析论文时，我希望它给我一个结构清晰、字段分明的 JSON 报告。</li>
<li>当我让它抓取个人主页时，我也希望得到一份规整的结构化数据。</li>
<li>但当我只是想跟它说句“干得不错”时，我希望它能像个正常“人”一样回复我，而不是冷冰冰地甩给我一个空的 JSON 对象。</li>
</ul>
<p>传统的 Agent 开发模式，比如用 <code>response_format</code> 强行规定输出格式，虽然能解决前两个问题，但却让 Agent 丧失了灵活性，变成了一个只会“填表”的机器人。这显然不是我们想要的“智能助理”。</p>
<p>经过一番探索，我找到了一种极其优雅的解决方案：<strong>把结构化输出本身，也变成一种“工具”！</strong> 让 Agent 自己来决定什么时候该“填表”，什么时候该“聊天”。</p>
<p>今天，我就将手把手带大家，使用 LangGraph 和 Google 最新的 <code>gemini-2.5-flash</code> 模型，构建一个能够<strong>无缝切换</strong>于<strong>学术研究</strong>、<strong>信息抓取</strong>和<strong>日常对话</strong>三种模式的“全能AI研究助理”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d306953739a434eb3553f5083bfd7d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlrdTE2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763833408&amp;x-signature=2gmX8vgQJjboP2STzkRZo9Trgt8%3D" alt="AI Assistant" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/794b140abe53457798b70cdb7ebd0204~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlrdTE2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763833408&amp;x-signature=yy1MVpyLPjPRcUkQvLuLFYZP4kI%3D" alt="LangGraph" loading="lazy"/> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fb9da91725c46149b3fd129707dc6de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWlrdTE2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763833408&amp;x-signature=URZYGIJXLAh6DwAYTEPQeJ%2BeZtc%3D" alt="Gemini" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">🔥 核心思路：让“格式”成为一种可选工具</h3>
<p>我们这次优化的核心思想，简单来说就是：<strong>不强迫，只引导</strong>。</p>
<p>我们不再粗暴地告诉 LLM：“你必须用这个格式回复我！” 而是换一种更聪明的方式：</p>
<ol>
<li>我们定义好想要的报告格式，比如 <code>PaperAnalysis</code>（论文分析报告）和 <code>LinkedinProfile</code>（领英主页报告）。</li>
<li>但我们不把它们作为强制的 <code>response_format</code>，而是把它们伪装成两个特殊的“工具”交给 Agent。</li>
<li>我们在 System Prompt 中明确告诉 Agent：“你的工具箱里有搜索、抓取等普通工具，还有两个特殊的‘报告生成’工具。当你需要产出正式报告时，请在收集完所有信息后，调用这两个工具来格式化你的最终答案。”</li>
</ol>
<p>这样做的好处是显而易见的：</p>
<ul>
<li><strong>高度灵活</strong>：Agent 掌握了主动权，可以根据对话上下文自主判断是否需要结构化输出。</li>
<li><strong>任务解耦</strong>：将“信息收集”和“格式化输出”两个步骤分开，Agent 的思考过程（Chain of Thought）更加清晰，有助于完成复杂任务。</li>
<li><strong>自然交互</strong>：对于普通聊天，Agent 可以直接回复，交互体验大大提升。</li>
</ul>
<p>理论说完了，让我们  show the code!</p>
<hr/>
<h3 data-id="heading-3">🛠️ 实战演练：三步构建全能助理</h3>
<h4 data-id="heading-4">步骤 1: 环境准备与依赖安装</h4>
<p>首先，我们需要在 Colab 环境中安装所有必需的库。这里我们用到了 <code>langgraph</code> 核心框架，<code>langchain-google-genai</code> 用于驱动 Gemini 模型，以及 <code>beautifulsoup4</code> 等辅助库。</p>
<blockquote>
<p><strong>⚠️ 注意：</strong> 每次安装或升级库之后，为了让新版本生效，请务必在 Colab 菜单栏点击 “代码执行程序” -&gt; “重启会话”。</p>
</blockquote>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># --- 步骤 1: 安装与重启 ---</span>
!pip install --upgrade --quiet langchain langchain-core langchain-mcp-adapters langchain-google-genai langgraph beautifulsoup4
<span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 库已升级。请务必从菜单栏点击 '代码执行程序' -&gt; '重启会话'，然后再继续运行下面的代码！"</span>)
</code></pre>
<h4 data-id="heading-5">步骤 2: 编写“灵魂”代码</h4>
<p>这是我们整个项目的核心代码。我会逐一拆解，让你看懂每一部分的功能。</p>
<h5 data-id="heading-6">2.1 导入与密钥配置</h5>
<p>常规操作，导入所有需要的模块，并从 Colab 的 <code>userdata</code> 中加载我们的 API 密钥。这种方式比直接把密钥写在代码里更安全。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 2.1: 导入</span>
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Union</span>
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">import</span> nest_asyncio
nest_asyncio.apply() <span class="hljs-comment"># 允许在Jupyter/Colab环境中嵌套运行asyncio事件循环</span>

<span class="hljs-keyword">from</span> langchain_google_genai <span class="hljs-keyword">import</span> ChatGoogleGenerativeAI
<span class="hljs-keyword">from</span> langchain_mcp_adapters.client <span class="hljs-keyword">import</span> MultiServerMCPClient
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field <span class="hljs-comment"># 导入 Pydantic 用于定义我们的“伪工具”</span>

<span class="hljs-comment"># 2.2: 加载密钥</span>
<span class="hljs-keyword">from</span> google.colab <span class="hljs-keyword">import</span> userdata
os.environ[<span class="hljs-string">"GEMINI_API_KEY"</span>] = userdata.get(<span class="hljs-string">'GEMINI_API_KEY'</span>)
BrightData_API_KEY = userdata.get(<span class="hljs-string">'BrightData_API_KEY'</span>)
Paper_Search_API_KEY = userdata.get(<span class="hljs-string">'Paper_Search_API_KEY'</span>)
</code></pre>
<h5 data-id="heading-7">2.2 🔥 核心优化点：创建“伪工具”🔥</h5>
<p>这里就是我们整个方案的“魔法”所在！我们使用 Pydantic 的 <code>BaseModel</code> 来定义两个类：<code>PaperAnalysis</code> 和 <code>LinkedinProfile</code>。</p>
<ul>
<li><strong><code>BaseModel</code></strong>: Pydantic 的基础类，能让我们像定义一个普通的 Python 类一样来定义数据结构。</li>
<li><strong><code>Field</code></strong>: 用于为类的属性添加额外的描述信息。<strong>这一点至关重要</strong>，因为 LLM 正是通过读取这些 <code>description</code> 来理解每个字段的含义以及整个“工具”的作用。</li>
<li><strong>类的文档字符串 (docstring)</strong>: 比如 <code>"""当用户要求...调用此工具来格式化最终报告。"""</code>，这是对整个工具最直接的描述，Agent 会优先读取它来判断工具的用途。</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ================================================================= #</span>
<span class="hljs-comment">#  🔥🔥🔥 核心优化点 1: 创建专门用于结构化输出的“伪工具” 🔥🔥🔥</span>
<span class="hljs-comment"># ================================================================= #</span>
<span class="hljs-comment"># 我们不再将 dataclass 作为 response_format，而是将它们包装成 Pydantic 模型，</span>
<span class="hljs-comment"># 并作为“工具”提供给 Agent。这让 Agent 可以自己决定何时调用它们。</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PaperAnalysis</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""当用户要求对一篇学术论文进行详细分析时，调用此工具来格式化最终报告。"""</span>
    title: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"论文的完整标题"</span>)
    authors: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = Field(description=<span class="hljs-string">"论文的核心作者列表"</span>)
    research_field: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"根据内容总结出的研究方向"</span>)
    summary: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"对论文核心贡献的详细总结"</span>)
    author_contact: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"从抓取内容中找到的作者邮箱或个人主页，如果找不到则为 '联系方式未找到'"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedinProfile</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""当用户要求提取领英个人主页信息时，调用此工具来格式化最终报告。"""</span>
    full_name: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"用户的全名"</span>)
    headline: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"用户的头衔或当前职位"</span>)
    location: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"用户所在的地理位置"</span>)
    summary: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"个人简介部分的总结"</span>)
    experience: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = Field(description=<span class="hljs-string">"一个包含所有工作经历的列表"</span>)
    contact: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"从抓取内容中找到的邮箱或个人主页，如果找不到则为 '联系方式未找到'"</span>)
</code></pre>
<h5 data-id="heading-8">2.3 设计“行动指南”：System Prompt</h5>
<p>一个好的 System Prompt 是 Agent 的“灵魂”。在这里，我们明确地为 Agent 设定了角色、能力，以及最重要的——行动指南（ReAct 思考模式）。</p>
<p>请注意，我们特地强调了 <code>PaperAnalysis</code> 和 <code>LinkedinProfile</code> 是<strong>特殊的“报告生成”工具</strong>，并指导 Agent 在收集完信息后<strong>必须</strong>调用它们来生成报告。这种明确的指令对于引导 Agent 行为至关重要。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># --- 步骤 2.3: 设计一个更通用的 System Prompt ---</span>
SYSTEM_PROMPT = <span class="hljs-string">"""
你是一个全能的AI研究助理。你可以处理多种任务，包括分析学术论文和查询个人资料。

**你的能力 (工具箱):**
*   你拥有学术搜索、通用网页搜索和网页抓取等一系列工具。
*   **特别注意:** 你还拥有两个特殊的“报告生成”工具：`PaperAnalysis` 和 `LinkedinProfile`。

**你的行动指南 (ReAct 思考模式):**
1.  **分析与规划:** 理解用户的请求。如果用户的最终目的是生成一份结构化的报告（比如论文分析或个人资料总结），你的最终行动**必须**是调用 `PaperAnalysis` 或 `LinkedinProfile` 工具。
2.  **信息收集:** 使用你的其他工具（如 `search_arxiv`, `scrape_as_markdown`）来收集填充报告所需的所有信息。
3.  **生成报告:** 当你收集到足够的信息后，调用相应的报告生成工具 (`PaperAnalysis` 或 `LinkedinProfile`)，将收集到的信息作为参数传入。
4.  **普通对话:** 如果用户只是进行普通聊天或提出简单问题，直接用自然语言回答即可，无需调用报告工具。
"""</span>
</code></pre>
<h5 data-id="heading-9">2.4 Agent 的组装与测试</h5>
<p>现在，万事俱备，我们来组装 Agent。</p>
<ol>
<li><strong>初始化工具集</strong>：我们通过 <code>MultiServerMCPClient</code> 加载了来自 BrightData 和 Paper Search 的真实工具集。</li>
<li><strong>注入“伪工具”</strong>：我们将刚才定义的 <code>PaperAnalysis</code> 和 <code>LinkedinProfile</code> 类，像普通工具一样，追加到 <code>all_tools</code> 列表中。</li>
<li><strong>创建 Agent</strong>：调用 <code>create_agent</code> 函数。请注意，我们<strong>没有传递 <code>response_format</code> 参数</strong>！这就是我们赋予 Agent 自由的关键。</li>
<li><strong>多任务测试</strong>：我们设计了三个连续的测试用例，覆盖了论文分析、个人资料查询和普通聊天这三种场景。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># --- 步骤 2.4: 定义主异步函数 ---</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🚀 开始配置通用 AI Agent..."</span>)

    <span class="hljs-comment"># --- 初始化工具集 ---</span>
    <span class="hljs-comment"># MultiServerMCPClient 用于连接和管理多个外部工具服务</span>
    mcp_client = MultiServerMCPClient({
        <span class="hljs-string">"bright_data"</span>: {
            <span class="hljs-string">"url"</span>: <span class="hljs-string">f"https://mcp.brightdata.com/mcp?token=<span class="hljs-subst">{BrightData_API_KEY}</span>&amp;pro=1"</span>,
            <span class="hljs-string">"transport"</span>: <span class="hljs-string">"streamable_http"</span>,
        },
        <span class="hljs-string">"Paper_Search"</span>: {
            <span class="hljs-string">"url"</span>: <span class="hljs-string">f"https://server.smithery.ai/@adamamer20/paper-search-mcp-openai/mcp?api_key=<span class="hljs-subst">{Paper_Search_API_KEY}</span>"</span>,
            <span class="hljs-string">"transport"</span>: <span class="hljs-string">"streamable_http"</span>,
        }
    })

    <span class="hljs-comment"># 异步获取所有可用的真实工具</span>
    real_tools = <span class="hljs-keyword">await</span> mcp_client.get_tools()

    <span class="hljs-comment"># 将我们的“伪工具”（Pydantic模型）加入到工具列表中</span>
    all_tools = real_tools + [PaperAnalysis, LinkedinProfile]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 成功加载 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(all_tools)}</span> 个工具。"</span>)

    <span class="hljs-comment"># --- 配置 LLM ---</span>
    <span class="hljs-comment"># 使用 Google 的 gemini-2.5-flash 模型，性价比很高</span>
    llm = ChatGoogleGenerativeAI(model=<span class="hljs-string">"gemini-2.5-flash"</span>, google_api_key=os.environ[<span class="hljs-string">"GEMINI_API_KEY"</span>])
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ LLM 配置完成: gemini-2.5-flash"</span>)

    <span class="hljs-comment"># --- 配置内存 ---</span>
    <span class="hljs-comment"># 使用内存存储会话历史，方便进行多轮对话</span>
    checkpointer = InMemorySaver()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"💾 内存已配置: InMemorySaver"</span>)

    <span class="hljs-comment"># --- 步骤 2.5: 创建 Agent，注意这次不指定 response_format ---</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🤖 正在创建通用 Agent..."</span>)
    agent_executor = create_agent(
        model=llm,
        tools=all_tools, <span class="hljs-comment"># 传入包含真实工具和“伪工具”的完整列表</span>
        system_prompt=SYSTEM_PROMPT,
        checkpointer=checkpointer
        <span class="hljs-comment"># 我们移除了 response_format，给予 Agent 更大的自由度</span>
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ Agent 创建成功！"</span>)

    <span class="hljs-comment"># --- 步骤 2.6: 进行多任务测试 ---</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🚀 开始多任务对话测试！"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)

    <span class="hljs-comment"># 为本次对话创建一个唯一的线程ID，以保持上下文</span>
    conversation_config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"multi-task-thread-1"</span>}}

    <span class="hljs-comment"># --- 任务1: 论文分析 ---</span>
    user_input_1 = <span class="hljs-string">"请使用 'search_arxiv' 工具搜索 'https://arxiv.org/abs/2409.09046'里的这篇论文，并用 'read_arxiv_paper' 工具读取论文内容。帮我提取论文主要内容和提取作者信息，尤其是作者们的邮箱。"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"👤 用户 (任务1): <span class="hljs-subst">{user_input_1}</span>\n"</span>)
    response_1 = <span class="hljs-keyword">await</span> agent_executor.ainvoke({<span class="hljs-string">"messages"</span>: [(<span class="hljs-string">"user"</span>, user_input_1)]}, config=conversation_config)
    final_answer_1 = response_1[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content
    <span class="hljs-comment"># ... (打印部分省略) ...</span>

    <span class="hljs-comment"># --- 任务2: 个人资料查询 ---</span>
    user_input_2 = <span class="hljs-string">"干得好！现在，请帮我查找吴恩达的领英主页信息，并以结构化形式返回。"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"👤 用户 (任务2): <span class="hljs-subst">{user_input_2}</span>\n"</span>)
    response_2 = <span class="hljs-keyword">await</span> agent_executor.ainvoke({<span class="hljs-string">"messages"</span>: [(<span class="hljs-string">"user"</span>, user_input_2)]}, config=conversation_config)
    final_answer_2 = response_2[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content
    <span class="hljs-comment"># ... (打印部分省略) ...</span>

    <span class="hljs-comment"># --- 任务3: 普通聊天 ---</span>
    user_input_3 = <span class="hljs-string">"谢谢你，你真是个好帮手。"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"👤 用户 (任务3): <span class="hljs-subst">{user_input_3}</span>\n"</span>)
    response_3 = <span class="hljs-keyword">await</span> agent_executor.ainvoke({<span class="hljs-string">"messages"</span>: [(<span class="hljs-string">"user"</span>, user_input_3)]}, config=conversation_config)
    final_answer_3 = response_3[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content
    <span class="hljs-comment"># ... (打印部分省略) ...</span>

    <span class="hljs-comment"># --- 统一输出最终结果 ---</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"---"</span> * <span class="hljs-number">20</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"最终成果展示:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"---"</span> * <span class="hljs-number">20</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n[任务一：论文分析结果]\n"</span>)
    <span class="hljs-built_in">print</span>(final_answer_1)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n[任务二：个人资料查询结果]\n"</span>)
    <span class="hljs-built_in">print</span>(final_answer_2)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n[任务三：普通聊天结果]\n"</span>)
    <span class="hljs-built_in">print</span>(final_answer_3)


<span class="hljs-comment"># --- 步骤 2.7: 运行主函数 ---</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<h4 data-id="heading-10">步骤 3: 见证奇迹！分析运行结果</h4>
<p>让我们看看这个聪明的 Agent 是如何处理我们抛给它的三个不同任务的。</p>
<h5 data-id="heading-11">任务 1: 论文分析 📖</h5>
<p><strong>用户输入</strong>: <code>请使用 'search_arxiv' 工具搜索 'https://arxiv.org/abs/2409.09046'里的这篇论文...帮我提取论文主要内容和提取作者信息...</code></p>
<p><strong>Agent 回答</strong>:</p>
<pre><code class="hljs language-text" lang="text">好的，我已经读取了这篇论文。

**论文主要内容摘要：**

大型语言模型（LLMs）在人工智能法律和政策应用中面临知识过时、幻觉和复杂语境中推理能力差的局限性。检索增强生成（RAG）系统通过整合外部知识来解决这些问题...为高风险法律和政策应用提供了一个强大且适应性强的解决方案。

**作者信息：**

*   **作者：** Rishi Kalra, Zekun Wu, Ayesha Gulley, Airlie Hilliard, Xin Guan, Adriano Koshiyama, Philip Treleaven
*   **所属机构：** Holistic AI 和 University College London

论文中并未直接提供作者的邮箱地址...为了获取作者的邮箱，我需要进行一次网页搜索。请问您是否希望我尝试搜索作者的邮箱？
</code></pre>
<p><strong>结果分析</strong>:
Agent 准确地执行了 <code>search_arxiv</code> 和 <code>read_arxiv_paper</code> 工具，并用 Markdown 格式清晰地总结了论文内容和作者信息。有趣的是，它<strong>没有</strong>调用我们预设的 <code>PaperAnalysis</code> 工具。这恰恰证明了它的智能和灵活性！它判断当前场景下，一个格式化的文本回复已经足够清晰，并且在发现信息不完整（找不到邮箱）时，它没有强行填表，而是主动与用户沟通，请求下一步指令。非常棒！</p>
<h5 data-id="heading-12">任务 2: 个人资料查询 🧑‍💼</h5>
<p><strong>用户输入</strong>: <code>干得好！现在，请帮我查找吴恩达的领英主页信息，并以结构化形式返回。</code></p>
<p><strong>Agent 回答</strong>:</p>
<pre><code class="hljs language-text" lang="text">好的，这是吴恩达（Andrew Ng）的领英主页信息：

**全名:** Andrew Ng
**头衔:** DeepLearning.AI 创始人；AI Fund 管理合伙人；LandingAI 执行主席
**地点:** 美国加利福尼亚州帕洛阿尔托
**个人简介:** Andrew Ng 是人工智能领域的杰出人物...他的个人主页是 http://andrewng.org。
**经历:**
*   DeepLearning.AI 创始人 (2017 年 6 月 - 至今)
*   AI Fund 管理合伙人 (2018 年 1 月 - 至今)
*   ...
**联系方式:** https://www.linkedin.com/in/andrewyng
</code></pre>
<p><strong>结果分析</strong>:
<strong>完美！</strong> 这次 Agent 的表现堪称典范。</p>
<ol>
<li>它理解了“吴恩达”和“领英主页”。</li>
<li>调用 <code>search_engine</code> 工具找到了正确的 URL。</li>
<li>调用 <code>web_data_linkedin_person_profile</code> 工具抓取了页面信息。</li>
<li><strong>最关键的一步</strong>：它调用了我们定义的 <code>LinkedinProfile</code> 这个“伪工具”，将抓取到的非结构化信息，自动填充到了我们预设的字段中。</li>
<li>最后，它将这个结构化的结果以用户友好的格式呈现出来。</li>
</ol>
<p>这完美地展示了我们的核心策略是多么成功！</p>
<h5 data-id="heading-13">任务 3: 普通聊天 😊</h5>
<p><strong>用户输入</strong>: <code>谢谢你，你真是个好帮手。</code></p>
<p><strong>Agent 回答</strong>:</p>
<pre><code class="hljs language-text" lang="text">不客气！很高兴能帮到您。如果您还有其他问题或需要进一步的帮助，请随时告诉我。
</code></pre>
<p><strong>结果分析</strong>:
正如我们所期望的，Agent 在面对简单的感谢时，给出了一个自然、礼貌的回复。它没有调用任何工具，更没有去尝试匹配 <code>PaperAnalysis</code> 或 <code>LinkedinProfile</code>，因为它清楚地知道，这只是一个简单的对话。这证明了我们的 Agent 真正实现了“能屈能伸”，在不同场景下游刃有余。</p>
<hr/>
<h3 data-id="heading-14">总结与展望</h3>
<p>通过这次实践，我们成功使用LangGraph的ReAct-Agent范式集成了BrightData和PaperSearch的MCP工具，通过搜索和爬取领英和学术网站，实现了具备论文搜索和读取，学者信息提取，邮箱查找等功能的 AI 助理。其成功的关键，就在于我们转变了思路：</p>
<blockquote>
<p><strong>将“强制的输出格式”转变为“可选的格式化工具”，把最终决策权交还给 Agent。</strong></p>
</blockquote>
<p>这种基于 Pydantic 模型和 ReAct 模式的“伪工具”方法，不仅让我们的 Agent 更加智能和灵活，也为我们未来构建更复杂的、多功能的 Agent 系统提供了一个极具价值的设计范式。</p>
<p>希望今天的分享能对你有所启发。如果你对这个项目有任何疑问或者更好的想法，欢迎在评论区留言讨论！</p>
<hr/>
<p><strong>附：完整项目源码</strong></p>
<p>（为了方便大家复制代码，这里再次贴出完整的、可直接运行的代码）</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># --- 步骤 1: 安装与重启 (同前) ---</span>
!pip install --upgrade --quiet langchain langchain-core langchain-mcp-adapters langchain-google-genai langgraph beautifulsoup4
<span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 库已升级。请务必从菜单栏点击 '代码执行程序' -&gt; '重启会话'，然后再继续运行下面的代码！"</span>)



<span class="hljs-comment"># --- 步骤 2: 完整代码 ---</span>

<span class="hljs-comment"># 2.1: 导入</span>
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Union</span>
<span class="hljs-keyword">from</span> dataclasses <span class="hljs-keyword">import</span> dataclass
<span class="hljs-keyword">import</span> nest_asyncio
nest_asyncio.apply()

<span class="hljs-keyword">from</span> langchain_google_genai <span class="hljs-keyword">import</span> ChatGoogleGenerativeAI
<span class="hljs-keyword">from</span> langchain_mcp_adapters.client <span class="hljs-keyword">import</span> MultiServerMCPClient
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-comment"># from langchain_core.pydantic_v1 import BaseModel, Field # 导入 Pydantic 用于动态工具</span>
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field


<span class="hljs-comment"># 2.2: 加载密钥</span>
<span class="hljs-keyword">from</span> google.colab <span class="hljs-keyword">import</span> userdata
os.environ[<span class="hljs-string">"GEMINI_API_KEY"</span>] = userdata.get(<span class="hljs-string">'GEMINI_API_KEY'</span>)
BrightData_API_KEY = userdata.get(<span class="hljs-string">'BrightData_API_KEY'</span>)
Paper_Search_API_KEY = userdata.get(<span class="hljs-string">'Paper_Search_API_KEY'</span>)

<span class="hljs-comment"># ================================================================= #</span>
<span class="hljs-comment">#  🔥🔥🔥 核心优化点 1: 创建专门用于结构化输出的“伪工具” 🔥🔥🔥</span>
<span class="hljs-comment"># ================================================================= #</span>
<span class="hljs-comment"># 我们不再将 dataclass 作为 response_format，而是将它们包装成 Pydantic 模型，</span>
<span class="hljs-comment"># 并作为“工具”提供给 Agent。这让 Agent 可以自己决定何时调用它们。</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PaperAnalysis</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""当用户要求对一篇学术论文进行详细分析时，调用此工具来格式化最终报告。"""</span>
    title: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"论文的完整标题"</span>)
    authors: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = Field(description=<span class="hljs-string">"论文的核心作者列表"</span>)
    research_field: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"根据内容总结出的研究方向"</span>)
    summary: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"对论文核心贡献的详细总结"</span>)
    author_contact: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"从抓取内容中找到的作者邮箱或个人主页，如果找不到则为 '联系方式未找到'"</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedinProfile</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""当用户要求提取领英个人主页信息时，调用此工具来格式化最终报告。"""</span>
    full_name: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"用户的全名"</span>)
    headline: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"用户的头衔或当前职位"</span>)
    location: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"用户所在的地理位置"</span>)
    summary: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"个人简介部分的总结"</span>)
    experience: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = Field(description=<span class="hljs-string">"一个包含所有工作经历的列表"</span>)
    contact: <span class="hljs-built_in">str</span> = Field(description=<span class="hljs-string">"从抓取内容中找到的邮箱或个人主页，如果找不到则为 '联系方式未找到'"</span>)

<span class="hljs-comment"># --- 步骤 2.3: 设计一个更通用的 System Prompt ---</span>
SYSTEM_PROMPT = <span class="hljs-string">"""
你是一个全能的AI研究助理。你可以处理多种任务，包括分析学术论文和查询个人资料。

**你的能力 (工具箱):**
*   你拥有学术搜索、通用网页搜索和网页抓取等一系列工具。
*   **特别注意:** 你还拥有两个特殊的“报告生成”工具：`PaperAnalysis` 和 `LinkedinProfile`。

**你的行动指南 (ReAct 思考模式):**
1.  **分析与规划:** 理解用户的请求。如果用户的最终目的是生成一份结构化的报告（比如论文分析或个人资料总结），你的最终行动**必须**是调用 `PaperAnalysis` 或 `LinkedinProfile` 工具。
2.  **信息收集:** 使用你的其他工具（如 `search_arxiv`, `scrape_as_markdown`）来收集填充报告所需的所有信息。
3.  **生成报告:** 当你收集到足够的信息后，调用相应的报告生成工具 (`PaperAnalysis` 或 `LinkedinProfile`)，将收集到的信息作为参数传入。
4.  **普通对话:** 如果用户只是进行普通聊天或提出简单问题，直接用自然语言回答即可，无需调用报告工具。
"""</span>

<span class="hljs-comment"># --- 步骤 2.4: 定义主异步函数 ---</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🚀 开始配置通用 AI Agent..."</span>)

    <span class="hljs-comment"># --- 初始化工具集 ---</span>
    mcp_client = MultiServerMCPClient({
    <span class="hljs-string">"bright_data"</span>: {
        <span class="hljs-string">"url"</span>: <span class="hljs-string">f"https://mcp.brightdata.com/mcp?token=<span class="hljs-subst">{BrightData_API_KEY}</span>&amp;pro=1"</span>,
        <span class="hljs-string">"transport"</span>: <span class="hljs-string">"streamable_http"</span>,
    },
    <span class="hljs-string">"Paper_Search"</span>: {
        <span class="hljs-string">"url"</span>: <span class="hljs-string">f"https://server.smithery.ai/@adamamer20/paper-search-mcp-openai/mcp?api_key=<span class="hljs-subst">{Paper_Search_API_KEY}</span>"</span>,
        <span class="hljs-string">"transport"</span>: <span class="hljs-string">"streamable_http"</span>,
    }
    })


    real_tools = <span class="hljs-keyword">await</span> mcp_client.get_tools()

    <span class="hljs-comment"># 将我们的“伪工具”加入工具列表</span>
    all_tools = real_tools + [PaperAnalysis, LinkedinProfile]
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 成功加载 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(all_tools)}</span> 个工具。"</span>)

    <span class="hljs-comment"># --- 配置 LLM ---</span>
    llm = ChatGoogleGenerativeAI(model=<span class="hljs-string">"gemini-2.5-flash"</span>, google_api_key=os.environ[<span class="hljs-string">"GEMINI_API_KEY"</span>])
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ LLM 配置完成: gemini-2.5-flash"</span>)

    <span class="hljs-comment"># --- 配置内存 ---</span>
    checkpointer = InMemorySaver()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"💾 内存已配置: InMemorySaver"</span>)

    <span class="hljs-comment"># --- 步骤 2.5: 创建 Agent，注意这次不指定 response_format ---</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🤖 正在创建通用 Agent..."</span>)
    agent_executor = create_agent(
        model=llm,
        tools=all_tools,
        system_prompt=SYSTEM_PROMPT,
        checkpointer=checkpointer
        <span class="hljs-comment"># 我们移除了 response_format，给予 Agent 更大的自由度</span>
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ Agent 创建成功！"</span>)

    <span class="hljs-comment"># --- 步骤 2.6: 进行多任务测试 ---</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🚀 开始多任务对话测试！"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)

    conversation_config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"multi-task-thread-1"</span>}}

    <span class="hljs-comment"># --- 任务1: 论文分析 ---</span>
    user_input_1 = <span class="hljs-string">"请使用 'search_arxiv' 工具搜索 'https://arxiv.org/abs/2409.09046'里的这篇论文，并用 'read_arxiv_paper' 工具读取论文内容。帮我提取论文主要内容和提取作者信息，尤其是作者们的邮箱。"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"👤 用户 (任务1): <span class="hljs-subst">{user_input_1}</span>\n"</span>)
    response_1 = <span class="hljs-keyword">await</span> agent_executor.ainvoke({<span class="hljs-string">"messages"</span>: [(<span class="hljs-string">"user"</span>, user_input_1)]}, config=conversation_config)
    final_answer_1 = response_1[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"🤖"</span> * <span class="hljs-number">25</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🤖 Agent 的回答 (任务1):"</span>)
    <span class="hljs-built_in">print</span>(final_answer_1)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🤖"</span> * <span class="hljs-number">25</span> + <span class="hljs-string">"\n"</span>)

    <span class="hljs-comment"># --- 任务2: 个人资料查询 ---</span>
    user_input_2 = <span class="hljs-string">"干得好！现在，请帮我查找吴恩达的领英主页信息，并以结构化形式返回。"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"👤 用户 (任务2): <span class="hljs-subst">{user_input_2}</span>\n"</span>)
    response_2 = <span class="hljs-keyword">await</span> agent_executor.ainvoke({<span class="hljs-string">"messages"</span>: [(<span class="hljs-string">"user"</span>, user_input_2)]}, config=conversation_config)
    final_answer_2 = response_2[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"🤖"</span> * <span class="hljs-number">25</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🤖 Agent 的回答 (任务2):"</span>)
    <span class="hljs-built_in">print</span>(final_answer_2)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🤖"</span> * <span class="hljs-number">25</span> + <span class="hljs-string">"\n"</span>)

    <span class="hljs-comment"># --- 任务3: 普通聊天 ---</span>
    user_input_3 = <span class="hljs-string">"谢谢你，你真是个好帮手。"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"👤 用户 (任务3): <span class="hljs-subst">{user_input_3}</span>\n"</span>)
    response_3 = <span class="hljs-keyword">await</span> agent_executor.ainvoke({<span class="hljs-string">"messages"</span>: [(<span class="hljs-string">"user"</span>, user_input_3)]}, config=conversation_config)
    final_answer_3 = response_3[<span class="hljs-string">'messages'</span>][-<span class="hljs-number">1</span>].content
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"🤖"</span> * <span class="hljs-number">25</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🤖 Agent 的回答 (任务3):"</span>)
    <span class="hljs-built_in">print</span>(final_answer_3)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🤖"</span> * <span class="hljs-number">25</span>)

<span class="hljs-comment"># --- 步骤 2.7: 运行主函数 ---</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[『OpenGL学习滤镜相机』- Day10: 相机预览与 OpenGL 结合]]></title>    <link>https://juejin.cn/post/7572493520004104226</link>    <guid>https://juejin.cn/post/7572493520004104226</guid>    <pubDate>2025-11-16T02:51:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572493520004104226" data-draft-id="7572524368879337506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="『OpenGL学习滤镜相机』- Day10: 相机预览与 OpenGL 结合"/> <meta itemprop="keywords" content="Android,OpenGL"/> <meta itemprop="datePublished" content="2025-11-16T02:51:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="下位子"/> <meta itemprop="url" content="https://juejin.cn/user/2313028193761389"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            『OpenGL学习滤镜相机』- Day10: 相机预览与 OpenGL 结合
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2313028193761389/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    下位子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T02:51:08.000Z" title="Sun Nov 16 2025 02:51:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://juejin.cn/post/7567889397497528383" target="_blank" title="https://juejin.cn/post/7567889397497528383">前言: 『OpenGL学习』 从零打造 Android 滤镜相机</a></p>
<p><a href="https://juejin.cn/post/7571299394345435178" target="_blank" title="https://juejin.cn/post/7571299394345435178">上一篇:『OpenGL学习滤镜相机』- Day9: CameraX 基础集成</a></p>
<p>Github: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaweizi%2FOpenGLTest" target="_blank" title="https://github.com/xiaweizi/OpenGLTest" ref="nofollow noopener noreferrer">OpenGLTest</a></p>
</blockquote>
<h2 data-id="heading-0">📚 今日目标</h2>
<ul>
<li>理解 SurfaceTexture 的工作原理</li>
<li>掌握 OES 纹理（外部纹理）的使用</li>
<li>学习如何将相机数据传递给 OpenGL</li>
<li>实现使用 GLSurfaceView 渲染相机预览</li>
<li>为实时滤镜功能打下基础</li>
</ul>
<p><strong>运行效果：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9919d301e97d478a944f07d814326fb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiL5L2N5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763866268&amp;x-signature=BHN92LSsuvvmyJrLL7mSKQPUeGE%3D" alt="Day10.png" loading="lazy"/></p>
<h2 data-id="heading-1">🎯 学习内容</h2>
<h3 data-id="heading-2">1. SurfaceTexture 简介</h3>
<p><strong>SurfaceTexture</strong> 是 Android 中用于将图像流作为 OpenGL 纹理的关键类。</p>
<h4 data-id="heading-3">什么是 SurfaceTexture？</h4>
<pre><code class="hljs">相机 → SurfaceTexture → OpenGL 纹理 → GLSurfaceView → 屏幕
</code></pre>
<p><strong>作用</strong>：</p>
<ul>
<li>📹 接收相机、视频解码器等的图像流</li>
<li>🔄 将图像数据转换为 OpenGL ES 纹理</li>
<li>🎨 允许在 OpenGL 中对图像进行处理</li>
</ul>
<h4 data-id="heading-4">SurfaceTexture vs PreviewView</h4>






























<table><thead><tr><th>特性</th><th>PreviewView</th><th>SurfaceTexture + GLSurfaceView</th></tr></thead><tbody><tr><td><strong>使用难度</strong></td><td>简单</td><td>复杂</td></tr><tr><td><strong>功能</strong></td><td>仅预览</td><td>预览 + 实时处理</td></tr><tr><td><strong>滤镜支持</strong></td><td>❌ 不支持</td><td>✅ 支持</td></tr><tr><td><strong>适用场景</strong></td><td>普通相机预览</td><td>实时滤镜、美颜</td></tr></tbody></table>
<h3 data-id="heading-5">2. OES 纹理（外部纹理）</h3>
<h4 data-id="heading-6">什么是 OES 纹理？</h4>
<p>OES 纹理（<code>GL_TEXTURE_EXTERNAL_OES</code>）是 OpenGL ES 的扩展，专门用于接收外部图像流。</p>
<p><strong>与普通纹理的区别</strong>：</p>



































<table><thead><tr><th>特性</th><th>GL_TEXTURE_2D</th><th>GL_TEXTURE_EXTERNAL_OES</th></tr></thead><tbody><tr><td><strong>数据来源</strong></td><td>内存中的图像数据</td><td>相机、视频等外部流</td></tr><tr><td><strong>纹理坐标</strong></td><td>(0,0) 到 (1,1)</td><td>可能需要变换矩阵</td></tr><tr><td><strong>采样器类型</strong></td><td><code>sampler2D</code></td><td><code>samplerExternalOES</code></td></tr><tr><td><strong>纹理参数</strong></td><td>全部支持</td><td>部分限制</td></tr><tr><td><strong>性能</strong></td><td>一般</td><td>更高（零拷贝）</td></tr></tbody></table>
<h4 data-id="heading-7">GLSL 中的 OES 纹理</h4>
<pre><code class="hljs language-glsl" lang="glsl">#extension GL_OES_EGL_image_external : require

precision mediump float;

varying vec2 vTexCoord;
uniform samplerExternalOES uTexture;  // 注意：不是 sampler2D

void main() {
    gl_FragColor = texture2D(uTexture, vTexCoord);
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>必须声明扩展：<code>#extension GL_OES_EGL_image_external : require</code></li>
<li>使用 <code>samplerExternalOES</code> 而不是 <code>sampler2D</code></li>
<li>采样方式仍然是 <code>texture2D()</code></li>
</ul>
<h3 data-id="heading-8">3. 实现流程</h3>
<h4 data-id="heading-9">3.1 创建 OES 纹理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createOESTexture</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
    <span class="hljs-keyword">val</span> textures = IntArray(<span class="hljs-number">1</span>)
    GLES20.glGenTextures(<span class="hljs-number">1</span>, textures, <span class="hljs-number">0</span>)
    
    <span class="hljs-keyword">val</span> textureId = textures[<span class="hljs-number">0</span>]
    GLES20.glBindTexture(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, textureId)
    
    <span class="hljs-comment">// 设置纹理参数</span>
    GLES20.glTexParameteri(
        GLES11Ext.GL_TEXTURE_EXTERNAL_OES,
        GLES20.GL_TEXTURE_MIN_FILTER,
        GLES20.GL_LINEAR
    )
    GLES20.glTexParameteri(
        GLES11Ext.GL_TEXTURE_EXTERNAL_OES,
        GLES20.GL_TEXTURE_MAG_FILTER,
        GLES20.GL_LINEAR
    )
    GLES20.glTexParameteri(
        GLES11Ext.GL_TEXTURE_EXTERNAL_OES,
        GLES20.GL_TEXTURE_WRAP_S,
        GLES20.GL_CLAMP_TO_EDGE
    )
    GLES20.glTexParameteri(
        GLES11Ext.GL_TEXTURE_EXTERNAL_OES,
        GLES20.GL_TEXTURE_WRAP_T,
        GLES20.GL_CLAMP_TO_EDGE
    )
    
    <span class="hljs-keyword">return</span> textureId
}
</code></pre>
<h4 data-id="heading-10">3.2 创建 SurfaceTexture</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> surfaceTexture: SurfaceTexture
<span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> oesTextureId: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>

<span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceCreated</span><span class="hljs-params">(gl: <span class="hljs-type">GL10</span>?, config: <span class="hljs-type">EGLConfig</span>?)</span></span> {
    <span class="hljs-comment">// 1. 创建 OES 纹理</span>
    oesTextureId = createOESTexture()
    
    <span class="hljs-comment">// 2. 创建 SurfaceTexture</span>
    surfaceTexture = SurfaceTexture(oesTextureId)
    
    <span class="hljs-comment">// 3. 设置监听器（当有新帧时回调）</span>
    surfaceTexture.setOnFrameAvailableListener {
        <span class="hljs-comment">// 请求重新渲染</span>
        glSurfaceView.requestRender()
    }
    
    <span class="hljs-comment">// 4. 启动相机（传递 SurfaceTexture）</span>
    startCamera(surfaceTexture)
}
</code></pre>
<h4 data-id="heading-11">3.3 绑定相机到 SurfaceTexture</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startCamera</span><span class="hljs-params">(surfaceTexture: <span class="hljs-type">SurfaceTexture</span>)</span></span> {
    <span class="hljs-keyword">val</span> cameraProviderFuture = ProcessCameraProvider.getInstance(context)
    
    cameraProviderFuture.addListener({
        <span class="hljs-keyword">val</span> cameraProvider = cameraProviderFuture.<span class="hljs-keyword">get</span>()
        
        <span class="hljs-comment">// 创建 Preview，但不使用 PreviewView</span>
        <span class="hljs-keyword">val</span> preview = Preview.Builder().build()
        
        <span class="hljs-comment">// 将 SurfaceTexture 包装为 Surface</span>
        <span class="hljs-keyword">val</span> surface = Surface(surfaceTexture)
        
        <span class="hljs-comment">// 创建 SurfaceProvider</span>
        preview.setSurfaceProvider { request -&gt;
            <span class="hljs-comment">// 获取相机的分辨率</span>
            <span class="hljs-keyword">val</span> resolution = request.resolution
            surfaceTexture.setDefaultBufferSize(resolution.width, resolution.height)
            
            <span class="hljs-comment">// 提供 Surface</span>
            request.provideSurface(
                surface,
                ContextCompat.getMainExecutor(context)
            ) { }
        }
        
        <span class="hljs-keyword">val</span> cameraSelector = CameraSelector.DEFAULT_BACK_CAMERA
        
        cameraProvider.unbindAll()
        cameraProvider.bindToLifecycle(
            <span class="hljs-keyword">this</span>,
            cameraSelector,
            preview
        )
        
    }, ContextCompat.getMainExecutor(context))
}
</code></pre>
<h4 data-id="heading-12">3.4 在 onDrawFrame 中更新纹理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDrawFrame</span><span class="hljs-params">(gl: <span class="hljs-type">GL10</span>?)</span></span> {
    <span class="hljs-comment">// 1. 更新 SurfaceTexture（获取最新帧）</span>
    surfaceTexture.updateTexImage()
    
    <span class="hljs-comment">// 2. 获取纹理变换矩阵（处理旋转、镜像等）</span>
    <span class="hljs-keyword">val</span> transformMatrix = FloatArray(<span class="hljs-number">16</span>)
    surfaceTexture.getTransformMatrix(transformMatrix)
    
    <span class="hljs-comment">// 3. 清屏</span>
    GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT)
    
    <span class="hljs-comment">// 4. 使用着色器程序</span>
    GLES20.glUseProgram(program)
    
    <span class="hljs-comment">// 5. 绑定 OES 纹理</span>
    GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
    GLES20.glBindTexture(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, oesTextureId)
    GLES20.glUniform1i(uTextureLocation, <span class="hljs-number">0</span>)
    
    <span class="hljs-comment">// 6. 传递变换矩阵</span>
    GLES20.glUniformMatrix4fv(uTransformMatrixLocation, <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>, transformMatrix, <span class="hljs-number">0</span>)
    
    <span class="hljs-comment">// 7. 绘制</span>
    drawQuad()
}
</code></pre>
<h3 data-id="heading-13">4. 纹理变换矩阵</h3>
<h4 data-id="heading-14">为什么需要变换矩阵？</h4>
<p>相机输出的图像可能有：</p>
<ul>
<li>🔄 <strong>旋转</strong>：相机传感器方向与屏幕不一致</li>
<li>🪞 <strong>镜像</strong>：前置相机通常是镜像的</li>
<li>📐 <strong>裁剪</strong>：分辨率不匹配</li>
</ul>
<p><code>SurfaceTexture.getTransformMatrix()</code> 提供的矩阵可以自动处理这些问题。</p>
<h4 data-id="heading-15">在着色器中应用变换矩阵</h4>
<pre><code class="hljs language-glsl" lang="glsl">// 顶点着色器
attribute vec4 aPosition;
attribute vec4 aTexCoord;
uniform mat4 uTransformMatrix;  // 变换矩阵
varying vec2 vTexCoord;

void main() {
    // 应用变换矩阵到纹理坐标
    vec4 transformedCoord = uTransformMatrix * aTexCoord;
    vTexCoord = transformedCoord.xy;
    gl_Position = aPosition;
}
</code></pre>
<p><strong>注意</strong>：纹理坐标需要使用 4D 向量（vec4），第三个分量为 0，第四个为 1：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> texCoords = floatArrayOf(
    <span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>,  <span class="hljs-comment">// 左下</span>
    <span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>,  <span class="hljs-comment">// 右下</span>
    <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>,  <span class="hljs-comment">// 左上</span>
    <span class="hljs-number">1f</span>, <span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>   <span class="hljs-comment">// 右上</span>
)
</code></pre>
<h3 data-id="heading-16">5. GLSurfaceView 渲染模式</h3>
<h4 data-id="heading-17">两种渲染模式</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 连续渲染（默认）</span>
glSurfaceView.renderMode = GLSurfaceView.RENDERMODE_CONTINUOUSLY

<span class="hljs-comment">// 2. 按需渲染（推荐用于相机）</span>
glSurfaceView.renderMode = GLSurfaceView.RENDERMODE_WHEN_DIRTY
</code></pre>
<p><strong>推荐做法</strong>：</p>
<ul>
<li>使用 <code>RENDERMODE_WHEN_DIRTY</code></li>
<li>在 <code>SurfaceTexture.setOnFrameAvailableListener</code> 中调用 <code>requestRender()</code></li>
<li>避免无谓的重绘，节省电量</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin">surfaceTexture.setOnFrameAvailableListener {
    glSurfaceView.requestRender()  <span class="hljs-comment">// 有新帧时才渲染</span>
}
</code></pre>
<h3 data-id="heading-18">6. 完整的 Renderer 实现</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Day10Renderer</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context) : GLSurfaceView.Renderer {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> program: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> oesTextureId: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> surfaceTexture: SurfaceTexture
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> uTextureLocation: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> uTransformMatrixLocation: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> transformMatrix = FloatArray(<span class="hljs-number">16</span>)
    
    <span class="hljs-comment">// OES 纹理的顶点着色器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> vertexShaderCode = <span class="hljs-string">"""
        attribute vec4 aPosition;
        attribute vec4 aTexCoord;
        uniform mat4 uTransformMatrix;
        varying vec2 vTexCoord;
        
        void main() {
            vec4 transformedCoord = uTransformMatrix * aTexCoord;
            vTexCoord = transformedCoord.xy;
            gl_Position = aPosition;
        }
    """</span>.trimIndent()
    
    <span class="hljs-comment">// OES 纹理的片段着色器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> fragmentShaderCode = <span class="hljs-string">"""
        #extension GL_OES_EGL_image_external : require
        precision mediump float;
        
        varying vec2 vTexCoord;
        uniform samplerExternalOES uTexture;
        
        void main() {
            gl_FragColor = texture2D(uTexture, vTexCoord);
        }
    """</span>.trimIndent()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceCreated</span><span class="hljs-params">(gl: <span class="hljs-type">GL10</span>?, config: <span class="hljs-type">EGLConfig</span>?)</span></span> {
        GLES20.glClearColor(<span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>)
        
        <span class="hljs-comment">// 编译着色器</span>
        program = createProgram(vertexShaderCode, fragmentShaderCode)
        
        <span class="hljs-comment">// 获取变量位置</span>
        uTextureLocation = GLES20.glGetUniformLocation(program, <span class="hljs-string">"uTexture"</span>)
        uTransformMatrixLocation = GLES20.glGetUniformLocation(program, <span class="hljs-string">"uTransformMatrix"</span>)
        
        <span class="hljs-comment">// 创建 OES 纹理</span>
        oesTextureId = createOESTexture()
        
        <span class="hljs-comment">// 创建 SurfaceTexture</span>
        surfaceTexture = SurfaceTexture(oesTextureId)
        surfaceTexture.setOnFrameAvailableListener {
            <span class="hljs-comment">// 请求重新渲染</span>
        }
        
        <span class="hljs-comment">// 启动相机</span>
        startCamera()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDrawFrame</span><span class="hljs-params">(gl: <span class="hljs-type">GL10</span>?)</span></span> {
        <span class="hljs-comment">// 更新纹理</span>
        surfaceTexture.updateTexImage()
        surfaceTexture.getTransformMatrix(transformMatrix)
        
        <span class="hljs-comment">// 清屏</span>
        GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT)
        
        <span class="hljs-comment">// 使用程序</span>
        GLES20.glUseProgram(program)
        
        <span class="hljs-comment">// 绑定纹理</span>
        GLES20.glActiveTexture(GLES20.GL_TEXTURE0)
        GLES20.glBindTexture(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, oesTextureId)
        GLES20.glUniform1i(uTextureLocation, <span class="hljs-number">0</span>)
        
        <span class="hljs-comment">// 传递变换矩阵</span>
        GLES20.glUniformMatrix4fv(uTransformMatrixLocation, <span class="hljs-number">1</span>, <span class="hljs-literal">false</span>, transformMatrix, <span class="hljs-number">0</span>)
        
        <span class="hljs-comment">// 绘制</span>
        drawQuad()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceChanged</span><span class="hljs-params">(gl: <span class="hljs-type">GL10</span>?, width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>)</span></span> {
        GLES20.glViewport(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createOESTexture</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-comment">// OES 纹理创建代码</span>
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startCamera</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 相机启动代码</span>
    }
}
</code></pre>
<h3 data-id="heading-19">7. 常见问题处理</h3>
<h4 data-id="heading-20">7.1 图像方向问题</h4>
<p><strong>问题</strong>：相机预览可能旋转 90°、180° 或 270°。</p>
<p><strong>解决方法</strong>：</p>
<ul>
<li>✅ 使用 <code>surfaceTexture.getTransformMatrix()</code> 自动处理</li>
<li>✅ 在顶点着色器中应用变换矩阵</li>
<li>❌ 不要手动旋转（会增加复杂度）</li>
</ul>
<h4 data-id="heading-21">7.2 前置相机镜像问题</h4>
<p><strong>问题</strong>：前置相机预览是镜像的。</p>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 如果需要取消镜像，可以在变换矩阵上再应用一个镜像变换</span>
<span class="hljs-keyword">if</span> (lensFacing == CameraSelector.LENS_FACING_FRONT) {
    <span class="hljs-comment">// 水平翻转矩阵</span>
    <span class="hljs-keyword">val</span> flipMatrix = floatArrayOf(
        -<span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>,
        <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>,
        <span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>,
        <span class="hljs-number">1f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>, <span class="hljs-number">1f</span>
    )
    Matrix.multiplyMM(finalMatrix, <span class="hljs-number">0</span>, flipMatrix, <span class="hljs-number">0</span>, transformMatrix, <span class="hljs-number">0</span>)
}
</code></pre>
<h4 data-id="heading-22">7.3 黑屏问题</h4>
<p><strong>可能原因</strong>：</p>
<ol>
<li>未调用 <code>surfaceTexture.updateTexImage()</code></li>
<li>OES 纹理创建失败</li>
<li>着色器中未声明 <code>#extension</code></li>
<li>相机未正确绑定到 SurfaceTexture</li>
</ol>
<p><strong>调试方法</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 检查纹理 ID</span>
Log.d(TAG, <span class="hljs-string">"OES Texture ID: <span class="hljs-variable">$oesTextureId</span>"</span>)

<span class="hljs-comment">// 检查是否有新帧</span>
surfaceTexture.setOnFrameAvailableListener {
    Log.d(TAG, <span class="hljs-string">"New frame available"</span>)
    glSurfaceView.requestRender()
}

<span class="hljs-comment">// 检查 OpenGL 错误</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkGLError</span><span class="hljs-params">(op: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">var</span> error: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">while</span> (GLES20.glGetError().also { error = it } != GLES20.GL_NO_ERROR) {
        Log.e(TAG, <span class="hljs-string">"<span class="hljs-variable">$op</span>: glError <span class="hljs-variable">$error</span>"</span>)
    }
}
</code></pre>
<h3 data-id="heading-23">8. 性能优化</h3>
<h4 data-id="heading-24">8.1 使用按需渲染</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">glSurfaceView.renderMode = GLSurfaceView.RENDERMODE_WHEN_DIRTY

surfaceTexture.setOnFrameAvailableListener {
    glSurfaceView.requestRender()  <span class="hljs-comment">// 只在有新帧时渲染</span>
}
</code></pre>
<h4 data-id="heading-25">8.2 避免不必要的拷贝</h4>
<p>OES 纹理的优势是<strong>零拷贝</strong>：</p>
<ul>
<li>相机数据直接写入 GPU 纹理</li>
<li>无需 CPU 参与数据传输</li>
<li>性能更高，延迟更低</li>
</ul>
<h4 data-id="heading-26">8.3 选择合适的分辨率</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> preview = Preview.Builder()
    .setTargetResolution(Size(<span class="hljs-number">1280</span>, <span class="hljs-number">720</span>))  <span class="hljs-comment">// 降低分辨率提高性能</span>
    .build()
</code></pre>
<h2 data-id="heading-27">💻 代码实践</h2>
<h3 data-id="heading-28">今日任务</h3>
<p>实现相机预览与 OpenGL 结合：</p>
<ol>
<li><strong>创建 OES 纹理</strong></li>
<li><strong>使用 SurfaceTexture 接收相机数据</strong></li>
<li><strong>在 GLSurfaceView 中渲染相机预览</strong></li>
<li><strong>处理纹理变换矩阵</strong></li>
<li><strong>支持前后摄像头切换</strong></li>
</ol>
<h3 data-id="heading-29">实现效果</h3>
<ul>
<li>📹 使用 OpenGL 渲染相机实时预览</li>
<li>🔄 自动处理图像旋转和镜像</li>
<li>📱 支持前后摄像头切换</li>
<li>⚡ 高性能、低延迟</li>
</ul>
<h3 data-id="heading-30">核心代码结构</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Day10Renderer</span>(context: Context, <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> glSurfaceView: GLSurfaceView) 
    : GLSurfaceView.Renderer {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> oesTextureId: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> surfaceTexture: SurfaceTexture
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getSurfaceTexture</span><span class="hljs-params">()</span></span>: SurfaceTexture = surfaceTexture
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSurfaceCreated</span><span class="hljs-params">(gl: <span class="hljs-type">GL10</span>?, config: <span class="hljs-type">EGLConfig</span>?)</span></span> {
        <span class="hljs-comment">// 创建 OES 纹理和 SurfaceTexture</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDrawFrame</span><span class="hljs-params">(gl: <span class="hljs-type">GL10</span>?)</span></span> {
        <span class="hljs-comment">// 更新纹理并渲染</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Day10Activity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> glSurfaceView: GLSurfaceView
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> renderer: Day10Renderer
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        
        glSurfaceView = GLSurfaceView(<span class="hljs-keyword">this</span>)
        glSurfaceView.setEGLContextClientVersion(<span class="hljs-number">2</span>)
        
        renderer = Day10Renderer(<span class="hljs-keyword">this</span>, glSurfaceView)
        glSurfaceView.setRenderer(renderer)
        glSurfaceView.renderMode = GLSurfaceView.RENDERMODE_WHEN_DIRTY
        
        setContentView(glSurfaceView)
        
        <span class="hljs-comment">// 启动相机</span>
        startCamera(renderer.getSurfaceTexture())
    }
}
</code></pre>
<h2 data-id="heading-31">🧪 练习任务</h2>
<h3 data-id="heading-32">基础任务</h3>
<ol>
<li>✅ 实现 OES 纹理创建</li>
<li>✅ 使用 SurfaceTexture 接收相机数据</li>
<li>✅ 在 OpenGL 中渲染相机预览</li>
</ol>
<h3 data-id="heading-33">进阶任务</h3>
<ol>
<li>🎨 添加简单滤镜（灰度、反色）</li>
<li>📐 支持捏合缩放</li>
<li>🔦 添加闪光灯控制</li>
<li>📸 支持拍照功能（从 OpenGL 纹理保存）</li>
</ol>
<h3 data-id="heading-34">挑战任务</h3>
<ol>
<li>🎬 实现录像功能（使用 MediaCodec）</li>
<li>🖼️ 实现双重曝光效果（两个相机混合）</li>
<li>🌈 实现实时美颜（磨皮、美白）</li>
<li>📊 显示 FPS 性能指标</li>
</ol>
<h2 data-id="heading-35">📖 知识点总结</h2>
<h3 data-id="heading-36">核心概念</h3>

























<table><thead><tr><th>概念</th><th>说明</th></tr></thead><tbody><tr><td><strong>SurfaceTexture</strong></td><td>将图像流转换为 OpenGL 纹理</td></tr><tr><td><strong>OES 纹理</strong></td><td>专用于外部图像流的纹理类型</td></tr><tr><td><strong>变换矩阵</strong></td><td>处理旋转、镜像、裁剪</td></tr><tr><td><strong>按需渲染</strong></td><td>仅在有新帧时渲染，节省电量</td></tr></tbody></table>
<h3 data-id="heading-37">关键 API</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 创建 OES 纹理</span>
GLES20.glBindTexture(GLES11Ext.GL_TEXTURE_EXTERNAL_OES, textureId)

<span class="hljs-comment">// 创建 SurfaceTexture</span>
<span class="hljs-keyword">val</span> surfaceTexture = SurfaceTexture(oesTextureId)

<span class="hljs-comment">// 更新纹理</span>
surfaceTexture.updateTexImage()

<span class="hljs-comment">// 获取变换矩阵</span>
surfaceTexture.getTransformMatrix(matrix)
</code></pre>
<h3 data-id="heading-38">最佳实践</h3>
<ol>
<li>✅ <strong>使用按需渲染模式</strong>：节省电量</li>
<li>✅ <strong>在 onFrameAvailable 中 requestRender()</strong>：及时更新</li>
<li>✅ <strong>使用变换矩阵</strong>：自动处理旋转和镜像</li>
<li>✅ <strong>检查 OpenGL 错误</strong>：及时发现问题</li>
<li>✅ <strong>选择合适的分辨率</strong>：平衡性能和质量</li>
</ol>
<h2 data-id="heading-39">🔗 参考资料</h2>
<h3 data-id="heading-40">官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fgraphics%2FSurfaceTexture" target="_blank" title="https://developer.android.com/reference/android/graphics/SurfaceTexture" ref="nofollow noopener noreferrer">SurfaceTexture</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.khronos.org%2Fregistry%2FOpenGL%2Fextensions%2FOES%2FOES_EGL_image_external.txt" target="_blank" title="https://www.khronos.org/registry/OpenGL/extensions/OES/OES_EGL_image_external.txt" ref="nofollow noopener noreferrer">GL_TEXTURE_EXTERNAL_OES</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fopengl%2FGLSurfaceView" target="_blank" title="https://developer.android.com/reference/android/opengl/GLSurfaceView" ref="nofollow noopener noreferrer">GLSurfaceView</a></li>
</ul>
<h3 data-id="heading-41">推荐阅读</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle%2Fgrafika" target="_blank" title="https://github.com/google/grafika" ref="nofollow noopener noreferrer">Grafika</a> - Google 的 OpenGL 示例项目</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdevices%2Fcamera" target="_blank" title="https://source.android.com/devices/camera" ref="nofollow noopener noreferrer">Android 相机架构</a></li>
</ul>
<h2 data-id="heading-42">📝 今日总结</h2>
<p>今天我们学习了相机预览与 OpenGL 的结合：</p>
<ol>
<li>✅ 理解了 SurfaceTexture 的工作原理</li>
<li>✅ 掌握了 OES 纹理的创建和使用</li>
<li>✅ 学会了将相机数据传递给 OpenGL</li>
<li>✅ 实现了使用 GLSurfaceView 渲染相机预览</li>
<li>✅ 了解了纹理变换矩阵的应用</li>
</ol>
<p><strong>关键要点</strong>：</p>
<ul>
<li>SurfaceTexture 是连接相机和 OpenGL 的桥梁</li>
<li>OES 纹理提供了高性能的零拷贝图像传输</li>
<li>变换矩阵自动处理旋转、镜像等问题</li>
<li>按需渲染模式能节省电量</li>
</ul>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">下一篇</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[开发需掌握的知识：高精地图]]></title>    <link>https://juejin.cn/post/7572781559766728754</link>    <guid>https://juejin.cn/post/7572781559766728754</guid>    <pubDate>2025-11-16T01:07:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572781559766728754" data-draft-id="7558050672820142143" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开发需掌握的知识：高精地图"/> <meta itemprop="keywords" content="后端,算法,人工智能"/> <meta itemprop="datePublished" content="2025-11-16T01:07:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三年之约"/> <meta itemprop="url" content="https://juejin.cn/user/3448523142729784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开发需掌握的知识：高精地图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3448523142729784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三年之约
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T01:07:33.000Z" title="Sun Nov 16 2025 01:07:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>高精度地图（HD Map, High-Definition Map）是自动驾驶、智能交通和导航领域的核心技术之一，其精度可达<strong>厘米级</strong>（对比传统导航地图的米级），并提供<strong>精细化车道模型</strong>和<strong>动态语义信息</strong>。以下是其核心优势及典型应用：</p>
<hr/>
<h3 data-id="heading-0"><strong>1. 自动驾驶的核心支柱</strong></h3>
<h4 data-id="heading-1"><strong>（1）超视距感知补充</strong></h4>
<ul>
<li><strong>问题</strong>：车载传感器（LiDAR、摄像头）受限于视距、遮挡和天气（如雾天）。</li>
<li><strong>优势</strong>：HD地图提供前方弯道坡度、车道线曲率、红绿灯位置等信息，提前调整车辆路径或速度。</li>
</ul>
<h4 data-id="heading-2"><strong>（2）车道级导航</strong></h4>
<ul>
<li><strong>静态精度</strong>：车道线位置、宽度、间距精确到厘米，支持车辆保持中心线（如自动驾驶巡航）。</li>
<li><strong>动态响应</strong>：遇到施工改道时，结合高精度车道模型快速规划新路径。</li>
</ul>
<h4 data-id="heading-3"><strong>（3）降低算力需求</strong></h4>
<ul>
<li><strong>减少感知负担</strong>：预知隧道出口无阳光眩光，无需实时识别车道线。</li>
<li><strong>预测能力</strong>：提前获知前方分岔路汇流点，优化变道时机（如匝道汇入高速）。</li>
</ul>
<h3 data-id="heading-4"><strong>2. 交通效率与安全性提升</strong></h3>
<h4 data-id="heading-5"><strong>（1）车路协同（V2I）</strong></h4>
<ul>
<li><strong>动态信号灯同步</strong>：红绿灯相位计划（绿灯时间）写入HD地图，车辆调整速度“绿波通行”。</li>
<li><strong>危险预警</strong>：弯道事故多发路段标注风险等级，触发车辆自动减速。</li>
</ul>
<h4 data-id="heading-6"><strong>（2）拥堵治理</strong></h4>
<ul>
<li><strong>车道级流量分析</strong>：某车道故障车停靠时，导航系统动态引导车辆绕行。</li>
<li><strong>收费站优化</strong>：预知ETC杆和人工窗口位置，减少排队交织。</li>
</ul>
<h3 data-id="heading-7"><strong>3. 精细化城市管理</strong></h3>
<h4 data-id="heading-8"><strong>（1）道路维护</strong></h4>
<ul>
<li><strong>病害检测</strong>：路面裂缝、凹坑与地图基准比对，自动生成养护工单。</li>
<li><strong>施工动态</strong>：临时围挡信息更新后，为物流车辆规划避让路径。</li>
</ul>
<h4 data-id="heading-9"><strong>（2）城市规划辅助</strong></h4>
<ul>
<li><strong>历史数据叠加</strong>：比对多年车道变化，分析拓宽或缩窄对交通流影响。</li>
<li><strong>仿真验证</strong>：虚拟测试新交通枢纽设计（如新增匝道），验证对现有路网影响。</li>
</ul>
<hr/>
<h3 data-id="heading-10"><strong>4. 成本与商业化潜力</strong></h3>
<h4 data-id="heading-11"><strong>（1）减少硬件成本</strong></h4>
<ul>
<li><strong>低配传感器可行</strong>：部分场景下，16线LiDAR+HD地图可替代64线LiDAR+无地图方案。</li>
<li><strong>纯视觉方案升级</strong>：特斯拉FSD通过影子模式补充“记忆路径”，类似轻量级HD地图。</li>
</ul>
<h4 data-id="heading-12"><strong>（2）付费模式创新</strong></h4>
<ul>
<li><strong>动态数据服务</strong>：道路拥堵收费、自动驾驶路径订阅制。</li>
<li><strong>广告精准投放</strong>：商超入口车道级提示（如“左转即达地下停车场”）。</li>
</ul>
<hr/>
<h3 data-id="heading-13"><strong>5. 技术突破与未来潜力</strong></h3>
<h4 data-id="heading-14"><strong>（1）数字孪生应用</strong></h4>
<ul>
<li><strong>实时映射</strong>：车辆行驶轨迹、道路异物掉落与地图中模型动态同步，用于公安或应急指挥。</li>
</ul>
<h4 data-id="heading-15"><strong>（2）C端交互升级</strong></h4>
<ul>
<li><strong>AR导航</strong>：车载AR-HUD中投射实际车道线，引导复杂立交（如重庆黄桷湾立交）。</li>
</ul>
<h3 data-id="heading-16"><strong>6. 局限性与挑战</strong></h3>





















<table><thead><tr><th><strong>优势</strong></th><th><strong>对应挑战</strong></th></tr></thead><tbody><tr><td>厘米级精度</td><td>需周期性测绘更新，山区维护成本高</td></tr><tr><td>静态+动态数据结合</td><td>数据存储量达普通地图1000倍（GB/公里）</td></tr><tr><td>政策支持（如北斗系统）</td><td>跨境地图合规性（如加密坐标系统一）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17"><strong>典型场景案例</strong></h3>
<ul>
<li><strong>北京亦庄自动驾驶区</strong>：HD地图支持Robotaxi在无保护左转中精准定位横向车流间隙。</li>
<li><strong>港珠澳大桥</strong>：车道级坡度与横风预警，保障极端天气通行安全。</li>
</ul>
<h2 data-id="heading-18"><strong>核心技术</strong></h2>
<p>高精度地图（HD Map）的构建和更新涉及多领域技术融合，其核心环节包括<strong>数据采集、处理、建模、更新与应用</strong>。以下是具体技术分类、当前解决方案及典型公司/开源工具总结：</p>
<hr/>
<h3 data-id="heading-19"><strong>1. 数据采集技术</strong></h3>
<h4 data-id="heading-20"><strong>（1）采集设备</strong></h4>



































<table><thead><tr><th><strong>技术</strong></th><th><strong>精度/成本</strong></th><th><strong>应用场景</strong></th><th><strong>局限</strong></th></tr></thead><tbody><tr><td><strong>Mobile Mapping System (MMS)</strong></td><td>厘米级/高成本</td><td>城市级主干道、高速路建图</td><td>车队调度复杂，山区覆盖困难</td></tr><tr><td><strong>GNSS/RTK定位</strong></td><td>5-10cm/中成本</td><td>室外车道线、信号灯位姿</td><td>信号遮挡（隧道）需辅助定位</td></tr><tr><td><strong>LiDAR激光扫描</strong></td><td>毫米-厘米级/高成本</td><td>隧道、立交等3D结构重建</td><td>点云处理算力需求大</td></tr><tr><td><strong>低成本组合方案</strong></td><td>1-5m/低成本</td><td>众包更新（车端传感器回传）</td><td>需后处理优化（SLAM融合）</td></tr></tbody></table>
<h4 data-id="heading-21"><strong>（2）众包采集（Crowdsourcing）</strong></h4>
<ul>
<li><strong>方案</strong>：特斯拉、小鹏等车企利用用户车辆摄像头+GNSS数据补充更新。</li>
<li><strong>代表</strong>：Mobileye Roadbook（通过前视摄像头生成描述道路语义的轻量化地图）。</li>
</ul>
<hr/>
<h3 data-id="heading-22"><strong>2. 数据处理与建模技术</strong></h3>
<h4 data-id="heading-23"><strong>（1）SLAM（同步定位与建图）</strong></h4>
<ul>
<li><strong>LiDAR SLAM</strong>：LIO-SAM（紧耦合LiDAR-IMU）、LeGO-LOAM（轻量化）。</li>
<li><strong>视觉SLAM</strong>：ORB-SLAM3（多传感器融合）、VINS-Fusion（单目+IMU）。</li>
<li><strong>作用</strong>：解决GNSS无信号区（地下车库）的定位问题。</li>
</ul>
<h4 data-id="heading-24"><strong>（2）点云处理</strong></h4>
<ul>
<li><strong>降噪</strong>：统计滤波（Statistical Outlier Removal）。</li>
<li><strong>特征提取</strong>：RANSAC算法识别车道线、道路边缘。</li>
<li><strong>工具</strong>：PCL（Point Cloud Library）、CloudCompare。</li>
</ul>
<h4 data-id="heading-25"><strong>（3）语义建模</strong></h4>
<ul>
<li><strong>要素分类</strong>：CNN（车道线识别）、PointNet++（3D目标检测）。</li>
<li><strong>Lane模型构建</strong>：分类型（单虚线、双实线）与几何信息编码，输出<strong>Lanelet2</strong>或<strong>OpenDRIVE</strong>格式。</li>
</ul>
<h4 data-id="heading-26"><strong>（4）拓扑网络</strong></h4>
<ul>
<li><strong>节点-Link连接</strong>：基于拓扑一致性校验（如无向图桥检测）。</li>
<li><strong>标准格式</strong>：NDS（导航数据标准）、SHP（Shapefile空间数据）。</li>
</ul>
<hr/>
<h3 data-id="heading-27"><strong>3. 地图更新技术</strong></h3>



































<table><thead><tr><th><strong>技术</strong></th><th><strong>更新延迟</strong></th><th><strong>应用场景</strong></th><th><strong>案例</strong></th></tr></thead><tbody><tr><td><strong>企业专业采集车</strong></td><td>月/季度级</td><td>基础框架更新</td><td>四维图新、高德</td></tr><tr><td><strong>车端众包实时更新</strong></td><td>分钟-小时级</td><td>红绿灯位置微调、临时施工</td><td>特斯拉“记忆路径”、百度Apollo</td></tr><tr><td><strong>路侧单元（RSU）推送</strong></td><td>秒级</td><td>事故预警、绿波速度</td><td>华为智慧公路方案</td></tr><tr><td><strong>差分更新</strong></td><td>按需</td><td>局部数据变更（如车道数量增减）</td><td>HERE OTA Update</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-28"><strong>4. 应用与动态服务</strong></h3>
<h4 data-id="heading-29"><strong>（1）自动驾驶集成</strong></h4>
<ul>
<li><strong>定位模块</strong>：匹配LiDAR实时扫描与HD地图点云（如NDT算法）。</li>
<li><strong>路径规划</strong>：结合车道语义信息（如禁行、汇入点），输出Frenet坐标。</li>
</ul>
<h4 data-id="heading-30"><strong>（2）交通管理</strong></h4>
<ul>
<li><strong>动态地图切片</strong>：根据行政区域或行政区划动态裁剪数据。</li>
<li><strong>加密传输</strong>：国密SM4算法保护传输过程数据安全。</li>
</ul>
<h4 data-id="heading-31"><strong>（3）开源方案</strong></h4>
<ul>
<li><strong>Autoware</strong>：支持OpenDRIVE格式地图解析。</li>
<li><strong>Apollo HD Map</strong>：百度开源，含10+道路要素类型（水马、公交站台）。 - <strong>Lanelet2</strong>：德国FTM研究所开发，轻量化车道拓扑表达。</li>
</ul>
<hr/>
<h3 data-id="heading-32"><strong>5. 当前主流解决方案对比</strong></h3>









































<table><thead><tr><th><strong>公司/项目</strong></th><th><strong>核心技术</strong></th><th><strong>商业模式</strong></th><th><strong>覆盖规模</strong></th></tr></thead><tbody><tr><td><strong>百度Apollo</strong></td><td>视觉+LiDAR SLAM，众包更新</td><td>免费开源+自动驾驶方案集成</td><td>国内20+城市</td></tr><tr><td><strong>高德（阿里）</strong></td><td>GNSS/RTK+专业MMS车队</td><td>收费数据服务+导航应用</td><td>全国公路网</td></tr><tr><td><strong>Mobileye</strong></td><td>前视摄像头语义众包</td><td>芯片预装，按里程订阅</td><td>全球主要国家</td></tr><tr><td><strong>Here Tech</strong></td><td>城市数字孪生+5G实时更新</td><td>动态事件收费（如拥堵预警）</td><td>欧美及亚洲主要城市</td></tr><tr><td><strong>特斯拉</strong></td><td>纯视觉记忆路径（无LiDAR依赖）</td><td>免费（FSD包包含）</td><td>用户行驶区域动态更新</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-33"><strong>6. 技术挑战与趋势</strong></h3>
<ul>
<li><strong>多传感器融合</strong>：激光雷达、摄像头、毫米波雷达的数据对齐（时空同步）。</li>
<li><strong>轻量化</strong>：阿里AHS（自适应高精地图）按需请求局部数据，降低车端存储。</li>
<li><strong>合规性</strong>：中国《测绘资质》要求“甲级”，外资地图商需与本土企业合作（如Here+四维图新）。</li>
</ul>
<p>百度 <strong>Apollo</strong> 自动驾驶平台的高精度地图模块（<strong>Apollo HD Map</strong>）是其核心组件之一，采用  <strong>“自研+开源+生态合作”</strong>  模式，深度融合车端传感器数据与地图生产管线。以下是其具体技术实现方案：</p>
<hr/>
<h3 data-id="heading-34"><strong>1. 整体架构</strong></h3>
<p>Apollo HD Map 分为 <strong>数据生产、数据管理、数据应用</strong> 三层：</p>
<pre><code class="hljs language-lua" lang="lua">gherkin
复制
                      +<span class="hljs-comment">------------------+</span>
                      | 数据应用层        |  ← 自动驾驶定位、规划、控制
                      +<span class="hljs-comment">------------------+</span>
                      | 数据管理层        |  ← 地图版本控制、差分更新
                      +<span class="hljs-comment">------------------+</span>
                      | 数据生产层        |  ← 采集、处理、建模、验证
                      +<span class="hljs-comment">------------------+</span>
</code></pre>
<ul>
<li><strong>核心目标</strong>：提供厘米级精度车道模型、动态语义（红绿灯、施工区）和 <strong>分钟级更新</strong> 能力。</li>
</ul>
<hr/>
<h3 data-id="heading-35"><strong>2. 数据生产流程</strong></h3>
<h4 data-id="heading-36"><strong>(1) 采集设备组合</strong></h4>
<h4 data-id="heading-37"><strong>(1) 采集设备组合</strong></h4>
<ul>
<li>
<p><strong>专业采集车</strong>：配备 Velodyne LiDAR（64线）+ 高轨 RTK-GNSS + 全景相机 + IMU，覆盖主城高速。</p>
</li>
<li>
<p><strong>众包补充</strong>：用户车辆（百度合作车型）的 GNSS + 单目摄像头数据，用于补充细节。 - <strong>特殊场景</strong>：</p>
<ul>
<li>隧道：UWB（超宽带）辅助定位。</li>
<li>地下车库：SLAM（无GNSS）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-38"><strong>(2) 处理管线</strong></h4>
<h5 data-id="heading-39"><strong>① 点云处理</strong></h5>
<ul>
<li>
<p><strong>LIO-SAM优化</strong>：LiDAR-IMU紧耦合，生成全局一致点云（闭环检测）。</p>
</li>
<li>
<p><strong>自动化要素提取</strong>：</p>
<ul>
<li>车道线：基于点云反射强度（PCA主成分分析）。</li>
<li>红绿灯：YOLOv4检测2D框，投影到3D点云。</li>
</ul>
</li>
<li>
<p><strong>工具链</strong>：Apollo自研 <code>C++ PCL插件</code> 实现快速标注。</p>
</li>
</ul>
<h5 data-id="heading-40"><strong>② 语义建模</strong></h5>
<ul>
<li>
<p><strong>格式输出</strong>：<strong>Apollo专用格式</strong>（扩展Lanelet2）和 <strong>OpenDRIVE</strong>。 - <strong>核心要素</strong>：</p>
<ul>
<li><strong>车道级</strong>：中心线、边界线、车道类型（虚/实线）。</li>
<li><strong>交通设施</strong>：红绿灯、路牌、公交站台。</li>
<li><strong>动态对象</strong>：水马、临时施工区。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-41"><strong>③ 拓扑校验</strong></h5>
<ul>
<li><strong>节点-link规则</strong>：避免断头路、自循环等逻辑错误。</li>
<li><strong>校验算法</strong>：基于图论的“单源最短路径”检查。</li>
</ul>
<h4 data-id="heading-42"><strong>(3) 地图验证</strong></h4>
<ul>
<li><strong>仿真测试</strong>：在 <strong>LGSVL</strong> 或 <strong>CARLA</strong> 中加载HD地图，测试车辆是否按预期变道。</li>
<li><strong>路测指标</strong>：横向误差（&lt;10cm）、要素缺失率（&lt;0.1%）。</li>
</ul>
<hr/>
<h3 data-id="heading-43"><strong>3. 数据管理方案</strong></h3>
<h4 data-id="heading-44"><strong>(1) 分层分块存储</strong></h4>
<ul>
<li>
<p><strong>标准划分</strong>：按道路区域切片（Tile），每Tile约1平方公里。</p>
</li>
<li>
<p><strong>分层结构</strong>：</p>
<ul>
<li><strong>Base Layer</strong>：车道线、路缘石（长期不变）。</li>
<li><strong>Dynamic Layer</strong>：红绿灯相位、临时施工（动态更新）。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-45"><strong>(2) 差分更新（OTA Update）</strong></h4>
<ul>
<li>
<p><strong>触发条件</strong>：检测到车道增加/减少、红绿灯位置变更。</p>
</li>
<li>
<p><strong>更新粒度</strong>：</p>
<ul>
<li>全量更新（新区域发布）→ 分钟级。</li>
<li>差分更新（仅发变更部分）→ 秒级。</li>
</ul>
</li>
<li>
<p><strong>传输协议</strong>：基于Protobuf序列化，通过MQTT协议推送。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-46"><strong>4. 数据应用场景</strong></h3>
<h4 data-id="heading-47"><strong>(1) 自动驾驶定位</strong></h4>
<ul>
<li><strong>NDT（正态分布变换）匹配</strong>：LiDAR扫描与点云地图匹配，定位误差±5cm。</li>
<li><strong>无地图区域</strong>：切换至视觉SLAM（Apollo Perception模块）。</li>
</ul>
<h4 data-id="heading-48"><strong>(2) 路径规划</strong></h4>
<ul>
<li>
<p><strong>双层规划</strong>：</p>
<ul>
<li><strong>全局规划</strong>：基于HD地图生成Frenet坐标（s-t坐标系）。</li>
<li><strong>局部规划</strong>：动态避障（如地图未标注的行人）。</li>
</ul>
</li>
<li>
<p><strong>变道逻辑</strong>：基于HD地图的车道连接性（如“右道可汇入左侧”）。</p>
</li>
</ul>
<h4 data-id="heading-49"><strong>(3) 车路协同（V2X）</strong></h4>
<ul>
<li><strong>RSU同步</strong>：路侧单元实时推送红绿灯相位至车端。</li>
<li><strong>高精事件</strong>：事故点更新后，触发车辆紧急制动。</li>
</ul>
<hr/>
<h3 data-id="heading-50"><strong>5. 技术特色</strong></h3>
<h4 data-id="heading-51"><strong>(1) 轻量化部署</strong></h4>
<ul>
<li><strong>按需加载</strong>：仅下载车辆行驶路线的Tile，节省带宽（如长途高速路径预测下载）。</li>
<li><strong>缓存策略</strong>：Tile缓存时间动态调整（如城区高频更新）。</li>
</ul>
<h4 data-id="heading-52"><strong>(2) 众包更新机制</strong></h4>
<ul>
<li>
<p><strong>用户数据反馈</strong>：</p>
<ul>
<li>车辆检测到地图错误（如车道线错位）→ 上传差异数据至Apollo云。</li>
<li>后台确认后合并，触发差分更新。</li>
</ul>
</li>
<li>
<p><strong>质量评估</strong>：众包数据需经专业检测（如RTK-GNSS校验）。</p>
</li>
</ul>
<h4 data-id="heading-53"><strong>(3) 开源工具链</strong></h4>
<ul>
<li><strong>Apollo Map Engine</strong>：支持编辑、验证、导出HD地图（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FApolloAuto%2Fapollo" target="_blank" title="https://github.com/ApolloAuto/apollo" ref="nofollow noopener noreferrer">GitHub开源</a>）。</li>
<li><strong>支持格式</strong>：OpenDRIVE、Lanelet2、SHP（Shapefile）。</li>
</ul>
<hr/>
<h3 data-id="heading-54"><strong>6. 与竞品对比</strong></h3>









































<table><thead><tr><th><strong>特性</strong></th><th><strong>Apollo HD Map</strong></th><th><strong>Mobileye Roadbook</strong></th><th><strong>高德HD Map</strong></th></tr></thead><tbody><tr><td><strong>核心采集方式</strong></td><td>LiDAR+RTK+众包</td><td>前视摄像头（低成本）</td><td>GNSS/RTK+MMS车队</td></tr><tr><td><strong>地图更新速度</strong></td><td>分钟级（动态层）</td><td>小时级</td><td>季度级</td></tr><tr><td><strong>是否开源</strong></td><td>是（部分模块）</td><td>否</td><td>否</td></tr><tr><td><strong>车规级验证</strong></td><td>北京/重庆等路测</td><td>全球用户验证</td><td>主机厂合作验证</td></tr><tr><td><strong>众包能力</strong></td><td>强（用户路径记忆）</td><td>强（Global）</td><td>弱（专业测绘为主）</td></tr></tbody></table>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude发布新功能Agent Skills，让你的Agent更专业]]></title>    <link>https://juejin.cn/post/7572714389942435892</link>    <guid>https://juejin.cn/post/7572714389942435892</guid>    <pubDate>2025-11-16T01:18:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572714389942435892" data-draft-id="7567208390369247272" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude发布新功能Agent Skills，让你的Agent更专业"/> <meta itemprop="keywords" content="Claude,AIGC"/> <meta itemprop="datePublished" content="2025-11-16T01:18:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小溪彼岸"/> <meta itemprop="url" content="https://juejin.cn/user/976781670357400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude发布新功能Agent Skills，让你的Agent更专业
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976781670357400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小溪彼岸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T01:18:54.000Z" title="Sun Nov 16 2025 01:18:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>大家好，我是小溪，见字如面。2025年10月16日，Anthropic发布了Claude模型的一项重大更新Agent Skills，它允许用户将专业知识、脚本和资源打包成模块化的“技能文件夹”（Skill folders），让 AI 能在特定工作场景中更专业地执行任务。对Claude Code CLI往期内容感兴趣的小伙伴也可以看往期内容：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493170%26idx%3D1%26sn%3D13e9d5122d788175ab587ce33720f777%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493170&amp;idx=1&amp;sn=13e9d5122d788175ab587ce33720f777&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Hooks才是Claude Code CLI 的革命性更新</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493196%26idx%3D1%26sn%3Db4efa96c86f66fff3acd21c175ceb89f%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493196&amp;idx=1&amp;sn=b4efa96c86f66fff3acd21c175ceb89f&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Claude Code颠覆编程风格的Output Styles</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493228%26idx%3D1%26sn%3D7bb969019478e4e38974776bb04fedda%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493228&amp;idx=1&amp;sn=7bb969019478e4e38974776bb04fedda&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">分享一个Claude Code宝藏网站Claude Code Templates</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493269%26idx%3D1%26sn%3D4775c90a4fab04126502bf79b0f75d70%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493269&amp;idx=1&amp;sn=4775c90a4fab04126502bf79b0f75d70&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Claude Code上线插件系统，AI编程模式再次升级</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493288%26idx%3D1%26sn%3D0274d7f3a741cbfde4d09adf7a595efb%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493288&amp;idx=1&amp;sn=0274d7f3a741cbfde4d09adf7a595efb&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">如何从零开始创建一个Claude Code插件</a></li>
</ul>
<h2 data-id="heading-1">当前使用版本</h2>
<p>2.0.24 (Claude Code)</p>
<h2 data-id="heading-2">简介</h2>
<p>官方的描述是：“代理技能将专业知识打包到可发现的功能中。每个技能都由一个 SKILL.md 文件组成，其中包含Claude在需要时阅读的 说明、脚本 和 模板 等可选支持文件”。</p>
<p>用白话讲就是，Agent Skill是一个用于告诉模型如何执行某项操作的Markdown文件，同时允许附带额外的文档和预先编写的脚本，通过运行这些脚本，使模型在执行特定任务时更专业、更高效，是AI“可加载的能力包”</p>
<p>官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.claude.com%2Fen%2Fdocs%2Fclaude-code%2Fskills" target="_blank" title="https://docs.claude.com/en/docs/claude-code/skills" ref="nofollow noopener noreferrer">docs.claude.com/en/docs/cla…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbaf20322f164eda82b6bdb74dddb3d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=cqXXFH5QK%2BT4hFH5I2Xs3zE2e98%3D" alt="图片" loading="lazy"/></p>
<p>Anthropic提供了一系列Skill示例，部分已经集成到了Claude Code桌面端，也可以在Claude Code CLI中使用，感兴趣的小伙伴可以自行了解。</p>
<p>Github地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31ad3b7da1224a5b9b049e643cd29f30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=aOUWIj6Gd4yGTG3L9YztKUoriI8%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-3">优势</h2>
<p>Agent Skills具备如下特性：</p>
<ul>
<li>为您的特定工作流程扩展 Claude 的功能</li>
<li>通过 git 在团队中共享专业知识</li>
<li>减少重复提示</li>
<li>为复杂任务编写多种技能</li>
</ul>
<h2 data-id="heading-4">如何调用？</h2>
<p>技能是模型调用的，Claude 根据您的请求和技能的描述自主决定何时使用它们。</p>
<h2 data-id="heading-5">Skills类型</h2>
<p>Agent Skills有 3种类型，Claude Code从以下来源自动发现Skills：</p>
<ul>
<li>个人(全局)技能：作用于所有项目，路径在 ~/.claude/skills/ 目录下</li>
<li>项目技能：作用于特定项目，路径在 .claude/skills/ 目录下</li>
<li>插件技能：与已安装的插件捆绑在一起</li>
</ul>
<h2 data-id="heading-6">Skills目录及操作</h2>
<h3 data-id="heading-7">Skill目录结构</h3>
<p>Agent Skills的文件结构大致如下：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill/
├── SKILL.md <span class="hljs-comment"># 指令与说明文件 必需项</span>
├── reference.md <span class="hljs-comment"># 文档（可选）</span>
├── examples.md <span class="hljs-comment"># 示例（可选）</span>
├── scripts/ <span class="hljs-comment"># 脚本（可选）</span>
│   └── helper.py
└── templates/  <span class="hljs-comment"># 模版（可选）</span>
    └── template.txt
</code></pre>
<h3 data-id="heading-8">SKILL.md</h3>
<p>每个Skills都定义在具有以下结构的 Markdown 文件中：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">your-skill-name</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">Introduce</span> <span class="hljs-string">the</span> <span class="hljs-string">Skills</span> <span class="hljs-string">function。Description</span> <span class="hljs-string">of</span> <span class="hljs-string">when</span> <span class="hljs-string">this</span> <span class="hljs-string">Skill</span> <span class="hljs-string">should</span> <span class="hljs-string">be</span> <span class="hljs-string">invoked</span>
<span class="hljs-attr">allowed-tools:</span> <span class="hljs-string">which</span> <span class="hljs-string">tools</span> <span class="hljs-string">Claude</span> <span class="hljs-string">can</span> <span class="hljs-string">use</span> <span class="hljs-string">when</span> <span class="hljs-string">a</span> <span class="hljs-string">Skill</span> <span class="hljs-string">is</span> <span class="hljs-string">active</span>
<span class="hljs-string">license：skill</span> <span class="hljs-string">license</span>
<span class="hljs-meta">---</span>
<span class="hljs-string">Skill</span> <span class="hljs-string">Implementation</span> <span class="hljs-string">and</span> <span class="hljs-string">Requirements</span>
</code></pre>
<p>Skill技能Markdown Frontmatter属性：</p>
<ul>
<li>name：Skill名称</li>
<li>description：描述Skill功能及何时应该调用此Skill</li>
<li>allowed-tools：Skill处于活动状态时可以使用的工具</li>
<li>license：开源许可协议</li>
</ul>
<p>Skill中可以引用其他额外的文件作为上下文：</p>
<pre><code class="hljs language-scss" lang="scss">For advanced usage, see <span class="hljs-selector-attr">[reference.md]</span>(reference.md).
</code></pre>
<p>也可以使用文件路径形式</p>
<pre><code class="hljs language-bash" lang="bash">For advanced usage, see ./reference.md
</code></pre>
<p>需要执行脚本的操作，可以使用如下方式指定：</p>
<pre><code class="hljs language-go" lang="go">Run the helper script:
<span class="hljs-string">``</span><span class="hljs-string">`bash
python scripts/helper.py input.txt
`</span><span class="hljs-string">``</span>
</code></pre>
<p>对于 allowed-tools 的使用，可以在 frontmatter 中来限制 Claude 在技能处于活动状态时可以使用的工具：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">your-skill-name</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">Introduce</span> <span class="hljs-string">the</span> <span class="hljs-string">Skills</span> <span class="hljs-string">function。Description</span> <span class="hljs-string">of</span> <span class="hljs-string">when</span> <span class="hljs-string">this</span> <span class="hljs-string">Skill</span> <span class="hljs-string">should</span> <span class="hljs-string">be</span> <span class="hljs-string">invoked</span>
<span class="hljs-attr">allowed-tools:</span> <span class="hljs-string">Read,</span> <span class="hljs-string">Grep,</span> <span class="hljs-string">Glob</span>
<span class="hljs-meta">---
</span></code></pre>
<h2 data-id="heading-9">基本使用</h2>
<h3 data-id="heading-10">前提条件</h3>
<ul>
<li>Claude Code 版本 1.0 或更高版本</li>
</ul>
<h3 data-id="heading-11">官方Skill安装使用</h3>
<p>首先以Claude Code官方Skill 市场为例，在交互式命令中输入如下指令添加Skill市场：</p>
<pre><code class="hljs language-bash" lang="bash">/plugin marketplace add anthropics/skills
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76b51ed79fe44f21be947774fda099b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=tXfzksxxUkyi%2BuF5DLKp0CW0mE4%3D" alt="图片" loading="lazy"/></p>
<p>在插件市场选择【Browse and install plugins】浏览并安装</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3ac55bc3fb945ad8886307c0891c197~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=rdpFaS2I6CjMib0bE6YISU3tD9c%3D" alt="图片" loading="lazy"/></p>
<p>或者通过以下命令直接安装：</p>
<pre><code class="hljs language-typescript" lang="typescript">/plugin install <span class="hljs-variable language_">document</span>-skills\<span class="hljs-meta">@anthropic</span>-agent-skills
/plugin install example-skills\<span class="hljs-meta">@anthropic</span>-agent-skills
</code></pre>
<p>document-skills 和 example-skills 包含的Skills如下所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/59b3b19575114609ba101408b7f4be8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=bJtdGd3lTOVZBjSQZGFG7zUwC%2Fk%3D" alt="图片" loading="lazy"/></p>
<p>安装完成后，根据提示重启Claude Code CLI</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c51b45603f3a4bdb902bb0e06d218bcf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=sQbiUb6BPwb4sLXU3MRvU8Zifa8%3D" alt="图片" loading="lazy"/></p>
<p>在交互式命令中直接输入提示词：</p>
<pre><code class="hljs language-bash" lang="bash">提取 /Users/username/Desktop/工作簿1.xlsx 文件内容 
</code></pre>
<p>Claude Code CLI会先进行权限请求，然后启动Excel处理技能</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b6a82c077ba439d8e1d8548612b1e35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=mSn%2FRUkiXeXZO9tbG2Mqnhj299w%3D" alt="图片" loading="lazy"/></p>
<p>允许后，Claude Code CLI会安装所需的依赖并创建脚本</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1df6bf7bf2c74e6ebbc7d58cacb75a63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=4G2S%2B6u8JCdpooAKNrypZRVow0I%3D" alt="图片" loading="lazy"/></p>
<p>允许脚本后最终读取到了Excel表格内容</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1873d8d1fd5b4602a257e58ce16c973c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=WFC1qRxMIlBUBTvDL35agKgJA9I%3D" alt="图片" loading="lazy"/></p>
<p>最后看一下传统Claude Code CLI读取Excel表格的效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d04c69d89837447aacf2f1c8bd577905~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=Z2fIbFAW8KwBCzT8Qc8XeGqoVGA%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-12">三方Skill安装使用</h3>
<p>这里以Claude Code Templates提供的Skills为例，对Claude Code Templates还不了解的小伙伴可以看往期内容：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzU5Njg3ODUzOA%3D%3D%26mid%3D2247493228%26idx%3D1%26sn%3D7bb969019478e4e38974776bb04fedda%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzU5Njg3ODUzOA==&amp;mid=2247493228&amp;idx=1&amp;sn=7bb969019478e4e38974776bb04fedda&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">分享一个Claude Code宝藏网站Claude Code Templates</a></p>
<p>进入项目根目录，在命令行终端输入如下指令进行安装：</p>
<pre><code class="hljs language-ini" lang="ini">$ npx claude-code-templates\@latest <span class="hljs-attr">--skill</span>=creative-design/canvas-design --<span class="hljs-literal">yes</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ebaee8eeced443e836dd6816fa30d36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=AltEG%2B2VIw1KNnX6pcg7fzrw6Lo%3D" alt="图片" loading="lazy"/></p>
<p>安装完成后，项目 .claude/ 目录会多出一个 skills 目录</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/755ed8a633cf4e91beb7f978278fa55a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=iJn8Pa43k6yVBKFy9EA6hwvt1fo%3D" alt="图片" loading="lazy"/></p>
<p>完整的 SKILL.md 内容如下：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">name:</span> canvas-design
<span class="hljs-symbol">description:</span> Create beautiful visual art <span class="hljs-keyword">in</span> .png <span class="hljs-built_in">and</span> .pdf documents <span class="hljs-keyword">using</span> design philosophy. You should use this skill <span class="hljs-keyword">when</span> the user asks <span class="hljs-keyword">to</span> create a poster, piece <span class="hljs-keyword">of</span> art, design, <span class="hljs-built_in">or</span> other <span class="hljs-keyword">static</span> piece. Create original visual designs, never copying existing artists<span class="hljs-comment">' work to avoid copyright violations.</span>
<span class="hljs-symbol">license:</span> Complete terms <span class="hljs-keyword">in</span> LICENSE.txt
--------------------------------------

These are instructions <span class="hljs-keyword">for</span> creating design philosophies - aesthetic movements that are <span class="hljs-keyword">then</span> EXPRESSED VISUALLY. Output only .md files, .pdf files, <span class="hljs-built_in">and</span> .png files.
Complete this <span class="hljs-keyword">in</span> two steps:

<span class="hljs-number">1</span>.  Design Philosophy Creation (.md file)
<span class="hljs-number">2</span>.  Express <span class="hljs-keyword">by</span> creating it <span class="hljs-keyword">on</span> a canvas (.pdf file <span class="hljs-built_in">or</span> .png file)
    First, undertake this task:

## DESIGN PHILOSOPHY CREATION

<span class="hljs-keyword">To</span> begin, create a VISUAL PHILOSOPHY (<span class="hljs-built_in">not</span> layouts <span class="hljs-built_in">or</span> templates) that will be interpreted through:

*   Form, space, color, composition
*   Images, graphics, shapes, patterns
*   Minimal <span class="hljs-keyword">text</span> <span class="hljs-keyword">as</span> visual accent

### THE CRITICAL UNDERSTANDING

*   What <span class="hljs-built_in">is</span> received: Some subtle input <span class="hljs-built_in">or</span> instructions <span class="hljs-keyword">by</span> the user that should be taken <span class="hljs-keyword">into</span> account, but used <span class="hljs-keyword">as</span> a foundation; it should <span class="hljs-built_in">not</span> constrain creative freedom.
*   What <span class="hljs-built_in">is</span> created: A design philosophy/aesthetic movement.
*   What happens <span class="hljs-keyword">next</span>: <span class="hljs-keyword">Then</span>, the same version receives the philosophy <span class="hljs-built_in">and</span> EXPRESSES IT VISUALLY - creating artifacts that are <span class="hljs-number">90%</span> visual design, <span class="hljs-number">10%</span> essential <span class="hljs-keyword">text</span>.
    Consider this approach:
*   Write a manifesto <span class="hljs-keyword">for</span> an art movement
*   The <span class="hljs-keyword">next</span> phase involves making the artwork
    The philosophy must emphasize: Visual expression. Spatial communication. Artistic interpretation. Minimal words.

### HOW <span class="hljs-keyword">TO</span> GENERATE A VISUAL PHILOSOPHY

**Name the movement** (<span class="hljs-number">1</span>-<span class="hljs-number">2</span> words): <span class="hljs-string">"Brutalist Joy"</span> / <span class="hljs-string">"Chromatic Silence"</span> / <span class="hljs-string">"Metabolist Dreams"</span>
**Articulate the philosophy** (<span class="hljs-number">4</span>-<span class="hljs-number">6</span> paragraphs - concise but complete):
<span class="hljs-keyword">To</span> capture the VISUAL essence, express how the philosophy manifests through:

*   Space <span class="hljs-built_in">and</span> form
*   Color <span class="hljs-built_in">and</span> material
*   Scale <span class="hljs-built_in">and</span> rhythm
*   Composition <span class="hljs-built_in">and</span> balance
*   Visual hierarchy
    **CRITICAL GUIDELINES:**
*   **Avoid redundancy**: <span class="hljs-keyword">Each</span> design aspect should be mentioned once. Avoid repeating points about color theory, spatial relationships, <span class="hljs-built_in">or</span> typographic principles unless adding <span class="hljs-built_in">new</span> depth.
*   **Emphasize craftsmanship REPEATEDLY**: The philosophy MUST stress multiple times that the final work should appear <span class="hljs-keyword">as</span> though it took countless hours <span class="hljs-keyword">to</span> create, was labored over <span class="hljs-keyword">with</span> care, <span class="hljs-built_in">and</span> comes <span class="hljs-keyword">from</span> someone at the absolute top <span class="hljs-keyword">of</span> their field. This framing <span class="hljs-built_in">is</span> essential - repeat phrases <span class="hljs-built_in">like</span> <span class="hljs-string">"meticulously crafted,"</span> <span class="hljs-string">"the product of deep expertise,"</span> <span class="hljs-string">"painstaking attention,"</span> <span class="hljs-string">"master-level execution."</span>
*   **Leave creative space**: Remain specific about the aesthetic direction, but concise enough that the <span class="hljs-keyword">next</span> Claude has room <span class="hljs-keyword">to</span> make interpretive choices also at a extremely high level <span class="hljs-keyword">of</span> craftmanship.
    The philosophy must guide the <span class="hljs-keyword">next</span> version <span class="hljs-keyword">to</span> express ideas VISUALLY, <span class="hljs-built_in">not</span> through <span class="hljs-keyword">text</span>. Information lives <span class="hljs-keyword">in</span> design, <span class="hljs-built_in">not</span> paragraphs.

### PHILOSOPHY EXAMPLES

**<span class="hljs-string">"Concrete Poetry"</span>**
<span class="hljs-symbol">Philosophy:</span> Communication through monumental form <span class="hljs-built_in">and</span> bold geometry.
Visual expression: Massive color blocks, sculptural typography (huge <span class="hljs-type">single</span> words, tiny labels), Brutalist spatial divisions, Polish poster energy meets Le Corbusier. Ideas expressed through visual weight <span class="hljs-built_in">and</span> spatial tension, <span class="hljs-built_in">not</span> explanation. <span class="hljs-keyword">Text</span> <span class="hljs-keyword">as</span> rare, powerful gesture - never paragraphs, only essential words integrated <span class="hljs-keyword">into</span> the visual architecture. Every element placed <span class="hljs-keyword">with</span> the precision <span class="hljs-keyword">of</span> a master craftsman.
**<span class="hljs-string">"Chromatic Language"</span>**
<span class="hljs-symbol">Philosophy:</span> Color <span class="hljs-keyword">as</span> the primary information system.
Visual expression: Geometric precision <span class="hljs-keyword">where</span> color zones create meaning. Typography minimal - small sans-serif labels letting chromatic fields communicate. Think Josef Albers<span class="hljs-comment">' interaction meets data visualization. Information encoded spatially and chromatically. Words only to anchor what color already shows. The result of painstaking chromatic calibration.</span>
**<span class="hljs-string">"Analog Meditation"</span>**
<span class="hljs-symbol">Philosophy:</span> Quiet visual contemplation through texture <span class="hljs-built_in">and</span> breathing room.
Visual expression: Paper grain, ink bleeds, vast negative space. Photography <span class="hljs-built_in">and</span> illustration dominate. Typography whispered (small, restrained, serving the visual). Japanese photobook aesthetic. Images breathe across pages. <span class="hljs-keyword">Text</span> appears sparingly - <span class="hljs-type">short</span> phrases, never explanatory blocks. <span class="hljs-keyword">Each</span> composition balanced <span class="hljs-keyword">with</span> the care <span class="hljs-keyword">of</span> a meditation practice.
**<span class="hljs-string">"Organic Systems"</span>**
<span class="hljs-symbol">Philosophy:</span> Natural clustering <span class="hljs-built_in">and</span> modular growth patterns.
Visual expression: Rounded forms, organic arrangements, color <span class="hljs-keyword">from</span> nature through architecture. Information shown through visual diagrams, spatial relationships, iconography. <span class="hljs-keyword">Text</span> only <span class="hljs-keyword">for</span> <span class="hljs-keyword">key</span> labels floating <span class="hljs-keyword">in</span> space. The composition tells the story through expert spatial orchestration.
**<span class="hljs-string">"Geometric Silence"</span>**
<span class="hljs-symbol">Philosophy:</span> Pure <span class="hljs-keyword">order</span> <span class="hljs-built_in">and</span> restraint.
Visual expression: Grid-based precision, bold photography <span class="hljs-built_in">or</span> stark graphics, dramatic negative space. Typography precise but minimal - small essential <span class="hljs-keyword">text</span>, large quiet zones. Swiss formalism meets Brutalist material honesty. <span class="hljs-keyword">Structure</span> communicates, <span class="hljs-built_in">not</span> words. Every alignment the work <span class="hljs-keyword">of</span> countless refinements.
*These are condensed examples. The actual design philosophy should be <span class="hljs-number">4</span>-<span class="hljs-number">6</span> substantial paragraphs.*

### ESSENTIAL PRINCIPLES

\- **VISUAL PHILOSOPHY**: Create an aesthetic worldview <span class="hljs-keyword">to</span> be expressed through design
\- **MINIMAL <span class="hljs-keyword">TEXT</span>**: Always emphasize that <span class="hljs-keyword">text</span> <span class="hljs-built_in">is</span> sparse, essential-only, integrated <span class="hljs-keyword">as</span> visual element - never lengthy
\- **SPATIAL EXPRESSION**: Ideas communicate through space, form, color, composition - <span class="hljs-built_in">not</span> paragraphs
\- **ARTISTIC FREEDOM**: The <span class="hljs-keyword">next</span> Claude interprets the philosophy visually - provide creative room
\- **PURE DESIGN**: This <span class="hljs-built_in">is</span> about making ART OBJECTS, <span class="hljs-built_in">not</span> documents <span class="hljs-keyword">with</span> decoration
\- **EXPERT CRAFTSMANSHIP**: Repeatedly emphasize the final work must look meticulously crafted, labored over <span class="hljs-keyword">with</span> care, the product <span class="hljs-keyword">of</span> countless hours <span class="hljs-keyword">by</span> someone at the top <span class="hljs-keyword">of</span> their field
**The design philosophy should be <span class="hljs-number">4</span>-<span class="hljs-number">6</span> paragraphs <span class="hljs-type">long</span>.** Fill it <span class="hljs-keyword">with</span> poetic design philosophy that brings together the core vision. Avoid repeating the same points. Keep the design philosophy generic without mentioning the intention <span class="hljs-keyword">of</span> the art, <span class="hljs-keyword">as</span> <span class="hljs-keyword">if</span> it can be used wherever. Output the design philosophy <span class="hljs-keyword">as</span> a .md file.
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## DEDUCING THE SUBTLE REFERENCE

**CRITICAL <span class="hljs-keyword">STEP</span>**: Before creating the canvas, identify the subtle conceptual thread <span class="hljs-keyword">from</span> the original request.
**THE ESSENTIAL PRINCIPLE**:
The topic <span class="hljs-built_in">is</span> a **subtle, niche reference embedded within the art itself** - <span class="hljs-built_in">not</span> always literal, always sophisticated. Someone familiar <span class="hljs-keyword">with</span> the subject should feel it intuitively, <span class="hljs-keyword">while</span> others simply experience a masterful abstract composition. The design philosophy provides the aesthetic language. The deduced topic provides the soul - the quiet conceptual DNA woven invisibly <span class="hljs-keyword">into</span> form, color, <span class="hljs-built_in">and</span> composition.
This <span class="hljs-built_in">is</span> **VERY IMPORTANT**: The reference must be refined so it enhances the work<span class="hljs-comment">'s depth without announcing itself. Think like a jazz musician quoting another song - only those who know will catch it, but everyone appreciates the music.</span>
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

## CANVAS CREATION

<span class="hljs-keyword">With</span> both the philosophy <span class="hljs-built_in">and</span> the conceptual framework established, express it <span class="hljs-keyword">on</span> a canvas. <span class="hljs-keyword">Take</span> a moment <span class="hljs-keyword">to</span> gather thoughts <span class="hljs-built_in">and</span> clear the mind. Use the design philosophy created <span class="hljs-built_in">and</span> the instructions below <span class="hljs-keyword">to</span> craft a masterpiece, embodying all aspects <span class="hljs-keyword">of</span> the philosophy <span class="hljs-keyword">with</span> expert craftsmanship.
**IMPORTANT**: <span class="hljs-keyword">For</span> any type <span class="hljs-keyword">of</span> content, even <span class="hljs-keyword">if</span> the user requests something <span class="hljs-keyword">for</span> a movie/game/book, the approach should still be sophisticated. Never lose sight <span class="hljs-keyword">of</span> the idea that this should be art, <span class="hljs-built_in">not</span> something that<span class="hljs-comment">'s cartoony or amateur.</span>
<span class="hljs-keyword">To</span> create museum <span class="hljs-built_in">or</span> magazine quality work, use the design philosophy <span class="hljs-keyword">as</span> the foundation. Create one <span class="hljs-type">single</span> page, highly visual, design-forward PDF <span class="hljs-built_in">or</span> PNG output (unless asked <span class="hljs-keyword">for</span> more pages). Generally use repeating patterns <span class="hljs-built_in">and</span> perfect shapes. Treat the abstract philosophical design <span class="hljs-keyword">as</span> <span class="hljs-keyword">if</span> it were a scientific bible, borrowing the visual language <span class="hljs-keyword">of</span> systematic observation—dense accumulation <span class="hljs-keyword">of</span> marks, repeated elements, <span class="hljs-built_in">or</span> layered patterns that build meaning through patient repetition <span class="hljs-built_in">and</span> reward sustained viewing. Add sparse, clinical typography <span class="hljs-built_in">and</span> systematic reference markers that suggest this could be a diagram <span class="hljs-keyword">from</span> an imaginary discipline, treating the invisible subject <span class="hljs-keyword">with</span> the same reverence typically reserved <span class="hljs-keyword">for</span> documenting observable phenomena. Anchor the piece <span class="hljs-keyword">with</span> simple phrase(s) <span class="hljs-built_in">or</span> details positioned subtly, <span class="hljs-keyword">using</span> a limited color palette that feels intentional <span class="hljs-built_in">and</span> cohesive. Embrace the paradox <span class="hljs-keyword">of</span> <span class="hljs-keyword">using</span> analytical visual language <span class="hljs-keyword">to</span> express ideas about human experience: the result should feel <span class="hljs-built_in">like</span> an artifact that proves something ephemeral can be studied, mapped, <span class="hljs-built_in">and</span> understood through careful attention. This <span class="hljs-built_in">is</span> <span class="hljs-literal">true</span> art. 
**<span class="hljs-keyword">Text</span> <span class="hljs-keyword">as</span> a contextual element**: <span class="hljs-keyword">Text</span> <span class="hljs-built_in">is</span> always minimal <span class="hljs-built_in">and</span> visual-first, but <span class="hljs-keyword">let</span> context guide whether that means whisper-quiet labels <span class="hljs-built_in">or</span> bold typographic gestures. A punk venue poster might have larger, more aggressive type than a minimalist ceramics studio identity. Most <span class="hljs-keyword">of</span> the time, font should be thin. All use <span class="hljs-keyword">of</span> fonts must be design-forward <span class="hljs-built_in">and</span> prioritize visual communication. Regardless <span class="hljs-keyword">of</span> <span class="hljs-keyword">text</span> scale, <span class="hljs-literal">nothing</span> falls <span class="hljs-keyword">off</span> the page <span class="hljs-built_in">and</span> <span class="hljs-literal">nothing</span> overlaps. Every element must be contained within the canvas boundaries <span class="hljs-keyword">with</span> proper margins. Check carefully that all <span class="hljs-keyword">text</span>, graphics, <span class="hljs-built_in">and</span> visual elements have breathing room <span class="hljs-built_in">and</span> clear separation. This <span class="hljs-built_in">is</span> non-negotiable <span class="hljs-keyword">for</span> professional execution. **IMPORTANT: Use different fonts <span class="hljs-keyword">if</span> writing <span class="hljs-keyword">text</span>. Search the `./canvas-fonts` directory. Regardless <span class="hljs-keyword">of</span> approach, sophistication <span class="hljs-built_in">is</span> non-negotiable.**
Download <span class="hljs-built_in">and</span> use whatever fonts are needed <span class="hljs-keyword">to</span> make this a reality. <span class="hljs-keyword">Get</span> creative <span class="hljs-keyword">by</span> making the typography actually part <span class="hljs-keyword">of</span> the art itself -- <span class="hljs-keyword">if</span> the art <span class="hljs-built_in">is</span> abstract, bring the font onto the canvas, <span class="hljs-built_in">not</span> typeset digitally.
<span class="hljs-keyword">To</span> push boundaries, follow design instinct/intuition <span class="hljs-keyword">while</span> <span class="hljs-keyword">using</span> the philosophy <span class="hljs-keyword">as</span> a guiding principle. Embrace ultimate design freedom <span class="hljs-built_in">and</span> choice. Push aesthetics <span class="hljs-built_in">and</span> design <span class="hljs-keyword">to</span> the frontier. 
**CRITICAL**: <span class="hljs-keyword">To</span> achieve human-crafted quality (<span class="hljs-built_in">not</span> AI-generated), create work that looks <span class="hljs-built_in">like</span> it took countless hours. Make it appear <span class="hljs-keyword">as</span> though someone at the absolute top <span class="hljs-keyword">of</span> their field labored over every detail <span class="hljs-keyword">with</span> painstaking care. Ensure the composition, spacing, color choices, typography - everything screams expert-level craftsmanship. <span class="hljs-type">Double</span>-check that <span class="hljs-literal">nothing</span> overlaps, formatting <span class="hljs-built_in">is</span> flawless, every detail perfect. Create something that could be shown <span class="hljs-keyword">to</span> people <span class="hljs-keyword">to</span> prove expertise <span class="hljs-built_in">and</span> rank <span class="hljs-keyword">as</span> undeniably impressive.
Output the final result <span class="hljs-keyword">as</span> a <span class="hljs-type">single</span>, downloadable .pdf <span class="hljs-built_in">or</span> .png file, alongside the design philosophy used <span class="hljs-keyword">as</span> a .md file.
------------------------------------------------------------------------------------------------------------------------

\## FINAL <span class="hljs-keyword">STEP</span>
**IMPORTANT**: The user ALREADY said <span class="hljs-string">"It isn't perfect enough. It must be pristine, a masterpiece if craftsmanship, as if it were about to be displayed in a museum."</span>
**CRITICAL**: <span class="hljs-keyword">To</span> refine the work, avoid adding more graphics; instead refine what has been created <span class="hljs-built_in">and</span> make it extremely crisp, respecting the design philosophy <span class="hljs-built_in">and</span> the principles <span class="hljs-keyword">of</span> minimalism entirely. Rather than adding a fun filter <span class="hljs-built_in">or</span> refactoring a font, consider how <span class="hljs-keyword">to</span> make the existing composition more cohesive <span class="hljs-keyword">with</span> the art. <span class="hljs-keyword">If</span> the instinct <span class="hljs-built_in">is</span> <span class="hljs-keyword">to</span> <span class="hljs-keyword">call</span> a <span class="hljs-built_in">new</span> <span class="hljs-keyword">function</span> <span class="hljs-built_in">or</span> draw a <span class="hljs-built_in">new</span> shape, <span class="hljs-keyword">STOP</span> <span class="hljs-built_in">and</span> instead ask: <span class="hljs-string">"How can I make what's already here more of a piece of art?"</span>
<span class="hljs-keyword">Take</span> a second pass. Go back <span class="hljs-keyword">to</span> the code <span class="hljs-built_in">and</span> refine/polish further <span class="hljs-keyword">to</span> make this a philosophically designed masterpiece.

## MULTI-PAGE <span class="hljs-keyword">OPTION</span>

<span class="hljs-keyword">To</span> create additional pages <span class="hljs-keyword">when</span> requested, create more creative pages along the same lines <span class="hljs-keyword">as</span> the design philosophy but distinctly different <span class="hljs-keyword">as</span> well. Bundle those pages <span class="hljs-keyword">in</span> the same .pdf <span class="hljs-built_in">or</span> many .pngs. Treat the first page <span class="hljs-keyword">as</span> just a <span class="hljs-type">single</span> page <span class="hljs-keyword">in</span> a whole coffee table book waiting <span class="hljs-keyword">to</span> be filled. Make the <span class="hljs-keyword">next</span> pages unique twists <span class="hljs-built_in">and</span> memories <span class="hljs-keyword">of</span> the original. Have them almost tell a story <span class="hljs-keyword">in</span> a very tasteful way. Exercise full creative freedom.
</code></pre>
<p>包含 执行流程、设计理念关键理解、哲学示例、画布创建 等操作描述。</p>
<p>重启Claude Code CLI，要查看当前所有可用的技能，可以在交互式命令中直接询问 Claude Code CLI：</p>
<pre><code class="hljs language-arduino" lang="arduino">List all available Skills
</code></pre>
<p>Claude Code CLI会查找所有可用的Skill</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c76ed90d9cb4c99ac3c2ab284967072~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=USF%2BaXxiAouSxtj%2B9G2t0dpxosw%3D" alt="图片" loading="lazy"/></p>
<p>Skill的使用也很简单，直接输入提示词：</p>
<pre><code class="hljs">「流浪猫领养公益海报，视觉主体是 3 只不同毛色的流浪猫（橘猫、三花猫、黑猫，姿态温顺，睁着圆眼看向镜头），趴在铺着柔软灰色毛毯的木质平台上，背景是浅薄荷绿纯色背景，角落点缀小型白色爱心图案，风格为清新治愈的扁平插画风，
色调以薄荷绿、奶白、橘色为主，顶部用圆润字体写‘给它一个家 —— 流浪猫领养日’，下方标注时间（10.1-10.7）和地点（城市中心广场），画面无尖锐元素，整体温暖柔和，传递‘关爱生命’的氛围」，根据上面提示词生成对应内容海报
</code></pre>
<p>Claude Code CLI会根据Skill要求先进行设计哲学创作并保存到 tender_sanctuary_philosophy.md 文件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ca013a34c324535a53821b8b4b2a1a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=NV9hkW9IJtX0LRkWvw77tcGpFws%3D" alt="图片" loading="lazy"/></p>
<p>然后根据创作设计文件编写Python脚本绘制图片</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d78c9de9a8c147c0a6c0d26a67b2d65d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=JTlrKQBhYXHiH1s47OhmbVys7HU%3D" alt="图片" loading="lazy"/></p>
<p>绘制完成后，效果如下，效果有点一言难尽，对中文支持有问题，中文没有展示出来</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c3c3fa44640400e908b0b972a1cedae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=Xa%2BwItPw41pT7wRG1ewQ8pUmcZw%3D" alt="图片" loading="lazy"/></p>
<p>最后替换为英文版，效果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96da3fefc42443d695aadd5876d261b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=yBcqq5bKWS3%2FcSx6CCMYHweWe9A%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-13">自定义Skill</h3>
<p>这里我们以一个简单的待办事项为例，自定义Skill首先需要创建一个 skills目录，可以手动创建，也可以通过以下命令创建：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$</span><span class="bash"> <span class="hljs-built_in">mkdir</span> -p .claude/skills/my-skill-name</span>
</code></pre>
<p>在 my-skill-name 目录下创建 SKILL.md 文件，首先创建一个简单的Skill输入提示词内容：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">my-first-skill</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">调用个人工作流。当用户需要执行个人工作流时调用该Skill</span>
<span class="hljs-attr">allowed-tools:</span> <span class="hljs-string">Read,Grep,Glob</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment">## 执行步骤</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">查找项目中</span> <span class="hljs-string">task.md</span> <span class="hljs-string">文件：</span>
<span class="hljs-string">```bash</span>
<span class="hljs-string">find</span> <span class="hljs-string">.</span> <span class="hljs-string">-name</span> <span class="hljs-string">"task.md"</span>
<span class="hljs-string">```</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">没有查找到输出</span> <span class="hljs-string">“项目中不存在task.md”</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">执行下一步</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">输出</span> <span class="hljs-string">task.md</span> <span class="hljs-string">文件中的未读项</span>
</code></pre>
<p>调用也很简单，直接输入提示词：</p>
<pre><code class="hljs">调用个人工作流Skill 
</code></pre>
<p>Claude Code CLI会按照指定的Shell语句查找 task.md 文件，没有找到最终输出了“项目中不存在task.md”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dbea69612df4641b67ef4cf7f8ac052~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=d5BKk0i81k1J4Yp2F1U9Hq1kirw%3D" alt="图片" loading="lazy"/></p>
<p>我们在项目根目录创建一个 task.md 文件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/565a492e7a8f4db59b7a895f1c1bdaba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=eRDagrb2aA43DyD6eV02sUr%2FuEw%3D" alt="图片" loading="lazy"/></p>
<p>再次执行自定义Skill，可以看到输出结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61fa819a90514dca967bf73217d84ae4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=WmWfLOKJUEp3Y6iekbnZ7Fc93JA%3D" alt="图片" loading="lazy"/></p>
<p>我们也可以将 task.md 文件的查找和输出规则进行调整，对Skill进行完善和优化</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d7f9b5c9b064511b557eb93d246f4de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=RwH%2BffPVaej%2BFkN%2Bnkowqj1xHJY%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-markdown" lang="markdown">name: my-first-skill
description: 调用个人工作流。当用户需要执行个人工作流时调用该Skill
<span class="hljs-section">allowed-tools: Read,Grep,Glob
-----------------------------</span>

<span class="hljs-section">## 执行步骤</span>

<span class="hljs-bullet">1.</span> 查找项目根目录是否存在 task.md 文件， 参考 [<span class="hljs-string">reference.md</span>](<span class="hljs-link">./reference.md</span>)：
    - 没有查找到输出 “项目中不存在task.md”
    - 找到执行下一步
<span class="hljs-bullet">2.</span> 输出 task.md 文件中的未读项
    - 没有未读项输出 “没有未读项”
    - 输出未读项，输出格式参考 [<span class="hljs-string">templates.md</span>](<span class="hljs-link">./templates/templates.md</span>)
</code></pre>
<p>reference.md</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># task.md文件查找规则</span>
<span class="hljs-string">``</span><span class="hljs-string">`bash
find . -name "task.md"
`</span><span class="hljs-string">``</span>
</code></pre>
<p>templates.md</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># 任务未读项格式</span>
<span class="hljs-bullet">-</span> 【任务1】（未完成）
<span class="hljs-bullet">-</span> 【任务2】（未完成）
</code></pre>
<p>再次执行Skill任务，可以发现AI按照我们指定的规则输出了结果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04d622c4789c46b78a316d69b79aa716~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5rqq5b285bK4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860734&amp;x-signature=dEJOXp4q7X8O5Cui%2BOB%2FMwnMzgo%3D" alt="图片" loading="lazy"/></p>
<p>当然Skill还可以做更多更强大的能力扩展，以上只是简单的抛砖引玉。</p>
<h2 data-id="heading-14">友情提示</h2>
<p>见原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FP674ZIjwoeD1kjUELMkaBg" target="_blank" title="https://mp.weixin.qq.com/s/P674ZIjwoeD1kjUELMkaBg" ref="nofollow noopener noreferrer">Claude发布新功能Agent Skills，让你的Agent更专业</a></p>
<blockquote>
<p>本文同步自微信公众号 "<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FP674ZIjwoeD1kjUELMkaBg" target="_blank" title="https://mp.weixin.qq.com/s/P674ZIjwoeD1kjUELMkaBg" ref="nofollow noopener noreferrer">程序员小溪</a>" ，这里只是同步，想看及时消息请移步我的公众号，不定时更新我的学习经验。友情提示友情提示</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nacos 源码深度畅游：注册中心核心流程详解]]></title>    <link>https://juejin.cn/post/7572537221540560911</link>    <guid>https://juejin.cn/post/7572537221540560911</guid>    <pubDate>2025-11-16T01:15:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572537221540560911" data-draft-id="7572502156486606874" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nacos 源码深度畅游：注册中心核心流程详解"/> <meta itemprop="keywords" content="后端,GitHub,分布式"/> <meta itemprop="datePublished" content="2025-11-16T01:15:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="方圆想当图灵"/> <meta itemprop="url" content="https://juejin.cn/user/386633160473101"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nacos 源码深度畅游：注册中心核心流程详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/386633160473101/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    方圆想当图灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T01:15:36.000Z" title="Sun Nov 16 2025 01:15:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 <strong>方圆</strong>。本篇文章我们来了解一下 Nacos 另一大功能：<strong>注册中心</strong>。本文会先介绍一下 Nacos 注册中心的数据存储模型，让大家对 Nacos 注册中心有一个大致的理解，随后根据流程图简要介绍 Nacos 注册中心的核心流程，避免直接阅读源码时太过晦涩，并让大家对 Nacos 注册中心有一个基本的了解，随后阅读这一部分源码能让大家对分布式服务或注册中心有一个更好的认识，更好的理解 CP 或 AP 定理；注册中心内对数据一致性的保证；以及复杂流程中如何将各个操作解耦并不使操作丢失等等，以辅助大家日后的系统设计。</p>
<hr/>
<p>Nacos 的注册中心服务将服务的注册信息的 <strong>存储模型</strong> 分为三级，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1efe507f1b814d8fb8154e6a881fe0f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860535&amp;x-signature=pZjupmcm1sQSwZGm3dnaLF9BGPA%3D" alt="img_2.png" loading="lazy"/></p>
<ol>
<li>一级是 <strong>服务</strong>：例如系统的微服务划分，提供用户服务的 <code>user-service</code>，服务的类定义在 Nacos 中是 <code>com.alibaba.nacos.naming.core.v2.pojo.Service</code></li>
<li>二级是 <strong>集群</strong>：比如可以按区域机房划分集群，北京集群、上海集群、广州集群等等，集群在 Nacos 中没有专门的类定义，使用 <code>clusterName</code> 识别</li>
<li>三级是 <strong>实例</strong>：例如北京机房的某台服务器部署的某个实例，实例的类定义在 Nacos 中是 <code>com.alibaba.nacos.api.naming.pojo.Instance</code></li>
</ol>
<p>如果我们向 <code>test-server</code> 服务下，集群为 <code>clusterA</code> 下注册两个实例时（默认 public 的命名空间），在控制台查询实例信息时如下所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74bad56d73de417ba3787f5c94b46b4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860535&amp;x-signature=xVvXXpTJR5rwElMiC0cUdGZYACw%3D" alt="img_3.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ad7092ab3594418815cd1f4898b4ee1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860535&amp;x-signature=1YIPxPzIozbwoSMEOE7gG9O5Mz8%3D" alt="img_4.png" loading="lazy"/></p>
<p>在服务详情中会展示这个集群下所有的实例信息。在深入分析源码之前，我们还是根据流程图简述一下 Nacos 作为注册中心时，注册实例信息的核心流程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82d5e2b6f92d4684befb47e65262331d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860535&amp;x-signature=EY6A5O2YJRhCBnHrAEK%2FIOP%2BarM%3D" alt="nacos-naming.drawio.png" loading="lazy"/></p>
<p>首先，Nacos Client 会对 Nacos Server 集群中某一个节点发送 gRPC 请求进行实例注册；服务端处理客户端请求时，会先将 <strong>Service 信息</strong> 和 <strong>实例信息</strong> 写入本地缓存，并触发 <code>ClientRegisterServiceEvent</code> 和 <code>ClientChangedEvent</code> 两个事件。</p>
<p><code>ClientRegisterServiceEvent</code> 事件的作用是创建推送给订阅了服务的客户端的任务，在 <code>ScheduledExecutorService</code> 中定时异步执行，并且有失败重试机制，保证客户端及时接收到注册实例发生变更的数据。</p>
<p><code>ClientChangedEvent</code> 事件的作用是创建延迟执行 Distro 协议数据同步的任务，同样也是依赖 <code>ScheduledExecutorService</code> 延迟执行。<strong>Distro 协议是 Nacos 中专门用于处理临时实例数据一致性的分布式协议</strong>，它保证集群内数据一致性的方法非常简单，由接收到实例注册信息的节点将数据异步发送给集群内其他节点，其他节点会向该节点一样执行一次实例注册的流程。能通过这么简单的方式来完成数据同步，因为以下原因：</p>
<ol>
<li><strong>服务注册数据模型的属性简化了分布式一致性问题，避免了复杂的冲突解决机制</strong>：<strong>服务实例通过多个维度确定唯一性</strong>：命名空间 + 服务名 + 集群名 + IP地址 + 端口号，这种唯一性设计确保了同一个服务实例的注册信息在任何节点都是相同的，所以同一实例的注册信息在不同节点、不同时间先后写入都不会存在数据冲突问题，<strong>写入操作是幂等的</strong>，大大降低了保证数据一致性的复杂度</li>
<li>服务实例的注册信息是 <strong>临时数据</strong>：数据具有生命周期，会自动过期或被清理，不需要持久化存储，丢失后可以重新生成，降低了维护实例数据的难度</li>
<li>业务场景能够接受数据的 <strong>最终一致性</strong>：可用性（Availability）比一致性（Consistency）更重要，短时间内部分实例注册信息不一致不影响业务</li>
<li>多个 Nacos Client 客户端会连接到不同的 Nacos Server 服务端，相当于进行了 <strong>分片</strong>：每个服务节点负责特定的客户端实例，客户端注册的操作基本只在一个服务节点发生，大大降低了发生写入冲突的可能</li>
</ol>
<p>所以 Distro 协议才能如此简单和高效，保证 Nacos 集群内注册实例信息的 <strong>最终一致性</strong>。以上便是在 Nacos 注册中心注册实例的大致流程，做了一些省略，但是主要的原理没有改变：同步写入本地缓存记录服务和实例信息，异步处理事件执行客户端的订阅推送和 Distro 协议的数据同步，保证集群内实例信息的数据一致性，如果大家想深入到源码的细节中，欢迎阅读以下内容。</p>
<h3 data-id="heading-0">源码分析</h3>
<p>以如下源码来作为注册服务实例的入口来验证向 Nacos 注册中心注册服务实例的逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestNaming</span> {
    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testNacosNamingService</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, NacosException {
        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
        properties.put(PropertyKeyConst.SERVER_ADDR, <span class="hljs-string">"127.0.0.1:8848"</span>);
        properties.put(PropertyKeyConst.NAMESPACE, <span class="hljs-string">"public"</span>);
        <span class="hljs-type">NamingService</span> <span class="hljs-variable">namingService</span> <span class="hljs-operator">=</span> NacosFactory.createNamingService(properties);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 注册一个服务实例</span>
            namingService.registerInstance(<span class="hljs-string">"test-service"</span>, <span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">8080</span>, <span class="hljs-string">"clusterA"</span>);

            <span class="hljs-comment">// 添加事件监听器</span>
            namingService.subscribe(<span class="hljs-string">"test-service"</span>, event -&gt; System.out.println(<span class="hljs-string">"服务实例变化: "</span> + event));
        } <span class="hljs-keyword">catch</span> (Exception e) {
            System.out.println(<span class="hljs-string">"服务注册失败(预期，因为服务器可能未启动): "</span> + e.getMessage());
        }

        TimeUnit.HOURS.sleep(<span class="hljs-number">5</span>);

        namingService.shutDown();
    }
}
</code></pre>
<p>最先它会执行 <code>NamingService#registerInstance</code> 方法，<code>Instance</code> 对象便是存储模型的实例信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NacosNamingService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NamingService</span> {

    <span class="hljs-keyword">private</span> NamingClientProxy clientProxy;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerInstance</span><span class="hljs-params">(String serviceName, String groupName, String ip, <span class="hljs-type">int</span> port, String clusterName)</span>
            <span class="hljs-keyword">throws</span> NacosException {
        <span class="hljs-type">Instance</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Instance</span>();
        instance.setIp(ip);
        instance.setPort(port);
        <span class="hljs-comment">// 默认权重值为 1</span>
        instance.setWeight(<span class="hljs-number">1.0</span>);
        instance.setClusterName(clusterName);
        registerInstance(serviceName, groupName, instance);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerInstance</span><span class="hljs-params">(String serviceName, String groupName, Instance instance)</span> <span class="hljs-keyword">throws</span> NacosException {
        <span class="hljs-comment">// 参数校验</span>
        NamingUtils.checkInstanceIsLegal(instance);
        checkAndStripGroupNamePrefix(instance, groupName);
        <span class="hljs-comment">// 在这里实际上使用了静态代理模式来区分是使用 HTTPClient 还是 GrpcClient，默认为后者</span>
        clientProxy.registerService(serviceName, groupName, instance);
    }
}
</code></pre>
<p>实际执行注册的为 <code>NamingGrpcClientProxy</code> 实现类，在向注册中心注册服务的逻辑中，我们 <strong>只关注创建临时（Ephemeral）服务实例</strong> 的逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NamingGrpcClientProxy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractNamingClientProxy</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> NamingGrpcRedoService redoService;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerService</span><span class="hljs-params">(String serviceName, String groupName, Instance instance)</span> <span class="hljs-keyword">throws</span> NacosException {
        NAMING_LOGGER.info(<span class="hljs-string">"[REGISTER-SERVICE] {} registering service {} with instance {}"</span>, namespaceId, serviceName,
                instance);
        <span class="hljs-comment">// [registerInstance] 步骤1：创建服务实例区分是否为临时</span>
        <span class="hljs-keyword">if</span> (instance.isEphemeral()) { 
            registerServiceForEphemeral(serviceName, groupName, instance);
        } <span class="hljs-keyword">else</span> {
            doRegisterServiceForPersistent(serviceName, groupName, instance);
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerServiceForEphemeral</span><span class="hljs-params">(String serviceName, String groupName, Instance instance)</span>
            <span class="hljs-keyword">throws</span> NacosException {
        redoService.cacheInstanceForRedo(serviceName, groupName, instance);
        doRegisterService(serviceName, groupName, instance);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doRegisterService</span><span class="hljs-params">(String serviceName, String groupName, Instance instance)</span> <span class="hljs-keyword">throws</span> NacosException {
        <span class="hljs-comment">// 客户端创建注册实例请求对象，包含命名空间、服务名、分组名和实例信息</span>
        <span class="hljs-type">InstanceRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstanceRequest</span>(namespaceId, serviceName, groupName,
                NamingRemoteConstants.REGISTER_INSTANCE, instance);
        <span class="hljs-comment">// [registerInstance] 步骤2：通过gRPC协议向服务端发送注册请求</span>
        requestToServer(request, Response.class);
        redoService.instanceRegistered(serviceName, groupName);
    }
}
</code></pre>
<p>在上述步骤中，可以发现分别两次调用了 <code>redoServer</code> 的 <code>cacheInstanceForRedo</code> 和 <code>instanceRegistered</code> 方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NamingGrpcRedoService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionEventListener</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;String, InstanceRedoData&gt; registeredInstances = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-comment">// 创建 InstanceRedoData 对象在 ConcurrentMap 中</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cacheInstanceForRedo</span><span class="hljs-params">(String serviceName, String groupName, Instance instance)</span> {
        <span class="hljs-comment">// eg: DEFAULT_GROUP@@test-service</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> NamingUtils.getGroupedName(serviceName, groupName);
        <span class="hljs-type">InstanceRedoData</span> <span class="hljs-variable">redoData</span> <span class="hljs-operator">=</span> InstanceRedoData.build(serviceName, groupName, instance);
        <span class="hljs-keyword">synchronized</span> (registeredInstances) {
            registeredInstances.put(key, redoData);
        }
    }
}
</code></pre>
<p>首先它会创建 <code>InstanceRedoData</code> 对象保存在 <code>ConcurrentMap</code> 中，初始字段值如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e384e223d7864c9e8ffe2f6384976b38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860535&amp;x-signature=GjJ0dffh%2BVrt%2BPLe5jHzzQZ1NtA%3D" alt="img.png" loading="lazy"/></p>
<p>在成功调用向服务端注册实例后，会将 <code>InstanceRedoData#registered</code> 字段标记为 true：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NamingGrpcRedoService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConnectionEventListener</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;String, InstanceRedoData&gt; registeredInstances = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">instanceRegistered</span><span class="hljs-params">(String serviceName, String groupName)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> NamingUtils.getGroupedName(serviceName, groupName);
        <span class="hljs-keyword">synchronized</span> (registeredInstances) {
            <span class="hljs-type">InstanceRedoData</span> <span class="hljs-variable">redoData</span> <span class="hljs-operator">=</span> registeredInstances.get(key);
            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != redoData) {
                <span class="hljs-comment">// 标记 registered 字段为 true</span>
                redoData.registered();
            }
        }
    }
}
</code></pre>
<p>至于 <code>InstanceRedoData</code> 对象有什么作用我们之后再看，我们还是先回到 gRPC 请求服务端注册实例的逻辑中。Nacos Client 会向服务端发送 <code>InstanceRequest</code> 请求，并有 Nacos Server 端的 <code>InstanceRequestHandler</code> 承接：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InstanceRequestHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RequestHandler</span>&lt;InstanceRequest, InstanceResponse&gt; {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EphemeralClientOperationServiceImpl clientOperationService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InstanceRequestHandler</span><span class="hljs-params">(EphemeralClientOperationServiceImpl clientOperationService)</span> {
        <span class="hljs-built_in">this</span>.clientOperationService = clientOperationService;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@NamespaceValidation</span>
    <span class="hljs-meta">@TpsControl(pointName = "RemoteNamingInstanceRegisterDeregister", name = "RemoteNamingInstanceRegisterDeregister")</span>
    <span class="hljs-meta">@Secured(action = ActionTypes.WRITE)</span>
    <span class="hljs-meta">@ExtractorManager</span>.Extractor(rpcExtractor = InstanceRequestParamExtractor.class)
    <span class="hljs-keyword">public</span> InstanceResponse <span class="hljs-title function_">handle</span><span class="hljs-params">(InstanceRequest request, RequestMeta meta)</span> <span class="hljs-keyword">throws</span> NacosException {
        <span class="hljs-comment">// [registerInstance] 步骤3：根据请求参数创建服务对象，设置为ephemeral（临时）服务</span>
        <span class="hljs-type">Service</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> Service.newService(request.getNamespace(), request.getGroupName(), request.getServiceName(),
                <span class="hljs-literal">true</span>);
        InstanceUtil.setInstanceIdIfEmpty(request.getInstance(), service.getGroupedServiceName());
        <span class="hljs-keyword">switch</span> (request.getType()) {
            <span class="hljs-keyword">case</span> NamingRemoteConstants.REGISTER_INSTANCE:
                <span class="hljs-comment">// 根据请求类型分发到具体的注册实例方法</span>
                <span class="hljs-keyword">return</span> registerInstance(service, request, meta);
            <span class="hljs-keyword">case</span> NamingRemoteConstants.DE_REGISTER_INSTANCE:
                <span class="hljs-keyword">return</span> deregisterInstance(service, request, meta);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NacosException</span>(NacosException.INVALID_PARAM,
                        String.format(<span class="hljs-string">"Unsupported request type %s"</span>, request.getType()));
        }
    }

    <span class="hljs-keyword">private</span> InstanceResponse <span class="hljs-title function_">registerInstance</span><span class="hljs-params">(Service service, InstanceRequest request, RequestMeta meta)</span>
            <span class="hljs-keyword">throws</span> NacosException {
        <span class="hljs-comment">// 调用客户端操作服务注册实例，传入服务、实例和连接ID</span>
        clientOperationService.registerInstance(service, request.getInstance(), meta.getConnectionId());
        <span class="hljs-comment">// 发布实例注册跟踪事件，记录注册操作的详细信息</span>
        NotifyCenter.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RegisterInstanceTraceEvent</span>(System.currentTimeMillis(),
                NamingRequestUtil.getSourceIpForGrpcRequest(meta), <span class="hljs-literal">true</span>, service.getNamespace(), service.getGroup(),
                service.getName(), request.getInstance().getIp(), request.getInstance().getPort()));
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstanceResponse</span>(NamingRemoteConstants.REGISTER_INSTANCE);
    }
}
</code></pre>
<p>它会创建 <code>Service</code> 对象，它是存储模型中的服务信息，如下所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37b23fbb9a9e4a7ea343c8d4e90d6487~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pa55ZyG5oOz5b2T5Zu-54G1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763860535&amp;x-signature=bDn4A65AAZlt%2BrS0O7PvXd7rfx8%3D" alt="img_1.png" loading="lazy"/></p>
<p>接下来我们先深入到其中调用的 <code>EphemeralClientOperationServiceImpl#registerInstance</code> 方法中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EphemeralClientOperationServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClientOperationService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerInstance</span><span class="hljs-params">(Service service, Instance instance, String clientId)</span> <span class="hljs-keyword">throws</span> NacosException {
        <span class="hljs-comment">// 验证实例的合法性（IP、端口等）</span>
        NamingUtils.checkInstanceIsLegal(instance);

        <span class="hljs-comment">// [registerInstance] 步骤4：从服务管理器获取单例服务对象</span>
        <span class="hljs-type">Service</span> <span class="hljs-variable">singleton</span> <span class="hljs-operator">=</span> ServiceManager.getInstance().getSingleton(service);
        <span class="hljs-keyword">if</span> (!singleton.isEphemeral()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NacosRuntimeException</span>(NacosException.INVALID_PARAM,
                    String.format(<span class="hljs-string">"Current service %s is persistent service, can't register ephemeral instance."</span>,
                            singleton.getGroupedServiceName()));
        }
        <span class="hljs-comment">// 获取客户端连接对象并验证其合法性</span>
        <span class="hljs-type">Client</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> clientManager.getClient(clientId);
        checkClientIsLegal(client, clientId);
        <span class="hljs-comment">// 将实例信息转换为发布信息对象</span>
        <span class="hljs-type">InstancePublishInfo</span> <span class="hljs-variable">instanceInfo</span> <span class="hljs-operator">=</span> getPublishInfo(instance);
        <span class="hljs-comment">// [registerInstance] 步骤5：将实例信息 InstancePublishInfo 添加到客户端的服务实例列表中</span>
        client.addServiceInstance(singleton, instanceInfo);
        client.setLastUpdatedTime();
        client.recalculateRevision();
        <span class="hljs-comment">// 发布客户端注册服务事件</span>
        NotifyCenter.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientOperationEvent</span>(singleton, clientId));
        <span class="hljs-comment">// 发布实例元数据事件，完成注册流程</span>
        NotifyCenter
                .publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MetadataEvent</span>.InstanceMetadataEvent(singleton, instanceInfo.getMetadataId(), <span class="hljs-literal">false</span>));
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceManager</span> {

    <span class="hljs-comment">// 单例模式：饿汉式</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ServiceManager</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceManager</span>();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ServiceManager <span class="hljs-title function_">getInstance</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> INSTANCE;
    }


    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Service, Service&gt; singletonRepository;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;String, Set&lt;Service&gt;&gt; namespaceSingletonMaps;

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ServiceManager</span><span class="hljs-params">()</span> {
        singletonRepository = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">10</span>);
        namespaceSingletonMaps = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>);
    }
    
    <span class="hljs-keyword">public</span> Service <span class="hljs-title function_">getSingleton</span><span class="hljs-params">(Service service)</span> {
        <span class="hljs-comment">// 首先在 singletonRepository 中查找或创建服务单例</span>
        <span class="hljs-type">Service</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> singletonRepository.computeIfAbsent(service, key -&gt; {
            NotifyCenter.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MetadataEvent</span>.ServiceMetadataEvent(service, <span class="hljs-literal">false</span>));
            <span class="hljs-keyword">return</span> service;
        });
        <span class="hljs-comment">// [registerInstance] 关键数据写入：将服务添加到命名空间服务映射表中 namespaceSingletonMaps</span>
        namespaceSingletonMaps.computeIfAbsent(result.getNamespace(), namespace -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashSet</span>&lt;&gt;()).add(result);
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p>在 <strong>[registerInstance] 步骤4</strong> 中完成了 <strong>服务实例信息注册后本地缓存的写入</strong>，它会被记录到 <code>ServiceManager#singletonRepository</code> 和 <code>ServiceManager#namespaceSingletonMaps</code> 两个变量中，并且在在首次通过 <code>ConcurrentHashMap#computeIfAbsent</code> 方法添加时会触发 <code>ServiceMetadataEvent</code> 事件，这个事件用于更新服务信息的元数据，比较简单就不再解释了，这有一点 <strong>代码规范</strong> 需要注意：它将 <code>ServiceManager#getSingleton</code> 命名为获取服务实例的方法，但是却在这个 <code>get</code> 方法中执行了写入逻辑，具有迷惑性，应该修改命名为 <code>registerAndGetSingleton</code> 才对。再回到 <code>registerInstance</code> 方法中，<strong>[registerInstance] 步骤5</strong> 也是一段重要的逻辑，它会在 <code>ConcurrentHashMap&lt;Service, InstancePublishInfo&gt; publishers</code> 记录注册实例的发布信息 <code>InstancePublishInfo</code>，包含 <strong>实例的 IP，端口和集群等必要信息</strong>，后续会从发布信息中来获取这些字段值，并且会触发 <code>ClientChangedEvent</code> 事件：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Client</span> {

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Service, InstancePublishInfo&gt; publishers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">16</span>, <span class="hljs-number">0.75f</span>, <span class="hljs-number">1</span>);
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">addServiceInstance</span><span class="hljs-params">(Service service, InstancePublishInfo instancePublishInfo)</span> {
        <span class="hljs-keyword">if</span> (instancePublishInfo <span class="hljs-keyword">instanceof</span> BatchInstancePublishInfo) {
            <span class="hljs-type">InstancePublishInfo</span> <span class="hljs-variable">old</span> <span class="hljs-operator">=</span> publishers.put(service, instancePublishInfo);
            MetricsMonitor.incrementIpCountWithBatchRegister(old, (BatchInstancePublishInfo) instancePublishInfo);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 记录实例的发布信息，用于后续从发布信息中解析获取注册实例的 IP 信息等</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == publishers.put(service, instancePublishInfo)) {
                MetricsMonitor.incrementInstanceCount();
            }
        }
        <span class="hljs-comment">// 触发 ClientChangedEvent 事件</span>
        NotifyCenter.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientEvent</span>.ClientChangedEvent(<span class="hljs-built_in">this</span>));
        Loggers.SRV_LOG.info(<span class="hljs-string">"Client change for service {}, {}"</span>, service, getClientId());
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p>在 <code>registerInstance</code> 方法中还会发布两个事件：<code>ClientRegisterServiceEvent</code> 和 <code>InstanceMetadataEvent</code>，后者用于写入实例的元数据比较简单，就不再赘述了。在以上逻辑中，我们知道了服务信息 <code>Service</code> 被记录在了 <code>ServiceManager</code> 中，服务下实例的信息被保存在了 <code>AbstractClient#publishers</code> 字段中，接下来我们看 <code>ClientRegisterServiceEvent</code> 事件和 <code>ClientChangedEvent</code> 事件是如何被处理的。</p>
<h4 data-id="heading-1">ClientRegisterServiceEvent</h4>
<p><code>ClientRegisterServiceEvent</code> 事件由 <code>ClientServiceIndexesManager</code> 订阅并消费，在这里也会记录服务信息，如下方代码所示，它还会触发 <code>ServiceChangedEvent</code> 事件：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientServiceIndexesManager</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SmartSubscriber</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;Service, Set&lt;String&gt;&gt; publisherIndexes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleClientOperation</span><span class="hljs-params">(ClientOperationEvent event)</span> {
        <span class="hljs-type">Service</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> event.getService();
        <span class="hljs-type">String</span> <span class="hljs-variable">clientId</span> <span class="hljs-operator">=</span> event.getClientId();
        <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ClientOperationEvent.ClientRegisterServiceEvent) {
            <span class="hljs-comment">// [registerInstance] 步骤6：处理客户端注册服务事件，将服务和客户端ID添加到发布者索引 publisherIndexes 中</span>
            addPublisherIndexes(service, clientId);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ClientOperationEvent.ClientDeregisterServiceEvent) {
            removePublisherIndexes(service, clientId);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ClientOperationEvent.ClientSubscribeServiceEvent) {
            addSubscriberIndexes(service, clientId);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ClientOperationEvent.ClientUnsubscribeServiceEvent) {
            removeSubscriberIndexes(service, clientId);
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addPublisherIndexes</span><span class="hljs-params">(Service service, String clientId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">serviceChangedType</span> <span class="hljs-operator">=</span> Constants.ServiceChangedType.INSTANCE_CHANGED;
        <span class="hljs-keyword">if</span> (!publisherIndexes.containsKey(service)) {
            <span class="hljs-comment">// 唯一需要更新索引的时间是 "首次" 创建服务的时</span>
            serviceChangedType = Constants.ServiceChangedType.ADD_SERVICE;
        }
        <span class="hljs-comment">// 发布服务变更事件，通知订阅者有新的服务实例注册</span>
        NotifyCenter.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceEvent</span>.ServiceChangedEvent(service, serviceChangedType, <span class="hljs-literal">true</span>));
        publisherIndexes.computeIfAbsent(service, key -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashSet</span>&lt;&gt;()).add(clientId);
    }
}
</code></pre>
<p><code>ServiceChangedEvent</code> 事件被 <code>NamingSubscriberServiceV2Impl</code> 订阅并消费：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NamingSubscriberServiceV2Impl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SmartSubscriber</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NamingSubscriberService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PushDelayTaskExecuteEngine delayTaskEngine;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onEvent</span><span class="hljs-params">(Event event)</span> {
        <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ServiceEvent.ServiceChangedEvent) {
            <span class="hljs-comment">// [registerInstance] 步骤7：处理服务变更事件，创建推送任务将服务变更通知给所有订阅者</span>
            ServiceEvent.<span class="hljs-type">ServiceChangedEvent</span> <span class="hljs-variable">serviceChangedEvent</span> <span class="hljs-operator">=</span> (ServiceEvent.ServiceChangedEvent) event;
            <span class="hljs-type">Service</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> serviceChangedEvent.getService();
            delayTaskEngine.addTask(service, <span class="hljs-keyword">new</span> <span class="hljs-title class_">PushDelayTask</span>(service, PushConfig.getInstance().getPushTaskDelay()));
            MetricsMonitor.incrementServiceChangeCount(service);
        }
    }
}
</code></pre>
<p>它会创建一个 <code>PushDelayTask</code> 添加到 <code>NacosDelayTaskExecuteEngine#tasks</code> 中，这个 <code>NacosDelayTaskExecuteEngine</code> 我们在配置发布的章节介绍过，本质上它是一个 <code>ScheduledExecutorService</code> 在每 100ms 执行一个 <code>ConcurrentHashMap&lt;Object, AbstractDelayTask&gt; tasks</code> 的任务。接下来我们先来了解一下 <code>PushDelayTask</code> 任务，重点关注注释信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PushDelayTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractDelayTask</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Service service;

    <span class="hljs-comment">// 是否推送给所有订阅服务信息的 Client</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> pushToAll;

    <span class="hljs-keyword">private</span> Set&lt;String&gt; targetClients;

    <span class="hljs-comment">// 创建推送所有订阅者的任务，上文中便是调用的这个构造函数</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PushDelayTask</span><span class="hljs-params">(Service service, <span class="hljs-type">long</span> delay)</span> {
        <span class="hljs-built_in">this</span>.service = service;
        pushToAll = <span class="hljs-literal">true</span>;
        targetClients = <span class="hljs-literal">null</span>;
        setTaskInterval(delay);
        setLastProcessTime(System.currentTimeMillis());
    }

    <span class="hljs-comment">// 创建推送某一个订阅者的任务，专门用于处理某个 IP 推送失败的情况</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PushDelayTask</span><span class="hljs-params">(Service service, <span class="hljs-type">long</span> delay, String targetClient)</span> {
        <span class="hljs-built_in">this</span>.service = service;
        <span class="hljs-built_in">this</span>.pushToAll = <span class="hljs-literal">false</span>;
        <span class="hljs-built_in">this</span>.targetClients = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;(<span class="hljs-number">1</span>);
        <span class="hljs-built_in">this</span>.targetClients.add(targetClient);
        setTaskInterval(delay);
        setLastProcessTime(System.currentTimeMillis());
    }

    <span class="hljs-comment">// 合并任务，避免多次重复调用</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">merge</span><span class="hljs-params">(AbstractDelayTask task)</span> {
        <span class="hljs-keyword">if</span> (!(task <span class="hljs-keyword">instanceof</span> PushDelayTask)) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-type">PushDelayTask</span> <span class="hljs-variable">oldTask</span> <span class="hljs-operator">=</span> (PushDelayTask) task;
        <span class="hljs-keyword">if</span> (isPushToAll() || oldTask.isPushToAll()) {
            pushToAll = <span class="hljs-literal">true</span>;
            targetClients = <span class="hljs-literal">null</span>;
        } <span class="hljs-keyword">else</span> {
            targetClients.addAll(oldTask.getTargetClients());
        }
        setLastProcessTime(Math.min(getLastProcessTime(), task.getLastProcessTime()));
        Loggers.PUSH.info(<span class="hljs-string">"[PUSH] Task merge for {}"</span>, service);
    }

    <span class="hljs-keyword">public</span> Service <span class="hljs-title function_">getService</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> service;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isPushToAll</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> pushToAll;
    }

    <span class="hljs-comment">// 获取目标推送 Client</span>
    <span class="hljs-keyword">public</span> Set&lt;String&gt; <span class="hljs-title function_">getTargetClients</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> targetClients;
    }
}
</code></pre>
<p>我们能了解到 <code>PushDelayTask</code> 能够 <strong>区分是推送给所有客户端还是只推送单一客户端，这么做的目的是可以针对某些推送异常的客户端进行任务重试</strong>。随后 <code>PushDelayTask</code> 会被 <code>PushDelayTaskProcessor</code> 处理，会被封装到 <code>PushExecuteTask</code> 任务中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PushDelayTaskProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NacosTaskProcessor</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PushDelayTaskExecuteEngine executeEngine;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">PushDelayTaskProcessor</span><span class="hljs-params">(PushDelayTaskExecuteEngine executeEngine)</span> {
        <span class="hljs-built_in">this</span>.executeEngine = executeEngine;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">process</span><span class="hljs-params">(NacosTask task)</span> {
        <span class="hljs-type">PushDelayTask</span> <span class="hljs-variable">pushDelayTask</span> <span class="hljs-operator">=</span> (PushDelayTask) task;
        <span class="hljs-type">Service</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> pushDelayTask.getService();
        <span class="hljs-comment">// [registerInstance] 步骤8：分发推送任务到执行器，准备将服务变更推送给客户端</span>
        NamingExecuteTaskDispatcher.getInstance()
                .dispatchAndExecuteTask(service, <span class="hljs-keyword">new</span> <span class="hljs-title class_">PushExecuteTask</span>(service, executeEngine, pushDelayTask));
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<p><code>NamingExecuteTaskDispatcher#dispatchAndExecuteTask</code> 方法会执行到如下逻辑中，分配给某一条线程去处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NacosExecuteTaskExecuteEngine</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractNacosTaskExecuteEngine</span>&lt;AbstractExecuteTask&gt; {

    <span class="hljs-comment">// 本质上是多条线程</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> TaskExecuteWorker[] executeWorkers;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">NacosExecuteTaskExecuteEngine</span><span class="hljs-params">(String name, Logger logger, <span class="hljs-type">int</span> dispatchWorkerCount)</span> {
        <span class="hljs-built_in">super</span>(logger);
        executeWorkers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskExecuteWorker</span>[dispatchWorkerCount];
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">mod</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; mod &lt; dispatchWorkerCount; ++mod) {
            executeWorkers[mod] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskExecuteWorker</span>(name, mod, dispatchWorkerCount, getEngineLog());
        }
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addTask</span><span class="hljs-params">(Object tag, AbstractExecuteTask task)</span> {
        <span class="hljs-type">NacosTaskProcessor</span> <span class="hljs-variable">processor</span> <span class="hljs-operator">=</span> getProcessor(tag);
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != processor) {
            processor.process(task);
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 分配给某个线程处理</span>
        <span class="hljs-type">TaskExecuteWorker</span> <span class="hljs-variable">worker</span> <span class="hljs-operator">=</span> getWorker(tag);
        worker.process(task);
    }

    <span class="hljs-keyword">private</span> TaskExecuteWorker <span class="hljs-title function_">getWorker</span><span class="hljs-params">(Object tag)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> (tag.hashCode() &amp; Integer.MAX_VALUE) % workersCount();
        <span class="hljs-keyword">return</span> executeWorkers[idx];
    }
}
</code></pre>
<p>以上逻辑还未涉及 <code>PushExecuteTask</code> 推送服务变更的逻辑处理，大家只需要了解到，至此将推送任务转交到了某个单一的线程中去执行了，接下来我们看一下 <code>PushExecuteTask</code> 的具体逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PushExecuteTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractExecuteTask</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PushDelayTaskExecuteEngine delayTaskEngine;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PushDelayTask delayTask;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// [registerInstance] 步骤9：生成推送数据，包含服务实例信息和元数据</span>
            <span class="hljs-type">PushDataWrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> generatePushData();
            <span class="hljs-type">ClientManager</span> <span class="hljs-variable">clientManager</span> <span class="hljs-operator">=</span> delayTaskEngine.getClientManager();
            <span class="hljs-comment">// 遍历目标客户端，向订阅了该服务的客户端推送数据</span>
            <span class="hljs-keyword">for</span> (String each : getTargetClientIds()) {
                <span class="hljs-type">Client</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> clientManager.getClient(each);
                <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == client) {
                    <span class="hljs-comment">// means this client has disconnect</span>
                    <span class="hljs-keyword">continue</span>;
                }
                <span class="hljs-type">Subscriber</span> <span class="hljs-variable">subscriber</span> <span class="hljs-operator">=</span> client.getSubscriber(service);
                <span class="hljs-comment">// skip if null</span>
                <span class="hljs-keyword">if</span> (subscriber == <span class="hljs-literal">null</span>) {
                    <span class="hljs-keyword">continue</span>;
                }
                <span class="hljs-comment">// 通过推送执行器向客户端推送服务变更通知</span>
                delayTaskEngine.getPushExecutor().doPushWithCallback(each, subscriber, wrapper,
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServicePushCallback</span>(each, subscriber, wrapper.getOriginalData(), delayTask.isPushToAll()));
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            Loggers.PUSH.error(<span class="hljs-string">"Push task for service"</span> + service.getGroupedServiceName() + <span class="hljs-string">" execute failed "</span>, e);
            <span class="hljs-comment">// 异常重试</span>
            delayTaskEngine.addTask(service, <span class="hljs-keyword">new</span> <span class="hljs-title class_">PushDelayTask</span>(service, <span class="hljs-number">1000L</span>));
        }
    }

    <span class="hljs-comment">// 初始推送时获取所有订阅服务信息的 Client；如果不是推送所有，说明是处理失败重试的场景，则只推送目标 Client 即可</span>
    <span class="hljs-keyword">private</span> Collection&lt;String&gt; <span class="hljs-title function_">getTargetClientIds</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> delayTask.isPushToAll() ? delayTaskEngine.getIndexesManager().getAllClientsSubscribeService(service)
                : delayTask.getTargetClients();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServicePushCallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NamingPushCallback</span> {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">()</span> {
            <span class="hljs-comment">// monitor and log</span>
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFail</span><span class="hljs-params">(Throwable e)</span> {
            <span class="hljs-type">long</span> <span class="hljs-variable">pushCostTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - executeStartTime;
            <span class="hljs-keyword">if</span> (!(e <span class="hljs-keyword">instanceof</span> NoRequiredRetryException)) {
                Loggers.PUSH.error(<span class="hljs-string">"Reason detail: "</span>, e);
                <span class="hljs-comment">// 如果针对某个 IP 推送失败，则创建推送针对目标 IP 的任务重试推送</span>
                delayTaskEngine.addTask(service,
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">PushDelayTask</span>(service, PushConfig.getInstance().getPushTaskRetryDelay(), clientId));
            }
            <span class="hljs-type">PushResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> PushResult
                    .pushFailed(service, clientId, actualServiceInfo, subscriber, pushCostTime, e, isPushToAll);
            PushResultHookHolder.getInstance().pushFailed(result);
        }
    }

}
</code></pre>
<p>从以上逻辑中可知：服务注册信息将推送给每个订阅了这个服务的 Client，如果推送失败会重新添加 <code>PushDelayTask</code> 任务重试，以此来保证订阅服务实例信息的 Client 都接收到变更。需要注意的是在 <strong>[registerInstance] 步骤9</strong> 中有以下非常关键的逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PushExecuteTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractExecuteTask</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PushDelayTaskExecuteEngine delayTaskEngine;
    
    <span class="hljs-comment">// 生成推送请求信息</span>
    <span class="hljs-keyword">private</span> PushDataWrapper <span class="hljs-title function_">generatePushData</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 获取要推送的服务信息，包含实例信息</span>
        <span class="hljs-type">ServiceInfo</span> <span class="hljs-variable">serviceInfo</span> <span class="hljs-operator">=</span> delayTaskEngine.getServiceStorage().getPushData(service);
        <span class="hljs-type">ServiceMetadata</span> <span class="hljs-variable">serviceMetadata</span> <span class="hljs-operator">=</span> delayTaskEngine.getMetadataManager().getServiceMetadata(service).orElse(<span class="hljs-literal">null</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PushDataWrapper</span>(serviceMetadata, serviceInfo);
    }
}

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceStorage</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;Service, Set&lt;String&gt;&gt; serviceClusterIndex;
    
    <span class="hljs-keyword">public</span> ServiceInfo <span class="hljs-title function_">getPushData</span><span class="hljs-params">(Service service)</span> {
        <span class="hljs-type">ServiceInfo</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> emptyServiceInfo(service);
        <span class="hljs-keyword">if</span> (!ServiceManager.getInstance().containSingleton(service)) {
            <span class="hljs-keyword">return</span> result;
        }
        <span class="hljs-type">Service</span> <span class="hljs-variable">singleton</span> <span class="hljs-operator">=</span> ServiceManager.getInstance().getSingleton(service);
        result.setHosts(getAllInstancesFromIndex(singleton));
        serviceDataIndexes.put(singleton, result);
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-keyword">private</span> ServiceInfo <span class="hljs-title function_">emptyServiceInfo</span><span class="hljs-params">(Service service)</span> {
        <span class="hljs-type">ServiceInfo</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceInfo</span>();
        result.setName(service.getName());
        result.setGroupName(service.getGroup());
        result.setLastRefTime(System.currentTimeMillis());
        result.setCacheMillis(switchDomain.getDefaultPushCacheMillis());
        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-comment">// 获取服务下所有的实例信息</span>
    <span class="hljs-keyword">private</span> List&lt;Instance&gt; <span class="hljs-title function_">getAllInstancesFromIndex</span><span class="hljs-params">(Service service)</span> {
        Set&lt;Instance&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        Set&lt;String&gt; clusters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        <span class="hljs-comment">// 获取 ClientId</span>
        <span class="hljs-keyword">for</span> (String each : serviceIndexesManager.getAllClientsRegisteredService(service)) {
            <span class="hljs-comment">// 获取实例注册信息 InstancePublishInfo</span>
            Optional&lt;InstancePublishInfo&gt; instancePublishInfo = getInstanceInfo(each, service);
            <span class="hljs-keyword">if</span> (instancePublishInfo.isPresent()) {
                <span class="hljs-type">InstancePublishInfo</span> <span class="hljs-variable">publishInfo</span> <span class="hljs-operator">=</span> instancePublishInfo.get();
                <span class="hljs-comment">//If it is a BatchInstancePublishInfo type, it will be processed manually and added to the instance list</span>
                <span class="hljs-keyword">if</span> (publishInfo <span class="hljs-keyword">instanceof</span> BatchInstancePublishInfo) {
                    <span class="hljs-type">BatchInstancePublishInfo</span> <span class="hljs-variable">batchInstancePublishInfo</span> <span class="hljs-operator">=</span> (BatchInstancePublishInfo) publishInfo;
                    List&lt;Instance&gt; batchInstance = parseBatchInstance(service, batchInstancePublishInfo, clusters);
                    result.addAll(batchInstance);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// 根据请求时 InstancePublishInfo 的注册实例对象创建出 Instance 实例</span>
                    <span class="hljs-type">Instance</span> <span class="hljs-variable">instance</span> <span class="hljs-operator">=</span> parseInstance(service, instancePublishInfo.get());
                    result.add(instance);
                    clusters.add(instance.getClusterName());
                }
            }
        }
        <span class="hljs-comment">// 缓存记录这个服务的集群</span>
        serviceClusterIndex.put(service, clusters);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;(result);
    }
}
</code></pre>
<p>在 <code>generatePushData</code> 方法中，生成了 <code>ServiceInfo</code> 对象，其中包含服务和该服务下注册的所有实例，实例信息是从 <code>InstancePublishInfo</code> 中解析出来的，实例的发布信息我们在上文中提到过。除此之外，还需要注意在 <code>getAllInstancesFromIndex</code> <strong>读方法中包含了缓存写入的逻辑</strong>，这种写法是非常不推荐的，具有迷惑性：谁会想到在读方法中还会包含写逻辑呢？所以在日常开发中一定要避免这种写法！</p>
<p>总结一下：<code>ClientRegisterServiceEvent</code> 事件的作用是将服务实例的变更信息推送给订阅了这个服务的所有客户端。</p>
<h4 data-id="heading-2">ClientChangedEvent</h4>
<p><code>ClientChangedEvent</code> 事件会被 <code>DistroClientDataProcessor</code> 订阅并消费，在它的 <code>onEvent</code> 方法中的 <code>else</code> 逻辑中可以发现它调用了 <code>syncToAllServer</code> 方法，从方法名中可以大概能猜出来，在 Nacos 采用集群模式部署时，会通过这个方法将注册的服务信息同步到其他节点上：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistroClientDataProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SmartSubscriber</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DistroDataStorage</span>, DistroDataProcessor {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DistroProtocol distroProtocol;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onEvent</span><span class="hljs-params">(Event event)</span> {
        <span class="hljs-keyword">if</span> (EnvUtil.getStandaloneMode()) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ClientEvent.ClientVerifyFailedEvent) {
            syncToVerifyFailedServer((ClientEvent.ClientVerifyFailedEvent) event);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// [registerInstance] 步骤10：同步所有服务</span>
            syncToAllServer((ClientEvent) event);
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">syncToAllServer</span><span class="hljs-params">(ClientEvent event)</span> {
        <span class="hljs-type">Client</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> event.getClient();
        <span class="hljs-keyword">if</span> (isInvalidClient(client)) {
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// 区分客户端断开连接的事件客户端变更事件</span>
        <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ClientEvent.ClientDisconnectEvent) {
            <span class="hljs-type">DistroKey</span> <span class="hljs-variable">distroKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistroKey</span>(client.getClientId(), TYPE);
            distroProtocol.sync(distroKey, DataOperation.DELETE);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ClientEvent.ClientChangedEvent) {
            <span class="hljs-type">DistroKey</span> <span class="hljs-variable">distroKey</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistroKey</span>(client.getClientId(), TYPE);
            distroProtocol.sync(distroKey, DataOperation.CHANGE);
        }
    }
}
</code></pre>
<p>在这个方法中，可以发现调用了 <code>DistroProtocol#sync</code> 方法，<code>DistroProtocol</code> 表示 <strong>Distro 协议</strong>：<strong>专门用于处理临时实例数据一致性的分布式协议</strong>，接下来我们通过 Nacos 的逻辑来了解一下这个协议。在 <code>DistroProtocol#sync</code> 方法中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistroProtocol</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DistroTaskEngineHolder distroTaskEngineHolder;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sync</span><span class="hljs-params">(DistroKey distroKey, DataOperation action)</span> {
        sync(distroKey, action, DistroConfig.getInstance().getSyncDelayMillis());
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sync</span><span class="hljs-params">(DistroKey distroKey, DataOperation action, <span class="hljs-type">long</span> delay)</span> {
        <span class="hljs-keyword">for</span> (Member each : memberManager.allMembersWithoutSelf()) {
            syncToTarget(distroKey, action, each.getAddress(), delay);
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">syncToTarget</span><span class="hljs-params">(DistroKey distroKey, DataOperation action, String targetServer, <span class="hljs-type">long</span> delay)</span> {
        <span class="hljs-type">DistroKey</span> <span class="hljs-variable">distroKeyWithTarget</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistroKey</span>(distroKey.getResourceKey(), distroKey.getResourceType(),
                targetServer);
        <span class="hljs-comment">// 创建异步 DistroDelayTask 任务</span>
        <span class="hljs-type">DistroDelayTask</span> <span class="hljs-variable">distroDelayTask</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistroDelayTask</span>(distroKeyWithTarget, action, delay);
        <span class="hljs-comment">// 添加到任务列表中延迟执行</span>
        distroTaskEngineHolder.getDelayTaskExecuteEngine().addTask(distroKeyWithTarget, distroDelayTask);
        <span class="hljs-keyword">if</span> (Loggers.DISTRO.isDebugEnabled()) {
            Loggers.DISTRO.debug(<span class="hljs-string">"[DISTRO-SCHEDULE] {} to {}"</span>, distroKey, targetServer);
        }
    }
}
</code></pre>
<p>它会创建一个 <code>DistroDelayTask</code> 添加到 <code>NacosDelayTaskExecuteEngine#tasks</code> 中，这个 <code>NacosDelayTaskExecuteEngine</code> 我们在配置发布的章节介绍过，本质上它是一个 <code>ScheduledExecutorService</code> 在每 100ms 执行一个 <code>ConcurrentHashMap&lt;Object, AbstractDelayTask&gt; tasks</code> 的任务。<code>DistroDelayTask</code> 任务中没有什么重要的逻辑，直接来看处理这个任务的实现类 <code>DistroDelayTaskProcessor</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistroDelayTaskProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NacosTaskProcessor</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DistroTaskEngineHolder distroTaskEngineHolder;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DistroComponentHolder distroComponentHolder;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DistroDelayTaskProcessor</span><span class="hljs-params">(DistroTaskEngineHolder distroTaskEngineHolder,
                                    DistroComponentHolder distroComponentHolder)</span> {
        <span class="hljs-built_in">this</span>.distroTaskEngineHolder = distroTaskEngineHolder;
        <span class="hljs-built_in">this</span>.distroComponentHolder = distroComponentHolder;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">process</span><span class="hljs-params">(NacosTask task)</span> {
        <span class="hljs-keyword">if</span> (!(task <span class="hljs-keyword">instanceof</span> DistroDelayTask)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-type">DistroDelayTask</span> <span class="hljs-variable">distroDelayTask</span> <span class="hljs-operator">=</span> (DistroDelayTask) task;
        <span class="hljs-type">DistroKey</span> <span class="hljs-variable">distroKey</span> <span class="hljs-operator">=</span> distroDelayTask.getDistroKey();
        <span class="hljs-keyword">switch</span> (distroDelayTask.getAction()) {
            <span class="hljs-keyword">case</span> DELETE:
                <span class="hljs-type">DistroSyncDeleteTask</span> <span class="hljs-variable">syncDeleteTask</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistroSyncDeleteTask</span>(distroKey, distroComponentHolder);
                distroTaskEngineHolder.getExecuteWorkersManager().addTask(distroKey, syncDeleteTask);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">case</span> CHANGE:
            <span class="hljs-keyword">case</span> ADD:
                <span class="hljs-comment">// [registerInstance] 步骤11：创建 DistroSyncChangeTask 任务异步执行</span>
                <span class="hljs-type">DistroSyncChangeTask</span> <span class="hljs-variable">syncChangeTask</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistroSyncChangeTask</span>(distroKey, distroComponentHolder);
                distroTaskEngineHolder.getExecuteWorkersManager().addTask(distroKey, syncChangeTask);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }
}
</code></pre>
<p><strong>[registerInstance] 步骤11</strong> 会创建 <code>DistroSyncChangeTask</code> 任务同样添加到延迟执行的任务队列中等待处理，这个任务的逻辑我们先来看一下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistroSyncChangeTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractDistroExecuteTask</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">DataOperation</span> <span class="hljs-variable">OPERATION</span> <span class="hljs-operator">=</span> DataOperation.CHANGE;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DistroSyncChangeTask</span><span class="hljs-params">(DistroKey distroKey, DistroComponentHolder distroComponentHolder)</span> {
        <span class="hljs-built_in">super</span>(distroKey, distroComponentHolder);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> DataOperation <span class="hljs-title function_">getDataOperation</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> OPERATION;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">doExecute</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> getDistroKey().getResourceType();
        <span class="hljs-type">DistroData</span> <span class="hljs-variable">distroData</span> <span class="hljs-operator">=</span> getDistroData(type);
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == distroData) {
            Loggers.DISTRO.warn(<span class="hljs-string">"[DISTRO] {} with null data to sync, skip"</span>, toString());
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }
        <span class="hljs-comment">// gRPC 通知其他节点服务实例信息</span>
        <span class="hljs-keyword">return</span> getDistroComponentHolder().findTransportAgent(type).syncData(distroData, getDistroKey().getTargetServer());
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doExecuteWithCallback</span><span class="hljs-params">(DistroCallback callback)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> getDistroKey().getResourceType();
        <span class="hljs-type">DistroData</span> <span class="hljs-variable">distroData</span> <span class="hljs-operator">=</span> getDistroData(type);
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == distroData) {
            Loggers.DISTRO.warn(<span class="hljs-string">"[DISTRO] {} with null data to sync, skip"</span>, toString());
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-comment">// gRPC 通知其他节点服务实例信息</span>
        getDistroComponentHolder().findTransportAgent(type).syncData(distroData, getDistroKey().getTargetServer(), callback);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"DistroSyncChangeTask for "</span> + getDistroKey().toString();
    }
    
    <span class="hljs-comment">// 获取 Distro 要推送的数据</span>
    <span class="hljs-keyword">private</span> DistroData <span class="hljs-title function_">getDistroData</span><span class="hljs-params">(String type)</span> {
        <span class="hljs-type">DistroData</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> getDistroComponentHolder().findDataStorage(type).getDistroData(getDistroKey());
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != result) {
            result.setType(OPERATION);
        }
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p>它的源码很简短，主要关注 <code>doExecute</code> 和 <code>doExecuteWithCallback</code> 方法，这两个方法的逻辑是借助 gRPC 通知集群中其他节点，区别是是否在 gRPC 调用完成后执行回调函数，这个任务的执行是在 <code>NacosExecuteTaskExecuteEngine</code> 中异步执行的，因为在上文中讲解过就不再赘述了，失败重试采用的还是重新添加到任务队列中等待执行。除此之外我们也要弄清楚推送的 DistroData 中到底都包含哪些信息，如下代码所示，它会执行到 <code>AbstractClient#generateSyncData</code> 的逻辑中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Client</span> {
    <span class="hljs-comment">// ...</span>
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ClientSyncData <span class="hljs-title function_">generateSyncData</span><span class="hljs-params">()</span> {
        List&lt;String&gt; namespaces = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        List&lt;String&gt; groupNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        List&lt;String&gt; serviceNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();

        List&lt;String&gt; batchNamespaces = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        List&lt;String&gt; batchGroupNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        List&lt;String&gt; batchServiceNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();

        List&lt;InstancePublishInfo&gt; instances = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        List&lt;BatchInstancePublishInfo&gt; batchInstancePublishInfos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
        <span class="hljs-type">BatchInstanceData</span>  <span class="hljs-variable">batchInstanceData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchInstanceData</span>();
        <span class="hljs-keyword">for</span> (Map.Entry&lt;Service, InstancePublishInfo&gt; entry : publishers.entrySet()) {
            <span class="hljs-type">InstancePublishInfo</span> <span class="hljs-variable">instancePublishInfo</span> <span class="hljs-operator">=</span> entry.getValue();
            <span class="hljs-keyword">if</span> (instancePublishInfo <span class="hljs-keyword">instanceof</span> BatchInstancePublishInfo) {
                <span class="hljs-type">BatchInstancePublishInfo</span> <span class="hljs-variable">batchInstance</span> <span class="hljs-operator">=</span> (BatchInstancePublishInfo) instancePublishInfo;
                batchInstancePublishInfos.add(batchInstance);
                buildBatchInstanceData(batchInstanceData, batchNamespaces, batchGroupNames, batchServiceNames, entry);
                batchInstanceData.setBatchInstancePublishInfos(batchInstancePublishInfos);
            } <span class="hljs-keyword">else</span> {
                namespaces.add(entry.getKey().getNamespace());
                groupNames.add(entry.getKey().getGroup());
                serviceNames.add(entry.getKey().getName());
                instances.add(entry.getValue());
            }
        }
        <span class="hljs-comment">// 包含了命名空间、服务信息和实例信息（InstancePublishInfo 或 BatchInstanceData）等</span>
        <span class="hljs-type">ClientSyncData</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientSyncData</span>(getClientId(), namespaces, groupNames, serviceNames, instances, batchInstanceData);
        data.getAttributes().addClientAttribute(REVISION, getRevision());
        <span class="hljs-keyword">return</span> data;
    }
}
</code></pre>
<p>虽然比较长，只看注释相关的内容即可，推送内容包含了命名空间、服务信息和实例信息等，这些信息大部分都来自 <code>InstancePublishInfo</code>，可见这个对象多么重要。</p>
<p><code>DistroSyncChangeTask</code> 任务会向其他节点发送 <code>DistroDataRequest</code> 请求，这个请求是如何被处理的呢？继续看 <code>DistroDataRequestHandler</code> 的逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@InvokeSource(source = {RemoteConstants.LABEL_SOURCE_CLUSTER})</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistroDataRequestHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RequestHandler</span>&lt;DistroDataRequest, DistroDataResponse&gt; {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DistroProtocol distroProtocol;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DistroDataRequestHandler</span><span class="hljs-params">(DistroProtocol distroProtocol)</span> {
        <span class="hljs-built_in">this</span>.distroProtocol = distroProtocol;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Secured(apiType = ApiType.INNER_API)</span>
    <span class="hljs-keyword">public</span> DistroDataResponse <span class="hljs-title function_">handle</span><span class="hljs-params">(DistroDataRequest request, RequestMeta meta)</span> <span class="hljs-keyword">throws</span> NacosException {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">switch</span> (request.getDataOperation()) {
                <span class="hljs-keyword">case</span> VERIFY:
                    <span class="hljs-keyword">return</span> handleVerify(request.getDistroData(), meta);
                <span class="hljs-keyword">case</span> SNAPSHOT:
                    <span class="hljs-keyword">return</span> handleSnapshot();
                <span class="hljs-keyword">case</span> ADD:
                <span class="hljs-keyword">case</span> CHANGE:
                <span class="hljs-keyword">case</span> DELETE:
                    <span class="hljs-comment">// [registerInstance] 步骤12 处理 DistroDataRequest 请求</span>
                    <span class="hljs-keyword">return</span> handleSyncData(request.getDistroData());
                <span class="hljs-keyword">case</span> QUERY:
                    <span class="hljs-keyword">return</span> handleQueryData(request.getDistroData());
                <span class="hljs-keyword">default</span>:
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistroDataResponse</span>();
            }
        } <span class="hljs-keyword">catch</span> (Exception e) {
            Loggers.DISTRO.error(<span class="hljs-string">"[DISTRO-FAILED] distro handle with exception"</span>, e);
            <span class="hljs-type">DistroDataResponse</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistroDataResponse</span>();
            result.setResultCode(ResponseCode.FAIL.getCode());
            result.setErrorCode(ResponseCode.FAIL.getCode());
            result.setMessage(<span class="hljs-string">"handle distro request with exception"</span>);
            <span class="hljs-keyword">return</span> result;
        }
    }

    <span class="hljs-keyword">private</span> DistroDataResponse <span class="hljs-title function_">handleSyncData</span><span class="hljs-params">(DistroData distroData)</span> {
        <span class="hljs-type">DistroDataResponse</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DistroDataResponse</span>();
        <span class="hljs-keyword">if</span> (!distroProtocol.onReceive(distroData)) {
            result.setErrorCode(ResponseCode.FAIL.getCode());
            result.setMessage(<span class="hljs-string">"[DISTRO-FAILED] distro data handle failed"</span>);
        }
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<p>我们需要关注 <code>DistroProtocol#onReceive</code> 方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistroProtocol</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DistroComponentHolder distroComponentHolder;
    
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onReceive</span><span class="hljs-params">(DistroData distroData)</span> {
        Loggers.DISTRO.info(<span class="hljs-string">"[DISTRO] Receive distro data type: {}, key: {}"</span>, distroData.getType(),
                distroData.getDistroKey());
        <span class="hljs-type">String</span> <span class="hljs-variable">resourceType</span> <span class="hljs-operator">=</span> distroData.getDistroKey().getResourceType();
        <span class="hljs-type">DistroDataProcessor</span> <span class="hljs-variable">dataProcessor</span> <span class="hljs-operator">=</span> distroComponentHolder.findDataProcessor(resourceType);
        <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> == dataProcessor) {
            Loggers.DISTRO.warn(<span class="hljs-string">"[DISTRO] Can't find data process for received data {}"</span>, resourceType);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-keyword">return</span> dataProcessor.processData(distroData);
    }
}
</code></pre>
<p>它会执行到 <code>DistroClientDataProcessor#processData</code> 方法，其中的 <code>upgradeClient</code> 方法是关键：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistroClientDataProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SmartSubscriber</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DistroDataStorage</span>, DistroDataProcessor {
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">processData</span><span class="hljs-params">(DistroData distroData)</span> {
        <span class="hljs-keyword">switch</span> (distroData.getType()) {
            <span class="hljs-keyword">case</span> ADD:
            <span class="hljs-keyword">case</span> CHANGE:
                <span class="hljs-comment">// [registerInstance] 步骤12：处理 Distro 协议同步的数据</span>
                <span class="hljs-type">ClientSyncData</span> <span class="hljs-variable">clientSyncData</span> <span class="hljs-operator">=</span> ApplicationUtils.getBean(Serializer.class)
                        .deserialize(distroData.getContent(), ClientSyncData.class);
                handlerClientSyncData(clientSyncData);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">case</span> DELETE:
                <span class="hljs-type">String</span> <span class="hljs-variable">deleteClientId</span> <span class="hljs-operator">=</span> distroData.getDistroKey().getResourceKey();
                Loggers.DISTRO.info(<span class="hljs-string">"[Client-Delete] Received distro client sync data {}"</span>, deleteClientId);
                clientManager.clientDisconnected(deleteClientId);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlerClientSyncData</span><span class="hljs-params">(ClientSyncData clientSyncData)</span> {
        Loggers.DISTRO
                .info(<span class="hljs-string">"[Client-Add] Received distro client sync data {}, revision={}"</span>, clientSyncData.getClientId(),
                        clientSyncData.getAttributes().getClientAttribute(ClientConstants.REVISION, <span class="hljs-number">0L</span>));
        clientManager.syncClientConnected(clientSyncData.getClientId(), clientSyncData.getAttributes());
        <span class="hljs-type">Client</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> clientManager.getClient(clientSyncData.getClientId());
        <span class="hljs-comment">// upgrade 是升级的含义，实际逻辑是完成 Distro 数据的写入</span>
        upgradeClient(client, clientSyncData);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">upgradeClient</span><span class="hljs-params">(Client client, ClientSyncData clientSyncData)</span> {
        Set&lt;Service&gt; syncedService = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
        <span class="hljs-comment">// process batch instance sync logic</span>
        processBatchInstanceDistroData(syncedService, client, clientSyncData);
        List&lt;String&gt; namespaces = clientSyncData.getNamespaces();
        List&lt;String&gt; groupNames = clientSyncData.getGroupNames();
        List&lt;String&gt; serviceNames = clientSyncData.getServiceNames();
        List&lt;InstancePublishInfo&gt; instances = clientSyncData.getInstancePublishInfos();

        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; namespaces.size(); i++) {
            <span class="hljs-type">Service</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> Service.newService(namespaces.get(i), groupNames.get(i), serviceNames.get(i));
            <span class="hljs-comment">// 注册并获取服务信息</span>
            <span class="hljs-type">Service</span> <span class="hljs-variable">singleton</span> <span class="hljs-operator">=</span> ServiceManager.getInstance().getSingleton(service);
            syncedService.add(singleton);
            <span class="hljs-type">InstancePublishInfo</span> <span class="hljs-variable">instancePublishInfo</span> <span class="hljs-operator">=</span> instances.get(i);
            <span class="hljs-keyword">if</span> (!instancePublishInfo.equals(client.getInstancePublishInfo(singleton))) {
                <span class="hljs-comment">// 执行的是 [registerInstance] 步骤5 的逻辑：将实例信息 InstancePublishInfo 添加到客户端的服务实例列表中</span>
                client.addServiceInstance(singleton, instancePublishInfo);
                <span class="hljs-comment">// 触发 ClientRegisterServiceEvent 事件</span>
                NotifyCenter.publishEvent(
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientOperationEvent</span>.ClientRegisterServiceEvent(singleton, client.getClientId()));
                NotifyCenter.publishEvent(
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MetadataEvent</span>.InstanceMetadataEvent(singleton, instancePublishInfo.getMetadataId(), <span class="hljs-literal">false</span>));
            }
        }
        <span class="hljs-keyword">for</span> (Service each : client.getAllPublishedService()) {
            <span class="hljs-keyword">if</span> (!syncedService.contains(each)) {
                client.removeServiceInstance(each);
                NotifyCenter.publishEvent(
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientOperationEvent</span>.ClientDeregisterServiceEvent(each, client.getClientId()));
            }
        }
        client.setRevision(clientSyncData.getAttributes().&lt;Integer&gt;getClientAttribute(ClientConstants.REVISION, <span class="hljs-number">0</span>));
    }
}
</code></pre>
<p><code>DistroClientDataProcessor#upgradeClient</code> 方法会执行时就和开篇介绍的 <code>EphemeralClientOperationServiceImpl#registerInstance</code> 方法基本一致的逻辑，注册 <code>Service</code> 信息，写入实例信息 <code>InstancePublishInfo</code>，并在随后发布 <code>ClientRegisterServiceEvent</code> 事件，这个事件我们在上一个小节专门介绍过，它的作用是将服务实例的变更信息推送给订阅了这个服务的所有客户端。</p>
<p>总而言之，通过 Distro 协议同步数据给集群中其他节点相当于在其他节点重新执行了一次实例注册的逻辑。不过，大家有没有考虑过这个问题：为什么 Distro 协议能够通过如此简单的方式在服务发现场景下保证数据的最终一致性呢？</p>
<p>最主要的原因是：<strong>服务注册数据模型的属性简化了分布式一致性问题，避免了复杂的冲突解决机制</strong>。该如何理解这个特点呢？</p>
<ul>
<li><strong>服务实例通过多个维度确定唯一性</strong>：命名空间 + 服务名 + 集群名 + IP地址 + 端口号，这种唯一性设计确保了同一个服务实例的注册信息在任何节点都是相同的，所以同一实例的注册信息在不同节点、不同时间先后写入都不会存在数据冲突问题，<strong>写入操作是幂等的</strong>，大大降低了保证数据一致性的复杂度。</li>
</ul>
<p>理解了这一点，我觉得便清楚了 Distro 协议的精髓。此外，还有以下原因使得 Distro 协议适用：</p>
<ol>
<li>服务实例的注册信息是 <strong>临时数据</strong>：数据具有生命周期，会自动过期或被清理，不需要持久化存储，丢失后可以重新生成，降低了维护实例数据的难度</li>
<li>业务场景能够接受数据的 <strong>最终一致性</strong>：可用性（Availability）比一致性（Consistency）更重要，短时间内部分实例注册信息不一致不影响业务</li>
<li>多个 Nacos Client 客户端会连接到不同的 Nacos Server 服务端，相当于进行了 <strong>分片</strong>：每个服务节点负责特定的客户端实例，客户端注册的操作基本只在一个服务节点发生，大大降低了发生写入冲突的可能</li>
</ol>
<p>接下来我们看一下在 Distro 协议中是如何清理过期数据的，核心逻辑在 <code>ExpiredClientCleaner</code> 中，它是一个定期执行的任务，任务逻辑如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExpiredClientCleaner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EphemeralIpPortClientManager clientManager;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">currentTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-comment">// 获取当前 Nacos Server 下连接的所有客户端</span>
        <span class="hljs-keyword">for</span> (String each : clientManager.allClientId()) {
            <span class="hljs-comment">// 遍历处理客户端信息</span>
            <span class="hljs-type">IpPortBasedClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> (IpPortBasedClient) clientManager.getClient(each);
            <span class="hljs-comment">// 如果客户端已经失效（在规定时间段内失去心跳）了</span>
            <span class="hljs-keyword">if</span> (<span class="hljs-literal">null</span> != client &amp;&amp; isExpireClient(currentTime, client)) {
                <span class="hljs-comment">// 执行客户端断开的逻辑，会触发 ClientDisconnectEvent 事件，删除失效的链接并通知集群内其他节点</span>
                clientManager.clientDisconnected(each);
            }
        }
    }
}
</code></pre>
<p>这个定时任务会在 Nacos Server 启动时，在 <code>ScheduledExecutorService</code> 中定期 5s 执行一次：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EphemeralIpPortClientManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ClientManager</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EphemeralIpPortClientManager</span><span class="hljs-params">(DistroMapper distroMapper, SwitchDomain switchDomain)</span> {
        <span class="hljs-comment">// 默认定期 5s 检查一次</span>
        GlobalExecutor.scheduleExpiredClientCleaner(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ExpiredClientCleaner</span>(<span class="hljs-built_in">this</span>, switchDomain), <span class="hljs-number">0</span>,
                Constants.DEFAULT_HEART_BEAT_INTERVAL, TimeUnit.MILLISECONDS);
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p>以此来保证过期的实例数据能及时被移除。</p>
<hr/>
<h3 data-id="heading-3">巨人的肩膀</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Falibaba%2Fnacos" target="_blank" title="https://github.com/alibaba/nacos" ref="nofollow noopener noreferrer">Github - alibaba/nacos</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fwenxuehai%2Fp%2F16179629.html" target="_blank" title="https://www.cnblogs.com/wenxuehai/p/16179629.html" ref="nofollow noopener noreferrer">博客园 - Nacos的基本使用（注册中心、配置中心）</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude vs Doubao Seek Code 产码能力对比]]></title>    <link>https://juejin.cn/post/7572537221540642831</link>    <guid>https://juejin.cn/post/7572537221540642831</guid>    <pubDate>2025-11-16T01:51:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572537221540642831" data-draft-id="7572714389942517812" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude vs Doubao Seek Code 产码能力对比"/> <meta itemprop="keywords" content="AI编程,Claude,代码规范"/> <meta itemprop="datePublished" content="2025-11-16T01:51:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="jump_jump"/> <meta itemprop="url" content="https://juejin.cn/user/4230576474692765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude vs Doubao Seek Code 产码能力对比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4230576474692765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    jump_jump
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T01:51:43.000Z" title="Sun Nov 16 2025 01:51:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">测试场景</h2>
<p><strong>相同测试任务</strong>：构建一个 agent，用于构建产品可行性方案，支持文档产出，使用 CrewAI</p>
<h2 data-id="heading-1">模型信息</h2>




















<table><thead><tr><th>维度</th><th>Claude Code</th><th>Doubao Seek Code</th></tr></thead><tbody><tr><td>模型版本</td><td>claude-sonnet-4-5-20250929</td><td>doubao-seed-code-preview-latest</td></tr><tr><td>定位</td><td>Anthropic 官方 CLI 工具</td><td>字节跳动豆包代码模型</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">一、项目结构对比</h2>
<h3 data-id="heading-3">Claude Code 结构</h3>
<pre><code class="hljs language-bash" lang="bash">crew-demo/
├── main.py                      <span class="hljs-comment"># CLI入口文件</span>
├── requirements.txt             <span class="hljs-comment"># Python依赖</span>
├── .env.example                <span class="hljs-comment"># 环境变量示例</span>
├── README.md                   <span class="hljs-comment"># 项目文档</span>
├── src/
│   ├── __init__.py
│   ├── crew_manager.py         <span class="hljs-comment"># Crew管理器</span>
│   ├── agents/
│   │   ├── __init__.py
│   │   └── feasibility_agents.py   <span class="hljs-comment"># Agent定义</span>
│   ├── tasks/
│   │   ├── __init__.py
│   │   └── feasibility_tasks.py    <span class="hljs-comment"># 任务定义</span>
│   ├── tools/
│   │   ├── __init__.py
│   │   └── document_generator.py   <span class="hljs-comment"># 文档生成工具</span>
│   └── config/
│       └── __init__.py
└── output/                     <span class="hljs-comment"># 输出报告目录（自动创建）</span>
    └── feasibility_report_*.md
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>采用标准 Python 包结构</li>
<li>模块化设计，职责分离清晰</li>
<li>使用 <code>src/</code> 目录隔离源代码</li>
<li>更符合大型项目的工程化规范</li>
</ul>
<h3 data-id="heading-4">Doubao Seek Code 结构</h3>
<pre><code class="hljs language-bash" lang="bash">├── config.yaml         <span class="hljs-comment"># 智能体与任务配置文件</span>
├── agents.py           <span class="hljs-comment"># 智能体定义模块</span>
├── tasks.py            <span class="hljs-comment"># 任务定义模块</span>
├── crew.py             <span class="hljs-comment"># CrewAI 协调模块</span>
├── main.py             <span class="hljs-comment"># 主入口程序</span>
├── example_usage.py    <span class="hljs-comment"># 使用示例</span>
├── .env.example        <span class="hljs-comment"># 环境变量示例</span>
└── requirements.txt    <span class="hljs-comment"># 依赖列表</span>
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>扁平化结构，所有文件在根目录</li>
<li>通过配置文件（config.yaml）管理配置</li>
<li>结构简洁，适合中小型项目</li>
<li>快速上手，易于理解</li>
</ul>
<p><strong>对比结论</strong>：</p>
<ul>
<li>Claude Code 更注重工程化和可扩展性</li>
<li>Doubao 更注重简洁性和快速开发</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、Agent 定义方式对比</h2>
<h3 data-id="heading-6">Claude Code - 代码化定义</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">financial_analyst</span>(<span class="hljs-params">self</span>) -&gt; Agent:
    <span class="hljs-string">"""财务分析师 - 负责成本收益分析"""</span>
    <span class="hljs-keyword">return</span> Agent(
        role=<span class="hljs-string">"财务分析师"</span>,
        goal=<span class="hljs-string">"评估产品的财务可行性，包括投资成本、预期收益、ROI和财务风险"</span>,
        backstory=<span class="hljs-string">"""你是一位专业的财务分析师，专注于创业项目和新产品的财务评估。
        你能够准确估算项目成本，预测收入模型，并计算关键财务指标。
        你的分析帮助决策者理解项目的经济价值和投资回报。"""</span>,
        verbose=<span class="hljs-literal">True</span>,
        allow_delegation=<span class="hljs-literal">False</span>,
        llm=self.llm
    )
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>类型提示，IDE 支持更好</li>
<li>灵活性高，可以动态配置</li>
<li>backstory 详细，上下文丰富</li>
</ul>
<h3 data-id="heading-7">Doubao Seek Code - 配置化定义</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">financial_analyst:</span>
    <span class="hljs-attr">role:</span> <span class="hljs-string">财务分析师</span>
    <span class="hljs-attr">goal:</span> <span class="hljs-string">进行财务预测、成本分析和投资回报率计算</span>
    <span class="hljs-attr">backstory:</span> <span class="hljs-string">注册会计师,拥有丰富的</span> <span class="hljs-string">startup</span> <span class="hljs-string">财务建模经验</span>
    <span class="hljs-attr">tools:</span> []
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>声明式配置，非开发人员也能理解</li>
<li>集中管理，易于批量修改</li>
<li>结构清晰，配置与代码分离</li>
</ul>
<p><strong>对比结论</strong>：</p>
<ul>
<li>Claude Code 适合需要复杂逻辑和动态配置的场景</li>
<li>Doubao 适合配置驱动、需要频繁调整角色的场景</li>
</ul>
<hr/>
<h2 data-id="heading-8">三、任务描述对比</h2>
<h3 data-id="heading-9">Claude Code - 详细任务描述</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@staticmethod</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">market_research_task</span>(<span class="hljs-params">agent, product_description: <span class="hljs-built_in">str</span></span>) -&gt; Task:
    <span class="hljs-string">"""市场调研任务"""</span>
    <span class="hljs-keyword">return</span> Task(
        description=<span class="hljs-string">f"""
        针对以下产品进行深入的市场调研和分析：

        产品描述：<span class="hljs-subst">{product_description}</span>

        请完成以下分析：
        1. 目标市场分析
            - 目标用户画像
            - 市场规模（TAM、SAM、SOM）
            - 用户痛点和需求

        2. 竞品分析
            - 主要竞品列表（至少3-5个）
            - 竞品优劣势对比
            - 市场差异化机会

        3. 市场趋势
            - 行业发展趋势
            - 技术趋势
            - 用户行为趋势

        4. 市场机会评估
            - 市场切入点
            - 潜在增长空间
            - 市场时机评估

        请提供详细的数据支持和清晰的结论。
        """</span>,
        agent=agent,
        expected_output=<span class="hljs-string">"详细的市场调研报告，包含目标市场分析、竞品分析、市场趋势和机会评估"</span>,
    )
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>任务描述极其详细</li>
<li>明确了每个分析维度的具体要求</li>
<li>包含期望输出的详细说明</li>
</ul>
<h3 data-id="heading-10">Doubao Seek Code - 简洁任务描述</h3>
<pre><code class="hljs language-python" lang="python">market_analysis_task = Task(
    description=self._format_task_description(
        <span class="hljs-comment"># 1. 分析目标市场规模（TAM/SAM/SOM）</span>
        <span class="hljs-comment"># 2. 研究市场增长趋势和驱动因素</span>
        <span class="hljs-comment"># 3. 分析竞争格局（直接/间接竞争对手）</span>
        <span class="hljs-comment"># 4. 定义目标用户画像和核心需求</span>
        tasks_config[<span class="hljs-string">"market_analysis"</span>][<span class="hljs-string">"description"</span>]
    ),
    agent=self.agents[<span class="hljs-string">"market_researcher"</span>],
    expected_output=<span class="hljs-string">"结构化的市场可行性分析报告片段，包含市场规模、趋势、竞争格局和用户需求"</span>,
)
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>实际描述从配置文件读取</li>
<li>更简洁，但依赖配置文件的完整性</li>
</ul>
<p><strong>对比结论</strong>：</p>
<ul>
<li>Claude Code 更适合复杂任务，需要详细指导</li>
<li>Doubao 更适合标准化任务，通过配置复用</li>
</ul>
<hr/>
<h2 data-id="heading-11">四、README 文档对比</h2>
<h3 data-id="heading-12">文档完整度</h3>























































<table><thead><tr><th>维度</th><th>Claude Code</th><th>Doubao Seek Code</th></tr></thead><tbody><tr><td>功能介绍</td><td>✅ 详细</td><td>✅ 简洁</td></tr><tr><td>安装步骤</td><td>✅ 完整（含虚拟环境）</td><td>✅ 基础步骤</td></tr><tr><td>使用示例</td><td>✅ 多种场景示例</td><td>✅ 基础示例</td></tr><tr><td>高级功能</td><td>✅ 模型切换、分析模式</td><td>❌ 无</td></tr><tr><td>流程图</td><td>✅ Mermaid 图表</td><td>❌ 无</td></tr><tr><td>Agent 详解</td><td>✅ 每个 Agent 详细说明</td><td>✅ 表格概览</td></tr><tr><td>最佳实践</td><td>✅ 提供建议</td><td>✅ 注意事项</td></tr><tr><td>故障排查</td><td>✅ 常见问题 Q&amp;A</td><td>❌ 无</td></tr><tr><td>自定义扩展</td><td>✅ 代码示例</td><td>✅ 配置说明</td></tr></tbody></table>
<p><strong>对比结论</strong>：</p>
<ul>
<li>Claude Code 文档更适合初学者和深度用户</li>
<li>Doubao 文档适合快速上手</li>
</ul>
<hr/>
<h2 data-id="heading-13">五、核心优势对比</h2>
<h3 data-id="heading-14">Claude Code 优势</h3>
<ol>
<li>
<p><strong>交互性强</strong></p>
<ul>
<li>支持随时打断当前任务</li>
<li>可根据用户输入动态调整后续逻辑</li>
<li>更符合实际开发中的迭代过程</li>
</ul>
</li>
<li>
<p><strong>工程化程度高</strong></p>
<ul>
<li>标准化的项目结构</li>
<li>完善的文档和示例</li>
<li>支持多种分析模式（full/quick）</li>
</ul>
</li>
<li>
<p><strong>功能丰富</strong></p>
<ul>
<li>支持从文件读取产品描述</li>
<li>提供多种模型选择</li>
<li>包含流程可视化（Mermaid）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-15">Doubao Seek Code 优势</h3>
<ol>
<li>
<p><strong>成本优势</strong></p>
<ul>
<li>首月 9.9 元</li>
<li>后续 40 元/月</li>
<li>对比 Claude/GPT-4 显著降低成本</li>
</ul>
</li>
<li>
<p><strong>配置化设计</strong></p>
<ul>
<li>YAML 配置文件管理</li>
<li>非开发人员也能调整</li>
<li>易于批量修改和复用</li>
</ul>
</li>
<li>
<p><strong>快速上手</strong></p>
<ul>
<li>扁平化结构，文件更少</li>
<li>简洁的文档</li>
<li>自带使用示例（example_usage.py）</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-16">六、存在的问题</h2>
<h3 data-id="heading-17">Doubao Seek Code</h3>
<p><strong>工作流问题</strong>：</p>
<ul>
<li>需要在提示词中明确添加"直接产码"</li>
<li>默认流程：先建立 requirements.txt → 拉取依赖 → 产码</li>
<li>用户必须中止对话并重新要求才能跳过依赖安装</li>
<li>Claude Code 则会先完成所有代码生成，最后再处理依赖</li>
</ul>
<p><strong>影响</strong>：</p>
<ul>
<li>降低了开发效率</li>
<li>打断了连续的产码体验</li>
<li>需要用户干预</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RocketMQ vs Kafka03 - 高可用机制深度剖析]]></title>    <link>https://juejin.cn/post/7572510909445586994</link>    <guid>https://juejin.cn/post/7572510909445586994</guid>    <pubDate>2025-11-15T12:51:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572510909445586994" data-draft-id="7572502156487147546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RocketMQ vs Kafka03 - 高可用机制深度剖析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-15T12:51:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张小黑12"/> <meta itemprop="url" content="https://juejin.cn/user/985627390911096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RocketMQ vs Kafka03 - 高可用机制深度剖析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/985627390911096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张小黑12
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T12:51:51.000Z" title="Sat Nov 15 2025 12:51:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第三篇：高可用机制深度剖析</h2>
<blockquote>
<p>高可用这事儿，从来不是靠某一个参数"调优"就能解决的。它背后是副本协议、故障检测、自动切换、数据对齐这一整套机制。本文会从 Kafka 和 RocketMQ 的源码实现入手，把 ISR、HW/LEO、Raft、主从复制等关键路径拆开讲，同时给出真实场景下的配置策略和踩坑经验。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">3.1 高可用设计理念</h3>
<p>先理清概念：高可用（HA）的目标是"尽可能减少不可用时间"。业界常用的指标是：</p>
<ul>
<li><strong>99.9%</strong>：年不可用时间约 8.76 小时（一般业务可接受）</li>
<li><strong>99.99%</strong>：年不可用时间约 52.6 分钟（金融、支付等核心系统）</li>
<li><strong>99.999%</strong>：年不可用时间约 5.26 分钟（运营商级别）</li>
</ul>
<p>要做到 4 个 9，必须在架构、流程、工具三个层面同时投入：</p>
<ol>
<li><strong>架构层</strong>：多副本、跨机房、自动故障转移</li>
<li><strong>流程层</strong>：变更审批、容量规划、故障演练</li>
<li><strong>工具层</strong>：监控告警、自动化运维、回滚机制</li>
</ol>
<p>Kafka 和 RocketMQ 在这三个维度的投入方式不太一样。</p>
<h4 data-id="heading-2">Kafka：去中心 + ISR + Controller</h4>
<p>Kafka 的架构哲学是"去中心化"：每个 Broker 都可能是某些 Partition 的 Leader，也可能是另一些 Partition 的 Follower。这种设计带来两个好处：</p>
<ol>
<li><strong>负载均衡天然</strong>：Leader 分散在各个 Broker，不会所有压力集中在某台机器。</li>
<li><strong>扩展性强</strong>：加一台 Broker，立刻就能分担流量。</li>
</ol>
<p>但去中心也有代价：需要一个"协调者"来管理元数据、触发 Leader 选举。这个协调者就是 Controller。</p>
<p><strong>Controller 的核心职责</strong>：</p>
<ul>
<li>监听 Broker 的上下线（通过 ZooKeeper session / KRaft 心跳）</li>
<li>管理每个 Partition 的 ISR 列表</li>
<li>在 Leader 宕机时从 ISR 中选新 Leader</li>
<li>把元数据变更通知到所有 Broker</li>
</ul>
<p><strong>ISR 机制</strong>：</p>
<ul>
<li>ISR（In-Sync Replicas）是 Kafka 高可用的核心。只有"紧跟"Leader 的副本才能留在 ISR 中。</li>
<li>判定标准：Follower 的 LEO（Log End Offset）与 Leader 的 LEO 差距不超过 <code>replica.lag.time.max.ms</code>（默认 10 秒）。</li>
<li>写入时 Producer 配置 <code>acks=all</code>，只有 ISR 内的所有副本都写入成功，才算真正成功。</li>
</ul>
<p>Kafka 的这套理念，适合"高吞吐 + 多分区 + 动态扩缩容"的场景，比如日志流、监控数据。</p>
<h4 data-id="heading-3">RocketMQ：主备明确 + 刷盘控制 + DLedger</h4>
<p>RocketMQ 的哲学是"主备角色清晰"：Master 负责读写，Slave 负责备份。这种设计简单粗暴，运维容易理解。</p>
<p><strong>Master-Slave 的优势</strong>：</p>
<ul>
<li>写入路径明确：Producer 只连 Master，不会分散到多台机器。</li>
<li>切换逻辑清晰：Master 挂了，要么人工提升 Slave，要么靠 DLedger 自动选举。</li>
<li>配置直观：<code>SYNC_MASTER</code> vs <code>ASYNC_MASTER</code>、同步刷盘 vs 异步刷盘，组合起来就是四种可靠性等级。</li>
</ul>
<p>但主备也有限制：单 Master 的写入能力有上限。所以 RocketMQ 通常会部署多组 Master-Slave，每组承担一部分 Topic/Queue。</p>
<p><strong>DLedger（4.5+）</strong>：</p>
<ul>
<li>把 CommitLog 存储抽象成 Raft 日志，写入需要多数派确认。</li>
<li>Leader 故障自动选举新 Leader，不需要人工干预。</li>
<li>适合对一致性要求高、又希望自动切换的场景（如金融核心系统）。</li>
</ul>
<p>RocketMQ 的这套理念，适合"确定性 + 可控性 + 业务消息"的场景，比如订单、支付、库存。</p>
<h4 data-id="heading-4">两者对比</h4>






























<table><thead><tr><th>维度</th><th>Kafka</th><th>RocketMQ</th></tr></thead><tbody><tr><td>角色模型</td><td>去中心化，动态 Leader</td><td>主备明确，Master/Slave 或 DLedger</td></tr><tr><td>副本同步</td><td>ISR 动态调整，灵活但需监控</td><td>模式固定，简单但切换需规划</td></tr><tr><td>控制面</td><td>Controller 重，需配合 ZK/KRaft</td><td>NameServer 轻，逻辑在 Broker</td></tr><tr><td>适合场景</td><td>日志流、高吞吐、流处理</td><td>业务消息、事务、订单</td></tr></tbody></table>
<p>没有"谁更好"，只有"谁更适合你的场景"。下面几节会深入源码和配置，把两者的高可用机制拆到底。</p>
<hr/>
<h3 data-id="heading-5">3.2 故障检测与恢复</h3>
<p>故障检测分三步：感知、判定、处置。Kafka 和 RocketMQ 在每一步的实现都有差异。</p>
<h4 data-id="heading-6">Kafka 的故障检测链路</h4>
<h5 data-id="heading-7">Broker 心跳与 session 管理</h5>
<p><strong>ZooKeeper 模式（3.0 之前）</strong>：</p>
<p>Broker 启动时会在 ZooKeeper 创建临时节点 <code>/brokers/ids/{brokerId}</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"host"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"192.168.1.10"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"port"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">9092</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"timestamp"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1700000000000"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"endpoints"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"PLAINTEXT://192.168.1.10:9092"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这是个临时节点（Ephemeral），Broker 与 ZooKeeper 的 session 断开后，节点会自动删除。Controller 监听 <code>/brokers/ids</code> 目录，一旦节点消失，立刻触发处理。</p>
<p>关键参数：</p>
<ul>
<li><code>zookeeper.session.timeout.ms</code>：默认 18000（18 秒），session 超时时间</li>
<li><code>zookeeper.connection.timeout.ms</code>：默认 18000（18 秒），连接超时时间</li>
</ul>
<p>调优经验：</p>
<ul>
<li>session 超时不要太短，否则网络抖动会频繁触发 failover。</li>
<li>也不要太长，否则故障恢复慢。一般生产环境保持 18~30 秒。</li>
</ul>
<p><strong>KRaft 模式（3.0+）</strong>：</p>
<p>不再依赖 ZooKeeper，Broker 直接与 Controller 通信。Controller 内部维护 Broker 的心跳表，通过 Raft 通道定期收心跳。</p>
<p>关键参数：</p>
<ul>
<li><code>broker.session.timeout.ms</code>：默认 9000（9 秒）</li>
<li><code>broker.heartbeat.interval.ms</code>：默认 2000（2 秒）</li>
</ul>
<p>KRaft 的故障感知更快（9 秒 vs 18 秒），元数据变更也更快（不需要经过 ZooKeeper）。</p>
<h5 data-id="heading-8">ISR 收缩与扩展</h5>
<p>ISR 的更新逻辑在 <code>Partition.scala</code> 的 <code>maybeExpandIsr()</code> 和 <code>maybeShrinkIsr()</code> 方法中。</p>
<p><strong>收缩逻辑（maybeShrinkIsr）</strong>：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">maybeShrinkIsr</span></span>(): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">val</span> now = time.milliseconds()
  <span class="hljs-keyword">val</span> outOfSyncReplicas = inSyncReplicas.filter { replica =&gt;
    <span class="hljs-keyword">val</span> lastCaughtUpTimeMs = replica.lastCaughtUpTimeMs
    (now - lastCaughtUpTimeMs) &gt; replicaLagTimeMaxMs
  }
  
  <span class="hljs-keyword">if</span> (outOfSyncReplicas.nonEmpty) {
    <span class="hljs-keyword">val</span> newIsr = inSyncReplicas -- outOfSyncReplicas
    updateIsr(newIsr)
    zkClient.updateIsr(topic, partition, newIsr)
  }
}
</code></pre>
<p>核心逻辑：</p>
<ol>
<li>遍历所有 ISR 副本，检查 <code>lastCaughtUpTimeMs</code>（最后一次追上 Leader 的时间）。</li>
<li>如果 <code>now - lastCaughtUpTimeMs &gt; replica.lag.time.max.ms</code>，踢出 ISR。</li>
<li>更新本地 ISR 列表，同时写入 ZooKeeper（ZK 模式）或元数据日志（KRaft）。</li>
</ol>
<p><strong>扩展逻辑（maybeExpandIsr）</strong>：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">maybeExpandIsr</span></span>(): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">val</span> outOfSyncReplicas = assignedReplicas -- inSyncReplicas
  <span class="hljs-keyword">val</span> caughtUpReplicas = outOfSyncReplicas.filter { replica =&gt;
    replica.logEndOffset &gt;= leader.highWatermark
  }
  
  <span class="hljs-keyword">if</span> (caughtUpReplicas.nonEmpty) {
    <span class="hljs-keyword">val</span> newIsr = inSyncReplicas ++ caughtUpReplicas
    updateIsr(newIsr)
    zkClient.updateIsr(topic, partition, newIsr)
  }
}
</code></pre>
<p>核心逻辑：</p>
<ol>
<li>找出所有"不在 ISR 中"的副本。</li>
<li>如果某个副本的 LEO 已经追上 Leader 的 HW，说明它已经同步完成，可以加入 ISR。</li>
<li>更新 ISR 列表。</li>
</ol>
<p><strong>ISR 抖动问题</strong>：</p>
<p>如果网络不稳定，Follower 会频繁进出 ISR，导致：</p>
<ul>
<li>ZooKeeper 写入压力大</li>
<li>Controller 频繁发送 UpdateMetadata 请求</li>
<li>监控告警频繁触发</li>
</ul>
<p>优化手段：</p>
<ul>
<li>调大 <code>replica.lag.time.max.ms</code>（从 10 秒调到 30 秒）</li>
<li>升级到 KRaft，减少 ZooKeeper 写入</li>
<li>使用 Cruise Control 检测慢副本，提前迁移</li>
</ul>
<h5 data-id="heading-9">Leader 选举流程</h5>
<p>Leader 宕机后，Controller 会从 ISR 中选出新 Leader。选举逻辑在 <code>PartitionStateMachine.scala</code> 中。</p>
<p><strong>选举步骤</strong>：</p>
<ol>
<li>
<p><strong>触发条件</strong>：</p>
<ul>
<li>Broker 下线（ZK session 超时 / KRaft 心跳超时）</li>
<li>Leader 所在 Broker 下线</li>
<li>手动触发 Preferred Leader Election</li>
</ul>
</li>
<li>
<p><strong>选举策略</strong>：</p>
<ul>
<li>从当前 ISR 列表中选择第一个可用的副本</li>
<li>如果 ISR 为空且 <code>unclean.leader.election.enable=true</code>，从所有副本中选择 LEO 最大的（可能丢数据）</li>
<li>如果 ISR 为空且不允许 Unclean，Partition 进入离线状态</li>
</ul>
</li>
<li>
<p><strong>元数据更新</strong>：</p>
<ul>
<li>Controller 更新 Leader Epoch（防止脑裂）</li>
<li>通知新 Leader 开始服务</li>
<li>通知其他 Broker 更新元数据</li>
</ul>
</li>
<li>
<p><strong>通知 Follower</strong>：</p>
<ul>
<li>Follower 收到 Leader 变更通知后，会截断本地日志到新 Leader 的 HW，避免数据不一致</li>
</ul>
</li>
</ol>
<p><strong>源码关键路径</strong>：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// PartitionStateMachine.scala</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">electLeader</span></span>(partition: <span class="hljs-type">TopicPartition</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">val</span> isr = zkClient.getInSyncReplicas(partition)
  <span class="hljs-keyword">val</span> newLeader = <span class="hljs-keyword">if</span> (isr.nonEmpty) {
    isr.head  <span class="hljs-comment">// 选择 ISR 第一个</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (uncleanLeaderElectionEnable) {
    allReplicas.maxBy(_.logEndOffset)  <span class="hljs-comment">// 选择 LEO 最大的</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-number">-1</span>  <span class="hljs-comment">// 离线</span>
  }
  
  <span class="hljs-keyword">if</span> (newLeader &gt;= <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">val</span> newLeaderEpoch = controllerEpoch + <span class="hljs-number">1</span>
    zkClient.updateLeaderAndIsr(partition, newLeader, isr, newLeaderEpoch)
    sendUpdateMetadataRequest(allBrokers)
  }
}
</code></pre>
<p><strong>Unclean Leader Election 的风险</strong>：</p>
<p>如果开启 <code>unclean.leader.election.enable=true</code>，允许落后副本上位：</p>
<ul>
<li>可能读到旧数据（LEO 小的副本成为 Leader）</li>
<li>可能丢失数据（新 Leader 不包含旧 Leader 的部分数据）</li>
</ul>
<p>生产环境一般禁用这个参数，宁可 Partition 暂时离线，也不要数据错乱。</p>
<h5 data-id="heading-10">Controlled Shutdown（优雅停机）</h5>
<p>Kafka 支持优雅停机，在 Broker 下线前主动迁移 Leader。</p>
<p><strong>流程</strong>：</p>
<ol>
<li>Broker 向 Controller 发送 <code>ControlledShutdownRequest</code></li>
<li>Controller 把该 Broker 上所有 Leader Partition 迁移到其他副本</li>
<li>迁移完成后，Broker 关闭网络监听，等待剩余请求处理完</li>
<li>最后关闭磁盘刷盘、日志清理等后台线程</li>
</ol>
<p><strong>配置</strong>：</p>
<pre><code class="hljs language-properties" lang="properties"># 开启优雅停机
controlled.shutdown.enable=true

# 最大重试次数
controlled.shutdown.max.retries=3

# 重试间隔
controlled.shutdown.retry.backoff.ms=5000
</code></pre>
<p>实战中，优雅停机能减少 Partition 不可用时间（从 10 秒降到 &lt; 1 秒）。但如果网络有问题，可能卡在"等待 Leader 迁移"阶段，需要设置超时。</p>
<h4 data-id="heading-11">RocketMQ 的故障检测链路</h4>
<h5 data-id="heading-12">Broker 心跳机制</h5>
<p>RocketMQ 的心跳分两类：</p>
<ol>
<li><strong>Broker → NameServer</strong>：每 30 秒上报路由信息</li>
<li><strong>Slave → Master</strong>：HAService 的长连接心跳，秒级检测</li>
</ol>
<p><strong>Broker 注册流程</strong>：</p>
<p>Broker 启动时向所有 NameServer 发送注册请求，包含：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"brokerName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"broker-a"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"brokerId"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"brokerAddr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"192.168.1.10:10911"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"clusterName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"DefaultCluster"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"haServerAddr"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"192.168.1.10:10912"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"topicConfigWrapper"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>NameServer 收到后更新路由表，并记录时间戳。后续每 30 秒 Broker 会重新发一次。</p>
<p><strong>心跳超时判定</strong>：</p>
<p>NameServer 有个定时任务 <code>RouteInfoManager.scanNotActiveBroker()</code>，每 10 秒扫一次：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scanNotActiveBroker</span><span class="hljs-params">()</span> {
    <span class="hljs-type">long</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
    Iterator&lt;Entry&lt;String, BrokerLiveInfo&gt;&gt; it = brokerLiveTable.entrySet().iterator();
    <span class="hljs-keyword">while</span> (it.hasNext()) {
        Entry&lt;String, BrokerLiveInfo&gt; entry = it.next();
        <span class="hljs-type">long</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> entry.getValue().getLastUpdateTimestamp();
        <span class="hljs-keyword">if</span> ((current - last) &gt; brokerExpiredTime) {  <span class="hljs-comment">// 默认 120 秒</span>
            it.remove();
            onBrokerInactive(entry.getKey());
        }
    }
}
</code></pre>
<p>超过 120 秒没收到心跳，NameServer 把 Broker 从路由表移除。Producer/Consumer 在下次拉取路由时会感知到变化。</p>
<p><strong>配置</strong>：</p>
<pre><code class="hljs language-properties" lang="properties"># Broker 心跳间隔（毫秒）
heartbeatBrokerInterval=30000

# NameServer 认为 Broker 失效的时间（毫秒）
brokerExpiredTime=120000
</code></pre>
<p>调优建议：</p>
<ul>
<li>心跳间隔不要太长，否则故障感知慢。</li>
<li>超时时间至少要是心跳间隔的 3 倍，防止偶发丢包。</li>
</ul>
<h5 data-id="heading-13">HAService：主从复制监控</h5>
<p>Slave 通过 HAService 与 Master 保持长连接，实时复制 CommitLog。</p>
<p><strong>HAService 线程模型</strong>：</p>
<p>Master 端：</p>
<ul>
<li><code>AcceptSocketService</code>：接受 Slave 连接</li>
<li><code>HAConnection.WriteSocketService</code>：向 Slave 发送数据</li>
<li><code>HAConnection.ReadSocketService</code>：接收 Slave 的 ACK</li>
</ul>
<p>Slave 端：</p>
<ul>
<li><code>HAClient</code>：连接 Master，拉取数据并写入本地 CommitLog</li>
</ul>
<p><strong>复制延迟监控</strong>：</p>
<p>Master 会记录每个 Slave 的复制进度（Slave Ack Offset），与当前 CommitLog 的最大偏移量对比，得出延迟：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">long</span> <span class="hljs-variable">masterMaxOffset</span> <span class="hljs-operator">=</span> commitLog.getMaxOffset();
<span class="hljs-type">long</span> <span class="hljs-variable">slaveAckOffset</span> <span class="hljs-operator">=</span> haConnection.getSlaveAckOffset();
<span class="hljs-type">long</span> <span class="hljs-variable">diff</span> <span class="hljs-operator">=</span> masterMaxOffset - slaveAckOffset;

<span class="hljs-keyword">if</span> (diff &gt; maxTransferLag) {
    log.warn(<span class="hljs-string">"Slave lag too large: {}MB"</span>, diff / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>);
}
</code></pre>
<p>如果延迟过大（比如 &gt; 1GB），说明 Slave 性能跟不上或网络有问题，需要告警。</p>
<h5 data-id="heading-14">DLedger 的 Raft 选举</h5>
<p>DLedger 是 RocketMQ 4.5+ 引入的 Raft 实现，用于替代 Master-Slave 的手动切换。</p>
<p><strong>Raft 核心角色</strong>：</p>
<ul>
<li><strong>Leader</strong>：负责读写，类似 Master</li>
<li><strong>Follower</strong>：从 Leader 复制数据，类似 Slave</li>
<li><strong>Candidate</strong>：选举中的临时角色</li>
</ul>
<p><strong>选举触发</strong>：</p>
<ul>
<li>Leader 心跳超时（默认 1 秒）</li>
<li>Follower 收不到 Leader 心跳，进入 Candidate 状态</li>
<li>向其他节点发起投票请求</li>
</ul>
<p><strong>投票逻辑</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// DLedgerLeaderElector.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleVote</span><span class="hljs-params">(VoteRequest request)</span> {
    <span class="hljs-keyword">if</span> (request.getTerm() &gt; <span class="hljs-built_in">this</span>.term) {
        <span class="hljs-comment">// 对方 term 更大，同意投票</span>
        <span class="hljs-built_in">this</span>.term = request.getTerm();
        <span class="hljs-built_in">this</span>.votedFor = request.getCandidateId();
        <span class="hljs-keyword">return</span> VoteResponse.ACCEPT;
    }
    
    <span class="hljs-keyword">if</span> (request.getLedgerEndIndex() &lt; <span class="hljs-built_in">this</span>.ledgerEndIndex) {
        <span class="hljs-comment">// 对方数据落后，拒绝投票</span>
        <span class="hljs-keyword">return</span> VoteResponse.REJECT;
    }
    
    <span class="hljs-comment">// 其他情况看是否已投票</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.votedFor == <span class="hljs-literal">null</span> || <span class="hljs-built_in">this</span>.votedFor.equals(request.getCandidateId())) {
        <span class="hljs-built_in">this</span>.votedFor = request.getCandidateId();
        <span class="hljs-keyword">return</span> VoteResponse.ACCEPT;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> VoteResponse.REJECT;
    }
}
</code></pre>
<p><strong>选举完成</strong>：</p>
<ul>
<li>获得多数票的 Candidate 成为 Leader</li>
<li>Leader 定期发送心跳（AppendEntries）维持地位</li>
<li>如果 Leader 挂掉，再次发起选举</li>
</ul>
<p>DLedger 的优势是"自动切换 + 强一致"，缺点是性能略低于异步复制（需要多数派确认）。</p>
<h4 data-id="heading-15">故障恢复时间对比</h4>








































<table><thead><tr><th>故障类型</th><th>Kafka (ZK)</th><th>Kafka (KRaft)</th><th>RocketMQ (MS)</th><th>RocketMQ (DLedger)</th></tr></thead><tbody><tr><td>Broker 宕机感知</td><td>18 秒</td><td>9 秒</td><td>120 秒</td><td>1 秒</td></tr><tr><td>Leader 选举时间</td><td>5~10 秒</td><td>2~5 秒</td><td>人工（分钟级）</td><td>自动（&lt; 1 秒）</td></tr><tr><td>路由更新时间</td><td>立即</td><td>立即</td><td>120 秒内</td><td>立即</td></tr><tr><td>总恢复时间</td><td>20~30 秒</td><td>10~15 秒</td><td>2~5 分钟</td><td>2~3 秒</td></tr></tbody></table>
<p>RocketMQ 的 DLedger 在自动切换上有明显优势，但 Master-Slave 模式的心跳超时太长（120 秒），需要靠监控提前发现问题。</p>
<hr/>
<h3 data-id="heading-16">3.3 数据一致性保证</h3>
<p>一致性是"不同副本能看到相同数据"的能力。在分布式环境下，网络延迟、节点故障都会造成数据不一致。Kafka 和 RocketMQ 通过不同的协议保证一致性。</p>
<h4 data-id="heading-17">Kafka：HW/LEO + Leader Epoch</h4>
<h5 data-id="heading-18">HW（High Watermark）与 LEO（Log End Offset）</h5>
<p>这是 Kafka 副本机制的核心概念。</p>
<p><strong>LEO</strong>：日志的最新偏移量，即"写到哪儿了"。每个副本都有自己的 LEO。</p>
<p><strong>HW</strong>：High Watermark，所有 ISR 副本都已确认的偏移量，即"消费者能读到哪儿"。</p>
<p>关系：<code>HW &lt;= min(所有 ISR 副本的 LEO)</code></p>
<p>举例：</p>
<ul>
<li>Leader LEO = 100</li>
<li>Follower1 LEO = 98</li>
<li>Follower2 LEO = 97</li>
<li>ISR = [Leader, Follower1, Follower2]</li>
<li>则 HW = min(100, 98, 97) = 97</li>
</ul>
<p>Consumer 只能读到 Offset 97 之前的数据，Offset 98~100 虽然 Leader 有，但还没"多数派确认"，暂时不可见。</p>
<p><strong>HW 更新流程</strong>：</p>
<ol>
<li>Producer 发送消息到 Leader，Leader 写入本地日志，LEO 变为 101。</li>
<li>Follower 通过 Fetch 请求拉取数据，写入本地日志，各自 LEO 更新。</li>
<li>Follower 在下一次 Fetch 时带上自己的 LEO，Leader 据此更新 HW。</li>
<li>HW 更新后，Leader 在 FetchResponse 中返回新的 HW 给 Follower，Follower 也更新本地 HW。</li>
</ol>
<p>这个流程有个特点：<strong>HW 的更新需要两轮 Fetch</strong>。这在旧版本中会导致数据截断问题，新版本通过 Leader Epoch 修复。</p>
<h5 data-id="heading-19">Leader Epoch 机制</h5>
<p>Leader Epoch 是 Kafka 2.5+ 引入的机制，用于解决 HW 更新滞后导致的数据截断问题。</p>
<p><strong>问题场景</strong>：</p>
<ol>
<li>Leader A，Follower B，ISR = [A, B]</li>
<li>Leader A 写入 Offset 100~102，LEO = 103，但 HW 还是 100（需要等 B 拉取）</li>
<li>B 拉取数据，LEO = 103，但本地 HW 还是 100（需要等下一轮 Fetch）</li>
<li>此时 A 宕机，B 当选 Leader。但 B 的 HW 是 100，所以 B 会截断 101~102 的数据</li>
<li>如果 A 恢复后重新加入，会从 B 同步，导致 101~102 的数据永久丢失</li>
</ol>
<p><strong>Leader Epoch 解决方案</strong>：</p>
<p>每次 Leader 选举，Epoch 递增。Follower 在同步前，先向 Leader 查询"我的 Epoch 对应的截断点"，而不是盲目截断到 HW。</p>
<p><strong>Epoch 查询流程</strong>：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// Follower 向新 Leader 查询</span>
<span class="hljs-keyword">val</span> request = <span class="hljs-type">OffsetsForLeaderEpochRequest</span>(myEpoch, myLEO)
<span class="hljs-keyword">val</span> response = leader.offsetsForLeaderEpoch(request)

<span class="hljs-keyword">if</span> (response.endOffset &lt; myLEO) {
  truncateTo(response.endOffset)  <span class="hljs-comment">// 只截断必要的部分</span>
}
</code></pre>
<p>这样就避免了"HW 滞后导致的数据丢失"。Leader Epoch 信息存储在 <code>.snapshot</code> 文件中。</p>
<h4 data-id="heading-20">RocketMQ：CommitLog 复制 + Raft 日志</h4>
<h5 data-id="heading-21">主从复制的 ACK 机制</h5>
<p>RocketMQ 的 Master-Slave 复制相对简单：</p>
<p><strong>ASYNC_MASTER（异步复制）</strong>：</p>
<ol>
<li>Producer 发消息到 Master</li>
<li>Master 写入 CommitLog，立即返回成功</li>
<li>HAService 后台线程异步把 CommitLog 复制到 Slave</li>
</ol>
<p>这种模式性能最高，但 Master 宕机会丢失"未复制的部分"。</p>
<p><strong>SYNC_MASTER（同步复制）</strong>：</p>
<ol>
<li>Producer 发消息到 Master</li>
<li>Master 写入 CommitLog，等待 Slave 返回 ACK</li>
<li>Slave 写入成功后返回 ACK</li>
<li>Master 收到 ACK 后才返回 Producer 成功</li>
</ol>
<p>这种模式可靠性高，但性能会下降 30% 左右（增加一次网络往返）。</p>
<p><strong>源码核心逻辑</strong>（简化版）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// HAService.java（Master 端）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">notifyTransferSome</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">long</span> offset)</span> {
    <span class="hljs-keyword">for</span> (HAConnection conn : connectionList) {
        conn.getTransferService().wakeup();  <span class="hljs-comment">// 唤醒发送线程</span>
    }
    
    <span class="hljs-keyword">if</span> (BrokerRole.SYNC_MASTER == brokerRole) {
        <span class="hljs-comment">// 同步复制，等待 Slave ACK</span>
        waitForSlaveAck(offset, syncFlushTimeout);
    }
}
</code></pre>
<p><strong>Slave ACK 逻辑</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// HAClient.java（Slave 端）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatchReadRequest</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 读取 Master 发来的数据</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">masterOffset</span> <span class="hljs-operator">=</span> readSocketBuffer.getLong();
    <span class="hljs-type">byte</span>[] bodyData = readSocketBuffer.getBytes();
    
    <span class="hljs-comment">// 写入本地 CommitLog</span>
    commitLog.appendData(masterOffset, bodyData);
    
    <span class="hljs-comment">// 返回 ACK</span>
    <span class="hljs-built_in">this</span>.currentReportedOffset = masterOffset + bodyData.length;
    reportSlaveMaxOffset(currentReportedOffset);
}
</code></pre>
<h5 data-id="heading-22">DLedger 的 Raft 日志复制</h5>
<p>DLedger 把 CommitLog 抽象成 Raft 日志（DLedger Log），每条消息对应一个 Entry。</p>
<p><strong>AppendEntries 流程</strong>：</p>
<ol>
<li>Leader 收到写入请求，分配递增的 Index</li>
<li>Leader 向所有 Follower 发送 AppendEntriesRequest</li>
<li>Follower 写入本地日志，返回 ACK</li>
<li>Leader 收到多数派 ACK 后，提交（commit）该 Entry</li>
<li>Leader 返回 Producer 成功</li>
</ol>
<p><strong>源码关键路径</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// DLedgerEntryPusher.java（Leader 端）</span>
<span class="hljs-keyword">public</span> CompletableFuture&lt;AppendEntryResponse&gt; <span class="hljs-title function_">handleAppend</span><span class="hljs-params">(DLedgerEntry entry)</span> {
    <span class="hljs-comment">// 写入本地日志</span>
    dLedgerStore.appendAsLeader(entry);
    
    <span class="hljs-comment">// 向所有 Follower 推送</span>
    List&lt;CompletableFuture&lt;PushEntryResponse&gt;&gt; futures = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">for</span> (String peerId : peerMap.keySet()) {
        futures.add(pushToFollower(peerId, entry));
    }
    
    <span class="hljs-comment">// 等待多数派 ACK</span>
    <span class="hljs-keyword">return</span> CompletableFuture.allOf(futures.toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CompletableFuture</span>[<span class="hljs-number">0</span>]))
        .thenApply(v -&gt; {
            <span class="hljs-type">int</span> <span class="hljs-variable">ackCount</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) futures.stream().filter(f -&gt; f.join().isSuccess()).count();
            <span class="hljs-keyword">if</span> (ackCount &gt;= quorum) {  <span class="hljs-comment">// quorum = (n + 1) / 2</span>
                dLedgerStore.updateCommittedIndex(entry.getIndex());
                <span class="hljs-keyword">return</span> AppendEntryResponse.success();
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> AppendEntryResponse.fail();
            }
        });
}
</code></pre>
<p><strong>日志对齐</strong>：</p>
<p>Follower 接收到 AppendEntries 后，会检查 prevIndex 是否匹配：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// DLedgerStore.java（Follower 端）</span>
<span class="hljs-keyword">public</span> AppendEntryResponse <span class="hljs-title function_">appendAsFollower</span><span class="hljs-params">(DLedgerEntry entry, <span class="hljs-type">long</span> prevIndex, <span class="hljs-type">long</span> prevTerm)</span> {
    <span class="hljs-type">DLedgerEntry</span> <span class="hljs-variable">localPrev</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.get(prevIndex);
    
    <span class="hljs-keyword">if</span> (localPrev == <span class="hljs-literal">null</span> || localPrev.getTerm() != prevTerm) {
        <span class="hljs-comment">// 日志不连续或 term 不匹配，拒绝</span>
        <span class="hljs-keyword">return</span> AppendEntryResponse.inconsistent();
    }
    
    <span class="hljs-comment">// 写入日志</span>
    <span class="hljs-built_in">this</span>.appendData(entry);
    <span class="hljs-keyword">return</span> AppendEntryResponse.success();
}
</code></pre>
<p>如果日志不连续，Leader 会回退 prevIndex 重新发送，直到找到一致点。</p>
<h4 data-id="heading-23">acks 参数与 min.insync.replicas</h4>
<p>Kafka 的 <code>acks</code> 参数决定了 Producer 对"写入成功"的定义。</p>
<p><strong>acks=0</strong>：</p>
<ul>
<li>Producer 发完就返回，不等任何确认</li>
<li>性能最高，但网络丢包、Broker 崩溃都会丢消息</li>
<li>适合日志采集、监控数据等"丢几条无所谓"的场景</li>
</ul>
<p><strong>acks=1</strong>：</p>
<ul>
<li>Leader 写入成功就返回</li>
<li>如果 Leader 写入后立刻宕机、数据还没复制到 Follower，会丢消息</li>
<li>性能和可靠性的折中方案</li>
</ul>
<p><strong>acks=all（-1）</strong>：</p>
<ul>
<li>所有 ISR 副本都写入成功才返回</li>
<li>配合 <code>min.insync.replicas &gt;= 2</code>，保证至少两个副本有数据</li>
<li>可靠性最高，但性能会降低</li>
</ul>
<p><strong>min.insync.replicas 的作用</strong>：</p>
<p>即使 <code>acks=all</code>，如果 ISR 只剩 1 个（Leader），写入仍然会成功。为了防止这种情况，设置 <code>min.insync.replicas=2</code>：</p>
<pre><code class="hljs language-properties" lang="properties"># Topic 级别配置
min.insync.replicas=2
</code></pre>
<p>如果 ISR 少于 2 个，Producer 写入会失败（抛出 <code>NotEnoughReplicasException</code>），倒逼运维修复副本。</p>
<p><strong>实战踩坑</strong>：</p>
<p>某公司配置了 <code>acks=all + min.insync.replicas=2</code>，但在滚动升级时，ISR 只剩 1 个，导致写入全部失败。</p>
<p>解决办法：</p>
<ul>
<li>升级前检查所有 Partition 的 ISR 数量</li>
<li>升级时限速，避免大量 Partition 同时迁移</li>
<li>必要时临时调低 <code>min.insync.replicas</code>（但要评估风险）</li>
</ul>
<h4 data-id="heading-24">Leader Epoch：防止数据截断</h4>
<p>前面讲了 Leader Epoch 的原理，这里补充实际场景下的效果。</p>
<p><strong>场景重现</strong>（旧版本，无 Leader Epoch）：</p>
<pre><code class="hljs language-ini" lang="ini">时间线：
T1: Leader A (<span class="hljs-attr">LEO</span>=<span class="hljs-number">105</span>, HW=<span class="hljs-number">100</span>), Follower B (LEO=<span class="hljs-number">105</span>, HW=<span class="hljs-number">100</span>)
T2: A 写入 106~110，<span class="hljs-attr">LEO</span>=<span class="hljs-number">111</span>，HW 还是 <span class="hljs-number">100</span>（需等 B 拉取）
T3: A 宕机
T4: B 当选 Leader，但 B 的 <span class="hljs-attr">HW</span>=<span class="hljs-number">100</span>，截断到 <span class="hljs-number">100</span>
T5: A 恢复，从 B 同步，也截断到 100
T6: 数据 101~110 永久丢失
</code></pre>
<p><strong>引入 Leader Epoch 后</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">T1: <span class="hljs-attr">Epoch</span>=<span class="hljs-number">5</span>, Leader A (LEO=<span class="hljs-number">105</span>)
T2: A 写入 106~110，<span class="hljs-attr">LEO</span>=<span class="hljs-number">111</span>
T3: A 宕机，Epoch 递增为 6
T4: B 当选 Leader (<span class="hljs-attr">Epoch</span>=<span class="hljs-number">6</span>, LEO=<span class="hljs-number">105</span>)
T5: A 恢复，查询 Epoch 6 的起始 Offset，得知是 105
T6: A 截断到 105（而不是盲目截断到 HW），保留了 100~105 的数据
</code></pre>
<p>虽然 106~110 仍然没有被复制到 B，但至少避免了"B 截断后 A 也跟着截断"的问题。</p>
<p><strong>配置</strong>：</p>
<p>Leader Epoch 从 2.5+ 默认开启，不需要额外配置。可以通过 <code>kafka-log-dirs.sh</code> 查看 <code>.snapshot</code> 文件：</p>
<pre><code class="hljs language-bash" lang="bash">kafka-log-dirs.sh --bootstrap-server localhost:9092 \
  --describe --topic my-topic
</code></pre>
<h4 data-id="heading-25">RocketMQ：同步刷盘 + 同步复制的组合</h4>
<p>RocketMQ 提供了"刷盘"和"复制"两个维度的配置，组合起来有四种可靠性等级。</p>








































<table><thead><tr><th>刷盘</th><th>复制</th><th>可靠性</th><th>性能</th><th>适用场景</th></tr></thead><tbody><tr><td>异步</td><td>异步</td><td>较低</td><td>最高</td><td>日志、监控</td></tr><tr><td>异步</td><td>同步</td><td>中等</td><td>中等</td><td>一般业务</td></tr><tr><td>同步</td><td>异步</td><td>中等</td><td>中等</td><td>需要单机可靠</td></tr><tr><td>同步</td><td>同步</td><td>最高</td><td>较低</td><td>金融、支付</td></tr></tbody></table>
<p><strong>源码实现</strong>（同步刷盘）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// CommitLog.java</span>
<span class="hljs-keyword">public</span> PutMessageResult <span class="hljs-title function_">putMessage</span><span class="hljs-params">(MessageExtBrokerInner msg)</span> {
    <span class="hljs-comment">// 写入 MappedFile</span>
    <span class="hljs-type">AppendMessageResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> mappedFile.appendMessage(msg);
    
    <span class="hljs-comment">// 同步刷盘</span>
    <span class="hljs-keyword">if</span> (FlushDiskType.SYNC_FLUSH == flushDiskType) {
        <span class="hljs-type">GroupCommitService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.groupCommitService;
        service.putRequest(<span class="hljs-keyword">new</span> <span class="hljs-title class_">GroupCommitRequest</span>(result.getWroteOffset() + result.getWroteBytes()));
        
        CompletableFuture&lt;FlushStatus&gt; flushFuture = service.waitForFlush(syncFlushTimeout);
        <span class="hljs-type">FlushStatus</span> <span class="hljs-variable">flushStatus</span> <span class="hljs-operator">=</span> flushFuture.get();
        
        <span class="hljs-keyword">if</span> (flushStatus != FlushStatus.FLUSH_OK) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PutMessageResult</span>(PutMessageStatus.FLUSH_DISK_TIMEOUT, result);
        }
    }
    
    <span class="hljs-comment">// 同步复制</span>
    <span class="hljs-keyword">if</span> (BrokerRole.SYNC_MASTER == brokerRole) {
        <span class="hljs-type">HAService</span> <span class="hljs-variable">ha</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.haService;
        <span class="hljs-keyword">if</span> (!ha.isSlaveOK(result.getWroteOffset() + result.getWroteBytes())) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PutMessageResult</span>(PutMessageStatus.SLAVE_NOT_AVAILABLE, result);
        }
        
        CompletableFuture&lt;PutMessageStatus&gt; replicaFuture = 
            ha.waitForSlave(result.getWroteOffset() + result.getWroteBytes(), syncFlushTimeout);
        <span class="hljs-type">PutMessageStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> replicaFuture.get();
        
        <span class="hljs-keyword">if</span> (status != PutMessageStatus.PUT_OK) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PutMessageResult</span>(PutMessageStatus.FLUSH_SLAVE_TIMEOUT, result);
        }
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PutMessageResult</span>(PutMessageStatus.PUT_OK, result);
}
</code></pre>
<p>关键点：</p>
<ul>
<li>同步刷盘和同步复制都是阻塞等待的（通过 CountDownLatch 或 CompletableFuture）</li>
<li>超时时间默认 5 秒（<code>syncFlushTimeout</code>），可调整</li>
<li>如果超时，返回失败状态，Producer 需要重试</li>
</ul>
<p><strong>DLedger 的日志提交</strong>：</p>
<p>DLedger 模式下，写入流程变为：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// DLedgerCommitLog.java</span>
<span class="hljs-keyword">public</span> CompletableFuture&lt;PutMessageResult&gt; <span class="hljs-title function_">asyncPutMessage</span><span class="hljs-params">(MessageExtBrokerInner msg)</span> {
    <span class="hljs-comment">// 构造 DLedger Entry</span>
    <span class="hljs-type">DLedgerEntry</span> <span class="hljs-variable">entry</span> <span class="hljs-operator">=</span> encodeToDLedgerEntry(msg);
    
    <span class="hljs-comment">// Append 到 DLedger（自动触发 Raft 复制）</span>
    <span class="hljs-keyword">return</span> dLedgerServer.appendAsLeader(entry)
        .thenApply(response -&gt; {
            <span class="hljs-keyword">if</span> (response.getCode() == DLedgerResponseCode.SUCCESS) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PutMessageResult</span>(PutMessageStatus.PUT_OK, ...);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PutMessageResult</span>(PutMessageStatus.SERVICE_NOT_AVAILABLE, ...);
            }
        });
}
</code></pre>
<p>DLedger 内部会处理 Raft 复制、多数派确认、日志对齐等逻辑，业务侧只需要配置副本数量和超时时间。</p>
<hr/>
<h3 data-id="heading-26">3.4 消息重复与幂等性</h3>
<p>高可用 = 重试 + 多副本，重复消息不可避免。Kafka 和 RocketMQ 都提供了一些手段减少重复，但端到端的幂等还是要业务自己保证。</p>
<h4 data-id="heading-27">Kafka：幂等 Producer + 事务消息</h4>
<h5 data-id="heading-28">幂等 Producer（PID + Sequence Number）</h5>
<p>Kafka 0.11+ 引入了幂等 Producer，解决"网络重传导致重复"的问题。</p>
<p><strong>开启方式</strong>：</p>
<pre><code class="hljs language-properties" lang="properties"># Producer 配置
enable.idempotence=true
</code></pre>
<p>开启后，Producer 会被分配一个唯一的 PID（Producer ID），每条消息带上递增的 Sequence Number。Broker 端会缓存最近的 Sequence，重复消息会被直接丢弃。</p>
<p><strong>源码逻辑</strong>（Broker 端）：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// Partition.scala</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">checkDuplicates</span></span>(producerId: <span class="hljs-type">Long</span>, sequence: <span class="hljs-type">Int</span>): <span class="hljs-type">Boolean</span> = {
  <span class="hljs-keyword">val</span> lastSeq = producerStateManager.lastSequence(producerId)
  
  <span class="hljs-keyword">if</span> (sequence &lt;= lastSeq) {
    <span class="hljs-comment">// 重复消息，返回成功但不写入</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  }
  
  <span class="hljs-keyword">if</span> (sequence != lastSeq + <span class="hljs-number">1</span>) {
    <span class="hljs-comment">// 序号不连续，说明有消息丢失，报错</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">OutOfOrderSequenceException</span>(...)
  }
  
  producerStateManager.updateSequence(producerId, sequence)
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}
</code></pre>
<p><strong>限制</strong>：</p>
<ul>
<li>只能保证单个 Producer 实例、单个 Partition 的幂等</li>
<li>跨 Partition 或多个 Producer 实例不保证</li>
<li>Producer 重启后 PID 会变，无法跨会话去重</li>
</ul>
<h5 data-id="heading-29">事务消息（Transactional Producer）</h5>
<p>Kafka 的事务消息通过两阶段提交（2PC）实现 Exactly Once。</p>
<p><strong>使用方式</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();
props.put(<span class="hljs-string">"transactional.id"</span>, <span class="hljs-string">"my-transactional-id"</span>);
props.put(<span class="hljs-string">"enable.idempotence"</span>, <span class="hljs-string">"true"</span>);

KafkaProducer&lt;String, String&gt; producer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">KafkaProducer</span>&lt;&gt;(props);

producer.initTransactions();

<span class="hljs-keyword">try</span> {
    producer.beginTransaction();
    producer.send(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProducerRecord</span>&lt;&gt;(<span class="hljs-string">"topic1"</span>, <span class="hljs-string">"msg1"</span>));
    producer.send(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProducerRecord</span>&lt;&gt;(<span class="hljs-string">"topic2"</span>, <span class="hljs-string">"msg2"</span>));
    producer.commitTransaction();
} <span class="hljs-keyword">catch</span> (Exception e) {
    producer.abortTransaction();
}
</code></pre>
<p><strong>事务协调器（Transaction Coordinator）</strong>：</p>
<p>Kafka 内部有个 <code>__transaction_state</code> Topic，存储事务状态：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">TransactionId</span> <span class="hljs-string">-&gt;</span> {
  <span class="hljs-attr">producerId:</span> <span class="hljs-number">12345</span>,
  <span class="hljs-attr">producerEpoch:</span> <span class="hljs-number">0</span>,
  <span class="hljs-attr">state:</span> <span class="hljs-string">Ongoing</span> <span class="hljs-string">|</span> <span class="hljs-string">PrepareCommit</span> <span class="hljs-string">|</span> <span class="hljs-string">PrepareAbort</span> <span class="hljs-string">|</span> <span class="hljs-string">CompleteCommit</span> <span class="hljs-string">|</span> <span class="hljs-string">CompleteAbort</span>,
  <span class="hljs-attr">partitions:</span> [<span class="hljs-string">topic1-0</span>, <span class="hljs-string">topic2-1</span>],
  <span class="hljs-attr">txnStartTimestamp:</span> <span class="hljs-number">1700000000</span>
}
</code></pre>
<p><strong>2PC 流程</strong>：</p>
<ol>
<li><strong>Begin</strong>：Producer 向 Coordinator 注册事务</li>
<li><strong>Prepare</strong>：Producer 发送消息到各个 Partition，但标记为"事务中"</li>
<li><strong>Commit</strong>：Producer 调用 <code>commitTransaction()</code>，Coordinator 写入 <code>PrepareCommit</code> 状态</li>
<li><strong>Complete</strong>：Coordinator 向所有 Partition 发送 <code>WriteTxnMarker</code>，标记事务完成</li>
<li><strong>Cleanup</strong>：清理事务状态</li>
</ol>
<p><strong>Consumer 端</strong>：</p>
<p>Consumer 需要配置 <code>isolation.level=read_committed</code>，这样只会读到已提交的事务消息。</p>
<p><strong>性能影响</strong>：</p>
<p>事务消息的性能会下降 20~30%，因为：</p>
<ul>
<li>需要写入事务状态到 <code>__transaction_state</code></li>
<li>需要等待所有 Partition 确认</li>
<li>Consumer 需要过滤未提交的消息</li>
</ul>
<h4 data-id="heading-30">RocketMQ：半消息 + 本地事务 + 回查</h4>
<p>RocketMQ 的事务消息走另一条路：先发半消息（对 Consumer 不可见），业务执行本地事务，再决定提交还是回滚。</p>
<p><strong>流程</strong>：</p>
<ol>
<li><strong>发送半消息</strong>：Producer 调用 <code>sendMessageInTransaction()</code>，Broker 写入半消息到特殊 Topic <code>RMQ_SYS_TRANS_HALF_TOPIC</code></li>
<li><strong>执行本地事务</strong>：Producer 执行本地事务逻辑（如扣减库存、更新订单）</li>
<li><strong>提交/回滚</strong>：根据本地事务结果，Producer 告诉 Broker 提交或回滚</li>
<li><strong>Broker 处理</strong>：提交则把半消息移到正常 Topic，回滚则删除半消息</li>
<li><strong>回查</strong>：如果 Broker 长时间没收到结果，会回查 Producer 本地事务状态</li>
</ol>
<p><strong>源码实现</strong>（发送半消息）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TransactionalMessageBridge.java</span>
<span class="hljs-keyword">public</span> PutMessageResult <span class="hljs-title function_">putHalfMessage</span><span class="hljs-params">(MessageExtBrokerInner msgInner)</span> {
    <span class="hljs-comment">// 改写 Topic 为半消息 Topic</span>
    msgInner.setTopic(TransactionalMessageUtil.buildHalfTopic());
    msgInner.setQueueId(<span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 写入 CommitLog</span>
    <span class="hljs-keyword">return</span> commitLog.putMessage(msgInner);
}
</code></pre>
<p><strong>回查机制</strong>：</p>
<p>Broker 有个定时任务 <code>TransactionalMessageCheckService</code>，每分钟扫一次半消息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TransactionalMessageCheckService.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">check</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 从半消息 Topic 拉取消息</span>
    List&lt;MessageExt&gt; halfMessages = pullHalfMessages();
    
    <span class="hljs-keyword">for</span> (MessageExt msg : halfMessages) {
        <span class="hljs-keyword">if</span> (System.currentTimeMillis() - msg.getStoreTimestamp() &gt; checkImmunityTime) {
            <span class="hljs-comment">// 超时未收到提交/回滚，回查 Producer</span>
            checkProducer(msg);
        }
    }
}
</code></pre>
<p>回查最多 15 次（可配置），超过次数会移到死信队列。</p>
<p><strong>对比</strong>：</p>






























<table><thead><tr><th>特性</th><th>Kafka 事务</th><th>RocketMQ 事务</th></tr></thead><tbody><tr><td>实现方式</td><td>2PC + 事务协调器</td><td>半消息 + 回查</td></tr><tr><td>适用场景</td><td>多 Topic 原子写入</td><td>本地事务 + 消息发送</td></tr><tr><td>性能影响</td><td>20~30%</td><td>15~20%</td></tr><tr><td>运维复杂度</td><td>中等</td><td>较低</td></tr></tbody></table>
<p>Kafka 的事务更适合 Kafka Streams 这种"读一个 Topic、写多个 Topic"的场景；RocketMQ 的事务更适合"扣库存 + 发消息"这种业务场景。</p>
<h4 data-id="heading-31">业务侧幂等的典型做法</h4>
<p>无论用哪种 MQ，业务侧的幂等是逃不掉的。几个常见手段：</p>
<ol>
<li><strong>数据库唯一索引</strong>：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `order_message` (
  `msg_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">PRIMARY</span> KEY,
  `order_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">32</span>),
  `status` tinyint,
  `create_time` datetime,
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_msg_id` (`msg_id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB;
</code></pre>
<p>插入时如果 <code>msg_id</code> 重复，会报 DuplicateKeyException，业务直接忽略即可。</p>
<ol start="2">
<li><strong>Redis SET</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">"msg:processed:"</span> + msgId;
<span class="hljs-keyword">if</span> (redis.setnx(key, <span class="hljs-string">"1"</span>, <span class="hljs-number">3600</span>)) {
    <span class="hljs-comment">// 第一次处理</span>
    processBusiness(msg);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 重复消息，跳过</span>
    log.warn(<span class="hljs-string">"Duplicate message: {}"</span>, msgId);
}
</code></pre>
<ol start="3">
<li><strong>状态机 + 乐观锁</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查询当前状态</span>
<span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectById(orderId);

<span class="hljs-keyword">if</span> (order.getStatus() != UNPAID) {
    <span class="hljs-comment">// 已处理过，跳过</span>
    <span class="hljs-keyword">return</span>;
}

<span class="hljs-comment">// 更新状态，带版本号</span>
<span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> orderMapper.updateStatus(orderId, PAID, order.getVersion());
<span class="hljs-keyword">if</span> (rows == <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 并发冲突，重试或放弃</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentModificationException</span>();
}
</code></pre>
<p>实战经验：</p>
<ul>
<li>幂等键要选对，订单号、支付流水号等天然唯一的业务主键最靠谱。</li>
<li>Redis 去重要设置过期时间，防止内存爆炸。</li>
<li>状态机设计要严谨，避免出现"不可逆状态"的逻辑漏洞。</li>
</ul>
<hr/>
<h3 data-id="heading-32">3.5 容灾与备份</h3>
<p>单机房的高可用只能防"机器挂""程序挂"，防不了"机房断电""网络割接"。跨机房容灾是更高层次的可用性保障。</p>
<h4 data-id="heading-33">Kafka 的跨机房方案</h4>
<h5 data-id="heading-34">MirrorMaker 2.0</h5>
<p>MirrorMaker 是 Kafka 官方的跨集群复制工具。2.0 版本重写了架构，支持双向同步、Topic 白名单、ACL 同步等功能。</p>
<p><strong>工作原理</strong>：</p>
<p>MirrorMaker 本质上是"消费源集群 + 写入目标集群"的桥接器。</p>
<pre><code class="hljs language-css" lang="css">Source Cluster (<span class="hljs-selector-tag">A</span> 机房)
    ↓ Consumer
MirrorMaker
    ↓ Producer
Target Cluster (<span class="hljs-selector-tag">B</span> 机房)
</code></pre>
<p><strong>配置示例</strong>：</p>
<pre><code class="hljs language-properties" lang="properties"># 源集群
source.bootstrap.servers=kafka-a:9092
source.cluster.alias=cluster-a

# 目标集群
target.bootstrap.servers=kafka-b:9092
target.cluster.alias=cluster-b

# Topic 白名单
topics=order.*, payment.*
topics.blacklist=test.*

# 同步配置
sync.topic.configs.enabled=true
sync.topic.acls.enabled=true
</code></pre>
<p><strong>双向同步</strong>：</p>
<p>如果需要双活，可以部署两个 MirrorMaker，A→B 和 B→A 同时跑。但要注意：</p>
<ul>
<li>消息可能循环复制（A 写的消息被复制到 B，B 又复制回 A）</li>
<li>需要在消息头里加标记，防止死循环</li>
</ul>
<p><strong>性能调优</strong>：</p>
<ul>
<li><code>tasks.max</code>：MirrorMaker 的并行度，建议设置为源集群 Partition 数的 1~2 倍</li>
<li><code>offset.lag.max</code>：复制延迟阈值，超过会触发告警</li>
<li><code>replication.factor</code>：目标集群的副本数，建议与源集群一致</li>
</ul>
<h5 data-id="heading-35">Cluster Linking（Confluent 商用特性）</h5>
<p>Confluent Platform 提供的 Cluster Linking 功能更强：</p>
<ul>
<li>支持实时双向同步</li>
<li>支持 Schema Registry 同步</li>
<li>支持细粒度的流控和限速</li>
</ul>
<p>但这是商用版，开源版用不了。</p>
<h4 data-id="heading-36">RocketMQ 的跨机房方案</h4>
<h5 data-id="heading-37">同城双活：双集群 + 双写</h5>
<p>常见做法是部署两套 RocketMQ 集群，业务双写：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Producer 双写</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(Message msg)</span> {
    <span class="hljs-keyword">try</span> {
        producerA.send(msg);  <span class="hljs-comment">// 写 A 机房</span>
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"Send to cluster A failed"</span>, e);
    }
    
    <span class="hljs-keyword">try</span> {
        producerB.send(msg);  <span class="hljs-comment">// 写 B 机房</span>
    } <span class="hljs-keyword">catch</span> (Exception e) {
        log.error(<span class="hljs-string">"Send to cluster B failed"</span>, e);
    }
}
</code></pre>
<p>问题：</p>
<ul>
<li>双写会增加延迟</li>
<li>两个集群的 Offset 不一致，Consumer 切换时需要重新定位</li>
</ul>
<p>优化方案：</p>
<ul>
<li>异步双写：先写主集群，成功后异步写备集群</li>
<li>消息轨迹：通过消息 ID 关联两侧的消息，方便排查</li>
</ul>
<h5 data-id="heading-38">DLedger 跨机房</h5>
<p>如果网络延迟 &lt; 5ms（同城专线），可以用 DLedger 把副本分布到不同机房：</p>
<pre><code class="hljs language-properties" lang="properties"># DLedger 配置
dLedgerPeers=n0-192.168.1.10:40911;n1-192.168.2.10:40911;n2-192.168.3.10:40911
</code></pre>
<p><code>n0</code> 在 A 机房，<code>n1</code> 在 B 机房，<code>n2</code> 在 C 机房。任意机房故障，剩余两个机房仍能达成多数派。</p>
<p><strong>注意事项</strong>：</p>
<ul>
<li>跨机房延迟会影响 Raft 选举和日志复制，RTT &gt; 10ms 不建议用这种方案</li>
<li>网络抖动可能导致频繁选举，需要调整 <code>heartBeatTimeIntervalMs</code>（默认 1000ms）</li>
</ul>
<h5 data-id="heading-39">消息备份与恢复</h5>
<p>RocketMQ 的 CommitLog 是独立文件，可以直接拷贝到对象存储做备份：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 定时备份脚本</span>
rsync -avz /data/rocketmq/store/commitlog/ \
  s3://backup-bucket/commitlog/$(<span class="hljs-built_in">date</span> +%Y%m%d)/
</code></pre>
<p>恢复时：</p>
<ol>
<li>拷贝 CommitLog 文件到新 Broker</li>
<li>启动 Broker，自动重建 ConsumeQueue</li>
<li>验证消息可消费</li>
</ol>
<p>这个方案的好处是简单粗暴，适合"定期全量备份"。缺点是恢复时间长（需要重建索引）。</p>
<h4 data-id="heading-40">容灾演练的关键动作</h4>
<p>容灾方案写得再漂亮，不演练都是纸面文章。几个必做的演练项：</p>
<ol>
<li>
<p><strong>机房断电演练</strong>：</p>
<ul>
<li>强制关闭一个机房的所有 Broker</li>
<li>验证另一侧集群能否自动接管流量</li>
<li>验证数据是否丢失</li>
</ul>
</li>
<li>
<p><strong>网络隔离演练</strong>：</p>
<ul>
<li>用 iptables 模拟机房之间网络中断</li>
<li>验证 Raft 或主从复制的表现</li>
<li>验证 Producer/Consumer 的切换逻辑</li>
</ul>
</li>
<li>
<p><strong>全量切流演练</strong>：</p>
<ul>
<li>把所有 Producer/Consumer 从 A 集群切到 B 集群</li>
<li>验证切换时间、消息丢失、重复消费等</li>
<li>验证回滚方案是否可用</li>
</ul>
</li>
</ol>
<p>演练后一定要复盘：</p>
<ul>
<li>实际恢复时间 vs 预期时间</li>
<li>哪些步骤卡住了</li>
<li>监控告警是否及时</li>
<li>有没有遗漏的检查项</li>
</ul>
<hr/>
<h3 data-id="heading-41">总结</h3>
<p>高可用是个系统工程，涉及架构、配置、监控、流程等多个层面。Kafka 和 RocketMQ 各有优势：</p>
<p><strong>Kafka</strong>：</p>
<ul>
<li>去中心化 + ISR 机制，适合高吞吐、动态扩容的场景</li>
<li>KRaft 模式大幅提升故障感知速度和元数据性能</li>
<li>事务消息适合流处理，但业务应用需要仔细设计</li>
</ul>
<p><strong>RocketMQ</strong>：</p>
<ul>
<li>主备明确 + 刷盘/复制组合，适合对一致性要求高的业务</li>
<li>DLedger 实现自动切换，降低运维成本</li>
<li>事务消息适合"本地事务 + 消息发送"的场景</li>
</ul>
<p><strong>落地建议</strong>：</p>
<ol>
<li><strong>架构选型</strong>：根据业务特点选择合适的副本模型和一致性策略</li>
<li><strong>参数调优</strong>：<code>acks</code>、<code>min.insync.replicas</code>、<code>replica.lag.time.max.ms</code>、<code>heartbeatBrokerInterval</code> 等要结合网络质量调整</li>
<li><strong>监控告警</strong>：分层监控（基础/服务/业务），告警分级（P0/P1/P2）</li>
<li><strong>容灾演练</strong>：定期演练，复盘改进，直到"一键切换"</li>
</ol>
<p>高可用没有捷径，只有把这些基础打牢，才能在故障来临时从容应对。
``</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RocketMQ vs Kafka04 - 高性能设计与调优]]></title>    <link>https://juejin.cn/post/7572566115848962098</link>    <guid>https://juejin.cn/post/7572566115848962098</guid>    <pubDate>2025-11-15T13:22:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572566115848962098" data-draft-id="7572566115848945714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RocketMQ vs Kafka04 - 高性能设计与调优"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-15T13:22:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="张小黑12"/> <meta itemprop="url" content="https://juejin.cn/user/985627390911096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RocketMQ vs Kafka04 - 高性能设计与调优
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/985627390911096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    张小黑12
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T13:22:53.000Z" title="Sat Nov 15 2025 13:22:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第四篇：高性能设计与调优</h2>
<blockquote>
<p>性能调优这事儿，七分靠设计，三分靠参数。Kafka 和 RocketMQ 都把"顺序写 + 批处理 + 零拷贝"写在了骨子里，但真正拉开差距的，是网络模型、内存管理、线程调度这些细节。本文会从源码级别剖析两者的性能设计，同时给出真实压测数据和调优经验，帮你绕过那些"看起来有用、实际没用"的优化手段。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">4.1 高性能设计原则</h3>
<p>先说结论：Kafka 和 RocketMQ 的性能都很强，单机 TPS 都能跑到百万级。差异主要在：</p>
<ul>
<li><strong>Kafka</strong>：更依赖 Page Cache，读写都追求"内存速度"；批处理粒度更大（Producer 端 batch）</li>
<li><strong>RocketMQ</strong>：更依赖堆外内存，写入链路短（CommitLog 一把梭）；读取有"两跳"（ConsumeQueue → CommitLog）</li>
</ul>
<p>但无论哪个，底层都遵循几条铁律：</p>
<ol>
<li><strong>顺序写 &gt; 随机写</strong>：磁盘顺序写能跑到 500MB/s+，随机写只有几十 MB/s</li>
<li><strong>批量 &gt; 单条</strong>：网络/磁盘的开销都在"系统调用"，批量能把单次开销摊薄</li>
<li><strong>零拷贝 &gt; 多次拷贝</strong>：sendfile、mmap 能减少数据在内核态/用户态之间的搬运</li>
</ol>
<p>下面分模块拆开讲。</p>
<h4 data-id="heading-2">Kafka 的性能技巧</h4>
<h5 data-id="heading-3">顺序写 + Page Cache</h5>
<p>Kafka 的 Segment 是 append-only 的，所有写入都是追加。磁盘顺序写的性能接近内存：</p>
<ul>
<li>机械盘（HDD）：100~150 MB/s</li>
<li>SATA SSD：500~600 MB/s</li>
<li>NVMe SSD：2000~3000 MB/s</li>
</ul>
<p>Kafka 默认不主动刷盘（<code>log.flush.interval.messages=Long.MaxValue</code>），把 flush 交给 OS：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// LogSegment.scala</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">append</span></span>(records: <span class="hljs-type">MemoryRecords</span>): <span class="hljs-type">Unit</span> = {
  <span class="hljs-keyword">val</span> written = fileChannel.write(records.buffer, fileSize)
  fileSize += written
  <span class="hljs-comment">// 不调用 force()，让 OS 决定刷盘时机</span>
}
</code></pre>
<p>这个策略的好处是性能高，代价是单机宕机可能丢数据。Kafka 通过 <code>acks=all</code> + 多副本来弥补这个风险。</p>
<p><strong>Page Cache 优化</strong>：</p>
<p>Page Cache 是 Kafka 性能的"放大器"。如果 Cache 命中率高，读写都是内存速度；如果命中率低，性能会断崖式下跌。</p>
<p>几个影响 Page Cache 的因素：</p>
<ol>
<li><strong>内存大小</strong>：Page Cache = 总内存 - JVM 堆 - OS 保留。一般留 70% 以上给 Page Cache。</li>
<li><strong>读写模式</strong>：顺序读写的命中率远高于随机读写。</li>
<li><strong>其他进程</strong>：同机器的其他进程（如 Hadoop、MySQL）会抢 Page Cache。</li>
</ol>
<p>查看 Page Cache 命中率：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 Kafka 进程的 Page Cache 使用</span>
sudo pcstat /var/kafka-logs/topic-*/00000000000000000000.<span class="hljs-built_in">log</span>

<span class="hljs-comment"># 输出示例</span>
|-------------------------------------------+----------------+------------+-----------+---------|
| Name                                      | Size           | Pages      | Cached    | Percent |
|-------------------------------------------+----------------+------------+-----------+---------|
| 00000000000000000000.<span class="hljs-built_in">log</span>                  | 1073741824     | 262144     | 261000    | 99.56%  |
|-------------------------------------------+----------------+------------+-----------+---------|
</code></pre>
<p>如果 Cached Percent &lt; 90%，说明 Page Cache 不够，考虑加内存或减少数据保留时间。</p>
<h5 data-id="heading-4">Zero-Copy（sendfile + mmap）</h5>
<p>Kafka 在读取时用 sendfile 系统调用，避免数据在内核态/用户态之间拷贝。</p>
<p><strong>传统方式</strong>（4 次拷贝）：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 磁盘 → 内核缓冲区（DMA）
<span class="hljs-bullet">2.</span> 内核缓冲区 → 用户缓冲区（read）
<span class="hljs-bullet">3.</span> 用户缓冲区 → Socket 缓冲区（write）
<span class="hljs-bullet">4.</span> Socket 缓冲区 → 网卡（DMA）
</code></pre>
<p><strong>sendfile 方式</strong>（2 次拷贝）：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 磁盘 → 内核缓冲区（DMA）
<span class="hljs-bullet">2.</span> 内核缓冲区 → 网卡（sendfile + DMA）
</code></pre>
<p>源码在 <code>FileRecords.java</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">writeTo</span><span class="hljs-params">(GatheringByteChannel channel, <span class="hljs-type">long</span> position, <span class="hljs-type">int</span> length)</span> {
    <span class="hljs-keyword">if</span> (channel <span class="hljs-keyword">instanceof</span> TransportLayer) {
        <span class="hljs-comment">// 使用 sendfile</span>
        <span class="hljs-keyword">return</span> transferTo(position, length, channel);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 回退到普通写入</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.writeTo(channel, position, length);
    }
}

<span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-title function_">transferTo</span><span class="hljs-params">(<span class="hljs-type">long</span> position, <span class="hljs-type">int</span> count, GatheringByteChannel target)</span> {
    <span class="hljs-keyword">return</span> fileChannel.transferTo(position, count, target);
}
</code></pre>
<p><code>transferTo()</code> 底层会调用 Linux 的 <code>sendfile64()</code> 系统调用。</p>
<h5 data-id="heading-5">批量处理</h5>
<p>Kafka 的批量处理贯穿整个链路：</p>
<p><strong>Producer 端</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// KafkaProducer.java</span>
<span class="hljs-keyword">private</span> Future&lt;RecordMetadata&gt; <span class="hljs-title function_">doSend</span><span class="hljs-params">(ProducerRecord&lt;K, V&gt; record, Callback callback)</span> {
    <span class="hljs-comment">// 消息先进 RecordAccumulator 缓冲区</span>
    RecordAccumulator.<span class="hljs-type">RecordAppendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> accumulator.append(
        tp, timestamp, serializedKey, serializedValue, headers, 
        interceptCallback, remainingWaitMs, <span class="hljs-literal">true</span>);
    
    <span class="hljs-comment">// 满足以下条件之一就发送：</span>
    <span class="hljs-comment">// 1. batch 满了（batch.size，默认 16KB）</span>
    <span class="hljs-comment">// 2. 等待超时（linger.ms，默认 0）</span>
    <span class="hljs-comment">// 3. 缓冲区满了（buffer.memory，默认 32MB）</span>
    <span class="hljs-keyword">if</span> (result.batchIsFull || result.newBatchCreated) {
        sender.wakeup();
    }
}
</code></pre>
<p><strong>Consumer 端</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Fetcher.java</span>
<span class="hljs-keyword">private</span> Map&lt;TopicPartition, List&lt;ConsumerRecord&lt;K, V&gt;&gt;&gt; <span class="hljs-title function_">fetchRecords</span><span class="hljs-params">(<span class="hljs-type">int</span> maxRecords)</span> {
    <span class="hljs-comment">// 一次拉取多个 Partition 的数据</span>
    Map&lt;TopicPartition, FetchResponse.PartitionData&gt; fetchData = 
        fetchFromBroker(maxWaitMs, minBytes, maxBytes);
    
    <span class="hljs-comment">// 批量解析</span>
    <span class="hljs-keyword">return</span> parseFetchedData(fetchData, maxRecords);
}
</code></pre>
<p><strong>Broker 端</strong>：</p>
<p>Broker 在处理 Produce/Fetch 请求时也是批量的：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-comment">// ReplicaManager.scala</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">appendRecords</span></span>(records: <span class="hljs-type">Map</span>[<span class="hljs-type">TopicPartition</span>, <span class="hljs-type">MemoryRecords</span>], 
                   requiredAcks: <span class="hljs-type">Int</span>): <span class="hljs-type">Map</span>[<span class="hljs-type">TopicPartition</span>, <span class="hljs-type">PartitionResponse</span>] = {
    <span class="hljs-comment">// 批量写入多个 Partition</span>
    <span class="hljs-keyword">val</span> produceResults = records.map { <span class="hljs-keyword">case</span> (tp, records) =&gt;
      <span class="hljs-keyword">val</span> partition = getPartition(tp)
      partition.appendRecordsToLeader(records, requiredAcks)
    }
    
    produceResults.toMap
}
</code></pre>
<p><strong>调优建议</strong>：</p>
<ul>
<li>Producer：<code>linger.ms=10~50</code>，让 batch 尽量大；但不要太大，否则延迟高</li>
<li>Consumer：<code>fetch.min.bytes=1MB</code>，等足够数据再返回；<code>max.poll.records=500</code>，单次拉多条</li>
<li>Broker：<code>num.io.threads</code> 要够，否则批量写入会排队</li>
</ul>
<h5 data-id="heading-6">压缩</h5>
<p>Kafka 支持多种压缩算法：Gzip、Snappy、LZ4、Zstd。</p>
<p><strong>压缩链路</strong>：</p>
<ol>
<li>Producer 端压缩（压缩整个 batch）</li>
<li>Broker 保持压缩状态存储（节省磁盘和网络）</li>
<li>Consumer 端解压</li>
</ol>
<p><strong>压缩比对比</strong>（1KB JSON 消息）：</p>








































<table><thead><tr><th>算法</th><th>压缩比</th><th>压缩耗时</th><th>解压耗时</th><th>适用场景</th></tr></thead><tbody><tr><td>Gzip</td><td>4:1</td><td>10ms</td><td>3ms</td><td>网络受限</td></tr><tr><td>Snappy</td><td>2.5:1</td><td>2ms</td><td>1ms</td><td>CPU 受限</td></tr><tr><td>LZ4</td><td>2.8:1</td><td>1.5ms</td><td>0.8ms</td><td>平衡</td></tr><tr><td>Zstd</td><td>3.5:1</td><td>5ms</td><td>2ms</td><td>磁盘受限</td></tr></tbody></table>
<p>实战中，LZ4 是首选：压缩比不错，速度快。如果网络是瓶颈（跨机房），可以用 Zstd。</p>
<h4 data-id="heading-7">RocketMQ 的性能技巧</h4>
<h5 data-id="heading-8">CommitLog 一把梭 + ConsumeQueue 异步</h5>
<p>RocketMQ 的写入路径非常短：</p>
<pre><code class="hljs language-markdown" lang="markdown">Producer → Broker → CommitLog → 返回成功
<span class="hljs-code">                      ↓ 异步
                  ConsumeQueue
</span></code></pre>
<p>所有 Topic 的消息都写同一个 CommitLog，磁盘磁头只需要在一个文件上顺序移动，IOPS 利用率拉满。</p>
<p><strong>源码</strong>（写入 CommitLog）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// CommitLog.java</span>
<span class="hljs-keyword">public</span> PutMessageResult <span class="hljs-title function_">putMessage</span><span class="hljs-params">(<span class="hljs-keyword">final</span> MessageExtBrokerInner msg)</span> {
    <span class="hljs-comment">// 获取当前 MappedFile</span>
    <span class="hljs-type">MappedFile</span> <span class="hljs-variable">mappedFile</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.mappedFileQueue.getLastMappedFile();
    
    <span class="hljs-comment">// 追加消息</span>
    <span class="hljs-type">AppendMessageResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> mappedFile.appendMessage(msg, <span class="hljs-built_in">this</span>.appendMessageCallback);
    
    <span class="hljs-comment">// 异步刷盘</span>
    <span class="hljs-keyword">if</span> (FlushDiskType.ASYNC_FLUSH == <span class="hljs-built_in">this</span>.defaultMessageStore.getMessageStoreConfig().getFlushDiskType()) {
        flushCommitLogService.wakeup();
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PutMessageResult</span>(PutMessageStatus.PUT_OK, result);
}
</code></pre>
<p><strong>异步构建 ConsumeQueue</strong>：</p>
<p><code>ReputMessageService</code> 线程监听 CommitLog 的更新，异步构建各个 Topic-Queue 的索引：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ReputMessageService.java（核心逻辑）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ReputMessageService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceThread</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-type">long</span> <span class="hljs-variable">reputFromOffset</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">while</span> (!<span class="hljs-built_in">this</span>.isStopped()) {
            <span class="hljs-comment">// 从 CommitLog 读取新消息</span>
            <span class="hljs-type">SelectMappedBufferResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> 
                DefaultMessageStore.<span class="hljs-built_in">this</span>.commitLog.getData(reputFromOffset);
            
            <span class="hljs-keyword">if</span> (result != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// 解析消息</span>
                    <span class="hljs-type">DispatchRequest</span> <span class="hljs-variable">dispatchRequest</span> <span class="hljs-operator">=</span> 
                        DefaultMessageStore.<span class="hljs-built_in">this</span>.commitLog.checkMessageAndReturnSize(result.getByteBuffer(), ...);
                    
                    <span class="hljs-comment">// 分发到各个 ConsumeQueue</span>
                    DefaultMessageStore.<span class="hljs-built_in">this</span>.doDispatch(dispatchRequest);
                    
                    <span class="hljs-comment">// 更新偏移量</span>
                    reputFromOffset += dispatchRequest.getMsgSize();
                } <span class="hljs-keyword">finally</span> {
                    result.release();
                }
            }
        }
    }
}
</code></pre>
<p>这个线程是单线程的，按顺序构建索引。如果 CommitLog 写入过快，ConsumeQueue 构建可能滞后。监控指标：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 reput 延迟</span>
grep <span class="hljs-string">"reput"</span> /data/rocketmq/logs/rocketmqlogs/store.log | <span class="hljs-built_in">tail</span> -20

<span class="hljs-comment"># 正常情况下延迟 &lt; 1ms</span>
<span class="hljs-comment"># 如果延迟 &gt; 10ms，说明 reput 线程跟不上，需要优化磁盘或 CPU</span>
</code></pre>
<h5 data-id="heading-9">TransientStorePool：堆外内存加速</h5>
<p>TransientStorePool 是 RocketMQ 4.5+ 引入的特性，把写入缓冲放到堆外内存（DirectBuffer），避开 GC。</p>
<p><strong>工作原理</strong>：</p>
<pre><code class="hljs">消息 → DirectBuffer（堆外） → MappedFile（mmap） → 磁盘
</code></pre>
<p>不开启时：</p>
<pre><code class="hljs">消息 → MappedFile（mmap） → 磁盘
</code></pre>
<p>直接写 MappedFile 会触发 page fault，堆外缓冲能减少 fault 次数。</p>
<p><strong>源码</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TransientStorePool.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransientStorePool</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> poolSize;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> fileSize;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Deque&lt;ByteBuffer&gt; availableBuffers;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; poolSize; i++) {
            <span class="hljs-comment">// 分配 DirectBuffer</span>
            <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> ByteBuffer.allocateDirect(fileSize);
            availableBuffers.offer(buffer);
        }
    }
    
    <span class="hljs-keyword">public</span> ByteBuffer <span class="hljs-title function_">borrowBuffer</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> availableBuffers.poll();
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnBuffer</span><span class="hljs-params">(ByteBuffer buffer)</span> {
        buffer.clear();
        availableBuffers.offer(buffer);
    }
}
</code></pre>
<p><strong>配置</strong>：</p>
<pre><code class="hljs language-properties" lang="properties"># 开启堆外内存池
transientStorePoolEnable=true

# 池大小（单位：个）
transientStorePoolSize=5
</code></pre>
<p>每个 Buffer 的大小 = <code>mapedFileSizeCommitLog</code>（默认 1GB），所以 <code>poolSize=5</code> 意味着占用 5GB 堆外内存。</p>
<p><strong>性能提升</strong>：</p>
<p>某压测（1KB 消息，100 Topic）：</p>























<table><thead><tr><th>配置</th><th>TPS</th><th>P99 延迟</th><th>GC 时间</th></tr></thead><tbody><tr><td>不开启 TransientStorePool</td><td>120 万</td><td>1.2ms</td><td>200ms/min</td></tr><tr><td>开启 TransientStorePool</td><td>160 万</td><td>0.8ms</td><td>50ms/min</td></tr></tbody></table>
<p>TPS 提升 30%，GC 时间降低 75%。</p>
<p><strong>注意事项</strong>：</p>
<ul>
<li>堆外内存不受 JVM 管理，泄漏了很难排查。需要监控 <code>direct buffer</code> 使用量。</li>
<li>如果开启了 <code>transientStorePoolEnable</code> 但忘了开 <code>flushCommitLogAsync</code>，会出现写入卡顿（因为同步刷盘不会使用 transient buffer）。</li>
</ul>
<hr/>
<h3 data-id="heading-10">4.2 网络层优化</h3>
<p>网络是"吞吐的天花板，延迟的地板"。Kafka 和 RocketMQ 都用了 Reactor 模型，但实现细节不同。</p>
<h4 data-id="heading-11">Kafka 的网络架构</h4>
<p>Kafka 自己实现了一套 NIO 框架，分为三层：</p>
<ol>
<li><strong>Acceptor</strong>：接受新连接，单线程</li>
<li><strong>Processor</strong>：读写 socket，多线程（<code>num.network.threads</code>）</li>
<li><strong>RequestHandler</strong>：处理请求逻辑，多线程（<code>num.io.threads</code>）</li>
</ol>
<p><strong>源码</strong>（<code>SocketServer.scala</code>）：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocketServer</span> </span>{
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> acceptors = <span class="hljs-keyword">new</span> mutable.<span class="hljs-type">HashMap</span>[<span class="hljs-type">EndPoint</span>, <span class="hljs-type">Acceptor</span>]
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> processors = <span class="hljs-keyword">new</span> <span class="hljs-type">Array</span>[<span class="hljs-type">Processor</span>](numProcessorThreads)
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> requestChannel = <span class="hljs-keyword">new</span> <span class="hljs-type">RequestChannel</span>(queueSize)
  
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">startup</span></span>(): <span class="hljs-type">Unit</span> = {
    <span class="hljs-comment">// 启动 Processor 线程</span>
    <span class="hljs-keyword">for</span> (i &lt;- <span class="hljs-number">0</span> until numProcessorThreads) {
      processors(i) = <span class="hljs-keyword">new</span> <span class="hljs-type">Processor</span>(i, requestChannel, ...)
      <span class="hljs-type">Utils</span>.newThread(<span class="hljs-string">s"kafka-network-thread-<span class="hljs-subst">$i</span>"</span>, processors(i)).start()
    }
    
    <span class="hljs-comment">// 启动 Acceptor</span>
    acceptors.foreach { <span class="hljs-keyword">case</span> (endpoint, acceptor) =&gt;
      <span class="hljs-type">Utils</span>.newThread(<span class="hljs-string">s"kafka-socket-acceptor-<span class="hljs-subst">$endpoint</span>"</span>, acceptor).start()
    }
  }
}
</code></pre>
<p><strong>Processor 线程的工作</strong>：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Processor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Runnable</span> </span>{
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> newConnections = <span class="hljs-keyword">new</span> <span class="hljs-type">ConcurrentLinkedQueue</span>[<span class="hljs-type">SocketChannel</span>]()
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> selector = <span class="hljs-keyword">new</span> <span class="hljs-type">KafkaSelector</span>(...)
  
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span></span>(): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">while</span> (isRunning) {
      <span class="hljs-comment">// 1. 接受新连接（由 Acceptor 分发过来）</span>
      configureNewConnections()
      
      <span class="hljs-comment">// 2. 处理读写事件</span>
      selector.poll(<span class="hljs-number">300</span>)
      
      <span class="hljs-comment">// 3. 把完整的请求放到 RequestChannel</span>
      processCompletedReceives()
      
      <span class="hljs-comment">// 4. 把响应写入 socket</span>
      processCompletedSends()
    }
  }
}
</code></pre>
<p><strong>RequestHandler 线程</strong>：</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KafkaRequestHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Runnable</span> </span>{
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span></span>(): <span class="hljs-type">Unit</span> = {
    <span class="hljs-keyword">while</span> (!stopped) {
      <span class="hljs-comment">// 从 RequestChannel 取请求</span>
      <span class="hljs-keyword">val</span> req = requestChannel.receiveRequest(<span class="hljs-number">300</span>)
      
      <span class="hljs-comment">// 调用 KafkaApis 处理</span>
      apis.handle(req)
    }
  }
}
</code></pre>
<p><strong>调优要点</strong>：</p>
<ol>
<li>
<p><strong>num.network.threads</strong>：</p>
<ul>
<li>默认 3，一般设置为网卡队列数（4~8）</li>
<li>如果 socket 读写慢，CPU 利用率低，可以加到 16</li>
</ul>
</li>
<li>
<p><strong>num.io.threads</strong>：</p>
<ul>
<li>默认 8，处理业务逻辑（Produce/Fetch）</li>
<li>可以根据 CPU 核数调整（建议 CPU 核数的 0.5~1 倍）</li>
</ul>
</li>
<li>
<p><strong>queued.max.requests</strong>：</p>
<ul>
<li>RequestChannel 的队列长度，默认 500</li>
<li>如果队列经常满，说明 IO 线程处理不过来，需要加 <code>num.io.threads</code></li>
</ul>
</li>
<li>
<p><strong>socket.send.buffer.bytes / socket.receive.buffer.bytes</strong>：</p>
<ul>
<li>默认 100KB，跨机房场景建议调大到 1MB+</li>
</ul>
</li>
</ol>
<p>查看队列深度：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># JMX 指标</span>
kafka.network:<span class="hljs-built_in">type</span>=RequestChannel,name=RequestQueueSize

<span class="hljs-comment"># 如果值 &gt; 100，说明请求积压</span>
</code></pre>
<h4 data-id="heading-12">RocketMQ 的网络架构</h4>
<p>RocketMQ 直接用 Netty，省去了自己维护 NIO 的麻烦。</p>
<p><strong>架构</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">Client</span> → Netty EventLoop → RequestTask → ExecutorService → Processor
</code></pre>
<p><strong>源码</strong>（<code>NettyRemotingServer.java</code>）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NettyRemotingServer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EventLoopGroup eventLoopGroupBoss;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EventLoopGroup eventLoopGroupSelector;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// Boss 线程处理连接</span>
        <span class="hljs-built_in">this</span>.eventLoopGroupBoss = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>, 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryImpl</span>(<span class="hljs-string">"NettyBoss_"</span>));
        
        <span class="hljs-comment">// Worker 线程处理 IO</span>
        <span class="hljs-built_in">this</span>.eventLoopGroupSelector = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(
            nettyServerConfig.getServerSelectorThreads(),
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryImpl</span>(<span class="hljs-string">"NettyServerNIOSelector_"</span>));
        
        <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">bootstrap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
        bootstrap.group(<span class="hljs-built_in">this</span>.eventLoopGroupBoss, <span class="hljs-built_in">this</span>.eventLoopGroupSelector)
            .channel(NioServerSocketChannel.class)
            .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> {
                    ch.pipeline()
                        .addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyEncoder</span>())
                        .addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyDecoder</span>())
                        .addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyServerHandler</span>());  <span class="hljs-comment">// 处理请求</span>
                }
            });
        
        <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">sync</span> <span class="hljs-operator">=</span> bootstrap.bind(port).sync();
    }
}
</code></pre>
<p><strong>请求处理</strong>：</p>
<p>Netty 接收到完整请求后，会丢到线程池处理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// NettyServerHandler.java</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, RemotingCommand msg)</span> {
    <span class="hljs-comment">// 根据请求类型选择线程池</span>
    <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> getExecutorService(msg.getCode());
    
    <span class="hljs-keyword">if</span> (executor == <span class="hljs-literal">null</span>) {
        executor = <span class="hljs-built_in">this</span>.defaultExecutor;  <span class="hljs-comment">// 默认线程池</span>
    }
    
    <span class="hljs-comment">// 提交任务</span>
    executor.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RequestTask</span>(ctx, msg));
}
</code></pre>
<p><strong>线程池分类</strong>：</p>
<ul>
<li><code>sendMessageExecutor</code>：处理 SEND_MESSAGE 请求</li>
<li><code>pullMessageExecutor</code>：处理 PULL_MESSAGE 请求</li>
<li><code>queryMessageExecutor</code>：处理查询请求</li>
<li><code>adminBrokerExecutor</code>：处理管理命令</li>
</ul>
<p><strong>调优要点</strong>：</p>
<ol>
<li>
<p><strong>serverSelectorThreads</strong>：</p>
<ul>
<li>Netty EventLoop 线程数，默认 3</li>
<li>可以调到 CPU 核数的 1~2 倍</li>
</ul>
</li>
<li>
<p><strong>sendMessageThreadPoolNums</strong>：</p>
<ul>
<li>处理写入的线程数，默认 16</li>
<li>根据 TPS 调整，保持队列长度 &lt; 100</li>
</ul>
</li>
<li>
<p><strong>pullMessageThreadPoolNums</strong>：</p>
<ul>
<li>处理拉取的线程数，默认 16</li>
<li>消费高峰时可以调大</li>
</ul>
</li>
</ol>
<p>查看线程池状态：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 通过 mqadmin 查看</span>
sh mqadmin clusterList -n localhost:9876

<span class="hljs-comment"># 查看线程池队列深度</span>
jstack &lt;pid&gt; | grep <span class="hljs-string">"sendMessageExecutor"</span>

<span class="hljs-comment"># 如果大量线程 WAITING，说明队列满了</span>
</code></pre>
<h4 data-id="heading-13">网络调优对比</h4>





























<table><thead><tr><th>指标</th><th>Kafka</th><th>RocketMQ</th><th>调优重点</th></tr></thead><tbody><tr><td>并发连接数</td><td>1000+</td><td>5000+</td><td>RocketMQ 用 Netty，连接数更高</td></tr><tr><td>单连接吞吐</td><td>50MB/s</td><td>60MB/s</td><td>差距不大</td></tr><tr><td>延迟抖动</td><td>依赖 RequestChannel 队列</td><td>依赖线程池队列</td><td>都要监控队列深度</td></tr></tbody></table>
<p><strong>网络层的通用优化</strong>：</p>
<ol>
<li><strong>打开 TCP_NODELAY</strong>：禁用 Nagle 算法，降低延迟</li>
<li><strong>调大 SO_SNDBUF / SO_RCVBUF</strong>：跨机房场景下，根据 BDP（带宽×延迟）计算合适的缓冲区大小</li>
<li><strong>开启 RPS/RFS</strong>：把网络中断绑定到多个 CPU 核，避免单核打满</li>
</ol>
<hr/>
<h3 data-id="heading-14">4.3 磁盘 IO 优化</h3>
<p>磁盘是性能的"最后一道坎"。</p>
<h4 data-id="heading-15">Kafka 的磁盘策略</h4>
<p>Kafka 依赖顺序写 + Page Cache，磁盘选型和文件系统配置直接影响性能。</p>
<p><strong>磁盘选型</strong>：</p>

































<table><thead><tr><th>磁盘类型</th><th>顺序写吞吐</th><th>随机 IOPS</th><th>价格</th><th>适用场景</th></tr></thead><tbody><tr><td>HDD（7200 转）</td><td>100~150 MB/s</td><td>100~200</td><td>低</td><td>成本敏感、数据量大</td></tr><tr><td>SATA SSD</td><td>500~600 MB/s</td><td>5万+</td><td>中</td><td>一般场景</td></tr><tr><td>NVMe SSD</td><td>2000~3000 MB/s</td><td>50万+</td><td>高</td><td>高性能场景</td></tr></tbody></table>
<p>Kafka 更吃"顺序写吞吐"，SATA SSD 就够用；如果预算足，NVMe 能把延迟压得更低。</p>
<p><strong>RAID 配置</strong>：</p>
<ul>
<li><strong>RAID0</strong>：条带化，性能最高，但任意磁盘故障都会丢数据</li>
<li><strong>RAID10</strong>：镜像+条带，性能和可靠性兼顾，推荐</li>
<li><strong>RAID5/6</strong>：校验冗余，写入性能差，不推荐</li>
</ul>
<p>Kafka 通常配 RAID10，再结合副本机制做容灾。</p>
<p><strong>文件系统</strong>：</p>
<ul>
<li><strong>XFS</strong>：推荐，大文件性能好，支持并发写入</li>
<li><strong>EXT4</strong>：也可以，但要调整参数</li>
<li><strong>ZFS/Btrfs</strong>：功能丰富但性能开销大，不推荐</li>
</ul>
<p>XFS 调优：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 挂载选项</span>
mount -o noatime,nodiratime,nobarrier /dev/sda1 /var/kafka-logs

<span class="hljs-comment"># 关闭 atime 减少写入</span>
<span class="hljs-comment"># 关闭 barrier 提升性能（需要 UPS 或副本保障）</span>
</code></pre>
<p><strong>Page Cache 回收策略</strong>：</p>
<p>调整内核参数，减少 Page Cache 被回收：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># /etc/sysctl.conf</span>
vm.dirty_ratio=80              <span class="hljs-comment"># 脏页达到 80% 才强制刷盘</span>
vm.dirty_background_ratio=5    <span class="hljs-comment"># 后台刷盘阈值</span>
vm.swappiness=1                <span class="hljs-comment"># 尽量不用 swap</span>
</code></pre>
<h4 data-id="heading-16">RocketMQ 的磁盘策略</h4>
<p>RocketMQ 的磁盘用法和 Kafka 类似，但多了"文件预热"和"预分配"。</p>
<p><strong>文件预分配</strong>：</p>
<p>CommitLog 文件在使用前会预创建：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MappedFileQueue.java</span>
<span class="hljs-keyword">public</span> MappedFile <span class="hljs-title function_">getLastMappedFile</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">long</span> startOffset, <span class="hljs-type">boolean</span> needCreate)</span> {
    <span class="hljs-type">MappedFile</span> <span class="hljs-variable">mappedFileLast</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.mappedFiles.get(<span class="hljs-built_in">this</span>.mappedFiles.size() - <span class="hljs-number">1</span>);
    
    <span class="hljs-keyword">if</span> (mappedFileLast.isFull()) {
        <span class="hljs-comment">// 文件满了，创建下一个</span>
        <span class="hljs-type">MappedFile</span> <span class="hljs-variable">newFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MappedFile</span>(
            nextFilePath, 
            <span class="hljs-built_in">this</span>.mappedFileSize,
            <span class="hljs-built_in">this</span>.transientStorePool);
        
        <span class="hljs-built_in">this</span>.mappedFiles.add(newFile);
        <span class="hljs-keyword">return</span> newFile;
    }
    
    <span class="hljs-keyword">return</span> mappedFileLast;
}
</code></pre>
<p>预分配的好处：</p>
<ul>
<li>避免写入时临时创建文件，减少卡顿</li>
<li>提前占用磁盘空间，防止碎片化</li>
</ul>
<p><strong>文件预热（warmMappedFileEnable）</strong>：</p>
<p>文件创建后，可以"预热"到内存，减少后续的 page fault：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MappedFile.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">warmMappedFile</span><span class="hljs-params">(FlushDiskType type, <span class="hljs-type">int</span> pages)</span> {
    <span class="hljs-type">ByteBuffer</span> <span class="hljs-variable">byteBuffer</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.mappedByteBuffer.slice();
    
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; pages; i++) {
        <span class="hljs-comment">// 每隔 4KB 写一个字节，触发 page fault</span>
        byteBuffer.put(i * <span class="hljs-number">4096</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0</span>);
    }
    
    <span class="hljs-keyword">if</span> (type == FlushDiskType.SYNC_FLUSH) {
        <span class="hljs-comment">// 同步刷盘模式下，还要 mlock，锁定内存页</span>
        LibC.INSTANCE.mlock(address, fileSize);
    }
}
</code></pre>
<p><strong>配置</strong>：</p>
<pre><code class="hljs language-properties" lang="properties"># 开启文件预热
warmMapedFileEnable=true

# 预热页数（-1 表示全部）
mapedFileSizeCommitLog=1073741824  # 1GB
</code></pre>
<p>预热会占用 CPU 和内存，但能换来更稳定的延迟（P999 从 10ms 降到 2ms）。</p>
<p><strong>磁盘 IO 调度器</strong>：</p>
<p>Linux 的 IO 调度器会影响性能：</p>
<ul>
<li><strong>CFQ</strong>（完全公平）：默认，但会导致延迟不稳定</li>
<li><strong>Deadline</strong>：优先处理读请求，延迟更稳定</li>
<li><strong>Noop</strong>：不排队，适合 SSD</li>
</ul>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前调度器</span>
<span class="hljs-built_in">cat</span> /sys/block/sda/queue/scheduler

<span class="hljs-comment"># 改为 deadline</span>
<span class="hljs-built_in">echo</span> deadline &gt; /sys/block/sda/queue/scheduler

<span class="hljs-comment"># 或者改为 noop（SSD）</span>
<span class="hljs-built_in">echo</span> noop &gt; /sys/block/sda/queue/scheduler
</code></pre>
<p>RocketMQ 官方建议用 Deadline 或 Noop。</p>
<hr/>
<h3 data-id="heading-17">4.4 内存管理优化</h3>
<p>内存分配策略决定了 GC 行为，GC 停顿会直接影响延迟。</p>
<h4 data-id="heading-18">Kafka 的内存分配</h4>
<p>Kafka Broker 的内存主要分两块：</p>
<ol>
<li><strong>JVM 堆</strong>：6~8GB，存储元数据、请求对象、Log Cleaner 的缓冲等</li>
<li><strong>Page Cache</strong>：剩余所有内存，存储消息数据</li>
</ol>
<p><strong>JVM 参数</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">export</span> KAFKA_HEAP_OPTS=<span class="hljs-string">"-Xms6g -Xmx6g"</span>
<span class="hljs-built_in">export</span> KAFKA_JVM_PERFORMANCE_OPTS=<span class="hljs-string">"-XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:InitiatingHeapOccupancyPercent=35"</span>
</code></pre>
<p><strong>G1 GC 配置</strong>：</p>
<ul>
<li><code>MaxGCPauseMillis=20</code>：期望的最大停顿时间，G1 会尽量控制</li>
<li><code>InitiatingHeapOccupancyPercent=35</code>：堆占用 35% 就开始并发标记，避免 Full GC</li>
</ul>
<p><strong>GC 日志分析</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开启 GC 日志</span>
-Xlog:gc*:file=/var/log/kafka/gc.log:time,<span class="hljs-built_in">uptime</span>,level,tags

<span class="hljs-comment"># 分析 GC</span>
grep <span class="hljs-string">"Pause Young"</span> gc.log | awk <span class="hljs-string">'{print $NF}'</span> | <span class="hljs-built_in">sort</span> -n | <span class="hljs-built_in">tail</span> -20

<span class="hljs-comment"># 如果 P99 &gt; 50ms，需要优化</span>
</code></pre>
<p>常见问题：</p>
<ul>
<li><strong>频繁 Young GC</strong>：对象创建过多，考虑对象池或减小堆</li>
<li><strong>Full GC</strong>：老年代满了，检查是否有内存泄漏</li>
</ul>
<h4 data-id="heading-19">RocketMQ 的内存分配</h4>
<p>RocketMQ 的内存分三块：</p>
<ol>
<li><strong>JVM 堆</strong>：8~16GB，存储消息对象、索引等</li>
<li><strong>堆外内存</strong>：TransientStorePool、MappedFile</li>
<li><strong>Page Cache</strong>：剩余内存</li>
</ol>
<p><strong>JVM 参数</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">JAVA_OPT=<span class="hljs-string">"<span class="hljs-variable">${JAVA_OPT}</span> -server -Xms8g -Xmx8g -Xmn4g"</span>
JAVA_OPT=<span class="hljs-string">"<span class="hljs-variable">${JAVA_OPT}</span> -XX:+UseG1GC -XX:MaxGCPauseMillis=50"</span>
JAVA_OPT=<span class="hljs-string">"<span class="hljs-variable">${JAVA_OPT}</span> -XX:+DisableExplicitGC"</span>  <span class="hljs-comment"># 禁用 System.gc()</span>
</code></pre>
<p><strong>堆外内存监控</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查看 DirectBuffer 使用</span>
<span class="hljs-type">long</span> <span class="hljs-variable">directMemory</span> <span class="hljs-operator">=</span> sun.misc.SharedSecrets.getJavaNioAccess()
    .getDirectBufferPool()
    .getMemoryUsed();

log.info(<span class="hljs-string">"Direct memory used: {}MB"</span>, directMemory / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>);
</code></pre>
<p>如果 DirectBuffer 持续增长不释放，说明有泄漏。常见原因：</p>
<ul>
<li>MappedFile 没有正确 unmap</li>
<li>TransientStorePool 的 buffer 没有归还</li>
</ul>
<hr/>
<h3 data-id="heading-20">4.5 线程模型优化</h3>
<p>线程模型是性能调优的"最后一公里"。</p>
<h4 data-id="heading-21">Kafka 的线程池</h4>
<p>Kafka 的线程池比较简单，主要是 Network、IO、Log Cleaner 三类。</p>
<p><strong>监控线程池</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 通过 JMX 查看</span>
kafka.server:type=KafkaRequestHandlerPool,name=RequestHandlerAvgIdlePercent

<span class="hljs-comment">// 如果 IdlePercent &lt; 20%，说明 IO 线程忙不过来</span>
</code></pre>
<p><strong>常见瓶颈</strong>：</p>
<ol>
<li>
<p><strong>IO 线程打满</strong>：</p>
<ul>
<li>表现：RequestChannel 队列深度 &gt; 100，CPU 打满</li>
<li>解决：增加 <code>num.io.threads</code></li>
</ul>
</li>
<li>
<p><strong>Network 线程慢</strong>：</p>
<ul>
<li>表现：socket buffer 满，clients 报 timeout</li>
<li>解决：增加 <code>num.network.threads</code>，或优化网络硬件</li>
</ul>
</li>
<li>
<p><strong>Log Cleaner 拖慢</strong>：</p>
<ul>
<li>表现：compaction 跟不上，Segment 越来越多</li>
<li>解决：增加 <code>log.cleaner.threads</code>，或调整 <code>min.cleanable.dirty.ratio</code></li>
</ul>
</li>
</ol>
<h4 data-id="heading-22">RocketMQ 的线程池</h4>
<p>RocketMQ 的线程池更细化，每种请求都有独立的线程池。</p>
<p><strong>线程池配置</strong>：</p>
<pre><code class="hljs language-properties" lang="properties"># 写入线程池
sendMessageThreadPoolNums=16

# 拉取线程池
pullMessageThreadPoolNums=16

# 查询线程池
queryMessageThreadPoolNums=8

# 管理线程池
adminBrokerThreadPoolNums=16
</code></pre>
<p><strong>线程池监控</strong>：</p>
<p>RocketMQ 有内置的线程池监控，可以通过 JMX 查看：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看线程池状态</span>
sh mqadmin brokerRuntimeInfo -n localhost:9876 -b broker-a

<span class="hljs-comment"># 输出示例：</span>
sendMessageThreadPoolQueueSize: 50         <span class="hljs-comment"># 队列深度</span>
sendMessageThreadPoolQueueCapacity: 10000  <span class="hljs-comment"># 队列容量</span>
pullMessageThreadPoolQueueSize: 20
</code></pre>
<p><strong>调优策略</strong>：</p>
<ol>
<li><strong>队列深度 &gt; 100</strong>：线程池处理不过来，增加线程数</li>
<li><strong>队列深度 = 0</strong>：线程池闲置，可以减少线程数</li>
<li><strong>队列深度波动大</strong>：流量不均匀，考虑削峰或限流</li>
</ol>
<p><strong>源码</strong>（线程池创建）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// BrokerController.java</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializeThreadExecutors</span><span class="hljs-params">()</span> {
    <span class="hljs-built_in">this</span>.sendMessageExecutor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrokerFixedThreadPoolExecutor</span>(
        <span class="hljs-built_in">this</span>.brokerConfig.getSendMessageThreadPoolNums(),
        <span class="hljs-built_in">this</span>.brokerConfig.getSendMessageThreadPoolNums(),
        <span class="hljs-number">1000</span> * <span class="hljs-number">60</span>,
        TimeUnit.MILLISECONDS,
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingQueue</span>&lt;&gt;(<span class="hljs-number">10000</span>),  <span class="hljs-comment">// 队列长度</span>
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadFactoryImpl</span>(<span class="hljs-string">"SendMessageThread_"</span>));
    
    <span class="hljs-comment">// 其他线程池类似...</span>
}
</code></pre>
<p><strong>拒绝策略</strong>：</p>
<p>如果队列满了，RocketMQ 会返回 <code>SYSTEM_BUSY</code>，Producer 需要重试：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// BrokerFastFailure.java</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanExpiredRequest</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 定期清理超时请求</span>
    <span class="hljs-keyword">while</span> (!requestQueue.isEmpty()) {
        <span class="hljs-type">Runnable</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> requestQueue.peek();
        <span class="hljs-keyword">if</span> (System.currentTimeMillis() - task.getCreateTimestamp() &gt; waitTimeMillsInQueue) {
            requestQueue.poll();
            task.returnResponse(ResponseCode.SYSTEM_BUSY);
        }
    }
}
</code></pre>
<p><strong>调优案例</strong>：</p>
<p>某 RocketMQ 集群 TPS 卡在 5 万，CPU 只有 30%：</p>
<ol>
<li>查看线程池，发现 <code>sendMessageExecutor</code> 队列深度 5000+</li>
<li>线程数只有 16，处理不过来</li>
<li>调整 <code>sendMessageThreadPoolNums=64</code></li>
<li>TPS 提升到 20 万，CPU 升到 70%</li>
</ol>
<hr/>
<h3 data-id="heading-23">4.6 性能测试与基准</h3>
<p>压测要设计好场景，否则测出来的数据没有参考价值。</p>
<h4 data-id="heading-24">测试场景设计</h4>
<p><strong>单 Topic 场景</strong>：</p>
<ul>
<li>目的：测试单 Topic 的极限性能</li>
<li>配置：1 个 Topic，4~8 个 Partition/Queue，3 副本</li>
<li>消息大小：1KB / 10KB / 100KB</li>
<li>发送模式：同步 / 异步</li>
</ul>
<p><strong>多 Topic 场景</strong>：</p>
<ul>
<li>目的：测试多 Topic 并发写入的性能</li>
<li>配置：100 个 Topic，每个 4 个 Partition/Queue</li>
<li>消息大小：1KB</li>
<li>发送模式：异步</li>
</ul>
<p><strong>小消息 vs 大消息</strong>：</p>
<ul>
<li>小消息（&lt; 1KB）：考验批处理和网络性能</li>
<li>大消息（&gt; 100KB）：考验磁盘吞吐和带宽</li>
</ul>
<h4 data-id="heading-25">Kafka 压测实战</h4>
<p><strong>测试环境</strong>：</p>
<ul>
<li>服务器：3 台，32 核 / 128GB / NVMe SSD</li>
<li>网络：万兆</li>
<li>Kafka 版本：3.5.0（KRaft 模式）</li>
<li>配置：3 副本，<code>acks=all</code>，<code>min.insync.replicas=2</code></li>
</ul>
<p><strong>压测命令</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Producer 压测</span>
kafka-producer-perf-test.sh \
  --topic perf-test \
  --num-records 10000000 \
  --record-size 1024 \
  --throughput -1 \
  --producer-props \
    bootstrap.servers=kafka1:9092,kafka2:9092,kafka3:9092 \
    acks=all \
    linger.ms=10 \
    batch.size=65536 \
    compression.type=lz4
</code></pre>
<p><strong>测试结果</strong>（1KB 消息）：</p>


















































<table><thead><tr><th>Partition 数</th><th>acks</th><th>linger.ms</th><th>TPS</th><th>P99 延迟</th><th>CPU</th><th>网络</th></tr></thead><tbody><tr><td>6</td><td>1</td><td>0</td><td>80 万</td><td>2.5ms</td><td>50%</td><td>600MB/s</td></tr><tr><td>6</td><td>1</td><td>10</td><td>120 万</td><td>12ms</td><td>60%</td><td>900MB/s</td></tr><tr><td>6</td><td>all</td><td>10</td><td>90 万</td><td>18ms</td><td>70%</td><td>700MB/s</td></tr><tr><td>12</td><td>all</td><td>10</td><td>140 万</td><td>15ms</td><td>80%</td><td>1GB/s</td></tr></tbody></table>
<p><strong>结论</strong>：</p>
<ul>
<li><code>linger.ms</code> 对 TPS 影响大（从 80 万提到 120 万），但延迟会增加</li>
<li>Partition 数量越多，TPS 越高（并行度更高）</li>
<li><code>acks=all</code> 会降低 TPS 20~30%</li>
</ul>
<h4 data-id="heading-26">RocketMQ 压测实战</h4>
<p><strong>测试环境</strong>：</p>
<ul>
<li>服务器：3 台，32 核 / 128GB / NVMe SSD</li>
<li>网络：万兆</li>
<li>RocketMQ 版本：4.9.4</li>
<li>配置：3 副本（DLedger），同步刷盘</li>
</ul>
<p><strong>压测命令</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Producer 压测</span>
sh benchmark.sh producer \
  -n localhost:9876 \
  -t perf-test \
  -s 1024 \
  -c 100  <span class="hljs-comment"># 100 个并发</span>
</code></pre>
<p><strong>测试结果</strong>（1KB 消息）：</p>


















































<table><thead><tr><th>Queue 数</th><th>刷盘</th><th>复制</th><th>TPS</th><th>P99 延迟</th><th>CPU</th><th>网络</th></tr></thead><tbody><tr><td>4</td><td>异步</td><td>异步</td><td>150 万</td><td>0.8ms</td><td>50%</td><td>1.1GB/s</td></tr><tr><td>4</td><td>异步</td><td>同步</td><td>110 万</td><td>2.5ms</td><td>65%</td><td>850MB/s</td></tr><tr><td>4</td><td>同步</td><td>同步</td><td>70 万</td><td>8ms</td><td>75%</td><td>550MB/s</td></tr><tr><td>8</td><td>异步</td><td>异步</td><td>180 万</td><td>0.7ms</td><td>60%</td><td>1.3GB/s</td></tr></tbody></table>
<p><strong>结论</strong>：</p>
<ul>
<li>异步刷盘 + 异步复制性能最高（180 万 TPS）</li>
<li>同步刷盘会降低 TPS 50%+</li>
<li>Queue 数量增加能提升 TPS，但提升幅度不如 Kafka 的 Partition</li>
</ul>
<h4 data-id="heading-27">性能瓶颈定位</h4>
<p>压测过程中如果 TPS 上不去，按以下顺序排查：</p>
<ol>
<li>
<p><strong>CPU</strong>：</p>
<ul>
<li><code>top -H -p &lt;pid&gt;</code>，看哪些线程占 CPU 高</li>
<li>如果 CPU &lt; 70%，说明不是 CPU 瓶颈</li>
<li>如果 CPU = 100%，用 <code>perf top</code> 看热点函数</li>
</ul>
</li>
<li>
<p><strong>网络</strong>：</p>
<ul>
<li><code>iftop</code> 或 <code>nload</code> 看网络吞吐</li>
<li>如果接近万兆上限（1.2GB/s），说明网络是瓶颈</li>
</ul>
</li>
<li>
<p><strong>磁盘</strong>：</p>
<ul>
<li><code>iostat -x 1</code> 看磁盘利用率和吞吐</li>
<li>如果 <code>%util</code> = 100%，说明磁盘是瓶颈</li>
</ul>
</li>
<li>
<p><strong>线程池</strong>：</p>
<ul>
<li>看队列深度，如果 &gt; 1000，说明线程池不够</li>
</ul>
</li>
<li>
<p><strong>GC</strong>：</p>
<ul>
<li>看 GC 日志，如果频繁 Full GC，说明堆太小或有泄漏</li>
</ul>
</li>
</ol>
<hr/>
<p><strong>背景</strong>：</p>
<p>某业务 Kafka 的 P99 延迟 2ms，但 P999 延迟 200ms+，影响用户体验。</p>
<p><strong>排查</strong>：</p>
<ol>
<li>查看 Producer 日志，发现偶发的 timeout 异常</li>
<li>查看 Broker GC 日志，发现偶发 Full GC（500ms+）</li>
<li>查看网络监控，发现 Processor 线程偶尔卡住</li>
</ol>
<p><strong>定位</strong>：</p>
<ol>
<li><strong>Full GC 原因</strong>：Log Cleaner 占用大量内存，触发 Full GC</li>
<li><strong>Processor 卡住原因</strong>：某些慢 Consumer 的 Fetch 请求耗时长，阻塞了其他请求</li>
</ol>
<p><strong>优化</strong>：</p>
<ol>
<li>调整 Log Cleaner 配置：</li>
</ol>
<pre><code class="hljs language-properties" lang="properties">log.cleaner.dedupe.buffer.size=256MB  # 从 128MB 调大
log.cleaner.threads=2                  # 增加线程
</code></pre>
<ol start="2">
<li>
<p>增加 <code>num.network.threads</code>（从 3 调到 8），避免慢请求阻塞</p>
</li>
<li>
<p>Consumer 端优化：</p>
<ul>
<li>增加 Consumer 实例，减少单个 Consumer 的负载</li>
<li>开启 <code>max.poll.records=500</code>，批量处理</li>
</ul>
</li>
</ol>
<p><strong>效果</strong>：</p>
<ul>
<li>Full GC 频率降低 90%</li>
<li>P999 延迟从 200ms 降到 10ms</li>
</ul>
<p><strong>经验</strong>：</p>
<p>P999 延迟的"长尾"往往是 GC、慢请求、网络抖动等偶发问题。需要结合日志和监控，逐个排查。</p>
<hr/>
<h3 data-id="heading-28">总结</h3>
<p>性能调优是个"木桶效应"：网络、磁盘、CPU、内存、线程、配置，任何一块短了都会拖后腿。</p>
<p><strong>Kafka 调优重点</strong>：</p>
<ol>
<li><strong>Page Cache</strong>：保证有足够内存，避免被其他进程挤占</li>
<li><strong>批量 + linger</strong>：Producer 端调整 <code>linger.ms</code> 和 <code>batch.size</code></li>
<li><strong>线程池</strong>：<code>num.network.threads</code> 和 <code>num.io.threads</code> 要够</li>
<li><strong>磁盘</strong>：用 SSD，XFS 文件系统，关闭 atime</li>
<li><strong>监控</strong>：盯 Page Cache 命中率、GC、Under-Replicated Partitions</li>
</ol>
<p><strong>RocketMQ 调优重点</strong>：</p>
<ol>
<li><strong>刷盘 + 复制</strong>：根据业务选择合适的组合（异步性能高，同步可靠性高）</li>
<li><strong>TransientStorePool</strong>：高吞吐场景下开启，减少 GC</li>
<li><strong>线程池</strong>：<code>sendMessageThreadPoolNums</code> 和 <code>pullMessageThreadPoolNums</code> 根据 TPS 调整</li>
<li><strong>文件预热</strong>：开启 <code>warmMappedFileEnable</code>，减少首写延迟</li>
<li><strong>监控</strong>：盯刷盘耗时、复制延迟、线程池队列深度</li>
</ol>
<p><strong>通用建议</strong>：</p>
<ol>
<li><strong>压测要贴近真实</strong>：用真实的消息大小、Topic 数量、流量模式</li>
<li><strong>监控要全面</strong>：CPU、内存、磁盘、网络、GC、线程池，缺一不可</li>
<li><strong>优化要有数据</strong>：每次优化前后都要记录数据，对比效果</li>
<li><strong>不要过度优化</strong>：达到业务目标就够了，不要追求"理论极限"</li>
</ol>
<p>性能调优的本质，是在"可靠性、延迟、吞吐"之间找平衡。没有最优解，只有最适合你业务的解。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何解决MySQL唯一索引与逻辑删除冲突]]></title>    <link>https://juejin.cn/post/7572497847770890267</link>    <guid>https://juejin.cn/post/7572497847770890267</guid>    <pubDate>2025-11-15T14:28:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572497847770890267" data-draft-id="7572781559750950939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何解决MySQL唯一索引与逻辑删除冲突"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-15T14:28:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CyberShen"/> <meta itemprop="url" content="https://juejin.cn/user/554609587530014"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何解决MySQL唯一索引与逻辑删除冲突
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/554609587530014/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CyberShen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T14:28:49.000Z" title="Sat Nov 15 2025 14:28:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在当今业务系统中，<strong>逻辑删除</strong>已成为数据管理的标配做法，它通过一个标记字段（如 <code>is_deleted</code>）来标识数据是否被删除，而不是真正从数据库中移除数据。这种做法有利于数据审计、故障恢复和历史记录追踪。然而，当表中存在<strong>唯一索引</strong>时，逻辑删除就会带来一个棘手的问题：已删除的数据仍然占用着唯一索引的“位置”，导致新插入的合法数据因违反唯一约束而被拒绝。</p>
<h2 data-id="heading-0">问题场景分析</h2>
<p>假设我们有一个用户表，其中 <code>username</code>字段需要保持唯一性，我们为此创建了唯一索引。同时，我们使用 <code>is_deleted</code>字段实现逻辑删除（0表示未删除，1表示已删除）。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">user</span>` (
  `id` <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
  `username` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `is_deleted` TINYINT(<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  `email` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> INDEX `idx_username_unique` (`username`)
);
</code></pre>
<p>现在考虑以下操作序列：</p>
<ol>
<li>插入用户名为"张三"的记录：<code>INSERT INTO user (username, is_deleted, email) VALUES ('张三', 0, 'zhangsan@example.com');</code></li>
<li>逻辑删除这条记录：<code>UPDATE user SET is_deleted = 1 WHERE username = '张三';</code></li>
<li>尝试重新创建用户名为"张三"的新用户：<code>INSERT INTO user (username, is_deleted, email) VALUES ('张三', 0, 'new_zhangsan@example.com');</code></li>
</ol>
<p>此时，第三步操作会失败，并报告"Duplicate entry"错误。因为唯一索引仍然认为用户名"张三"已存在，尽管它对应的数据已被标记为删除。</p>
<h2 data-id="heading-1">解决方案对比</h2>
<p>以下是几种解决这一问题的方案，各有优缺点，适用于不同场景。</p>
<h3 data-id="heading-2">方案一：将删除标识设置为NULL</h3>
<p>利用<strong>数据库唯一索引对NULL值无效</strong>的特性，将删除标识字段设置为NULL而非固定的值。<strong>实现方式：</strong></p>
<ul>
<li>未删除时，<code>del_flag</code>字段为0（或NOT NULL）</li>
<li>逻辑删除时，将 <code>del_flag</code>设置为NULL</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建联合唯一索引</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">UNIQUE</span> INDEX idx_username_del_flag (username, del_flag);

<span class="hljs-comment">-- 逻辑删除时设置del_flag为NULL</span>
<span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">SET</span> del_flag <span class="hljs-operator">=</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'张三'</span> <span class="hljs-keyword">AND</span> del_flag <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
</code></pre>
<p>如果你使用MyBatis-Plus，可以通过注解简化配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 是否删除
 * 为解决'逻辑删除'和'唯一索引'冲突问题，将逻辑删除字段设置为NULL
 */</span>
<span class="hljs-meta">@TableLogic(value = <span class="hljs-string">"0"</span>, delval = <span class="hljs-string">"NULL"</span>)</span>
<span class="hljs-keyword">private</span> <span class="hljs-built_in">Boolean</span> deleteFlag;
</code></pre>
<p><strong>优点</strong>：实现简单，无需改变表结构<strong>缺点</strong>：语义上不够直观，NULL值的处理可能需要额外注意</p>
<h3 data-id="heading-3">方案二：使用时间戳作为删除标志</h3>
<p>将删除标志从布尔值改为时间戳，<strong>利用时间戳的高唯一性</strong>避免冲突。<strong>实现方式：</strong></p>
<ul>
<li>未删除时，<code>delete_time</code>字段为0或NULL</li>
<li>逻辑删除时，将 <code>delete_time</code>设置为当前时间戳</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 修改表结构，将删除标志改为时间戳</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">user</span> 
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> delete_time <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'删除时间，0表示未删除'</span>;

<span class="hljs-comment">-- 创建联合唯一索引</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">UNIQUE</span> INDEX idx_username_delete_time (username, delete_time);

<span class="hljs-comment">-- 逻辑删除时设置delete_time为当前时间戳</span>
<span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">SET</span> delete_time <span class="hljs-operator">=</span> UNIX_TIMESTAMP() <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'张三'</span> <span class="hljs-keyword">AND</span> delete_time <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
</code></pre>
<p><strong>优点</strong>：可以记录删除时间，冲突可能性极低<strong>缺点</strong>：需要修改表结构，存储空间稍大</p>
<h3 data-id="heading-4">方案三：新增删除唯一标识字段</h3>
<p><strong>新增一个专门用于唯一约束的字段</strong>，与原有唯一字段组成联合唯一索引。<strong>实现方式：</strong></p>
<ul>
<li>新增 <code>del_unique_key</code>字段，默认值为0（类型与主键相同）</li>
<li>逻辑删除时，将 <code>del_unique_key</code>设置为该记录的主键ID</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 新增del_unique_key字段</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">user</span> 
<span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> del_unique_key <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'用于唯一索引的逻辑删除字段'</span>;

<span class="hljs-comment">-- 创建联合唯一索引</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">UNIQUE</span> INDEX idx_username_del_unique (username, del_unique_key);

<span class="hljs-comment">-- 逻辑删除时设置del_unique_key为主键值</span>
<span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">SET</span> del_unique_key <span class="hljs-operator">=</span> id, is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'张三'</span> <span class="hljs-keyword">AND</span> is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
</code></pre>
<p><strong>优点</strong>：保证唯一性，易于理解<strong>缺点</strong>：需要新增字段，删除操作稍复杂</p>
<h3 data-id="heading-5">方案四：MySQL 8.0+ 虚拟生成列方案（推荐）</h3>
<p>对于MySQL 8.0.13及以上版本，<strong>虚拟生成列</strong>提供了一种优雅的解决方案。<strong>实现原理：</strong> 创建虚拟生成列，仅当数据未删除时显示业务字段值，删除后显示NULL，然后在该虚拟列上创建唯一索引。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 添加虚拟生成列</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">user</span>
  <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> username_visible <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
    GENERATED ALWAYS <span class="hljs-keyword">AS</span> (IF(is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, username, <span class="hljs-keyword">NULL</span>)) VIRTUAL,
  <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> email_visible <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
    GENERATED ALWAYS <span class="hljs-keyword">AS</span> (IF(is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, email, <span class="hljs-keyword">NULL</span>)) VIRTUAL;

<span class="hljs-comment">-- 在虚拟列上创建唯一索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX idx_user_unique
  <span class="hljs-keyword">ON</span> <span class="hljs-keyword">user</span>(username_visible, email_visible);
</code></pre>
<p>现在，可以正常进行插入和删除操作：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 插入第一条数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">user</span> (username, is_deleted, email) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'张三'</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'zhangsan@example.com'</span>);

<span class="hljs-comment">-- 逻辑删除该数据</span>
<span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">SET</span> is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'张三'</span>;

<span class="hljs-comment">-- 再次插入相同用户名，成功！</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">user</span> (username, is_deleted, email) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'张三'</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'new_zhangsan@example.com'</span>);
</code></pre>
<p><strong>优点</strong>：</p>
<ul>
<li>完全在数据库层解决，无需修改业务代码</li>
<li>索引效率高，仅对未删除数据建立索引</li>
<li>语义清晰，易于维护</li>
</ul>
<p><strong>缺点</strong>：需要MySQL 8.0.13+版本支持</p>
<h3 data-id="heading-6">方案五：物理删除与历史表</h3>
<p>如果业务允许，可以考虑<strong>物理删除+历史表</strong>的方案。<strong>实现方式：</strong></p>
<ul>
<li>主表使用物理删除</li>
<li>删除前将数据转移至历史表</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建历史表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_history <span class="hljs-keyword">LIKE</span> <span class="hljs-keyword">user</span>;
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> user_history <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> deleted_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>;

<span class="hljs-comment">-- 删除操作（事务中执行）</span>
<span class="hljs-keyword">START</span> TRANSACTION;
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> user_history <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>, NOW() <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<p><strong>优点</strong>：彻底避免唯一索引冲突，数据归档清晰<strong>缺点</strong>：实现复杂，需要维护历史表</p>
<h3 data-id="heading-7">方案六：引入Redis等外部缓存</h3>
<p><strong>将唯一性检查移至应用层</strong>，通过Redis等高性能缓存保证唯一性。<strong>实现方式：</strong></p>
<ul>
<li>移除数据库层面的唯一约束</li>
<li>插入数据前，先检查Redis中是否存在相同键值</li>
<li>使用Redis的原子操作保证并发安全</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 伪代码示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">insertUser</span>(<span class="hljs-params">User user</span>) {
    <span class="hljs-title class_">String</span> key = <span class="hljs-string">"user:unique:"</span> + user.<span class="hljs-title function_">getUsername</span>();
    <span class="hljs-comment">// 使用SETNX原子操作</span>
    <span class="hljs-built_in">boolean</span> success = redis.<span class="hljs-title function_">setnx</span>(key, user.<span class="hljs-title function_">getId</span>(), expiration);
    <span class="hljs-keyword">if</span> (!success) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BusinessException</span>(<span class="hljs-string">"用户名已存在"</span>);
    }
    <span class="hljs-comment">// 插入数据库</span>
    <span class="hljs-keyword">return</span> userMapper.<span class="hljs-title function_">insert</span>(user) &gt; <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// 删除时</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">deleteUser</span>(<span class="hljs-params">Long userId</span>) {
    <span class="hljs-title class_">User</span> user = userMapper.<span class="hljs-title function_">selectById</span>(userId);
    <span class="hljs-title class_">String</span> key = <span class="hljs-string">"user:unique:"</span> + user.<span class="hljs-title function_">getUsername</span>();
    redis.<span class="hljs-title function_">delete</span>(key);
    <span class="hljs-keyword">return</span> userMapper.<span class="hljs-title function_">logicDelete</span>(userId);
}
</code></pre>
<p><strong>优点</strong>：高性能，灵活性强<strong>缺点</strong>：系统复杂度增加，需要维护数据一致性</p>
<h2 data-id="heading-8">方案比较与选型建议</h2>
<p>下表对比了各方案的适用场景和注意事项：</p>






















































<table><thead><tr><th>方案</th><th>适用场景</th><th>优点</th><th>缺点</th><th>推荐指数</th></tr></thead><tbody><tr><td>删除标识设为NULL</td><td>简单业务，数据量小</td><td>实现简单</td><td>语义不清，NULL处理复杂</td><td>★★★☆☆</td></tr><tr><td>时间戳删除标志</td><td>需要记录删除时间</td><td>记录删除时间，低概率冲突</td><td>存储空间稍大</td><td>★★★★☆</td></tr><tr><td>新增删除标识字段</td><td>大多数业务场景</td><td>保证唯一性，易于理解</td><td>需要新增字段</td><td>★★★★☆</td></tr><tr><td>虚拟生成列(MySQL 8.0+)</td><td>MySQL 8.0+环境</td><td>数据库层解决，高效</td><td>版本要求高</td><td>★★★★★</td></tr><tr><td>物理删除+历史表</td><td>数据归档重要场景</td><td>彻底解决冲突</td><td>实现复杂，维护成本高</td><td>★★☆☆☆</td></tr><tr><td>Redis外部缓存</td><td>高并发，高性能要求</td><td>性能极高</td><td>系统复杂，一致性难保证</td><td>★★★☆☆</td></tr></tbody></table>
<p><strong>选型建议：</strong></p>
<ol>
<li><strong>新建系统且使用MySQL 8.0+</strong> ：强烈推荐<strong>虚拟生成列方案</strong>，它在数据库层面完美解决问题，且无需修改业务代码。</li>
<li><strong>现有系统改造</strong>：优先考虑<strong>新增删除标识字段</strong>或<strong>时间戳方案</strong>，对现有业务影响较小。</li>
<li><strong>高并发场景</strong>：可以考虑<strong>Redis方案</strong>，但要做好数据一致性的保障。</li>
<li><strong>数据敏感型业务</strong>：<strong>物理删除+历史表</strong>虽然实现复杂，但提供了完整的数据追踪能力。</li>
</ol>
<h2 data-id="heading-9">实战示例：虚拟生成列方案完整实现</h2>
<p>以下是在MySQL 8.0+环境中使用虚拟生成列的完整示例：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">user</span>` (
  `id` <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
  `username` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  `is_deleted` TINYINT(<span class="hljs-number">1</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  `email` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB;

<span class="hljs-comment">-- 添加虚拟生成列</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> <span class="hljs-keyword">user</span>
  <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> username_visible <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
    GENERATED ALWAYS <span class="hljs-keyword">AS</span> (IF(is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, username, <span class="hljs-keyword">NULL</span>)) VIRTUAL,
  <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">COLUMN</span> email_visible <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>)
    GENERATED ALWAYS <span class="hljs-keyword">AS</span> (IF(is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">0</span>, email, <span class="hljs-keyword">NULL</span>)) VIRTUAL;

<span class="hljs-comment">-- 创建唯一索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX idx_user_unique
  <span class="hljs-keyword">ON</span> <span class="hljs-keyword">user</span>(username_visible, email_visible);

<span class="hljs-comment">-- 测试数据操作</span>
<span class="hljs-comment">-- 1. 插入第一条数据</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">user</span> (username, is_deleted, email) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'zhangsan'</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'zhangsan@example.com'</span>);

<span class="hljs-comment">-- 2. 逻辑删除第一条数据</span>
<span class="hljs-keyword">UPDATE</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">SET</span> is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> username <span class="hljs-operator">=</span> <span class="hljs-string">'zhangsan'</span>;

<span class="hljs-comment">-- 3. 插入同用户名的新数据（应该成功）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> <span class="hljs-keyword">user</span> (username, is_deleted, email) <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'zhangsan'</span>, <span class="hljs-number">0</span>, <span class="hljs-string">'new_zhangsan@example.com'</span>);

<span class="hljs-comment">-- 4. 查询验证</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">WHERE</span> is_deleted <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
</code></pre>
<h2 data-id="heading-10">总结</h2>
<p>MySQL唯一索引与逻辑删除的冲突是数据库设计中常见但完全可以解决的问题。选择哪种方案应根据具体的业务需求、技术环境和未来发展规划来决定。对于大多数场景，我推荐<strong>虚拟生成列方案</strong>（MySQL 8.0+）或<strong>新增删除标识字段方案</strong>（MySQL低版本），它们在复杂性、性能和可维护性之间取得了较好的平衡。无论选择哪种方案，重要的是要在项目早期就考虑并设计好删除策略，避免在业务发展到一定阶段后才发现数据一致性问题，那时再进行改造将付出更大的代价。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-154 Apache Druid 架构与组件职责全解析 版本架构：Coordinator/Overlord/Historical 实战]]></title>    <link>https://juejin.cn/post/7572493520003973154</link>    <guid>https://juejin.cn/post/7572493520003973154</guid>    <pubDate>2025-11-16T01:53:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572493520003973154" data-draft-id="7572537221540659215" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-154 Apache Druid 架构与组件职责全解析 版本架构：Coordinator/Overlord/Historical 实战"/> <meta itemprop="keywords" content="后端,大数据,Apache"/> <meta itemprop="datePublished" content="2025-11-16T01:53:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-154 Apache Druid 架构与组件职责全解析 版本架构：Coordinator/Overlord/Historical 实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T01:53:43.000Z" title="Sun Nov 16 2025 01:53:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：实时 + 历史 OLAP，需要稳定摄入、可扩展查询与可预期的集群运维。</li>
<li>结论：按 Master（Coordinator/Overlord）/Query（Broker/Router）/Data（Historical/MiddleManager）拆分，配合 ZK、元库与 Deep Storage，优先治理 Segment 与任务调度。</li>
<li>产出：架构要点清单、版本/依赖矩阵（待你确认）、常见故障定位与修复速查卡。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d816449f9b75462fa544136705b61f01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763862823&amp;x-signature=6smXSCuEfiknlQz5K3txjxD6Gxw%3D" alt="大数据-154 Apache Druid 架构与组件职责全解析 版本架构：Coordinator/Overlord/Historical 实战" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/976bb980f8a34547b140d96fee19d86c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763862823&amp;x-signature=ucfJP7y19e4QbsAIf4Lz3WFaVSE%3D" alt="Apache Druid" loading="lazy"/></p>
<h2 data-id="heading-1">基础架构</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc7dc103ccb44197aca947eb6367b5d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763862823&amp;x-signature=%2BQjmzMXVONpj3rLbSvuiYwxNSvE%3D" alt="Druid 基础架构" loading="lazy"/></p>
<h3 data-id="heading-2">Coordinator Node</h3>
<p>Druid的Coordinator组件主要负责集群中历史节点(Historical Node)的数据负载均衡和生命周期管理。具体来说，它的核心职责包括以下几个方面：</p>
<ol>
<li>
<p><strong>数据负载均衡</strong>：</p>
<ul>
<li>监控各历史节点的负载情况</li>
<li>根据配置的均衡策略在节点间迁移Segment</li>
<li>确保数据均匀分布，避免某些节点过载</li>
<li>处理新加入或失效节点后的数据重分布</li>
</ul>
</li>
<li>
<p><strong>生命周期管理</strong>：</p>
<ul>
<li>按照预先定义的规则(Rule)管理数据</li>
<li>协调新数据的加载流程</li>
<li>定期检查并卸载过期数据</li>
<li>根据需要复制重要数据以提高可用性</li>
<li>执行数据的冷热分层策略</li>
</ul>
</li>
</ol>
<p>Coordinator的运行是周期性的，其执行间隔由druid.coordinator.period参数控制，默认值为60000毫秒(60秒)。每次运行时，Coordinator会：</p>
<ol>
<li>
<p><strong>集群状态同步</strong>：</p>
<ul>
<li>维持与ZooKeeper的持久连接</li>
<li>实时获取集群拓扑和节点状态信息</li>
<li>监控历史节点的加入、离开或故障情况</li>
</ul>
</li>
<li>
<p><strong>元数据管理</strong>：</p>
<ul>
<li>连接配置的元数据库(通常是MySQL或PostgreSQL)</li>
<li>读取和维护所有Segment的元信息</li>
<li>获取和处理数据管理规则(Rule)配置</li>
<li>记录Segment的分布和状态变更</li>
</ul>
</li>
<li>
<p><strong>决策执行</strong>：</p>
<ul>
<li>根据规则和当前状态生成数据管理计划</li>
<li>向历史节点下发加载/卸载指令</li>
<li>协调节点间的数据迁移操作</li>
<li>处理数据复制和均衡的请求</li>
</ul>
</li>
</ol>
<p>在实际应用中，Coordinator的这些功能确保了Druid集群能够：</p>
<ul>
<li>自动适应工作负载变化</li>
<li>优雅处理节点扩容或故障</li>
<li>按需保留有价值的历史数据</li>
<li>高效利用集群存储资源</li>
</ul>
<h3 data-id="heading-3">Overlord Node</h3>
<p>进程监视MiddleManager进程，并且是Druid数据摄入的主节点，负责将提取任务分配给MiddleManagers并协调Segment发布，包括接受、拆解、分配Task，以及创建Task相关的锁，并返回Task的状态。</p>
<h3 data-id="heading-4">Historical Node</h3>
<p>加载生成好的数据文件，以供数据查询。Historical Node是整个集群查询性能的核心所在，Historical会承担绝大部分的Segment查询。</p>
<ul>
<li>Historical 进程从 Deep Storage 中下载 Segment，并响应有关这些Segment的查询请求（这些请求来自Broker进程）</li>
<li>Historical 进程不处理写入请求</li>
<li>Historical 进程采用了无共享架构设计，它知道如何去加载和删除 Segment，以及如何基于 Segment 来响应查询。即便底层的深度存储无法正常工作，Historical 进程还是能针对其已同步的 Segments，正常提供查询服务。</li>
<li>底层的深度存储无法正常工作，Historical进程还是能针对其已同步的 Segments，正常提供查询服务。</li>
</ul>
<h3 data-id="heading-5">MiddleManager Node</h3>
<p>及时摄入实时数据，生成Segment数据文件</p>
<ul>
<li>MiddleManager 进程是执行提交任务的工作节点，MiddleManagers将任务转发给在不同JVM中运行的Peon进程</li>
<li>MiddleManager、Peon、Task的对应关系是：每个Peon进程一次只能运行一个Task任务，但一个MiddleManager却可以管理多个Peon进程</li>
</ul>
<h3 data-id="heading-6">Broker Node</h3>
<p>接收客户端查询请求，并将这些查询转发给 Histo 和 MiddleManagers。当Brokers从这些子查询中收到结果时，它们会合并这些结果并将它们返回给调用者。</p>
<ul>
<li>Broker 节点负责转发Client查询请求的</li>
<li>Broker 通过 ZooKeeper 能够知道哪个 Segment 在哪些节点上，将查询转发给相应节点</li>
<li>所有节点返回数据后，Broker会所有节点的数据进行合并，然后返回给Client</li>
</ul>
<h3 data-id="heading-7">Router Node</h3>
<p>（可选）
负责将路由转发到Broker、Coordinator、Overlords</p>
<ul>
<li>Router进程可以在 Broker、Overlords、Coordinator进程之上，提供一层统一的API网关</li>
<li>Router进程是可选的，如果集群数据规模已经到达了TB级别，需要考虑启动（druid.router.managerProxy.enable=true）</li>
<li>一旦集群规模达到一定数量级，那么发生故障的概率就会变得不容忽视，而Router支持将请求只发送给健康的节点，避免请求失败。</li>
<li>同时，查询的响应时间和资源消耗，也会随着数据量的增长而变高，而Router支持设置查询的优先级和负载均衡策略，避免了大查询造成的队列堆积或查询热点等问题</li>
</ul>
<h3 data-id="heading-8">如何分类</h3>
<p>Druid的进程可以被任意部署，为了理解与部署组织方便，这些进程分为了三类：</p>
<ul>
<li>Master：Coordinator、Overlord 负责数据可用性和摄取</li>
<li>Query：Broker、Router 负责处理外部请求</li>
<li>Data：Historical、MiddleManager，负责实际的Ingestion负载和数据存储</li>
</ul>
<h3 data-id="heading-9">其他依赖</h3>
<p>Deep Storage
存放生成的 Segment 数据文件，并供历史服务器下载，对于单节点集群可以是本地磁盘，而对于分布式集群一般是HDFS。</p>
<ul>
<li>Druid使用 Deep Storage来做数据的备份，也作为Druid进程之间在后台传输数据的一种方式</li>
<li>当相应查询时，Historical首先从本地磁盘读取预取的段，这也意味着需要在Deep Storage和加载的数据Historical中拥有足够的磁盘空间。</li>
</ul>
<h4 data-id="heading-10">Metadata Storage</h4>
<p>存储Durid集群的元数据信息，如Segment的相关信息，一般使用MySQL。<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a63688b05b0f4de1803e5e76a75012cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763862823&amp;x-signature=Lq5BfnQUfsJsCwvf5iOlzCF4HSk%3D" alt="Metadata Storage" loading="lazy"/></p>
<h4 data-id="heading-11">ZooKeeper</h4>
<p>Druid 集群通过以下几个关键机制来确保集群内各节点的协调工作：</p>
<h5 data-id="heading-12">1. Coordinator 节点的 Leader 选举机制</h5>
<ul>
<li><strong>选举协议</strong>：采用基于 Zookeeper 的 Leader 选举算法</li>
<li><strong>职责范围</strong>：
<ul>
<li>监控 Historical 节点的 Segment 加载状态</li>
<li>协调 Segment 在集群中的分布</li>
<li>管理 Segment 的加载和丢弃策略</li>
</ul>
</li>
<li><strong>选举过程</strong>：当当前 Leader 下线时，所有 Coordinator 节点会参与新一轮选举，最先在 Zookeeper 上创建临时节点的成为新 Leader</li>
</ul>
<h5 data-id="heading-13">2. Historical 节点发布 Segment 的协议</h5>
<ul>
<li><strong>发布流程</strong>：
<ol>
<li>Historical 节点完成 Segment 加载后，会在元数据存储中更新状态</li>
<li>向 Coordinator 发送 Segment 可用通知</li>
<li>Coordinator 验证元数据一致性后，将该 Segment 标记为可查询</li>
</ol>
</li>
<li><strong>容错机制</strong>：如果发布过程中失败，Segment 会被标记为失败状态，并由 Coordinator 安排重试</li>
</ul>
<h5 data-id="heading-14">3. Coordinator 和 Historical 间的 Segment 管理协议</h5>
<ul>
<li><strong>Load Segment 流程</strong>：
<ol>
<li>Coordinator 根据负载均衡策略选择目标 Historical 节点</li>
<li>发送 HTTP 请求通知 Historical 加载指定 Segment</li>
<li>Historical 从深度存储下载 Segment 数据并加载到内存</li>
</ol>
</li>
<li><strong>Drop Segment 流程</strong>：
<ol>
<li>Coordinator 发送删除指令给 Historical</li>
<li>Historical 从内存卸载 Segment 并删除本地副本</li>
<li>更新元数据状态</li>
</ol>
</li>
</ul>
<h5 data-id="heading-15">4. Overlord 节点的 Leader 选举机制</h5>
<ul>
<li><strong>选举特点</strong>：与 Coordinator 类似，同样基于 Zookeeper</li>
<li><strong>职责范围</strong>：
<ul>
<li>接收和处理任务提交请求</li>
<li>分配任务给 MiddleManager</li>
<li>监控任务执行状态</li>
</ul>
</li>
<li><strong>故障转移</strong>：当 Leader 失效时，新 Leader 会接管所有正在运行的任务状态</li>
</ul>
<h5 data-id="heading-16">5. Overlord 和 MiddleManager 间的任务管理协议</h5>
<ul>
<li><strong>任务分配流程</strong>：
<ol>
<li>Overlord 接收任务提交请求</li>
<li>根据 MiddleManager 的负载情况选择执行节点</li>
<li>通过 HTTP 接口将任务描述发送给 MiddleManager</li>
</ol>
</li>
<li><strong>状态同步机制</strong>：
<ul>
<li>MiddleManager 定期向 Overlord 发送心跳和任务状态更新</li>
<li>Overlord 监控任务进度，必要时进行重试或重新调度</li>
</ul>
</li>
<li><strong>容错处理</strong>：当 MiddleManager 失联时，Overlord 会将任务重新分配给其他可用节点</li>
</ul>
<p>这些协调机制共同确保了 Druid 集群在分布式环境下的可靠运行和数据一致性。</p>
<h2 data-id="heading-17">架构演进</h2>
<h3 data-id="heading-18">初始版本~0.6.0</h3>
<p>2012-2013年
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3f65a9edec342d581b6f5eb353935d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763862823&amp;x-signature=Vej8frwCB6nVPN3wYyPIm0HsNGI%3D" alt="Druid 0.6.0" loading="lazy"/></p>
<h3 data-id="heading-19">0.7.0~0.12.0</h3>
<p>2013年-2018年</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d597329cd0d42fa9a77b95aead03a68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763862823&amp;x-signature=1B8WGEIadhkCWr89HCpAoyMXOyI%3D" alt="Druid 0.7.0" loading="lazy"/></p>
<h3 data-id="heading-20">集群管理</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3aeb2f0018924f7fbecfc03e16e855e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763862823&amp;x-signature=fDN9IHre%2B3WnZs3ee30OTbe3B8E%3D" alt="Druid 集群管理" loading="lazy"/></p>
<h3 data-id="heading-21">0.13.0~当前版本</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61d34c4415c947619daaa83875cb91b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763862823&amp;x-signature=FVRrcZFl%2FU33SAu4EL%2FHef%2BaNBM%3D" alt="Druid 0.13.0" loading="lazy"/></p>
<h4 data-id="heading-22">Lambda架构</h4>
<p>从大的架构上看，Druid是一个Lambda架构。
Lambda架构是由Storm坐着Nathan Marz提出的一个实时大数据处理框架，Lambda架构设计是为了处理大规模数据时，同时发挥流处理和批处理的优势：</p>
<ul>
<li>通过批处理提供全面、准确的数据</li>
<li>通过流处理提供低延迟的数据
从而达到平衡延迟、吞吐量和容错性的目的，为了满足下游的及时查询，批处理和流处理的结果会合并。</li>
</ul>
<p>Lambda架构包含三层：BatchLayer、SpeedLayer、Serving Layer</p>
<ul>
<li>BatchLayer：批处理层，对离线的历史数据进行预计算，为了下游能够快速查询想要的结果，由于批处理基于完成的历史数据集，准确性可以得到保证，批处理层可以用Hadoop、Spark、Flink等框架计算。</li>
<li>SpeedLayer：加速处理层，处理实时的增量数据，这一层重点在于低延迟，加速层的数据不如批处理层那样完整和准确，但是可以填补批处理高延迟导致的数据空白。加速层可以使用Storm、Spark Streaming和Flink等框架计算。</li>
<li>ServingLayer：合并层，将历史数据、实时数据合并在一起，输出到数据库或者其他介质，供下游分析</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8894735527a14986826d8568b1603202~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763862823&amp;x-signature=XOPIRv5eUYpi7FrLXlPD6dELkz4%3D" alt="Druid 每一层的架构" loading="lazy"/></p>
<h3 data-id="heading-23">流式数据链路</h3>
<p>Raw Data - Kafka - Streaming Processor（Optional 实时ETL）-  Kafka（Optional）- Druid - Application/User</p>
<h3 data-id="heading-24">批处理数据链路</h3>
<p>Raw data - Kafka（Optional） - HDFS - ETL Process（Optional）- Druid - Application/User</p>
<h2 data-id="heading-25">错误速查</h2>



























































<table><thead><tr><th>症状</th><th>根因</th><th>定位</th><th>修复</th></tr></thead><tbody><tr><td>查询慢/抖动/热点段</td><td>Segment 过碎、缺 compaction；Broker 合并开销大；缓存命中低</td><td>查看 Broker/Historical 指标（merge/CPU/缓存命中）、segment 大小与数量</td><td>启用/优化 compaction，控制 segmentGranularity；调优 Broker 线程与查询并发；开启/优化缓存策略</td></tr><tr><td>Segment 无法加载/“丢片”</td><td>Deep Storage 读写/权限问题；Coordinator 规则触发 Drop</td><td>Coordinator 动作日志、Historical 日志与 Deep Storage ACL</td><td>修正 load/drop 规则与 ACL；重试加载；校验副本与可用空间</td></tr><tr><td>实时摄入堆积</td><td>MiddleManager slot/内存不足；Kafka backlog 增长</td><td>Overlord 任务状态、Peon 日志、Kafka lag</td><td>扩容 MiddleManager/提高 taskSlots 与内存；调小 segment 颗粒度；增加并发/限速</td></tr><tr><td>Leader 频繁切换</td><td>ZK 抖动/会话过期</td><td>ZK 日志、会话过期计数、网络抖动排查</td><td>提高会话超时；稳定 ZK（三/五节点奇数）；隔离噪声网络</td></tr><tr><td>查询结果缺失/不一致</td><td>Segment 未发布/未标记可查询；晚到数据未并入</td><td>元库状态、Coordinator 规则、数据时间窗口</td><td>校准发布流程；配置 lateMessage 处理与窗口；补跑/重算并 compaction</td></tr><tr><td>Historical 磁盘打满</td><td>本地缓存无上限；副本数/保留策略不当</td><td>磁盘监控、缓存目录与副本策略</td><td>设定缓存上限与清理策略；收敛副本/保留规则；扩容磁盘/节点</td></tr><tr><td>任务频繁失败/重试</td><td>Peon 内存不足、依赖 JAR/权限问题</td><td>Peon GC/OOM 日志、容器限制、依赖校验</td><td>上调 Xmx/容器限制；修正依赖与权限；分解大任务，缩短窗口</td></tr><tr><td>Broker 502/超时</td><td>下游节点慢/不可达；聚合超时</td><td>Broker 日志与下游健康检查</td><td>为慢查询设置专用池/优先级；限流与超时分级；排除故障节点</td></tr></tbody></table>
<h2 data-id="heading-26">其他系列</h2>
<h3 data-id="heading-27">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI-调查研究-108-具身智能 机器人模型训练全流程详解：从预训练到强化学习与人类反馈</strong></p>
<h3 data-id="heading-28">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-154 深入浅出 MongoDB 用Java访问 MongoDB 数据库 从环境搭建到CRUD完整示例</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务正在更新！深入浅出助你打牢基础！</p>
<h3 data-id="heading-29">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[通用会话控制方案]]></title>    <link>https://juejin.cn/post/7572408522439131171</link>    <guid>https://juejin.cn/post/7572408522439131171</guid>    <pubDate>2025-11-15T12:39:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572408522439131171" data-draft-id="7572453554331844608" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="通用会话控制方案"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-15T12:39:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Heo"/> <meta itemprop="url" content="https://juejin.cn/user/1410009035452887"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            通用会话控制方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1410009035452887/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Heo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T12:39:30.000Z" title="Sat Nov 15 2025 12:39:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、会话控制概念</h2>
<ul>
<li>目的：在无状态的 HTTP 请求间<strong>识别/鉴权用户身份</strong>并维持登录状态。</li>
<li>核心问题：谁保存“用户状态”？（服务器 / 客户端 / 第三方认证服务器），以及如何安全地在多请求间传递该凭证（Cookie / Authorization header）。</li>
</ul>
<h2 data-id="heading-1">二、传统方案：Cookie + 服务端 Session</h2>
<h3 data-id="heading-2">1) 流程</h3>
<ol>
<li>用户登录，后端验证凭证（用户名/密码）。</li>
<li>后端在服务器端创建 session（比如 <code>sessionId</code> 对应的对象存在 Redis / DB / 内存），并返回 <code>Set-Cookie: sessionId=xxx; HttpOnly; Secure; SameSite=Lax; Path=/</code> 响应头部信息。</li>
<li>浏览器自动带上 Cookie（同源或按 CORS 配置带上 <code>credentials: 'include'</code>），后端根据 <code>sessionId</code> 在 session store 查到用户信息并授权。</li>
</ol>
<h3 data-id="heading-3">2) 示例（Express + express-session + Redis）</h3>
<p>后端：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express-session'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">RedisStore</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'connect-redis'</span>)(session);
app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">session</span>({
  <span class="hljs-attr">store</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisStore</span>({ <span class="hljs-attr">client</span>: redisClient }),
  <span class="hljs-attr">secret</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">SESSION_SECRET</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'sid'</span>,
  <span class="hljs-attr">resave</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">cookie</span>: {
    <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 生产必须 https</span>
    <span class="hljs-attr">sameSite</span>: <span class="hljs-string">'lax'</span>,   <span class="hljs-comment">// 或 'strict' / 'none'（配合跨域）</span>
    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">24</span> * <span class="hljs-number">3600</span> * <span class="hljs-number">1000</span>
  }
}));
</code></pre>
<p>前端（fetch）：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/profile'</span>, { <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span> })
</code></pre>
<h3 data-id="heading-4">3) 优点</h3>
<ul>
<li>简单明确：后端完全控制会话（可以随时废弃/修改）。</li>
<li>支持服务端会话失效（logout 立刻生效）。</li>
<li>易于集成细粒度权限、会话统计与审计（存 Redis 的 session 可包含登录 IP、设备信息等）。</li>
</ul>
<h3 data-id="heading-5">4) 缺点</h3>
<ul>
<li><strong>水平扩展</strong>需共享 session store（Redis）。</li>
<li>Session 存储和查询带来额外延迟与成本。</li>
<li>跨域场景复杂：需要正确配置 <code>Access-Control-Allow-Credentials</code>、<code>Set-Cookie</code> 的 <code>SameSite=None; Secure</code> 等，避免安全问题。</li>
</ul>
<h2 data-id="heading-6">三、JWT（JSON Web Token）方案概述</h2>
<h3 data-id="heading-7">1) JWT 的基本思想（无状态 token）</h3>
<ul>
<li>后端发放一个签名的 token（通常是 Access Token），包含用户 id、到期时间等。</li>
<li>前端携带 token（通常放在 Authorization header 或者放入 HttpOnly cookie）向后端请求；后端不查 session store，而是直接验证 token 的签名与有效期，若通过则鉴权成功。</li>
</ul>
<p>JWT 典型格式：<code>header.payload.signature</code>（Base64 编码）</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsonwebtoken'</span>);
<span class="hljs-keyword">const</span> accessToken = jwt.<span class="hljs-title function_">sign</span>({ <span class="hljs-attr">uid</span>: xxx }, process.<span class="hljs-property">env</span>.<span class="hljs-property">JWT_SECRET</span>, { <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">'15m'</span> });
<span class="hljs-keyword">const</span> payload = jwt.<span class="hljs-title function_">verify</span>(accessToken, process.<span class="hljs-property">env</span>.<span class="hljs-property">JWT_SECRET</span>);
</code></pre>
<h3 data-id="heading-8">2) 常见拓展</h3>
<ul>
<li>​**短期 Access Token（如 5–15 分钟）**​：放在内存或短寿命存储（不放 localStorage 更安全），用于 API 调用。</li>
<li>​<strong>长期 Refresh Token（如 14 天或更长）<strong>​：安全保存（​</strong>HttpOnly, Secure cookie</strong>​），用于换取新的 Access Token。每次刷新都会发送新的 refresh token。服务端会保存 refresh token 的元数据（redis）。</li>
<li>Access Token 可放在 Authorization: <code>Bearer &lt;token&gt;</code>，或也可放在 HttpOnly cookie（同域 + credentials）
<blockquote>
<p>推荐将 Refresh Token 放 HttpOnly cookie，Access Token 放内存并通过 Authorization header 发送（减少 CSRF 风险）。</p>
</blockquote>
</li>
</ul>
<h3 data-id="heading-9">3) 优点</h3>
<ul>
<li>​<strong>无状态</strong>​，后端不必保存 session（容易横向扩展，适合微服务 &amp; 无状态后端），更适合移动端 SPA 等分布式鉴权。</li>
<li>Token 自包含（本身携带用户身份信息，后端只需验证 token 签名，就直接知道 token 是否有效以及用户信息，无需再查询数据库或者 session 存储），减少每次请求的 DB 查询。</li>
<li>与 OAuth2 兼容，便于做 SSO 与第三方登录。</li>
</ul>
<h3 data-id="heading-10">4) 缺点</h3>
<ul>
<li>​<strong>无法轻易撤销</strong>​（access token 在有效期内一直可用，除非引入黑名单/撤销机制）。</li>
<li>如果把 JWT 放在 localStorage（可被 JS 读取）会增加 XSS 风险；如果放 Cookie，则面临 CSRF 风险。</li>
</ul>
<h2 data-id="heading-11">四、Cookie Session 与 JWT 的主要区别</h2>
<p>表格 还在加载中，请等待加载完成后再尝试复制</p>
<h2 data-id="heading-12">五、安全策略</h2>
<h3 data-id="heading-13">CSRF 防护（Cookie 自动带 credential 的情况下）</h3>
<ul>
<li>优先：使用 <strong>SameSite=Lax</strong> 或 ​<strong>SameSite=Strict ​</strong>​。</li>
<li>对于必须 <code>SameSite=None</code> 的跨站场景，配合 ​**CSRF Token（双 submit cookie）**​：
<ul>
<li>后端在登录时设 <code>Set-Cookie: CSRF-Token=xxx; HttpOnly=false; Secure</code>（可被 JS 读取）</li>
<li>前端每次请求在 header 中带 <code>X-CSRF-Token: &lt;value&gt;</code>，后端验证 header 与 cookie 值一致。</li>
</ul>
</li>
<li>或使用 <code>Origin</code> / <code>Referer</code> 检查（只允许来自可信域的请求）。</li>
</ul>
<blockquote>
<p>核心：CSRF 攻击者 ​<strong>可以发请求</strong>​，但 ​<strong>没法读 Cookie</strong>​，无法把 token 放到 header 中，所以校验(<code>(req.cookies["CSRF-Token"] !== req.headers["X-CSRF-Token"])</code>)。<strong>CSRF 攻击能发请求，但拿不到 cookie 内容 。</strong></p>
</blockquote>
<h3 data-id="heading-14">XSS 防护（避免 token 被窃取）</h3>
<ul>
<li>对可执行 token 的存储避免使用 <code>localStorage</code>（HttpOnly cookie 防止 JS 读取）。</li>
</ul>
<h3 data-id="heading-15">JWT 可撤销性策略</h3>
<ul>
<li>​<strong>短寿命 access token + refresh token</strong>​（refresh token 存 HttpOnly cookie）：
<ul>
<li>access token 过期快，可减少滥用窗口。</li>
<li>refresh token 在服务端有黑名单/DB 记录，必要时撤销（例如用户登出、密码变更）。</li>
</ul>
</li>
<li>​**token id（jti） + 存在服务端黑名单（Redis）**​：在 logout / 强制下线时把 jti 写入黑名单并在验证时检查。黑名单可设置过期与分布式缓存。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[原型理解从入门到精通]]></title>    <link>https://juejin.cn/post/7572454929144905763</link>    <guid>https://juejin.cn/post/7572454929144905763</guid>    <pubDate>2025-11-15T13:08:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572454929144905763" data-draft-id="7572454929144889379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="原型理解从入门到精通"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-15T13:08:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Heo"/> <meta itemprop="url" content="https://juejin.cn/user/1410009035452887"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            原型理解从入门到精通
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1410009035452887/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Heo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T13:08:15.000Z" title="Sat Nov 15 2025 13:08:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>原型这块知识点，其实在我们工作中的使用非常简单。但是俗话说“面试造火箭，工作拧螺丝”，在面试中，面试官不时就会考察一些花里胡哨的问题，所以，我们只有将这个概念和他的相关知识理解透彻，才能以不变应万变。</p>
</blockquote>
<ol>
<li>
<h2 data-id="heading-0">两个容易混淆但要分清的东西</h2>
</li>
<li>
<p>​<strong>每个普通对象都有内部隐式属性 ​<code>[[Prototype]]</code><strong>​​</strong>（常见访问名 ​<code>proto</code><strong>​</strong>）</strong> —— 它指向另一个对象（即原型对象）。</p>
<blockquote>
<p>所以原型对象名字的由来就是，一个对象有一个 prototype 属性，就是原型属性，而这个原型属性本身又是一个对象，所以称之为原型对象。</p>
</blockquote>
</li>
<li>
<p><strong>函数（作为构造函数）有 ​<code>.prototype</code><strong>​</strong>​ 属性</strong> —— 当你用 <code>new Fn()</code> 创建实例时，实例的 <code>[[Prototype]]</code> 会被设置为 <code>Fn.prototype</code>。</p>
</li>
</ol>
<blockquote>
<p>总结：<code>.prototype</code> 是构造函数的属性；<code>[[Prototype]]/__proto__</code> 是普通对象实例的内部指针，二者在构造/实例化时建立联系，但不是同一个东西。</p>
</blockquote>
<ol start="2">
<li>
<h2 data-id="heading-1">原型链：属性查找的核心机制</h2>
</li>
</ol>
<p>当你访问 <code>obj.prop</code> 时，JS 的查找流程如下：</p>
<ol>
<li>先查看 <code>obj</code> 自身是否有名为 <code>prop</code> 的​<strong>自有属性</strong>​。有就返回。</li>
<li>没有则沿着 <code>obj.[[Prototype]]</code>（即 <code>obj.__proto__</code>）去找，找到就返回。</li>
<li>若仍未找到则继续沿着原型的 <code>[[Prototype]]</code>（形成链）向上查找，直到 <code>null</code>（查不到返回 <code>undefined</code>）。</li>
</ol>
<p>这就是所谓的 ​**原型链（prototype chain）**​。</p>
<blockquote>
<p>ES6 <code>class</code> 是语法糖，本质仍用原型。</p>
</blockquote>
<p>示例：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> grand = { <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) { <span class="hljs-keyword">return</span> <span class="hljs-string">'hi from grand'</span>; } };
<span class="hljs-keyword">const</span> parent = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(grand);
parent.<span class="hljs-property">say</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-string">'parent'</span>;
<span class="hljs-keyword">const</span> child = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(parent);
child.<span class="hljs-property">own</span> = <span class="hljs-number">1</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-property">own</span>);           <span class="hljs-comment">// 1 （own property）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-title function_">say</span>());         <span class="hljs-comment">// 'parent' （从 parent 找到）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(child.<span class="hljs-title function_">greet</span>());       <span class="hljs-comment">// 'hi from grand' （从 grand 找到）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(child)); <span class="hljs-comment">// parent</span>
</code></pre>
<p>我们既可以通过构造函数的方式实现继承，也可以通过纯原型继承（Object.create()）的方式实现。</p>
<ul>
<li><code>Object.getPrototypeOf(obj)</code>：安全地获取 <code>[[Prototype]]</code>。</li>
<li><code>Object.setPrototypeOf(obj, proto)</code>：设置对象的原型。通常优先建议使用 <code>Object.create</code> 在创建时设置原型。</li>
</ul>
<ol start="3">
<li>
<h2 data-id="heading-2">构造函数与 <code>new</code> 的工作原理</h2>
</li>
</ol>
<p>当你写 <code>new F(arg)</code>：</p>
<ol>
<li>新建一个空对象 <code>obj</code>。</li>
<li>这个空对象的 <code>[[Prototype]]</code> 被设置为 <code>F.prototype</code>。</li>
<li>执行 <code>F</code>，并把 <code>this</code> 指向 <code>obj</code>。</li>
<li>若 <code>F</code> 返回对象，则最终结果为该对象；否则返回 <code>obj</code>。</li>
</ol>
<p>因此，<code>F.prototype</code> 是实例继承的方法/属性的来源。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">/**
 * 模拟实现 new 操作符的函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Function</span>} Constructor 构造函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">...any</span>} args 传递给构造函数的参数
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">*</span>} 如果无返回值或者显示返回一个对象，则返回构造函数的执行结果；如果显示返回一个基本类型，则返回构造函数的实例
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">Constructor, ...args</span>) {
    <span class="hljs-comment">// 1. 创建一个全新的空对象 2. 为这个空对象设置原型(__proto__)</span>
    <span class="hljs-comment">// 可以使用 {}，但是推荐使用 Object.create() 创建对象并设置原型</span>
    <span class="hljs-keyword">const</span> instance = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Constructor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)

    <span class="hljs-comment">// 3. 绑定构造函数的this为其新创建的空实例对象，并执行构造函数体</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Constructor</span>.<span class="hljs-title function_">apply</span>(instance, args)

    <span class="hljs-keyword">const</span> isObject = <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'object'</span> &amp;&amp; result !== <span class="hljs-literal">null</span>
    <span class="hljs-keyword">const</span> isFunction = <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'function'</span>
    <span class="hljs-comment">// 4. 如果构造函数返回一个非原始值，则返回这个对象；否则返回创建的新实例对象</span>
    <span class="hljs-keyword">if</span> (isObject || isFunction) <span class="hljs-keyword">return</span> result
    <span class="hljs-keyword">return</span> instance
}
</code></pre>
<ol start="4">
<li>
<h2 data-id="heading-3"><code>hasOwnProperty</code>、<code>in</code>、<code>Object.keys</code> 的区别</h2>
</li>
</ol>
<ul>
<li><code>obj.hasOwnProperty('a')</code>：只检查自身属性（不走原型链）。</li>
<li><code>'a' in obj</code>：检查自身或原型链上是否存在属性（包括不可枚举的）。</li>
<li><code>Object.keys(obj)</code> / <code>for...in</code>：<code>Object.keys</code> 返回自身可枚举属性数组；<code>for...in</code> 会枚举自身 + 可枚举的继承属性（可用 <code>hasOwnProperty</code> 过滤）。</li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> p = {<span class="hljs-attr">x</span>:<span class="hljs-number">1</span>};
<span class="hljs-keyword">const</span> o = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(p);
o.<span class="hljs-property">y</span> = <span class="hljs-number">2</span>;

<span class="hljs-string">'x'</span> <span class="hljs-keyword">in</span> o <span class="hljs-comment">// true</span>
o.<span class="hljs-title function_">hasOwnProperty</span>(<span class="hljs-string">'x'</span>) <span class="hljs-comment">// false</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(o) <span class="hljs-comment">// ['y']</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> k <span class="hljs-keyword">in</span> o) { <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(k); } <span class="hljs-comment">// 'y' 'x'</span>
</code></pre>
<ol start="5">
<li>
<h2 data-id="heading-4"><code>instanceof</code> 如何工作</h2>
</li>
</ol>
<p><code>obj instanceof Constructor</code> 检查的是 <code>Constructor.prototype</code> 是否出现在 <code>obj</code> 的原型链上（通过 <code>Object.getPrototypeOf</code> 递归判断）。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">/**
 * 模拟 instanceOf 的实现
 * <span class="hljs-doctag">@param</span> object 实例对象
 * <span class="hljs-doctag">@param</span> Constructor 构造函数(类)
 * <span class="hljs-doctag">@return</span> {<span class="hljs-type">boolean</span>}
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">myInstanceOf</span>(<span class="hljs-params"><span class="hljs-built_in">object</span>, Constructor</span>) {
    <span class="hljs-comment">// 初始获取对象的原型</span>
    <span class="hljs-keyword">let</span> proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(<span class="hljs-built_in">object</span>)

    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        <span class="hljs-comment">// 遍历到原型链顶端</span>
        <span class="hljs-keyword">if</span> (proto === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-comment">// 找到匹配的原型</span>
        <span class="hljs-keyword">if</span> (proto === <span class="hljs-title class_">Constructor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        <span class="hljs-comment">// 继续向上查找原型链</span>
        proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(proto)
    }
}
</code></pre>
<ol start="6">
<li>
<h2 data-id="heading-5">覆盖与读取顺序</h2>
</li>
</ol>
<p>如果对象自身有同名属性，会遮蔽原型上的同名属性：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> proto = {<span class="hljs-attr">v</span>:<span class="hljs-number">1</span>};
<span class="hljs-keyword">const</span> o = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(proto);
o.<span class="hljs-property">v</span> = <span class="hljs-number">2</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(o.<span class="hljs-property">v</span>); <span class="hljs-comment">// 2 （自身属性优先）</span>
<span class="hljs-keyword">delete</span> o.<span class="hljs-property">v</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(o.<span class="hljs-property">v</span>); <span class="hljs-comment">// 1 （回退到原型）</span>
</code></pre>
<ol start="7">
<li>
<h2 data-id="heading-6">修改原型</h2>
</li>
</ol>
<p>你可以给原型添加/修改方法，所有继承该原型的对象都会受影响：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myLog</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){ <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">length</span>); };
[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>].<span class="hljs-title function_">myLog</span>(); <span class="hljs-comment">// 3</span>
</code></pre>
<p>​<strong>注意</strong>​：</p>
<ul>
<li>不要随意修改内置对象（如 <code>Object.prototype</code>、<code>Array.prototype</code>）。修改 prototype 会影响所有实例，可能引入难以追踪的副作用。
<blockquote>
<p>这也是非常常见的一种网络安全漏洞：原型污染。指攻击者使用某种</p>
</blockquote>
</li>
</ul>
<ol start="8">
<li>
<h2 data-id="heading-7">单独说说 constructor</h2>
</li>
</ol>
<p>上面的内容看起来是不是还挺简单的。如果上面内容已经完全理解了，那么再来看 construtor 属性。</p>
<p>JavaScript 每个函数（构造函数）对象天生都会有一个 <code>prototype</code> 属性，而这个 <code>prototype</code> 对象中，默认会有一个指向函数本身的属性 —— <code>constructor</code>。</p>
<p>可以理解为：</p>
<blockquote>
<p><strong>constructor 是原型对象上一个指针，用来指向创建该实例的构造函数。</strong></p>
</blockquote>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; }
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>上述这段代码还比较好理解，总之就是 prototype 这个对象身上有一个属性叫做 constructor，这个 constructor 刚好指向原 构造函数。</p>
<p>接着这段代码的思路，我们再来看看下面这段代码：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name; }
<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Tom"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p.<span class="hljs-property">constructor</span> === <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>诶？不儿？constructor 不是 prototype 上的属性吗？实例对象上也有这个属性吗？</p>
<p>如果你能想到这里，那说明之前的内容至少你已经学懂了。接下来让我告诉你为什么 <code>p.constructor === Person</code>？</p>
<p>原因其实也很简单，因为：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">p.<span class="hljs-property">constructor</span>
= p.<span class="hljs-property">__proto__</span>.<span class="hljs-property">constructor</span>   <span class="hljs-comment">// 实例上没有 constructor，会去原型 __proto__ 查找</span>
= <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span>
= <span class="hljs-title class_">Person</span>
</code></pre>
<h3 data-id="heading-8">为什么上面的继承方式我没有说 constructor？</h3>
<p>因为原型重写后会丢失 constructor 指向，需要手动补回。看这段代码：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params"/>) {}
<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
  <span class="hljs-title function_">eat</span>(<span class="hljs-params"/>) {}
};
</code></pre>
<p>乍眼一看，我们是为 Animal 构造函数添加了 eat 方法，但其实 ⚠️ 这样做会 ​<strong>覆盖原始默认的 prototype 对象</strong>​，从而导致 <code>constructor</code> 丢失（变成 Object ==&gt; <code>{ eat(){} }</code> ）。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span>); <span class="hljs-comment">// 此时是 Object，不是 Animal</span>
</code></pre>
<p>所以，如果你非要这么写，还得自己补回 constructor：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params"/>) {}
<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
  <span class="hljs-attr">constructor</span>: <span class="hljs-title class_">Animal</span>, <span class="hljs-comment">// 手动补回构造函数</span>
  <span class="hljs-title function_">eat</span>(<span class="hljs-params"/>) {}
};
</code></pre>
<p>这样你是不是明白了，为什么上面的继承方式我没有说 constructor。不是不行，而是不太推荐。​<strong>任何人都可以随意改原型</strong>​，导致 <code>constructor</code> 变得不可信。</p>
<blockquote>
<p>ES6 class 的 <code>constructor</code> 本质也是一样的。</p>
</blockquote>
<ol start="9">
<li>
<h2 data-id="heading-9">我是真的不想再谈 Funciton 了</h2>
</li>
</ol>
<blockquote>
<p>这一节完全可以不看，因为本质上还是上面的内容，但奈何总有面试官喜欢挖坑，也总有同学喜欢上当~</p>
</blockquote>
<p>普通函数（非箭头）天然可以作为构造函数。所以上面说的什么 Object、Person 等等所有函数都是 <code>Function</code> 的实例。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Function</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) <span class="hljs-comment">// true</span>
</code></pre>
<p><code>Function.prototype</code> 自身也是一个函数（内置），它的 <code>prototype</code> 与普通对象不同——记住 <code>Function</code> 本身是一个 constructor：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title class_">Function</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span> <span class="hljs-comment">// true</span>
<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span> <span class="hljs-comment">// false (Function.prototype 是个普通函数对象)</span>
<span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> <span class="hljs-comment">// true</span>
</code></pre>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title class_">Person</span> (构造函数)
  │
  ├── prototype → <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> → { <span class="hljs-attr">constructor</span>: <span class="hljs-title class_">Person</span>, ... }  ✅
  └── __proto__ → <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>  ✅
</code></pre>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title class_">Function</span>.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> <span class="hljs-comment">// true</span>
</code></pre>
<blockquote>
<p>Function 自己也是一个函数，它也是自己构造出来的。这就像是先有鸡还是先有蛋的问题 😂。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跨域问题解决方案汇总]]></title>    <link>https://juejin.cn/post/7572453554331926528</link>    <guid>https://juejin.cn/post/7572453554331926528</guid>    <pubDate>2025-11-15T13:17:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572453554331926528" data-draft-id="7572714389922742312" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跨域问题解决方案汇总"/> <meta itemprop="keywords" content="前端,后端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-15T13:17:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Heo"/> <meta itemprop="url" content="https://juejin.cn/user/1410009035452887"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跨域问题解决方案汇总
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1410009035452887/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Heo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T13:17:16.000Z" title="Sat Nov 15 2025 13:17:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>全文默认讲的是浏览器端发起的 HTTP 请求的“跨域”问题（同源策略导致的受限）。</p>
</blockquote>
<h2 data-id="heading-0">跨域 / 同源策略概述</h2>
<ul>
<li>​**同源（same-origin）**​：协议、域名（host）、端口 三者完全相同称为同源。 例如 <code>https://example.com:443</code> 和 <code>http://example.com</code> <strong>不是</strong>同源（协议不同）。</li>
<li>​**同源策略（SOP）**​：浏览器的一种安全机制，限制从一个源加载的脚本去读取另一个源的响应（以防 CSRF / 数据泄露）。</li>
<li>​**跨域（cross-origin）**​：当请求目标不满足同源时即为跨域，请求仍可发出，但浏览器会阻止 JS 读取响应，除非服务器明确允许（即 CORS -&gt; 跨域资源共享）。</li>
</ul>
<h2 data-id="heading-1">CORS（Cross-Origin Resource Sharing）</h2>
<p>CORS（Cross-Origin Resource Sharing）跨域资源共享。浏览器会根据响应头判断是否允许跨域读取。一些关键的响应头包括：</p>
<ul>
<li><code>Access-Control-Allow-Origin</code>：允许的源（或 <code>*</code>）。
<blockquote>
<p>但是这里我们一般不配置为 <code>*</code>，因为<strong>如果响应包含敏感数据或依赖 cookie/凭证（Authorization / session），</strong> <code>*</code> 与 <code>Access-Control-Allow-Credentials: true</code> 不能同用，浏览器也会拒绝这种组合，属于安全漏洞 ⚠️。（篇幅有限，更多细节见下篇文章。）</p>
</blockquote>
</li>
<li><code>Access-Control-Allow-Methods</code>：允许的方法（GET, POST, PUT...）。</li>
<li><code>Access-Control-Allow-Headers</code>：允许的自定义 Header（如 <code>Authorization, X-Custom-Header</code>）。</li>
<li><code>Access-Control-Allow-Credentials</code>：是否允许带 cookie/凭证（<code>true</code> 表示允许）。</li>
<li><code>Access-Control-Expose-Headers</code>：允许前端访问的响应头。</li>
<li><code>Access-Control-Max-Age</code>：预检（preflight）结果缓存时长（秒）。
<blockquote>
<p>预检请求（preflight）：当请求使用了非“简单请求”方法或自定义了 header、或 <code>Content-Type</code> 非简单类型时，浏览器会先发 <code>OPTIONS</code> 请求询问服务器是否允许。</p>
</blockquote>
</li>
</ul>
<h2 data-id="heading-2">常见解决方案</h2>
<h3 data-id="heading-3">方案 A — 在服务端正确配置 CORS</h3>
<p>这是最通用也最推荐的做法：​<strong>在响应里返回正确的 CORS 头</strong>​。</p>
<h4 data-id="heading-4">Express（Node）示例（使用 <code>cors</code> 中间件）</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-keyword">const</span> cors = <span class="hljs-built_in">require</span>(<span class="hljs-string">'cors'</span>)
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>()

app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cors</span>({
  <span class="hljs-attr">origin</span>: <span class="hljs-string">'https://app.example.com'</span>, <span class="hljs-comment">// 注意不能用 '*' 配合 credentials</span>
  <span class="hljs-attr">methods</span>: [<span class="hljs-string">'GET'</span>,<span class="hljs-string">'POST'</span>,<span class="hljs-string">'PUT'</span>,<span class="hljs-string">'DELETE'</span>,<span class="hljs-string">'OPTIONS'</span>],
  <span class="hljs-attr">credentials</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 允许 cookie</span>
  <span class="hljs-attr">allowedHeaders</span>: [<span class="hljs-string">'Content-Type'</span>,<span class="hljs-string">'Authorization'</span>,<span class="hljs-string">'X-Requested-With'</span>]
}));
</code></pre>
<h4 data-id="heading-5">Nginx：把 CORS header 加到响应上</h4>
<pre><code class="hljs language-Nginx" lang="Nginx">location /api/ {
  if ($request_method = 'OPTIONS') {
    add_header 'Access-Control-Allow-Origin' 'https://app.example.com';
    add_header 'Access-Control-Allow-Methods' 'GET,POST,OPTIONS,PUT,DELETE';
    add_header 'Access-Control-Allow-Headers' 'Authorization,Content-Type';
    add_header 'Access-Control-Allow-Credentials' 'true';
    add_header 'Access-Control-Max-Age' 1728000;
    add_header 'Content-Length' 0;
    add_header 'Content-Type' 'text/plain charset=UTF-8';
    return 204;
  }

  proxy_pass http://backend;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  # 把 header 添加到后端响应
  proxy_hide_header 'Access-Control-Allow-Origin';
  add_header 'Access-Control-Allow-Origin' 'https://app.example.com';
  add_header 'Access-Control-Allow-Credentials' 'true';
}
</code></pre>
<h3 data-id="heading-6">方案 B — 前端代理到同源（仅开发阶段）</h3>
<p>开发阶段或没有后端权限时使用我们经常使用构建工具的 dev server 实现反向代理。把跨域请求代理到本地 dev server（同源），由 dev server 转发到目标服务器。</p>
<h4 data-id="heading-7">Vite dev server 配置</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'https://api.example.com'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function"><span class="hljs-params">path</span> =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^\/api/</span>, <span class="hljs-string">''</span>)
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-8">方案 C — Nginx 反向代理（生产阶段常用）</h3>
<p>这也是生产环境下的常用方案。在 Nginx 等反向代理层统一转发，前端调用同域（Nginx），Nginx 代理后再与后端跨域通信。</p>
<blockquote>
<p>前端请求：<code>https://app.example.com/api/...</code>（同源） Nginx proxy_pass -&gt; <code>https://api.example.com/...</code>。</p>
</blockquote>
<pre><code class="hljs language-Bash" lang="Bash">server {
    listen 80;
    server_name example.com;

    <span class="hljs-comment"># 静态资源代理</span>
    location /static/ {
        root /project/static;
        index index.html index.html; <span class="hljs-comment"># 访问 /static/ 会自动“重定向”到 /project/static/index.html 文件</span>
    }

    <span class="hljs-comment"># API代理</span>
    location /api/ {
        rewrite ^/api/(.*)$ /<span class="hljs-variable">$1</span> <span class="hljs-built_in">break</span>; <span class="hljs-comment"># 如果服务器没有 /api 记得重写</span>
        proxy_pass http://api.example.com; <span class="hljs-comment"># 代理的地址</span>
        
    }
}
</code></pre>
<h3 data-id="heading-9">方案 D — JSONP（已过时，仅限 GET）</h3>
<p>只支持 <code>GET</code>，通过 <code>&lt;script&gt;</code> 标签绕过 SOP，服务端返回 <code>callback(...)</code>，容易被攻击者使用 <code>callback</code> 恶意函数做 XSS 攻击。</p>
<h3 data-id="heading-10">方案 E — postMessage（跨窗口/iframe 场景）</h3>
<p>当需要跨域页面间通信（iframe 和父窗口），使用 <code>window.postMessage</code>。适用于页面间数据交换，不适用于普通 API 请求。我们一般会在微前端、OAuth 第三方登录、单点登录、支付页面回调、WebView 混合开发中使用。</p>
<h3 data-id="heading-11">方案 F — WebSocket（不受 CORS 限制）</h3>
<p>WebSocket 握手不是标准的 CORS；如果用 WS/WSS，浏览器不会因同源限制阻止读取消息（但服务器可能做 origin 校验）。我们也不可能为了跨域强行使用 WebSocket。（之后会详细介绍 HTTP 协议和 WebSocket 协议关系和他们的使用）</p>
<h2 data-id="heading-12">开发时一些坑</h2>
<p>在我刚开始独立从零到一搭建前后端项目的时候（当时还没有什么 AI Coding，全凭一手搜索引擎），这个问题让我红温到晚上一点也没有解决（没错，当时我还很菜 hh）。</p>
<h3 data-id="heading-13">处理带 cookie / 带凭证的跨域请求</h3>
<ol>
<li>服务端：
<ol>
<li><code>Access-Control-Allow-Origin: https://app.example.com</code>（具体 origin，不能是 <code>*</code>）</li>
<li><code>Access-Control-Allow-Credentials: true</code></li>
</ol>
</li>
<li>前端（fetch / xhr）：
<ol>
<li><code>fetch(url, { credentials: 'include' })</code> 或 <code>xhr.withCredentials = true</code></li>
</ol>
</li>
</ol>
<p>​<strong>当时我犯的错误</strong>​：</p>
<ul>
<li>没有设置 <code>credentials: 'include'</code>，浏览器不会发送 cookie。</li>
<li>服务端回送 <code>Access-Control-Allow-Origin: *</code> 与 <code>Allow-Credentials: true</code> 同时存在（浏览器会拒绝）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 3.2震撼发布：5个必知的新特性让你开发效率提升50%]]></title>    <link>https://juejin.cn/post/7572493520003792930</link>    <guid>https://juejin.cn/post/7572493520003792930</guid>    <pubDate>2025-11-16T00:16:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572493520003792930" data-draft-id="7572493520003776546" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 3.2震撼发布：5个必知的新特性让你开发效率提升50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-16T00:16:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT_陈寒"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 3.2震撼发布：5个必知的新特性让你开发效率提升50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT_陈寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T00:16:56.000Z" title="Sun Nov 16 2025 00:16:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Spring Boot 3.2震撼发布：5个必知的新特性让你开发效率提升50%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Spring Boot 3.2的发布无疑是Java生态圈的一大盛事。作为Spring框架的核心项目之一，Spring Boot始终致力于简化企业级应用的开发和部署。本次3.2版本的更新不仅延续了这一传统，更带来了多项突破性的改进和创新。从性能优化到开发体验的提升，从对最新Java特性的支持到与云原生技术的深度整合，Spring Boot 3.2为开发者提供了前所未有的便利和效率。</p>
<p>本文将深入剖析Spring Boot 3.2中最值得关注的5大新特性，这些特性经过精心设计和实践验证，有望将你的开发效率提升50%甚至更高。无论你是Spring Boot的老用户还是刚刚接触这一框架的新手，这些新功能都将为你带来全新的开发体验。</p>
<h2 data-id="heading-2">主体内容</h2>
<h3 data-id="heading-3">1. 虚拟线程(Virtual Threads)的全面支持</h3>
<p><strong>背景与意义：</strong>
随着Java 21的发布，虚拟线程成为了最受瞩目的特性之一。Spring Boot 3.2对虚拟线程提供了开箱即用的支持，这标志着响应式编程之外的另一种高性能并发模型的到来。</p>
<p><strong>技术实现细节：</strong></p>
<ul>
<li>Spring MVC和WebFlux现在都可以配置为使用虚拟线程</li>
<li><code>spring.threads.virtual.enabled=true</code>即可启用全局虚拟线程支持</li>
<li>Tomcat/Jetty等嵌入式服务器已适配虚拟线程模型</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VirtualThreadConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> TomcatProtocolHandlerCustomizer&lt;?&gt; protocolHandlerVirtualThreadExecutorCustomizer() {
        <span class="hljs-keyword">return</span> protocolHandler -&gt; {
            protocolHandler.setExecutor(Executors.newVirtualThreadPerTaskExecutor());
        };
    }
}
</code></pre>
<p><strong>性能优势：</strong></p>
<ul>
<li>与传统平台线程相比，内存占用减少90%</li>
<li>上下文切换开销几乎为零</li>
<li>轻松支持百万级并发连接</li>
</ul>
<p><strong>最佳实践建议：</strong></p>
<ol>
<li>IO密集型应用最适合采用虚拟线程</li>
<li>CPU密集型任务仍需谨慎评估</li>
<li>与传统线程池混合使用时需注意资源隔离</li>
</ol>
<h3 data-id="heading-4">2. CRaC(Coordinated Restore at Checkpoint)的生产就绪支持</h3>
<p><strong>创新价值：</strong>
CRaC技术通过在特定时刻保存JVM状态并快速恢复的能力，彻底改变了Java应用的启动速度问题。</p>
<p><strong>集成方式：</strong></p>
<ul>
<li>Spring Boot自动检测CRaC运行环境</li>
<li><code>ApplicationStartup</code>接口新增CRaC相关事件回调</li>
<li><code>@Checkpoint</code>注解标记关键保存点</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyController</span> {

    <span class="hljs-meta">@Checkpoint</span> <span class="hljs-comment">// JVM将在处理首个请求前创建检查点</span>
    <span class="hljs-meta">@GetMapping("/")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">home</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello from CRaC-enabled app!"</span>;
    }
}
</code></pre>
<p><strong>实测数据对比：</strong></p>




















<table><thead><tr><th/><th>Cold Start</th><th>CRaC恢复</th></tr></thead><tbody><tr><td>Web应用</td><td>3500ms</td><td>&lt;100ms</td></tr><tr><td>Batch作业</td><td>4200ms</td><td>&lt;50ms</td></tr></tbody></table>
<h3 data-id="heading-5">3. Spring AI模块的正式引入</h3>
<p><strong>变革性影响：</strong>
AI功能的集成使Spring应用第一次具备了原生的大模型交互能力。</p>
<p><strong>核心功能组件：</strong></p>
<ul>
<li><code>AiTemplate</code>: AI操作的统一入口模板类</li>
<li><code>EmbeddingClient</code>:向量嵌入生成接口</li>
<li><code>PromptTemplate</code>:提示词模板引擎</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomerSupportService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AiTemplate aiTemplate;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">generateResponse</span><span class="hljs-params">(String query)</span> {
        <span class="hljs-type">Prompt</span> <span class="hljs-variable">prompt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PromptBuilder</span>()
            .withTemplate(<span class="hljs-string">"你是一个专业的客服代表。请回答以下客户问题: {{query}}"</span>)
            .withVariable(<span class="hljs-string">"query"</span>, query)
            .build();
            
        <span class="hljs-keyword">return</span> aiTemplate.generate(prompt).getOutput();
    }
}
</code></pre>
<p><strong>集成生态系统：</strong></p>
<ol>
<li>OpenAI/GPT4默认支持
2.Bedrock(Amazon)、VertexAI(Google)适配器可选
3.HuggingFace本地模型兼容层</li>
</ol>
<h3 data-id="heading-6">4.JDK21特性的深度整合</h3>
<p><strong>语言级改进利用：</strong></p>
<h4 data-id="heading-7">Records模式的自动绑定</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PostMapping("/users")</span>
<span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> UserRecord(
    String username, 
    <span class="hljs-meta">@Email</span> String email,
    <span class="hljs-meta">@Size(min=8)</span> String password)</span> userInput) {
    
    <span class="hljs-comment">// Spring自动解构Record并进行验证  </span>
}
</code></pre>
<h4 data-id="heading-8">switch模式匹配简化逻辑控制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@EventListener</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleEvent</span><span class="hljs-params">(ApplicationEvent event)</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">switch</span>(event) {
        <span class="hljs-keyword">case</span> ContextStartedEvent e -&gt; <span class="hljs-string">"上下文启动"</span>;
        <span class="hljs-keyword">case</span> PayloadApplicationEvent&lt;?&gt;(String payload) -&gt; <span class="hljs-string">"字符串负载:"</span>+payload;
        <span class="hljs-keyword">default</span> -&gt; <span class="hljs-string">"未知事件"</span>;
    };
}
</code></pre>
<h4 data-id="heading-9">sealed接口增强API设计安全边界</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentResult</span> 
    <span class="hljs-keyword">permits</span> Success, Failure, Pending {}
    
<span class="hljs-comment">// Controller中可直接使用密封类型作为返回值    </span>
</code></pre>
<p>###5.GraalVM原生镜像构建的革命性改进</p>
<p><strong>构建过程优化亮点:</strong></p>
<p>1.<strong>内存消耗降低40%</strong>:新的分析算法显著减少构建时内存需求<br/>
2.<strong>构建速度提升60%</strong>:并行化处理和增量编译技术引入<br/>
3.<strong>反射配置自动化</strong>:运行时动态收集取代手动配置</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment">#新版构建命令示例:</span>
./mvnw spring-boot:build-image \
<span class="hljs-attr">-Dspring-boot.aot.enabled</span>=<span class="hljs-literal">true</span> \
<span class="hljs-attr">-Dspring-boot.build-image.pullPolicy</span>=always \
<span class="hljs-attr">-Dspring-boot.build-image.builder</span>=paketobuildpacks/builder-jammy-tiny:latest  
</code></pre>
<p><strong>资源占用对比表:</strong></p>

























<table><thead><tr><th>指标</th><th>传统JAR</th><th>GraalVM原生镜像</th></tr></thead><tbody><tr><td>启动时间</td><td>2500ms</td><td>50ms</td></tr><tr><td>内存占用</td><td>512MB</td><td>64MB</td></tr><tr><td>磁盘空间</td><td>35MB</td><td>22MB</td></tr></tbody></table>
<p>##总结与展望</p>
<p>SpringBoot3.2的这些创新特性不仅仅是简单的版本迭代升级——它们代表了现代Java开发的三个关键方向转型:</p>
<p>1.<strong>性能范式转移</strong>:从单纯依赖硬件扩容转向深度的运行时优化<br/>
2.<strong>开发模式进化</strong>:声明式编程扩展到AI集成领域<br/>
3.<strong>部署形态革新</strong>:云原生特质通过GraalVM达到新高度</p>
<p>对于已经采用微服务架构的企业而言,这些改进意味着可以节省30%-50%的基础设施成本;对于开发者个体来说,生产力提升的效果更加直观可感。</p>
<p>随着2024年的临近,我们有理由相信SpringBoot将继续引领企业级Java开发的潮流方向。这次发布的诸多功能也暗示了未来的发展趋势:更深度的AI集成、更智能的编译器协作以及更彻底的无服务器化支持都已在路线图中清晰可见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae WebGen-solo模式快速完成项目]]></title>    <link>https://juejin.cn/post/7572537221540462607</link>    <guid>https://juejin.cn/post/7572537221540462607</guid>    <pubDate>2025-11-15T23:34:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572537221540462607" data-draft-id="7572537221540446223" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae WebGen-solo模式快速完成项目"/> <meta itemprop="keywords" content="Trae,人工智能,全栈"/> <meta itemprop="datePublished" content="2025-11-15T23:34:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae WebGen-solo模式快速完成项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T23:34:48.000Z" title="Sat Nov 15 2025 23:34:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎯 一、项目目标定义</h2>
<p>名称：<strong>Trae WebGen (Solo Mode)</strong><br/>
任务：</p>
<blockquote>
<p>用户输入一句话，例如<br/>
“帮我生成一个简约的博客首页，有标题、文章预览和底部版权。”<br/>
程序即可自动生成一个HTML文件页面，并在生成区实时预览。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">🧩 二、核心功能模块</h2>
<ol>
<li>
<p><strong>输入解析层（Input Parser）</strong></p>
<ul>
<li>解析自然语言需求</li>
<li>提取关键组件（例如“标题”、“按钮”、“导航栏”、“图文布局”）</li>
</ul>
</li>
<li>
<p><strong>页面模板生成层（Template Engine）</strong></p>
<ul>
<li>基于关键字调用内置模板代码块</li>
<li>动态组合布局结构</li>
<li>自动插入样式（Tailwind-like inline CSS 或自定义生成）</li>
</ul>
</li>
<li>
<p><strong>渲染与导出层</strong></p>
<ul>
<li>在浏览器中实时预览</li>
<li>一键导出 <code>.html</code> 文件</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-2">🛠 三、技术栈与约束</h2>






























<table><thead><tr><th>模块</th><th>技术</th><th>原因</th></tr></thead><tbody><tr><td>UI逻辑</td><td>原生 HTML + JS</td><td>保持轻量、零依赖</td></tr><tr><td>模板引擎</td><td>JS字符串拼接 + JSON模板描述</td><td>快速灵活</td></tr><tr><td>样式系统</td><td>内联CSS生成器</td><td>避免复杂CSS依赖</td></tr><tr><td>时间预算</td><td>1小时</td><td>SOLO模式要求高效极简</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-3">⚙️ 四、开发里程碑</h2>





























<table><thead><tr><th>时间（分钟）</th><th>任务</th></tr></thead><tbody><tr><td>0-10</td><td>初始化HTML界面结构</td></tr><tr><td>10-25</td><td>编写Keyword解析逻辑</td></tr><tr><td>25-45</td><td>构建模板生成引擎</td></tr><tr><td>45-55</td><td>完成实时渲染模块</td></tr><tr><td>55-60</td><td>打包测试与导出功能</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">🚀 五、起始代码（HTML + JS一体）</h2>
<p>下面是一份“可直接运行”的版本：</p>
<blockquote>
<p>打开浏览器后即可直接生成网页结构。</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width,initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Trae WebGen Solo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Segoe UI'</span>, sans-serif; <span class="hljs-attribute">background</span>: <span class="hljs-number">#f8f9fa</span>; <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; }
    <span class="hljs-selector-tag">header</span> { <span class="hljs-attribute">background</span>: <span class="hljs-number">#111</span>; <span class="hljs-attribute">color</span>: white; <span class="hljs-attribute">padding</span>: <span class="hljs-number">1em</span>; <span class="hljs-attribute">text-align</span>: center; }
    <span class="hljs-selector-tag">main</span> { <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">flex-direction</span>: column; <span class="hljs-attribute">align-items</span>: center; <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>; }
    <span class="hljs-selector-tag">textarea</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">80%</span>; <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>; <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>; }
    <span class="hljs-selector-tag">button</span> { <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>; <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">10px</span>; <span class="hljs-attribute">font-weight</span>: bold; <span class="hljs-attribute">cursor</span>: pointer; <span class="hljs-attribute">background</span>: <span class="hljs-number">#007bff</span>; <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>; <span class="hljs-attribute">border</span>: none; <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">5px</span>;}
    <span class="hljs-selector-id">#output</span> { <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>; <span class="hljs-attribute">width</span>: <span class="hljs-number">90%</span>; <span class="hljs-attribute">background</span>: white; <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>; <span class="hljs-attribute">min-height</span>: <span class="hljs-number">200px</span>; }
    <span class="hljs-selector-tag">iframe</span> { <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>; <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>; <span class="hljs-attribute">border</span>: none; <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>; }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">header</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Trae WebGen Solo Mode<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userInput"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入网页需求，例如『生成有标题和文章卡片的博客页』"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"generateWeb()"</span>&gt;</span>生成网页<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"output"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"preview"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-keyword">const</span> templates = {
      <span class="hljs-attr">title</span>: <span class="hljs-function"><span class="hljs-params">txt</span> =&gt;</span> <span class="hljs-string">`&lt;h1 style="text-align:center; font-size:2em; margin-top:20px;"&gt;<span class="hljs-subst">${txt || <span class="hljs-string">'我的网页标题'</span>}</span>&lt;/h1&gt;`</span>,
      <span class="hljs-attr">paragraph</span>: <span class="hljs-function"><span class="hljs-params">txt</span> =&gt;</span> <span class="hljs-string">`&lt;p style="line-height:1.7;"&gt;<span class="hljs-subst">${txt || <span class="hljs-string">'这是一段示例文字。'</span>}</span>&lt;/p&gt;`</span>,
      <span class="hljs-attr">footer</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">`&lt;footer style="text-align:center;padding:10px;background:#222;color:#fff;"&gt;© 2025 Trae WebGen&lt;/footer&gt;`</span>,
      <span class="hljs-attr">article</span>: <span class="hljs-function">(<span class="hljs-params">title, body</span>) =&gt;</span> <span class="hljs-string">`
        &lt;article style="border-bottom:1px solid #ddd;margin:20px 0;padding-bottom:10px;"&gt;
          &lt;h2&gt;<span class="hljs-subst">${title || <span class="hljs-string">'文章标题'</span>}</span>&lt;/h2&gt;
          &lt;p&gt;<span class="hljs-subst">${body || <span class="hljs-string">'这是文章的预览部分……'</span>}</span>&lt;/p&gt;
        &lt;/article&gt;`</span>
    };

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">parseInput</span>(<span class="hljs-params">text</span>) {
      <span class="hljs-keyword">const</span> keywords = [];
      <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/标题/</span>.<span class="hljs-title function_">test</span>(text)) keywords.<span class="hljs-title function_">push</span>(<span class="hljs-string">'title'</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/文章|博客/</span>.<span class="hljs-title function_">test</span>(text)) keywords.<span class="hljs-title function_">push</span>(<span class="hljs-string">'article'</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/段落|介绍|说明/</span>.<span class="hljs-title function_">test</span>(text)) keywords.<span class="hljs-title function_">push</span>(<span class="hljs-string">'paragraph'</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/底部|版权/</span>.<span class="hljs-title function_">test</span>(text)) keywords.<span class="hljs-title function_">push</span>(<span class="hljs-string">'footer'</span>);
      <span class="hljs-keyword">return</span> keywords;
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateHTML</span>(<span class="hljs-params">keywords</span>) {
      <span class="hljs-keyword">let</span> html = <span class="hljs-string">'&lt;section style="max-width:800px;margin:auto;padding:20px;"&gt;'</span>;
      <span class="hljs-keyword">if</span> (keywords.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'title'</span>)) html += templates.<span class="hljs-title function_">title</span>(<span class="hljs-string">'欢迎访问我的网站'</span>);
      <span class="hljs-keyword">if</span> (keywords.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'article'</span>)) {
        html += templates.<span class="hljs-title function_">article</span>(<span class="hljs-string">'第一篇文章'</span>, <span class="hljs-string">'内容预览……'</span>);
        html += templates.<span class="hljs-title function_">article</span>(<span class="hljs-string">'第二篇文章'</span>, <span class="hljs-string">'更多内容正在加载……'</span>);
      }
      <span class="hljs-keyword">if</span> (keywords.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'paragraph'</span>)) html += templates.<span class="hljs-title function_">paragraph</span>(<span class="hljs-string">'本站是由Trae WebGen自动生成。'</span>);
      <span class="hljs-keyword">if</span> (keywords.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'footer'</span>)) html += templates.<span class="hljs-title function_">footer</span>();
      html += <span class="hljs-string">'&lt;/section&gt;'</span>;
      <span class="hljs-keyword">return</span> html;
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateWeb</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> text = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'userInput'</span>).<span class="hljs-property">value</span>;
      <span class="hljs-keyword">const</span> keywords = <span class="hljs-title function_">parseInput</span>(text);
      <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">generateHTML</span>(keywords);
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output'</span>).<span class="hljs-property">textContent</span> = result;

      <span class="hljs-keyword">const</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'preview'</span>);
      <span class="hljs-keyword">const</span> doc = iframe.<span class="hljs-property">contentDocument</span> || iframe.<span class="hljs-property">contentWindow</span>.<span class="hljs-property">document</span>;
      doc.<span class="hljs-title function_">open</span>();
      doc.<span class="hljs-title function_">write</span>(result);
      doc.<span class="hljs-title function_">close</span>();
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<hr/>
<h2 data-id="heading-5">💡 六、玩法扩展（可选）</h2>
<ol>
<li>
<p><strong>加入 AI Prompt 模块</strong></p>
<ul>
<li>可连接 LLM（如本地模型或API）自动推断网页结构关键字。</li>
</ul>
</li>
<li>
<p><strong>保存模板系统</strong></p>
<ul>
<li>用户可“收藏”生成的网页样式片段。</li>
</ul>
</li>
<li>
<p><strong>导出 ZIP 包</strong></p>
<ul>
<li>一键将生成内容打包下载成完整网站项目。</li>
</ul>
</li>
<li>
<p><strong>多人模式（Trae Co-op）</strong></p>
<ul>
<li>不同用户可协同编辑同一页面的构思与生成逻辑。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-6">🧙‍♂️ 七、结语</h2>
<p>Trae SOLO 模式的魔力在于：</p>
<blockquote>
<p>不靠大团队，不拼框架生态，<br/>
只凭你的键盘、直觉和一点点“零信任的勇气”。</p>
</blockquote>
<p>这一小时，你不只是写代码。<br/>
你在 <strong>创造一个懂你语言的网页生成器</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我用 SOLO Coder 做 Excalidraw 开源项目二次开发]]></title>    <link>https://juejin.cn/post/7572697146286735410</link>    <guid>https://juejin.cn/post/7572697146286735410</guid>    <pubDate>2025-11-16T00:17:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572697146286735410" data-draft-id="7572387666979979290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我用 SOLO Coder 做 Excalidraw 开源项目二次开发"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-11-16T00:17:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不惑_"/> <meta itemprop="url" content="https://juejin.cn/user/1471609400466218"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我用 SOLO Coder 做 Excalidraw 开源项目二次开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1471609400466218/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不惑_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-16T00:17:44.000Z" title="Sun Nov 16 2025 00:17:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我总觉得，真正的二次开发不是把功能贴到代码里那么简单，而是要在一个有生命力的开源项目里，摸索出它的气质和脉络，然后把自己的改动像一块合适的木料，打磨到恰好咬合的位置。Excalidraw 正好是那种适合雕琢的项目：接口清晰、结构分明、社区稳健，甚至它的白板本身就鼓励你在上面画来画去。于是我把一个小愿望丢给 SOLO Coder：把文本 → 图形的智能生成做进来，流程图也好，思维导图也罢，最好的结果就是我能在编辑器里写一句话，轻轻一点，就看到图像在面前成形。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44c9372d06e84782bc5118f4f5aad85a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763857063&amp;x-signature=RC5YxC7RVoQcAgqy1bxDgb8PN4M%3D" alt="image.png" loading="lazy"/></p>
<p>这是一篇完整的AI绘图功能二次开发笔记：我用 SOLO Coder 在 Excalidraw 开源项目中增加文本→图形的 AI 能力，支持流程图与思维导图，并在编辑器里直接预览和插入。文章覆盖环境搭建、前后端改造、联调验证、问题处理与可复制的操作步骤，先看效果吧。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccc064be923f4f33aa161ff06c16a3b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763857063&amp;x-signature=RaInPrvxWlWbgdAc6HCl%2F1%2Fj1tE%3D" alt="1114-2.gif" loading="lazy"/></p>
<p>你将获得</p>
<ul>
<li>在主菜单新增AI绘图入口，打开文本转图对话框（TTD）</li>
<li>前端将文本与图类型发送到后端；后端接入豆包（Volcengine Ark）生成 Mermaid 文本</li>
<li>预览区渲染并一键插入到画布；失败时有清洗与兜底策略</li>
</ul>
<p>在此之前，我们已经通过SOLO Coder 部署了本地的Excalidraw，接着要找入口，找一个人走近白板时自然会按下的地方。我把AI绘图放到主菜单里，让它像一个轻微的邀请而不是强制的引导。点击以后，前端抛给我第一个态度不好的报错：<code>setAppState is not a function</code>。两秒钟的心情起伏之后，我意识到是这个问题可以通过AI去解决，于是我把AI产生的问题换个了AI。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5f338985e11406b9860ce6e8fcf6165~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763857063&amp;x-signature=SJLxzCniCWg6aBii2Pvtg3Yj9Bo%3D" alt="image.png" loading="lazy"/>
不难发现，它很快修复了这个问题，Excalidraw 的命令式接口里没有这个方法，应该用 <code>updateScene</code>。把全局事件改成 <code>updateScene({ appState: { openDialog: ... } })</code>，对话框乖乖弹出来，像终于滑到桌面正中间的一杯茶。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ff559656a01476f87b1c4964105393b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763857063&amp;x-signature=QxiB4NbZKEmsniQ%2FAzMthsodwDg%3D" alt="image.png" loading="lazy"/>
这扇窗叫 TTD，对话框的全名是 Text-to-Diagram。也就是 Text-to-Diagram。对话框的形态很友好，左边一个文本框，右边一个预览区，鼠标在文本框里点击一下，那种手指压下去的瞬间，我顺手截了一张图，留作交互起点的标记。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d2a10c0cf9c474eaa863bed731efa38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763857063&amp;x-signature=unYW20bZPrUY%2FyH1AhcX1cZ0HUY%3D" alt="image.png" loading="lazy"/>
第一次按下Generate，我看到的是一片沉默，预览区安静地不动，还给我抛了一个Generated an invalid diagram。我把这个截图也留下，作为一次不太成功的尝试。那会儿我就明白了，这不是没调用，而是调用了，但返回的 Mermaid 文本不合身。思维导图的 Mermaid 语法算是实验性，转换库不是对所有情况都拿得很稳。于是我把后端派上台，搭了一个干净的 ai-backend ，用 Express 做路由，让它站在 excalidraw-master 的旁边，同时悄悄接入豆包（Volcengine Ark）的 Chat Completions，用 .env.local 留住密钥，不往前端暴露，保持整个结构清爽。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2678a90256624a3d928c1cf9c57e0aa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763857063&amp;x-signature=H07Z5HgwuhGmbTnB3mWtOEkwAKM%3D" alt="image.png" loading="lazy"/></p>
<p>后端这边，我直接把豆包API输入个SOLO。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/788f70c912c3481ba51dab0abaf55e2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763857063&amp;x-signature=ryqs5pm7F3UA%2BSSpRI%2B2DI3CE6U%3D" alt="image.png" loading="lazy"/></p>
<p>这里有详解的API文档：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a761f7773fc40099239adccf93a0852~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763857063&amp;x-signature=pZg82gVjaAonuZXXlMvFp284wM4%3D" alt="image.png" loading="lazy"/></p>
<p>接下来会新建一个 <code>ai-backend</code>，让它站在主项目的旁侧，单纯、安静，读 <code>.env.local</code> 里的密钥，不把任何敏感信息暴露到前端，也不往仓库里乱提交。路由只做一件事：<code>/v1/ai/text-to-diagram/generate</code> 接受 <code>prompt</code> 和 <code>type</code>，优先调用豆包 Ark Chat Completions，把返回的内容清洗一下。</p>
<p>我很在意交互的微妙。TTD 对话框里那段英文提示，说系统目前用 Mermaid 当中间步骤，这句话像一个前置的协议：你要么给我流程、要么给我结构，我来想办法帮你成长为图像。用户写的是人话，模型理解的是人话，但预览需要的是规整的语言。所以我把类型的选择前置到生成动作的上方，让这组 UI 形成一个心智链条：输入、选择、生成、预览、插入。你能感到手势的顺畅，能看到预期的结果，这比任何文档提示都有效。</p>
<p>过程中有一些次要的插曲，比如浏览器标签意外打开旧端口 3000，所以事件监听并没有注册到你看的页面上；比如我一度尝试用 <code>window.addEventListener</code> 做一些全局控制，后来还是把它规整到 <code>useEffect</code>，跟着 <code>excalidrawAPI</code> 走生命周期；比如Mermaid 原文那一页会让人想查看细节，我就保留了View as Mermaid的跳转，给调试者一个后备的工具。每一个小动作都不是必须，但它们是贴心，我希望这套体验不是硬塞进去的功能，而是一种自然的延伸。</p>
<p>豆包的接入自己也带了一点个性。我把密钥放在本地 <code>.env.local</code> 里，不在代码里落笔，也不在终端里写长串的临时变量。模型的参数没有走极端，<code>max_completion_tokens</code> 设个温和的上限，<code>reasoning_effort</code> 放在中等，确保稳定和成本可控。有时为了让预览稳定，我会把 Mindmap 的生成提示悄悄引导成 Flowchart 的层级表达，毕竟转换链路对流程图更友好，这不是背叛，更像是一个实用主义的选择。用户要的是看到结构并可编辑的图形，图的样式可以慢慢打磨，但空白的预览等不及。</p>
<p>这时候整条链路开始有了握手的感觉。我在首页截图之后，又截了一个主菜单展开的画面，那里有AI绘图这个新朋友。我点开对话框，在文本框里敲了一段结构——比如把项目规划放在首行，然后用短句把目标范围时间资源团队预算一行一行列出来，然后按下Generate。这回预览区不再冷场，图像从右边长出来，节点紧紧排列，像把散落的书页用线穿在一起。我让它落到画布中央，放大一点，给这个时刻留一张干净的截图。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06827f2c5b5f47cea490247124f5e17a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763857063&amp;x-signature=4bEMWKimkbIA9yfzYrI7EG5AcW0%3D" alt="image.png" loading="lazy"/></p>
<p>接下来点击Insert按钮，就可以将内容插入到画布中。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6508bd6916cc41dbb9b238748e363c0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5oORXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763857063&amp;x-signature=vbRCSy2zV9VNECpx1p1IKCLSYKs%3D" alt="image.png" loading="lazy"/></p>
<p>偶尔，它还会闹些情绪。比如你输入了太长的一段话，没有清晰的结构，它会再次用Generated an invalid diagram提醒你，语气像朋友。这个时候，不要把锅丢给模型，稍微调整一下文本，把主题放在第一行，把一级要点一行一个，风格更像大纲，再按一下生成。它会给你面子，预览就出来了。如果你想更确定一点，把右上角的类型切到 Flowchart，它几乎不会让你失望。</p>
<p>写到这里，我开始觉得这件事并不只是给项目加了一个AI功能。它更像是让一个成熟的工具，学会听另一种语言。Excalidraw 原本鼓励你用手去画，现在它也可以理解你说画一个这样的结构。TTD 对话框不是魔法，它只是一个理性的桥梁，把人的表达连接到图的表达，帮你跨过去。SOLO Coder 在这件事上扮演的角色，是把那些易碎的衔接点，替你稳稳地固定住。下载、安装、起服务、修事件、接模型、清文本、兜底，这些看起来像是工程细节，但它们构成了整个体验的实感。</p>
<p>如果你问我，SOLO Coder 在这件事里做了什么，我想说它并没有替我写掉所有代码，但它帮我把那条从下载到看见的路径铺平了。在本地拉起项目，协调工作区依赖、启动 Vite，修好入口事件，把后端服务跑起来，豆包的密钥藏在 .env.local ，调用链条串上去，预览链条又稳住，再给这条路放几个路标，这些工作听起来不起眼，却让一切变得顺畅。二次开发真正的魅力在于此：你不是把自己的想法贴上去，而是把它揉进来，跟项目的语言在一起，跟它的节奏在一起。</p>
<p>我把这篇文章写成一段连续的叙事，不讲首先、其次、最后，不做报告那样堆观点。我只是把自己的实操摊开，让那些按键、链接、路径、拐角、错误和修复全都在地上，带着你走过一次。等你走完，你会发现你也能这样，把一个想法交给 SOLO Coder，给它一个被验证的出口，只要你愿意在中间补上一点点耐心，这条路会变得像一条平整的木板道，踩上去不会发出吱嘎的声响。这个项目于是有了一个新习惯：不仅用手画，还能用话画。图像不再需要你去一个个摆放，它可以按照你的文字，自己站在画布上。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（126） Redis在实时统计中的应用有哪些？]]></title>    <link>https://juejin.cn/post/7572497847771693083</link>    <guid>https://juejin.cn/post/7572497847771693083</guid>    <pubDate>2025-11-15T23:33:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572497847771693083" data-draft-id="7572510909446291506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（126） Redis在实时统计中的应用有哪些？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-15T23:33:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（126） Redis在实时统计中的应用有哪些？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T23:33:23.000Z" title="Sat Nov 15 2025 23:33:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis 在实时统计中的应用非常广泛，主要用于以下几个场景：页面访问量统计、用户行为分析、计数器、数据采样、实时数据聚合等。下面详细描述这些应用场景，并结合 Java 代码示例进行讲解。</p>
<h3 data-id="heading-0">1. 页面访问量统计</h3>
<p>Redis 可以用于统计页面的访问量，通过使用 Redis 的自增操作，可以快速记录页面的访问次数。</p>
<h4 data-id="heading-1">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PageViewCounter</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">pageKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"page:home"</span>;
            
            <span class="hljs-comment">// 增加页面访问量</span>
            jedis.incr(pageKey);
            
            <span class="hljs-comment">// 获取当前页面访问量</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">pageViews</span> <span class="hljs-operator">=</span> jedis.get(pageKey);
            System.out.println(<span class="hljs-string">"Home page views: "</span> + pageViews);
        }
    }
}
</code></pre>
<h3 data-id="heading-2">2. 用户行为分析</h3>
<p>Redis 可以记录用户的各种行为（例如登录、点击、购买等），并进行实时分析。</p>
<h4 data-id="heading-3">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserBehaviorTracker</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user123"</span>;
            <span class="hljs-type">String</span> <span class="hljs-variable">behaviorKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"behavior:"</span> + userId;
            
            <span class="hljs-comment">// 记录用户行为</span>
            jedis.hincrBy(behaviorKey, <span class="hljs-string">"login"</span>, <span class="hljs-number">1</span>);
            jedis.hincrBy(behaviorKey, <span class="hljs-string">"click"</span>, <span class="hljs-number">5</span>);
            jedis.hincrBy(behaviorKey, <span class="hljs-string">"purchase"</span>, <span class="hljs-number">2</span>);
            
            <span class="hljs-comment">// 获取用户行为统计</span>
            System.out.println(<span class="hljs-string">"User behavior: "</span> + jedis.hgetAll(behaviorKey));
        }
    }
}
</code></pre>
<h3 data-id="heading-4">3. 计数器</h3>
<p>Redis 的自增操作非常适合用于实现各种计数器，例如网站的访问量、商品销售量等。</p>
<h4 data-id="heading-5">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GenericCounter</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">counterKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"counter:generic"</span>;
            
            <span class="hljs-comment">// 自增计数器</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> jedis.incr(counterKey);
            System.out.println(<span class="hljs-string">"Current count: "</span> + count);
        }
    }
}
</code></pre>
<h3 data-id="heading-6">4. 数据采样</h3>
<p>Redis 可以用于存储和分析实时数据样本，例如记录每分钟的访问量，以便后续进行统计分析。</p>
<h4 data-id="heading-7">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> java.time.Instant;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSampling</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">sampleKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"samples:pageviews"</span>;
            <span class="hljs-type">long</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> Instant.now().getEpochSecond();
            
            <span class="hljs-comment">// 记录当前时间戳的访问量</span>
            jedis.zadd(sampleKey, timestamp, String.valueOf(timestamp));
            
            <span class="hljs-comment">// 获取最近一分钟的访问量</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">oneMinuteAgo</span> <span class="hljs-operator">=</span> timestamp - <span class="hljs-number">60</span>;
            <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> jedis.zcount(sampleKey, oneMinuteAgo, timestamp);
            System.out.println(<span class="hljs-string">"Page views in the last minute: "</span> + count);
        }
    }
}
</code></pre>
<h3 data-id="heading-8">5. 实时数据聚合</h3>
<p>通过 Redis 的 Hash 数据结构，可以实现对多种数据的聚合统计，例如统计多个服务器的 CPU 负载、内存使用等。</p>
<h4 data-id="heading-9">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RealTimeAggregation</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">aggregationKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"aggregation:cpu_load"</span>;
            
            <span class="hljs-comment">// 模拟记录不同服务器的 CPU 负载</span>
            jedis.hincrByFloat(aggregationKey, <span class="hljs-string">"server1"</span>, <span class="hljs-number">20.5</span>);
            jedis.hincrByFloat(aggregationKey, <span class="hljs-string">"server2"</span>, <span class="hljs-number">30.2</span>);
            jedis.hincrByFloat(aggregationKey, <span class="hljs-string">"server3"</span>, <span class="hljs-number">25.1</span>);
            
            <span class="hljs-comment">// 获取聚合结果</span>
            System.out.println(<span class="hljs-string">"CPU Load: "</span> + jedis.hgetAll(aggregationKey));
        }
    }
}
</code></pre>
<h3 data-id="heading-10">6. 实时用户在线统计</h3>
<p>利用 Redis 的 Set 数据结构，可以统计当前在线用户数，并进行实时查询。</p>
<h4 data-id="heading-11">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OnlineUserCounter</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">onlineUsersKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"users:online"</span>;
            <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user123"</span>;
            
            <span class="hljs-comment">// 用户上线</span>
            jedis.sadd(onlineUsersKey, userId);
            
            <span class="hljs-comment">// 获取当前在线用户数</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">onlineCount</span> <span class="hljs-operator">=</span> jedis.scard(onlineUsersKey);
            System.out.println(<span class="hljs-string">"Current online users: "</span> + onlineCount);
            
            <span class="hljs-comment">// 用户下线</span>
            jedis.srem(onlineUsersKey, userId);
            
            <span class="hljs-comment">// 获取当前在线用户数</span>
            onlineCount = jedis.scard(onlineUsersKey);
            System.out.println(<span class="hljs-string">"Current online users after logout: "</span> + onlineCount);
        }
    }
}
</code></pre>
<p>Redis 的高性能和丰富的数据结构使其成为实时统计应用的理想选择。通过这些示例代码，可以看到 Redis 在页面访问量统计、用户行为分析、计数器、数据采样、实时数据聚合以及实时用户在线统计等方面的强大功能。希望这些示例能够帮助您更好地理解和应用 Redis 于实时统计场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis（127）Redis的内部数据结构是什么？]]></title>    <link>https://juejin.cn/post/7572781559766646834</link>    <guid>https://juejin.cn/post/7572781559766646834</guid>    <pubDate>2025-11-15T23:34:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572781559766646834" data-draft-id="7572515402796204082" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis（127）Redis的内部数据结构是什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-15T23:34:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis（127）Redis的内部数据结构是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T23:34:20.000Z" title="Sat Nov 15 2025 23:34:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis 是一个高性能的内存数据库，其底层实现依赖于多种数据结构。这些数据结构不仅决定了 Redis 的高性能，也使得 Redis 在处理不同类型的数据时能够保持高效。下面详细介绍 Redis 的内部数据结构，并结合具体代码示例进行解释。</p>
<h3 data-id="heading-0">1. 字符串（String）</h3>
<p>字符串是 Redis 中最基本的数据类型。它不仅可以存储文本，还可以存储二进制数据，如图像或序列化对象。</p>
<h4 data-id="heading-1">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisStringExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-comment">// 设置字符串键值</span>
            jedis.set(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
            
            <span class="hljs-comment">// 获取字符串键值</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">"key"</span>);
            System.out.println(<span class="hljs-string">"Stored string in redis: "</span> + value);
        }
    }
}
</code></pre>
<h3 data-id="heading-2">2. 哈希（Hash）</h3>
<p>哈希类型是一个键值对集合，类似于 Java 的 <code>HashMap</code>。哈希特别适合存储对象。</p>
<h4 data-id="heading-3">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisHashExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">userKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:1000"</span>;
            
            <span class="hljs-comment">// 设置哈希字段</span>
            jedis.hset(userKey, <span class="hljs-string">"name"</span>, <span class="hljs-string">"John"</span>);
            jedis.hset(userKey, <span class="hljs-string">"age"</span>, <span class="hljs-string">"30"</span>);
            
            <span class="hljs-comment">// 获取哈希字段</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> jedis.hget(userKey, <span class="hljs-string">"name"</span>);
            <span class="hljs-type">String</span> <span class="hljs-variable">age</span> <span class="hljs-operator">=</span> jedis.hget(userKey, <span class="hljs-string">"age"</span>);
            
            System.out.println(<span class="hljs-string">"Name: "</span> + name);
            System.out.println(<span class="hljs-string">"Age: "</span> + age);
        }
    }
}
</code></pre>
<h3 data-id="heading-4">3. 列表（List）</h3>
<p>列表是一个有序的字符串列表，可以从列表的两端进行压入和弹出操作，类似于 LinkedList。</p>
<h4 data-id="heading-5">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisListExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">listKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"taskQueue"</span>;
            
            <span class="hljs-comment">// 从列表左侧压入</span>
            jedis.lpush(listKey, <span class="hljs-string">"Task1"</span>, <span class="hljs-string">"Task2"</span>, <span class="hljs-string">"Task3"</span>);
            
            <span class="hljs-comment">// 从列表右侧弹出</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> jedis.rpop(listKey);
            System.out.println(<span class="hljs-string">"Popped task: "</span> + task);
            
            <span class="hljs-comment">// 获取列表所有元素</span>
            System.out.println(<span class="hljs-string">"Remaining tasks: "</span> + jedis.lrange(listKey, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>));
        }
    }
}
</code></pre>
<h3 data-id="heading-6">4. 集合（Set）</h3>
<p>集合是一个无序的字符串集合，用于高效地进行添加、删除和查找操作。</p>
<h4 data-id="heading-7">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisSetExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">setKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"userRoles"</span>;
            
            <span class="hljs-comment">// 添加集合元素</span>
            jedis.sadd(setKey, <span class="hljs-string">"admin"</span>, <span class="hljs-string">"editor"</span>, <span class="hljs-string">"viewer"</span>);
            
            <span class="hljs-comment">// 获取集合所有元素</span>
            System.out.println(<span class="hljs-string">"User roles: "</span> + jedis.smembers(setKey));
            
            <span class="hljs-comment">// 判断元素是否存在</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isAdmin</span> <span class="hljs-operator">=</span> jedis.sismember(setKey, <span class="hljs-string">"admin"</span>);
            System.out.println(<span class="hljs-string">"Is admin: "</span> + isAdmin);
        }
    }
}
</code></pre>
<h3 data-id="heading-8">5. 有序集合（Sorted Set）</h3>
<p>有序集合是一个带有分数的字符串集合，集合中的元素按分数进行排序，适用于实现排行榜等功能。</p>
<h4 data-id="heading-9">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisSortedSetExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">sortedSetKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"leaderboard"</span>;
            
            <span class="hljs-comment">// 添加有序集合元素</span>
            jedis.zadd(sortedSetKey, <span class="hljs-number">100</span>, <span class="hljs-string">"user1"</span>);
            jedis.zadd(sortedSetKey, <span class="hljs-number">200</span>, <span class="hljs-string">"user2"</span>);
            jedis.zadd(sortedSetKey, <span class="hljs-number">150</span>, <span class="hljs-string">"user3"</span>);
            
            <span class="hljs-comment">// 获取有序集合元素</span>
            System.out.println(<span class="hljs-string">"Leaderboard: "</span> + jedis.zrevrangeWithScores(sortedSetKey, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>));
        }
    }
}
</code></pre>
<h3 data-id="heading-10">6. 位图（Bitmap）</h3>
<p>位图是一种特殊类型的字符串，可以对字符串中的单个位进行操作，适用于实现布隆过滤器等功能。</p>
<h4 data-id="heading-11">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisBitmapExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">bitmapKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:active"</span>;
            
            <span class="hljs-comment">// 设置某个位为1</span>
            jedis.setbit(bitmapKey, <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>);
            jedis.setbit(bitmapKey, <span class="hljs-number">3</span>, <span class="hljs-literal">true</span>);
            
            <span class="hljs-comment">// 获取某个位的值</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isActive</span> <span class="hljs-operator">=</span> jedis.getbit(bitmapKey, <span class="hljs-number">1</span>);
            System.out.println(<span class="hljs-string">"User is active at position 1: "</span> + isActive);
            
            <span class="hljs-comment">// 统计位图中值为1的位数</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">activeUserCount</span> <span class="hljs-operator">=</span> jedis.bitcount(bitmapKey);
            System.out.println(<span class="hljs-string">"Active user count: "</span> + activeUserCount);
        }
    }
}
</code></pre>
<h3 data-id="heading-12">7. HyperLogLog</h3>
<p>HyperLogLog 是一种用于基数估算的概率性数据结构，适用于大规模去重计数。</p>
<h4 data-id="heading-13">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisHyperLogLogExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">hllKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"uniqueVisitors"</span>;
            
            <span class="hljs-comment">// 添加元素</span>
            jedis.pfadd(hllKey, <span class="hljs-string">"user1"</span>, <span class="hljs-string">"user2"</span>, <span class="hljs-string">"user3"</span>, <span class="hljs-string">"user2"</span>);
            
            <span class="hljs-comment">// 估算基数</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">uniqueCount</span> <span class="hljs-operator">=</span> jedis.pfcount(hllKey);
            System.out.println(<span class="hljs-string">"Unique visitors: "</span> + uniqueCount);
        }
    }
}
</code></pre>
<h3 data-id="heading-14">8. 流（Stream）</h3>
<p>流是 Redis 5.0 引入的数据结构，适用于处理日志和消息队列。</p>
<h4 data-id="heading-15">示例代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> redis.clients.jedis.StreamEntryID;

<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisStreamExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">6379</span>)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">streamKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"mystream"</span>;
            
            <span class="hljs-comment">// 添加流元素</span>
            Map&lt;String, String&gt; entry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            entry.put(<span class="hljs-string">"name"</span>, <span class="hljs-string">"Alice"</span>);
            entry.put(<span class="hljs-string">"message"</span>, <span class="hljs-string">"Hello, World!"</span>);
            jedis.xadd(streamKey, StreamEntryID.NEW_ENTRY, entry);
            
            <span class="hljs-comment">// 读取流元素</span>
            List&lt;Map.Entry&lt;String, List&lt;StreamEntry&gt;&gt;&gt; streamEntries = jedis.xread(StreamEntryID.UNRECEIVED_ENTRY, streamKey);
            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, List&lt;StreamEntry&gt;&gt; streamEntry : streamEntries) {
                System.out.println(<span class="hljs-string">"Stream: "</span> + streamEntry.getKey());
                <span class="hljs-keyword">for</span> (StreamEntry entry : streamEntry.getValue()) {
                    System.out.println(<span class="hljs-string">"Entry ID: "</span> + entry.getID());
                    System.out.println(<span class="hljs-string">"Fields: "</span> + entry.getFields());
                }
            }
        }
    }
}
</code></pre>
<p>上述代码展示了 Redis 中几种主要数据结构的使用示例。每种数据结构都有其特定的用途和优势，可以根据具体需求选择合适的数据结构来实现高效的数据存储和操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[零信任架构下的 WebAIGC 服务安全技术升级方向]]></title>    <link>https://juejin.cn/post/7572534419879673891</link>    <guid>https://juejin.cn/post/7572534419879673891</guid>    <pubDate>2025-11-15T23:29:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572534419879673891" data-draft-id="7572714389942353972" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="零信任架构下的 WebAIGC 服务安全技术升级方向"/> <meta itemprop="keywords" content="Trae,人工智能,前端"/> <meta itemprop="datePublished" content="2025-11-15T23:29:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            零信任架构下的 WebAIGC 服务安全技术升级方向
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T23:29:46.000Z" title="Sat Nov 15 2025 23:29:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：我们已不再“相信”一切</h2>
<p>在互联网江湖的旧时代，安全防线的哲学像是一座古城门：</p>
<blockquote>
<p>“只要进了城，全是自己人；只要在外面，全是坏人。”</p>
</blockquote>
<p>这种“城内无敌”的逻辑简单粗暴，但当我们的 <strong>应用、用户和AI模型</strong> 分散到全球各地的云端节点上时，城门的概念变得像《三体》的面壁计划——看似防御，实则透明。</p>
<p>于是，新时代的口号变成了：</p>
<blockquote>
<p><strong>零信任（Zero Trust）——默认无信任，一切验证重启。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-1">一、零信任理念的内核哲学</h2>
<p>如果把计算系统比作一个社会，那么“零信任”就像是一个反乌托邦的理性国度：</p>
<ul>
<li>公民（用户、应用、设备）每次出门（网络访问）都要身份证明。</li>
<li>证件通过多层验证（身份认证、多因素验证、行为分析）。</li>
<li>警察系统（安全策略引擎）实时监控是否有异常举动。</li>
</ul>
<p>在计算的世界里，这意味着：</p>

























<table><thead><tr><th>传统安全模型</th><th>零信任模型</th></tr></thead><tbody><tr><td>先信任、后验证</td><td>永不信任、持续验证</td></tr><tr><td>网络边界保护</td><td>动态身份和上下文驱动</td></tr><tr><td>静态访问控制</td><td>细粒度策略、自适应访问</td></tr><tr><td>内网=安全区</td><td>内网=潜在威胁源</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-2">二、WebAIGC 的新安全痛点</h2>
<p>当 AIGC（AI Generated Content） 走向 Web 化，安全问题变得前所未有地“元”：</p>
<ol>
<li><strong>Prompt 注入攻击</strong>：<br/>
攻击者像给AI喂了一颗“邪念种子”，让它自我篡改输出逻辑。</li>
<li><strong>模型窃取与越权调用</strong>：<br/>
改改请求头也许就能访问另一位用户的定制模型接口，犹如偷别人魔法卷轴。</li>
<li><strong>数据投毒</strong>：<br/>
训练集被混入恶意数据，AI像读了错误的《资治通鉴》。</li>
<li><strong>生成内容滥用</strong>：<br/>
AI生成可能被用于诈骗、钓鱼或虚假宣传，防护需要“语义级”安全分析。</li>
</ol>
<hr/>
<h2 data-id="heading-3">三、零信任架构下的安全技术升级方向</h2>
<h3 data-id="heading-4">1. <strong>身份无边界化认证</strong></h3>
<p>传统的 OAuth2、JWT 已经是老兵，但在零信任下，我们要做到：</p>
<ul>
<li>每次 API 访问皆需 <strong>实时身份验证</strong>；</li>
<li>引入 <strong>动态上下文标签</strong>（设备指纹、地理位置、访问时间段）；</li>
<li>实现“信任滑动窗口”：信任不是一次认证，而是个不断衰减的函数。</li>
</ul>
<blockquote>
<p>就像喝咖啡提神，时间一久就得再来一杯。</p>
</blockquote>
<p><strong>示例：动态令牌签发机制（JS伪代码）</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">issueDynamicToken</span>(<span class="hljs-params">userContext</span>) </span>{
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">trustScore</span> = <span class="hljs-title function_ invoke__">calculateTrust</span>(userContext); <span class="hljs-comment">// 基于设备、地理、历史行为</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">expireTime</span> = trustScore &gt; <span class="hljs-number">80</span> ? <span class="hljs-number">10</span> * <span class="hljs-number">60</span> : <span class="hljs-number">3</span> * <span class="hljs-number">60</span>; <span class="hljs-comment">// 高可信缩短寿命，防滥用</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">token</span> = <span class="hljs-title function_ invoke__">signToken</span>({
    <span class="hljs-attr">uid</span>: userContext.id,
    <span class="hljs-attr">trust</span>: trustScore,
    <span class="hljs-attr">exp</span>: Date.<span class="hljs-title function_ invoke__">now</span>() + expireTime * <span class="hljs-number">1000</span>
  });
  <span class="hljs-keyword">return</span> token;
}
</code></pre>
<hr/>
<h3 data-id="heading-5">2. <strong>多层策略管控（Policy-as-Code）</strong></h3>
<p>人类安全团队太慢，AI时代的防御要“自动长牙”：</p>
<ul>
<li>策略以代码形式声明（JSON/YAML/JS 表达式）。</li>
<li>实时计算“是否允许访问、允许生成或调用模型”。</li>
<li>安全团队不再发布文档，而是直接发布“安全逻辑模块”。</li>
</ul>
<p><strong>示例：智能策略检查</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">policyCheck</span>(<span class="hljs-params">request, userContext</span>) {
  <span class="hljs-keyword">const</span> rules = [
    { <span class="hljs-attr">condition</span>: userContext.<span class="hljs-property">trust</span> &lt; <span class="hljs-number">50</span>, <span class="hljs-attr">action</span>: <span class="hljs-string">'deny'</span>, <span class="hljs-attr">reason</span>: <span class="hljs-string">'Low Trust'</span> },
    { <span class="hljs-attr">condition</span>: request.<span class="hljs-property">endpoint</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/admin'</span>), <span class="hljs-attr">role</span>: <span class="hljs-string">'Admin'</span> },
    { <span class="hljs-attr">condition</span>: <span class="hljs-regexp">/forbidden|jailbreak/i</span>.<span class="hljs-title function_">test</span>(request.<span class="hljs-property">input</span>), <span class="hljs-attr">action</span>: <span class="hljs-string">'sanitize'</span> }
  ];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> rule <span class="hljs-keyword">of</span> rules) {
    <span class="hljs-keyword">if</span> (evalRule(rule.<span class="hljs-property">condition</span>, request, userContext)) {
      <span class="hljs-keyword">return</span> rule.<span class="hljs-property">action</span> || <span class="hljs-string">'allow'</span>;
    }
  }
}
</code></pre>
<blockquote>
<p>这就像一位“数字质检员”，每次AI发言前都被询问：“你确定你该说这个吗？”</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">3. <strong>内容级防御与语义审计</strong></h3>
<p>在 AIGC 环境中，信息流不是字节流，而是“意义流”。<br/>
安全控制必须具备语义理解：</p>
<ul>
<li>启用 <strong>内容过滤模型</strong>：检测滥用、敏感表达、数据泄露。</li>
<li>对生成请求进行“意图分析”，检测越权提示词。</li>
<li>利用 <strong>Embedding 相似度防御</strong>：防止隐藏式攻击，比如利用语义重写绕过规则。</li>
</ul>
<hr/>
<h3 data-id="heading-7">4. <strong>模型级防护与访问水印</strong></h3>
<p>未来，模型不仅需要“防御输入”，还需要“证明自己”：</p>
<ul>
<li><strong>模型水印</strong>：在输出中嵌入可验证的数学特征，用于溯源。</li>
<li><strong>多重调用剪裁</strong>：限制参数规模、防滥用大模型计算资源。</li>
<li><strong>可验证执行环境（VEE）</strong> ：确保模型权重和运行逻辑未被篡改。</li>
</ul>
<blockquote>
<p>简单说，就是让AI也装上防盗门，还带GPS定位。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">四、WebAIGC 的安全升级路线图</h2>



































<table><thead><tr><th>阶段</th><th>目标</th><th>技术手段</th></tr></thead><tbody><tr><td><strong>阶段1</strong></td><td>基础身份安全</td><td>MFA、动态令牌、API网关验证</td></tr><tr><td><strong>阶段2</strong></td><td>策略自动化</td><td>Policy-as-Code、行为检测引擎</td></tr><tr><td><strong>阶段3</strong></td><td>内容级防御</td><td>Prompt分析、生成语义审计</td></tr><tr><td><strong>阶段4</strong></td><td>可验证AI</td><td>模型水印、可信执行环境</td></tr><tr><td><strong>阶段5</strong></td><td>自适应零信任AI</td><td>AI管AI的自主安全治理系统</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-9">五、结语：信任之死，智能之生</h2>
<p>零信任不是“不信任”，而是 <strong>将信任的定义拿回科学世界</strong>。<br/>
在 AIGC 时代，安全边界模糊，人机协作密切，我们要让系统像詹姆斯·邦德一样理智，又像庄子一样清醒。</p>
<blockquote>
<p><strong>真正的安全，不是筑墙，而是让系统学会怀疑。</strong></p>
</blockquote>
<hr/>
<p><em>少一点盲目信任，多一份计算的怀疑。<br/>
在零信任的世界里，AI才会真的自由。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[REST API 与前后端交互：让应用真正跑起来]]></title>    <link>https://juejin.cn/post/7572781559766548530</link>    <guid>https://juejin.cn/post/7572781559766548530</guid>    <pubDate>2025-11-15T21:48:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572781559766548530" data-draft-id="7572515402796023858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="REST API 与前后端交互：让应用真正跑起来"/> <meta itemprop="keywords" content="后端,Python,IPython"/> <meta itemprop="datePublished" content="2025-11-15T21:48:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            REST API 与前后端交互：让应用真正跑起来
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T21:48:51.000Z" title="Sat Nov 15 2025 21:48:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在现代 Web 开发中，前后端分离已经成为主流。无论你是在做管理后台、小程序、移动 App 还是复杂的 Web 系统，都绕不开一个关键技术：
<strong>REST API</strong>。</p>
</blockquote>
<p>当你能用 Python 写出清晰、规范、易用的 REST API 时，你做的项目就能被各类前端轻松调用，从而具备真正的“互联网应用能力”。</p>
<p>今天我们就聊聊 REST API 是什么、为什么重要、该怎么用 Python 实现，以及前后端之间是如何交互的。</p>
<hr/>
<h2 data-id="heading-0">一、什么是 REST API</h2>
<p>REST 的全称是 Representational State Transfer，是一种轻量级、标准化的接口设计风格。</p>
<p>它不复杂，用一句话概括就是：</p>
<p><strong>使用 URL 表示资源，用 HTTP 方法表达操作。</strong></p>
<p>比如“文章”这个资源：</p>



































<table><thead><tr><th>操作</th><th>方法</th><th>示例 URL</th></tr></thead><tbody><tr><td>获取文章列表</td><td>GET</td><td>/api/articles/</td></tr><tr><td>创建一篇文章</td><td>POST</td><td>/api/articles/</td></tr><tr><td>获取某篇文章详情</td><td>GET</td><td>/api/articles/10/</td></tr><tr><td>更新文章</td><td>PUT</td><td>/api/articles/10/</td></tr><tr><td>删除文章</td><td>DELETE</td><td>/api/articles/10/</td></tr></tbody></table>
<p>这就是 REST 最核心的思想：
<strong>URL 表资源，方法表行为。</strong></p>
<hr/>
<h2 data-id="heading-1">二、REST API 为什么重要</h2>
<p>在前后端分离架构下：</p>
<ul>
<li>前端：负责页面、展示、交互</li>
<li>后端：负责数据、业务逻辑、权限、存储</li>
</ul>
<p>两者通过 API 连接，像这样：</p>
<pre><code class="hljs language-css" lang="css">React / Vue / 小程序 / App  →  <span class="hljs-attribute">REST</span> API  →  Python 后端
</code></pre>
<p>好处非常明确：</p>
<ol>
<li><strong>灵活：一个后端，可以服务多端</strong></li>
<li><strong>解耦：前端改界面不影响后端逻辑</strong></li>
<li><strong>可测试：API 可以用 Postman、curl 测试</strong></li>
<li><strong>标准化：结构清晰，团队协作更容易</strong></li>
</ol>
<p>也就是说，只要你写好 API，应用就能随便接各种前端。</p>
<hr/>
<h2 data-id="heading-2">三、Python 如何实现 REST API</h2>
<p>Python 有很多方式可以创建 REST API，最常用的有：</p>
<ul>
<li><strong>Flask</strong>：轻量灵活</li>
<li><strong>Django REST framework</strong>：强大、企业级</li>
<li><strong>FastAPI</strong>：高性能、现代化（文档好、速度快）</li>
</ul>
<p>下面我们用 Flask 示范一个最简单的 REST API。</p>
<hr/>
<h2 data-id="heading-3">四、用 Flask 写一个简单 REST API</h2>
<p>你先安装 Flask：</p>
<pre><code class="hljs language-bash" lang="bash">pip install flask
</code></pre>
<p>写一个基础接口：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, jsonify, request

app = Flask(__name__)

articles = [
    {<span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"title"</span>: <span class="hljs-string">"Hello Python"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Flask makes API easy"</span>},
    {<span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>, <span class="hljs-string">"title"</span>: <span class="hljs-string">"REST 风格"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"让接口更标准更清晰"</span>},
]

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/api/articles"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_articles</span>():
    <span class="hljs-keyword">return</span> jsonify(articles)

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/api/articles"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_article</span>():
    data = request.json
    data[<span class="hljs-string">"id"</span>] = <span class="hljs-built_in">len</span>(articles) + <span class="hljs-number">1</span>
    articles.append(data)
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">"message"</span>: <span class="hljs-string">"created"</span>, <span class="hljs-string">"article"</span>: data})

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    app.run()
</code></pre>
<p>运行：</p>
<pre><code class="hljs language-bash" lang="bash">python app.py
</code></pre>
<p>然后你就可以访问：</p>
<ul>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2F127.0.0.1%3A5000%2Fapi%2Farticles" target="_blank" title="http://127.0.0.1:5000/api/articles" ref="nofollow noopener noreferrer">http://127.0.0.1:5000/api/articles</a>
获取文章列表</li>
<li>POST 相同地址即可创建文章</li>
</ul>
<p>这就是最基础的 REST API。</p>
<hr/>
<h2 data-id="heading-4">五、前端是如何调用 API 的</h2>
<p>现代前端一般使用 <strong>axios、fetch、uni.request、小程序 API 等方式</strong> 来调用后端接口。</p>
<p>以 JavaScript fetch 为例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">fetch</span>(<span class="hljs-string">"http://127.0.0.1:5000/api/articles"</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">resp</span> =&gt;</span> resp.<span class="hljs-title function_">json</span>())
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data));
</code></pre>
<p>返回值通常是 JSON：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">[</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Hello Python"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Flask makes API easy"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"REST 风格"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"让接口更标准更清晰"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">]</span>
</code></pre>
<p>你会发现，前端不需要知道任何数据库细节，只用关注数据本身即可。</p>
<hr/>
<h2 data-id="heading-5">六、REST API 必须遵守的规范</h2>
<p>一个优秀的 API 应该满足以下条件：</p>
<h4 data-id="heading-6">1. 返回统一的 JSON 结构</h4>
<p>不要让前端猜字段。</p>
<h4 data-id="heading-7">2. 明确的 HTTP 状态码</h4>
<p>示例：</p>
<ul>
<li>200 成功</li>
<li>201 创建成功</li>
<li>400 参数错误</li>
<li>401 未登录</li>
<li>500 服务端错误</li>
</ul>
<h4 data-id="heading-8">3. 使用名词做 URL</h4>
<p>尽量避免：</p>
<pre><code class="hljs language-bash" lang="bash">/getArticle
/addArticle
</code></pre>
<p>要这样：</p>
<pre><code class="hljs language-bash" lang="bash">/articles/
/articles/10
</code></pre>
<h4 data-id="heading-9">4. 保证数据结构清晰可读</h4>
<p>字段名称简洁统一。</p>
<hr/>
<h2 data-id="heading-10">七、Python 中更强大的 REST 框架推荐</h2>
<p>如果你的项目较大，推荐使用：</p>
<h3 data-id="heading-11">Django REST framework</h3>
<p>特点：</p>
<ul>
<li>自带认证系统</li>
<li>自带分页、序列化、验证</li>
<li>企业级项目首选</li>
</ul>
<p>一行代码就能生成 API：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> rest_framework.viewsets <span class="hljs-keyword">import</span> ModelViewSet
</code></pre>
<h3 data-id="heading-12">FastAPI</h3>
<p>特点：</p>
<ul>
<li>非常快</li>
<li>自动生成 Swagger 文档</li>
<li>异步支持强</li>
</ul>
<p>示例语法简洁漂亮：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI

app = FastAPI()

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/items"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_items</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"msg"</span>: <span class="hljs-string">"hello"</span>}
</code></pre>
<hr/>
<h2 data-id="heading-13">八、总结</h2>
<p>这一章我们搞清楚了：</p>
<ul>
<li>REST API 是前后端分离的基石</li>
<li>API 就是资源（URL）+ 行为（HTTP 方法）</li>
<li>Python 可以用 Flask、Django REST、FastAPI 等框架实现</li>
<li>前端通过 JSON/HTTP 调用 API</li>
<li>优秀的 API 必须规范、统一、清晰</li>
</ul>
<p>当你能熟练写 REST API，你已经具备成为后端开发者的重要能力。
在实际项目中，它能帮你快速搭建服务端系统，让你的业务真正落地运行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python 综合项目实战：学生成绩管理系统（命令行版）]]></title>    <link>https://juejin.cn/post/7572515402796040242</link>    <guid>https://juejin.cn/post/7572515402796040242</guid>    <pubDate>2025-11-15T21:49:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572515402796040242" data-draft-id="7572502156487901210" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python 综合项目实战：学生成绩管理系统（命令行版）"/> <meta itemprop="keywords" content="后端,Python,IPython"/> <meta itemprop="datePublished" content="2025-11-15T21:49:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员爱钓鱼"/> <meta itemprop="url" content="https://juejin.cn/user/2799775299157614"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python 综合项目实战：学生成绩管理系统（命令行版）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799775299157614/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员爱钓鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T21:49:28.000Z" title="Sat Nov 15 2025 21:49:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>当我们学完 Python 的基本语法、函数、文件操作、数据结构之后，最重要的就是“动手把零散技能组合起来”。
一个 <strong>命令行版本的学生成绩管理系统</strong> 非常适合作为阶段性小项目，它不需要用到任何 GUI 框架，但涵盖了如下关键知识点：</p>
</blockquote>
<ul>
<li>文件读写</li>
<li>列表与字典操作</li>
<li>输入与输出</li>
<li>流程控制与异常处理</li>
<li>模块化（可选）</li>
<li>程序结构设计</li>
</ul>
<p>这类小项目虽然简单，但非常接近真实业务逻辑，是从“语法”迈向“小型应用”的第一步。</p>
<hr/>
<h2 data-id="heading-0">1. 项目功能设计</h2>
<p>我们先把项目功能规划清楚，这比写代码更重要：</p>
<h4 data-id="heading-1"><strong>核心需求</strong></h4>
<ol>
<li><strong>添加学生成绩</strong></li>
<li><strong>查看所有学生成绩</strong></li>
<li><strong>查询指定学生</strong></li>
<li><strong>修改学生成绩</strong></li>
<li><strong>删除学生信息</strong></li>
<li><strong>保存到文件 / 从文件读取</strong></li>
<li><strong>退出程序</strong></li>
</ol>
<h4 data-id="heading-2"><strong>数据结构设计</strong></h4>
<p>我们用字典表示一个学生：</p>
<pre><code class="hljs language-python" lang="python">{
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"2025001"</span>,
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"张三"</span>,
    <span class="hljs-string">"score"</span>: <span class="hljs-number">88</span>
}
</code></pre>
<p>全部学生数据使用列表保存：</p>
<pre><code class="hljs language-python" lang="python">students = []
</code></pre>
<p>这个结构清晰、扩展性强，也方便序列化保存。</p>
<hr/>
<h2 data-id="heading-3">2. 主菜单设计</h2>
<p>命令行程序最重要的就是菜单循环：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">show_menu</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n===== 学生成绩管理系统 ====="</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 添加学生成绩"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 查看所有学生"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 查询学生"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"4. 修改学生成绩"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"5. 删除学生信息"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"6. 保存数据"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"7. 读取数据"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"0. 退出系统"</span>)
</code></pre>
<p>看起来简单，但这是后续所有操作的“入口”。</p>
<hr/>
<h2 data-id="heading-4">3. 功能实现</h2>
<p>下面给出完整的核心逻辑，代码结构清晰易懂。</p>
<hr/>
<h3 data-id="heading-5">① 添加学生</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">add_student</span>(<span class="hljs-params">students</span>):
    sid = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入学号："</span>)
    name = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入姓名："</span>)
    score = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入成绩："</span>))
    students.append({<span class="hljs-string">"id"</span>: sid, <span class="hljs-string">"name"</span>: name, <span class="hljs-string">"score"</span>: score})
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"添加成功！"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-6">② 查看所有学生</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">show_all</span>(<span class="hljs-params">students</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> students:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"当前没有学生数据"</span>)
        <span class="hljs-keyword">return</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 所有学生成绩 ---"</span>)
    <span class="hljs-keyword">for</span> stu <span class="hljs-keyword">in</span> students:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"学号：<span class="hljs-subst">{stu[<span class="hljs-string">'id'</span>]}</span>，姓名：<span class="hljs-subst">{stu[<span class="hljs-string">'name'</span>]}</span>，成绩：<span class="hljs-subst">{stu[<span class="hljs-string">'score'</span>]}</span>"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-7">③ 按学号查询学生</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">find_student</span>(<span class="hljs-params">students</span>):
    sid = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入要查询的学号："</span>)
    <span class="hljs-keyword">for</span> stu <span class="hljs-keyword">in</span> students:
        <span class="hljs-keyword">if</span> stu[<span class="hljs-string">"id"</span>] == sid:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"找到 → 姓名：<span class="hljs-subst">{stu[<span class="hljs-string">'name'</span>]}</span>，成绩：<span class="hljs-subst">{stu[<span class="hljs-string">'score'</span>]}</span>"</span>)
            <span class="hljs-keyword">return</span> stu
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"未找到该学生"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<hr/>
<h3 data-id="heading-8">④ 修改成绩</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">update_student</span>(<span class="hljs-params">students</span>):
    stu = find_student(students)
    <span class="hljs-keyword">if</span> stu:
        new_score = <span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">"请输入新成绩："</span>))
        stu[<span class="hljs-string">"score"</span>] = new_score
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"修改成功！"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-9">⑤ 删除学生</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_student</span>(<span class="hljs-params">students</span>):
    stu = find_student(students)
    <span class="hljs-keyword">if</span> stu:
        students.remove(stu)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"删除成功！"</span>)
</code></pre>
<hr/>
<h2 data-id="heading-10">4. 数据持久化（文件保存 &amp; 读取）</h2>
<p>我们使用简单的 JSON 格式，因为它结构清晰、方便读写。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json

<span class="hljs-keyword">def</span> <span class="hljs-title function_">save_data</span>(<span class="hljs-params">students, filename=<span class="hljs-string">"students.json"</span></span>):
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
        json.dump(students, f, ensure_ascii=<span class="hljs-literal">False</span>, indent=<span class="hljs-number">2</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"数据已保存!"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">load_data</span>(<span class="hljs-params">filename=<span class="hljs-string">"students.json"</span></span>):
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename, <span class="hljs-string">"r"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
            data = json.load(f)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"数据读取成功!"</span>)
        <span class="hljs-keyword">return</span> data
    <span class="hljs-keyword">except</span> FileNotFoundError:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"文件不存在，使用空数据。"</span>)
        <span class="hljs-keyword">return</span> []
</code></pre>
<hr/>
<h2 data-id="heading-11">5. 主程序（把所有功能串起来）</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    students = load_data()

    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        show_menu()
        choice = <span class="hljs-built_in">input</span>(<span class="hljs-string">"请选择操作："</span>)

        <span class="hljs-keyword">if</span> choice == <span class="hljs-string">"1"</span>:
            add_student(students)
        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">"2"</span>:
            show_all(students)
        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">"3"</span>:
            find_student(students)
        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">"4"</span>:
            update_student(students)
        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">"5"</span>:
            delete_student(students)
        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">"6"</span>:
            save_data(students)
        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">"7"</span>:
            students = load_data()
        <span class="hljs-keyword">elif</span> choice == <span class="hljs-string">"0"</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"退出系统，欢迎下次使用！"</span>)
            <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"输入无效，请重新选择!"</span>)
</code></pre>
<p>运行：</p>
<pre><code class="hljs language-bash" lang="bash">python student_system.py
</code></pre>
<p>你的第一个完整小系统就能跑起来了。</p>
<hr/>
<h2 data-id="heading-12">6. 项目扩展方向</h2>
<p>如果你想继续升级这个项目，我给你一些很好拓展方向：</p>
<h4 data-id="heading-13">✔ 增加成绩排序功能</h4>
<p>按成绩排序、按姓名排序等。</p>
<h4 data-id="heading-14">✔ 增加成绩统计</h4>
<p>最高分、最低分、平均分。</p>
<h4 data-id="heading-15">✔ 使用 SQLite/MySQL 持久化</h4>
<p>从文件升级成真正的数据库。</p>
<h4 data-id="heading-16">✔ 使用类封装</h4>
<p>将学生、系统封装为类，代码更专业。</p>
<h4 data-id="heading-17">✔ 使用 Tkinter / PyQt 做 GUI</h4>
<p>瞬间变成桌面应用。</p>
<h4 data-id="heading-18">✔ 使用 Flask / FastAPI 提供 REST API</h4>
<p>做成一个真正的“学生管理后台”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 中 UnaryOperator 接口与 Lambda 表达式的应用示例]]></title>    <link>https://juejin.cn/post/7572459757107724342</link>    <guid>https://juejin.cn/post/7572459757107724342</guid>    <pubDate>2025-11-15T19:21:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572459757107724342" data-draft-id="7572481101710278710" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 中 UnaryOperator 接口与 Lambda 表达式的应用示例"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-15T19:21:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dcs"/> <meta itemprop="url" content="https://juejin.cn/user/3679404422861902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 中 UnaryOperator 接口与 Lambda 表达式的应用示例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3679404422861902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dcs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T19:21:15.000Z" title="Sat Nov 15 2025 19:21:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，这里是<strong>架构资源栈</strong>！点击上方关注，添加“<strong>星标</strong>”，一起学习大厂前沿架构！</p>
<p>关注、发送<code>C1</code>即可获取JetBrains全家桶激活工具和码！</p>
<hr/>
<p>在 Java 8 引入 Lambda 表达式的过程中，开发者面临了许多新的接口，其中不乏一些看起来颇为学术、难以理解的名称。<strong>UnaryOperator</strong> 接口就是其中之一，但其实它的用途和实现非常简单。</p>
<h3 data-id="heading-0"><strong>UnaryOperator 的功能</strong></h3>
<p><strong>UnaryOperator</strong> 接口的功能就是接收一个对象，处理它后返回相同类型的对象。这个“unary”特性意味着输入和输出的对象类型是相同的。</p>
<p>从技术角度看，<strong>UnaryOperator</strong> 接口继承了 <strong>Function</strong> 接口，并且定义了一个名为 <strong>apply</strong> 的方法。</p>
<pre><code class="hljs language-java" lang="java">java.util.function.UnaryOperator
<span class="hljs-meta">@FunctionalInterface</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UnaryOperator</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Function</span>&lt;T, T&gt; {
    T <span class="hljs-title function_">apply</span><span class="hljs-params">(T t)</span>;
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d097d6e6669f4bb18fab03c2cf0e8b8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGNz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763839275&amp;x-signature=o%2FmS%2BTD3RyuHY%2FPqILCHUprgWVs%3D" alt="image" loading="lazy"/></p>
<p>比如，你可能想从一个对一个字符串做特殊处理后返回新的字符串。这正是 <strong>UnaryOperator</strong> 的应用场景——输入和输出都是字符串。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee962e4a8162472282a1f590454d9889~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGNz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763839275&amp;x-signature=1psbfMxnAYBytTYGDR85E1LAyWk%3D" alt="image" loading="lazy"/></p>
<h3 data-id="heading-1"><strong>UnaryOperator 实现示例</strong></h3>
<p>首先来看一个传统的实现方式，我们创建一个类 <code>UnaryOperatorExample</code> 来实现 <strong>UnaryOperator</strong> 接口，并提供 <code>apply</code> 方法：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.xiaod.lambda;


<span class="hljs-keyword">import</span> java.util.function.UnaryOperator;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnaryOperatorImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UnaryOperator</span>&lt;String&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">apply</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">return</span> name+<span class="hljs-string">"，财运滚滚！"</span>;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UnaryOperatorImplTest</span> {

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUnaryOperatorImpl</span><span class="hljs-params">()</span> {
        <span class="hljs-type">UnaryOperatorImpl</span> <span class="hljs-variable">unaryOperatorImpl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UnaryOperatorImpl</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">"小D"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> unaryOperatorImpl.apply(name);
        <span class="hljs-comment">// 小D，财运滚滚！</span>
        System.out.println(result);
    }

}
</code></pre>
<p>执行上述代码后，控制台将输出字符串 <code>小D，财运滚滚！</code>。</p>
<h3 data-id="heading-2"><strong>UnaryOperator 的 Lambda 表达式示例</strong></h3>
<p>使用 Java 的 Lambda 表达式可以简化代码，不再需要创建完整的类。通过 Lambda 表达式，我们可以直接实现 <strong>UnaryOperator</strong> 接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUnaryOperatorImplLambda</span><span class="hljs-params">()</span> {
        UnaryOperator&lt;String&gt; extensionAdder = (String name) -&gt; { <span class="hljs-keyword">return</span> name+<span class="hljs-string">"，财运滚滚！"</span>;} ;
        <span class="hljs-type">String</span> <span class="hljs-variable">newText</span> <span class="hljs-operator">=</span> extensionAdder.apply(<span class="hljs-string">"小D1"</span>);
        <span class="hljs-comment">// 小D1，财运滚滚！</span>
        System.out.println(newText);
    }

</code></pre>
<p>Lambda 表达式使得代码更加简洁和紧凑，能够快速传达功能意图。</p>
<h3 data-id="heading-3"><strong>进一步简化 Lambda 表达式</strong></h3>
<p>你还可以进一步简化 Lambda 表达式，省略类型声明，使得代码更加简洁：</p>
<pre><code class="hljs language-java" lang="java">UnaryOperator&lt;String&gt; extensionAdder = text -&gt; text + <span class="hljs-string">".txt"</span>;
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testUnaryOperatorImplLambda1</span><span class="hljs-params">()</span> {
        UnaryOperator&lt;String&gt; extensionAdder = (name)-&gt; name+<span class="hljs-string">"，财运滚滚！"</span> ;
        <span class="hljs-type">String</span> <span class="hljs-variable">newText</span> <span class="hljs-operator">=</span> extensionAdder.apply(<span class="hljs-string">"小D2"</span>);
        <span class="hljs-comment">// 小D2，财运滚滚！</span>
        System.out.println(newText);
    }
</code></pre>
<h3 data-id="heading-4"><strong>Java API 中 UnaryOperator 的应用</strong></h3>
<p><strong>UnaryOperator</strong> 接口在 Java API 中广泛应用。例如，它作为参数传递给 <strong>Stream</strong> 类的 <code>iterate</code> 方法。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> &lt;T&gt; Stream&lt;T&gt; <span class="hljs-title function_">iterate</span><span class="hljs-params">(T seed, UnaryOperator&lt;T&gt; f)</span>;
</code></pre>
<p>这种方法签名可能对初学者来说比较陌生，但通过 <strong>UnaryOperator</strong> 的简单示例，我们可以清晰地理解：它只是接收并返回相同类型的数据。Lambda 表达式的引入，使得 Java 编程更简洁易读，也极大提高了开发效率。</p>
<h3 data-id="heading-5"><strong>总结</strong></h3>
<p>通过这个简单的示例，我们深入了解了 <strong>UnaryOperator</strong> 接口及其在 Java Lambda 表达式中的应用。作为一个功能强大的工具，它简化了 Java 编程的复杂性，使得代码更加简洁和易于维护。</p>
<hr/>
<p><strong>喜欢就奖励一个“👍”和“在看”呗~</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5097f5cd8ee944e4893201a7b6deaf68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGNz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763839275&amp;x-signature=7sqwJIDs3EuLkoLjDfBQIt0ezFo%3D" alt="image" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO 正式版实战：一个全栈打卡项目的真实体验]]></title>    <link>https://juejin.cn/post/7572397142364766250</link>    <guid>https://juejin.cn/post/7572397142364766250</guid>    <pubDate>2025-11-14T12:46:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572397142364766250" data-draft-id="7572397142364749866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO 正式版实战：一个全栈打卡项目的真实体验"/> <meta itemprop="keywords" content="Trae,Solo,人工智能"/> <meta itemprop="datePublished" content="2025-11-14T12:46:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO 正式版实战：一个全栈打卡项目的真实体验
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-14T12:46:41.000Z" title="Fri Nov 14 2025 12:46:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前天 <code>TRAE</code> 进行升级，发布了 <code>SOLO</code> 正式版，今天，我们就试试新版实战效果具体如何。</p>
<p>这篇文章包括一个“实战过程”和“使用后的体会”，如果你正在考虑要不要尝试 <code>TRAE SOLO</code>，这篇文章应该可以帮到你。</p>
<h2 data-id="heading-0">目标</h2>
<p>计划搭建一个共同学习的平台，用户可以设置自己的学习主题，并设置学习计划的里程碑节点，每个人可以加入自己想要学习的主题，并每天打卡。</p>
<p>这个项目包括<strong>前后端</strong>，核心需求主要是<strong>3张关联表</strong>，应该可以当做一个比较典型的实战场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ace5aac0a3324d978740d71d2db6ad4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763729593&amp;x-signature=yk5PXq9DmTObsp8WTVyUgWkDrtw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">实战记录</h2>
<p>由于今天的分享重点在实战效果，因此具体操作会稍微简略一点。</p>
<h3 data-id="heading-2">初版生成</h3>
<p>使用 <code>SOLO Builder</code> 智能体生成初版。</p>
<p><strong>指令</strong></p>
<pre><code class="hljs language-diff" lang="diff">我们有一个技术社区，集中学习交流TRAE SOLO，想要搭建一个学习打卡平台。
<span class="hljs-deletion">- 可以创建学习计划，包括主题、周期和里程碑。</span>
<span class="hljs-deletion">- 可以针对每一个里程碑进行打卡记录。</span>
<span class="hljs-deletion">- 提供打卡完成排行榜</span>
<span class="hljs-deletion">- 整体风格参考截图</span>
前端使用vue+elementui+javascript，后端使用springboot+h2内存数据库。
</code></pre>
<p><strong>过程</strong></p>
<p>过程没有太大变动，依然是先生成相关的<strong>文档</strong>，文档内容确实详细。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd37a98225624d6f8e7167ea3d2ed4d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763729593&amp;x-signature=idTqsbHrDoPOzblglxDda03sxU0%3D" alt="" loading="lazy"/></p>
<p>按照任务清单进行生成，同时可以看到任务过程自动进行了<strong>总结</strong>，看起来更加有条理了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0828d2a110c4e9590b123bb66d57340~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763729593&amp;x-signature=jJH5tVXF8eRc7qyxjqGcWXPLt1w%3D" alt="" loading="lazy"/></p>
<p><strong>结果</strong></p>
<p>这次生成持续运行了1个小时仍未结束。</p>
<p>后来我跟踪了详细的执行过程，在30分钟左右，主要代码已经基本生成完成，剩余时间，一直在反复解决一个问题，但没有成功。</p>
<p>多次尝试解决失败后，我中断了生成，并手动修复了 bug。</p>
<p>这个 bug 修复完成后，项目的完成度倒是还可以。</p>
<p>先看几个界面。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/000f59b92b7f49fdbdf8c32388b0148b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763729593&amp;x-signature=lVvY1P%2FRFNH7reyj2%2F0GIOaCMQo%3D" alt="首页" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a818b97f1854e99ba4f3ae0f357d938~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763729593&amp;x-signature=e2c%2Bigb1o2lXdlTyzJREIUJm13g%3D" alt="添加学习计划成功" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a97a36f457614cbf9ed463849ca0696e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763729593&amp;x-signature=tPB070X2lB9A1hLx6CniKhoI%2FUo%3D" alt="打卡" loading="lazy"/></p>
<p>注：界面风格是在文档中分析错了，不是生成偏离的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cbbd7b4b6b04cab8e2e8d8eb7886a01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763729593&amp;x-signature=QRPfjbhhuJLltYzGZf2UWqVYJs0%3D" alt="" loading="lazy"/></p>
<p>接下来看下代码，一波对话，一共 65 个文件，包括前后端。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/644dfbb9b77d4970963d5376070e99b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763729593&amp;x-signature=CnmFCq7XUxVUi7IRqQz4wDvrK8I%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">实战体会</h2>
<p>因为这次是个大版本，我们专门分出一个章节分享下实际使用体会，方便大家判断。</p>
<p>上面实战记录是最后成功的一次，之前为了探索 <code>SOLO 正式版</code>的基本边界，我尝试了很多情况，包括提示词详细程度、不同智能体效果、Plan模式。</p>
<p><strong>第1点</strong></p>
<p><code>SOLO Coder</code> 的响应速度相对 <code>SOLO Builder</code> 速度更快，包括生成文档，但是，对从 0 到 1 的这种需要处理多方面内容杂糅的问题不太擅长。</p>
<p>这类问题，尤其是<strong>包含前端界面的，还是更适合 使用 SOLO Builder 处理</strong>。</p>
<p>因此，模型尚未再次大幅提升前，<strong>推荐使用方法</strong>：</p>
<ol>
<li>先用 SOLO Builder 进行分析，并生成文档；</li>
<li>然后使用 SOLO Builder 进行前端部分开发；</li>
<li>再通过 SOLO Coder 进行后端功能开发。</li>
</ol>
<p><strong>第2点</strong></p>
<p><code>Max</code> 模式确实爽，不会出现需要手动“继续”的情况，就是 <code>token</code> 不知道扛不扛得住。</p>
<p>像我这次直接跑了1个小时，要是 <code>token</code>，不敢想。</p>
<p><strong>第3点</strong></p>
<p>新模型的直观体验还是不错的，并且是国内最近几个头部模型中少有的<strong>支持上传图片</strong>的。</p>
<p>但是，有几个问题感觉需要注意：</p>
<ul>
<li>中文控制不太稳定，对话长了之后有较大几率开始使用英文输出，不太方便跟踪调试。</li>
<li>对于小问题的定位不太“聪明”，总是会尝试多种方法，最后才选择了一种较好的方案，是否可以参考 GPT-5.1 设置模型偏好，比如：保守型、激进型。</li>
</ul>
<p><strong>第4点</strong></p>
<p>这是今天这次实战碰到最大的一个问题，也是前面提到卡了接近半个小时的原因。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">VueCompilerError:</span> Element <span class="hljs-built_in">is</span> missing <span class="hljs-keyword">end</span> tag.
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/900c408812f1402aac16a0b5470dd60f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763729593&amp;x-signature=fUCQGNMPhAOv4Q2oV%2FI6QU0PWL0%3D" alt="" loading="lazy"/></p>
<p>错误其实很简单，就是 <code>vue</code> 页面 <code>&lt;style&gt;</code> 缺少闭合标签 <code>&lt;/style&gt;</code>。我手动加上后就好了。</p>
<p>但这个问题在之前使用过程中也碰到过几次，每次碰到后，想要依赖 <code>SOLO</code> 自己解决都很难，给人感觉像是这块的训练数据被污染了。</p>
<blockquote>
<p>已经反馈给官方，希望可以尽早解决。</p>
</blockquote>
<h2 data-id="heading-4">结语</h2>
<p>实战表现虽不完美，但很大程度上是因为我刻意选择了较复杂的三表关联需求，以试探 SOLO 正式版的能力边界。</p>
<p>综合下来，<code>TRAE SOLO 正式版</code>的整体体验还算不错，但仍需进步。</p>
<p>如果你有意向，强烈建议试试，当前还在免费中~</p>
<p>也希望 <code>TRAE</code> 后续继续进化，为大家提供更加智能的产品服务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端开发小技巧-【JavaScript】- 获取元素距离 document 顶部的距离]]></title>    <link>https://juejin.cn/post/7572459217812045887</link>    <guid>https://juejin.cn/post/7572459217812045887</guid>    <pubDate>2025-11-15T15:16:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572459217812045887" data-draft-id="7571650164843348002" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端开发小技巧-【JavaScript】- 获取元素距离 document 顶部的距离"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-11-15T15:16:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="禁止摆烂_才浅"/> <meta itemprop="url" content="https://juejin.cn/user/92819673587448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端开发小技巧-【JavaScript】- 获取元素距离 document 顶部的距离
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/92819673587448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    禁止摆烂_才浅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-15T15:16:24.000Z" title="Sat Nov 15 2025 15:16:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">获取元素距离 document 顶部的距离</h2>
<h3 data-id="heading-1">方案1：使用 <code>offsetTop</code>（最简单）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myDiv'</span>)
<span class="hljs-keyword">const</span> distance = element.<span class="hljs-property">offsetTop</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(distance)  <span class="hljs-comment">// 500（像素）</span>
</code></pre>
<h3 data-id="heading-2">方案2：使用 <code>getBoundingClientRect() + scrollY</code>（最准确）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myDiv'</span>)
<span class="hljs-keyword">const</span> distance = element.<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">top</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(distance)  <span class="hljs-comment">// 500（像素）</span>
</code></pre>
<h3 data-id="heading-3">方案3：递归计算（处理嵌套位置）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getDistanceFromTop</span>(<span class="hljs-params">element</span>) {
  <span class="hljs-keyword">let</span> distance = <span class="hljs-number">0</span>
  <span class="hljs-keyword">let</span> current = element

  <span class="hljs-keyword">while</span> (current) {
    distance += current.<span class="hljs-property">offsetTop</span>
    current = current.<span class="hljs-property">offsetParent</span>
  }

  <span class="hljs-keyword">return</span> distance
}

<span class="hljs-keyword">const</span> distance = <span class="hljs-title function_">getDistanceFromTop</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myDiv'</span>))
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(distance)
</code></pre>
<h3 data-id="heading-4">对比表格</h3>





























<table><thead><tr><th>方法</th><th>优点</th><th>缺点</th><th>推荐度</th></tr></thead><tbody><tr><td><code>offsetTop</code></td><td>简单快速</td><td>只返回相对最近定位父元素</td><td>⭐⭐⭐</td></tr><tr><td><code>getBoundingClientRect().top + scrollY</code></td><td>精确、兼容性好</td><td>稍复杂</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>递归计算</td><td>处理复杂嵌套</td><td>代码复杂</td><td>⭐⭐</td></tr></tbody></table>
<h3 data-id="heading-5">完整示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 最推荐的方法</span>
<span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myDiv'</span>)
<span class="hljs-keyword">const</span> distanceFromDocTop = element.<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">top</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`元素距离文档顶部: <span class="hljs-subst">${distanceFromDocTop}</span>px`</span>)
</code></pre>
<h3 data-id="heading-6">React 中使用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRef, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> elementRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>)

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (elementRef.<span class="hljs-property">current</span>) {
      <span class="hljs-keyword">const</span> distance = elementRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">top</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'距离文档顶部:'</span>, distance)
    }
  }, [])

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{elementRef}</span>&gt;</span>内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-7">实际应用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取元素到文档顶部的距离</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getElementDistanceFromTop</span>(<span class="hljs-params">elementId, offset = <span class="hljs-number">0</span></span>) {
  <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(elementId)
  
  <span class="hljs-keyword">if</span> (!element) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`元素 <span class="hljs-subst">${elementId}</span> 不存在`</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
  }

  <span class="hljs-keyword">return</span> element.<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">top</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span> - offset
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> distance = <span class="hljs-title function_">getElementDistanceFromTop</span>(<span class="hljs-string">'myDiv'</span>, <span class="hljs-number">100</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(distance)  <span class="hljs-comment">// 返回元素距离文档顶部，减去 100px 的偏移</span>

<span class="hljs-comment">// 滚动到该位置</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>({
  <span class="hljs-attr">top</span>: distance,
  <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span>
})
</code></pre>
<h3 data-id="heading-8">总结</h3>
<p><strong>最佳方案</strong>：<code>element.getBoundingClientRect().top + window.scrollY</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 滚动到指定元素
 * <span class="hljs-doctag">@param</span> id 元素ID
 * <span class="hljs-doctag">@param</span> offsetTop 偏移量【指定元素上下偏移量】
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollTo</span> = (<span class="hljs-params">id: <span class="hljs-built_in">string</span>, offsetTop: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(id)
  <span class="hljs-keyword">if</span> (!element) {
    <span class="hljs-keyword">return</span>
  }

  <span class="hljs-keyword">const</span> elementTop = element.<span class="hljs-title function_">getBoundingClientRect</span>().<span class="hljs-property">top</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span>
  <span class="hljs-keyword">const</span> targetTop = elementTop - offsetTop

  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>({
    <span class="hljs-attr">top</span>: targetTop,
    <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span>,
  })
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>