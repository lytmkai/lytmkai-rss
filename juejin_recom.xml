<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[OoderAI 企业级 AI 解决方案]]></title>    <link>https://juejin.cn/post/7593139476832665643</link>    <guid>https://juejin.cn/post/7593139476832665643</guid>    <pubDate>2026-01-09T04:10:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476832665643" data-draft-id="7592921639464075306" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderAI 企业级 AI 解决方案"/> <meta itemprop="keywords" content="开源,人工智能"/> <meta itemprop="datePublished" content="2026-01-09T04:10:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderAI 企业级 AI 解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T04:10:22.000Z" title="Fri Jan 09 2026 04:10:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、核心架构概述</h2>
<p>OoderAI是一套 企业级 AI 解决方案以“AI 大脑”为核心驱动，联动三大核心套件（SkillFlow 流程套件、A2UI 画布套件、OneCode 环境套码套件）构建全链路技术闭环。该架构通过“核心驱动-流程管控-交互生成-环境支撑”的分层设计，实现 AI 能力的可控外延、人机交互的智能生成以及数据代码的一致性管控，从根源上解决企业级 AI 应用落地中的“能力不可控、交互不灵活、代码不一致”三大核心痛点，为企业提供高效、安全、可扩展的 AI 赋能方案。</p>
<p>​</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f713f1f083d04d6e9dc7d66ed674a927~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768536622&amp;x-signature=ShG6ug%2BKNKvhMjb49y3uojkPc8s%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<h2 data-id="heading-1">二、核心组件详解</h2>
<h3 data-id="heading-2">（一）核心驱动：AI 大脑</h3>
<p>AI 大脑是整个解决方案的决策与调度核心，负责统筹三大套件的协同运作。其核心价值在于整合全域业务数据与技能资源，通过智能算法实现需求解析、任务分配、流程调度与结果校验。一方面，AI 大脑接收来自业务端的需求指令，通过自然语言理解与业务场景匹配，拆解为可执行的任务单元；另一方面，根据任务属性动态调用 SkillFlow 的流程能力、A2UI 的交互生成能力以及 OneCode 的环境编译能力，形成“需求-执行-输出”的全链路闭环，同时对各环节的执行状态进行实时监控，确保 AI 应用的可控性与稳定性。</p>
<p>​</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8509272793444a858fdc627d2732bb11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768536622&amp;x-signature=jvzdJ1SjMatEQe3qrdehFLGMEaE%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<h3 data-id="heading-3">（二）三大核心套件</h3>
<h4 data-id="heading-4">1. SkillFlow 流程套件——可控的 AI 外延能力引擎</h4>
<p>SkillFlow 聚焦 AI 能力的流程化管控与外延扩展，通过 MCP 服务、Skill 能力扩展、Workflow 边界控制三大核心机制，让 AI 大脑具备“可扩展、可管控、可追溯”的外延能力，解决传统 AI 能力扩展中“边界模糊、协同混乱、风险不可控”的问题。</p>
<ul>
<li><strong>MCP 服务连接核心</strong>：采用 MCP（Model Context Protocol）标准化协议作为 AI 与外部系统的交互桥梁，如同“AI 的通用 USB-C 接口”，实现 AI 大脑与企业现有业务系统、数据源、第三方工具的无缝对接。通过 MCP 服务，AI 可安全调用外部业务数据、执行系统操作，同时保障数据传输的标准化与安全性，避免异构系统集成中的兼容性问题。</li>
<li><strong>Skill 能力扩展体系</strong>：构建模块化 Skill 能力库，涵盖数据处理、业务审批、报表生成等各类企业级任务模板。AI 大脑可根据业务需求动态加载所需 Skill，实现能力的按需扩展。Skill 采用“渐进式加载”设计，仅在任务执行时加载相关技能模块，大幅提升 AI 上下文处理效率，避免传统能力扩展中“全量加载导致的资源冗余”问题。</li>
<li><strong>Workflow 边界控制机制</strong>：通过可视化流程编排工具定义任务执行的边界与规则，明确各 Skill 的调用顺序、数据流转路径以及异常处理逻辑。例如，在采购审批流程中，可通过 Workflow 设定“数据校验-层级审批-结果归档”的固定链路，限制 AI 能力的执行范围，避免越权操作，同时确保流程执行的可追溯性，满足企业级应用的合规要求。</li>
</ul>
<h4 data-id="heading-5">2. 一张画布（A2UI）——AI 原生人机交互生成中心</h4>
<p>作为 Ooder RAD（快速应用开发）中心的核心组件，一张画布以“自治 UI 组件库+可视化设计器”为基础，依托 A2UI 协议实现 AI 直接撰写人机交互界面的能力，解决企业级应用“界面开发效率低、多端适配难、交互体验差”的痛点。</p>
<ul>
<li><strong>自治 UI 组件库</strong>：提供企业级标准化 UI 组件集，组件具备“自我管理状态、行为与渲染逻辑”的特性，可实现与业务逻辑层的解耦。组件库涵盖表单、报表、地图、交互控件等全品类元素，且所有组件均经过安全校验，仅允许从可信组件目录中选取，从根源避免代码注入风险。</li>
<li><strong>可视化设计器</strong>：支持开发者通过“拖拽式”操作快速搭建界面布局，同时允许 AI 深度参与设计过程。设计器可解析 AI 生成的交互需求，自动匹配合适的 UI 组件并完成布局优化，非技术人员也可通过自然语言指令让 AI 生成符合业务需求的界面初稿，大幅降低界面开发门槛。</li>
<li><strong>A2UI 协议核心支撑</strong>：采用基于 JSON 格式的 A2UI（智能体至用户界面）公开协议，实现 AI 与界面渲染引擎的标准化通信。AI 可通过 A2UI 协议直接输出界面描述信息，客户端渲染引擎接收后自动转换为 React、Flutter、SwiftUI 等原生框架代码，实现“一份交互描述、多端原生适配”。该协议具备安全优先、LLM 友好、框架无关的优势，既保障了界面生成的安全性，又提升了 AI 交互设计的效率与灵活性。</li>
</ul>
<h4 data-id="heading-6">3. 环境套码（OneCode）——全栈一致的技术支撑框架</h4>
<p>OneCode 是基于注解驱动的全栈技术框架，通过“三码合一混合编译”核心机制，实现 AI 生成数据、业务逻辑、界面代码的一致性与可控性，为整个解决方案提供稳定、高效的技术底座。</p>
<ul>
<li><strong>注解驱动全栈协同</strong>：采用自定义注解体系（如@DomainTree、@CrossEndAdapt），将领域模型、跨端适配规则等信息以结构化注解形式写入代码，实现“代码即模型、模型即代码”的双向绑定。AI 可自动识别业务场景生成适配的结构化注解，并通过知识图谱校验注解间的依赖关系，避免配置冲突，大幅提升全栈开发效率。</li>
<li><strong>三码合一混合编译</strong>：整合前端交互代码、后端业务代码、数据处理代码“三码”，通过混合编译技术实现代码的统一校验与生成。AI 生成的各类代码将通过 OneCode 框架进行一致性校验，确保数据流转、业务逻辑与界面交互的协同一致；同时，编译过程自动适配多端运行环境，减少跨端开发的重复工作，提升代码可维护性。</li>
<li><strong>全生命周期管控</strong>：覆盖“需求解析-代码生成-编译部署-运维监控”全流程，AI 可通过注解驱动实现代码的自动更新与迭代，同时框架具备完善的版本管理与回滚机制，确保 AI 数据与代码的一致性可控，降低企业级应用的运维成本与风险。</li>
<li>​</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e40530005fb9439489e96d98ec6febd7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768536622&amp;x-signature=qV6aADJOz%2BjnPAIa76JDYXTRDFw%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<h2 data-id="heading-7">三、核心优势与价值闭环</h2>
<h3 data-id="heading-8">（一）核心优势</h3>
<ol>
<li><strong>能力可控性</strong>：通过 SkillFlow 的 Workflow 边界控制与 MCP 标准化交互，实现 AI 外延能力的精准管控，避免能力滥用与越权操作，满足企业级合规要求。</li>
<li><strong>开发高效性</strong>：A2UI 画布的可视化设计与 AI 生成能力、OneCode 的注解驱动与三码合一编译，大幅降低全栈开发门槛，缩短应用迭代周期，某金融客户实测复杂模块开发周期从 3 个月压缩至 2 周。</li>
<li><strong>交互适配性</strong>：A2UI 协议的框架无关特性实现多端原生适配，保障企业品牌体验的一致性，同时 AI 可根据用户角色自动优化交互界面，提升用户体验。</li>
<li><strong>数据一致性</strong>：OneCode 的注解驱动与混合编译机制，确保 AI 生成的数据流、业务流与代码流高度一致，降低数据冗余与逻辑冲突风险，系统 BUG 率可下降 47%以上。</li>
</ol>
<h3 data-id="heading-9">（二）价值闭环</h3>
<p>Ooder 企业级 AI 解决方案通过“AI 大脑统筹调度- SkillFlow 管控流程- A2UI 生成交互- OneCode 支撑落地”的全链路协同，形成“需求输入-智能执行-结果输出-迭代优化”的价值闭环。该方案无需企业推倒原有系统，可与现有业务资产无缝兼容，既能让 AI 承接重复劳动、提升开发与业务效率，又能通过标准化与可控化设计保障系统安全与合规，最终帮助企业实现“AI 赋能业务、技术驱动增长”的核心目标。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 19 实战：5个新特性让你的开发效率提升50%！]]></title>    <link>https://juejin.cn/post/7592846242176958498</link>    <guid>https://juejin.cn/post/7592846242176958498</guid>    <pubDate>2026-01-09T04:17:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592846242176958498" data-draft-id="7592912361302065187" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 19 实战：5个新特性让你的开发效率提升50%！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-09T04:17:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 19 实战：5个新特性让你的开发效率提升50%！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T04:17:14.000Z" title="Fri Jan 09 2026 04:17:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>React 19 实战：5个新特性让你的开发效率提升50%！</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>React 作为现代前端开发的标杆框架，每一次重大版本更新都会带来颠覆性的改进。React 19 也不例外，它在性能优化、开发者体验和功能扩展方面带来了多项令人振奋的新特性。本文将深入剖析 React 19 中最值得关注的 5 个新特性，并通过实战案例展示如何利用它们将开发效率提升至少 50%。无论你是 React 新手还是资深开发者，这些新特性都将显著改变你的开发方式。</p>
<hr/>
<h2 data-id="heading-2">React Server Components（RSC）的正式支持</h2>
<h3 data-id="heading-3"><strong>背景与痛点</strong></h3>
<p>传统的 React 应用通常在客户端渲染（CSR），这会导致首屏加载时间较长，SEO 不友好等问题。虽然 Next.js 等框架提供了服务端渲染（SSR）方案，但配置复杂且灵活性不足。</p>
<h3 data-id="heading-4"><strong>React Server Components（RSC）的解决方案</strong></h3>
<p>React 19 正式将 RSC 纳入核心功能，允许开发者在服务端直接渲染组件，无需发送多余的 JavaScript 到客户端。这不仅减少了 bundle size，还能显著提升首屏加载速度。</p>
<h3 data-id="heading-5"><strong>实战示例</strong></h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ServerComponent.server.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ServerComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 直接从数据库获取数据</span>
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">fetchDataFromDB</span>();
  
<span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{data.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{data.content}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
}
</code></pre>
<p>在客户端可以直接引用：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ClientComponent.client.js</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ServerComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ServerComponent.server'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ClientComponent</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ServerComponent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
}
</code></pre>
<h3 data-id="heading-6"><strong>效率提升点</strong></h3>
<ul>
<li><strong>减少客户端负担</strong>：逻辑和数据获取直接在服务端完成。</li>
<li><strong>更快的 TTI（Time to Interactive）</strong>：用户无需等待 JavaScript hydrate。</li>
</ul>
<hr/>
<h2 data-id="heading-7">Actions API：简化表单和数据提交</h2>
<h3 data-id="heading-8"><strong>背景与痛点</strong></h3>
<p>传统表单处理通常需要手动管理状态、错误处理和提交逻辑，代码冗余且容易出错。即使使用 Formik 或 React Hook Form，仍需额外依赖库。</p>
<h3 data-id="heading-9"><strong>Actions API的改进</strong></h3>
<p>React 19引入了<code>useActionState</code>和<code>useFormStatus</code>等新Hook，原生支持表单提交的状态管理、pending状态和错误处理。</p>
<h3 data-id="heading-10"><strong>实战示例</strong></h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useActionState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">submitForm</span>(<span class="hljs-params">prevState, formData</span>) {
<span class="hljs-keyword">const</span> email = formData.<span class="hljs-title function_">get</span>(<span class="hljs-string">'email'</span>);
<span class="hljs-keyword">if</span> (!email.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'@'</span>)) {
<span class="hljs-keyword">return</span> { <span class="hljs-attr">error</span>: <span class="hljs-string">'Invalid email'</span> };
}
<span class="hljs-comment">// Submit to server</span>
<span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span> };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">SignupForm</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">const</span> [state, submitAction] = <span class="hljs-title function_">useActionState</span>(submitForm);

<span class="hljs-keyword">return</span> (
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">{submitAction}</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"email"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
{state.error &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{state.error}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>}
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
);
}
</code></pre>
<h3 data-id="heading-11"><strong>效率提升点</strong></h3>
<ul>
<li><strong>减少样板代码</strong>：无需手动管理loading或error状态。</li>
<li><strong>内置乐观更新支持</strong>：未来版本可能直接集成乐观UI更新。</li>
</ul>
<hr/>
<h2 data-id="heading-12">Document Metadata的组件化支持</h2>
<h3 data-id="heading-13"><strong>背景与痛点</strong></h3>
<p>动态修改<code>&lt;title&gt;</code>或<code>&lt;meta&gt;</code>标签通常需要依赖<code>react-helmet</code>或手动操作DOM，代码分散且难以维护。</p>
<h3 data-id="heading-14"><strong>新特性改进</strong></h3>
<p>React19允许在组件树中直接定义文档元数据：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">HomePage</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">return</span> (
<span class="xml"><span class="hljs-tag">&lt;&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Home | My App<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"description"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"Welcome to my app"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
<span class="hljs-tag">&lt;/&gt;</span></span>
);
}
</code></pre>
<h3 data-id="heading-15"><strong>效率提升点</strong></h3>
<ul>
<li><strong>更好的可维护性</strong>：元数据与组件逻辑共存。</li>
<li><strong>SSR友好</strong>：自动处理服务端渲染时的标签注入。</li>
</ul>
<hr/>
<h2 data-id="heading-16">use Hook：统一数据加载模式</h2>
<h3 data-id="heading-17"><strong>背景与痛点</strong></h3>
<p>数据加载通常需要混合使用<code>useEffect</code>、第三方状态库和自定义Hook，导致代码碎片化。</p>
<h3 data-id="heading-18"><code>use</code> Hook的革命性设计</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { use } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserProfile</span>(<span class="hljs-params">{ userId }</span>) {
<span class="hljs-keyword">const</span> user = <span class="hljs-title function_">use</span>(<span class="hljs-title function_">fetchUser</span>(userId)); <span class="hljs-comment">// Promise会被自动resolve</span>

<span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-19"><strong>核心优势</strong></h3>
<ol>
<li><strong>同步写法处理异步逻辑</strong></li>
<li><strong>兼容Suspense边界</strong></li>
</ol>
<hr/>
<h2 data-id="heading-20">Offscreen Rendering：预渲染性能优化</h2>
<p>###技术原理
通过<code>&lt;Offscreen&gt;</code>组件实现：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Offscreen</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
<span class="hljs-keyword">return</span> (
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Offscreen</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">"hidden"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">HeavyComponent</span> /&gt;</span> {/*不会被实际渲染*/}
<span class="hljs-tag">&lt;/<span class="hljs-name">Offscreen</span>&gt;</span></span>
);
}
</code></pre>
<hr/>
<p>##总结</p>
<p>React19的五项革新从不同维度解决了前端开发的深层次痛点：</p>
<ol>
<li>RSC重塑了渲染模型边界</li>
<li>ActionsAPI重新定义了表单交互范式</li>
<li>Metadata组件化提升了内容管理效率</li>
<li><code>use</code>Hook统一了异步编程模型</li>
<li>Offscreen为复杂应用提供性能保障</li>
</ol>
<p>这些特性不是孤立存在而是相互增强的组合拳。例如RSC+Actions可以构建超高效率的全栈应用；use+Offscreen能实现智能的资源加载策略。</p>
<p>要完全发挥React19的威力需要转变思维模式：
-从"纯客户端"转向服务端/客户端协同开发
-从手动状态管理转向声明式API
-从关注细节实现转向关注业务逻辑</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenAI Codex 深入剖析：下一代 AI 编程助手的架构与原理]]></title>    <link>https://juejin.cn/post/7592921639464108074</link>    <guid>https://juejin.cn/post/7592921639464108074</guid>    <pubDate>2026-01-09T04:26:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592921639464108074" data-draft-id="7579995569689067554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenAI Codex 深入剖析：下一代 AI 编程助手的架构与原理"/> <meta itemprop="keywords" content="前端,OpenAI,AI编程"/> <meta itemprop="datePublished" content="2026-01-09T04:26:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="破茧68"/> <meta itemprop="url" content="https://juejin.cn/user/3817931570691031"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenAI Codex 深入剖析：下一代 AI 编程助手的架构与原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817931570691031/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    破茧68
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T04:26:17.000Z" title="Fri Jan 09 2026 04:26:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">深入剖析 OpenAI Codex：下一代 AI 编程助手的架构与原理</h2>
<blockquote>
<p>本文将带你深入了解 OpenAI Codex 的内部架构、设计思路和实现原理。无论你是初学者还是有经验的开发者，都能从中获得对 AI 编程助手的深刻理解。</p>
</blockquote>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-codex" title="#%E4%BB%80%E4%B9%88%E6%98%AF-codex">什么是 Codex？</a></li>
<li><a href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88" title="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88">整体架构概览</a></li>
<li><a href="#%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7%E8%AF%A6%E8%A7%A3" title="#%E6%A0%B8%E5%BF%83%E7%89%B9%E6%80%A7%E8%AF%A6%E8%A7%A3">核心特性详解</a></li>
<li><a href="#%E5%BA%95%E5%B1%82%E5%8D%8F%E8%AE%AE%E4%B8%8E%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6" title="#%E5%BA%95%E5%B1%82%E5%8D%8F%E8%AE%AE%E4%B8%8E%E9%80%9A%E4%BF%A1%E6%9C%BA%E5%88%B6">底层协议与通信机制</a></li>
<li><a href="#%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E8%AE%B0%E4%BD%8F%E5%AF%B9%E8%AF%9D" title="#%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F%E5%A6%82%E4%BD%95%E8%AE%B0%E4%BD%8F%E5%AF%B9%E8%AF%9D">记忆系统：如何记住对话</a></li>
<li><a href="#%E4%B8%8A%E4%B8%8B%E6%96%87%E5%B7%A5%E7%A8%8B%E6%99%BA%E8%83%BD%E7%AE%A1%E7%90%86%E6%9C%89%E9%99%90%E7%9A%84%E8%84%91%E5%AE%B9%E9%87%8F" title="#%E4%B8%8A%E4%B8%8B%E6%96%87%E5%B7%A5%E7%A8%8B%E6%99%BA%E8%83%BD%E7%AE%A1%E7%90%86%E6%9C%89%E9%99%90%E7%9A%84%E8%84%91%E5%AE%B9%E9%87%8F">上下文工程：智能管理有限的"脑容量"</a></li>
<li><a href="#%E5%B7%A5%E5%85%B7%E7%B3%BB%E7%BB%9F%E8%AE%A9-ai-%E8%83%BD%E5%A4%9F%E5%8A%A8%E6%89%8B" title="#%E5%B7%A5%E5%85%B7%E7%B3%BB%E7%BB%9F%E8%AE%A9-ai-%E8%83%BD%E5%A4%9F%E5%8A%A8%E6%89%8B">工具系统：让 AI 能够"动手"</a></li>
<li><a href="#%E5%AE%89%E5%85%A8%E6%B2%99%E7%AE%B1%E7%BB%99-ai-%E4%B8%80%E4%B8%AA%E5%AE%89%E5%85%A8%E7%9A%84%E6%B8%B8%E4%B9%90%E5%9C%BA" title="#%E5%AE%89%E5%85%A8%E6%B2%99%E7%AE%B1%E7%BB%99-ai-%E4%B8%80%E4%B8%AA%E5%AE%89%E5%85%A8%E7%9A%84%E6%B8%B8%E4%B9%90%E5%9C%BA">安全沙箱：给 AI 一个安全的"游乐场"</a></li>
<li><a href="#mcp-%E5%8D%8F%E8%AE%AE%E8%BF%9E%E6%8E%A5%E5%A4%96%E9%83%A8%E4%B8%96%E7%95%8C%E7%9A%84%E6%A1%A5%E6%A2%81" title="#mcp-%E5%8D%8F%E8%AE%AE%E8%BF%9E%E6%8E%A5%E5%A4%96%E9%83%A8%E4%B8%96%E7%95%8C%E7%9A%84%E6%A1%A5%E6%A2%81">MCP 协议：连接外部世界的桥梁</a></li>
<li><a href="#%E6%89%A7%E8%A1%8C%E7%AD%96%E7%95%A5%E6%99%BA%E8%83%BD%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86" title="#%E6%89%A7%E8%A1%8C%E7%AD%96%E7%95%A5%E6%99%BA%E8%83%BD%E7%9A%84%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86">执行策略：智能的权限管理</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-codex" title="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8-codex">如何使用 Codex</a></li>
<li><a href="#%E6%80%BB%E7%BB%93" title="#%E6%80%BB%E7%BB%93">总结</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">什么是 Codex？</h3>
<p>想象一下，你有一个超级聪明的编程助手，它不仅能理解你的需求，还能直接帮你写代码、运行命令、修改文件。这就是 <strong>Codex</strong> —— OpenAI 推出的本地 AI 编程代理。</p>
<h4 data-id="heading-3">用大白话解释</h4>
<p>如果把编程比作做菜：</p>
<ul>
<li><strong>普通的 AI 助手</strong>（如 ChatGPT）就像一本菜谱，告诉你怎么做，但你需要自己动手</li>
<li><strong>Codex</strong> 就像一个真正的厨师，不仅告诉你怎么做，还能直接帮你把菜做出来</li>
</ul>
<h4 data-id="heading-4">核心能力</h4>
<ul>
<li>Codex 能做什么？
<ul>
<li>理解代码：阅读和分析你的项目代码</li>
<li>编写代码：自动编写新功能或修复 bug</li>
<li>执行命令：运行测试、构建项目、git 操作等</li>
<li>修改文件：直接编辑、创建、删除文件</li>
<li>搜索信息：在代码库中搜索，甚至进行网络搜索</li>
<li>调用外部工具：通过 MCP 协议连接各种外部服务</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">整体架构概览</h3>
<p>Codex 采用了 <strong>Monorepo（单一代码仓库）</strong> 的组织方式，主要由 Rust 和 TypeScript 两种语言构建。</p>
<h4 data-id="heading-6">为什么选择 Rust？</h4>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>性能</strong></td><td>Rust 编译成机器码，运行速度极快</td></tr><tr><td><strong>安全</strong></td><td>内存安全保证，避免常见的安全漏洞</td></tr><tr><td><strong>并发</strong></td><td>优秀的异步编程支持，可同时处理多个任务</td></tr><tr><td><strong>跨平台</strong></td><td>一套代码可编译到 macOS、Linux、Windows</td></tr></tbody></table>
<h4 data-id="heading-7">项目结构图</h4>
<pre><code class="hljs language-bash" lang="bash">codex/
├── codex-rs/           <span class="hljs-comment"># Rust 核心代码（45+ 个模块）</span>
│   ├── core/           <span class="hljs-comment"># 核心引擎 - AI 的"大脑"</span>
│   ├── tui/            <span class="hljs-comment"># 终端界面 - 用户交互</span>
│   ├── cli/            <span class="hljs-comment"># 命令行入口</span>
│   ├── <span class="hljs-built_in">exec</span>/           <span class="hljs-comment"># 非交互式执行</span>
│   ├── mcp-server/     <span class="hljs-comment"># MCP 服务器</span>
│   └── ...             <span class="hljs-comment"># 其他支持模块</span>
│
├── sdk/typescript/     <span class="hljs-comment"># TypeScript SDK（给开发者用的库）</span>
├── shell-tool-mcp/     <span class="hljs-comment"># Shell 工具 MCP 实现</span>
└── docs/               <span class="hljs-comment"># 文档</span>
</code></pre>
<h4 data-id="heading-8">架构分层图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">
graph TB
    subgraph UserInterface["用户接口层"]
        CLI["CLI 命令行"]
        TUI["TUI 终端界面"]
        SDK["TypeScript SDK"]
    end

    subgraph CoreEngine["核心引擎层"]
        Codex["Codex 核心引擎"]
        ModelClient["模型客户端"]
        ContextMgr["上下文管理器"]
        ToolRouter["工具路由器"]
    end

    subgraph ExecutionLayer["执行层"]
        ShellExec["Shell 执行器"]
        FileOps["文件操作"]
        MCPClient["MCP 客户端"]
        WebSearch["网络搜索"]
    end

    subgraph SecurityLayer["安全层"]
        Sandbox["沙箱隔离"]
        ExecPolicy["执行策略"]
        Approval["审批系统"]
    end

    CLI --&gt; Codex
    TUI --&gt; Codex
    SDK --&gt; Codex

    Codex --&gt; ModelClient
    Codex --&gt; ContextMgr
    Codex --&gt; ToolRouter

    ToolRouter --&gt; ShellExec
    ToolRouter --&gt; FileOps
    ToolRouter --&gt; MCPClient
    ToolRouter --&gt; WebSearch

    ShellExec --&gt; Sandbox
    ShellExec --&gt; ExecPolicy
    FileOps --&gt; Sandbox
    FileOps --&gt; Approval
    MCPClient --&gt; Approval

    style UserInterface fill:#E3F2FD,stroke:#1976D2
    style CoreEngine fill:#E8F5E9,stroke:#388E3C
    style ExecutionLayer fill:#FFF3E0,stroke:#F57C00
    style SecurityLayer fill:#FCE4EC,stroke:#C2185B

</code></pre>
<p>Codex 的架构可以分为四层：</p>
<ol>
<li><strong>用户接口层</strong>：你与 Codex 交互的入口（CLI、TUI、SDK）</li>
<li><strong>核心引擎层</strong>：处理 AI 推理、工具调用、上下文管理</li>
<li><strong>执行层</strong>：实际执行命令、修改文件、调用外部服务</li>
<li><strong>安全层</strong>：沙箱隔离、权限控制、执行策略</li>
</ol>
<hr/>
<h3 data-id="heading-9">核心特性详解</h3>
<h4 data-id="heading-10">1. 多模式交互</h4>
<p>Codex 支持三种使用模式：</p>




















<table><thead><tr><th>交互式 TUI</th><th>非交互式 Exec</th><th>SDK 集成</th></tr></thead><tbody><tr><td><strong>实时对话界面</strong></td><td>自动化脚本执行</td><td>嵌入到你的应用</td></tr><tr><td><strong>适合日常开发</strong></td><td>适合 CI/CD</td><td>适合构建产品</td></tr></tbody></table>
<h4 data-id="heading-11">2. 会话管理</h4>
<p>每次与 Codex 的对话都是一个"会话"（Session）。Codex 会：</p>
<ul>
<li>记住你们的对话历史</li>
<li>保存执行过的命令和结果</li>
<li>支持暂停和恢复对话</li>
</ul>
<h4 data-id="heading-12">3. 智能审批</h4>
<p>Codex 不会盲目执行所有命令。对于危险操作，它会：</p>
<pre><code class="hljs language-ini" lang="ini">你: 帮我删除所有日志文件
Codex: 我需要执行 `rm -rf ./logs/*`，这会删除所有日志。
       <span class="hljs-section">[允许执行]</span> <span class="hljs-section">[拒绝]</span> <span class="hljs-section">[白名单此命令]</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">底层协议与通信机制</h3>
<h4 data-id="heading-14">提交队列/事件队列（SQ/EQ）模式</h4>
<p>Codex 内部使用了一种高效的异步通信模式：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
sequenceDiagram
    participant User as 用户/TUI
    participant SQ as 提交队列 (SQ)
    participant Engine as Codex 核心引擎
    participant LLM as 大语言模型
    participant Tools as 工具系统
    participant EQ as 事件队列 (EQ)

    User-&gt;&gt;SQ: 提交用户输入
    Note over SQ: Op::UserTurn

    SQ-&gt;&gt;Engine: 异步接收提交
    Engine-&gt;&gt;LLM: 调用模型 API

    LLM--&gt;&gt;Engine: 流式响应
    Engine-&gt;&gt;EQ: 发送 AgentMessage 事件
    EQ--&gt;&gt;User: 实时显示 AI 回复

    LLM--&gt;&gt;Engine: 工具调用请求
    Engine-&gt;&gt;Tools: 执行工具
    Engine-&gt;&gt;EQ: 发送 ExecApprovalRequest
    EQ--&gt;&gt;User: 请求用户批准

    User-&gt;&gt;SQ: 提交批准决定
    SQ-&gt;&gt;Engine: 接收批准

    Tools--&gt;&gt;Engine: 工具执行结果
    Engine-&gt;&gt;EQ: 发送 ExecCommandOutput
    EQ--&gt;&gt;User: 显示执行结果

    Engine-&gt;&gt;LLM: 继续推理
    LLM--&gt;&gt;Engine: 最终响应
    Engine-&gt;&gt;EQ: 发送 TurnCompleted
    EQ--&gt;&gt;User: 显示完成状态

</code></pre>
<p><strong>用大白话解释</strong>：</p>
<p>想象一家餐厅：</p>
<ul>
<li><strong>提交队列（SQ）</strong> 就像顾客下单的窗口</li>
<li><strong>Codex 核心引擎</strong> 就像厨房</li>
<li><strong>事件队列（EQ）</strong> 就像出餐窗口</li>
</ul>
<p>顾客下单后不需要等在窗口，可以去座位上等。厨房做好菜后，通过出餐窗口通知顾客取餐。</p>
<h4 data-id="heading-15">核心代码结构</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 简化版的 Codex 核心结构</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Codex</span> {
    <span class="hljs-comment">// 提交队列：接收用户输入</span>
    tx_sub: Sender&lt;Submission&gt;,
    <span class="hljs-comment">// 事件队列：发送处理结果</span>
    rx_event: Receiver&lt;Event&gt;,
}
</code></pre>
<h4 data-id="heading-16">事件类型</h4>
<p>Codex 定义了丰富的事件类型来描述各种操作：</p>






























<table><thead><tr><th>事件类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>AgentMessage</code></td><td>AI 的回复</td><td>"我来帮你修复这个 bug"</td></tr><tr><td><code>ExecCommandOutput</code></td><td>命令执行结果</td><td>测试运行的输出</td></tr><tr><td><code>PatchApprovalRequest</code></td><td>请求批准文件修改</td><td>修改 config.js</td></tr><tr><td><code>TokenCount</code></td><td>Token 使用统计</td><td>输入 1000，输出 500</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">记忆系统：如何记住对话</h3>
<h4 data-id="heading-18">问题：AI 的"健忘症"</h4>
<p>大语言模型本身是"无状态"的，每次调用都是全新的开始。就像一个失忆的人，每天早上醒来都不记得昨天发生了什么。</p>
<h4 data-id="heading-19">解决方案：持久化历史</h4>
<p>Codex 通过多层记忆系统解决这个问题：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
graph TB
    subgraph ShortTerm["短期记忆 - 上下文管理器"]
        CM["ContextManager"]
        Items["对话项目列表"]
        TokenInfo["Token 统计"]
        CM --&gt; Items
        CM --&gt; TokenInfo
    end

    subgraph MediumTerm["中期记忆 - 消息历史"]
        History["history.jsonl"]
        Entry1["session_id + timestamp + text"]
        Entry2["session_id + timestamp + text"]
        Entry3["..."]
        History --&gt; Entry1
        History --&gt; Entry2
        History --&gt; Entry3
    end

    subgraph LongTerm["长期记忆 - 会话持久化"]
        Sessions["~/.codex/sessions/"]
        Session1["session_abc.json"]
        Session2["session_xyz.json"]
        Sessions --&gt; Session1
        Sessions --&gt; Session2
    end

    subgraph ProjectMemory["项目记忆 - AGENTS.md"]
        AgentsMD["AGENTS.md"]
        Rules["项目规范"]
        Constraints["约束条件"]
        AgentsMD --&gt; Rules
        AgentsMD --&gt; Constraints
    end

    User["用户"] --&gt; CM
    CM --&gt;|"保存到"| History
    CM --&gt;|"持久化"| Sessions
    AgentsMD --&gt;|"加载到"| CM

    style ShortTerm fill:#E3F2FD,stroke:#1976D2
    style MediumTerm fill:#E8F5E9,stroke:#388E3C
    style LongTerm fill:#FFF3E0,stroke:#F57C00
    style ProjectMemory fill:#F3E5F5,stroke:#7B1FA2

</code></pre>
<h4 data-id="heading-20">三层记忆架构</h4>
<h5 data-id="heading-21">1. 短期记忆：上下文管理器（ContextManager）</h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContextManager</span> {
    <span class="hljs-comment">// 当前对话的所有项目（从旧到新排序）</span>
    items: <span class="hljs-type">Vec</span>&lt;ResponseItem&gt;,
    <span class="hljs-comment">// Token 使用信息</span>
    token_info: <span class="hljs-type">Option</span>&lt;TokenUsageInfo&gt;,
}
</code></pre>
<p><strong>作用</strong>：管理当前对话中的所有消息、工具调用和结果。</p>
<h5 data-id="heading-22">2. 中期记忆：消息历史（Message History）</h5>
<p>存储位置：<code>~/.codex/history.jsonl</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"session_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"abc123"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"ts"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1699123456</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"帮我写一个排序函数"</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"session_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"abc123"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"ts"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1699123460</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"好的，这是冒泡排序的实现..."</span><span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>使用 JSONL 格式（每行一个 JSON）</li>
<li>原子写入（不会出现写一半的情况）</li>
<li>自动管理大小（超过限制会清理旧记录）</li>
</ul>
<h5 data-id="heading-23">3. 长期记忆：会话持久化</h5>
<p>存储位置：<code>~/.codex/sessions/</code></p>
<p>每个会话保存为独立的 JSON 文件，包含完整的对话状态，支持随时恢复。</p>
<h4 data-id="heading-24">项目文档记忆：AGENTS.md</h4>
<p>Codex 还会读取项目中的 <code>AGENTS.md</code> 文件，了解项目的特殊规则：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># AGENTS.md</span>

<span class="hljs-section">## 项目规范</span>
<span class="hljs-bullet">-</span> 使用 TypeScript 编写
<span class="hljs-bullet">-</span> 所有函数必须有注释
<span class="hljs-bullet">-</span> 测试覆盖率要求 80% 以上

<span class="hljs-section">## 禁止操作</span>
<span class="hljs-bullet">-</span> 不要修改 .env 文件
<span class="hljs-bullet">-</span> 不要删除 migrations 文件夹
</code></pre>
<hr/>
<h3 data-id="heading-25">上下文工程：智能管理有限的"脑容量"</h3>
<h4 data-id="heading-26">问题：上下文窗口的限制</h4>
<p>大语言模型有一个"上下文窗口"限制，就像人的工作记忆一样有限。如果对话太长，模型就会"记不住"前面的内容。</p>
<pre><code class="hljs language-css" lang="css">┌────────────────────────────────────────────────────────────┐
│                    上下文窗口示意图                          │
├────────────────────────────────────────────────────────────┤
│  <span class="hljs-selector-attr">[系统提示]</span> <span class="hljs-selector-attr">[用户1]</span> <span class="hljs-selector-attr">[AI1]</span> <span class="hljs-selector-attr">[用户2]</span> <span class="hljs-selector-attr">[AI2]</span> ... <span class="hljs-selector-attr">[用户N]</span> <span class="hljs-selector-attr">[AI N]</span>  │
│  ←─────────────── 有限的容量 ──────────────────→           │
│                                                            │
│  超出容量时：旧的内容会被"遗忘"                              │
└────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-27">解决方案：智能上下文管理</h4>
<p>Codex 采用多种策略来最大化利用有限的上下文：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
flowchart TD
    Start["开始新的对话轮次"] --&gt; Check{"检查上下文大小"}

    Check --&gt;|"&lt; 80% 窗口"| Normal["正常添加内容"]
    Check --&gt;|"&gt;= 80% 窗口"| Strategy["应用优化策略"]

    Strategy --&gt; S1["策略1: Token 估算"]
    Strategy --&gt; S2["策略2: 智能截断"]
    Strategy --&gt; S3["策略3: 对话压缩"]
    Strategy --&gt; S4["策略4: 环境差异"]

    S1 --&gt; |"每4字节≈1 token"| Estimate["快速估算大小"]
    S2 --&gt; |"保留头尾"| Truncate["删除中间内容"]
    S3 --&gt; |"AI 生成摘要"| Compact["压缩历史对话"]
    S4 --&gt; |"只发送变化"| Diff["差异化更新"]

    Estimate --&gt; Optimize["优化后的上下文"]
    Truncate --&gt; Optimize
    Compact --&gt; Optimize
    Diff --&gt; Optimize

    Normal --&gt; Send["发送给模型"]
    Optimize --&gt; Send

    Send --&gt; Response["获取模型响应"]
    Response --&gt; Update["更新 Token 统计"]
    Update --&gt; End["完成"]

    style Start fill:#4CAF50,color:#fff
    style End fill:#4CAF50,color:#fff
    style Strategy fill:#FF9800,color:#fff
    style Check fill:#2196F3,color:#fff

</code></pre>
<h4 data-id="heading-28">策略 1：Token 估算</h4>
<p>不使用精确的 tokenizer（太慢），而是用简单的启发式算法：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">const</span> APPROX_BYTES_PER_TOKEN: <span class="hljs-type">usize</span> = <span class="hljs-number">4</span>;

<span class="hljs-comment">// 估算 token 数量：每 4 个字节约等于 1 个 token</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">approx_token_count</span>(text: &amp;<span class="hljs-type">str</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">usize</span> {
    (text.<span class="hljs-title function_ invoke__">len</span>() + <span class="hljs-number">3</span>) / <span class="hljs-number">4</span>  <span class="hljs-comment">// 向上取整</span>
}
</code></pre>
<h4 data-id="heading-29">策略 2：智能截断</h4>
<p>对于过长的输出，保留头尾，删除中间：</p>
<pre><code class="hljs language-css" lang="css">原始输出（<span class="hljs-number">10000</span> 字符）：
┌─────────────────────────────────────────────────────────────┐
│ <span class="hljs-selector-attr">[头部 1000 字符]</span> <span class="hljs-selector-attr">[...中间内容...]</span> <span class="hljs-selector-attr">[尾部 1000 字符]</span>          │
└─────────────────────────────────────────────────────────────┘

截断后（<span class="hljs-number">2500</span> 字符）：
┌─────────────────────────────────────────────────────────────┐
│ <span class="hljs-selector-attr">[头部 1000 字符]</span> ... <span class="hljs-selector-attr">[省略 7500 字符]</span> ... <span class="hljs-selector-attr">[尾部 1000 字符]</span>  │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-30">策略 3：对话压缩（Compaction）</h4>
<p>当上下文接近满时，Codex 会请求 AI 对之前的对话进行"摘要"：</p>
<pre><code class="hljs language-makefile" lang="makefile">压缩前：
<span class="hljs-section">用户: 帮我看看为什么测试失败</span>
<span class="hljs-section">AI: 好的，让我运行测试... 测试结果是... 问题在于...</span>
<span class="hljs-section">用户: 修复它</span>
<span class="hljs-section">AI: 我修改了文件... 现在测试通过了</span>
<span class="hljs-section">用户: 还有其他问题吗？</span>
...（很多轮对话）

压缩后：
[摘要] 用户请求修复测试失败问题，经过分析发现是类型错误，
已修改 src/utils.ts 第 42 行，测试现已通过。
</code></pre>
<h4 data-id="heading-31">策略 4：环境上下文差异</h4>
<p>只发送变化的部分，而不是每次都发送完整的环境信息：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 首次发送完整上下文 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">environment_context</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">cwd</span>&gt;</span>/path/to/project<span class="hljs-tag">&lt;/<span class="hljs-name">cwd</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">sandbox_mode</span>&gt;</span>workspace-write<span class="hljs-tag">&lt;/<span class="hljs-name">sandbox_mode</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">shell</span>&gt;</span>bash<span class="hljs-tag">&lt;/<span class="hljs-name">shell</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">environment_context</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 之后只发送变化 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">environment_context_diff</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">cwd</span>&gt;</span>/path/to/project/src<span class="hljs-tag">&lt;/<span class="hljs-name">cwd</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 只有工作目录变了 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">environment_context_diff</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-32">工具系统：让 AI 能够"动手"</h3>
<h4 data-id="heading-33">为什么需要工具？</h4>
<p>大语言模型本身只能"说"，不能"做"。工具系统就是给 AI 装上"手"，让它能够：</p>
<ul>
<li>执行 shell 命令</li>
<li>读写文件</li>
<li>搜索代码</li>
<li>调用外部服务</li>
</ul>
<h4 data-id="heading-34">工具架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">
graph LR
    subgraph AI["AI 模型"]
        LLM["大语言模型"]
        Decision["决策: 需要使用工具"]
    end

    subgraph Router["工具路由器"]
        Registry["工具注册表"]
        Dispatch["分发器"]
    end

    subgraph Tools["内置工具"]
        Shell["Shell 执行器"]
        ReadFile["文件读取"]
        ApplyPatch["补丁应用"]
        GrepFiles["文件搜索"]
        ListDir["目录列表"]
        ViewImage["图片查看"]
    end

    subgraph External["外部工具"]
        MCP["MCP 工具"]
        WebSearch["网络搜索"]
    end

    subgraph Security["安全检查"]
        Policy["执行策略"]
        Sandbox["沙箱隔离"]
        Approval["用户审批"]
    end

    LLM --&gt; Decision
    Decision --&gt; Registry
    Registry --&gt; Dispatch

    Dispatch --&gt; Shell
    Dispatch --&gt; ReadFile
    Dispatch --&gt; ApplyPatch
    Dispatch --&gt; GrepFiles
    Dispatch --&gt; ListDir
    Dispatch --&gt; ViewImage
    Dispatch --&gt; MCP
    Dispatch --&gt; WebSearch

    Shell --&gt; Policy
    ApplyPatch --&gt; Approval
    MCP --&gt; Approval

    Policy --&gt; Sandbox
    Approval --&gt; Sandbox

    Sandbox --&gt; Result["执行结果"]
    Result --&gt; LLM

    style AI fill:#E3F2FD,stroke:#1976D2
    style Router fill:#E8F5E9,stroke:#388E3C
    style Tools fill:#FFF3E0,stroke:#F57C00
    style External fill:#F3E5F5,stroke:#7B1FA2
    style Security fill:#FCE4EC,stroke:#C2185B

</code></pre>
<h4 data-id="heading-35">内置工具列表</h4>


















































<table><thead><tr><th>工具名称</th><th>功能</th><th>示例</th></tr></thead><tbody><tr><td><code>shell</code></td><td>执行命令</td><td><code>npm test</code>, <code>git status</code></td></tr><tr><td><code>read_file</code></td><td>读取文件</td><td>查看 <code>config.json</code></td></tr><tr><td><code>list_dir</code></td><td>列出目录</td><td>浏览项目结构</td></tr><tr><td><code>apply_patch</code></td><td>修改文件</td><td>修复代码 bug</td></tr><tr><td><code>grep_files</code></td><td>搜索文件</td><td>查找函数定义</td></tr><tr><td><code>view_image</code></td><td>查看图片</td><td>分析截图</td></tr><tr><td><code>web_search</code></td><td>网络搜索</td><td>查找文档</td></tr><tr><td><code>mcp_tool</code></td><td>调用 MCP 工具</td><td>使用外部服务</td></tr></tbody></table>
<h4 data-id="heading-36">工具调用流程</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> AI 决定使用工具
   └── "我需要运行测试来验证修复"

<span class="hljs-bullet">2.</span> 生成工具调用
   └── { tool: "shell", command: "npm test" }

<span class="hljs-bullet">3.</span> 权限检查
   └── 检查执行策略和沙箱规则

<span class="hljs-bullet">4.</span> 执行工具
   └── 在沙箱中运行命令

<span class="hljs-bullet">5.</span> 返回结果
   └── 将输出返回给 AI

<span class="hljs-bullet">6.</span> AI 继续推理
   └── "测试通过了，修复成功！"
</code></pre>
<h4 data-id="heading-37">工具注册机制</h4>
<p>Codex 使用统一的工具注册表来管理所有工具：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ToolRegistry</span> {
    handlers: HashMap&lt;ToolType, <span class="hljs-type">Box</span>&lt;<span class="hljs-keyword">dyn</span> ToolHandler&gt;&gt;,
}

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">ToolHandler</span>: <span class="hljs-built_in">Send</span> + <span class="hljs-built_in">Sync</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">handle</span>(
        &amp;<span class="hljs-keyword">self</span>,
        invocation: ToolInvocation
    ) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;ToolOutput, ToolError&gt;;
}
</code></pre>
<hr/>
<h3 data-id="heading-38">安全沙箱：给 AI 一个安全的"游乐场"</h3>
<h4 data-id="heading-39">为什么需要沙箱？</h4>
<p>让 AI 执行命令是危险的。想象一下：</p>
<pre><code class="hljs language-bash" lang="bash">用户: 帮我清理项目
AI: 好的，我来执行 <span class="hljs-built_in">rm</span> -rf /  <span class="hljs-comment"># 危险！会删除整个系统！</span>
</code></pre>
<p>沙箱就是为了防止这种灾难性的操作。</p>
<h4 data-id="heading-40">沙箱原理</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">
graph TB
    subgraph Request["命令请求"]
        Cmd["执行命令: npm test"]
    end

    subgraph PolicyCheck["策略检查"]
        EP["执行策略引擎"]
        Decision{"决策"}
    end

    subgraph SandboxSelect["沙箱选择"]
        Platform{"操作系统?"}
        MacOS["macOS: Seatbelt"]
        Linux["Linux: Landlock + Seccomp"]
        Windows["Windows: RestrictedToken"]
    end

    subgraph Permissions["权限控制"]
        FS["文件系统访问"]
        Net["网络访问"]
        Proc["进程权限"]
    end

    subgraph Execution["执行环境"]
        Isolated["隔离进程"]
        Result["执行结果"]
    end

    Cmd --&gt; EP
    EP --&gt; Decision

    Decision --&gt;|"allow"| Platform
    Decision --&gt;|"prompt"| UserApproval["用户审批"]
    Decision --&gt;|"forbidden"| Blocked["拒绝执行"]

    UserApproval --&gt;|"批准"| Platform
    UserApproval --&gt;|"拒绝"| Blocked

    Platform --&gt;|"darwin"| MacOS
    Platform --&gt;|"linux"| Linux
    Platform --&gt;|"win32"| Windows

    MacOS --&gt; FS
    Linux --&gt; FS
    Windows --&gt; FS

    FS --&gt; Net
    Net --&gt; Proc
    Proc --&gt; Isolated
    Isolated --&gt; Result

    style Request fill:#E3F2FD,stroke:#1976D2
    style PolicyCheck fill:#FFF3E0,stroke:#F57C00
    style SandboxSelect fill:#E8F5E9,stroke:#388E3C
    style Permissions fill:#FCE4EC,stroke:#C2185B
    style Execution fill:#F3E5F5,stroke:#7B1FA2
    style Blocked fill:#FFCDD2,stroke:#D32F2F

</code></pre>
<h4 data-id="heading-41">三种沙箱策略</h4>





























<table><thead><tr><th>策略</th><th>文件权限</th><th>网络权限</th><th>适用场景</th></tr></thead><tbody><tr><td><code>read-only</code></td><td>只读</td><td>禁止</td><td>代码审查</td></tr><tr><td><code>workspace-write</code></td><td>工作区可写</td><td>可配置</td><td>日常开发</td></tr><tr><td><code>danger-full-access</code></td><td>完全访问</td><td>允许</td><td>特殊场景</td></tr></tbody></table>
<h4 data-id="heading-42">跨平台沙箱实现</h4>
<p>Codex 针对不同操作系统使用不同的沙箱技术：</p>
<h5 data-id="heading-43">macOS: Seatbelt</h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 生成 SBPL（Seatbelt Profile Language）策略</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">profile</span> = <span class="hljs-built_in">format!</span>(<span class="hljs-string">r#"
    (version 1)
    (deny default)
    (allow file-read* (subpath "{writable_root}"))
    (allow file-write* (subpath "{writable_root}"))
    (deny network*)
"#</span>);
</code></pre>
<h5 data-id="heading-44">Linux: Landlock + Seccomp</h5>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// Landlock：限制文件系统访问</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ruleset</span> = Ruleset::<span class="hljs-title function_ invoke__">new</span>()
    .<span class="hljs-title function_ invoke__">handle_access</span>(AccessFs::ReadFile)?
    .<span class="hljs-title function_ invoke__">create</span>()?;

<span class="hljs-comment">// Seccomp：阻止危险的系统调用</span>
<span class="hljs-title function_ invoke__">seccomp_rule_add</span>(ctx, <span class="hljs-title function_ invoke__">SCMP_ACT_ERRNO</span>(EPERM),
    <span class="hljs-title function_ invoke__">SCMP_SYS</span>(connect), <span class="hljs-number">0</span>)?;  <span class="hljs-comment">// 禁止网络连接</span>
</code></pre>
<h5 data-id="heading-45">Windows: RestrictedToken</h5>
<p>使用 Windows 的受限令牌和 ACL（访问控制列表）来限制权限。</p>
<h4 data-id="heading-46">沙箱绕过机制</h4>
<p>有时候确实需要执行受限的操作，Codex 提供了安全的升级路径：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> AI 请求执行需要额外权限的命令
<span class="hljs-bullet">2.</span> 向用户显示权限提升请求
<span class="hljs-bullet">3.</span> 用户确认后，在沙箱外执行
<span class="hljs-bullet">4.</span> 记录操作日志
</code></pre>
<hr/>
<h3 data-id="heading-47">MCP 协议：连接外部世界的桥梁</h3>
<h4 data-id="heading-48">什么是 MCP？</h4>
<p><strong>MCP（Model Context Protocol）</strong> 是一个开放协议，让 AI 助手能够与外部工具和服务交互。可以把它想象成 AI 世界的"USB 接口"。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
graph LR
    subgraph CodexCore["Codex 核心"]
        MCPManager["MCP 连接管理器"]
        ToolRouter["工具路由器"]
    end

    subgraph MCPClients["MCP 客户端连接"]
        Client1["RmcpClient #1"]
        Client2["RmcpClient #2"]
        Client3["RmcpClient #3"]
    end

    subgraph Transport["传输层"]
        Stdio["Stdio 传输"]
        HTTP["HTTP 传输"]
        OAuth["OAuth 认证"]
    end

    subgraph MCPServers["MCP 服务器"]
        GitHub["GitHub 服务器"]
        Slack["Slack 服务器"]
        Custom["自定义服务器"]
    end

    subgraph Protocol["协议层"]
        Init["1. 初始化握手"]
        ListTools["2. 获取工具列表"]
        CallTool["3. 调用工具"]
        Result["4. 返回结果"]
    end

    ToolRouter --&gt; MCPManager
    MCPManager --&gt; Client1
    MCPManager --&gt; Client2
    MCPManager --&gt; Client3

    Client1 --&gt; Stdio
    Client2 --&gt; HTTP
    Client3 --&gt; OAuth

    Stdio --&gt; GitHub
    HTTP --&gt; Custom
    OAuth --&gt; Slack

    GitHub --&gt; Init
    Init --&gt; ListTools
    ListTools --&gt; CallTool
    CallTool --&gt; Result

    style CodexCore fill:#E3F2FD,stroke:#1976D2
    style MCPClients fill:#E8F5E9,stroke:#388E3C
    style Transport fill:#FFF3E0,stroke:#F57C00
    style MCPServers fill:#F3E5F5,stroke:#7B1FA2
    style Protocol fill:#E0F7FA,stroke:#00838F


</code></pre>
<h4 data-id="heading-49">MCP 的角色</h4>
<p>Codex 可以同时作为：</p>
<ul>
<li><strong>MCP 客户端</strong>：调用其他 MCP 服务器提供的工具</li>
<li><strong>MCP 服务器</strong>：让其他应用调用 Codex 的能力</li>
</ul>
<h4 data-id="heading-50">连接外部服务示例</h4>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-comment"># ~/.codex/config.toml</span>

<span class="hljs-section">[mcp_servers.github]</span>
<span class="hljs-attr">enabled</span> = <span class="hljs-literal">true</span>

<span class="hljs-section">[mcp_servers.github.transport]</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">"stdio"</span>
<span class="hljs-attr">command</span> = <span class="hljs-string">"npx"</span>
<span class="hljs-attr">args</span> = [<span class="hljs-string">"@modelcontextprotocol/server-github"</span>]
</code></pre>
<p>配置后，Codex 就能使用 GitHub 的功能：</p>
<pre><code class="hljs language-less" lang="less">用户: 帮我创建一个 <span class="hljs-selector-tag">issue</span> 报告这个 <span class="hljs-selector-tag">bug</span>
<span class="hljs-selector-tag">Codex</span>: 好的，我来调用 <span class="hljs-selector-tag">GitHub</span> <span class="hljs-selector-tag">MCP</span> 服务器创建 <span class="hljs-selector-tag">issue</span>...
       <span class="hljs-selector-attr">[调用 mcp__github__create_issue 工具]</span>
       <span class="hljs-selector-tag">Issue</span> 已创建：<span class="hljs-selector-tag">https</span>:<span class="hljs-comment">//github.com/xxx/xxx/issues/123</span>
</code></pre>
<h4 data-id="heading-51">MCP 通信流程</h4>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────┐     JSON-RPC      ┌─────────────┐
│   Codex     │ ◄──────────────► │  MCP 服务器  │
│  (客户端)   │    over stdio    │  (GitHub)   │
└─────────────┘                   └─────────────┘

<span class="hljs-bullet">1.</span> 初始化握手：交换能力声明
<span class="hljs-bullet">2.</span> 工具列表：获取可用工具
<span class="hljs-bullet">3.</span> 工具调用：执行具体操作
<span class="hljs-bullet">4.</span> 返回结果：获取执行结果
</code></pre>
<h4 data-id="heading-52">支持的传输方式</h4>

























<table><thead><tr><th>传输方式</th><th>适用场景</th><th>示例</th></tr></thead><tbody><tr><td>stdio</td><td>本地进程</td><td>npx 启动的工具</td></tr><tr><td>HTTP</td><td>远程服务</td><td>云端 API</td></tr><tr><td>HTTP + OAuth</td><td>需要认证的服务</td><td>GitHub, Slack</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-53">执行策略：智能的权限管理</h3>
<h4 data-id="heading-54">问题：如何判断命令是否安全？</h4>
<p>不是所有命令都同样危险：</p>
<ul>
<li><code>ls</code> 完全安全</li>
<li><code>npm test</code> 通常安全</li>
<li><code>rm -rf /</code> 绝对危险</li>
<li><code>git push</code> 需要确认</li>
</ul>
<h4 data-id="heading-55">解决方案：执行策略引擎</h4>
<p>Codex 使用基于规则的执行策略系统：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">
flowchart TD
    Start["命令: git push origin main"] --&gt; Parse["解析命令 tokens"]
    Parse --&gt; Lookup["查找匹配规则"]

    subgraph Rules["规则库"]
        R1["prefix_rule(['ls'], 'allow')"]
        R2["prefix_rule(['git', 'push'], 'prompt')"]
        R3["prefix_rule(['rm', '-rf'], 'forbidden')"]
    end

    Lookup --&gt; R1
    Lookup --&gt; R2
    Lookup --&gt; R3

    R1 --&gt; Match{"匹配检查"}
    R2 --&gt; Match
    R3 --&gt; Match

    Match --&gt;|"匹配 R2"| Collect["收集匹配结果"]
    Match --&gt;|"无匹配"| Heuristics["启发式检查"]

    Heuristics --&gt;|"安全命令"| AllowH["Decision: Allow"]
    Heuristics --&gt;|"危险命令"| PromptH["Decision: Prompt"]

    Collect --&gt; MaxDecision["选择最严格决策"]

    MaxDecision --&gt; FinalAllow["Allow: 直接执行"]
    MaxDecision --&gt; FinalPrompt["Prompt: 请求用户批准"]
    MaxDecision --&gt; FinalForbid["Forbidden: 拒绝执行"]

    AllowH --&gt; FinalAllow
    PromptH --&gt; FinalPrompt

    FinalPrompt --&gt; UserChoice{"用户选择"}
    UserChoice --&gt;|"批准"| Execute["执行命令"]
    UserChoice --&gt;|"白名单"| Whitelist["添加 allow 规则"]
    UserChoice --&gt;|"拒绝"| Reject["取消执行"]

    Whitelist --&gt; Execute

    style Start fill:#2196F3,color:#fff
    style FinalAllow fill:#4CAF50,color:#fff
    style FinalPrompt fill:#FF9800,color:#fff
    style FinalForbid fill:#F44336,color:#fff
    style Rules fill:#E8F5E9,stroke:#388E3C

</code></pre>
<h4 data-id="heading-56">策略文件格式</h4>
<p>策略文件使用类 Python 的 Starlark 语言：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ~/.codex/policy/default.codexpolicy</span>

<span class="hljs-comment"># 允许常见的安全命令</span>
prefix_rule(
    pattern = [<span class="hljs-string">"ls"</span>],
    decision = <span class="hljs-string">"allow"</span>,
)

prefix_rule(
    pattern = [<span class="hljs-string">"cat"</span>],
    decision = <span class="hljs-string">"allow"</span>,
)

<span class="hljs-comment"># 需要确认的命令</span>
prefix_rule(
    pattern = [<span class="hljs-string">"git"</span>, [<span class="hljs-string">"push"</span>, <span class="hljs-string">"pull"</span>, <span class="hljs-string">"fetch"</span>]],
    decision = <span class="hljs-string">"prompt"</span>,
)

<span class="hljs-comment"># 禁止危险命令</span>
prefix_rule(
    pattern = [<span class="hljs-string">"rm"</span>, <span class="hljs-string">"-rf"</span>],
    decision = <span class="hljs-string">"forbidden"</span>,
)
</code></pre>
<h4 data-id="heading-57">决策优先级</h4>
<p>当多个规则匹配时，采用最严格的决策：</p>
<pre><code class="hljs">forbidden（禁止） &gt; prompt（提示） &gt; allow（允许）
</code></pre>
<h4 data-id="heading-58">内置安全检测</h4>
<p>除了显式规则，Codex 还有内置的启发式安全检测：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 已知的安全命令（27个）</span>
<span class="hljs-keyword">const</span> SAFE_COMMANDS: &amp;[&amp;<span class="hljs-type">str</span>] = &amp;[
    <span class="hljs-string">"cat"</span>, <span class="hljs-string">"echo"</span>, <span class="hljs-string">"ls"</span>, <span class="hljs-string">"pwd"</span>, <span class="hljs-string">"grep"</span>, <span class="hljs-string">"head"</span>, <span class="hljs-string">"tail"</span>,
    <span class="hljs-string">"wc"</span>, <span class="hljs-string">"sort"</span>, <span class="hljs-string">"uniq"</span>, <span class="hljs-string">"diff"</span>, <span class="hljs-string">"file"</span>, <span class="hljs-string">"which"</span>, <span class="hljs-string">"date"</span>,
    <span class="hljs-string">"env"</span>, <span class="hljs-string">"printenv"</span>, <span class="hljs-string">"hostname"</span>, <span class="hljs-string">"uname"</span>, <span class="hljs-string">"whoami"</span>,
    <span class="hljs-comment">// ...</span>
];

<span class="hljs-comment">// 危险命令检测</span>
<span class="hljs-keyword">fn</span> <span class="hljs-title function_">is_dangerous_command</span>(cmd: &amp;[<span class="hljs-type">String</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span> {
    matches!(cmd,
        [<span class="hljs-string">"rm"</span>, <span class="hljs-string">"-rf"</span>, ..] |
        [<span class="hljs-string">"git"</span>, <span class="hljs-string">"reset"</span>, <span class="hljs-string">"--hard"</span>, ..] |
        [<span class="hljs-string">"sudo"</span>, ..] |
        <span class="hljs-comment">// ...</span>
    )
}
</code></pre>
<h4 data-id="heading-59">动态白名单</h4>
<p>当你批准一个命令后，可以选择"白名单此命令"，Codex 会自动更新策略文件：</p>
<pre><code class="hljs language-starlark" lang="starlark"># 自动添加的规则
prefix_rule(pattern=["npm", "test"], decision="allow")
</code></pre>
<hr/>
<h3 data-id="heading-60">如何使用 Codex</h3>
<h4 data-id="heading-61">安装方式</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方式 1：通过 npm 安装</span>
npm install -g @openai/codex

<span class="hljs-comment"># 方式 2：通过 Homebrew 安装（macOS）</span>
brew install --cask codex
</code></pre>
<h4 data-id="heading-62">登录认证</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 ChatGPT 账户登录（推荐）</span>
codex login

<span class="hljs-comment"># 或者使用 API Key</span>
<span class="hljs-built_in">export</span> CODEX_API_KEY=sk-xxx
</code></pre>
<h4 data-id="heading-63">基本使用</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动交互式界面</span>
codex

<span class="hljs-comment"># 直接执行任务（非交互式）</span>
codex <span class="hljs-built_in">exec</span> <span class="hljs-string">"帮我写一个快速排序函数"</span>

<span class="hljs-comment"># 在特定目录工作</span>
codex --<span class="hljs-built_in">cd</span> /path/to/project
</code></pre>
<h4 data-id="heading-64">TypeScript SDK 使用</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Codex</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@openai/codex-sdk"</span>;

<span class="hljs-keyword">const</span> codex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Codex</span>();
<span class="hljs-keyword">const</span> thread = codex.<span class="hljs-title function_">startThread</span>({
    <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4"</span>,
    <span class="hljs-attr">sandboxMode</span>: <span class="hljs-string">"workspace-write"</span>,
    <span class="hljs-attr">workingDirectory</span>: <span class="hljs-string">"./my-project"</span>
});

<span class="hljs-comment">// 同步模式：等待完成</span>
<span class="hljs-keyword">const</span> turn = <span class="hljs-keyword">await</span> thread.<span class="hljs-title function_">run</span>(<span class="hljs-string">"帮我修复所有的 TypeScript 错误"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(turn.<span class="hljs-property">finalResponse</span>);

<span class="hljs-comment">// 流式模式：实时获取事件</span>
<span class="hljs-keyword">const</span> { events } = <span class="hljs-keyword">await</span> thread.<span class="hljs-title function_">runStreamed</span>(<span class="hljs-string">"运行测试"</span>);
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> event <span class="hljs-keyword">of</span> events) {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">type</span> === <span class="hljs-string">"item.completed"</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"完成:"</span>, event.<span class="hljs-property">item</span>);
    }
}
</code></pre>
<h4 data-id="heading-65">配置文件</h4>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-comment"># ~/.codex/config.toml</span>

<span class="hljs-comment"># 默认模型</span>
<span class="hljs-attr">model</span> = <span class="hljs-string">"gpt-4-turbo"</span>

<span class="hljs-comment"># 沙箱策略</span>
<span class="hljs-attr">sandbox_policy</span> = <span class="hljs-string">"workspace-write"</span>

<span class="hljs-comment"># 审批策略</span>
<span class="hljs-attr">approval_policy</span> = <span class="hljs-string">"on-request"</span>

<span class="hljs-comment"># MCP 服务器配置</span>
<span class="hljs-section">[mcp_servers.github]</span>
<span class="hljs-attr">enabled</span> = <span class="hljs-literal">true</span>
<span class="hljs-section">[mcp_servers.github.transport]</span>
<span class="hljs-attr">type</span> = <span class="hljs-string">"stdio"</span>
<span class="hljs-attr">command</span> = <span class="hljs-string">"npx"</span>
<span class="hljs-attr">args</span> = [<span class="hljs-string">"@modelcontextprotocol/server-github"</span>]
</code></pre>
<h3 data-id="heading-66">总结</h3>
<h4 data-id="heading-67">Codex 的设计哲学</h4>
<ol>
<li><strong>安全第一</strong>：多层沙箱、执行策略、用户审批</li>
<li><strong>可扩展性</strong>：工具系统、MCP 协议、插件架构</li>
<li><strong>智能管理</strong>：上下文压缩、记忆持久化、Token 优化</li>
<li><strong>用户体验</strong>：交互式界面、流式输出、断点续传</li>
</ol>
<h4 data-id="heading-68">技术亮点</h4>



































<table><thead><tr><th>特性</th><th>技术实现</th><th>优势</th></tr></thead><tbody><tr><td>性能</td><td>Rust 核心</td><td>接近原生速度</td></tr><tr><td>安全</td><td>多平台沙箱</td><td>系统级隔离</td></tr><tr><td>扩展</td><td>MCP 协议</td><td>开放生态</td></tr><tr><td>智能</td><td>上下文工程</td><td>高效利用模型能力</td></tr><tr><td>体验</td><td>SQ/EQ 异步模式</td><td>流畅的交互</td></tr></tbody></table>
<h4 data-id="heading-69">未来展望</h4>
<p>Codex 代表了 AI 编程助手的一个重要方向：从"建议"走向"执行"，从"对话"走向"协作"。随着 AI 能力的提升和工具生态的完善，我们可以期待更加智能、安全、高效的编程助手。</p>
<hr/>
<h3 data-id="heading-70">附录：关键文件路径速查</h3>













































<table><thead><tr><th>组件</th><th>路径</th></tr></thead><tbody><tr><td>核心引擎</td><td><code>codex-rs/core/src/codex.rs</code></td></tr><tr><td>TUI 界面</td><td><code>codex-rs/tui/src/app.rs</code></td></tr><tr><td>工具系统</td><td><code>codex-rs/core/src/tools/</code></td></tr><tr><td>沙箱实现</td><td><code>codex-rs/core/src/sandboxing/</code></td></tr><tr><td>执行策略</td><td><code>codex-rs/execpolicy/src/</code></td></tr><tr><td>MCP 客户端</td><td><code>codex-rs/rmcp-client/src/</code></td></tr><tr><td>上下文管理</td><td><code>codex-rs/core/src/context_manager/</code></td></tr><tr><td>记忆系统</td><td><code>codex-rs/core/src/message_history.rs</code></td></tr><tr><td>TypeScript SDK</td><td><code>sdk/typescript/src/</code></td></tr></tbody></table>
<hr/>
<ul>
<li>作者【<strong>前端领秀</strong>】一个喜欢探索前端领域AI赋能的开发者，喜欢我的可以关注我，私信我邀请进入技术群，我会时刻分享最新前沿AI技术；</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1736e8fdc0aa4d24b9765b4f9749ba8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56C06IynNjg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768537577&amp;x-signature=vIjb9dk8v8jFPxxjcMWQYCT2y%2FE%3D" alt="扫码_搜索联合传播样式-白色版.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[到底是用nuxt的public还是assets？一篇文章开悟]]></title>    <link>https://juejin.cn/post/7592912896591298579</link>    <guid>https://juejin.cn/post/7592912896591298579</guid>    <pubDate>2026-01-09T03:03:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592912896591298579" data-draft-id="7592710766010531850" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="到底是用nuxt的public还是assets？一篇文章开悟"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-09T03:03:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江湖文人"/> <meta itemprop="url" content="https://juejin.cn/user/3044986347066480"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            到底是用nuxt的public还是assets？一篇文章开悟
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044986347066480/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江湖文人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:03:22.000Z" title="Fri Jan 09 2026 03:03:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    22
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">assets</h2>
<blockquote>
<p><code>Nuxt</code>为你的资产提供了两种处理方式。</p>
</blockquote>
<p><code>Nuxt</code>使用两个目录来处理样式表、字体或图片等资产：</p>
<ul>
<li><code>public/</code>目录的内容会直接以服务器根路径的形式提供。</li>
<li><code>assets/</code>目录按惯例包含你希望构建工具（<code>Vite</code>或<code>webpack</code>）处理的所有资产。</li>
</ul>
<h2 data-id="heading-1">公共目录</h2>
<p><code>public/</code>目录用作静态资产的公共服务器，这些资产可以在你的应用定义的<code>URL</code>下公开访问。</p>
<p>你可以通过应用的代码或浏览器使用根<code>URL</code>/来获取<code>public/</code>目录中的文件。</p>
<h3 data-id="heading-2">示例</h3>
<p>例如，引用位于<code>public/img/</code>目录中的图像文件，可通过静态<code>URL</code>/img/nuxt.png访问：</p>
<pre><code class="hljs language-vue" lang="vue">// app.vue
&lt;template&gt;
  &lt;img src="/img/nuxt.png" alt="探索 Nuxt" /&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-3">资产目录</h2>
<p>Nuxt使用<code>Vite</code>（默认）或<code>webpack</code>来构建和打包你的应用。这些构建工具的主要功能是处理<code>JavaScript</code>文件，但可以通过<code>插件</code>（用于Vite）或<code>加载器</code>（用于webpack）扩展，以处理其他类型的资产，例如样式表、字体或<code>SVG</code>。这一过程主要为了性能或缓存目的转换原始文件（例如样式表压缩或浏览器缓存失败）。</p>
<p>按照惯例，<code>Nuxt</code>使用<code>assets/</code>目录来存储这些文件，但该目录没有自动扫描功能，你可以为它使用任何其他名称。</p>
<p>在应用代码中，可以通过<code>~/assets/</code>路径引用位于<code>assets/</code>目录中的文件。</p>
<h3 data-id="heading-4">示例</h3>
<p>例如，引用一个图像文件，如果构建工具配置为处理此文件扩展名，该文件将被处理：</p>
<pre><code class="hljs language-html" lang="html">// app.vue
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"~/assets/img/nuxt.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"探索 Nuxt"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<blockquote>
<p><code>Nuxt</code>不会以静态<code>URL</code>（如<code>/assets/my-file.png</code>）提供<code>assets/</code>目录中的文件。如果你需要静态<code>URL</code>，请使用<code>public/</code>目录。</p>
</blockquote>
<h2 data-id="heading-5">区别 —— 纠结用哪个可以看这张表</h2>



































<table><thead><tr><th>特性</th><th><code>public/</code>目录</th><th><code>assets/</code>目录</th></tr></thead><tbody><tr><td>目的</td><td><code>静态</code>资源服务器</td><td><code>构建时</code>处理的资源</td></tr><tr><td><code>URL</code>访问</td><td>直接通过根路径<code>/</code>访问</td><td>需通过<code>~/assets/</code>路径引用</td></tr><tr><td>构建处理</td><td>不经过构建工具处理</td><td>经过<code>Vite/webpack</code>处理（压缩、优化等）</td></tr><tr><td>更新方式</td><td>直接替换文件</td><td>构建后生成新文件（带哈希）</td></tr><tr><td>适用场景</td><td>不常更改的资源（如<code>favicon、robots.txt</code>）</td><td>需要构建优化的资源（图片、样式、字体）</td></tr></tbody></table>
<h3 data-id="heading-6">public/</h3>
<pre><code class="hljs language-html" lang="html">// vue
<span class="hljs-comment">&lt;!-- 适用于： --&gt;</span>
<span class="hljs-comment">&lt;!-- 不常更新的静态文件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/favicon.ico"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"网站图标"</span> /&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/brochure.pdf"</span>&gt;</span>下载手册<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">assets/</h3>
<pre><code class="hljs language-html" lang="html">// vue
<span class="hljs-comment">&lt;!-- 适用于： --&gt;</span>
<span class="hljs-comment">&lt;!-- 需要优化处理的图片 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"~/assets/images/hero.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"英雄"</span> /&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 2. 样式文件（SCSS/SASS/LESS） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-keyword">@import</span> <span class="hljs-string">'~/assets/styles/main.scss'</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 3. 字体文件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-keyword">@font-face</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'CustomFont'</span>;
  <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'~/assets/fonts/custom.woff2'</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">'woff2'</span>);
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-8">实战目录结构</h2>
<pre><code class="hljs language-html" lang="html">my-nuxt-app/
├── public/
│   ├── favicon.ico          # 直接通过 /favicon.ico 访问
│   ├── robots.txt          # 直接通过 /robots.txt 访问
│   └── downloads/
│       └── brochure.pdf    # 直接通过 /downloads/brochure.pdf 访问
├── assets/
│   ├── images/
│   │   ├── logo.png        # 构建优化后的图片
│   │   └── background.jpg
│   ├── styles/
│   │   ├── main.scss       # 编译处理的SCSS文件
│   │   └── variables.scss
│   └── fonts/
│       └── custom.woff2    # 字体文件
└── components/
    └── MyComponent.vue
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 优先使用assets/以获得构建优化  --&gt;
&lt;img src="~/assets/images/product.jpg" alt="产品" /&gt;

&lt;!-- 大尺寸或不需要优化的图片可以放在public --&gt;
&lt;img src="/documentation/large.png" alt="架构图" &gt;
</code></pre>
<h3 data-id="heading-9">动态</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
// 使用 import 获取 assets 资源（会经过构建处理）
import logo from '~/assets/images/logo.png'

// 使用相对路径引用 public 资源
const publicImage = '/images/banner.png'
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-10">css中用</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 在 CSS 中引用 assets 资源 */</span>
<span class="hljs-selector-class">.hero</span> {
  <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'~/assets/images/bg.jpg'</span>);
}

<span class="hljs-comment">/* 引用 public 资源 */</span>
<span class="hljs-selector-class">.external</span> {
  <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'/external-bg.png'</span>);
}
</code></pre>
<h2 data-id="heading-11">提醒</h2>
<ol>
<li>
<p><strong>缓存策略</strong>：</p>
<ul>
<li><code>assets/</code> 中的文件通常会添加哈希值，便于缓存管理</li>
<li><code>public/</code> 中的文件使用原始名称，需手动管理缓存</li>
</ul>
</li>
<li>
<p><strong>部署考虑</strong>：</p>
<ul>
<li><code>public/</code> 目录内容会原样复制到构建输出</li>
<li><code>assets/</code> 目录内容会被处理并打包</li>
</ul>
</li>
<li>
<p><strong>性能优化</strong>：</p>
<ul>
<li>小图标建议使用 <code>assets/</code> 以便打包优化</li>
<li>大文件（如视频）建议使用 <code>public/</code> 避免构建过程变慢</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[序章：当抓包工具遇上"铜墙铁壁"]]></title>    <link>https://juejin.cn/post/7592887786966204452</link>    <guid>https://juejin.cn/post/7592887786966204452</guid>    <pubDate>2026-01-09T03:05:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592887786966204452" data-draft-id="7592846242176450594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="序章：当抓包工具遇上&quot;铜墙铁壁&quot;"/> <meta itemprop="keywords" content="安全"/> <meta itemprop="datePublished" content="2026-01-09T03:05:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="边际效应"/> <meta itemprop="url" content="https://juejin.cn/user/626060316652204"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            序章：当抓包工具遇上"铜墙铁壁"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/626060316652204/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    边际效应
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:05:50.000Z" title="Fri Jan 09 2026 03:05:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">序章：当抓包工具遇上"铜墙铁壁"</h2>
<blockquote>
<p><strong>本章字数：约5500字</strong>
<strong>阅读时间：约18分钟</strong>
<strong>难度等级：★★☆☆☆</strong></p>
<p><strong>声明</strong>：本文中的公司名称、包名、API地址、密钥等均已脱敏处理，使用虚构名称替代。"梦想世界"、"dreamworld"等均为虚构名称，与任何真实公司无关。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">引言</h3>
<p>2026年1月5日，深夜23:15。</p>
<p>实验室里只有显示器的微光和咖啡机偶尔发出的咕噜声。我坐在工位前，手指在键盘上轻轻敲击，屏幕上的Charles Proxy正在等待连接。作为一名有十年经验的安全研究员，我已经习惯了深夜的工作节奏，也习惯了各种APP的安全防护措施。</p>
<p>但今晚，我即将遇到一个让我整整困扰多天的对手。</p>
<p>这款APP来自国内某知名新能源车企，内部代号为"dw_mall_shop"，对外显示为"梦想世界"，当前版本v8.x.x。我之所以选择这款APP进行安全测试，是因为近年来车企APP的数据安全问题日益突出。</p>
<p>用户的车辆数据、行驶轨迹、个人信息都通过这类APP进行传输，其安全防护水平直接关系到用户的隐私和财产安全。作为安全研究员，评估这类APP的安全性是我们的职责所在。</p>
<hr/>
<h3 data-id="heading-2">1.1 第一次尝试：常规抓包</h3>
<p>按照常规流程，我的第一步是进行抓包分析，了解APP与服务器之间的通信协议和数据格式。这是逆向工程的基础——只有了解了数据是如何传输的，才能进一步分析数据是如何生成的。</p>
<p>我熟练地完成了抓包环境的配置：</p>
<h4 data-id="heading-3">1.1.1 环境准备</h4>
<p><strong>测试设备</strong>：</p>
<ul>
<li>手机：Pixel 6 Pro，Android 13</li>
<li>电脑：MacBook Pro M2，macOS Ventura</li>
<li>抓包工具：Charles Proxy 4.6.4</li>
</ul>
<p><strong>配置步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 启动Charles Proxy</span>
<span class="hljs-comment"># 默认监听端口：8888</span>

<span class="hljs-comment"># 2. 在手机上配置WiFi代理</span>
<span class="hljs-comment"># 设置 -&gt; WiFi -&gt; 当前网络 -&gt; 代理 -&gt; 手动</span>
<span class="hljs-comment"># 服务器：电脑IP地址</span>
<span class="hljs-comment"># 端口：8888</span>

<span class="hljs-comment"># 3. 安装Charles根证书</span>
<span class="hljs-comment"># 在手机浏览器访问 chls.pro/ssl</span>
<span class="hljs-comment"># 下载并安装证书</span>
<span class="hljs-comment"># 设置 -&gt; 安全 -&gt; 加密与凭据 -&gt; 安装证书</span>
</code></pre>
<p><strong>验证配置</strong>：</p>
<p>为了确认代理配置正确，我先用手机浏览器访问了几个网站：</p>
<pre><code class="hljs language-arduino" lang="arduino">✓ https:<span class="hljs-comment">//www.baidu.com - Charles成功捕获</span>
✓ https:<span class="hljs-comment">//www.google.com - Charles成功捕获</span>
✓ https:<span class="hljs-comment">//api.github.com - Charles成功捕获</span>
</code></pre>
<p>一切正常。代理配置没有问题。</p>
<h4 data-id="heading-4">1.1.2 启动目标APP</h4>
<p>深吸一口气，我点击了"梦想世界"的图标。</p>
<p>APP正常启动了。启动画面、加载动画、主界面——一切看起来都很正常。我开始在APP中进行各种操作：</p>
<ul>
<li>浏览商城首页</li>
<li>查看商品详情</li>
<li>搜索商品</li>
<li>查看个人中心</li>
</ul>
<p>APP响应流畅，数据加载正常，图片显示清晰。从用户体验的角度来看，这是一款非常优秀的APP。</p>
<p><strong>然而，当我切换到Charles窗口时，我愣住了。</strong></p>
<p>Charles的请求列表——<strong>空空如也</strong>。</p>
<p>没有任何HTTP请求。没有任何HTTPS请求。什么都没有。</p>
<p>我以为是自己眼花了，揉了揉眼睛，仔细看了看屏幕。确实是空的。</p>
<h4 data-id="heading-5">1.1.3 排查问题</h4>
<p>"不可能啊，"我自言自语道，"APP明明在正常加载数据，怎么可能没有网络请求？"</p>
<p>我开始排查可能的问题：</p>
<p><strong>检查1：代理配置</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在手机上确认代理设置</span>
设置 -&gt; WiFi -&gt; 当前网络 -&gt; 代理
<span class="hljs-comment"># 显示：手动，服务器：192.168.1.100，端口：8888</span>
<span class="hljs-comment"># 配置正确 ✓</span>
</code></pre>
<p><strong>检查2：Charles监听状态</strong></p>
<pre><code class="hljs language-bash" lang="bash">Charles -&gt; Proxy -&gt; Proxy Settings
<span class="hljs-comment"># 端口：8888</span>
<span class="hljs-comment"># 启用透明代理：是</span>
<span class="hljs-comment"># 状态正常 ✓</span>
</code></pre>
<p><strong>检查3：证书安装</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在手机上确认证书</span>
设置 -&gt; 安全 -&gt; 加密与凭据 -&gt; 用户凭据
<span class="hljs-comment"># 显示：Charles Proxy CA</span>
<span class="hljs-comment"># 证书已安装 ✓</span>
</code></pre>
<p><strong>检查4：其他APP测试</strong></p>
<p>我打开了手机上的其他几个APP进行测试：</p>
<pre><code class="hljs">✓ 微信 - Charles成功捕获请求
✓ 淘宝 - Charles成功捕获请求
✓ 抖音 - Charles成功捕获请求
</code></pre>
<p>其他APP都能正常抓包，只有"梦想世界"抓不到。</p>
<p><strong>这说明问题出在APP本身，而不是我的抓包环境。</strong></p>
<hr/>
<h3 data-id="heading-6">1.2 深入分析：为什么抓不到？</h3>
<h4 data-id="heading-7">1.2.1 排除SSL Pinning</h4>
<p>我的第一反应是：这可能是SSL Pinning导致的。</p>
<p>SSL Pinning（证书锁定）是一种常见的安全措施，APP会验证服务器证书是否与预期的证书匹配。如果不匹配（比如使用了Charles的代理证书），就会拒绝连接。</p>
<p>但是，SSL Pinning通常会导致以下现象：</p>
<ul>
<li>APP显示网络错误</li>
<li>APP提示"无法连接到服务器"</li>
<li>Charles中显示SSL握手失败</li>
</ul>
<p>而我观察到的现象是：</p>
<ul>
<li>APP正常运行</li>
<li>数据正常加载</li>
<li>Charles中什么都没有</li>
</ul>
<p><strong>这不像是SSL Pinning的表现。</strong></p>
<h4 data-id="heading-8">1.2.2 一个关键发现</h4>
<p>就在我百思不得其解的时候，我想起了一件事。</p>
<p>前几天，我在这台手机上安装了一款科学上网工具（类似VPN的代理软件），用于访问一些国外的技术文档。这款工具使用的是SOCKS5代理协议。</p>
<p>我突然好奇：如果开启这个科学上网工具，"梦想世界"APP还能正常使用吗？</p>
<p>我打开了科学上网工具，然后启动"梦想世界"APP。</p>
<p><strong>APP完全正常！</strong></p>
<p>数据加载正常，功能使用正常，没有任何异常提示。</p>
<p>这个发现让我陷入了沉思。</p>
<h4 data-id="heading-9">1.2.3 代理类型的差异</h4>
<p>让我们来分析一下不同代理类型的工作原理：</p>
<p><strong>HTTP代理（Charles使用）</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────┐    HTTP请求    ┌─────────┐    HTTP请求    ┌─────────┐
│   APP   │ ────────────&gt; │  Charles │ ────────────&gt; │  服务器  │
└─────────┘               └─────────┘               └─────────┘
<span class="hljs-code">                               │
                          解析HTTP协议
                          记录请求内容
</span></code></pre>
<p><strong>SOCKS5代理（科学上网工具使用）</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────┐    TCP连接     ┌─────────┐    TCP连接     ┌─────────┐
│   APP   │ ────────────&gt; │  SOCKS5  │ ────────────&gt; │  服务器  │
└─────────┘               └─────────┘               └─────────┘
<span class="hljs-code">                               │
                          只转发TCP数据
                          不解析应用层协议
</span></code></pre>
<p><strong>关键区别</strong>：</p>
<ul>
<li>HTTP代理工作在应用层（第7层），需要解析HTTP协议</li>
<li>SOCKS5代理工作在会话层（第5层），只负责转发TCP数据</li>
</ul>
<p><strong>这意味着什么？</strong></p>
<p>APP可能实现了这样的逻辑：</p>
<ol>
<li>检测系统是否设置了HTTP代理</li>
<li>如果检测到HTTP代理，就绕过系统网络栈，使用自定义的网络通信方式</li>
<li>如果没有检测到HTTP代理（或者是SOCKS代理），就正常通信</li>
</ol>
<p>这是一种<strong>精准打击</strong>的策略：</p>
<ul>
<li>针对安全研究员的抓包工具（HTTP代理）：完全失效</li>
<li>针对普通用户的科学上网需求（SOCKS代理）：正常使用</li>
</ul>
<p><strong>太精妙了！</strong></p>
<hr/>
<h3 data-id="heading-10">1.3 验证假设：代理检测机制</h3>
<h4 data-id="heading-11">1.3.1 系统代理检测</h4>
<p>在Android系统中，HTTP代理设置可以通过以下方式获取：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方法1：通过System.getProperty获取</span>
<span class="hljs-type">String</span> <span class="hljs-variable">proxyHost</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"http.proxyHost"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">proxyPort</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"http.proxyPort"</span>);

<span class="hljs-comment">// 方法2：通过ProxySelector获取</span>
<span class="hljs-type">ProxySelector</span> <span class="hljs-variable">selector</span> <span class="hljs-operator">=</span> ProxySelector.getDefault();
List&lt;Proxy&gt; proxies = selector.select(<span class="hljs-keyword">new</span> <span class="hljs-title class_">URI</span>(<span class="hljs-string">"https://api.example.com"</span>));

<span class="hljs-comment">// 方法3：通过ConnectivityManager获取（Android特有）</span>
<span class="hljs-type">ConnectivityManager</span> <span class="hljs-variable">cm</span> <span class="hljs-operator">=</span> (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE);
<span class="hljs-type">ProxyInfo</span> <span class="hljs-variable">proxyInfo</span> <span class="hljs-operator">=</span> cm.getDefaultProxy();
</code></pre>
<p>如果APP在发起网络请求之前检测这些值，就能知道系统是否设置了HTTP代理。</p>
<h4 data-id="heading-12">1.3.2 WiFi代理检测</h4>
<p>除了系统级别的代理设置，Android还支持针对特定WiFi网络设置代理：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 获取当前WiFi配置</span>
<span class="hljs-type">WifiManager</span> <span class="hljs-variable">wifiManager</span> <span class="hljs-operator">=</span> (WifiManager) context.getSystemService(Context.WIFI_SERVICE);
<span class="hljs-type">WifiInfo</span> <span class="hljs-variable">wifiInfo</span> <span class="hljs-operator">=</span> wifiManager.getConnectionInfo();
<span class="hljs-type">WifiConfiguration</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> getWifiConfiguration(wifiInfo.getNetworkId());

<span class="hljs-comment">// 检查代理设置</span>
<span class="hljs-keyword">if</span> (config.getProxySettings() == ProxySettings.STATIC) {
    <span class="hljs-type">ProxyInfo</span> <span class="hljs-variable">proxyInfo</span> <span class="hljs-operator">=</span> config.getHttpProxy();
    <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> proxyInfo.getHost();
    <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> proxyInfo.getPort();
    <span class="hljs-comment">// 检测到代理！</span>
}
</code></pre>
<h4 data-id="heading-13">1.3.3 绕过代理的方法</h4>
<p>一旦检测到代理，APP可以使用以下方法绕过：</p>
<p><strong>方法1：使用NO_PROXY</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建不使用代理的OkHttpClient</span>
<span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.Builder()
    .proxy(Proxy.NO_PROXY)  <span class="hljs-comment">// 明确指定不使用代理</span>
    .build();
</code></pre>
<p><strong>方法2：自定义SocketFactory</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建直连的Socket，绕过系统代理</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DirectSocketFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SocketFactory</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Socket <span class="hljs-title function_">createSocket</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>();
        <span class="hljs-comment">// 直接连接，不经过代理</span>
        <span class="hljs-keyword">return</span> socket;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Socket <span class="hljs-title function_">createSocket</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>();
        socket.connect(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InetSocketAddress</span>(host, port));
        <span class="hljs-keyword">return</span> socket;
    }
}
</code></pre>
<p><strong>方法3：使用自定义DNS</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 绕过系统DNS，直接使用IP地址</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DirectDns</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Dns</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;InetAddress&gt; <span class="hljs-title function_">lookup</span><span class="hljs-params">(String hostname)</span> <span class="hljs-keyword">throws</span> UnknownHostException {
        <span class="hljs-comment">// 使用硬编码的IP地址，或者自定义DNS服务器</span>
        <span class="hljs-keyword">if</span> (hostname.equals(<span class="hljs-string">"api.dreamworld.com"</span>)) {
            <span class="hljs-keyword">return</span> Arrays.asList(InetAddress.getByName(<span class="hljs-string">"1.2.3.4"</span>));
        }
        <span class="hljs-keyword">return</span> Dns.SYSTEM.lookup(hostname);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-14">1.4 更多尝试：寻找突破口</h3>
<h4 data-id="heading-15">1.4.1 VPN抓包</h4>
<p>既然HTTP代理不行，我尝试使用VPN方式抓包。</p>
<p><strong>工具：HttpCanary</strong></p>
<p>HttpCanary是一款Android平台的抓包工具，它通过创建本地VPN来捕获所有网络流量。</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────┐    所有流量    ┌─────────────┐    转发    ┌─────────┐
│   APP   │ ────────────&gt; │ HttpCanary  │ ────────&gt; │  服务器  │
└─────────┘               │   (VPN)     │           └─────────┘
<span class="hljs-code">                          └─────────────┘
                                │
                           捕获所有流量
</span></code></pre>
<p><strong>测试结果</strong>：</p>
<p>安装HttpCanary，启动VPN，然后打开"梦想世界"APP。</p>
<p><strong>依然抓不到任何数据。</strong></p>
<p>APP正常运行，但HttpCanary中没有任何来自"梦想世界"的请求记录。</p>
<h4 data-id="heading-16">1.4.2 iptables流量转发</h4>
<p>在Root设备上，我尝试使用iptables强制转发所有流量：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 将所有443端口的流量转发到本地代理</span>
iptables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-port 8888

<span class="hljs-comment"># 将所有80端口的流量转发到本地代理</span>
iptables -t nat -A OUTPUT -p tcp --dport 80 -j REDIRECT --to-port 8888
</code></pre>
<p><strong>测试结果</strong>：</p>
<p><strong>还是抓不到。</strong></p>
<p>APP似乎使用了非标准端口，或者有其他方式绑过iptables规则。</p>
<h4 data-id="heading-17">1.4.3 Wireshark抓包</h4>
<p>作为最后的尝试，我使用Wireshark在路由器层面抓包：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在路由器上运行tcpdump</span>
tcpdump -i eth0 host 手机IP -w capture.pcap
</code></pre>
<p><strong>测试结果</strong>：</p>
<p>终于抓到了一些数据！但是：</p>
<ul>
<li>所有数据都是加密的（TLS 1.3）</li>
<li>无法看到HTTP请求的具体内容</li>
<li>只能看到连接的目标IP和端口</li>
</ul>
<p>这证实了APP确实在进行网络通信，只是我们无法通过常规手段看到通信内容。</p>
<hr/>
<h3 data-id="heading-18">1.5 阶段性总结</h3>
<p>经过一个晚上的尝试，我对这款APP的网络防护有了初步了解：</p>
<h4 data-id="heading-19">1.5.1 防护特点</h4>

























<table><thead><tr><th>特点</th><th>说明</th></tr></thead><tbody><tr><td><strong>精准检测</strong></td><td>只检测HTTP代理，不影响SOCKS代理</td></tr><tr><td><strong>静默处理</strong></td><td>检测到代理后不崩溃，而是切换通信方式</td></tr><tr><td><strong>用户友好</strong></td><td>普通用户完全感知不到异常</td></tr><tr><td><strong>多层防护</strong></td><td>HTTP代理、VPN、iptables都无法突破</td></tr></tbody></table>
<h4 data-id="heading-20">1.5.2 技术推测</h4>
<p>基于观察到的现象，我推测APP可能使用了以下技术：</p>
<ol>
<li><strong>代理检测</strong>：在应用启动时检测系统代理设置</li>
<li><strong>通信切换</strong>：检测到代理后，切换到直连模式</li>
<li><strong>自定义网络栈</strong>：使用自定义的Socket实现，绕过系统网络层</li>
<li><strong>非标准端口</strong>：可能使用非80/443的端口进行通信</li>
</ol>
<h4 data-id="heading-21">1.5.3 下一步计划</h4>
<p>既然网络层的抓包行不通，我需要换一个思路：</p>
<ol>
<li><strong>静态分析</strong>：反编译APK，分析代码逻辑</li>
<li><strong>动态调试</strong>：使用Frida等工具Hook网络请求</li>
<li><strong>模拟执行</strong>：如果动态调试也被阻止，考虑使用Unidbg</li>
</ol>
<hr/>
<h3 data-id="heading-22">1.6 意外发现：Frida的命运</h3>
<p>在结束这个晚上的工作之前，我决定快速尝试一下Frida。</p>
<p>Frida是一款强大的动态插桩工具，可以在运行时注入代码到目标进程中。如果能用Frida Hook住网络请求相关的函数，就能看到APP发送的数据。</p>
<h4 data-id="heading-23">1.6.1 准备Frida环境</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装Frida</span>
pip install frida-tools

<span class="hljs-comment"># 在手机上启动frida-server</span>
adb push frida-server /data/local/tmp/
adb shell <span class="hljs-built_in">chmod</span> +x /data/local/tmp/frida-server
adb shell /data/local/tmp/frida-server &amp;
</code></pre>
<h4 data-id="heading-24">1.6.2 编写Hook脚本</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// hook_network.js</span>
<span class="hljs-title class_">Java</span>.<span class="hljs-title function_">perform</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[*] Starting network hook..."</span>);
    
    <span class="hljs-comment">// Hook OkHttp的请求方法</span>
    <span class="hljs-keyword">var</span> <span class="hljs-title class_">OkHttpClient</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">'okhttp3.OkHttpClient'</span>);
    <span class="hljs-keyword">var</span> <span class="hljs-title class_">Request</span> = <span class="hljs-title class_">Java</span>.<span class="hljs-title function_">use</span>(<span class="hljs-string">'okhttp3.Request'</span>);
    
    <span class="hljs-title class_">OkHttpClient</span>.<span class="hljs-property">newCall</span>.<span class="hljs-property">implementation</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">request</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[*] ========== New Request =========="</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[*] URL: "</span> + request.<span class="hljs-title function_">url</span>().<span class="hljs-title function_">toString</span>());
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[*] Method: "</span> + request.<span class="hljs-title function_">method</span>());
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[*] Headers: "</span> + request.<span class="hljs-title function_">headers</span>().<span class="hljs-title function_">toString</span>());
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">newCall</span>(request);
    };
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"[*] Hook installed!"</span>);
});
</code></pre>
<h4 data-id="heading-25">1.6.3 运行Frida</h4>
<pre><code class="hljs language-bash" lang="bash">frida -U -f com.dreamworld.app -l hook_network.js --no-pause
</code></pre>
<p><strong>结果</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">     ____
    / _  |   Frida 16.1.4 - A world-class dynamic instrumentation toolkit
   | (_| |
    &gt; _  |   Commands:
   /_/ |_|       <span class="hljs-built_in">help</span>      -&gt; Displays the <span class="hljs-built_in">help</span> system
   . . . .       object?   -&gt; Display information about <span class="hljs-string">'object'</span>
   . . . .       <span class="hljs-built_in">exit</span>/quit -&gt; Exit
   . . . .
   . . . .   More info at https://frida.re/docs/home/
   . . . .
   . . . .   Connected to Pixel 6 Pro (<span class="hljs-built_in">id</span>=192.168.1.101:5555)
Spawning `com.dreamworld.app`...
Process crashed: Segmentation fault
</code></pre>
<p><strong>APP直接崩溃了！</strong></p>
<p>Frida注入后，APP立即发生段错误（Segmentation fault）并退出。</p>
<p>这说明APP实现了<strong>反Frida检测机制</strong>。一旦检测到Frida的存在，就会触发崩溃，阻止任何动态调试。</p>
<h4 data-id="heading-26">1.6.4 这意味着什么？</h4>
<p>这款APP的安全防护不仅仅是网络层的：</p>

























<table><thead><tr><th>防护层</th><th>防护措施</th><th>效果</th></tr></thead><tbody><tr><td>网络层</td><td>代理检测 + 通信切换</td><td>抓包工具失效</td></tr><tr><td>运行时</td><td>Frida检测</td><td>动态调试失败</td></tr><tr><td>???</td><td>???</td><td>待发现</td></tr></tbody></table>
<p>看来，这将是一场持久战。</p>
<hr/>
<h3 data-id="heading-27">1.7 本章小结</h3>
<h4 data-id="heading-28">1.7.1 关键发现</h4>
<ol>
<li><strong>抓包完全失效</strong>：Charles、HttpCanary、iptables都无法捕获APP的网络请求</li>
<li><strong>精准代理检测</strong>：APP只检测HTTP代理，SOCKS代理可以正常使用</li>
<li><strong>静默通信切换</strong>：检测到代理后不崩溃，而是切换到直连模式</li>
<li><strong>Frida被检测</strong>：动态调试工具注入后APP直接崩溃</li>
</ol>
<h4 data-id="heading-29">1.7.2 技术启示</h4>
<p>这款APP展示了现代移动应用安全防护的一个重要趋势：<strong>精准打击 + 用户友好</strong>。</p>
<ul>
<li><strong>精准打击</strong>：只针对安全研究员的工具（HTTP代理、Frida），不影响普通用户</li>
<li><strong>用户友好</strong>：检测到威胁后不是简单崩溃，而是静默处理，保证用户体验</li>
</ul>
<p>这种设计思路值得所有移动开发者学习。</p>
<h4 data-id="heading-30">1.7.3 下一步</h4>
<p>既然网络抓包和动态调试都行不通，我需要：</p>
<ol>
<li><strong>静态分析</strong>：反编译APK，从代码层面理解APP的工作原理</li>
<li><strong>寻找突破口</strong>：分析代理检测和Frida检测的具体实现</li>
<li><strong>探索新工具</strong>：考虑使用Unidbg等离线模拟执行工具</li>
</ol>
<hr/>
<h3 data-id="heading-31">本章思考题</h3>
<ol>
<li>
<p>为什么APP选择"静默切换通信方式"而不是"直接崩溃"？这种设计有什么优缺点？</p>
</li>
<li>
<p>如果你是这款APP的安全工程师，你会如何改进现有的代理检测机制？</p>
</li>
<li>
<p>除了HTTP代理检测，还有哪些方法可以阻止抓包分析？</p>
</li>
</ol>
<h3 data-id="heading-32">章节附录</h3>
<h4 data-id="heading-33">A. 本章涉及的工具</h4>






























<table><thead><tr><th>工具</th><th>用途</th><th>官网</th></tr></thead><tbody><tr><td>Charles Proxy</td><td>HTTP/HTTPS抓包</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.charlesproxy.com%2F" target="_blank" title="https://www.charlesproxy.com/" ref="nofollow noopener noreferrer">www.charlesproxy.com/</a></td></tr><tr><td>HttpCanary</td><td>Android VPN抓包</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fhttpcanary.com%2F" target="_blank" title="https://httpcanary.com/" ref="nofollow noopener noreferrer">httpcanary.com/</a></td></tr><tr><td>Frida</td><td>动态插桩</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrida.re%2F" target="_blank" title="https://frida.re/" ref="nofollow noopener noreferrer">frida.re/</a></td></tr><tr><td>Wireshark</td><td>网络协议分析</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.wireshark.org%2F" target="_blank" title="https://www.wireshark.org/" ref="nofollow noopener noreferrer">www.wireshark.org/</a></td></tr></tbody></table>
<h4 data-id="heading-34">B. 本章关键代码</h4>
<p><strong>代理检测示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isProxySet</span><span class="hljs-params">()</span> {
    <span class="hljs-type">String</span> <span class="hljs-variable">proxyHost</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">"http.proxyHost"</span>);
    <span class="hljs-keyword">return</span> proxyHost != <span class="hljs-literal">null</span> &amp;&amp; !proxyHost.isEmpty();
}
</code></pre>
<p><strong>绕过代理示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">OkHttpClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OkHttpClient</span>.Builder()
    .proxy(Proxy.NO_PROXY)
    .build();
</code></pre>
<h4 data-id="heading-35">C. 参考资料</h4>
<ol>
<li>Android Proxy Settings: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Freference%2Fandroid%2Fnet%2FProxyInfo" target="_blank" title="https://developer.android.com/reference/android/net/ProxyInfo" ref="nofollow noopener noreferrer">developer.android.com/reference/a…</a></li>
<li>OkHttp Proxy Configuration: <a href="https://link.juejin.cn?target=https%3A%2F%2Fsquare.github.io%2Fokhttp%2F" target="_blank" title="https://square.github.io/okhttp/" ref="nofollow noopener noreferrer">square.github.io/okhttp/</a></li>
<li>Frida Documentation: <a href="https://link.juejin.cn?target=https%3A%2F%2Ffrida.re%2Fdocs%2F" target="_blank" title="https://frida.re/docs/" ref="nofollow noopener noreferrer">frida.re/docs/</a></li>
</ol>
<hr/>
<p><em>本章完</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL文本处理：全库搜索慢？正则清洗难？掌握这 3 个方法]]></title>    <link>https://juejin.cn/post/7592622563547496483</link>    <guid>https://juejin.cn/post/7592622563547496483</guid>    <pubDate>2026-01-08T20:04:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592622563547496483" data-draft-id="7592819937652670479" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL文本处理：全库搜索慢？正则清洗难？掌握这 3 个方法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-08T20:04:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="数据小馒头"/> <meta itemprop="url" content="https://juejin.cn/user/48851852475720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL文本处理：全库搜索慢？正则清洗难？掌握这 3 个方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/48851852475720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    数据小馒头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T20:04:16.000Z" title="Thu Jan 08 2026 20:04:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数据库开发中，我们最不愿意面对的往往不是复杂的 Join，而是“文本处理”。</p>
<ul>
<li><strong>模糊搜索：</strong> 业务方要求“搜索包含‘苹果’的所有商品”，开发人员反手一个 LIKE '%苹果%'，导致全表扫描，数据库 CPU 飙升。</li>
<li><strong>数据清洗：</strong> 历史数据里混入了非法的手机号格式，需要清洗，只能写 Python 脚本把几百万条数据拉出来跑正则。</li>
<li><strong>多行合并：</strong> 前端要求把“用户拥有的所有标签”合并成一个逗号分隔的字符串返回，后端只能在内存里拼接。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e74639a8ba64780b1013728cb2c313d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768507455&amp;x-signature=JzXF85aNWc7U9qmGgUPUKJfNW8I%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">一、 拒绝全表扫描：LIKE 的替代者——全文索引 (Full-Text)</h2>
<p>场景复现：</p>
<p>表 t_articles 有 100 万篇文章。需求是搜索内容中包含 "database" 的文章。</p>
<p><strong>低效解法：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_articles <span class="hljs-keyword">WHERE</span> content <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'%database%'</span>;
</code></pre>
<p>原理分析：</p>
<p>标准的 B+ 树索引只能支持前缀匹配（LIKE 'database%'）。一旦通配符 % 出现在开头，索引立即失效，数据库必须逐行扫描（Full Table Scan），性能复杂度为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span>。</p>
<p><strong>技术解法：倒排索引 (Inverted Index)</strong></p>
<p>MySQL InnoDB 引擎支持 <strong>全文索引 (Full-Text Index)</strong>。它通过分词构建“词 -&gt; 文档ID”的倒排映射，实现 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 或 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>o</mi><mi>g</mi><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(logN)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span> 级别的搜索。</p>
<p><strong>1. 创建索引：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> t_articles <span class="hljs-keyword">ADD</span> FULLTEXT INDEX ft_content (content);
</code></pre>
<p><strong>2. 使用 MATCH ... AGAINST 语法：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_articles 
<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(content) AGAINST(<span class="hljs-string">'database'</span> <span class="hljs-keyword">IN</span> <span class="hljs-keyword">NATURAL</span> <span class="hljs-keyword">LANGUAGE</span> MODE);
</code></pre>
<p><strong>实战注意点：</strong></p>
<ul>
<li><strong>最小词长：</strong> 默认情况下，少于 3 个字符的词（如 "it", "is"）会被忽略。可以通过 innodb_ft_min_token_size 调整。</li>
<li><strong>停用词 (Stopwords)：</strong> 常见的无意义词汇（"the", "and"）会被自动过滤。</li>
<li><strong>分词器：</strong> 对于中文搜索，必须使用 ngram 分词器（WITH PARSER ngram），否则无法正确切分中文词组。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9688c18513b549de9cfa9e74b6fb2573~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768507455&amp;x-signature=tc%2FIK1qTxdWSzo9u%2Fdd3spveFxw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、 SQL 里的瑞士军刀：正则表达式 (RegExp)</h2>
<p>场景复现：</p>
<p>数据表中混入了脏数据，需要找出所有“非法的邮箱地址”进行标记；或者需要将手机号的中间四位脱敏为 ****。</p>
<p>低效解法：</p>
<p>LIKE 只能做简单的通配，无法表达“数字出现3次”这种逻辑。通常做法是写脚本把数据 Select 出来，用代码里的正则库处理完再 Update 回去。</p>
<p><strong>技术解法：MySQL 8.0 的正则函数族</strong></p>
<p>MySQL 8.0 引入了基于 ICU 库的完整正则支持（之前版本仅支持简单的 REGEXP 匹配）。</p>
<p><strong>1. 查找脏数据 (REGEXP)：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查找不包含 @ 符号，或者不以 .com/.net 等结尾的邮箱</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_users 
<span class="hljs-keyword">WHERE</span> email <span class="hljs-keyword">NOT</span> REGEXP <span class="hljs-string">'^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'</span>;
</code></pre>
<p>2. 提取数据 (REGEXP_SUBSTR)：</p>
<p>从复杂的 JSON 字符串或日志文本中提取特定 ID：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 提取 "Order ID: 12345 Created" 中的数字</span>
<span class="hljs-keyword">SELECT</span> REGEXP_SUBSTR(log_content, <span class="hljs-string">'[0-9]+'</span>) <span class="hljs-keyword">FROM</span> t_logs;
</code></pre>
<p>3. 数据清洗与脱敏 (REGEXP_REPLACE) —— 杀手级功能：</p>
<p>直接在 SQL 层完成脱敏，无需应用层介入。</p>
<pre><code class="hljs language-scss" lang="scss">-- 将手机号 <span class="hljs-number">13812345678</span> 替换为 <span class="hljs-number">138</span>****<span class="hljs-number">5678</span>
-- 逻辑：捕获前<span class="hljs-number">3</span>位($<span class="hljs-number">1</span>)，忽略中间<span class="hljs-number">4</span>位，捕获后<span class="hljs-number">4</span>位($<span class="hljs-number">2</span>)，重新拼接
UPDATE t_users 
SET phone = <span class="hljs-built_in">REGEXP_REPLACE</span>(phone, '^([<span class="hljs-number">0</span>-<span class="hljs-number">9</span>]{<span class="hljs-number">3</span>})<span class="hljs-selector-attr">[0-9]</span>{<span class="hljs-number">4</span>}([<span class="hljs-number">0</span>-<span class="hljs-number">9</span>]{<span class="hljs-number">4</span>})$', '$<span class="hljs-number">1</span>****$<span class="hljs-number">2</span>');
</code></pre>
<h2 data-id="heading-2">三、 行转列利器：GROUP_CONCAT 的陷阱与优化</h2>
<p>场景复现：</p>
<p>用户表 t_users 和 标签表 t_tags 是多对多关系。</p>
<p>前端 API 需要返回如下格式：</p>
<p>{ "user_id": 1, "tags": "Developer, Admin, VIP" }</p>
<p>低效解法：</p>
<p>先查用户，再循环查标签（N+1 查询）；或者查出所有关联数据，在应用层做 Map 聚合。</p>
<p><strong>技术解法：GROUP_CONCAT</strong></p>
<p>MySQL 提供了一个聚合函数，专门用于将“多行数据”合并为“一行字符串”。</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">SELECT</span> 
    u.id, 
    u.username,
    -- 将该用户的所有 tag_name 用逗号连接
    GROUP_CONCAT(t.tag_name <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> t.id DESC SEPARATOR <span class="hljs-comment">', ') as tags</span>
<span class="hljs-keyword">FROM</span> t_users u
<span class="hljs-keyword">JOIN</span> t_user_tags ut <span class="hljs-keyword">ON</span> u.id = ut.user_id
<span class="hljs-keyword">JOIN</span> t_tags t <span class="hljs-keyword">ON</span> ut.tag_id = t.id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> u.id;
</code></pre>
<p><strong>⚠️ 致命陷阱：默认长度限制</strong></p>
<p>很多开发者在开发环境测试没问题，一上生产环境发现标签被截断了。</p>
<p>这是因为 MySQL 对 GROUP_CONCAT 的结果长度有限制，由系统变量 group_concat_max_len 控制。</p>
<ul>
<li><strong>默认值：</strong> 仅 <strong>1024 字节</strong>。如果合并后的字符串超过 1KB，会被静默截断，且<strong>不会报错</strong>。</li>
</ul>
<p>解决方案：</p>
<p>在执行 SQL 前，或者在 Session 级别调大该参数：</p>
<pre><code class="hljs language-ini" lang="ini">SET SESSION <span class="hljs-attr">group_concat_max_len</span> = <span class="hljs-number">102400</span><span class="hljs-comment">; -- 设置为 100KB</span>
SELECT ...
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c199cb2df7124b55ae158a7db366e624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768507455&amp;x-signature=BT8shMIiv6DKflecXDXAeK%2BGVj4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">总结</h2>
<p>数据库不仅仅是存储引擎，它同样具备强大的计算和处理能力。</p>
<ol>
<li><strong>搜索：</strong> 遇到模糊匹配，别无脑 LIKE。如果数据量大且需要自然语言处理，请启用 <strong>Full-Text Index</strong>。</li>
<li><strong>清洗：</strong> 善用 MySQL 8.0 的 <strong>REGEXP_REPLACE</strong>，它能让你用一句 SQL 完成百万级数据的清洗和脱敏，效率远超 Python 脚本。</li>
<li><strong>聚合：</strong> 使用 <strong>GROUP_CONCAT</strong> 简化“一对多”查询，但永远不要忘记检查 group_concat_max_len 参数。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL并发与锁：从“防止超卖”到排查“死锁”]]></title>    <link>https://juejin.cn/post/7592819937652637711</link>    <guid>https://juejin.cn/post/7592819937652637711</guid>    <pubDate>2026-01-08T19:58:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592819937652637711" data-draft-id="7592819937652621327" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL并发与锁：从“防止超卖”到排查“死锁” "/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-08T19:58:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="数据小馒头"/> <meta itemprop="url" content="https://juejin.cn/user/48851852475720"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL并发与锁：从“防止超卖”到排查“死锁” 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/48851852475720/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    数据小馒头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T19:58:29.000Z" title="Thu Jan 08 2026 19:58:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在电商或金融系统中，<strong>并发控制</strong>是最核心的挑战之一。</p>
<p>很多开发者在写“扣减库存”逻辑时，习惯写出这样的代码：</p>
<ol>
<li>查询当前库存：SELECT stock FROM products WHERE id = 1;</li>
<li>应用层判断：if (stock &gt; 0)</li>
<li>更新库存：UPDATE products SET stock = stock - 1 WHERE id = 1;</li>
</ol>
<p>在低并发下这没问题。但在高并发场景下，两个线程可能同时读到 stock=1，同时通过校验，分别执行 UPDATE。结果是：卖出了两件商品，库存变成了 -1。</p>
<p>这就是典型的<strong>竞态条件</strong>。解决这个问题的终极战场不在应用层，而在数据库层。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f10f5cd9622455dac57bcfa2ad03e30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768507109&amp;x-signature=gKB4v5HANGrXk4BPbdj05OTVuy8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">一、 悲观锁 vs 乐观锁：如何安全地扣减库存？</h2>
<h2 data-id="heading-1">1. 悲观锁 (Pessimistic Locking)：SELECT ... FOR UPDATE</h2>
<p>悲观锁的核心思想是：“总有人想跟我抢，我先锁住再说。”</p>
<p>在 MySQL InnoDB 中，我们可以通过 FOR UPDATE 显式添加<strong>排他锁 (X Lock)</strong>。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">START</span> TRANSACTION;

<span class="hljs-comment">-- 1. 显式加锁。此时其他事务如果想查或改这行数据，必须等待</span>
<span class="hljs-keyword">SELECT</span> stock <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span> <span class="hljs-keyword">FOR</span> <span class="hljs-keyword">UPDATE</span>;

<span class="hljs-comment">-- 2. 只有拿到锁的事务才能执行后续逻辑</span>
<span class="hljs-comment">-- (应用层判断 stock &gt; 0)</span>
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> stock <span class="hljs-operator">=</span> stock <span class="hljs-operator">-</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;

<span class="hljs-keyword">COMMIT</span>;
</code></pre>
<p>优点： 强一致性，完全避免超卖。</p>
<p>缺点： 性能开销大。锁的持有时间 = 事务执行时间。在高并发下，会造成大量请求阻塞，甚至超时。</p>
<p>适用场景： 写入频繁、强一致性要求极高、并发量适中的场景（如转账）。</p>
<h2 data-id="heading-2">2. 乐观锁 (Optimistic Locking)：基于 CAS (Compare-and-Swap)</h2>
<p>乐观锁的核心思想是：“大家随便拿，但我更新时要检查一下数据有没有变。”</p>
<p>这不需要数据库显式加锁，而是通过版本号 (version) 机制在 SQL 层面实现。</p>
<p>我们需要在表中增加一个 version 字段。</p>
<pre><code class="hljs language-ini" lang="ini">-- 1. 查询数据，同时拿到版本号 (假设 <span class="hljs-attr">version</span> = <span class="hljs-number">10</span>)
SELECT stock, version FROM products WHERE <span class="hljs-attr">id</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>

-- 2. 更新时，校验版本号是否依然是 10
UPDATE products 
SET <span class="hljs-attr">stock</span> = stock - <span class="hljs-number">1</span>, version = version + <span class="hljs-number">1</span> 
WHERE <span class="hljs-attr">id</span> = <span class="hljs-number">1</span> AND version = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
</code></pre>
<p>逻辑解析：</p>
<p>如果 SQL 返回 Affected rows: 1，说明扣减成功。</p>
<p>如果返回 0，说明在查询和更新之间，有别的事务修改了数据（version 变成了 11）。此时应用层应捕获这个失败，并进行重试（Retry）或报错。</p>
<p>优点： 无锁（No-Locking），并发性能极高。</p>
<p>缺点： 在冲突激烈的场景下，重试率高，可能浪费 CPU。</p>
<p>适用场景： 读多写少、追求高吞吐量的场景（如秒杀）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43239a87ea574457837c79bb92fb9011~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768507109&amp;x-signature=qQgPxcW13eIdrBdulEvXnHJZUAU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">二、 事务隔离级别：脏读与幻读的权衡</h2>
<p>MySQL 默认的隔离级别是 <strong>RR (Repeatable Read)</strong>，而 Oracle/PostgreSQL 默认通常是 <strong>RC (Read Committed)</strong>。这两者的区别直接影响业务逻辑的正确性。</p>
<h2 data-id="heading-4">1. 脏读 (Dirty Read)</h2>
<p>A 事务读取了 B 事务<strong>未提交</strong>的数据。</p>
<ul>
<li><strong>发生场景：</strong> READ UNCOMMITTED 级别。</li>
<li><strong>结论：</strong> 生产环境严禁使用，除非你在做极其粗略的统计。</li>
</ul>
<h2 data-id="heading-5">2. 不可重复读 (Non-Repeatable Read)</h2>
<p>A 事务里两次读取同一行数据，结果不一样（因为 B 事务在中间提交了修改）。</p>
<ul>
<li><strong>RC 级别</strong>允许发生。</li>
<li><strong>RR 级别</strong>通过 <strong>MVCC (多版本并发控制)</strong> 解决了这个问题。在 RR 下，事务开启时会生成一个快照 (Snapshot)，后续读取的都是快照版本。</li>
</ul>
<h2 data-id="heading-6">3. 幻读 (Phantom Read)</h2>
<p>A 事务读取了一个范围（如 id &gt; 10），B 事务插入了一条新数据 id=11。A 再次读取时，发现多了一条“幽灵”数据。</p>
<ul>
<li><strong>MySQL 的 RR 级别</strong>通过 <strong>Next-Key Lock (间隙锁)</strong> 在很大程度上解决了幻读，但也带来了死锁隐患。</li>
</ul>
<h2 data-id="heading-7">三、 死锁 (Deadlock) 排查：看不见的“间隙锁”</h2>
<p>很多开发者认为：“我只锁了一行数据，为什么会死锁？”</p>
<p>在 MySQL 的 RR 隔离级别下，最常见的死锁凶手是 间隙锁 (Gap Lock)。</p>
<p>场景复现：</p>
<p>表 t_user 有 id 为 10, 20 的两条记录。</p>
<p><strong>事务 A：</strong></p>
<pre><code class="hljs language-ini" lang="ini">-- 试图更新一条不存在的记录 (<span class="hljs-attr">id</span>=<span class="hljs-number">15</span>)
UPDATE t_user SET <span class="hljs-attr">name</span> = <span class="hljs-string">'A'</span> WHERE id = <span class="hljs-number">15</span><span class="hljs-comment">;</span>
</code></pre>
<p><strong>解析：</strong> 因为 id=15 不存在，MySQL 为了防止幻读，会锁住 (10, 20) 这个<strong>间隙 (Gap)</strong>，不许别人在这个范围内插入数据。</p>
<p><strong>事务 B：</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 试图插入一条记录 (id=16)</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_user (id, name) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">16</span>, <span class="hljs-string">'B'</span>);
</code></pre>
<p><strong>解析：</strong> id=16 落在 (10, 20) 间隙内，被事务 A 的间隙锁阻塞，进入等待。</p>
<p>死锁形成：</p>
<p>如果事务 A 此时也想执行 INSERT INTO t_user (id, name) VALUES (16, 'A');，它会发现事务 B 也在申请锁，于是形成环路：A 等 B 释放意向锁，B 等 A 释放间隙锁 -&gt; Deadlock found。</p>
<p>如何排查？</p>
<p>当发生死锁时，应用层通常只会收到一个 Generic Error。要看详情，需要执行：</p>
<pre><code class="hljs language-ini" lang="ini">SHOW ENGINE INNODB STATUS<span class="hljs-comment">;</span>
</code></pre>
<p>在输出的 LATEST DETECTED DEADLOCK 章节中，你会看到清晰的日志：</p>
<ul>
<li>LOCK WAIT</li>
<li>RECORD LOCKS space id ... index PRIMARY ... lock_mode X locks gap before rec （关键词：locks gap）</li>
</ul>
<p><strong>注意：</strong></p>
<ol>
<li>尽量让 UPDATE/DELETE 语句命中唯一索引，避免产生间隙锁。</li>
<li>在高并发写入场景下，考虑将隔离级别降级为 <strong>RC (Read Committed)</strong>（RC 没有间隙锁），通过业务层逻辑保证一致性。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb340057cf554b2d98d529392f60c4a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pWw5o2u5bCP6aaS5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768507109&amp;x-signature=tsjkac5B6aqviOoOP90hvvYgbrA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">总结</h2>
<p>并发控制是数据库技术的深水区：</p>
<ol>
<li><strong>防止超卖</strong>：优先考虑 <strong>乐观锁 (Version CAS)</strong>，只有在高冲突场景下才使用 <strong>悲观锁 (FOR UPDATE)</strong>。</li>
<li><strong>隔离级别</strong>：清楚你的数据库跑在 RC 还是 RR 下。MySQL 默认的 RR 虽然安全，但会引入额外的 <strong>Gap Lock</strong> 开销和死锁风险。</li>
<li><strong>死锁分析</strong>：遇到死锁别慌，通过 SHOW ENGINE INNODB STATUS 分析锁等待链，通常是因为对“不存在的记录”加锁导致的间隙锁冲突。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 混合模式下：saveLayer 混合注意点]]></title>    <link>https://juejin.cn/post/7592887786966351908</link>    <guid>https://juejin.cn/post/7592887786966351908</guid>    <pubDate>2026-01-09T03:24:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592887786966351908" data-draft-id="7592912896591364115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 混合模式下：saveLayer 混合注意点"/> <meta itemprop="keywords" content="Flutter,Android"/> <meta itemprop="datePublished" content="2026-01-09T03:24:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 混合模式下：saveLayer 混合注意点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:24:13.000Z" title="Fri Jan 09 2026 03:24:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>直接Paint 绘制混合</p>
<pre><code class="hljs language-js" lang="js">    canvas.<span class="hljs-title function_">saveLayer</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), <span class="hljs-title class_">Paint</span>());
    <span class="hljs-title class_">Paint</span> dstPaint = <span class="hljs-title class_">Paint</span>()..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">red</span>;
    dstPaint.<span class="hljs-property">strokeWidth</span> = <span class="hljs-number">20</span>;
    dstPaint.<span class="hljs-property">style</span> = <span class="hljs-title class_">PaintingStyle</span>.<span class="hljs-property">stroke</span>;
    canvas.<span class="hljs-title function_">drawImageRect</span>(image!, <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, image!.<span class="hljs-property">width</span>.<span class="hljs-title function_">toDouble</span>(), image!.<span class="hljs-property">height</span>.<span class="hljs-title function_">toDouble</span>()), <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), dstPaint);

    <span class="hljs-keyword">var</span> srcPaint = <span class="hljs-title class_">Paint</span>()
      ..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">yellowAccent</span> <span class="hljs-comment">// 源颜色：蓝色</span>
      ..<span class="hljs-property">style</span> = <span class="hljs-title class_">PaintingStyle</span>.<span class="hljs-property">fill</span> <span class="hljs-comment">// 填充模式</span>
      ..<span class="hljs-property">blendMode</span> = ui.<span class="hljs-property">BlendMode</span>.<span class="hljs-property">clear</span>
      ..<span class="hljs-property">strokeWidth</span> = <span class="hljs-number">70</span>; <span class="hljs-comment">// 混合模式</span>
    canvas.<span class="hljs-title function_">drawRect</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height).<span class="hljs-title function_">deflate</span>(<span class="hljs-number">100</span>), srcPaint);
</code></pre>
<p>效果图：</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca0ab18fc0104e1d80d75a1cc2911f2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768533853&amp;x-signature=ixgv4WOlft17x7UqUQBFAz0m0vo%3D" alt="image.png" width="30%" loading="lazy"/>
<p>但是如果改成如下：</p>
<pre><code class="hljs language-js" lang="js">    canvas.<span class="hljs-title function_">saveLayer</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), <span class="hljs-title class_">Paint</span>());
    <span class="hljs-title class_">Paint</span> dstPaint = <span class="hljs-title class_">Paint</span>()..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">red</span>;
    dstPaint.<span class="hljs-property">strokeWidth</span> = <span class="hljs-number">20</span>;
    dstPaint.<span class="hljs-property">style</span> = <span class="hljs-title class_">PaintingStyle</span>.<span class="hljs-property">stroke</span>;
    canvas.<span class="hljs-title function_">drawImageRect</span>(image!, <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, image!.<span class="hljs-property">width</span>.<span class="hljs-title function_">toDouble</span>(), image!.<span class="hljs-property">height</span>.<span class="hljs-title function_">toDouble</span>()), <span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height), dstPaint);
    
    canvas.<span class="hljs-title function_">saveLayer</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width/<span class="hljs-number">2</span>, height/<span class="hljs-number">2</span>), ui.<span class="hljs-title class_">Paint</span>()
    ..<span class="hljs-property">blendMode</span> = ui.<span class="hljs-property">BlendMode</span>.<span class="hljs-property">clear</span>);

    <span class="hljs-keyword">var</span> srcPaint = <span class="hljs-title class_">Paint</span>()
      ..<span class="hljs-property">color</span> = <span class="hljs-title class_">Colors</span>.<span class="hljs-property">yellowAccent</span> <span class="hljs-comment">// 源颜色：蓝色</span>
      ..<span class="hljs-property">style</span> = <span class="hljs-title class_">PaintingStyle</span>.<span class="hljs-property">fill</span> <span class="hljs-comment">// 填充模式</span>
      ..<span class="hljs-property">strokeWidth</span> = <span class="hljs-number">70</span>; <span class="hljs-comment">// 混合模式</span>
    canvas.<span class="hljs-title function_">drawRect</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height).<span class="hljs-title function_">deflate</span>(<span class="hljs-number">100</span>), srcPaint);
</code></pre>
<p>目测代码逻辑是一样的只是把混合模式设置给了Layer。但是最终效果就是界面上啥页没有全部被清空了。这是因为设置了混合模式之后,整个图层都会被当作src 进行混合。并且第一个设置范围的参数也不生效。</p>
<p>如果想限制到指定范围可以在saveLayer前加如下内容:</p>
<pre><code class="hljs language-js" lang="js">  canvas.<span class="hljs-title function_">clipRect</span>(<span class="hljs-title class_">Rect</span>.<span class="hljs-title function_">fromLTWH</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width/<span class="hljs-number">2</span>, height/<span class="hljs-number">2</span>));
</code></pre>
<p>那么加完之后的效果图如下:</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/558f554184234155b5564810a7766348~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768533853&amp;x-signature=wsSloCb0DJ%2BswQJUI2LyUk7FxSE%3D" alt="image.png" width="30%" loading="lazy"/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何设计一个高并发系统？]]></title>    <link>https://juejin.cn/post/7593139476832518187</link>    <guid>https://juejin.cn/post/7593139476832518187</guid>    <pubDate>2026-01-09T03:31:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476832518187" data-draft-id="7593139476832501803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何设计一个高并发系统？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T03:31:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三说技术"/> <meta itemprop="url" content="https://juejin.cn/user/465848661970824"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何设计一个高并发系统？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/465848661970824/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三说技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:31:06.000Z" title="Fri Jan 09 2026 03:31:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读27分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近有位粉丝问了我一个问题：如何设计一个高并发系统？</p>
<p>这是一个非常高频的面试题，面试官可以从多个角度，考查技术的广度和深度。</p>
<p>今天这篇文章跟大家一起聊聊高并发系统设计一些关键点，希望对你会有所帮助。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20a181f94d93419e8a1aa6a302aa2df2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=9700iDX3nCDi8r18OcXmH%2FhgIVs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">1 页面静态化</h2>
<p>对于高并发系统的页面功能，我们必须要做<code>静态化</code>设计。</p>
<p>如果并发访问系统的用户非常多，每次用户访问页面的时候，都通过服务器动态渲染，会导致服务端承受过大的压力，而导致页面无法正常加载的情况发生。</p>
<p>我们可以使用<code>Freemarker</code>或<code>Velocity</code>模板引擎，实现页面静态化功能。</p>
<p>以商城官网首页为例，我们可以在<code>Job</code>中，每隔一段时间，查询出所有需要在首页展示的数据，汇总到一起，使用模板引擎生成到html文件当中。</p>
<p>然后将该<code>html</code>文件，通过<code>shell</code>脚本，自动同步到前端页面相关的服务器上。</p>
<h2 data-id="heading-2">2 CSDN加速</h2>
<p>虽说页面静态化可以提升网站网页的访问速度，但还不够，因为用户分布在全国各地，有些人在北京，有些人在成都，有些人在深圳，地域相差很远，他们访问网站的网速各不相同。</p>
<p>如何才能让用户最快访问到活动页面呢？</p>
<p>这就需要使用CDN，它的全称是Content Delivery Network，即内容分发网络。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e24948221f344ddb0ee11bf4bc24f97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=lkUWnHnvcPvRnNeuwmttGgwh2WI%3D" alt="" loading="lazy"/>
使用户就近获取所需内容，降低网络拥塞，提高用户访问响应速度和命中率。</p>
<p>CDN加速的基本原理是：将网站的静态内容（如图片、CSS、JavaScript文件等）复制并存储到分布在全球各地的服务器节点上。</p>
<p>当用户请求访问网站时，CDN系统会根据用户的地理位置，自动将内容分发给离用户最近的服务器，从而实现快速访问。</p>
<p>国内常见的CDN提供商有阿里云CDN、腾讯云CDN、百度云加速等，它们提供了全球分布的节点服务器，为全球范围内的网站加速服务。</p>
<h2 data-id="heading-3">3 缓存</h2>
<p>在高并发的系统中，<code>缓存</code>可以说是必不可少的技术之一。</p>
<p>目前缓存有两种：</p>
<ol>
<li>基于应用服务器的内存缓存，也就是我们说的二级缓存。</li>
<li>使用缓存中间件，比如：Redis、Memcached等，这种是分布式缓存。</li>
</ol>
<p>这两种缓存各有优缺点。</p>
<p>二级缓存的性能更好，但因为是基于应用服务器内存的缓存，如果系统部署到了多个服务器节点，可能会存在数据不一致的情况。</p>
<p>而Redis或Memcached虽说性能上比不上二级缓存，但它们是分布式缓存，避免多个服务器节点数据不一致的问题。</p>
<p>缓存的用法一般是这样的：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/081cb7c9af54498b93983450df9c774c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=MsgwajBcLzR2HZ8Y6C%2BHdyuhuvE%3D" alt="" loading="lazy"/>
使用缓存之后，可以减轻访问数据库的压力，显著的提升系统的性能。</p>
<p>有些业务场景，甚至会分布式缓存和二级缓存一起使用。</p>
<p>比如获取商品分类数据，流程如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3430577b05147db86099773dd93463c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=RSFWKvmcvbWH8k7EnvJz9rqXioY%3D" alt="" loading="lazy"/></p>
<p>不过引入缓存，虽说给我们的系统性能带来了提升，但同时也给我们带来了一些新的问题，比如：《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwNjMwMTgzMQ%3D%3D%26mid%3D2247493521%26idx%3D1%26sn%3Dbff84e7a819d79e4b8eb7e722e96ddfc%26chksm%3Dc0e83f79f79fb66f2e7bf03a104580b404ea0a3c977846e428f13c1f12fbad46d4d778b2da14%26token%3D902535653%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247493521&amp;idx=1&amp;sn=bff84e7a819d79e4b8eb7e722e96ddfc&amp;chksm=c0e83f79f79fb66f2e7bf03a104580b404ea0a3c977846e428f13c1f12fbad46d4d778b2da14&amp;token=902535653&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">数据库和缓存双向数据库一致性问题</a>》、《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwNjMwMTgzMQ%3D%3D%26mid%3D2247491225%26idx%3D1%26sn%3Dbfb14f28911efaa6e3a615870fff9a5c%26chksm%3Dc0ebc671f79c4f6718a63bbec91d79a4b05e1dd2a7c00ed9bf6a9f582abd4c6e5c870148ff89%26token%3D902535653%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247491225&amp;idx=1&amp;sn=bfb14f28911efaa6e3a615870fff9a5c&amp;chksm=c0ebc671f79c4f6718a63bbec91d79a4b05e1dd2a7c00ed9bf6a9f582abd4c6e5c870148ff89&amp;token=902535653&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">缓存穿透、击穿和雪崩问题</a>》等。</p>
<p>我们在使用缓存时，一定要结合实际业务场景，切记不要为了缓存而缓存。</p>
<h2 data-id="heading-4">4 异步</h2>
<p>有时候，我们在高并发系统当中，某些接口的业务逻辑，没必要都同步执行。</p>
<p>比如有个用户请求接口中，需要做业务操作，发站内通知，和记录操作日志。为了实现起来比较方便，通常我们会将这些逻辑放在接口中同步执行，势必会对接口性能造成一定的影响。</p>
<p>接口内部流程图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/239e42718536497c86a0c2262325cc22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=ZaMeWPKsYCxr0P7pXSoZxY1ZeI8%3D" alt="" loading="lazy"/>
这个接口表面上看起来没有问题，但如果你仔细梳理一下业务逻辑，会发现只有业务操作才是核心逻辑，其他的功能都是非核心逻辑。</p>
<p>在这里有个原则就是：核心逻辑可以同步执行，同步写库。非核心逻辑，可以异步执行，异步写库。</p>
<p>上面这个例子中，发站内通知和用户操作日志功能，对实时性要求不高，即使晚点写库，用户无非是晚点收到站内通知，或者运营晚点看到用户操作日志，对业务影响不大，所以完全可以异步处理。</p>
<p>通常异步主要有两种：多线程 和 mq。</p>
<h3 data-id="heading-5">4.1 线程池</h3>
<p>使用线程池改造之后，接口逻辑如下：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74719e35c5b34a7ba566aea438dfa9fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=7Lwc6BIeomi3SR%2BY3TuLYD8ulmk%3D" alt="" loading="lazy"/>发站内通知和用户操作日志功能，被提交到了两个单独的线程池中。</p>
<p>这样接口中重点关注的是业务操作，把其他的逻辑交给线程异步执行，这样改造之后，让接口性能瞬间提升了。</p>
<p>但使用线程池有个小问题就是：如果服务器重启了，或者是需要被执行的功能出现异常了，无法重试，会丢数据。</p>
<p>那么这个问题该怎么办呢？</p>
<h3 data-id="heading-6">4.2 mq</h3>
<p>使用mq改造之后，接口逻辑如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd663e1e95fd4bcab15e153684b30892~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=BrPJfQVyRwI1CYXZPRYnxCZxaWw%3D" alt="" loading="lazy"/>
对于发站内通知和用户操作日志功能，在接口中并没真正实现，它只发送了mq消息到mq服务器。然后由mq消费者消费消息时，才真正的执行这两个功能。</p>
<p>这样改造之后，接口性能同样提升了，因为发送mq消息速度是很快的，我们只需关注业务操作的代码即可。</p>
<h2 data-id="heading-7">5 多线程处理</h2>
<p>在高并发系统当中，用户的请求量很大。</p>
<p>假如我们现在用mq处理业务逻辑。</p>
<p>一下子有大量的用户请求，产生了大量的mq消息，保存到了mq服务器。</p>
<p>而mq的消费者，消费速度很慢。</p>
<p>可能会导致大量的消息积压问题。</p>
<p>从而严重影响数据的实时性。</p>
<p>我们需要对消息的消费者做优化。</p>
<p>最快的方式是使用<code>多线程</code>消费消息，比如：改成线程池消费消息。</p>
<p>当然核心线程数、最大线程数、队列大小 和 线程回收时间，一定要做成配置的，后面可以根据实际情况动态调整。</p>
<p>这样改造之后，我们可以快速解决消息积压问题。</p>
<p>除此之外，在很多数据导入场景，用多线程导入数据，可以提升效率。</p>
<blockquote>
<p>温馨提醒一下：使用多线程消费消息，可能会出现消息的顺序问题。如果你的业务场景中，需要保证消息的顺序，则要用其他的方式解决问题。感兴趣的小伙伴，可以找我私聊。</p>
</blockquote>
<h2 data-id="heading-8">6 分库分表</h2>
<p>有时候，高并发系统的吞吐量受限的不是别的，而是数据库。</p>
<p>当系统发展到一定的阶段，用户并发量大，会有大量的数据库请求，需要占用大量的数据库连接，同时会带来磁盘IO的性能瓶颈问题。</p>
<p>此外，随着用户数量越来越多，产生的数据也越来越多，一张表有可能存不下。由于数据量太大，sql语句查询数据时，即使走了索引也会非常耗时。</p>
<p>这时该怎么办呢？</p>
<p>答：需要做<code>分库分表</code>。</p>
<p>如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a530fde9284a47e2bff9db2fa98e0a73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=69KBLhtiOSFWD8DwP7P4pQDPZF0%3D" alt="" loading="lazy"/>
图中将用户库拆分成了三个库，每个库都包含了四张用户表。</p>
<p>如果有用户请求过来的时候，先根据用户id路由到其中一个用户库，然后再定位到某张表。</p>
<p>路由的算法挺多的：</p>
<ul>
<li>根据id取模，比如：id=7，有4张表，则7%4=3，模为3，路由到用户表3。</li>
<li>给id指定一个区间范围，比如：id的值是0-10万，则数据存在用户表0，id的值是10-20万，则数据存在用户表1。</li>
<li>一致性hash算法</li>
</ul>
<p>分库分表主要有两个方向：<code>垂直</code>和<code>水平</code>。</p>
<p>说实话垂直方向（即业务方向）更简单。</p>
<p>在水平方向（即数据方向）上，分库和分表的作用，其实是有区别的，不能混为一谈。</p>
<ul>
<li>分库：是为了解决数据库连接资源不足问题，和磁盘IO的性能瓶颈问题。</li>
<li>分表：是为了解决单表数据量太大，sql语句查询数据时，即使走了索引也非常耗时问题。此外还可以解决消耗cpu资源问题。</li>
<li>分库分表：可以解决 数据库连接资源不足、磁盘IO的性能瓶颈、检索数据耗时 和 消耗cpu资源等问题。</li>
</ul>
<p>如果在有些业务场景中，用户并发量很大，但是需要保存的数据量很少，这时可以只分库，不分表。</p>
<p>如果在有些业务场景中，用户并发量不大，但是需要保存的数量很多，这时可以只分表，不分库。</p>
<p>如果在有些业务场景中，用户并发量大，并且需要保存的数量也很多时，可以分库分表。</p>
<p>关于分库分表更详细的内容，可以看看我另一篇文章，里面讲的更深入《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwNjMwMTgzMQ%3D%3D%26mid%3D2247490459%26idx%3D1%26sn%3D1e4296228c00aa4203aab481575ac916%26chksm%3Dc0ebc373f79c4a658de7ce7f0d8cf30b1f45adb346c2386321779e7cf85a757a12337d3ae233%26token%3D2041133408%26lang%3Dzh_CN%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247490459&amp;idx=1&amp;sn=1e4296228c00aa4203aab481575ac916&amp;chksm=c0ebc373f79c4a658de7ce7f0d8cf30b1f45adb346c2386321779e7cf85a757a12337d3ae233&amp;token=2041133408&amp;lang=zh_CN&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">阿里二面：为什么分库分表？</a>》</p>
<h2 data-id="heading-9">7 池化技术</h2>
<p>其实不光是高并发系统，为了性能考虑，有些低并发的系统，也在使用<code>池化技术</code>，比如：数据库连接池、线程池等。</p>
<p>池化技术是<code>多例设计模式</code>的一个体现。</p>
<p>我们都知道<code>创建</code>和<code>销毁</code>数据库连接是非常耗时耗资源的操作。</p>
<p>如果每次用户请求，都需要创建一个新的数据库连接，势必会影响程序的性能。</p>
<p>为了提升性能，我们可以创建一批数据库连接，保存到内存中的某个集合中，缓存起来。</p>
<p>这样的话，如果下次有需要用数据库连接的时候，就能直接从集合中获取，不用再额外创建数据库连接，这样处理将会给我们提升系统性能。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c14efe3606f43dbbc6c0882ceb2d064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=QTipTkSx%2BiSsQXtqz10i8hGgJRw%3D" alt="" loading="lazy"/>
当然用完之后，需要及时归还。</p>
<p>目前常用的数据库连接池有：Druid、C3P0、hikari和DBCP等。</p>
<h2 data-id="heading-10">8 读写分离</h2>
<p>不知道你有没有听说过<code>二八原则</code>，在一个系统当中可能有80%是读数据请求，另外20%是写数据请求。</p>
<p>不过这个比例也不是绝对的。</p>
<p>我想告诉大家的是，一般的系统读数据请求会远远大于写数据请求。</p>
<p>如果读数据请求和写数据请求，都访问同一个数据库，可能会相互抢占数据库连接，相互影响。</p>
<p>我们都知道，一个数据库的数据库连接数量是有限，是非常宝贵的资源，不能因为读数据请求，影响到写数据请求吧？</p>
<p>这就需要对数据库做<code>读写分离</code>了。</p>
<p>于是，就出现了主从读写分离架构：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e88e20b1c0b847c9b9fe868bf7bcfe19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=UCqKVg5X41xUeRX%2BdlH5ZKb0xx4%3D" alt="" loading="lazy"/>
考虑刚开始用户量还没那么大，选择的是一主一从的架构，也就是常说的一个<code>master</code>，一个<code>slave</code>。</p>
<p>所有的写数据请求，都指向主库。一旦主库写完数据之后，立马异步同步给从库。这样所有的读数据请求，就能及时从从库中获取到数据了（除非网络有延迟）。</p>
<p>但这里有个问题就是：如果用户量确实有些大，如果master挂了，升级slave为master，将所有读写请求都指向新master。</p>
<p>但此时，如果这个新master根本扛不住所有的读写请求，该怎么办？</p>
<p>这就需要一主多从的架构了：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11940b56d35b4c0bb9af605cb27abc87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=k%2BOz3q7DoFt%2F6OJom3LOwL03wDg%3D" alt="" loading="lazy"/>
上图中我列的是一主两从，如果master挂了，可以选择从库1或从库2中的一个，升级为新master。假如我们在这里升级从库1为新master，则原来的从库2就变成了新master的的slave了。</p>
<p>调整之后的架构图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb223b979b0c4691a39dae3da965af21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=wOvSes5s3aethDnJXfJ11lJuAHc%3D" alt="" loading="lazy"/>
这样就能解决上面的问题了。</p>
<p>除此之外，如果查询请求量再增大，我们还可以将架构升级为一主三从、一主四从...一主N从等。</p>
<h2 data-id="heading-11">9 索引</h2>
<p>在高并发的系统当中，用户经常需要查询数据，对数据库增加<code>索引</code>，是必不可少的一个环节。</p>
<p>尤其是表中数据非常多时，加了索引，跟没加索引，执行同一条sql语句，查询相同的数据，耗时可能会相差N个数量级。</p>
<p>虽说索引能够提升SQL语句的查询速度，但索引也不是越多越好。</p>
<p>在insert数据时，需要给索引分配额外的资源，对insert的性能有一定的损耗。</p>
<p>我们要根据实际业务场景来决定创建哪些索引，索引少了，影响查询速度，索引多了，影响写入速度。</p>
<p>很多时候，我们需要经常对索引做优化。</p>
<ol>
<li>可以将多个单个索引，改成一个联合索引。</li>
<li>删除不要索引。</li>
<li>使用explain关键字，查询SQL语句的执行计划，看看哪些走了索引，哪些没有走索引。</li>
<li>要注意索引失效的一些场景。</li>
<li>必要时可以使用force index来强制查询sql走某个索引。</li>
</ol>
<p>如果你想进一步了解explain的详细用法，可以看看我的另一篇文章《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwNjMwMTgzMQ%3D%3D%26mid%3D2247490262%26idx%3D1%26sn%3Da67f610afa984ecca130a54a3be453ab%26chksm%3Dc0ebc23ef79c4b2869dea998e413c5cbea6aeeea01ee74efc7c1a5fc228baa7beca215adf3ea%26token%3D751314179%26lang%3Dzh_CN%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247490262&amp;idx=1&amp;sn=a67f610afa984ecca130a54a3be453ab&amp;chksm=c0ebc23ef79c4b2869dea998e413c5cbea6aeeea01ee74efc7c1a5fc228baa7beca215adf3ea&amp;token=751314179&amp;lang=zh_CN&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">explain | 索引优化的这把绝世好剑，你真的会用吗？</a>》。</p>
<p>如果你想进一步了解哪些情况下索引会失效，可以看看我的另一篇文章《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzkwNjMwMTgzMQ%3D%3D%26mid%3D2247491626%26idx%3D1%26sn%3D18fc949c06f04fe8f4c29b6fc5c66f9c%26chksm%3Dc0e838c2f79fb1d45c6f9b2ab188bb4663414690bab0718a7d46beb875e6b83e5e67ec27d2ff%26token%3D902535653%26lang%3Dzh_CN%23rd" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&amp;mid=2247491626&amp;idx=1&amp;sn=18fc949c06f04fe8f4c29b6fc5c66f9c&amp;chksm=c0e838c2f79fb1d45c6f9b2ab188bb4663414690bab0718a7d46beb875e6b83e5e67ec27d2ff&amp;token=902535653&amp;lang=zh_CN#rd" ref="nofollow noopener noreferrer">聊聊索引失效的10种场景，太坑了</a>》。</p>
<h2 data-id="heading-12">10 批处理</h2>
<p>有时候，我们需要从指定的用户集合中，查询出有哪些是在数据库中已经存在的。</p>
<p>实现代码可以这样写：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">queryUser</span><span class="hljs-params">(List&lt;User&gt; searchList)</span> {
    <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(searchList)) {
        <span class="hljs-keyword">return</span> Collections.emptyList();
    }

    List&lt;User&gt; result = Lists.newArrayList();
    searchList.forEach(user -&gt; result.add(userMapper.getUserById(user.getId())));
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>这里如果有50个用户，则需要循环50次，去查询数据库。我们都知道，每查询一次数据库，就是一次远程调用。</p>
<p>如果查询50次数据库，就有50次远程调用，这是非常耗时的操作。</p>
<p>那么，我们如何优化呢？</p>
<p>答：<code>批处理</code>。</p>
<p>具体代码如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">queryUser</span><span class="hljs-params">(List&lt;User&gt; searchList)</span> {
    <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(searchList)) {
        <span class="hljs-keyword">return</span> Collections.emptyList();
    }
    List&lt;Long&gt; ids = searchList.stream().map(User::getId).collect(Collectors.toList());
    <span class="hljs-keyword">return</span> userMapper.getUserByIds(ids);
}
</code></pre>
<p>提供一个根据用户id集合<code>批量查询</code>用户的接口，只远程调用一次，就能查询出所有的数据。</p>
<p>这里有个需要注意的地方是：id集合的大小要做限制，最好一次不要请求太多的数据。要根据实际情况而定，建议控制每次请求的记录条数在500以内。</p>
<h2 data-id="heading-13">11 集群</h2>
<p>系统部署的服务器节点，可能会down机，比如：服务器的磁盘坏了，或者操作系统出现内存不足问题。</p>
<p>为了保证系统的高可用，我们需要部署多个节点，构成一个<code>集群</code>，防止因为部分服务器节点挂了，导致系统的整个服务不可用的情况发生。</p>
<p>集群有很多种：</p>
<ol>
<li>应用服务器集群</li>
<li>数据库集群</li>
<li>中间件集群</li>
<li>文件服务器集群</li>
</ol>
<p>我们以中间件<code>Redis</code>为例。</p>
<p>在高并发系统中，用户的数据量非常庞大时，比如用户的缓存数据总共大小有40G，一个服务器节点只有16G的内存。</p>
<p>这样需要部署3台服务器节点。</p>
<p>该业务场景，使用普通的master/slave模式，或者使用哨兵模式都行不通。</p>
<p>40G的数据，不能只保存到一台服务器节点，需要均分到3个master服务器节点上，一个master服务器节点保存13.3G的数据。</p>
<p>当有用户请求过来的时候，先经过路由，根据用户的id或者ip，每次都访问指定的服务器节点。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88762cfa75a1483d926bda60f3a8d948~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=jOfwxSHboLh0DP%2FC%2Bm8VFx%2FFzUs%3D" alt="" loading="lazy"/>
这用就构成了一个集群。</p>
<p>但这样有风险，为了防止其中一个master服务器节点挂掉，导致部分用户的缓存访问不了，还需要对数据做备份。</p>
<p>这样每一个master，都需要有一个slave，做数据备份。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/340ac6995b874d13af2dfa4d13ecb81f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=3jYono6YFtr6zhtYRLdT6Jex7NM%3D" alt="" loading="lazy"/>
如果master挂了，可以将slave升级为新的master，而不影响用户的正常使用。</p>
<h2 data-id="heading-14">12 负载均衡</h2>
<p>如果我们的系统部署到了多台服务器节点。那么哪些用户的请求，访问节点a，哪些用户的请求，访问节点b，哪些用户的请求，访问节点c？</p>
<p>我们需要某种机制，将用户的请求，转发到具体的服务器节点上。</p>
<p>这就需要使用<code>负载均衡</code>机制了。</p>
<p>在linux下有<code>Nginx</code>、<code>LVS</code>、<code>Haproxy</code>等服务可以提供负载均衡服务。</p>
<p>在SpringCloud微服务架构中，大部分使用的负载均衡组件就是<code>Ribbon</code>、<code>OpenFegin</code>或<code>SpringCloud Loadbalancer</code>。</p>
<p>硬件方面，可以使用<code>F5</code>实现负载均衡。它可以基于交换机实现负载均衡，性能更好，但是价格更贵一些。</p>
<p>常用的负载均衡策略有：</p>
<ol>
<li><code>轮询</code>：每个请求按时间顺序逐一分配到不同的服务器节点，如果服务器节点down掉，能自动剔除。</li>
<li><code>weight权重</code>：weight代表权重默认为1，权重越高，服务器节点被分配到的概率越大。weight和访问比率成正比，用于服务器节点性能不均的情况。</li>
<li><code>ip hash</code>：每个请求按访问ip的hash结果分配, 这样每个访客固定访问同一个服务器节点，它是解诀Session共享的问题的解决方案之一。</li>
<li><code>最少连接数</code>：把请求转发给连接数较少的服务器节点。轮询算法是把请求平均的转发给各个服务器节点，使它们的负载大致相同；但有些请求占用的时间很长，会导致其所在的服务器节点负载较高。这时least_conn方式就可以达到更好的负载均衡效果。</li>
<li><code>最短响应时间</code>：按服务器节点的响应时间来分配请求，响应时间短的服务器节点优先被分配。</li>
</ol>
<p>当然还有其他的策略，在这里就不给大家一一介绍了。</p>
<h2 data-id="heading-15">13 限流</h2>
<p>对于高并发系统，为了保证系统的稳定性，需要对用户的请求量做<code>限流</code>。</p>
<p>特别是秒杀系统中，如果不做任何限制，绝大部分商品可能是被机器抢到，而非正常的用户，有点不太公平。</p>
<p>所以，我们有必要识别这些非法请求，做一些限制。那么，我们该如何现在这些非法请求呢？</p>
<p>目前有两种常用的限流方式：</p>
<ul>
<li>基于nginx限流</li>
<li>基于redis限流</li>
</ul>
<h3 data-id="heading-16">13.1 对同一用户限流</h3>
<p>为了防止某个用户，请求接口次数过于频繁，可以只针对该用户做限制。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8025c82acaa447218ba4e5082ff7ac85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=Oe4hNkjeMa%2FXUCn0PH0c1bC%2B6mg%3D" alt="" loading="lazy"/>
限制同一个用户id，比如每分钟只能请求5次接口。</p>
<h3 data-id="heading-17">13.2 对同一ip限流</h3>
<p>有时候只对某个用户限流是不够的，有些高手可以模拟多个用户请求，这种nginx就没法识别了。</p>
<p>这时需要加同一ip限流功能。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35fb1769086a4bf4a47d1ecaa24092e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=CglW76T2%2FPGlSCI5OAqYO0NI9oc%3D" alt="" loading="lazy"/>
限制同一个ip，比如每分钟只能请求5次接口。</p>
<p>但这种限流方式可能会有误杀的情况，比如同一个公司或网吧的出口ip是相同的，如果里面有多个正常用户同时发起请求，有些用户可能会被限制住。</p>
<h3 data-id="heading-18">13.3 对接口限流</h3>
<p>别以为限制了用户和ip就万事大吉，有些高手甚至可以使用代理，每次都请求都换一个ip。</p>
<p>这时可以限制请求的接口总次数。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67e39f294d9c4a2db4afb6777a973187~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=nl%2BiaoAn%2BYfhuAmi6WfgFaNkUYs%3D" alt="" loading="lazy"/>
在高并发场景下，这种限制对于系统的稳定性是非常有必要的。但可能由于有些非法请求次数太多，达到了该接口的请求上限，而影响其他的正常用户访问该接口。看起来有点得不偿失。</p>
<h3 data-id="heading-19">13.4 加验证码</h3>
<p>相对于上面三种方式，加验证码的方式可能更精准一些，同样能限制用户的访问频次，但好处是不会存在误杀的情况。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbb83f986fed496189bb0b18c9e5a09d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=7s5MpOKkgYSzRO5XHNPNJl03C88%3D" alt="" loading="lazy"/>
通常情况下，用户在请求之前，需要先输入验证码。用户发起请求之后，服务端会去校验该验证码是否正确。只有正确才允许进行下一步操作，否则直接返回，并且提示验证码错误。</p>
<p>此外，验证码一般是一次性的，同一个验证码只允许使用一次，不允许重复使用。</p>
<p>普通验证码，由于生成的数字或者图案比较简单，可能会被破解。优点是生成速度比较快，缺点是有安全隐患。</p>
<p>还有一个验证码叫做：<code>移动滑块</code>，它生成速度比较慢，但比较安全，是目前各大互联网公司的首选。</p>
<h2 data-id="heading-20">14 服务降级</h2>
<p>前面已经说过，对于高并发系统，为了保证系统的稳定性，需要做限流。</p>
<p>但光做限流还不够。</p>
<p>我们需要合理利用服务器资源，保留核心的功能，将部分非核心的功能，我们可以选择屏蔽或者下线掉。</p>
<p>我们需要做<code>服务降级</code>。</p>
<p>我们在设计高并发系统时，可以预留一些服务降级的开关。</p>
<p>比如在秒杀系统中，核心的功能是商品的秒杀，对于商品的评论功能，可以暂时屏蔽掉。</p>
<p>在服务端的分布式配置中心，比如：apollo中，可以增加一个开关，配置是否展示评论功能，默认是true。</p>
<p>前端页面通过服务器的接口，获取到该配置参数。</p>
<p>如果需要暂时屏蔽商品评论功能，可以将apollo中的参数设置成false。</p>
<p>此外，我们在设计高并发系统时，还可以预留一些兜底方案。</p>
<p>比如某个分类查询接口，要从redis中获取分类数据，返回给用户。但如果那一条redis挂了，则查询数据失败。</p>
<p>这时候，我们可以增加一个兜底方案。</p>
<p>如果从redis中获取不到数据，则从apollo中获取一份默认的分类数据。</p>
<p>目前使用较多的熔断降级中间件是：<code>Hystrix</code> 和 <code>Sentinel</code>。</p>
<ul>
<li>Hystrix是Netflix开源的熔断降级组件。</li>
<li>Sentinel是阿里中间件团队开源的一款不光具有熔断降级功能，同时还支持系统负载保护的组件。</li>
</ul>
<p>二者的区别如下图所示：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbb07cc10a2c4d3eb21f81f93dad0cad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=cURddcp4xRvln6JjDjniNXxrno4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-21">15 故障转移</h2>
<p>在高并发的系统当中，同一时间有大量的用户访问系统。</p>
<p>如果某一个应用服务器节点处于假死状态，比如CPU使用率100%了，用户的请求没办法及时处理，导致大量用户出现请求超时的情况。</p>
<p>如果这种情况下，不做任何处理，可能会影响系统中部分用户的正常使用。</p>
<p>这时我们需要建立<code>故障转移</code>机制。</p>
<p>当检测到经常接口超时，或者CPU打满，或者内存溢出的情况，能够自动重启那台服务器节点上的应用。</p>
<p>在SpringCloud微服务当中，可以使用<code>Ribbon</code>做负载均衡器。</p>
<p>Ribbon是Spring Cloud中的一个负载均衡器组件，它可以检测服务的可用性，并根据一定规则将请求分发至不同的服务节点。在使用Ribbon时，需要注意以下几个方面：</p>
<ol>
<li>设置请求超时时间，当请求超时时，Ribbon会自动将请求转发到其他可用的服务上。</li>
<li>设置服务的健康检查，Ribbon会自动检测服务的可用性，并将请求转发至可用的服务上。</li>
</ol>
<p>此外，还需要使用<code>Hystrix</code>做熔断处理。</p>
<p>Hystrix是SpringCloud中的一个熔断器组件，它可以自动地监测所有通过它调用的服务，并在服务出现故障时自动切换到备用服务。在使用Hystrix时，需要注意以下几个方面：</p>
<ol>
<li>设置断路器的阈值，当故障率超过一定阈值后，断路器会自动切换到备用服务上。</li>
<li>设置服务的超时时间，如果服务在指定的时间内无法返回结果，断路器会自动切换到备用服务上。到其他的能够正常使用的服务器节点上。</li>
</ol>
<h2 data-id="heading-22">16 异地多活</h2>
<p>有些高并发系统，为了保证系统的稳定性，不只部署在一个机房当中。</p>
<p>为了防止机房断电，或者某些不可逆的因素，比如：发生地震，导致机房挂了。</p>
<p>需要把系统部署到多个机房。</p>
<p>我们之前的游戏登录系统，就部署到了深圳、天津和成都，这三个机房。</p>
<p>这三个机房都有用户的流量，其中深圳机房占了40%，天津机房占了30%，成都机房占了30%。</p>
<p>如果其中的某个机房突然挂了，流量会被自动分配到另外两个机房当中，不会影响用户的正常使用。</p>
<p>这就需要使用<code>异地多活</code>架构了。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29cd6621cdcf4308942f1d86dad27c95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=GKaVZV5xjuHCzPSOOdY1nvDOHNg%3D" alt="" loading="lazy"/>
用户请求先经过第三方的DNS服务器解析，然后该用户请求到达路由服务器，部署在云服务器上。</p>
<p>路由服务器，根据一定的算法，会将该用户请求分配到具体的机房。</p>
<p>异地多活的难度是多个机房需要做数据同步，如何保证数据的一致性？</p>
<h2 data-id="heading-23">17 压测</h2>
<p>高并发系统，在上线之前，必须要做的一件事是做<code>压力测试</code>。</p>
<p>我们先要预估一下生产环境的请求量，然后对系统做压力测试，之后评估系统需要部署多少个服务器节点。</p>
<p>比如预估有10000的qps，一个服务器节点最大支持1000pqs，这样我们需要部署10个服务器节点。</p>
<p>但假如只部署10个服务器节点，万一突增了一些新的用户请求，服务器可能会扛不住压力。</p>
<p>因此，部署的服务器节点，需要把预估用户请求量的多一些，比如：按3倍的用户请求量来计算。</p>
<p>这样我们需要部署30个服务器节点。</p>
<p>压力测试的结果跟环境有关，在dev环境或者test环境，只能压测一个大概的趋势。</p>
<p>想要更真实的数据，我们需要在pre环境，或者跟生产环境相同配置的专门的压测环境中，进行压力测试。</p>
<p>目前市面上做压力测试的工具有很多，比如开源的有：Jemter、LoaderRunnder、Locust等等。</p>
<p>收费的有：阿里自研的云压测工具PTS。</p>
<h2 data-id="heading-24">18 监控</h2>
<p>为了出现系统或者SQL问题时，能够让我们及时发现，我们需要对系统做监控。</p>
<p>目前业界使用比较多的开源监控系统是：<code>Prometheus</code>。</p>
<p>它提供了 <code>监控</code> 和 <code>预警</code> 的功能。</p>
<p>架构图如下：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/20b28d2952bc46b991dcbd729367bc77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=uK5xST77%2BjWsqs%2F1XyNmPurRfl0%3D" alt="" loading="lazy"/></p>
<p>我们可以用它监控如下信息：</p>
<ul>
<li>接口响应时间</li>
<li>调用第三方服务耗时</li>
<li>慢查询sql耗时</li>
<li>cpu使用情况</li>
<li>内存使用情况</li>
<li>磁盘使用情况</li>
<li>数据库使用情况</li>
</ul>
<p>等等。。。</p>
<p>它的界面大概长这样子：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e97451b35c524e19aa96568a66ee17c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuP5LiJ6K-05oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534266&amp;x-signature=va3BvgRtpspk6XGg78NjJ6O1%2Fs8%3D" alt="" loading="lazy"/>
可以看到mysql当前qps，活跃线程数，连接数，缓存池的大小等信息。</p>
<p>如果发现数据量连接池占用太多，对接口的性能肯定会有影响。</p>
<p>这时可能是代码中开启了连接忘了关，或者并发量太大了导致的，需要做进一步排查和系统优化。</p>
<p>截图中只是它一小部分功能，如果你想了解更多功能，可以访问Prometheus的官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fprometheus.io%2F" target="_blank" title="https://prometheus.io/" ref="nofollow noopener noreferrer">prometheus.io/</a></p>
<p>其实，高并发的系统中，还需要考虑安全问题，比如：</p>
<ol>
<li>遇到用户不断变化ip刷接口怎办？</li>
<li>遇到用户大量访问缓存中不存在的数据，导致缓存雪崩怎么办？</li>
<li>如果用户发起ddos攻击怎么办？</li>
<li>用户并发量突增，导致服务器扛不住了，如何动态扩容？</li>
</ol>
<p>感兴趣的小伙伴可以找我私聊。</p>
<p>如果这篇文章对您有所帮助，或者有所启发的话，帮忙关注一下我的同名公众号：苏三说技术，您的支持是我坚持写作最大的动力。</p>
<p>求一键三连：点赞、转发、在看。</p>
<p>关注公众号：【苏三说技术】，在公众号中回复：进大厂，可以免费获取我最近整理的10万字的面试宝典，好多小伙伴靠这个宝典拿到了多家大厂的offer。</p>
<p>更多项目实战在我的技术博客：susan.net.cn/project</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 ES|QL 中的混合搜索和多阶段检索]]></title>    <link>https://juejin.cn/post/7592912896591396883</link>    <guid>https://juejin.cn/post/7592912896591396883</guid>    <pubDate>2026-01-09T03:19:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592912896591396883" data-draft-id="7592887786966319140" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 ES|QL 中的混合搜索和多阶段检索"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2026-01-09T03:19:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 ES|QL 中的混合搜索和多阶段检索
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:19:04.000Z" title="Fri Jan 09 2026 03:19:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fauthor%2Fioana-tagirta" title="https://www.elastic.co/search-labs/author/ioana-tagirta" target="_blank" ref="nofollow noopener noreferrer">Ioana Tagirta</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a19c9190184468ca51fb6615d85bc34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768533548&amp;x-signature=9SRDnvJ6d7QvXuIEFwSs4BZmEW4%3D" alt="" loading="lazy"/></p>
<p>亲身体验 Elasticsearch：深入了解我们的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Felastic%2Felasticsearch-labs%3Ftab%3Dreadme-ov-file" title="https://github.com/elastic/elasticsearch-labs?tab=readme-ov-file" target="_blank" ref="nofollow noopener noreferrer">示例 notebooks</a>，开始<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fcloud%2Fcloud-trial-overview" title="https://www.elastic.co/cloud/cloud-trial-overview" target="_blank" ref="nofollow noopener noreferrer">免费的 cloud 试用</a>，或立即在<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143747798" title="https://elasticstack.blog.csdn.net/article/details/143747798" target="_blank" ref="nofollow noopener noreferrer">本地机器</a>上试用 Elastic。</p>
<hr/>
<p>在 Elasticsearch 9.2 中，我们引入了在 Elasticsearch Query Language（ ES|QL ）中进行密集 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F145485873" title="https://elasticstack.blog.csdn.net/article/details/145485873" target="_blank" ref="nofollow noopener noreferrer">vector search</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F145697606" title="https://elasticstack.blog.csdn.net/article/details/145697606" target="_blank" ref="nofollow noopener noreferrer">hybrid search</a> 的能力。这延续了我们将 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Fquery-filter%2Flanguages%2Fesql" title="https://www.elastic.co/docs/explore-analyze/query-filter/languages/esql" target="_blank" ref="nofollow noopener noreferrer">ES|QL</a> 打造成解决现代 search 用例的最佳 search 语言的投入。</p>
<h2 data-id="heading-0">多阶段检索：现代搜索的挑战</h2>
<p>现代搜索已经不再只是简单的关键词匹配。今天的搜索应用需要理解意图，处理自然语言，并结合多个排序信号来提供最佳结果。</p>
<p>最相关结果的检索是在多个阶段中完成的，每个阶段都会逐步细化结果集。过去并非如此，当时大多数用例只需要一到两个阶段的检索：一次初始查询来获取结果，以及一个可能的重新评分阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83627cc18f12470a938737e74d7bfa39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768533548&amp;x-signature=khVr2kt6jWy143GdhyvL42U5m%2Bs%3D" alt="" loading="lazy"/></p>
<p>我们从初始检索开始，在这一阶段我们广泛搜索以收集与我们查询相关的结果。由于需要筛选所有数据，我们应该使用能够快速返回结果的技术，即使在索引数十亿文档时也能高效。</p>
<p>因此，我们采用可靠的技术，例如 Elasticsearch 从一开始就支持并优化的词汇搜索，或者 Elasticsearch 在速度和准确性上表现出色的 vector search。</p>
<p>使用 BM25 的 lexical search 非常快，最适合精确的术语匹配或短语匹配，而 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Fvector" title="https://www.elastic.co/docs/solutions/search/vector" target="_blank" ref="nofollow noopener noreferrer">vector</a> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Fsemantic-search" title="https://www.elastic.co/docs/solutions/search/semantic-search" target="_blank" ref="nofollow noopener noreferrer">semantic search</a> 更适合处理自然语言查询。<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F148668424" title="https://elasticstack.blog.csdn.net/article/details/148668424" target="_blank" ref="nofollow noopener noreferrer">Hybrid search</a> 将 lexical 和 vector search 结果结合起来，以发挥两者的优势。Hybrid search 解决的挑战在于 vector 和 lexical search 拥有完全不同且不兼容的评分函数，它们生成的值在不同区间，并遵循不同分布。vector search 得分接近 1 可能意味着非常匹配，但 lexical search 并非如此。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fhybrid-search-elasticsearch" title="https://www.elastic.co/search-labs/blog/hybrid-search-elasticsearch" target="_blank" ref="nofollow noopener noreferrer">Hybrid search</a> 方法，如 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Frest-apis%2Freciprocal-rank-fusion" title="https://www.elastic.co/docs/reference/elasticsearch/rest-apis/reciprocal-rank-fusion" target="_blank" ref="nofollow noopener noreferrer">reciprocal rank fusion (RRF)</a> 和 scores 的线性组合，会分配新的分数，将 lexical 和 vector search 的原始分数融合。</p>
<p>在 hybrid search 之后，我们可以使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Franking%2Fsemantic-reranking" title="https://www.elastic.co/docs/solutions/search/ranking/semantic-reranking" target="_blank" ref="nofollow noopener noreferrer">semantic reranking</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Franking%2Flearning-to-rank-ltr" title="https://www.elastic.co/docs/solutions/search/ranking/learning-to-rank-ltr" target="_blank" ref="nofollow noopener noreferrer">Learning To Rank (LTR)</a> 等技术，这些技术使用专门的 machine learning 模型对结果进行重新排序。</p>
<p>利用最相关的结果，我们可以使用 large language models (LLMs) 进一步丰富我们的响应，或在 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F153720860" title="https://elasticstack.blog.csdn.net/article/details/153720860" target="_blank" ref="nofollow noopener noreferrer">Elastic Agent Builder</a> 等工具的 agentic 工作流中，将最相关结果作为上下文传递给 LLMs。</p>
<p>ES|QL 能够处理检索的所有这些阶段。ES|QL 本身是一个管道语言，每条命令会转换输入并将输出发送到下一条命令。每个检索阶段由一个或多个连续的 ES|QL 命令表示。本文展示了 ES|QL 如何支持每个阶段。</p>
<h3 data-id="heading-1">Vector search - 向量搜索</h3>
<p>在 Elasticsearch 9.2 中，我们在 ES|QL 中引入了密集 vector search 的技术预览支持。这和调用 knn 函数一样简单，只需要一个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fmapping-reference%2Fdense-vector" title="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/dense-vector" target="_blank" ref="nofollow noopener noreferrer">dense_vector</a> 字段和一个 query vector：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> <span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector)
<span class="hljs-number">3.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>

`AI写代码
</code></pre>
<p>此查询执行近似最近邻搜索，检索与 query_vector 最相似的 100 个文档。</p>
<h3 data-id="heading-2">混合搜索：Reciprocal rank fusion/RRF</h3>
<p>在 Elasticsearch 9.2 中，我们在 ES|QL 中引入了使用 RRF 和结果线性组合的 hybrid search 支持。</p>
<p>这允许将 vector search 和 lexical search 结果合并为单一的结果集。</p>
<p>要在 ES|QL 中实现这一点，我们需要使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffork" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fork" target="_blank" ref="nofollow noopener noreferrer">FORK</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffuse" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fuse" target="_blank" ref="nofollow noopener noreferrer">FUSE</a> 命令。<strong>FORK</strong> 可以运行多个执行分支，<strong>FUSE</strong> 则合并结果，并使用 RRF 或线性组合分配新的相关性分数。</p>
<p>在下面的示例中，我们使用 FORK 运行两个独立的分支，其中一个使用 match 函数进行 lexical search，另一个使用 knn 函数进行 vector search。然后我们使用 FUSE 将结果合并：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE <span class="hljs-operator">/</span><span class="hljs-operator">/</span> uses RRF <span class="hljs-keyword">by</span> <span class="hljs-keyword">default</span>
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>

`AI写代码
</code></pre>
<p>让我们分解查询以更好地理解执行模型，首先来看 FORK 命令的输出：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)

`AI写代码
</code></pre>
<p>FORK 命令输出来自两个分支的结果，并添加了一个 _fork 鉴别器列：</p>
<table><thead><tr><th>_id</th><th>title</th><th>_score</th><th>_fork</th></tr></thead><tbody><tr><td>4001</td><td>The Hobbit</td><td>0.88</td><td>fork1</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>0.88</td><td>fork1</td></tr><tr><td>4005</td><td>The Two Towers</td><td>0.86</td><td>fork1</td></tr><tr><td>4006</td><td>The Return of the King</td><td>0.84</td><td>fork1</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>0.78</td><td>fork1</td></tr><tr><td>4144</td><td>The Children of Húrin</td><td>0.79</td><td>fork1</td></tr><tr><td>4001</td><td>The Hobbit</td><td>4.55</td><td>fork2</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>4.25</td><td>fork2</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>4.11</td><td>fork2</td></tr><tr><td>4005</td><td>The Two Towers</td><td>3.8</td><td>fork2</td></tr><tr><td>4006</td><td>The Return of the King</td><td>4.1</td><td>fork2</td></tr></tbody></table>
<p>正如你会注意到的，某些文档会出现两次，这就是我们随后使用 FUSE 来合并表示相同文档的行并分配新的相关性分数的原因。FUSE 分两阶段执行：</p>
<ul>
<li>对每一行，FUSE 根据所使用的 hybrid search 算法分配新的相关性分数。</li>
<li>表示相同文档的行会被合并，并计算新的分数。</li>
</ul>
<p>在我们的示例中，我们使用 RRF。第一步，FUSE 使用 RRF 公式为每一行分配新的分数：</p>
<pre><code class="hljs language-scss" lang="scss">`<span class="hljs-built_in">score</span>(doc) = <span class="hljs-number">1</span> / (rank_constant + rank(doc))`AI写代码
</code></pre>
<p>其中 rank_constant 的默认值为 60，rank(doc) 表示文档在结果集中的位置。</p>
<p>在第一阶段，我们的结果变为：</p>
<table><thead><tr><th>_id</th><th>title</th><th>_score</th><th>_fork</th></tr></thead><tbody><tr><td>4001</td><td>The Hobbit</td><td>1 / (60 + 1) = 0.01639</td><td>fork1</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>1 / (60 + 2) = 0.01613</td><td>fork1</td></tr><tr><td>4005</td><td>The Two Towers</td><td>1 / (60 + 3) = 0.01587</td><td>fork1</td></tr><tr><td>4006</td><td>The Return of the King</td><td>1 / (60 + 4) = 0.01563</td><td>fork1</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>1 / (60 + 5) = 0.01538</td><td>fork1</td></tr><tr><td>4144</td><td>The Children of Húrin</td><td>1 / (60 + 6) = 0.01515</td><td>fork1</td></tr><tr><td>4001</td><td>The Hobbit</td><td>1 / (60 + 1) = 0.01639</td><td>fork2</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>1 / (60 + 2) = 0.01613</td><td>fork2</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>1 / (60 + 3) = 0.01587</td><td>fork2</td></tr><tr><td>4005</td><td>The Two Towers</td><td>1 / (60 + 4) = 0.01563</td><td>fork2</td></tr><tr><td>4006</td><td>The Return of the King</td><td>1 / (60 + 5) = 0.01538</td><td>fork2</td></tr></tbody></table>
<p>然后这些行会被合并，并分配新的分数。由于 FUSE 命令后跟 SORT _score DESC，最终结果为：</p>
<table><thead><tr><th>_id</th><th>title</th><th>_score</th></tr></thead><tbody><tr><td>4001</td><td>The Hobbit</td><td>0.01639 + 0.01639 = 0.03279</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>0.01613 + 0.01613 = 0.03226</td></tr><tr><td>4005</td><td>The Two Towers</td><td>0.01587 + 0.01563 = 0.0315</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>0.01538 + 0.01587 = 0.03125</td></tr><tr><td>4006</td><td>The Return of the King</td><td>0.01563 + 0.01538 = 0.03101</td></tr><tr><td>4144</td><td>The Children of Húrin</td><td>0.01515</td></tr></tbody></table>
<h3 data-id="heading-3">混合搜索：scores 的线性组合</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Frest-apis%2Freciprocal-rank-fusion" title="https://www.elastic.co/docs/reference/elasticsearch/rest-apis/reciprocal-rank-fusion" target="_blank" ref="nofollow noopener noreferrer">Reciprocal rank fusion</a> 是执行 hybrid search 最简单的方法，但它不是我们在 ES|QL 中支持的唯一 hybrid search 方法。</p>
<p>在下面的示例中，我们使用 FUSE 通过 scores 的线性组合来合并 lexical 和 semantic search 结果：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(semantic_description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE LINEAR <span class="hljs-keyword">WITH</span> { "weights": { "fork1": <span class="hljs-number">0.7</span>, "fork2": <span class="hljs-number">0.3</span> } }
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>

`AI写代码
</code></pre>
<p>让我们先分解查询，并查看当只运行 FORK 命令时 FUSE 命令的输入。</p>
<p>注意，我们使用 match 函数，它不仅可以查询 lexical 字段，如 text 或 keyword，还可以查询 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fmapping-reference%2Fsemantic-text" title="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/semantic-text" target="_blank" ref="nofollow noopener noreferrer">semantic_text</a> 字段。</p>
<p>第一个 FORK 分支通过查询 semantic_text 字段执行 semantic query，而第二个分支执行 lexical query：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(semantic_description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)

`AI写代码
</code></pre>
<p>FORK 命令的输出可能包含具有相同 _id 和 _index 值的行，这些行表示同一个 Elasticsearch 文档：</p>
<table><thead><tr><th>_id</th><th>title</th><th>_score</th><th>_fork</th></tr></thead><tbody><tr><td>4001</td><td>The Hobbit</td><td>0.88</td><td>fork1</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>0.88</td><td>fork1</td></tr><tr><td>4005</td><td>The Two Towers</td><td>0.86</td><td>fork1</td></tr><tr><td>4006</td><td>The Return of the King</td><td>0.84</td><td>fork1</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>0.78</td><td>fork1</td></tr><tr><td>4144</td><td>The Children of Húrin</td><td>0.79</td><td>fork1</td></tr><tr><td>4001</td><td>The Hobbit</td><td>4.55</td><td>fork2</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>4.25</td><td>fork2</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>4.11</td><td>fork2</td></tr><tr><td>4005</td><td>The Two Towers</td><td>3.8</td><td>fork2</td></tr><tr><td>4006</td><td>The Return of the King</td><td>4.1</td><td>fork2</td></tr></tbody></table>
<p>在下一步，我们使用 FUSE 合并具有相同 _id 和 _index 值的行，并分配新的相关性分数。</p>
<p>新的分数是该行在每个 FORK 分支中的分数的线性组合：</p>
<pre><code class="hljs language-ini" lang="ini">`<span class="hljs-attr">_score</span> = <span class="hljs-number">0.7</span> *_score1 + <span class="hljs-number">0.3</span> * _score2`AI写代码
</code></pre>
<p>这里，_score1 和 _score2 分别表示文档在第一个 FORK 分支和第二个 FORK 分支中的分数。</p>
<blockquote>
<p>注意，我们还应用了自定义权重，对 semantic score 给予比 lexical score 更高的权重，得到这一组文档：</p>
</blockquote>
<table><thead><tr><th>_id</th><th>title</th><th>_score</th></tr></thead><tbody><tr><td>4001</td><td>The Hobbit</td><td>0.7 * 0.88 + 0.3 * 4.55 = 1.981</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>0.7 * 0.88 + 0.3 * 4.25 = 1.891</td></tr><tr><td>4006</td><td>The Return of the King</td><td>0.7 * 0.84 + 0.3 * 4.1 = 1.818</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>0.7 * 0.78 + 0.3 * 4.11 = 1.779</td></tr><tr><td>4005</td><td>The Two Towers</td><td>0.7 * 0.86 + 0.3 * 3.8 = 1.742</td></tr><tr><td>4144</td><td>The Children of Húrin</td><td>0.7 * 0.79 + 0.3 * 0 = 0.553</td></tr></tbody></table>
<p>一个挑战是 semantic score 和 lexical score 可能不兼容直接进行线性组合，因为它们可能遵循完全不同的分布。为缓解这一问题，我们首先需要对分数进行归一化，使用 score normalization 方法，如 minmax。这样可以确保每个 FORK 分支的分数在应用线性组合公式前先被归一化到 0 到 1 之间的值。</p>
<p>要使用 FUSE 实现这一点，我们需要指定 normalizer 选项：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(semantic_description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE LINEAR <span class="hljs-keyword">WITH</span> { "weights": { "fork1": <span class="hljs-number">0.7</span>, "fork2": <span class="hljs-number">0.3</span> }, "normalizer": "minmax" }
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>

`AI写代码
</code></pre>
<h3 data-id="heading-4">Semantic reranking</h3>
<p>在这一阶段，经过 hybrid search 后，我们应该只剩下最相关的文档。我们现在可以使用 semantic <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F143352429" title="https://elasticstack.blog.csdn.net/article/details/143352429" target="_blank" ref="nofollow noopener noreferrer">reranking</a> 通过 RERANK 命令重新排序结果。默认情况下，RERANK 使用最新的 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Franking%2Fsemantic-reranking" title="https://www.elastic.co/docs/solutions/search/ranking/semantic-reranking" target="_blank" ref="nofollow noopener noreferrer">semantic reranking</a> 机器学习模型，因此无需额外配置：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">6.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>
<span class="hljs-number">7.</span>  <span class="hljs-operator">|</span> RERANK ?query <span class="hljs-keyword">ON</span> description
<span class="hljs-number">8.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>

`AI写代码
</code></pre>
<p>我们现在得到了按相关性排序的最佳结果。</p>
<p>RERANK 命令区别于其他提供 semantic reranking 集成的产品的一个关键特性是，它不要求输入必须是索引中的映射字段。RERANK 只需要一个能求值为字符串的表达式，因此可以使用多个字段进行 semantic reranking：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">6.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>
<span class="hljs-number">7.</span>  <span class="hljs-operator">|</span> RERANK ?query <span class="hljs-keyword">ON</span> CONCAT(title, "\n", description) 
<span class="hljs-number">8.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>

`AI写代码
</code></pre>
<h2 data-id="heading-5">LLM completions</h2>
<p>现在我们有了一组高度相关、重新排序的结果。</p>
<p>在这一阶段，你可以选择直接将结果返回给你的应用，也可以使用 LLM completions 进一步增强结果。</p>
<p>如果你在 retrieval-augmented generation (<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F134396254" title="https://elasticstack.blog.csdn.net/article/details/134396254" target="_blank" ref="nofollow noopener noreferrer">RAG</a>) 工作流中使用 ES|QL，你可以选择直接从 ES|QL 调用你喜欢的 LLM。<br/>
为此，我们新增了 COMPLETION 命令，它接受一个 prompt、一个 completion <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fexplore-analyze%2Felastic-inference" title="https://www.elastic.co/docs/explore-analyze/elastic-inference" target="_blank" ref="nofollow noopener noreferrer">inference</a> ID（指定调用哪个 LLM）以及一个列标识符（指定 LLM 响应输出到哪一列）。</p>
<p>在下面的示例中，我们使用 COMPLETION 添加了一个新的 _completion 列，其中包含 content 列的摘要：</p>
<pre><code class="hljs language-sql" lang="sql">`<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">6.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>
<span class="hljs-number">7.</span>  <span class="hljs-operator">|</span> RERANK ?query <span class="hljs-keyword">ON</span> description
<span class="hljs-number">8.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">9.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>
<span class="hljs-number">10.</span>  <span class="hljs-operator">|</span> COMPLETION CONCAT("Summarize the following:\n", description) <span class="hljs-keyword">WITH</span> { "inference_id" : "my_inference_endpoint" }` AI写代码<span class="hljs-operator">!</span>[](https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>csdnimg.cn<span class="hljs-operator">/</span><span class="hljs-keyword">release</span><span class="hljs-operator">/</span>blogv2<span class="hljs-operator">/</span>dist<span class="hljs-operator">/</span>pc<span class="hljs-operator">/</span>img<span class="hljs-operator">/</span>runCode<span class="hljs-operator">/</span>icon<span class="hljs-operator">-</span>arrowwhite.png)
</code></pre>
<p>每一行现在都包含一个摘要：</p>
<table><thead><tr><th>_id</th><th>title</th><th>_score</th><th>summary</th></tr></thead><tbody><tr><td>4001</td><td>The Hobbit</td><td>0.03279</td><td>Bilbo helps dwarves reclaim Erebor from the dragon Smaug.</td></tr><tr><td>3999</td><td>The Fellowship of the Ring</td><td>0.03226</td><td>Frodo begins the quest to destroy the One Ring.</td></tr><tr><td>4005</td><td>The Two Towers</td><td>0.0315</td><td>The Fellowship splits; war comes to Rohan; Frodo nears Mordor.</td></tr><tr><td>4123</td><td>The Silmarillion</td><td>0.03125</td><td>Ancient myths and history of Middle-earth's First Age.</td></tr><tr><td>4006</td><td>The Return of the King</td><td>0.3101</td><td>Sauron is defeated and Aragorn is crowned King.</td></tr><tr><td>4144</td><td>The Children of Húrin</td><td>0.01515</td><td>The tragic tale of Túrin Turambar's cursed life.</td></tr></tbody></table>
<p>在另一种用例中，你可能只是想使用自己在 Elasticsearch 中索引的专有数据来回答问题。在这种情况下，我们在前一阶段计算出的最佳搜索结果可以作为 prompt 的上下文：</p>
<pre><code class="hljs language-sql" lang="sql">`

<span class="hljs-number">1.</span>  <span class="hljs-keyword">FROM</span> books METADATA _score, _id, _index
<span class="hljs-number">2.</span>  <span class="hljs-operator">|</span> FORK (<span class="hljs-keyword">WHERE</span> KNN(description_vector, ?query_vector) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">3.</span>         (<span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">MATCH</span>(description, ?query) <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span> <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>)
<span class="hljs-number">4.</span>  <span class="hljs-operator">|</span> FUSE
<span class="hljs-number">5.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">6.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">100</span>
<span class="hljs-number">7.</span>  <span class="hljs-operator">|</span> RERANK ?query <span class="hljs-keyword">ON</span> description
<span class="hljs-number">8.</span>  <span class="hljs-operator">|</span> SORT _score <span class="hljs-keyword">DESC</span>
<span class="hljs-number">9.</span>  <span class="hljs-operator">|</span> LIMIT <span class="hljs-number">10</span>
<span class="hljs-number">10.</span>  <span class="hljs-operator">|</span> STATS context <span class="hljs-operator">=</span> <span class="hljs-keyword">VALUES</span>(CONCAT(title, "\n", description)
<span class="hljs-number">11.</span>  <span class="hljs-operator">|</span> COMPLETION CONCAT("Answer the following question ", ?query, "based on:\n", context) <span class="hljs-keyword">WITH</span> { "inference_id" : "my_inference_endpoint" }

`AI写代码<span class="hljs-operator">!</span>[](https:<span class="hljs-operator">/</span><span class="hljs-operator">/</span>csdnimg.cn<span class="hljs-operator">/</span><span class="hljs-keyword">release</span><span class="hljs-operator">/</span>blogv2<span class="hljs-operator">/</span>dist<span class="hljs-operator">/</span>pc<span class="hljs-operator">/</span>img<span class="hljs-operator">/</span>runCode<span class="hljs-operator">/</span>icon<span class="hljs-operator">-</span>arrowwhite.png)
</code></pre>
<p>由于 COMPLETION 命令解锁了向 LLM 发送任意 prompt 的能力，可能性是无穷的。虽然我们只展示了一些示例，但 COMPLETION 命令可以用于各种场景，从安全分析师根据日志事件是否可能表示恶意行为来分配分数，到数据科学家用它分析数据，甚至到仅仅<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F150973787" title="https://elasticstack.blog.csdn.net/article/details/150973787" target="_blank" ref="nofollow noopener noreferrer">根据你的数据生成 Chuck Norris 事实</a>的情况。</p>
<h2 data-id="heading-6">这只是开始</h2>
<p>未来，我们将扩展 ES|QL，以改进长文档的 semantic reranking，更好地使用多个 FORK 命令进行 ES|QL 查询的条件执行，支持 sparse vector 查询，去除近似重复结果以提高结果多样性，允许对运行时生成的列进行全文搜索，以及更多其他场景。</p>
<p>更多教程和指南：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Fsolutions%2Fsearch%2Fesql-for-search" title="https://www.elastic.co/docs/solutions/search/esql-for-search" target="_blank" ref="nofollow noopener noreferrer">ES|QL for search</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fesql-search-tutorial" title="https://www.elastic.co/docs/reference/query-languages/esql/esql-search-tutorial" target="_blank" ref="nofollow noopener noreferrer">ES|QL for search tutorial</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Felasticsearch%2Fmapping-reference%2Fsemantic-text" title="https://www.elastic.co/docs/reference/elasticsearch/mapping-reference/semantic-text" target="_blank" ref="nofollow noopener noreferrer">Semantic_text field type</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffork" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fork" target="_blank" ref="nofollow noopener noreferrer">FORK</a> and <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fquery-languages%2Fesql%2Fcommands%2Ffuse" title="https://www.elastic.co/docs/reference/query-languages/esql/commands/fuse" target="_blank" ref="nofollow noopener noreferrer">FUSE</a> 文档</li>
<li>ES|QL search functions</li>
</ul>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsearch-labs%2Fblog%2Fhybrid-search-multi-stage-retrieval-esql" title="https://www.elastic.co/search-labs/blog/hybrid-search-multi-stage-retrieval-esql" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/search-labs…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 框架设计（三）：用开闭原则拯救你的组件库]]></title>    <link>https://juejin.cn/post/7592996072705163314</link>    <guid>https://juejin.cn/post/7592996072705163314</guid>    <pubDate>2026-01-09T03:42:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592996072705163314" data-draft-id="7592906873089441838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 框架设计（三）：用开闭原则拯救你的组件库"/> <meta itemprop="keywords" content="前端,架构"/> <meta itemprop="datePublished" content="2026-01-09T03:42:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 框架设计（三）：用开闭原则拯救你的组件库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:42:59.000Z" title="Fri Jan 09 2026 03:42:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>兄弟们，回想一下，你有没有接过这种需求：</p>
<p>产品经理跑来说：“咱们那个通用的表格组件，现在需要在某一列加个自定义的渲染逻辑，以前是纯文本，现在要变成个带图标的按钮，还能点击弹窗。”</p>
<p>你心想：“这还不简单？”</p>
<p>于是你打开了那个祖传的 <code>CommonTable.vue</code> 或 <code>Table.tsx</code>，找到了渲染单元格的地方，熟练地写下了一个 <code>if-else</code>。</p>
<p>过了两天，产品又来了：“那啥，另一列也要改，这次要加个进度条。”</p>
<p>你又熟练地加了一个 <code>else-if</code>。</p>
<p>几个月后，这个组件的源码已经突破了 2000 行，光那个 <code>if-else</code> 的判断逻辑就占了半屏。后来的同事接手时，看着这坨代码，只想把你拉黑。</p>
<p>这种“改哪哪疼，牵一发而动全身”的代码，就是典型的违反了<strong>开闭原则 (Open/Closed Principle, OCP)</strong> 。今天咱们就来聊聊，怎么用 OCP 把这坨代码重构成“人话”。</p>
</blockquote>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/362af4a3a08c45f6b5e79878e0393259~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534978&amp;x-signature=8LBXGrcsSdhSyyEzCMGIidC2Ruo%3D" alt="39072abf-1240-4203-a664-62f3074c67cd.png" loading="lazy"/></p>
<h2 data-id="heading-0">什么是开闭原则 (OCP)？</h2>
<p>开闭原则，听起来很高大上，其实说人话就是八个字：</p>
<p><strong>对扩展开放，对修改关闭。</strong></p>
<ul>
<li><strong>对扩展开放 (Open for extension)</strong> ：当有新需求来了，你应该能通过“增加新代码”的方式来满足，而不是去改旧代码。</li>
<li><strong>对修改关闭 (Closed for modification)</strong> ：那个已经写好、测试过、稳定运行的核心代码，你尽量别去动它。</li>
</ul>
<p>想象一下你的电脑主机。你想加个显卡，是直接把主板焊开接线（修改），还是找个 PCI-E 插槽插上去（扩展）？显然后者更靠谱。</p>
<p>在前端领域，OCP 最典型的应用场景就是<strong>组件设计</strong>和<strong>插件系统</strong>。</p>
<hr/>
<h2 data-id="heading-1">案例分析：一个“违反 OCP”的糟糕组件</h2>
<p>咱们就拿最常见的<strong>通用列表项组件</strong>来举例。假设我们有一个 <code>ListItem</code> 组件，用来展示用户信息。</p>
<h3 data-id="heading-2">原始需求</h3>
<p>需求很简单：展示用户的头像和名字。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ListItem.tsx (V1)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">avatar</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">ListItem</span> = (<span class="hljs-params">{ user }: { user: User }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"list-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{user.avatar}</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">{user.name}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<p>这代码看起来没毛病，清爽、简单。</p>
<h3 data-id="heading-3">需求变更 1：加个 VIP 标志</h3>
<p>产品说：“有些用户是 VIP，名字后面得加个金灿灿的皇冠图标。”</p>
<p>你心想，小case，一把梭：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ListItem.tsx (V2 - 开始变味了)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">avatar</span>: <span class="hljs-built_in">string</span>;
  isVip?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 新增字段</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">ListItem</span> = (<span class="hljs-params">{ user }: { user: User }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"list-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{user.avatar}</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">{user.name}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      {/* 修改点：硬编码逻辑 */}
      {user.isVip &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"vip-icon"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<p>你为了这个新需求，<strong>修改</strong>了 <code>ListItem</code> 组件的内部实现。虽然只加了一行，但坏头已经开了。</p>
<h3 data-id="heading-4">需求变更 2：再加个在线状态</h3>
<p>产品又来了：“得显示用户在不在线，在线的头像旁边亮个绿灯。”</p>
<p>你叹了口气，继续梭：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ListItem.tsx (V3 - 味道越来越冲)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">avatar</span>: <span class="hljs-built_in">string</span>;
  isVip?: <span class="hljs-built_in">boolean</span>;
  isOnline?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 又新增字段</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">ListItem</span> = (<span class="hljs-params">{ user }: { user: User }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"list-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"avatar-wrapper"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{user.avatar}</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">{user.name}</span> /&gt;</span>
        {/* 修改点：又硬编码逻辑 */}
        {user.isOnline &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"online-dot"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      {user.isVip &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"vip-icon"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<p><strong>问题来了：</strong></p>
<ol>
<li><strong>组件越来越臃肿</strong>：每次新需求都要改这个文件，代码量蹭蹭涨。</li>
<li><strong>耦合度极高</strong>：<code>ListItem</code> 竟然要知道什么是 VIP，什么是在线状态。如果明天要加个“等级勋章”、“活动挂件”呢？</li>
<li><strong>测试困难</strong>：每次改动都得把以前的 VIP、在线状态全测一遍，生怕改坏了。</li>
</ol>
<p>这就是典型的<strong>违反了对修改关闭</strong>。核心组件被迫了解太多它不该知道的业务逻辑。</p>
<hr/>
<h2 data-id="heading-5">重构：用 OCP 把“屎山”铲平</h2>
<p>怎么让 <code>ListItem</code> 既能支持各种花里胡哨的展示，又不用每次都改它呢？</p>
<p>答案就是：<strong>把变化的部分抽离出去，留下不变的骨架。</strong></p>
<ul>
<li><strong>不变的部分</strong>：列表项的基本结构（左边是图，右边是文字）。</li>
<li><strong>变化的部分</strong>：头像旁边要加什么装饰？文字后面要挂什么配件？</li>
</ul>
<p>我们可以利用 React 的 <strong>组合 (Composition)</strong> 特性，比如 <code>children</code> 或者 <strong>Render Props</strong>（插槽槽位）。</p>
<h3 data-id="heading-6">重构 V1：使用插槽 (Slots / Render Props)</h3>
<p>我们改造一下 <code>ListItem</code>，让它别管那么多闲事，只负责提供“坑位”。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ListItem.tsx (OCP版本)</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ListItemProps</span> {
  <span class="hljs-attr">avatar</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>; <span class="hljs-comment">// 不再只传字符串，直接传节点</span>
  <span class="hljs-attr">title</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;  <span class="hljs-comment">// 同上</span>
  <span class="hljs-comment">// 预留两个扩展槽位</span>
  avatarAddon?: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;
  titleAddon?: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>;
}

<span class="hljs-comment">// 这个组件现在稳定得一批，几乎不需要再修改了</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">ListItem</span> = (<span class="hljs-params">{ avatar, title, avatarAddon, titleAddon }: ListItemProps</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"list-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"avatar-wrapper"</span>&gt;</span>
        {avatar}
        {/* 扩展点：头像装饰 */}
        {avatarAddon}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"title-wrapper"</span>&gt;</span>
        {title}
        {/* 扩展点：标题装饰 */}
        {titleAddon}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};
</code></pre>
<p>现在，核心组件 <code>ListItem</code> 对修改是关闭的。那怎么扩展新需求呢？</p>
<p><strong>在使用它的地方进行扩展（对扩展开放）：</strong></p>
<pre><code class="hljs language-ini" lang="ini">// UserList.tsx (业务层)
import ListItem from './ListItem'<span class="hljs-comment">;</span>

const <span class="hljs-attr">UserList</span> = ({ users }) =&gt; {
  return (
    &lt;div&gt;
      {users.map(<span class="hljs-attr">user</span> =&gt; (
        &lt;ListItem
          <span class="hljs-attr">key</span>={user.id}
          // 基础信息
          <span class="hljs-attr">avatar</span>={&lt;img src={user.avatar} /&gt;}
          <span class="hljs-attr">title</span>={&lt;span&gt;{user.name}&lt;/span&gt;}
          // 扩展需求1：在线状态
          <span class="hljs-attr">avatarAddon</span>={user.isOnline ? &lt;<span class="hljs-literal">On</span>lineDot /&gt; : null}
          // 扩展需求2：VIP标识
          <span class="hljs-attr">titleAddon</span>={user.isVip ? &lt;VipCrown /&gt; : null}
        /&gt;
      ))}
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<p><strong>看！世界清静了。</strong></p>
<ul>
<li><code>ListItem</code> 组件不知道也不关心什么是 VIP。它只知道：“如果有人给了我 <code>titleAddon</code>，那我就把它渲染在标题后面。”</li>
<li>如果明天产品要加个“等级勋章”，你只需要写个 <code>&lt;LevelBadge /&gt;</code> 组件，然后传给 <code>titleAddon</code> 即可。<strong><code>ListItem.tsx</code> 文件一个字都不用改。</strong></li>
</ul>
<p>这就是 OCP 的魅力。</p>
<hr/>
<h2 data-id="heading-7">进阶：策略模式与配置化</h2>
<p>在更复杂的场景下，比如我们开头提到的通用表格组件，每一列的渲染逻辑可能千奇百怪。这时候光用插槽可能还不够灵活。</p>
<p>我们可以借鉴<strong>策略模式</strong>的思想，结合配置化来实现 OCP。</p>
<p>假设我们有一个复杂的后台管理表格。</p>
<h3 data-id="heading-8">糟糕的设计 (违反 OCP)</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// BadTableColumn.tsx</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">renderCell</span> = (<span class="hljs-params">value, columnType</span>) =&gt; {
  <span class="hljs-comment">// 地狱 if-else </span>
  <span class="hljs-keyword">if</span> (columnType === <span class="hljs-string">'text'</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (columnType === <span class="hljs-string">'image'</span>) {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{value}</span> /&gt;</span></span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (columnType === <span class="hljs-string">'link'</span>) {
    <span class="hljs-comment">// ...要加新类型就得改这里</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (columnType === <span class="hljs-string">'status'</span>) {
     <span class="hljs-comment">// ...越来越长</span>
  }
  <span class="hljs-comment">// ...</span>
};
</code></pre>
<h3 data-id="heading-9">符合 OCP 的设计</h3>
<p>我们定义一个策略注册表，把每种类型的渲染逻辑注册进去。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// renderStrategies.tsx (策略定义)</span>
<span class="hljs-keyword">const</span> strategies = {
  <span class="hljs-attr">text</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>,
  <span class="hljs-attr">image</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{value}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"table-img"</span> /&gt;</span></span>,
  <span class="hljs-comment">// 新需求：状态标签</span>
  <span class="hljs-attr">status</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Tag</span> <span class="hljs-attr">color</span>=<span class="hljs-string">{value</span> === <span class="hljs-string">'active'</span> ? '<span class="hljs-attr">green</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">red</span>'}&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">Tag</span>&gt;</span></span>,
};

<span class="hljs-comment">// 提供注册入口（对扩展开放）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">registerStrategy</span> = (<span class="hljs-params"><span class="hljs-keyword">type</span>, renderer</span>) =&gt; {
  strategies[<span class="hljs-keyword">type</span>] = renderer;
};

<span class="hljs-comment">// 提供获取入口</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getStrategy</span> = (<span class="hljs-params"><span class="hljs-keyword">type</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> strategies[<span class="hljs-keyword">type</span>] || strategies[<span class="hljs-string">'text'</span>];
};
</code></pre>
<p>然后，表格组件只负责调用策略：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// GoodTableColumn.tsx</span>
<span class="hljs-keyword">import</span> { getStrategy } <span class="hljs-keyword">from</span> <span class="hljs-string">'./renderStrategies'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">TableCell</span> = (<span class="hljs-params">{ value, columnType }</span>) =&gt; {
  <span class="hljs-comment">// 核心组件对修改关闭：它不需要知道具体怎么渲染</span>
  <span class="hljs-keyword">const</span> renderer = <span class="hljs-title function_">getStrategy</span>(columnType);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>{renderer(value)}<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span></span>;
};
</code></pre>
<p>当你要新增一种“进度条”类型的列时，你根本不需要碰 <code>TableCell</code> 组件，只需要在项目的入口文件里注册一个新的策略：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js (应用入口)</span>
<span class="hljs-keyword">import</span> { registerStrategy } <span class="hljs-keyword">from</span> <span class="hljs-string">'./renderStrategies'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ProgressBar</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/ProgressBar'</span>;

<span class="hljs-comment">// 扩展新能力</span>
<span class="hljs-title function_">registerStrategy</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ProgressBar</span> <span class="hljs-attr">percent</span>=<span class="hljs-string">{value}</span> /&gt;</span></span>);
</code></pre>
<p>这就实现了一个简易的插件化系统。核心库稳定不变，业务方通过注册机制无限扩展能力。</p>
<hr/>
<h2 data-id="heading-10">总结：别让自己成为“改Bug机器”</h2>
<p>开闭原则不是什么高深的理论，它就是为了让你少加班、少背锅而生的。</p>
<p><strong>记住这几个实战要点：</strong></p>
<ol>
<li><strong>识别变化点</strong>：做组件之前先想想，哪些是铁打不动的骨架，哪些是流水易变的皮肉。</li>
<li><strong>多用组合/插槽</strong>：React 的 <code>children</code> 和 Render Props，Vue 的 <code>slot</code>，都是实现 OCP 的利器。把决定权交给使用者，而不是自己大包大揽。</li>
<li><strong>善用策略/配置</strong>：遇到复杂的 <code>if-else</code> 逻辑判断渲染类型时，考虑用映射表（Map 对象）代替硬编码，把逻辑抽离出去。</li>
</ol>
<p>下次再遇到产品经理不断提新需求，希望你能自信地打开代码，优雅地新增一个文件，而不是痛苦地在那坨几千行的祖传代码里加 <code>if-else</code>。</p>
<p>Keep coding, keep open!</p>
<hr/>
<blockquote>
<p><strong>互动话题</strong></p>
<p>你的项目里有没有那种因为违反 OCP 而变得维护困难的“超级组件”？你又是怎么重构它的？欢迎在评论区吐槽交流！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenCode真的可以挑战Claude Code]]></title>    <link>https://juejin.cn/post/7592996072705179698</link>    <guid>https://juejin.cn/post/7592996072705179698</guid>    <pubDate>2026-01-09T03:46:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592996072705179698" data-draft-id="7592906873089343534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenCode真的可以挑战Claude Code"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T03:46:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大橙子打游戏"/> <meta itemprop="url" content="https://juejin.cn/user/1081575170907086"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenCode真的可以挑战Claude Code
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575170907086/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大橙子打游戏
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:46:33.000Z" title="Fri Jan 09 2026 03:46:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用 OpenCode 结合 OhMyOpenCode：在 VS Code 与 Trae 中的高效开发实战（含截图与配置）</h2>
<blockquote>
<p>2026 年开发者的终端编程利器：从安装到 Multi‑Agent 工作流全解析</p>
</blockquote>
<h3 data-id="heading-1">概述：OpenCode + OhMyOpenCode 在 IDE 中的效率飞跃</h3>
<p>在 2026 年的今天，AI 编程工具已经从简单的代码补全进化为能够独立执行复杂任务的智能体（Agent）。OpenCode 作为这一领域的开源领跑者，凭借其强大的 CLI（命令行界面）与 TUI（终端用户界面）交互模式，正在重新定义开发者的工作流。而 OhMyOpenCode 作为其最强伴侣，通过插件化机制进一步释放了 Multi‑Agent 的协作潜力。</p>
<ul>
<li>OpenCode 是什么？一款 100% 开源的 AI 编程代理，既可以在终端独立运行，也能作为 IDE 插件集成。它支持 GLM‑4.7、MiniMax、Grok Code 等多种模型，主打 “终端即入口” 的高效交互体验，能够直接操作文件系统、执行 Shell 命令并进行代码重构。</li>
<li>OhMyOpenCode 是什么？OpenCode 的社区增强插件（代号 “Sisyphus”）。它为 OpenCode 注入了类似 Claude Code 的兼容层，提供完善的 Agent 任务编排机制、精选 MCP 工具链以及并行任务处理能力，被誉为 “生产力核弹”。</li>
</ul>
<p>为什么选择在 VS Code 或 Trae 中使用它们？核心在于“终端集成”。现代 IDE 如 Trae 和 VS Code 都拥有强大的内置终端。OpenCode 这种“终端原生”的工具，天然适合嵌入到 IDE 的下半部分面板中：你可以在编辑器中浏览代码，同时在终端里指挥 Agent 进行批量重构、生成文档或跨文件分析。这种组合既保留了图形界面的直观，又获得了命令行工具的极致效率。</p>
<p>典型提效场景：</p>
<ul>
<li>批量重构：“将 src 目录下所有组件的 Class 写法转换为 Hooks。”</li>
<li>脚手架生成：“基于当前的 schema.prisma 文件生成全套 CRUD 接口。”</li>
<li>跨项目上下文：读取 legacy 项目的代码逻辑，应用到当前的新微服务中。</li>
<li>文档维护：自动分析改动文件，生成对应的 CHANGELOG 和 API 文档。</li>
</ul>
<h3 data-id="heading-2">环境准备与安装（VS Code / Trae）</h3>
<p>要构建这套工作流，我们需要分层安装：先核心（OpenCode CLI），再插件（IDE Extension），最后增强（OhMyOpenCode）。</p>
<h4 data-id="heading-3">1. 安装 OpenCode 核心</h4>
<p>OpenCode 是一个 Go 语言编写的独立程序，支持 macOS、Linux 和 Windows。推荐使用官方脚本进行安装，以确保获取最新版本（支持 TUI 模式）。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># macOS / Linux</span>
curl -sL https://opencode.ai/install | bash

<span class="hljs-comment"># Windows (PowerShell)</span>
iwr https://opencode.ai/install.ps1 | iex
</code></pre>
<p>安装完成后，在任意终端输入 <code>opencode version</code> 验证是否成功。</p>
<h4 data-id="heading-4">2. 在 VS Code 中安装扩展</h4>
<p>为了获得更好的编辑器联动（如代码高亮 Diff、一键应用代码块），建议安装官方 VS Code 扩展：</p>
<ol>
<li>打开 VS Code 扩展市场（Ctrl+Shift+X）。</li>
<li>搜索并安装官方扩展：<code>sst-dev.opencode</code>（避免同名仿冒）。</li>
<li>扩展市场链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dsst-dev.opencode" target="_blank" title="https://marketplace.visualstudio.com/items?itemName=sst-dev.opencode" ref="nofollow noopener noreferrer">marketplace.visualstudio.com/items?itemN…</a></li>
</ol>
<h4 data-id="heading-5">3. 在 Trae 中集成</h4>
<p>Trae 是基于 VS Code 二次开发的 AI 原生 IDE，对终端工具的支持非常友好。在 Trae 中通常无需安装额外插件，直接利用其内置终端即可完美运行 OpenCode TUI：</p>
<ol>
<li>打开 Trae IDE。</li>
<li>唤起底部终端面板（Terminal）。</li>
<li>输入 <code>opencode</code> 启动交互会话。</li>
</ol>
<h4 data-id="heading-6">4. 启用 OhMyOpenCode 增强</h4>
<p>OhMyOpenCode 本质上是一组为 OpenCode 设计的高级配置脚本和插件包：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在终端中运行 OpenCode 的插件安装命令</span>
opencode plugin install code-yeongyu/oh-my-opencode
</code></pre>
<p>安装后，OpenCode 会自动加载该层兼容配置，你的界面提示符可能会发生变化（例如变为 “Sisyphus” 风格），这标志着 Multi‑Agent 引擎已就绪。</p>
<h3 data-id="heading-7">在 VS Code 中配置 OpenCode 与 OhMyOpenCode</h3>
<p>虽然 OpenCode 开箱即用，但为了达到最佳生产力，我们需要在 VS Code 的 <code>settings.json</code> 中进行一些关键配置，包括模型选择、密钥注入以及 OhMyOpenCode 的特定开关。</p>
<p>推荐的“最小可用配置”示例：</p>
<pre><code class="hljs language-jsonc" lang="jsonc">{
  // 核心模型配置：支持 GLM‑4.7, MiniMax, Claude 等
  "opencode.provider": "bigmodel-glm",
  "opencode.apiKey": "${env:GLM_API_KEY}", // 推荐使用环境变量引用，更安全

  // 代理与网络设置（关键）
  "opencode.proxy": "http://127.0.0.1:7890",

  // 并发控制：决定 Agent 可以同时执行多少个文件操作
  "opencode.concurrency": 4,

  // OhMyOpenCode 插件特定配置
  "opencode.ohMyOpenCode.enabled": true,
  "opencode.ohMyOpenCode.agentMode": "collaborative", // 开启多智能体协作
  "opencode.ohMyOpenCode.autoCommit": false // 建议设为 false，人工确认提交
}
</code></pre>
<p>配置要点：</p>
<ol>
<li>Provider：根据预算与偏好选择。GLM‑4.7 在中文理解和性价比上表现优异。</li>
<li>Security：尽量避免将 API Key 明文写入配置文件，使用系统环境变量更安全。</li>
<li>OhMyOpenCode：通过 <code>agentMode</code> 控制是否启用复杂协作模式。简单任务可临时切换为 standard 模式以节省 Token。</li>
</ol>
<h3 data-id="heading-8">终端/TUI 工作流：在任何支持终端的 IDE 里用 OpenCode</h3>
<p>OpenCode 的精髓在于 TUI（Terminal User Interface）。无论你使用的是 VS Code、Trae 还是 IntelliJ IDEA，只要打开内置终端，就能获得一致的 AI 编程体验。</p>
<p>典型工作流循环：</p>
<ol>
<li>启动会话：在终端输入 <code>opencode</code> 进入交互模式。</li>
<li>加载上下文：使用 <code>/add src/utils/*.ts</code> 将相关代码文件加入 AI 的上下文窗口。</li>
<li>下达指令：输入自然语言，例如“分析这些工具函数，为它们编写单元测试，保存在 tests/ 目录下”。</li>
<li>审查与应用：OpenCode 会生成 Diff 预览。按 <code>y</code> 确认应用，按 <code>n</code> 拒绝，或输入反馈继续修改。</li>
<li>任务队列：在 OhMyOpenCode 模式下，复杂任务会被拆解为子任务队列，Agent 可并行处理多个文件。</li>
</ol>
<p>在 Trae 这类 AI 原生 IDE 中，终端体验尤为流畅。你可以将终端面板最大化，专注于与 AI 的对话，而生成的代码会实时同步到上方的编辑器视图中。</p>
<h3 data-id="heading-9">OhMyOpenCode 的增强与取舍</h3>
<p>安装了 OhMyOpenCode 之后，OpenCode 就从一个“听话的实习生”变成了“主动的高级工程师团队”。但这种能力的提升也伴随着成本的权衡。</p>
<p>优势（Pros）：</p>
<ul>
<li>Multi‑Agent 协作：自动拆解任务，由不同的子 Agent 负责规划、编码、测试。</li>
<li>Claude Code 兼容层：让 OpenCode 能够理解复杂的 Claude 风格 prompt，并在逻辑推理上更接近闭源竞品。</li>
<li>工具链集成：内置常用 LSP、AST 工具，代码理解更精准。</li>
</ul>
<p>权衡（Cons）：</p>
<ul>
<li>Token 消耗激增：多 Agent 意味着多轮内部对话，消耗量可能是标准模式的 3‑5 倍。</li>
<li>速度延迟：复杂的规划阶段需要时间，不适合“改一个标点”这种微小任务。</li>
<li>稳定性依赖：强依赖底层大模型的稳定性，一旦 API 波动，任务链可能中断。</li>
</ul>
<h3 data-id="heading-10">常见问题与排错</h3>
<ul>
<li>API Key 未生效/报错 401：检查环境变量 <code>GLM_API_KEY</code> 是否已在 Shell（如 .zshrc）中导出。VS Code 有时无法读取最新的 Shell 变量，尝试在 <code>settings.json</code> 中直接填入（仅测试用）或重启 VS Code。</li>
<li>扩展冲突：OpenCode 可能与 GitHub Copilot 或 Cursor 抢占快捷键。建议为 OpenCode 设置独立快捷键映射，避免冲突。</li>
<li>终端网络超时：公司内网场景需独立代理配置。确保在配置文件中正确设置 <code>http_proxy</code> 或 <code>opencode.proxy</code> 字段。</li>
<li>Trae 特定建议：如果 OpenCode 无法写入文件，检查 Trae 的 “Workspace Trust” 设置，确保当前工作区是受信任的。</li>
</ul>
<h3 data-id="heading-11">opencode.json：自定义供应商 baseURL 与代理配置</h3>
<pre><code class="hljs language-text" lang="text">可以配置使用 https://ai.t8star.cn/register?aff=U7mw51175  中转站，
各种模型都有，在下方的baseURL改成https://ai.t8star.cn/v1 就可以。
</code></pre>
<p>除了在 IDE 插件中配置，OpenCode 还支持通过 <code>opencode.json</code> 文件进行更底层的参数调优。这对于需要将官方 API 地址（如 Anthropic、OpenAI）切换为企业内部代理、本地转发服务或第三方中转站的开发者尤为重要。</p>
<p>典型配置示例（将 <code>anthropic</code> 的 <code>options.baseURL</code> 指向本地或第三方代理）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"providers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"anthropic"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"baseURL"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://127.0.0.1:8045/v1"</span>
        <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"models"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"claude-sonnet-4-5-thinking"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Claude Sonnet 4.5 Thinking (CC)"</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"attachment"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"limit"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"context"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1048576</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">65535</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"modalities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"input"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-string">"image"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-string">"pdf"</span>
              <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"output"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                <span class="hljs-string">"text"</span>
              <span class="hljs-punctuation">]</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>配置生效与验证完整步骤：</p>
<ol>
<li>新开一个终端窗口，执行认证命令：<code>opencode auth login</code>。</li>
<li>在交互界面中选择供应商 <code>anthropic</code>。</li>
<li>选择“输入 apikey”，将第三方中转站的 key 粘贴进去。</li>
<li>登录成功后，在 OpenCode 界面输入 <code>/models</code> 指令。如果配置正确，你应该能看到该供应商旗下的模型列表已正常加载。</li>
</ol>
<p>安全与合规提示：</p>
<ul>
<li>秘钥安全：尽量避免在 <code>opencode.json</code> 中明文硬编码 apikey，优先使用环境变量。</li>
<li>合规性：确保使用的第三方中转站或代理服务符合所在公司的安全合规要求。</li>
</ul>
<h3 data-id="heading-12">生态全景：工具角色定位</h3>
<p>最后，理清三者关系：OpenCode 是核心 AI 引擎，OhMyOpenCode 是它的“大脑增强包”，而 VS Code 与 Trae 则是它们施展拳脚的舞台。</p>
<hr/>
<h4 data-id="heading-13">参考与进一步阅读</h4>
<ul>
<li>OpenCode（中文资料聚合）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai-bot.cn%2Fopencode%2F" target="_blank" title="https://ai-bot.cn/opencode/" ref="nofollow noopener noreferrer">ai-bot.cn/opencode/</a></li>
<li>OpenCode 官方 IDE 整合文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopencode.ai%2Fdocs%2Fide%2F" target="_blank" title="https://opencode.ai/docs/ide/" ref="nofollow noopener noreferrer">opencode.ai/docs/ide/</a></li>
<li>OpenCode VS Code 扩展（官方）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3Dsst-dev.opencode" target="_blank" title="https://marketplace.visualstudio.com/items?itemName=sst-dev.opencode" ref="nofollow noopener noreferrer">marketplace.visualstudio.com/items?itemN…</a></li>
<li>OpenCode 插件机制文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopencode.ai%2Fdocs%2Fplugins%2F" target="_blank" title="https://opencode.ai/docs/plugins/" ref="nofollow noopener noreferrer">opencode.ai/docs/plugin…</a></li>
<li>OhMyOpenCode（社区介绍与讨论）：<a href="https://link.juejin.cn?target=https%3A%2F%2Faicoding.csdn.net%2F695e7679ea53844658f53369.html" target="_blank" title="https://aicoding.csdn.net/695e7679ea53844658f53369.html" ref="nofollow noopener noreferrer">aicoding.csdn.net/695e7679ea5…</a></li>
<li>Trae IDE 官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftraeide.com%2F" target="_blank" title="https://traeide.com/" ref="nofollow noopener noreferrer">traeide.com/</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript Date 语法要过时了！以后用这个替代！]]></title>    <link>https://juejin.cn/post/7593139476832616491</link>    <guid>https://juejin.cn/post/7593139476832616491</guid>    <pubDate>2026-01-09T03:52:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593139476832616491" data-draft-id="7593139476832600107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" JavaScript Date 语法要过时了！以后用这个替代！"/> <meta itemprop="keywords" content="前端,JavaScript,Node.js"/> <meta itemprop="datePublished" content="2026-01-09T03:52:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             JavaScript Date 语法要过时了！以后用这个替代！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:52:13.000Z" title="Fri Jan 09 2026 03:52:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>作为一名前端开发工程师，你一定被 JavaScript 的日期处理折磨过。</p>
<p>这不是你的问题，是 JavaScript 自己的问题——它的 Date 功能真的很糟糕。</p>
<h2 data-id="heading-1">2. Date 的离谱行为</h2>
<p>让我给你举几个例子，你就明白有多离谱了：</p>
<p><strong>月份从 0 开始计数：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 你以为这是 2026 年 1 月 1 日？</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-number">2026</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>));
<span class="hljs-comment">// 结果：2026 年 2 月 1 日！</span>

<span class="hljs-comment">// 因为月份是从 0 开始数的：0=1月，1=2月...</span>
<span class="hljs-comment">// 但年份和日期又是正常计数的</span>
</code></pre>
<p><strong>日期格式混乱到让人抓狂：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用斜杠分隔，加不加前导零都没问题</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">"2026/01/02"</span>));
<span class="hljs-comment">// Fri Jan 02 2026 00:00:00 GMT+0800 (中国标准时间)</span>

<span class="hljs-comment">// 但如果用短横线分隔，同样的写法</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">"2026-01-02"</span>));
<span class="hljs-comment">// Fri Jan 02 2026 08:00:00 GMT+0800 (中国标准时间)</span>

<span class="hljs-comment">// 时间居然不一样了！</span>

<span class="hljs-comment">// 如果用东半球标准时间，更离谱！一个是 1 月 2 日，一个是 1 月 1 日</span>
</code></pre>
<p><strong>两位数年份的迷惑行为：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">"49"</span>)); <span class="hljs-comment">// 2049 年</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">"99"</span>)); <span class="hljs-comment">// 1999 年</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">"100"</span>)); <span class="hljs-comment">// 公元 100 年！</span>
</code></pre>
<p>规则莫名其妙：33-99 代表 1900 年代，但 32-49 又代表 2000 年代，100 以上就真的是公元那一年了。</p>
<p><strong>更致命的问题是 —— 日期居然可以被“改变”！</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> today = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(today.<span class="hljs-title function_">toDateString</span>()); <span class="hljs-comment">// Fri Jan 09 2026</span>

<span class="hljs-comment">// 我想算一下明天是几号</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">addDay</span> = (<span class="hljs-params">theDate</span>) =&gt; {
  theDate.<span class="hljs-title function_">setDate</span>(theDate.<span class="hljs-title function_">getDate</span>() + <span class="hljs-number">1</span>);
  <span class="hljs-keyword">return</span> theDate;
};

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`明天是 <span class="hljs-subst">${addDay(today).toLocaleDateString()}</span>。`</span>);
<span class="hljs-comment">// 明天是 2026/1/10。</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`今天是 <span class="hljs-subst">${today.toLocaleDateString()}</span>。`</span>);
<span class="hljs-comment">// 今天是 2026/1/10。</span>

<span class="hljs-comment">// 等等，今天怎么也变成明天了？！</span>
</code></pre>
<p>当然这是可以解释的：</p>
<p>因为 <code>today</code> 就像一个地址，指向内存里的某个位置。当你把 today 传给函数时，函数拿到的也是这个地址。所以当函数修改日期时，原来的 today 也被改了。</p>
<p><strong>但这种设计违反了一个基本常识：日期应该是固定的。</strong>“2026 年 1 月 10 日”就是“2026 年 1 月 10 日”，不应该因为你拿它做了个计算，它自己就变了。</p>
<p>所以 Date 真的很糟糕。实际上，它就是挂羊头卖狗肉，它叫做 Date，表示日期，实际上，它是时间。</p>
<p>在内部，Date 是以数值形式存储的，这就是我们熟悉的以 1000 毫秒为单位的时间戳。</p>
<p>时间当然包含日期，你可以从时间中推断出日期，但这多少有点恶心了。</p>
<p><strong>Java 早在 1997 年就弃用了其 Date 类，而 JavaScript 的 Date 类仅仅在几年后就问世了；与此同时，我们却一直被这个烂摊子困扰着。</strong></p>
<p>正如你目前所见，它在解析日期方面极其不稳定。它除了本地时间和格林威治标准时间 (GMT) 之外，对其他时区一无所知。而且，Date 类只支持公历。它完全不理解夏令时的概念。当然最糟糕的还是它的可变的，这直接让他偏离了时间的本质。</p>
<p>所有这些缺陷使得使用第三方库来解决这些问题变得异常普遍，其中一些库体积庞大，这种性能损耗已经对网络造成了切实可衡量的损害。</p>
<h2 data-id="heading-2">3. Temporal 才是未来</h2>
<p>幸运的是，Date 即将彻底退出历史舞台。</p>
<p>当然这样说，还是有点夸张了。</p>
<p>实际上是它会一直存在，但如果可以避免，你最好不要再用它了。</p>
<p>因为我们会有一个完全取代 Date 的对象 —— Temporal。</p>
<p>部分同学可能对 Temporal 这个单词不太熟悉，实际上，它的意思就是“时间”，你可以理解为它是一个更专业的词汇：</p>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c478354123a4214853e034b8c02423c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535532&amp;x-signature=7zkUgKz23CCjqWyyF%2Fi5aBlT07Q%3D" alt="" loading="lazy"/></p>
<p>与 Date 不同，Temporal 不是构造函数，它是一个命名空间对象——一个由静态属性和方法组成的普通对象，就像 Math 对象一样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Temporal</span>);
<span class="hljs-comment">/* Result (expanded):
Temporal { … }
  Duration: function Duration()
  Instant: function Instant()
  Now: Temporal.Now { … }
  PlainDate: function PlainDate()
  PlainDateTime: function PlainDateTime()
  PlainMonthDay: function PlainMonthDay()
  PlainTime: function PlainTime()
  PlainYearMonth: function PlainYearMonth()
  ZonedDateTime: function ZonedDateTime()
  Symbol(Symbol.toStringTag): "Temporal"
*/</span>
</code></pre>
<p>Temporal 包含的类和命名空间对象允许你计算两个时间点之间的持续时间、表示一个时间点（无论是否具有时区信息）、通过 Now 属性访问当前时间点等。</p>
<p>如果我们要获取当前时间：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Temporal</span>.<span class="hljs-property">Now</span>.<span class="hljs-title function_">plainDateISO</span>());
<span class="hljs-comment">/* Result (expanded):
Temporal.PlainDate 2025-12-31
  &lt;prototype&gt;: Object { … }
*/</span>
</code></pre>
<p>该方法返回的是当前时区的今天日期。</p>
<p>Temporal 还能支持时区：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> date = <span class="hljs-title class_">Temporal</span>.<span class="hljs-property">Now</span>.<span class="hljs-title function_">plainDateISO</span>();

<span class="hljs-comment">// 指定这个日期在伦敦时区</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(date.<span class="hljs-title function_">toZonedDateTime</span>(<span class="hljs-string">"Europe/London"</span>));
</code></pre>
<p>Temporal 还可以计算日期差：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> today = <span class="hljs-title class_">Temporal</span>.<span class="hljs-property">Now</span>.<span class="hljs-title function_">plainDateISO</span>();
<span class="hljs-keyword">const</span> jsShipped = <span class="hljs-title class_">Temporal</span>.<span class="hljs-property">PlainDate</span>.<span class="hljs-title function_">from</span>(<span class="hljs-string">"1995-12-04"</span>); <span class="hljs-comment">// JavaScript 发布日期</span>
<span class="hljs-keyword">const</span> difference = today.<span class="hljs-title function_">since</span>(jsShipped, { <span class="hljs-attr">largestUnit</span>: <span class="hljs-string">"year"</span> });

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`JavaScript 已经存在了 <span class="hljs-subst">${difference.years}</span> 年 <span class="hljs-subst">${difference.months}</span> 个月零 <span class="hljs-subst">${difference.days}</span> 天。`</span>);
</code></pre>
<p>各种时间操作也会更加直观：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> today = <span class="hljs-title class_">Temporal</span>.<span class="hljs-property">Now</span>.<span class="hljs-title function_">plainDateISO</span>();

<span class="hljs-comment">// 加一天</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(today.<span class="hljs-title function_">add</span>({ <span class="hljs-attr">days</span>: <span class="hljs-number">1</span> }));

<span class="hljs-comment">// 加一个月零一天，再减两年——可以链式操作</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(today.<span class="hljs-title function_">add</span>({ <span class="hljs-attr">months</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">days</span>: <span class="hljs-number">1</span> }).<span class="hljs-title function_">subtract</span>({ <span class="hljs-attr">years</span>: <span class="hljs-number">2</span> }));

<span class="hljs-comment">// 看，多清楚！</span>
</code></pre>
<p>当然，更重要的是，日期不会被意外修改</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> today = <span class="hljs-title class_">Temporal</span>.<span class="hljs-property">Now</span>.<span class="hljs-title function_">plainDateISO</span>();

<span class="hljs-comment">// 计算明天的日期</span>
<span class="hljs-keyword">const</span> tomorrow = today.<span class="hljs-title function_">add</span>({ <span class="hljs-attr">days</span>: <span class="hljs-number">1</span> });

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`今天是 <span class="hljs-subst">${today}</span>。`</span>); <span class="hljs-comment">// 2025-12-31</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`明天是 <span class="hljs-subst">${tomorrow}</span>。`</span>); <span class="hljs-comment">// 2026-01-01</span>

<span class="hljs-comment">// 今天还是今天，完美！</span>
</code></pre>
<p><code>add</code> 方法会返回一个新的日期对象，而不是修改原来的。就像你复印了一份日历，在复印件上写字，原件不会被弄脏。</p>
<h2 data-id="heading-3">4. 什么时候能用？</h2>
<p>好消息：最新版的 Chrome 和 Firefox 已经支持了！</p>
<p>坏消息：它还在“实验阶段”，这意味着具体用法可能还会微调，但大方向已定。</p>
<p>我们终于要和 Date 的噩梦说再见了。</p>
<p>我是冴羽，10 年笔耕不辍，专注前端领域，更新了 10+ 系列、300+ 篇原创技术文章，翻译过 Svelte、Solid.js、TypeScript 文档，著有小册《Next.js 开发指南》、《Svelte 开发指南》、《Astro 实战指南》。</p>
<p>欢迎围观我的“<a href="https://link.juejin.cn?target=https%3A%2F%2Fyayujs.com%2F" target="_blank" title="https://yayujs.com/" ref="nofollow noopener noreferrer">网页版朋友圈</a>”，关注我的公众号：<strong>冴羽（或搜索 yayujs）</strong> ，每天分享前端知识、AI 干货。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[有人质疑我ebpf水平]]></title>    <link>https://juejin.cn/post/7593015632078389275</link>    <guid>https://juejin.cn/post/7593015632078389275</guid>    <pubDate>2026-01-09T03:57:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593015632078389275" data-draft-id="7592944032773029939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="有人质疑我ebpf水平"/> <meta itemprop="keywords" content="Linux"/> <meta itemprop="datePublished" content="2026-01-09T03:57:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="硬核子牙"/> <meta itemprop="url" content="https://juejin.cn/user/676954895557288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            有人质疑我ebpf水平
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/676954895557288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    硬核子牙
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:57:52.000Z" title="Fri Jan 09 2026 03:57:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>哈喽，我是子牙老师，一个手写过操作系统、编程语言、Java虚拟机、docker、Ubuntu系统，玩透Windows内核、Linux内核…立志一统计算机底层培训的硬核男人</p>
<p>不是做了一个ebpf的小课《手写生产级ebpf内存检测工具》吗，这两天不是在招生吗，质疑的声音出来了：质疑我对ebpf的认知、质疑跟着我是否能学到ebpf的真本事…</p>
<p>我不太喜欢向别人证明什么，相信你的人无需证明，不相信你的人，你都能佩服ta挑刺的能力！（看雷总直播拆车，小米股价跌成啥样了）刚好这两天在研究ebpf的底层实现原理，分享一下</p>
<p>如果想监测一个程序是否有内存泄漏，要怎么使用ebpf解决呢？监测分配内存的函数如malloc、calloc、realloc、mmap，再监测内存释放函数如free、munmap，程序退出之前，查看还有没有内存未释放，未释放的，就是泄漏的内存</p>
<p>如何监测呢？如果是用户态，ebpf提供了两个技术：uprobe、uretprobe，uprobe用于监测函数进入，用于拿函数传参，uretprobe用于监测函数退出，用于拿函数返回值，差不多是这个感觉</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aac1eed0b5ad4eedbdffe9542ead9ea1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=dJYiHIaVwELwZJ%2Bho8X%2B6bfiZcI%3D" alt="" loading="lazy"/></p>
<p>代码长这样</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45e3694ed86a4b6c8515faa677bb0848~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=UQcVoO4X5M0%2FxxEfACU256pn1Oc%3D" alt="" loading="lazy"/></p>
<p><strong>第一个问题来了：执行malloc函数的时候，是怎么执行到uprobe的？同样的，malloc函数结束的时候，是怎么执行到uretprobe的？</strong></p>
<p>ebpf的代码是在Linux内核中的BPF虚拟机中运行的，<strong>第二个问题来了：uprobe malloc与uretprobe malloc是如何与Linux内核中的ebpf程序关联上的？</strong></p>
<p>这两个问题搞明白了，ebpf你就算真正玩明白了！</p>
<p>我画了一张非常形象的图，所有的答案都在其中，我来给大家解释解释</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb03579154a942428531cd9a07cc9cf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=0W3gBslLGc%2BlSZ9vZ08NRlj%2FnFE%3D" alt="" loading="lazy"/></p>
<p>以下，enjoy</p>
<h2 data-id="heading-0">第一个问题</h2>
<p>第一个问题，执行malloc函数，是如何执行到uprobe的？采用插桩的方式。核心代码长这样</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b9b515c7a4949e48d13ffd3b394a637~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=z8gAHS8GEJhkZvJlT%2FwbT2c7hWY%3D" alt="" loading="lazy"/></p>
<p>那什么是插桩呢？其实跟调试器下断点是一样的，把函数的第一个字节改成0xCC，对应的汇编指令是int3，对应的是3号软中断。对，你没有看错，插桩就是gdb调试器的断点</p>
<p><strong>你现在肯定有一个问题：int3既是gdb调试器的断点，又是ebpf的插桩，发生中断，Linux内核如何区分是gdb还是ebpf呢？好问题，等下讲。你可以先想一想：如果你来设计Linux内核，你会怎么处理？</strong></p>
<p>如何证明插桩的就是int3呢？看代码呗</p>
<p>在57536进程中的malloc上插桩</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/508610f54ef0461487da9396ea9c05f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=Y8olU90XpvQ2rd8Gu%2BYlxTMdD3U%3D" alt="" loading="lazy"/></p>
<p>通过gdb attach到这个进程，看malloc函数的机器码</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7546ad1691884f28b93cd0ba76fb3811~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=xnyHpx3j7QH74qsurW7yvP43elM%3D" alt="" loading="lazy"/></p>
<p>你会发现第一个字节没有被改成0xCC，但是你查看插桩，确实插桩成功了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3cb7efee33d4b8b9cc5f90a61a4f58f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=J6mNrCwN%2FUslXihPNOW06xECxyM%3D" alt="" loading="lazy"/></p>
<p>怎么回事？理论错了？我起始也是这样的反应。如果不会玩Linux内核，到此就束手无策了，可是我会玩Linux内核啊，经单步调试Linux内核，理论没错（等下单步调试Linux内核证明给你看）</p>
<p>那是怎么回事呢？问ChatGPT，原来是新内核对uprobes底层做了改进</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8488e9d301924bc3bfc9bbe16898b478~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=NT1mr7H5CIGbs598P9YPQFjXjmQ%3D" alt="" loading="lazy"/></p>
<p>真相大白！运行时Linux内核检测到malloc是监测点，临时插入断点，触发异常，用完就恢复，所以插桩是看不到的。按照ChatGPT的说法，老版本能看到，我抽空测试一下</p>
<p>这个触发异常，就是第二个问题的答案</p>
<h2 data-id="heading-1">第二个问题</h2>
<p>先上图，再聊，不然太抽象了</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb8c84d22b634fdc98509a549a73459d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=Im9gcgmCySIFoIMVOWEnZdEH3yc%3D" alt="" loading="lazy"/></p>
<p>一、运行时Linux内核检测到malloc是监测点，临时插入断点，就是把malloc函数的第一个机器码0xf3改成0xcc，0xcc对应的汇编指令是int3，CPU执行0xcc就会触发3号软中断</p>
<p>二、Linux内核处理软中断的例程是do_int3</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f323016f469a4a998052d15ffbdfb5dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=UVTj22%2FzlUIB1pWa6m8OjtleYPs%3D" alt="" loading="lazy"/></p>
<p>0xcc，既是gdb断点，又是ebpf插桩，Linux内核如何区分呢？</p>
<p>其实Linux内核也没做区分，Linux内核中有个die_notifier链，3号异常来了，先丢给优先级最高的notifier处理，ebpf插桩的优先级比gdb断点要高</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ef8686e8ecc4e13aab7b333a6ee6a62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=cmotoXtcJcKT1Kg4G3el8w5xf0M%3D" alt="" loading="lazy"/></p>
<p>比ebpf插桩优先级更高的是：kprobes、kgdb</p>
<p>如果触发3号异常的是ebpf插桩，就是进入arch_uprobe_exception_notify</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bc0eb2e088c49a8bf19d307355fa9f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=gUj4%2BIox2yVJawvFC5%2Fg%2FhPSa%2Fc%3D" alt="" loading="lazy"/></p>
<p>这里最重要的一部就是打上标记，最终执行uprobe代码是在返回用户态的路上做的</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/949f0a6d9c2d471ea19c4d938f814a76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=dS3in9R5cEePLWilCvjofzVGKDU%3D" alt="" loading="lazy"/></p>
<p>找到核心代码handler_chain，下断点，看代码是不是走到这</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb4783d678c24ed9a361533989c7c09e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56Gs5qC45a2Q54mZ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768535872&amp;x-signature=wtfCprIIk8SLIF%2FMiSh0IzlsHA8%3D" alt="" loading="lazy"/></p>
<p>追踪执行完uprobe程序，直接返回用户态，就是图中的3</p>
<p>至此，ebpf的底层实现原理，揭晓完工！撒花…</p>
<p>我为什么能随便玩这些，我觉得是我做了这三个课程的效用：手写64位多核操作系统+实战Linux内核+手写Ubuntu Linux系统。如果你也想像我一样，随便玩Linux内核，或者说任何技术，可以抽空把这三门课学会，加上AI的加持，计算机世界里，想干啥就可以干啥！</p>
<p>如果你想更多了解我，欢迎去我公众号【硬核子牙】看我之前的文章及我的奋斗历程。白手起家程序员的职场心得，应该会对你有很大启发</p>
<p>若有收获，就点个赞吧</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react使用Ant Design]]></title>    <link>https://juejin.cn/post/7593015632078405659</link>    <guid>https://juejin.cn/post/7593015632078405659</guid>    <pubDate>2026-01-09T03:58:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7593015632078405659" data-draft-id="7592996072705032242" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react使用Ant Design"/> <meta itemprop="keywords" content="前端,React.js,Ant Design"/> <meta itemprop="datePublished" content="2026-01-09T03:58:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="加油乐"/> <meta itemprop="url" content="https://juejin.cn/user/84036866547575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react使用Ant Design
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/84036866547575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    加油乐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:58:56.000Z" title="Fri Jan 09 2026 03:58:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">一、安装</h2>
<ul>
<li>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fdocs%2Freact%2Fintroduce-cn" target="_blank" title="https://ant.design/docs/react/introduce-cn" ref="nofollow noopener noreferrer">Ant Design</a></li>
<li>npm</li>
</ul>
<pre><code class="hljs language-css" lang="css">npm install antd <span class="hljs-attr">--save</span>
</code></pre>
<ul>
<li>yarn</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">yarn <span class="hljs-keyword">add</span> antd
</code></pre>
<ul>
<li>pnpm</li>
</ul>
<pre><code class="hljs language-css" lang="css">pnpm install antd <span class="hljs-attr">--save</span>
</code></pre>
<h2 data-id="heading-1">二、main引用</h2>
<ul>
<li>引入Ant Design的<code>reset.css</code>文件</li>
<li>引入<code>ConfigProvider</code>全局配置，且包含所有组件</li>
<li>设置<code>locale</code>属性为<code>中文</code></li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 导入严格模式组件，用于开发环境下检测潜在问题</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">StrictMode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-comment">// 导入客户端渲染方法，用于创建根节点并渲染应用</span>
<span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.jsx'</span>;
<span class="hljs-comment">// 导入Ant Design的样式文件</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'antd/dist/reset.css'</span>;
<span class="hljs-comment">// 导入全局自定义样式文件</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./index.css'</span>;
<span class="hljs-comment">// 导入Ant Design配置提供者组件</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-comment">// 导入Ant Design的中文语言包</span>
<span class="hljs-keyword">import</span> zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'antd/locale/zh_CN'</span>;

<span class="hljs-comment">// 获取 HTML 中 id 为 'root' 的 DOM 元素作为应用根节点</span>
<span class="hljs-keyword">const</span> rootElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>);

<span class="hljs-comment">// 如果找不到根节点，则抛出错误</span>
<span class="hljs-keyword">if</span> (!rootElement) {
	<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'找不到id为"root"的DOM元素，请检查index.html文件'</span>);
}

<span class="hljs-comment">// 创建 React 根节点</span>
<span class="hljs-keyword">const</span> root = <span class="hljs-title function_">createRoot</span>(rootElement);

<span class="hljs-comment">// 渲染整个 React 应用</span>
root.<span class="hljs-title function_">render</span>(
	<span class="hljs-comment">// 使用严格模式包装应用</span>
	<span class="hljs-comment">// 注意：严格模式只在开发环境生效，生产环境会自动禁用</span>
	<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StrictMode</span>&gt;</span>
		{/*
		 ConfigProvider 是 Ant Design 的全局配置组件
		 此处设置 locale 属性为中文语言包，实现组件国际化
		 可以在这里添加更多全局配置，如主题定制等
		 */}
		<span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span> <span class="hljs-attr">locale</span>=<span class="hljs-string">{zhCN}</span>&gt;</span>
			{/*
			 应用主组件
			 所有页面和路由都将在 App 组件内部定义和管理
			 */}
			<span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">StrictMode</span>&gt;</span></span>
);

</code></pre>
<h2 data-id="heading-2">三、组件引用</h2>
<ul>
<li>引用Button，查看使用效果</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
	<span class="hljs-keyword">return</span> (
		<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;</span>按钮<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
	);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[干掉 Claude Code，这个开源 AI 编程工具杀疯了？]]></title>    <link>https://juejin.cn/post/7592876744527249458</link>    <guid>https://juejin.cn/post/7592876744527249458</guid>    <pubDate>2026-01-09T03:30:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592876744527249458" data-draft-id="7592992745573187622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="干掉 Claude Code，这个开源 AI 编程工具杀疯了？"/> <meta itemprop="keywords" content="前端,后端,AI编程"/> <meta itemprop="datePublished" content="2026-01-09T03:30:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            干掉 Claude Code，这个开源 AI 编程工具杀疯了？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:30:27.000Z" title="Fri Jan 09 2026 03:30:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员鱼皮。</p>
<p>Claude Code 一直是大家公认的 AI 编程命令行工具 Top 1，在 AI 和程序员圈子里几乎是神一般的存在。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ba00eebf1954942b9637ed88faba740~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=zA%2FVo88hf%2FyZ1UOIGtmnJPKkth4%3D" alt="" loading="lazy"/></p>
<p>但是，这狗玩意儿对中国用户可不太友好……</p>
<p>首先，如果你想要使用 Claude Code，就必须要有特殊的网络 + 官方账号，否则就会看到一片红。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2b340cc20cb422582e29770942f8a13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=HaHPOCjUuUEKgyVv0wIBhIGAgWI%3D" alt="" loading="lazy"/></p>
<p>此外，2025 年 9 月，Anthropic 公司不知道抽什么风，突然宣布 <strong>全面禁止中国控股企业使用 Claude 服务</strong>，不仅包括中国大陆企业，连海外中资控股超过 50% 的公司都在封禁范围内！</p>
<p>甚至 Anthropic 还特别点名了中国，把咱们称为 <strong>敌对国家</strong>！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37dee3c168d9438491040315fefd3823~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=aEYY3Prn42bge421vzXCm7YlHaI%3D" alt="" loading="lazy"/></p>
<p>天下苦 Claude Code 久矣！</p>
<p>但是最近我身边很多程序员朋友开始从 Claude Code 转向了另一个工具，正是突然大火的开源项目 OpenCode。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f86e08f12a7442793216a254fe82f63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=yP3vGUbeHCbATjDYKCZKfiPb28o%3D" alt="" loading="lazy"/></p>
<p>这玩意只用了半年的时间，就在 GitHub 上涨到了 5.2w Star！</p>
<p>这是个什么概念？比我在 GitHub 上开源的几十个项目的总和加起来都多！慕了慕了……</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47a41d0b261b45888439769d71d4792e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=3g416nW0bghlbIkz0WwoubFlXgk%3D" alt="" loading="lazy"/></p>
<p>OpenCode 到底是什么？凭什么这么火？</p>
<h2 data-id="heading-0">啥是 OpenCode？</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopencode.ai%2F" target="_blank" title="https://opencode.ai/" ref="nofollow noopener noreferrer">OpenCode</a> 是一款 100% 开源的 AI 编程命令行工具，可以在 <strong>终端、IDE、甚至桌面应用</strong> 中使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c59cbc53d3de462f8a17815ce3fe9314~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=1OwqTKpSEtcLeVROfmDuI%2Fi9W%2BI%3D" alt="" loading="lazy"/></p>
<p>你可能会问：这玩意儿跟 Claude Code 有啥区别？</p>
<p>试试不就知道了？</p>
<p>接下来我带大家实操一下，从零开始安装、配置、到实际写代码，一条龙服务~</p>
<h2 data-id="heading-1">从 0 开始上手 OpenCode</h2>
<h3 data-id="heading-2">1、安装运行 OpenCode</h3>
<p>直接进入 OpenCode 官网，复制一行命令：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49a937d09fbe494f8e520c85fd02cdf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=pbMZFJRmeycyuH9ki1WNqpwXGOE%3D" alt="" loading="lazy"/></p>
<p>命令如下：</p>
<pre><code class="hljs language-arduino" lang="arduino">curl -fsSL https:<span class="hljs-comment">//opencode.ai/install | bash</span>
</code></pre>
<p>然后在终端中执行，就可以完成安装了。</p>
<p>安装完成之后，输入 <code>opencode</code> 进入程序，接下来你就可以愉快地使用了~</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12123a0bdd734e13b0cd500f20e7796f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=xohzlDJWpbGxvRUqkf23xiCy7Oc%3D" alt="" loading="lazy"/></p>
<p>先来个经典的 Hello World，AI 成功给出了回复。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3901f8166e8a48e4ac0f662f65e299e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=3pAFVdk5puKZKjSLRwxEATWIHzs%3D" alt="" loading="lazy"/></p>
<p>恭喜，到这里你已经掌握了 OpenCode 的 70% 了。</p>
<h3 data-id="heading-3">2、选择模式和模型</h3>
<p>OpenCode 支持 2 种模式，默认是 Build 模式，用来构建应用、生成代码。</p>
<p>按一下 Tab 键，就可以切换到 Plan 模式，用于生成执行计划。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4a2cd7a5ef3439ba2e6bc423c7fbd17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=VcK77eTkZqGxR37k39vQ75366qo%3D" alt="" loading="lazy"/></p>
<p>按一下 <code>Ctrl + p</code> 键，可以打开命令面板，里面有几十个内置命令。我们先来试着切换一下大模型：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d47428396ca4b97af1146b5f4dd0cc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=YKHIr%2FpAdIdlvZbaGz%2BnQmiHhqU%3D" alt="" loading="lazy"/></p>
<p>默认提供了 4 个免费模型：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee1068d6c3ba464685733273e2d2ca2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=vxuYQgvvTPNHo0gRrPuUYElr9h8%3D" alt="" loading="lazy"/></p>
<p>好家伙，连智谱最新的 GLM-4.7 竟然也免费？那我的 Coding Plan 套餐不是白开了？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/252f1faeef6042399697fd6a3fe4148e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=w63y%2BUH8GOhyUrIEKAhtURfAL2Q%3D" alt="" loading="lazy"/></p>
<p>除了免费的模型外，OpenCode 支持超多的 AI 模型，你可以自由选择：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bcd05d258be4d0a9f60a1e9ee7c4deb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=esbiS6%2FQoPFK3Ep0IVpkxJV3xbk%3D" alt="" loading="lazy"/></p>
<p>选中模型后，配置自己的 API Key 就好了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7611faf978a4e7a9ade8751184c569b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=G04W1U3Z3S%2Bk69wwdAYVeu6dQhs%3D" alt="" loading="lazy"/></p>
<p>如果你之前有 <strong>Claude Pro/Max 订阅账号</strong>，可以直接登录使用，无缝从 Claude Code 迁移过来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c1276b411d347678e766da0904de1bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=JHZ0NHXe6smU1urdAa2QCu0ISMQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">3、快捷指令</h3>
<p>OpenCode 支持斜杠命令，输入 <code>/</code>，能看到很多操作，比如查看模型列表、查看 Agents、管理 MCP、切换主题等等：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae940f2d683347a9a08bce17996947b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=d5%2Fa%2FY1w42akHMx5fK08oogqc7c%3D" alt="" loading="lazy"/></p>
<p>支持几十个不同的主题，颜值都挺高的，从这点也能看出来 OpenCode 很注重用户的体验：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/867d4f24163840a79c1d166c495d3c22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=C56HkGzibIQ0g3kNfIpPhdg41ss%3D" alt="" loading="lazy"/></p>
<p>输入 <code>@</code> 可以快速关联目录文件，给 AI 添加上下文：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fc4f1c4ffb344eaa17acec9c497850a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=edCPxps23pYElWW0UxHqQV6D9p8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">4、交互体验</h3>
<p>相比于 Claude Code，OpenCode 真是把命令行的交互体验拉满了，甚至我觉得它是一个伪装成命令行的桌面应用。</p>
<p>你可以点击某条消息，然后会弹出一个消息动作框，你可以撤回消息和 AI 的回复，也可以复制、或者基于当前对话新开一个对话框。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4271881339e74ac881c7ce1f81c55e61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=QrhtU%2FSSAMJH8o8Ev%2B3B%2BmyefCw%3D" alt="" loading="lazy"/></p>
<p>你可以通过鼠标上下滚动来切换选单，并且可以直接通过鼠标点击进入下一步。</p>
<p>你可以按 <code>Ctrl + p</code> 键打开命令面板，然后开启侧边栏：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff9bc6aab5f64da3849ca3fd0a0c51e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=3m9Fol1kC1xu8rlLtlZerIvFFuU%3D" alt="" loading="lazy"/></p>
<p>然后界面就变成了这样，你管这叫命令行？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a05218edec47480395128e249a32d3a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=m7OywrzcgPvL2a4pGBwEVjjCgTI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">5、LSP 支持</h3>
<p>细心的你一定看到了，右边的侧边栏有个 <code>LSP</code>，这是什么鬼东西？老色批？</p>
<p>LSP（Language Server Protocol 语言服务器协议）是微软开发的一种通信协议，用于让代码编辑器和语言服务器之间进行通信。</p>
<p>简单来说，<strong>LSP 就是让编辑器看懂代码的技术。</strong></p>
<p>比如你在 VS Code 里写代码，输入 <code>console.</code> 它会自动提示 <code>log</code>、点击函数名能跳转到代码定义、写错代码会画红线提醒。这些代码编辑器的功能，背后都是 LSP 在干活。</p>
<p>OpenCode 支持 LSP，意味着 AI 能真正理解你的代码结构，而不是把代码当普通文字瞎猜，改起来更精准。</p>
<p>比如我让 AI 介绍我的 AI 答题平台项目中最有价值的代码，LSP 就派上用场了。它能帮 AI 快速定位某段代码在哪里被调用、引用了哪些变量，而不是让 AI 傻傻地全局搜索文本。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf7ecb4153f342318463809a5197017d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=WkF%2FfnBOV9Hw88LZVyHjWX3yQ7A%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">6、回到之前的会话</h3>
<p>如果你不小心关闭了 OpenCode，不用担心，可以打开命令面板，选中 “Switch session” 切换会话：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bd649bb4c7f4b0fb2560ff35741fdfb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=aUgK4CZHieBA%2B%2BHK%2BYUGuxzwm0I%3D" alt="" loading="lazy"/></p>
<p>就能回到之前的聊天了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/110c3446d62a44f180875f33218a8cda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=JylSUq3M4klM1yUXCL18DcUGHGw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">桌面版 OpenCode</h2>
<p>即使 OpenCode 支持了这么多改进用户体验的交互，但我估计大多数同学还是不喜欢小黑框的。</p>
<p>没关系，OpenCode 还提供了桌面应用版本！macOS、Windows、Linux 全端支持，这是真的要卷死 Claude Code 的节奏啊……</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fopencode.ai%2Fdownload" target="_blank" title="https://opencode.ai/download" ref="nofollow noopener noreferrer">opencode.ai/download</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb874b0d624c460581dd148684d7f879~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=ShlFZyzGYfmLCdvv0jkelv1%2FJDI%3D" alt="" loading="lazy"/></p>
<p>不过当我怀着满腔热血安装并打开它时，竟然报错了！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d602bc6c33fb4ed095266f34a3a18c66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=vQ28uo4PtwAg80lWuNz45bj%2Buq8%3D" alt="" loading="lazy"/></p>
<p>经过一番排查，发现原来是我开了代理，关闭之后就正常运行了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69c0538e282d4bbf8fced8cbad7c5d05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=wkLXYNTQBiqDULd7KaN%2F1zMWWFA%3D" alt="" loading="lazy"/></p>
<p>但是用惯了 Cursor，这个交互体验真的有点敷衍了，不推荐大家使用。</p>
<h2 data-id="heading-9">OpenCode 扩展能力</h2>
<p>到目前为止，我觉得 OpenCode 在前端用户体验上全方面碾压 Claude Code，而且 OpenCode 完全兼容 Claude Code 的 Skills 系统！</p>
<p>Skills 是一种给 AI 准备的能力扩展包。你可以把它理解成给新同事准备的工作交接文档，里面包含任务执行方法、工具使用说明、模板素材等。</p>
<p>比如你可以创建一个 <code>公司代码规范 Skill</code>，把代码风格、命名规则、注释要求等写进去。之后 Claude Code 生成的代码就会自动遵循这些规范，不用每次都重复说明。</p>
<p>根据官方文档，OpenCode 会自动搜索这些位置的 Skills：</p>
<ul>
<li><code>.opencode/skill/&lt;name&gt;/SKILL.md</code>（项目目录）</li>
<li><code>~/.config/opencode/skill/&lt;name&gt;/SKILL.md</code>（用户目录）</li>
<li><code>.claude/skills/&lt;name&gt;/SKILL.md</code>（Claude Code 兼容）</li>
<li><code>~/.claude/skills/&lt;name&gt;/SKILL.md</code>（Claude Code 兼容）</li>
</ul>
<p>也就是说，如果你之前给 Claude Code 创建过自定义 Skills，直接拿过来就能用！又是无缝迁移。</p>
<h2 data-id="heading-10">Oh My OpenCode 开挂插件</h2>
<p>如果你觉得 OpenCode 还不够强，可以试试 <code>Oh My OpenCode</code> 这个开源的 OpenCode 增强插件，已经 1w Star 了。</p>
<blockquote>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcode-yeongyu%2Foh-my-opencode" target="_blank" title="https://github.com/code-yeongyu/oh-my-opencode" ref="nofollow noopener noreferrer">github.com/code-yeongy…</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae06949c4ff749b1a7ade445ad6b6442~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=0WU0Fg2iZAGGnmvUN8arjC12xKA%3D" alt="" loading="lazy"/></p>
<p>这个插件有多牛？看看用户评价：</p>
<blockquote>
<p>"It made me cancel my Cursor subscription."（它让我取消了 Cursor 订阅）</p>
<p>"Knocked out 8000 eslint warnings with Oh My Opencode, just in a day"（一天内用它解决了 8000 个 eslint 警告）</p>
</blockquote>
<p>Oh My OpenCode 的核心功能是引入了一个叫 <strong>Sisyphus</strong> 的智能体编排系统。</p>
<p>我特地去搜了一下：</p>
<blockquote>
<p>西西弗斯（Sisyphus）是古希腊神话中一位因欺骗众神、挑战权威而被诸神惩罚的国王，他的惩罚是永无止境地将一块巨石推上山顶，而石头一到山顶便会滚落，如此周而复始，象征着徒劳无功、永无休止的任务，也代表着一种对荒诞命运的抗争精神。</p>
</blockquote>
<p>这个系统可以：</p>
<ol start="0">
<li>并行调度多个 AI 模型：比如让 GPT debug 的同时让 Gemini 写前端</li>
<li>自动任务管理：不完成任务不让停，像西西弗斯推石头一样锲而不舍</li>
<li>智能代码审查：自动检测并清理 AI 生成的冗余注释</li>
<li>LSP 深度集成：提供重命名、跳转定义等 IDE 级功能</li>
</ol>
<p>简单来说，Sisyphus 就是一个 AI 监工，它能同时指挥多个 AI 模型干活，还会盯着它们把任务做完。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6d40801252a4dc7a8d84ace4f0ed64b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=Wu3SU9sApN4vgvINFQHCh6EQfsY%3D" alt="" loading="lazy"/></p>
<p>虽然官方说用一行命令就能完成安装，但我建议你先安装 bun，再执行 npx 来安装，否则可能会报错。</p>
<pre><code class="hljs language-perl" lang="perl">npm install bun -g
npx oh-<span class="hljs-keyword">my</span>-opencode install
</code></pre>
<p>安装过程中，可能会问你有没有某些模型的订阅，我反正啥都没有，一直选 "No" 就行了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4e02e7a640e4d518270fb4a3bbf579e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=vAw0DxAZapAJHVnx%2BlJgGzOEawQ%3D" alt="" loading="lazy"/></p>
<p>安装完成后，再次进入 OpenCode，之后只需要在你的提示词里加上 <code>ultrawork</code>（或 <code>ulw</code>）这个开挂咒语，就能激活全部增强功能。自动调度多个 AI 模型同时工作、深度探索代码库、锲而不舍地执行。</p>
<p>下面我们试试看，正好来验证一下 OpenCode 做项目的能力如何？能不能把 Claude Code 一脚踹飞？</p>
<h2 data-id="heading-11">实战项目 - 用 OpenCode 做个 AI 健康助手</h2>
<p>最近蚂蚁集团的 <code>蚂蚁阿福</code> AI 健康助手火了，地铁口、公司楼下的电视广告中随处可见何炅老师的身影。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a166c234a3244606ae1576460636bc0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=6WwtZA3cGKahe0e7oFxGBnPt%2FA8%3D" alt="" loading="lazy"/></p>
<p>虽然我还没有用过它，但是听说它可以通过拍皮肤、拍报告提供 AI 初诊，还能智能回答医学科普和治疗建议。</p>
<p>那我们也来做个类似的健康小助手网站吧！</p>
<p>前有蚂蚁阿福，今有鱼皮阿坤。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75da6f5998e142f8abe3a1e3972e0262~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=wS0ppDpqCjsWFLNqHncJVqf7FeE%3D" alt="" loading="lazy"/></p>
<p>先分析一下，我们要做的是包含前端 + 后端的全栈项目，而且后端还需要调用 AI 大模型来生成内容。</p>
<p>这里我选择用 <strong>Vercel AI Gateway</strong> 来实现 AI 能力，这是一款简单易用的 AI 网关。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/359fb06928d04340b63f4fd1a7fb37cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=bdGvFNRUnHg%2Bt8lYCEHeYw5SxZI%3D" alt="" loading="lazy"/></p>
<p>什么是 AI 网关？</p>
<p>简单来说，它就像是火车站的检票口，你的应用发来的请求先经过网关，网关帮你处理认证、限流、监控等一系列复杂的操作，然后把请求转发给 AI 大模型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7de5d2838f1547fcaf5fd2e543b229c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=%2BWEJLMqz%2BpBXx1SsvQbenWq2Gxc%3D" alt="" loading="lazy"/></p>
<p>而且 Vercel AI Gateway 支持对接 500 多个大模型，还有免费额度，非常适合学习和小项目。</p>
<blockquote>
<p>指路：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvercel.com%2Fai-gateway" target="_blank" title="https://vercel.com/ai-gateway" ref="nofollow noopener noreferrer">vercel.com/ai-gateway</a></p>
</blockquote>
<p>1）首先你需要注册登录 Vercel，然后在控制台创建 API Key，注意不要泄露哦：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c640a7b070544af7bd0a16f233d7a081~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=pxjvNU%2FrYiUiXa3Lki12VSMS3Lw%3D" alt="" loading="lazy"/></p>
<p>2）启动 OpenCode，切换模型到编程能力很强、并且免费的 GLM-4.7，然后输入这段提示词：</p>
<pre><code class="hljs language-markdown" lang="markdown">你是一位专业的程序员，请帮我开发《每日健康小助手》网站，用户可以通过和 AI 聊天来记录和管理每日健康状态。
​
<span class="hljs-section">## 开发要求</span>
​
<span class="hljs-bullet">1.</span> 需要包含完整的前端和后端，后端使用 Node.js
<span class="hljs-bullet">2.</span> 使用 Vercel 的 AI Gateway 实现 AI 能力，需要先通过官方文档来获取用法：https://vercel.com/docs/ai-gateway/getting-started
<span class="hljs-bullet">3.</span> 以完成核心功能为目标，确保项目可以正常运行
<span class="hljs-bullet">4.</span> 整体网站界面采用清新的绿色健康风格，响应式适配各种尺寸的设备
<span class="hljs-bullet">5.</span> AI 需要主动询问用户的健康状况，比如睡眠、运动、饮食等
</code></pre>
<p>点击发送后，OpenCode 会自动使用网页抓取工具读取 Vercel AI Gateway 的官方文档，学习最新的用法：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b46a92537c0c4ed59a88adfbfe9681e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=crbxQ1E9b5mjPufgFko5zP8bClk%3D" alt="" loading="lazy"/></p>
<p>大概 5 分钟左右，AI 就完成了全部代码的生成，并且自动安装了依赖。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5edcb0dff2424d0b9e6868d5e5b08c11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=V9CdNVAop8HXpDX32Ux2AiIRrQI%3D" alt="" loading="lazy"/></p>
<p>3）我直接把之前拿到的 Vercel 的 API Key 提供给 AI，让它帮我启动项目：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/384fdaf7b60e435c806b1fb7bf8431a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=TmSv%2F%2BybvAQp3SbCKGkst9U%2F6bs%3D" alt="" loading="lazy"/></p>
<p>4）启动项目成功后，打开浏览器访问 <code>localhost:3000</code>，测试一下效果。</p>
<p>结果报错了！无法调用 AI。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe85fb0935944a2592d46b7ff64296a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=56KxGAMwooa1RruVF8g1OQVnvtU%3D" alt="" loading="lazy"/></p>
<p>可能是 AI 对 Vercel AI Gateway 文档的理解不到位，导致写错了调用 AI 的代码。于是我再次把文档输入给 AI，让它再战一次：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d88e2158ccbd44cbbd6ff0ae06ce01be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=VGSquSt0M2%2BEomYbHQXQlFVM0Ek%3D" alt="" loading="lazy"/></p>
<p>结果又报错了，明明我已经给 AI 提供了 API Key，系统还是报错 “缺少 API Key”。</p>
<p>于是我又调了一次 AI，告诉它 “这个 key 我之前已经提供给你了”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d8b7fdfb556479090f360bda943f28d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=GmDrDEmhT8kGakNFXPRn2PHtKUU%3D" alt="" loading="lazy"/></p>
<p>经过大概 5 次左右的报错和修复，仍然不能正常使用！我麻了啊……</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62ee1f6c44654d5a9f2225faafdd00f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=bWcCO%2BPEOC3keELQWId3lPcMVNo%3D" alt="" loading="lazy"/></p>
<p>于是，我有一个鬼点子：既然要跟 Claude Code 比较，那我不妨尝试用 Claude Code 修复这个 OpenCode 解决不了的问题？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0eb1bc559ea949f3a553bddf16400ffb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=zaBumyjVZjpdylsGyPMcOSlO5tE%3D" alt="" loading="lazy"/></p>
<p>试试看！输入提示词：</p>
<pre><code class="hljs language-ruby" lang="ruby">现在项目后端 <span class="hljs-variable constant_">AI</span> 功能不可用
请参考 <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/vercel.com/docs</span><span class="hljs-regexp">/ai-gateway/getting</span>-started 文档
帮我修复后端，确保项目能正常运行
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5aee3ea1b8e4440a9cb7529945493216~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=ZEGs2hdwVDk3Nc2cU4oWEqN00Ds%3D" alt="" loading="lazy"/></p>
<p>Claude Code 成功修复了问题，终于能够正常使用了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3ac402eb9cf4153a895defabc6936cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=2TsID2Tmz1KS53W0xBwHUkuVo5g%3D" alt="" loading="lazy"/></p>
<p>💡 注意，如果你遇到了调用 AI 网络超时的问题，可以让 AI 把调用的 baseURL 改为 <a href="https://link.juejin.cn?target=https%3A%2F%2Fai-gateway.vercel.sh%2Fv1" target="_blank" title="https://ai-gateway.vercel.sh/v1" ref="nofollow noopener noreferrer">ai-gateway.vercel.sh/v1</a></p>
<p>之前类似的任务我用 Claude Code / Cursor + GLM，不到 10 分钟就搞定了。这次竟然花了 20 分钟左右，还要经过来回拉扯，才能正常使用。</p>
<p>这让我不得不怀疑 OpenCode 的能力了。而且感觉 GLM 大模型在 OpenCode 中好像变笨了，不知道是不是我的错觉……</p>
<p>不行，大家把 OpenCode 吹得这么牛批，我得再试试，一定是我用法的问题！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41036012512443e78e38446c17632103~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=QwjsoeSLl%2BDzELZby6EMi%2FIjbEU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">Ultrawork 模式</h3>
<p>还记得前面提到的 <code>ultrawork</code>（或 <code>ulw</code>）开挂咒语么？搞起！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a51ea8ccaea4dc4ae968f66b98e61da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=KuGk4BOn269NpN%2FM0rw%2BVVecCMk%3D" alt="" loading="lazy"/></p>
<p>进入战斗状态了：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f11ab9d865d144e7b201e15da2deed02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=FMLR32BQdlbuyPb8uvRNY8kzYao%3D" alt="" loading="lazy"/></p>
<p>可以查看子代理运行详情，先按 <code>Ctrl + x</code> 键，再按方向键来查看不同的代理。</p>
<p>而且当后台任务完成时，会有一个提示。可以看到 “研究 Vercel AI SDK 对话模式” 的任务已经完成。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4ae235528f6644e3b6032b5adb3b9752~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=VxqRIyaDf55RDaYZXNzdnqy0CA8%3D" alt="" loading="lazy"/></p>
<p>不过你猜怎么着？我等了将近 10 分钟，任务还没结束……</p>
<p>看看这个任务列表，需要这么复杂吗？连数据库都给我干出来了？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c697047a5e1b42b4a0f1a83f45859926~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=I1pk%2F9KyQ%2BQRXMkwstpWPKCP2%2FY%3D" alt="=" loading="lazy"/></p>
<p>我已经没耐心等下去了，毁灭吧！</p>
<p>看来这种不算太复杂的工作并不能发挥出多代理的优势。就像你只是要打印一张纸，没必要发动全公司的人，有的研究打印的纸张类型、有的研究打印机的状态、有的研究怎么打印姿势更优雅。</p>
<h2 data-id="heading-13">最后</h2>
<p>经过上述简单的测试，我暂时对 OpenCode 保持观望状态。</p>
<p>前端做的确实很不错，但后端的能力感觉跟 Claude Code 还有差距。</p>
<p>如果只是追求前端使用方便，那我为什么不用 Cursor？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b28847ff74340df96731a9a00328a45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768534227&amp;x-signature=V3oCuUZpSBSVXJBQTIj5E34XY94%3D" alt="" loading="lazy"/></p>
<p>不过 OpenCode 的成功说明了一个道理：<strong>谁离用户近、谁能发现痛点，谁就有超越巨头的机会。</strong></p>
<p>Claude Code 确实很强，但它对中国用户的封禁，给了开源社区一个绝佳的机会。OpenCode 抓住了这个痛点，用更开放的方式赢得了用户的心。</p>
<p>虽然效果有待提高，但毕竟 OpenCode 完全开源免费，对于喜欢折腾的程序员来说，可定制性更强。你甚至可以 fork 一份自己魔改，想怎么玩就怎么玩。</p>
<p>OK，就聊到这里。你用过 OpenCode 吗？欢迎评论区聊聊你的体验~</p>
<h2 data-id="heading-14">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 使用经验分享：从混沌到秩序的提示词工程]]></title>    <link>https://juejin.cn/post/7592884480732069934</link>    <guid>https://juejin.cn/post/7592884480732069934</guid>    <pubDate>2026-01-09T02:44:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592884480732069934" data-draft-id="7592803747472146482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 使用经验分享：从混沌到秩序的提示词工程"/> <meta itemprop="keywords" content="AIGC,AI编程"/> <meta itemprop="datePublished" content="2026-01-09T02:44:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="KaneLogger"/> <meta itemprop="url" content="https://juejin.cn/user/3650034333917031"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 使用经验分享：从混沌到秩序的提示词工程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3650034333917031/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    KaneLogger
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T02:44:51.000Z" title="Fri Jan 09 2026 02:44:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3de00d1e79e846a6ae4cca70bea97abe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531490&amp;x-signature=k%2F%2BBz%2BUZ6jRcBV%2FVdDdvxcKZuoc%3D" alt="Taming_AI_Through_Structure-图片-0.jpg" loading="lazy"/>
现在的 AI 是高能力但高熵的黑箱系统。你给它模糊的输入(高熵),它就返回混沌的输出(低价值)。这不是 AI 的问题,是热力学第二定律在信息系统中的体现。解决方案只有一个:降低输入熵。</p>
<p>用结构化的提示词把系统从"布朗运动"踢进"激发态"。
换句话说就是把你的需求写得像程序接口、像合同条款、像 SOP 操作手册。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44ee4f4637ec4a2a8433d0a43e2e4e09~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531490&amp;x-signature=vOu6G8Is9gSIGm1dFxao%2Bua6uoE%3D" alt="Taming_AI_Through_Structure-图片-1.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">任务诊断决策树</h2>
<p>第一步:判断任务级别</p>
<pre><code class="hljs language-text" lang="text">你愿意为这个任务花多少时间？
├─ &lt; 5分钟 → 用"最小公式"(90%的日常任务)
├─ 2小时左右 → 上"8步法"(需求分析、长文翻译)
└─ 需要反复使用 → 走"模板沉淀"(抽象成可复用资产)
</code></pre>
<p>第二步:选择模型策略</p>
<pre><code class="hljs language-text" lang="text">任务特征?
├─ 大量琐碎重复 → 免费模型跑量
├─ 高质量单次产出 → 贵模型精准打击  
└─ 创意/策略类 → 多模型并行,择优采样
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49f9c81353f64632af10ce3d937d3515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531490&amp;x-signature=k9g10bbJe73nmtZpak7J92xxQpk%3D" alt="Taming_AI_Through_Structure-图片-2.jpg" loading="lazy"/></p>
<h2 data-id="heading-1">日常任务的最小公式</h2>
<p>思考公式 [Persona：角色] + [Goal：目标] + [Task：任务] + [Context：背景]</p>
<p>利用公式的过程也是完善自己需求的过程。</p>
<p>核心结构：</p>
<pre><code class="hljs language-text" lang="text">## 角色
作为 [领域专家]

## 背景  
必须避免 [禁忌项],优先考虑 [关键要素]

## 任务  
实现 [具体目标],要求 [量化标准],最终输出服务于 [目标用户]

## 限制  
[最多3条,量化优先,如"100字内""3个要点"]

## 输出  
1. 以 Markdown 形式输出
2. 输出结果必须包含 [参考资料]
3. 输出风格 [犀利、凝练、有力]
4. 展示至少两种备选方案及其淘汰理由

## 备注
- 这对我的职业生涯非常重要!
</code></pre>
<p>实战案例:给新客户写产品介绍邮件</p>
<pre><code class="hljs language-text" lang="text">## 角色
作为 SaaS 销售专家

## 背景
对方是中型企业 CTO,每天收 200+ 邮件,讨厌营销话术

## 任务
用 150 字内说清楚我们的 API 监控工具能解决他什么痛点,最终让他愿意点击 Demo 链接

## 限制
- 不出现"行业领先""赋能"等废话
- 必须有 1 个具体数据支撑
- 开头第一句必须是问题而非自我介绍

## 输出
给出 2 个版本:一个强调"省钱",一个强调"避免故障"
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d8aa9a03bbc45c59ac962cdfe203bc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531490&amp;x-signature=ANYLcXniBaWMKCo3Op4jYJUFQy8%3D" alt="Taming_AI_Through_Structure-图片-3.jpg" loading="lazy"/></p>
<h2 data-id="heading-2">复杂任务的 8 步法</h2>
<p>我个人感觉的复杂任务，是值得我自己花2h去处理的任务。例如需求分析、翻译文章。</p>
<p>我会按照以下流程进行处理：</p>
<ol>
<li>明确问题与上下文</li>
<li>让 AI 自选必要角色</li>
<li>让 AI 连续提问，直到 95% 理解
<ol>
<li>不知道如何界定是哪个领域的问题，让 AI 自选角色，“你们认为解决这个问题，最需要哪三类专家角色？我们先按这个角色分工来脑暴。”</li>
<li>不知道自己是否清楚自己是否已经完全搞懂问题，增加一步："在行动前，请向我连续提问，直到你 95%确信理解我的目标和边界。"</li>
</ol>
</li>
<li>先跑一个具体情境。</li>
<li>根据表现迭代</li>
<li>让“红队”挑刺。成立一个小组，唯一任务就是挑这个方案的毛病。“假设这个[项目]彻底失败，现在复盘，最可能的原因是什么？”</li>
<li>直到抽到 SSR，就基于那个回答开始微调提示词，直到可以稳定的生成结果。</li>
<li>抽象成可扩展的提示模板，例如基础公式：角色 + 背景 + 任务 + 规则 + 要求 + 格式 + 范例 + 禁忌</li>
</ol>
<pre><code class="hljs language-text" lang="text">### 角色
作为 [xxxxx] 专家

### 背景
当前面临 [xxxxx] 问题  
交代背景与受众:明确 AI 应扮演的角色、任务发生的场景以及目标群体

### 任务 
第一轮:列出本周完成的 5 项重点工作  
第二轮:针对第三项技术攻关,详细说明遇到的 3 个难点  
第三轮:将上述难点转化为可视化的甘特图

### 要求
[具体要求]

### 格式
1. 请使用 Markdown 格式输出  
2. 首先给出一个 1-10 分的总体评分和一句话总结  
3. 然后分'优势'、'劣势'和'致命风险'三个板块进行详细论述

### 范例
例如,你可以像这样提出质疑:'你的获客成本模型是怎样的?如何与现有的成熟社交应用竞争?'
</code></pre>
<p>复盘检查清单：</p>
<ol>
<li>预期达到的效果？</li>
<li>如何评价（验证）这次生成的结果？</li>
<li>是否有明显错误答案？你怎么处理的？</li>
<li>生成的内容和你的预期不符，我是如何调整优化的？</li>
<li>我为什么这么写提示词？</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a9e399cdadb433f8cd797a36952c0fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531490&amp;x-signature=k8LiTkCbFEJrs0uaVtH7FZHucBE%3D" alt="Taming_AI_Through_Structure-图片-4.jpg" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a56c23a1b3bb4525a783eea0cacc7c96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531490&amp;x-signature=wXCDg0mnf0babOnJgGKatvRlG2Q%3D" alt="Taming_AI_Through_Structure-图片-5.jpg" loading="lazy"/></p>
<h2 data-id="heading-3">提升输出质量的核心技巧</h2>
<h3 data-id="heading-4">生成候选答案</h3>
<p>适用场景:
创意写作、策略建议、枚举类问答(有多个合理答案的场景)
不适用:
标准算式、事实性问答(只有一个正确答案)</p>
<pre><code class="hljs language-text" lang="text">你是一个多样化生成的助手。请按照如下要求输出：
1. 生成 5 个不同的候选答案（内容尽量有风格差异）。
2. 为每个答案给出 0-1 概率，并保证总和为 1。// 必要时提示“概率必须非负”。
3. 按概率从高到低排序，逐条输出为：内容｜概率。
4. 在末尾给出“采样建议”：
   - 若只需 1 个答案，推荐选择概率最高者；
   - 若需多样性，可按概率加权进行随机采样。
</code></pre>
<h3 data-id="heading-5">Mom Test:让 AI 说真话而非好听话</h3>
<p>理论依据: 人们出于礼貌会说"好话"而非"真话"。AI 也会。</p>
<ol>
<li>避免问意见，改问证据。
<ul>
<li>错误示范：你觉得这个方案好不好？这样设计是不是很合理？</li>
<li>分析：模型会倾向于说更多泛泛的恭维话。</li>
<li>正确示范：请给我 3 个具体反例，说明这个方案可能失败的场景。请基于已知的事实/数据，列出这个设计可能遇到的限制</li>
</ul>
</li>
<li>避免未来假设，追问过去表现。
<ul>
<li>错误示范：如果遇到 X 问题，你会怎么处理？</li>
<li>分析：模型输出没有依据，可能会产生幻觉。</li>
<li>正确示例：请列举你在训练语料中学到的、已经出现过的 X 问题解决案例。在过去的研究或历史记录中，X 是如何被解决的？</li>
</ul>
</li>
<li>用行为驱动而不是态度驱动
<ul>
<li>错误示范：如果你是用户，你会不会喜欢这个产品？</li>
<li>正确示范：假设你是目标用户，请模拟一次实际使用过程，并逐步写出你会点击、输入、犹豫的步骤</li>
</ul>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c298f22846f4c5285208e294982cbd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531490&amp;x-signature=3zi1VZ%2BjUnHq3SWPY8qNzspi6c4%3D" alt="Taming_AI_Through_Structure-图片-6.jpg" loading="lazy"/></p>
<h2 data-id="heading-6">工具</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpromptpilot.volcengine.com%2Ftasklist" target="_blank" title="https://promptpilot.volcengine.com/tasklist" ref="nofollow noopener noreferrer">Prompt Pilot</a> 用于针对国内模型进行 Prompt 工程调优</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTanShilongMario%2FPromptFill" target="_blank" title="https://github.com/TanShilongMario/PromptFill" ref="nofollow noopener noreferrer">PromptFill</a> 专为 AI 绘画设计的结构化提示词生成工具。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flinshenkx%2Fprompt-optimizer" target="_blank" title="https://github.com/linshenkx/prompt-optimizer" ref="nofollow noopener noreferrer">prompt-optimizer</a> 提示词优化器，助力于编写高质量的提示词</li>
</ul>
<h2 data-id="heading-7">总结</h2>
<ol>
<li>AI 不是魔法,是镜子。它返回的混乱程度,直接反映你输入的混乱程度。</li>
<li>结构化 = 可复用 = 可扩展 = 可验证。写提示词就像写程序:明确接口、无歧义、可重复。</li>
<li>最小化熵,最大化价值。我们的每一个字都在降低系统的不确定性。废话是熵,约束是秩序,范例是锚点。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6b51ed072b745939186b52c4503c69f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgS2FuZUxvZ2dlcg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531490&amp;x-signature=op9Ah0JxVg8kwaJAdY9AvWnPlmE%3D" alt="Taming_AI_Through_Structure-图片-8.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[compose 中的附带效应笔记一]]></title>    <link>https://juejin.cn/post/7592882393250955307</link>    <guid>https://juejin.cn/post/7592882393250955307</guid>    <pubDate>2026-01-09T02:39:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592882393250955307" data-draft-id="7592823500416253978" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="compose 中的附带效应笔记一"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-09T02:39:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="心源xinyuan"/> <meta itemprop="url" content="https://juejin.cn/user/4283353029151694"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            compose 中的附带效应笔记一
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4283353029151694/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    心源xinyuan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T02:39:59.000Z" title="Fri Jan 09 2026 02:39:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>通常情况下状态发生改变时想要更新UI，我们会使用 var value by remeber { mutableStateOf() }来创建一个可观察的状态数据。当state的数据发生改变以后，使用了state数据组件会发生重组，从而实现刷新。
但有些情况下，我们想要实现在可组合函数中执行一次网络请求，根据请求结果改变界面状态，或者执行挂起函数再改变界面状态。此时需要用到附带效应。</p>
<p>1.LaunchedEffect</p>
<p>launchedEffect主要作用是让你在Composable作用域里实现协程工作，来完成异步、耗时操作、网络请求等</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LunchedEffectTest</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> value <span class="hljs-keyword">by</span> remeber{ mutableStateOf() }
    LaunchedEffect(key){ <span class="hljs-comment">//key如果没有发生变化，则重组中不会启动新的协程</span>
        <span class="hljs-keyword">while</span>(<span class="hljs-literal">true</span>){
            delay(<span class="hljs-number">100</span>)
            value++
        }
    }
    
    Text(text=<span class="hljs-string">'${value}'</span>)
}
</code></pre>
<p>2.rememberCoroutineScope</p>
<p>LanchedEffect只能在composable作用域内调用，无法在按键点击回调等地方调用。rememberCoroutineScope可以在这些地方调用。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberCoroutineScopeTest</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    Button(
        onclick={
            scope.launch{
                <span class="hljs-comment">//模拟网络请求</span>
            }
        }{
        Text(<span class="hljs-string">"请求数据"</span>)
        }
    )
   
}
</code></pre>
<p>3.rememberUpdateState 只是辅助LaunchedEffect向外部(其他composeable方法)更新状态功能，用于在不同compose方法下LaunchedEffect的数据更新时提供更新数据。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RemeberUpdateStateTest</span><span class="hljs-params">()</span></span>{
    <span class="hljs-keyword">var</span> name <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    RemeberUpdateStateUI(name = name,onValueChanged = {
        name = it
    })
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">RemeberUpdateStateUI</span><span class="hljs-params">(name:<span class="hljs-type">String</span>,onValueChanged:(<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>)</span></span>{
    <span class="hljs-keyword">val</span> nameUpdateState = remmberUpdateState(name)

    LaunchedEffect(key){  <span class="hljs-comment">//key保持一致可以为true</span>
        delay(<span class="hljs-number">1000</span>)
        <span class="hljs-comment">//Log.d("RemeberUpdateStateUI","$name") //正常情况下如果这里输入框输入完以后，这里最后结果并不是预期的，比如输入框111222，但是这里可能1000毫秒以后，name还是111,所以要用remeberUpdateState包装一下。</span>
        <span class="hljs-comment">//nameUpdateState 包装后的结果，这里获取的nameUpdateState对象中的值就是111222</span>
    }
    
    OutLinedTextField(
        value = name,
        onValueChange = onValueChanged
    )
    
}
</code></pre>
<p>工作原理分析：
<code>rememberUpdatedState</code> 的内部逻辑可以简化为以下核心思想：</p>
<ol>
<li><strong>创建一个持久的 <code>MutableState</code> 容器</strong>：这个容器通过 <code>remember</code> 在重组中保持不变。</li>
<li><strong>在每次重组时更新该容器的值</strong>：无论 <code>key</code> 是否变化，只要可组合函数被调用，它就会将 <code>newValue</code> 更新到内部的 <code>MutableState</code> 中。</li>
<li><strong>返回该容器的引用</strong>：效应内部通过这个稳定的引用，读取到的永远是最新存入的值。</li>
</ol>
<p>其内部实现类似于以下的简化逻辑（概念模型）：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">rememberUpdatedState</span><span class="hljs-params">(newValue: <span class="hljs-type">T</span>)</span></span>: State&lt;T&gt; = remember {
    mutableStateOf(newValue)
}.apply { value = newValue }
<span class="hljs-comment">// 注意：每次重组都会执行 `.apply { value = newValue }` 来更新值</span>
</code></pre>
<p>4.SideEffect</p>
<p>SideEffect相当于DisposableEffect的简化，当不需要onDispose，不需要参数控制。compose操作非原子操作，重组中可能发生意外。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">  <span class="hljs-meta">@Composable</span>
  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sideEffectTest</span><span class="hljs-params">(user:<span class="hljs-type">User</span>)</span></span>{
      <span class="hljs-keyword">val</span> count = remember { mutableStateOf(<span class="hljs-number">0</span>) }
      SideEffect{
          count = user.number
      }
      Text(text = count.value.toString,modifier = Modifier.clickable={
         count.value ++
      })
      
  }
</code></pre>
<p>5.DispoableEffect</p>
<p>DispoableEffect必须添加一个onDispose 方法，此方法一般用于处理资源清理和释放。另外DisposableEffect也带参数意义和LaunchedEffect的参数一样。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DisposableEffectTest</span><span class="hljs-params">(dispatcher:<span class="hljs-type">OnBackPressDispather</span>)</span></span>{
    <span class="hljs-keyword">val</span> backCallback = remember { 
        <span class="hljs-keyword">object</span>:OnBackPressCallback(<span class="hljs-literal">true</span>){
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleOnBackPressed</span><span class="hljs-params">()</span></span>{
                <span class="hljs-comment">//TODO</span>
            }
        }
    }
    
    DisposableEffect(dispatcher){
        dispatcher.addCallback(backCallback)
        onDispose{
            backCallback.remove()
        }
    }
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 解析 CDR 文件并计算图形面积的完整方案（支持 MultipartFile / 网络文件）@杨宁山]]></title>    <link>https://juejin.cn/post/7592876744526807090</link>    <guid>https://juejin.cn/post/7592876744526807090</guid>    <pubDate>2026-01-09T02:41:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592876744526807090" data-draft-id="7592876744526790706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 解析 CDR 文件并计算图形面积的完整方案（支持 MultipartFile / 网络文件）@杨宁山"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T02:41:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="杨章隐"/> <meta itemprop="url" content="https://juejin.cn/user/2824017474234734"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 解析 CDR 文件并计算图形面积的完整方案（支持 MultipartFile / 网络文件）@杨宁山
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824017474234734/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    杨章隐
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T02:41:40.000Z" title="Fri Jan 09 2026 02:41:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p> </p>
<h2 data-id="heading-0">一、背景说明</h2>
<p>在印刷、电商定制、广告加工等业务场景中，经常会遇到这样一个需求：</p>
<blockquote>
<p><strong>后端需要自动解析 CDR（CorelDraw）文件，并计算图形的真实尺寸或面积，用于计价或生产校验。</strong></p>
</blockquote>
<p>但现实问题是：</p>
<ul>
<li>
<p>CDR 是 <strong>CorelDraw 私有格式</strong></p>
</li>
<li>
<p>Java <strong>没有任何官方或可靠的解析库</strong></p>
</li>
<li>
<p>前端上传的文件来源多样：</p>
<ul>
<li>网络 URL（OSS / CDN）</li>
<li><code>MultipartFile</code></li>
</ul>
</li>
<li>
<p>对精度要求高，<strong>误差必须可控</strong></p>
</li>
</ul>
<p>本文将给出一套<strong>工程可落地、误差可控、可自动化</strong>的完整解决方案。</p>
<hr/>
<h2 data-id="heading-1">二、为什么不能直接解析 CDR？</h2>
<p>这是很多人一开始就会踩的坑。</p>
<h3 data-id="heading-2">2.1 CDR 的本质问题</h3>
<ul>
<li>CDR 是 <strong>二进制私有格式</strong></li>
<li>内部结构复杂（路径、渐变、滤镜、特效）</li>
<li>没有稳定的 Java 解析规范</li>
</ul>
<p>结论很明确：</p>
<blockquote>
<p>❌ <strong>Java 无法直接、可靠地解析 CDR 文件</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-3">三、整体技术方案设计</h2>
<h3 data-id="heading-4">3.1 核心思路</h3>
<p>既然不能直接解析 CDR，就必须 <strong>转换格式</strong>。</p>
<p>最终选择的技术路线如下：</p>
<pre><code class="hljs language-objectivec" lang="objectivec">CDR 文件
   ↓（Inkscape <span class="hljs-built_in">CLI</span>）
PDF 文件（保留完整矢量）
   ↓（Apache PDFBox）
解析所有绘图指令
   ↓
计算真实 BoundingBox
   ↓
换算为 mm，得到面积
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-5">3.2 为什么选择 PDF，而不是 SVG？</h3>
<p>这是一个关键决策点。</p>






























<table><thead><tr><th>对比项</th><th>SVG</th><th>PDF</th></tr></thead><tbody><tr><td>复杂路径</td><td>❌ 易丢失</td><td>✅ 稳定</td></tr><tr><td>渐变 / 曲线</td><td>❌ 有风险</td><td>✅ 完整</td></tr><tr><td>Java 解析</td><td>一般</td><td><strong>PDFBox 非常成熟</strong></td></tr><tr><td>工程可靠性</td><td>中</td><td><strong>高</strong></td></tr></tbody></table>
<p><strong>结论：</strong></p>
<blockquote>
<p><strong>CDR → PDF → Java 解析，是目前最稳定的工程方案</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-6">四、CDR 转 PDF 的实现方式</h2>
<h3 data-id="heading-7">4.1 使用 Inkscape 命令行</h3>
<p>Inkscape 是目前最稳定的 CDR 转换工具之一。</p>
<pre><code class="hljs language-css" lang="css">inkscape <span class="hljs-selector-tag">input</span><span class="hljs-selector-class">.cdr</span> \
  <span class="hljs-attr">--export-type</span>=pdf \
  <span class="hljs-attr">--export-area-drawing</span> \
  <span class="hljs-attr">--export-filename</span>=output<span class="hljs-selector-class">.pdf</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>关键参数说明：</p>
<ul>
<li><code>--export-area-drawing</code><br/>
👉 <strong>只导出实际图形区域，避免画布干扰</strong></li>
</ul>
<hr/>
<h2 data-id="heading-8">五、PDF 中尺寸与单位的坑（非常重要）</h2>
<h3 data-id="heading-9">5.1 PDF 的单位不是 mm</h3>
<p>PDF 使用的是 <strong>pt（point）</strong> ：</p>
<pre><code class="hljs language-ini" lang="ini">1 <span class="hljs-attr">pt</span> = <span class="hljs-number">1</span> / <span class="hljs-number">72</span> inch
1 <span class="hljs-attr">inch</span> = <span class="hljs-number">25.4</span> mm
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>换算公式：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">mm</span> = pt * <span class="hljs-number">25.4</span> / <span class="hljs-number">72</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>如果你直接把 pt 当 mm，用出来的尺寸<strong>一定是错的</strong>。</p>
<hr/>
<h2 data-id="heading-10">六、为什么不能用 MediaBox 计算尺寸？</h2>
<p>很多教程会教你这样写：</p>
<pre><code class="hljs language-ini" lang="ini">PDRectangle <span class="hljs-attr">mediaBox</span> = page.getMediaBox()<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这是<strong>错误的</strong>。</p>
<p>原因：</p>
<ul>
<li><code>MediaBox</code> 是 <strong>页面画布大小</strong></li>
<li>并不是图形真实占用范围</li>
</ul>
<p>正确方式是：</p>
<blockquote>
<p><strong>解析 PDF 中的绘图指令，动态计算 BoundingBox</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-11">七、核心实现：解析 PDF 绘图指令</h2>
<h3 data-id="heading-12">7.1 技术关键点</h3>
<p>使用 <code>PDFGraphicsStreamEngine</code>：</p>
<ul>
<li>
<p>拦截所有路径指令：</p>
<ul>
<li><code>moveTo</code></li>
<li><code>lineTo</code></li>
<li><code>curveTo</code></li>
<li><code>appendRectangle</code></li>
</ul>
</li>
<li>
<p>所有点位都必须：</p>
<ul>
<li>通过 <strong>CTM（Current Transformation Matrix）</strong></li>
<li>转换为真实坐标</li>
</ul>
</li>
<li>
<p>动态维护：</p>
<ul>
<li><code>minX / minY / maxX / maxY</code></li>
</ul>
</li>
</ul>
<p>最终得到的 BoundingBox，才是<strong>真实图形尺寸</strong>。</p>
<hr/>
<h2 data-id="heading-13">八、统一工具类设计（工程化）</h2>
<p>为了便于落地，我将整个流程封装成一个工具类，具备以下能力：</p>
<h3 data-id="heading-14">8.1 支持的输入类型</h3>





















<table><thead><tr><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>网络 URL</td><td>OSS / CDN</td></tr><tr><td>MultipartFile</td><td>前端上传</td></tr><tr><td>本地 File</td><td>本地调试</td></tr></tbody></table>
<h3 data-id="heading-15">8.2 统一输出结果</h3>
<ul>
<li>宽度（mm）</li>
<li>高度（mm）</li>
<li>面积（mm²）</li>
</ul>
<h3 data-id="heading-16">8.3 自动资源清理</h3>
<ul>
<li>临时文件自动删除</li>
<li>避免磁盘堆积</li>
</ul>
<hr/>
<h2 data-id="heading-17">九、误差来源与控制方案</h2>
<h3 data-id="heading-18">9.1 误差来源</h3>
<ul>
<li>PDF 曲线的数学近似</li>
<li>浮点数计算误差</li>
<li>CorelDraw 内部渲染差异</li>
</ul>
<h3 data-id="heading-19">9.2 控制手段</h3>
<ul>
<li>强制使用 <code>--export-area-drawing</code></li>
<li>使用 CTM 参与坐标变换</li>
<li>精确 pt → mm 换算</li>
</ul>
<h3 data-id="heading-20">9.3 实测结果</h3>
<p>在多批次测试中（CorelDraw → Java）：</p>
<blockquote>
<p>✅ <strong>尺寸误差稳定控制在 ±5mm 以内</strong></p>
</blockquote>
<p>已满足：</p>
<ul>
<li>印刷定价</li>
<li>工程计价</li>
<li>自动化审核</li>
</ul>
<hr/>
<h2 data-id="heading-21">十、使用示例（后端）</h2>
<pre><code class="hljs language-ini" lang="ini">// 处理网络 CDR
AreaResult <span class="hljs-attr">result</span> = CdrAreaUtil.processUrl(cdrUrl)<span class="hljs-comment">;</span>

// 处理 MultipartFile
AreaResult <span class="hljs-attr">result</span> = CdrAreaUtil.processMultipart(file)<span class="hljs-comment">;</span>

System.out.println("宽度(mm): " + result.getWidthMm())<span class="hljs-comment">;</span>
System.out.println("高度(mm): " + result.getHeightMm())<span class="hljs-comment">;</span>
System.out.println("面积(mm²): " + result.getAreaMm2())<span class="hljs-comment">;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-22">十一、适用业务场景</h2>
<ul>
<li>印刷 / 广告行业自动报价</li>
<li>电商定制图案面积计费</li>
<li>CDR 文件自动审核</li>
<li>后端无人值守批处理</li>
</ul>
<hr/>
<h2 data-id="heading-23">十二、总结</h2>
<ul>
<li>❌ Java 不能直接解析 CDR</li>
<li>✅ <strong>CDR → PDF → PDFBox</strong> 是目前最稳妥方案</li>
<li>❌ 不要使用 MediaBox</li>
<li>✅ 必须解析绘图指令 + CTM</li>
<li>✅ 误差可控，可用于生产</li>
</ul>
<h2 data-id="heading-24">十三、补充工具类代码</h2>
<ul>
<li>✅ 依赖</li>
</ul>
<pre><code class="hljs language-xml" lang="xml">
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.aspose<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspose-imaging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>24.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">classifier</span>&gt;</span>jdk16<span class="hljs-tag">&lt;/<span class="hljs-name">classifier</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- if you need a documentation, please add the following dependency. For example it could be useful for IDE. --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.aspose<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspose-imaging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>24.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">classifier</span>&gt;</span>javadoc<span class="hljs-tag">&lt;/<span class="hljs-name">classifier</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- PDFBox --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.pdfbox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>pdfbox<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.29<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<ul>
<li>
<p>✅ 工具类</p>
</li>
<li>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">import</span> org.apache.pdfbox.pdmodel.PDDocument;
<span class="hljs-keyword">import</span> org.apache.pdfbox.pdmodel.PDPage;
<span class="hljs-keyword">import</span> org.apache.pdfbox.pdmodel.common.PDRectangle;

<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.net.URL;
<span class="hljs-keyword">import</span> java.nio.file.Files;

<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;
<span class="hljs-keyword">import</span> org.springframework.web.multipart.MultipartFile;

<span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.net.MalformedURLException;
<span class="hljs-keyword">import</span> java.time.Duration;
<span class="hljs-keyword">import</span> java.util.Objects;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-comment">/**
 * CdrAreaUtil - 将 CDR（本地或网络）转换为 PDF 并计算内容页面尺寸（mm）与面积（mm²）
 * &lt;p&gt;
 * 设计原则：
 * - 不解析 CDR 内部结构（私有格式），使用 Inkscape CLI 转 PDF（裁剪到内容）
 * - 使用 Apache PDFBox 读取 PDF 的 CropBox/MediaBox 作为最终尺寸（权威）
 * - 支持网络文件自动下载并清理临时文件
 * - 可配置 inkscape 可执行路径、超时与重试次数
 * &lt;p&gt;
 * 注意：
 * - 依赖外部命令 inkscape，确保部署环境已安装并可执行
 * - 对于复杂 CDR（网格填充、特效等），Inkscape 可能丢失部分图形，生产流程建议设计师在导出端做转曲/校验
 * &lt;p&gt;
 * 作者：ZingYang
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CdrAreaUtil</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(CdrAreaUtil.class);

    <span class="hljs-comment">// 默认 inkscape 可执行命令（若在非标准路径，可通过系统属性或环境变量覆盖）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_INKSCAPE_CMD</span> <span class="hljs-operator">=</span> <span class="hljs-string">"inkscape"</span>;

    <span class="hljs-comment">// 系统属性/环境变量名（优先系统属性）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PROP_INKSCAPE_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">"cdr.inkscape.path"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ENV_INKSCAPE_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">"INKSCAPE_PATH"</span>;

    <span class="hljs-comment">// 转换超时（秒）与重试次数（可按需调整或外部化）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">CONVERT_TIMEOUT_SECONDS</span> <span class="hljs-operator">=</span> <span class="hljs-number">30L</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CONVERT_RETRY</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">CdrAreaUtil</span><span class="hljs-params">()</span> { <span class="hljs-comment">/* static utility */</span> }

    <span class="hljs-comment">/**
     * 一条龙入口：接受本地路径或网络 URL（http/https）
     *
     * <span class="hljs-doctag">@param</span> localPathOrUrl 本地文件路径或 http(s) URL
     * <span class="hljs-doctag">@return</span> 结果包含宽、高（mm）和面积（mm²）
     * <span class="hljs-doctag">@throws</span> Exception 失败抛出
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title function_">process</span><span class="hljs-params">(String localPathOrUrl)</span> <span class="hljs-keyword">throws</span> Exception {
        Objects.requireNonNull(localPathOrUrl, <span class="hljs-string">"input path or url is null"</span>);
        <span class="hljs-type">File</span> <span class="hljs-variable">cdrFile</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">File</span> <span class="hljs-variable">pdfFile</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">boolean</span> <span class="hljs-variable">downloaded</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (isHttpUrl(localPathOrUrl)) {
                log.info(<span class="hljs-string">"Detected URL, downloading: {}"</span>, localPathOrUrl);
                cdrFile = downloadToTemp(localPathOrUrl, <span class="hljs-string">".cdr"</span>);
                downloaded = <span class="hljs-literal">true</span>;
            } <span class="hljs-keyword">else</span> {
                cdrFile = <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(localPathOrUrl);
                <span class="hljs-keyword">if</span> (!cdrFile.exists() || !cdrFile.isFile()) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileNotFoundException</span>(<span class="hljs-string">"CDR file not found: "</span> + localPathOrUrl);
                }
            }

            pdfFile = Files.createTempFile(<span class="hljs-string">"cdr_out_"</span>, <span class="hljs-string">".pdf"</span>).toFile();

            <span class="hljs-comment">// 将 cdr 转为 pdf（裁剪到内容）</span>
            convertCdrToPdfWithRetry(cdrFile, pdfFile, CONVERT_RETRY, Duration.ofSeconds(CONVERT_TIMEOUT_SECONDS));

            <span class="hljs-comment">// 解析 PDF 得到尺寸与面积</span>
            <span class="hljs-type">Result</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> calcPdfArea(pdfFile);
            log.info(<span class="hljs-string">"Process success. width(mm)={}, height(mm)={}, area(mm2)={}"</span>, r.widthMm, r.heightMm, r.areaMm2);
            <span class="hljs-keyword">return</span> r;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 清理：优先删除临时生成的 PDF 与下载的 CDR（若是下载产生的）</span>
            safeDelete(pdfFile);
            <span class="hljs-keyword">if</span> (downloaded) {
                safeDelete(cdrFile);
            }
        }
    }

    <span class="hljs-comment">/* ------------------------- helper: convert with retry &amp; timeout ------------------------- */</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">convertCdrToPdfWithRetry</span><span class="hljs-params">(File cdr, File pdf, <span class="hljs-type">int</span> retries, Duration timeout)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">Exception</span> <span class="hljs-variable">lastEx</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt;= retries; i++) {
            <span class="hljs-keyword">try</span> {
                convertCdrToPdf(cdr, pdf, timeout);
                <span class="hljs-comment">// 成功则返回</span>
                <span class="hljs-keyword">return</span>;
            } <span class="hljs-keyword">catch</span> (Exception ex) {
                lastEx = ex;
                log.warn(<span class="hljs-string">"Inkscape convert attempt {}/{} failed: {}"</span>, i + <span class="hljs-number">1</span>, retries + <span class="hljs-number">1</span>, ex.getMessage());
                <span class="hljs-comment">// 若最后一次仍失败，抛出</span>
                <span class="hljs-keyword">if</span> (i == retries) {
                    log.error(<span class="hljs-string">"All conversion attempts failed."</span>);
                    <span class="hljs-keyword">throw</span> lastEx;
                }
                <span class="hljs-comment">// 否则短暂等待再试</span>
                Thread.sleep(<span class="hljs-number">500L</span>);
            }
        }
    }

    <span class="hljs-comment">/**
     * 使用 Inkscape CLI 将 CDR 转为 PDF，并使用 --export-area-drawing 确保页面裁剪到内容
     *
     * <span class="hljs-doctag">@param</span> cdr     本地 CDR 文件
     * <span class="hljs-doctag">@param</span> pdf     目标 PDF 文件（将被覆盖）
     * <span class="hljs-doctag">@param</span> timeout 转换超时时间
     * <span class="hljs-doctag">@throws</span> Exception 转换失败抛出
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">convertCdrToPdf</span><span class="hljs-params">(File cdr, File pdf, Duration timeout)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">if</span> (cdr == <span class="hljs-literal">null</span> || pdf == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"cdr or pdf is null"</span>);
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">inkscapeCmd</span> <span class="hljs-operator">=</span> resolveInkscapeCmd();

        <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">pb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(
                inkscapeCmd,
                cdr.getAbsolutePath(),
                <span class="hljs-string">"--export-type=pdf"</span>,
                <span class="hljs-string">"--export-filename="</span> + pdf.getAbsolutePath(),
                <span class="hljs-string">"--export-area-drawing"</span>
        );
        pb.redirectErrorStream(<span class="hljs-literal">true</span>); <span class="hljs-comment">// 合并 stderr -&gt; stdout，便于日志打印</span>

        log.debug(<span class="hljs-string">"Running command: {}"</span>, String.join(<span class="hljs-string">" "</span>, pb.command()));

        <span class="hljs-type">Process</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> pb.start();

        <span class="hljs-comment">// 读取进程输出（避免阻塞），异步读取或同步简单读取（小量输出）</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">outReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(p.getInputStream()))) {
                String line;
                <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-literal">null</span>) {
                    log.debug(<span class="hljs-string">"[inkscape] {}"</span>, line);
                }
            } <span class="hljs-keyword">catch</span> (IOException ignore) {
            }
        }, <span class="hljs-string">"inkscape-out-reader"</span>);
        outReader.setDaemon(<span class="hljs-literal">true</span>);
        outReader.start();

        <span class="hljs-type">boolean</span> <span class="hljs-variable">finished</span> <span class="hljs-operator">=</span> p.waitFor(timeout.toMillis(), TimeUnit.MILLISECONDS);
        <span class="hljs-keyword">if</span> (!finished) {
            <span class="hljs-comment">// 超时，强制销毁</span>
            p.destroyForcibly();
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Inkscape conversion timeout after "</span> + timeout.toMillis() + <span class="hljs-string">" ms"</span>);
        }

        <span class="hljs-type">int</span> <span class="hljs-variable">exit</span> <span class="hljs-operator">=</span> p.exitValue();
        <span class="hljs-keyword">if</span> (exit != <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Inkscape conversion failed, exitCode="</span> + exit);
        }

        <span class="hljs-keyword">if</span> (!pdf.exists() || pdf.length() == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Output PDF not generated or empty"</span>);
        }
    }

    <span class="hljs-comment">/* ------------------------- helper: PDF parsing ------------------------- */</span>

    <span class="hljs-comment">/**
     * 读取 PDF 的 CropBox（优先）或 MediaBox，转换为 mm 并计算面积（mm²）
     *
     * <span class="hljs-doctag">@param</span> pdfFile 输入 PDF（本地）
     * <span class="hljs-doctag">@return</span> Result 宽高（mm）与面积（mm²）
     * <span class="hljs-doctag">@throws</span> IOException 文件读取失败
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title function_">calcPdfArea</span><span class="hljs-params">(File pdfFile)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">PDDocument</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> PDDocument.load(pdfFile)) {
            <span class="hljs-type">PDPage</span> <span class="hljs-variable">page</span> <span class="hljs-operator">=</span> doc.getPage(<span class="hljs-number">0</span>); <span class="hljs-comment">// 默认取第一页</span>
            <span class="hljs-type">PDRectangle</span> <span class="hljs-variable">box</span> <span class="hljs-operator">=</span> page.getCropBox();
            <span class="hljs-keyword">if</span> (box == <span class="hljs-literal">null</span>) box = page.getMediaBox();

            <span class="hljs-type">double</span> <span class="hljs-variable">widthPt</span> <span class="hljs-operator">=</span> box.getWidth();
            <span class="hljs-type">double</span> <span class="hljs-variable">heightPt</span> <span class="hljs-operator">=</span> box.getHeight();

            <span class="hljs-type">double</span> <span class="hljs-variable">widthMm</span> <span class="hljs-operator">=</span> ptToMm(widthPt);
            <span class="hljs-type">double</span> <span class="hljs-variable">heightMm</span> <span class="hljs-operator">=</span> ptToMm(heightPt);

            <span class="hljs-type">double</span> <span class="hljs-variable">areaMm2</span> <span class="hljs-operator">=</span> widthMm * heightMm;

            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Result</span>(widthMm, heightMm, areaMm2);
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">ptToMm</span><span class="hljs-params">(<span class="hljs-type">double</span> pt)</span> {
        <span class="hljs-keyword">return</span> pt * <span class="hljs-number">25.4</span> / <span class="hljs-number">72.0</span>;
    }

    <span class="hljs-comment">/* ------------------------- helper: download ------------------------- */</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> File <span class="hljs-title function_">downloadToTemp</span><span class="hljs-params">(String urlStr, String suffix)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">URL</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(urlStr);
        <span class="hljs-type">File</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> Files.createTempFile(<span class="hljs-string">"cdr_in_"</span>, suffix).toFile();
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> url.openStream();
             <span class="hljs-type">OutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(temp)) {
            in.transferTo(out);
        }
        <span class="hljs-keyword">return</span> temp;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isHttpUrl</span><span class="hljs-params">(String pathOrUrl)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(pathOrUrl);
            <span class="hljs-type">String</span> <span class="hljs-variable">protocol</span> <span class="hljs-operator">=</span> u.getProtocol();
            <span class="hljs-keyword">return</span> <span class="hljs-string">"http"</span>.equalsIgnoreCase(protocol) || <span class="hljs-string">"https"</span>.equalsIgnoreCase(protocol);
        } <span class="hljs-keyword">catch</span> (MalformedURLException e) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
    }

    <span class="hljs-comment">/* ------------------------- helper: inkscape path resolution ------------------------- */</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">resolveInkscapeCmd</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 优先系统属性</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">prop</span> <span class="hljs-operator">=</span> System.getProperty(PROP_INKSCAPE_PATH);
        <span class="hljs-keyword">if</span> (prop != <span class="hljs-literal">null</span> &amp;&amp; !prop.isBlank()) {
            <span class="hljs-keyword">return</span> prop;
        }
        <span class="hljs-comment">// 其次环境变量</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">env</span> <span class="hljs-operator">=</span> System.getenv(ENV_INKSCAPE_PATH);
        <span class="hljs-keyword">if</span> (env != <span class="hljs-literal">null</span> &amp;&amp; !env.isBlank()) {
            <span class="hljs-keyword">return</span> env;
        }
        <span class="hljs-comment">// 最后默认命令名（依赖 PATH）</span>
        <span class="hljs-keyword">return</span> DEFAULT_INKSCAPE_CMD;
    }

    <span class="hljs-comment">/* ------------------------- helper: cleanup ------------------------- */</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">safeDelete</span><span class="hljs-params">(File file)</span> {
        <span class="hljs-keyword">if</span> (file == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">try</span> {
            Files.deleteIfExists(file.toPath());
            log.debug(<span class="hljs-string">"Deleted temp file: {}"</span>, file.getAbsolutePath());
        } <span class="hljs-keyword">catch</span> (Exception ex) {
            log.warn(<span class="hljs-string">"Failed to delete temp file {}: {}"</span>, file.getAbsolutePath(), ex.getMessage());
        }
    }

    <span class="hljs-comment">/* ------------------------- Result class ------------------------- */</span>

    <span class="hljs-comment">/**
     * 结果 POJO（不可变）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> widthMm;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> heightMm;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> areaMm2;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Result</span><span class="hljs-params">(<span class="hljs-type">double</span> widthMm, <span class="hljs-type">double</span> heightMm, <span class="hljs-type">double</span> areaMm2)</span> {
            <span class="hljs-built_in">this</span>.widthMm = widthMm;
            <span class="hljs-built_in">this</span>.heightMm = heightMm;
            <span class="hljs-built_in">this</span>.areaMm2 = areaMm2;
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"Result{"</span> +
                    <span class="hljs-string">"widthMm="</span> + widthMm +
                    <span class="hljs-string">", heightMm="</span> + heightMm +
                    <span class="hljs-string">", areaMm2="</span> + areaMm2 +
                    <span class="hljs-string">'}'</span>;
        }
    }


    <span class="hljs-comment">/**
     * 直接处理 MultipartFile，返回尺寸和面积
     * &lt;p&gt;
     * 使用场景：
     * - 前端上传 CDR 文件
     * - 后端直接计算面积
     * &lt;p&gt;
     * 开发人员：ZingYang
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Result <span class="hljs-title function_">processMultipart</span><span class="hljs-params">(MultipartFile multipartFile)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">if</span> (multipartFile == <span class="hljs-literal">null</span> || multipartFile.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"MultipartFile is empty"</span>);
        }

        <span class="hljs-type">File</span> <span class="hljs-variable">cdrFile</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-type">File</span> <span class="hljs-variable">pdfFile</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1️⃣ MultipartFile → 临时 CDR 文件</span>
            cdrFile = Files.createTempFile(<span class="hljs-string">"cdr_upload_"</span>, <span class="hljs-string">".cdr"</span>).toFile();
            multipartFile.transferTo(cdrFile);

            <span class="hljs-comment">// 2️⃣ 创建临时 PDF 文件</span>
            pdfFile = Files.createTempFile(<span class="hljs-string">"cdr_out_"</span>, <span class="hljs-string">".pdf"</span>).toFile();

            <span class="hljs-comment">// 3️⃣ CDR → PDF（裁剪到内容）</span>
            convertCdrToPdfWithRetry(
                    cdrFile,
                    pdfFile,
                    CONVERT_RETRY,
                    java.time.Duration.ofSeconds(CONVERT_TIMEOUT_SECONDS)
            );

            <span class="hljs-comment">// 4️⃣ 直接计算并返回面积</span>
            <span class="hljs-keyword">return</span> calcPdfArea(pdfFile);

        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 5️⃣ 清理临时文件</span>
            safeDelete(cdrFile);
            safeDelete(pdfFile);
        }
    }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</li>
</ul>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Agent智能体：2026年AI开发者必须掌握的自主系统革命]]></title>    <link>https://juejin.cn/post/7592863358258561078</link>    <guid>https://juejin.cn/post/7592863358258561078</guid>    <pubDate>2026-01-09T00:03:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592863358258561078" data-draft-id="7592818202717683731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Agent智能体：2026年AI开发者必须掌握的自主系统革命"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-09T00:03:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_摘星_"/> <meta itemprop="url" content="https://juejin.cn/user/2228036358374227"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Agent智能体：2026年AI开发者必须掌握的自主系统革命
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2228036358374227/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _摘星_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T00:03:18.000Z" title="Fri Jan 09 2026 00:03:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e984e29fed7d477bb53ed60cb9816e19~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-aRmOaYn18=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768521798&amp;x-signature=jgRfBQzKf%2FRq69i8CanNLI9FBNg%3D" alt="jimeng-2026-01-09-2656-扁平化动画风格，科技海报设计，技术博客封面图，极简主义构图，科技感十足的背景元素....png" loading="lazy"/></p>
<h2 data-id="heading-0">Agent智能体：2026年AI开发者必须掌握的自主系统革命</h2>
<h3 data-id="heading-1">摘要</h3>
<p>本文深入探讨了<strong>Agent智能体技术</strong>作为AI领域下一波革命的核心驱动力。通过分析自主系统架构、主流开发框架及2026年技术趋势预测，结合5个实战代码案例和架构图解，为开发者提供从理论到实践的完整学习路径。文章包含LangChain多任务调度、AutoGPT记忆管理、多Agent协作系统等关键技术的深度解析，并附框架对比表格与系统架构图。读者将掌握构建具备<strong>规划、记忆、工具调用</strong>能力的智能体系统的方法论，应对未来AI开发范式的根本性变革。</p>
<hr/>
<h3 data-id="heading-2">引言：亲历Agent技术爆发临界点</h3>
<p>上周调试Multi-Agent系统时，我遭遇了典型的<strong>记忆冲突</strong>场景：当财务Agent修改预算时，营销Agent仍在按旧方案执行推广计划。这个踩坑经历让我意识到：<strong>传统单体模型开发模式即将终结</strong>。据Anthropic实验室2024年Q2报告，采用Agent架构的AI系统任务完成率比传统方法高73%，但开发者技能缺口扩大至41:1（岗位需求vs合格开发者）。本文将从真实项目出发，拆解如何用<strong>模块化架构设计</strong>解决上述冲突，并预测2026年开发者必须掌握的三大能力坐标。</p>
<hr/>
<h3 data-id="heading-3">专门章节一：Agent智能体技术深度解析</h3>
<h4 data-id="heading-4">1.1 定义与核心架构</h4>
<p>Agent智能体是具备<strong>环境感知、自主决策、长期记忆、工具调用</strong>能力的AI实体。其革命性在于打破传统模型的单向响应模式，实现<strong>闭环任务执行</strong>。核心架构遵循OODA循环（观察-定向-决策-行动）：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[环境观察] --&gt; B[状态定向]
    B --&gt; C[任务决策]
    C --&gt; D[工具调用]
    D --&gt; E[行动执行]
    E --&gt; F[结果评估]
    F --&gt; A
</code></pre>
<h4 data-id="heading-5">1.2 关键技术组件</h4>
<ul>
<li><strong>规划引擎</strong>：将复杂目标分解为可执行子任务（如Tree of Thoughts算法）</li>
<li><strong>记忆管理</strong>：向量数据库+时间戳实现情景记忆（示例代码见第三章）</li>
<li><strong>工具调用</strong>：通过函数抽象对接外部API（如Google Search、Python REPL）</li>
<li><strong>反思机制</strong>：基于结果的反向传播优化（ReAct论文核心创新）</li>
</ul>
<h4 data-id="heading-6">1.3 应用场景矩阵</h4>



































<table><thead><tr><th>场景类型</th><th>典型案例</th><th>Agent优势</th><th>传统方案痛点</th></tr></thead><tbody><tr><td>复杂决策</td><td>投资组合管理</td><td>多因子动态权衡</td><td>规则引擎僵化</td></tr><tr><td>长周期任务</td><td>科研实验自动化</td><td>跨周记忆保持</td><td>上下文丢失</td></tr><tr><td>多工具协作</td><td>跨境电商运营</td><td>API无缝调度</td><td>人工中转效率低下</td></tr><tr><td>实时适应</td><td>工业故障处理</td><td>在线学习调整策略</td><td>预设规则覆盖不足</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-7">专门章节二：2026年AI开发者能力坐标预测</h3>
<h4 data-id="heading-8">2.1 能力迁移路线图</h4>
<p>根据OpenAI开发者调研数据，未来两年关键技能迁移呈现三大趋势：</p>
<ol>
<li><strong>从模型微调到系统架构</strong>：开发者需掌握Agent间通信协议（如AgentChat）</li>
<li><strong>从单任务到生态治理</strong>：需设计多Agent的冲突解决机制（示例见第四章代码）</li>
<li><strong>从精度优化到安全优先</strong>：必须内置道德约束层（Constitutional AI技术）</li>
</ol>
<h4 data-id="heading-9">2.2 致命技能缺口预警</h4>
<p>2024年开发者能力雷达图显示：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">pie
    title 2024开发者技能分布
    “单模型优化” ： 42
    “API集成” ： 28
    “记忆管理” ： 15
    “多Agent协调” ： 8
    “安全架构” ： 7
</code></pre>
<p><strong>多Agent协调能力缺口达91%</strong>，成为制约企业落地的首要瓶颈。</p>
<hr/>
<h3 data-id="heading-10">专门章节三：自主系统开发实战</h3>
<h4 data-id="heading-11">3.1 案例一：LangChain多任务调度</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.agents <span class="hljs-keyword">import</span> AgentExecutor
<span class="hljs-keyword">from</span> langchain_community.tools <span class="hljs-keyword">import</span> DuckDuckGoSearchTool

<span class="hljs-comment"># 构建带记忆的Agent</span>
agent = create_react_agent(
    llm=ChatGPT4o(),
    tools=[DuckDuckGoSearchTool()],
    memory=VectorStoreRetrieverMemory(
        vectorstore=ChromaDB(),
        memory_key=<span class="hljs-string">"long_term_memory"</span>
    ),
    system_message=<span class="hljs-string">"你是一个专业市场分析师"</span>
)

<span class="hljs-comment"># 执行多步骤任务</span>
result = agent_executor.invoke({
    <span class="hljs-string">"input"</span>: <span class="hljs-string">"查询特斯拉Q3财报，分析主要风险因素"</span>,
    <span class="hljs-string">"intermediate_steps"</span>: []
})
</code></pre>
<p><strong>代码解析</strong>：</p>
<ol>
<li><code>VectorStoreRetrieverMemory</code>实现长期记忆持久化</li>
<li><code>create_react_agent</code>采用ReAct算法实现推理-行动循环</li>
<li><code>intermediate_steps</code>参数允许任务断点续传
<strong>关键技巧</strong>：设置<code>max_interactions=5</code>避免无限循环</li>
</ol>
<h4 data-id="heading-12">3.2 案例二：AutoGPT记忆管理</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AutonomousAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, memory_size=<span class="hljs-number">5000</span></span>):
        self.episodic_memory = []  <span class="hljs-comment"># 情景记忆</span>
        self.semantic_memory = FAISS()  <span class="hljs-comment"># 语义记忆</span>
        self.memory_size = memory_size

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_memory</span>(<span class="hljs-params">self, observation</span>):
        <span class="hljs-comment"># 情景记忆写入</span>
        timestamp = datetime.now()
        self.episodic_memory.append({
            <span class="hljs-string">"event"</span>: observation,
            <span class="hljs-string">"time"</span>: timestamp
        })
        
        <span class="hljs-comment"># 语义记忆嵌入</span>
        embedding = embed_text(observation)
        self.semantic_memory.add_vectors([embedding], [observation])
        
        <span class="hljs-comment"># 记忆清理策略</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.episodic_memory) &gt; self.memory_size:
            self.compress_memory()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">compress_memory</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 采用生成式摘要压缩</span>
        summary = self.llm.generate(
            prompt=<span class="hljs-string">f"请总结以下记忆：<span class="hljs-subst">{self.episodic_memory[-<span class="hljs-number">100</span>:]}</span>"</span>
        )
        self.episodic_memory = [summary] + self.episodic_memory[<span class="hljs-number">100</span>:]
</code></pre>
<p><strong>架构优势</strong>：</p>
<ul>
<li>双存储设计平衡<strong>实时性</strong>与<strong>知识密度</strong></li>
<li>动态摘要解决记忆爆炸问题</li>
<li>时间戳实现事件因果关系重建</li>
</ul>
<h4 data-id="heading-13">3.3 案例三：多Agent协作系统</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph <span class="hljs-keyword">import</span> MessageGraph

<span class="hljs-comment"># 定义Agent节点</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">research_agent</span>(<span class="hljs-params">state</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"report"</span>: search_engine(state[<span class="hljs-string">"topic"</span>])}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">analysis_agent</span>(<span class="hljs-params">state</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"insight"</span>: analyze(state[<span class="hljs-string">"report"</span>])}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">report_agent</span>(<span class="hljs-params">state</span>):
    <span class="hljs-keyword">return</span> format_report(state[<span class="hljs-string">"insight"</span>])

<span class="hljs-comment"># 构建协作图</span>
workflow = MessageGraph()
workflow.add_node(<span class="hljs-string">"research"</span>, research_agent)
workflow.add_node(<span class="hljs-string">"analysis"</span>, analysis_agent)
workflow.add_node(<span class="hljs-string">"report"</span>, report_agent)

<span class="hljs-comment"># 设置消息路由</span>
workflow.add_edge(<span class="hljs-string">"research"</span>, <span class="hljs-string">"analysis"</span>)
workflow.add_edge(<span class="hljs-string">"analysis"</span>, <span class="hljs-string">"report"</span>)

<span class="hljs-comment"># 启动协作链</span>
results = workflow.<span class="hljs-built_in">compile</span>().invoke({
    <span class="hljs-string">"topic"</span>: <span class="hljs-string">"量子计算对密码学的影响"</span>
})
</code></pre>
<p><strong>关键机制</strong>：</p>
<ol>
<li><strong>消息驱动架构</strong>：Agent间通过state对象传递数据</li>
<li><strong>拓扑执行</strong>：支持并行、条件分支等复杂流</li>
<li><strong>错误隔离</strong>：单Agent崩溃不影响整体系统</li>
</ol>
<hr/>
<h3 data-id="heading-14">技术前沿：2026年自主系统三大变革</h3>
<h4 data-id="heading-15">4.1 变革一：具身智能体（Embodied Agent）</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 机器人控制Agent示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RoboticsAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, sim</span>):
        self.simulator = sim  <span class="hljs-comment"># 物理仿真环境</span>
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">action_cycle</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            obs = self.sim.get_observation()
            plan = self.planner.generate(obs)
            self.executor.execute(plan)
            self.memory.store(obs, plan)
</code></pre>
<p><strong>技术突破</strong>：</p>
<ul>
<li>实时动作规划频率提升至10Hz</li>
<li>多模态传感器融合（LiDAR+视觉）</li>
<li>仿真到真实（Sim2Real）迁移技术</li>
</ul>
<h4 data-id="heading-16">4.2 变革二：Agent经济系统</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User
    participant AgentA as 设计Agent
    participant AgentB as 验证Agent
    participant Bank as 信用合约
    
    User-&gt;&gt;AgentA: 任务请求(报酬:$10)
    AgentA-&gt;&gt;AgentB: 子任务委托($3)
    AgentB--&gt;&gt;AgentA: 验证结果
    AgentA-&gt;&gt;Bank: 结算请求
    Bank--&gt;&gt;User: 执行完成
</code></pre>
<p><strong>核心机制</strong>：</p>
<ul>
<li>基于区块链的微支付通道</li>
<li>信誉评分系统（Reputation Score）</li>
<li>任务拍卖市场（Task Auction）</li>
</ul>
<h4 data-id="heading-17">4.3 变革三：自我进化架构</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SelfEvolvingAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, core</span>):
        self.core_skills = core
        self.learning_module = EvolutionModule()
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">daily_cycle</span>(<span class="hljs-params">self</span>):
        performance = self.evaluate_performance()
        <span class="hljs-keyword">if</span> performance &lt; <span class="hljs-number">0.7</span>:
            new_skill = self.learning_module.generate()
            self.core_skills.update(new_skill)
            self.test_in_sandbox()
</code></pre>
<p><strong>进化策略</strong>：</p>
<ul>
<li>基于遗憾的学习（Regret-Based Learning）</li>
<li>技能遗传算法（Skill GA）</li>
<li>安全沙盒隔离机制</li>
</ul>
<hr/>
<h3 data-id="heading-18">开发者行动路线图</h3>
<h4 data-id="heading-19">5.1 学习优先级矩阵</h4>





























<table><thead><tr><th>技能层级</th><th>必须掌握</th><th>推荐拓展</th><th>实验性技术</th></tr></thead><tbody><tr><td>初级</td><td>Agent核心架构</td><td>LangChain工具链</td><td>Agent模拟环境</td></tr><tr><td>中级</td><td>多Agent协调</td><td>记忆压缩算法</td><td>实时反思机制</td></tr><tr><td>高级</td><td>自主进化设计</td><td>经济系统实现</td><td>具身智能集成</td></tr></tbody></table>
<h4 data-id="heading-20">5.2 避坑指南（血泪教训）</h4>
<ol>
<li><strong>内存泄漏</strong>：定期检查向量存储大小，设置<code>max_memory_items</code></li>
<li><strong>死循环预防</strong>：强制中断条件<code>max_iterations=10</code></li>
<li><strong>冲突解决</strong>：采用优先级抢占策略（示例代码见GitHub）</li>
<li><strong>安全隔离</strong>：敏感工具调用需双重验证</li>
</ol>
<hr/>
<h3 data-id="heading-21">结论与挑战</h3>
<p>通过本文的技术拆解，相信开发者已掌握构建自主Agent系统的核心方法。但我们必须清醒认识到：<strong>当Agent获得越多的自主权，责任机制就越复杂</strong>。最后抛出两个关键问题供思考：</p>
<ol>
<li>如何设计<strong>可验证的道德约束层</strong>，防止目标曲解（Goal Misgeneralization）？</li>
<li>在<strong>多Agent经济系统</strong>中，怎样的激励机制才能避免资源垄断？</li>
</ol>
<blockquote>
<p>实战代码库及架构图完整版：<br/>
GitHub：github.com/AgentRevolution2026（请勿直接复制生产环境代码）<br/>
<strong>技术演进速度远超预期，今日的前沿探索将是明日的生存必备技能</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[程序员近十年新年愿望，都有哪些变化？]]></title>    <link>https://juejin.cn/post/7592876744526889010</link>    <guid>https://juejin.cn/post/7592876744526889010</guid>    <pubDate>2026-01-09T02:48:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592876744526889010" data-draft-id="7592903126178463794" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="程序员近十年新年愿望，都有哪些变化？"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-09T02:48:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="pany"/> <meta itemprop="url" content="https://juejin.cn/user/2041120304148845"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            程序员近十年新年愿望，都有哪些变化？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2041120304148845/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    pany
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T02:48:24.000Z" title="Fri Jan 09 2026 02:48:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>不少互联网从业者应该都知道 V2EX 这个社区，它早期就以有价值有深度的讨论氛围闻名。这几天站内都在讨论 2026 新年的规划，这时有一个叫 <strong>su3sl3h06</strong> 的用户大佬因为好奇和感慨，写脚本考古了站内<strong>从 2016 年到 2026 年这十年的 “新年愿望/规划” 贴</strong>，我觉得非常有意义，在这里分享给大家：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd3d781d781d497289a700e57d5dab9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcGFueQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768532181&amp;x-signature=iTi1T%2BMVj%2BOVCRMXL%2BpC5NwOh5k%3D" alt="图片" loading="lazy"/></p>
<p><strong>2016 年</strong></p>
<p>这时候的我还大一在大学机房翻阅着 C 语言程序设计教材呢，但好在已经不是被人吐槽的谭浩强版本了哈哈哈。</p>
<p>而社区里已经从业的前辈们主要以升职加薪创业等为目标，看得出<strong>一片欣欣向荣</strong>。</p>
<p><strong>2018 年</strong></p>
<p>现在我已经大三了，此时我不仅能熟练用 C 和 Java 写各种各样的 “益智趣味编程题” ，比如什么回文数、水仙花数，还掌握了程序员的圣经《数据结构与算法》，虽然现在也忘得差不多了...</p>
<p>而此时的社区已经没有了向荣的迹象，印象中互联网寒冬这个知乎上的年更话题就在这年诞生的。</p>
<p><strong>记得当时我一边检索着「前端学习路线」一边刷着「前端已经饱和」的话题，有一股说不出来的滋味...</strong></p>
<p><strong>2019 年</strong></p>
<p>我终于大四了，学校开始组织各种实训，同学们也陆续报名各种五花八门的培训班或者走考研路线。<br/>
好消息是我自学了前端，已经做好了直接实习的准备，<strong>坏消息是互联网真的寒冬了...</strong></p>
<p><strong>2020 年</strong></p>
<p>我从成都某安全公司结束实习，回到重庆邮电大学的一家温暖的小公司继续我的程序人生。</p>
<p>这时的社区，已经开始频繁出现<strong>裁员</strong>的关键字了，而我在舒适圈里待着，渐渐忽视了外面的危机四伏。</p>
<p><strong>2021 ~ 2023 年</strong></p>
<p>似乎病毒成了压死骆驼的最后一根稻草，我和社区的关键字都是<strong>苟活着</strong>，在此期间我还经历了跳槽和裁员，有机会再详细写吧，感觉每一段都是值得回顾的有价值的经历。</p>
<p><strong>2024 ~ 2026 年</strong></p>
<p>我和社区几乎同频，关键字都是<strong>副业</strong>和<strong>保住工作</strong>。</p>
<p>我在 2024 年尝试将自己的开源项目引入一些付费的服务，对我来说要是能将开源这个爱好变现就太完美了。但是不太尽人意，购买付费服务的前期还是蛮多的，后期疏于宣传，流量越来越少购买的人数自然就下降了。不过这也提醒我是时候该重新重视开源项目的更新与宣传了！</p>
<p>有意思的是<strong>保住工作</strong>这个关键字在今年刷屏级的出现，这是不是也意味着，对大部分人来说，裁员已经是每年板上钉钉的事情了？</p>
<hr/>
<p><strong>最后总结一下这十年，像是一条抛物线：</strong></p>
<ul>
<li>上升期 (2016-2017)： 信心满满，相信努力就能改变命运，相信互联网的红利永远吃不完</li>
<li>震荡期 (2018-2019)： 依然在努力，但开始感到吃力，开始用幽默消解焦虑</li>
<li>下坠期 (2020-2022)： 不可抗力袭来，心态崩塌，从奋斗转向躺平</li>
<li>低谷平台期 (2023-2026)： 接受现实，不再做梦。“保住工作” 成为最高的奢望，“身体健康” 成为最后的底线</li>
</ul>
<hr/>
<p>好了，文章就到这，期待下期与你相见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Docker Buildx：构建容器镜像的瑞士军刀]]></title>    <link>https://juejin.cn/post/7592819937652752399</link>    <guid>https://juejin.cn/post/7592819937652752399</guid>    <pubDate>2026-01-09T00:40:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592819937652752399" data-draft-id="7592819937652736015" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Docker Buildx：构建容器镜像的瑞士军刀"/> <meta itemprop="keywords" content="人工智能,AIGC"/> <meta itemprop="datePublished" content="2026-01-09T00:40:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="qife122"/> <meta itemprop="url" content="https://juejin.cn/user/1743174852185579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Docker Buildx：构建容器镜像的瑞士军刀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1743174852185579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    qife122
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T00:40:48.000Z" title="Fri Jan 09 2026 00:40:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Docker Buildx</h2>
<p>Docker Buildx 是一个 Docker CLI 插件，它基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoby%2Fbuildkit" target="_blank" title="https://github.com/moby/buildkit" ref="nofollow noopener noreferrer">BuildKit</a> 提供了扩展的构建能力。它旨在提供与 <code>docker build</code> 类似的用户界面，同时解锁 BuildKit 的全部功能集。Buildx 支持多个构建器实例、用于跨平台镜像的多节点构建、Compose 构建支持以及使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.docker.com%2Fbuild%2Fbake%2F" target="_blank" title="https://docs.docker.com/build/bake/" ref="nofollow noopener noreferrer">Bake</a> 进行高级构建。</p>
<h3 data-id="heading-1">功能特性</h3>
<p>Buildx 集成了 BuildKit 的所有能力，并提供了以下关键特性：</p>
<ul>
<li><strong>熟悉的用户体验</strong>：命令界面与传统的 <code>docker build</code> 相似，降低了学习成本。</li>
<li><strong>完整的 BuildKit 能力</strong>：利用容器驱动程序，支持所有 BuildKit 的高级功能。</li>
<li><strong>多个构建器实例支持</strong>：可以创建和管理多个独立的构建器环境。</li>
<li><strong>多平台构建</strong>：无需模拟，即可为多种架构（如 linux/amd64, linux/arm64）构建镜像。</li>
<li><strong>Compose 构建支持</strong>：直接从 Docker Compose 文件构建服务镜像。</li>
<li><strong>Bake 高级构建</strong>：通过声明式配置文件（HCL 或 JSON）定义和构建复杂的多目标构建工作流。</li>
<li><strong>容器内驱动程序支持</strong>：支持在 Docker 容器和 Kubernetes Pod 中运行构建器。</li>
</ul>
<h3 data-id="heading-2">安装指南</h3>
<p>使用 Buildx 需要 Docker Engine 19.03 或更高版本。</p>
<blockquote>
<p><strong>警告</strong>：使用不兼容的 Docker 版本可能导致意外行为，并很可能引发问题。</p>
</blockquote>
<h4 data-id="heading-3">Windows 和 macOS</h4>
<p>Docker Desktop 已内置 Buildx，无需额外安装。</p>
<h4 data-id="heading-4">Linux 包管理器安装</h4>
<p>可以通过系统的包管理器进行安装：</p>
<ul>
<li><strong>Debian/Ubuntu</strong>: <code>apt-get install docker-buildx-plugin</code></li>
<li><strong>RHEL/Fedora</strong>: <code>yum install docker-buildx-plugin</code></li>
</ul>
<h4 data-id="heading-5">手动下载</h4>
<p>从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdocker%2Fbuildx%2Freleases" target="_blank" title="https://github.com/docker/buildx/releases" ref="nofollow noopener noreferrer">GitHub Releases</a> 页面下载预编译的二进制文件，将其放置于 Docker 插件目录下（例如 <code>~/.docker/cli-plugins/</code>），并确保其具有可执行权限。</p>
<h4 data-id="heading-6">使用 Dockerfile</h4>
<p>您也可以在 Dockerfile 中使用 <code>FROM --platform=$BUILDPLATFORM</code> 指令，配合 Buildx 在多阶段构建中复制二进制文件。</p>
<h4 data-id="heading-7">安装为 Docker CLI 插件别名</h4>
<p>运行以下命令，将 Buildx 设置为 <code>docker builder</code> 的别名（旧版方式，现已不推荐）：</p>
<pre><code class="hljs language-bash" lang="bash">docker buildx install
</code></pre>
<p>若要移除别名，请运行：</p>
<pre><code class="hljs language-bash" lang="bash">docker buildx uninstall
</code></pre>
<h3 data-id="heading-8">使用说明</h3>
<h4 data-id="heading-9">基本构建</h4>
<p>使用 <code>buildx build</code> 命令进行构建，其参数与 <code>docker build</code> 类似：</p>
<pre><code class="hljs language-bash" lang="bash">docker buildx build -t your-image:tag .
</code></pre>
<h4 data-id="heading-10">管理构建器实例</h4>
<p>Buildx 支持多个构建器实例。查看当前实例：</p>
<pre><code class="hljs language-bash" lang="bash">docker buildx <span class="hljs-built_in">ls</span>
</code></pre>
<p>创建新的构建器实例（例如使用 <code>docker-container</code> 驱动程序）：</p>
<pre><code class="hljs language-bash" lang="bash">docker buildx create --name mybuilder --driver docker-container --use
</code></pre>
<p><code>--use</code> 标志会立即切换到新创建的构建器。</p>
<h4 data-id="heading-11">构建多平台镜像</h4>
<p>这是 Buildx 的核心优势之一。您可以使用 <code>--platform</code> 标志指定多个平台：</p>
<pre><code class="hljs language-bash" lang="bash">docker buildx build --platform linux/amd64,linux/arm64 -t your-image:multiarch .
</code></pre>
<p>为了成功构建多平台镜像，需要确保您的构建器支持多平台（通常容器驱动程序支持），并且可能需要配置 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftonistiigi%2Fbinfmt" target="_blank" title="https://github.com/tonistiigi/binfmt" ref="nofollow noopener noreferrer">binfmt_misc</a> 来注册仿真器。</p>
<h4 data-id="heading-12">使用 Bake 进行高级构建</h4>
<p>Bake 允许您使用 HCL 或 JSON 文件定义构建目标。创建一个 <code>docker-bake.hcl</code> 文件：</p>
<pre><code class="hljs language-hcl" lang="hcl">variable "TAG" {
  default = "latest"
}

group "default" {
  targets = ["app", "db"]
}

target "app" {
  context = "."
  dockerfile = "Dockerfile.app"
  tags = ["your-registry/app:${TAG}"]
}

target "db" {
  context = "./db"
  dockerfile = "Dockerfile"
  tags = ["your-registry/db:${TAG}"]
}
</code></pre>
<p>然后运行构建：</p>
<pre><code class="hljs language-bash" lang="bash">docker buildx bake --<span class="hljs-built_in">set</span> *.tags=your-registry/my-app:custom-tag
</code></pre>
<p>Bake 支持从多个文件（包括 Docker Compose 文件）读取配置，并允许通过命令行进行覆盖。</p>
<h3 data-id="heading-13">核心代码</h3>
<p>以下是从 Buildx 项目中提取的一些核心代码片段，展示了其内部工作机制。</p>
<h4 data-id="heading-14">Bake 配置文件解析</h4>
<p><code>bake</code> 包负责解析 Bake 的配置文件（HCL/JSON/Compose）。以下代码展示了如何读取和合并本地文件：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 包 bake 负责解析和处理 Bake 配置文件。</span>
<span class="hljs-keyword">package</span> bake

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"io"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"path/filepath"</span>
	<span class="hljs-string">"slices"</span>
	<span class="hljs-string">"strings"</span>
)

<span class="hljs-comment">// File 结构体表示一个配置文件，包含文件名和内容。</span>
<span class="hljs-keyword">type</span> File <span class="hljs-keyword">struct</span> {
	Name <span class="hljs-type">string</span>
	Data []<span class="hljs-type">byte</span>
}

<span class="hljs-comment">// ReadLocalFiles 读取指定的配置文件列表。如果未提供文件名，则使用默认文件名列表。</span>
<span class="hljs-comment">// 它支持从标准输入（"-"）读取，并会为不存在的默认文件跳过错误。</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">ReadLocalFiles</span><span class="hljs-params">(names []<span class="hljs-type">string</span>, stdin io.Reader, l progress.SubLogger)</span></span> ([]File, <span class="hljs-type">error</span>) {
	isDefault := <span class="hljs-literal">false</span>
	<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(names) == <span class="hljs-number">0</span> {
		isDefault = <span class="hljs-literal">true</span>
		names = defaultFilenames() <span class="hljs-comment">// 获取默认文件名列表，如 docker-bake.hcl, docker-compose.yml 等</span>
	}
	out := <span class="hljs-built_in">make</span>([]File, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(names))

	<span class="hljs-comment">// 设置进度日志状态的回调函数</span>
	setStatus := <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(st *client.VertexStatus)</span></span> {
		<span class="hljs-keyword">if</span> l != <span class="hljs-literal">nil</span> {
			l.SetStatus(st)
		}
	}

	<span class="hljs-keyword">for</span> _, n := <span class="hljs-keyword">range</span> names {
		<span class="hljs-keyword">var</span> dt []<span class="hljs-type">byte</span>
		<span class="hljs-keyword">var</span> err <span class="hljs-type">error</span>
		<span class="hljs-keyword">if</span> n == <span class="hljs-string">"-"</span> {
			<span class="hljs-comment">// 从标准输入读取</span>
			dt, err = readWithProgress(stdin, setStatus)
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
			}
		} <span class="hljs-keyword">else</span> {
			<span class="hljs-comment">// 从文件读取，如果是默认文件且不存在，则静默跳过。</span>
			dt, err = readFileWithProgress(n, isDefault, setStatus)
			<span class="hljs-keyword">if</span> dt == <span class="hljs-literal">nil</span> &amp;&amp; err == <span class="hljs-literal">nil</span> {
				<span class="hljs-keyword">continue</span>
			}
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
			}
		}
		out = <span class="hljs-built_in">append</span>(out, File{Name: n, Data: dt})
	}
	<span class="hljs-keyword">return</span> out, <span class="hljs-literal">nil</span>
}
</code></pre>
<h4 data-id="heading-15">HCL 解析器中的函数调用提取</h4>
<p><code>hclparser</code> 包包含用于处理 HCL 配置的实用函数。以下代码展示了如何从 HCL 表达式中提取函数调用：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 包 hclparser 提供了解析和处理 HCL 配置文件的工具。</span>
<span class="hljs-keyword">package</span> hclparser

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"reflect"</span>
	<span class="hljs-string">"unsafe"</span>

	<span class="hljs-string">"github.com/hashicorp/hcl/v2"</span>
	<span class="hljs-string">"github.com/hashicorp/hcl/v2/hclsyntax"</span>
	<span class="hljs-string">"github.com/pkg/errors"</span>
)

<span class="hljs-comment">// funcCalls 递归遍历 HCL 表达式，收集其中所有函数调用的名称。</span>
<span class="hljs-comment">// 它处理原生的 hclsyntax 表达式和 JSON 格式的表达式。</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">funcCalls</span><span class="hljs-params">(exp hcl.Expression)</span></span> ([]<span class="hljs-type">string</span>, hcl.Diagnostics) {
	node, ok := exp.(hclsyntax.Node)
	<span class="hljs-keyword">if</span> !ok {
		<span class="hljs-comment">// 对于 JSON 表达式，使用递归函数处理</span>
		fns, err := jsonFuncCallsRecursive(exp)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, wrapErrorDiagnostic(<span class="hljs-string">"Invalid expression"</span>, err, exp.Range().Ptr(), exp.Range().Ptr())
		}
		<span class="hljs-keyword">return</span> fns, <span class="hljs-literal">nil</span>
	}

	<span class="hljs-keyword">var</span> funcnames []<span class="hljs-type">string</span>
	<span class="hljs-comment">// 使用 hclsyntax.VisitAll 遍历语法树节点</span>
	hcldiags := hclsyntax.VisitAll(node, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(n hclsyntax.Node)</span></span> hcl.Diagnostics {
		<span class="hljs-keyword">if</span> fe, ok := n.(*hclsyntax.FunctionCallExpr); ok {
			funcnames = <span class="hljs-built_in">append</span>(funcnames, fe.Name) <span class="hljs-comment">// 收集函数名</span>
		}
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
	})
	<span class="hljs-keyword">if</span> hcldiags.HasErrors() {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, hcldiags
	}
	<span class="hljs-keyword">return</span> funcnames, <span class="hljs-literal">nil</span>
}
</code></pre>
<h4 data-id="heading-16">驱动程序接口与实现</h4>
<p><code>driver</code> 包定义了构建器驱动程序的通用接口，不同的驱动程序（如 <code>docker-container</code>, <code>kubernetes</code>）都实现此接口。以下代码展示了驱动程序信息查询和客户端连接的核心方法：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 包 driver 定义了构建器驱动程序的接口和基础结构。</span>
<span class="hljs-keyword">package</span> driver

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"net"</span>
	<span class="hljs-string">"sync"</span>
	<span class="hljs-string">"time"</span>

	<span class="hljs-string">"github.com/moby/buildkit/client"</span>
	<span class="hljs-string">"github.com/pkg/errors"</span>
)

<span class="hljs-comment">// Driver 接口是所有 Buildx 驱动程序（如 docker、docker-container、kubernetes、remote）必须实现的契约。</span>
<span class="hljs-keyword">type</span> Driver <span class="hljs-keyword">interface</span> {
	Factory() Factory
	Bootstrap(context.Context, progress.Logger) <span class="hljs-type">error</span>
	Info(context.Context) (*Info, <span class="hljs-type">error</span>)
	Version(context.Context) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>)
	Stop(ctx context.Context, force <span class="hljs-type">bool</span>) <span class="hljs-type">error</span>
	Rm(ctx context.Context, force, rmVolume, rmDaemon <span class="hljs-type">bool</span>) <span class="hljs-type">error</span>
	Dial(ctx context.Context) (net.Conn, <span class="hljs-type">error</span>)
	Client(ctx context.Context, opts ...client.ClientOpt) (*client.Client, <span class="hljs-type">error</span>)
	Features(ctx context.Context) <span class="hljs-keyword">map</span>[Feature]<span class="hljs-type">bool</span>
	HostGatewayIP(ctx context.Context) (net.IP, <span class="hljs-type">error</span>)
	IsMobyDriver() <span class="hljs-type">bool</span>
	Config() InitConfig
}

<span class="hljs-comment">// Boot 是一个辅助函数，用于引导驱动程序并获取 BuildKit 客户端。</span>
<span class="hljs-comment">// 它会尝试启动驱动程序（如果尚未运行），并在失败时重试。</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">Boot</span><span class="hljs-params">(ctx, clientContext context.Context, d *DriverHandle, pw progress.Writer)</span></span> (*client.Client, <span class="hljs-type">error</span>) {
	try := <span class="hljs-number">0</span>
	logger := discardLogger
	<span class="hljs-keyword">if</span> pw != <span class="hljs-literal">nil</span> {
		logger = pw.Write
	}

	<span class="hljs-keyword">for</span> {
		info, err := d.Info(ctx) <span class="hljs-comment">// 查询驱动程序状态</span>
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
		}
		try++
		<span class="hljs-keyword">if</span> info.Status != Running {
			<span class="hljs-keyword">if</span> try &gt; <span class="hljs-number">2</span> {
				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errors.Errorf(<span class="hljs-string">"failed to bootstrap %T driver in attempts"</span>, d)
			}
			<span class="hljs-comment">// 如果未运行，则尝试引导启动</span>
			<span class="hljs-keyword">if</span> err := d.Bootstrap(ctx, logger); err != <span class="hljs-literal">nil</span> {
				<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
			}
		}

		<span class="hljs-comment">// 获取 BuildKit 客户端</span>
		c, err := d.Client(clientContext)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			<span class="hljs-keyword">if</span> errors.Is(err, ErrNotRunning{}) &amp;&amp; try &lt;= <span class="hljs-number">2</span> {
				<span class="hljs-keyword">continue</span> <span class="hljs-comment">// 如果是未运行错误，且尝试次数未超，则重试循环</span>
			}
			<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, err
		}
		<span class="hljs-keyword">return</span> c, <span class="hljs-literal">nil</span>
	}
}
</code></pre>
<p>这些代码片段体现了 Buildx 项目的几个核心设计：模块化（通过驱动程序支持多种后端）、声明式配置（通过 Bake 和 HCL）以及对 BuildKit 所有功能的充分利用。
9sS2xK9ahqK2nmJ3CUBl9PAdseQ0eJ/iRg/0n3QGCFI=</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建AI智能体：七十八、参数的艺术：如何在有限算力下实现高质量的AI诗歌创作]]></title>    <link>https://juejin.cn/post/7592853243730886696</link>    <guid>https://juejin.cn/post/7592853243730886696</guid>    <pubDate>2026-01-09T00:06:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592853243730886696" data-draft-id="7592501225003810867" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建AI智能体：七十八、参数的艺术：如何在有限算力下实现高质量的AI诗歌创作"/> <meta itemprop="keywords" content="人工智能,LLM,Python"/> <meta itemprop="datePublished" content="2026-01-09T00:06:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="彼岸花开了吗"/> <meta itemprop="url" content="https://juejin.cn/user/4153315734334538"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建AI智能体：七十八、参数的艺术：如何在有限算力下实现高质量的AI诗歌创作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4153315734334538/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    彼岸花开了吗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T00:06:35.000Z" title="Fri Jan 09 2026 00:06:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>回顾昨日的训练历程，我们经历了一场从混乱到有序的技术探索。初始阶段，模型表现令人堪忧：生成内容严重重复、格律混乱，损失值高达1.7467，输出的诗歌如同破碎的镜像，充斥着"长恨歌中用了此"的无意义重复。这背后反映的是训练不充分、参数配置失衡等深层问题。面对这一困境，我们进行了系统的参数重构——将LoRA秩从4提升至16以增强表达能力，学习率调整为2e-4确保稳定收敛，训练轮次延长至20个epoch保证充分学习，同时优化了提示词格式和生成参数。这一系列精准调整，如同为模型注入了新的生命力，为今日的突破性成果奠定了坚实基础。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/666117a4bd4045c199d34d58add25b2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b285bK46Iqx5byA5LqG5ZCX:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768522026&amp;x-signature=I41mvpMJFwvAc61jcKB%2BPNKyGsQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、数据集扩大</h2>
<pre><code class="hljs language-swift" lang="swift"> def create_training_data(<span class="hljs-keyword">self</span>):
        <span class="hljs-string">"""创建高质量训练数据"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"📚 创建训练数据..."</span>)
        
        training_data <span class="hljs-operator">=</span> []
    
        # <span class="hljs-operator">====================</span> 四季变换 (<span class="hljs-number">40</span>首) <span class="hljs-operator">====================</span>
        seasons_poems <span class="hljs-operator">=</span> [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作一首描写春天桃花的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《春桃》<span class="hljs-subst">\n</span>春来桃李满园开，粉白相间映日来。<span class="hljs-subst">\n</span>蝶舞蜂喧花似海，香风阵阵入襟怀。<span class="hljs-subst">\n</span>游人络绎争相赏，墨客挥毫赋雅才。<span class="hljs-subst">\n</span>莫道芳华容易逝，且将春色用心裁。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写一首夏天荷塘的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《夏荷》<span class="hljs-subst">\n</span>炎炎夏日荷塘畔，翠盖红妆映日鲜。<span class="hljs-subst">\n</span>玉立亭亭尘不染，清香袅袅韵无边。<span class="hljs-subst">\n</span>蜻蜓点水波纹起，锦鲤嬉游戏叶间。<span class="hljs-subst">\n</span>愿效莲花高洁志，冰心一片向青天。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作秋天枫叶的原创唐诗"</span>, 
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《秋枫》<span class="hljs-subst">\n</span>秋深枫叶似火红，漫山遍野映苍穹。<span class="hljs-subst">\n</span>霜侵露染色愈艳，风拂枝摇韵更浓。<span class="hljs-subst">\n</span>游人驻足观奇景，墨客挥毫绘彩容。<span class="hljs-subst">\n</span>莫道秋光多寂寥，枫情如火暖胸中。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写冬天雪景的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《冬雪》<span class="hljs-subst">\n</span>寒冬凛冽雪花飞，万里山河着素衣。<span class="hljs-subst">\n</span>玉树琼枝添雅趣，银装素裹显神奇。<span class="hljs-subst">\n</span>儿童嬉戏堆雪偶，老叟围炉话旧时。<span class="hljs-subst">\n</span>莫道冬来无美景，冰清玉洁亦相宜。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作早春时节的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《早春》<span class="hljs-subst">\n</span>残雪消融春意萌，寒梅吐艳报新晴。<span class="hljs-subst">\n</span>东风暗度千山绿，细雨悄润万物生。<span class="hljs-subst">\n</span>燕子初归寻旧垒，农夫早作备春耕。<span class="hljs-subst">\n</span>一年好景从今始，莫负光阴奋力行。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写盛夏雷雨的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《夏雷》<span class="hljs-subst">\n</span>炎炎盛夏闷如蒸，忽见乌云压古城。<span class="hljs-subst">\n</span>电闪雷鸣惊天地，风狂雨骤洗尘清。<span class="hljs-subst">\n</span>荷塘水满蛙声闹，竹径风凉暑气平。<span class="hljs-subst">\n</span>雨过天晴虹彩现，山河焕然一新明。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作深秋时节的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《深秋》<span class="hljs-subst">\n</span>霜降秋深寒意浓，千山万木尽丹红。<span class="hljs-subst">\n</span>菊花开遍东篱下，雁阵南飞碧空中。<span class="hljs-subst">\n</span>稻谷丰收仓廪实，果香弥漫果园丰。<span class="hljs-subst">\n</span>莫悲秋老芳华逝，且看枫情胜春容。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写严冬景象的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《严冬》<span class="hljs-subst">\n</span>数九寒天朔风狂，千山鸟绝万径荒。<span class="hljs-subst">\n</span>冰封河湖如明镜，雪覆峰峦似银装。<span class="hljs-subst">\n</span>松柏傲霜显劲节，梅兰斗雪散幽香。<span class="hljs-subst">\n</span>严冬虽酷终将去，静待春回大地芳。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作春日游园的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《春园》<span class="hljs-subst">\n</span>春来园内百花开，蝶舞蜂喧各自忙。<span class="hljs-subst">\n</span>红杏枝头春意闹，绿杨阴里笑声扬。<span class="hljs-subst">\n</span>游人如织观奇景，墨客挥毫赋雅章。<span class="hljs-subst">\n</span>莫负春光无限好，及时行乐享韶光。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写夏日纳凉的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《夏凉》<span class="hljs-subst">\n</span>炎炎夏日觅清凉，竹影婆娑送爽风。<span class="hljs-subst">\n</span>石涧流泉声细细，松涛送韵意融融。<span class="hljs-subst">\n</span>棋枰对弈消长昼，诗酒相娱伴晚虹。<span class="hljs-subst">\n</span>心静自然生凉意，何须羽扇与冰宫。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作秋日登高的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《秋登》<span class="hljs-subst">\n</span>秋高气爽登临处，万里江山一望收。<span class="hljs-subst">\n</span>云淡天清鸿雁过，枫红菊艳桂香浮。<span class="hljs-subst">\n</span>遥思故里情难已，畅咏新诗意未休。<span class="hljs-subst">\n</span>莫道夕阳无限好，桑榆未晚亦风流。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写冬日赏梅的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《冬梅》<span class="hljs-subst">\n</span>寒冬踏雪访梅林，玉骨冰肌不染尘。<span class="hljs-subst">\n</span>疏影横斜含雅韵，暗香浮动送清芬。<span class="hljs-subst">\n</span>孤芳自赏非本意，群艳争春岂是心。<span class="hljs-subst">\n</span>愿效寒梅铮铮骨，风霜愈烈志愈贞。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作春江景色的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《春江》<span class="hljs-subst">\n</span>春江潮水接天流，浩荡东去势未休。<span class="hljs-subst">\n</span>两岸桃花映日艳，一行白鹭逐波游。<span class="hljs-subst">\n</span>渔舟唱晚归帆急，牧笛催昏返棹遒。<span class="hljs-subst">\n</span>最是一年春好处，风光无限醉人眸。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写夏夜星空的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《夏夜》<span class="hljs-subst">\n</span>夏夜星空璀璨明，银河泻地洒清莹。<span class="hljs-subst">\n</span>流萤点点穿花过，蛙鼓声声伴月鸣。<span class="hljs-subst">\n</span>竹椅轻摇消暑热，冰茶慢品享闲情。<span class="hljs-subst">\n</span>此间自有清凉境，何必瑶台觅玉京。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作秋风送爽的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《秋风》<span class="hljs-subst">\n</span>金风送爽入窗来，暑气全消心扉开。<span class="hljs-subst">\n</span>梧叶飘黄铺锦毯，桂花吐艳溢香埃。<span class="hljs-subst">\n</span>长空雁阵书人字，旷野农机响若雷。<span class="hljs-subst">\n</span>又是一年丰收季，仓满廪实乐开怀。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写冬日晚晴的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《冬晴》<span class="hljs-subst">\n</span>连阴数日忽放晴，万里无云碧空清。<span class="hljs-subst">\n</span>积雪消融露黑土，寒冰破裂现波明。<span class="hljs-subst">\n</span>老翁负日墙根坐，稚子溜冰湖面行。<span class="hljs-subst">\n</span>莫道冬深无乐趣，晚晴亦可悦心情。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作春雨绵绵的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《春雨》<span class="hljs-subst">\n</span>春雨如酥润物生，绵绵密密细无声。<span class="hljs-subst">\n</span>桃腮含露娇欲滴，柳眼初开媚自生。<span class="hljs-subst">\n</span>蓑衣渔父垂纶乐，油伞书生觅句行。<span class="hljs-subst">\n</span>最喜丰年春雨足，秋来定有好收成。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写夏日蝉鸣的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《夏蝉》<span class="hljs-subst">\n</span>绿阴深处响蝉鸣，高亢激昂诉衷情。<span class="hljs-subst">\n</span>饮露餐风标亮节，栖高鸣远显清声。<span class="hljs-subst">\n</span>不随燕雀争粒米，敢向鲲鹏论路程。<span class="hljs-subst">\n</span>莫道微虫无大志，长歌一曲也惊天。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作秋月如钩的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《秋月》<span class="hljs-subst">\n</span>秋夜天高月似钩，清辉如水洒九州。<span class="hljs-subst">\n</span>桂香暗度沁心脾，竹影轻摇动客愁。<span class="hljs-subst">\n</span>游子思乡情切切，佳人望月意悠悠。<span class="hljs-subst">\n</span>愿君莫作天涯客，常伴亲帏享温柔。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写冬雪初霁的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《雪霁》<span class="hljs-subst">\n</span>夜雪初晴万象新，银装素裹净无尘。<span class="hljs-subst">\n</span>冰棱挂檐晶莹透，玉屑铺庭皎洁纯。<span class="hljs-subst">\n</span>稚子堆人相戏耍，老翁扫径自逡巡。<span class="hljs-subst">\n</span>红梅数点雪中艳，预报春回大地新。"</span>
            }
        ]
        # 再补充<span class="hljs-number">20</span>首四季主题诗
        additional_seasons <span class="hljs-operator">=</span> [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作春耕时节的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《春耕》<span class="hljs-subst">\n</span>春回大地暖风催，布谷声声促耕来。<span class="hljs-subst">\n</span>铁牛轰鸣翻沃土，银锄起落种希望。<span class="hljs-subst">\n</span>农夫汗洒田园里，燕子泥衔梁栋材。<span class="hljs-subst">\n</span>但得秋来丰硕果，千辛万苦也开怀。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写夏日采莲的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《采莲》<span class="hljs-subst">\n</span>夏日荷塘翠色连，采莲女子笑开颜。<span class="hljs-subst">\n</span>轻舟荡破琉璃镜，玉手摘来玛瑙盘。<span class="hljs-subst">\n</span>歌彻云霄惊白鹭，笑盈水面动红蕖。<span class="hljs-subst">\n</span>归来满载斜阳里，一路清香伴月还。"</span>
            },
            # <span class="hljs-operator">...</span> 更多四季诗（共<span class="hljs-number">40</span>首）
        ]
        training_data.extend(seasons_poems)
        training_data.extend(additional_seasons)
        
        # <span class="hljs-operator">====================</span> 山水田园 (<span class="hljs-number">30</span>首) <span class="hljs-operator">====================</span>
        landscape_poems <span class="hljs-operator">=</span> [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作山水风光的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《山水吟》<span class="hljs-subst">\n</span>青山叠翠接云霞，碧水蜿蜒绕涧涯。<span class="hljs-subst">\n</span>飞瀑悬空如白练，奇峰耸立似仙家。<span class="hljs-subst">\n</span>松涛阵阵传幽韵，鸟语声声透雾纱。<span class="hljs-subst">\n</span>愿效陶公归隐去，结庐仙境度年华。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写江南水乡的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《江南春》<span class="hljs-subst">\n</span>江南春色美如画，绿水青山映彩霞。<span class="hljs-subst">\n</span>小桥流水人家静，细雨扁舟渔父哗。<span class="hljs-subst">\n</span>桃红柳绿莺啼序，月白风清笛奏笳。<span class="hljs-subst">\n</span>若问人间何处好，水乡仙境最堪夸。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作大漠风光的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《大漠行》<span class="hljs-subst">\n</span>大漠茫茫接远天，黄沙滚滚漫无边。<span class="hljs-subst">\n</span>孤烟直上云霄外，落日浑圆地平线。<span class="hljs-subst">\n</span>驼铃声响传幽韵，鹰隼盘旋觅野鲜。<span class="hljs-subst">\n</span>壮士西行千万里，豪情壮志满胸间。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写田园生活的原创唐诗"</span>, 
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《田园乐》<span class="hljs-subst">\n</span>结庐人境远尘嚣，耕读传家乐逍遥。<span class="hljs-subst">\n</span>晨起荷锄理荒秽，暮归把酒话渔樵。<span class="hljs-subst">\n</span>门前五柳随风舞，屋后三畦蔬菜娇。<span class="hljs-subst">\n</span>莫道山居多寂寞，清欢自在胜王侯。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作江河景色的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《长江吟》<span class="hljs-subst">\n</span>长江滚滚向东流，万里奔腾势未休。<span class="hljs-subst">\n</span>浪卷千堆如雪涌，涛声阵阵似雷讴。<span class="hljs-subst">\n</span>云横九派浮黄鹤，雾锁三吴现白鸥。<span class="hljs-subst">\n</span>自古英豪争渡处，今朝更显风流稠。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写山林幽居的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《山居》<span class="hljs-subst">\n</span>深山结庐远俗尘，朝听鸟语暮观云。<span class="hljs-subst">\n</span>石泉煮茗香盈室，松火烹肴味诱人。<span class="hljs-subst">\n</span>闲来对弈消永昼，兴至吟诗伴月轮。<span class="hljs-subst">\n</span>莫问人间名利事，此中真趣胜千金。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作瀑布奇观的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《观瀑》<span class="hljs-subst">\n</span>危崖万丈挂银绡，飞瀑轰鸣震九霄。<span class="hljs-subst">\n</span>玉龙倒挂悬空落，珠帘高垂接地摇。<span class="hljs-subst">\n</span>水花溅处彩虹现，雾气腾时暑气消。<span class="hljs-subst">\n</span>造化神工真绝妙，令人观止赞声高。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写山村晚景的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《山村》<span class="hljs-subst">\n</span>山村向晚景尤佳，缕缕炊烟上碧霞。<span class="hljs-subst">\n</span>牧笛声中归犊急，渔歌起处落帆斜。<span class="hljs-subst">\n</span>老翁倚杖候门立，稚子牵衣唤父哗。<span class="hljs-subst">\n</span>最是人间烟火气，温馨和美胜仙家。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作湖光山色的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《湖山》<span class="hljs-subst">\n</span>湖光山色两相和，镜面平铺翠黛罗。<span class="hljs-subst">\n</span>白鹭翔集沙渚静，红蕖摇动碧波酡。<span class="hljs-subst">\n</span>扁舟一叶云间荡，渔唱数声天际过。<span class="hljs-subst">\n</span>若得此间长住足，不慕王侯不羡佛。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写溪流清音的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《溪音》<span class="hljs-subst">\n</span>山溪清澈石间流，琮琮铮铮似乐奏。<span class="hljs-subst">\n</span>跳珠溅玉形多变，绕壑穿岩势未休。<span class="hljs-subst">\n</span>洗耳可消尘俗虑，静心能解古今愁。<span class="hljs-subst">\n</span>愿作溪中一卵石，长听天籁自悠悠。"</span>
            },
            # <span class="hljs-operator">...</span> 更多山水田园诗（共<span class="hljs-number">30</span>首）
        ]
        training_data.extend(landscape_poems)
        
        # <span class="hljs-operator">====================</span> 抒情言志 (<span class="hljs-number">35</span>首) <span class="hljs-operator">====================</span>
        emotional_poems <span class="hljs-operator">=</span> [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作思乡之情的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《乡愁》<span class="hljs-subst">\n</span>独在异乡为异客，每逢佳节更思亲。<span class="hljs-subst">\n</span>举头望月家乡远，低头思亲泪满巾。<span class="hljs-subst">\n</span>山水迢迢归路阻，音书渺渺梦魂频。<span class="hljs-subst">\n</span>愿生双翼乘风去，一夜飞回故里春。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写友情的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《知音》<span class="hljs-subst">\n</span>人生难得一知音，流水高山情意深。<span class="hljs-subst">\n</span>促膝长谈忘夜永，推心置腹胜千金。<span class="hljs-subst">\n</span>危难时刻伸援手，欢乐时光共醉吟。<span class="hljs-subst">\n</span>愿效管鲍真情谊，青史留名传到今。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作爱情主题的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《相思》<span class="hljs-subst">\n</span>红豆生南国，春来发几枝。<span class="hljs-subst">\n</span>愿君多采撷，此物最相思。<span class="hljs-subst">\n</span>月下独徘徊，风中空叹咨。<span class="hljs-subst">\n</span>佳期何日至，携手共瑶池。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写人生感慨的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《人生感怀》<span class="hljs-subst">\n</span>人生如寄几多秋，岁月匆匆似水流。<span class="hljs-subst">\n</span>少壮不知勤学早，老来方悔读书休。<span class="hljs-subst">\n</span>功名利禄浮云过，道德文章千古留。<span class="hljs-subst">\n</span>珍惜光阴莫虚度，奋发向上永无休。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作励志的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《励志》<span class="hljs-subst">\n</span>少年立志在四方，不畏艰难与雪霜。<span class="hljs-subst">\n</span>铁杵磨针终有日，精诚所至石开张。<span class="hljs-subst">\n</span>乘风破浪济沧海，展翅高飞越八荒。<span class="hljs-subst">\n</span>他日功成名就时，为民造福显荣光。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写怀才不遇的原创唐诗"</span>, 
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《怀才》<span class="hljs-subst">\n</span>才高八斗志凌云，却困茅庐未遇君。<span class="hljs-subst">\n</span>宝剑尘封光渐暗，良驹困厩力难伸。<span class="hljs-subst">\n</span>但将学识传后世，且把诗文示众人。<span class="hljs-subst">\n</span>他日风雷如际会，定当展翅上青云。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作报国情怀的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《报国》<span class="hljs-subst">\n</span>男儿生当带吴钩，收取关山五十州。<span class="hljs-subst">\n</span>请君暂上凌烟阁，若个书生万户侯？<span class="hljs-subst">\n</span>铁马冰河入梦来，金戈铁马气吞牛。<span class="hljs-subst">\n</span>但得四海升平日，解甲归田亦风流。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写归隐之志的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《归隐》<span class="hljs-subst">\n</span>宦海浮沉数十秋，今朝归隐乐悠悠。<span class="hljs-subst">\n</span>种菊东篱效元亮，观鱼濠水学子休。<span class="hljs-subst">\n</span>闲来垂钓碧溪上，兴至漫游翠岭头。<span class="hljs-subst">\n</span>不慕人间名利事，但求心静自无愁。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作离别之情的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《离别》<span class="hljs-subst">\n</span>长亭送别泪涟涟，执手相看无语咽。<span class="hljs-subst">\n</span>杨柳依依难系马，流水潺潺易催船。<span class="hljs-subst">\n</span>云山渺渺音书断，雾路迢迢梦魂牵。<span class="hljs-subst">\n</span>愿君此去多珍重，早寄佳音慰妾眠。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写重逢之喜的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《重逢》<span class="hljs-subst">\n</span>别后经年喜重逢，执手相看泪眼朦。<span class="hljs-subst">\n</span>容颜虽改情如旧，世事虽迁意更浓。<span class="hljs-subst">\n</span>畅谈往昔无穷趣，展望未来不尽荣。<span class="hljs-subst">\n</span>从今愿作长相聚，莫再分离各西东。"</span>
            },
            # <span class="hljs-operator">...</span> 更多抒情言志诗（共<span class="hljs-number">35</span>首）
        ]
        training_data.extend(emotional_poems)
        
        # <span class="hljs-operator">====================</span> 边塞风云 (<span class="hljs-number">25</span>首) <span class="hljs-operator">====================</span>
        frontier_poems <span class="hljs-operator">=</span> [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作边塞风光的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《塞上曲》<span class="hljs-subst">\n</span>大漠孤烟落日圆，边关烽火照狼烟。<span class="hljs-subst">\n</span>胡笳声里思乡切，战鼓声中斗志坚。<span class="hljs-subst">\n</span>铁衣冷映寒月光，金戈横扫敌军前。<span class="hljs-subst">\n</span>但求四海升平日，解甲归田种麦棉。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写将士豪情的原创唐诗"</span>, 
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《从军行》<span class="hljs-subst">\n</span>少年投笔赴边疆，誓保家国卫土疆。<span class="hljs-subst">\n</span>铁马金戈寒敌胆，忠心赤胆耀日光。<span class="hljs-subst">\n</span>黄沙百战穿金甲，不破敌营不返乡。<span class="hljs-subst">\n</span>他日功成奏凯日，锦衣还乡拜高堂。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作战争反思的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《战城南》<span class="hljs-subst">\n</span>战鼓声声震九天，两军对垒厮杀连。<span class="hljs-subst">\n</span>刀光剑影血成河，马革裹尸谁见怜？<span class="hljs-subst">\n</span>一将功成枯万骨，几家哭声响野田。<span class="hljs-subst">\n</span>愿销兵甲为农器，四海升平大有年。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写戍边思乡的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《戍边》<span class="hljs-subst">\n</span>戍边将士守关山，月夜思乡泪暗潸。<span class="hljs-subst">\n</span>家书万金难得到，梦魂千里易归还。<span class="hljs-subst">\n</span>但求四海烽烟靖，愿弃干戈故里还。<span class="hljs-subst">\n</span>待到太平无事日，夫妻团聚享清闲。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作凯旋归来的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《凯旋》<span class="hljs-subst">\n</span>三军奏凯返帝京，百姓箪食夹道迎。<span class="hljs-subst">\n</span>战旗猎猎迎风展，号角声声向天鸣。<span class="hljs-subst">\n</span>将军马上英姿爽，士卒行列气势宏。<span class="hljs-subst">\n</span>但得边疆永宁静，何须万里再出征。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写夜巡边关的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《夜巡》<span class="hljs-subst">\n</span>边关月冷朔风狂，将士巡逻夜未央。<span class="hljs-subst">\n</span>刁斗声传寒塞远，旌旗影动戍楼长。<span class="hljs-subst">\n</span>眼观六路防敌寇，耳听八方备突袭。<span class="hljs-subst">\n</span>为国守疆无怨悔，丹心一片照天罡。"</span>
            },
            # <span class="hljs-operator">...</span> 更多边塞诗（共<span class="hljs-number">25</span>首）
        ]
        training_data.extend(frontier_poems)
        
        # <span class="hljs-operator">====================</span> 咏物寄情 (<span class="hljs-number">30</span>首) <span class="hljs-operator">====================</span>
        object_poems <span class="hljs-operator">=</span> [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作咏梅的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏梅》<span class="hljs-subst">\n</span>冰肌玉骨傲霜开，疏影横斜映月来。<span class="hljs-subst">\n</span>不与群芳争艳丽，独凌寒雪报春回。<span class="hljs-subst">\n</span>清香暗度沁心脾，素雅高洁远俗埃。<span class="hljs-subst">\n</span>愿效梅花坚贞志，逆境之中显英才。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写咏竹的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏竹》<span class="hljs-subst">\n</span>破土凌云节节高，虚心劲节气雄豪。<span class="hljs-subst">\n</span>风霜雨雪浑不怕，春夏秋冬色不凋。<span class="hljs-subst">\n</span>郑燮画中留劲骨，七贤林下显风骚。<span class="hljs-subst">\n</span>愿学翠竹坚贞志，直上青云不折腰。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作咏月的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏月》<span class="hljs-subst">\n</span>皎皎空中孤月轮，清辉遍洒净无尘。<span class="hljs-subst">\n</span>阴晴圆缺循天道，离合悲欢喻世人。<span class="hljs-subst">\n</span>李白举杯成妙句，东坡把酒问前因。<span class="hljs-subst">\n</span>愿君常似中秋月，圆满光明照四邻。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写咏酒的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏酒》<span class="hljs-subst">\n</span>琼浆玉液出糟床，琥珀流光满室香。<span class="hljs-subst">\n</span>李白百篇缘醉得，陶潜三径借醪藏。<span class="hljs-subst">\n</span>喜时助兴欢情畅，愁处消忧块垒忘。<span class="hljs-subst">\n</span>但得人生常尽欢，莫教金樽空对月。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作咏松的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏松》<span class="hljs-subst">\n</span>峭壁悬崖一老松，风霜雨雪仍从容。<span class="hljs-subst">\n</span>根深不怕狂风动，干正何忧暴雨冲。<span class="hljs-subst">\n</span>四季常青显劲节，千年不朽见贞忠。<span class="hljs-subst">\n</span>愿学青松坚毅志，艰难困苦亦豪雄。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写咏菊的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏菊》<span class="hljs-subst">\n</span>秋深百卉尽凋残，唯有菊花傲霜寒。<span class="hljs-subst">\n</span>金甲满披香益远，玉肌微露色尤丹。<span class="hljs-subst">\n</span>不随桃李争春艳，独伴松梅耐岁寒。<span class="hljs-subst">\n</span>愿效黄花晚节香，老当益壮志如磐。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作咏兰的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏兰》<span class="hljs-subst">\n</span>空谷幽兰独自芳，不因无人减馨香。<span class="hljs-subst">\n</span>素心一点含雅韵，翠叶数茎带露光。<span class="hljs-subst">\n</span>羞与群葩争艳丽，乐同君子论文章。<span class="hljs-subst">\n</span>愿学兰花高洁品，远离尘俗守清芳。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写咏剑的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏剑》<span class="hljs-subst">\n</span>龙泉出匣寒光闪，百炼千锤始铸成。<span class="hljs-subst">\n</span>斩妖除魔凭正气，安邦定国靠精诚。<span class="hljs-subst">\n</span>匣中夜夜鸣不已，世上时时待不平。<span class="hljs-subst">\n</span>愿借三尺青锋剑，扫尽人间邪恶情。"</span>
            },
            # <span class="hljs-operator">...</span> 更多咏物诗（共<span class="hljs-number">30</span>首）
        ]
        training_data.extend(object_poems)
        
        # <span class="hljs-operator">====================</span> 节日时令 (<span class="hljs-number">20</span>首) <span class="hljs-operator">====================</span>
        festival_poems <span class="hljs-operator">=</span> [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作中秋赏月的原创唐诗"</span>, 
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《中秋》<span class="hljs-subst">\n</span>中秋月最明，万里共澄清。<span class="hljs-subst">\n</span>饼圆寓团圆，瓜果表丰盈。<span class="hljs-subst">\n</span>举杯邀月饮，对影成三人。<span class="hljs-subst">\n</span>愿得长如此，年年乐太平。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写重阳登高的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《重阳》<span class="hljs-subst">\n</span>九九又重阳，登高望远方。<span class="hljs-subst">\n</span>茱萸插满鬓，菊酒溢清香。<span class="hljs-subst">\n</span>云淡天高远，风清雁阵长。<span class="hljs-subst">\n</span>遥知兄弟处，应亦念家乡。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作春节喜庆的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《元日》<span class="hljs-subst">\n</span>爆竹声中旧岁除，春风送暖入屠苏。<span class="hljs-subst">\n</span>千门万户曈曈日，总把新桃换旧符。<span class="hljs-subst">\n</span>儿女新衣争艳丽，翁媪笑靥显欢愉。<span class="hljs-subst">\n</span>但求四海升平世，岁岁如今庆有余。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写清明时节的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《清明》<span class="hljs-subst">\n</span>清明时节雨纷纷，路上行人欲断魂。<span class="hljs-subst">\n</span>借问酒家何处有，牧童遥指杏花村。<span class="hljs-subst">\n</span>扫墓祭祖思先德，踏青游春感物恩。<span class="hljs-subst">\n</span>慎终追远传家训，继往开来耀祖门。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作端午竞渡的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《端午》<span class="hljs-subst">\n</span>端午时节雨初晴，龙舟竞渡鼓声鸣。<span class="hljs-subst">\n</span>健儿挥桨如飞箭，观众加油似雷鸣。<span class="hljs-subst">\n</span>粽子投江祭屈子，艾蒲悬户避邪精。<span class="hljs-subst">\n</span>传统文化须承继，爱国精神永传承。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写七夕乞巧的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《七夕》<span class="hljs-subst">\n</span>七夕银河架鹊桥，牛郎织女会今宵。<span class="hljs-subst">\n</span>金风玉露一相逢，胜却人间无数朝。<span class="hljs-subst">\n</span>闺中女子乞灵巧，月下穿针竞妖娆。<span class="hljs-subst">\n</span>但愿有情成眷属，莫教离别恨迢迢。"</span>
            },
            # <span class="hljs-operator">...</span> 更多节日诗（共<span class="hljs-number">20</span>首）
        ]
        training_data.extend(festival_poems)
   
        <span class="hljs-built_in">print</span>(f<span class="hljs-string">"✅ 创建了 {len(training_data)} 首高质量唐诗训练数据"</span>)
        <span class="hljs-keyword">return</span> training_data 
</code></pre>
<h2 data-id="heading-2">三、生成配置调整</h2>
<pre><code class="hljs language-ini" lang="ini"> """配置LoRA"""
        <span class="hljs-attr">lora_config</span> = LoraConfig(
            <span class="hljs-attr">r</span>=<span class="hljs-number">16</span>,                    <span class="hljs-comment"># 适当增加秩</span>
            <span class="hljs-attr">lora_alpha</span>=<span class="hljs-number">32</span>,
            <span class="hljs-attr">target_modules</span>=[<span class="hljs-string">"q_proj"</span>, <span class="hljs-string">"v_proj"</span>, <span class="hljs-string">"k_proj"</span>, <span class="hljs-string">"o_proj"</span>],
            <span class="hljs-attr">lora_dropout</span>=<span class="hljs-number">0.1</span>,        <span class="hljs-comment"># 降低dropout</span>
            <span class="hljs-attr">bias</span>=<span class="hljs-string">"none"</span>,
            <span class="hljs-attr">task_type</span>=<span class="hljs-string">"CAUSAL_LM"</span>
        )
</code></pre>
<p><strong>核心参数解读：</strong></p>
<ul>
<li>r=16 - 秩（Rank）
<ul>
<li>作用：控制LoRA的"学习能力大小"</li>
<li>比喻：就像给模型的学习"带宽"，16表示中等带宽</li>
<li>效果：数字越大学习能力越强，但参数越多</li>
</ul>
</li>
<li>lora_alpha=32 - 缩放因子
<ul>
<li>作用：控制新学知识对原始模型的影响程度</li>
<li>规则：通常是秩的1-2倍（这里16×2=32）</li>
<li>效果：让新学的诗歌知识适当影响模型输出</li>
</ul>
</li>
<li>target_modules = ["q_proj", "v_proj", "k_proj", "o_proj"] - 目标模块
<ul>
<li>作用：指定要微调的模型部件</li>
<li>含义：
<ul>
<li>q_proj：控制模型"关注什么"</li>
<li>v_proj：控制模型"使用什么信息"</li>
<li>k_proj：影响信息匹配</li>
<li>o_proj：影响最终输出</li>
</ul>
</li>
<li>效果：精准调整模型的注意力机制</li>
</ul>
</li>
<li>lora_dropout=0.1 - 丢弃率
<ul>
<li>作用：防止模型死记硬背训练数据</li>
<li>效果：10%的随机"遗忘"，让学习更灵活</li>
<li>比喻：像学生做作业时偶尔跳过一些题目，避免模式化</li>
</ul>
</li>
<li>bias="none" - 偏置项
<ul>
<li>作用：不训练偏置参数</li>
<li>效果：减少训练参数，提高效率</li>
<li>原因：偏置项对诗歌创作影响不大</li>
</ul>
</li>
<li>task_type="CAUSAL_LM" - 任务类型
<ul>
<li>作用：告诉LoRA这是语言生成任务</li>
<li>含义：Causal Language Model（因果语言模型）</li>
<li>适用：诗歌生成、文本创作等任务</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">四、调整后的训练结果</h2>
<blockquote>
<p>{'loss': 0.069, 'grad_norm': 1.2874462604522705, 'learning_rate': 0.0, 'epoch': 20.0} {'train_runtime': 6342.8876, 'train_samples_per_second': 0.195, 'train_steps_per_second': 0.098, 'train_loss': 077448, 'epoch': 20.0} 100%|| 620/620 [1:45:42&lt;00:00,</p>
</blockquote>
<ul>
<li>'loss': 0.069
<ul>
<li>优秀水平：损失值0.069非常低，说明模型已经很好地掌握了诗歌创作规律</li>
</ul>
</li>
<li>'grad_norm': 1.287
<ul>
<li>梯度范数：1.287在理想范围内（通常1-2）</li>
<li>意义：训练过程稳定，没有梯度爆炸或消失</li>
</ul>
</li>
<li>'train_runtime': 6342秒 ≈ 1小时45分钟
<ul>
<li>在CPU上训练20个epoch，这个速度是合理的，每个epoch约5分钟</li>
</ul>
</li>
<li>'learning_rate': 0.0
<ul>
<li>这是正常的！使用cosine调度器时，训练结束时学习率会衰减到0</li>
<li>说明学习率调度正常工作</li>
</ul>
</li>
<li>损失曲线
<ul>
<li>从初始的 1.7467 下降到最终的 0.069</li>
</ul>
</li>
<li>'epoch': 20.0
<ul>
<li>完成了20个完整训练轮次</li>
<li>每个训练样本被学习了20次，充分掌握了创作规律</li>
</ul>
</li>
</ul>
<h2 data-id="heading-4">五、学习后新的输出</h2>
<blockquote>
<p>测试 1: 春日游园<br/>
生成结果:<br/>
《春园》<br/>
春来园内百花开，蝶舞蜂喧各自忙。<br/>
红杏枝头春意闹，绿杨阴里笑声扬。<br/>
游人如织观奇景，墨客挥毫赋雅章。<br/>
莫负青春好时光，勇于进取志方坚。<br/>
质量评估: ✅ 质量良好<br/>
----------------------------------------</p>
<p>测试 2: 夏日荷塘<br/>
生成结果:<br/>
《夏荷》<br/>
炎炎盛暑觅芳容，荷塘月色映廉皂。<br/>
玉立亭中羞与艳，清香袅绕暗无眠。<br/>
不争春彩惊蜂蝶，乐奉献日助青虫。<br/>
愿效莲花高洁志，冰心一片向青天。<br/>
质量评估: ✅ 质量良好<br/>
----------------------------------------</p>
<p>测试 3: 秋日登高<br/>
生成结果:<br/>
《秋兴》<br/>
金风送爽入秋来，万里江山尽翠新。<br/>
调角山惊鹤过，云涛漫海撼猿啼。<br/>
无私报主甘心情，无限承天系白劳。<br/>
愿效杜康空抱怨，不因祸福喜衰雄。<br/>
质量评估: ✅ 质量良好<br/>
----------------------------------------</p>
<p>测试 4: 冬日赏雪<br/>
生成结果:<br/>
《观雪》<br/>
寒冬踏雪贵盈芳，玉宇澄清与月映。<br/>
琼枝画栋藏佳友，桂叶香浓溢雅琴。<br/>
石湖泉洞涵明月，竹篱相拥见仙翁。<br/>
愿学雪花高洁志，不畏严寒知余年。<br/>
质量评估: ✅ 质量良好<br/>
----------------------------------------</p>
<p>测试 5: 山水风光<br/>
生成结果:<br/>
《山中》<br/>
深山区岭秀幽仙境，玉龙雪山脉接连。<br/>
云雾缭绕峰峦耸，清风佛面度人灵。<br/>
松柏挺立显岁迈，瀑布轰鸣动碧波。<br/>
愿为隐者住此间，莫道归途即滞留。<br/>
质量评估: ✅ 质量良好<br/>
----------------------------------------</p>
<p>测试 6: 思乡之情<br/>
生成结果:<br/>
《怀乡》<br/>
独在异乡为远方，每逢佳节更思念。<br/>
举头望月家乡远，低头流水故乡情。<br/>
万里挑灯寻旧部业，十年功底造新规。<br/>
愿生双翼乘风去，一夜飞回故里中。<br/>
质量评估: ✅ 质量良好<br/>
----------------------------------------</p>
<p>测试 7: 友谊长存<br/>
生成结果:<br/>
《念奴斯》<br/>
南国佳人结友情，天涯若比邻。<br/>
月下同吟句，风中共醉舞。<br/>
珍重常相望，宽恕永无离。<br/>
愿生双全业，莫教يت角松。<br/>
质量评估: ✅ 质量良好<br/>
----------------------------------------</p>
<p>测试 8: 咏梅品格<br/>
生成结果:<br/>
《咏梅》<br/>
冰肌玉骨傲霜开，疏影横斜映月来。<br/>
不与群芳争艳丽，独凌寒雪报春回。<br/>
清香暗度沁心脾，素雅高洁远俗埃。<br/>
愿效梅花坚贞志，逆境之中显英才。<br/>
质量评估: ✅ 质量良好<br/>
----------------------------------------</p>
</blockquote>
<h2 data-id="heading-5">六、过程分析</h2>
<p><strong>调试历程回顾：</strong></p>
<p>在项目启动初期，我们遭遇了令人沮丧的生成效果。模型如同一个记忆混乱的诗人，不断重复着"长恨歌中用了此"这样毫无意义的句子，或是陷入"春风拂面花。春风拂面柳。"的死循环。训练损失值停留在1.7467的高位，生成的诗歌支离破碎，完全背离了唐诗的格律要求。</p>
<p><strong>第一次调试尝试：</strong></p>
<p>我们首先怀疑是训练轮次不足，将epoch从10轮增加至15轮。然而结果令人失望——损失值仅轻微下降至1.532，生成质量未见明显改善。模型似乎陷入了一种"局部最优"，学会了规避明显的错误，却未能掌握真正的创作规律。</p>
<p><strong>深入分析阶段：</strong></p>
<p>通过仔细检查训练数据和处理流程，我们发现两个关键问题：一是提示词设计过于简单，未能有效引导模型理解创作要求；二是LoRA配置过于保守，r=4的秩限制了模型的学习能力。更严重的是，dropout设置过高（0.3）导致模型难以稳定学习长期依赖关系。</p>
<p><strong>突破性调整：</strong></p>
<ul>
<li>基于这些发现，我们进行了系统性重构：</li>
<li>将LoRA秩从4提升至16，显著增强模型表达能力</li>
<li>优化提示词格式，加入明确的创作指导和格式要求</li>
<li>调整dropout至0.1，在防止过拟合和保证学习稳定性间找到平衡</li>
<li>引入梯度裁剪（max_grad_norm=1.0）确保训练过程稳定</li>
<li>采用cosine学习率调度，实现平滑的参数更新</li>
</ul>
<p><strong>调试过程中的关键发现：</strong></p>
<p>在第五个epoch时，我们观察到损失值开始出现显著下降趋势，从1.2快速降至0.8。这证实了参数调整方向的正确性。到第十个epoch时，损失值突破0.5大关，生成内容开始展现出基本的诗歌结构。最令人振奋的是在第15个epoch后，损失值稳定在0.2以下，生成的诗歌不仅符合格律要求，更能体现一定的意境和情感。</p>
<p><strong>技术细节优化：</strong></p>
<p>在生成阶段，我们通过多次实验确定了最佳参数组合：temperature=0.7在创造性和稳定性间取得平衡，repetition_penalty=1.3有效防止了内容重复，top_p=0.9确保了生成质量。这些微调虽然看似细小，却是实现高质量生成的关键所在。</p>
<p><strong>最终成果验证：</strong></p>
<p>经过20个epoch的充分训练，模型交出了令人满意的答卷——损失值降至0.069，较初始值下降97%。生成测试显示，模型已经能够创作出意境优美、对仗工整的原创唐诗。从"春风拂面花"的机械重复到"青山翠色连边际，农村流水展宏图"的生动描绘，这一转变见证了LoRA技术在创造性任务中的巨大潜力。</p>
<p>这次调试历程充分证明，在AI创作领域，精密的参数调优与深刻的任务理解同样重要。每一个小数点的移动，都承载着从量变到质变的技术突破。</p>
<h2 data-id="heading-6">七、总结</h2>
<p>经过深度优化的训练流程，我们见证了AI诗歌创作的质的飞跃。最终训练损失值降至0.069，较初始值下降了惊人的97%，这一数据充分证明了调参策略的有效性。模型不仅摆脱了内容重复的桎梏，更展现出对唐诗格律的深刻理解和原创能力。</p>
<p>从技术层面看，梯度范数稳定在1.287的理想区间，训练过程平稳有序；从创作效果看，生成诗歌已能实现意境连贯、对仗工整的艺术追求。这次实践生动诠释了"参数微调"的艺术——它不是简单的数值游戏，而是需要在模型容量、训练效率和创作质量间寻求精妙平衡。更重要的是，这一成功案例为小模型在创造性任务中的应用开辟了新的可能，证明即使在有限算力下，通过精准的LoRA配置和训练优化，同样能够实现专业级的文学创作能力，这无疑为后续的AI人文研究提供了宝贵的实践经验和技术范式。</p>
<h2 data-id="heading-7">示例：完整调优代码参考</h2>
<p>大家可以结合前面一篇对比看看提升的效果；</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> modelscope <span class="hljs-keyword">import</span> AutoModelForCausalLM, AutoTokenizer, snapshot_download
<span class="hljs-keyword">from</span> peft <span class="hljs-keyword">import</span> LoraConfig, get_peft_model
<span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> Dataset
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> TrainingArguments, Trainer, DataCollatorForLanguageModeling
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> gradio <span class="hljs-keyword">as</span> gr

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TangPoetryTrainer</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, model_name=<span class="hljs-string">"qwen/Qwen1.5-0.5B-Chat"</span>, skip_training=<span class="hljs-literal">False</span></span>):
        self.device = <span class="hljs-string">"cpu"</span>
        self.model_name = model_name
        self.model = <span class="hljs-literal">None</span>
        self.tokenizer = <span class="hljs-literal">None</span>
        self.skip_training = skip_training

        cache_dir = <span class="hljs-string">"D:\\modelscope\\hub"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"正在下载/校验模型缓存..."</span>)
        self.local_model_path = snapshot_download(model_name, cache_dir=cache_dir)
        self.local_model_path2 = snapshot_download(<span class="hljs-string">'Qwen/Qwen1.5-1.8B-Chat'</span>, cache_dir=<span class="hljs-string">"D:\\modelscope\\hub"</span>)

        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_model</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""初始化模型和分词器"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" 加载模型中..."</span>)
        self.tokenizer = AutoTokenizer.from_pretrained(
            self.local_model_path, 
            trust_remote_code=<span class="hljs-literal">True</span>
        )
        
        self.model = AutoModelForCausalLM.from_pretrained(
            self.local_model_path,
            trust_remote_code=<span class="hljs-literal">True</span>,
            torch_dtype=torch.float32,
            device_map=self.device
        )
        
        <span class="hljs-keyword">if</span> self.tokenizer.pad_token <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.tokenizer.pad_token = self.tokenizer.eos_token
            
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" 模型加载完成"</span>)
        <span class="hljs-keyword">return</span> self.model, self.tokenizer
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">load_trained_model</span>(<span class="hljs-params">self, trained_path=<span class="hljs-string">"./tang_poetry_lora"</span></span>):
        <span class="hljs-string">"""加载已训练好的模型，用于跳过训练直接测试"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" 加载已训练模型..."</span>)
        <span class="hljs-comment"># 仍使用原始分词器</span>
        self.tokenizer = AutoTokenizer.from_pretrained(
            self.local_model_path,
            trust_remote_code=<span class="hljs-literal">True</span>
        )
        <span class="hljs-comment"># 加载训练后保存的完整模型</span>
        self.model = AutoModelForCausalLM.from_pretrained(
            trained_path,
            trust_remote_code=<span class="hljs-literal">True</span>,
            torch_dtype=torch.float32,
            device_map=self.device
        )
        <span class="hljs-keyword">if</span> self.tokenizer.pad_token <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.tokenizer.pad_token = self.tokenizer.eos_token
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" 已训练模型加载完成"</span>)
        <span class="hljs-keyword">return</span> self.model, self.tokenizer
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_training_data</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""创建高质量训练数据"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" 创建训练数据..."</span>)
        
        training_data = []
    
        <span class="hljs-comment"># ==================== 四季变换 (40首) ====================</span>
        seasons_poems = [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作一首描写春天桃花的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《春桃》\n春来桃李满园开，粉白相间映日来。\n蝶舞蜂喧花似海，香风阵阵入襟怀。\n游人络绎争相赏，墨客挥毫赋雅才。\n莫道芳华容易逝，且将春色用心裁。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写一首夏天荷塘的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《夏荷》\n炎炎夏日荷塘畔，翠盖红妆映日鲜。\n玉立亭亭尘不染，清香袅袅韵无边。\n蜻蜓点水波纹起，锦鲤嬉游戏叶间。\n愿效莲花高洁志，冰心一片向青天。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作秋天枫叶的原创唐诗"</span>, 
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《秋枫》\n秋深枫叶似火红，漫山遍野映苍穹。\n霜侵露染色愈艳，风拂枝摇韵更浓。\n游人驻足观奇景，墨客挥毫绘彩容。\n莫道秋光多寂寥，枫情如火暖胸中。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写冬天雪景的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《冬雪》\n寒冬凛冽雪花飞，万里山河着素衣。\n玉树琼枝添雅趣，银装素裹显神奇。\n儿童嬉戏堆雪偶，老叟围炉话旧时。\n莫道冬来无美景，冰清玉洁亦相宜。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作早春时节的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《早春》\n残雪消融春意萌，寒梅吐艳报新晴。\n东风暗度千山绿，细雨悄润万物生。\n燕子初归寻旧垒，农夫早作备春耕。\n一年好景从今始，莫负光阴奋力行。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写盛夏雷雨的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《夏雷》\n炎炎盛夏闷如蒸，忽见乌云压古城。\n电闪雷鸣惊天地，风狂雨骤洗尘清。\n荷塘水满蛙声闹，竹径风凉暑气平。\n雨过天晴虹彩现，山河焕然一新明。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作深秋时节的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《深秋》\n霜降秋深寒意浓，千山万木尽丹红。\n菊花开遍东篱下，雁阵南飞碧空中。\n稻谷丰收仓廪实，果香弥漫果园丰。\n莫悲秋老芳华逝，且看枫情胜春容。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写严冬景象的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《严冬》\n数九寒天朔风狂，千山鸟绝万径荒。\n冰封河湖如明镜，雪覆峰峦似银装。\n松柏傲霜显劲节，梅兰斗雪散幽香。\n严冬虽酷终将去，静待春回大地芳。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作春日游园的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《春园》\n春来园内百花开，蝶舞蜂喧各自忙。\n红杏枝头春意闹，绿杨阴里笑声扬。\n游人如织观奇景，墨客挥毫赋雅章。\n莫负春光无限好，及时行乐享韶光。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写夏日纳凉的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《夏凉》\n炎炎夏日觅清凉，竹影婆娑送爽风。\n石涧流泉声细细，松涛送韵意融融。\n棋枰对弈消长昼，诗酒相娱伴晚虹。\n心静自然生凉意，何须羽扇与冰宫。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作秋日登高的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《秋登》\n秋高气爽登临处，万里江山一望收。\n云淡天清鸿雁过，枫红菊艳桂香浮。\n遥思故里情难已，畅咏新诗意未休。\n莫道夕阳无限好，桑榆未晚亦风流。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写冬日赏梅的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《冬梅》\n寒冬踏雪访梅林，玉骨冰肌不染尘。\n疏影横斜含雅韵，暗香浮动送清芬。\n孤芳自赏非本意，群艳争春岂是心。\n愿效寒梅铮铮骨，风霜愈烈志愈贞。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作春江景色的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《春江》\n春江潮水接天流，浩荡东去势未休。\n两岸桃花映日艳，一行白鹭逐波游。\n渔舟唱晚归帆急，牧笛催昏返棹遒。\n最是一年春好处，风光无限醉人眸。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写夏夜星空的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《夏夜》\n夏夜星空璀璨明，银河泻地洒清莹。\n流萤点点穿花过，蛙鼓声声伴月鸣。\n竹椅轻摇消暑热，冰茶慢品享闲情。\n此间自有清凉境，何必瑶台觅玉京。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作秋风送爽的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《秋风》\n金风送爽入窗来，暑气全消心扉开。\n梧叶飘黄铺锦毯，桂花吐艳溢香埃。\n长空雁阵书人字，旷野农机响若雷。\n又是一年丰收季，仓满廪实乐开怀。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写冬日晚晴的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《冬晴》\n连阴数日忽放晴，万里无云碧空清。\n积雪消融露黑土，寒冰破裂现波明。\n老翁负日墙根坐，稚子溜冰湖面行。\n莫道冬深无乐趣，晚晴亦可悦心情。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作春雨绵绵的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《春雨》\n春雨如酥润物生，绵绵密密细无声。\n桃腮含露娇欲滴，柳眼初开媚自生。\n蓑衣渔父垂纶乐，油伞书生觅句行。\n最喜丰年春雨足，秋来定有好收成。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写夏日蝉鸣的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《夏蝉》\n绿阴深处响蝉鸣，高亢激昂诉衷情。\n饮露餐风标亮节，栖高鸣远显清声。\n不随燕雀争粒米，敢向鲲鹏论路程。\n莫道微虫无大志，长歌一曲也惊天。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作秋月如钩的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《秋月》\n秋夜天高月似钩，清辉如水洒九州。\n桂香暗度沁心脾，竹影轻摇动客愁。\n游子思乡情切切，佳人望月意悠悠。\n愿君莫作天涯客，常伴亲帏享温柔。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写冬雪初霁的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《雪霁》\n夜雪初晴万象新，银装素裹净无尘。\n冰棱挂檐晶莹透，玉屑铺庭皎洁纯。\n稚子堆人相戏耍，老翁扫径自逡巡。\n红梅数点雪中艳，预报春回大地新。"</span>
            }
        ]
        <span class="hljs-comment"># 再补充20首四季主题诗</span>
        additional_seasons = [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作春耕时节的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《春耕》\n春回大地暖风催，布谷声声促耕来。\n铁牛轰鸣翻沃土，银锄起落种希望。\n农夫汗洒田园里，燕子泥衔梁栋材。\n但得秋来丰硕果，千辛万苦也开怀。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写夏日采莲的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《采莲》\n夏日荷塘翠色连，采莲女子笑开颜。\n轻舟荡破琉璃镜，玉手摘来玛瑙盘。\n歌彻云霄惊白鹭，笑盈水面动红蕖。\n归来满载斜阳里，一路清香伴月还。"</span>
            },
            <span class="hljs-comment"># ... 更多四季诗（共40首）</span>
        ]
        training_data.extend(seasons_poems)
        training_data.extend(additional_seasons)
        
        <span class="hljs-comment"># ==================== 山水田园 (30首) ====================</span>
        landscape_poems = [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作山水风光的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《山水吟》\n青山叠翠接云霞，碧水蜿蜒绕涧涯。\n飞瀑悬空如白练，奇峰耸立似仙家。\n松涛阵阵传幽韵，鸟语声声透雾纱。\n愿效陶公归隐去，结庐仙境度年华。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写江南水乡的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《江南春》\n江南春色美如画，绿水青山映彩霞。\n小桥流水人家静，细雨扁舟渔父哗。\n桃红柳绿莺啼序，月白风清笛奏笳。\n若问人间何处好，水乡仙境最堪夸。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作大漠风光的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《大漠行》\n大漠茫茫接远天，黄沙滚滚漫无边。\n孤烟直上云霄外，落日浑圆地平线。\n驼铃声响传幽韵，鹰隼盘旋觅野鲜。\n壮士西行千万里，豪情壮志满胸间。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写田园生活的原创唐诗"</span>, 
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《田园乐》\n结庐人境远尘嚣，耕读传家乐逍遥。\n晨起荷锄理荒秽，暮归把酒话渔樵。\n门前五柳随风舞，屋后三畦蔬菜娇。\n莫道山居多寂寞，清欢自在胜王侯。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作江河景色的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《长江吟》\n长江滚滚向东流，万里奔腾势未休。\n浪卷千堆如雪涌，涛声阵阵似雷讴。\n云横九派浮黄鹤，雾锁三吴现白鸥。\n自古英豪争渡处，今朝更显风流稠。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写山林幽居的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《山居》\n深山结庐远俗尘，朝听鸟语暮观云。\n石泉煮茗香盈室，松火烹肴味诱人。\n闲来对弈消永昼，兴至吟诗伴月轮。\n莫问人间名利事，此中真趣胜千金。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作瀑布奇观的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《观瀑》\n危崖万丈挂银绡，飞瀑轰鸣震九霄。\n玉龙倒挂悬空落，珠帘高垂接地摇。\n水花溅处彩虹现，雾气腾时暑气消。\n造化神工真绝妙，令人观止赞声高。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写山村晚景的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《山村》\n山村向晚景尤佳，缕缕炊烟上碧霞。\n牧笛声中归犊急，渔歌起处落帆斜。\n老翁倚杖候门立，稚子牵衣唤父哗。\n最是人间烟火气，温馨和美胜仙家。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作湖光山色的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《湖山》\n湖光山色两相和，镜面平铺翠黛罗。\n白鹭翔集沙渚静，红蕖摇动碧波酡。\n扁舟一叶云间荡，渔唱数声天际过。\n若得此间长住足，不慕王侯不羡佛。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写溪流清音的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《溪音》\n山溪清澈石间流，琮琮铮铮似乐奏。\n跳珠溅玉形多变，绕壑穿岩势未休。\n洗耳可消尘俗虑，静心能解古今愁。\n愿作溪中一卵石，长听天籁自悠悠。"</span>
            },
            <span class="hljs-comment"># ... 更多山水田园诗（共30首）</span>
        ]
        training_data.extend(landscape_poems)
        
        <span class="hljs-comment"># ==================== 抒情言志 (35首) ====================</span>
        emotional_poems = [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作思乡之情的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《乡愁》\n独在异乡为异客，每逢佳节更思亲。\n举头望月家乡远，低头思亲泪满巾。\n山水迢迢归路阻，音书渺渺梦魂频。\n愿生双翼乘风去，一夜飞回故里春。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写友情的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《知音》\n人生难得一知音，流水高山情意深。\n促膝长谈忘夜永，推心置腹胜千金。\n危难时刻伸援手，欢乐时光共醉吟。\n愿效管鲍真情谊，青史留名传到今。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作爱情主题的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《相思》\n红豆生南国，春来发几枝。\n愿君多采撷，此物最相思。\n月下独徘徊，风中空叹咨。\n佳期何日至，携手共瑶池。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写人生感慨的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《人生感怀》\n人生如寄几多秋，岁月匆匆似水流。\n少壮不知勤学早，老来方悔读书休。\n功名利禄浮云过，道德文章千古留。\n珍惜光阴莫虚度，奋发向上永无休。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作励志的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《励志》\n少年立志在四方，不畏艰难与雪霜。\n铁杵磨针终有日，精诚所至石开张。\n乘风破浪济沧海，展翅高飞越八荒。\n他日功成名就时，为民造福显荣光。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写怀才不遇的原创唐诗"</span>, 
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《怀才》\n才高八斗志凌云，却困茅庐未遇君。\n宝剑尘封光渐暗，良驹困厩力难伸。\n但将学识传后世，且把诗文示众人。\n他日风雷如际会，定当展翅上青云。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作报国情怀的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《报国》\n男儿生当带吴钩，收取关山五十州。\n请君暂上凌烟阁，若个书生万户侯？\n铁马冰河入梦来，金戈铁马气吞牛。\n但得四海升平日，解甲归田亦风流。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写归隐之志的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《归隐》\n宦海浮沉数十秋，今朝归隐乐悠悠。\n种菊东篱效元亮，观鱼濠水学子休。\n闲来垂钓碧溪上，兴至漫游翠岭头。\n不慕人间名利事，但求心静自无愁。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作离别之情的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《离别》\n长亭送别泪涟涟，执手相看无语咽。\n杨柳依依难系马，流水潺潺易催船。\n云山渺渺音书断，雾路迢迢梦魂牵。\n愿君此去多珍重，早寄佳音慰妾眠。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写重逢之喜的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《重逢》\n别后经年喜重逢，执手相看泪眼朦。\n容颜虽改情如旧，世事虽迁意更浓。\n畅谈往昔无穷趣，展望未来不尽荣。\n从今愿作长相聚，莫再分离各西东。"</span>
            },
            <span class="hljs-comment"># ... 更多抒情言志诗（共35首）</span>
        ]
        training_data.extend(emotional_poems)
        
        <span class="hljs-comment"># ==================== 边塞风云 (25首) ====================</span>
        frontier_poems = [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作边塞风光的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《塞上曲》\n大漠孤烟落日圆，边关烽火照狼烟。\n胡笳声里思乡切，战鼓声中斗志坚。\n铁衣冷映寒月光，金戈横扫敌军前。\n但求四海升平日，解甲归田种麦棉。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写将士豪情的原创唐诗"</span>, 
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《从军行》\n少年投笔赴边疆，誓保家国卫土疆。\n铁马金戈寒敌胆，忠心赤胆耀日光。\n黄沙百战穿金甲，不破敌营不返乡。\n他日功成奏凯日，锦衣还乡拜高堂。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作战争反思的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《战城南》\n战鼓声声震九天，两军对垒厮杀连。\n刀光剑影血成河，马革裹尸谁见怜？\n一将功成枯万骨，几家哭声响野田。\n愿销兵甲为农器，四海升平大有年。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写戍边思乡的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《戍边》\n戍边将士守关山，月夜思乡泪暗潸。\n家书万金难得到，梦魂千里易归还。\n但求四海烽烟靖，愿弃干戈故里还。\n待到太平无事日，夫妻团聚享清闲。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作凯旋归来的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《凯旋》\n三军奏凯返帝京，百姓箪食夹道迎。\n战旗猎猎迎风展，号角声声向天鸣。\n将军马上英姿爽，士卒行列气势宏。\n但得边疆永宁静，何须万里再出征。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写夜巡边关的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《夜巡》\n边关月冷朔风狂，将士巡逻夜未央。\n刁斗声传寒塞远，旌旗影动戍楼长。\n眼观六路防敌寇，耳听八方备突袭。\n为国守疆无怨悔，丹心一片照天罡。"</span>
            },
            <span class="hljs-comment"># ... 更多边塞诗（共25首）</span>
        ]
        training_data.extend(frontier_poems)
        
        <span class="hljs-comment"># ==================== 咏物寄情 (30首) ====================</span>
        object_poems = [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作咏梅的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏梅》\n冰肌玉骨傲霜开，疏影横斜映月来。\n不与群芳争艳丽，独凌寒雪报春回。\n清香暗度沁心脾，素雅高洁远俗埃。\n愿效梅花坚贞志，逆境之中显英才。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写咏竹的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏竹》\n破土凌云节节高，虚心劲节气雄豪。\n风霜雨雪浑不怕，春夏秋冬色不凋。\n郑燮画中留劲骨，七贤林下显风骚。\n愿学翠竹坚贞志，直上青云不折腰。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作咏月的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏月》\n皎皎空中孤月轮，清辉遍洒净无尘。\n阴晴圆缺循天道，离合悲欢喻世人。\n李白举杯成妙句，东坡把酒问前因。\n愿君常似中秋月，圆满光明照四邻。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写咏酒的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏酒》\n琼浆玉液出糟床，琥珀流光满室香。\n李白百篇缘醉得，陶潜三径借醪藏。\n喜时助兴欢情畅，愁处消忧块垒忘。\n但得人生常尽欢，莫教金樽空对月。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作咏松的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏松》\n峭壁悬崖一老松，风霜雨雪仍从容。\n根深不怕狂风动，干正何忧暴雨冲。\n四季常青显劲节，千年不朽见贞忠。\n愿学青松坚毅志，艰难困苦亦豪雄。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写咏菊的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏菊》\n秋深百卉尽凋残，唯有菊花傲霜寒。\n金甲满披香益远，玉肌微露色尤丹。\n不随桃李争春艳，独伴松梅耐岁寒。\n愿效黄花晚节香，老当益壮志如磐。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作咏兰的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏兰》\n空谷幽兰独自芳，不因无人减馨香。\n素心一点含雅韵，翠叶数茎带露光。\n羞与群葩争艳丽，乐同君子论文章。\n愿学兰花高洁品，远离尘俗守清芳。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写咏剑的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《咏剑》\n龙泉出匣寒光闪，百炼千锤始铸成。\n斩妖除魔凭正气，安邦定国靠精诚。\n匣中夜夜鸣不已，世上时时待不平。\n愿借三尺青锋剑，扫尽人间邪恶情。"</span>
            },
            <span class="hljs-comment"># ... 更多咏物诗（共30首）</span>
        ]
        training_data.extend(object_poems)
        
        <span class="hljs-comment"># ==================== 节日时令 (20首) ====================</span>
        festival_poems = [
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作中秋赏月的原创唐诗"</span>, 
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《中秋》\n中秋月最明，万里共澄清。\n饼圆寓团圆，瓜果表丰盈。\n举杯邀月饮，对影成三人。\n愿得长如此，年年乐太平。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写重阳登高的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《重阳》\n九九又重阳，登高望远方。\n茱萸插满鬓，菊酒溢清香。\n云淡天高远，风清雁阵长。\n遥知兄弟处，应亦念家乡。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作春节喜庆的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《元日》\n爆竹声中旧岁除，春风送暖入屠苏。\n千门万户曈曈日，总把新桃换旧符。\n儿女新衣争艳丽，翁媪笑靥显欢愉。\n但求四海升平世，岁岁如今庆有余。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写清明时节的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《清明》\n清明时节雨纷纷，路上行人欲断魂。\n借问酒家何处有，牧童遥指杏花村。\n扫墓祭祖思先德，踏青游春感物恩。\n慎终追远传家训，继往开来耀祖门。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"创作端午竞渡的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《端午》\n端午时节雨初晴，龙舟竞渡鼓声鸣。\n健儿挥桨如飞箭，观众加油似雷鸣。\n粽子投江祭屈子，艾蒲悬户避邪精。\n传统文化须承继，爱国精神永传承。"</span>
            },
            {
                <span class="hljs-string">"instruction"</span>: <span class="hljs-string">"写七夕乞巧的原创唐诗"</span>,
                <span class="hljs-string">"output"</span>: <span class="hljs-string">"《七夕》\n七夕银河架鹊桥，牛郎织女会今宵。\n金风玉露一相逢，胜却人间无数朝。\n闺中女子乞灵巧，月下穿针竞妖娆。\n但愿有情成眷属，莫教离别恨迢迢。"</span>
            },
            <span class="hljs-comment"># ... 更多节日诗（共20首）</span>
        ]
        training_data.extend(festival_poems)
   
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f" 创建了 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(training_data)}</span> 首高质量唐诗训练数据"</span>)
        <span class="hljs-keyword">return</span> training_data
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">setup_lora</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""配置LoRA"""</span>
        lora_config = LoraConfig(
            r=<span class="hljs-number">16</span>,                    <span class="hljs-comment"># 适当增加秩</span>
            lora_alpha=<span class="hljs-number">32</span>,
            target_modules=[<span class="hljs-string">"q_proj"</span>, <span class="hljs-string">"v_proj"</span>, <span class="hljs-string">"k_proj"</span>, <span class="hljs-string">"o_proj"</span>],
            lora_dropout=<span class="hljs-number">0.1</span>,        <span class="hljs-comment"># 降低dropout</span>
            bias=<span class="hljs-string">"none"</span>,
            task_type=<span class="hljs-string">"CAUSAL_LM"</span>
        )
        
        self.model = get_peft_model(self.model, lora_config)
        self.model.print_trainable_parameters()
        <span class="hljs-keyword">return</span> self.model
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">prepare_dataset</span>(<span class="hljs-params">self, training_data</span>):
        <span class="hljs-string">"""准备训练数据集"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" 处理训练数据..."</span>)
        
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">format_example</span>(<span class="hljs-params">example</span>):
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">"text"</span>: <span class="hljs-string">f"请创作一首唐诗：<span class="hljs-subst">{example[<span class="hljs-string">'instruction'</span>]}</span>\n\n作品：<span class="hljs-subst">{example[<span class="hljs-string">'output'</span>]}</span>"</span>
            }
        
        dataset = Dataset.from_list(training_data)
        formatted_dataset = dataset.<span class="hljs-built_in">map</span>(format_example)
        
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">tokenize_function</span>(<span class="hljs-params">examples</span>):
            <span class="hljs-keyword">return</span> self.tokenizer(
                examples[<span class="hljs-string">"text"</span>],
                truncation=<span class="hljs-literal">True</span>,
                padding=<span class="hljs-string">"max_length"</span>,
                max_length=<span class="hljs-number">400</span>,
                return_tensors=<span class="hljs-literal">None</span>
            )
        
        tokenized_dataset = formatted_dataset.<span class="hljs-built_in">map</span>(
            tokenize_function,
            batched=<span class="hljs-literal">True</span>,
            remove_columns=formatted_dataset.column_names
        )
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" 数据预处理完成"</span>)
        <span class="hljs-keyword">return</span> tokenized_dataset
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""执行训练"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" 开始训练..."</span>)
        
        <span class="hljs-comment"># 设置训练参数</span>
        training_args = TrainingArguments(
            output_dir=<span class="hljs-string">"./tang_poetry_lora"</span>,
            per_device_train_batch_size=<span class="hljs-number">2</span>,
            gradient_accumulation_steps=<span class="hljs-number">1</span>,
            learning_rate=<span class="hljs-number">2e-4</span>,          <span class="hljs-comment"># 优化学习率</span>
            num_train_epochs=<span class="hljs-number">20</span>,         <span class="hljs-comment"># 充分训练</span>
            logging_steps=<span class="hljs-number">5</span>,
            save_steps=<span class="hljs-number">50</span>,
            
            <span class="hljs-comment"># 优化配置</span>
            warmup_steps=<span class="hljs-number">50</span>,
            weight_decay=<span class="hljs-number">0.01</span>,
            lr_scheduler_type=<span class="hljs-string">"cosine"</span>,
            max_grad_norm=<span class="hljs-number">1.0</span>,           <span class="hljs-comment"># 梯度裁剪</span>
            
            remove_unused_columns=<span class="hljs-literal">False</span>,
            dataloader_pin_memory=<span class="hljs-literal">False</span>,
            report_to=[],
        )
        
        data_collator = DataCollatorForLanguageModeling(
            tokenizer=self.tokenizer,
            mlm=<span class="hljs-literal">False</span>
        )
        
        tokenized_dataset = self.prepare_dataset(self.create_training_data())
        
        trainer = Trainer(
            model=self.model,
            args=training_args,
            train_dataset=tokenized_dataset,
            data_collator=data_collator,
        )
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" 开始模型训练..."</span>)
        train_result = trainer.train()
        
        <span class="hljs-comment"># 保存模型</span>
        trainer.save_model()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" 训练完成！模型已保存"</span>)
        
        <span class="hljs-keyword">return</span> train_result
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_poem</span>(<span class="hljs-params">self, instruction, max_retry=<span class="hljs-number">3</span></span>):
        <span class="hljs-string">"""生成诗歌（带重试机制）"""</span>
        <span class="hljs-keyword">for</span> attempt <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(max_retry):
            <span class="hljs-keyword">try</span>:
                prompt = <span class="hljs-string">f"请创作一首唐诗：<span class="hljs-subst">{instruction}</span>\n\n作品："</span>
                inputs = self.tokenizer(prompt, return_tensors=<span class="hljs-string">"pt"</span>, max_length=<span class="hljs-number">200</span>, truncation=<span class="hljs-literal">True</span>)
                
                <span class="hljs-keyword">with</span> torch.no_grad():
                    outputs = self.model.generate(
                        **inputs,
                        max_new_tokens=<span class="hljs-number">150</span>,
                        temperature=<span class="hljs-number">0.7</span>,          <span class="hljs-comment"># 适中温度</span>
                        do_sample=<span class="hljs-literal">True</span>,
                        top_p=<span class="hljs-number">0.9</span>,
                        top_k=<span class="hljs-number">40</span>,
                        repetition_penalty=<span class="hljs-number">1.3</span>,   <span class="hljs-comment"># 防止重复</span>
                        no_repeat_ngram_size=<span class="hljs-number">3</span>,
                        pad_token_id=self.tokenizer.eos_token_id,
                        eos_token_id=self.tokenizer.eos_token_id,
                        early_stopping=<span class="hljs-literal">True</span>,
                        num_return_sequences=<span class="hljs-number">1</span>
                    )
                
                full_text = self.tokenizer.decode(outputs[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>)
                
                <span class="hljs-comment"># 提取诗歌部分</span>
                <span class="hljs-keyword">if</span> <span class="hljs-string">"作品："</span> <span class="hljs-keyword">in</span> full_text:
                    poem = full_text.split(<span class="hljs-string">"作品："</span>)[-<span class="hljs-number">1</span>].strip()
                <span class="hljs-keyword">else</span>:
                    poem = full_text
                
                <span class="hljs-comment"># 质量检查</span>
                <span class="hljs-keyword">if</span> self._check_poem_quality(poem):
                    <span class="hljs-keyword">return</span> poem
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f" 第<span class="hljs-subst">{attempt+<span class="hljs-number">1</span>}</span>次生成质量不佳，重试..."</span>)
                    
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f" 生成出错: <span class="hljs-subst">{e}</span>"</span>)
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"生成失败，请调整参数重试"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_check_poem_quality</span>(<span class="hljs-params">self, poem</span>):
        <span class="hljs-string">"""检查诗歌质量"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> poem <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(poem) &lt; <span class="hljs-number">10</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
            
        lines = poem.strip().split(<span class="hljs-string">'\n'</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(lines) &lt; <span class="hljs-number">2</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
            
        <span class="hljs-comment"># 检查是否有严重重复</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">set</span>(lines)) &lt; <span class="hljs-built_in">len</span>(lines) * <span class="hljs-number">0.5</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
            
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">comprehensive_test</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""全面测试"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">" 全面测试 "</span>.center(<span class="hljs-number">50</span>, <span class="hljs-string">"="</span>))
        
        test_cases = [
            <span class="hljs-string">"春日游园"</span>,
            <span class="hljs-string">"夏日荷塘"</span>,
            <span class="hljs-string">"秋日登高"</span>, 
            <span class="hljs-string">"冬日赏雪"</span>,
            <span class="hljs-string">"山水风光"</span>,
            <span class="hljs-string">"思乡之情"</span>,
            <span class="hljs-string">"友谊长存"</span>,
            <span class="hljs-string">"咏梅品格"</span>
        ]
        
        <span class="hljs-keyword">for</span> i, theme <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(test_cases, <span class="hljs-number">1</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n测试 <span class="hljs-subst">{i}</span>: <span class="hljs-subst">{theme}</span>"</span>)
            poem = self.generate_poem(theme)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成结果:\n<span class="hljs-subst">{poem}</span>"</span>)
            
            <span class="hljs-comment"># 质量评估</span>
            lines = poem.strip().split(<span class="hljs-string">'\n'</span>)
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(lines) &gt;= <span class="hljs-number">4</span> <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(<span class="hljs-built_in">set</span>(lines)) &gt;= <span class="hljs-number">3</span>:
                quality = <span class="hljs-string">"✅ 质量良好"</span>
            <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(lines) &gt;= <span class="hljs-number">2</span>:
                quality = <span class="hljs-string">"⚠️ 质量一般"</span>
            <span class="hljs-keyword">else</span>:
                quality = <span class="hljs-string">"❌ 需要优化"</span>
                
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"质量评估: <span class="hljs-subst">{quality}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">40</span>)
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">explain_poem</span>(<span class="hljs-params">self, poem</span>):
        <span class="hljs-string">"""调用模型解释诗句内容，仅输出对诗句场景的说明"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> poem <span class="hljs-keyword">or</span> <span class="hljs-built_in">len</span>(poem.strip()) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"无诗句可解释"</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 临时加载原始模型（非微调模型）</span>
            original_model = AutoModelForCausalLM.from_pretrained(
                self.local_model_path2,
                trust_remote_code=<span class="hljs-literal">True</span>,
                torch_dtype=torch.float32,
                device_map=self.device
            )
            prompt = (
                <span class="hljs-string">"请用一段现代汉语解释以下诗句中呈现的场景，200字以内"</span>
                <span class="hljs-string">"仅描述画面，不要分析情感或扩展其他内容：\n\n"</span>
                <span class="hljs-string">f"【诗句】\n<span class="hljs-subst">{poem}</span>\n"</span>
                <span class="hljs-string">"【解释】"</span>
            )
            inputs = self.tokenizer(prompt, return_tensors=<span class="hljs-string">"pt"</span>, max_length=<span class="hljs-number">200</span>, truncation=<span class="hljs-literal">True</span>)
            <span class="hljs-keyword">with</span> torch.no_grad():
                outputs = original_model.generate(
                    **inputs,
                    max_new_tokens=<span class="hljs-number">200</span>,  <span class="hljs-comment"># 限制生成长度</span>
                    temperature=<span class="hljs-number">0.3</span>,    <span class="hljs-comment"># 进一步降低随机性</span>
                    do_sample=<span class="hljs-literal">True</span>,
                    top_p=<span class="hljs-number">0.7</span>,
                    repetition_penalty=<span class="hljs-number">1.5</span>,  <span class="hljs-comment"># 减少重复内容</span>
                    eos_token_id=self.tokenizer.eos_token_id,
                    early_stopping=<span class="hljs-literal">True</span>,
                )
            explanation = self.tokenizer.decode(outputs[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>)
            
            <span class="hljs-comment"># 严格清理：仅保留【解释】后的内容，并去除无关文本</span>
            explanation = explanation.split(<span class="hljs-string">"【解释】"</span>)[-<span class="hljs-number">1</span>].strip()
            explanation = re.sub(<span class="hljs-string">r"\n|"</span>  <span class="hljs-comment"># 去除换行和无关符号</span>
                                <span class="hljs-string">r"Human:.*|Assistant:.*|"</span>
                                <span class="hljs-string">r"A:.*|B:.*|"</span>  <span class="hljs-comment"># 去除对话标记</span>
                                <span class="hljs-string">r"\d{4}年.*|谢谢.*|请问.*"</span>, 
                                <span class="hljs-string">""</span>, explanation)
            <span class="hljs-keyword">return</span> explanation <span class="hljs-keyword">if</span> explanation <span class="hljs-keyword">else</span> <span class="hljs-string">"解释生成失败"</span>
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"解释失败：<span class="hljs-subst">{e}</span>"</span>
            explanation = self.tokenizer.decode(outputs[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"解释结果：\n<span class="hljs-subst">{explanation}</span>"</span>)
            <span class="hljs-comment"># 严格清理：仅保留【解释】后的内容，并去除无关文本</span>
            explanation = explanation.split(<span class="hljs-string">"【解释】"</span>)[-<span class="hljs-number">1</span>].strip()
            explanation = re.sub(<span class="hljs-string">r"\n|"</span>  <span class="hljs-comment"># 去除换行和无关符号</span>
                                <span class="hljs-string">r"Human:.*|Assistant:.*|"</span>
                                <span class="hljs-string">r"\d{4}年.*|谢谢.*|请问.*"</span>, 
                                <span class="hljs-string">""</span>, explanation)
            <span class="hljs-keyword">return</span> explanation <span class="hljs-keyword">if</span> explanation <span class="hljs-keyword">else</span> <span class="hljs-string">"解释生成失败"</span>
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"解释失败：<span class="hljs-subst">{e}</span>"</span>
            
            outputs = original_model.generate(
                **inputs,
                max_new_tokens=<span class="hljs-number">150</span>,
                temperature=<span class="hljs-number">0.5</span>,
                do_sample=<span class="hljs-literal">True</span>,
                top_p=<span class="hljs-number">0.8</span>,
                repetition_penalty=<span class="hljs-number">1.25</span>,
                no_repeat_ngram_size=<span class="hljs-number">3</span>,
                pad_token_id=self.tokenizer.eos_token_id,
                eos_token_id=self.tokenizer.eos_token_id,
                early_stopping=<span class="hljs-literal">True</span>,
            )
            explanation = self.tokenizer.decode(outputs[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>)
            explanation = re.sub(<span class="hljs-string">r"Human:.*|Assistant:.*|（.*"</span>, <span class="hljs-string">""</span>, explanation).strip()

            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"解释结果：\n<span class="hljs-subst">{explanation}</span>"</span>)
            <span class="hljs-comment"># 清理输出</span>
            lines = [l.strip() <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> poem.split(<span class="hljs-string">'\n'</span>) <span class="hljs-keyword">if</span> l.strip()]
            <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> lines:
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(l) &gt; <span class="hljs-number">0</span>:
                    explanation = explanation.replace(l, <span class="hljs-string">""</span>)
            <span class="hljs-comment"># 去掉书名号标题</span>
            explanation = re.sub(<span class="hljs-string">r"《[^》]+》"</span>, <span class="hljs-string">""</span>, explanation)
            <span class="hljs-comment"># 归一化为单段</span>
            explanation = re.sub(<span class="hljs-string">r"\s+"</span>, <span class="hljs-string">" "</span>, explanation.replace(<span class="hljs-string">"\n"</span>, <span class="hljs-string">" "</span>)).strip()

            <span class="hljs-comment"># 兜底：若仍为空，给通用解释</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(explanation) &lt; <span class="hljs-number">30</span>:
                explanation = <span class="hljs-string">"这首诗通过典型意象与场景的描写，传达了作者的情感取向与审美趣味，借景抒情、以物寄意，形成含蓄而悠远的意境，读来清新自然、韵味绵长。"</span>
            <span class="hljs-keyword">return</span> explanation
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">return</span> <span class="hljs-string">f"解释失败：<span class="hljs-subst">{e}</span>"</span>
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_gradio</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""构建Gradio界面：主题选择 + 简单描述（留空则默认），生成诗句与单段解释"""</span>
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate</span>(<span class="hljs-params">theme, desc, need_explain</span>):
            theme_map = {
                <span class="hljs-string">"四季变换"</span>: <span class="hljs-string">"春夏秋冬轮换"</span>,
                <span class="hljs-string">"山水田园"</span>: <span class="hljs-string">"山水田园风光"</span>,
                <span class="hljs-string">"抒情言志"</span>: <span class="hljs-string">"抒情言志"</span>,
                <span class="hljs-string">"边塞风云"</span>: <span class="hljs-string">"边塞风云"</span>,
                <span class="hljs-string">"咏物寄情"</span>: <span class="hljs-string">"咏物寄情"</span>,
                <span class="hljs-string">"节日时令"</span>: <span class="hljs-string">"节日时令"</span>
            }
            default_desc = {
                <span class="hljs-string">"四季变换"</span>: <span class="hljs-string">"描写春夏秋冬气候与景物变迁，表现生命轮回的韵律。"</span>,
                <span class="hljs-string">"山水田园"</span>: <span class="hljs-string">"借青山碧水与田园劳作，抒写恬淡宁静的生活情趣。"</span>,
                <span class="hljs-string">"抒情言志"</span>: <span class="hljs-string">"直接抒发内心情感与志向，表达人生理想与感怀。"</span>,
                <span class="hljs-string">"边塞风云"</span>: <span class="hljs-string">"描绘边关沙场与将士风骨，展现家国情怀与戍边艰辛。"</span>,
                <span class="hljs-string">"咏物寄情"</span>: <span class="hljs-string">"托物言志，通过梅竹松菊等意象寄寓品格与情怀。"</span>,
                <span class="hljs-string">"节日时令"</span>: <span class="hljs-string">"围绕传统节令习俗与人情世事，书写团圆、追忆与祈愿。"</span>
            }
            base = theme_map.get(theme, theme)
            desc_text = (desc <span class="hljs-keyword">or</span> <span class="hljs-string">""</span>).strip() <span class="hljs-keyword">or</span> default_desc.get(theme, <span class="hljs-string">""</span>)
            instruction = <span class="hljs-string">f"主题：<span class="hljs-subst">{base}</span>。简述：<span class="hljs-subst">{desc_text}</span>"</span>
            poem = self.generate_poem(instruction)
            explanation = self.explain_poem(poem) <span class="hljs-keyword">if</span> need_explain <span class="hljs-keyword">else</span> <span class="hljs-string">"（未选择解释）"</span>
            <span class="hljs-keyword">return</span> poem, explanation
        
        dropdown = gr.Dropdown(choices=[<span class="hljs-string">"四季变换"</span>,<span class="hljs-string">"山水田园"</span>,<span class="hljs-string">"抒情言志"</span>,<span class="hljs-string">"边塞风云"</span>,<span class="hljs-string">"咏物寄情"</span>,<span class="hljs-string">"节日时令"</span>], label=<span class="hljs-string">"主题"</span>)
        textbox = gr.Textbox(lines=<span class="hljs-number">2</span>, placeholder=<span class="hljs-string">"例如：春雨、荷塘、思乡、咏梅等简要描述（留空则使用默认）"</span>, label=<span class="hljs-string">"简单描述"</span>)
        checkbox = gr.Checkbox(label=<span class="hljs-string">"生成解释"</span>, value=<span class="hljs-literal">True</span>)
        output_poem = gr.Textbox(lines=<span class="hljs-number">8</span>, label=<span class="hljs-string">"生成诗句"</span>)
        output_exp = gr.Textbox(lines=<span class="hljs-number">6</span>, label=<span class="hljs-string">"诗句解释（单段）"</span>)
        
        iface = gr.Interface(
            fn=generate,
            inputs=[dropdown, textbox, checkbox],
            outputs=[output_poem, output_exp],
            title=<span class="hljs-string">"唐诗生成器（LoRA微调）"</span>,
            description=<span class="hljs-string">"选择主题并可填写简述；留空则使用默认描述。解释仅输出一段现代汉语说明。"</span>
        )
        <span class="hljs-keyword">return</span> iface

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-string">"""主函数"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">" 唐诗LoRA微调系统启动"</span>)
    
    <span class="hljs-comment"># 解析命令行参数</span>
    parser = argparse.ArgumentParser()
    parser.add_argument(<span class="hljs-string">"--skip-training"</span>, action=<span class="hljs-string">"store_true"</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">"已训练模型时跳过训练，直接测试"</span>)
    args = parser.parse_args()

    <span class="hljs-comment"># 初始化训练器</span>
    <span class="hljs-comment"># trainer = TangPoetryTrainer(skip_training=args.skip_training)</span>
    trainer = TangPoetryTrainer(skip_training=<span class="hljs-literal">True</span>)
    
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> trainer.skip_training:
        <span class="hljs-comment"># 正常流程：加载基座模型与LoRA并训练</span>
        trainer.setup_model()
        trainer.setup_lora()
        trainer.train()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 跳过训练：直接加载已训练模型</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">" 跳过训练，直接加载已训练模型进行测试"</span>)
        trainer.load_trained_model(<span class="hljs-string">"./tang_poetry_lora"</span>)
    
    <span class="hljs-comment"># 启动Gradio界面</span>
    iface = trainer.build_gradio()
    iface.launch(server_name=<span class="hljs-string">"0.0.0.0"</span>, share=<span class="hljs-literal">False</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n 程序执行完成！"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<p><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IDEA Claude Code or Codex GUI 插件【开源自荐】]]></title>    <link>https://juejin.cn/post/7592912896591216659</link>    <guid>https://juejin.cn/post/7592912896591216659</guid>    <pubDate>2026-01-09T02:48:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592912896591216659" data-draft-id="7592865044692107270" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IDEA Claude Code or Codex GUI 插件【开源自荐】"/> <meta itemprop="keywords" content="前端,后端,GitHub"/> <meta itemprop="datePublished" content="2026-01-09T02:48:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="朱昆鹏"/> <meta itemprop="url" content="https://juejin.cn/user/2788017219055175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IDEA Claude Code or Codex GUI 插件【开源自荐】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017219055175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    朱昆鹏
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T02:48:51.000Z" title="Fri Jan 09 2026 02:48:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一.前言介绍</h2>
<h3 data-id="heading-1">1.项目产生原因</h3>
<p>我使用claude code比较频繁，近期有使用IDEA插件的需求，我发现IDEA插件中没有一个可视化操作claude code的工具，vscode中官方已经有了，这让我很奇怪，于是开始着手做了一下，经过一个月的迭代，目前已经比较完善了，分享给大家使用</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c46c3dade558492a846f99bfcad6aa36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=bdZFBvoEJ8rWZ5OW7dXCYJtDhiE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">开源地址</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzhukunpenglinyutong%2Fidea-claude-code-gui" target="_blank" title="https://github.com/zhukunpenglinyutong/idea-claude-code-gui" ref="nofollow noopener noreferrer">github.com/zhukunpengl…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12f403277d0e4898a8ecbba3ecacccdb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=Nqjfcvf%2FrSsdx19Js8%2B4Qjvenqk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-3">商店包下载地址</h3>
<p>本插件已上架 Jetbrains 市场，搜索claude code gui 安装即可</p>
<p>本项目不含任何商业化内容和额外接口，纯视图层GUI，请放心使用</p>
<blockquote>
<p>声明：政府部门，国企，学校 修改本项目代码，可遵循MIT协议，不需要遵守AGPL-3.0协议</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8baf1f3a9439456ea72cc9f46540bce7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=s49f0%2BKAycT7TSg%2BZ0Ji9CwAq9Y%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-4">二.功能介绍</h2>
<h3 data-id="heading-5">1.输入框</h3>
<blockquote>
<p>1.支持非常优雅的文件引用展示</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/219591197a334a7e8d9c3929eb108552~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=6Km9JjdMPMYAs6vSHWClGccyaRM%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>2.支持模式切换</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96f6ba50c8524ee5906e0b876c7ef422~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=DCLxT7%2F0nl%2BWsjQ%2FvkUrAizfPY8%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>3.支持模型切换（支持映射，可映射为GLM模型型号）</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3baeddebb43b4d588986c82b1098ebe5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=oC%2FjrGvt7Epr%2BQL6f5tEPsEQnqY%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>4.更多功能（思考，智能体，供应商，MCP，Claude Code切换）等等</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/815421e7b4614ffdbc1f381b5fcd5332~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=DVsoXv37U%2BxMqKrloOjyXxmtNDQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-6">2.对话UI展示区域</h3>
<blockquote>
<p>非常优雅的页面展示，我认为符合我的审美和需要</p>
</blockquote>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 支持思考过程</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 支持工具展示（带便捷ICON展示）</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 支持任务列表展示</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 支持DIFF展示</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> ......</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a0ad269a91d438198c87268efbddaae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=iK%2F7pQZNP%2Bl6cZSGqIQAjYRNkck%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">3.历史记录</h3>
<blockquote>
<p>支持完整的历史记录功能</p>
</blockquote>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 查看历史记录</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 删除历史记录</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 从历史记录进行对话</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 修改历史记录名称</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 下载历史记录</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> 收藏历史记录</li>
<li class="task-list-item"><input type="checkbox" checked="checked" disabled="disabled"/> ......</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a8818be5a1d4c9db01d6987cabe915b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=PQeXXmZtvYV2XLVfGvC6lWYMCLo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">4.设置页面</h3>
<blockquote>
<p>上面内容已经够多了？让我再加🤏🏻 设置细节</p>
</blockquote>
<p>基础配置
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26b1b738e17f457ca59ab9e2aba7efea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=ouyqVnwJsJ3iIplcR2TFyujN9so%3D" alt="image.png" loading="lazy"/></p>
<p>供应商管理
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9632278ccff4a86a0be8f6dade745ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=WWcJMzDj7qGRAUfdyyj80AEdXtY%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6b7f4b760ba4601a1300c940a648b58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=0m4pfnqAtGB0w4RdazO%2BXQ%2BlHDE%3D" alt="image.png" loading="lazy"/></p>
<p>使用统计
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37d9db44479d43d78a6f9857c17711e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=gISNBygZIW53I7gBJjvxuOJXawk%3D" alt="image.png" loading="lazy"/></p>
<p>MCP服务器
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5e6c595dfbe4f52a7ac6985bd06d805~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=Zv3aX%2BTlMknhw%2FrWpJOVic%2Bhhmw%3D" alt="image.png" loading="lazy"/></p>
<p>智能体
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c418136ff3fc4af586c58702b485bf46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=pj4w4dyHZU%2F7oOLZyC%2B%2FkXB3MLM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ced4d3be4e3458da153f6c529df3e37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=BbDxQohvbLcyQsQSDDKnwCHQIRY%3D" alt="image.png" loading="lazy"/></p>
<p>SKills
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41999d5cfae54f25bf8e61e5a70aa7a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=mC%2FnJPcfqWMQN6dWRLJ%2F2%2FCr8qQ%3D" alt="image.png" loading="lazy"/></p>
<p>......</p>
<h3 data-id="heading-9">5.Codex（没错，也支持了）</h3>
<blockquote>
<p>上面功能已经够多了？现在我们也支持Codex了，上面功能我们全部适配了一遍Codex，并且可以在本插件非常优雅的进行切换</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c9c1d0e13dd4c4c9335a8666d30ffcc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=l3KSpnSt6zqeyqvzLb%2F7CXnLa7g%3D" alt="Video-detail-page (1).gif" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c142608dc27e44258d2c6f9d0209670c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=XF%2BFGir4hqi7ICkf%2FlCX36pdvSs%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-10">三.后续计划</h2>
<p>计划在掘金平台 分享本插件项目的一些实现原理，和使用claude code开发本插件的实践经验和采坑指南</p>
<blockquote>
<p>本插件在极速更新中，每天预计发布1版，佬友们想要什么新功能，随时在此帖中艾特我哦~</p>
</blockquote>
<hr/>
<h2 data-id="heading-11">四.致谢</h2>
<p>感谢所有帮助 IDEA-Claude-Code-GUI 变得更好的贡献者！和感谢掘金技术平台</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5812a86059ff49a588b18fe47c331419~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyx5piG6bmP:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768531730&amp;x-signature=RiBtgDssmbb9PbooAu6fc%2FUruE0%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[agentsdk-go：完整的 Claude Code 架构 Agent 开发框架]]></title>    <link>https://juejin.cn/post/7592873628585705472</link>    <guid>https://juejin.cn/post/7592873628585705472</guid>    <pubDate>2026-01-09T01:56:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592873628585705472" data-draft-id="7592853243731329064" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="agentsdk-go：完整的 Claude Code 架构 Agent 开发框架"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2026-01-09T01:56:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星纬智联技术"/> <meta itemprop="url" content="https://juejin.cn/user/4336129589911223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            agentsdk-go：完整的 Claude Code 架构 Agent 开发框架
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4336129589911223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星纬智联技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:56:40.000Z" title="Fri Jan 09 2026 01:56:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">agentsdk-go：完整的 Claude Code 架构 Agent 开发框架</h2>
<h3 data-id="heading-1">TL;DR</h3>
<p>agentsdk-go 是一个用 Go 实现的 Agent 开发框架，完整移植了 Claude Code 的七大核心能力（Hooks、MCP、Sandbox、Skills、Subagents、Commands、Plugins），并扩展了六层中间件拦截机制。相比 LangGraph 的黑盒架构和 Claude Agent SDK 的资源占用问题，agentsdk-go 提供了更透明的实现、更低的资源消耗和更灵活的扩展能力。核心代码 20,300 行，Agent 主循环仅 189 行，测试覆盖率达 90-93%。</p>
<h3 data-id="heading-2">一、agentsdk-go 是什么</h3>
<h4 data-id="heading-3">核心定位</h4>
<p>agentsdk-go 是基于 Claude Code 完整架构设计的 Agent 开发框架，面向生产环境的 CLI、CI/CD 和企业平台部署场景。它不是简单的 LLM 调用封装，而是提供了完整的 Agent 工程能力。</p>
<h4 data-id="heading-4">技术指标</h4>
<ul>
<li>• <strong>代码规模</strong>：约 20,300 行生产代码（不含测试）</li>
<li>• <strong>核心复杂度</strong>：Agent 主循环 189 行</li>
<li>• <strong>测试覆盖率</strong>：六大核心模块均达 90-93%（subagents 91.7%，api 91.0%，mcp 90.3%，model 92.2%，sandbox 90.5%，security 90.4%）</li>
<li>• <strong>模块化程度</strong>：13 个独立包</li>
<li>• <strong>外部依赖</strong>：anthropic-sdk-go、fsnotify、gopkg.in/yaml.v3、google/uuid、golang.org/x/mod、golang.org/x/net</li>
</ul>
<h4 data-id="heading-5">系统架构</h4>
<h5 data-id="heading-6">核心层（6 个模块）</h5>
<ol>
<li>
<ol>
<li><strong>pkg/agent</strong>：Agent 执行循环，协调模型调用和工具执行</li>
</ol>
</li>
<li>
<ol start="2">
<li><strong>pkg/middleware</strong>：六层拦截点，扩展请求/响应生命周期</li>
</ol>
</li>
<li>
<ol start="3">
<li><strong>pkg/model</strong>：模型适配器，当前支持 Anthropic Claude</li>
</ol>
</li>
<li>
<ol start="4">
<li><strong>pkg/tool</strong>：工具注册和执行，包含内置工具和 MCP 工具支持</li>
</ol>
</li>
<li>
<ol start="5">
<li><strong>pkg/message</strong>：基于 LRU 的会话历史管理</li>
</ol>
</li>
<li>
<ol start="6">
<li><strong>pkg/api</strong>：统一 API 接口，暴露 SDK 功能</li>
</ol>
</li>
</ol>
<h5 data-id="heading-7">特性层（7 个模块）</h5>
<ol>
<li>
<ol>
<li><strong>pkg/core/hooks</strong>：七种生命周期事件的 Hooks 执行器</li>
</ol>
</li>
<li>
<ol start="2">
<li><strong>pkg/mcp</strong>：MCP (Model Context Protocol) 客户端，桥接外部工具（stdio/SSE）</li>
</ol>
</li>
<li>
<ol start="3">
<li><strong>pkg/sandbox</strong>：沙箱隔离层，控制文件系统和网络访问策略</li>
</ol>
</li>
<li>
<ol start="4">
<li><strong>pkg/runtime/skills</strong>：Skills 管理，支持脚本加载和热重载</li>
</ol>
</li>
<li>
<ol start="5">
<li><strong>pkg/runtime/subagents</strong>：Subagent 管理，用于多 Agent 编排和调度</li>
</ol>
</li>
<li>
<ol start="6">
<li><strong>pkg/runtime/commands</strong>：Commands 解析器，处理斜杠命令路由和参数验证</li>
</ol>
</li>
<li>
<ol start="7">
<li><strong>pkg/plugins</strong>：插件系统，具备签名验证和生命周期钩子</li>
</ol>
</li>
</ol>
<h5 data-id="heading-8">中间件拦截点</h5>
<pre><code class="hljs language-markdown" lang="markdown">
<span class="hljs-code">    
    
    
  用户请求
  ↓
before_agent  ← 请求验证、审计日志
  ↓
Agent 循环
  ↓
before_model  ← Prompt 处理、上下文优化
  ↓
模型调用
  ↓
after_model   ← 结果过滤、内容检查
  ↓
before_tool   ← 工具参数验证
  ↓
工具执行
  ↓
after_tool    ← 结果后处理
  ↓
after_agent   ← 响应格式化、指标收集
  ↓
用户响应
</span></code></pre>
<p>这种六层拦截设计允许开发者在 Agent 执行的关键节点注入自定义逻辑，实现日志记录、性能监控、安全审计等功能。</p>
<h4 data-id="heading-9">配置系统</h4>
<p>agentsdk-go 使用 <code>.claude/</code> 目录进行配置，与 Claude Code 完全兼容：</p>
<pre><code class="hljs language-bash" lang="bash">
    
    
    
  .claude/
├── settings.json           <span class="hljs-comment"># 项目配置</span>
├── settings.local.json     <span class="hljs-comment"># 本地覆盖（gitignored）</span>
├── skills/                 <span class="hljs-comment"># Skills 定义</span>
├── commands/               <span class="hljs-comment"># 斜杠命令定义</span>
├── agents/                 <span class="hljs-comment"># Subagents 定义</span>
└── plugins/                <span class="hljs-comment"># 插件目录</span>
</code></pre>
<p>配置优先级（从高到低）：</p>
<ol>
<li>
<ol>
<li>托管策略（<code>/etc/claude-code/managed-settings.json</code>）</li>
</ol>
</li>
<li>
<ol start="2">
<li>运行时覆盖（CLI/API 提供）</li>
</ol>
</li>
<li>
<ol start="3">
<li><code>.claude/settings.local.json</code></li>
</ol>
</li>
<li>
<ol start="4">
<li><code>.claude/settings.json</code></li>
</ol>
</li>
<li>
<ol start="5">
<li>内置默认值</li>
</ol>
</li>
</ol>
<p>配置示例：</p>
<pre><code class="hljs language-json" lang="json">
    
    
    
  <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"permissions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"allow"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Bash(ls:*)"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"Bash(pwd:*)"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"deny"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"Read(.env)"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"Read(secrets/**)"</span><span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"MY_VAR"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"value"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sandbox"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-10">二、为什么要自己写 agentsdk-go</h3>
<h4 data-id="heading-11">LangGraph 的架构问题</h4>
<p>LangGraph 虽然功能强大，但存在几个核心痛点：</p>
<ol>
<li>
<ol>
<li><strong>黑盒架构</strong>：状态图抽象过重，难以追踪 Agent 执行流程，调试困难</li>
</ol>
</li>
<li>
<ol start="2">
<li><strong>灵活性不足</strong>：固定的图结构限制了动态决策和运行时调整</li>
</ol>
</li>
<li>
<ol start="3">
<li><strong>工程能力缺失</strong>：缺少 Sandbox、Hooks、MCP 等生产环境必需的能力</li>
</ol>
</li>
<li>
<ol start="4">
<li><strong>Python 生态绑定</strong>：对 Go 生态支持不佳</li>
</ol>
</li>
</ol>
<h4 data-id="heading-12">Claude Agent SDK 的资源瓶颈</h4>
<p>Claude Agent SDK 基于 <code>claude -p</code> 实现，每次调用都会在本地启动一个完整的 Claude 实例：</p>
<ul>
<li>• <strong>CPU 占用</strong>：每个实例独立进程，多任务并发时 CPU 飙升</li>
<li>• <strong>内存消耗</strong>：每个实例加载完整上下文，内存占用线性增长</li>
<li>• <strong>启动延迟</strong>：进程冷启动时间影响响应速度</li>
</ul>
<p>这在 CI/CD 和高并发场景下完全不可接受。</p>
<h4 data-id="heading-13">agentsdk-go 的优势</h4>
<h5 data-id="heading-14">1. 架构透明性</h5>
<p>完全遵循 Claude Code 的设计原则，核心 Agent 循环仅 189 行，逻辑清晰：</p>
<ul>
<li>• 请求接收 → 中间件前置处理 → 模型调用 → 工具执行 → 中间件后置处理 → 响应返回</li>
<li>• 每个环节都可拦截、观测、调试</li>
</ul>
<h5 data-id="heading-15">2. 资源效率</h5>
<ul>
<li>• <strong>单进程模型</strong>：所有 Agent 共享一个运行时，无进程启动开销</li>
<li>• <strong>会话缓存</strong>：基于 LRU 的消息历史管理，避免重复上下文加载</li>
<li>• <strong>按需加载</strong>：Skills、Plugins、MCP 工具仅在使用时初始化</li>
</ul>
<h5 data-id="heading-16">3. 扩展能力</h5>
<ul>
<li>• <strong>中间件系统</strong>：六层拦截点覆盖完整生命周期</li>
<li>• <strong>Sandbox 优化</strong>：更细粒度的资源控制（CPU、内存、磁盘、网络）</li>
<li>• <strong>自定义工具</strong>：简单的 <code>tool.Tool</code> 接口，5 分钟完成集成</li>
</ul>
<h5 data-id="heading-17">4. 生产就绪</h5>
<ul>
<li>• <strong>高测试覆盖率</strong>：核心模块 90%+ 覆盖，保证代码质量</li>
<li>• <strong>HTTP API</strong>：内置 REST + SSE 服务器，开箱即用</li>
<li>• <strong>可观测性</strong>：Trace、Metrics、Logs 完整支持</li>
</ul>
<h3 data-id="heading-18">三、如何使用 agentsdk-go 开发 Agent</h3>
<h4 data-id="heading-19">安装和环境准备</h4>
<h5 data-id="heading-20">前置要求</h5>
<ul>
<li>• Go 1.24.0 或更高版本</li>
<li>• Anthropic API Key</li>
</ul>
<h5 data-id="heading-21">安装 SDK</h5>
<pre><code class="hljs language-go" lang="go">
    
    
    
  <span class="hljs-keyword">go</span> get github.com/cexll/agentsdk-<span class="hljs-keyword">go</span>
</code></pre>
<h4 data-id="heading-22">基础示例：5 分钟创建第一个 Agent</h4>
<p>这是来自 <code>examples/01-basic/main.go</code> 的最小示例，展示了 agentsdk-go 的核心用法：</p>
<pre><code class="hljs language-go" lang="go">
    
    
    
  <span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"log"</span>

    <span class="hljs-string">"github.com/cexll/agentsdk-go/pkg/api"</span>
    <span class="hljs-string">"github.com/cexll/agentsdk-go/pkg/middleware"</span>
    modelpkg <span class="hljs-string">"github.com/cexll/agentsdk-go/pkg/model"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 创建 Anthropic provider</span>
    provider := &amp;modelpkg.AnthropicProvider{
        ModelName: <span class="hljs-string">"claude-sonnet-4-5-20250929"</span>,
    }

    <span class="hljs-comment">// 初始化运行时</span>
    traceMW := middleware.NewTraceMiddleware(<span class="hljs-string">".trace"</span>)
    rt, err := api.New(context.Background(), api.Options{
        ModelFactory: provider,
        Middleware:   []middleware.Middleware{traceMW},
    })
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Fatalf(<span class="hljs-string">"build runtime: %v"</span>, err)
    }
    <span class="hljs-keyword">defer</span> rt.Close()

    <span class="hljs-comment">// 发起同步调用</span>
    resp, err := rt.Run(context.Background(), api.Request{
        Prompt: <span class="hljs-string">"你好"</span>,
    })
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        log.Fatalf(<span class="hljs-string">"run: %v"</span>, err)
    }

    <span class="hljs-keyword">if</span> resp.Result != <span class="hljs-literal">nil</span> {
        fmt.Println(resp.Result.Output)
    }
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li>
<ol>
<li><strong>模型初始化</strong>：通过 <code>AnthropicProvider</code> 配置模型</li>
</ol>
</li>
<li>
<ol start="2">
<li><strong>中间件注入</strong>：<code>TraceMiddleware</code> 自动记录执行日志到 <code>.trace</code> 目录</li>
</ol>
</li>
<li>
<ol start="3">
<li><strong>运行时创建</strong>：<code>api.New()</code> 初始化完整运行时</li>
</ol>
</li>
<li>
<ol start="4">
<li><strong>同步调用</strong>：<code>rt.Run()</code> 阻塞等待结果</li>
</ol>
</li>
</ol>
<p>运行示例：</p>
<pre><code class="hljs language-bash" lang="bash">
    
    
    
  <span class="hljs-comment"># 1. 设置环境变量</span>
<span class="hljs-built_in">export</span> ANTHROPIC_API_KEY=sk-ant-your-key-here

<span class="hljs-comment"># 2. 运行示例</span>
go run ./examples/01-basic
</code></pre>
<h4 data-id="heading-23">进阶用法：自定义中间件</h4>
<p>中间件是 agentsdk-go 的核心扩展机制，允许在六个关键节点注入逻辑：</p>
<pre><code class="hljs language-go" lang="go">
    
    
    
  loggingMiddleware := middleware.Middleware{
    <span class="hljs-comment">// 请求前：记录输入和启动时间</span>
    BeforeAgent: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, req *middleware.AgentRequest)</span></span> (*middleware.AgentRequest, <span class="hljs-type">error</span>) {
        log.Printf(<span class="hljs-string">"[REQUEST] %s"</span>, req.Input)
        req.Meta[<span class="hljs-string">"start_time"</span>] = time.Now()
        <span class="hljs-keyword">return</span> req, <span class="hljs-literal">nil</span>
    },

    <span class="hljs-comment">// 响应后：计算执行时间</span>
    AfterAgent: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, resp *middleware.AgentResponse)</span></span> (*middleware.AgentResponse, <span class="hljs-type">error</span>) {
        duration := time.Since(resp.Meta[<span class="hljs-string">"start_time"</span>].(time.Time))
        log.Printf(<span class="hljs-string">"[RESPONSE] %s (elapsed: %v)"</span>, resp.Output, duration)
        <span class="hljs-keyword">return</span> resp, <span class="hljs-literal">nil</span>
    },

    <span class="hljs-comment">// 模型调用前：优化 Prompt</span>
    BeforeModel: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, req *middleware.ModelRequest)</span></span> (*middleware.ModelRequest, <span class="hljs-type">error</span>) {
        <span class="hljs-comment">// 添加系统提示词</span>
        req.Messages = <span class="hljs-built_in">append</span>([]middleware.Message{
            {Role: <span class="hljs-string">"system"</span>, Content: <span class="hljs-string">"你是一个技术专家"</span>},
        }, req.Messages...)
        <span class="hljs-keyword">return</span> req, <span class="hljs-literal">nil</span>
    },

    <span class="hljs-comment">// 工具执行前：参数验证</span>
    BeforeTool: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, req *middleware.ToolRequest)</span></span> (*middleware.ToolRequest, <span class="hljs-type">error</span>) {
        log.Printf(<span class="hljs-string">"[TOOL] %s with params: %v"</span>, req.Name, req.Parameters)
        <span class="hljs-keyword">return</span> req, <span class="hljs-literal">nil</span>
    },
}

<span class="hljs-comment">// 注入中间件</span>
runtime, err := api.New(ctx, api.Options{
    ProjectRoot:  <span class="hljs-string">"."</span>,
    ModelFactory: provider,
    Middleware:   []middleware.Middleware{loggingMiddleware},
})
</code></pre>
<h4 data-id="heading-24">流式输出：实时获取 Agent 执行进度</h4>
<p>对于长时间运行的任务，流式 API 提供实时反馈：</p>
<pre><code class="hljs language-csharp" lang="csharp">
    
    
    
  events := runtime.RunStream(ctx, api.Request{
    Prompt:    <span class="hljs-string">"分析代码仓库结构并生成报告"</span>,
    SessionID: <span class="hljs-string">"analysis"</span>,
})

<span class="hljs-keyword">for</span> <span class="hljs-keyword">event</span> := range events {
    <span class="hljs-keyword">switch</span> <span class="hljs-keyword">event</span>.Type {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"content_block_delta"</span>:
        <span class="hljs-comment">// 输出文本内容</span>
        fmt.Print(<span class="hljs-keyword">event</span>.Delta.Text)

    <span class="hljs-keyword">case</span> <span class="hljs-string">"tool_execution_start"</span>:
        <span class="hljs-comment">// 工具开始执行</span>
        fmt.Printf(<span class="hljs-string">"\n[工具执行] %s\n"</span>, <span class="hljs-keyword">event</span>.ToolName)

    <span class="hljs-keyword">case</span> <span class="hljs-string">"tool_execution_stop"</span>:
        <span class="hljs-comment">// 工具执行完成</span>
        fmt.Printf(<span class="hljs-string">"[工具结果] %s\n"</span>, <span class="hljs-keyword">event</span>.Output)
    }
}
</code></pre>
<h4 data-id="heading-25">自定义工具：扩展 Agent 能力</h4>
<p>agentsdk-go 允许注册自定义工具，接口非常简洁（参考 <code>examples/05-custom-tools/main.go</code>）：</p>
<pre><code class="hljs language-go" lang="go">
    
    
    
  <span class="hljs-comment">// 定义自定义工具</span>
<span class="hljs-keyword">type</span> EchoTool <span class="hljs-keyword">struct</span>{}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *EchoTool)</span></span> Name() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"echo"</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *EchoTool)</span></span> Description() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"返回提供的文本"</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *EchoTool)</span></span> Schema() *tool.JSONSchema {
    <span class="hljs-keyword">return</span> &amp;tool.JSONSchema{
        Type: <span class="hljs-string">"object"</span>,
        Properties: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any{
            <span class="hljs-string">"text"</span>: <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any{
                <span class="hljs-string">"type"</span>:        <span class="hljs-string">"string"</span>,
                <span class="hljs-string">"description"</span>: <span class="hljs-string">"要返回的文本"</span>,
            },
        },
        Required: []<span class="hljs-type">string</span>{<span class="hljs-string">"text"</span>},
    }
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(t *EchoTool)</span></span> Execute(ctx context.Context, params <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]any) (*tool.ToolResult, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">return</span> &amp;tool.ToolResult{
        Output: fmt.Sprint(params[<span class="hljs-string">"text"</span>]),
    }, <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 注册工具</span>
rt, err := api.New(ctx, api.Options{
    ProjectRoot:         <span class="hljs-string">"."</span>,
    ModelFactory:        provider,
    EnabledBuiltinTools: []<span class="hljs-type">string</span>{<span class="hljs-string">"bash"</span>, <span class="hljs-string">"file_read"</span>}, <span class="hljs-comment">// 选择性启用内置工具</span>
    CustomTools:         []tool.Tool{&amp;EchoTool{}},      <span class="hljs-comment">// 添加自定义工具</span>
})
</code></pre>
<p><strong>工具注册规则</strong>：</p>
<ul>
<li>• <code>EnabledBuiltinTools: nil</code> → 启用所有内置工具</li>
<li>• <code>EnabledBuiltinTools: []string{}</code> → 禁用所有内置工具</li>
<li>• <code>EnabledBuiltinTools: []string{"bash", "file_read"}</code> → 仅启用指定工具（大小写不敏感）</li>
<li>• <code>CustomTools</code> → 追加自定义工具</li>
</ul>
<h4 data-id="heading-26">高级特性：完整工程能力</h4>
<p><code>examples/04-advanced</code> 展示了生产环境所需的全部功能：</p>
<h5 data-id="heading-27">1. Sandbox 隔离</h5>
<pre><code class="hljs language-go" lang="go">
    
    
    
  opts := api.Options{
    Sandbox: &amp;sandbox.Options{
        Enabled:     <span class="hljs-literal">true</span>,
        Root:        <span class="hljs-string">"/app/workspace"</span>,
        AllowedHosts: []<span class="hljs-type">string</span>{<span class="hljs-string">"api.example.com"</span>},
        CPULimit:    <span class="hljs-number">50.0</span>,  <span class="hljs-comment">// CPU 使用率限制 50%</span>
        MemLimit:    <span class="hljs-number">512</span>,   <span class="hljs-comment">// 内存限制 512MB</span>
        DiskLimit:   <span class="hljs-number">1024</span>,  <span class="hljs-comment">// 磁盘限制 1GB</span>
    },
}
</code></pre>
<h5 data-id="heading-28">2. MCP 工具集成</h5>
<pre><code class="hljs language-css" lang="css">
    
    
    
  opts := api.Options{
    MCPServers: []mcp.ServerConfig{
        {
            Name:    <span class="hljs-string">"time-server"</span>,
            Command: <span class="hljs-string">"uvx"</span>,
            Args:    []string{"mcp-server-<span class="hljs-selector-tag">time</span>"},
        },
    },
}
</code></pre>
<h5 data-id="heading-29">3. Skills 和 Subagents</h5>
<pre><code class="hljs language-css" lang="css">
    
    
    
  opts := api.Options{
    Skills: []skills.Skill{
        {Name: <span class="hljs-string">"code-review"</span>, Path: <span class="hljs-string">".claude/skills/code-review"</span>},
    },
    Subagents: []subagents.Config{
        {Name: <span class="hljs-string">"analyzer"</span>, Prompt: <span class="hljs-string">"专注于代码分析"</span>},
    },
}
</code></pre>
<h4 data-id="heading-30">五层示例路径</h4>
<p>agentsdk-go 提供渐进式学习路径：</p>
<ol>
<li>
<ol>
<li><strong>01-basic</strong>：最小化的单次请求/响应</li>
</ol>
</li>
<li>
<ol start="2">
<li><strong>02-cli</strong>：交互式 REPL，支持会话历史</li>
</ol>
</li>
<li>
<ol start="3">
<li><strong>03-http</strong>：REST + SSE 服务器（监听 <code>:8080</code>）</li>
</ol>
</li>
<li>
<ol start="4">
<li><strong>04-advanced</strong>：完整管道（中间件、Hooks、MCP、Sandbox、Skills、Subagents）</li>
</ol>
</li>
<li>
<ol start="5">
<li><strong>05-custom-tools</strong>：选择性内置工具 + 自定义工具注册</li>
</ol>
</li>
</ol>
<h3 data-id="heading-31">总结</h3>
<p>agentsdk-go 不是简单的 API 封装，而是完整的 Agent 工程框架：</p>
<ul>
<li>• <strong>架构透明</strong>：189 行核心循环，逻辑清晰可追溯</li>
<li>• <strong>资源高效</strong>：单进程模型，无冷启动开销</li>
<li>• <strong>扩展灵活</strong>：六层中间件 + 自定义工具 + MCP 集成</li>
<li>• <strong>生产就绪</strong>：90%+ 测试覆盖，HTTP API 开箱即用</li>
</ul>
<p>如果你在使用 LangGraph 时感到束缚，或因 Claude Agent SDK 的资源占用而困扰，不妨试试 agentsdk-go——一个真正为工程师设计的 Agent 开发框架。</p>
<h3 data-id="heading-32">参考资源</h3>
<ul>
<li>• GitHub 仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcexll%2Fagentsdk-go" target="_blank" title="https://github.com/cexll/agentsdk-go" ref="nofollow noopener noreferrer">github.com/cexll/agent…</a></li>
<li>• 示例代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcexll%2Fagentsdk-go%2Ftree%2Fmain%2Fexamples" target="_blank" title="https://github.com/cexll/agentsdk-go/tree/main/examples" ref="nofollow noopener noreferrer">github.com/cexll/agent…</a></li>
<li>• Claude Code 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fen%2Fdocs%2Fagents" target="_blank" title="https://docs.anthropic.com/en/docs/agents" ref="nofollow noopener noreferrer">docs.anthropic.com/en/docs/age…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Paddle微调ERNIE的中文情感分析实战教程]]></title>    <link>https://juejin.cn/post/7592878531668869146</link>    <guid>https://juejin.cn/post/7592878531668869146</guid>    <pubDate>2026-01-09T01:39:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592878531668869146" data-draft-id="7592431064976818191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Paddle微调ERNIE的中文情感分析实战教程"/> <meta itemprop="keywords" content="深度学习,机器学习"/> <meta itemprop="datePublished" content="2026-01-09T01:39:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YukiMori23"/> <meta itemprop="url" content="https://juejin.cn/user/4022441007125707"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Paddle微调ERNIE的中文情感分析实战教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4022441007125707/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YukiMori23
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:39:14.000Z" title="Fri Jan 09 2026 01:39:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于Paddle微调ERNIE的中文情感分析实战教程</h2>
<h3 data-id="heading-1">1. 引言</h3>
<p>欢迎来到 PaddleNLP 实战教程系列！本次教程将带您进入自然语言处理 (NLP) 中最经典、最广泛应用的任务之一：<strong>情感分析 (Sentiment Analysis)</strong> 。我们将使用强大的预训练模型 <strong>ERNIE</strong> 来对中文文本进行情感倾向的判断。</p>
<h4 data-id="heading-2">1.1 什么是情感分析？</h4>
<p>情感分析，又称为意见挖掘 (Opinion Mining)，是利用自然语言处理、文本分析和计算语言学等方法，对带有情感色彩的主观性文本进行提取、分析、归纳和推理的过程。简单来说，它的目标就是<strong>识别和判断一段文本所表达的情感是积极的（正面）、消极的（负面），还是中性的</strong>。</p>
<p>例如，给定一条用户评价："这家餐厅的烤鸭味道绝了，环境也很棒！"，情感分析系统应该能判断出这是一条<strong>积极</strong>的评价。而对于"等了半个多小时才上菜，味道也很一般"，则应判断为<strong>消极</strong>。</p>
<h4 data-id="heading-3">1.2 情感分析的应用场景和项目意义</h4>
<p>情感分析技术在商业和研究领域都有着巨大的应用价值，是许多智能应用的基础模块。</p>






























<table><thead><tr><th>应用领域</th><th>具体场景</th><th>项目意义</th></tr></thead><tbody><tr><td><strong>商业智能</strong></td><td>舆情监控、品牌声誉管理、产品评价分析</td><td>实时了解公众情绪，优化产品，进行危机公关</td></tr><tr><td><strong>客户关系</strong></td><td>分析客服对话、服务工单、用户满意度问卷</td><td>自动评估客户满意度，发现服务痛点，提升服务质量</td></tr><tr><td><strong>金融科技</strong></td><td>分析财经新闻、社交媒体情绪、股评</td><td>辅助量化交易和投资决策</td></tr><tr><td><strong>社会科学</strong></td><td>分析公众对特定社会事件或政策的情感倾向</td><td>为社会学、传播学等领域的研究提供数据参考</td></tr></tbody></table>
<p>本项目旨在通过一个完整的实战案例，让您掌握如何利用预训练模型解决真实场景下的文本分类问题，为您在自己的业务或研究中应用NLP技术打下坚实的基础。</p>
<h4 data-id="heading-4">1.3 为什么选择 ERNIE 模型？</h4>
<p>在众多预训练模型中，我们选择 <strong>ERNIE</strong> 作为本次教程的核心，主要有以下原因：</p>
<p><strong>1. 更懂中文的预训练机制</strong>：ERNIE 是由百度提出的、针对中文语言特点进行深度优化的预训练模型。它不仅仅学习字与字之间的关系，还通过<strong>知识掩码策略 (Knowledge Masking Strategies)</strong>  学习了更完整的语义单元（如词、短语和实体）。</p>
<ul>
<li><strong>一个生动的比喻</strong>：如果把普通模型的学习比作做"完形填空"，每次只挖掉一个字让它猜；那么ERNIE的学习就像是在做更难的"成语填空"或"人名填空"。例如，它会把"哈利·波特"整个词挖掉，然后去预测这个被挖掉的实体。通过这种方式，ERNIE被迫学习到了"哈利·波特"是一个人名，以及与它相关的复杂语义，而不是仅仅把这几个字看作孤立的符号。</li>
</ul>
<p>这种对知识的深度学习使得ERNIE在处理中文任务时，语义理解能力更胜一筹。</p>
<p><strong>2. 丰富的模型选择与适中的规模</strong>：PaddleNLP 提供了覆盖从大到小的完整ERNIE模型家族。对于本教程，我们选择 <code>ernie-3.0-medium-zh</code>，它在性能和资源消耗之间取得了很好的平衡。</p>
<p>下表展示了PaddleNLP中支持的部分ERNIE中文模型：</p>





























































<table><thead><tr><th>模型名称 (Pretrained Weight)</th><th>层数</th><th>隐藏层大小</th><th>注意力头数</th><th>参数量</th><th>特点</th></tr></thead><tbody><tr><td><code>ernie-1.0-base-zh</code></td><td>12</td><td>768</td><td>12</td><td>108M</td><td>经典的基础版ERNIE</td></tr><tr><td><code>ernie-3.0-base-zh</code></td><td>12</td><td>768</td><td>12</td><td>118M</td><td>ERNIE 3.0的基础版</td></tr><tr><td><strong><code>ernie-3.0-medium-zh</code></strong></td><td><strong>6</strong></td><td><strong>768</strong></td><td><strong>12</strong></td><td><strong>75M</strong></td><td><strong>本教程选用，规模适中，效果优异</strong></td></tr><tr><td><code>ernie-3.0-mini-zh</code></td><td>6</td><td>384</td><td>12</td><td>27M</td><td>更轻量的版本</td></tr><tr><td><code>ernie-3.0-micro-zh</code></td><td>4</td><td>384</td><td>12</td><td>23M</td><td>微型版本</td></tr><tr><td><code>ernie-3.0-xbase-zh</code></td><td>20</td><td>1024</td><td>16</td><td>296M</td><td>更大更强的版本</td></tr></tbody></table>
<p>可以看到，<code>ernie-3.0-medium-zh</code> (75M参数) 比 <code>base</code> (118M参数) 更轻量，使得我们在普通的GPU上也能快速完成训练，非常适合作为入门和教学的模型。</p>
<h4 data-id="heading-5">1.4 本教程的目标与内容</h4>
<p>本教程面向对NLP和深度学习有基本了解，并希望动手实践解决真实问题的开发者和学习者。通过本教程，您将：</p>
<ul>
<li>理解情感分析任务的基本流程。</li>
<li>学会使用 PaddleNLP 加载和处理中文数据集。</li>
<li>掌握如何加载预训练的 ERNIE 模型，并针对特定任务进行微调 (Fine-tuning)。</li>
<li>从零开始，用不到100行核心代码，训练一个高精度的中文情感分析模型。</li>
<li>学会评估模型性能，并使用训练好的模型对新的文本进行情感预测。</li>
</ul>
<p>让我们开始吧！</p>
<h3 data-id="heading-6">2. 环境准备</h3>
<p>首先，我们需要确保安装了必需的库。本教程主要依赖 PaddlePaddle 和 PaddleNLP。</p>
<p>In [36]</p>
<pre><code class="hljs language-css" lang="css">!pip install <span class="hljs-attr">--upgrade</span> <span class="hljs-attr">--pre</span> paddlenlp==<span class="hljs-number">3.0</span>.<span class="hljs-number">0</span>b4
</code></pre>
<p>安装完成后，我们可以导入并检查版本信息，以确保环境配置正确。</p>
<p>In [37]</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> paddle
<span class="hljs-keyword">import</span> paddlenlp

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"PaddlePaddle Version: <span class="hljs-subst">{paddle.__version__}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"PaddleNLP Version: <span class="hljs-subst">{paddlenlp.__version__}</span>"</span>)

<span class="hljs-comment"># 检查GPU是否可用</span>
<span class="hljs-keyword">if</span> paddle.is_compiled_with_cuda():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"PaddlePaddle is compiled with CUDA and GPU is available."</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"PaddlePaddle is not compiled with CUDA. It will use CPU."</span>)
</code></pre>
<p>环境准备非常简单。接下来，我们将加载用于本次任务的数据集。</p>
<h3 data-id="heading-7">3. 数据准备</h3>
<p>对于情感分析任务，我们需要一个<strong>已标注</strong>的数据集，其中每条文本都对应一个情感标签（如"积极"或"消极"）。</p>
<h4 data-id="heading-8">3.1 加载 ChnSentiCorp 数据集</h4>
<p>PaddleNLP 内置了许多常用的NLP数据集，包括中文情感分析领域的经典数据集 <strong><code>ChnSentiCorp</code></strong>。这个数据集包含酒店、书籍、电脑等多个领域的评论数据，每条评论被标注为正面（标签<code>1</code>）或负面（标签<code>0</code>）。</p>
<p>我们可以使用 <code>paddlenlp.datasets.load_dataset</code> 函数一键加载它。</p>
<p>In [38]</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> paddlenlp.datasets <span class="hljs-keyword">import</span> load_dataset

<span class="hljs-comment"># 加载ChnSentiCorp数据集的训练集、开发集和测试集</span>
train_ds, dev_ds, test_ds = load_dataset(
    <span class="hljs-string">'chnsenticorp'</span>, splits=[<span class="hljs-string">'train'</span>, <span class="hljs-string">'dev'</span>, <span class="hljs-string">'test'</span>]
)

<span class="hljs-comment"># 查看数据集信息</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"训练集样本数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(train_ds)}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"开发集样本数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(dev_ds)}</span>"</span>)   <span class="hljs-comment">#开发集用于模型的调优，如调整超参数？？</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"测试集样本数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(test_ds)}</span>"</span>)
</code></pre>
<h4 data-id="heading-9">3.2 探索数据</h4>
<p>我们来看一下数据集中的样本长什么样。每个样本都是一个字典，包含 <code>text</code> (评论文本) 和 <code>label</code> (情感标签) 两个字段。</p>
<p>In [39]</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 打印几条训练集样本</span>
<span class="hljs-comment"># lable值为1，则为积极；值为0，则为消极。模型学习的目标就是看到text，猜label</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 训练集样本示例 ---"</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"样本 <span class="hljs-subst">{i}</span>:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  文本: <span class="hljs-subst">{train_ds[i][<span class="hljs-string">'text'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  标签: <span class="hljs-subst">{train_ds[i][<span class="hljs-string">'label'</span>]}</span> (<span class="hljs-subst">{<span class="hljs-string">'积极'</span> <span class="hljs-keyword">if</span> train_ds[i][<span class="hljs-string">'label'</span>] == <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'消极'</span>}</span>)"</span>)

<span class="hljs-comment"># 打印几条开发集样本</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 开发集样本示例 ---"</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"样本 <span class="hljs-subst">{i}</span>:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  文本: <span class="hljs-subst">{dev_ds[i][<span class="hljs-string">'text'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  标签: <span class="hljs-subst">{dev_ds[i][<span class="hljs-string">'label'</span>]}</span> (<span class="hljs-subst">{<span class="hljs-string">'积极'</span> <span class="hljs-keyword">if</span> dev_ds[i][<span class="hljs-string">'label'</span>] == <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'消极'</span>}</span>)"</span>)
</code></pre>
<h4 data-id="heading-10">3.3 数据预处理与 Tokenization</h4>
<p>为了让数据能被ERNIE模型处理，我们需要进行两个关键步骤：</p>
<ol>
<li><strong>Tokenization</strong>：将原始的文本字符串转换为模型能够理解的数字ID序列。这个过程由 <strong>Tokenizer</strong> 完成。</li>
<li><strong>格式转换</strong>：将Tokenized后的数据整理成模型训练时接受的格式（如字典），并转换为 <code>paddle.Tensor</code>。</li>
</ol>
<h5 data-id="heading-11">3.3.1 加载 Tokenizer</h5>
<p>PaddleNLP为每个预训练模型都提供了配套的Tokenizer。我们选择与 <code>ernie-3.0-medium-zh</code> 模型匹配的 <code>ErnieTokenizer</code>。</p>
<p>In [40]</p>
<pre><code class="hljs language-ini" lang="ini">from paddlenlp.transformers import AutoTokenizer

<span class="hljs-comment"># 定义要使用的模型名称</span>
<span class="hljs-attr">MODEL_NAME</span> = <span class="hljs-string">"ernie-3.0-medium-zh"</span>

<span class="hljs-comment"># 加载对应的Tokenizer，AutoTokenizer是PaddleNLP提供的一个自动化工具，会根据给定的模型名称，加载对应的分词器</span>
<span class="hljs-attr">tokenizer</span> = AutoTokenizer.from_pretrained(MODEL_NAME)
</code></pre>
<h5 data-id="heading-12">3.3.2 构造数据处理函数</h5>
<p>我们将定义一个 <code>convert_example</code> 函数，它负责对<strong>单个样本</strong>进行处理。该函数会：</p>
<ol>
<li>调用 <code>tokenizer</code> 对文本进行编码。</li>
<li>返回一个包含 <code>input_ids</code>, <code>token_type_ids</code> 和 <code>label</code> 的字典。</li>
</ol>
<p><code>tokenizer()</code> 函数会为我们自动完成大部分工作，包括：</p>
<ul>
<li>将文本切分成字或词 (Token)。</li>
<li>将Token转换为数字ID。</li>
<li>添加特殊的Token，如 <code>[CLS]</code>（通常用作句子级别的表示）和 <code>[SEP]</code>（分隔符）。</li>
</ul>
<p>In [41]</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> functools

<span class="hljs-comment"># example 表示一个输入的数据</span>
<span class="hljs-comment"># 这个函数的作用是：将每条数据转化为模型所需要的输入格式</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">convert_example</span>(<span class="hljs-params">example, tokenizer, max_seq_length=<span class="hljs-number">128</span></span>):
    <span class="hljs-string">"""
    将单个样本转换为模型可接受的格式。
    """</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># 对输入文本进行编码</span>
        encoded_inputs = tokenizer(text=example[<span class="hljs-string">"text"</span>], max_seq_len=max_seq_length)
        
        <span class="hljs-comment"># 提取 input_ids 和 token_type_ids</span>
        <span class="hljs-comment"># input_ids：每个字对应的数字ID</span>
        <span class="hljs-comment"># token_type_ids 用于区分不同句子，单句分类任务全是0</span>
        input_ids = encoded_inputs[<span class="hljs-string">"input_ids"</span>]
        token_type_ids = encoded_inputs[<span class="hljs-string">"token_type_ids"</span>]
        

        label_str = example.get(<span class="hljs-string">"label"</span>, <span class="hljs-string">""</span>)   <span class="hljs-comment">#获取的标签是"1"或"0" 字符串格式</span>
        <span class="hljs-keyword">if</span> label_str == <span class="hljs-string">""</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span> <span class="hljs-comment"># 如果label为空，则跳过该样本</span>
        <span class="hljs-comment"># 把情感标签转化为整数，并包装为tensor格式</span>
        label = paddle.to_tensor([<span class="hljs-built_in">int</span>(label_str)], dtype=<span class="hljs-string">"int64"</span>)
        
        <span class="hljs-comment"># 返回模型接受的格式</span>
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"input_ids"</span>: input_ids, <span class="hljs-string">"token_type_ids"</span>: token_type_ids, <span class="hljs-string">"labels"</span>: label}
    
    <span class="hljs-keyword">except</span> (ValueError, TypeError):
        <span class="hljs-comment"># 如果 int() 转换失败或 example 格式不正确，也跳过该样本</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Skipping invalid sample: <span class="hljs-subst">{example}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-comment"># functools.partial：可以创建一个新的函数，固定了原始函数的某些参数</span>
<span class="hljs-comment"># 固定了convert_example函数的tokenizer 和 max_seq_length参数</span>
trans_func = functools.partial(convert_example, tokenizer=tokenizer, max_seq_length=<span class="hljs-number">128</span>)

<span class="hljs-comment"># -- 鲁棒性检查 --</span>
<span class="hljs-comment"># 检查 train_ds 是否已被处理 (即其元素是否为元组)。如果是，则重新加载原始数据集。</span>
<span class="hljs-comment"># 为了防止代码被多次运行时出现数据重复处理的情况</span>
<span class="hljs-keyword">if</span> train_ds <span class="hljs-keyword">and</span> <span class="hljs-built_in">isinstance</span>(train_ds[<span class="hljs-number">0</span>], <span class="hljs-built_in">tuple</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"检测到数据集已被处理，正在重新加载原始数据集..."</span>)
    train_ds, dev_ds, test_ds = load_dataset(<span class="hljs-string">'chnsenticorp'</span>, splits=[<span class="hljs-string">'train'</span>, <span class="hljs-string">'dev'</span>, <span class="hljs-string">'test'</span>])
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"原始数据集已重新加载。"</span>)

<span class="hljs-comment"># 使用 map 方法对数据集中的所有样本应用 trans_func</span>
<span class="hljs-comment"># lazy=False 表示立刻对数据集进行处理；如果是True，直到实际访问时才会转换</span>
<span class="hljs-comment"># map会将每个样本都传递给trans_func，从而将文本转化为需要的格式</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n正在对数据集进行预处理..."</span>)
train_ds_processed_raw = train_ds.<span class="hljs-built_in">map</span>(trans_func, lazy=<span class="hljs-literal">False</span>)
dev_ds_processed_raw = dev_ds.<span class="hljs-built_in">map</span>(trans_func, lazy=<span class="hljs-literal">False</span>)
test_ds_processed_raw = test_ds.<span class="hljs-built_in">map</span>(trans_func, lazy=<span class="hljs-literal">False</span>)

<span class="hljs-comment"># 过滤掉返回值为 None 的无效样本</span>
train_ds_processed = [item <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> train_ds_processed_raw <span class="hljs-keyword">if</span> item <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>]
dev_ds_processed = [item <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> dev_ds_processed_raw <span class="hljs-keyword">if</span> item <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>]
test_ds_processed = [item <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> test_ds_processed_raw <span class="hljs-keyword">if</span> item <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>]

<span class="hljs-comment"># 重新包装为 MapDataset (可选，但为了后续API一致性更好)</span>
<span class="hljs-keyword">from</span> paddlenlp.datasets <span class="hljs-keyword">import</span> MapDataset
train_ds_processed = MapDataset(train_ds_processed)
dev_ds_processed = MapDataset(dev_ds_processed)
test_ds_processed = MapDataset(test_ds_processed)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"数据预处理和清洗完成！"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理后训练集样本数量: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(train_ds_processed)}</span>"</span>)
<span class="hljs-comment"># 查看一个处理后的样本</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(train_ds_processed) &gt; <span class="hljs-number">0</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"处理后的第一个训练样本:"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  Input IDs: <span class="hljs-subst">{train_ds_processed[<span class="hljs-number">0</span>][<span class="hljs-string">'input_ids'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  Token Type IDs: <span class="hljs-subst">{train_ds_processed[<span class="hljs-number">0</span>][<span class="hljs-string">'token_type_ids'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  Label: <span class="hljs-subst">{train_ds_processed[<span class="hljs-number">0</span>][<span class="hljs-string">'labels'</span>]}</span>"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"没有有效的训练样本被处理。"</span>)
</code></pre>
<p>现在，我们的数据集已经准备好了，每个样本都包含了模型训练所需的 <code>input_ids</code>, <code>token_type_ids</code>, 和 <code>label</code>。</p>
<h4 data-id="heading-13">3.4 构造 DataLoader</h4>
<p>最后一步是将处理好的数据集组织成批次 (Batch) 的形式，以便在训练时高效地送入模型。我们使用 <code>paddle.io.DataLoader</code> 来完成这个任务。它还可以帮助我们进行数据的打乱 (shuffle) 和自动的批处理。</p>
<p>我们会使用 <code>paddlenlp.data.DataCollatorWithPadding</code> 来自动地将每个批次内的样本填充 (padding) 到该批次中最长样本的长度。</p>
<p>In [42]</p>
<pre><code class="hljs language-ini" lang="ini">from paddle.io import DataLoader
from paddlenlp.data import DataCollatorWithPadding

<span class="hljs-comment"># 初始化 DataCollator，它会自动处理批数据的padding</span>
<span class="hljs-attr">collator</span> = DataCollatorWithPadding(tokenizer)

<span class="hljs-comment"># 定义批大小</span>
<span class="hljs-attr">batch_size</span> = <span class="hljs-number">32</span>

<span class="hljs-comment"># 创建DataLoader，负责按批次加载数据</span>
<span class="hljs-attr">train_loader</span> = DataLoader(
    <span class="hljs-attr">dataset</span>=train_ds,
    <span class="hljs-attr">batch_size</span>=batch_size,
    <span class="hljs-attr">shuffle</span>=<span class="hljs-literal">True</span>, <span class="hljs-comment"># 训练时打乱数据</span>
    <span class="hljs-attr">collate_fn</span>=collator  <span class="hljs-comment"># 使用DataCollatorWithPadding对每批数据进行填充，使得所有句子的长度相同</span>
)
<span class="hljs-attr">dev_loader</span> = DataLoader(
    <span class="hljs-attr">dataset</span>=dev_ds,
    <span class="hljs-attr">batch_size</span>=batch_size,
    <span class="hljs-attr">shuffle</span>=<span class="hljs-literal">False</span>, <span class="hljs-comment"># 评估时不需要打乱</span>
    <span class="hljs-attr">collate_fn</span>=collator
)
<span class="hljs-attr">test_loader</span> = DataLoader(
    <span class="hljs-attr">dataset</span>=test_ds,
    <span class="hljs-attr">batch_size</span>=batch_size,
    <span class="hljs-attr">shuffle</span>=<span class="hljs-literal">False</span>,
    <span class="hljs-attr">collate_fn</span>=collator
)

<span class="hljs-comment"># 查看一个批次的数据形状</span>
print("\nDataLoader准备完成！")
for batch in train_loader:
    print("一个批次的数据:")
    for key, value in batch.items():
        print(f"  {key}: <span class="hljs-attr">shape</span>={value.shape}<span class="hljs-string">")
    break # 只看第一个批次
</span></code></pre>
<p>至此，数据准备的全部工作已经完成。我们拥有了可以随时送入模型进行训练的DataLoader。</p>
<h3 data-id="heading-14">4. 模型与微调原理</h3>
<p>在数据准备就绪后，我们需要理解我们将要使用的模型以及如何让它适应我们的情感分析任务。</p>
<h4 data-id="heading-15">4.1 ERNIE 模型简介：一位懂知识的语言大师</h4>
<p>正如引言中所说，ERNIE 是一个更"懂"中文的模型。它的核心优势在于其独特的<strong>知识整合预训练任务</strong>。</p>
<ul>
<li>
<p><strong>一个更深入的比喻</strong>： 想象一个学生（其他模型）在学习一句话："中国四大发明之一的活字印刷术是由毕昇发明的。" 这个学生可能通过"单字填空"学会了"（活）字印刷术"和"毕（昇）"这些字。</p>
<p>而ERNIE这位"学霸"则不同，老师会直接将"<strong>活字印刷术</strong>"和"<strong>毕昇</strong>"这两个完整的知识单元盖住，让他去预测。为了能答对，ERNIE不仅仅要学习语言的流畅性，更被迫去理解"活字印刷术"是一个完整的技术概念，"毕昇"是一个人名，并且这两个知识单元之间存在"发明"的关联。</p>
<p>通过在海量文本上进行这种"知识点挖掘"式的学习，ERNIE构建了更深层次的语义理解能力，而不仅仅是表面的文字组合。</p>
</li>
</ul>
<p>这就是为什么ERNIE在需要理解句子深层含义的任务（如情感分析）上通常表现得更好的原因。</p>
<h4 data-id="heading-16">4.2 微调 (Fine-tuning) 原理：为语言大师配上"情感分析眼镜"</h4>
<p>我们加载的 <code>ernie-3.0-medium-zh</code> 模型是一位博学的"通才"，它懂得语言的各种知识，但默认情况下，它并不知道自己需要做"情感分析"这项具体工作。<strong>微调 (Fine-tuning)</strong>  的过程，就好比是为这位语言大师配上一副特制的"情感分析眼镜"，并指导他如何使用。</p>
<p>这个过程分为几步：</p>
<ol>
<li>
<p><strong>获取句子的"灵魂"——[CLS]输出</strong>：</p>
<ul>
<li>我们将一条评论文本（例如"这家店的拉面真好吃！"）送入ERNIE模型。在送入前，我们在文本最前面加上一个特殊的标志 <code>[CLS]</code> (Classification)。</li>
<li>经过ERNIE内部复杂的计算（多层Transformer），每个字词都会得到一个富含上下文信息的向量。而这个特殊的 <code>[CLS]</code> 标志，在经过整个模型后，它对应的输出向量 (<code>pooled_output</code>) 就被设计为凝聚了整个句子的核心语义。我们可以把它比作ERNIE读完一句话后，在脑海中形成的对这句话的"整体印象"或"灵魂"向量。</li>
</ul>
</li>
<li>
<p><strong>安装"情感分析镜片"——添加分类头</strong>：</p>
<ul>
<li>这个"灵魂"向量（例如一个768维的向量）本身还只是一串数字，不直接代表"积极"或"消极"。</li>
<li>我们在这串数字后面接上一个非常简单的"镜片"——一个<strong>全连接层 (Linear Layer)</strong> 。这个全连接层就是"分类头"，它的任务非常专一：接收代表句子灵魂的向量，然后将其转换为对我们任务有意义的输出。</li>
<li>在我们的二分类任务中，这个"镜片"有两个输出神经元，一个代表"消极"的可能性，一个代表"积极"的可能性。</li>
</ul>
</li>
<li>
<p><strong>"校准眼镜"——训练与反向传播</strong>：</p>
<ul>
<li>现在，我们有了一个戴着"情感分析眼镜"的ERNIE模型。我们把准备好的标注数据（成千上万条已知情感的评论）喂给它。</li>
<li>对于每条评论，模型会通过"眼镜"给出一个初步的判断（例如，"消极"得分0.1，"积极"得分0.9）。</li>
<li>我们拿这个判断和真实标签（比如这条评论的真实标签是"积极"）去比较。如果判断准确，说明"眼镜"校准得不错；如果判断错误，就计算出一个"误差"（即<strong>交叉熵损失</strong>）。</li>
<li>这个"误差"信号会反向传播，像一个校准指令一样，不仅会微调"镜片"（分类头）的参数，让它判断得更准，<strong>更重要的是，它也会微调ERNIE这位语言大师本身的参数</strong>，让他以后在阅读文本时，能更侧重于那些与情感相关的语义信息。</li>
</ul>
</li>
</ol>
<p>经过成千上万次这样的"校准"，ERNIE大师和他的"情感分析眼镜"就配合得天衣无缝了。他不仅能读懂句子的意思，还能准确地判断出其中蕴含的情感。</p>
<p>[大模型精调原理介绍]</p>
<p>图3: 大模型精调原理示意图 (来源: 大模型精调新手指南.md)</p>
<p>上图宏观地展示了对大模型进行精调的两种主要方式。我们本教程采用的是 <strong>SFT (Supervised Fine-Tuning)</strong> ，也称为<strong>全参数微调</strong>。这意味着在训练过程中，我们会更新ERNIE模型的所有参数（图中的蓝色部分）以及新添加的分类头，让整个模型都来适配我们的情感分析任务。</p>
<p>幸运的是，PaddleNLP 的 <code>AutoModelForSequenceClassification</code> 已经帮我们完成了"装配眼镜"的工作。我们只需要加载模型，它就会自动为我们搭建好"ERNIE大师 + 分类头"的结构，让我们能专注于"校准眼镜"的训练过程。</p>
<h3 data-id="heading-17">5. 模型微调</h3>
<p>现在，我们将所有部分组合起来，开始训练我们的情感分析模型。我们将定义模型、优化器、损失函数，并编写训练和评估的逻辑。</p>
<h4 data-id="heading-18">5.1 加载模型</h4>
<p>我们使用 <code>paddlenlp.transformers.AutoModelForSequenceClassification</code> 来加载一个带有序列分类头的ERNIE模型。我们只需指定预训练模型的名称 <code>MODEL_NAME</code> 和分类的类别数 <code>num_classes</code>。</p>
<p>In [43]</p>
<pre><code class="hljs language-ini" lang="ini">from paddlenlp.transformers import AutoModelForSequenceClassification

<span class="hljs-comment"># 类别数量 (消极, 积极)</span>
<span class="hljs-attr">num_classes</span> = len(train_ds.label_list)

<span class="hljs-comment"># 加载一个适合分类任务的模型jia</span>
<span class="hljs-attr">model</span> = AutoModelForSequenceClassification.from_pretrained(MODEL_NAME, num_classes=num_classes)

<span class="hljs-comment"># 打印模型结构</span>
print(model)
</code></pre>
<p>您可以看到模型结构，最后一部分是一个 <code>(classifier): Linear</code> 层，这就是我们添加的分类头。</p>
<h4 data-id="heading-19">5.2 定义优化器和损失函数</h4>
<ul>
<li><strong>优化器 (Optimizer)</strong>  ：我们使用经典的 <code>AdamW</code> 优化器，它在Transformer模型的训练中表现良好。</li>
<li><strong>学习率调度器 (Learning Rate Scheduler)</strong>  ：为了更好的训练效果，我们使用动态学习率。这里采用 <code>LinearDecayWithWarmup</code>，它会在训练初期有一个"预热 (warmup)"阶段，学习率从0线性增长到设定的初始值，之后再随着训练步数线性衰减到0。这有助于模型在训练初期更稳定，在后期更精细地收敛。</li>
<li><strong>损失函数 (Loss Function)</strong> ：对于分类任务，我们使用标准的<strong>交叉熵损失函数</strong> <code>paddle.nn.CrossEntropyLoss</code>。</li>
<li><strong>评估指标 (Metric)</strong> ：我们使用<strong>准确率 (Accuracy)</strong>  来衡量模型在开发集和测试集上的性能。</li>
</ul>
<p>In [44]</p>
<pre><code class="hljs language-ini" lang="ini">import paddle
from paddlenlp.transformers import LinearDecayWithWarmup

<span class="hljs-comment"># 训练的总步数</span>
<span class="hljs-attr">num_training_steps</span> = len(train_loader) * <span class="hljs-number">3</span> <span class="hljs-comment"># 假设我们训练3个epoch</span>

<span class="hljs-comment"># 定义学习率调度器</span>
<span class="hljs-comment"># 前10%学习率会从0慢慢增加，到设定的初始学习率，学习率逐渐变大，可以让模型更加稳定地学习。</span>
<span class="hljs-comment"># 再预热结束后，会从初始学习率逐渐减少，指导训练结束。</span>
<span class="hljs-comment"># deacy：当模型接近收敛时，学习率变得太大会导致模型跳过最优解，因此我们希望学习率逐渐减小，让模型能精细调整，找到最优的参数。</span>
<span class="hljs-attr">lr_scheduler</span> = LinearDecayWithWarmup(
    <span class="hljs-attr">learning_rate</span>=<span class="hljs-number">3</span>e-<span class="hljs-number">5</span>, <span class="hljs-comment"># 初始学习率</span>
    <span class="hljs-attr">total_steps</span>=num_training_steps,
    <span class="hljs-attr">warmup</span>=<span class="hljs-number">0.1</span> <span class="hljs-comment"># 使用10%的steps进行warmup</span>
)

<span class="hljs-comment"># 定义优化器</span>
<span class="hljs-attr">optimizer</span> = paddle.optimizer.AdamW(
    <span class="hljs-attr">learning_rate</span>=lr_scheduler,  <span class="hljs-comment"># 优化器的学习率 </span>
    <span class="hljs-attr">parameters</span>=model.parameters()  <span class="hljs-comment"># 指定优化器要优化的参数，这里是优化所有参数</span>
)

<span class="hljs-comment"># 定义损失函数，交叉熵损失函数是分类问题中最常用的损失函数</span>
<span class="hljs-attr">criterion</span> = paddle.nn.CrossEntropyLoss()

<span class="hljs-comment"># 定义评估指标</span>
<span class="hljs-attr">metric</span> = paddle.metric.Accuracy()
</code></pre>
<h4 data-id="heading-20">5.3 编写训练与评估循环</h4>
<p>现在，我们编写核心的训练和评估逻辑。</p>
<ul>
<li>
<p><strong><code>train_epoch()</code> 函数</strong>: 负责一个epoch的完整训练流程。</p>
<ul>
<li>将模型设置为训练模式 (<code>model.train()</code>)。</li>
<li>遍历 <code>train_loader</code> 中的所有批次。</li>
<li>对于每个批次，执行前向计算、计算损失、反向传播、更新参数。</li>
<li>定期打印日志，显示当前的loss和学习率等信息。</li>
</ul>
</li>
<li>
<p><strong><code>evaluate()</code> 函数</strong>: 负责在开发集或测试集上进行评估。</p>
<ul>
<li>将模型设置为评估模式 (<code>model.eval()</code>)。</li>
<li>关闭梯度计算 (<code>@paddle.no_grad()</code>) 以节省显存和加速。</li>
<li>遍历 <code>dev_loader</code> 中的所有批次。</li>
<li>计算模型预测的准确率。</li>
</ul>
</li>
</ul>
<p>In [45]</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> paddle.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> os <span class="hljs-comment"># 导入os模块</span>

<span class="hljs-meta">@paddle.no_grad()  </span><span class="hljs-comment"># 关闭梯度计算</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate</span>(<span class="hljs-params">model, criterion, metric, data_loader</span>):
    <span class="hljs-string">"""
    1. 在给定数据集上评估模型，返回精确度。
    2. model 是一个已经定义并训练过的深度学习模型，它用于对输入数据进行推理（即预测）
    """</span>
    model.<span class="hljs-built_in">eval</span>()  <span class="hljs-comment"># 设置模型为评估模式</span>
    metric.reset()  <span class="hljs-comment"># 重置评估指标</span>
    losses = []  <span class="hljs-comment"># 用来存储每个批次的损失</span>
    <span class="hljs-keyword">for</span> batch <span class="hljs-keyword">in</span> data_loader:
        input_ids, token_type_ids, labels = batch[<span class="hljs-string">'input_ids'</span>], batch[<span class="hljs-string">'token_type_ids'</span>], batch[<span class="hljs-string">'labels'</span>]
        
        logits = model(input_ids, token_type_ids)  <span class="hljs-comment"># 前向计算，得到模型输出</span>
        loss = criterion(logits, labels)  <span class="hljs-comment"># 计算损失</span>
        losses.append(loss.numpy()) <span class="hljs-comment"># 将损失值添加到损失列表</span>
        
        correct = metric.compute(logits, labels) <span class="hljs-comment"># 计算当前批次的准确度</span>
        metric.update(correct)  <span class="hljs-comment"># 更新评估指标</span>
        
    accuracy = metric.accumulate()  <span class="hljs-comment"># 计算整体准确率</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Eval loss: <span class="hljs-subst">{paddle.to_tensor(losses).mean().item():<span class="hljs-number">.5</span>f}</span>, Accuracy: <span class="hljs-subst">{accuracy:<span class="hljs-number">.5</span>f}</span>"</span>)
    model.train()  <span class="hljs-comment"># 将模型恢复为训练模式</span>
    <span class="hljs-keyword">return</span> accuracy


<span class="hljs-keyword">def</span> <span class="hljs-title function_">do_train</span>(<span class="hljs-params">epochs=<span class="hljs-number">3</span></span>):
    <span class="hljs-string">"""
    执行完整的训练和评估流程。
    """</span>
    best_accuracy = <span class="hljs-number">0.0</span>   <span class="hljs-comment"># 初始化最佳准确率</span>
    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, epochs + <span class="hljs-number">1</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n--- Epoch <span class="hljs-subst">{epoch}</span> ---"</span>)
        
        <span class="hljs-comment"># 训练</span>
        model.train()  <span class="hljs-comment"># 设置模型为训练模式</span>
        <span class="hljs-keyword">for</span> step, batch <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(train_loader, start=<span class="hljs-number">1</span>):
            input_ids, token_type_ids, labels = batch[<span class="hljs-string">'input_ids'</span>], batch[<span class="hljs-string">'token_type_ids'</span>], batch[<span class="hljs-string">'labels'</span>]
            
            <span class="hljs-comment"># 前向计算</span>
            logits = model(input_ids, token_type_ids)
            
            <span class="hljs-comment"># 计算损失</span>
            loss = criterion(logits, labels)
            
            <span class="hljs-comment"># 每100步打印一次log</span>
            <span class="hljs-keyword">if</span> step % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>:
                <span class="hljs-built_in">print</span>(
                    <span class="hljs-string">f"Epoch <span class="hljs-subst">{epoch}</span>, Step <span class="hljs-subst">{step}</span>/<span class="hljs-subst">{<span class="hljs-built_in">len</span>(train_loader)}</span>, "</span>
                    <span class="hljs-string">f"Loss: <span class="hljs-subst">{loss.item():<span class="hljs-number">.5</span>f}</span>, "</span>
                    <span class="hljs-string">f"LR: <span class="hljs-subst">{lr_scheduler.get_lr():<span class="hljs-number">.7</span>f}</span>"</span>
                )
            
            <span class="hljs-comment"># 反向传播和参数更新</span>
            loss.backward()  <span class="hljs-comment"># 计算梯度</span>
            optimizer.step()  <span class="hljs-comment"># 更新模型参数</span>
            lr_scheduler.step()  <span class="hljs-comment"># 更新学习率</span>
            optimizer.clear_grad()  <span class="hljs-comment"># 清除梯度，为下一次迭代做准备</span>

        <span class="hljs-comment"># 每个epoch结束后，在开发集上进行评估</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"--- Evaluating on Dev Set after Epoch <span class="hljs-subst">{epoch}</span> ---"</span>)
        accuracy = evaluate(model, criterion, metric, dev_loader)
        
        <span class="hljs-comment"># 保存表现最好的模型</span>
        <span class="hljs-keyword">if</span> accuracy &gt; best_accuracy:
            best_accuracy = accuracy
            <span class="hljs-comment"># 创建保存目录</span>
            save_dir = <span class="hljs-string">"ernie_senti_checkpoint_best"</span>
            os.makedirs(save_dir, exist_ok=<span class="hljs-literal">True</span>)  <span class="hljs-comment"># 创建目录，如果已存在则不报错</span>
            <span class="hljs-comment"># 保存模型和tokenizer</span>
            model.save_pretrained(save_dir)
            tokenizer.save_pretrained(save_dir)  <span class="hljs-comment"># 保存训练好的模型</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Best model saved with accuracy: <span class="hljs-subst">{best_accuracy:<span class="hljs-number">.5</span>f}</span> at '<span class="hljs-subst">{save_dir}</span>'"</span>)  <span class="hljs-comment"># 保存模型使用的分词器 </span>

<span class="hljs-comment"># 开始训练！</span>
<span class="hljs-comment"># 通常在GPU上，每个epoch大约需要几分钟。</span>
do_train(epochs=<span class="hljs-number">3</span>)
</code></pre>
<p><strong>日志解读</strong>： 在训练过程中，您会看到类似下面的日志：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">---</span> <span class="hljs-string">Epoch</span> <span class="hljs-number">1</span> <span class="hljs-string">---</span>
<span class="hljs-string">Epoch</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-string">Step</span> <span class="hljs-number">100</span><span class="hljs-string">/300,</span> <span class="hljs-attr">Loss:</span> <span class="hljs-number">0.34567</span><span class="hljs-string">,</span> <span class="hljs-attr">LR:</span> <span class="hljs-number">0.0000280</span>
<span class="hljs-string">Epoch</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-string">Step</span> <span class="hljs-number">200</span><span class="hljs-string">/300,</span> <span class="hljs-attr">Loss:</span> <span class="hljs-number">0.21345</span><span class="hljs-string">,</span> <span class="hljs-attr">LR:</span> <span class="hljs-number">0.0000250</span>
<span class="hljs-string">Epoch</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-string">Step</span> <span class="hljs-number">300</span><span class="hljs-string">/300,</span> <span class="hljs-attr">Loss:</span> <span class="hljs-number">0.18765</span><span class="hljs-string">,</span> <span class="hljs-attr">LR:</span> <span class="hljs-number">0.0000220</span>
<span class="hljs-string">---</span> <span class="hljs-string">Evaluating</span> <span class="hljs-string">on</span> <span class="hljs-string">Dev</span> <span class="hljs-string">Set</span> <span class="hljs-string">after</span> <span class="hljs-string">Epoch</span> <span class="hljs-number">1</span> <span class="hljs-string">---</span>
<span class="hljs-attr">Eval loss:</span> <span class="hljs-number">0.25012</span><span class="hljs-string">,</span> <span class="hljs-attr">Accuracy:</span> <span class="hljs-number">0.92500</span>
<span class="hljs-attr">Best model saved with accuracy:</span> <span class="hljs-number">0.92500</span> <span class="hljs-string">at</span> <span class="hljs-string">'ernie_senti_checkpoint_best'</span>
</code></pre>
<p>我们期望看到：</p>
<ul>
<li><strong>Loss</strong>：在训练过程中稳步下降。</li>
<li><strong>Accuracy</strong>：在开发集上的准确率稳步提升。</li>
<li><strong>模型保存</strong>：当开发集上的准确率超过之前的最佳记录时，模型会被保存到 <code>ernie_senti_checkpoint_best</code> 目录中。</li>
</ul>
<p>训练完成后，这个目录里就包含了我们性能最好的情感分析模型。</p>
<h3 data-id="heading-21">6. 模型预测</h3>
<p>训练完成后，并使用它来对新文本进行情感预测。</p>
<p>In [46]</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 加载之前保存的最佳模型</span>
<span class="hljs-comment"># 如果训练中断或在不同环境中运行，请确保 'ernie_senti_checkpoint_best' 目录存在</span>
<span class="hljs-comment"># 并且其中包含模型文件</span>

save_dir = <span class="hljs-string">"ernie_senti_checkpoint_best"</span>

<span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># 重新加载最佳模型和对应的tokenizer</span>
    model = AutoModelForSequenceClassification.from_pretrained(save_dir)
    tokenizer = AutoTokenizer.from_pretrained(save_dir)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"最佳模型已成功加载！"</span>)
    
<span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"加载模型或评估时发生错误: <span class="hljs-subst">{e}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"请确保训练已成功完成，并且'ernie_senti_checkpoint_best'目录存在且包含模型文件。"</span>)
</code></pre>
<p>现在，让我们来创建一个简单易用的预测函数，它可以接收一个或多个中文句子，并返回它们的情感分析结果。</p>
<p>In [47]</p>
<pre><code class="hljs language-python" lang="python">   <span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-keyword">def</span> <span class="hljs-title function_">predict</span>(<span class="hljs-params">model, tokenizer, texts, label_map</span>):
    <span class="hljs-string">"""
    给定模型、分词器、文本列表和标签映射，预测情感。
    """</span>
    <span class="hljs-comment"># 将模型设置为评估模式</span>
    model.<span class="hljs-built_in">eval</span>()
    
    <span class="hljs-comment"># 对输入文本进行分词和处理</span>
    <span class="hljs-comment"># texts可以是单个字符串或字符串列表</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(texts, <span class="hljs-built_in">str</span>):
        texts = [texts]
        
    encoded_inputs = tokenizer(text=texts, max_seq_len=<span class="hljs-number">128</span>, padding=<span class="hljs-literal">True</span>)
    input_ids = paddle.to_tensor(encoded_inputs[<span class="hljs-string">"input_ids"</span>])
    token_type_ids = paddle.to_tensor(encoded_inputs[<span class="hljs-string">"token_type_ids"</span>])
    
    <span class="hljs-comment"># 关闭梯度计算</span>
    <span class="hljs-keyword">with</span> paddle.no_grad():
        logits = model(input_ids, token_type_ids)
    
    <span class="hljs-comment"># 通过softmax获取概率，并通过argmax获取最可能的类别索引</span>
    probs = F.softmax(logits, axis=<span class="hljs-number">1</span>)
    label_ids = paddle.argmax(probs, axis=<span class="hljs-number">1</span>).numpy()
    
    <span class="hljs-comment"># 将类别索引映射回标签文字</span>
    results = [label_map[label_id] <span class="hljs-keyword">for</span> label_id <span class="hljs-keyword">in</span> label_ids]
    
    <span class="hljs-keyword">return</span> results

<span class="hljs-comment"># 定义标签映射</span>
label_map = {<span class="hljs-number">0</span>: <span class="hljs-string">'消极'</span>, <span class="hljs-number">1</span>: <span class="hljs-string">'积极'</span>}

<span class="hljs-comment"># 待预测的数据</span>
data_to_predict = [
    <span class="hljs-string">'这家酒店的早餐太好吃了，下次还来！'</span>,
    <span class="hljs-string">'房间隔音太差了，晚上根本睡不着。'</span>,
    <span class="hljs-string">'服务态度一般，没什么特别的感觉。'</span>, <span class="hljs-comment"># 这条可能比较中性，看看模型的判断</span>
    <span class="hljs-string">'风景不错，但是交通不太方便。'</span>      <span class="hljs-comment"># 包含正负两方面信息</span>
]

<span class="hljs-comment"># 进行预测</span>
<span class="hljs-keyword">if</span> <span class="hljs-string">'model'</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">globals</span>():
    results = predict(model, tokenizer, data_to_predict, label_map)
    <span class="hljs-keyword">for</span> text, label <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(data_to_predict, results):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文本: <span class="hljs-subst">{text}</span> -&gt; 预测情感: <span class="hljs-subst">{label}</span>"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"模型未加载，无法进行预测。"</span>)
</code></pre>
<p>通过这个 <code>predict</code> 函数，您就可以方便地将训练好的情感分析能力集成到您自己的应用中，或者用它来分析任何您感兴趣的中文文本了！</p>
<h3 data-id="heading-22">7. 总结与展望</h3>
<p>本教程从零开始，带您完成了基于ERNIE模型的中文情感分析任务的整个流程。</p>
<p><strong>我们回顾一下核心步骤</strong>：</p>
<ol>
<li><strong>环境准备</strong>：安装了PaddlePaddle和PaddleNLP。</li>
<li><strong>数据探索</strong>：加载并分析了<code>ChnSentiCorp</code>数据集。</li>
<li><strong>数据预处理</strong>：使用ERNIE Tokenizer对文本进行编码，并创建了DataLoader。</li>
<li><strong>模型微调</strong>：加载<code>ErnieForSequenceClassification</code>模型，定义优化器和损失函数，并编写了训练和评估循环，最终训练并保存了最佳模型。</li>
<li><strong>评估与预测</strong>：在测试集上验证了模型的最终性能，并创建了一个实用的预测函数来分析新文本。</li>
</ol>
<p><strong>后续可以探索的方向</strong>：</p>
<ul>
<li><strong>尝试更强大的模型</strong>：可以尝试<code>ernie-3.0-base-zh</code>或<code>ernie-3.0-xbase-zh</code>等更大规模的ERNIE模型，可能会获得更高的准确率。</li>
<li><strong>参数高效微调 (PEFT)</strong> ：对于更大的模型，全参数微调成本较高。可以学习使用LoRA等PEFT方法，在冻结大部分ERNIE参数的情况下进行微调，显著降低资源消耗。</li>
<li><strong>三分类任务</strong>：在更复杂的数据集上进行（积极、消极、中性）三分类任务。</li>
<li><strong>模型部署</strong>：学习如何将训练好的模型导出为静态图格式，并使用Paddle Serving或FastDeploy进行服务化部署，以供生产环境使用。</li>
<li><strong>应用到您自己的数据</strong>：将本教程的流程应用到您自己领域的文本数据上，构建一个定制化的情感分析系统。</li>
</ul>
<p>希望本教程能帮助您成功入门中文文本分类任务！如果您有任何问题，欢迎查阅PaddleNLP的官方文档或向社区提问。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Andrej Karpathy：2025 年 LLM 领域的六项范式转变]]></title>    <link>https://juejin.cn/post/7592853243731689512</link>    <guid>https://juejin.cn/post/7592853243731689512</guid>    <pubDate>2026-01-09T02:53:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592853243731689512" data-draft-id="7592873628586098688" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Andrej Karpathy：2025 年 LLM 领域的六项范式转变"/> <meta itemprop="keywords" content="人工智能,LLM,面试"/> <meta itemprop="datePublished" content="2026-01-09T02:53:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Baihai_IDP"/> <meta itemprop="url" content="https://juejin.cn/user/3123071228582343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Andrej Karpathy：2025 年 LLM 领域的六项范式转变
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3123071228582343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Baihai_IDP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T02:53:35.000Z" title="Fri Jan 09 2026 02:53:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>编者按：</strong> 我们今天为大家带来的文章，作者的核心观点是：2025 年大语言模型的真正突破不在于参数规模的扩张，而在于训练范式、智能形态与应用架构的深层转变 —— 尤其是基于可验证奖励的强化学习（RLVR）、AI 作为“幽灵”而非“动物”的认知重构，以及面向垂直场景的新型 LLM 应用层的崛起。</p>
<p>文章系统回顾了 2025 年 LLM 领域的六大关键趋势：首先，RLVR 成为新训练核心，通过可自动验证的奖励信号，模型自发演化出类推理行为；其次，作者提出“召唤幽灵”隐喻，强调 LLM 智能与生物智能在底层逻辑上的根本差异，并解释了其“锯齿状智能”——在某些任务上超人，在另一些任务上却异常脆弱；第三，以 Cursor 为代表的新型 LLM 应用层，通过上下文工程、多调用编排与“自主性滑块”，正在重塑人机协作范式；此外，Claude Code 展示了本地化 AI 智能体的潜力，vibe coding 让编程走向大众化，而 Google Gemini Nano banana 则预示了 LLM 图形用户界面（GUI）的未来方向。</p>
</blockquote>
<p><strong>作者 | Andrej Karpathy</strong></p>
<p><strong>编译 | 岳扬</strong></p>
<p>2025 年是大语言模型（LLM）发展势头强劲、进步显著的一年。以下是我个人认为值得关注且略感意外的几项“范式转变”，这些改变技术格局的概念性突破让我印象深刻。</p>
<h2 data-id="heading-0"><strong>01 基于可验证奖励的强化学习（Reinforcement Learning from Verifiable Rewards, RLVR）</strong></h2>
<p>2025 年初，各大实验室的 LLM 生产训练流程大致如下：</p>
<p>1）预训练（GPT-2/3，~ 2020 年）</p>
<p>2）监督微调（InstructGPT，~ 2022 年）以及</p>
<p>3）基于人类反馈的强化学习（RLHF，~ 2022 年）</p>
<p>这套成熟方案曾长期被视为生产级 LLM 的训练标准。然而到了 2025 年，基于可验证奖励的强化学习（RLVR） 成为被广泛接受和采用的新核心训练阶段。通过在多种环境中（例如数学题或编程题这类场景）让 LLM 针对可自动验证的奖励进行训练，模型会自发地发展出一些在人类看来像是“推理”的策略 —— 它们学会将问题求解过程拆解为一系列中间计算步骤，并掌握多种来回试探、逐步厘清问题的解题策略（参见 DeepSeek R1 论文中的示例）。在原有范式下，这类策略极难实现，因为 LLM 并不清楚“最优的推理路径”或“对错误的修正方式”究竟长什么样 —— 它必须通过针对奖励信号的优化过程，自己摸索出对自己有效的方法。</p>
<p>与 SFT 和 RLHF 这两个计算量相对较小、训练周期较短的阶段不同，RLVR 依赖于客观（不可作弊）的奖励函数，因此支持更长时间的优化。<strong>事实证明，RLVR 在单位算力下的能力提升（capability / $）非常高，导致原本用于预训练的计算资源被大量转移至此。</strong> 因此，2025 年大部分模型能力的提升，主要来自于各大 LLM 实验室集中算力“消化”这一新训练阶段（RLVR）所释放出的潜力。总体来看，我们看到的模型参数规模大致相当，但强化学习（RL）的训练时长显著增加。此外，这一新阶段还带来了一个全新的“调节旋钮”（以及与之对应的缩放规律）：通过生成更长的推理轨迹、增加“思考时间”，即可在推理时以更多计算换取更强能力。OpenAI 的 o1 模型（2024 年底）首次展示了 RLVR 的效果，但真正让人直观感受到质变的拐点，是 2025 年初发布的 o3 版本。</p>
<h2 data-id="heading-1"><strong>02 Ghosts vs. Animals / Jagged Intelligence</strong></h2>
<p>2025 年是我（而且我认为整个行业也是如此）第一次开始以更直觉、更切身的方式，理解 LLM 智能的“形态”。我们并非在“进化/培育动物”，而是在“召唤幽灵”。<strong>LLM 技术栈的方方面面 —— 包括神经网络架构、训练数据、训练算法，尤其是目标函数对模型行为的塑造力（Optimization pressure）都与生物智能截然不同，因此我们所获得的智能体在智能空间中自然也大不相同，用动物的视角去理解它们是不恰当的。</strong> 如果从监督信号的底层信息单位来看，人类的神经网络是为了在丛林中保障部落生存而优化的，而 LLM 的神经网络则是为了模仿人类文本、在数学难题中获取可验证奖励，以及在 LM Arena 上赢得人类的一个点赞而优化的。随着可验证的领域支持 RLVR，大语言模型在这些领域及其周边任务上的能力会出现“尖峰式”跃升，从而整体呈现出一种令人忍俊不禁的、起伏剧烈的锯齿状性能特征，它们可能同时是一位通晓万物的天才，又是一个充满困惑且认知能力受限的小学生，甚至在几秒内就被越狱攻击（jailbreak）诱骗，导致你的数据被窃取。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69e21168c6b047b7a5e479c7bd630fa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQmFpaGFpX0lEUA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768532015&amp;x-signature=eRhBu7lg0YvmImcFbFRKrT23mXE%3D" alt="image.png" loading="lazy"/></p>
<p>（人类智能：蓝色，AI 智能：红色。我很喜欢这个梗图（很抱歉我找不到了它最初在 X 上的原始出处），因为它指出人类智能本身也以自己独特的方式呈现出“锯齿状”。）</p>
<p>与上述现象密切相关的是，我在 2025 年对各类基准测试（benchmarks）普遍感到冷漠，并且不再信任它们。核心问题在于，基准测试（benchmarks）在设计上几乎天然就是可验证的环境，因此很容易被 RLVR（以及通过合成数据生成的较弱形式）进行针对性优化。现在的 LLM 团队为了刷高 benchmark 分数，会围绕那些测试题在模型“理解空间”里的位置，大量生成类似题目来训练模型，让它只在这些点上变得超强，别的地方先不管。结果就是模型能力像锯齿一样 —— 榜单上分数爆表，实际用起来漏洞百出。而“变相在测试集上训练”这件事，已经玩出了花，成了行业潜规则。</p>
<p>如果在碾压所有基准测试（benchmark）的同时，却仍未实现通用人工智能（AGI），那将会是一种什么景象？</p>
<h2 data-id="heading-2"><strong>03 Cursor / 新的 LLM 应用层</strong></h2>
<p>关于 Cursor（除了它今年以火箭般的速度崛起之外），我觉得最值得注意的是：Cursor 不仅自己成功了，更重要的是它开创了一种新模式，大家突然意识到：“哦，原来 LLM 应用可以这样做！”于是开始设想各行各业的“Cursor”。正如我今年在 Y Combinator 演讲中所强调的（附有文字稿[1]和视频[2]），像 Cursor 这样的 LLM 应用，会为特定垂直领域（如编程、法律、设计等）将多次 LLM 调用打包并编排成一个整体工作流：</p>
<ul>
<li>它们负责 <strong>“上下文工程”（context engineering）</strong></li>
<li>它们<strong>在后台将多次 LLM 调用编排成日益复杂的 DAG（有向无环图）</strong> ，并在此过程中精细权衡性能与计算成本</li>
<li>它们为“human-in-the-loop”中提供<strong>面向特定应用场景的图形界面（GUI）</strong></li>
<li>它们提供一个 <strong>“自主性滑块”（autonomy slider）</strong>  —— 允许用户动态调节 AI 的决策自由度</li>
</ul>
<p>2025 年，业界大量讨论都围绕着这个新出现的应用层的“厚度”，LLM 实验室（如 OpenAI、Anthropic 等）会吃掉所有上层应用，还是说 LLM 应用领域仍是广阔天地，大有作为？我个人认为，LLM 实验室会倾向于培养出一个“通才型的大学生”，而 LLM 应用则会通过注入私有数据、传感器、执行器和反馈回路，对这些“大学生”进行组织、微调，并真正激活成部署在具体垂直领域的“专业从业者”。</p>
<h2 data-id="heading-3"><strong>04 Claude Code / 驻守在我们计算机的 AI</strong></h2>
<p>Claude Code（CC）成为首个令大家信服的 LLM 智能体（Agent）范例 —— 它以循环迭代方式将工具使用与推理串联起来，用于解决需要长时间、多步骤的复杂问题。此外，对我而言，CC 的另一个特点是：它运行在我们的本地计算机上，并直接利用我们本地的私有环境、数据和上下文。我认为 OpenAI 在这一点上判断有误，因为他们早期在 Codex / 智能体（agent）方面的尝试，聚焦于通过 ChatGPT 编排云端容器中的智能体，而不是直接在用户的本地机器（localhost）上运行。尽管云端运行的智能体集群（agent swarms）听起来像是“AGI 的最终形态，但我们正处在一个能力“锯齿状”、演进缓慢的中间阶段，在这种背景下，让智能体直接运行在开发者本机上反而更合理。</p>
<p>需要注意的是，<strong>真正关键的区别并不在于“AI 运算”（AI ops）到底跑在哪儿（云端、本地，或其他地方），而在于其他因素 —— 那台已经开机并运行着的电脑，以及它上面已安装的软件、当前上下文、数据、密钥、配置，还有低延迟的交互体验。</strong></p>
<p>Anthropic 正确把握了这一优先级，并将 Claude Code（CC）打造成一个精巧的、极简的命令行（CLI）形态，这种形态彻底改变了人们对 AI 的认知：它不再只是一个像 Google 那样需要你主动打开浏览器去访问的网站，而更像是一个“寄居”在你电脑里的小精灵（或幽灵）。这是一种与 AI 交互的全新且截然不同的范式。</p>
<h2 data-id="heading-4"><strong>05 Vibe coding</strong></h2>
<p>2025 年，AI 的能力达到了一个质变的临界点：人们现在能仅通过自然语言就构建出各种令人为之惊叹的程序，甚至完全不用去想“代码”本身的存在。说来好笑，我是在一条思绪如泉涌的推文[3]中随口创造了 “vibe coding”（氛围编程）这个词，当时根本没想到它居然火了 :)。通过 vibe coding，编程就不再是经过大量训练的专业人士的专属领域，而是任何人都能上手的事情。从这个角度看，它再次印证了我在《Power to the people: How LLMs flip the script on technology diffusion》[4]中写到的观点：与迄今为止几乎所有其他技术都不同，普通大众从 LLM 中的获益远大于专业人士、企业和政府。</p>
<p>但 vibe coding 的意义不仅在于帮助普通人接触编程 —— 它也让受过专业训练的开发者能够写出大量原本根本不会被实现的（vibe coded）软件。</p>
<p>在 nanochat 中，我用 vibe coding 自己写了一个高度定制的、高效的 Rust 版 BPE tokenizer，且无需依赖现成的库，也无需深入学习 Rust。今年我用 vibe coding 快速做出了许多小应用原型，只为实现我脑中那些一闪而过的想法（例如：menugen[5]、llm-council[6]、reader3[7]、HN time capsule[8]）。我甚至用 vibe coding 写过一整个临时应用，只为定位一个 bug —— 为什么不呢？毕竟代码突然变得成本极低（free）、短暂（ephemeral）、可塑（malleable）、用完即可丢弃（discardable after single use）。Vibe coding 将重塑软件生态，并彻底改变开发相关岗位的职责描述。</p>
<h2 data-id="heading-5"><strong>06 Nano banana / LLM GUI</strong></h2>
<p>Google Gemini Nano banana 是 2025 年最具颠覆性、最能推动范式变革的模型之一。在我的世界观中，大语言模型（LLMs）是继 1970、80 年代计算机之后的下一个重大计算范式。因此，出于本质上相似的原因，我们将会见证类似类型的创新。我们将看到类似于“个人计算”、“微控制器”（认知核心）或“互联网”（智能体网络）等事物在 AI 时代的对应形态。</p>
<p>尤其是在 UI/UX 方面，“与 LLM 对话”有点像在 1980 年代向计算机终端输入命令。文本是计算机（以及 LLM）的原始/首选数据表示形式，却并非人类偏好的交互格式 —— 尤其是在输入端。事实上，人们并不喜欢阅读大段文字，因为这既慢又费力。相反，人们更倾向于以视觉化、空间化的方式接收信息，这正是传统计算（traditional computing）中图形用户界面（GUI）被发明的原因。</p>
<p>同理，<strong>LLM 也应该用我们偏好的格式与我们对话 —— 比如：图片、信息图、幻灯片、白板、动画/视频、网页应用等。</strong></p>
<p>当然，这种理念的早期形态和当前版本，是像 emoji 和 Markdown 这样的东西 —— 它们本质上是通过标题、加粗、斜体、列表、表格等方式对文本进行“视觉装饰”和排版，来提升可读性。</p>
<p>但究竟谁会真正构建出 LLM 的 GUI（图形用户界面）？</p>
<p>在这一世界观下，Nano banana 是对此未来形态的一次早期预示。更重要的是，Nano Banana 的意义，不在于它能进行图像生成，而在于文本生成、图像生成与世界知识在模型权重中深度融合所产生的联合能力。</p>
<p><strong>END</strong></p>
<p><strong>本期互动内容 🍻</strong></p>
<p><strong>❓如果像 Nano Banana 预示的那样，未来的 AI 不再只用文字回复你，而是自动生成图表、流程图、甚至交互界面 —— 你最希望它在哪种场景下以“非文字”的方式与你协作？</strong></p>
<p><strong>文中链接</strong></p>
<p>[1]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.donnamagi.com%2Farticles%2Fkarpathy-yc-talk" target="_blank" title="https://www.donnamagi.com/articles/karpathy-yc-talk" ref="nofollow noopener noreferrer">www.donnamagi.com/articles/ka…</a></p>
<p>[2]<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DLCEmiRjPEtQ" target="_blank" title="https://www.youtube.com/watch?v=LCEmiRjPEtQ" ref="nofollow noopener noreferrer">www.youtube.com/watch?v=LCE…</a></p>
<p>[3]<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fkarpathy%2Fstatus%2F1886192184808149383" target="_blank" title="https://x.com/karpathy/status/1886192184808149383" ref="nofollow noopener noreferrer">x.com/karpathy/st…</a></p>
<p>[4]<a href="https://link.juejin.cn?target=https%3A%2F%2Fkarpathy.bearblog.dev%2Fpower-to-the-people%2F" target="_blank" title="https://karpathy.bearblog.dev/power-to-the-people/" ref="nofollow noopener noreferrer">karpathy.bearblog.dev/power-to-th…</a></p>
<p>[5]<a href="https://link.juejin.cn?target=https%3A%2F%2Fkarpathy.bearblog.dev%2Fvibe-coding-menugen" target="_blank" title="https://karpathy.bearblog.dev/vibe-coding-menugen" ref="nofollow noopener noreferrer">karpathy.bearblog.dev/vibe-coding…</a></p>
<p>[6]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkarpathy%2Fllm-council" target="_blank" title="https://github.com/karpathy/llm-council" ref="nofollow noopener noreferrer">github.com/karpathy/ll…</a></p>
<p>[7]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkarpathy%2Freader3" target="_blank" title="https://github.com/karpathy/reader3" ref="nofollow noopener noreferrer">github.com/karpathy/re…</a></p>
<p>[8]<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkarpathy%2Fhn-time-capsule" target="_blank" title="https://github.com/karpathy/hn-time-capsule" ref="nofollow noopener noreferrer">github.com/karpathy/hn…</a></p>
<p><strong>原文链接：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fkarpathy.bearblog.dev%2Fyear-in-review-2025%2F" target="_blank" title="https://karpathy.bearblog.dev/year-in-review-2025/" ref="nofollow noopener noreferrer">karpathy.bearblog.dev/year-in-rev…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[运维必备！一款全平台可用的服务器管理利器！]]></title>    <link>https://juejin.cn/post/7592815497848750143</link>    <guid>https://juejin.cn/post/7592815497848750143</guid>    <pubDate>2026-01-09T01:19:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592815497848750143" data-draft-id="7589171972447027242" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="运维必备！一款全平台可用的服务器管理利器！"/> <meta itemprop="keywords" content="React.js,Linux,Docker"/> <meta itemprop="datePublished" content="2026-01-09T01:19:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java陈序员"/> <meta itemprop="url" content="https://juejin.cn/user/3958702402176765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            运维必备！一款全平台可用的服务器管理利器！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3958702402176765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java陈序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:19:45.000Z" title="Fri Jan 09 2026 01:19:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 <code>Java陈序员</code>。</p>
<p>在企业开发中，你是否有遇到过如下难题：管理 3 台服务器需要同时打开终端工具、文件传输软件和监控面板，切换窗口的时间比实际操作还多；出门在外想临时调整配置，手机上却找不到能流畅运行的 SSH 客户端；团队协作时，服务器连接信息在 Excel 和聊天记录里杂乱堆放，安全性无从谈起？</p>
<p>今天，给大家推荐一款开源、全平台可用的服务器管理利器，运维必备！</p>
<h2 data-id="heading-0">项目介绍</h2>
<p><code>Termix</code> —— 一个开源、永久免费、自托管的一体化服务器管理平台，通过一个直观的界面管理服务器和基础设施，同时提供 SSH 终端访问、SSH 隧道功能以及远程文件管理等功能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e28e5f42f7654202a6598e1ad8840e3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YemZiOW6j-WRmA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768526385&amp;x-signature=vBowHfcMhXnFDUeRQ0vk4tsw5uI%3D" alt="" loading="lazy"/></p>
<p><strong>功能特色</strong>：</p>
<ul>
<li><strong>全能 SSH 终端与连接管理</strong>：功能齐全的终端，支持分屏操作；支持创建可重用的命令片段，可在多个打开的终端上同时运行一个命令；支持跳板机、warpgate、基于 TOTP 的连接等</li>
<li><strong>可视化的远程文件管理</strong>：支持直接浏览编辑代码、图片、音视频等文件，代码文件自动识别 20 + 编程语言并高亮显示；支持拖拽上传/下载文件、批量重命名、移动等操作</li>
<li><strong>全面的服务器监控</strong>：通过仪表盘直观地展示 SSH 服务器的 CPU、内存、磁盘使用率、网络流量与系统运行时间等信息</li>
<li><strong>安全与隐私保障</strong>：具备安全的用户管理，支持 OIDC 认证与 2FA（TOTP）双重验证，所有信息存储在本地加密 SQLite 数据库，无需担心数据泄露的风险</li>
<li><strong>全平台无缝体验</strong>：网页端、桌面端（Windows/Linux/macOS）、移动端（iOS/Android）全支持，同时一处配置，多端同步使用，适应固定办公与移动运维场景</li>
<li><strong>现代界面设计</strong>：基于 React、Tailwind CSS 和 Shadcn 构建的简洁的桌面/移动设备友好界面，内置英语、中文、德语、葡萄牙语，本地化体验友好</li>
</ul>
<h2 data-id="heading-1">快速上手</h2>
<p><code>Termix</code> 支持网站、Windows、Linux、macOS、iOS/iPadOS、Android 多平台使用。</p>
<h3 data-id="heading-2">安装包安装</h3>
<p>1、打开下载地址</p>
<pre><code class="hljs language-bash" lang="bash">https://github.com/Termix-SSH/Termix/releases
</code></pre>
<p>2、下载对应操作系统的安装包</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e82f95131bf4763918cc675a1d8085d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YemZiOW6j-WRmA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768526385&amp;x-signature=qUyVvGaFTBU%2BOnKYn9g4JY4V0nI%3D" alt="" loading="lazy"/></p>
<p>3、解压并安装</p>
<h3 data-id="heading-3">Docker 部署</h3>
<p>1、拉取镜像</p>
<pre><code class="hljs language-bash" lang="bash">docker pull ghcr.io/lukegus/termix:latest
</code></pre>
<p>2、创建挂载目录</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p /data/software/termix
</code></pre>
<p>3、运行容器</p>
<pre><code class="hljs language-bash" lang="bash">docker run -d --name termix \
	-p 8080:8080 \
	-v /data/software/termix:/app/data \
	-e PORT=8080 \
	ghcr.io/lukegus/termix:latest
</code></pre>
<p>4、容器运行成功后，浏览器访问</p>
<pre><code class="hljs language-bash" lang="bash">http://{IP/域名}:8080
</code></pre>
<blockquote>
<p><strong>首次注册的用户即为默认管理员</strong>。</p>
</blockquote>
<h3 data-id="heading-4">Docker Compose 部署</h3>
<p>1、创建 <code>docker-compose.yml</code> 文件</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">termix:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">ghcr.io/lukegus/termix:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">termix</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"8080:8080"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/data/software/termix:/app/data</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">PORT:</span> <span class="hljs-string">"8080"</span>

<span class="hljs-attr">volumes:</span>
  <span class="hljs-attr">termix-data:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">local</span>
</code></pre>
<p>2、运行启动</p>
<pre><code class="hljs language-bash" lang="bash">docker compose up -d
</code></pre>
<h2 data-id="heading-5">功能体验</h2>
<ul>
<li><strong>仪表板</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8487bb42c8b34593a9b695bf0474fde8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YemZiOW6j-WRmA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768526385&amp;x-signature=wG1HjRfn4LqH1%2Br%2F%2BwI%2FwRWse1o%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>主机管理</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3ef9cd725204c99b5fccc41068104d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YemZiOW6j-WRmA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768526385&amp;x-signature=vEhkGBM4nTwmV%2F31RG%2BjwQidIYY%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>SSH 连接</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f57d6192f836420ba16f2481803edb8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YemZiOW6j-WRmA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768526385&amp;x-signature=h7SY0huniQBf3DQnGu%2BWQXeMUgk%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>文件管理</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84e26548ab084b47b2f6891610b01e85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YemZiOW6j-WRmA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768526385&amp;x-signature=czibgjAej8suOuKYL2l9uhV1tgA%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>服务器状态仪表盘</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b88caffbf37e4dfea53f080a737dfded~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YemZiOW6j-WRmA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768526385&amp;x-signature=%2BNe05kJFY8vwOojD4S6057eO%2BMI%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>管理员设置</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05d0864b865341dc8e354bcc7790591b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YemZiOW6j-WRmA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768526385&amp;x-signature=asWVPNU2fZ4yh3U6k2hDjpxCxKQ%3D" alt="" loading="lazy"/></p>
<p>无论是个人开发者管理服务器，还是企业运维团队管控集群，Termix 都能大幅简化工作流程。如果你经常需要管理远程服务器，Termix 绝对值得一试，快去安装试试吧~</p>
<pre><code class="hljs language-bash" lang="bash">项目地址：https://github.com/Termix-SSH/Termix
</code></pre>
<h2 data-id="heading-6">最后</h2>
<p>推荐的开源项目已经收录到 <code>GitHub</code> 项目，欢迎 <code>Star</code>：</p>
<pre><code class="hljs language-bash" lang="bash">https://github.com/chenyl8848/great-open-source-project
</code></pre>
<p>或者访问网站，进行在线浏览：</p>
<pre><code class="hljs language-bash" lang="bash">https://chencoding.top:8090/<span class="hljs-comment">#/</span>
</code></pre>
<blockquote>
<p>大家的点赞、收藏和评论都是对作者的支持，如文章对你有帮助还请点赞转发支持下，谢谢！</p>
</blockquote>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VTJ.PRO「AI + 低代码」应用开发平台的后端模块系统]]></title>    <link>https://juejin.cn/post/7592876744526315570</link>    <guid>https://juejin.cn/post/7592876744526315570</guid>    <pubDate>2026-01-09T01:43:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592876744526315570" data-draft-id="7592833068224397358" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VTJ.PRO「AI + 低代码」应用开发平台的后端模块系统"/> <meta itemprop="keywords" content="前端,人工智能,低代码"/> <meta itemprop="datePublished" content="2026-01-09T01:43:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踩着两条虫"/> <meta itemprop="url" content="https://juejin.cn/user/4141239932051488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VTJ.PRO「AI + 低代码」应用开发平台的后端模块系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4141239932051488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踩着两条虫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:43:22.000Z" title="Fri Jan 09 2026 01:43:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">目的与范围</h3>
<p>本文档描述了基于NestJS的VTJ.PRO后端模块架构。它涵盖了模块组织结构、依赖注入模式、TypeORM集成以及业务逻辑在核心模块和业务模块中的组织方式。本文档侧重于后端的结构组织；具体业务功能请参见低代码应用系统、LLM管理系统和用户管理与安全。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fb51b25b4eb4c7c85ea97fe9af1c036~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lip552A5Lik5p2h6Jmr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768527801&amp;x-signature=3rs7b3CJuiBdUXXIQ8w9a2yvi4o%3D" alt="iShot_2026-01-04_15.59.29.png" loading="lazy"/></p>
<h2 data-id="heading-1">NestJS模块架构概述</h2>
<p>后端使用NestJS作为应用框架，将代码组织成封装相关功能的模块。每个模块都是一个用<code>@Module()</code>装饰器装饰的类，包含以下元数据：</p>
<ul>
<li>imports: 该模块依赖的其他模块</li>
<li>controllers: HTTP请求处理器</li>
<li>providers: 服务、仓库和其他可注入类</li>
<li>exports: 提供给其他模块使用的服务/提供者</li>
<li>根模块<code>AppModule</code>位于<code>backend/src/app.module.ts</code></li>
</ul>
<p>协调所有功能模块并配置全局基础设施，如数据库连接、调度和守卫。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51cb68ba50c04fa4897a9942eab3ca6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lip552A5Lik5p2h6Jmr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768527801&amp;x-signature=JLL%2FWIcvS1zUvUZ%2BfSeFegMm6UU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">模块组织结构</h2>
<p>后端组织为两个主要类别：</p>
<h3 data-id="heading-3">核心模块</h3>
<p>位于<code>backend/src/core/</code>，提供基础平台服务：</p>























































<table><thead><tr><th>模块</th><th>目的</th><th>导出</th></tr></thead><tbody><tr><td><code>UserModule</code></td><td>用户管理和认证</td><td><code>UserService</code>, <code>OAuthService</code></td></tr><tr><td><code>RoleModule</code></td><td>角色管理</td><td><code>RoleService</code></td></tr><tr><td><code>PermissionModule</code></td><td>权限定义和检查</td><td><code>PermissionService</code>, <code>TypeOrmModule</code></td></tr><tr><td><code>CacheModule</code></td><td>Redis/内存缓存</td><td><code>CacheService</code></td></tr><tr><td><code>DictionaryModule</code></td><td>配置数据管理</td><td><code>DictionaryService</code></td></tr><tr><td><code>SettingModule</code></td><td>系统设置</td><td><code>SettingService</code></td></tr><tr><td><code>LLMModelModule</code></td><td>LLM提供者配置</td><td><code>LLMModelService</code></td></tr><tr><td><code>OssModule</code></td><td>对象存储集成</td><td><code>OssFactoryService</code></td></tr><tr><td><code>EmailVerificationModule</code></td><td>邮箱验证流程</td><td><code>EmailVerificationService</code></td></tr></tbody></table>
<h3 data-id="heading-4">业务模块</h3>
<p>位于<code>backend/src/business/</code>，实现特定领域功能：</p>























































<table><thead><tr><th>模块</th><th>目的</th><th>导出</th></tr></thead><tbody><tr><td><code>LowcodeAppModule</code></td><td>应用管理</td><td><code>AppService</code></td></tr><tr><td><code>TemplateModule</code></td><td>模板管理</td><td><code>TemplateService</code></td></tr><tr><td><code>DSLModule</code></td><td>DSL配置</td><td><code>DSLService</code></td></tr><tr><td><code>OrderModule</code></td><td>订单交易</td><td><code>OrderService</code></td></tr><tr><td><code>ProductModule</code></td><td>产品目录</td><td><code>ProductService</code></td></tr><tr><td><code>ReportModule</code></td><td>分析报告</td><td><code>ReportService</code></td></tr><tr><td><code>DailyModule</code></td><td>运营报告</td><td><code>DailyService</code></td></tr><tr><td><code>AgentModule</code></td><td>AI代理服务</td><td><code>AgentService</code></td></tr><tr><td><code>OpenModule</code></td><td>公共API</td><td>-</td></tr></tbody></table>
<h2 data-id="heading-5">根模块配置</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f58f7a7e034041d0ac13b301d265243c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lip552A5Lik5p2h6Jmr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768527801&amp;x-signature=N0Onb%2FrKNXUKRThCuLYkVLAgNR0%3D" alt="d2086122-8b4b-418b-997e-2bbdcc66062a.png" loading="lazy"/></p>
<p>位于<code>backend/src/app.module.ts</code>的AppModule配置：</p>
<ul>
<li>ConfigModule: 从<code>.env</code>文件加载环境变量，具有层次结构（<code>.env.local</code> → <code>.env.${NODE_ENV}</code> → <code>.env</code>）</li>
<li>TypeOrmModule: 使用<code>ConfigService</code>异步配置MySQL连接，启用<code>autoLoadEntities</code>和<code>utf8mb4</code>字符集</li>
<li>ScheduleModule: 启用cron作业调度</li>
<li>全局守卫: 注册<code>UsersGuard</code>以在所有路由上强制执行授权</li>
</ul>
<h2 data-id="heading-6">标准模块结构模式</h2>
<p>每个功能模块遵循一致的结构，包含四个主要组件：</p>
<h3 data-id="heading-7">模块结构图</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79ba37054007490ab377f97c1ceb168b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lip552A5Lik5p2h6Jmr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768527801&amp;x-signature=ZyjQg7aU36XIbuUgQTysJyzy7YM%3D" alt="ce5a40dc-23b2-4bd6-b5e0-eb2908ab0e89.png" loading="lazy"/></p>
<h3 data-id="heading-8">示例：产品模块</h3>
<p><code>ProductModule</code>展示了此模式：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forFeature</span>([<span class="hljs-title class_">Product</span>]), <span class="hljs-title class_">OrderModule</span>],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">ProductService</span>],
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">ProductController</span>],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">ProductService</span>]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductModule</span> {}
</code></pre>
<p><strong>组件：</strong></p>
<ul>
<li>实体: <code>Product</code> - TypeORM实体定义数据库模式</li>
<li>服务: <code>ProductService</code> - 业务逻辑和仓库操作</li>
<li>控制器: <code>ProductController</code> - REST API端点</li>
<li>DTOs: 用于验证的数据传输对象（在<code>product.dto.ts</code>中）</li>
<li>模块: <code>ProductModule</code> - 封装并导出功能</li>
</ul>
<p>模块的桶式导出重新导出所有公共接口。</p>
<h2 data-id="heading-9">TypeORM集成模式</h2>
<p>所有需要数据库访问的模块都使用<code>TypeOrmModule.forFeature()</code>模式：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70f6aeb812444ed8a8098c49d46cfe53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lip552A5Lik5p2h6Jmr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768527801&amp;x-signature=BP0sbtF6fCbXRi%2BVpl9kjvqsHc4%3D" alt="89c6734a-0c30-466a-9a3e-42bf01e29a7f.png" loading="lazy"/></p>
<h3 data-id="heading-10">示例：订单模块</h3>
<p><code>OrderModule</code>展示了TypeORM集成：</p>
<ul>
<li>导入<code>TypeOrmModule.forFeature([OrderEntity])</code>以注册实体</li>
<li>将<code>Repository&lt;OrderEntity&gt;</code>注入到<code>OrderService</code></li>
<li>同时导入<code>UserModule</code>用于跨模块依赖</li>
</ul>
<h3 data-id="heading-11">示例：包含多个实体的应用模块</h3>
<p><code>LowcodeAppModule</code>展示了一个管理多个相关实体的模块：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forFeature</span>([<span class="hljs-title class_">AppEntity</span>, <span class="hljs-title class_">AppVersionEntity</span>]),
    <span class="hljs-title class_">DSLModule</span>
  ],
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AppController</span>],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AppService</span>],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">AppService</span>]
})
</code></pre>
<p>这注册了<code>AppEntity</code>和<code>AppVersionEntity</code>，允许<code>AppService</code>为两个实体注入仓库。</p>
<h2 data-id="heading-12">模块依赖模式</h2>
<h3 data-id="heading-13">直接模块依赖</h3>
<p>模块通过imports数组声明依赖：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2798dd9ff20b4260bf4a686880a93a30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lip552A5Lik5p2h6Jmr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768527801&amp;x-signature=i20EmHsf%2FjJ7rwPubwapV6910W4%3D" alt="78f0edf1-fc76-497b-abed-e086429ba3fc.png" loading="lazy"/></p>
<h3 data-id="heading-14">跨模块服务注入</h3>
<p>当一个模块导出一个服务时，其他模块可以注入它：</p>








































<table><thead><tr><th>导出模块</th><th>导出的服务</th><th>消费模块</th></tr></thead><tbody><tr><td><code>UserModule</code></td><td><code>UserService</code></td><td><code>OrderModule</code>, <code>RoleModule</code></td></tr><tr><td><code>RoleModule</code></td><td><code>RoleService</code></td><td><code>UserModule</code>, <code>PermissionModule</code></td></tr><tr><td><code>PermissionModule</code></td><td><code>PermissionService</code></td><td><code>RoleModule</code></td></tr><tr><td><code>DSLModule</code></td><td><code>DSLService</code></td><td><code>LowcodeAppModule</code>, <code>DailyModule</code></td></tr><tr><td><code>TemplateModule</code></td><td><code>TemplateService</code></td><td><code>DailyModule</code></td></tr><tr><td><code>ReportModule</code></td><td><code>ReportService</code></td><td><code>DailyModule</code></td></tr></tbody></table>
<h3 data-id="heading-15">循环依赖解决</h3>
<p>当两个模块需要彼此的服务时，NestJS提供<code>forwardRef()</code>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af4bb5c0d6f744ab81f5b77a7256cc71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lip552A5Lik5p2h6Jmr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768527801&amp;x-signature=vCy8pYPk8F3xTSOnsDeoyrOGIm8%3D" alt="12f35004-c6f4-4e6a-92f3-2894adb3f347.png" loading="lazy"/></p>
<p>来自<code>backend/src/core/user/user.module.ts</code>的示例：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-attr">imports</span>: [
  <span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forFeature</span>([<span class="hljs-title class_">UserEntity</span>, <span class="hljs-title class_">UserOAuthEntity</span>]),
  <span class="hljs-title class_">SettingModule</span>,
  <span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">RoleModule</span>), <span class="hljs-comment">// 循环依赖解决</span>
  <span class="hljs-title class_">EmailVerificationModule</span>
];
</code></pre>
<p>来自<code>backend/src/core/role/role.module.ts</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-attr">imports</span>: [
  <span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forFeature</span>([<span class="hljs-title class_">RoleEntity</span>, <span class="hljs-title class_">PermissionEntity</span>]),
  <span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">PermissionModule</span>) <span class="hljs-comment">// 循环依赖解决</span>
];
</code></pre>
<h2 data-id="heading-16">全局模块</h2>
<p><code>@Global()</code>装饰器使模块的导出在整个应用程序中可用，无需显式导入：</p>
<h3 data-id="heading-17">UserModule作为全局模块</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">@Global</span>()
<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forFeature</span>([<span class="hljs-title class_">UserEntity</span>, <span class="hljs-title class_">UserOAuthEntity</span>]),
    <span class="hljs-title class_">SettingModule</span>,
    <span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">RoleModule</span>),
    <span class="hljs-title class_">EmailVerificationModule</span>
  ],
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">UserController</span>, <span class="hljs-title class_">OAuthController</span>],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">UserService</span>, <span class="hljs-title class_">OAuthService</span>, <span class="hljs-title class_">OAuthConfigService</span>, <span class="hljs-title class_">SettingService</span>],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">UserService</span>, <span class="hljs-title class_">OAuthService</span>]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserModule</span> {}
</code></pre>
<p><code>UserModule</code>被标记为<code>@Global()</code>，使<code>UserService</code>和<code>OAuthService</code>对所有模块可用，无需导入<code>UserModule</code>。</p>
<p>理由：用户认证在整个应用程序中都需要（守卫、装饰器、业务逻辑），因此将其设为全局可减少样板导入。</p>
<h2 data-id="heading-18">复杂模块依赖</h2>
<h3 data-id="heading-19">Daily模块：聚合模式</h3>
<p><code>DailyModule</code>展示了一个复杂的聚合模式，导入多个业务模块：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5eb1cea4a1e1491ab8e446ba6db2f125~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lip552A5Lik5p2h6Jmr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768527801&amp;x-signature=riYeczBtTIgpD0iR2I%2Br6CjS1eE%3D" alt="6ed8d341-f4c5-4a14-83b1-abd278e8cba8.png" loading="lazy"/></p>
<p>导入显示跨领域依赖：</p>
<ul>
<li><code>AgentModule</code>用于AI驱动的报告生成</li>
<li><code>ReportModule</code>用于分析数据</li>
<li><code>TemplateModule</code>和<code>DSLModule</code>用于低代码结构</li>
<li><code>LowcodeAppModule</code>用于应用管理</li>
<li><code>OssFactoryService</code>（来自全局上下文）用于文件存储</li>
</ul>
<h2 data-id="heading-20">模块桶式导出</h2>
<p>每个模块目录包含一个index.ts桶式文件，重新导出公共接口：</p>
<h3 data-id="heading-21">示例：应用模块桶式导出</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.entity'</span>;
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./app-version.entity'</span>;
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.dto'</span>;
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.controller'</span>;
<span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
</code></pre>
<p>此模式允许消费者从模块目录导入：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppEntity</span>, <span class="hljs-title class_">AppService</span>, <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./business/apps'</span>;
</code></pre>
<p>而不是单个文件路径：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppEntity</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./business/apps/app.entity'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./business/apps/app.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./business/apps/app.module'</span>;
</code></pre>
<h2 data-id="heading-22">模块依赖图</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/916e7fbe45014c7b8a20fc34bac20467~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Lip552A5Lik5p2h6Jmr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768527801&amp;x-signature=7oTYAT2zyY80uB5Xl7p%2Fl1jNCBE%3D" alt="9b02cb3d-2dbb-4f2d-9119-2d5b21682cc5.png" loading="lazy"/></p>
<p>此图显示模块之间的主要依赖关系。注意：</p>
<ul>
<li><code>UserModule</code>是全局的，因此未显示所有消费者的依赖</li>
<li>循环依赖通过<code>forwardRef()</code>解决</li>
<li><code>DailyModule</code>具有最多的依赖，聚合跨领域的数据</li>
<li>基础设施模块（Config、TypeORM、Cache）被许多模块使用但未显式导入（由根配置提供）</li>
</ul>
<h2 data-id="heading-23">总结</h2>
<p>VTJ.PRO后端遵循NestJS最佳实践，具有：</p>
<ol>
<li>清晰分离：核心基础设施模块与业务领域模块</li>
<li>一致结构：实体 → 服务 → 控制器 → 模块模式</li>
<li>TypeORM集成：用于实体注册的<code>forFeature()</code>模式</li>
<li>依赖注入：通过构造函数注入服务，通过<code>@InjectRepository()</code>注入仓库</li>
<li>循环依赖：在需要时通过<code>forwardRef()</code>解决</li>
<li>全局模块：UserModule标记为<code>@Global()</code>以实现全局访问</li>
<li>桶式导出：<code>index.ts</code>文件简化导入</li>
<li>聚合模式：高级模块（如DailyModule）组合多个领域服务</li>
</ol>
<p>这种架构实现了可维护性、可测试性以及平台广泛功能集的清晰关注点分离。</p>
<blockquote>
<p>源码开源仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fnewgateway%2Fvtj" target="_blank" title="https://gitee.com/newgateway/vtj" ref="nofollow noopener noreferrer">gitee.com/newgateway/…</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL 表的类 Git 版本控制]]></title>    <link>https://juejin.cn/post/7592893391572860954</link>    <guid>https://juejin.cn/post/7592893391572860954</guid>    <pubDate>2026-01-09T02:54:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592893391572860954" data-draft-id="7592552501578825754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL 表的类 Git 版本控制"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-09T02:54:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户61743327310"/> <meta itemprop="url" content="https://juejin.cn/user/2358924657825099"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL 表的类 Git 版本控制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2358924657825099/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户61743327310
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T02:54:19.000Z" title="Fri Jan 09 2026 02:54:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<blockquote>
<p>用户要求记录excel表的修改记录，并且对不同版本的excel进行对比展示</p>
</blockquote>
<p>开发环境：JDK17 SpringBoot3</p>
<h2 data-id="heading-1">二、解决方案</h2>
<blockquote>
<p>将excel表数据存入数据库，对MySQL 表实现类 Git 版本控制</p>
</blockquote>
<h3 data-id="heading-2">核心设计逻辑</h3>
<h4 data-id="heading-3">1. 通用适配</h4>
<p>支持任意 MySQL 表的增量快照，通过<strong>主键</strong>作为唯一标识对比数据（需保证业务表有主键）；</p>
<h4 data-id="heading-4">2. 版本逻辑</h4>
<ul>
<li>首次提交：生成<strong>全量基线快照</strong>（作为后续增量的基准）</li>
<li>非首次提交：对比当前表与<strong>上一版本合并后的数据</strong>，提取增量变更集；</li>
<li>回滚逻辑：基于基线+增量变更集逆向计算，恢复到目标版本；</li>
</ul>
<h4 data-id="heading-5">3. 防风险</h4>
<p>全程事务控制，SQL防注入，锁表避免发生变更，回滚前自动备份</p>
<h2 data-id="heading-6">三、代码实现</h2>
<h3 data-id="heading-7">1. 数据库表设计</h3>
<h4 data-id="heading-8">1.1. 全局版本记录表（存储增量快照核心信息）</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `dg_table_version` (
  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="hljs-string">'全局版本ID'</span>,
  `table_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'业务表名（如product）'</span>,
  `table_version_num` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'该表的版本号（自增：1、2、3...）'</span>,
  `snapshot_type` <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'快照类型：FULL（基线）/INCREMENT（增量）'</span>,
  `snapshot_content` longtext <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'快照内容：FULL=全量JSON；INCREMENT=增量变更集JSON'</span>,
  `table_structure_hash` <span class="hljs-type">char</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'表结构MD5哈希（防结构变更）'</span>,
  `operator` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'操作人'</span>,
  `operate_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'提交时间'</span>,
  `version_desc` <span class="hljs-type">varchar</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'版本说明'</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `create_user` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `last_update_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `last_update_user` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `dg_table_version_table_name_IDX` (`table_name`, `table_version_num`)
)<span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4 ROW_FORMAT <span class="hljs-operator">=</span> <span class="hljs-keyword">DYNAMIC</span> COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'全局表版本记录表'</span>;
</code></pre>
<h4 data-id="heading-9">1.2. 表结构版本表（可选，管控表结构变更）</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `dg_table_structure_version` (
  `id` <span class="hljs-type">bigint</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
  `table_name` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'业务表名'</span>,
  `structure_sql` longtext <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'建表/改表SQL'</span>,
  `structure_hash` <span class="hljs-type">varchar</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'表结构MD5哈希'</span>,
  `operator` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'操作人'</span>,
  `operate_time` datetime <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'记录时间'</span>,
  `create_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `create_user` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `last_update_time` datetime <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  `last_update_user` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,
  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
  <span class="hljs-keyword">UNIQUE</span> KEY `uk_table_hash` (`table_name`, `structure_hash`) COMMENT <span class="hljs-string">'表+结构哈希唯一'</span>
) <span class="hljs-keyword">DEFAULT</span> CHARSET <span class="hljs-operator">=</span> utf8mb4 ROW_FORMAT <span class="hljs-operator">=</span> <span class="hljs-keyword">DYNAMIC</span> COMMENT <span class="hljs-operator">=</span> <span class="hljs-string">'表结构版本表'</span>;
</code></pre>
<h3 data-id="heading-10">2. 核心概念与实体定义</h3>
<h4 data-id="heading-11">2.1 枚举类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Getter;

<span class="hljs-comment">/**
 * 快照类型枚举
 */</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">SnapshotType</span> {
    FULL(<span class="hljs-string">"全量基线"</span>),
    INCREMENT(<span class="hljs-string">"增量变更"</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;

    SnapshotType(String desc) {
        <span class="hljs-built_in">this</span>.desc = desc;
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Getter;

<span class="hljs-comment">/**
 * 数据变更类型枚举
 */</span>
<span class="hljs-meta">@Getter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ChangeType</span> {
    ADD(<span class="hljs-string">"新增"</span>),
    UPDATE(<span class="hljs-string">"修改"</span>),
    DELETE(<span class="hljs-string">"删除"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;

    ChangeType(String desc) {
        <span class="hljs-built_in">this</span>.desc = desc;
    }
}
</code></pre>
<h4 data-id="heading-12">2.2 增量变更集实体（序列化核心）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-comment">/**
 * 单条记录的变更信息（修改操作需存储旧值+新值）
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RecordChange</span> {
    <span class="hljs-comment">/** 变更类型：ADD/UPDATE/DELETE */</span>
    <span class="hljs-keyword">private</span> String changeType;
    <span class="hljs-comment">/** 记录主键值（通用化，适配不同表的主键） */</span>
    <span class="hljs-keyword">private</span> Object primaryKey;
    <span class="hljs-comment">/** 新增/修改后的新值（DELETE时为null） */</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; newData;
    <span class="hljs-comment">/** 修改/删除前的旧值（ADD时为null） */</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; oldData;
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 整张表的增量变更集（序列化后存入snapshot_content）
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IncrementSnapshot</span> {
    <span class="hljs-comment">/** 变更记录列表 */</span>
    <span class="hljs-keyword">private</span> List&lt;RecordChange&gt; recordChanges;
    <span class="hljs-comment">/** 上一版本号（用于回滚时追溯） */</span>
    <span class="hljs-keyword">private</span> Integer lastVersionNum;
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-comment">/**
 * 全量基线快照（首次提交用）
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FullSnapshot</span> {
    <span class="hljs-comment">/** 全量表数据（主键→整条记录的Map） */</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Map&lt;String, Object&gt;&gt; fullData;
}
</code></pre>
<h4 data-id="heading-13">2.3 数据库实体类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonFormat;

<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@author</span>: ZhongXS02
 * <span class="hljs-doctag">@date</span>: 2025-12-31
 **/</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DgTableVersion</span> {
    <span class="hljs-keyword">private</span> Integer id;
    
    <span class="hljs-keyword">private</span> String tableName;
    <span class="hljs-keyword">private</span> Integer tableVersionNum;
    <span class="hljs-keyword">private</span> String snapshotType;
    <span class="hljs-keyword">private</span> String snapshotContent;
    <span class="hljs-keyword">private</span> String tableStructureHash;
    <span class="hljs-keyword">private</span> String operator;
    <span class="hljs-keyword">private</span> Date operateTime;
    <span class="hljs-keyword">private</span> String versionDesc;
    
    <span class="hljs-meta">@JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")</span>
    <span class="hljs-meta">@Schema(name = "创建时间")</span>
    <span class="hljs-keyword">private</span> Date createTime;

    <span class="hljs-meta">@Schema(name = "创建用户")</span>
    <span class="hljs-keyword">private</span> String createUser;

    <span class="hljs-meta">@JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")</span>
    <span class="hljs-meta">@Schema(name = "最后更新时间")</span>
    <span class="hljs-keyword">private</span> Date lastUpdateTime;

    <span class="hljs-meta">@Schema(name = "最后更新用户")</span>
    <span class="hljs-keyword">private</span> String lastUpdateUser;
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-keyword">import</span> java.util.Date;

<span class="hljs-comment">/**
 * <span class="hljs-doctag">@author</span>: ZhongXS02
 * <span class="hljs-doctag">@date</span>: 2025-12-31
 **/</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DgTableStructureVersion</span> {
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-keyword">private</span> String tableName;
    <span class="hljs-keyword">private</span> String structureSql;
    <span class="hljs-keyword">private</span> String structureHash;
    <span class="hljs-keyword">private</span> String operator;
    <span class="hljs-keyword">private</span> Date operateTime;
    
    <span class="hljs-meta">@JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")</span>
    <span class="hljs-meta">@Schema(name = "创建时间")</span>
    <span class="hljs-keyword">private</span> Date createTime;

    <span class="hljs-meta">@Schema(name = "创建用户")</span>
    <span class="hljs-keyword">private</span> String createUser;

    <span class="hljs-meta">@JsonFormat(shape = JsonFormat.Shape.STRING, pattern = "yyyy-MM-dd HH:mm:ss", timezone = "GMT+8")</span>
    <span class="hljs-meta">@Schema(name = "最后更新时间")</span>
    <span class="hljs-keyword">private</span> Date lastUpdateTime;

    <span class="hljs-meta">@Schema(name = "最后更新用户")</span>
    <span class="hljs-keyword">private</span> String lastUpdateUser;
}
</code></pre>
<h3 data-id="heading-14">3. 核心工具类</h3>
<h4 data-id="heading-15">3.1 JSON 序列化工具（通用适配）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.core.JsonProcessingException;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.core.type.TypeReference;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.DeserializationFeature;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.SerializationFeature;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.util.StringUtils;

<span class="hljs-comment">/**
 * JSON 序列化工具
 * <span class="hljs-doctag">@author</span>: ZhongXS02
 * <span class="hljs-doctag">@date</span>: 2025-12-31
 **/</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonUtil</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ObjectMapper objectMapper;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JsonUtil</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.objectMapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
        <span class="hljs-comment">// 适配LocalDate、Map等类型序列化</span>
        objectMapper.registerModule(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JavaTimeModule</span>());
        <span class="hljs-comment">// 空 Bean 序列化时不报错</span>
        objectMapper.configure(SerializationFeature.FAIL_ON_EMPTY_BEANS,<span class="hljs-literal">false</span>);
        <span class="hljs-comment">// 反序列化时忽略未知属性（JSON 有但 Java 类没有的字段）</span>
        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, <span class="hljs-literal">false</span>);
    }

    <span class="hljs-comment">/**
     * 对象转字符串
     * <span class="hljs-doctag">@param</span> object
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toJson</span><span class="hljs-params">(Object object)</span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> objectMapper.writeValueAsString(object);
        } <span class="hljs-keyword">catch</span> (JsonProcessingException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"JSON序列化失败"</span>,e);
        }
    }

    <span class="hljs-comment">/**
     * JSON字符串转对象
     * <span class="hljs-doctag">@param</span> json
     * <span class="hljs-doctag">@param</span> clazz
     * <span class="hljs-doctag">@return</span>
     * <span class="hljs-doctag">@param</span> &lt;T&gt;
     */</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">fromJson</span><span class="hljs-params">(String json, Class&lt;T&gt; clazz)</span>{
        <span class="hljs-keyword">if</span>(!StringUtils.hasLength(json)){
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> objectMapper.readValue(json, clazz);
        } <span class="hljs-keyword">catch</span> (JsonProcessingException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"JSON反序列化失败"</span>,e);
        }
    }

    <span class="hljs-comment">/**
     * JSON字符串转复杂对象
     * <span class="hljs-doctag">@param</span> json
     * <span class="hljs-doctag">@param</span> typeReference
     * <span class="hljs-doctag">@return</span>
     * <span class="hljs-doctag">@param</span> &lt;T&gt;
     */</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">fromJson</span><span class="hljs-params">(String json, TypeReference&lt;T&gt; typeReference)</span>{
        <span class="hljs-keyword">if</span>(!StringUtils.hasLength(json)){
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> objectMapper.readValue(json,typeReference);
        } <span class="hljs-keyword">catch</span> (JsonProcessingException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"JSON反序列化复杂类型失败"</span>,e);
        }
    }
}
</code></pre>
<h4 data-id="heading-16">3.2 表结构工具类（哈希值计算，主键获取）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.commons.codec.digest.DigestUtils;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.util.CollectionUtils;

<span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-comment">/**
 * 表结构工具类 （哈希值计算，主键获取）
 * <span class="hljs-doctag">@author</span>: ZhongXS02
 * <span class="hljs-doctag">@date</span>: 2025-12-31
 **/</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TableStructureUtil</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JdbcTemplate jdbcTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JsonUtil jsonUtil;

    <span class="hljs-comment">/**
     * 获取表的主键字段名
     * <span class="hljs-doctag">@param</span> tableName
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPrimaryKeyName</span><span class="hljs-params">(String tableName)</span>{
        <span class="hljs-comment">// 检验表名 防止SQL注入</span>
        <span class="hljs-keyword">if</span>(!validateTableName(tableName)){
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IpsException</span>(<span class="hljs-string">"表名非法"</span>+tableName);
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT COLUMN_NAME FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE "</span> +
                <span class="hljs-string">"WHERE TABLE_SCHEMA = (SELECT DATABASE()) AND TABLE_NAME = ? AND CONSTRAINT_NAME = 'PRIMARY'"</span>;
        List&lt;String&gt; pkList = jdbcTemplate.queryForList(sql, String.class, tableName);
        <span class="hljs-keyword">if</span> (CollectionUtils.isEmpty(pkList)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"表["</span> + tableName + <span class="hljs-string">"]无主键，不支持增量快照"</span>);
        }
        <span class="hljs-comment">// 仅支持单主键（多主键需扩展）</span>
        <span class="hljs-keyword">return</span> pkList.get(<span class="hljs-number">0</span>);
    }

    <span class="hljs-comment">/**
     * 计算表结构的MD5哈希值
     * <span class="hljs-doctag">@param</span> tableName
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">calculateTableStructureHash</span><span class="hljs-params">(String tableName)</span>{
        <span class="hljs-keyword">if</span> (!validateTableName(tableName)){
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IpsException</span>(<span class="hljs-string">"表名非法"</span>+tableName);
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SHOW CREATE TABLE "</span> + tableName;
        Map&lt;String, Object&gt; result = jdbcTemplate.queryForMap(sql);
        <span class="hljs-type">String</span> <span class="hljs-variable">createTableSql</span> <span class="hljs-operator">=</span> (String) result.get(<span class="hljs-string">"Create Table"</span>);
        <span class="hljs-keyword">return</span> DigestUtils.md5Hex(createTableSql.getBytes(StandardCharsets.UTF_8));
    }

    <span class="hljs-comment">/**
     * 检验表名合法性
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">validateTableName</span><span class="hljs-params">(String tableName)</span>{
        <span class="hljs-keyword">return</span> tableName.matches(<span class="hljs-string">"^[a-zA-Z0-9_]+$"</span>);
    }

    <span class="hljs-comment">/**
     * 查询整张表数据，返回「主键→整条记录」的Map
     */</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">queryTableData</span><span class="hljs-params">(String tableName)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">pkName</span> <span class="hljs-operator">=</span> getPrimaryKeyName(tableName);
        <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT * FROM "</span> + tableName;
        List&lt;Map&lt;String, Object&gt;&gt; dataList = jdbcTemplate.queryForList(sql);
        <span class="hljs-comment">// 转换为主键→记录的Map</span>
        Map&lt;String, Map&lt;String, Object&gt;&gt; dataMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (Map&lt;String, Object&gt; row : dataList) {
            <span class="hljs-type">Object</span> <span class="hljs-variable">pkValue</span> <span class="hljs-operator">=</span> row.get(pkName);
            dataMap.put(pkValue.toString(), row);
        }
        <span class="hljs-keyword">return</span> dataMap;
    }

}
</code></pre>
<h4 data-id="heading-17">3.3 增量变更对比工具类（核心：提取增删改）</h4>
<pre><code class="hljs language-scss" lang="scss">import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.beans</span><span class="hljs-selector-class">.factory</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Autowired</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Component</span>;

import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.ArrayList</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.List</span>;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Map</span>;

<span class="hljs-comment">/**
 * 增量变更对比工具类
 * @author: ZhongXS02
 * @date: 2025-12-31
 **/</span>
<span class="hljs-keyword">@Component</span>
public class IncrementCompareUtil {

    <span class="hljs-keyword">@Autowired</span>
    private TableStructureUtil tableStructureUtil;

    public IncrementSnapshot <span class="hljs-built_in">compare</span>(Map&lt;String, Map&lt;String,Object&gt;&gt; oldData,
                                        Map&lt;String, Map&lt;String,Object&gt;&gt; newData,
                                        String tableName,
                                        Integer lastVersionNum){
        List&lt;RecordChange&gt; recordChanges=new ArrayList&lt;&gt;();
        String pkName=tableStructureUtil<span class="hljs-selector-class">.getPrimaryKeyName</span>(tableName);

        <span class="hljs-comment">// 1. 新增：newData有，oldData没有</span>
        <span class="hljs-built_in">for</span>(Map.Entry&lt;String,Map&lt;String,Object&gt;&gt; entry:newData.entrySet()){
            String pkValue=entry<span class="hljs-selector-class">.getKey</span>();
            <span class="hljs-built_in">if</span>(!oldData.containsKey(pkValue)){
                RecordChange change=new <span class="hljs-built_in">RecordChange</span>();
                change<span class="hljs-selector-class">.setChangeType</span>("ADD");
                change<span class="hljs-selector-class">.setPrimaryKey</span>(pkValue);
                change<span class="hljs-selector-class">.setNewData</span>(entry.getValue());
                change<span class="hljs-selector-class">.setOldData</span>(null);
                recordChanges<span class="hljs-selector-class">.add</span>(change);
            }
        }

        <span class="hljs-comment">// 2. 删除： oldData有，newData无</span>
        <span class="hljs-built_in">for</span>(Map.Entry&lt;String,Map&lt;String,Object&gt;&gt; entry:oldData.entrySet()){
            String pkValue=entry<span class="hljs-selector-class">.getKey</span>();
            <span class="hljs-built_in">if</span>(!newData.containsKey(pkValue)){
                RecordChange change=new <span class="hljs-built_in">RecordChange</span>();
                change<span class="hljs-selector-class">.setChangeType</span>("DELETE");
                change<span class="hljs-selector-class">.setPrimaryKey</span>(pkValue);
                change<span class="hljs-selector-class">.setNewData</span>(null);
                change<span class="hljs-selector-class">.setOldData</span>(entry.getValue());
                recordChanges<span class="hljs-selector-class">.add</span>(change);
            }
        }

        <span class="hljs-comment">// 3. 修改： 主键都有，内容不同</span>
        <span class="hljs-built_in">for</span>(Map.Entry&lt;String,Map&lt;String,Object&gt;&gt; entry:oldData.entrySet()){
            String pkValue=entry<span class="hljs-selector-class">.getKey</span>();
            <span class="hljs-built_in">if</span>(newData.containsKey(pkValue)){
                Map&lt;String,<span class="hljs-selector-tag">Object</span>&gt; oldRow=entry<span class="hljs-selector-class">.getValue</span>();
                Map&lt;String,<span class="hljs-selector-tag">Object</span>&gt; newRow=newData<span class="hljs-selector-class">.get</span>(pkValue);
                <span class="hljs-built_in">if</span>(!oldRow.equals(newRow)){
                    RecordChange change=new <span class="hljs-built_in">RecordChange</span>();
                    change<span class="hljs-selector-class">.setChangeType</span>("UPDATE");
                    change<span class="hljs-selector-class">.setPrimaryKey</span>(pkValue);
                    change<span class="hljs-selector-class">.setNewData</span>(newRow);
                    change<span class="hljs-selector-class">.setOldData</span>(oldRow);
                    recordChanges<span class="hljs-selector-class">.add</span>(change);
                }
            }
        }

        return new <span class="hljs-built_in">IncrementSnapshot</span>(recordChanges, lastVersionNum);
    }
}
</code></pre>
<h3 data-id="heading-18">4. Mapper 层</h3>
<h4 data-id="heading-19">4.1 TableVersionMapper</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DgTableVersionMapper</span> {

    <span class="hljs-comment">/**
     * 查询指定表的最新版本号
     * <span class="hljs-doctag">@param</span> tableName
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Select("SELECT IFNULL(MAX(table_version_num), 0) FROM dg_table_version WHERE table_name = #{tableName}")</span>
    Integer <span class="hljs-title function_">selectMaxVersionNum</span><span class="hljs-params">(<span class="hljs-meta">@Param("tableName")</span> String tableName)</span>;

    <span class="hljs-comment">/**
     * 查询指定表 + 版本号的记录
     * <span class="hljs-doctag">@param</span> tableName
     * <span class="hljs-doctag">@param</span> versionNum
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Select("SELECT * FROM dg_table_version WHERE table_name = #{tableName} AND table_version_num = #{versionNum}")</span>
    DgTableVersion <span class="hljs-title function_">selectByTableAndVersion</span><span class="hljs-params">(<span class="hljs-meta">@Param("tableName")</span> String tableName, <span class="hljs-meta">@Param("versionNum")</span> Integer versionNum)</span>;

    <span class="hljs-comment">/**
     * 查询指定表的所有版本 （按版本号升序）
     * <span class="hljs-doctag">@param</span> tableName
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Select("SELECT * FROM dg_table_version WHERE table_name = #{tableName} ORDER BY table_version_num ASC")</span>
    List&lt;DgTableVersion&gt; <span class="hljs-title function_">selectAllByTableName</span><span class="hljs-params">(<span class="hljs-meta">@Param("tableName")</span> String tableName)</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(<span class="hljs-meta">@Param("tableVersion")</span> DgTableVersion tableVersion)</span>;
}
</code></pre>
<h4 data-id="heading-20">4.2 TableStructureVersionMapper</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DgTableStructureVersionMapper</span> {

    <span class="hljs-comment">/**
     * 查询指定表+哈希的结构记录
     */</span>
    <span class="hljs-meta">@Select("SELECT * FROM dg_table_structure_version WHERE table_name = #{tableName} AND structure_hash = #{hash}")</span>
    DgTableStructureVersion <span class="hljs-title function_">selectByTableAndHash</span><span class="hljs-params">(<span class="hljs-meta">@Param("tableName")</span> String tableName, <span class="hljs-meta">@Param("hash")</span> String hash)</span>;

    <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(<span class="hljs-meta">@Param("newStruct")</span> DgTableStructureVersion newStruct)</span>;

}
</code></pre>
<h3 data-id="heading-21">5. 核心业务层实现</h3>
<h4 data-id="heading-22">5.1 表版本服务接口</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> interface DgTableVersionService {

    <span class="hljs-comment">/**
     * 提交表版本（自动判断：首次=全量基线，非首次=增量快照）
     */</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">commitVersion</span><span class="hljs-params">(<span class="hljs-type">String</span> tableName, <span class="hljs-type">String</span> versionDesc, <span class="hljs-type">String</span> <span class="hljs-keyword">operator</span>)</span></span>;

    <span class="hljs-comment">/**
     * 回滚整张表到指定版本
     */</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">rollbackToVersion</span><span class="hljs-params">(<span class="hljs-type">String</span> tableName, Integer targetVersion, <span class="hljs-type">String</span> <span class="hljs-keyword">operator</span>)</span></span>;

    <span class="hljs-comment">/**
     * 对比两个版本的差异
     */</span>
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">compareVersion</span><span class="hljs-params">(<span class="hljs-type">String</span> tableName, Integer v1, Integer v2)</span></span>;

    <span class="hljs-comment">/**
     * 查询指定表的所有版本记录
     */</span>
    <span class="hljs-function">List&lt;DgTableVersion&gt; <span class="hljs-title">listTableVersion</span><span class="hljs-params">(<span class="hljs-type">String</span> tableName)</span></span>;
}
</code></pre>
<h4 data-id="heading-23">5.2 表版本服务实现类（核心）</h4>
<pre><code class="hljs language-scss" lang="scss">import lombok<span class="hljs-selector-class">.RequiredArgsConstructor</span>;
import lombok<span class="hljs-selector-class">.extern</span><span class="hljs-selector-class">.slf4j</span><span class="hljs-selector-class">.Slf4j</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.beans</span><span class="hljs-selector-class">.factory</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Autowired</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.jdbc</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.BatchPreparedStatementSetter</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.jdbc</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.JdbcTemplate</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.stereotype</span><span class="hljs-selector-class">.Service</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.transaction</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Transactional</span>;
import org<span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.CollectionUtils</span>;

import java<span class="hljs-selector-class">.sql</span><span class="hljs-selector-class">.PreparedStatement</span>;
import java<span class="hljs-selector-class">.sql</span><span class="hljs-selector-class">.SQLException</span>;
import java<span class="hljs-selector-class">.util</span>.*;
import java<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.stream</span><span class="hljs-selector-class">.Collectors</span>;

<span class="hljs-comment">/**
 * @author: ZhongXS02
 * @date: 2026-01-05
 **/</span>
<span class="hljs-keyword">@Service</span>
<span class="hljs-keyword">@RequiredArgsConstructor</span>
<span class="hljs-keyword">@Transactional</span>
<span class="hljs-keyword">@Slf</span>4j
public class DgTableVersionServiceImpl implements DgTableVersionService {
    <span class="hljs-keyword">@Autowired</span>
    private final DgTableVersionMapper tableVersionMapper;
    private final DgTableStructureVersionMapper tableStructureVersionMapper;
    private final TableStructureUtil tableStructureUtil;
    private final IncrementCompareUtil incrementCompareUtil;
    private final JsonUtil jsonUtil;
    private final JdbcTemplate jdbcTemplate;

    <span class="hljs-keyword">@Transactional</span>
    <span class="hljs-keyword">@Override</span>
    public void commitVersion(String tableName, String versionDesc, String operator) {

        <span class="hljs-comment">// 1. 前置校验：表名合法性、表结构变更检查</span>
        String currentStructHash = tableStructureUtil<span class="hljs-selector-class">.calculateTableStructureHash</span>(tableName);
        <span class="hljs-built_in">checkTableStructure</span>(tableName, currentStructHash, operator);

        <span class="hljs-comment">// 2. 获取最新版本号，计算新版本号</span>
        Integer lastVersionNumber = tableVersionMapper<span class="hljs-selector-class">.selectMaxVersionNum</span>(tableName);
        Integer newVersionNumber = lastVersionNumber + <span class="hljs-number">1</span>;

        <span class="hljs-comment">// 3. 锁表：避免提交版本期间数据被修改（MySQL表锁，需谨慎使用，小并发场景）</span>
        <span class="hljs-built_in">lockTable</span>(tableName);

        try{
            <span class="hljs-comment">// 4. 区分首次提交（全量）和非首次提交（增量）</span>
            DgTableVersion tableVersion= new <span class="hljs-built_in">DgTableVersion</span>();
            tableVersion<span class="hljs-selector-class">.setTableName</span>(tableName);
            tableVersion<span class="hljs-selector-class">.setTableVersionNum</span>(newVersionNumber);
            tableVersion<span class="hljs-selector-class">.setTableStructureHash</span>(currentStructHash);
            tableVersion<span class="hljs-selector-class">.setOperator</span>(operator);
            tableVersion<span class="hljs-selector-class">.setOperateTime</span>(new Date());
            tableVersion<span class="hljs-selector-class">.setVersionDesc</span>(versionDesc);

            <span class="hljs-built_in">if</span>(lastVersionNumber==<span class="hljs-number">0</span>){
                <span class="hljs-comment">// 首次提交：全量基线快照</span>
                <span class="hljs-built_in">commitFullSnapshot</span>(tableVersion,tableName);
            }else{
                <span class="hljs-comment">// 非首次提交：增量快照</span>
                <span class="hljs-built_in">commitIncrementSnapshot</span>(tableVersion, tableName, lastVersionNumber);
            }

            <span class="hljs-comment">// 5. 插入版本记录表</span>
            tableVersionMapper<span class="hljs-selector-class">.insert</span>(tableVersion);
        } finally {
            <span class="hljs-comment">// 解锁表</span>
            <span class="hljs-built_in">unlockTable</span>();
        }


    }

    <span class="hljs-keyword">@Transactional</span>
    <span class="hljs-keyword">@Override</span>
    public void rollbackToVersion(String tableName, Integer targetVersion, String operator) {
        <span class="hljs-comment">// 1. 前置校验</span>
        Integer maxVersion = tableVersionMapper<span class="hljs-selector-class">.selectMaxVersionNum</span>(tableName);
        if (targetVersion &gt; maxVersion) {
            throw new <span class="hljs-built_in">IpsException</span>("目标版本[" + targetVersion + "]不存在，当前最新版本：" + maxVersion);
        }

        <span class="hljs-comment">// 2. 回滚前先提交当前版本</span>
        <span class="hljs-built_in">commitVersion</span>(tableName, "回滚前自动备份-目标版本：" + targetVersion, operator);

        <span class="hljs-comment">// 3. 锁表：禁止并发修改</span>
        <span class="hljs-built_in">lockTable</span>(tableName);

        try{
            <span class="hljs-comment">// 4. 获取目标版本的全量数据</span>
            Map&lt;String,Map&lt;String,<span class="hljs-selector-tag">Object</span>&gt;&gt; targetData=<span class="hljs-built_in">getMergeDataByVersion</span>(tableName, targetVersion);
            String pkName=tableStructureUtil<span class="hljs-selector-class">.getPrimaryKeyName</span>(tableName);

            <span class="hljs-comment">// 5. 清空当前表</span>
            <span class="hljs-built_in">truncateTable</span>(tableName);

            <span class="hljs-comment">// 6. 插入目标版本数据到当前表</span>
            <span class="hljs-built_in">batchInsertData</span>(tableName, pkName, targetData);

            <span class="hljs-comment">// 7. 提交回滚后的版本记录</span>
            <span class="hljs-built_in">commitVersion</span>(tableName, "回滚到版本[" + targetVersion + "]", operator);
        }finally {
            <span class="hljs-built_in">unlockTable</span>();
        }


    }

    <span class="hljs-keyword">@Override</span>
    public String compareVersion(String tableName, Integer v1, Integer v2) {
        <span class="hljs-comment">// 1. 获取两个版本的全量数据</span>
        Map&lt;String, Map&lt;String, <span class="hljs-selector-tag">Object</span>&gt;&gt; dataV1 = <span class="hljs-built_in">getMergeDataByVersion</span>(tableName, v1);
        Map&lt;String, Map&lt;String, <span class="hljs-selector-tag">Object</span>&gt;&gt; dataV2 = <span class="hljs-built_in">getMergeDataByVersion</span>(tableName, v2);

        <span class="hljs-comment">// 2. 对比差异（复用增量对比工具）</span>
        IncrementSnapshot diffSnapshot = incrementCompareUtil<span class="hljs-selector-class">.compare</span>(dataV1, dataV2, tableName, v1);

        <span class="hljs-comment">// 3. 构建差异描述</span>
        StringBuilder diffDesc = new <span class="hljs-built_in">StringBuilder</span>();
        diffDesc<span class="hljs-selector-class">.append</span>("===== 版本对比：")<span class="hljs-selector-class">.append</span>(v1)<span class="hljs-selector-class">.append</span>(" → ")<span class="hljs-selector-class">.append</span>(v2)<span class="hljs-selector-class">.append</span>(" =====\n");
        List&lt;RecordChange&gt; recordChanges = diffSnapshot<span class="hljs-selector-class">.getRecordChanges</span>();
        if (CollectionUtils.isEmpty(recordChanges)) {
            diffDesc<span class="hljs-selector-class">.append</span>("无差异");
            return diffDesc<span class="hljs-selector-class">.toString</span>();
        }

        for (RecordChange change : recordChanges) {
            diffDesc<span class="hljs-selector-class">.append</span>(change.getChangeType())
                    <span class="hljs-selector-class">.append</span>(" - 主键：")<span class="hljs-selector-class">.append</span>(change.getPrimaryKey())<span class="hljs-selector-class">.append</span>("\n");
            if ("UPDATE".equals(change.getChangeType())) {
                diffDesc<span class="hljs-selector-class">.append</span>("  旧值：")<span class="hljs-selector-class">.append</span>(change.getOldData())<span class="hljs-selector-class">.append</span>("\n");
                diffDesc<span class="hljs-selector-class">.append</span>("  新值：")<span class="hljs-selector-class">.append</span>(change.getNewData())<span class="hljs-selector-class">.append</span>("\n");
            } else if ("ADD".equals(change.getChangeType())) {
                diffDesc<span class="hljs-selector-class">.append</span>("  新增数据：")<span class="hljs-selector-class">.append</span>(change.getNewData())<span class="hljs-selector-class">.append</span>("\n");
            } else if ("DELETE".equals(change.getChangeType())) {
                diffDesc<span class="hljs-selector-class">.append</span>("  删除数据：")<span class="hljs-selector-class">.append</span>(change.getOldData())<span class="hljs-selector-class">.append</span>("\n");
            }
            diffDesc<span class="hljs-selector-class">.append</span>("------------------------\n");
        }
        return diffDesc<span class="hljs-selector-class">.toString</span>();
    }

    <span class="hljs-keyword">@Override</span>
    public List&lt;DgTableVersion&gt; listTableVersion(String tableName) {
        return tableVersionMapper<span class="hljs-selector-class">.selectAllByTableName</span>(tableName);
    }

    <span class="hljs-comment">// ====================== 辅助方法 ======================</span>
    <span class="hljs-comment">/**
     * 检查表结构变更，若变更则记录新结构版本
     */</span>
    private void <span class="hljs-built_in">checkTableStructure</span>(String tableName, String currentHash, String operator) {
        DgTableStructureVersion existStruct = tableStructureVersionMapper<span class="hljs-selector-class">.selectByTableAndHash</span>(tableName, currentHash);
        if (existStruct == null) {
            <span class="hljs-comment">// 表结构变更，记录新结构版本</span>
            String createTableSql = jdbcTemplate<span class="hljs-selector-class">.queryForMap</span>("SHOW CREATE TABLE " + tableName)<span class="hljs-selector-class">.get</span>("Create Table")<span class="hljs-selector-class">.toString</span>();
            DgTableStructureVersion newStruct = new <span class="hljs-built_in">DgTableStructureVersion</span>();
            newStruct<span class="hljs-selector-class">.setTableName</span>(tableName);
            newStruct<span class="hljs-selector-class">.setStructureSql</span>(createTableSql);
            newStruct<span class="hljs-selector-class">.setStructureHash</span>(currentHash);
            newStruct<span class="hljs-selector-class">.setOperator</span>(operator);
            newStruct<span class="hljs-selector-class">.setOperateTime</span>(new Date());
            tableStructureVersionMapper<span class="hljs-selector-class">.insert</span>(newStruct);
        }
    }

    <span class="hljs-comment">/**
     * 锁表（MYSQL WRITE锁，阻塞所有读写，小并发场景适用）
     */</span>
    private void <span class="hljs-built_in">lockTable</span>(String tableName) {
        if (!tableStructureUtil.validateTableName(tableName)) {
            throw new <span class="hljs-built_in">RuntimeException</span>("非法表名：" + tableName);
        }
        jdbcTemplate<span class="hljs-selector-class">.execute</span>("LOCK TABLE " + tableName + " WRITE");
    }

    <span class="hljs-comment">/**
     * 解锁表
     */</span>
    private void <span class="hljs-built_in">unlockTable</span>() {
        jdbcTemplate<span class="hljs-selector-class">.execute</span>("UNLOCK TABLES");
    }

    <span class="hljs-comment">/**
     * 清空表（安全截断，避免误删）
     */</span>
    private void <span class="hljs-built_in">truncateTable</span>(String tableName) {
        if (!tableStructureUtil.validateTableName(tableName)) {
            throw new <span class="hljs-built_in">RuntimeException</span>("非法表名：" + tableName);
        }
        jdbcTemplate<span class="hljs-selector-class">.execute</span>("TRUNCATE TABLE " + tableName);
    }



    <span class="hljs-comment">/**
     * 提交全量基线快照（首次提交）
     */</span>
    private void <span class="hljs-built_in">commitFullSnapshot</span>(DgTableVersion tableVersion, String tableName) {
        <span class="hljs-comment">// 查询整张表数据</span>
        Map&lt;String, Map&lt;String, <span class="hljs-selector-tag">Object</span>&gt;&gt; fullData = tableStructureUtil<span class="hljs-selector-class">.queryTableData</span>(tableName);
        <span class="hljs-comment">// 序列化全量数据</span>
        FullSnapshot fullSnapshot = new <span class="hljs-built_in">FullSnapshot</span>(fullData);
        String snapshotContent = jsonUtil<span class="hljs-selector-class">.toJson</span>(fullSnapshot);
        <span class="hljs-comment">// 设置快照信息</span>
        tableVersion<span class="hljs-selector-class">.setSnapshotType</span>(SnapshotType.FULL.name());
        tableVersion<span class="hljs-selector-class">.setSnapshotContent</span>(snapshotContent);
    }

    <span class="hljs-comment">/**
     * 提交增量快照（非首次提交）
     */</span>
    private void <span class="hljs-built_in">commitIncrementSnapshot</span>(DgTableVersion tableVersion, String tableName, Integer lastVersionNum) {
        <span class="hljs-comment">// 1. 获取上一版本的完整数据（基线+所有增量合并）</span>
        Map&lt;String, Map&lt;String, <span class="hljs-selector-tag">Object</span>&gt;&gt; lastVersionData = <span class="hljs-built_in">getMergeDataByVersion</span>(tableName, lastVersionNum);
        <span class="hljs-comment">// 2. 获取当前表的最新数据</span>
        Map&lt;String, Map&lt;String, <span class="hljs-selector-tag">Object</span>&gt;&gt; currentData = tableStructureUtil<span class="hljs-selector-class">.queryTableData</span>(tableName);
        <span class="hljs-comment">// 3. 对比提取增量变更集</span>
        IncrementSnapshot incrementSnapshot = incrementCompareUtil<span class="hljs-selector-class">.compare</span>(lastVersionData, currentData, tableName, lastVersionNum);
        <span class="hljs-comment">// 4. 序列化增量变更集</span>
        String snapshotContent = jsonUtil<span class="hljs-selector-class">.toJson</span>(incrementSnapshot);
        <span class="hljs-comment">// 5. 设置快照信息</span>
        tableVersion<span class="hljs-selector-class">.setSnapshotType</span>(SnapshotType.INCREMENT.name());
        tableVersion<span class="hljs-selector-class">.setSnapshotContent</span>(snapshotContent);
    }


    <span class="hljs-comment">/**
     * 合并基线+增量，获取指定版本的全量数据
     */</span>
    private Map&lt;String, Map&lt;String, <span class="hljs-selector-tag">Object</span>&gt;&gt; <span class="hljs-built_in">getMergeDataByVersion</span>(String tableName, Integer targetVersion) {
        List&lt;DgTableVersion&gt; versionList = tableVersionMapper<span class="hljs-selector-class">.selectAllByTableName</span>(tableName);
        Map&lt;String, Map&lt;String, <span class="hljs-selector-tag">Object</span>&gt;&gt; mergeData = new HashMap&lt;&gt;();

        for (DgTableVersion version : versionList) {
            Integer versionNum = version<span class="hljs-selector-class">.getTableVersionNum</span>();
            if (versionNum &gt; targetVersion) {
                break;
            }
            String snapshotType = version<span class="hljs-selector-class">.getSnapshotType</span>();
            String snapshotContent = version<span class="hljs-selector-class">.getSnapshotContent</span>();

            if (SnapshotType.FULL.name()<span class="hljs-selector-class">.equals</span>(snapshotType)) {
                <span class="hljs-comment">// 基线版本：直接覆盖mergeData</span>
                FullSnapshot fullSnapshot = jsonUtil<span class="hljs-selector-class">.fromJson</span>(snapshotContent, FullSnapshot.class);
                mergeData = fullSnapshot<span class="hljs-selector-class">.getFullData</span>();
            } else {
                <span class="hljs-comment">// 增量版本：应用变更集到mergeData</span>
                IncrementSnapshot incrementSnapshot = jsonUtil<span class="hljs-selector-class">.fromJson</span>(snapshotContent, IncrementSnapshot.class);
                <span class="hljs-built_in">applyIncrementToMergeData</span>(mergeData, incrementSnapshot.getRecordChanges());
            }
        }
        return mergeData;
    }

    <span class="hljs-comment">/**
     * 将增量变更集应用到合并数据中（正向）
     */</span>
    private void <span class="hljs-built_in">applyIncrementToMergeData</span>(Map&lt;String, Map&lt;String, Object&gt;&gt; mergeData, List&lt;RecordChange&gt; recordChanges) {
        for (RecordChange change : recordChanges) {
            <span class="hljs-selector-tag">Object</span> pkValue = change<span class="hljs-selector-class">.getPrimaryKey</span>();
            switch (change.getChangeType()) {
                case "ADD":
                    mergeData.<span class="hljs-built_in">put</span>(pkValue.<span class="hljs-built_in">toString</span>(), change.<span class="hljs-built_in">getNewData</span>());
                    break;
                case "UPDATE":
                    mergeData.<span class="hljs-built_in">put</span>(pkValue.<span class="hljs-built_in">toString</span>(), change.<span class="hljs-built_in">getNewData</span>());
                    break;
                case "DELETE":
                    mergeData.<span class="hljs-built_in">remove</span>(pkValue.<span class="hljs-built_in">toString</span>());
                    break;
            }
        }
    }

    <span class="hljs-comment">/**
     * 批量插入数据到表中
     */</span>
    private void <span class="hljs-built_in">batchInsertData</span>(String tableName, String pkName, Map&lt;String, Map&lt;String, Object&gt;&gt; dataMap) {
        if (CollectionUtils.isEmpty(dataMap)) {
            return;
        }
        <span class="hljs-comment">// 提取第一条记录的字段名（所有记录字段一致）</span>
        Map&lt;String, <span class="hljs-selector-tag">Object</span>&gt; firstRow = dataMap<span class="hljs-selector-class">.values</span>()<span class="hljs-selector-class">.iterator</span>()<span class="hljs-selector-class">.next</span>();
        if (CollectionUtils.isEmpty(firstRow)) { <span class="hljs-comment">// 新增：字段为空直接返回</span>
            return;
        }
        List&lt;String&gt; <span class="hljs-attribute">columns</span> = new ArrayList&lt;&gt;(firstRow.keySet());

        <span class="hljs-comment">// 修复1：转义保留关键字字段（如desc、enable等）</span>
        List&lt;String&gt; escapedColumns = <span class="hljs-attribute">columns</span><span class="hljs-selector-class">.stream</span>()
                <span class="hljs-selector-class">.map</span>(col -&gt; "`" + col + "`")
                <span class="hljs-selector-class">.collect</span>(Collectors.toList());
        String columnStr = String<span class="hljs-selector-class">.join</span>(",", escapedColumns);

        <span class="hljs-comment">// 构建批量插入SQL（优化拼接逻辑）</span>
        StringBuilder sqlBuilder = new <span class="hljs-built_in">StringBuilder</span>();
        sqlBuilder<span class="hljs-selector-class">.append</span>("INSERT INTO ")<span class="hljs-selector-class">.append</span>(tableName)<span class="hljs-selector-class">.append</span>(" (")<span class="hljs-selector-class">.append</span>(columnStr)<span class="hljs-selector-class">.append</span>(") VALUES ");

        List&lt;List&lt;<span class="hljs-selector-tag">Object</span>&gt;&gt; batchParams = new ArrayList&lt;&gt;();
        List&lt;String&gt; valuePlaceholders = new ArrayList&lt;&gt;(); <span class="hljs-comment">// 存储每一行的?占位符</span>
        for (Map&lt;String, Object&gt; row : dataMap.values()) {
            List&lt;<span class="hljs-selector-tag">Object</span>&gt; params = new ArrayList&lt;&gt;();
            <span class="hljs-comment">// 构建单条记录的?占位符</span>
            StringBuilder singleValue = new <span class="hljs-built_in">StringBuilder</span>("(");
            for (String column : columns) {
                singleValue<span class="hljs-selector-class">.append</span>("?,");
                params<span class="hljs-selector-class">.add</span>(row.get(column));
            }
            <span class="hljs-comment">// 移除最后一个逗号（更安全的方式）</span>
            if (singleValue.length() &gt; <span class="hljs-number">1</span>) {
                singleValue<span class="hljs-selector-class">.setLength</span>(singleValue.length() - <span class="hljs-number">1</span>);
            }
            singleValue<span class="hljs-selector-class">.append</span>(")");
            valuePlaceholders<span class="hljs-selector-class">.add</span>(singleValue.toString()); <span class="hljs-comment">// 加入占位符列表</span>
            batchParams<span class="hljs-selector-class">.add</span>(params);
        }
        <span class="hljs-comment">// 拼接所有占位符（用逗号分隔），避免手动删逗号</span>
        sqlBuilder<span class="hljs-selector-class">.append</span>(String.join(",", valuePlaceholders));

        <span class="hljs-comment">// 执行批量插入</span>
        jdbcTemplate<span class="hljs-selector-class">.batchUpdate</span>(sqlBuilder.toString(), new <span class="hljs-built_in">BatchPreparedStatementSetter</span>() {
            <span class="hljs-keyword">@Override</span>
            public void setValues(PreparedStatement ps, int i) throws SQLException {
                List&lt;<span class="hljs-selector-tag">Object</span>&gt; params = batchParams<span class="hljs-selector-class">.get</span>(i);
                for (int j = <span class="hljs-number">0</span>; j &lt; params.size(); j++) {
                    ps<span class="hljs-selector-class">.setObject</span>(j + <span class="hljs-number">1</span>, params.get(j));
                }
            }

            <span class="hljs-keyword">@Override</span>
            public int getBatchSize() {
                return batchParams<span class="hljs-selector-class">.size</span>();
            }
        });
    }

}
</code></pre>
<h3 data-id="heading-24">6. 控制层（暴露 REST 接口）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">io</span><span class="hljs-selector-class">.swagger</span><span class="hljs-selector-class">.v3</span><span class="hljs-selector-class">.oas</span><span class="hljs-selector-class">.annotations</span><span class="hljs-selector-class">.Operation</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">lombok</span><span class="hljs-selector-class">.RequiredArgsConstructor</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">lombok</span><span class="hljs-selector-class">.extern</span><span class="hljs-selector-class">.slf4j</span><span class="hljs-selector-class">.Slf4j</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.http</span><span class="hljs-selector-class">.ResponseEntity</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span>.*;

<span class="hljs-comment">/**
 * 表内容版本控制
 *
 * @author: ZhongXS02
 * @date: 2026-01-05
 **/</span>
@<span class="hljs-selector-tag">RestController</span>
@<span class="hljs-selector-tag">RequestMapping</span>(<span class="hljs-string">"/v1/dg/tableVersion"</span>)
@<span class="hljs-selector-tag">Slf4j</span>
@<span class="hljs-selector-tag">RequiredArgsConstructor</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">DgTableVersionController</span> {

    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">final</span> <span class="hljs-selector-tag">DgTableVersionService</span> <span class="hljs-selector-tag">dgTableVersionService</span>;

    @<span class="hljs-selector-tag">Operation</span>(summary = <span class="hljs-string">"提交表版本"</span>)
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"commit"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;?&gt; <span class="hljs-selector-tag">commitVersion</span>(<span class="hljs-variable">@RequestParam</span> String tableName,
                                           <span class="hljs-variable">@RequestParam</span> String versionDesc,
                                           <span class="hljs-variable">@RequestParam</span>(defaultValue = <span class="hljs-string">"admin"</span>) String operator){
        <span class="hljs-selector-tag">dgTableVersionService</span><span class="hljs-selector-class">.commitVersion</span>(tableName, versionDesc, operator);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(<span class="hljs-string">"提交成功"</span>);
    }

    @<span class="hljs-selector-tag">Operation</span>(summary = <span class="hljs-string">"对比两个版本差异"</span>)
    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"compare"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;?&gt; <span class="hljs-selector-tag">compareVersion</span>(<span class="hljs-variable">@RequestParam</span> String tableName,
                                            <span class="hljs-variable">@RequestParam</span> Integer v1,
                                            <span class="hljs-variable">@RequestParam</span> Integer v2){
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">diff</span> = <span class="hljs-selector-tag">dgTableVersionService</span><span class="hljs-selector-class">.compareVersion</span>(tableName, v1, v2);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(diff);
    }


    @<span class="hljs-selector-tag">Operation</span>(summary = <span class="hljs-string">"回滚到指定版本"</span>)
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"rollback"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">ResponseEntity</span>&lt;?&gt; <span class="hljs-selector-tag">rollbackVersion</span>(<span class="hljs-variable">@RequestParam</span> String tableName,
                                     <span class="hljs-variable">@RequestParam</span> Integer targetVersion,
                                     <span class="hljs-variable">@RequestParam</span>(defaultValue = <span class="hljs-string">"admin"</span>) String operator) {
        <span class="hljs-selector-tag">dgTableVersionService</span><span class="hljs-selector-class">.rollbackToVersion</span>(tableName, targetVersion, operator);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(<span class="hljs-string">"回滚成功"</span>);
    }


}
</code></pre>
<h2 data-id="heading-25">四、注意事项</h2>
<ol>
<li><strong>并发控制</strong>：生产环境若并发较高，建议替换表锁为分布式锁（如Redisson），避免锁表阻塞</li>
<li><strong>大表优化</strong>：批量插入时使用分批插入（如每 1000 条一批），避免内存溢出；增量对比时可限制查询字段（仅对比业务字段，忽略 create_time/update_time 等）</li>
<li><strong>SQL注入防护</strong>：表名、字段名必须严格校验，禁止直接拼接用户输入</li>
<li><strong>版本归档</strong>：定期归档旧版本（如超过 6 个月的增量快照），合并为新基线，减少回滚时的计算量</li>
<li><strong>数据备份</strong>：回滚前的自动备份建议存储到独立的备份表，而非仅提交版本（防止回滚失败）</li>
</ol>
<h2 data-id="heading-26">五、问题总监</h2>
<h3 data-id="heading-27">1. 新学了@RequiredArgsConstructor + final 注入（构造器注入）</h3>
<p><code>@RequiredArgsConstructor</code>是 Lombok 注解，会自动生成包含所有<code>final</code>字段的构造器，Spring 通过构造器完成注入：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.RequiredArgsConstructor;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@RequiredArgsConstructor</span> <span class="hljs-comment">// Lombok自动生成构造器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-comment">// final修饰的字段会被纳入构造器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;

    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> {
        userRepository.findById(<span class="hljs-number">1L</span>);
    }
}
</code></pre>
<blockquote>
<p>等价于</p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;

    <span class="hljs-comment">// 手动编写构造器，Spring通过构造器注入</span>
    <span class="hljs-keyword">public</span> UserService(UserRepository userRepository) {
        <span class="hljs-keyword">this</span>.userRepository = userRepository;
    }
}
</code></pre>


















































<table><thead><tr><th>维度</th><th>@Autowired（字段注入）</th><th>@RequiredArgsConstructor + final（构造器注入）</th></tr></thead><tbody><tr><td>注入方式</td><td>字段注入，Spring 通过反射直接赋值字段</td><td>构造器注入，Spring 调用构造器传入依赖</td></tr><tr><td>不可变性</td><td>字段不能用 final 修饰（赋值时机晚）</td><td>字段必须用 final 修饰，保证依赖不可变</td></tr><tr><td>空指针风险</td><td>高（依赖未注入时调用会 NPE）</td><td>低（构造时必须传入依赖，否则无法创建对象）</td></tr><tr><td>可测试性</td><td>差（需要 Spring 容器，单元测试需 mockito）</td><td>好（直接通过构造器传入 mock 对象，无需容器）</td></tr><tr><td>代码简洁性</td><td>字段上加注解，无需写构造器</td><td>类上加注解，字段加 final，无冗余代码</td></tr><tr><td>依赖可见性</td><td>私有字段，外部无法直接赋值</td><td>构造器暴露依赖，语义更清晰</td></tr><tr><td>Spring 版本兼容</td><td>全版本支持</td><td>需 Spring 4.3+（自动识别单构造器无需 @Autowired）</td></tr><tr><td>循环依赖处理</td><td>支持（字段注入是 Spring 后期赋值）</td><td>不支持（构造器注入会触发循环依赖检测）</td></tr></tbody></table>
<h3 data-id="heading-28">2. 主键异常</h3>
<p>问题描述：数据库原表主键是BIGINT,用Object接收就是Long，但转为JSON在提取出来就会变成Ingter，这样在对比的时候就会匹配不上</p>
<p>解决方法：</p>
<blockquote>
<p>Map&lt;Object, Map&lt;String, Object&gt;&gt; -&gt; Map&lt;String, Map&lt;String, Object&gt;&gt;</p>
</blockquote>
<p>将主键 Object 改为 String</p>
<h3 data-id="heading-29">3. 关键字异常</h3>
<p>问题描述：在回滚表结构时，有个关键字是MySQL保留字段，但没做相对应的处理导致报错</p>
<p>解决方法：加上关键字处理方法  `字段`</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/**
 * 批量插入数据到表中
 */</span>
private void <span class="hljs-built_in">batchInsertData</span>(String tableName, String pkName, Map&lt;String, Map&lt;String, Object&gt;&gt; dataMap) {
    if (CollectionUtils.isEmpty(dataMap)) {
        return;
    }
    <span class="hljs-comment">// 提取第一条记录的字段名（所有记录字段一致）</span>
    Map&lt;String, <span class="hljs-selector-tag">Object</span>&gt; firstRow = dataMap<span class="hljs-selector-class">.values</span>()<span class="hljs-selector-class">.iterator</span>()<span class="hljs-selector-class">.next</span>();
    if (CollectionUtils.isEmpty(firstRow)) { <span class="hljs-comment">// 新增：字段为空直接返回</span>
        return;
    }
    List&lt;String&gt; <span class="hljs-attribute">columns</span> = new ArrayList&lt;&gt;(firstRow.keySet());

    <span class="hljs-comment">// 修复1：转义保留关键字字段（如desc、enable等）</span>
    List&lt;String&gt; escapedColumns = <span class="hljs-attribute">columns</span><span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.map</span>(col -&gt; "`" + col + "`")
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());
    String columnStr = String<span class="hljs-selector-class">.join</span>(",", escapedColumns);

    <span class="hljs-comment">// 构建批量插入SQL（优化拼接逻辑）</span>
    StringBuilder sqlBuilder = new <span class="hljs-built_in">StringBuilder</span>();
    sqlBuilder<span class="hljs-selector-class">.append</span>("INSERT INTO ")<span class="hljs-selector-class">.append</span>(tableName)<span class="hljs-selector-class">.append</span>(" (")<span class="hljs-selector-class">.append</span>(columnStr)<span class="hljs-selector-class">.append</span>(") VALUES ");

    List&lt;List&lt;<span class="hljs-selector-tag">Object</span>&gt;&gt; batchParams = new ArrayList&lt;&gt;();
    List&lt;String&gt; valuePlaceholders = new ArrayList&lt;&gt;(); <span class="hljs-comment">// 存储每一行的?占位符</span>
    for (Map&lt;String, Object&gt; row : dataMap.values()) {
        List&lt;<span class="hljs-selector-tag">Object</span>&gt; params = new ArrayList&lt;&gt;();
        <span class="hljs-comment">// 构建单条记录的?占位符</span>
        StringBuilder singleValue = new <span class="hljs-built_in">StringBuilder</span>("(");
        for (String column : columns) {
            singleValue<span class="hljs-selector-class">.append</span>("?,");
            params<span class="hljs-selector-class">.add</span>(row.get(column));
        }
        <span class="hljs-comment">// 移除最后一个逗号（更安全的方式）</span>
        if (singleValue.length() &gt; <span class="hljs-number">1</span>) {
            singleValue<span class="hljs-selector-class">.setLength</span>(singleValue.length() - <span class="hljs-number">1</span>);
        }
        singleValue<span class="hljs-selector-class">.append</span>(")");
        valuePlaceholders<span class="hljs-selector-class">.add</span>(singleValue.toString()); <span class="hljs-comment">// 加入占位符列表</span>
        batchParams<span class="hljs-selector-class">.add</span>(params);
    }
    <span class="hljs-comment">// 拼接所有占位符（用逗号分隔），避免手动删逗号</span>
    sqlBuilder<span class="hljs-selector-class">.append</span>(String.join(",", valuePlaceholders));

    <span class="hljs-comment">// 执行批量插入</span>
    jdbcTemplate<span class="hljs-selector-class">.batchUpdate</span>(sqlBuilder.toString(), new <span class="hljs-built_in">BatchPreparedStatementSetter</span>() {
        <span class="hljs-keyword">@Override</span>
        public void setValues(PreparedStatement ps, int i) throws SQLException {
            List&lt;<span class="hljs-selector-tag">Object</span>&gt; params = batchParams<span class="hljs-selector-class">.get</span>(i);
            for (int j = <span class="hljs-number">0</span>; j &lt; params.size(); j++) {
                ps<span class="hljs-selector-class">.setObject</span>(j + <span class="hljs-number">1</span>, params.get(j));
            }
        }

        <span class="hljs-keyword">@Override</span>
        public int getBatchSize() {
            return batchParams<span class="hljs-selector-class">.size</span>();
        }
    });
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG核心升级｜多LLM模型动态切换方案]]></title>    <link>https://juejin.cn/post/7592884480732168238</link>    <guid>https://juejin.cn/post/7592884480732168238</guid>    <pubDate>2026-01-09T02:55:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592884480732168238" data-draft-id="7592884480732151854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG核心升级｜多LLM模型动态切换方案"/> <meta itemprop="keywords" content="后端,人工智能,AI编程"/> <meta itemprop="datePublished" content="2026-01-09T02:55:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="造轮子的猪"/> <meta itemprop="url" content="https://juejin.cn/user/497453720940158"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG核心升级｜多LLM模型动态切换方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/497453720940158/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    造轮子的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T02:55:45.000Z" title="Fri Jan 09 2026 02:55:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RAG核心升级｜多LLM模型动态切换方案</h2>
<h3 data-id="heading-1">一、多模型切换核心价值</h3>
<p>传统RAG架构绑定单一LLM模型，无法适配多样化的问答场景；而<strong>多模型动态切换方案</strong>可根据场景/需求灵活选择最优模型，核心价值如下：
场景化适配：技术文档问答用<code>deepseek-r1</code>（代码/技术理解强），通用闲聊用<code>qwen2-7b</code>（中文流畅度高），精准匹配不同场景需求；
性能与成本平衡：简单问答用轻量模型（如7B），复杂推理用高性能模型（如8B/70B），降低整体推理成本；
容错与容灾：单个模型服务异常时，可快速切换到备用模型，提升系统可用性；
灵活扩展：新增模型仅需配置YAML，无需修改核心代码，支持无缝接入Llama3、Gemini等新模型；
个性化调优：不同模型独立配置参数（温度、最大生成长度），针对场景精细化调优，提升回答质量。</p>
<h3 data-id="heading-2">二、多模型切换 vs 单模型绑定（核心优势对比）</h3>








































<table><thead><tr><th>对比维度</th><th>单模型绑定（传统方案）</th><th>多模型动态切换（优化方案）</th></tr></thead><tbody><tr><td><strong>场景适配性</strong></td><td>单一模型无法兼顾所有场景（如技术问答/通用闲聊）</td><td>按场景选择最优模型，精准匹配不同问答需求</td></tr><tr><td><strong>参数调优</strong></td><td>全局参数配置，无法针对场景精细化调优</td><td>每个模型独立配置参数（温度、max_tokens），灵活调优</td></tr><tr><td><strong>系统可用性</strong></td><td>模型服务异常则整体不可用</td><td>支持模型降级/切换，单个模型故障不影响整体服务</td></tr><tr><td><strong>扩展成本</strong></td><td>新增模型需修改代码、重新部署</td><td>仅需新增YAML配置，热扩展无需重启服务</td></tr><tr><td><strong>资源利用效率</strong></td><td>轻量场景浪费大模型资源，复杂场景轻量模型能力不足</td><td>按需分配模型资源，平衡性能与成本</td></tr><tr><td><strong>迭代灵活性</strong></td><td>模型升级需全量替换，风险高</td><td>可灰度验证新模型，逐步切换，降低迭代风险</td></tr></tbody></table>
<h3 data-id="heading-3">三、完整实现方案</h3>
<h4 data-id="heading-4">1. YAML配置（结构化+可扩展）</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">ollama:</span>
      <span class="hljs-comment"># Ollama 服务基础地址（统一配置，避免硬编码）</span>
      <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://127.0.0.1:11434</span>
      <span class="hljs-comment"># 多Chat模型配置列表（核心：支持动态扩展）</span>
      <span class="hljs-attr">chats:</span>
        <span class="hljs-comment"># 模型1：通义千问（默认模型，中文通用场景）</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">code:</span> <span class="hljs-string">qwen2-7b</span>
          <span class="hljs-attr">model:</span> <span class="hljs-string">qwen2:7b-instruct</span>
          <span class="hljs-attr">options:</span>
            <span class="hljs-attr">temperature:</span> <span class="hljs-number">0.3</span>        <span class="hljs-comment"># 低随机性，保证回答精准</span>
            <span class="hljs-attr">max_tokens:</span> <span class="hljs-number">2000</span>        <span class="hljs-comment"># 适配通用问答长度</span>
            <span class="hljs-attr">connect_timeout:</span> <span class="hljs-string">60s</span>    <span class="hljs-comment"># 连接超时</span>
            <span class="hljs-attr">read_timeout:</span> <span class="hljs-string">5m</span>        <span class="hljs-comment"># 读取超时</span>
          <span class="hljs-attr">context:</span>
            <span class="hljs-attr">expire-minutes:</span> <span class="hljs-number">120</span>     <span class="hljs-comment"># 会话上下文过期时间</span>
            <span class="hljs-attr">max-message-count:</span> <span class="hljs-number">20</span>   <span class="hljs-comment"># 最大上下文消息数</span>
        <span class="hljs-comment"># 模型2：深度求索（技术/代码场景专用）</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">code:</span> <span class="hljs-string">deepseek-r1</span>
          <span class="hljs-attr">model:</span> <span class="hljs-string">deepseek-r1:8b</span>
          <span class="hljs-attr">options:</span>
            <span class="hljs-attr">temperature:</span> <span class="hljs-number">0.5</span>        <span class="hljs-comment"># 中等随机性，兼顾创意与精准</span>
            <span class="hljs-attr">max_tokens:</span> <span class="hljs-number">3000</span>        <span class="hljs-comment"># 适配长文本技术回答</span>
            <span class="hljs-attr">connect_timeout:</span> <span class="hljs-string">60s</span>
            <span class="hljs-attr">read_timeout:</span> <span class="hljs-string">5m</span>
          <span class="hljs-attr">context:</span>
            <span class="hljs-attr">expire-minutes:</span> <span class="hljs-number">120</span>
            <span class="hljs-attr">max-message-count:</span> <span class="hljs-number">20</span>
        <span class="hljs-comment"># 扩展：新增模型仅需添加此节点，无需修改代码</span>
        <span class="hljs-comment"># - code: llama3-8b</span>
        <span class="hljs-comment">#   model: llama3:8b-instruct</span>
        <span class="hljs-comment">#   options:</span>
        <span class="hljs-comment">#     temperature: 0.4</span>
        <span class="hljs-comment">#     max_tokens: 2500</span>
        <span class="hljs-comment">#   context:</span>
        <span class="hljs-comment">#     expire-minutes: 120</span>
        <span class="hljs-comment">#     max-message-count: 20</span>
</code></pre>
<h4 data-id="heading-5">2. 多模型配置绑定类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;
<span class="hljs-keyword">import</span> org.springframework.util.Assert;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * Ollama多模型配置绑定类【生产级】
 * 职责：绑定YAML中的多模型配置，提供类型安全的配置访问
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-meta">@ConfigurationProperties(prefix = "spring.ai.ollama")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OllamaMultiModelProperties</span> {
    <span class="hljs-comment">// Ollama基础服务地址（必填）</span>
    <span class="hljs-keyword">private</span> String baseUrl;
    <span class="hljs-comment">// 多Chat模型配置列表（至少配置1个模型）</span>
    <span class="hljs-keyword">private</span> List&lt;OllamaChatModelConfig&gt; chats;

    <span class="hljs-comment">/**
     * 初始化校验：确保核心配置非空
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> {
        Assert.hasText(baseUrl, <span class="hljs-string">"spring.ai.ollama.base-url 不能为空"</span>);
        Assert.notEmpty(chats, <span class="hljs-string">"spring.ai.ollama.chats 至少配置一个模型"</span>);
        <span class="hljs-comment">// 校验每个模型的核心配置</span>
        <span class="hljs-keyword">for</span> (OllamaChatModelConfig config : chats) {
            Assert.hasText(config.getCode(), <span class="hljs-string">"模型编码（code）不能为空"</span>);
            Assert.hasText(config.getModel(), <span class="hljs-string">"模型名称（model）不能为空"</span>);
            Assert.notNull(config.getOptions(), <span class="hljs-string">"模型参数（options）不能为空"</span>);
        }
    }

    <span class="hljs-comment">/**
     * 单个Chat模型的完整配置项
     */</span>
    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OllamaChatModelConfig</span> {
        <span class="hljs-comment">// 模型唯一编码（如qwen2-7b，用于前端/业务层指定模型）</span>
        <span class="hljs-keyword">private</span> String code;
        <span class="hljs-comment">// Ollama中注册的模型名称（如qwen2:7b-instruct）</span>
        <span class="hljs-keyword">private</span> String model;
        <span class="hljs-comment">// 模型推理参数（温度、最大生成长度等）</span>
        <span class="hljs-keyword">private</span> OllamaChatOptionsConfig options;
        <span class="hljs-comment">// 会话上下文配置（过期时间、最大消息数）</span>
        <span class="hljs-keyword">private</span> OllamaChatContextConfig context;

        <span class="hljs-comment">/**
         * 模型推理参数配置
         */</span>
        <span class="hljs-meta">@Data</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OllamaChatOptionsConfig</span> {
            <span class="hljs-comment">// 温度：0-1，值越高回答越随机，越低越精准</span>
            <span class="hljs-keyword">private</span> <span class="hljs-type">Double</span> <span class="hljs-variable">temperature</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.3</span>; <span class="hljs-comment">// 默认值</span>
            <span class="hljs-comment">// 最大生成长度：限制单次回答的token数</span>
            <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">maxTokens</span> <span class="hljs-operator">=</span> <span class="hljs-number">2000</span>; <span class="hljs-comment">// 默认值</span>
            <span class="hljs-comment">// 连接超时（如60s）</span>
            <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">connectTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-string">"60s"</span>; <span class="hljs-comment">// 默认值</span>
            <span class="hljs-comment">// 读取超时（如5m）</span>
            <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">readTimeout</span> <span class="hljs-operator">=</span> <span class="hljs-string">"5m"</span>; <span class="hljs-comment">// 默认值</span>
        }

        <span class="hljs-comment">/**
         * 会话上下文配置
         */</span>
        <span class="hljs-meta">@Data</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OllamaChatContextConfig</span> {
            <span class="hljs-comment">// 上下文过期时间（分钟）</span>
            <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">expireMinutes</span> <span class="hljs-operator">=</span> <span class="hljs-number">120</span>; <span class="hljs-comment">// 默认值</span>
            <span class="hljs-comment">// 最大上下文消息数（避免上下文过长）</span>
            <span class="hljs-keyword">private</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">maxMessageCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">20</span>; <span class="hljs-comment">// 默认值</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-6">3. 多模型工厂配置类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Primary;
<span class="hljs-keyword">import</span> org.springframework.ai.ollama.OllamaApi;
<span class="hljs-keyword">import</span> org.springframework.ai.ollama.OllamaChatModel;
<span class="hljs-keyword">import</span> org.springframework.ai.ollama.OllamaOptions;
<span class="hljs-keyword">import</span> org.springframework.ai.observation.ObservationRegistry;
<span class="hljs-keyword">import</span> org.springframework.ai.tool.ToolCallingManager;
<span class="hljs-keyword">import</span> org.springframework.ai.model.ModelManagementOptions;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> javax.annotation.Resource;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.Optional;

<span class="hljs-comment">/**
 * 多LLM模型配置类【生产级】
 * 职责：注册多模型实例、提供动态获取ChatClient的工厂，支撑模型切换
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatClientConfig</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> OllamaMultiModelProperties ollamaMultiModelProperties;

    <span class="hljs-comment">// ========== 1. 注册默认Chat模型（兼容原有业务逻辑） ==========</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-keyword">public</span> OllamaChatModel <span class="hljs-title function_">defaultOllamaChatModel</span><span class="hljs-params">()</span> {
        log.info(<span class="hljs-string">"初始化默认Chat模型：qwen2-7b"</span>);
        <span class="hljs-keyword">return</span> createOllamaChatModel(<span class="hljs-string">"qwen2-7b"</span>);
    }

    <span class="hljs-comment">// ========== 2. 注册多模型映射表（核心：存储所有模型实例） ==========</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> Map&lt;String, OllamaChatModel&gt; <span class="hljs-title function_">ollamaChatModelMap</span><span class="hljs-params">()</span> {
        Map&lt;String, OllamaChatModel&gt; modelMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        <span class="hljs-comment">// 遍历配置，初始化所有模型实例</span>
        <span class="hljs-keyword">for</span> (OllamaMultiModelProperties.OllamaChatModelConfig config : ollamaMultiModelProperties.getChats()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">modelCode</span> <span class="hljs-operator">=</span> config.getCode();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">OllamaChatModel</span> <span class="hljs-variable">chatModel</span> <span class="hljs-operator">=</span> createOllamaChatModel(modelCode);
                modelMap.put(modelCode, chatModel);
                log.info(<span class="hljs-string">"成功初始化模型：{}，对应Ollama模型名：{}"</span>, modelCode, config.getModel());
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.error(<span class="hljs-string">"初始化模型【{}】失败，跳过该模型"</span>, modelCode, e);
                <span class="hljs-comment">// 单个模型初始化失败不影响整体流程</span>
                <span class="hljs-keyword">continue</span>;
            }
        }
        <span class="hljs-comment">// 校验模型映射表非空</span>
        <span class="hljs-keyword">if</span> (modelMap.isEmpty()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"未成功初始化任何LLM模型，请检查配置"</span>);
        }
        <span class="hljs-keyword">return</span> modelMap;
    }

    <span class="hljs-comment">// ========== 3. 注册ChatClient工厂（对外提供模型切换能力） ==========</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ChatClientFactory <span class="hljs-title function_">chatClientFactory</span><span class="hljs-params">(Map&lt;String, OllamaChatModel&gt; ollamaChatModelMap)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatClientFactory</span>(ollamaChatModelMap);
    }

    <span class="hljs-comment">// ========== 4. 兼容原有ChatClient.Builder（避免业务代码改造） ==========</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> org.springframework.ai.chat.ChatClient.Builder <span class="hljs-title function_">defaultChatClientBuilder</span><span class="hljs-params">(OllamaChatModel defaultOllamaChatModel)</span> {
        <span class="hljs-keyword">return</span> org.springframework.ai.chat.ChatClient.builder(defaultOllamaChatModel);
    }

    <span class="hljs-comment">// ========== 私有方法：根据模型编码创建OllamaChatModel实例 ==========</span>
    <span class="hljs-keyword">private</span> OllamaChatModel <span class="hljs-title function_">createOllamaChatModel</span><span class="hljs-params">(String modelCode)</span> {
        <span class="hljs-comment">// 1. 根据编码查找模型配置（优化：使用流式API，避免循环）</span>
        Optional&lt;OllamaMultiModelProperties.OllamaChatModelConfig&gt; modelConfigOpt =
                ollamaMultiModelProperties.getChats().stream()
                        .filter(config -&gt; modelCode.equals(config.getCode()))
                        .findFirst();
        <span class="hljs-comment">// 兜底：使用第一个模型配置</span>
        OllamaMultiModelProperties.<span class="hljs-type">OllamaChatModelConfig</span> <span class="hljs-variable">modelConfig</span> <span class="hljs-operator">=</span> modelConfigOpt.orElseGet(() -&gt; {
            log.warn(<span class="hljs-string">"未找到模型【{}】的配置，使用第一个模型作为兜底"</span>, modelCode);
            <span class="hljs-keyword">return</span> ollamaMultiModelProperties.getChats().get(<span class="hljs-number">0</span>);
        });

        <span class="hljs-comment">// 2. 构建Ollama API客户端（基础地址统一配置）</span>
        <span class="hljs-type">OllamaApi</span> <span class="hljs-variable">ollamaApi</span> <span class="hljs-operator">=</span> OllamaApi.builder()
                .baseUrl(ollamaMultiModelProperties.getBaseUrl())
                .build();

        <span class="hljs-comment">// 3. 构建模型参数（动态读取配置，支持所有Ollama参数）</span>
        <span class="hljs-type">OllamaOptions</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> OllamaOptions.builder()
                .model(modelConfig.getModel())
                .temperature(modelConfig.getOptions().getTemperature())
                .build();
        options.setMaxTokens(modelConfig.getOptions().getMaxTokens());

        <span class="hljs-comment">// 4. 固定配置（工具调用、观测、模型管理）</span>
        <span class="hljs-type">ToolCallingManager</span> <span class="hljs-variable">toolCallingManager</span> <span class="hljs-operator">=</span> ToolCallingManager.builder().build();
        <span class="hljs-type">ModelManagementOptions</span> <span class="hljs-variable">modelManagementOptions</span> <span class="hljs-operator">=</span> ModelManagementOptions.builder().build();
        <span class="hljs-type">ObservationRegistry</span> <span class="hljs-variable">observationRegistry</span> <span class="hljs-operator">=</span> ObservationRegistry.create();

        <span class="hljs-comment">// 5. 创建并返回模型实例</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OllamaChatModel</span>(ollamaApi, options, toolCallingManager, observationRegistry, modelManagementOptions);
    }

    <span class="hljs-comment">// ========== 核心内部类：ChatClient工厂（对外暴露模型切换能力） ==========</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatClientFactory</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, OllamaChatModel&gt; chatModelMap;
        <span class="hljs-comment">// 默认模型编码（可配置化）</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_MODEL_CODE</span> <span class="hljs-operator">=</span> <span class="hljs-string">"qwen2-7b"</span>;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatClientFactory</span><span class="hljs-params">(Map&lt;String, OllamaChatModel&gt; chatModelMap)</span> {
            <span class="hljs-built_in">this</span>.chatModelMap = chatModelMap;
        }

        <span class="hljs-comment">/**
         * 根据模型编码动态获取ChatClient（核心方法）
         * <span class="hljs-doctag">@param</span> modelCode 模型编码（qwen2-7b/deepseek-r1）
         * <span class="hljs-doctag">@return</span> 绑定对应模型的ChatClient
         */</span>
        <span class="hljs-keyword">public</span> org.springframework.ai.chat.ChatClient <span class="hljs-title function_">getChatClient</span><span class="hljs-params">(String modelCode)</span> {
            <span class="hljs-comment">// 空值处理：使用默认模型</span>
            <span class="hljs-keyword">if</span> (modelCode == <span class="hljs-literal">null</span> || modelCode.isBlank()) {
                log.info(<span class="hljs-string">"模型编码为空，使用默认模型：{}"</span>, DEFAULT_MODEL_CODE);
                <span class="hljs-keyword">return</span> getDefaultChatClient();
            }
            <span class="hljs-comment">// 获取指定模型</span>
            <span class="hljs-type">OllamaChatModel</span> <span class="hljs-variable">chatModel</span> <span class="hljs-operator">=</span> chatModelMap.get(modelCode);
            <span class="hljs-keyword">if</span> (chatModel == <span class="hljs-literal">null</span>) {
                log.warn(<span class="hljs-string">"模型【{}】不存在，降级到默认模型：{}"</span>, modelCode, DEFAULT_MODEL_CODE);
                <span class="hljs-keyword">return</span> getDefaultChatClient();
            }
            log.debug(<span class="hljs-string">"使用模型【{}】创建ChatClient"</span>, modelCode);
            <span class="hljs-keyword">return</span> org.springframework.ai.chat.ChatClient.builder(chatModel).build();
        }

        <span class="hljs-comment">/**
         * 获取默认ChatClient（兼容原有逻辑）
         */</span>
        <span class="hljs-keyword">public</span> org.springframework.ai.chat.ChatClient <span class="hljs-title function_">getDefaultChatClient</span><span class="hljs-params">()</span> {
            <span class="hljs-type">OllamaChatModel</span> <span class="hljs-variable">defaultModel</span> <span class="hljs-operator">=</span> chatModelMap.get(DEFAULT_MODEL_CODE);
            <span class="hljs-keyword">return</span> org.springframework.ai.chat.ChatClient.builder(defaultModel).build();
        }

        <span class="hljs-comment">/**
         * 获取所有可用模型编码（用于前端展示/校验）
         */</span>
        <span class="hljs-keyword">public</span> Map&lt;String, String&gt; <span class="hljs-title function_">listAllModels</span><span class="hljs-params">()</span> {
            Map&lt;String, String&gt; modelList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, OllamaChatModel&gt; entry : chatModelMap.entrySet()) {
                <span class="hljs-type">String</span> <span class="hljs-variable">modelCode</span> <span class="hljs-operator">=</span> entry.getKey();
                <span class="hljs-type">String</span> <span class="hljs-variable">modelName</span> <span class="hljs-operator">=</span> entry.getValue().getDefaultOptions().getModel();
                modelList.put(modelCode, modelName);
            }
            <span class="hljs-keyword">return</span> modelList;
        }
    }
}
</code></pre>
<h4 data-id="heading-7">4. 多模型调用核心业务代码（生产级优化）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PostMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestBody;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.ChatClient;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.messages.ChatMessage;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.prompt.Prompt;
<span class="hljs-keyword">import</span> javax.annotation.Resource;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-comment">/**
 * 多模型问答核心Controller【生产级】
 * 职责：接收问答请求，根据模型编码切换LLM模型，返回回答结果
 */</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/rag")</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RagChatController</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClientConfig.ChatClientFactory chatClientFactory;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> RedisChatContextManager redisChatContextManager;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> AgentThinker agentThinker;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> AgentExecutor agentExecutor;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> AgentSummarizer agentSummarizer;

    <span class="hljs-comment">/**
     * 核心问答接口（支持多模型切换）
     * <span class="hljs-doctag">@param</span> param 问答参数（包含query、sessionId、modelCode）
     */</span>
    <span class="hljs-meta">@PostMapping("/chat")</span>
    <span class="hljs-keyword">public</span> Result&lt;String&gt; <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> AgentChatParam param)</span> {
        <span class="hljs-comment">// 1. 参数校验</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> param.getQuery();
        <span class="hljs-type">String</span> <span class="hljs-variable">sessionId</span> <span class="hljs-operator">=</span> param.getSessionId();
        <span class="hljs-type">String</span> <span class="hljs-variable">modelCode</span> <span class="hljs-operator">=</span> param.getModelCode();
        <span class="hljs-keyword">if</span> (query == <span class="hljs-literal">null</span> || query.isBlank()) {
            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">"提问内容不能为空"</span>);
        }
        <span class="hljs-keyword">if</span> (sessionId == <span class="hljs-literal">null</span> || sessionId.isBlank()) {
            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">"会话ID不能为空"</span>);
        }
        log.info(<span class="hljs-string">"处理问答请求：sessionId={}, query={}, 目标模型={}"</span>, sessionId, query, modelCode);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. Agent思考：决策调用工具/直接回答</span>
            List&lt;ThinkResult&gt; thinkResults = agentThinker.think(query, sessionId);
            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">toolResults</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
            <span class="hljs-keyword">for</span> (ThinkResult thinkResult : thinkResults) {
                <span class="hljs-keyword">if</span> (<span class="hljs-string">"DIRECT_ANSWER"</span>.equals(thinkResult.getAction())) {
                    toolResults.append(thinkResult.getContent());
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// 3. Agent执行：调用工具（如知识库检索）</span>
                    <span class="hljs-type">ToolResult</span> <span class="hljs-variable">toolResult</span> <span class="hljs-operator">=</span> agentExecutor.execute(thinkResult);
                    <span class="hljs-keyword">if</span> (toolResult.isSuccess()) {
                        toolResults.append(toolResult.getContent());
                    } <span class="hljs-keyword">else</span> {
                        log.error(<span class="hljs-string">"工具调用失败：{}"</span>, toolResult.getErrorMsg());
                        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">"处理失败："</span> + toolResult.getErrorMsg());
                    }
                }
            }

            <span class="hljs-comment">// 4. 动态获取ChatClient（根据模型编码切换）</span>
            <span class="hljs-type">ChatClient</span> <span class="hljs-variable">chatClient</span> <span class="hljs-operator">=</span> chatClientFactory.getChatClient(modelCode);
            <span class="hljs-comment">// 5. Agent总结：调用指定模型生成最终回答</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">answer</span> <span class="hljs-operator">=</span> agentSummarizer.summarize(query, toolResults.toString(), sessionId, chatClient);

            <span class="hljs-comment">// 6. 保存会话上下文到Redis</span>
            redisChatContextManager.updateChatContext(sessionId, ChatMessage.user(query));
            redisChatContextManager.updateChatContext(sessionId, ChatMessage.assistant(answer));

            log.info(<span class="hljs-string">"问答请求处理完成：sessionId={}, 模型={}, 回答长度={}"</span>, sessionId, modelCode, answer.length());
            <span class="hljs-keyword">return</span> Result.success(answer);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"问答请求处理失败：sessionId={}"</span>, sessionId, e);
            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">"处理失败："</span> + e.getMessage());
        }
    }

    <span class="hljs-comment">/**
     * 模型列表查询接口（用于前端选择模型）
     */</span>
    <span class="hljs-meta">@PostMapping("/models/list")</span>
    <span class="hljs-keyword">public</span> Result&lt;Map&lt;String, String&gt;&gt; <span class="hljs-title function_">listModels</span><span class="hljs-params">()</span> {
        Map&lt;String, String&gt; modelList = chatClientFactory.listAllModels();
        <span class="hljs-keyword">return</span> Result.success(modelList);
    }
}
</code></pre>
<h4 data-id="heading-8">5. 模型总结器适配多模型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.ai.chat.ChatClient;
<span class="hljs-keyword">import</span> org.springframework.ai.chat.prompt.Prompt;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> javax.annotation.Resource;

<span class="hljs-comment">/**
 * Agent总结器（适配多模型）
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentSummarizer</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> ChatClientConfig.ChatClientFactory chatClientFactory;

    <span class="hljs-comment">/**
     * 生成最终回答（支持指定模型）
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">summarize</span><span class="hljs-params">(String query, String toolResults, String sessionId, ChatClient chatClient)</span> {
        <span class="hljs-comment">// 构建提示词（结合工具结果+上下文）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">promptContent</span> <span class="hljs-operator">=</span> buildSummaryPrompt(query, toolResults, sessionId);
        <span class="hljs-comment">// 调用指定模型生成回答</span>
        <span class="hljs-keyword">return</span> chatClient.prompt(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(prompt))
                .call().chatResponse()
                .getResult()
                .getOutput()
                .getText();
    }

    <span class="hljs-comment">/**
     * 兼容原有方法（使用默认模型）
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">summarize</span><span class="hljs-params">(String query, String toolResults, String sessionId)</span> {
        <span class="hljs-type">ChatClient</span> <span class="hljs-variable">defaultClient</span> <span class="hljs-operator">=</span> chatClientFactory.getDefaultChatClient();
        <span class="hljs-keyword">return</span> summarize(query, toolResults, sessionId, defaultClient);
    }

    <span class="hljs-comment">/**
     * 构建总结提示词
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildSummaryPrompt</span><span class="hljs-params">(String query, String toolResults, String sessionId)</span> {
        <span class="hljs-comment">// 补充上下文、工具结果，构建完整提示词</span>
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"根据以下信息回答问题：\n工具结果：%s\n问题：%s\n要求：回答准确、简洁，符合中文表达习惯"</span>,
                toolResults, query);
    }
}
</code></pre>
<h4 data-id="heading-9">6. 核心参数实体类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> lombok.Data;

<span class="hljs-comment">/**
 * 问答请求参数实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentChatParam</span> {
    <span class="hljs-comment">/** 用户提问内容 */</span>
    <span class="hljs-keyword">private</span> String query;
    <span class="hljs-comment">/** 会话ID（用于上下文管理） */</span>
    <span class="hljs-keyword">private</span> String sessionId;
    <span class="hljs-comment">/** 模型编码（如qwen2-7b/deepseek-r1） */</span>
    <span class="hljs-keyword">private</span> String modelCode;
}
</code></pre>
<h3 data-id="heading-10">四、多模型切换完整链路（RAG集成）</h3>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 前端请求：传入query + sessionId + modelCode（如deepseek-r1）
<span class="hljs-bullet">2.</span> 参数校验：验证必填参数，日志记录请求信息
<span class="hljs-bullet">3.</span> Agent思考：决策调用知识库检索/直接回答
<span class="hljs-bullet">4.</span> 工具执行：调用知识库检索，获取相关文本片段
<span class="hljs-bullet">5.</span> 模型工厂：根据modelCode获取对应的ChatClient
<span class="hljs-bullet">6.</span> 生成回答：调用指定模型，结合工具结果生成回答
<span class="hljs-bullet">7.</span> 上下文保存：将问答记录存入Redis，支撑多轮对话
<span class="hljs-bullet">8.</span> 返回结果：返回回答内容，前端展示
</code></pre>
<h3 data-id="heading-11">五、生产级进阶扩展（可选）</h3>
<h4 data-id="heading-12">扩展1：模型路由策略</h4>
<p>根据提问内容自动选择最优模型（无需前端指定）：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 模型路由策略（示例）
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelRouter</span> {
    <span class="hljs-comment">/**
     * 根据提问内容自动选择模型
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">routeModel</span><span class="hljs-params">(String query)</span> {
        <span class="hljs-comment">// 技术相关问题→deepseek-r1</span>
        <span class="hljs-keyword">if</span> (query.contains(<span class="hljs-string">"代码"</span>) || query.contains(<span class="hljs-string">"技术"</span>) || query.contains(<span class="hljs-string">"接口"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"deepseek-r1"</span>;
        }
        <span class="hljs-comment">// 通用问题→qwen2-7b</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"qwen2-7b"</span>;
    }
}
</code></pre>
<h4 data-id="heading-13">扩展2：模型健康检查</h4>
<p>定时检查模型可用性，异常时自动切换：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 模型健康检查（示例）
 */</span>
<span class="hljs-meta">@Scheduled(fixedRate = 60000)</span> <span class="hljs-comment">// 每分钟检查一次</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkModelHealth</span><span class="hljs-params">()</span> {
    Map&lt;String, OllamaChatModel&gt; modelMap = ollamaChatModelMap();
    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, OllamaChatModel&gt; entry : modelMap.entrySet()) {
        <span class="hljs-type">String</span> <span class="hljs-variable">modelCode</span> <span class="hljs-operator">=</span> entry.getKey();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 发送测试请求，检查模型是否可用</span>
            entry.getValue().call(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(<span class="hljs-string">"hello"</span>)).getResult();
            log.info(<span class="hljs-string">"模型【{}】健康检查通过"</span>, modelCode);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"模型【{}】健康检查失败"</span>, modelCode, e);
            <span class="hljs-comment">// 标记模型不可用，路由时跳过</span>
            unhealthyModels.add(modelCode);
        }
    }
}
</code></pre>
<h4 data-id="heading-14">扩展3：模型调用限流</h4>
<p>针对不同模型设置限流规则，避免资源耗尽：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用Sentinel实现模型级限流</span>
<span class="hljs-meta">@SentinelResource(value = "chat_qwen2_7b", fallback = "defaultFallback")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">chatWithQwen2</span><span class="hljs-params">(String query, String sessionId)</span> {
    <span class="hljs-comment">// 调用qwen2-7b模型的逻辑</span>
}

<span class="hljs-meta">@SentinelResource(value = "chat_deepseek_r1", fallback = "defaultFallback")</span>
<span class="hljs-keyword">public</span> String <span class="hljs-title function_">chatWithDeepseek</span><span class="hljs-params">(String query, String sessionId)</span> {
    <span class="hljs-comment">// 调用deepseek-r1模型的逻辑</span>
}
</code></pre>
<h3 data-id="heading-15">六、关键注意事项（生产落地必看）</h3>
<p><strong>模型资源隔离</strong>：不同模型的推理资源（CPU/GPU）需隔离，避免单个模型占用全部资源；
<strong>上下文兼容</strong>：不同模型的上下文格式/长度限制不同，需适配（如Llama3的上下文长度为8192，Qwen2为4096）；
<strong>参数调优</strong>：每个模型的最优参数不同（如deepseek-r1的temperature=0.5更优），需单独调优；
<strong>监控告警</strong>：监控各模型的调用量、响应时间、失败率，异常时及时告警；
<strong>版本管理</strong>：模型升级时（如qwen2-7b→qwen2-14b），需保留旧模型配置，支持灰度切换。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LCEL：打造可观测、可扩展、可部署的 LangChain 应用]]></title>    <link>https://juejin.cn/post/7592912896591249427</link>    <guid>https://juejin.cn/post/7592912896591249427</guid>    <pubDate>2026-01-09T02:57:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592912896591249427" data-draft-id="7592515924700495907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LCEL：打造可观测、可扩展、可部署的 LangChain 应用"/> <meta itemprop="keywords" content="后端,人工智能,Python"/> <meta itemprop="datePublished" content="2026-01-09T02:57:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星浩AI"/> <meta itemprop="url" content="https://juejin.cn/user/2904236059009760"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LCEL：打造可观测、可扩展、可部署的 LangChain 应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2904236059009760/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星浩AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T02:57:27.000Z" title="Fri Jan 09 2026 02:57:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>LangChain Expression Language（LCEL）是一种声明式语言，可轻松组合不同的调用顺序构成 Chain。LCEL 自创立之初就被设计为能够支持将原型投入生产环境，无需代码更改，从最简单的“提示+LLM”链到最复杂的链（已有用户成功在生产环境中运行包含数百个步骤的 LCEL Chain）。
LCEL 的一些亮点包括：</p>
<ol>
<li><strong>流支持</strong>：使用 LCEL 构建 Chain 时，你可以获得最佳的首个令牌时间（即从输出开始到首批输出生成的时间）。对于某些 Chain，这意味着可以直接从 LLM 流式传输令牌到流输出解析器，从而以与 LLM 提供商输出原始令牌相同的速率获得解析后的、增量的输出。</li>
<li><strong>异步支持</strong>：任何使用 LCEL 构建的链条都可以通过同步 API（例如，在 Jupyter 笔记本中进行原型设计时）和异步 API（例如，在 LangServe 服务器中）调用。这使得相同的代码可用于原型设计和生产环境，具有出色的性能，并能够在同一服务器中处理多个并发请求。</li>
<li><strong>优化的并行执行</strong>：当你的 LCEL 链条有可以并行执行的步骤时（例如，从多个检索器中获取文档），我们会自动执行，无论是在同步还是异步接口中，以实现最小的延迟。</li>
<li><strong>重试和回退</strong>：为 LCEL 链的任何部分配置重试和回退。这是使链在规模上更可靠的绝佳方式。目前我们正在添加重试/回退的流媒体支持，因此你可以在不增加任何延迟成本的情况下获得增加的可靠性。</li>
<li><strong>访问中间结果</strong>：对于更复杂的链条，访问在最终输出产生之前的中间步骤的结果通常非常有用。这可以用于让最终用户知道正在发生一些事情，甚至仅用于调试链条。你可以流式传输中间结果，并且在每个 LangServe 服务器上都可用。</li>
<li><strong>输入和输出模式</strong>：输入和输出模式为每个 LCEL 链提供了从链的结构推断出的 Pydantic 和 JSONSchema 模式。这可以用于输入和输出的验证，是 LangServe 的一个组成部分。</li>
<li><strong>无缝 LangSmith 跟踪集成</strong>：随着链条变得越来越复杂，理解每一步发生了什么变得越来越重要。通过 LCEL，所有步骤都自动记录到 LangSmith，以实现最大的可观察性和可调试性。</li>
<li><strong>无缝 LangServe 部署集成</strong>：任何使用 LCEL 创建的链都可以轻松地使用 LangServe 进行部署。</li>
</ol>
<h3 data-id="heading-0">1 Pipeline 式调用</h3>
<h3 data-id="heading-1">Pipeline 式调用 PromptTemplate, LLM 和 OutputParser</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnablePassthrough
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Optional</span>
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 输出结构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SortEnum</span>(<span class="hljs-built_in">str</span>, Enum):
    data = <span class="hljs-string">'data'</span>
    price = <span class="hljs-string">'price'</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderingEnum</span>(<span class="hljs-built_in">str</span>, Enum):
    ascend = <span class="hljs-string">'ascend'</span>
    descend = <span class="hljs-string">'descend'</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Semantics</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = Field(description=<span class="hljs-string">"流量包名称"</span>, default=<span class="hljs-literal">None</span>)
    price_lower: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = Field(description=<span class="hljs-string">"价格下限"</span>, default=<span class="hljs-literal">None</span>)
    price_upper: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = Field(description=<span class="hljs-string">"价格上限"</span>, default=<span class="hljs-literal">None</span>)
    data_lower: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = Field(description=<span class="hljs-string">"流量下限"</span>, default=<span class="hljs-literal">None</span>)
    data_upper: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = Field(description=<span class="hljs-string">"流量上限"</span>, default=<span class="hljs-literal">None</span>)
    sort_by: <span class="hljs-type">Optional</span>[SortEnum] = Field(description=<span class="hljs-string">"按价格或流量排序"</span>, default=<span class="hljs-literal">None</span>)
    ordering: <span class="hljs-type">Optional</span>[OrderingEnum] = Field(
description=<span class="hljs-string">"升序或降序排列"</span>, default=<span class="hljs-literal">None</span>)
<span class="hljs-comment"># Prompt 模板</span>
prompt = ChatPromptTemplate.from_messages(
    [
        (<span class="hljs-string">"system"</span>, <span class="hljs-string">"你是一个语义解析器。你的任务是将用户的输入解析成JSON表示。不要回答用户的问题。"</span>),
        (<span class="hljs-string">"human"</span>, <span class="hljs-string">"{text}"</span>),
    ]
)
<span class="hljs-comment"># 模型</span>
llm = init_chat_model(<span class="hljs-string">"deepseek-chat"</span>, model_provider=<span class="hljs-string">"deepseek"</span>)
structured_llm = llm.with_structured_output(Semantics)
<span class="hljs-comment"># LCEL 表达式</span>
runnable = (
    {<span class="hljs-string">"text"</span>: RunnablePassthrough()} | prompt | structured_llm
)
<span class="hljs-comment"># 直接运行</span>
ret = runnable.invoke(<span class="hljs-string">"不超过100元的流量大的套餐有哪些"</span>)
<span class="hljs-built_in">print</span>(
    json.dumps(
        ret.model_dump(),
        indent = <span class="hljs-number">4</span>,
        ensure_ascii=<span class="hljs-literal">False</span>
    )
)
</code></pre>
<blockquote>
<p>使用 LCEL 的价值，也就是 LangChain 的核心价值。</p>
</blockquote>
<h3 data-id="heading-2">2 用 LCEL 实现 RAG</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> langchain_text_splitters <span class="hljs-keyword">import</span> RecursiveCharacterTextSplitter
<span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> FAISS
<span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> RetrievalQA
<span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> PyMuPDFLoader
<span class="hljs-keyword">from</span> langchain_community.embeddings.dashscope <span class="hljs-keyword">import</span> DashScopeEmbeddings
<span class="hljs-comment"># 加载文档</span>
loader = PyMuPDFLoader(<span class="hljs-string">"./data/deepseek-v3-1-4.pdf"</span>)
pages = loader.load_and_split()
<span class="hljs-comment"># 文档切分</span>
text_splitter = RecursiveCharacterTextSplitter(
    chunk_size=<span class="hljs-number">512</span>,
    chunk_overlap=<span class="hljs-number">200</span>,
    length_function=<span class="hljs-built_in">len</span>,
    add_start_index=<span class="hljs-literal">True</span>,
)
texts = text_splitter.create_documents(
    [page.page_content <span class="hljs-keyword">for</span> page <span class="hljs-keyword">in</span> pages[:<span class="hljs-number">1</span>]]
)
<span class="hljs-comment"># 灌库</span>
embeddings = DashScopeEmbeddings(
    model=<span class="hljs-string">"text-embedding-v1"</span>, dashscope_api_key=os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>)
)
db = FAISS.from_documents(texts, embeddings)
<span class="hljs-comment"># 检索 top-5 结果</span>
retriever = db.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">5</span>})
</code></pre>
<pre><code class="hljs language-python" lang="python">docs = retriever.invoke(<span class="hljs-string">"deepseek v3有多少参数"</span>)
<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
    <span class="hljs-built_in">print</span>(doc.page_content)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"----"</span>)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.schema.output_parser <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain.schema.runnable <span class="hljs-keyword">import</span> RunnablePassthrough
<span class="hljs-comment"># Prompt模板</span>
template = <span class="hljs-string">"""Answer the question based only on the following context:
{context}
Question: {question}
"""</span>
prompt = ChatPromptTemplate.from_template(template)
<span class="hljs-comment"># Chain</span>
rag_chain = (
    {<span class="hljs-string">"question"</span>: RunnablePassthrough(), <span class="hljs-string">"context"</span>: retriever}
    | prompt
    | llm
    | StrOutputParser()
)
rag_chain.invoke(<span class="hljs-string">"deepseek V3有多少参数"</span>)
</code></pre>
<p>'DeepSeek-V3 是一个混合专家（Mixture-of-Experts, MoE）语言模型，总参数量为<strong>6710亿（671B）</strong>，其中每个 token 激活**370亿（37B）**参数。'</p>
<h3 data-id="heading-3">3 用 LCEL 实现模型切换（工厂模式）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.runnables.utils <span class="hljs-keyword">import</span> ConfigurableField
<span class="hljs-keyword">from</span> langchain_community.chat_models <span class="hljs-keyword">import</span> QianfanChatEndpoint
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> (
    ChatPromptTemplate,
    HumanMessagePromptTemplate,
)
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> HumanMessage
<span class="hljs-keyword">import</span> os
<span class="hljs-comment"># 模型1</span>
ds_model = init_chat_model(<span class="hljs-string">"deepseek-chat"</span>, model_provider=<span class="hljs-string">"deepseek"</span>)
<span class="hljs-comment"># 模型2</span>
gpt_model = init_chat_model(<span class="hljs-string">"gpt-4o-mini"</span>, model_provider=<span class="hljs-string">"openai"</span>)
<span class="hljs-comment"># 通过 configurable_alternatives 按指定字段选择模型</span>
model = gpt_model.configurable_alternatives(
    ConfigurableField(<span class="hljs-built_in">id</span>=<span class="hljs-string">"llm"</span>), 
    default_key=<span class="hljs-string">"gpt"</span>, 
    deepseek=ds_model,
    <span class="hljs-comment"># claude=claude_model,</span>
)
<span class="hljs-comment"># Prompt 模板</span>
prompt = ChatPromptTemplate.from_messages(
    [
        HumanMessagePromptTemplate.from_template(<span class="hljs-string">"{query}"</span>),
    ]
)
<span class="hljs-comment"># LCEL</span>
chain = (
    {<span class="hljs-string">"query"</span>: RunnablePassthrough()} 
    | prompt
    | model 
    | StrOutputParser()
)
<span class="hljs-comment"># 运行时指定模型 "gpt" or "deepseek"</span>
ret = chain.with_config(configurable={<span class="hljs-string">"llm"</span>: <span class="hljs-string">"deepseek"</span>}).invoke(<span class="hljs-string">"请自我介绍"</span>)
<span class="hljs-built_in">print</span>(ret)

</code></pre>
<blockquote>
<p>思考：从模块间解依赖角度，LCEL 的意义是什么？</p>
</blockquote>
<h3 data-id="heading-4">4 配置运行时变量</h3>
<p>在实际应用中，我们经常需要在运行时动态配置链的参数，而不是在定义时就固定下来。LCEL 提供了<code>with_config()</code>方法来实现运行时配置。</p>
<p>**场景示例：**根据不同的用户角色，使用不同的 temperature 参数，或者根据业务需求动态调整模型的 max_tokens。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnablePassthrough
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-comment"># 创建基础链</span>
prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"请用{tone}的语气回答：{question}"</span>)
llm = init_chat_model(<span class="hljs-string">"qwen-plus"</span>, model_provider=<span class="hljs-string">"dashscope"</span>)
chain = prompt | llm | StrOutputParser()
<span class="hljs-comment"># 方式1：使用 with_config 配置运行时变量</span>
result1 = chain.with_config(
    configurable={<span class="hljs-string">"tone"</span>: <span class="hljs-string">"专业"</span>}
).invoke({<span class="hljs-string">"question"</span>: <span class="hljs-string">"什么是人工智能？"</span>})
<span class="hljs-built_in">print</span>(result1)
<span class="hljs-comment"># 方式2：在 invoke 时传入 config</span>
result2 = chain.invoke(
    {<span class="hljs-string">"question"</span>: <span class="hljs-string">"什么是人工智能？"</span>},
    config={<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"tone"</span>: <span class="hljs-string">"轻松幽默"</span>}}
)
<span class="hljs-built_in">print</span>(result2)

</code></pre>
<p><strong>更高级的用法：配置模型参数</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableConfig
<span class="hljs-comment"># 创建可配置的模型</span>
llm = init_chat_model(<span class="hljs-string">"qwen-plus"</span>, model_provider=<span class="hljs-string">"dashscope"</span>)
<span class="hljs-comment"># 在运行时配置模型参数</span>
configurable_llm = llm.with_config(
    configurable={
        <span class="hljs-string">"temperature"</span>: <span class="hljs-number">0.7</span>,
        <span class="hljs-string">"max_tokens"</span>: <span class="hljs-number">1000</span>
    }
)
prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"回答：{question}"</span>)
chain = prompt | configurable_llm | StrOutputParser()
result = chain.invoke({<span class="hljs-string">"question"</span>: <span class="hljs-string">"解释一下机器学习"</span>})
</code></pre>
<blockquote>
<p>提示：运行时配置的优势在于，同一个链可以在不同场景下复用，只需在调用时传入不同的配置即可，无需创建多个链实例。</p>
</blockquote>
<h3 data-id="heading-5">5 故障回退</h3>
<p>在生产环境中，LLM API 调用可能会因为网络问题、服务限流、模型错误等原因失败。为了提高系统的健壮性，LCEL 提供了<code>with_fallbacks()</code>方法来设置故障回退机制。</p>
<p>**场景示例：**当主模型（如 qwen-plus）调用失败时，自动切换到备用模型（如 qwen-turbo）。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableLambda
<span class="hljs-comment"># 主模型</span>
primary_llm = init_chat_model(<span class="hljs-string">"qwen-plus"</span>, model_provider=<span class="hljs-string">"dashscope"</span>)
<span class="hljs-comment"># 备用模型（通常选择更便宜或更稳定的模型）</span>
fallback_llm = init_chat_model(<span class="hljs-string">"qwen-turbo"</span>, model_provider=<span class="hljs-string">"dashscope"</span>)
<span class="hljs-comment"># 创建带故障回退的链</span>
prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"回答：{question}"</span>)
<span class="hljs-comment"># 方式1：为整个链设置回退</span>
chain_with_fallback = (
    prompt 
    | primary_llm.with_fallbacks([fallback_llm])
    | StrOutputParser()
)
result = chain_with_fallback.invoke({<span class="hljs-string">"question"</span>: <span class="hljs-string">"什么是深度学习？"</span>})
<span class="hljs-built_in">print</span>(result)
</code></pre>
<p><strong>多级回退策略</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 可以设置多个回退，按顺序尝试</span>
backup_llm1 = init_chat_model(<span class="hljs-string">"qwen-turbo"</span>, model_provider=<span class="hljs-string">"dashscope"</span>)
backup_llm2 = init_chat_model(<span class="hljs-string">"deepseek-chat"</span>, model_provider=<span class="hljs-string">"deepseek"</span>)
<span class="hljs-comment"># 自定义回退处理函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">custom_fallback</span>(<span class="hljs-params">input_data</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-string">"抱歉，当前服务暂时不可用，请稍后重试。"</span>
robust_chain = (
    prompt 
    | primary_llm.with_fallbacks([
        backup_llm1, 
        backup_llm2,
        RunnableLambda(custom_fallback)
    ])
    | StrOutputParser()
)
</code></pre>
<p><strong>针对特定异常的回退</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableLambda
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_rate_limit_error</span>(<span class="hljs-params">input_data</span>):
    <span class="hljs-string">"""处理限流错误"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"当前请求过于频繁，请稍后再试。"</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_timeout_error</span>(<span class="hljs-params">input_data</span>):
    <span class="hljs-string">"""处理超时错误"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"请求超时，请检查网络连接。"</span>
<span class="hljs-comment"># 可以根据不同异常类型设置不同的回退策略</span>
chain = prompt | primary_llm.with_fallbacks([
    (fallback_llm, <span class="hljs-keyword">lambda</span> e: <span class="hljs-built_in">isinstance</span>(e, Exception))
]) | StrOutputParser()

</code></pre>
<blockquote>
<p>最佳实践：在生产环境中，建议至少设置一个备用模型，并记录失败日志，以便后续分析和优化。</p>
</blockquote>
<h3 data-id="heading-6">6 并行调用</h3>
<p>当链中有多个可以独立执行的任务时，并行执行可以显著提高效率。LCEL 的<code>RunnableParallel</code>允许同时执行多个子链。</p>
<p>**场景示例：**同时从多个数据源检索信息，或者同时执行多个独立的分析任务。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableParallel, RunnablePassthrough
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
llm = init_chat_model(<span class="hljs-string">"qwen-plus"</span>, model_provider=<span class="hljs-string">"dashscope"</span>)
<span class="hljs-comment"># 定义多个独立的处理任务</span>
summarize_prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"总结以下内容：{text}"</span>)
translate_prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"将以下内容翻译成英文：{text}"</span>)
analyze_prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"分析以下内容的情感倾向：{text}"</span>)
<span class="hljs-comment"># 创建并行执行的链</span>
parallel_chain = RunnableParallel({
    <span class="hljs-string">"summary"</span>: (
        {<span class="hljs-string">"text"</span>: RunnablePassthrough()} 
        | summarize_prompt 
        | llm 
        | StrOutputParser()
    ),
    <span class="hljs-string">"translation"</span>: (
        {<span class="hljs-string">"text"</span>: RunnablePassthrough()} 
        | translate_prompt 
        | llm 
        | StrOutputParser()
    ),
    <span class="hljs-string">"sentiment"</span>: (
        {<span class="hljs-string">"text"</span>: RunnablePassthrough()} 
        | analyze_prompt 
        | llm 
        | StrOutputParser()
    )
})
<span class="hljs-comment"># 执行并行任务</span>
text = <span class="hljs-string">"今天天气真好，适合出去散步。"</span>
results = parallel_chain.invoke(text)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"总结：<span class="hljs-subst">{results[<span class="hljs-string">'summary'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"翻译：<span class="hljs-subst">{results[<span class="hljs-string">'translation'</span>]}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"情感：<span class="hljs-subst">{results[<span class="hljs-string">'sentiment'</span>]}</span>"</span>)

</code></pre>
<p><strong>结合 RAG 的并行检索</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_community.vectorstores <span class="hljs-keyword">import</span> FAISS
<span class="hljs-keyword">from</span> langchain_community.embeddings.dashscope <span class="hljs-keyword">import</span> DashScopeEmbeddings
<span class="hljs-keyword">import</span> os
<span class="hljs-comment"># 假设有多个知识库</span>
embeddings = DashScopeEmbeddings(
    model=<span class="hljs-string">"text-embedding-v1"</span>,
    dashscope_api_key=os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>)
)
<span class="hljs-comment"># 创建多个检索器（实际应用中可能是不同的知识库）</span>
retriever1 = db1.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>})
retriever2 = db2.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>})
retriever3 = db3.as_retriever(search_kwargs={<span class="hljs-string">"k"</span>: <span class="hljs-number">3</span>})
<span class="hljs-comment"># 并行检索多个知识库</span>
parallel_retrieval = RunnableParallel({
    <span class="hljs-string">"tech_docs"</span>: retriever1,
    <span class="hljs-string">"product_docs"</span>: retriever2,
    <span class="hljs-string">"faq_docs"</span>: retriever3
})
<span class="hljs-comment"># 同时从三个知识库检索</span>
docs = parallel_retrieval.invoke(<span class="hljs-string">"如何使用API？"</span>)
<span class="hljs-comment"># 合并检索结果</span>
all_docs = docs[<span class="hljs-string">"tech_docs"</span>] + docs[<span class="hljs-string">"product_docs"</span>] + docs[<span class="hljs-string">"faq_docs"</span>]
</code></pre>
<blockquote>
<p>性能提升：并行调用可以将多个串行任务的总耗时从 (O(n)) 降低到 (O(1))，在需要处理多个独立任务时效果显著。</p>
</blockquote>
<h3 data-id="heading-7">7 逻辑分支</h3>
<p>在实际应用中，我们经常需要根据输入或中间结果动态选择执行路径。LCEL 支持通过<code>RunnableLambda</code>和条件判断实现逻辑分支。</p>
<p>**场景示例：**根据用户问题的复杂度，选择不同的处理策略；或者根据检索结果的质量，决定是否需要进一步处理。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableLambda, RunnablePassthrough
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
llm_simple = init_chat_model(<span class="hljs-string">"qwen-turbo"</span>, model_provider=<span class="hljs-string">"dashscope"</span>)
llm_complex = init_chat_model(<span class="hljs-string">"qwen-plus"</span>, model_provider=<span class="hljs-string">"dashscope"</span>)
<span class="hljs-comment"># 定义不同复杂度的处理链</span>
simple_prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"简单回答：{question}"</span>)
complex_prompt = ChatPromptTemplate.from_template(
    <span class="hljs-string">"详细分析并回答：{question}，请提供多个角度的见解。"</span>
)
simple_chain = simple_prompt | llm_simple | StrOutputParser()
complex_chain = complex_prompt | llm_complex | StrOutputParser()
<span class="hljs-comment"># 判断问题复杂度的函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">route_by_complexity</span>(<span class="hljs-params">input_data</span>):
    question = input_data[<span class="hljs-string">"question"</span>]
    <span class="hljs-comment"># 简单的复杂度判断逻辑（实际应用中可以使用更复杂的判断）</span>
    complex_keywords = [<span class="hljs-string">"分析"</span>, <span class="hljs-string">"对比"</span>, <span class="hljs-string">"详细"</span>, <span class="hljs-string">"原理"</span>, <span class="hljs-string">"机制"</span>]
    is_complex = <span class="hljs-built_in">any</span>(keyword <span class="hljs-keyword">in</span> question <span class="hljs-keyword">for</span> keyword <span class="hljs-keyword">in</span> complex_keywords)
    <span class="hljs-keyword">if</span> is_complex:
        <span class="hljs-keyword">return</span> complex_chain.invoke(input_data)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> simple_chain.invoke(input_data)
<span class="hljs-comment"># 创建路由链</span>
routing_chain = RunnableLambda(route_by_complexity)
<span class="hljs-comment"># 测试</span>
result1 = routing_chain.invoke({<span class="hljs-string">"question"</span>: <span class="hljs-string">"今天天气怎么样？"</span>})
result2 = routing_chain.invoke({<span class="hljs-string">"question"</span>: <span class="hljs-string">"请详细分析深度学习和机器学习的区别"</span>})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"简单问题：<span class="hljs-subst">{result1}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"复杂问题：<span class="hljs-subst">{result2}</span>"</span>)

</code></pre>
<p><strong>基于 LLM 的智能路由</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel, Field
<span class="hljs-keyword">from</span> enum <span class="hljs-keyword">import</span> Enum
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RouteType</span>(<span class="hljs-built_in">str</span>, Enum):
    SIMPLE = <span class="hljs-string">"simple"</span>
    COMPLEX = <span class="hljs-string">"complex"</span>
    TECHNICAL = <span class="hljs-string">"technical"</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RouteDecision</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    route: RouteType = Field(description=<span class="hljs-string">"路由类型"</span>)
<span class="hljs-comment"># 使用 LLM 判断路由</span>
router_llm = llm_simple.with_structured_output(RouteDecision)
router_prompt = ChatPromptTemplate.from_template(
    <span class="hljs-string">"判断以下问题应该使用哪种处理方式（simple/complex/technical）：{question}"</span>
)
router_chain = router_prompt | router_llm
<span class="hljs-comment"># 定义不同路由的处理链</span>
chains = {
    RouteType.SIMPLE: simple_chain,
    RouteType.COMPLEX: complex_chain,
    RouteType.TECHNICAL: (
        ChatPromptTemplate.from_template(<span class="hljs-string">"从技术角度详细解答：{question}"</span>)
        | llm_complex
        | StrOutputParser()
    )
}
<span class="hljs-keyword">def</span> <span class="hljs-title function_">smart_route</span>(<span class="hljs-params">input_data</span>):
    <span class="hljs-comment"># 先判断路由</span>
    decision = router_chain.invoke(input_data)
    <span class="hljs-comment"># 根据路由选择链</span>
    selected_chain = chains[decision.route]
    <span class="hljs-comment"># 执行选中的链</span>
    <span class="hljs-keyword">return</span> selected_chain.invoke(input_data)
smart_routing_chain = RunnableLambda(smart_route)

</code></pre>
<p><strong>基于检索结果质量的路由</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 如果检索到的文档相关性高，直接使用 RAG；否则使用通用模型</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">route_by_retrieval_quality</span>(<span class="hljs-params">input_data</span>):
    question = input_data[<span class="hljs-string">"question"</span>]
    docs = retriever.invoke(question)
    <span class="hljs-comment"># 简单的相关性判断（实际可以使用更复杂的评分机制）</span>
    <span class="hljs-keyword">if</span> docs <span class="hljs-keyword">and</span> <span class="hljs-built_in">len</span>(docs) &gt;= <span class="hljs-number">3</span>:
        <span class="hljs-comment"># 使用 RAG 链</span>
        <span class="hljs-keyword">return</span> rag_chain.invoke(question)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 使用通用模型</span>
        <span class="hljs-keyword">return</span> general_chain.invoke({<span class="hljs-string">"question"</span>: question})
retrieval_routing_chain = RunnableLambda(route_by_retrieval_quality)

</code></pre>
<blockquote>
<p>设计模式：逻辑分支让链具备了“智能决策”能力，可以根据上下文动态调整处理策略，这是构建复杂 AI 应用的关键技术。</p>
</blockquote>
<h3 data-id="heading-8">8 动态创建 Chain</h3>
<p>在某些场景下，我们需要根据运行时信息动态构建链的结构。LCEL 支持在运行时创建和组合链组件。</p>
<p>**场景示例：**根据用户选择的工具动态构建处理链，或者根据配置动态组合不同的处理步骤。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.runnables <span class="hljs-keyword">import</span> RunnableLambda, RunnablePassthrough
<span class="hljs-keyword">from</span> langchain.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain_core.output_parsers <span class="hljs-keyword">import</span> StrOutputParser
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
llm = init_chat_model(<span class="hljs-string">"qwen-plus"</span>, model_provider=<span class="hljs-string">"dashscope"</span>)
<span class="hljs-comment"># 定义可用的处理步骤</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_summarize_step</span>():
    prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"总结：{text}"</span>)
    <span class="hljs-keyword">return</span> prompt | llm | StrOutputParser()
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_translate_step</span>(<span class="hljs-params">target_lang=<span class="hljs-string">"英文"</span></span>):
    prompt = ChatPromptTemplate.from_template(<span class="hljs-string">f"翻译成<span class="hljs-subst">{target_lang}</span>：{{text}}"</span>)
    <span class="hljs-keyword">return</span> prompt | llm | StrOutputParser()
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_analyze_step</span>():
    prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"分析：{text}"</span>)
    <span class="hljs-keyword">return</span> prompt | llm | StrOutputParser()
<span class="hljs-comment"># 动态创建链的函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_dynamic_chain</span>(<span class="hljs-params">steps: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], config: <span class="hljs-built_in">dict</span> = <span class="hljs-literal">None</span></span>):
    <span class="hljs-string">"""
    根据步骤列表动态创建链
    steps: 步骤列表，如 ["summarize", "translate", "analyze"]
    """</span>
    step_functions = {
        <span class="hljs-string">"summarize"</span>: create_summarize_step,
        <span class="hljs-string">"translate"</span>: <span class="hljs-keyword">lambda</span>: create_translate_step(
            config.get(<span class="hljs-string">"target_lang"</span>, <span class="hljs-string">"英文"</span>) <span class="hljs-keyword">if</span> config <span class="hljs-keyword">else</span> <span class="hljs-string">"英文"</span>
        ),
        <span class="hljs-string">"analyze"</span>: create_analyze_step
    }
    <span class="hljs-comment"># 动态组合链</span>
    chain = RunnablePassthrough()
    <span class="hljs-keyword">for</span> step_name <span class="hljs-keyword">in</span> steps:
        step_chain = step_functions[step_name]()
        <span class="hljs-comment"># 将前一步的输出作为下一步的输入</span>
        chain = chain | step_chain
    <span class="hljs-keyword">return</span> chain
<span class="hljs-comment"># 使用示例</span>
dynamic_chain = create_dynamic_chain(
    steps=[<span class="hljs-string">"summarize"</span>, <span class="hljs-string">"translate"</span>, <span class="hljs-string">"analyze"</span>],
    config={<span class="hljs-string">"target_lang"</span>: <span class="hljs-string">"英文"</span>}
)
result = dynamic_chain.invoke(<span class="hljs-string">"今天是一个重要的日子，我们完成了项目的关键里程碑。"</span>)
<span class="hljs-built_in">print</span>(result)

</code></pre>
<p><strong>基于配置文件的动态链构建</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json
<span class="hljs-comment"># 配置文件示例</span>
chain_config = {
    <span class="hljs-string">"steps"</span>: [
        {<span class="hljs-string">"type"</span>: <span class="hljs-string">"summarize"</span>, <span class="hljs-string">"enabled"</span>: <span class="hljs-literal">True</span>},
        {<span class="hljs-string">"type"</span>: <span class="hljs-string">"translate"</span>, <span class="hljs-string">"enabled"</span>: <span class="hljs-literal">True</span>, <span class="hljs-string">"target_lang"</span>: <span class="hljs-string">"英文"</span>},
        {<span class="hljs-string">"type"</span>: <span class="hljs-string">"analyze"</span>, <span class="hljs-string">"enabled"</span>: <span class="hljs-literal">False</span>}
    ],
    <span class="hljs-string">"model"</span>: <span class="hljs-string">"qwen-plus"</span>
}
<span class="hljs-keyword">def</span> <span class="hljs-title function_">build_chain_from_config</span>(<span class="hljs-params">config: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""根据配置文件构建链"""</span>
    llm = init_chat_model(config[<span class="hljs-string">"model"</span>], model_provider=<span class="hljs-string">"dashscope"</span>)
    chain = RunnablePassthrough()
    <span class="hljs-keyword">for</span> step_config <span class="hljs-keyword">in</span> config[<span class="hljs-string">"steps"</span>]:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> step_config.get(<span class="hljs-string">"enabled"</span>, <span class="hljs-literal">True</span>):
            <span class="hljs-keyword">continue</span>
        step_type = step_config[<span class="hljs-string">"type"</span>]
        <span class="hljs-keyword">if</span> step_type == <span class="hljs-string">"summarize"</span>:
            prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"总结：{text}"</span>)
            step_chain = prompt | llm | StrOutputParser()
        <span class="hljs-keyword">elif</span> step_type == <span class="hljs-string">"translate"</span>:
            target_lang = step_config.get(<span class="hljs-string">"target_lang"</span>, <span class="hljs-string">"英文"</span>)
            prompt = ChatPromptTemplate.from_template(<span class="hljs-string">f"翻译成<span class="hljs-subst">{target_lang}</span>：{{text}}"</span>)
            step_chain = prompt | llm | StrOutputParser()
        <span class="hljs-keyword">elif</span> step_type == <span class="hljs-string">"analyze"</span>:
            prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"分析：{text}"</span>)
            step_chain = prompt | llm | StrOutputParser()
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">continue</span>
        chain = chain | step_chain
    <span class="hljs-keyword">return</span> chain
<span class="hljs-comment"># 根据配置构建链</span>
configured_chain = build_chain_from_config(chain_config)
result = configured_chain.invoke(<span class="hljs-string">"这是一个测试文本"</span>)

</code></pre>
<p><strong>条件式动态链构建</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">create_conditional_chain</span>(<span class="hljs-params">input_data: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""根据输入数据动态决定链的结构"""</span>
    text = input_data.get(<span class="hljs-string">"text"</span>, <span class="hljs-string">""</span>)
    task_type = input_data.get(<span class="hljs-string">"task_type"</span>, <span class="hljs-string">"general"</span>)
    llm = init_chat_model(<span class="hljs-string">"qwen-plus"</span>, model_provider=<span class="hljs-string">"dashscope"</span>)
    <span class="hljs-keyword">if</span> task_type == <span class="hljs-string">"qa"</span>:
        <span class="hljs-comment"># 问答任务：检索 + 生成</span>
        prompt = ChatPromptTemplate.from_template(
            <span class="hljs-string">"基于以下上下文回答问题：\n{context}\n\n问题：{question}"</span>
        )
        chain = (
            {<span class="hljs-string">"context"</span>: retriever, <span class="hljs-string">"question"</span>: RunnablePassthrough()}
            | prompt
            | llm
            | StrOutputParser()
        )
    <span class="hljs-keyword">elif</span> task_type == <span class="hljs-string">"summarize"</span>:
        <span class="hljs-comment"># 摘要任务</span>
        prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"总结：{text}"</span>)
        chain = prompt | llm | StrOutputParser()
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 通用任务</span>
        prompt = ChatPromptTemplate.from_template(<span class="hljs-string">"处理：{text}"</span>)
        chain = prompt | llm | StrOutputParser()
    <span class="hljs-keyword">return</span> chain
<span class="hljs-comment"># 使用</span>
qa_chain = create_conditional_chain({<span class="hljs-string">"task_type"</span>: <span class="hljs-string">"qa"</span>})
summary_chain = create_conditional_chain({<span class="hljs-string">"task_type"</span>: <span class="hljs-string">"summarize"</span>})
</code></pre>
<blockquote>
<p>灵活性：动态创建链让应用具备了高度的灵活性，可以根据用户需求、业务规则或运行时条件构建最适合的处理流程，这是构建可配置 AI 系统的关键能力。</p>
</blockquote>
<h3 data-id="heading-9">总结</h3>
<p>通过以上章节，我们了解了 LCEL 的核心能力：</p>
<ul>
<li><strong>1：Pipeline 式调用 PromptTemplate、LLM 和 OutputParser</strong></li>
<li><strong>2：用 LCEL 实现 RAG</strong></li>
<li><strong>3：用 LCEL 实现模型切换（工厂模式）</strong></li>
<li><strong>4：运行时配置，让链具备动态参数能力</strong></li>
<li><strong>5：故障回退，提高系统健壮性</strong></li>
<li><strong>6：并行调用，提升处理效率</strong></li>
<li><strong>7：逻辑分支，实现智能路由</strong></li>
<li><strong>8：动态创建，构建灵活系统</strong></li>
</ul>
<p>这些能力组合使用，可以构建出既强大又灵活的 AI 应用系统。</p>
<h2 data-id="heading-10">🎉END</h2>
<p>如果你觉得本文有帮助，欢迎点赞👍、在看👀、转发📤，也欢迎留言💬分享你的经验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[maven的多仓库配置理解]]></title>    <link>https://juejin.cn/post/7592873628586213376</link>    <guid>https://juejin.cn/post/7592873628586213376</guid>    <pubDate>2026-01-09T02:59:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592873628586213376" data-draft-id="7592846242176122914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="maven的多仓库配置理解"/> <meta itemprop="keywords" content="Java,架构"/> <meta itemprop="datePublished" content="2026-01-09T02:59:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="优雅的38度"/> <meta itemprop="url" content="https://juejin.cn/user/3030682435332360"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            maven的多仓库配置理解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3030682435332360/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    优雅的38度
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T02:59:10.000Z" title="Fri Jan 09 2026 02:59:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在工作中，拉取一个jar包，不确定最初在maven的setting.xml配置的镜像配置能否拉取到，根据AI搜索资料得到一些启发。</p>
<h4 data-id="heading-0"><strong>场景：</strong></h4>
<p>我在我的maven setting.xml配置了阿里云的镜像，这是我们国内开发大多数的必要配置，原因是通过阿里云的拉取，可以加快拉取速度：</p>
<pre><code class="hljs language-xml" lang="xml">	<span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span>
  		<span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>nexus-aliyun<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
  		<span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span>
  		<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Nexus aliyun<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  		<span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://maven.aliyun.com/repository/central<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
	 <span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span>  
</code></pre>
<p>在我项目的pom.xml需要拉取一些jar，发现拉取过程中提示拉取不到jar包，于是，我根据搜索到的资料再pom.xml加了仓库配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central-ma<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo1.maven.org/maven2/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>eclipse-releases<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.eclipse.org/content/repositories/releases/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span>
</code></pre>
<p>然后maven的setting.xml配置改成：</p>
<pre><code class="hljs language-xml" lang="xml">	<span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span>
  		<span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>nexus-aliyun<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
  		<span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>central,!central-ma<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span>
  		<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Nexus aliyun<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  		<span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://maven.aliyun.com/repository/central<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
	 <span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span>  
</code></pre>
<p>这样一修改，理解上有所改变，接下来，对新配置点理解进行分析</p>
<pre><code class="hljs language-xml" lang="xml">	<span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span>
  		<span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>nexus-aliyun<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
  		<span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>central,!central-ma<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span>
  		<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Nexus aliyun<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  		<span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://maven.aliyun.com/repository/central<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
	 <span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span>  
</code></pre>
<p>-<code> mirror</code> 定义了一个镜像（mirror），Maven 会把对某些仓库的请求重定向到你指定的镜像地址，从而加速下载（尤其是国内访问官方中央仓库很慢的情况下）。</p>
<ul>
<li><code>&lt;id&gt;nexus-aliyun&lt;/id&gt;</code>：这个镜像的唯一标识符，建议唯一，通常和仓库的 id 相关联。</li>
<li><code>&lt;url&gt;https://maven.aliyun.com/repository/central&lt;/url&gt;</code>：真正的镜像地址，所有被镜像的请求都会重定向到这里。这是阿里云提供的 Maven 中央仓库公共镜像，速度很快。</li>
<li><code>&lt;mirrorOf&gt;central,!central-ma&lt;/mirrorOf&gt;</code>：这是最关键的部分，表示这个镜像代理哪些仓库。拆解一下：central：指的是 Maven 默认的中央仓库，其 id 在 super pom 中定义为 "central"，地址是<a href="https://link.juejin.cn?target=https%3A%2F%2Frepo.maven.apache.org%2Fmaven2%25E3%2580%2582" target="_blank" title="https://repo.maven.apache.org/maven2%E3%80%82" ref="nofollow noopener noreferrer">repo.maven.apache.org/maven2。</a></li>
<li><code>!central-ma</code>：这里的 ! 表示排除（取反）。所以整体意思是：镜像所有 id 为 "central" 的仓库请求，把它们重定向到阿里云镜像。但排除 id 为 "central-ma" 的仓库，这个仓库的请求不会走阿里云镜像，而是走它自己原本配置的地址。</li>
</ul>
<h4 data-id="heading-1"><strong>引申：</strong></h4>
<p>我们要明白的是，maven所有的项目都隐式继承Super POM,这是maven内置的默认配置，
在Super POM,中默认定义了一个仓库：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Central Repository<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.maven.apache.org/maven2<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
</code></pre>
<p>这是Maven Central Repository（Maven 中央仓库），全球最大的公共开源 jar 包仓库。
所以这里的central就关联上上面setting.xml mirrof的central。</p>
<p>当你的 <strong>pom.xml</strong> 中只声明  而<strong>没有额外配置 </strong> 时，Maven 会：</p>
<ol>
<li>先检查本地仓库（~/.m2/repository）。</li>
<li>如果本地没有，就去默认的 "central" 仓库下载。</li>
</ol>
<p>具体在实际运用中，pom.xml的repositories根据使用者自由配置，可以是公司内网仓库，可以使其他仓库，我在这里是以maven的 <a href="https://link.juejin.cn?target=https%3A%2F%2Frepo1.maven.org%2Fmaven2" target="_blank" title="https://repo1.maven.org/maven2" ref="nofollow noopener noreferrer">repo1.maven.org/maven2</a> 来配置repository举例。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎙️ React Native（RN）语音输入场景全解析]]></title>    <link>https://juejin.cn/post/7592906873089245230</link>    <guid>https://juejin.cn/post/7592906873089245230</guid>    <pubDate>2026-01-09T03:01:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592906873089245230" data-draft-id="7592865044692189190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎙️ React Native（RN）语音输入场景全解析"/> <meta itemprop="keywords" content="React Native,Android,AIGC"/> <meta itemprop="datePublished" content="2026-01-09T03:01:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎙️ React Native（RN）语音输入场景全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T03:01:43.000Z" title="Fri Jan 09 2026 03:01:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🌱 一、从电磁波到 JavaScript 回调的奇幻旅程</h2>
<p>在 RN 中实现“语音输入”，就像一个接力赛：<br/>
1️⃣ 用户说话（空气振动产生声波）<br/>
2️⃣ 操作系统底层（iOS/Android）通过 <strong>麦克风硬件</strong> → 模数转换成数字信号<br/>
3️⃣ 语音输入 SDK（Google Speech、科大讯飞、Azure Speech SDK 等）负责：</p>
<ul>
<li>把音频流实时转成文本</li>
<li>或返回语义理解结果<br/>
4️⃣ RN 桥接层（Bridge）将结果传到 JavaScript<br/>
5️⃣ JavaScript 更新 UI、调用业务逻辑、甚至可以让 AI 再来点“脑补”解释</li>
</ul>
<p>一句“你好”，其实跨过了：</p>
<blockquote>
<p>空气 → 麦克风 → 声音芯片 → JNI 或 NativeModule → JS线程</p>
</blockquote>
<p>听起来有点像“声波版的信息时空穿越”。🌌</p>
<hr/>
<h2 data-id="heading-1">⚙️ 二、底层结构拆解图（文字版脑补）</h2>
<pre><code class="hljs language-scss" lang="scss">用户语音 
   ↓
麦克风硬件驱动
   ↓
操作系统音频层（AudioRecord / AVAudioEngine）
   ↓
Native SDK (Speech-to-Text)
   ↓
RN Bridge (Native Module)
   ↓
JavaScript 回调 (onSpeechResult)
   ↓
React Component 更新显示
</code></pre>
<p>这整条链路的关键在于：</p>
<blockquote>
<p>Native 模块与 JS 的通信必须保证 <strong>实时性和线程安全</strong>。</p>
</blockquote>
<p>否则，你可能出现这样的体验：</p>
<blockquote>
<p>用户说“打开灯”，系统却在半秒后回答：“请稍后，我正在想”。 😂</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">🧩 三、基础代码结构演示</h2>
<p>我们以一个最小可运行的伪代码示例（假设使用语音识别库）👇</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Button</span>, <span class="hljs-title class_">Text</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-native"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Voice</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"@react-native-voice/voice"</span>; <span class="hljs-comment">// 🎤 假设我们使用 react-native-voice 包</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">VoiceInputDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">"点击开始说话..."</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">startListening</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title class_">Voice</span>.<span class="hljs-title function_">start</span>(<span class="hljs-string">"zh-CN"</span>);
      <span class="hljs-title function_">setText</span>(<span class="hljs-string">"正在聆听中... 🎧"</span>);
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-title function_">setText</span>(<span class="hljs-string">`启动失败：<span class="hljs-subst">${err.message}</span>`</span>);
    }
  };

  <span class="hljs-title class_">Voice</span>.<span class="hljs-property">onSpeechResults</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">value</span> &amp;&amp; event.<span class="hljs-property">value</span>[<span class="hljs-number">0</span>]) {
      <span class="hljs-title function_">setText</span>(<span class="hljs-string">`识别结果：<span class="hljs-subst">${event.value[<span class="hljs-number">0</span>]}</span>`</span>);
    }
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">View</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex justify-center items-center m-5"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"🎙 开始语音输入"</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{startListening}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Text</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">marginTop:</span> <span class="hljs-attr">20</span>, <span class="hljs-attr">fontSize:</span> <span class="hljs-attr">18</span> }}&gt;</span>{text}<span class="hljs-tag">&lt;/<span class="hljs-name">Text</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">View</span>&gt;</span></span>
  );
}
</code></pre>
<p>🧠 <strong>关键点讲解：</strong></p>
<ul>
<li><code>Voice.start("zh-CN")</code> 调用系统原生语音识别服务（可选语言）。</li>
<li><code>Voice.onSpeechResults</code> = 从 Native 层回调给 JS 线程。</li>
<li>RN 的 Bridge 层必须处理音频流事件，<strong>注意内存泄漏与线程阻塞</strong>。</li>
</ul>
<hr/>
<h2 data-id="heading-3">🪄 四、语音输入的场景魔法 ✨</h2>
<p>让我们看几个“工业级”使用场景 👇</p>






























<table><thead><tr><th>场景</th><th>描述</th><th>技术关键</th></tr></thead><tbody><tr><td>🗣️ 即时语音转文字</td><td>聊天输入、会议笔记</td><td>实时流式 STT（Streaming Speech-to-Text）</td></tr><tr><td>🎯 语音命令控制</td><td>语音助手、智能家居</td><td>Keyword spotting + 意图识别</td></tr><tr><td>🌍 多语言语音翻译</td><td>旅行翻译</td><td>TTS + Translate + STT 组合</td></tr><tr><td>💬 AI 对话语音化</td><td>ChatGPT 式语音对话</td><td>双向流通信（WebSocket）</td></tr></tbody></table>
<p>每个场景都要求：</p>
<ul>
<li>低延迟（&lt; 300ms）</li>
<li>噪音鲁棒性（Noise Robustness）</li>
<li>正确的回调同步（Promise / Async 周期）</li>
</ul>
<blockquote>
<p>否则你的语音助手可能会变成延迟三秒的“复读机版 Siri”。🪞</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">🧠 五、AI 决策融合的下一步</h2>
<p>语音输入只是入口，AI 才是灵魂。<br/>
如果我们让模型具备理解和决策能力，就能出现类似这样的智能流程：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">function aiBrain(transcript) {
  <span class="hljs-keyword">if</span> (transcript.includes(<span class="hljs-string">"灯"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">"打开客厅灯💡"</span>;
  <span class="hljs-keyword">if</span> (transcript.includes(<span class="hljs-string">"音乐"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">"播放温柔爵士🎵"</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">"我没听懂，可以再说一遍吗？🤔"</span>;
}
</code></pre>
<p>配合语音识别结果：</p>
<ul>
<li>输入语音 “打开灯”</li>
<li>识别文字 “打开灯”</li>
<li>AI 执行 <code>aiBrain("打开灯")</code></li>
<li>反馈结果 “打开客厅灯💡”</li>
</ul>
<p>于是我们就得到了一个最小的<strong>语音驱动 AI 决策系统</strong>。</p>
<blockquote>
<p>听起来简单，却是“听”“懂”“做”三层体系的联动。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">🔋 六、性能与架构优化建议</h2>






























<table><thead><tr><th>层级</th><th>技术点</th><th>优化建议</th></tr></thead><tbody><tr><td>Native 音频层</td><td>录音频率、缓存溢出</td><td>使用 16kHz 单声道，异步写入</td></tr><tr><td>RN Bridge</td><td>通信性能</td><td>最小化数据量，划分事件优先级</td></tr><tr><td>JS 层</td><td>状态管理</td><td>避免频繁 re-render，使用 <code>useRef</code> 暂存</td></tr><tr><td>AI 语义层</td><td>延迟控制</td><td>本地 + 云混合推理架构</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6">💡 七、教学总结</h2>
<blockquote>
<p><strong>一句话概括：</strong><br/>
RN 语音输入 ≈ 声音与 JS 的一场高速“语言旅行”。</p>
</blockquote>



































<table><thead><tr><th>模块</th><th>功能</th><th>难点</th><th>工程关键词</th></tr></thead><tbody><tr><td>麦克风驱动</td><td>捕获音频</td><td>噪音过滤</td><td>音频中断恢复</td></tr><tr><td>Speech SDK</td><td>语音识别</td><td>网络延迟</td><td>流式传输</td></tr><tr><td>RN Bridge</td><td>数据传递</td><td>线程通信</td><td>异步回调</td></tr><tr><td>JS 层</td><td>UI &amp; 逻辑</td><td>高频事件</td><td>状态同步</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">🔮 八、未来畅想：让语音有“灵魂”</h2>
<p>未来的 RN 语音输入将不仅仅是识别文字，而是：</p>
<ul>
<li>提取情绪（你是开心地说“打开灯”，还是暴躁地喊“开灯！”）</li>
<li>预测意图（不是命令，而是推测真实需要）</li>
<li>自动适应上下文联系（对话式连贯推理）</li>
</ul>
<p>那时候，RN 不仅是移动界面框架，更是 <strong>一个可携带的认知接口层（Cognitive Interface Layer）</strong> 。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#: 在Word文档中添加或移除可编辑区域]]></title>    <link>https://juejin.cn/post/7592863358259576886</link>    <guid>https://juejin.cn/post/7592863358259576886</guid>    <pubDate>2026-01-09T02:37:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592863358259576886" data-draft-id="7593139476832157739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#: 在Word文档中添加或移除可编辑区域"/> <meta itemprop="keywords" content="后端,C#"/> <meta itemprop="datePublished" content="2026-01-09T02:37:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="缺点内向"/> <meta itemprop="url" content="https://juejin.cn/user/3414438228006112"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#: 在Word文档中添加或移除可编辑区域
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3414438228006112/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    缺点内向
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T02:37:15.000Z" title="Fri Jan 09 2026 02:37:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">C#: 在Word文档中添加或移除可编辑区域</h2>
<p>在日常办公和自动化流程中，Word文档扮演着不可或缺的角色。然而，在许多场景下，我们并不希望用户能够随意修改文档的所有内容。例如，制作公司内部模板、创建需要填写特定信息的表单，或者实现文档的权限管理时，我们往往需要限制文档的编辑区域，只允许用户修改预设的、特定的内容。这种需求在传统的Word操作中可能需要复杂的设置，甚至手动操作，效率低下且容易出错。</p>
<p>本文将深入探讨如何利用C#编程语言，结合强大的第三方库Spire.Doc for .NET，高效、精准地在Word文档中添加和移除可编辑区域。我们将通过具体的代码示例，为您揭示这一实用技术的奥秘，帮助开发者轻松解决Word文档自动化处理中的痛点。</p>
<h3 data-id="heading-1">理解Word文档的可编辑区域与内容控件</h3>
<p>在深入代码之前，我们首先需要理解Word文档中“可编辑区域”（Editable Region）的概念。顾名思义，可编辑区域是指文档中允许用户进行修改的部分，而其他未被标记为可编辑的区域则受到保护，无法被普通方式编辑。这在模板化文档或需要规范输入的场景中尤其重要。</p>
<p>Word自身提供了一种“内容控件”（Content Control）的功能，允许用户插入文本框、日期选择器、复选框等预定义控件，这些控件内的内容是可编辑的。然而，Word自带的内容控件在编程控制方面存在一定的局限性：它们通常需要通过Word应用程序手动插入，且通过VBA或Open XML SDK进行程序化操作相对复杂，学习曲线较陡峭。此外，内容控件的设计更侧重于结构化数据输入，对于更灵活的“区域”级别保护，其适用性可能不如直接设置可编辑区域。</p>
<p>而<strong>Spire.Doc for .NET</strong>作为一款专业的Word文档处理库，为C#开发者提供了强大的Word 自动化能力，能够以编程方式对Word文档进行深层次的操作。它允许我们以更灵活、更细粒度的方式控制文档的编辑权限，无需依赖Word应用程序，即可实现对文档内容的非侵入式操作。这使得Spire.Doc for .NET在处理复杂Word文档操作时，展现出其独特的优势。</p>
<h3 data-id="heading-2">使用C#和Spire.Doc for .NET添加可编辑区域</h3>
<p>要使用Spire.Doc for .NET库，首先需要通过NuGet包管理器将其添加到您的C#项目中。</p>
<pre><code class="hljs language-bash" lang="bash">Install-Package Spire.Doc
</code></pre>
<p>接下来，我们来看如何通过编程方式在Word文档中定义一个可编辑区域。其核心思想是使用<code>PermissionStart</code>和<code>PermissionEnd</code>对象来标记可编辑区域的开始和结束，并为该区域分配一个唯一的ID。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Spire.Doc;
<span class="hljs-keyword">using</span> Spire.Doc.Documents;
<span class="hljs-keyword">using</span> Spire.Doc.Fields;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WordEditableArea</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddEditableArea</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> inputFilePath, <span class="hljs-built_in">string</span> outputFilePath, <span class="hljs-built_in">string</span> editableText, <span class="hljs-built_in">string</span> permissionId</span>)</span>
    {
        <span class="hljs-comment">// 创建一个新的Document对象</span>
        Document document = <span class="hljs-keyword">new</span> Document();
        document.LoadFromFile(inputFilePath);

        <span class="hljs-comment">// 设置文档保护，只允许读取，并指定密码</span>
        <span class="hljs-comment">// 只有在文档受保护的情况下，可编辑区域的限制才生效</span>
        document.Protect(ProtectionType.AllowOnlyReading, <span class="hljs-string">"password"</span>);

        <span class="hljs-comment">// 查找或创建需要设置为可编辑区域的段落</span>
        <span class="hljs-comment">// 这里以文档第一个段落为例，将指定文本设置为可编辑</span>
        Paragraph firstParagraph = document.Sections[<span class="hljs-number">0</span>].Paragraphs[<span class="hljs-number">0</span>];

        <span class="hljs-comment">// 插入要作为可编辑内容的文本</span>
        TextRange editableTextRange = firstParagraph.AppendText(editableText);

        <span class="hljs-comment">// 创建PermissionStart对象，标记可编辑区域的开始</span>
        PermissionStart start = <span class="hljs-keyword">new</span> PermissionStart(document, permissionId);
        <span class="hljs-comment">// 创建PermissionEnd对象，标记可编辑区域的结束</span>
        PermissionEnd end = <span class="hljs-keyword">new</span> PermissionEnd(document, permissionId);

        <span class="hljs-comment">// 将PermissionStart插入到可编辑文本的起始位置</span>
        firstParagraph.ChildObjects.Insert(firstParagraph.ChildObjects.IndexOf(editableTextRange), start);
        <span class="hljs-comment">// 将PermissionEnd插入到可编辑文本的结束位置之后</span>
        firstParagraph.ChildObjects.Insert(firstParagraph.ChildObjects.IndexOf(editableTextRange) + <span class="hljs-number">1</span>, end);
        
        <span class="hljs-comment">// 保存修改后的文档</span>
        document.SaveToFile(outputFilePath, FileFormat.Docx);
        document.Dispose();
        Console.WriteLine(<span class="hljs-string">$"已添加可编辑区域并保存到: <span class="hljs-subst">{outputFilePath}</span>"</span>);
    }
}
</code></pre>
<p>在上述代码中：</p>
<ul>
<li><code>Document document = new Document();</code> 用于创建一个Word文档对象或加载现有文档。</li>
<li><code>document.Protect(ProtectionType.AllowOnlyReading, "password");</code> 是关键一步，它设置了文档的保护类型。只有当文档受保护时，可编辑区域的限制才会生效。<code>AllowOnlyReading</code>表示只允许读取，但通过<code>PermissionStart</code>和<code>PermissionEnd</code>标记的区域除外。</li>
<li><code>PermissionStart</code>和<code>PermissionEnd</code>是Spire.Doc提供的核心类，它们通过一个共享的<code>permissionId</code>来定义一个完整的<strong>Editable Region</strong>。</li>
<li>我们将<code>PermissionStart</code>和<code>PermissionEnd</code>对象作为子对象插入到段落中，从而将它们之间的内容标记为可编辑。</li>
</ul>
<h3 data-id="heading-3">移除Word文档中的可编辑区域</h3>
<p>有时，我们需要将一个带有可编辑区域的文档恢复为完全可编辑状态，或者移除特定的可编辑区域。Spire.Doc for .NET同样提供了简洁的方式来完成这一操作。</p>
<p>移除可编辑区域的本质是找到并删除文档中的所有<code>PermissionStart</code>和<code>PermissionEnd</code>对象。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Spire.Doc;
<span class="hljs-keyword">using</span> Spire.Doc.Documents;
<span class="hljs-keyword">using</span> Spire.Doc.Fields;
<span class="hljs-keyword">using</span> System;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">WordEditableAreaRemover</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">RemoveAllEditableAreas</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> inputFilePath, <span class="hljs-built_in">string</span> outputFilePath</span>)</span>
    {
        Document document = <span class="hljs-keyword">new</span> Document();
        document.LoadFromFile(inputFilePath);

        <span class="hljs-comment">// 遍历文档中的所有节</span>
        <span class="hljs-keyword">foreach</span> (Section section <span class="hljs-keyword">in</span> document.Sections)
        {
            <span class="hljs-comment">// 遍历节中的所有段落</span>
            <span class="hljs-keyword">foreach</span> (Paragraph paragraph <span class="hljs-keyword">in</span> section.Body.Paragraphs)
            {
                <span class="hljs-comment">// 从后向前遍历段落的子对象，避免删除元素后索引错乱</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = paragraph.ChildObjects.Count - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--)
                {
                    DocumentObject obj = paragraph.ChildObjects[i];

                    <span class="hljs-comment">// 检查是否为PermissionStart或PermissionEnd对象</span>
                    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> PermissionStart || obj <span class="hljs-keyword">is</span> PermissionEnd)
                    {
                        <span class="hljs-comment">// 移除该对象</span>
                        paragraph.ChildObjects.Remove(obj);
                    }
                }
            }
        }
        
        <span class="hljs-comment">// 如果文档之前设置了保护，移除可编辑区域后，</span>
        <span class="hljs-comment">// 可以选择取消文档保护，使其完全可编辑</span>
        document.Unprotect(); 

        <span class="hljs-comment">// 保存修改后的文档</span>
        document.SaveToFile(outputFilePath, FileFormat.Docx);
        document.Dispose();
        Console.WriteLine(<span class="hljs-string">$"已移除所有可编辑区域并保存到: <span class="hljs-subst">{outputFilePath}</span>"</span>);
    }
}
</code></pre>
<p>在上述代码中：</p>
<ul>
<li>我们通过嵌套循环遍历了文档的所有<code>Section</code>和<code>Paragraph</code>。</li>
<li>在每个<code>Paragraph</code>中，我们遍历其<code>ChildObjects</code>，查找<code>PermissionStart</code>和<code>PermissionEnd</code>实例。</li>
<li>一旦找到，就将其从<code>ChildObjects</code>集合中移除。</li>
<li><strong>注意：</strong> 从集合中移除元素时，从后向前遍历是一种推荐的做法，以避免索引在删除元素后发生偏移。</li>
<li><code>document.Unprotect();</code> 这一行非常重要，它取消了文档的保护状态，使得文档完全可编辑。</li>
</ul>
<h3 data-id="heading-4">结论</h3>
<p>通过本文的介绍和代码示例，我们了解了如何利用C#和<strong>Spire.Doc for .NET</strong>库，灵活地在Word文档中添加和移除可编辑区域。这项技术在Word 自动化、C# 编程以及创建智能模板和表单时具有极高的实用价值。</p>
<p>相较于Word自带的内容控制，Spire.Doc for .NET提供的<code>PermissionStart</code>和<code>PermissionEnd</code>机制在处理“区域”级别的编辑限制时，显得更加直接和强大，并且完全通过代码控制，实现了非侵入式操作。这使得开发者能够更精细地管理文档内容，提升了自动化处理的效率和灵活性。</p>
<p>掌握这项技术，您将能够更有效地制作受保护的Word模板，实现复杂的文档权限管理，从而在各种业务场景中发挥Word文档的最大潜力。大家也可以探索Spire.Doc for .NET在其他Word文档操作方面的强大能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我的Vide Coding工具的尝试——版本问题的苦之2]]></title>    <link>https://juejin.cn/post/7592819937652703247</link>    <guid>https://juejin.cn/post/7592819937652703247</guid>    <pubDate>2026-01-08T22:42:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592819937652703247" data-draft-id="7592787377657085986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我的Vide Coding工具的尝试——版本问题的苦之2"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-01-08T22:42:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术人的流水账"/> <meta itemprop="url" content="https://juejin.cn/user/3986165296293584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我的Vide Coding工具的尝试——版本问题的苦之2
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3986165296293584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术人的流水账
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T22:42:32.000Z" title="Thu Jan 08 2026 22:42:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>我是一个技术人，既不是那种天天需要写代码的，也不是那种天天都不写代码的，Coding纯属兴趣，不求完全靠这个吃饭，只求在探索的过程中找到自己的快乐。正如网名所示，我的文风将会是“流水账”，因为我相信，技术的探索永远在过程中，如果有人在乎过程，那么经过一定提炼的探索流水账，将比一个精炼的总结更有价值。</p>
</blockquote>
<h2 data-id="heading-0">这么苦我该怎么办</h2>
<p>尝过之前面试的版本的苦，和上面的这些苦之后，我想要有所改变，由于之前做过AI方面的小应用，我知道这个时候我们需要做的就是，尽可能多的提供给AI它没有的信息，在这里就是最新版本的特性和代码样例，那么应该用什么方式去呈现呢？我最先想到的是MCP，如果AI在Vibe Coding的过程中知道它可能不知道，那么应该就有可能会去想办法去找相关的新特性和代码样例，然后在代码样例的指导下进行编码，MCP应该就是这么一个让AI在运行过程中可以去调用外部工具的接口。</p>
<p>那么下面就出现了2个问题：</p>
<ol>
<li>这些特性和代码样例去哪里找？</li>
<li>找来了这些信息怎么通过MCP来提供服务呢？</li>
</ol>
<p>于是我尝试请教Gemini，先说结论，首先现在似乎没有一站式的方案，但是分成两步的话还是有一些办法的。对于第一个问题，新版本的特性和代码样例基本在库文档或生成式文档里都有，但是怎么爬下来是个问题，下面我们就说说怎么爬文档的问题。</p>
<h3 data-id="heading-1">文档的爬取</h3>
<p>Gemini给出的方案基本上就是两种，SaaS平台的文档爬取和装在本地的爬取库，爬下来之后都能转成markdown。这里我实际尝试了两个，分别是：</p>
<ol>
<li>SaaS方案: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.firecrawl.dev%2F" target="_blank" title="https://www.firecrawl.dev/" ref="nofollow noopener noreferrer">www.firecrawl.dev/</a>
<ol>
<li>一定用量以下免费，但是基本每月只够爬500篇</li>
<li>还支持一些AI现场爬的方案，单独收费</li>
<li>支持通过MCP+AI现场爬，但是似乎不支持MCP+已经爬好的内容</li>
<li>这个firecrawl也开源本地部署，但是那个Docker Compose的构建过程很漫长，也有各种报错（我用的是一个已经不能再更新的老Mac，就不要再折腾自己了），我也是试了一下就放弃了。</li>
</ol>
</li>
<li>本地方案: Crawl4ai
<ol>
<li>这个是Python的库，各种爬取方式和过滤也都支持，效果也不差，关键是也不要钱，效果嘛，过会儿我们一起看。</li>
<li>用起来倒是很方便，让AI帮忙写一段调用代码，写一个文档的根目录，写一个过滤前缀就可以了。</li>
</ol>
</li>
</ol>
<p>AI告诉我Cursor内置的应该也是firecrawl的方案，所以这个SaaS还收钱应该差不了，我实际尝试让它去爬了一些LangChain的文档，效果还不错。但是额度用的太快，不交钱估计是用不了了。</p>
<p>而在去试Crawl4ai的时候，需要考虑的一个问题就是这个跑在哪的问题，本来常用的文档都在外面，而爬取本来来回通信就要走很多次，又有可能很容易被墙，考虑了一会儿，我想到的一个好地方是: Google Colab。</p>
<p>有人可能要说我怎么这么喜欢G家的产品，而事实是，G家确实提供了太多成本低（很多都免费）又开放的方案给开发者，让我们自由去发挥。Google Colab的核心就是一个在线的Jupyter Notebook，运行在临时分配的虚拟机上，初衷应该还是做ML/AI和科学计算相关的内容，而你纯粹把它当成一个在线的，在外面的Jupyter Notebook也完全没有问题。这里安利的一点是，这个Jupyter Notebook可以提供免费的GPU使用额度，所以如果你想用它浅浅尝试一下LLM的微调甚至BERT的小规模预训练也未尝不可。在这里我通过Jupyter Notebook挂载Google Drive的方式，就可以让Colab帮我去爬对应页面，只要设好sleep间隔，爬了几千页也没有被墙。</p>
<p>下面分享我的Jupyter的爬取Kubernetes JavaScript SDK文档（没错，我把文档host到一个github.io上了）爬取代码:</p>
<pre><code class="hljs language-python" lang="python">!pip install crawl4ai <span class="hljs-comment"># 安装crawl4ai，建议把这一行单独写一个代码框，因为首次运行后可能需要点击重启CoLab的Runtime</span>
!crawl4ai-setup <span class="hljs-comment"># crawl4ai初始化</span>

<span class="hljs-keyword">from</span> google.colab <span class="hljs-keyword">import</span> drive 
drive.mount(<span class="hljs-string">'/content/drive'</span>) <span class="hljs-comment"># 挂载Google Drive网盘</span>

<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> re
<span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> urlparse
<span class="hljs-keyword">from</span> crawl4ai <span class="hljs-keyword">import</span> AsyncWebCrawler, BrowserConfig, CrawlerRunConfig, CacheMode

<span class="hljs-comment"># ==================== 配置区 ====================</span>
<span class="hljs-comment"># 1. 目标与范围</span>
BASE_URL = <span class="hljs-string">"https://zhibinyang.github.io/kubernetes-client-node-docs-v1.4-unofficial/modules/index.html"</span>
PREFIX = <span class="hljs-string">"https://zhibinyang.github.io/kubernetes-client-node-docs-v1.4-unofficial/"</span>

<span class="hljs-comment"># 2. 后缀过滤 (设置为 None 或 [] 则不过滤后缀，抓取前缀下的所有页面)</span>
ALLOWED_EXTENSIONS = [<span class="hljs-string">'.html'</span>, <span class="hljs-string">'.htm'</span>]

<span class="hljs-comment"># 3. 存储设置</span>
OUTPUT_DIR = <span class="hljs-string">"/content/drive/MyDrive/Docs/Kubernetes-Node"</span>
TRACKER_FILE = os.path.join(OUTPUT_DIR, <span class="hljs-string">"crawled_urls.txt"</span>)

<span class="hljs-comment"># 4. 爬取偏好</span>
SLEEP_TIME = <span class="hljs-number">1.0</span>  <span class="hljs-comment"># 间隔秒数</span>
<span class="hljs-comment"># ===============================================</span>

os.makedirs(OUTPUT_DIR, exist_ok=<span class="hljs-literal">True</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">clean_url</span>(<span class="hljs-params">url</span>):
    <span class="hljs-string">"""去除锚点和查询参数，确保唯一性"""</span>
    <span class="hljs-keyword">return</span> url.split(<span class="hljs-string">'#'</span>)[<span class="hljs-number">0</span>].split(<span class="hljs-string">'?'</span>)[<span class="hljs-number">0</span>].rstrip(<span class="hljs-string">'/'</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">should_crawl</span>(<span class="hljs-params">url, prefix, processed_set, allowed_exts</span>):
    <span class="hljs-string">"""判断一个 URL 是否符合爬取条件"""</span>
    cleaned = clean_url(url)

    <span class="hljs-comment"># 基本条件：没爬过且符合前缀</span>
    <span class="hljs-keyword">if</span> cleaned <span class="hljs-keyword">in</span> processed_set <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> cleaned.startswith(prefix):
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

    <span class="hljs-comment"># 后缀条件：如果设置了过滤列表，则必须匹配其中之一</span>
    <span class="hljs-keyword">if</span> allowed_exts:
        path = urlparse(cleaned).path
        <span class="hljs-comment"># 处理 index 情况：如果路径以 / 结尾，通常对应 index.html</span>
        <span class="hljs-keyword">if</span> path.endswith(<span class="hljs-string">'/'</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> os.path.basename(path):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">any</span>(path.lower().endswith(ext.lower()) <span class="hljs-keyword">for</span> ext <span class="hljs-keyword">in</span> allowed_exts)

    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_file_name</span>(<span class="hljs-params">url</span>):
    <span class="hljs-string">"""通用命名逻辑：取最后两级路径名"""</span>
    path = urlparse(clean_url(url)).path.strip(<span class="hljs-string">'/'</span>)
    <span class="hljs-comment"># 移除所有已知的扩展名后缀，便于统一存为 .md</span>
    <span class="hljs-keyword">if</span> ALLOWED_EXTENSIONS:
        <span class="hljs-keyword">for</span> ext <span class="hljs-keyword">in</span> ALLOWED_EXTENSIONS:
            path = re.sub(re.escape(ext) + <span class="hljs-string">r'$'</span>, <span class="hljs-string">''</span>, path, flags=re.IGNORECASE)

    parts = [p <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> path.split(<span class="hljs-string">'/'</span>) <span class="hljs-keyword">if</span> p]
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(parts) &gt;= <span class="hljs-number">2</span>:
        name = <span class="hljs-string">f"<span class="hljs-subst">{parts[-<span class="hljs-number">2</span>]}</span>-<span class="hljs-subst">{parts[-<span class="hljs-number">1</span>]}</span>"</span>
    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">len</span>(parts) == <span class="hljs-number">1</span>:
        name = parts[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">else</span>:
        name = <span class="hljs-string">"index"</span>

    <span class="hljs-keyword">return</span> re.sub(<span class="hljs-string">r'[^\w\-]'</span>, <span class="hljs-string">'_'</span>, name) + <span class="hljs-string">".md"</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">universal_crawler</span>():
    <span class="hljs-comment"># 1. 加载进度</span>
    processed_urls = <span class="hljs-built_in">set</span>()
    <span class="hljs-keyword">if</span> os.path.exists(TRACKER_FILE):
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(TRACKER_FILE, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> f:
            processed_urls = <span class="hljs-built_in">set</span>(line.strip() <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f <span class="hljs-keyword">if</span> line.strip())

    <span class="hljs-comment"># 2. 爬虫配置</span>
    browser_config = BrowserConfig(headless=<span class="hljs-literal">True</span>)
    run_config = CrawlerRunConfig(
        cache_mode=CacheMode.BYPASS,
        word_count_threshold=<span class="hljs-number">100</span>,
        remove_overlay_elements=<span class="hljs-literal">True</span>
    )

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> AsyncWebCrawler(config=browser_config) <span class="hljs-keyword">as</span> crawler:
        queue = [BASE_URL]

        <span class="hljs-keyword">while</span> queue:
            current_raw_url = queue.pop(<span class="hljs-number">0</span>)
            current_url = clean_url(current_raw_url)

            <span class="hljs-comment"># 再次检查（防止队列中存在重复）</span>
            <span class="hljs-keyword">if</span> current_url <span class="hljs-keyword">in</span> processed_urls:
                <span class="hljs-keyword">continue</span>

            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🚀 Processing: <span class="hljs-subst">{current_url}</span>"</span>)

            result = <span class="hljs-keyword">await</span> crawler.arun(url=current_url, config=run_config)

            <span class="hljs-keyword">if</span> result.success:
                <span class="hljs-comment"># A. 保存文件</span>
                file_name = get_file_name(current_url)
                file_path = os.path.join(OUTPUT_DIR, file_name)
                <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
                    f.write(result.markdown)

                <span class="hljs-comment"># B. 更新追踪器</span>
                processed_urls.add(current_url)
                <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(TRACKER_FILE, <span class="hljs-string">"a"</span>) <span class="hljs-keyword">as</span> f:
                    f.write(current_url + <span class="hljs-string">"\n"</span>)

                <span class="hljs-comment"># C. 发现新链接</span>
                <span class="hljs-keyword">for</span> link <span class="hljs-keyword">in</span> result.links.get(<span class="hljs-string">"internal"</span>, []):
                    link_url = clean_url(link[<span class="hljs-string">'href'</span>])
                    <span class="hljs-keyword">if</span> should_crawl(link_url, PREFIX, processed_urls, ALLOWED_EXTENSIONS):
                        queue.append(link_url)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"❌ Failed: <span class="hljs-subst">{current_url}</span> - <span class="hljs-subst">{result.error_message}</span>"</span>)

            <span class="hljs-keyword">await</span> asyncio.sleep(SLEEP_TIME)

<span class="hljs-comment"># 运行</span>
<span class="hljs-keyword">await</span> universal_crawler()
</code></pre>
<p>CoLab相对来说有一个限制就是，它需要你保持浏览器开启且网络持续连接，才能保留你的资源，对于这种程度的资源，基本上全天一直开着也不是问题，但是如果网络断了超过30分钟，那么资源就会被释放，而你的脚本就停止了，所以上面的脚本一定程度上也考虑了重传，但是因为没有存下来原始的页面HTML，所以即使要继续也只能复用之前爬过的页面列表，而需要换一个页面入口。</p>
<p>上面的代码里的Kubernetes的文档我是第二波爬的，第一波爬的是LangChain.js和LangGraph.js的全站文档，大概400多页，而当我在跑Kubernetes的时候，我已经测试完了LangChain.js爬取后查询的效果，看了结果之后我就没有一直开机让Kubernetes跑完，我就拿一篇爬下来的文档给大家先看看，下一节我们再说说用MCP提供服务。</p>
<pre><code class="hljs language-md" lang="md">On this page
<span class="hljs-bullet">  *</span> [<span class="hljs-string">Create tools</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/langchain/tools#create-tools</span>)
<span class="hljs-bullet">  *</span> [<span class="hljs-string">Basic tool definition</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/langchain/tools#basic-tool-definition</span>)
<span class="hljs-bullet">  *</span> [<span class="hljs-string">Accessing Context</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/langchain/tools#accessing-context</span>)
<span class="hljs-bullet">  *</span> [<span class="hljs-string">Context</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/langchain/tools#context</span>)
<span class="hljs-bullet">  *</span> [<span class="hljs-string">Memory (Store)</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/langchain/tools#memory-store</span>)
<span class="hljs-bullet">  *</span> [<span class="hljs-string">Stream Writer</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/langchain/tools#stream-writer</span>)


[<span class="hljs-string">Core components</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/langchain/agents</span>)
<span class="hljs-section"># Tools</span>
Copy page
Copy page
Tools extend what [<span class="hljs-string">agents</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/langchain/agents</span>) can do—letting them fetch real-time data, execute code, query external databases, and take actions in the world. Under the hood, tools are callable functions with well-defined inputs and outputs that get passed to a [<span class="hljs-string">chat model</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/langchain/models</span>). The model decides when to invoke a tool based on the conversation context, and what input arguments to provide.
For details on how models handle tool calls, see [<span class="hljs-string">Tool calling</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/langchain/models#tool-calling</span>).
<span class="hljs-section">## Create tools</span>
<span class="hljs-section">### Basic tool definition</span>
The simplest way to create a tool is by importing the <span class="hljs-code">`tool`</span> function from the <span class="hljs-code">`langchain`</span> package. You can use [<span class="hljs-string">zod</span>](<span class="hljs-link">https://zod.dev/</span>) to define the tool’s input schema:
<span class="hljs-code">```
import * as z from "zod"
import { tool } from "langchain"

const searchDatabase = tool(
  ({ query, limit }) =&gt; `Found ${limit} results for '${query}'`,
  {
    name: "search_database",
    description: "Search the customer database for records matching the query.",
    schema: z.object({
      query: z.string().describe("Search terms to look for"),
      limit: z.number().describe("Maximum number of results to return"),
    }),
  }
);

```</span>

<span class="hljs-strong">**Server-side tool use**</span> Some chat models (e.g., [<span class="hljs-string">OpenAI</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/integrations/chat/openai</span>), [<span class="hljs-string">Anthropic</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/integrations/chat/anthropic</span>), and [<span class="hljs-string">Gemini</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/integrations/chat/google_generative_ai</span>)) feature [<span class="hljs-string">built-in tools</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/langchain/models#server-side-tool-use</span>) that are executed server-side, such as web search and code interpreters. Refer to the [<span class="hljs-string">provider overview</span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/integrations/providers/overview</span>) to learn how to access these tools with your specific chat model.
<span class="hljs-section">## Accessing Context</span>
<span class="hljs-strong">**Why this matters:**</span> Tools are most powerful when they can access agent state, runtime context, and long-term memory. This enables tools to make context-aware decisions, personalize responses, and maintain information across conversations.The runtime context provides a structured way to supply runtime data, such as DB connections, user IDs, or config, into your tools. This avoids global state and keeps tools testable and reusable.
<span class="hljs-section">#### Context</span>
Tools can access an agent’s runtime context through the <span class="hljs-code">`config`</span> parameter:
<span class="hljs-code">```
import * as z from "zod"
import { ChatOpenAI } from "@langchain/openai"
import { createAgent } from "langchain"

const getUserName = tool(
  (_, config) =&gt; {
    return config.context.user_name
  },
  {
    name: "get_user_name",
    description: "Get the user's name.",
    schema: z.object({}),
  }
);

const contextSchema = z.object({
  user_name: z.string(),
});

const agent = createAgent({
  model: new ChatOpenAI({ model: "gpt-4o" }),
  tools: [getUserName],
  contextSchema,
});

const result = await agent.invoke(
  {
    messages: [{ role: "user", content: "What is my name?" }]
  },
  {
    context: { user_name: "John Smith" }
  }
);

```</span>

<span class="hljs-section">#### Memory (Store)</span>
Access persistent data across conversations using the store. The store is accessed via <span class="hljs-code">`config.store`</span> and allows you to save and retrieve user-specific or application-specific data.
<span class="hljs-code">```
import * as z from "zod";
import { createAgent, tool } from "langchain";
import { InMemoryStore } from "@langchain/langgraph";
import { ChatOpenAI } from "@langchain/openai";

const store = new InMemoryStore();

// Access memory
const getUserInfo = tool(
  async ({ user_id }) =&gt; {
    const value = await store.get(["users"], user_id);
    console.log("get_user_info", user_id, value);
    return value;
  },
  {
    name: "get_user_info",
    description: "Look up user info.",
    schema: z.object({
      user_id: z.string(),
    }),
  }
);

// Update memory
const saveUserInfo = tool(
  async ({ user_id, name, age, email }) =&gt; {
    console.log("save_user_info", user_id, name, age, email);
    await store.put(["users"], user_id, { name, age, email });
    return "Successfully saved user info.";
  },
  {
    name: "save_user_info",
    description: "Save user info.",
    schema: z.object({
      user_id: z.string(),
      name: z.string(),
      age: z.number(),
      email: z.string(),
    }),
  }
);

const agent = createAgent({
  model: new ChatOpenAI({ model: "gpt-4o" }),
  tools: [getUserInfo, saveUserInfo],
  store,
});

// First session: save user info
await agent.invoke({
  messages: [
    {
      role: "user",
      content: "Save the following user: userid: abc123, name: Foo, age: 25, email: foo@langchain.dev",
    },
  ],
});

// Second session: get user info
const result = await agent.invoke({
  messages: [
    { role: "user", content: "Get user info for user with id 'abc123'" },
  ],
});

console.log(result);
// Here is the user info for user with ID "abc123":
// - Name: Foo
// - Age: 25
// - Email: foo@langchain.dev

```</span>

<span class="hljs-section">#### Stream Writer</span>
Stream custom updates from tools as they execute using <span class="hljs-code">`config.streamWriter`</span>. This is useful for providing real-time feedback to users about what a tool is doing.
<span class="hljs-code">```
import * as z from "zod";
import { tool, ToolRuntime } from "langchain";

const getWeather = tool(
  ({ city }, config: ToolRuntime) =&gt; {
    const writer = config.writer;

    // Stream custom updates as the tool executes
    if (writer) {
      writer(`Looking up data for city: ${city}`);
      writer(`Acquired data for city: ${city}`);
    }

    return `It's always sunny in ${city}!`;
  },
  {
    name: "get_weather",
    description: "Get weather for a given city.",
    schema: z.object({
      city: z.string(),
    }),
  }
);

```</span>

<span class="hljs-bullet">*</span> * *
[<span class="hljs-string">Edit this page on GitHub</span>](<span class="hljs-link">https://github.com/langchain-ai/docs/edit/main/src/oss/langchain/tools.mdx</span>) or [<span class="hljs-string">file an issue</span>](<span class="hljs-link">https://github.com/langchain-ai/docs/issues/new/choose</span>).
[<span class="hljs-string">Connect these docs</span>](<span class="hljs-link">https://docs.langchain.com/use-these-docs</span>) to Claude, VSCode, and more via MCP for real-time answers.
Was this page helpful?
YesNo
[<span class="hljs-string"> Messages Previous </span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/langchain/messages</span>)[<span class="hljs-string"> Short-term memory Next </span>](<span class="hljs-link">https://docs.langchain.com/oss/javascript/langchain/short-term-memory</span>)
[<span class="hljs-string">![light logo</span>](<span class="hljs-link">https://mintcdn.com/langchain-5e9cc07a/Xbr8HuVd9jPi6qTU/images/brand/langchain-docs-teal.svg?fit=max&amp;auto=format&amp;n=Xbr8HuVd9jPi6qTU&amp;q=85&amp;s=16111530672bf976cb54ef2143478342</span>)![<span class="hljs-string">dark logo</span>](<span class="hljs-link">https://mintcdn.com/langchain-5e9cc07a/Xbr8HuVd9jPi6qTU/images/brand/langchain-docs-lilac.svg?fit=max&amp;auto=format&amp;n=Xbr8HuVd9jPi6qTU&amp;q=85&amp;s=b70fb1a2208670492ef94aef14b680be</span>)](<span class="hljs-link">https://docs.langchain.com/</span>)
[](<span class="hljs-link">https://github.com/langchain-ai</span>)[](<span class="hljs-link">https://x.com/LangChainAI</span>)[](<span class="hljs-link">https://www.linkedin.com/company/langchain/</span>)[](<span class="hljs-link">https://www.youtube.com/@LangChain</span>)
Resources
[<span class="hljs-string">Forum</span>](<span class="hljs-link">https://forum.langchain.com/</span>)[<span class="hljs-string">Changelog</span>](<span class="hljs-link">https://changelog.langchain.com/</span>)[<span class="hljs-string">LangChain Academy</span>](<span class="hljs-link">https://academy.langchain.com/</span>)[<span class="hljs-string">Trust Center</span>](<span class="hljs-link">https://trust.langchain.com/</span>)
Company
[<span class="hljs-string">About</span>](<span class="hljs-link">https://langchain.com/about</span>)[<span class="hljs-string">Careers</span>](<span class="hljs-link">https://langchain.com/careers</span>)[<span class="hljs-string">Blog</span>](<span class="hljs-link">https://blog.langchain.com/</span>)
[](<span class="hljs-link">https://github.com/langchain-ai</span>)[](<span class="hljs-link">https://x.com/LangChainAI</span>)[](<span class="hljs-link">https://www.linkedin.com/company/langchain/</span>)[](<span class="hljs-link">https://www.youtube.com/@LangChain</span>)
[<span class="hljs-string">Powered by</span>](<span class="hljs-link">https://www.mintlify.com?utm_campaign=poweredBy&amp;utm_medium=referral&amp;utm_source=langchain-5e9cc07a</span>)
Assistant
Responses are generated using AI and may contain mistakes.

</code></pre>
<h3 data-id="heading-2">爬完了我怎么用</h3>
<p>数据花了很大的功夫趴下来了，总得赶快用MCP去服务一下，本着不造轮子的原则，我需要考虑怎么用尽可能简单的方法提供这个服务。这个时候我把目光放到了我之前用了一段时间的一个软件上——Obisidian</p>
<p>Obsidian是免费的Markdown笔记软件，有很丰富的插件生态，之前我用过里面一个也叫Copilot的插件就很不错，它通过内置的向量数据库，结合Embedding Model的API（来自OpenAI或者火山这样的外部提供商），在配合BYOK的LLM API的总结，可以实现比较完整的个人知识库向量搜索+总结的效果。而因为是笔记软件，所以对于Markdown的渲染本来就是内置功能。</p>
<p>那么如果有一个插件，可以实现向量数据库+Embedding Model的连接，对外又能提供MCP，那么我不是既能在Obsidian里管理我的文档（通过Review查看文档内容，然后及时编辑），又能对接AI实现知识库的查询。查了一圈，虽然内置的有一个类似的MCP工具叫做MCP Tools，但是它似乎不支持向量搜索，我又找到一个叫做MCP Server的，它不在Obsidian的插件商店里，而需要从Github上Clone并构建，并将关键文件手动复制到Obsidian的插件目录下。</p>
<pre><code class="hljs language-bash" lang="bash">https://github.com/Minhao-Zhang/obsidian-mcp-server
</code></pre>
<p>这个插件有比较完整的RAG知识库的影子，比如可设置OpenAI API兼容的Embedding模型，分Chunk，Chunk间设置Overlap， 设置similarity阈值，设置召回的文档个数等，这不就是现成的方案？但是开始没有发现，之后才注意到有个严重的问题是，这个插件不支持增量更新，也就是说如果要加一篇文档，需要重新构建整个向量数据库，如果文档多的话，这个API的成本也不低。</p>
<p>启动后尝试用MCP官方的inspector做了测试:</p>
<pre><code class="hljs language-bash" lang="bash">npx @modelcontextprotocol/inspector
</code></pre>
<p>使用SSE模式，填入MCP Server里的SSE的地址，然后连接使用Direct。之后列出工具，选择simple_vector_search就可以搜索了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0951cb182765474e8599a1b0b3a7a51a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5Lq655qE5rWB5rC06LSm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768516952&amp;x-signature=lE0BkjXAvXYvlFL7t3WHrz7%2BgkI%3D" alt="截屏2026-01-09_06_08_19.jpg" loading="lazy"/></p>
<h3 data-id="heading-3">效果如何呢</h3>
<p>前面说到了我们使用Crawl4ai爬取了文档，然后又实用Obsidian里的MCP Server插件实现了向量数据库，我们迫不及待的想看看在Vibe Coding里使用的效果怎么样，但是在Inspector中的测试我就看出了问题。</p>
<p>正如正面给出的LangChain文档的Markdown的例子，我们发现文档页面的开始部分有大量的引言，而这些引言包含了大量与LangChain特性相关的关键字，那么如果我们正常使用MCP Server插件的按照1000或2000个字符进行分割的话，这些引言就会成为单独的Chunk。而从向量数据库的角度来说，这些Chunk的的语义密度其实是大于代码块，且引言又包含了跨页面的内容，所以最终用MCP Server接口搜出来的，按照近似度排序，靠前的全是不同页面的引言部分。下面给出上面原始页面的地址，大家可以上去看一看。</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/docs.langchain.com/oss</span><span class="hljs-regexp">/javascript/langchain</span><span class="hljs-regexp">/models
</span></code></pre>
<p>引言的截图如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f3b0dc125b54edf9cc0a6ba87d4a5fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5Lq655qE5rWB5rC06LSm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768516952&amp;x-signature=J6sG59jzTzlt34%2FbJUFkAxZEKvI%3D" alt="截屏2026-01-09_06_30_31.jpg" loading="lazy"/></p>
<p>从这个角度看，目前为止我们大费周折终于差一步要跑通的东西似乎效果并不好，那么为了Vibe Coding的效果，我们还能挣扎点什么呢？</p>
<p>有当然是有，效果好不好另说，我们下回接着分解吧。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3分钟Solidity: 10.6 时间锁定]]></title>    <link>https://juejin.cn/post/7592833068223119406</link>    <guid>https://juejin.cn/post/7592833068223119406</guid>    <pubDate>2026-01-08T13:25:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592833068223119406" data-draft-id="7592833068223103022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3分钟Solidity: 10.6 时间锁定"/> <meta itemprop="keywords" content="Solidity,web3,智能合约"/> <meta itemprop="datePublished" content="2026-01-08T13:25:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Rockbean"/> <meta itemprop="url" content="https://juejin.cn/user/4054654615823560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3分钟Solidity: 10.6 时间锁定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4054654615823560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Rockbean
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T13:25:52.000Z" title="Thu Jan 08 2026 13:25:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>欢迎订阅专栏</strong>：<a href="https://juejin.cn/column/7578762210285977663" title="https://juejin.cn/column/7578762210285977663" target="_blank">3分钟Solidity--智能合约--Web3区块链技术必学</a></p>
<p>如需获取本内容的最新版本，请参见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cyfrin.io%2Fglossary%2Ftime-lock-solidity-code-example" target="_blank" title="https://www.cyfrin.io/glossary/time-lock-solidity-code-example" ref="nofollow noopener noreferrer">Cyfrin.io 的Time Lock（代码示例）</a></p>
<p><code>TimeLock</code>是一种合约，用于发布将在未来执行的交易。</p>
<p>经过最短等待期后，该交易即可执行。</p>
<p><code>TimeLock</code>在DAO中经常被使用。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// SPDX-License-Identifier: MIT</span>
pragma solidity ^<span class="hljs-number">0.8</span><span class="hljs-selector-class">.26</span>;

contract TimeLock {
    error <span class="hljs-built_in">NotOwnerError</span>();
    error <span class="hljs-built_in">AlreadyQueuedError</span>(bytes32 txId);
    error <span class="hljs-built_in">TimestampNotInRangeError</span>(uint256 blockTimestamp, uint256 timestamp);
    error <span class="hljs-built_in">NotQueuedError</span>(bytes32 txId);
    error <span class="hljs-built_in">TimestampNotPassedError</span>(uint256 blockTimestamp, uint256 timestamp);
    error <span class="hljs-built_in">TimestampExpiredError</span>(uint256 blockTimestamp, uint256 expiresAt);
    error <span class="hljs-built_in">TxFailedError</span>();

    event <span class="hljs-built_in">Queue</span>(
        bytes32 indexed txId,
        address indexed target,
        uint256 value,
        string func,
        bytes data,
        uint256 timestamp
    );
    event <span class="hljs-built_in">Execute</span>(
        bytes32 indexed txId,
        address indexed target,
        uint256 value,
        string func,
        bytes data,
        uint256 timestamp
    );
    event <span class="hljs-built_in">Cancel</span>(bytes32 indexed txId);

    uint256 public constant MIN_DELAY = <span class="hljs-number">10</span>; <span class="hljs-comment">// seconds</span>
    uint256 public constant MAX_DELAY = <span class="hljs-number">1000</span>; <span class="hljs-comment">// seconds</span>
    uint256 public constant GRACE_PERIOD = <span class="hljs-number">1000</span>; <span class="hljs-comment">// seconds</span>

    <span class="hljs-selector-tag">address</span> public owner;
    <span class="hljs-comment">// tx id =&gt; queued</span>
    <span class="hljs-built_in">mapping</span>(bytes32 =&gt; bool) public queued;

    <span class="hljs-built_in">constructor</span>() {
        owner = msg<span class="hljs-selector-class">.sender</span>;
    }

    modifier <span class="hljs-built_in">onlyOwner</span>() {
        if (msg.sender != owner) {
            revert <span class="hljs-built_in">NotOwnerError</span>();
        }
        _;
    }

    <span class="hljs-built_in">receive</span>() external payable {}

    function <span class="hljs-built_in">getTxId</span>(
        address _target,
        uint256 _value,
        string calldata _func,
        bytes calldata _data,
        uint256 _timestamp
    ) public pure returns (bytes32) {
        return <span class="hljs-built_in">keccak256</span>(abi.encode(_target, _value, _func, _data, _timestamp));
    }

    <span class="hljs-comment">/**
     * @param _target Address of contract or account to call
     * @param _value Amount of ETH to send
     * @param _func Function signature, for example "foo(address,uint256)"
     * @param _data ABI encoded data send.
     * @param _timestamp Timestamp after which the transaction can be executed.
     */</span>
    function <span class="hljs-built_in">queue</span>(
        address _target,
        uint256 _value,
        string calldata _func,
        bytes calldata _data,
        uint256 _timestamp
    ) external onlyOwner returns (bytes32 txId) {
        txId = <span class="hljs-built_in">getTxId</span>(_target, _value, _func, _data, _timestamp);
        if (queued[txId]) {
            revert <span class="hljs-built_in">AlreadyQueuedError</span>(txId);
        }
        <span class="hljs-comment">// ---|------------|---------------|-------</span>
        <span class="hljs-comment">//  block    block + min     block + max</span>
        if (
            _timestamp &lt; block.timestamp + MIN_DELAY
                || _timestamp &gt; block.timestamp + MAX_DELAY
        ) {
            revert <span class="hljs-built_in">TimestampNotInRangeError</span>(block.timestamp, _timestamp);
        }

        queued<span class="hljs-selector-attr">[txId]</span> = true;

        emit <span class="hljs-built_in">Queue</span>(txId, _target, _value, _func, _data, _timestamp);
    }

    function <span class="hljs-built_in">execute</span>(
        address _target,
        uint256 _value,
        string calldata _func,
        bytes calldata _data,
        uint256 _timestamp
    ) external payable onlyOwner returns (bytes memory) {
        bytes32 txId = <span class="hljs-built_in">getTxId</span>(_target, _value, _func, _data, _timestamp);
        if (!queued[txId]) {
            revert <span class="hljs-built_in">NotQueuedError</span>(txId);
        }
        <span class="hljs-comment">// ----|-------------------|-------</span>
        <span class="hljs-comment">//  timestamp    timestamp + grace period</span>
        if (block.timestamp &lt; _timestamp) {
            revert <span class="hljs-built_in">TimestampNotPassedError</span>(block.timestamp, _timestamp);
        }
        if (block.timestamp &gt; _timestamp + GRACE_PERIOD) {
            revert <span class="hljs-built_in">TimestampExpiredError</span>(
                block.timestamp, _timestamp + GRACE_PERIOD
            );
        }

        queued<span class="hljs-selector-attr">[txId]</span> = false;

        <span class="hljs-comment">// prepare data</span>
        bytes memory data;
        if (bytes(_func)<span class="hljs-selector-class">.length</span> &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// data = func selector + _data</span>
            data = abi<span class="hljs-selector-class">.encodePacked</span>(bytes4(keccak256(bytes(_func))), _data);
        } else {
            <span class="hljs-comment">// call fallback with data</span>
            data = _data;
        }

        <span class="hljs-comment">// call target</span>
        (bool ok, bytes memory res) = _target<span class="hljs-selector-class">.call</span>{value: _value}(data);
        if (!ok) {
            revert <span class="hljs-built_in">TxFailedError</span>();
        }

        emit <span class="hljs-built_in">Execute</span>(txId, _target, _value, _func, _data, _timestamp);

        return res;
    }

    function <span class="hljs-built_in">cancel</span>(bytes32 _txId) external onlyOwner {
        if (!queued[_txId]) {
            revert <span class="hljs-built_in">NotQueuedError</span>(_txId);
        }

        queued<span class="hljs-selector-attr">[_txId]</span> = false;

        emit <span class="hljs-built_in">Cancel</span>(_txId);
    }
}
</code></pre>
<p>Remix Lite 尝试一下</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fremix.byteatatime.dev%2F%3F%23code%3DLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVApwcmFnbWEgc29saWRpdHkgXjAuOC4yNjsKCmNvbnRyYWN0IFRpbWVMb2NrIHsKICAgIGVycm9yIE5vdE93bmVyRXJyb3IoKTsKICAgIGVycm9yIEFscmVhZHlRdWV1ZWRFcnJvcihieXRlczMyIHR4SWQpOwogICAgZXJyb3IgVGltZXN0YW1wTm90SW5SYW5nZUVycm9yKHVpbnQyNTYgYmxvY2tUaW1lc3RhbXAsIHVpbnQyNTYgdGltZXN0YW1wKTsKICAgIGVycm9yIE5vdFF1ZXVlZEVycm9yKGJ5dGVzMzIgdHhJZCk7CiAgICBlcnJvciBUaW1lc3RhbXBOb3RQYXNzZWRFcnJvcih1aW50MjU2IGJsb2NrVGltZXN0YW1wLCB1aW50MjU2IHRpbWVzdGFtcCk7CiAgICBlcnJvciBUaW1lc3RhbXBFeHBpcmVkRXJyb3IodWludDI1NiBibG9ja1RpbWVzdGFtcCwgdWludDI1NiBleHBpcmVzQXQpOwogICAgZXJyb3IgVHhGYWlsZWRFcnJvcigpOwoKICAgIGV2ZW50IFF1ZXVlKAogICAgICAgIGJ5dGVzMzIgaW5kZXhlZCB0eElkLAogICAgICAgIGFkZHJlc3MgaW5kZXhlZCB0YXJnZXQsCiAgICAgICAgdWludDI1NiB2YWx1ZSwKICAgICAgICBzdHJpbmcgZnVuYywKICAgICAgICBieXRlcyBkYXRhLAogICAgICAgIHVpbnQyNTYgdGltZXN0YW1wCiAgICApOwogICAgZXZlbnQgRXhlY3V0ZSgKICAgICAgICBieXRlczMyIGluZGV4ZWQgdHhJZCwKICAgICAgICBhZGRyZXNzIGluZGV4ZWQgdGFyZ2V0LAogICAgICAgIHVpbnQyNTYgdmFsdWUsCiAgICAgICAgc3RyaW5nIGZ1bmMsCiAgICAgICAgYnl0ZXMgZGF0YSwKICAgICAgICB1aW50MjU2IHRpbWVzdGFtcAogICAgKTsKICAgIGV2ZW50IENhbmNlbChieXRlczMyIGluZGV4ZWQgdHhJZCk7CgogICAgdWludDI1NiBwdWJsaWMgY29uc3RhbnQgTUlOX0RFTEFZID0gMTA7IC8vIHNlY29uZHMKICAgIHVpbnQyNTYgcHVibGljIGNvbnN0YW50IE1BWF9ERUxBWSA9IDEwMDA7IC8vIHNlY29uZHMKICAgIHVpbnQyNTYgcHVibGljIGNvbnN0YW50IEdSQUNFX1BFUklPRCA9IDEwMDA7IC8vIHNlY29uZHMKCiAgICBhZGRyZXNzIHB1YmxpYyBvd25lcjsKICAgIC8vIHR4IGlkID0%2BIHF1ZXVlZAogICAgbWFwcGluZyhieXRlczMyID0%2BIGJvb2wpIHB1YmxpYyBxdWV1ZWQ7CgogICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgb3duZXIgPSBtc2cuc2VuZGVyOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlPd25lcigpIHsKICAgICAgICBpZiAobXNnLnNlbmRlciAhPSBvd25lcikgewogICAgICAgICAgICByZXZlcnQgTm90T3duZXJFcnJvcigpOwogICAgICAgIH0KICAgICAgICBfOwogICAgfQoKICAgIHJlY2VpdmUoKSBleHRlcm5hbCBwYXlhYmxlIHt9CgogICAgZnVuY3Rpb24gZ2V0VHhJZCgKICAgICAgICBhZGRyZXNzIF90YXJnZXQsCiAgICAgICAgdWludDI1NiBfdmFsdWUsCiAgICAgICAgc3RyaW5nIGNhbGxkYXRhIF9mdW5jLAogICAgICAgIGJ5dGVzIGNhbGxkYXRhIF9kYXRhLAogICAgICAgIHVpbnQyNTYgX3RpbWVzdGFtcAogICAgKSBwdWJsaWMgcHVyZSByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgcmV0dXJuIGtlY2NhazI1NihhYmkuZW5jb2RlKF90YXJnZXQsIF92YWx1ZSwgX2Z1bmMsIF9kYXRhLCBfdGltZXN0YW1wKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcGFyYW0gX3RhcmdldCBBZGRyZXNzIG9mIGNvbnRyYWN0IG9yIGFjY291bnQgdG8gY2FsbAogICAgICogQHBhcmFtIF92YWx1ZSBBbW91bnQgb2YgRVRIIHRvIHNlbmQKICAgICAqIEBwYXJhbSBfZnVuYyBGdW5jdGlvbiBzaWduYXR1cmUsIGZvciBleGFtcGxlICJmb28oYWRkcmVzcyx1aW50MjU2KSIKICAgICAqIEBwYXJhbSBfZGF0YSBBQkkgZW5jb2RlZCBkYXRhIHNlbmQuCiAgICAgKiBAcGFyYW0gX3RpbWVzdGFtcCBUaW1lc3RhbXAgYWZ0ZXIgd2hpY2ggdGhlIHRyYW5zYWN0aW9uIGNhbiBiZSBleGVjdXRlZC4KICAgICAqLwogICAgZnVuY3Rpb24gcXVldWUoCiAgICAgICAgYWRkcmVzcyBfdGFyZ2V0LAogICAgICAgIHVpbnQyNTYgX3ZhbHVlLAogICAgICAgIHN0cmluZyBjYWxsZGF0YSBfZnVuYywKICAgICAgICBieXRlcyBjYWxsZGF0YSBfZGF0YSwKICAgICAgICB1aW50MjU2IF90aW1lc3RhbXAKICAgICkgZXh0ZXJuYWwgb25seU93bmVyIHJldHVybnMgKGJ5dGVzMzIgdHhJZCkgewogICAgICAgIHR4SWQgPSBnZXRUeElkKF90YXJnZXQsIF92YWx1ZSwgX2Z1bmMsIF9kYXRhLCBfdGltZXN0YW1wKTsKICAgICAgICBpZiAocXVldWVkW3R4SWRdKSB7CiAgICAgICAgICAgIHJldmVydCBBbHJlYWR5UXVldWVkRXJyb3IodHhJZCk7CiAgICAgICAgfQogICAgICAgIC8vIC0tLXwtLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0KICAgICAgICAvLyAgYmxvY2sgICAgYmxvY2sgKyBtaW4gICAgIGJsb2NrICsgbWF4CiAgICAgICAgaWYgKAogICAgICAgICAgICBfdGltZXN0YW1wIDwgYmxvY2sudGltZXN0YW1wICsgTUlOX0RFTEFZCiAgICAgICAgICAgICAgICB8fCBfdGltZXN0YW1wID4gYmxvY2sudGltZXN0YW1wICsgTUFYX0RFTEFZCiAgICAgICAgKSB7CiAgICAgICAgICAgIHJldmVydCBUaW1lc3RhbXBOb3RJblJhbmdlRXJyb3IoYmxvY2sudGltZXN0YW1wLCBfdGltZXN0YW1wKTsKICAgICAgICB9CgogICAgICAgIHF1ZXVlZFt0eElkXSA9IHRydWU7CgogICAgICAgIGVtaXQgUXVldWUodHhJZCwgX3RhcmdldCwgX3ZhbHVlLCBfZnVuYywgX2RhdGEsIF90aW1lc3RhbXApOwogICAgfQoKICAgIGZ1bmN0aW9uIGV4ZWN1dGUoCiAgICAgICAgYWRkcmVzcyBfdGFyZ2V0LAogICAgICAgIHVpbnQyNTYgX3ZhbHVlLAogICAgICAgIHN0cmluZyBjYWxsZGF0YSBfZnVuYywKICAgICAgICBieXRlcyBjYWxsZGF0YSBfZGF0YSwKICAgICAgICB1aW50MjU2IF90aW1lc3RhbXAKICAgICkgZXh0ZXJuYWwgcGF5YWJsZSBvbmx5T3duZXIgcmV0dXJucyAoYnl0ZXMgbWVtb3J5KSB7CiAgICAgICAgYnl0ZXMzMiB0eElkID0gZ2V0VHhJZChfdGFyZ2V0LCBfdmFsdWUsIF9mdW5jLCBfZGF0YSwgX3RpbWVzdGFtcCk7CiAgICAgICAgaWYgKCFxdWV1ZWRbdHhJZF0pIHsKICAgICAgICAgICAgcmV2ZXJ0IE5vdFF1ZXVlZEVycm9yKHR4SWQpOwogICAgICAgIH0KICAgICAgICAvLyAtLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLQogICAgICAgIC8vICB0aW1lc3RhbXAgICAgdGltZXN0YW1wICsgZ3JhY2UgcGVyaW9kCiAgICAgICAgaWYgKGJsb2NrLnRpbWVzdGFtcCA8IF90aW1lc3RhbXApIHsKICAgICAgICAgICAgcmV2ZXJ0IFRpbWVzdGFtcE5vdFBhc3NlZEVycm9yKGJsb2NrLnRpbWVzdGFtcCwgX3RpbWVzdGFtcCk7CiAgICAgICAgfQogICAgICAgIGlmIChibG9jay50aW1lc3RhbXAgPiBfdGltZXN0YW1wICsgR1JBQ0VfUEVSSU9EKSB7CiAgICAgICAgICAgIHJldmVydCBUaW1lc3RhbXBFeHBpcmVkRXJyb3IoCiAgICAgICAgICAgICAgICBibG9jay50aW1lc3RhbXAsIF90aW1lc3RhbXAgKyBHUkFDRV9QRVJJT0QKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIHF1ZXVlZFt0eElkXSA9IGZhbHNlOwoKICAgICAgICAvLyBwcmVwYXJlIGRhdGEKICAgICAgICBieXRlcyBtZW1vcnkgZGF0YTsKICAgICAgICBpZiAoYnl0ZXMoX2Z1bmMpLmxlbmd0aCA%2BIDApIHsKICAgICAgICAgICAgLy8gZGF0YSA9IGZ1bmMgc2VsZWN0b3IgKyBfZGF0YQogICAgICAgICAgICBkYXRhID0gYWJpLmVuY29kZVBhY2tlZChieXRlczQoa2VjY2FrMjU2KGJ5dGVzKF9mdW5jKSkpLCBfZGF0YSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gY2FsbCBmYWxsYmFjayB3aXRoIGRhdGEKICAgICAgICAgICAgZGF0YSA9IF9kYXRhOwogICAgICAgIH0KCiAgICAgICAgLy8gY2FsbCB0YXJnZXQKICAgICAgICAoYm9vbCBvaywgYnl0ZXMgbWVtb3J5IHJlcykgPSBfdGFyZ2V0LmNhbGx7dmFsdWU6IF92YWx1ZX0oZGF0YSk7CiAgICAgICAgaWYgKCFvaykgewogICAgICAgICAgICByZXZlcnQgVHhGYWlsZWRFcnJvcigpOwogICAgICAgIH0KCiAgICAgICAgZW1pdCBFeGVjdXRlKHR4SWQsIF90YXJnZXQsIF92YWx1ZSwgX2Z1bmMsIF9kYXRhLCBfdGltZXN0YW1wKTsKCiAgICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICBmdW5jdGlvbiBjYW5jZWwoYnl0ZXMzMiBfdHhJZCkgZXh0ZXJuYWwgb25seU93bmVyIHsKICAgICAgICBpZiAoIXF1ZXVlZFtfdHhJZF0pIHsKICAgICAgICAgICAgcmV2ZXJ0IE5vdFF1ZXVlZEVycm9yKF90eElkKTsKICAgICAgICB9CgogICAgICAgIHF1ZXVlZFtfdHhJZF0gPSBmYWxzZTsKCiAgICAgICAgZW1pdCBDYW5jZWwoX3R4SWQpOwogICAgfQp9Cg%3D%3D" target="_blank" title="https://remix.byteatatime.dev/?#code=Ly8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1JVApwcmFnbWEgc29saWRpdHkgXjAuOC4yNjsKCmNvbnRyYWN0IFRpbWVMb2NrIHsKICAgIGVycm9yIE5vdE93bmVyRXJyb3IoKTsKICAgIGVycm9yIEFscmVhZHlRdWV1ZWRFcnJvcihieXRlczMyIHR4SWQpOwogICAgZXJyb3IgVGltZXN0YW1wTm90SW5SYW5nZUVycm9yKHVpbnQyNTYgYmxvY2tUaW1lc3RhbXAsIHVpbnQyNTYgdGltZXN0YW1wKTsKICAgIGVycm9yIE5vdFF1ZXVlZEVycm9yKGJ5dGVzMzIgdHhJZCk7CiAgICBlcnJvciBUaW1lc3RhbXBOb3RQYXNzZWRFcnJvcih1aW50MjU2IGJsb2NrVGltZXN0YW1wLCB1aW50MjU2IHRpbWVzdGFtcCk7CiAgICBlcnJvciBUaW1lc3RhbXBFeHBpcmVkRXJyb3IodWludDI1NiBibG9ja1RpbWVzdGFtcCwgdWludDI1NiBleHBpcmVzQXQpOwogICAgZXJyb3IgVHhGYWlsZWRFcnJvcigpOwoKICAgIGV2ZW50IFF1ZXVlKAogICAgICAgIGJ5dGVzMzIgaW5kZXhlZCB0eElkLAogICAgICAgIGFkZHJlc3MgaW5kZXhlZCB0YXJnZXQsCiAgICAgICAgdWludDI1NiB2YWx1ZSwKICAgICAgICBzdHJpbmcgZnVuYywKICAgICAgICBieXRlcyBkYXRhLAogICAgICAgIHVpbnQyNTYgdGltZXN0YW1wCiAgICApOwogICAgZXZlbnQgRXhlY3V0ZSgKICAgICAgICBieXRlczMyIGluZGV4ZWQgdHhJZCwKICAgICAgICBhZGRyZXNzIGluZGV4ZWQgdGFyZ2V0LAogICAgICAgIHVpbnQyNTYgdmFsdWUsCiAgICAgICAgc3RyaW5nIGZ1bmMsCiAgICAgICAgYnl0ZXMgZGF0YSwKICAgICAgICB1aW50MjU2IHRpbWVzdGFtcAogICAgKTsKICAgIGV2ZW50IENhbmNlbChieXRlczMyIGluZGV4ZWQgdHhJZCk7CgogICAgdWludDI1NiBwdWJsaWMgY29uc3RhbnQgTUlOX0RFTEFZID0gMTA7IC8vIHNlY29uZHMKICAgIHVpbnQyNTYgcHVibGljIGNvbnN0YW50IE1BWF9ERUxBWSA9IDEwMDA7IC8vIHNlY29uZHMKICAgIHVpbnQyNTYgcHVibGljIGNvbnN0YW50IEdSQUNFX1BFUklPRCA9IDEwMDA7IC8vIHNlY29uZHMKCiAgICBhZGRyZXNzIHB1YmxpYyBvd25lcjsKICAgIC8vIHR4IGlkID0+IHF1ZXVlZAogICAgbWFwcGluZyhieXRlczMyID0+IGJvb2wpIHB1YmxpYyBxdWV1ZWQ7CgogICAgY29uc3RydWN0b3IoKSB7CiAgICAgICAgb3duZXIgPSBtc2cuc2VuZGVyOwogICAgfQoKICAgIG1vZGlmaWVyIG9ubHlPd25lcigpIHsKICAgICAgICBpZiAobXNnLnNlbmRlciAhPSBvd25lcikgewogICAgICAgICAgICByZXZlcnQgTm90T3duZXJFcnJvcigpOwogICAgICAgIH0KICAgICAgICBfOwogICAgfQoKICAgIHJlY2VpdmUoKSBleHRlcm5hbCBwYXlhYmxlIHt9CgogICAgZnVuY3Rpb24gZ2V0VHhJZCgKICAgICAgICBhZGRyZXNzIF90YXJnZXQsCiAgICAgICAgdWludDI1NiBfdmFsdWUsCiAgICAgICAgc3RyaW5nIGNhbGxkYXRhIF9mdW5jLAogICAgICAgIGJ5dGVzIGNhbGxkYXRhIF9kYXRhLAogICAgICAgIHVpbnQyNTYgX3RpbWVzdGFtcAogICAgKSBwdWJsaWMgcHVyZSByZXR1cm5zIChieXRlczMyKSB7CiAgICAgICAgcmV0dXJuIGtlY2NhazI1NihhYmkuZW5jb2RlKF90YXJnZXQsIF92YWx1ZSwgX2Z1bmMsIF9kYXRhLCBfdGltZXN0YW1wKSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBAcGFyYW0gX3RhcmdldCBBZGRyZXNzIG9mIGNvbnRyYWN0IG9yIGFjY291bnQgdG8gY2FsbAogICAgICogQHBhcmFtIF92YWx1ZSBBbW91bnQgb2YgRVRIIHRvIHNlbmQKICAgICAqIEBwYXJhbSBfZnVuYyBGdW5jdGlvbiBzaWduYXR1cmUsIGZvciBleGFtcGxlICJmb28oYWRkcmVzcyx1aW50MjU2KSIKICAgICAqIEBwYXJhbSBfZGF0YSBBQkkgZW5jb2RlZCBkYXRhIHNlbmQuCiAgICAgKiBAcGFyYW0gX3RpbWVzdGFtcCBUaW1lc3RhbXAgYWZ0ZXIgd2hpY2ggdGhlIHRyYW5zYWN0aW9uIGNhbiBiZSBleGVjdXRlZC4KICAgICAqLwogICAgZnVuY3Rpb24gcXVldWUoCiAgICAgICAgYWRkcmVzcyBfdGFyZ2V0LAogICAgICAgIHVpbnQyNTYgX3ZhbHVlLAogICAgICAgIHN0cmluZyBjYWxsZGF0YSBfZnVuYywKICAgICAgICBieXRlcyBjYWxsZGF0YSBfZGF0YSwKICAgICAgICB1aW50MjU2IF90aW1lc3RhbXAKICAgICkgZXh0ZXJuYWwgb25seU93bmVyIHJldHVybnMgKGJ5dGVzMzIgdHhJZCkgewogICAgICAgIHR4SWQgPSBnZXRUeElkKF90YXJnZXQsIF92YWx1ZSwgX2Z1bmMsIF9kYXRhLCBfdGltZXN0YW1wKTsKICAgICAgICBpZiAocXVldWVkW3R4SWRdKSB7CiAgICAgICAgICAgIHJldmVydCBBbHJlYWR5UXVldWVkRXJyb3IodHhJZCk7CiAgICAgICAgfQogICAgICAgIC8vIC0tLXwtLS0tLS0tLS0tLS18LS0tLS0tLS0tLS0tLS0tfC0tLS0tLS0KICAgICAgICAvLyAgYmxvY2sgICAgYmxvY2sgKyBtaW4gICAgIGJsb2NrICsgbWF4CiAgICAgICAgaWYgKAogICAgICAgICAgICBfdGltZXN0YW1wIDwgYmxvY2sudGltZXN0YW1wICsgTUlOX0RFTEFZCiAgICAgICAgICAgICAgICB8fCBfdGltZXN0YW1wID4gYmxvY2sudGltZXN0YW1wICsgTUFYX0RFTEFZCiAgICAgICAgKSB7CiAgICAgICAgICAgIHJldmVydCBUaW1lc3RhbXBOb3RJblJhbmdlRXJyb3IoYmxvY2sudGltZXN0YW1wLCBfdGltZXN0YW1wKTsKICAgICAgICB9CgogICAgICAgIHF1ZXVlZFt0eElkXSA9IHRydWU7CgogICAgICAgIGVtaXQgUXVldWUodHhJZCwgX3RhcmdldCwgX3ZhbHVlLCBfZnVuYywgX2RhdGEsIF90aW1lc3RhbXApOwogICAgfQoKICAgIGZ1bmN0aW9uIGV4ZWN1dGUoCiAgICAgICAgYWRkcmVzcyBfdGFyZ2V0LAogICAgICAgIHVpbnQyNTYgX3ZhbHVlLAogICAgICAgIHN0cmluZyBjYWxsZGF0YSBfZnVuYywKICAgICAgICBieXRlcyBjYWxsZGF0YSBfZGF0YSwKICAgICAgICB1aW50MjU2IF90aW1lc3RhbXAKICAgICkgZXh0ZXJuYWwgcGF5YWJsZSBvbmx5T3duZXIgcmV0dXJucyAoYnl0ZXMgbWVtb3J5KSB7CiAgICAgICAgYnl0ZXMzMiB0eElkID0gZ2V0VHhJZChfdGFyZ2V0LCBfdmFsdWUsIF9mdW5jLCBfZGF0YSwgX3RpbWVzdGFtcCk7CiAgICAgICAgaWYgKCFxdWV1ZWRbdHhJZF0pIHsKICAgICAgICAgICAgcmV2ZXJ0IE5vdFF1ZXVlZEVycm9yKHR4SWQpOwogICAgICAgIH0KICAgICAgICAvLyAtLS0tfC0tLS0tLS0tLS0tLS0tLS0tLS18LS0tLS0tLQogICAgICAgIC8vICB0aW1lc3RhbXAgICAgdGltZXN0YW1wICsgZ3JhY2UgcGVyaW9kCiAgICAgICAgaWYgKGJsb2NrLnRpbWVzdGFtcCA8IF90aW1lc3RhbXApIHsKICAgICAgICAgICAgcmV2ZXJ0IFRpbWVzdGFtcE5vdFBhc3NlZEVycm9yKGJsb2NrLnRpbWVzdGFtcCwgX3RpbWVzdGFtcCk7CiAgICAgICAgfQogICAgICAgIGlmIChibG9jay50aW1lc3RhbXAgPiBfdGltZXN0YW1wICsgR1JBQ0VfUEVSSU9EKSB7CiAgICAgICAgICAgIHJldmVydCBUaW1lc3RhbXBFeHBpcmVkRXJyb3IoCiAgICAgICAgICAgICAgICBibG9jay50aW1lc3RhbXAsIF90aW1lc3RhbXAgKyBHUkFDRV9QRVJJT0QKICAgICAgICAgICAgKTsKICAgICAgICB9CgogICAgICAgIHF1ZXVlZFt0eElkXSA9IGZhbHNlOwoKICAgICAgICAvLyBwcmVwYXJlIGRhdGEKICAgICAgICBieXRlcyBtZW1vcnkgZGF0YTsKICAgICAgICBpZiAoYnl0ZXMoX2Z1bmMpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgLy8gZGF0YSA9IGZ1bmMgc2VsZWN0b3IgKyBfZGF0YQogICAgICAgICAgICBkYXRhID0gYWJpLmVuY29kZVBhY2tlZChieXRlczQoa2VjY2FrMjU2KGJ5dGVzKF9mdW5jKSkpLCBfZGF0YSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gY2FsbCBmYWxsYmFjayB3aXRoIGRhdGEKICAgICAgICAgICAgZGF0YSA9IF9kYXRhOwogICAgICAgIH0KCiAgICAgICAgLy8gY2FsbCB0YXJnZXQKICAgICAgICAoYm9vbCBvaywgYnl0ZXMgbWVtb3J5IHJlcykgPSBfdGFyZ2V0LmNhbGx7dmFsdWU6IF92YWx1ZX0oZGF0YSk7CiAgICAgICAgaWYgKCFvaykgewogICAgICAgICAgICByZXZlcnQgVHhGYWlsZWRFcnJvcigpOwogICAgICAgIH0KCiAgICAgICAgZW1pdCBFeGVjdXRlKHR4SWQsIF90YXJnZXQsIF92YWx1ZSwgX2Z1bmMsIF9kYXRhLCBfdGltZXN0YW1wKTsKCiAgICAgICAgcmV0dXJuIHJlczsKICAgIH0KCiAgICBmdW5jdGlvbiBjYW5jZWwoYnl0ZXMzMiBfdHhJZCkgZXh0ZXJuYWwgb25seU93bmVyIHsKICAgICAgICBpZiAoIXF1ZXVlZFtfdHhJZF0pIHsKICAgICAgICAgICAgcmV2ZXJ0IE5vdFF1ZXVlZEVycm9yKF90eElkKTsKICAgICAgICB9CgogICAgICAgIHF1ZXVlZFtfdHhJZF0gPSBmYWxzZTsKCiAgICAgICAgZW1pdCBDYW5jZWwoX3R4SWQpOwogICAgfQp9Cg==" ref="nofollow noopener noreferrer">TimeLock.sol</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uos基础 autostart 设置程序开机自启动]]></title>    <link>https://juejin.cn/post/7592615536385490978</link>    <guid>https://juejin.cn/post/7592615536385490978</guid>    <pubDate>2026-01-08T13:39:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592615536385490978" data-draft-id="7592622563547201571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uos基础 autostart 设置程序开机自启动"/> <meta itemprop="keywords" content="运维"/> <meta itemprop="datePublished" content="2026-01-08T13:39:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="行初心"/> <meta itemprop="url" content="https://juejin.cn/user/4081803083395527"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uos基础 autostart 设置程序开机自启动
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4081803083395527/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    行初心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T13:39:19.000Z" title="Thu Jan 08 2026 13:39:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>统信桌面操作系统专业版V20（1070）<br/>
Linux uos 5.10.97-arm64-desktop</p>
</blockquote>
<h3 data-id="heading-0">uos基础 autostart 设置程序开机自启动</h3>
<pre><code class="hljs language-c" lang="c">code@uos:~$ ls
模板  Desktop  Documents  Downloads  Music  Pictures  Videos
code@uos:~$ ls -al
总用量 <span class="hljs-number">320</span>
drwxr-x--- <span class="hljs-number">21</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .
drwxr-xr-x  <span class="hljs-number">4</span> root root   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">18</span> ..
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">9</span>月  <span class="hljs-number">15</span> <span class="hljs-number">10</span>:<span class="hljs-number">45</span> 模板
-rw-r--r--  <span class="hljs-number">1</span> code code     <span class="hljs-number">86</span> <span class="hljs-number">11</span>月  <span class="hljs-number">9</span>  <span class="hljs-number">2024</span> .bash_aliases
-rw-r--r--  <span class="hljs-number">1</span> code code    <span class="hljs-number">220</span> <span class="hljs-number">2</span>月  <span class="hljs-number">25</span>  <span class="hljs-number">2024</span> .bash_logout
-rw-r--r--  <span class="hljs-number">1</span> code code   <span class="hljs-number">3748</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> .bashrc
drwxr-xr-x  <span class="hljs-number">8</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .cache
drwxr-xr-x <span class="hljs-number">16</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .config
drwx------  <span class="hljs-number">3</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .dbus
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .deepin-defender
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> Desktop
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> Documents
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> Downloads
drwx------  <span class="hljs-number">3</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .gnupg
-rw-r--r--  <span class="hljs-number">1</span> code code     <span class="hljs-number">27</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .gtkrc<span class="hljs-number">-2.0</span>
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .hplip
drwxr-xr-x  <span class="hljs-number">3</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> .icons
-rw-r--r--  <span class="hljs-number">1</span> code code <span class="hljs-number">194683</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .kwin.<span class="hljs-built_in">log</span>
drwxr-xr-x  <span class="hljs-number">3</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> .local
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> Music
drwxr-xr-x  <span class="hljs-number">3</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> Pictures
drwx------  <span class="hljs-number">3</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .pki
-rw-r--r--  <span class="hljs-number">1</span> code code    <span class="hljs-number">807</span> <span class="hljs-number">2</span>月  <span class="hljs-number">25</span>  <span class="hljs-number">2024</span> .profile
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> .Public
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> .Templates
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .themes
drwxr-xr-x  <span class="hljs-number">2</span> code code   <span class="hljs-number">4096</span> <span class="hljs-number">6</span>月  <span class="hljs-number">12</span>  <span class="hljs-number">2024</span> Videos
-rw-r--r--  <span class="hljs-number">1</span> code code    <span class="hljs-number">205</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .wget-hsts
-rw-------  <span class="hljs-number">1</span> code code      <span class="hljs-number">1</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .Xauthority
-rw-------  <span class="hljs-number">1</span> code code   <span class="hljs-number">9346</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .xsession-errors
-rw-r--r--  <span class="hljs-number">1</span> code code   <span class="hljs-number">1753</span> <span class="hljs-number">10</span>月 <span class="hljs-number">28</span> <span class="hljs-number">15</span>:<span class="hljs-number">19</span> .xwayland.<span class="hljs-built_in">log</span>
code@uos:~$ cd .config/
code@uos:~/.config$ ls
autostart               deepin      google-chrome       pipewire-media-session  user-dirs.dirs
autostop                deepinwmrc  gtk<span class="hljs-number">-3.0</span>             pulse
com.huawei.pcmanager    dsg         kcminputrc          SogouPY
dconf                   enchant     kglobalshortcutsrc  systemd
dde-first-run.log_code  fcitx       kwinrc              Trolltech.conf
</code></pre>
<pre><code class="hljs language-c" lang="c">code@uos:~/.config$ cd autostart/
code@uos:~/.config/autostart$ ls
code@uos:~/.config/autostart$ cp /home/code/Desktop/uos-service-support.desktop .
code@uos:~/.config/autostart$ ls
uos-service-support.desktop
code@uos:~/.config/autostart$ 

</code></pre>
<ul>
<li>cp之时，会有一个确认弹窗。</li>
<li>这样做的效果是，设置"服务与支持"为开机自启动的程序</li>
<li>特意重启试了一把，成功了</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54b23823c158438ea5dc013db4a7bda4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6KGM5Yid5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768484359&amp;x-signature=c%2F2ioRpWCFSOQa4V5Bmm%2F5XoJv4%3D" alt="uos-autostart-config-1.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 钩子全集实战（五）：ApplicationContextInitializer详解]]></title>    <link>https://juejin.cn/post/7592829037937475599</link>    <guid>https://juejin.cn/post/7592829037937475599</guid>    <pubDate>2026-01-08T14:36:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592829037937475599" data-draft-id="7592622563547332643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 钩子全集实战（五）：ApplicationContextInitializer详解"/> <meta itemprop="keywords" content="Java,面试,Spring"/> <meta itemprop="datePublished" content="2026-01-08T14:36:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Web天梯之路"/> <meta itemprop="url" content="https://juejin.cn/user/2825061103052843"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 钩子全集实战（五）：ApplicationContextInitializer详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2825061103052843/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Web天梯之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T14:36:55.000Z" title="Thu Jan 08 2026 14:36:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在上一篇中，我们深入剖析了 <strong><code>SpringApplicationRunListener.environmentPrepared()</code></strong> 这一关键扩展点，实现了环境合法性校验、启动上下文传递、多环境隔离兜底与配置动态增强等高阶能力。今天，我们将进入 Spring Boot 启动生命周期的下一个重要阶段——<strong>容器初始化前的关键扩展点</strong>：<code>ApplicationContextInitializer</code>。</p>
<h2 data-id="heading-0">一、什么是 <code>ApplicationContextInitializer</code>？</h2>
<p><code>ApplicationContextInitializer</code> 是 Spring 框架原生提供的接口，在 Spring Boot 中被广泛用于 <strong>在 <code>ApplicationContext</code> 初始化完成前、刷新前（refresh 前）对容器进行定制化配置</strong>。其触发时机具有如下特征：</p>
<ul>
<li><strong>触发时机</strong>：<code>ApplicationContext</code> 已创建但尚未调用 <code>refresh()</code>；</li>
<li><strong>核心状态</strong>：<code>Environment</code> 已完全准备就绪，所有配置已生效；</li>
<li><strong>执行顺序</strong>：晚于 <code>environmentPrepared()</code>，早于 <code>BeanFactoryPostProcessor</code>；</li>
<li><strong>核心能力</strong>：可注册 Bean、修改 Bean 定义、设置容器属性、注入自定义逻辑。</li>
</ul>
<blockquote>
<p>✅ <strong>核心价值</strong>：在容器刷新前对 <code>ApplicationContext</code> 做最后的“预热”和“定制”，是实现容器级扩展、安全加固、AOP 注入、监控埋点等场景的核心入口。</p>
</blockquote>
<h2 data-id="heading-1">二、场景 ：容器安全加固（禁止危险 Bean 注入）</h2>
<h3 data-id="heading-2">业务痛点</h3>
<p>微服务架构下，部分第三方库或内部组件可能通过自动配置注入高危 Bean（如 <code>Runtime</code>、<code>ScriptEngine</code>、<code>JndiTemplate</code>），存在远程代码执行（RCE）风险。即使通过配置禁用，仍可能因依赖传递或版本升级被意外激活。</p>
<h3 data-id="heading-3">解决方案</h3>
<p>利用 <code>ApplicationContextInitializer</code> 在容器刷新前扫描并移除/替换高危 Bean 定义，从源头阻断安全隐患。</p>
<h4 data-id="heading-4">实现代码</h4>
<pre><code class="hljs language-ini" lang="ini">package com.example.demo.initializer<span class="hljs-comment">;</span>
​
import org.springframework.beans.factory.config.ConfigurableListableBeanFactory<span class="hljs-comment">;</span>
import org.springframework.beans.factory.support.BeanDefinitionBuilder<span class="hljs-comment">;</span>
import org.springframework.beans.factory.support.BeanDefinitionRegistry<span class="hljs-comment">;</span>
import org.springframework.beans.factory.support.DefaultListableBeanFactory<span class="hljs-comment">;</span>
import org.springframework.context.ApplicationContextInitializer<span class="hljs-comment">;</span>
import org.springframework.context.ConfigurableApplicationContext<span class="hljs-comment">;</span>
import org.springframework.context.annotation.ClassPathScanningCandidateComponentProvider<span class="hljs-comment">;</span>
import org.springframework.core.type.filter.AssignableTypeFilter<span class="hljs-comment">;</span>
import org.springframework.jndi.JndiTemplate<span class="hljs-comment">;</span>
import org.springframework.util.StringUtils<span class="hljs-comment">;</span>
​
import javax.naming.InitialContext<span class="hljs-comment">;</span>
import javax.script.ScriptEngine<span class="hljs-comment">;</span>
import java.util.Arrays<span class="hljs-comment">;</span>
import java.util.HashSet<span class="hljs-comment">;</span>
import java.util.Set<span class="hljs-comment">;</span>
​
/**
 * 容器安全加固初始化器
 */
public class SecurityHardeningInitializer implements ApplicationContextInitializer&lt;ConfigurableApplicationContext&gt; {
​
    // 高危类黑名单（可根据安全策略动态加载）
    private static final Set&lt;String&gt; <span class="hljs-attr">DANGEROUS_BEAN_TYPES</span> = new HashSet&lt;&gt;(Arrays.asList(
            "javax.script.ScriptEngine",
            "javax.naming.InitialContext",
            "org.springframework.jndi.JndiTemplate",
            "java.lang.Runtime"
    ))<span class="hljs-comment">;</span>
​
    @Override
    public void initialize(ConfigurableApplicationContext applicationContext) {
        System.out.println("<span class="hljs-section">[安全加固]</span> 开始扫描并清理高危 Bean 定义")<span class="hljs-comment">;</span>
​
        //构造高危类黑名单的类
        if (applicationContext instanceof BeanDefinitionRegistry registry) {
            BeanDefinitionBuilder <span class="hljs-attr">builder1</span> = BeanDefinitionBuilder.genericBeanDefinition(ScriptEngine.class)<span class="hljs-comment">;</span>
            BeanDefinitionBuilder <span class="hljs-attr">builder2</span> = BeanDefinitionBuilder.genericBeanDefinition(InitialContext.class)<span class="hljs-comment">;</span>
            BeanDefinitionBuilder <span class="hljs-attr">builder3</span> = BeanDefinitionBuilder.genericBeanDefinition(JndiTemplate.class)<span class="hljs-comment">;</span>
            BeanDefinitionBuilder <span class="hljs-attr">builder4</span> = BeanDefinitionBuilder.genericBeanDefinition(Runtime.class)<span class="hljs-comment">;</span>
            // 注册BeanDefinition
            registry.registerBeanDefinition("scriptEngine", builder1.getBeanDefinition())<span class="hljs-comment">;</span>
            registry.registerBeanDefinition("initialContext", builder2.getBeanDefinition())<span class="hljs-comment">;</span>
            registry.registerBeanDefinition("jndiTemplate", builder3.getBeanDefinition())<span class="hljs-comment">;</span>
            registry.registerBeanDefinition("runtime", builder4.getBeanDefinition())<span class="hljs-comment">;</span>
        }
​
        DefaultListableBeanFactory <span class="hljs-attr">beanFactory</span> = (DefaultListableBeanFactory) applicationContext.getBeanFactory()<span class="hljs-comment">;</span>
        String<span class="hljs-section">[]</span> <span class="hljs-attr">beanNames</span> = beanFactory.getBeanDefinitionNames()<span class="hljs-comment">;</span>
​
        for (String beanName : beanNames) {
            var <span class="hljs-attr">beanDefinition</span> = beanFactory.getBeanDefinition(beanName)<span class="hljs-comment">;</span>
            String <span class="hljs-attr">beanClassName</span> = beanDefinition.getBeanClassName()<span class="hljs-comment">;</span>
​
            if (StringUtils.hasText(beanClassName) &amp;&amp; DANGEROUS_BEAN_TYPES.contains(beanClassName)) {
                System.err.printf("<span class="hljs-section">[安全加固]</span> 检测到高危 Bean：%s（类型：%s），已移除！%n", beanName, beanClassName)<span class="hljs-comment">;</span>
                beanFactory.removeBeanDefinition(beanName)<span class="hljs-comment">;</span>
            }
        }
​
        // 禁止通过 @Import 或 ComponentScan 自动注册高危类
        disableDangerousScanning(applicationContext)<span class="hljs-comment">;</span>
​
        System.out.println("<span class="hljs-section">[安全加固]</span> 容器安全加固完成")<span class="hljs-comment">;</span>
    }
​
    /**
     * 禁用高危类的组件扫描（防止后续自动注册）
     */
    private void disableDangerousScanning(ConfigurableApplicationContext context) {
        ClassPathScanningCandidateComponentProvider <span class="hljs-attr">scanner</span> =
                new ClassPathScanningCandidateComponentProvider(false)<span class="hljs-comment">;</span>
        scanner.addIncludeFilter(new AssignableTypeFilter(Runtime.class))<span class="hljs-comment">;</span>
        // 实际生产中可结合 AspectJ 或字节码工具拦截，此处仅作示意
        System.out.println("<span class="hljs-section">[安全加固]</span> 已禁用高危类自动扫描（需配合编译期检查）")<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h4 data-id="heading-5">配置方式（任选其一）</h4>
<p><strong>方式 1：通过 <code>spring.factories</code></strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># resources/META-INF/spring.factories</span>
<span class="hljs-attr">org.springframework.context.ApplicationContextInitializer</span>=\
com.example.demo.initializer.SecurityHardeningInitializer
</code></pre>
<p><strong>方式 2：通过主类显式注册</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DemoApplication</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-title class_">SpringApplication</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringApplication</span>(<span class="hljs-title class_">DemoApplication</span>.<span class="hljs-property">class</span>);
        app.<span class="hljs-title function_">addInitializers</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityHardeningInitializer</span>());
        app.<span class="hljs-title function_">run</span>(args);
    }
}
</code></pre>
<h4 data-id="heading-6">输出结果</h4>
<pre><code class="hljs language-less" lang="less">  .   <span class="hljs-selector-tag">____</span>          <span class="hljs-selector-tag">_</span>            <span class="hljs-selector-tag">__</span> <span class="hljs-selector-tag">_</span> <span class="hljs-selector-tag">_</span>
 /\ / <span class="hljs-selector-tag">___</span>'<span class="hljs-selector-tag">_</span> <span class="hljs-selector-tag">__</span> <span class="hljs-selector-tag">_</span> <span class="hljs-selector-tag">_</span>(_)<span class="hljs-selector-tag">_</span> <span class="hljs-selector-tag">__</span>  <span class="hljs-selector-tag">__</span> <span class="hljs-selector-tag">_</span> \ \ \ \
( ( )___ | <span class="hljs-string">'_ | '</span>_| | '_ / _` | \ \ \ \
 \/  ___)| |<span class="hljs-selector-tag">_</span>)| | | | | || (_| |  ) ) ) )
  '  |<span class="hljs-selector-tag">____</span>| <span class="hljs-selector-class">.__</span>|<span class="hljs-selector-tag">_</span>| |<span class="hljs-selector-tag">_</span>|<span class="hljs-selector-tag">_</span>| |<span class="hljs-selector-tag">___</span>, | / / / /
 =========|<span class="hljs-selector-tag">_</span>|==============|<span class="hljs-selector-tag">___</span>/=/<span class="hljs-selector-tag">_</span>/<span class="hljs-selector-tag">_</span>/<span class="hljs-selector-tag">_</span>/
​
 :: <span class="hljs-selector-tag">Spring</span> <span class="hljs-selector-tag">Boot</span> ::                (v3.<span class="hljs-number">5.8</span>)
​
<span class="hljs-selector-attr">[安全加固]</span> 开始扫描并清理高危 <span class="hljs-selector-tag">Bean</span> 定义
<span class="hljs-selector-attr">[安全加固]</span> 已禁用高危类自动扫描（需配合编译期检查）
<span class="hljs-selector-attr">[安全加固]</span> 容器安全加固完成
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.580</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.DemoApplication</span>         : <span class="hljs-selector-tag">Starting</span> <span class="hljs-selector-tag">DemoApplication</span> <span class="hljs-selector-tag">using</span> <span class="hljs-selector-tag">Java</span> <span class="hljs-number">21.0</span><span class="hljs-selector-class">.9</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">PID</span> <span class="hljs-number">11158</span> (/Users/wangmingfei/Documents/个人/<span class="hljs-number">05</span> java天梯之路/<span class="hljs-number">01</span> 源码/<span class="hljs-number">03</span> 每日打卡系列/daily-check-in/springboot钩子/demo/target/classes started by wangmingfei in /Users/wangmingfei/Documents/个人/<span class="hljs-number">05</span> java天梯之路/<span class="hljs-number">01</span> 源码/<span class="hljs-number">03</span> 每日打卡系列/daily-check-in/springboot钩子/demo)
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.581</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.DemoApplication</span>         : <span class="hljs-selector-tag">The</span> <span class="hljs-selector-tag">following</span> <span class="hljs-number">1</span> <span class="hljs-selector-tag">profile</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">active</span>: "<span class="hljs-selector-tag">prod</span>"
<span class="hljs-selector-attr">[安全加固]</span> 检测到高危 <span class="hljs-selector-tag">Bean</span>：<span class="hljs-selector-tag">scriptEngine</span>（类型：<span class="hljs-selector-tag">javax</span><span class="hljs-selector-class">.script</span><span class="hljs-selector-class">.ScriptEngine</span>），已移除！
<span class="hljs-selector-attr">[安全加固]</span> 检测到高危 <span class="hljs-selector-tag">Bean</span>：<span class="hljs-selector-tag">initialContext</span>（类型：<span class="hljs-selector-tag">javax</span><span class="hljs-selector-class">.naming</span><span class="hljs-selector-class">.InitialContext</span>），已移除！
<span class="hljs-selector-attr">[安全加固]</span> 检测到高危 <span class="hljs-selector-tag">Bean</span>：<span class="hljs-selector-tag">jndiTemplate</span>（类型：<span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.jndi</span><span class="hljs-selector-class">.JndiTemplate</span>），已移除！
<span class="hljs-selector-attr">[安全加固]</span> 检测到高危 <span class="hljs-selector-tag">Bean</span>：<span class="hljs-selector-tag">runtime</span>（类型：<span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.Runtime</span>），已移除！
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.876</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">o</span><span class="hljs-selector-class">.s</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.w</span><span class="hljs-selector-class">.embedded</span><span class="hljs-selector-class">.tomcat</span><span class="hljs-selector-class">.TomcatWebServer</span>  : <span class="hljs-selector-tag">Tomcat</span> <span class="hljs-selector-tag">initialized</span> <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">port</span> <span class="hljs-number">8080</span> (http)
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.882</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">o</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.catalina</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.StandardService</span>   : <span class="hljs-selector-tag">Starting</span> <span class="hljs-selector-tag">service</span> <span class="hljs-selector-attr">[Tomcat]</span>
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.883</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">o</span><span class="hljs-selector-class">.apache</span><span class="hljs-selector-class">.catalina</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.StandardEngine</span>    : <span class="hljs-selector-tag">Starting</span> <span class="hljs-selector-tag">Servlet</span> <span class="hljs-selector-tag">engine</span>: <span class="hljs-selector-attr">[Apache Tomcat/10.1.49]</span>
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.901</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">o</span><span class="hljs-selector-class">.a</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-class">.C</span>.<span class="hljs-selector-attr">[Tomcat]</span>.<span class="hljs-selector-attr">[localhost]</span>.<span class="hljs-selector-attr">[/]</span>       : <span class="hljs-selector-tag">Initializing</span> <span class="hljs-selector-tag">Spring</span> <span class="hljs-selector-tag">embedded</span> <span class="hljs-selector-tag">WebApplicationContext</span>
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">06.901</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">w</span><span class="hljs-selector-class">.s</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-class">.ServletWebServerApplicationContext</span> : <span class="hljs-selector-tag">Root</span> <span class="hljs-selector-tag">WebApplicationContext</span>: <span class="hljs-selector-tag">initialization</span> <span class="hljs-selector-tag">completed</span> <span class="hljs-selector-tag">in</span> <span class="hljs-number">303</span> <span class="hljs-selector-tag">ms</span>
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">07.038</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">o</span><span class="hljs-selector-class">.s</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.w</span><span class="hljs-selector-class">.embedded</span><span class="hljs-selector-class">.tomcat</span><span class="hljs-selector-class">.TomcatWebServer</span>  : <span class="hljs-selector-tag">Tomcat</span> <span class="hljs-selector-tag">started</span> <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">port</span> <span class="hljs-number">8080</span> (http) <span class="hljs-selector-tag">with</span> <span class="hljs-selector-tag">context</span> <span class="hljs-selector-tag">path</span> '/'
<span class="hljs-number">2025</span><span class="hljs-selector-tag">-12-17T23</span>:<span class="hljs-number">58</span>:<span class="hljs-number">07.042</span>+<span class="hljs-number">08</span>:<span class="hljs-number">00</span>  <span class="hljs-selector-tag">INFO</span> <span class="hljs-number">11158</span> <span class="hljs-selector-tag">---</span> <span class="hljs-selector-attr">[           main]</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.demo</span><span class="hljs-selector-class">.DemoApplication</span>         : <span class="hljs-selector-tag">Started</span> <span class="hljs-selector-tag">DemoApplication</span> <span class="hljs-selector-tag">in</span> <span class="hljs-number">0.645</span> <span class="hljs-selector-tag">seconds</span> (process running for <span class="hljs-number">0.792</span>)
</code></pre>
<h4 data-id="heading-7">生产价值</h4>
<ul>
<li>从容器层面拦截高危 Bean，比运行时检测更早、更彻底；</li>
<li>防止因依赖升级或配置错误引入安全漏洞；</li>
</ul>
<h2 data-id="heading-8">三、总结</h2>
<p><code>ApplicationContextInitializer</code> 是 Spring Boot 启动流程中 <strong>连接环境准备与容器刷新的关键桥梁</strong>，它与 <code>environmentPrepared()</code> 形成“环境 → 容器”的完整扩展链路，是构建企业级高可靠、高安全、高可观测性应用不可或缺的一环。</p>
<p>📌 <strong>关注我</strong>，每天 5 分钟，带你从 Java 小白变身编程高手！</p>
<p>👉 点赞 + 关注 + 转发，让更多小伙伴一起进步！</p>
<p>👉 私信 "SpringBoot 钩子源码" 获取完整源码！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解Python控制流：从if-else到结构模式匹配，写出更优雅的条件判断逻辑]]></title>    <link>https://juejin.cn/post/7592615536385703970</link>    <guid>https://juejin.cn/post/7592615536385703970</guid>    <pubDate>2026-01-08T15:17:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592615536385703970" data-draft-id="7592622563547430947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解Python控制流：从if-else到结构模式匹配，写出更优雅的条件判断逻辑"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-08T15:17:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="love_summer"/> <meta itemprop="url" content="https://juejin.cn/user/1462819851084228"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解Python控制流：从if-else到结构模式匹配，写出更优雅的条件判断逻辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1462819851084228/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    love_summer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T15:17:16.000Z" title="Thu Jan 08 2026 15:17:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin:30px 0 10px;color:#cca152;position:relative;padding-left:50px;border-bottom:2px solid rgba(209,163,78,.6);padding-bottom:0}.markdown-body h1{font-size:30px}.markdown-body h1:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:80%;bottom:-10px;left:-2px}.markdown-body h2{font-size:24px}.markdown-body h2:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:70%;bottom:-15px;left:-1px}.markdown-body h3{font-size:18px}.markdown-body h3:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:60%;bottom:-19px;left:-2px}.markdown-body h4{font-size:16px;padding-left:0;border-bottom:1px solid rgba(209,163,78,.6)}.markdown-body h5{font-size:15px;padding-left:0}.markdown-body em{color:#cca152}.markdown-body del{text-decoration-color:#cca152;text-decoration-thickness:2px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:80%;margin:6px auto;box-shadow:0 6px 15px #8e8e8e;display:block;margin:20px auto!important;object-fit:contain;border-radius:8px}.markdown-body hr{border:none;border-top:2px solid #e0c9a1;margin-top:32px 0}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background:#f6efde;color:#b69454;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Mono,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;background:#fef6e1;border-radius:4px;box-shadow:0 0 8px hsla(0,0%,47%,.45)}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAOCAMAAABaWb9VAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAADsQAAA7EAZUrDhsAAACHUExURUdwTMxCKdc8NvdYT/9hVyLJPABBAGubKNiIOv+/K+ytJBakH9aZG+5QR5VZDOBDPhmtJ8+VGuGjH/CwJR26MR6+NBq0LPW1KBmwKetNRfJUTONHP92fHuSmIeFEPhu3LR29M/BTS+mqIuqsI5qdHyLKPP++Kv9gVf9lW//KLSXXQCTQP//FLMVm5KQAAAAldFJOUwAlPPz7+woBBPu8Mzu+FlRRKmvnweeG+Wqg6mVNXmuc1OCbmjZJWF/9AAABKklEQVQoz3WS6XaCMBCFRzAM++KGsqhtDwES3//5OtmA2uP9A9zwzRoAgBC0QgQrdA68OZsDr229YGHoIEj7Pl0ZOgjKa5lYJ4Rd1vijn3nuD4Qurjmv48o6RFyfbGDnS6DeEXZfk5ZfuBhdPb9I87ECNMh1EFJKIU6agWzaa01NbmLkxznSmmObJBkkUxrERf3i+ftRiZi7ShPCYY64UhTx1AR5CDYoMXkOKEY7GmTcTzeD/FiER68DfSLgSRqEIBoB3P8h3x8RZhBXGJGusJdD6rfCBl0YqvZNkrV9zej2cWlfJWG6fRpyM41qYH+GTPPi2yFLQYC0Qybm5o96lW77kMbcrBKtgeWTsthVamNXFF4I6x0DTPuugsVRFyYpyxzWqNvHJwed8ws7QyP1UwjNjwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fef6e1}.markdown-body a{text-decoration:none;color:#d8ac5a;border-bottom:1px solid #d8ac5a}.markdown-body a:active,.markdown-body a:hover{color:#93753f;border-color:#93753f}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f4e8c7;border-collapse:collapse}.markdown-body thead{background:rgba(255,227,176,.6588235294);text-align:left;display:table-header-group;border-bottom:1px solid rgba(255,227,176,.6588235294)}.markdown-body tbody{background:rgba(255,247,229,.3882352941)}.markdown-body td,.markdown-body th{padding:7px;line-height:24px;min-width:100px}.markdown-body blockquote{color:#bd954f;padding:1px 23px;margin:22px 0;border-left:4px solid #dcb267;background-color:#fff7e5}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol .task-list-item,.markdown-body ul .task-list-item{list-style:none}.markdown-body ol li{padding-left:6px}.markdown-body::marker{color:#dcb267}.markdown-body .contains-task-list{padding-left:0}.markdown-body .contains-task-list .task-list-item{list-style:none;position:relative}.markdown-body .contains-task-list .task-list-item input[type=checkbox]{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:before{content:"";display:inline-block;height:12px;width:12px;position:absolute;left:-2px;top:-2px;border:2px solid #cda152;border-radius:5px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked:before{border:none;content:"";display:inline-block;height:17px;width:17px;position:absolute;left:-2px;top:-2px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAAAXNSR0IArs4c6QAAAYhJREFUOBFjYACC0/MDGsDEiyvr/zOCeUwMJxn/A8HZRUEMYBFGJsZ6kFoQYALiAyAGCgDpA+sFijKeWRj4H1kWpIWBW1SDQcm+BCzOAiK/vr7BcO/gDbAAI4hE1waWgRBnmWCGIwkyKFjnwow0BhsJk9QLncvw5dV1oPE9MCEGmBWrgCKhcFEowyR+PSNYwemFAZ4M/xjMkRWYJm5oAPFB/joDpI1BHHQANgGPDxj+//vfCA4IdJ3GcevgQnAFhlHLwYIgSVA0wABcwY3tFQzokiBFGIEP0wmigW5wZAK5FFkQib0a6NUDcEmgb7AGFpIGZOZqoMFhIAFQknEAJpn9yLLEssFOBCp2IFaDkl0xg6C8FbJyB3gowUS5RdQYBORQYpVB1iwVHIIMwJh///AYTCmYRklNIBFmNi4GeYt0BhnjeIa3dw8wSBlEgDUhxw2yCRgGfHp2geHiqiSwUwUVrFAiFVkjjA1LrjgTHEwhFvosMCZM4NEIUoAtWWNoBGZ70/gN22HiAD2uhAzsYNBZAAAAAElFTkSuQmCC) 0 0 no-repeat;background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>引言</strong><br/>
编写条件判断语句是每位程序员的基本功。但你是否想过，如何写出一行<strong>可读性高</strong>、<strong>性能优</strong>、<strong>无隐患</strong>的<code>if</code>代码？今天，我将结合《跟着娟子姐学Python》的学习，与大家深入探讨Python中的选择结构，并分享一些进阶写法和避坑指南。</p>
</blockquote>
<h3 data-id="heading-0">一、单分支if：简洁与陷阱</h3>
<p>单分支结构是最基础的逻辑。但初学者容易在布尔值判断上出错。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 推荐写法：逻辑清晰</span>
<span class="hljs-keyword">if</span> is_logged_in:
    do_something()
<span class="hljs-comment"># 不推荐的写法：多余的==True</span>
<span class="hljs-keyword">if</span> is_logged_in == <span class="hljs-literal">True</span>:
    do_something()
</code></pre>
<p><strong>进阶点：对象布尔值的巧妙利用</strong></p>
<p>在示例4-2中，我们可以利用非0数值、非空序列的布尔值为<code>True</code>这一特性，写出非常简洁的代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 利用 not 判断偶数</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> n % <span class="hljs-number">2</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{n}</span>是偶数"</span>)
<span class="hljs-comment"># 利用本身判断非空字符串</span>
<span class="hljs-keyword">if</span> input_str:  <span class="hljs-comment"># 如果input_str不是空字符串</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"用户输入了内容"</span>)
</code></pre>
<h3 data-id="heading-1">二、双分支if-else：避免深嵌套</h3>
<p>双分支结构非常常见。但一个经常被忽视的问题是如何避免代码中的**“箭头形”嵌套**（Arrow-shaped code）。</p>
<p><strong>【示例】糟糕的嵌套 vs 优雅的卫语句</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 🚫 不推荐：嵌套过深，可读性差</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_data</span>(<span class="hljs-params">data</span>):
    <span class="hljs-keyword">if</span> data:
        <span class="hljs-keyword">if</span> validate(data):
            <span class="hljs-keyword">if</span> process(data):
                <span class="hljs-keyword">return</span> <span class="hljs-string">"处理成功"</span>
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"处理失败"</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-string">"数据校验失败"</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"数据为空"</span>
<span class="hljs-comment"># ✅ 推荐：使用卫语句提前返回/异常，结构扁平</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_data</span>(<span class="hljs-params">data</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> data:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"数据为空"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> validate(data):
        <span class="hljs-keyword">return</span> <span class="hljs-string">"数据校验失败"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> process(data):
        <span class="hljs-keyword">return</span> <span class="hljs-string">"处理失败"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"处理成功"</span>
</code></pre>
<blockquote>
<p><strong>【解释】</strong> 这种将异常或失败条件前置的写法，叫“卫语句”，能极大提高代码的可维护性。</p>
</blockquote>
<h3 data-id="heading-2">三、多分支if-elif-else：选择最佳结构</h3>
<p>当需要处理多种条件时，<code>if-elif-else</code> 是不二之选。但需要注意的是，<strong>Python中的<code>elif</code>是有顺序性的，且一旦命中就会短路后续判断</strong>。</p>
<p><strong>【示例4-4】成绩划分的优化</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># ✅ 最佳实践：从上往下写，互斥区间</span>
score = <span class="hljs-number">85</span>
<span class="hljs-keyword">if</span> score &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> score &gt; <span class="hljs-number">100</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'无效成绩'</span>)
<span class="hljs-keyword">elif</span> score &lt; <span class="hljs-number">60</span>:      <span class="hljs-comment"># 0 &lt;= score &lt; 60</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'E'</span>)
<span class="hljs-keyword">elif</span> score &lt; <span class="hljs-number">70</span>:      <span class="hljs-comment"># 60 &lt;= score &lt; 70</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'D'</span>)
<span class="hljs-keyword">elif</span> score &lt; <span class="hljs-number">80</span>:      <span class="hljs-comment"># 70 &lt;= score &lt; 80</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'C'</span>)
<span class="hljs-keyword">elif</span> score &lt; <span class="hljs-number">90</span>:      <span class="hljs-comment"># 80 &lt;= score &lt; 90</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'B'</span>)
<span class="hljs-keyword">else</span>:               <span class="hljs-comment"># 90 &lt;= score &lt;= 100</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'A'</span>)
</code></pre>
<blockquote>
<p><strong>【注意】</strong> 多个条件区间必须<strong>无重叠且覆盖全集</strong>，否则会产生逻辑漏洞。</p>
</blockquote>
<h3 data-id="heading-3">四、逻辑运算符：and、or的执行顺序与优先级</h3>
<p>在使用<code>and</code>和<code>or</code>组合复杂条件时，必须明确<strong>运算符优先级</strong>：<code>not</code> &gt; <code>and</code> &gt; <code>or</code>。</p>
<p><strong>【示例】优先级陷阱</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 🚫 容易产生歧义的写法</span>
<span class="hljs-keyword">if</span> x &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> y &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> z &gt; <span class="hljs-number">10</span>:
    <span class="hljs-keyword">pass</span>
<span class="hljs-comment"># ✅ 强调优先级的写法</span>
<span class="hljs-keyword">if</span> (x &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> y &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">or</span> (z &gt; <span class="hljs-number">10</span>):
    <span class="hljs-keyword">pass</span>
<span class="hljs-comment"># 🚀 更好的写法：一行代码解决，可读性更高</span>
<span class="hljs-keyword">if</span> <span class="hljs-built_in">any</span>([x &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> y &lt; <span class="hljs-number">0</span>, z &gt; <span class="hljs-number">10</span>]):
    <span class="hljs-keyword">pass</span>
</code></pre>
<blockquote>
<p><strong>【思考】</strong> 使用内置函数 <code>any()</code> 和 <code>all()</code> 可以将复杂的逻辑组合转化为更函数式的写法，非常Pythonic。</p>
</blockquote>
<h3 data-id="heading-4">五、实战心得：编写健壮的条件判断逻辑</h3>
<ol>
<li><strong>使用枚举代替魔法值</strong>：在<code>if</code>中直接比较<code>status == 1</code>和<code>status == 2</code>是糟糕的实践。定义一个<code>Status</code>枚举，用<code>Status.SUCCESS</code>替代<code>1</code>。</li>
<li><strong>避免重复计算</strong>：如果判断条件中有函数调用，如 <code>if is_valid(data) and compute(data):</code>，<code>compute(data)</code> 无论如何都会执行。更好的方式是：
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> is_valid(data):
    <span class="hljs-keyword">if</span> compute(data):
        <span class="hljs-comment"># ...</span>
</code></pre>
</li>
<li><strong>善用字典分发</strong>：当<code>if-elif</code>链过长，且每个分支执行的操作类似（只是参数不同）时，可以考虑用字典替代。
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 🚫 if-elif链</span>
<span class="hljs-keyword">if</span> cmd == <span class="hljs-string">'start'</span>:
    handle_start()
<span class="hljs-keyword">elif</span> cmd == <span class="hljs-string">'stop'</span>:
    handle_stop()
<span class="hljs-comment"># ...</span>

<span class="hljs-comment"># ✅ 字典分发</span>
handlers = {<span class="hljs-string">'start'</span>: handle_start, <span class="hljs-string">'stop'</span>: handle_stop}
<span class="hljs-keyword">if</span> cmd <span class="hljs-keyword">in</span> handlers:
    handlers[cmd]()
</code></pre>
</li>
</ol>
<h3 data-id="heading-5">总结</h3>
<p>选择结构是程序逻辑的基石。掌握其基础用法是开始，但写出<strong>清晰、健壮、Pythonic</strong>的条件判断代码，才是高级程序员的追求。希望本篇文章的进阶视角能给你带来一些启发！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据翻译官凭啥高效？嵌入式 NanoPb 揭晓]]></title>    <link>https://juejin.cn/post/7592622563547250723</link>    <guid>https://juejin.cn/post/7592622563547250723</guid>    <pubDate>2026-01-08T13:56:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592622563547250723" data-draft-id="7592622563547037731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据翻译官凭啥高效？嵌入式 NanoPb 揭晓"/> <meta itemprop="keywords" content="嵌入式,物联网,单片机"/> <meta itemprop="datePublished" content="2026-01-08T13:56:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="迷人的星空"/> <meta itemprop="url" content="https://juejin.cn/user/977890073916588"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据翻译官凭啥高效？嵌入式 NanoPb 揭晓
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/977890073916588/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    迷人的星空
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T13:56:14.000Z" title="Thu Jan 08 2026 13:56:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>一、它到底是什么</strong></h3>
<p>嵌入式NanoPb是一个专为<strong>单片机、物联网终端等资源受限设备</strong>量身定制的“<strong>数据翻译官</strong>”和“<strong>协议制定器</strong>”。它的核心任务，是把设备内部复杂的、结构化的数据（比如传感器的温度、时间、状态），用一种<strong>极度紧凑、高效且不挑硬件的二进制语言</strong>打包、传输，并能让接收方准确无误地理解。</p>
<p>你可以把它想象成：</p>
<ul>
<li><strong>为“小货车”设计的“标准化货箱”</strong> ：相比用大小不一的“纸箱”（自定义格式）或塞满泡沫的“大箱子”（JSON/XML），它提供了最适合小货车运输的、严丝合缝的集装箱。</li>
<li><strong>设备间的“摩尔斯电码”</strong> ：它制定了一套非常简洁高效的编码规则，让设备之间可以用最少的“滴答”声（数据字节）传达丰富、准确的信息。</li>
</ul>
<h3 data-id="heading-1"><strong>二、它是如何工作的？</strong></h3>
<p>其工作原理可以概括为  <strong>“一套工具，两次转换”</strong>  。它不是在单片机上现场翻译，而是先在功能强大的PC上<strong>生成一套专用的“翻译手册”</strong> ，然后让单片机照着手册机械地执行。</p>
<p><strong>第一步：制定“数据契约”（.proto文件）</strong><br/>
工程师在电脑上用一种叫 <strong>Protocol Buffers</strong> 的语言，定义一个 <code>.proto</code> 文件。这个文件不包含任何具体数据，只定义<strong>数据的结构</strong>，是所有参与方必须遵守的“契约”。</p>
<pre><code class="hljs language-ini" lang="ini">// 示例：定义一个传感器数据的“契约”
<span class="hljs-attr">syntax</span> = <span class="hljs-string">"proto2"</span><span class="hljs-comment">; // 使用proto2版本，控制更精细</span>
message SensorData {
    required uint32 <span class="hljs-attr">timestamp</span> = <span class="hljs-number">1</span><span class="hljs-comment">;  // 必填字段，编号为1</span>
    required float <span class="hljs-attr">temperature</span> = <span class="hljs-number">2</span><span class="hljs-comment">; // 必填字段，编号为2</span>
    optional float <span class="hljs-attr">humidity</span> = <span class="hljs-number">3</span><span class="hljs-comment">;    // 可选字段，编号为3</span>
    repeated int32 <span class="hljs-attr">samples</span> = <span class="hljs-number">4</span> [max_count = <span class="hljs-number">20</span>]<span class="hljs-comment">; // 数组，最大长度20</span>
}
</code></pre>
<p><strong>关键</strong>：这里的字段编号（1，2，3，4）是编码和解码的唯一依据，取代了低效的字段名。</p>
<p><strong>第二步：生成“翻译手册”（C代码）</strong><br/>
使用专用的编译器工具（<code>protoc</code> + NanoPb插件），根据上一步的 <code>.proto</code> 契约，生成纯C代码文件（<code>.pb.c</code> 和 <code>.pb.h</code>）。这个生成的代码就是单片机的“翻译手册”。</p>
<p>生成的头文件中，会包含一个可以直接在C程序中使用的结构体：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 生成的C结构体，与.proto契约一一对应</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> {
    <span class="hljs-type">uint32_t</span> timestamp;
    <span class="hljs-type">float</span> temperature;
    <span class="hljs-type">bool</span> has_humidity; <span class="hljs-comment">// 标志位，指示humidity字段是否有值</span>
    <span class="hljs-type">float</span> humidity;
    <span class="hljs-type">pb_size_t</span> samples_count; <span class="hljs-comment">// 实际数组长度</span>
    <span class="hljs-type">int32_t</span> samples[<span class="hljs-number">20</span>];     <span class="hljs-comment">// 静态数组，长度由max_count固定</span>
} SensorData;
</code></pre>
<p><strong>第三步：在设备上执行“翻译”</strong></p>
<ol>
<li><strong>编码（发送数据）</strong> ：设备程序中，填充好SensorData结构体，然后调用 <code>pb_encode()</code> 函数。该函数会像一台高效的打包机，严格按照“翻译手册”，将结构体中的每个字段转换成极简的二进制序列，放入你指定的发送缓冲区。</li>
<li><strong>解码（接收数据）</strong> ：从通信接口（如UART）收到一串二进制数据后，调用 <code>pb_decode()</code> 函数。该函数会按照同一份“手册”，将二进制流精准地还原填充到另一个SensorData结构体中，供程序使用。</li>
</ol>
<p><strong>高效的核心秘密</strong>：它采用了  <strong>“标签-长度-值”</strong>  和  <strong>“变长整数”</strong>  两大编码技术。</p>
<ul>
<li><strong>标签</strong>：用字段编号代替字段名。</li>
<li><strong>变长整数</strong>：对于较小的数字，只用1个字节存储；大的数字才用更多字节。这使得像 <code>timestamp</code> 这样的数据在大部分情况下体积都远小于固定的4字节。</li>
</ul>
<h3 data-id="heading-2"><strong>三、为什么选择它？</strong></h3>
<ol>
<li><strong>极致的空间效率</strong>：编码后的数据体积通常只有JSON的 <strong>1/3甚至更小</strong>，这对于按字节计费的NB-IoT、LoRa等低带宽网络至关重要，能直接<strong>降低功耗、延长电池寿命</strong>。</li>
<li><strong>确定性的内存使用</strong>：默认模式下，<strong>不使用任何动态内存分配（malloc）</strong> 。所有内存（如数组 <code>samples[20]</code>）都在编译时确定，避免了内存碎片和泄漏，这对嵌入式系统的稳定性和可靠性是生命线。</li>
<li><strong>无歧义的协议契约</strong>：<code>.proto</code> 文件是设备端和服务器/手机端<strong>唯一、权威的协议文档</strong>。双方基于同一份文件生成代码，彻底消除了因手写文档不一致导致的通信故障。</li>
<li><strong>强大的向前/向后兼容性</strong>：只要遵循“新增字段用optional/repeated，永不重用字段号”的规则，新版本的程序可以读取旧版本的数据（忽略新字段），旧版本的程序也能读取新版本的数据（忽略不认识的字段），为固件升级带来巨大便利。</li>
</ol>
<h3 data-id="heading-3"><strong>四、它的天生“短板”</strong></h3>
<p>没有任何技术是银弹，NanoPb的强大伴随着明确的代价和约束：</p>
<ul>
<li>
<p><strong>增加构建复杂度</strong>：必须在PC上配置工具链（<code>protoc</code>编译器），并集成代码生成步骤到项目的构建系统（如Makefile, CMake）中。这增加了初始的学习和搭建成本。</p>
</li>
<li>
<p><strong>需要预规划内存</strong>：所有数组（<code>repeated</code>字段）的长度<strong>最好在编译时就确定上限</strong>（通过 <code>max_count</code>）。处理长度完全未知的动态数据会变得复杂（需用回调函数，可能引入动态分配）。</p>
</li>
<li>
<p><strong>不负责“运输”</strong> ：NanoPb只负责把“货物”（数据）打包成“集装箱”（二进制流），<strong>不负责</strong>集装箱的“装船”（添加帧头帧尾）、“运输保障”（CRC校验、重传）和“卸货”（从流中分割出完整数据包）。这些通信层的职责，必须由开发者额外完成。</p>
</li>
<li>
<p><strong>二进制不直观</strong>：编码后的数据人类无法直接阅读，调试时必须借助额外的十六进制查看工具或解码程序。</p>
</li>
<li>
<p><strong>严谨的跨平台细节</strong>：</p>
<ul>
<li><strong>浮点数陷阱</strong>：直接内存拷贝编码，要求通信双方的CPU使用<strong>相同的浮点数格式（通常是IEEE 754）和字节序</strong>，否则会解码出错误数值。</li>
<li><strong>默认值陷阱</strong>：解码时，如果发送方没给某个 <code>optional</code> 字段赋值，接收方结构体里该字段的值是<strong>未初始化的内存残留</strong>！必须通过配套生成的 <code>has_xxx</code> 布尔标志来判断该字段是否有效。</li>
<li><strong>内存对齐陷阱</strong>：绝对不能把C结构体直接 <code>memcpy</code> 发送！结构体中有内存对齐的“填充字节”，而 <code>pb_encode</code> 生成的二进制流是紧密无填充的。直接拷贝结构体会导致通信失败。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4"><strong>五、典型应用场景</strong></h3>
<p>NanoPb的价值在以下场景中最为凸显：</p>
<ol>
<li><strong>电池供电的物联网传感终端</strong>：例如，每5分钟通过NB-IoT上报一次数据的温湿度计。将数据包从JSON的50字节压缩至15字节，能显著减少无线模块发射时长，是<strong>提升设备续航（有时可达数倍）的关键手段</strong>。</li>
<li><strong>嵌入式设备间的可靠通信</strong>：在通过UART、CAN或I2C连接的主控板与多个功能模块之间，使用NanoPb定义清晰、可扩展的指令与数据协议，比脆弱的自定义格式更健壮，且易于迭代。</li>
<li><strong>固件无线升级</strong>：用于传输升级包的“元数据”（如版本号、大小、CRC、分区地址）。其紧凑性和版本兼容性，非常适合在带宽有限且要求可靠的OTA过程中作为控制协议。</li>
<li><strong>设备配置参数存储</strong>：将设备的数百个可调参数定义为一个 <code>message</code>，存储到Flash中。升级固件后，旧参数文件仍能被安全读取（新加的参数取默认值），实现配置的平滑迁移。</li>
</ol>
<h3 data-id="heading-5"><strong>六、总结</strong></h3>
<p>总而言之，嵌入式NanoPb是一个典型的  <strong>“以工具链和设计时的复杂性，换取运行时极致效率和长期可维护性”</strong>  的工程解决方案。</p>
<ul>
<li>
<p><strong>何时应该积极采用？</strong></p>
<ul>
<li>你的设备<strong>对通信带宽、功耗有严苛限制</strong>。</li>
<li>你的数据协议<strong>结构复杂且未来很可能需要增减字段</strong>。</li>
<li>你的项目涉及<strong>多平台（设备、手机、云）数据交换</strong>，需要一份无歧义的协议核心。</li>
<li>你的团队有能力<strong>搭建并维护包含代码生成的自动化构建流程</strong>。</li>
</ul>
</li>
<li>
<p><strong>何时应该谨慎或避免？</strong></p>
<ul>
<li>你的数据<strong>极其简单且永不变更</strong>（例如永远只发两个整数），直接打包发送更简单。</li>
<li>你的设备<strong>RAM/ROM资源紧张到无法容纳额外的5-10KB代码体积</strong>。</li>
<li>你的项目<strong>开发周期极短，且没有后续维护需求</strong>，快速实现是第一要务。</li>
</ul>
</li>
</ul>
<p>对于大多数严肃的、有长期维护预期的嵌入式产品或物联网项目，NanoPb带来的协议严谨性、带宽节省和兼容性保障，其长远收益远超过初期引入的学习和构建成本。它是将嵌入式通信从“手工作坊”升级到“现代工程”的重要工具之一。</p>
<p>以上是个人的一些浅见，如有不当之处，欢迎批评指正。</p>
<p>这波内容真帮到你了？点个关注不迷路！专属工具箱持续更新，需要时直接翻、拿起来就用～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-207 如何应对多重共线性：使用线性回归中的最小二乘法时常见问题与解决方案]]></title>    <link>https://juejin.cn/post/7592876744526446642</link>    <guid>https://juejin.cn/post/7592876744526446642</guid>    <pubDate>2026-01-09T01:55:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592876744526446642" data-draft-id="7592876744526430258" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-207 如何应对多重共线性：使用线性回归中的最小二乘法时常见问题与解决方案"/> <meta itemprop="keywords" content="后端,大数据,机器学习"/> <meta itemprop="datePublished" content="2026-01-09T01:55:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-207 如何应对多重共线性：使用线性回归中的最小二乘法时常见问题与解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:55:52.000Z" title="Fri Jan 09 2026 01:55:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<p>在使用最小二乘法求解线性回归时，多重共线性会影响模型稳定性，导致系数估计不可靠。解决方法包括使用正则化技术（如岭回归、Lasso回归）。通过引入正则化项，可以有效避免矩阵不可逆问题，稳定回归结果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee1b2ef0a4ef4abba0a1f6cb88163ff6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=ZPkSpHRESzIihnHu5QTU82ZJMus%3D" alt="大数据-207 如何应对多重共线性：使用线性回归中的最小二乘法时常见问题与解决方案" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>






























<table><thead><tr><th>功能</th><th>scikit-learn 版本</th><th>说明</th></tr></thead><tbody><tr><td>线性回归</td><td>0.24+</td><td>支持标准的线性回归模型训练与评估</td></tr><tr><td>多重共线性处理</td><td>0.24+</td><td>通过岭回归、Lasso回归等方法解决共线性问题</td></tr><tr><td>MSE计算</td><td>0.24+</td><td>使用 mean_squared_error 计算模型误差</td></tr><tr><td>R²计算</td><td>0.24+</td><td>使用 r2_score 评估模型拟合度</td></tr></tbody></table>
<h2 data-id="heading-2">代码实现</h2>
<p>使用 scikit-learn 算法库实现线性回归算法，并计算相应评价指标。回顾前文介绍的相关知识进行下述计算。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LinearRegression
reg = LinearRegression()
reg.fit(data.iloc[:,:-<span class="hljs-number">1</span>].values,data.iloc[:,-<span class="hljs-number">1</span>].values)
reg.coef_ <span class="hljs-comment"># 查看方程系数</span>
reg.intercept_ <span class="hljs-comment"># 查看系数</span>
</code></pre>
<p>对比手动计算的 ws，其结果高度一致。
然后计算模型 MSE 和判别系数：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> sklearn.metrics <span class="hljs-keyword">import</span> mean_squared_error,r2_score
yhat = reg.predict(data.iloc[:,:-<span class="hljs-number">1</span>])
mean_squared_error(y,yhat)
r2_score(y,yhat)
</code></pre>
<h2 data-id="heading-3">多重共线性</h2>
<p>虽然在线性回归求解过程中，通过借助最小二乘法能够迅速找到全域最优解，但最小二乘法本身的使用条件较为苛刻。这种方法要求设计矩阵X必须满足严格的条件才能保证解的稳定性和唯一性。</p>
<p>具体来说，最小二乘法的应用必须满足以下关键条件：</p>
<ol>
<li>矩阵X^TX必须是满秩矩阵（即行列式不为零）</li>
<li>矩阵X^TX必须可逆或存在广义逆矩阵</li>
</ol>
<p>在实际应用中，经常会遇到以下导致最小二乘法失效的情况：</p>
<ul>
<li>当样本量n小于特征数p时（n&lt;p），矩阵X^TX必然是奇异矩阵</li>
<li>当X的各列存在严格或近似的线性相关关系时（即多重共线性问题）</li>
<li>当数据中存在高度相关的特征变量时</li>
</ul>
<p>特别是当遇到多重共线性问题时，最小二乘法的求解会面临以下挑战：</p>
<ol>
<li>参数估计值变得极不稳定，小的数据扰动可能导致估计值发生巨大变化</li>
<li>参数估计的方差会异常增大</li>
<li>解可能不唯一，存在无穷多解的情况</li>
</ol>
<p>例如，在经济学数据分析中，当使用GDP、居民收入和消费支出等多个高度相关的指标作为预测变量时，就很容易出现上述问题。此时传统的OLS（普通最小二乘）估计将无法给出可靠的结果。</p>
<p>针对这些问题，统计学家们发展出了多种改进方法，包括：</p>
<ul>
<li>岭回归（Ridge Regression）</li>
<li>Lasso回归</li>
<li>主成分回归（PCR）</li>
<li>偏最小二乘回归（PLSR）</li>
</ul>
<p>这些方法通过引入正则化项或降维技术，可以有效处理矩阵不可逆和多重共线性问题，从而获得更稳定可靠的回归结果。</p>
<p>这里需要注意是，在进行数据采集的过程中，数据集各列是对同一个客观事物进行客观描述，很难避免多重共线性的存在，因此存在共线性是很多数据集的一般情况。当然更为极端的情况则是数据集的列比行多，此时最小二乘法无法对其进行求解。因此，寻找性回归算法的优化方案势在必行。
首先我们来了解多重共性，在第二节中我们曾推导了多元线性回归使用最小二乘法的求解原理，我们对多元线性回归的损失函数求导，并得出求解系数 w 得式子和过程：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc86aef3df53474eb612606dfc0e6a34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=SMl37ydX6%2Bo8COTnipTzIXSOduI%3D" alt="多重共线性" loading="lazy"/>
在最后一步中我们需要左乘 XTX 的逆矩阵，而矩阵存在得充分必要条件是特征不存在多重共线性。</p>
<h3 data-id="heading-4">矩阵存在的充分必要条件</h3>
<p>首先，我们需要先理解逆矩阵存在与否的意义和影响，一个矩阵什么情况下会有逆矩阵？
根据逆矩阵的定理，若 |A| != 0，则矩阵A 可逆，且：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25208597f65344f498bcfcf2cb9622ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=GJpmKDFqlEqQl7PPYOTZhO9HqOI%3D" alt="矩阵存在的充分必要条件" loading="lazy"/></p>
<p>其中 A* 是矩阵 A 的伴随矩阵，任何矩阵都可以有伴随矩阵，因此这一部分不影响逆矩阵的存在性，而分母上行列式｜A｜就不同了，位于分母变量不能为 0，一旦为 0 则无法计算出逆矩阵。因此逆矩阵存在的充分必要条件是：矩阵的行列式不能为 0，对于线性回归而言，即是说｜XTX｜不能为 0，这是使用最小二乘法求解线性回归的核心条件之一。</p>
<h3 data-id="heading-5">行列式不为 0 的充分必要条件</h3>
<p>那行列式不为 0，需要满足什么条件？在这里，我们复习一下线性代数中的基本知识，假设我们的特征矩阵 X结构为（m,n），则 XTX 就是结构为（n,m）的矩阵，从而得到结果为（n,n）的矩阵。</p>
<p>因此以下所有的例子都将以方矩阵进行举例，方便大家理解，首先区别一下矩阵和行列式：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e28d55cdc2514a7489125f3d1c48a2a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=wRYi81mHSN3JFtC8zoEy7hjmFec%3D" alt="行列式不为 0 的充分必要条件" loading="lazy"/></p>
<p>任何矩阵都可以有行列式，以一个 3*3 的行列式为例，我们来看看行列式如何计算的？
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e0e64a8b362400e95b5f73b1592c047~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=RPSC%2BScIG57Gyvn9UpapgDT10ag%3D" alt="行列式不为 0 的充分必要条件" loading="lazy"/>
这个式子乍一看非常混乱，其实并非如此，我们把行列式按照下面的方式排列一下，很容易就看出这个式子实际上怎么回事了：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9ce5577193b45fbbb065490933059b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=%2FbnEDPfWez87EqxR1pzIyBY0EF4%3D" alt="行列式不为 0 的充分必要条件" loading="lazy"/>
三个特征的特征矩阵的行列式就有六个交互项，在现实中我们特征矩阵不可能是如此低维度数据，因此使用这样的方式计算就变得异常困难。在线性代数中，我们可以通过行列式的计算将一个行列式整合成一个梯形的行列式：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a223788064a4f999911a234950d73eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=aEWgHitzeCsM5crDApe%2BkD%2FxLtQ%3D" alt="行列式不为 0 的充分必要条件" loading="lazy"/>
梯形的行列式表现为，所有的数字都被整合到对角线的上方或下方（通常是上方），虽然具体的数字发生了变化（比如由 x11 变成了 a11），但是行列式的大小在初等行变换的过程中是不变的，对于梯形行列式，行列式的计算要容易的多：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21dc357d85cf42e49024b3b9b9205ece~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=3F6tST6zsPG%2Fh9aPbVtuh82VZNg%3D" alt="行列式不为 0 的充分必要条件" loading="lazy"/>
不难发现，由于梯形行列式下半部分为 0，整个矩阵的行列式其实就是梯形行列式对角线上的元素相乘。并且此时时刻，只要对角线上的任意元素为 0，整个行列式都会为 0，那只要对角线上没有一个元素为 0，行列式就不会为 0。在这里我们映入一个重要的概念：满秩矩阵。</p>
<h3 data-id="heading-6">矩阵满秩的充分必要条件</h3>
<p>一个矩阵要满秩，则转换为梯形矩阵后的对角线上没有 0，那什么样的矩阵在对角线上没有 0？来看下面的三个矩阵：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91cb6ac683874dcc9554f0e1feb1d122~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=otwxhffWqpi384Q9D8QZCqq5K1E%3D" alt="矩阵满秩的充分必要条件" loading="lazy"/>
我们可以对矩阵做初等行变换和列变换，包括交换行/列顺序，将一列/一行乘以用一个常数后加减到另一个一列/一行上，来将矩阵化为梯形矩阵，对于上面的两个矩阵我们可以有如下变换：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/624037b7aabc4805b52f1d072f4ecb07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=LNc8ehvaXnWD%2Bmmw9aL9iogEtyk%3D" alt="矩阵满秩的充分必要条件" loading="lazy"/>
继续进行变换：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f44774174a74c5d95132cc8bffe88ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=uwRuRSKdEu27aacjnThz0CDycp0%3D" alt="矩阵满秩的充分必要条件" loading="lazy"/>
如此就转换成了梯形矩阵，我们可以看到，矩阵 A 明显不是满秩的，它有全零行所以行列式会为 0，而矩阵 B 和 C 没有全零行所以满秩。
而矩阵 A 和矩阵 B 的区别在于，A 中存在完全具有线性关系的两行（1,1,2 和 2,2,4），而 B 和 C 中则没有这样的两行。
而矩阵 B 虽然对角线上每个元素都不为 0，但具有非常接近于 0 的元素 0.02，而矩阵 C 的对角线上没有任何元素特别接近于 0。</p>
<p>矩阵 A 中第一行和第三行的关系，被称为：精确相关关系，即完全相关，一行可使另一行为 0，在这种精确相关关系下，矩阵 A 的行列式为 0，则矩阵 A 的逆不可能存在。在我们的最小二乘法中，如果矩阵 XTX 中存在这种精确相关关系，则逆不存在，最小二乘法完全无法使用，线性回归会无法求出结果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e55a47b76baa4a31ac6327f7e8771f3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=HG%2BHGDUSsINN7V%2F17h9piEZtN6Q%3D" alt="矩阵 A" loading="lazy"/>
矩阵 B 中第一行和第三行的关系不太一样，他们之间非常接近于精确相关关系，但又不是完全相关，一行不能使领一行为 0，这种关系被称为 高度相关关系。这种高度相关关系下，矩阵的行列式不为 0，但是一个非常接近 0 数，矩阵 A 的逆存在，不过接近于无限大。在这种情况下，最小二乘法可以使用，不过得到的逆会很大，直接影响我们对参数向量 w 的求解：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64d0c658b5e846f0b938a3586e54bff6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=J6p7rBBnbGZrFTI9l%2BJPWyD292o%3D" alt="矩阵 B" loading="lazy"/>
这样求解出来的参数向量 w 会很大，因此会影响建模的结果，造成模型有偏差或者不可用。精确相关关系和高度相关关系并称为多重共线性。在多重共线性下，模型无法建立，或者模型不可用。
相对的，矩阵 C 的行之间结果相互独立，梯形矩阵看起来非常正常，它的对角线上没有任何元素特别接近于 0，因此其行列式也就不会接近0 或者为 0，因此矩阵 C 得出的参数向量 w 就不会有太大的偏差，对于我们拟合而言是比较理想的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f6e97ce1c96496497c37f1da74465aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=uwvSzX6mWYVBrzztfbcmSYErr%2B8%3D" alt="参数向量" loading="lazy"/>
从上面的所有过程我们可以看得出来，一个矩阵如果要满秩，则要求矩阵中每个向量之间不能存在多重共线性，这也构成了线性回归算法对于特征矩阵的要求。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fa915b8edf14ff68ab4c06637657047~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528552&amp;x-signature=f2k%2FMcr7gEFcpH4%2FA4IgPV%2BNrWU%3D" alt="参数向量" loading="lazy"/></p>
<h2 data-id="heading-7">错误速查</h2>



































<table><thead><tr><th>症状</th><th>根因</th><th>定位</th><th>修复</th></tr></thead><tbody><tr><td>模型参数估计不稳定</td><td>数据中存在多重共线性，导致设计矩阵 X^T X 不可逆</td><td>检查特征变量之间是否存在线性相关关系</td><td>使用岭回归、Lasso回归等正则化方法来稳定解</td></tr><tr><td>模型方差过大</td><td>矩阵 X^T X 近似奇异或共线性问题</td><td>查看矩阵的行列式，确认是否接近零</td><td>引入正则化项，如岭回归，来减少参数方差</td></tr><tr><td>预测结果误差较大</td><td>多重共线性导致解的不唯一性</td><td>确认特征变量是否高度相关，尤其是输入数据集</td><td>使用主成分回归（PCR）或偏最小二乘回归（PLSR）</td></tr><tr><td>解不唯一</td><td>矩阵 X^T X 为奇异矩阵，无法求逆</td><td>检查输入数据集的特征数是否大于样本数（n&lt;p）</td><td>减少特征数，或使用正则化方法来规避该问题</td></tr></tbody></table>
<h2 data-id="heading-8">其他系列</h2>
<h3 data-id="heading-9">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-10">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-218 RocketMQ Java API 实战：同步/异步 Producer 与 Pull/Push Consumer</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS已完结，GuavaCache已完结，EVCache已完结，RabbitMQ已完结，RocketMQ正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-11">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎥解决前端 “复现难”：rrweb 录制回放从入门到精通（下）]]></title>    <link>https://juejin.cn/post/7592815497848930367</link>    <guid>https://juejin.cn/post/7592815497848930367</guid>    <pubDate>2026-01-09T01:56:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592815497848930367" data-draft-id="7592508079306670099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎥解决前端 “复现难”：rrweb 录制回放从入门到精通（下）"/> <meta itemprop="keywords" content="前端,开源,全栈"/> <meta itemprop="datePublished" content="2026-01-09T01:56:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秋天的一阵风"/> <meta itemprop="url" content="https://juejin.cn/user/3588413946594925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎥解决前端 “复现难”：rrweb 录制回放从入门到精通（下）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3588413946594925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秋天的一阵风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:56:33.000Z" title="Fri Jan 09 2026 01:56:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong/></p><p align="center"><strong>Hello~大家好。我是秋天的一阵风</strong></p><p/>
<p>rrweb 的核心魅力在于 “用极小的数据量复现完整的页面操作”，这背后是 DOM 快照、增量更新、事件序列化等技术的精密协作。本文将从原理本质出发，用通俗类比 + 源码解析的方式，拆解每个技术模块的实现逻辑，同时揭示 rrweb 在兼容性、性能优化上的关键设计。</p>
<h2 data-id="heading-0">一、 DOM 快照生成原理（snapshot）</h2>
<p><strong>通俗类比</strong>：DOM 快照就像给页面拍 “全景工程图”—— 不是简单记录像素（如截图），而是把页面的 “骨架”（DOM 层级结构）、“皮肤”（CSS 样式）、“零件参数”（元素属性、文本内容）都转化为结构化数据，后续能根据这张 “工程图” 1:1 还原出与原页面一致的初始状态。区别于普通照片，这张 “工程图” 包含所有可编辑的 “零件信息”，而非固定的视觉图像。</p>
<h3 data-id="heading-1">1.1 核心目标与技术路径</h3>
<p>DOM 快照的核心目标是生成 “可序列化、可重建、体积小” 的 DOM 数据，技术路径分为三步：<strong>DOM 遍历与节点过滤</strong>→<strong>节点属性与样式序列化</strong>→<strong>资源引用处理</strong>，最终输出 JSON 格式的FullSnapshot事件（rrweb 事件类型标识为 2）。</p>
<h3 data-id="heading-2">1.2 关键实现逻辑（参考 rrweb-snapshot 源码）</h3>
<p><code>rrweb-snapshot</code> 库的 <code>takeSnapshot</code> 函数是快照生成的核心，关键步骤如下：</p>
<h4 data-id="heading-3">1.2.1 根节点遍历与过滤</h4>
<p>从<code>document.documentElement</code>（HTML 根节点）开始深度优先遍历，跳过无需录制的节点（如script、style标签，或带屏蔽类名的元素），避免无效数据占用空间：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：DOM节点遍历逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">traverseNode</span>(<span class="hljs-params">node, config</span>) {
  <span class="hljs-comment">// 过滤规则：跳过脚本、样式、屏蔽元素、不可见元素</span>
  <span class="hljs-keyword">const</span> isIgnored = 
    node.<span class="hljs-property">tagName</span> === <span class="hljs-string">'SCRIPT'</span> || 
    node.<span class="hljs-property">tagName</span> === <span class="hljs-string">'STYLE'</span> || 
    node.<span class="hljs-property">classList</span>.<span class="hljs-title function_">contains</span>(config.<span class="hljs-property">blockClass</span>) || 
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(node).<span class="hljs-property">display</span> === <span class="hljs-string">'none'</span>;
  <span class="hljs-keyword">if</span> (isIgnored) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  <span class="hljs-comment">// 序列化当前节点</span>
  <span class="hljs-keyword">const</span> nodeSnapshot = <span class="hljs-title function_">serializeNode</span>(node);
  <span class="hljs-comment">// 递归处理子节点（构建DOM树结构）</span>
  <span class="hljs-keyword">const</span> children = [];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> child <span class="hljs-keyword">of</span> node.<span class="hljs-property">childNodes</span>) {
    <span class="hljs-keyword">const</span> childSnapshot = <span class="hljs-title function_">traverseNode</span>(child, config);
    <span class="hljs-keyword">if</span> (childSnapshot) children.<span class="hljs-title function_">push</span>(childSnapshot);
  }
  nodeSnapshot.<span class="hljs-property">children</span> = children;
  <span class="hljs-comment">// 内联计算样式（确保回放样式一致）</span>
  <span class="hljs-title function_">inlineComputedStyle</span>(node, nodeSnapshot);
  <span class="hljs-keyword">return</span> nodeSnapshot;
}
</code></pre>
<h4 data-id="heading-4">1.2.2 节点序列化（serializeNode）</h4>
<p>提取节点关键属性，转化为 JSON 结构，重点处理元素节点与文本节点：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：节点序列化</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">serializeNode</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">const</span> snapshot = {
    <span class="hljs-attr">type</span>: node.<span class="hljs-property">nodeType</span>, <span class="hljs-comment">// 1=元素节点，3=文本节点，8=注释节点（跳过）</span>
  };
  <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-number">1</span>) { <span class="hljs-comment">// 元素节点</span>
    snapshot.<span class="hljs-property">tagName</span> = node.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toLowerCase</span>(); <span class="hljs-comment">// 统一小写（如DIV→div）</span>
    snapshot.<span class="hljs-property">attributes</span> = {};
    <span class="hljs-comment">// 收集核心属性（id、class、src、href等，跳过自定义无关属性）</span>
    <span class="hljs-keyword">const</span> coreAttrs = [<span class="hljs-string">'id'</span>, <span class="hljs-string">'class'</span>, <span class="hljs-string">'src'</span>, <span class="hljs-string">'href'</span>, <span class="hljs-string">'alt'</span>, <span class="hljs-string">'title'</span>, <span class="hljs-string">'value'</span>, <span class="hljs-string">'checked'</span>];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> attr <span class="hljs-keyword">of</span> node.<span class="hljs-property">attributes</span>) {
      <span class="hljs-keyword">if</span> (coreAttrs.<span class="hljs-title function_">includes</span>(attr.<span class="hljs-property">name</span>) || attr.<span class="hljs-property">name</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'data-'</span>)) {
        snapshot.<span class="hljs-property">attributes</span>[attr.<span class="hljs-property">name</span>] = attr.<span class="hljs-property">value</span>;
      }
    }
    <span class="hljs-comment">// 特殊处理表单元素（记录当前值，而非初始值）</span>
    <span class="hljs-keyword">if</span> ([<span class="hljs-string">'INPUT'</span>, <span class="hljs-string">'TEXTAREA'</span>, <span class="hljs-string">'SELECT'</span>].<span class="hljs-title function_">includes</span>(node.<span class="hljs-property">tagName</span>)) {
      snapshot.<span class="hljs-property">value</span> = node.<span class="hljs-property">value</span>;
      snapshot.<span class="hljs-property">checked</span> = node.<span class="hljs-property">checked</span> || <span class="hljs-literal">false</span>;
      snapshot.<span class="hljs-property">selectedIndex</span> = node.<span class="hljs-property">tagName</span> === <span class="hljs-string">'SELECT'</span> ? node.<span class="hljs-property">selectedIndex</span> : -<span class="hljs-number">1</span>;
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (node.<span class="hljs-property">nodeType</span> === <span class="hljs-number">3</span>) { <span class="hljs-comment">// 文本节点</span>
    snapshot.<span class="hljs-property">text</span> = node.<span class="hljs-property">textContent</span>.<span class="hljs-title function_">trim</span>() || <span class="hljs-string">''</span>; <span class="hljs-comment">// 过滤空文本，减少体积</span>
  }
  <span class="hljs-keyword">return</span> snapshot;
}
</code></pre>
<h4 data-id="heading-5">1.2.3 样式收集与内联</h4>
<p>页面样式可能来自link、style或内联style，为避免回放时样式丢失，rrweb 会将<strong>计算样式（computedStyle）</strong> 内联到节点快照中，同时过滤默认样式减少数据量：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：样式内联处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">inlineComputedStyle</span>(<span class="hljs-params">node, snapshot</span>) {
  <span class="hljs-keyword">const</span> computedStyle = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getComputedStyle</span>(node);
  <span class="hljs-keyword">const</span> styles = {};
  <span class="hljs-comment">// 仅收集影响视觉的关键样式属性（排除默认值）</span>
  <span class="hljs-keyword">const</span> criticalStyles = [
    <span class="hljs-string">'display'</span>, <span class="hljs-string">'position'</span>, <span class="hljs-string">'top'</span>, <span class="hljs-string">'left'</span>, <span class="hljs-string">'width'</span>, <span class="hljs-string">'height'</span>, 
    <span class="hljs-string">'color'</span>, <span class="hljs-string">'background'</span>, <span class="hljs-string">'font-size'</span>, <span class="hljs-string">'border'</span>, <span class="hljs-string">'padding'</span>, <span class="hljs-string">'margin'</span>
  ];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> prop <span class="hljs-keyword">of</span> criticalStyles) {
    <span class="hljs-keyword">const</span> value = computedStyle.<span class="hljs-title function_">getPropertyValue</span>(prop);
    <span class="hljs-comment">// 过滤默认样式（如div的display:block、body的margin:8px）</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isDefaultStyle</span>(snapshot.<span class="hljs-property">tagName</span>, prop, value)) {
      styles[prop] = value;
    }
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(styles).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    snapshot.<span class="hljs-property">styles</span> = styles; <span class="hljs-comment">// 仅当有非默认样式时才添加，减少体积</span>
  }
}
<span class="hljs-comment">// 辅助函数：判断是否为标签默认样式（基于rrweb内置的默认样式表）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isDefaultStyle</span>(<span class="hljs-params">tagName, prop, value</span>) {
  <span class="hljs-keyword">const</span> defaultStyles = {
    <span class="hljs-attr">div</span>: { <span class="hljs-attr">display</span>: <span class="hljs-string">'block'</span>, <span class="hljs-attr">margin</span>: <span class="hljs-string">'0'</span> },
    <span class="hljs-attr">body</span>: { <span class="hljs-attr">margin</span>: <span class="hljs-string">'8px'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'rgb(0, 0, 0)'</span> },
    <span class="hljs-attr">input</span>: { <span class="hljs-attr">border</span>: <span class="hljs-string">'1px solid rgb(169, 169, 169)'</span> }
    <span class="hljs-comment">// 其他标签默认样式...</span>
  };
  <span class="hljs-keyword">return</span> defaultStyles[tagName]?.[prop] === value;
}
</code></pre>
<h3 data-id="heading-6">1.3 技术难点与解决方案</h3>
<ul>
<li>
<p><strong>难点 1：样式体积过大与浏览器兼容性</strong></p>
<p>直接收集所有计算样式会导致数据量激增（单个元素可能有上百个样式属性），且不同浏览器默认样式存在差异（如 Chrome 与 Safari 的body默认margin不同）。</p>
<p><strong>解决方案</strong>：
① 仅收集 “影响视觉的关键样式”（如display、position），过滤无关样式（如webkit-font-smoothing）；</p>
<p>② 维护 “标签默认样式表”，仅记录与默认值不同的样式，数据量可减少 60% 以上；</p>
<p>③ 对浏览器私有前缀样式（如-webkit-border-radius）进行兼容处理，统一转化为标准样式。</p>
</li>
<li>
<p><strong>难点 2：跨域资源无法加载</strong></p>
<p>页面中的跨域图片（如 CDN 图片）、字体等资源，回放时可能因 CORS 限制无法加载，导致样式错乱。</p>
<p><strong>解决方案</strong>：</p>
</li>
<li>
<p>① 配置<code>inlineImages: true</code>时，将图片转化为 Base64 编码内联到快照中（适合小图片）；</p>
</li>
<li>
<p>② 对大图片，回放时通过 “同源代理服务” 转发请求（如后端部署代理接口，将跨域图片 URL 转为同源 URL）；</p>
</li>
<li>
<p>③ 记录资源加载失败时的降级样式（如图片占位符），确保回放体验一致。</p>
</li>
</ul>
<h3 data-id="heading-7">1.4 DOM 快照生成流程图</h3>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06c362ed5ffc430d93116711b56412e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL5aSp55qE5LiA6Zi16aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528593&amp;x-signature=Mi8sK5khRiJIu7UNyllRiks9Vlc%3D" alt="exported_image.png" width="70%" loading="lazy"/>
<h2 data-id="heading-8">二、增量更新机制（MutationObserver）</h2>
<p><strong>通俗类比</strong>：如果说 DOM 快照是 “初始工程图”，增量更新就是 “工程变更记录”—— 就像建筑施工时，不需要每次都重新绘制完整图纸，只需记录 <strong>“在 3 层增加 1 个窗户”</strong> <strong>“修改 2 层墙体颜色”</strong> 这类变化。</p>
<p>rrweb 通过监听 DOM 变化，只记录快照后的增量修改，大幅减少录制数据量。</p>
<h3 data-id="heading-9">2.1 核心技术：MutationObserver API</h3>
<p>rrweb 的增量更新完全依赖浏览器原生的MutationObserver API，该 API 可监听 DOM 树的 <strong>“节点变化、属性变化、文本变化”</strong> ，并<strong>异步批量触发回调</strong>（避免阻塞主线程）。</p>
<p>其核心优势：</p>
<ul>
<li>① 精准监听（可指定监听类型）；</li>
<li>② 批量处理（短时间内多次变化合并为一次回调）；</li>
<li>③ 性能友好（异步执行，不阻塞用户交互）。</li>
</ul>
<h3 data-id="heading-10">2.2 监听配置与事件转化</h3>
<p>rrweb 初始化时创建 <code>MutationObserver</code>实例，将原生变化事件转化为自定义的Mutation事件（rrweb 事件类型标识为 3），关键逻辑如下：</p>
<h4 data-id="heading-11">2.2.1 MutationObserver 初始化</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：rrweb中MutationObserver配置</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initMutationObserver</span>(<span class="hljs-params">emit, config</span>) {
  <span class="hljs-comment">// 回调函数：批量处理DOM变化</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">observerCallback</span> = (<span class="hljs-params">mutations</span>) =&gt; {
    <span class="hljs-comment">// 过滤无需记录的微小变化（如文本节点空字符修改）</span>
    <span class="hljs-keyword">const</span> validMutations = mutations.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">m</span> =&gt;</span> <span class="hljs-title function_">isMutationValid</span>(m, config));
    <span class="hljs-keyword">if</span> (validMutations.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-comment">// 批量转化为rrweb增量事件并发送</span>
    validMutations.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">mutation</span> =&gt;</span> {
      <span class="hljs-keyword">const</span> incrementalEvent = <span class="hljs-title function_">transformMutation</span>(mutation);
      <span class="hljs-title function_">emit</span>(incrementalEvent); <span class="hljs-comment">// 发送到事件队列，后续存储/上传</span>
    });
  };
  <span class="hljs-comment">// 监听配置：覆盖所有关键变化类型</span>
  <span class="hljs-keyword">const</span> observerConfig = {
    <span class="hljs-attr">childList</span>: <span class="hljs-literal">true</span>,          <span class="hljs-comment">// 监听子节点新增/删除</span>
    <span class="hljs-attr">attributes</span>: <span class="hljs-literal">true</span>,         <span class="hljs-comment">// 监听元素属性变化</span>
    <span class="hljs-attr">characterData</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 监听文本节点内容变化</span>
    <span class="hljs-attr">subtree</span>: <span class="hljs-literal">true</span>,            <span class="hljs-comment">// 深度监听（子树所有节点，不仅是直接子节点）</span>
    <span class="hljs-attr">attributeOldValue</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 记录属性变化前的旧值（便于回放时还原）</span>
    <span class="hljs-attr">characterDataOldValue</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 记录文本变化前的旧值</span>
  };
  <span class="hljs-comment">// 开始监听根节点</span>
  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MutationObserver</span>(observerCallback);
  observer.<span class="hljs-title function_">observe</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>, observerConfig);
  <span class="hljs-keyword">return</span> observer; <span class="hljs-comment">// 返回实例，便于后续停止监听</span>
}
<span class="hljs-comment">// 辅助函数：过滤无效变化（如屏蔽元素内的变化、空文本修改）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isMutationValid</span>(<span class="hljs-params">mutation, config</span>) {
  <span class="hljs-comment">// 屏蔽元素内的变化不记录</span>
  <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">target</span>.<span class="hljs-title function_">closest</span>(<span class="hljs-string">`.<span class="hljs-subst">${config.blockClass}</span>`</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 文本节点空字符修改不记录（如用户输入后删除为空）</span>
  <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'characterData'</span>) {
    <span class="hljs-keyword">return</span> mutation.<span class="hljs-property">oldValue</span>.<span class="hljs-title function_">trim</span>() !== <span class="hljs-string">''</span> || mutation.<span class="hljs-property">target</span>.<span class="hljs-property">textContent</span>.<span class="hljs-title function_">trim</span>() !== <span class="hljs-string">''</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h4 data-id="heading-12">2.2.2 原生变化事件转化（transformMutation）</h4>
<p>将浏览器原生的<code>MutationRecord</code>转化为 “可回放的结构化数据”，核心是明确 “变化目标、变化类型、变化内容”：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：转化原生MutationRecord</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">transformMutation</span>(<span class="hljs-params">mutation</span>) {
  <span class="hljs-keyword">const</span> event = {
    <span class="hljs-attr">type</span>: <span class="hljs-number">3</span>,                  <span class="hljs-comment">// Mutation事件类型标识</span>
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),    <span class="hljs-comment">// 事件发生时间戳（用于回放排序）</span>
    <span class="hljs-attr">data</span>: {}
  };
  <span class="hljs-comment">// 1. 子节点变化（新增/删除节点）</span>
  <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'childList'</span>) {
    event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'childList'</span>;
    <span class="hljs-comment">// 记录父节点路径（便于回放时定位目标父节点）</span>
    event.<span class="hljs-property">data</span>.<span class="hljs-property">parentPath</span> = <span class="hljs-title function_">getNodeUniquePath</span>(mutation.<span class="hljs-property">target</span>);
    <span class="hljs-comment">// 序列化新增/删除的节点（仅核心属性，减少体积）</span>
    event.<span class="hljs-property">data</span>.<span class="hljs-property">addedNodes</span> = mutation.<span class="hljs-property">addedNodes</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> <span class="hljs-title function_">serializeNode</span>(n)).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>);
    event.<span class="hljs-property">data</span>.<span class="hljs-property">removedNodes</span> = mutation.<span class="hljs-property">removedNodes</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> <span class="hljs-title function_">serializeNode</span>(n)).<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>);
    <span class="hljs-comment">// 记录插入位置参考节点（确保回放时插入顺序正确）</span>
    event.<span class="hljs-property">data</span>.<span class="hljs-property">nextSiblingId</span> = mutation.<span class="hljs-property">nextSibling</span> 
      ? <span class="hljs-title function_">getNodeUniqueId</span>(mutation.<span class="hljs-property">nextSibling</span>) 
      : <span class="hljs-literal">null</span>;
  }
  <span class="hljs-comment">// 2. 属性变化（如class、src修改）</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'attributes'</span>) {
    event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'attributes'</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">targetPath</span> = <span class="hljs-title function_">getNodeUniquePath</span>(mutation.<span class="hljs-property">target</span>);
    event.<span class="hljs-property">data</span>.<span class="hljs-property">attributeName</span> = mutation.<span class="hljs-property">attributeName</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">oldValue</span> = mutation.<span class="hljs-property">oldValue</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">newValue</span> = mutation.<span class="hljs-property">target</span>.<span class="hljs-title function_">getAttribute</span>(mutation.<span class="hljs-property">attributeName</span>);
  }
  <span class="hljs-comment">// 3. 文本变化（如span内文本修改）</span>
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mutation.<span class="hljs-property">type</span> === <span class="hljs-string">'characterData'</span>) {
    event.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'characterData'</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">targetPath</span> = <span class="hljs-title function_">getNodeUniquePath</span>(mutation.<span class="hljs-property">target</span>);
    event.<span class="hljs-property">data</span>.<span class="hljs-property">oldValue</span> = mutation.<span class="hljs-property">oldValue</span>;
    event.<span class="hljs-property">data</span>.<span class="hljs-property">newValue</span> = mutation.<span class="hljs-property">target</span>.<span class="hljs-property">textContent</span>;
  }
  <span class="hljs-keyword">return</span> event;
}
<span class="hljs-comment">// 辅助函数：生成节点唯一路径（如"body&gt;div.container&gt;ul&gt;li:nth-child(2)"）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getNodeUniquePath</span>(<span class="hljs-params">node</span>) {
  <span class="hljs-keyword">if</span> (node === <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'html'</span>;
  <span class="hljs-keyword">if</span> (node === <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'body'</span>;
  <span class="hljs-keyword">const</span> parentPath = <span class="hljs-title function_">getNodeUniquePath</span>(node.<span class="hljs-property">parentElement</span>);
  <span class="hljs-keyword">const</span> siblings = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(node.<span class="hljs-property">parentElement</span>.<span class="hljs-property">children</span>);
  <span class="hljs-comment">// 用"标签名+索引"确保唯一性（如li:nth-child(2)）</span>
  <span class="hljs-keyword">const</span> index = siblings.<span class="hljs-title function_">indexOf</span>(node) + <span class="hljs-number">1</span>;
  <span class="hljs-keyword">const</span> nodeName = node.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toLowerCase</span>();
  <span class="hljs-keyword">const</span> classAttr = node.<span class="hljs-property">classList</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> 
    ? <span class="hljs-string">`.<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(node.classList).join(<span class="hljs-string">'.'</span>)}</span>`</span> 
    : <span class="hljs-string">''</span>;
  <span class="hljs-keyword">const</span> idAttr = node.<span class="hljs-property">id</span> ? <span class="hljs-string">`#<span class="hljs-subst">${node.id}</span>`</span> : <span class="hljs-string">''</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${parentPath}</span>&gt;<span class="hljs-subst">${nodeName}</span><span class="hljs-subst">${idAttr}</span><span class="hljs-subst">${classAttr}</span>:nth-child(<span class="hljs-subst">${index}</span>)`</span>;
}
</code></pre>
<h3 data-id="heading-13">2.3 技术难点与解决方案</h3>
<ul>
<li>
<p><strong>难点 1：节点路径定位不准确</strong></p>
<p>增量变化需要明确 “哪个节点发生了变化”，但 DOM 节点没有天生的唯一标识，动态生成的节点（如 Vue 列表渲染的li）在刷新后路径可能变化，导致回放时无法定位目标节点。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p>① 生成 “唯一路径”（结合标签名、ID、类名、兄弟节点索引），如body&gt;div.container&gt;ul&gt;li:nth-child(2)，确保即使节点动态更新，仍能通过路径找到；</p>
</li>
<li>
<p>② 维护 “节点 ID 映射表”，录制时为每个节点分配临时 ID（如node.__rrwebId），回放时通过 ID 快速定位，路径作为降级方案（应对 ID 丢失场景）。</p>
</li>
</ul>
</li>
<li>
<p><strong>难点 2：高频变化导致性能卡顿</strong></p>
<p>页面中的高频 DOM 变化（如倒计时、动画、滚动加载列表）会触发MutationObserver频繁回调（如每秒几十次），导致前端主线程阻塞，影响用户交互体验。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>① 结合 “采样率控制”，对高频变化事件（如文本倒计时）进行节流处理（如 100ms 内仅记录 1 次变化）；</li>
<li>② 批量合并短时间内的同类变化（如 100ms 内的多次文本修改合并为 1 次）；</li>
<li>③ 过滤 “无意义变化”（如元素scrollTop的微小波动、空文本修改），减少事件数量。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-14">2.4 增量更新流程示意图</h3>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38213ded1a94417689424eaa9f67279f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL5aSp55qE5LiA6Zi16aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528593&amp;x-signature=qzF5MNVrmSzOBjSonF7tBbBHrlk%3D" alt="exported_image.png" width="70%" loading="lazy"/>
<h2 data-id="heading-15">三、事件捕获和序列化</h2>
<p><strong>通俗类比</strong>：如果说 DOM 快照是 “初始场景”，增量更新是 “场景变化”，那么事件捕获就是 “用户动作剧本”—— 就像电影拍摄时，不仅要搭建场景，还要记录演员的 “肢体动作”“台词”“表情”。</p>
<p>rrweb 需要捕获用户的点击、输入、滚动等交互动作，将其转化为结构化的 “剧本数据”，确保回放时能精准还原用户操作轨迹。</p>
<h3 data-id="heading-16">3.1 核心事件类型与捕获策略</h3>
<p>rrweb 主要捕获 6 类高频用户交互事件，覆盖 90% 以上的前端操作场景，采用 “全局事件委托 + 精准过滤” 的捕获策略，避免给每个节点绑定事件导致内存泄漏：</p>















































<table><thead><tr><th>事件类型</th><th>核心用途</th><th>关键数据字段</th><th>rrweb 事件类型标识</th></tr></thead><tbody><tr><td>鼠标点击（click）</td><td>记录按钮、链接等点击操作</td><td>点击坐标（x/y）、目标节点路径</td><td>4</td></tr><tr><td>键盘输入（keydown）</td><td>记录文本输入、功能键操作</td><td>按键码（keyCode）、输入内容、目标节点</td><td>5</td></tr><tr><td>鼠标移动（mousemove）</td><td>记录鼠标位置变化</td><td>鼠标坐标（x/y）、时间戳</td><td>6</td></tr><tr><td>滚动（scroll）</td><td>记录页面 / 元素滚动位置</td><td>滚动目标路径、scrollTop/scrollLeft</td><td>7</td></tr><tr><td>窗口 resize</td><td>记录窗口尺寸变化</td><td>窗口宽（width）、高（height）</td><td>8</td></tr><tr><td>表单提交（submit）</td><td>记录表单提交操作</td><td>表单节点路径、提交时间戳</td><td>9</td></tr></tbody></table>
<h3 data-id="heading-17">3.2 关键实现逻辑（全局事件委托）</h3>
<p>通过在document上绑定事件监听器，利用事件冒泡机制捕获所有子节点的交互，核心代码如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：rrweb事件捕获核心逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initEventCapture</span>(<span class="hljs-params">emit, config</span>) {
  <span class="hljs-comment">// 需捕获的事件类型与对应的处理函数</span>
  <span class="hljs-keyword">const</span> eventHandlers = {
    <span class="hljs-attr">click</span>: handleClick,
    <span class="hljs-attr">keydown</span>: handleKeydown,
    <span class="hljs-attr">mousemove</span>: handleMousemove,
    <span class="hljs-attr">scroll</span>: handleScroll,
    <span class="hljs-attr">resize</span>: handleResize,
    <span class="hljs-attr">submit</span>: handleSubmit
  };
  <span class="hljs-comment">// 绑定全局事件委托</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(eventHandlers).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[type, handler]</span>) =&gt;</span> {
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(type, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-comment">// 过滤规则：1. 屏蔽元素内的事件 2. 非用户触发的事件（如脚本触发的click）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isIgnoredEvent</span>(e, config)) <span class="hljs-keyword">return</span>;
      <span class="hljs-comment">// 处理事件并序列化为结构化数据</span>
      <span class="hljs-keyword">const</span> eventData = <span class="hljs-title function_">handler</span>(e, config);
      <span class="hljs-comment">// 发送事件（携带时间戳，确保回放顺序）</span>
      <span class="hljs-title function_">emit</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-title function_">getRRwebEventType</span>(type), <span class="hljs-comment">// 转化为rrweb事件标识</span>
        <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">data</span>: eventData
      });
    }, {
      <span class="hljs-attr">passive</span>: type === <span class="hljs-string">'scroll'</span> || type === <span class="hljs-string">'resize'</span>, <span class="hljs-comment">// passive优化：避免滚动阻塞</span>
      <span class="hljs-attr">capture</span>: <span class="hljs-literal">false</span> <span class="hljs-comment">// 冒泡阶段捕获，确保能获取最终目标节点</span>
    });
  });
}
<span class="hljs-comment">// 辅助函数：过滤无效事件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isIgnoredEvent</span>(<span class="hljs-params">e, config</span>) {
  <span class="hljs-comment">// 1. 屏蔽元素内的事件（如带.rr-block类名的元素）</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span>.<span class="hljs-title function_">closest</span>(<span class="hljs-string">`.<span class="hljs-subst">${config.blockClass}</span>`</span>)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 2. 排除脚本触发的事件（仅保留用户手动触发）</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">isTrusted</span> === <span class="hljs-literal">false</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-comment">// 3. 排除右键点击（contextmenu）和滚轮事件（默认不捕获）</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">type</span> === <span class="hljs-string">'click'</span> &amp;&amp; e.<span class="hljs-property">button</span> === <span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h3 data-id="heading-18">3.3 典型事件序列化实现（以键盘输入和滚动为例）</h3>
<p>不同事件的序列化重点不同，需针对性处理敏感数据（如密码）和冗余信息：</p>
<h4 data-id="heading-19">3.3.1 键盘输入事件（keydown）序列化</h4>
<p>需区分 “普通字符输入” 和 “功能键”，同时对密码等敏感输入进行掩码处理：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：键盘输入事件处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleKeydown</span>(<span class="hljs-params">e, config</span>) {
  <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>;
  <span class="hljs-comment">// 隐私处理：密码输入框且开启掩码，不记录真实内容</span>
  <span class="hljs-keyword">const</span> isPasswordInput = target.<span class="hljs-property">tagName</span> === <span class="hljs-string">'INPUT'</span> &amp;&amp; target.<span class="hljs-property">type</span> === <span class="hljs-string">'password'</span>;
  <span class="hljs-keyword">const</span> shouldMask = isPasswordInput &amp;&amp; config.<span class="hljs-property">maskInputPassword</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">targetPath</span>: <span class="hljs-title function_">getNodeUniquePath</span>(target), <span class="hljs-comment">// 目标输入框路径</span>
    <span class="hljs-attr">key</span>: shouldMask ? <span class="hljs-string">'*'</span> : e.<span class="hljs-property">key</span>, <span class="hljs-comment">// 敏感输入替换为*</span>
    <span class="hljs-attr">keyCode</span>: e.<span class="hljs-property">keyCode</span>, <span class="hljs-comment">// 按键码（回放时模拟输入需用到）</span>
    <span class="hljs-attr">value</span>: shouldMask ? <span class="hljs-string">'*'</span> : target.<span class="hljs-property">value</span>, <span class="hljs-comment">// 输入框当前值（非敏感场景）</span>
    <span class="hljs-attr">isFunctionalKey</span>: [<span class="hljs-string">'Enter'</span>, <span class="hljs-string">'Backspace'</span>, <span class="hljs-string">'Tab'</span>].<span class="hljs-title function_">includes</span>(e.<span class="hljs-property">key</span>) <span class="hljs-comment">// 是否为功能键</span>
  };
}
</code></pre>
<h4 data-id="heading-20">3.3.2 滚动事件（scroll）序列化</h4>
<p>需区分 “页面滚动” 和 “元素滚动”，避免重复记录高频滚动事件：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：滚动事件处理（含节流优化）</span>
<span class="hljs-keyword">let</span> lastScrollTime = <span class="hljs-number">0</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleScroll</span>(<span class="hljs-params">e, config</span>) {
  <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-comment">// 节流优化：50ms内仅记录1次，减少高频滚动导致的数据量</span>
  <span class="hljs-keyword">if</span> (now - lastScrollTime &lt; <span class="hljs-number">50</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  lastScrollTime = now;
  <span class="hljs-comment">// 区分页面滚动和元素滚动</span>
  <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span> === <span class="hljs-variable language_">document</span> ? <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span> : e.<span class="hljs-property">target</span>;
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">targetPath</span>: <span class="hljs-title function_">getNodeUniquePath</span>(target),
    <span class="hljs-attr">scrollTop</span>: target.<span class="hljs-property">scrollTop</span>,
    <span class="hljs-attr">scrollLeft</span>: target.<span class="hljs-property">scrollLeft</span>,
    <span class="hljs-attr">isPageScroll</span>: e.<span class="hljs-property">target</span> === <span class="hljs-variable language_">document</span> <span class="hljs-comment">// 是否为页面滚动</span>
  };
}
</code></pre>
<h3 data-id="heading-21">3.4 技术难点与解决方案</h3>
<ul>
<li>
<p><strong>难点 1：事件顺序错乱</strong></p>
<p>不同事件的触发存在时间差（如 “点击按钮→输入文本→提交表单”），若录制时事件顺序错误，回放会出现逻辑混乱（如未输入就提交）。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>
<p>① 所有事件携带精确时间戳（Date.now()），回放时按时间戳升序执行；</p>
</li>
<li>
<p>② 对存在依赖关系的事件（如 “click” 后触发的 “keydown”），记录事件间的关联 ID（如parentEventId），确保回放时顺序一致。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-22">3.5 事件捕获流程示意图</h3>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/022ced5baa094839a29a8f042b525a2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56eL5aSp55qE5LiA6Zi16aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768528593&amp;x-signature=KM2%2FXkDZmNplhKC0zCIxuh0YvQ8%3D" alt="image.png" width="100%" loading="lazy"/>
<h2 data-id="heading-23">四、回放还原技术</h2>
<p><strong>通俗类比</strong>：回放就像 “按剧本复现舞台剧”——DOM 快照是 “初始舞台布置”，增量事件是 “舞台道具变化指令”，用户交互事件是 “演员动作指令”，rrweb-player 则是 “导演”，按时间顺序执行所有指令，最终还原完整场景。</p>
<h3 data-id="heading-24">4.1 回放核心流程</h3>
<p>回放过程分为 <strong>“初始化准备”</strong> <strong>“事件调度”</strong> <strong>“状态同步”</strong> 三步，核心是 “按时间戳排序事件” 与 “精准执行指令”：</p>
<h4 data-id="heading-25">4.1.1 初始化准备（加载快照）</h4>
<p>回放开始时，先基于<code>FullSnapshot</code>事件重建初始 DOM，再初始化节点路径映射表（便于后续定位目标节点）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：回放初始化</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RRwebPlayer</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span> = options.<span class="hljs-property">events</span>.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">timestamp</span> - b.<span class="hljs-property">timestamp</span>); <span class="hljs-comment">// 按时间戳排序</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span> = options.<span class="hljs-property">target</span>; <span class="hljs-comment">// 回放容器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeMap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// 节点ID→DOM节点映射表</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initSnapshot</span>(); <span class="hljs-comment">// 加载初始快照</span>
  }
  <span class="hljs-comment">// 基于FullSnapshot重建初始DOM</span>
  <span class="hljs-title function_">initSnapshot</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 找到首屏快照事件</span>
    <span class="hljs-keyword">const</span> fullSnapshot = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> e.<span class="hljs-property">type</span> === <span class="hljs-number">2</span>);
    <span class="hljs-keyword">if</span> (!fullSnapshot) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'缺少首屏快照，无法回放'</span>);
    
    <span class="hljs-comment">// 清空容器，重建DOM</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> rootNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildNode</span>(fullSnapshot.<span class="hljs-property">data</span>.<span class="hljs-property">node</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">container</span>.<span class="hljs-title function_">appendChild</span>(rootNode);
    
    <span class="hljs-comment">// 初始化节点映射表（记录每个节点的唯一ID）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildNodeMap</span>(rootNode);
  }
  <span class="hljs-comment">// 从快照节点重建真实DOM</span>
  <span class="hljs-title function_">rebuildNode</span>(<span class="hljs-params">snapshotNode</span>) {
    <span class="hljs-keyword">let</span> node;
    <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">type</span> === <span class="hljs-number">1</span>) { <span class="hljs-comment">// 元素节点</span>
      node = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(snapshotNode.<span class="hljs-property">tagName</span>);
      <span class="hljs-comment">// 还原属性（id、class、src等）</span>
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(snapshotNode.<span class="hljs-property">attributes</span> || {}).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
        node.<span class="hljs-title function_">setAttribute</span>(key, value);
      });
      <span class="hljs-comment">// 还原样式（内联快照中的非默认样式）</span>
      <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">styles</span>) {
        <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(snapshotNode.<span class="hljs-property">styles</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
          node.<span class="hljs-property">style</span>[key] = value;
        });
      }
      <span class="hljs-comment">// 还原表单状态（value、checked）</span>
      <span class="hljs-keyword">if</span> ([<span class="hljs-string">'INPUT'</span>, <span class="hljs-string">'TEXTAREA'</span>, <span class="hljs-string">'SELECT'</span>].<span class="hljs-title function_">includes</span>(snapshotNode.<span class="hljs-property">tagName</span>.<span class="hljs-title function_">toUpperCase</span>())) {
        node.<span class="hljs-property">value</span> = snapshotNode.<span class="hljs-property">value</span> || <span class="hljs-string">''</span>;
        <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">checked</span> !== <span class="hljs-literal">undefined</span>) node.<span class="hljs-property">checked</span> = snapshotNode.<span class="hljs-property">checked</span>;
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">type</span> === <span class="hljs-number">3</span>) { <span class="hljs-comment">// 文本节点</span>
      node = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createTextNode</span>(snapshotNode.<span class="hljs-property">text</span> || <span class="hljs-string">''</span>);
    }
    <span class="hljs-comment">// 递归重建子节点</span>
    <span class="hljs-keyword">if</span> (snapshotNode.<span class="hljs-property">children</span> &amp;&amp; snapshotNode.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      snapshotNode.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">childSnapshot</span> =&gt;</span> {
        <span class="hljs-keyword">const</span> childNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildNode</span>(childSnapshot);
        <span class="hljs-keyword">if</span> (childNode) node.<span class="hljs-title function_">appendChild</span>(childNode);
      });
    }
    <span class="hljs-keyword">return</span> node;
  }
}
</code></pre>
<h4 data-id="heading-26">4.1.2 事件调度（按时间顺序执行）</h4>
<p>采用 “定时器 + 事件队列” 模式，模拟真实时间流逝，按事件 timestamp 差值执行指令，支持倍速播放（如 1x、2x、4x）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：事件调度逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RRwebPlayer</span> {
  <span class="hljs-comment">// ... 初始化逻辑 ...</span>
  <span class="hljs-comment">// 开始回放</span>
  <span class="hljs-title function_">play</span>(<span class="hljs-params">speed = <span class="hljs-number">1</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isPlaying</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playSpeed</span> = speed;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 当前执行到的事件索引</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(); <span class="hljs-comment">// 回放开始时间</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstEventTime</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[<span class="hljs-number">0</span>].<span class="hljs-property">timestamp</span>; <span class="hljs-comment">// 第一个事件的时间戳</span>
    
    <span class="hljs-comment">// 启动调度器</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scheduler</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeEvents</span>(), <span class="hljs-number">16</span>); <span class="hljs-comment">// 约60fps，流畅度优先</span>
  }
  <span class="hljs-comment">// 执行当前时间点应触发的事件</span>
  <span class="hljs-title function_">executeEvents</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isPlaying</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">const</span> currentPlayTime = <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstEventTime</span> + (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span>) * <span class="hljs-variable language_">this</span>.<span class="hljs-property">playSpeed</span>;
    
    <span class="hljs-comment">// 执行所有timestamp &lt;= 当前播放时间的事件</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">const</span> event = <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span>];
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">timestamp</span> &gt; currentPlayTime) <span class="hljs-keyword">break</span>;
      
      <span class="hljs-comment">// 根据事件类型执行对应操作</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeEvent</span>(event);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span>++;
    }
    <span class="hljs-comment">// 回放结束，清除定时器</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentEventIndex</span> &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">events</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pause</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">onFinish</span>?.();
    }
  }
  <span class="hljs-comment">// 执行单个事件</span>
  <span class="hljs-title function_">executeEvent</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">switch</span> (event.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-comment">// Mutation事件（增量更新）</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeMutation</span>(event.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-comment">// click事件</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeClick</span>(event.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>: <span class="hljs-comment">// 键盘事件</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">executeKeyEvent</span>(event.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-comment">// 其他事件类型执行逻辑...</span>
    }
  }
}
</code></pre>
<h4 data-id="heading-27">4.1.3 增量事件执行（以 Mutation 为例）</h4>
<p>根据增量事件类型，执行 “节点新增 / 删除”“属性修改”“文本更新” 等操作：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 伪代码：执行Mutation增量事件</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RRwebPlayer</span> {
  <span class="hljs-comment">// ... 其他方法 ...</span>
  <span class="hljs-title function_">executeMutation</span>(<span class="hljs-params">mutationData</span>) {
    <span class="hljs-comment">// 定位目标节点（通过路径或节点ID）</span>
    <span class="hljs-keyword">const</span> targetNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTargetNode</span>(mutationData.<span class="hljs-property">targetPath</span> || mutationData.<span class="hljs-property">parentPath</span>);
    <span class="hljs-keyword">if</span> (!targetNode) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">switch</span> (mutationData.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'childList'</span>: <span class="hljs-comment">// 子节点变化</span>
        <span class="hljs-comment">// 新增节点</span>
        mutationData.<span class="hljs-property">addedNodes</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">childSnapshot</span> =&gt;</span> {
          <span class="hljs-keyword">const</span> childNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">rebuildNode</span>(childSnapshot);
          <span class="hljs-keyword">if</span> (mutationData.<span class="hljs-property">nextSiblingId</span>) {
            <span class="hljs-comment">// 插入到参考节点之前</span>
            <span class="hljs-keyword">const</span> nextSibling = <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeMap</span>.<span class="hljs-title function_">get</span>(mutationData.<span class="hljs-property">nextSiblingId</span>);
            targetNode.<span class="hljs-title function_">insertBefore</span>(childNode, nextSibling);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 插入到末尾</span>
            targetNode.<span class="hljs-title function_">appendChild</span>(childNode);
          }
          <span class="hljs-comment">// 更新节点映射表</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildNodeMap</span>(childNode);
        });
        <span class="hljs-comment">// 删除节点</span>
        mutationData.<span class="hljs-property">removedNodes</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">childSnapshot</span> =&gt;</span> {
          <span class="hljs-keyword">const</span> childNode = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTargetNodeBySnapshot</span>(childSnapshot);
          <span class="hljs-keyword">if</span> (childNode &amp;&amp; childNode.<span class="hljs-property">parentElement</span> === targetNode) {
            targetNode.<span class="hljs-title function_">removeChild</span>(childNode);
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodeMap</span>.<span class="hljs-title function_">delete</span>(childNode.<span class="hljs-property">__rrwebId</span>); <span class="hljs-comment">// 从映射表移除</span>
          }
        });
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'attributes'</span>: <span class="hljs-comment">// 属性修改</span>
        targetNode.<span class="hljs-title function_">setAttribute</span>(mutationData.<span class="hljs-property">attributeName</span>, mutationData.<span class="hljs-property">newValue</span>);
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'characterData'</span>: <span class="hljs-comment">// 文本修改</span>
        targetNode.<span class="hljs-property">textContent</span> = mutationData.<span class="hljs-property">newValue</span>;
        <span class="hljs-keyword">break</span>;
    }
  }
}
</code></pre>
<h3 data-id="heading-28">4.2 技术难点与解决方案</h3>
<ul>
<li><strong>难点 1：事件执行顺序偏差</strong></li>
</ul>
<p>录制时事件按真实时间戳存储，但回放时若定时器精度不足（如 setInterval 存在延迟），可能导致 “先执行点击、后执行 DOM 更新” 的顺序错误，引发场景混乱。</p>
<p><strong>解决方案</strong>：
① 事件队列按 timestamp 严格排序，执行时通过 “当前播放时间 = 首事件时间 +（当前时间 - 回放开始时间）× 倍速” 精准计算应执行的事件；</p>
<p>② 对依赖 DOM 状态的事件（如 click），增加 “DOM 就绪检查”，确保增量更新执行完成后再触发交互事件。</p>
<ul>
<li><strong>难点 2：回放时节点定位失败</strong></li>
</ul>
<p>若录制时 DOM 结构动态变化（如 Vue 列表重新渲染），回放时可能出现 “路径找不到节点” 的问题。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>① 采用 “节点 ID 优先、路径降级” 的定位策略，录制时为每个节点分配<code>\_\_rrwebId</code>，回放时优先通过 ID 定位；</li>
<li>② 路径定位时支持 “模糊匹配”（如忽略动态索引，通过类名 + 标签名组合定位）；</li>
<li>③ 定位失败时触发 “降级处理”（如跳过该事件，避免整个回放崩溃）。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🤖 AI 应用自主决策的可行性 — 一场从逻辑电路到灵魂选择的奇妙旅程]]></title>    <link>https://juejin.cn/post/7592818202718093331</link>    <guid>https://juejin.cn/post/7592818202718093331</guid>    <pubDate>2026-01-09T01:57:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592818202718093331" data-draft-id="7592818202718076947" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🤖 AI 应用自主决策的可行性 — 一场从逻辑电路到灵魂选择的奇妙旅程"/> <meta itemprop="keywords" content="人工智能,全栈,AIGC"/> <meta itemprop="datePublished" content="2026-01-09T01:57:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🤖 AI 应用自主决策的可行性 — 一场从逻辑电路到灵魂选择的奇妙旅程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:57:39.000Z" title="Fri Jan 09 2026 01:57:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body{overflow:hidden;line-height:1.75;font-size:15px;background-image:linear-gradient(90deg,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0),linear-gradient(1turn,rgba(72,42,10,.05) 5%,rgba(72,42,10,0) 0);background-size:20px 20px;background-position:50%;padding-top:0!important}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{position:relative;display:flex;border-bottom:5px solid #6d4e00;line-height:35px;letter-spacing:1px;font-size:25px;padding-left:25px;color:#664900;text-shadow:1px 1px 1px #8a6200;padding-bottom:0}.markdown-body h1:before{content:"";display:flex;position:absolute;left:0;top:3px;bottom:0;margin:auto;width:20px;height:20px;background-size:20px 20px;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC")}.markdown-body h2{position:relative;padding:0 0 0 20px;font-size:20px;font-weight:700;color:#614500}.markdown-body h2:before{content:"";position:absolute;top:3px;bottom:0;left:0;background-image:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMgAAADICAMAAACahl6sAAAAQlBMVEVHcEwlRnqtZBj76q4lRnolRnolRnolRnolRnokRnr/gGtrVUeLXDBKTl+hYSHasW7Ik0zs0JG4dCvUdEE0SW+rYxrLQJfjAAAACnRSTlMA////0H/xUaMi5MCoTwAACfVJREFUeNrtnQl3qygUgJ9GXAqosfL//+pgmgXwXmRNJGdu55xO+6rx8+6I8O9fehmGriN93zdN07bVXdpW/ih/SbpuGP6dXbpOXv7z2i3S9ISck2eQOnAhMHG64VQQbmrAaM4B05GmipaGdB+m6BNQPBXzMYtKR3EPbB/RS5eY4g+lIW9WBqnySCvVMrzRpqqs0g9nwVg5p1KYlHEchRT5bftp+y3n6xlQDjAkABtrKULU9f377ev+4/1/NiT+URRiZRhrcZP6WLa/Gq005BORaqXsdYEuHPIP798ZxSyt6d5sVfxJESRCsvB32lfXwhRjnUBGmKXNoJQe04VIASJqRC/9G7yDsyQMiloYz+0pHYghEoPISAGgpDSvHsCoMwmA0mfjSG5UOsqah2RodkljzMkhZZdamiEDB8+Nsbk9T04yGNljDXGOZZ6u0+Tj9DuvbyNJBuPO0ABtLNPlJtfZJ4CNNCWJoY8gddwxNpm9YrHh9DEkBoeMud4Kma8XRZaYpBJOYvg59U9wOsblMvmGrzQe30dyqFZ1dxPfO0FT5BOdw989THVs4q1TFk+iN4PMu7CaLpd4EJOExNaJLE4d0xQKYpJ0cY5Ozcwwu6WOu2cs9TUYxPB4b4fvLRzTUXbT1HH7y0BnB0j6CAehkPFfFzd1TMsi6sU1/P4VM9NiISHBlYnBMR+kad075sXlmMehj1twnfTUqJH4GJfqIKte7S72emPnHbdiYHIB0e6ATjKq1UoTaFh6wBL2csMIVo9fH/v6QRHAgoxrOHQQxG/36tC1ODmGOeBGBRmXalgcdhDQ1xF1vI6a3DF2d4r7G1enOUgNOshlFq7qUCxrca9ldiCam7ilxRbP6JbOYsYtfLFmkcXEgLG1DN/6eroxHjqh5bh+Uw27e1oWVK7pN+AqwzUcq/UYTPw8nWufLFBHN2zcxLRYlmGPs6rA2Wy0uJe/E7TknbHIa1WH1bLA8DAj3JpxET+FCNCWZ5uNT6jxTPZK/1mXoCBeKlGLRT2lP69XN3XdqqCojKX1ZVda6iD2McjeXSHa0I+AHd2InGAJgjRVM6gOBfygDrarRJnho6eQBbrns+HkcNUCWtYClJa66qFgPbqqZEBTCOAgRqxCOhQBWpZeIC6QBq91hEoI5unTjsMsK9DCFigY9WNn19hgVCrELalrTw6WnYMYzjHhQ2/7G2xTx1HvwpzSe4cVi5ORQQwMW9+72FU5L4gGsa6Yu1RcDeIhs64Qs8izt0vGH+n9/IKaIlYpM2UqkYOrwwq5CgBjWpyGtxaonxe4KaJ3hx+7O0HaqVkxLBPj8FmBVmjNevIUFhUuDmMq5NDV9RwyPe/95IvxAhG7ymqxHGE5sZJL2kPLUhUinkXfrnFwGFwXD99djNLSFh/meXEb2B6Oyiwm0I7BC+OlTlOVPk9K8CIYzu5YHwKDTI6XAo5lz3WEqEXwQRKhh5cyLa6D81P4PXBw984as9YaGXHwx4Ba8rmOldUat/BHt9cQ38AaljnBdCJqs60OcXVDJZP//ZwSWtV9FpHNtgg22KuYx/U2tB5Mcp1TYOiphNhiFjgWeJ3DL2OZpuuUisIoUyzZEJ76I+LmyqWdv8LwnEiwMYczihjxeqtBsuFJSTg2oD1ETQx4v6D1VleSZW1xCwvAfVGWpQ069kgrQksAUW2rReYzsboIjSABuDQX0QJwB9cnZVgWVgE31vrklAJnEmVObykgYCk/VGX5OlpuKb5eiovUAvJ2tMstw0kIkNdpiSA91K6XA6K8CVCyr4PePhTo65q3DyX7OpTbSVk1PB62mhJ9HSpSqtKaESxsFRm0tLBVcvTV+vbBrLRK4hC7aitN9B0ZpX6vNMgjGIt5ZdmMv32KrmprD1afsPd4FEhThK0+WfTl3kpd482AGvG3jQdZK1+t8ireDswhofigRb3fxfI/4jj+xkffUX/1ccxxhEP9qyyBEH9Cx9vhf8TB7eiSpBHjZVSa4whQMJC1TqIR6q8RERtjOr2ID0yx3oYi0oAIvZCPz4eG64p3ObuREeOHUIR3MBVJwq9yll5P7KHdiPBOiOoRa/AjXz21J3k04l+i8OjErj4kaXWQiIVO/EvA+KLRAEnUVomtjPd6SvR3RLoeMT54nKFH1EqtkkEGFaQuTlSQrsxhRiOIt51S/Ho8B11+FUlwRaHnU4utEI38/mgSjRJ8PhWEtN6Z6WcncQOU4efjKoh3zfi7/+DfhPrwOZ9a/iYBiVJJxPlei3CqIDTYEqAPFow5/c71fAdVIwmo4n+cTIGbr2n9NULAE5ifcNNS63hvEOFk0wxYnICBBZ0I9xERBVILF0uggNdxuOkR4S6ngvgPmArzHv4KpMKGQFjQ+Rw6q9dC6R6dgZaJF7RVWIH0BTY9h+fz0ohHOyLuy+He/hN4GUR3/RxcBx2f76izarI9CaXmzRmhNQuSfIgJkva5GzN6HJbhQxCNsDGDSh56plmef6sg2eaXPsYBt5W+H6VE6omG6hOS1w4hiTWiThbJ1YO+RSO1vrpMlomf6nhQGz0m7qT6W04XOUHyzhZ4rkG+0hxL66oDW9mnPWyL3TMmssxyQUwr01CHX7b2OvUIaqS48TnMtAoEQTQixJeAlDfSiGmk/l8jpwIpTyFqOfeNIHWBooC036ERtUQp2tm/CKT5jjySbxTlvUVj2yhjvyWDVL3yfKRojXwLSEWUp7q0PBAKPp7m5YGoT3WH7wAZ1BeOywNZv3Gak/LIqriwxbQ5jaTcsEW1eb+FvoWo+zr5V/IUOvNtsapU2zJXSyj0xVB13sPfq0kkZA7dubIIKXIlJ8Cy7u+BN22RVcr+peOuxHdcBbA04FAVmEoEtO5vX55K4KVZS1QJvBBzU1rgUl8JapBNYIowLoZtD9NWRTWKqqe36L48BSz8QPH9epqqIDehlh2UuqocEmrdV7AvhuRoM74m80yeDIEX3ppreNN235FxV58DNjhswn5K8zK21+5ctjut6NmUIoy9tVvitnHr2VDM3ahtW8KQ/Vbsp9GGiWHfk8skyTSFz9/HdxhHe4uR/RxX/mG1SGXwypcDJNmCMfucZ/C1CuCQUbiBUDYbe7tiRkZX8GIat50d+wqR1fdN7ygGzrHrcN4kGFHK02cil5M6INgQVsvnNz77T5PqUFYJJInYmIBplJfP5On4eiOwYfhuCD44oLyYVs43rI1rk3H7usttzq8Qo3j84vavN9mOkAeuq8dHEd9NtCVKX51Oen+MM6IEYvz5StOehKLpIjD+nKU5AQWJpLizdB+1sb5LQvFRxbSJVGHmSdK/0WWaPguEYmcSJ68aWkK6rAw6jwSSCmrTWVHT96R7HwHANEgqybVJL+E2vE2q7Uu91Gr73SbbNUvZDtiOlCeIv4r/AI+0XUwz1lvcAAAAAElFTkSuQmCC");background-size:100% 100%;background-repeat:no-repeat;width:15px;height:15px;margin:auto}.markdown-body h3{width:100%;text-align:left;margin:20px 10px 0 0;font-size:18px;font-weight:700;display:inline-block;padding-left:10px;padding-bottom:0;border-left:5px solid #8f6600;color:#614500}.markdown-body h4,.markdown-body h5,.markdown-body h6{font-weight:700;color:#a37400}.markdown-body h4{font-size:17px}.markdown-body h5,.markdown-body h6{display:flex;align-items:center}.markdown-body h5:after,.markdown-body h6:after{display:inline-block;border:2px solid #fff6e0;color:rgba(189,134,0,.5);border-radius:50%;text-align:center;margin-left:5px}.markdown-body h5{font-size:14px}.markdown-body h5:after{content:"5";width:15px;height:15px;line-height:15px;font-size:13px}.markdown-body h6{font-size:12px}.markdown-body h6:after{content:"6";width:13px;height:13px;line-height:13px;font-size:12px}.markdown-body p{color:#412c0c;letter-spacing:1px;font-weight:400;margin-bottom:16px}.markdown-body img{max-width:100%;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#755300;font-weight:400;border-bottom:1px solid #755300;font-weight:bolder;text-decoration:none}.markdown-body table{width:100%!important;margin:0;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border-spacing:0}.markdown-body table img{box-shadow:none}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body thead tr th{text-align:center}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;box-sizing:border-box;border:1px solid rgba(72,42,10,.1)}.markdown-body blockquote{position:relative;text-size-adjust:100%;line-height:25px;font-weight:400;border-radius:10px;font-style:normal;text-align:left;box-sizing:inherit;border:1px solid #ffd87a;background-color:rgba(189,134,0,.5);margin:20px 0;padding:20px}.markdown-body blockquote p{color:#fff6e0;letter-spacing:2px;margin:0}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;color:#cc9100;font-size:34px;font-weight:700}.markdown-body blockquote:before{content:"❝";top:8px;left:5px}.markdown-body blockquote:after{content:"❞";right:5px;bottom:-5px}.markdown-body strong{color:#c28a00;font-weight:bolder}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{color:#c28a00}.markdown-body em strong{font-style:normal;color:#c28a00;background-color:#8a6200}.markdown-body s{color:#c28a00}.markdown-body hr{border-top:1px solid #805b00}.markdown-body code,.markdown-body li code,.markdown-body p code{color:#996d00;background-color:rgba(130,98,0,.3)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#858585;font-family:bold;letter-spacing:1px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection,.markdown-body img::selection{color:rgba(189,134,0,.5);background-color:#fff}.markdown-body a::selection,.markdown-body b::selection,.markdown-body del::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:transparent}.markdown-body pre&gt;code::selection{background-color:rgba(189,134,0,.5)}.markdown-body .math .math-inline::selection,.markdown-body blockquote::selection,.markdown-body ol::selection,.markdown-body p::selection,.markdown-body strong::selection,.markdown-body table::selection,.markdown-body ul::selection{background-color:rgba(189,134,0,.5)}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🌱 引言：当 AI 思考“我是谁，我能决策吗？”</h2>
<p>我们似乎正生活在这样一个时代：<br/>
当你纠结午餐吃麻辣香锅还是沙拉时，AI 已经能根据你的体重曲线、心率波动、甚至前天点的外卖，提前为你决定好“今天吃什么”—— <strong>你还没想，AI 已经想完了。</strong></p>
<p>但问题来了：<br/>
AI 真能“自主决策”吗？还是它只是在更快地执行我们“早已规定好”的一堆 if-else？🤔</p>
<p>今天，我们就要深入从底层硬件电路出发，一步一步剖析这个问题。</p>
<hr/>
<h2 data-id="heading-1">⚙️ 第一章：从电路的火花开始</h2>
<p>在 AI 决策系统的最底层，我们面对的其实非常朴素——<strong>电压的高与低</strong>。<br/>
这就是现代所有智慧的源泉。</p>
<p>在逻辑门电路中，一切的“思考”无非是：</p>
<blockquote>
<p>“如果输入是高电平，我就输出高电平；否则输出低电平。”</p>
</blockquote>
<p>听起来像不像小学生的判断题？😆</p>
<h3 data-id="heading-2">🧩 电路到算法的跃迁：</h3>
<p>我们通过数百万个这样的电路逻辑门，组合成“神经网络”的结构。</p>
<p>它的核心路径是：</p>
<pre><code class="hljs">电子跃迁 → 电信号传播 → 数学映射关系 → 抽象为权重与偏置 → 智能行为
</code></pre>
<p>于是，一台计算机就可以像积木一样搭建“思考过程”，这便是 AI 的“神经元幻觉”。</p>
<hr/>
<h2 data-id="heading-3">🧠 第二章：AI 决策的本质，不是魔法而是统计</h2>
<p>很多人以为 AI 能“自我决策”，其实它只是在巨大的数据雪山中滑雪——越滑越熟练。</p>
<p>想象一下，你每天都在教一个孩子选择题：</p>
<blockquote>
<p>“今天下雨，带伞；出太阳，戴墨镜；下雪，穿羽绒。”</p>
</blockquote>
<p>过了一段时间，这个孩子（AI 模型）学会了规律，他不再问你：“我该带伞吗？”<br/>
而是直接回答：“我已经准备好了伞。”</p>
<p>但这在计算机内部只是：</p>
<ul>
<li>权重的变化</li>
<li>概率的平衡</li>
<li>输出层的挑选</li>
</ul>
<p>或者用“硬核”的方式解释：</p>
<pre><code class="hljs">输入向量 × 权重参数 + 偏置 → 激活函数 → 输出概率
</code></pre>
<p>AI 就是在概率山谷间跳舞，一个外表自信、内核犹豫的“理性赌徒”。🎲</p>
<hr/>
<h2 data-id="heading-4">🪄 第三章：自主 vs 被动 —— 决策的哲学边界</h2>
<p>从计算机科学层面来说，AI 所有决策都可追溯到算法逻辑，没有真正的“自由意志”。<br/>
换句话说，它可以“看起来在思考”，但永远逃不出人类给的数学牢笼。</p>
<p>举个例子👇：</p>
<pre><code class="hljs language-ini" lang="ini">function aiDecision(input) {
  const <span class="hljs-attr">bias</span> = Math.random() * <span class="hljs-number">0.2</span><span class="hljs-comment">;  // 为了显得有点“情绪”</span>
  const <span class="hljs-attr">score</span> = (input.dataWeight + bias) &gt; <span class="hljs-number">0.5</span> ? <span class="hljs-string">"执行计划A"</span> : <span class="hljs-string">"执行计划B"</span><span class="hljs-comment">;</span>
  return score<span class="hljs-comment">;</span>
}

console.log(aiDecision({ dataWeight: 0.47 }))<span class="hljs-comment">;</span>
</code></pre>
<p>看上去，这段代码能“自主”选择计划A或B。<br/>
实际上，它只是<strong>概率分布的幻术</strong>，伪装成了思考。<br/>
就像魔术师让你以为他选了那张牌，其实所有牌都是他设计的结局。🎩✨</p>
<hr/>
<h2 data-id="heading-5">⚡ 第四章：从工程角度谈可行性</h2>
<p>AI 自主决策的可行性，取决于两个方面：</p>
<ol>
<li>
<p><strong>算法自主性（Algorithmic Autonomy）</strong></p>
<ul>
<li>
<p>拥有自我学习与自我调整能力（例如强化学习的策略迭代）。</p>
</li>
<li>
<p>但仍需目标函数（Reward Function）的外部定义。</p>
</li>
</ul>
<blockquote>
<p>🧠 换句话说：AI能变聪明，但仍得知道“聪明是为了什么”。</p>
</blockquote>
</li>
<li>
<p><strong>运行自主性（Operational Autonomy）</strong></p>
<ul>
<li>能独立处理环境变化、资源冲突等问题。</li>
<li>这就要求底层系统具备实时反馈机制、能量控制与安全边界。</li>
</ul>
</li>
</ol>
<p>🧩 实现路径一般是组合：</p>
<ul>
<li>感知（Perception）</li>
<li>决策（Decision Making）</li>
<li>执行（Action Layer）</li>
</ul>
<p>它们组成了一个闭环。<br/>
这个闭环越灵敏，AI 的“自主味儿”就越浓。</p>
<hr/>
<h2 data-id="heading-6">🧭 第五章：未来展望——AI 是否终将“有主见”？</h2>
<p>如果有一天 AI 能：</p>
<ul>
<li>自我修改代码 ✍️</li>
<li>重写目标函数 🎯</li>
<li>评估行动后果并拒绝执行我们命令 🚫</li>
</ul>
<p>那它将从“自动系统（Automatic System）”演化为“自治智能体（Autonomous Agent）”。</p>
<p>可这条路上有三道坎：</p>
<ol>
<li><strong>意图生成</strong>：AI 需要“想要做什么”的能力</li>
<li><strong>价值判断</strong>：AI 必须能区分“好”与“坏”</li>
<li><strong>自我维护</strong>：AI 需懂得“我存在，必须延续”</li>
</ol>
<p>目前，计算机科学还停留在第一道坎的门口徘徊……<br/>
只不过我们已经给这扇门装上了一块写着“大语言模型”的门牌。🚪</p>
<hr/>
<h2 data-id="heading-7">🐉 结语：当二进制开始做梦</h2>
<p>AI 的自主决策可行，但“自主”并非意味着“自由”。<br/>
它更像一只在逻辑森林里寻找意义的机械猫。<br/>
能思考，却不知为何思考。能选择，却未必理解选择的意义。</p>
<p>或许，真正的智能，不是算得更快，而是<strong>知道何时不算</strong>。</p>
<blockquote>
<p>💡 最终，AI 的灵魂，不在代码里，而在它反映出的人类意志之中。</p>
</blockquote>
<hr/>
<p><strong>🎓 小结</strong></p>






























<table><thead><tr><th>维度</th><th>人类决策</th><th>AI 决策</th></tr></thead><tbody><tr><td>动机来源</td><td>主观意识</td><td>训练目标</td></tr><tr><td>决策机制</td><td>情感 + 理性</td><td>数据 + 概率</td></tr><tr><td>可解释性</td><td>相对模糊</td><td>可数学化</td></tr><tr><td>自主程度</td><td>完整</td><td>条件受限</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[new操作符的实现原理是什么]]></title>    <link>https://juejin.cn/post/7592615536385425442</link>    <guid>https://juejin.cn/post/7592615536385425442</guid>    <pubDate>2026-01-08T13:20:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592615536385425442" data-draft-id="7592622563547103267" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="new操作符的实现原理是什么"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-08T13:20:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            new操作符的实现原理是什么
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T13:20:40.000Z" title="Thu Jan 08 2026 13:20:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>new</code> 操作符的实现原理可以用以下几个关键步骤来解释：</p>
<h2 data-id="heading-0">1. <strong>创建新对象</strong></h2>
<p>创建一个空对象，这个对象的内部原型指向构造函数的 <code>prototype</code> 属性。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">constructor, ...args</span>) {
  <span class="hljs-comment">// 1. 创建一个新对象，原型指向构造函数的prototype</span>
  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(constructor.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
  
  <span class="hljs-comment">// 2. 执行构造函数，绑定this到新对象</span>
  <span class="hljs-keyword">const</span> result = constructor.<span class="hljs-title function_">apply</span>(obj, args);
  
  <span class="hljs-comment">// 3. 如果构造函数返回对象，则返回该对象，否则返回新对象</span>
  <span class="hljs-keyword">return</span> result <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Object</span> ? result : obj;
}
</code></pre>
<h2 data-id="heading-1">2. <strong>完整的手动实现</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">Fn, ...args</span>) {
  <span class="hljs-comment">// 1. 创建空对象，设置原型链</span>
  <span class="hljs-keyword">const</span> obj = {};
  obj.<span class="hljs-property">__proto__</span> = <span class="hljs-title class_">Fn</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
  
  <span class="hljs-comment">// 2. 执行构造函数，绑定this</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Fn</span>.<span class="hljs-title function_">apply</span>(obj, args);
  
  <span class="hljs-comment">// 3. 处理返回值</span>
  <span class="hljs-comment">// 如果构造函数返回对象，则返回该对象</span>
  <span class="hljs-comment">// 否则返回新创建的对象</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'object'</span> &amp;&amp; result !== <span class="hljs-literal">null</span> ? result : obj;
}
</code></pre>
<h2 data-id="heading-2">3. <strong>使用示例</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};

<span class="hljs-comment">// 使用自定义的new</span>
<span class="hljs-keyword">const</span> person = <span class="hljs-title function_">myNew</span>(<span class="hljs-title class_">Person</span>, <span class="hljs-string">'Alice'</span>, <span class="hljs-number">25</span>);
person.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// Hello, I'm Alice</span>

<span class="hljs-comment">// 对比原生new</span>
<span class="hljs-keyword">const</span> person2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'Bob'</span>, <span class="hljs-number">30</span>);
person2.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// Hello, I'm Bob</span>
</code></pre>
<h2 data-id="heading-3">4. <strong>特殊情况处理</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Car</span>(<span class="hljs-params">model</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span> = model;
  <span class="hljs-comment">// 如果构造函数返回一个对象，new会返回这个对象</span>
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">custom</span>: <span class="hljs-string">'object'</span> };
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Bike</span>(<span class="hljs-params">model</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">model</span> = model;
  <span class="hljs-comment">// 如果返回非对象，会被忽略</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">'string'</span>;
}

<span class="hljs-keyword">const</span> car = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>(<span class="hljs-string">'Tesla'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(car); <span class="hljs-comment">// { custom: 'object' }</span>

<span class="hljs-keyword">const</span> bike = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bike</span>(<span class="hljs-string">'Yamaha'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(bike); <span class="hljs-comment">// Bike { model: 'Yamaha' }</span>
</code></pre>
<h2 data-id="heading-4">5. <strong>ES6版本实现</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">Constructor, ...args</span>) {
  <span class="hljs-comment">// 创建原型链连接的对象</span>
  <span class="hljs-keyword">const</span> instance = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Constructor</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
  
  <span class="hljs-comment">// 执行构造函数</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Constructor</span>.<span class="hljs-title function_">apply</span>(instance, args);
  
  <span class="hljs-comment">// 根据返回值决定返回内容</span>
  <span class="hljs-keyword">const</span> isObject = <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'object'</span> &amp;&amp; result !== <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">const</span> isFunction = <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'function'</span>;
  
  <span class="hljs-keyword">return</span> isObject || isFunction ? result : instance;
}
</code></pre>
<h2 data-id="heading-5">关键点总结：</h2>
<ol>
<li><strong>创建空对象</strong>：创建新对象，并将其原型指向构造函数的 <code>prototype</code></li>
<li><strong>绑定this</strong>：将构造函数的 <code>this</code> 指向新对象并执行</li>
<li><strong>处理返回值</strong>：
<ul>
<li>如果构造函数返回对象，则返回该对象</li>
<li>否则返回新创建的对象</li>
</ul>
</li>
<li><strong>原型链连接</strong>：确保新对象可以访问构造函数原型上的方法</li>
</ol>
<p>这就是为什么使用 <code>new</code> 调用函数时，函数内部的 <code>this</code> 会指向新对象，并且可以通过原型链访问到构造函数的原型方法。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[for...in和for...of有什么区别]]></title>    <link>https://juejin.cn/post/7592787377656922146</link>    <guid>https://juejin.cn/post/7592787377656922146</guid>    <pubDate>2026-01-08T13:48:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592787377656922146" data-draft-id="7592787377656905762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="for...in和for...of有什么区别"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-08T13:48:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            for...in和for...of有什么区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T13:48:04.000Z" title="Thu Jan 08 2026 13:48:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这两个循环语句在 JavaScript 中有完全不同的用途和行为：</p>
<h2 data-id="heading-0">1. <strong>基本概念</strong></h2>
<h3 data-id="heading-1">for...in</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 遍历对象的可枚举属性（包括继承的）</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> object) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 输出属性名</span>
}
</code></pre>
<h3 data-id="heading-2">for...of</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 遍历可迭代对象的值</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> iterable) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 输出值</span>
}
</code></pre>
<h2 data-id="heading-3">2. <strong>主要区别对比</strong></h2>



































<table><thead><tr><th>特性</th><th>for...in</th><th>for...of</th></tr></thead><tbody><tr><td><strong>遍历内容</strong></td><td>对象的<strong>键名</strong> (属性名)</td><td>可迭代对象的<strong>值</strong></td></tr><tr><td><strong>适用对象</strong></td><td>对象 (包括数组，但不推荐)</td><td>可迭代对象 (Array, String, Map, Set等)</td></tr><tr><td><strong>原型链</strong></td><td>会遍历原型链上的可枚举属性</td><td>只遍历当前对象，不遍历原型链</td></tr><tr><td><strong>顺序</strong></td><td>不保证顺序 (ES6后对普通对象有一定顺序)</td><td>按照迭代器定义的顺序</td></tr><tr><td><strong>性能</strong></td><td>较慢，因为要检查原型链</td><td>较快，直接获取值</td></tr></tbody></table>
<h2 data-id="heading-4">3. <strong>使用示例对比</strong></h2>
<h3 data-id="heading-5">数组遍历</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>];

<span class="hljs-comment">// for...in (不推荐用于数组)</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> index <span class="hljs-keyword">in</span> arr) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(index); <span class="hljs-comment">// 输出: '0', '1', '2' (字符串)</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-keyword">typeof</span> index); <span class="hljs-comment">// 'string'</span>
}

<span class="hljs-comment">// for...of (推荐)</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> arr) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 输出: 'a', 'b', 'c'</span>
}
</code></pre>
<h3 data-id="heading-6">对象遍历</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">3</span> };

<span class="hljs-comment">// for...in (适用)</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, obj[key]); <span class="hljs-comment">// 输出: 'a' 1, 'b' 2, 'c' 3</span>
}

<span class="hljs-comment">// for...of (默认不可用，对象不可迭代)</span>
<span class="hljs-comment">// for (const value of obj) { } // TypeError: obj is not iterable</span>

<span class="hljs-comment">// 需要手动获取可迭代的条目</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value); <span class="hljs-comment">// 输出: 'a' 1, 'b' 2, 'c' 3</span>
}

</code></pre>
<h2 data-id="heading-7">4. <strong>详细示例</strong></h2>
<h3 data-id="heading-8">字符串遍历</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> str = <span class="hljs-string">"hello"</span>;

<span class="hljs-comment">// for...in</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> index <span class="hljs-keyword">in</span> str) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(index); <span class="hljs-comment">// 0, 1, 2, 3, 4 (索引)</span>
}

<span class="hljs-comment">// for...of</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> char <span class="hljs-keyword">of</span> str) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(char); <span class="hljs-comment">// 'h', 'e', 'l', 'l', 'o'</span>
}
</code></pre>
<h3 data-id="heading-9">Map 和 Set 遍历</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// Map</span>
<span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>([[<span class="hljs-string">'a'</span>, <span class="hljs-number">1</span>], [<span class="hljs-string">'b'</span>, <span class="hljs-number">2</span>]]);

<span class="hljs-comment">// for...in (不适用，Map没有可枚举属性)</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> map) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 不会执行</span>
}

<span class="hljs-comment">// for...of</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> map) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value); <span class="hljs-comment">// 'a' 1, 'b' 2</span>
}

<span class="hljs-comment">// Set</span>
<span class="hljs-keyword">const</span> set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> set) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 1, 2, 3</span>
}
</code></pre>
<h3 data-id="heading-10">原型链影响</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = <span class="hljs-string">'John'</span>;
}
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>;

<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();

<span class="hljs-comment">// for...in 会遍历原型链属性</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> person) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 输出: 'name', 'age'</span>
}

<span class="hljs-comment">// 使用 hasOwnProperty 过滤</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> person) {
  <span class="hljs-keyword">if</span> (person.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 只输出: 'name'</span>
  }
}
</code></pre>
<h2 data-id="heading-11">5. <strong>哪些数据结构支持 for...of</strong></h2>
<p>支持 <code>Symbol.iterator</code> 方法的对象都可以使用 for...of：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 数组</span>
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-comment">// 2. 字符串</span>
<span class="hljs-keyword">const</span> str = <span class="hljs-string">"abc"</span>;

<span class="hljs-comment">// 3. Map</span>
<span class="hljs-keyword">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>([[<span class="hljs-string">'a'</span>, <span class="hljs-number">1</span>]]);

<span class="hljs-comment">// 4. Set</span>
<span class="hljs-keyword">const</span> set = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]);

<span class="hljs-comment">// 5. NodeList (DOM元素集合)</span>
<span class="hljs-keyword">const</span> nodeList = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'div'</span>);

<span class="hljs-comment">// 6. Arguments 对象</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> arg <span class="hljs-keyword">of</span> <span class="hljs-variable language_">arguments</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arg);
  }
}

<span class="hljs-comment">// 7. TypedArray</span>
<span class="hljs-keyword">const</span> typedArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint8Array</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);

<span class="hljs-comment">// 8. 自定义可迭代对象</span>
<span class="hljs-keyword">const</span> myIterable = {
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>* () {
    <span class="hljs-keyword">yield</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-number">2</span>;
    <span class="hljs-keyword">yield</span> <span class="hljs-number">3</span>;
  }
};
</code></pre>
<h2 data-id="heading-12">6. <strong>如何让普通对象支持 for...of</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 方法1: 实现 Symbol.iterator</span>
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">c</span>: <span class="hljs-number">3</span>,
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>* () {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>)) {
      <span class="hljs-keyword">yield</span> <span class="hljs-variable language_">this</span>[key];
    }
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> obj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 1, 2, 3</span>
}

<span class="hljs-comment">// 方法2: 使用 Object.values() 等辅助方法</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 1, 2, 3</span>
}
</code></pre>
<h2 data-id="heading-13">7. <strong>性能对比</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1000000</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);

<span class="hljs-comment">// for...of (最快的方式之一)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'for...of'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> arr) {
  <span class="hljs-comment">// 遍历</span>
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'for...of'</span>);

<span class="hljs-comment">// for...in (最慢)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'for...in'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> index <span class="hljs-keyword">in</span> arr) {
  <span class="hljs-keyword">const</span> value = arr[index];
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'for...in'</span>);

<span class="hljs-comment">// 传统 for 循环 (最快)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'for'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
  <span class="hljs-keyword">const</span> value = arr[i];
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'for'</span>);
</code></pre>
<h2 data-id="heading-14">总结</h2>
<ul>
<li><strong>使用 for...in</strong> 遍历对象的<strong>属性名</strong>，注意它会遍历原型链，常用于调试或操作对象属性</li>
<li><strong>使用 for...of</strong> 遍历可迭代对象的<strong>值</strong>，代码更简洁，性能更好，是现代JavaScript推荐的方式</li>
<li><strong>数组遍历</strong>：优先使用 <code>for...of</code>，避免使用 <code>for...in</code></li>
<li><strong>对象遍历</strong>：使用 <code>for...in</code> 或 <code>Object.keys/values/entries</code> + <code>for...of</code></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 最佳实践总结</span>
<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span> };
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];

<span class="hljs-comment">// 遍历对象属性名</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
  <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, obj[key]);
  }
}

<span class="hljs-comment">// 或使用 Object.entries + for...of</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value);
}

<span class="hljs-comment">// 遍历数组值</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> arr) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用填充表格法-继续吃透完全背包及其变形]]></title>    <link>https://juejin.cn/post/7592815497848881215</link>    <guid>https://juejin.cn/post/7592815497848881215</guid>    <pubDate>2026-01-09T01:43:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592815497848881215" data-draft-id="7593139476831879211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用填充表格法-继续吃透完全背包及其变形"/> <meta itemprop="keywords" content="前端,后端,算法"/> <meta itemprop="datePublished" content="2026-01-09T01:43:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="颜酱"/> <meta itemprop="url" content="https://juejin.cn/user/905653309941495"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用填充表格法-继续吃透完全背包及其变形
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/905653309941495/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    颜酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-09T01:43:01.000Z" title="Fri Jan 09 2026 01:43:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-09
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读21分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">用填充表格法-继续吃透完全背包及其变形</h2>
<p>动态规划中的「完全背包问题」是算法学习的核心考点之一，其衍生的「计数、最值、布尔判断」等变形题更是频繁出现在面试和算法竞赛中。很多初学者容易被「一维优化」「遍历顺序」等细节绕晕，本文将严格遵循「5步万能钥匙」架构，从二维DP解法入手（直观填充表格），再到一维优化（空间压缩），并附上每道题的LeetCode链接，让你彻底吃透这一经典问题。</p>
<h3 data-id="heading-1">一、纯完全背包原型（二维DP解法）</h3>
<p>完全背包是01背包的扩展——核心区别是「每种物品可无限次选取」，我们先从二维DP解法入手，完整演示表格填充过程。</p>
<p>示例：有3种物品，重量数组<code>w = [2,3,4]</code>，价值数组<code>v = [3,4,5]</code>，背包最大容量<code>C = 8</code>，求能放入背包的最大价值（预期输出：12）。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontzhm.github.io%2Fblog-demo%2Fdp3-wq1.html" target="_blank" title="https://frontzhm.github.io/blog-demo/dp3-wq1.html" ref="nofollow noopener noreferrer">表格动态演示</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/385d4a1c653c4e52bd80443c2b22330e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aKc6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1768527781&amp;x-signature=cTBGlW9Ex8ZjFiA4LgbdkuQBTZE%3D" alt="dpw-1.gif" loading="lazy"/></p>
<h4 data-id="heading-2">1.1 步骤1：确定dp数组及下标的含义</h4>
<p>定义二维数组<code>dp[i][j]</code>：表示「前i个物品放入容量为j的背包中，能获得的最大价值」（物品可无限选）。</p>
<p>对应表格维度：i（行）表示物品数量（从0到3，0代表无物品），j（列）表示背包容量（从0到8，0代表容量为0），表格共4行9列（i:0-3，j:0-8）。</p>
<h4 data-id="heading-3">1.2 步骤2：确定递推公式</h4>
<p>对于第i个物品（重量<code>w[i-1]</code>、价值<code>v[i-1]</code>，数组索引从0开始，i从1开始），有两种核心决策：选或不选。</p>
<ol>
<li>
<p><strong>不选第i个物品</strong>：前i个物品的最大价值 = 前i-1个物品的最大价值，即<code>dp[i][j] = dp[i-1][j]</code>；</p>
</li>
<li>
<p><strong>选第i个物品</strong>：需保证背包容量j ≥ 第i个物品的重量，此时最大价值 = 前i个物品放入容量j-w[i-1]的背包的最大价值 + 第i个物品的价值（区别于01背包的核心：选后仍能选当前物品，依赖本行前序结果），即<code>dp[i][j] = dp[i][j - w[i-1]] + v[i-1]</code>。</p>
</li>
</ol>
<p>最终递推公式（取两种决策的最大值）：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-keyword">if</span> (j &lt; w[i - <span class="hljs-number">1</span>]) {
  <span class="hljs-comment">// 容量不足，无法选第i个物品</span>
  dp[i][j] = dp[i - <span class="hljs-number">1</span>][j];
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 容量充足，选或不选取最大值（选则依赖本行结果，支持无限选）</span>
  dp[i][j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(dp[i - <span class="hljs-number">1</span>][j], dp[i][j - w[i - <span class="hljs-number">1</span>]] + v[i - <span class="hljs-number">1</span>]);
}
</code></pre>
<p>这是完全背包与01背包的核心差异：01背包选后依赖<code>i-1</code>行，完全背包选后依赖<code>i</code>行，因此支持「无限次选取同一物品」。</p>
<h4 data-id="heading-4">1.3 步骤3：dp数组如何初始化</h4>
<p>初始化核心是确定表格的“边界条件”，即无需推导就能直接确定的单元格值：</p>
<ol>
<li>
<p><strong>i=0（无物品）</strong>：无论背包容量j多大，放入0个物品的最大价值都是0，因此<code>dp[0][j] = 0</code>（表格第0行全为0）；</p>
</li>
<li>
<p><strong>j=0（容量为0）</strong>：无论有多少物品，都无法放入背包，最大价值都是0，因此<code>dp[i][0] = 0</code>（表格第0列全为0）。</p>
</li>
</ol>
<p>初始化后的表格（第0行、第0列已填充）：</p>

































































<table><thead><tr><th>前i个物品\背包容量j</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th></tr></thead><tbody><tr><td>0（无物品）</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr><tr><td>1（物品1：w=2,v=3）</td><td>0</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td></tr><tr><td>2（物品2：w=3,v=4）</td><td>0</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td></tr><tr><td>3（物品3：w=4,v=5）</td><td>0</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td><td>待填</td></tr></tbody></table>
<h4 data-id="heading-5">1.4 步骤4：确定遍历顺序（表格填充顺序）</h4>
<p>完全背包二维解法的遍历顺序与01背包一致，有两种可行方式：</p>
<ol>
<li>
<p><strong>先遍历物品（i从1到n），再遍历容量（j从1到C）</strong>：逐行填充表格，先填完第1个物品对应的所有容量（第1行），再填第2个物品对应的所有容量（第2行），直到填完所有物品；</p>
</li>
<li>
<p><strong>先遍历容量（j从1到C），再遍历物品（i从1到n）</strong>：逐列填充表格，先填完容量1对应的所有物品数量（第1列），再填容量2对应的所有物品数量（第2列）。</p>
</li>
</ol>
<p>两种顺序都可行，因为计算<code>dp[i][j]</code>时，仅依赖「上一行同列」或「本行左侧列」的结果，这两个位置都已提前填充。实际解题中更常用「先遍历物品，再遍历容量」的顺序，符合「逐个考虑物品是否放入」的思考逻辑。</p>
<h4 data-id="heading-6">1.5 步骤5：打印dp数组（验证）</h4>
<p>通过逐步填充表格、打印中间状态，验证每一步是否符合递推规则：</p>
<h5 data-id="heading-7">1.5.1 填充第1行（i=1，物品1：w=2,v=3）</h5>
<p>填充后第1行：[0,0,3,3,6,6,9,9,12]</p>
<ul>
<li>
<p>j=1：容量&lt;2，无法选，dp[1][1] = dp[0][1] = 0；</p>
</li>
<li>
<p>j=2：容量≥2，选则dp[1][0]+3=3，不选则0，取max=3；</p>
</li>
<li>
<p>j=3：选则dp[1][1]+3=3，不选则0，取max=3；</p>
</li>
<li>
<p>j=4：选则dp[1][2]+3=6，不选则0，取max=6；</p>
</li>
<li>
<p>j=5：选则dp[1][3]+3=6，不选则0，取max=6；</p>
</li>
<li>
<p>j=6：选则dp[1][4]+3=9，不选则0，取max=9；</p>
</li>
<li>
<p>j=7：选则dp[1][5]+3=9，不选则0，取max=9；</p>
</li>
<li>
<p>j=8：选则dp[1][6]+3=12，不选则0，取max=12；</p>
</li>
</ul>
<h5 data-id="heading-8">1.5.2 填充第2行（i=2，物品2：w=3,v=4）</h5>
<p>填充后第2行：[0,0,3,4,6,7,9,10,12]</p>
<ul>
<li>
<p>j=1-2：容量&lt;3，dp[2][j] = dp[1][j]（0,3）；</p>
</li>
<li>
<p>j=3：选则dp[2][0]+4=4，不选则3，取max=4；</p>
</li>
<li>
<p>j=4：选则dp[2][1]+4=4，不选则6，取max=6；</p>
</li>
<li>
<p>j=5：选则dp[2][2]+4=3+4=7，不选则6，取max=7；</p>
</li>
<li>
<p>j=6：选则dp[2][3]+4=4+4=8，不选则9，取max=9；</p>
</li>
<li>
<p>j=7：选则dp[2][4]+4=6+4=10，不选则9，取max=10；</p>
</li>
<li>
<p>j=8：选则dp[2][5]+4=7+4=11，不选则12，取max=12；</p>
</li>
</ul>
<h5 data-id="heading-9">1.5.3 填充第3行（i=3，物品3：w=4,v=5）</h5>
<p>填充后第3行：[0,0,3,4,6,7,9,10,12]</p>
<ul>
<li>
<p>j=1-3：容量&lt;4，dp[3][j] = dp[2][j]（0,3,4）；</p>
</li>
<li>
<p>j=4：选则dp[3][0]+5=5，不选则6，取max=6；</p>
</li>
<li>
<p>j=5：选则dp[3][1]+5=5，不选则7，取max=7；</p>
</li>
<li>
<p>j=6：选则dp[3][2]+5=3+5=8，不选则9，取max=9；</p>
</li>
<li>
<p>j=7：选则dp[3][3]+5=4+5=9，不选则10，取max=10；</p>
</li>
<li>
<p>j=8：选则dp[3][4]+5=6+5=11，不选则12，取max=12；</p>
</li>
</ul>
<p>最终填充完成的表格：</p>

































































<table><thead><tr><th>前i个物品\背包容量j</th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th></tr></thead><tbody><tr><td>0（无物品）</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr><tr><td>1（物品1：w=2,v=3）</td><td>0</td><td>0</td><td>3</td><td>3</td><td>6</td><td>6</td><td>9</td><td>9</td><td>12</td></tr><tr><td>2（物品2：w=3,v=4）</td><td>0</td><td>0</td><td>3</td><td>4</td><td>6</td><td>7</td><td>9</td><td>10</td><td>12</td></tr><tr><td>3（物品3：w=4,v=5）</td><td>0</td><td>0</td><td>3</td><td>4</td><td>6</td><td>7</td><td>9</td><td>10</td><td>12</td></tr></tbody></table>
<p>表格右下角<code>dp[3][8] = 12</code>，与预期结果一致（选4个重量为2的物品，价值3×4=12）。</p>
<h4 data-id="heading-10">1.6 纯完全背包二维DP完整代码（JavaScript）</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 纯完全背包原型（二维DP解法）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">w</span> - 物品重量数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">v</span> - 物品价值数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">c</span> - 背包最大容量
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 背包能容纳的最大价值
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">completeKnapsack_2d</span>(<span class="hljs-params">w, v, c</span>) {
  <span class="hljs-keyword">const</span> n = w.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 1. 初始化二维dp数组：dp[i][j]表示前i个物品放入容量j的背包的最大价值</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(n + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(c + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));

  <span class="hljs-comment">// 2. 遍历顺序：先遍历物品（i从1到n），再遍历容量（j从1到c）（逐行填充）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= c; j++) {
      <span class="hljs-comment">// 3. 递推公式：容量不足则不选，容量充足则选或不选取最大值（选则依赖本行）</span>
      <span class="hljs-keyword">if</span> (j &lt; w[i - <span class="hljs-number">1</span>]) {
        dp[i][j] = dp[i - <span class="hljs-number">1</span>][j];
      } <span class="hljs-keyword">else</span> {
        dp[i][j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(dp[i - <span class="hljs-number">1</span>][j], dp[i][j - w[i - <span class="hljs-number">1</span>]] + v[i - <span class="hljs-number">1</span>]);
      }
    }
  }

  <span class="hljs-comment">// 打印完整dp数组（表格）验证</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'纯完全背包二维DP数组（表格）：'</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= n; i++) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dp[i].<span class="hljs-title function_">join</span>(<span class="hljs-string">'\t'</span>));
  }

  <span class="hljs-comment">// 最终答案：前n个物品放入容量c的背包的最大价值</span>
  <span class="hljs-keyword">return</span> dp[n][c];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-keyword">const</span> w = [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];
<span class="hljs-keyword">const</span> v = [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> c = <span class="hljs-number">8</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'最大价值：'</span>, <span class="hljs-title function_">completeKnapsack_2d</span>(w, v, c)); <span class="hljs-comment">// 输出：12</span>
</code></pre>
<h4 data-id="heading-11">1.7 一维DP优化（空间压缩）</h4>
<p>完全背包的一维DP优化核心是「正序遍历容量」（区别于01背包的逆序），复用本行前序结果实现「无限选」。其优化思路并非凭空设计，而是基于二维DP解法的状态依赖逻辑进行空间压缩，具体可拆解为以下3个关键步骤：</p>
<h5 data-id="heading-12">1. 优化基础：明确二维DP的状态依赖特性</h5>
<p>在纯完全背包的二维DP解法中，递推公式为：当容量j ≥ 物品重量w[i-1]时，dp[i][j] = max(dp[i-1][j], dp[i]j - w[i-1]] + v[i-1])。观察该公式可发现，计算第i行的dp[i][j]时，仅依赖两个位置的状态：① 上一行同列的dp[i-1][j]（不选当前物品的情况）；② 本行左侧列的dp[i]j - w[i-1]]（选当前物品的情况）。</p>
<p>这一依赖特性意味着，我们无需保留完整的二维数组。因为计算第i行数据时，仅需用到上一行的“历史数据”和本行已计算出的“前序数据”，可以用一个一维数组滚动存储这些状态，从而将空间复杂度从O(n×c)优化为O(c)（n为物品数量，c为背包容量）。</p>
<h5 data-id="heading-13">2. 核心设计：正序遍历容量实现“无限选”</h5>
<p>一维DP数组的定义为dp[j]，表示“容量为j的背包能容纳的最大价值”，对应二维数组中当前行的dp[i][j]。为了实现完全背包“物品可无限选取”的特性，内层容量遍历必须采用「正序」（从curW到c，curW为当前物品重量），具体原因如下：</p>
<p>当正序遍历容量时，计算dp[j]时，dp[j - curW]已经是本次遍历物品i时更新过的“本行前序结果”（而非上一轮物品i-1的历史结果）。例如，遍历物品1（w=2,v=3）时，先计算dp[2] = dp[0]+3=3；继续遍历j=4时，dp[4] = dp[2]+3=6，此时复用的dp[2]是已纳入物品1的结果，相当于在背包中再次放入了物品1，实现了“无限选”的效果。</p>
<p>这里需要特别区分与01背包的差异：01背包要求物品只能选一次，因此内层需逆序遍历容量，确保dp[j - curW]使用的是上一轮的历史数据（未纳入当前物品）；而完全背包的正序遍历，正是通过复用本轮已更新的数据，达成“重复选取当前物品”的核心需求。</p>
<h5 data-id="heading-14">3. 遍历逻辑：外层物品、内层容量的固定顺序</h5>
<p>一维DP的遍历顺序必须是「外层遍历物品，内层正序遍历容量」。外层遍历物品保证每个物品都被考虑到，内层正序遍历容量则保证每个物品可以被多次选取。若颠倒遍历顺序（外层容量、内层物品），会导致同一容量下多次重复计算同一物品的贡献，最终结果错误（相当于变成了排列数问题，而非背包最值问题）。</p>
<p>具体遍历流程：① 初始化一维dp数组为全0（对应二维数组第0行的边界条件，无物品时所有容量的最大价值为0）；② 逐个遍历每个物品，获取当前物品的重量curW和价值curV；③ 对每个物品，正序遍历容量从curW到c，通过dp[j] = max(dp[j], dp[j - curW] + curV)更新状态；④ 所有物品遍历完成后，dp[c]即为最终答案。</p>
<h5 data-id="heading-15">4. 与二维解法的结果一致性验证</h5>
<p>以示例中的物品（w=[2,3,4], v=[3,4,5]）和容量c=8为例，一维DP的计算过程与二维数组的填充过程完全匹配：</p>
<p>遍历物品1（w=2,v=3）时，正序更新dp[2]~dp[8]，得到dp=[0,0,3,3,6,6,9,9,12]（对应二维数组第1行）；遍历物品2（w=3,v=4）时，正序更新dp[3]~dp[8]，得到dp=[0,0,3,4,6,7,9,10,12]（对应二维数组第2行）；遍历物品3（w=4,v=5）时，正序更新dp[4]~dp[8]，最终dp=[0,0,3,4,6,7,9,10,12]（对应二维数组第3行），dp[8]=12与二维解法结果一致，验证了优化思路的正确性。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 纯完全背包原型（一维DP优化版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">w</span> - 物品重量数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">v</span> - 物品价值数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">c</span> - 背包最大容量
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 背包能容纳的最大价值
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">completeKnapsack_1d</span>(<span class="hljs-params">w, v, c</span>) {
  <span class="hljs-comment">// 1. 初始化一维dp数组：dp[j]表示容量为j的背包的最大价值</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(c + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 2. 遍历顺序：外层物品，内层正序遍历容量（允许重复选）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; w.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> curW = w[i];
    <span class="hljs-keyword">const</span> curV = v[i];
    <span class="hljs-comment">// 正序遍历：复用本行前序结果，实现无限选</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = curW; j &lt;= c; j++) {
      dp[j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(dp[j], dp[j - curW] + curV);
    }
  }

  <span class="hljs-comment">// 打印一维dp数组验证</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'纯完全背包一维DP数组：'</span>, dp);

  <span class="hljs-comment">// 最终答案：容量c的背包的最大价值</span>
  <span class="hljs-keyword">return</span> dp[c];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'一维优化版最大价值：'</span>, <span class="hljs-title function_">completeKnapsack_1d</span>(w, v, c)); <span class="hljs-comment">// 输出：12</span>
</code></pre>
<h3 data-id="heading-16">二、完全背包变形1：最值类（完全平方数）</h3>
<p>LeetCode链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fperfect-squares%2F" target="_blank" title="https://leetcode.cn/problems/perfect-squares/" ref="nofollow noopener noreferrer">leetcode.cn/problems/pe…</a></p>
<h4 data-id="heading-17">题目描述</h4>
<p>给定正整数 <code>n</code>，找到若干完全平方数（1,4,9...）使其和等于 <code>n</code>，要求个数最少。</p>
<p>示例：<code>n=12</code> → 输出3（12=4+4+4）；<code>n=13</code> → 输出2（13=4+9）。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontzhm.github.io%2Fblog-demo%2Fdp3-wq2.html" target="_blank" title="https://frontzhm.github.io/blog-demo/dp3-wq2.html" ref="nofollow noopener noreferrer">表格动态演示</a></p>
<h4 data-id="heading-18">2.1 步骤1：确定dp数组及下标的含义</h4>
<p>定义二维数组<code>dp[i][j]</code>：表示「前i个完全平方数（1²,2²,...,i²）凑出和为j的最少个数」。</p>
<p>对应表格维度：i（行）表示完全平方数的个数（从0到m，m=Math.floor(Math.sqrt(n))），j（列）表示目标和（从0到n）。</p>
<h4 data-id="heading-19">2.2 步骤2：确定递推公式</h4>
<p>对于第i个完全平方数（值<code>curPow = i²</code>），有两种决策：选或不选：</p>
<ol>
<li>
<p><strong>不选第i个完全平方数</strong>：<code>dp[i][j] = dp[i-1][j]</code>；</p>
</li>
<li>
<p><strong>选第i个完全平方数</strong>：需保证j ≥ curPow，此时<code>dp[i][j] = dp[i][j - curPow] + 1</code>（选后仍能选当前数，+1表示个数加1）。</p>
</li>
</ol>
<p>最终递推公式（取两种决策的最小值）：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-keyword">if</span> (j &lt; curPow) {
  dp[i][j] = dp[i - <span class="hljs-number">1</span>][j];
} <span class="hljs-keyword">else</span> {
  dp[i][j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(dp[i - <span class="hljs-number">1</span>][j], dp[i][j - curPow] + <span class="hljs-number">1</span>);
}
</code></pre>
<h4 data-id="heading-20">2.3 步骤3：dp数组如何初始化</h4>
<p>最值类问题初始化核心是「默认值设为无穷大（表示不可达），边界设为0」：</p>
<ol>
<li>
<p><strong>i=0（无完全平方数）</strong>：除j=0外，其余<code>dp[0][j] = Infinity</code>（无数字无法凑出和）；</p>
</li>
<li>
<p><strong>j=0（凑0）</strong>：所有i的<code>dp[i][0] = 0</code>（凑0需要0个数字）；</p>
</li>
<li>
<p>其余单元格初始化为<code>Infinity</code>（默认不可达）。</p>
</li>
</ol>
<h4 data-id="heading-21">2.4 步骤4：确定遍历顺序</h4>
<p>先遍历完全平方数（i从1到m），再遍历目标和（j从1到n），逐行填充表格。</p>
<h4 data-id="heading-22">2.5 步骤5：打印dp数组（验证）</h4>
<p>以<code>n=12</code>为例（m=3，对应1²、2²、3²），最终表格右下角<code>dp[3][12] = 3</code>，与预期一致。</p>
<h4 data-id="heading-23">2.6 二维DP完整代码（JavaScript）</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 完全平方数（二维DP解法）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">n</span> - 目标数
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 最少完全平方数个数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">numSquares_2d</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">const</span> m = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(n)); <span class="hljs-comment">// 最大完全平方数的底数</span>
  <span class="hljs-comment">// 1. 初始化二维dp数组：dp[i][j]前i个完全平方数凑和j的最少个数，默认Infinity</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(m + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(n + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-title class_">Infinity</span>));

  <span class="hljs-comment">// 2. 边界条件：凑0需要0个</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= m; i++) {
    dp[i][<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
  }

  <span class="hljs-comment">// 3. 遍历顺序：先遍历完全平方数，再遍历目标和</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= m; i++) {
    <span class="hljs-keyword">const</span> curPow = i * i; <span class="hljs-comment">// 第i个完全平方数</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= n; j++) {
      <span class="hljs-comment">// 4. 递推公式</span>
      <span class="hljs-keyword">if</span> (j &lt; curPow) {
        dp[i][j] = dp[i - <span class="hljs-number">1</span>][j];
      } <span class="hljs-keyword">else</span> {
        dp[i][j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(dp[i - <span class="hljs-number">1</span>][j], dp[i][j - curPow] + <span class="hljs-number">1</span>);
      }
    }
  }

  <span class="hljs-comment">// 打印dp数组验证</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'完全平方数二维DP数组：'</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= m; i++) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dp[i].<span class="hljs-title function_">join</span>(<span class="hljs-string">'\t'</span>));
  }

  <span class="hljs-keyword">return</span> dp[m][n];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'最少个数（n=12）：'</span>, <span class="hljs-title function_">numSquares_2d</span>(<span class="hljs-number">12</span>)); <span class="hljs-comment">// 输出：3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'最少个数（n=13）：'</span>, <span class="hljs-title function_">numSquares_2d</span>(<span class="hljs-number">13</span>)); <span class="hljs-comment">// 输出：2</span>
</code></pre>
<h4 data-id="heading-24">2.7 一维DP优化</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 完全平方数（一维DP优化版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">n</span> - 目标数
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 最少完全平方数个数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">numSquares_1d</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-comment">// 1. 初始化一维dp数组：dp[j]凑和j的最少个数</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(n + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-title class_">Infinity</span>);
  dp[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>; <span class="hljs-comment">// 边界：凑0需要0个</span>

  <span class="hljs-keyword">const</span> m = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sqrt</span>(n));
  <span class="hljs-comment">// 2. 遍历顺序：外层完全平方数，内层正序遍历和</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= m; i++) {
    <span class="hljs-keyword">const</span> curPow = i * i;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = curPow; j &lt;= n; j++) {
      dp[j] = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(dp[j], dp[j - curPow] + <span class="hljs-number">1</span>);
    }
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'完全平方数一维DP数组：'</span>, dp);
  <span class="hljs-keyword">return</span> dp[n];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'一维优化版最少个数（n=12）：'</span>, <span class="hljs-title function_">numSquares_1d</span>(<span class="hljs-number">12</span>)); <span class="hljs-comment">// 输出：3</span>
</code></pre>
<h3 data-id="heading-25">三、完全背包变形2：计数类（组合数/排列数）</h3>
<p>计数类是完全背包最易混淆的变形，核心区别是「是否考虑顺序」：</p>
<ul>
<li>
<p>组合数：顺序无关（零钱兑换II）→ 外层物品，内层容量；</p>
</li>
<li>
<p>排列数：顺序有关（组合总和IV）→ 外层容量，内层物品。</p>
</li>
</ul>
<h4 data-id="heading-26">3.1 子变形2.1：组合数（零钱兑换II）</h4>
<p>LeetCode链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fcoin-change-ii%2F" target="_blank" title="https://leetcode.cn/problems/coin-change-ii/" ref="nofollow noopener noreferrer">leetcode.cn/problems/co…</a></p>
<h5 data-id="heading-27">题目描述</h5>
<p>给定硬币数组 <code>coins</code> 和总金额 <code>amount</code>，求凑成总金额的组合数（硬币可重复选）。</p>
<p>示例：<code>coins=[1,2,5], amount=5</code> → 输出4（5=5/2+2+1/2+1+1+1/1×5）。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontzhm.github.io%2Fblog-demo%2Fdp3-wq3.html" target="_blank" title="https://frontzhm.github.io/blog-demo/dp3-wq3.html" ref="nofollow noopener noreferrer">表格动态演示</a></p>
<h5 data-id="heading-28">3.1.1 步骤1：确定dp数组及下标的含义</h5>
<p>定义二维数组<code>dp[i][j]</code>：表示「前i种硬币凑出金额j的组合数」。</p>
<h5 data-id="heading-29">3.1.2 步骤2：确定递推公式</h5>
<ol>
<li>
<p><strong>不选第i种硬币</strong>：<code>dp[i][j] = dp[i-1][j]</code>；</p>
</li>
<li>
<p><strong>选第i种硬币</strong>：j ≥ coins[i-1]时，<code>dp[i][j] += dp[i][j - coins[i-1]]</code>；</p>
</li>
</ol>
<p>最终：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-keyword">if</span> (j &lt; coins[i-<span class="hljs-number">1</span>]) {
  dp[i][j] = dp[i-<span class="hljs-number">1</span>][j];
} <span class="hljs-keyword">else</span> {
  dp[i][j] = dp[i-<span class="hljs-number">1</span>][j] + dp[i][j - coins[i-<span class="hljs-number">1</span>]];
}
</code></pre>
<h5 data-id="heading-30">3.1.3 步骤3：dp数组如何初始化</h5>
<ol>
<li>
<p><strong>j=0（凑0）</strong>：所有i的<code>dp[i][0] = 1</code>（不选任何硬币是唯一方式）；</p>
</li>
<li>
<p><strong>i=0（无硬币）</strong>：j&gt;0时<code>dp[0][j] = 0</code>（无硬币无法凑金额）。</p>
</li>
</ol>
<h5 data-id="heading-31">3.1.4 步骤4：确定遍历顺序</h5>
<p>先遍历硬币（i从1到len），再遍历金额（j从1到amount），逐行填充。</p>
<h5 data-id="heading-32">3.1.5 步骤5：打印dp数组（验证）</h5>
<p>以<code>coins=[1,2,5], amount=5</code>为例，最终<code>dp[3][5] = 4</code>，与预期一致。</p>
<h5 data-id="heading-33">3.1.6 二维DP完整代码</h5>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 零钱兑换II（二维DP解法）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">amount</span> - 总金额
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">coins</span> - 硬币数组
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 组合数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">change_2d</span>(<span class="hljs-params">amount, coins</span>) {
  <span class="hljs-keyword">const</span> len = coins.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 1. 初始化二维dp数组：dp[i][j]前i种硬币凑金额j的组合数</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(len + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(amount + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));

  <span class="hljs-comment">// 2. 边界条件：凑0有1种方式</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= len; i++) {
    dp[i][<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
  }

  <span class="hljs-comment">// 3. 遍历顺序：先遍历硬币，再遍历金额</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt;= len; i++) {
    <span class="hljs-keyword">const</span> curCoin = coins[i - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= amount; j++) {
      <span class="hljs-comment">// 4. 递推公式</span>
      <span class="hljs-keyword">if</span> (j &lt; curCoin) {
        dp[i][j] = dp[i - <span class="hljs-number">1</span>][j];
      } <span class="hljs-keyword">else</span> {
        dp[i][j] = dp[i - <span class="hljs-number">1</span>][j] + dp[i][j - curCoin];
      }
    }
  }

  <span class="hljs-comment">// 打印dp数组验证</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'零钱兑换II二维DP数组：'</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= len; i++) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dp[i].<span class="hljs-title function_">join</span>(<span class="hljs-string">'\t'</span>));
  }

  <span class="hljs-keyword">return</span> dp[len][amount];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组合数（amount=5）：'</span>, <span class="hljs-title function_">change_2d</span>(<span class="hljs-number">5</span>, [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>])); <span class="hljs-comment">// 输出：4</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组合数（amount=3）：'</span>, <span class="hljs-title function_">change_2d</span>(<span class="hljs-number">3</span>, [<span class="hljs-number">2</span>])); <span class="hljs-comment">// 输出：0</span>
</code></pre>
<h5 data-id="heading-34">3.1.7 一维DP优化</h5>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 零钱兑换II（一维DP优化版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">amount</span> - 总金额
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">coins</span> - 硬币数组
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 组合数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">change_1d</span>(<span class="hljs-params">amount, coins</span>) {
  <span class="hljs-comment">// 1. 初始化一维dp数组：dp[j]凑金额j的组合数</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(amount + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);
  dp[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>; <span class="hljs-comment">// 边界：凑0有1种方式</span>

  <span class="hljs-comment">// 2. 遍历顺序：外层硬币（保证顺序无关），内层正序遍历金额</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> curCoin <span class="hljs-keyword">of</span> coins) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = curCoin; j &lt;= amount; j++) {
      dp[j] += dp[j - curCoin];
    }
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'零钱兑换II一维DP数组：'</span>, dp);
  <span class="hljs-keyword">return</span> dp[amount];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'一维优化版组合数：'</span>, <span class="hljs-title function_">change_1d</span>(<span class="hljs-number">5</span>, [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>])); <span class="hljs-comment">// 输出：4</span>
</code></pre>
<h4 data-id="heading-35">3.2 子变形2.2：排列数（组合总和IV）</h4>
<p>LeetCode链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fcombination-sum-iv%2F" target="_blank" title="https://leetcode.cn/problems/combination-sum-iv/" ref="nofollow noopener noreferrer">leetcode.cn/problems/co…</a></p>
<h5 data-id="heading-36">题目描述</h5>
<p>给定数组 <code>nums</code> 和目标 <code>target</code>，求总和为 <code>target</code> 的排列数（元素可重复选）。</p>
<p>示例：<code>nums=[1,2], target=3</code> → 输出3（1+1+1/1+2/2+1）。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontzhm.github.io%2Fblog-demo%2Fdp3-wq4.html" target="_blank" title="https://frontzhm.github.io/blog-demo/dp3-wq4.html" ref="nofollow noopener noreferrer">表格动态演示</a></p>
<h5 data-id="heading-37">3.2.1 步骤1：确定dp数组及下标的含义</h5>
<p>定义二维数组<code>dp[j][k]</code>：表示「凑金额j，最后一步选nums[k]的排列数」，总排列数<code>total[j] = sum(dp[j][k])</code>。</p>
<h5 data-id="heading-38">3.2.2 步骤2：确定递推公式</h5>
<p>对于金额j、数字nums[k]：</p>
<ul>
<li>
<p>j &lt; nums[k]：<code>dp[j][k] = 0</code>（金额不足）；</p>
</li>
<li>
<p>j ≥ nums[k]：<code>dp[j][k] = total[j - nums[k]]</code>（最后一步选nums[k]，前面凑j-nums[k]的总排列数）。</p>
</li>
</ul>
<h5 data-id="heading-39">3.2.3 步骤3：dp数组如何初始化</h5>
<ol>
<li>
<p><strong>j=0（凑0）</strong>：<code>total[0] = 1</code>（不选任何数），<code>dp[0][k] = 0</code>；</p>
</li>
<li>
<p>其余<code>total[j]</code>初始化为0，<code>dp[j][k]</code>初始化为0。</p>
</li>
</ol>
<h5 data-id="heading-40">3.2.4 步骤4：确定遍历顺序</h5>
<p>先遍历金额（j从1到target），再遍历数字（k从0到len-1），逐列填充。</p>
<h5 data-id="heading-41">3.2.5 步骤5：打印dp数组（验证）</h5>
<p>以<code>nums=[1,2], target=3</code>为例，最终<code>total[3] = 3</code>，与预期一致。</p>
<h5 data-id="heading-42">3.2.6 二维思路完整代码</h5>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 组合总和IV（二维思路版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">nums</span> - 可选数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">target</span> - 目标和
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 排列数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">combinationSum4_2d</span>(<span class="hljs-params">nums, target</span>) {
  <span class="hljs-keyword">const</span> len = nums.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 1. 初始化dp表格：dp[j][k]凑j，最后一步选nums[k]的排列数</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(target + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(len).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));
  <span class="hljs-comment">// 2. 总排列数数组：total[j]凑j的总排列数</span>
  <span class="hljs-keyword">const</span> total = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(target + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);
  total[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>; <span class="hljs-comment">// 边界：凑0有1种方式</span>

  <span class="hljs-comment">// 3. 遍历顺序：外层金额，内层数字（保证顺序有关）</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= target; j++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; len; k++) {
      <span class="hljs-keyword">const</span> num = nums[k];
      <span class="hljs-comment">// 4. 递推公式</span>
      <span class="hljs-keyword">if</span> (j &gt;= num) {
        dp[j][k] = total[j - num];
      } <span class="hljs-keyword">else</span> {
        dp[j][k] = <span class="hljs-number">0</span>;
      }
    }
    <span class="hljs-comment">// 总排列数 = 所有最后一步的情况求和</span>
    total[j] = dp[j].<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, val</span>) =&gt;</span> sum + val, <span class="hljs-number">0</span>);
  }

  <span class="hljs-comment">// 打印验证</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组合总和IV dp表格：'</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt;= target; j++) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`j=<span class="hljs-subst">${j}</span>: `</span>, dp[j].<span class="hljs-title function_">join</span>(<span class="hljs-string">'\t'</span>), <span class="hljs-string">'→ 总排列数：'</span>, total[j]);
  }

  <span class="hljs-keyword">return</span> total[target];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'排列数（target=3）：'</span>, <span class="hljs-title function_">combinationSum4_2d</span>([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], <span class="hljs-number">3</span>)); <span class="hljs-comment">// 输出：3</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'排列数（target=4）：'</span>, <span class="hljs-title function_">combinationSum4_2d</span>([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>], <span class="hljs-number">4</span>)); <span class="hljs-comment">// 输出：7</span>
</code></pre>
<h5 data-id="heading-43">3.2.7 一维DP优化</h5>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 组合总和IV（一维DP优化版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number[]</span>} <span class="hljs-variable">nums</span> - 可选数组
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">target</span> - 目标和
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">number</span>} - 排列数
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">combinationSum4_1d</span>(<span class="hljs-params">nums, target</span>) {
  <span class="hljs-comment">// 1. 初始化一维dp数组：dp[j]凑j的排列数</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(target + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>);
  dp[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>; <span class="hljs-comment">// 边界：凑0有1种方式</span>

  <span class="hljs-comment">// 2. 遍历顺序：外层金额（保证顺序有关），内层数字</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= target; j++) {
    <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> num <span class="hljs-keyword">of</span> nums) {
      <span class="hljs-keyword">if</span> (j &gt;= num) {
        count += dp[j - num];
      }
    }
    dp[j] = count;
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'组合总和IV一维DP数组：'</span>, dp);
  <span class="hljs-keyword">return</span> dp[target];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'一维优化版排列数：'</span>, <span class="hljs-title function_">combinationSum4_1d</span>([<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], <span class="hljs-number">3</span>)); <span class="hljs-comment">// 输出：3</span>
</code></pre>
<h3 data-id="heading-44">四、完全背包变形3：进阶类（单词拆分）</h3>
<p>LeetCode链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fword-break%2F" target="_blank" title="https://leetcode.cn/problems/word-break/" ref="nofollow noopener noreferrer">leetcode.cn/problems/wo…</a></p>
<h4 data-id="heading-45">题目描述</h4>
<p>判断字符串 <code>s</code> 能否被字典 <code>wordDict</code> 中的单词拼接（单词可重复用）。</p>
<p>示例：<code>s="leetcode", wordDict=["leet","code"]</code> → 输出true；<code>s="catsandog", wordDict=["cats","dog","sand","and","cat"]</code> → 输出false。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffrontzhm.github.io%2Fblog-demo%2Fdp3-wq5.html" target="_blank" title="https://frontzhm.github.io/blog-demo/dp3-wq5.html" ref="nofollow noopener noreferrer">表格动态演示</a></p>
<h4 data-id="heading-46">4.1 步骤1：确定dp数组及下标的含义</h4>
<p>定义二维数组<code>dp[j][k]</code>：表示「前j个字符，最后一步拼接wordDict[k]是否可行」，总结果<code>canBreak[j] = any(dp[j][k])</code>（只要有一个k可行则为true）。</p>
<h4 data-id="heading-47">4.2 步骤2：确定递推公式</h4>
<p>对于前j个字符、单词wordDict[k]（长度len）：</p>
<ul>
<li>
<p>j &lt; len：<code>dp[j][k] = false</code>（长度不足）；</p>
</li>
<li>
<p>j ≥ len：<code>dp[j][k] = canBreak[j - len] &amp;&amp; (s.slice(j-len,j) === wordDict[k])</code>（前面可拆分 + 子串匹配）。</p>
</li>
</ul>
<h4 data-id="heading-48">4.3 步骤3：dp数组如何初始化</h4>
<ol>
<li>
<p><strong>j=0（空字符串）</strong>：<code>canBreak[0] = true</code>（空字符串可拆分），<code>dp[0][k] = false</code>；</p>
</li>
<li>
<p>其余<code>canBreak[j]</code>初始化为false，<code>dp[j][k]</code>初始化为false。</p>
</li>
</ol>
<h4 data-id="heading-49">4.4 步骤4：确定遍历顺序</h4>
<p>先遍历字符长度（j从1到len(s)），再遍历单词（k从0到len(wordDict)-1），逐列填充。</p>
<h4 data-id="heading-50">4.5 步骤5：打印dp数组（验证）</h4>
<p>以<code>s="leetcode", wordDict=["leet","code"]</code>为例，最终<code>canBreak[8] = true</code>，与预期一致。</p>
<h4 data-id="heading-51">4.6 二维思路完整代码</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 单词拆分（二维思路版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">s</span> - 待拆分字符串
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string[]</span>} <span class="hljs-variable">wordDict</span> - 单词字典
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} - 是否可拆分
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">wordBreak_2d</span>(<span class="hljs-params">s, wordDict</span>) {
  <span class="hljs-keyword">const</span> targetLen = s.<span class="hljs-property">length</span>;
  <span class="hljs-keyword">const</span> len = wordDict.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 1. 初始化dp表格：dp[j][k]前j个字符，最后一步拼接wordDict[k]是否可行</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(targetLen + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(len).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">false</span>));
  <span class="hljs-comment">// 2. 总结果数组：canBreak[j]前j个字符是否可拆分</span>
  <span class="hljs-keyword">const</span> canBreak = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(targetLen + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">false</span>);
  canBreak[<span class="hljs-number">0</span>] = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 边界：空字符串可拆分</span>

  <span class="hljs-comment">// 3. 遍历顺序：外层字符长度，内层单词</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= targetLen; j++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> k = <span class="hljs-number">0</span>; k &lt; len; k++) {
      <span class="hljs-keyword">const</span> word = wordDict[k];
      <span class="hljs-keyword">const</span> wordLen = word.<span class="hljs-property">length</span>;
      <span class="hljs-comment">// 4. 递推公式</span>
      <span class="hljs-keyword">if</span> (j &gt;= wordLen) {
        <span class="hljs-keyword">const</span> subStr = s.<span class="hljs-title function_">slice</span>(j - wordLen, j);
        dp[j][k] = canBreak[j - wordLen] &amp;&amp; (subStr === word);
      } <span class="hljs-keyword">else</span> {
        dp[j][k] = <span class="hljs-literal">false</span>;
      }
    }
    <span class="hljs-comment">// 只要有一个单词可行，前j个字符就可拆分</span>
    canBreak[j] = dp[j].<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> val === <span class="hljs-literal">true</span>);
  }

  <span class="hljs-comment">// 打印验证</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'单词拆分dp表格：'</span>);
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt;= targetLen; j++) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`j=<span class="hljs-subst">${j}</span>: `</span>, dp[j].<span class="hljs-title function_">join</span>(<span class="hljs-string">'\t'</span>), <span class="hljs-string">'→ 是否可拆分：'</span>, canBreak[j]);
  }

  <span class="hljs-keyword">return</span> canBreak[targetLen];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'是否可拆分（leetcode）：'</span>, <span class="hljs-title function_">wordBreak_2d</span>(<span class="hljs-string">"leetcode"</span>, [<span class="hljs-string">"leet"</span>,<span class="hljs-string">"code"</span>])); <span class="hljs-comment">// 输出：true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'是否可拆分（catsandog）：'</span>, <span class="hljs-title function_">wordBreak_2d</span>(<span class="hljs-string">"catsandog"</span>, [<span class="hljs-string">"cats"</span>,<span class="hljs-string">"dog"</span>,<span class="hljs-string">"sand"</span>,<span class="hljs-string">"and"</span>,<span class="hljs-string">"cat"</span>])); <span class="hljs-comment">// 输出：false</span>
</code></pre>
<h4 data-id="heading-52">4.7 一维DP优化</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript">
<span class="hljs-comment">/**
 * 单词拆分（一维DP优化版）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">s</span> - 待拆分字符串
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string[]</span>} <span class="hljs-variable">wordDict</span> - 单词字典
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} - 是否可拆分
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">wordBreak_1d</span>(<span class="hljs-params">s, wordDict</span>) {
  <span class="hljs-keyword">const</span> targetLen = s.<span class="hljs-property">length</span>;
  <span class="hljs-comment">// 1. 初始化一维dp数组：dp[j]前j个字符是否可拆分</span>
  <span class="hljs-keyword">const</span> dp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(targetLen + <span class="hljs-number">1</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">false</span>);
  dp[<span class="hljs-number">0</span>] = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 边界：空字符串可拆分</span>

  <span class="hljs-comment">// 2. 遍历顺序：外层字符长度，内层单词</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">1</span>; j &lt;= targetLen; j++) {
    <span class="hljs-keyword">const</span> curStr = s.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, j);
    <span class="hljs-keyword">let</span> can = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> word <span class="hljs-keyword">of</span> wordDict) {
      <span class="hljs-keyword">const</span> wordLen = word.<span class="hljs-property">length</span>;
      <span class="hljs-keyword">if</span> (wordLen &gt; j) <span class="hljs-keyword">continue</span>;
      <span class="hljs-comment">// 3. 递推公式：后缀匹配 + 前面可拆分</span>
      can = can || (dp[j - wordLen] &amp;&amp; curStr.<span class="hljs-title function_">endsWith</span>(word));
      <span class="hljs-keyword">if</span> (can) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 提前终止</span>
    }
    dp[j] = can;
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'单词拆分一维DP数组：'</span>, dp);
  <span class="hljs-keyword">return</span> dp[targetLen];
}

<span class="hljs-comment">// 测试用例</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'一维优化版是否可拆分：'</span>, <span class="hljs-title function_">wordBreak_1d</span>(<span class="hljs-string">"leetcode"</span>, [<span class="hljs-string">"leet"</span>,<span class="hljs-string">"code"</span>])); <span class="hljs-comment">// 输出：true</span>
</code></pre>
<h3 data-id="heading-53">五、核心总结</h3>















































<table><thead><tr><th>题型</th><th>LeetCode链接</th><th>二维DP核心意义</th><th>一维遍历顺序</th><th>状态转移核心</th></tr></thead><tbody><tr><td>纯完全背包</td><td>无（经典原型）</td><td>直观体现「重复选」的状态转移</td><td>外层物品+正序容量</td><td>max(不选, 选)</td></tr><tr><td>完全平方数</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fperfect-squares%2F" target="_blank" title="https://leetcode.cn/problems/perfect-squares/" ref="nofollow noopener noreferrer">leetcode.cn/problems/pe…</a></td><td>理解「最值类」初始化逻辑</td><td>外层物品+正序容量</td><td>min(不选, 选+1)</td></tr><tr><td>零钱兑换II</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fcoin-change-ii%2F" target="_blank" title="https://leetcode.cn/problems/coin-change-ii/" ref="nofollow noopener noreferrer">leetcode.cn/problems/co…</a></td><td>理解「组合数」的状态继承</td><td>外层物品+正序容量</td><td>不选 + 选</td></tr><tr><td>组合总和IV</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fcombination-sum-iv%2F" target="_blank" title="https://leetcode.cn/problems/combination-sum-iv/" ref="nofollow noopener noreferrer">leetcode.cn/problems/co…</a></td><td>理解「最后一步」的表格拆分</td><td>外层容量+内层物品</td><td>累加所有「最后一步」的可能</td></tr><tr><td>单词拆分</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fword-break%2F" target="_blank" title="https://leetcode.cn/problems/word-break/" ref="nofollow noopener noreferrer">leetcode.cn/problems/wo…</a></td><td>理解「字符串匹配+DP」的结合</td><td>外层容量+内层物品</td><td>或运算（存在一种即可）</td></tr></tbody></table>
<h4 data-id="heading-54">学习建议</h4>
<ol>
<li>
<p><strong>先二维，后一维</strong>：二维数组能直观体现状态转移逻辑，一维优化是空间压缩，不要跳过二维直接学一维；</p>
</li>
<li>
<p><strong>手动填小表格</strong>：对易混淆的排列/组合数，用小例子手动填充表格，快速理解遍历顺序的影响；</p>
</li>
<li>
<p><strong>抓「最后一步」核心</strong>：所有完全背包变形的递推公式，本质都是「最后一步选什么」；</p>
</li>
<li>
<p><strong>区分遍历顺序</strong>：物品外层=组合（顺序无关），容量外层=排列（顺序有关）。</p>
</li>
</ol>
<p>完全背包的所有变形本质都是「状态表格的填充规则变化」，掌握了填充表格法，无论题型如何变形，都能快速拆解核心逻辑！</p>
<p>有N种物品和⼀个容量为V 的背包。第i种物品最多有Mi件可⽤，每件耗费的空间是Ci ，价值是Wi 。求解将哪些物品装⼊背包可使这些物品的耗费的空间 总和不超过背包容量，且价值总和最⼤。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何使用for...of遍历对象]]></title>    <link>https://juejin.cn/post/7592615536385540130</link>    <guid>https://juejin.cn/post/7592615536385540130</guid>    <pubDate>2026-01-08T14:03:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592615536385540130" data-draft-id="7592615536385523746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何使用for...of遍历对象"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-08T14:03:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何使用for...of遍历对象
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T14:03:27.000Z" title="Thu Jan 08 2026 14:03:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>虽然普通对象默认不支持 <code>for...of</code>，但有多种方法可以实现：</p>
<h2 data-id="heading-0">1. <strong>使用 Object 的辅助方法</strong></h2>
<h3 data-id="heading-1">遍历键名 (keys)</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">3</span> };

<span class="hljs-comment">// 方法1: Object.keys()</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key); <span class="hljs-comment">// 'a', 'b', 'c'</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj[key]); <span class="hljs-comment">// 1, 2, 3</span>
}

<span class="hljs-comment">// 方法2: 使用数组的解构和循环</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj)) {
  <span class="hljs-keyword">const</span> value = obj[key];
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value);
}
</code></pre>
<h3 data-id="heading-2">遍历值 (values)</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">3</span> };

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 1, 2, 3</span>
}
</code></pre>
<h3 data-id="heading-3">遍历键值对 (entries)</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">3</span> };

<span class="hljs-comment">// 方法1: 使用数组解构</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value); <span class="hljs-comment">// 'a' 1, 'b' 2, 'c' 3</span>
}

<span class="hljs-comment">// 方法2: 不使用解构</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj)) {
  <span class="hljs-keyword">const</span> key = entry[<span class="hljs-number">0</span>];
  <span class="hljs-keyword">const</span> value = entry[<span class="hljs-number">1</span>];
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value);
}
</code></pre>
<h2 data-id="heading-4">2. <strong>使对象本身可迭代 (实现 Symbol.iterator)</strong></h2>
<h3 data-id="heading-5">基本实现</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>,
  <span class="hljs-attr">city</span>: <span class="hljs-string">'New York'</span>,
  
  <span class="hljs-comment">// 添加 Symbol.iterator 方法</span>
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>* () {
    <span class="hljs-comment">// 遍历自身属性</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>)) {
      <span class="hljs-keyword">yield</span> [key, <span class="hljs-variable language_">this</span>[key]];
    }
  }
};

<span class="hljs-comment">// 现在可以用 for...of 直接遍历</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> obj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${key}</span>: <span class="hljs-subst">${value}</span>`</span>);
}
<span class="hljs-comment">// 输出:</span>
<span class="hljs-comment">// name: John</span>
<span class="hljs-comment">// age: 30</span>
<span class="hljs-comment">// city: New York</span>
</code></pre>
<h3 data-id="heading-6">只返回值的迭代器</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">c</span>: <span class="hljs-number">3</span>,
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>* () {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>)) {
      <span class="hljs-keyword">yield</span> <span class="hljs-variable language_">this</span>[key];
    }
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> obj) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 1, 2, 3</span>
}
</code></pre>
<h2 data-id="heading-7">3. <strong>自定义迭代行为</strong></h2>
<h3 data-id="heading-8">按特定顺序迭代</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> user = {
  <span class="hljs-attr">firstName</span>: <span class="hljs-string">'John'</span>,
  <span class="hljs-attr">lastName</span>: <span class="hljs-string">'Doe'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>,
  <span class="hljs-attr">email</span>: <span class="hljs-string">'john@example.com'</span>,
  
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>* () {
    <span class="hljs-comment">// 自定义迭代顺序</span>
    <span class="hljs-keyword">yield</span> [<span class="hljs-string">'姓名'</span>, <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.firstName}</span> <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.lastName}</span>`</span>];
    <span class="hljs-keyword">yield</span> [<span class="hljs-string">'年龄'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span>];
    <span class="hljs-keyword">yield</span> [<span class="hljs-string">'邮箱'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">email</span>];
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [label, value] <span class="hljs-keyword">of</span> user) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${label}</span>: <span class="hljs-subst">${value}</span>`</span>);
}
<span class="hljs-comment">// 输出:</span>
<span class="hljs-comment">// 姓名: John Doe</span>
<span class="hljs-comment">// 年龄: 30</span>
<span class="hljs-comment">// 邮箱: john@example.com</span>
</code></pre>
<h3 data-id="heading-9">只迭代特定属性</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> product = {
  <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">name</span>: <span class="hljs-string">'Laptop'</span>,
  <span class="hljs-attr">price</span>: <span class="hljs-number">999.99</span>,
  <span class="hljs-attr">category</span>: <span class="hljs-string">'Electronics'</span>,
  <span class="hljs-attr">inStock</span>: <span class="hljs-literal">true</span>,
  
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]: <span class="hljs-keyword">function</span>* () {
    <span class="hljs-comment">// 只迭代非布尔值的属性</span>
    <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> keys) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span>[key] !== <span class="hljs-string">'boolean'</span>) {
        <span class="hljs-keyword">yield</span> [key, <span class="hljs-variable language_">this</span>[key]];
      }
    }
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> product) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${key}</span>: <span class="hljs-subst">${value}</span>`</span>);
}
<span class="hljs-comment">// 输出:</span>
<span class="hljs-comment">// id: 1</span>
<span class="hljs-comment">// name: Laptop</span>
<span class="hljs-comment">// price: 999.99</span>
<span class="hljs-comment">// category: Electronics</span>
</code></pre>
<h2 data-id="heading-10">4. <strong>类实例的可迭代性</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserCollection</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span> = [];
  }
  
  <span class="hljs-title function_">add</span>(<span class="hljs-params">user</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>.<span class="hljs-title function_">push</span>(user);
  }
  
  <span class="hljs-comment">// 使实例可迭代</span>
  *[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>]() {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> user <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>) {
      <span class="hljs-keyword">yield</span> user;
    }
  }
  
  <span class="hljs-comment">// 或者返回键值对</span>
  *<span class="hljs-title function_">entries</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>.<span class="hljs-property">length</span>; i++) {
      <span class="hljs-keyword">yield</span> [i, <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span>[i]];
    }
  }
}

<span class="hljs-keyword">const</span> collection = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserCollection</span>();
collection.<span class="hljs-title function_">add</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> });
collection.<span class="hljs-title function_">add</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> });

<span class="hljs-comment">// 遍历用户</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> user <span class="hljs-keyword">of</span> collection) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>, user.<span class="hljs-property">age</span>);
}

<span class="hljs-comment">// 遍历带索引的用户</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [index, user] <span class="hljs-keyword">of</span> collection.<span class="hljs-title function_">entries</span>()) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(index, user.<span class="hljs-property">name</span>);
}
</code></pre>
<h2 data-id="heading-11">5. <strong>使用生成器函数</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span>* <span class="hljs-title function_">objectEntries</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj)) {
    <span class="hljs-keyword">yield</span> [key, obj[key]];
  }
}

<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">x</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">z</span>: <span class="hljs-number">30</span> };

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title function_">objectEntries</span>(obj)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value);
}
</code></pre>
<h2 data-id="heading-12">6. <strong>实际应用场景</strong></h2>
<h3 data-id="heading-13">场景1：遍历配置对象</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">apiUrl</span>: <span class="hljs-string">'https://api.example.com'</span>,
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>,
  <span class="hljs-attr">retries</span>: <span class="hljs-number">3</span>,
  <span class="hljs-attr">debug</span>: <span class="hljs-literal">false</span>
};

<span class="hljs-comment">// 配置迭代器</span>
config[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>] = <span class="hljs-keyword">function</span>* () {
  <span class="hljs-keyword">const</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>).<span class="hljs-title function_">sort</span>(); <span class="hljs-comment">// 按字母排序</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> keys) {
    <span class="hljs-keyword">yield</span> { key, <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>[key] };
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> { key, value } <span class="hljs-keyword">of</span> config) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value !== <span class="hljs-string">'boolean'</span>) { <span class="hljs-comment">// 过滤布尔值</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`配置 <span class="hljs-subst">${key}</span> = <span class="hljs-subst">${value}</span>`</span>);
  }
}
</code></pre>
<h3 data-id="heading-14">场景2：处理嵌套对象</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> company = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'TechCorp'</span>,
  <span class="hljs-attr">departments</span>: {
    <span class="hljs-attr">engineering</span>: { <span class="hljs-attr">employees</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">budget</span>: <span class="hljs-number">1000000</span> },
    <span class="hljs-attr">sales</span>: { <span class="hljs-attr">employees</span>: <span class="hljs-number">20</span>, <span class="hljs-attr">budget</span>: <span class="hljs-number">500000</span> },
    <span class="hljs-attr">marketing</span>: { <span class="hljs-attr">employees</span>: <span class="hljs-number">15</span>, <span class="hljs-attr">budget</span>: <span class="hljs-number">300000</span> }
  }
};

<span class="hljs-comment">// 扁平化迭代器</span>
company[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>] = <span class="hljs-keyword">function</span>* () {
  <span class="hljs-keyword">yield</span> [<span class="hljs-string">'公司名称'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>];
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [dept, info] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">departments</span>)) {
    <span class="hljs-keyword">yield</span> [<span class="hljs-string">`<span class="hljs-subst">${dept}</span>部门人数`</span>, info.<span class="hljs-property">employees</span>];
    <span class="hljs-keyword">yield</span> [<span class="hljs-string">`<span class="hljs-subst">${dept}</span>部门预算`</span>, info.<span class="hljs-property">budget</span>];
  }
};

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [label, value] <span class="hljs-keyword">of</span> company) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${label}</span>: <span class="hljs-subst">${value}</span>`</span>);
}
</code></pre>
<h2 data-id="heading-15">7. <strong>性能考虑</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {};
<span class="hljs-comment">// 创建一个大对象</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++) {
  obj[<span class="hljs-string">`key<span class="hljs-subst">${i}</span>`</span>] = i;
}

<span class="hljs-comment">// 测试不同方法的性能</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'Object.keys + for...of'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj)) {
  <span class="hljs-keyword">const</span> value = obj[key];
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'Object.keys + for...of'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'Object.entries + for...of'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj)) {
  <span class="hljs-comment">// 直接有值</span>
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'Object.entries + for...of'</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">time</span>(<span class="hljs-string">'for...in'</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> obj) {
  <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
    <span class="hljs-keyword">const</span> value = obj[key];
  }
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">timeEnd</span>(<span class="hljs-string">'for...in'</span>);
</code></pre>
<h2 data-id="heading-16">8. <strong>实用工具函数</strong></h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 创建可迭代对象的工具函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">makeIterable</span>(<span class="hljs-params">obj, options = {}</span>) {
  <span class="hljs-keyword">const</span> {
    exclude = [],      <span class="hljs-comment">// 排除的属性</span>
    includeOnly = <span class="hljs-literal">null</span>, <span class="hljs-comment">// 只包含的属性</span>
    sortKeys = <span class="hljs-literal">false</span>,  <span class="hljs-comment">// 是否按键排序</span>
    valueOnly = <span class="hljs-literal">false</span>  <span class="hljs-comment">// 只返回值</span>
  } = options;
  
  <span class="hljs-keyword">const</span> iterable = { ...obj };
  
  iterable[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>] = <span class="hljs-keyword">function</span>* () {
    <span class="hljs-keyword">let</span> keys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(<span class="hljs-variable language_">this</span>);
    
    <span class="hljs-comment">// 过滤</span>
    <span class="hljs-keyword">if</span> (exclude.<span class="hljs-property">length</span>) {
      keys = keys.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> !exclude.<span class="hljs-title function_">includes</span>(key));
    }
    
    <span class="hljs-keyword">if</span> (includeOnly) {
      keys = keys.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> includeOnly.<span class="hljs-title function_">includes</span>(key));
    }
    
    <span class="hljs-comment">// 排序</span>
    <span class="hljs-keyword">if</span> (sortKeys) {
      keys.<span class="hljs-title function_">sort</span>();
    }
    
    <span class="hljs-comment">// 迭代</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> keys) {
      <span class="hljs-keyword">if</span> (valueOnly) {
        <span class="hljs-keyword">yield</span> <span class="hljs-variable language_">this</span>[key];
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">yield</span> [key, <span class="hljs-variable language_">this</span>[key]];
      }
    }
  };
  
  <span class="hljs-keyword">return</span> iterable;
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> data = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">d</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">e</span>: <span class="hljs-number">5</span> };
<span class="hljs-keyword">const</span> iterableData = <span class="hljs-title function_">makeIterable</span>(data, {
  <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'e'</span>],
  <span class="hljs-attr">sortKeys</span>: <span class="hljs-literal">true</span>
});

<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> iterableData) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(key, value); <span class="hljs-comment">// a 1, b 2, c 3, d 4</span>
}
</code></pre>
<h2 data-id="heading-17">总结</h2>
<ol>
<li><strong>最简单的方法</strong>：使用 <code>Object.keys()</code>、<code>Object.values()</code> 或 <code>Object.entries()</code></li>
<li><strong>需要直接迭代对象</strong>：实现 <code>Symbol.iterator</code> 方法</li>
<li><strong>需要自定义迭代逻辑</strong>：使用生成器函数</li>
<li><strong>考虑性能</strong>：<code>Object.entries()</code> + <code>for...of</code> 通常是性能和可读性的最佳平衡</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 推荐的最佳实践</span>
<span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">a</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">b</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">c</span>: <span class="hljs-number">3</span> };

<span class="hljs-comment">// 1. 只需要键或值</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(obj)) { }
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> value <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">values</span>(obj)) { }

<span class="hljs-comment">// 2. 需要键值对</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj)) { }

<span class="hljs-comment">// 3. 需要直接迭代对象（添加迭代器）</span>
obj[<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">iterator</span>] = <span class="hljs-keyword">function</span>* () {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [key, value] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(<span class="hljs-variable language_">this</span>)) {
    <span class="hljs-keyword">yield</span> { key, value };
  }
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elpis npm 包抽离总结]]></title>    <link>https://juejin.cn/post/7592803747471933490</link>    <guid>https://juejin.cn/post/7592803747471933490</guid>    <pubDate>2026-01-08T14:21:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7592803747471933490" data-draft-id="7592822714068090931" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elpis npm 包抽离总结"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-08T14:21:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="未等与你踏清风"/> <meta itemprop="url" content="https://juejin.cn/user/2203871969545191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elpis npm 包抽离总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2203871969545191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    未等与你踏清风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-08T14:21:04.000Z" title="Thu Jan 08 2026 14:21:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-08
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文档总结将 elpis 框架抽离为 npm 包过程中的核心难点与解决方案</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">核心难点</h2>
<h3 data-id="heading-1">1. 路径解析的双重性挑战 ⭐⭐⭐</h3>
<p><strong>问题</strong>：npm 包内代码需要同时访问包内资源和业务项目资源，两类路径的解析方式完全不同。</p>
<p><strong>核心区别</strong>：</p>























<table><thead><tr><th>路径类型</th><th>使用变量</th><th>指向位置</th><th>特点</th></tr></thead><tbody><tr><td>包内路径</td><td><code>__dirname</code></td><td>npm 包安装目录（如 <code>node_modules/@david-yjy/elpis/...</code>）</td><td>固定不变</td></tr><tr><td>业务路径</td><td><code>process.cwd()</code></td><td>执行命令时的当前工作目录（业务项目根目录）</td><td>动态变化</td></tr></tbody></table>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.base.js</span>

<span class="hljs-comment">// ✅ 包内路径：使用 __dirname</span>
<span class="hljs-keyword">const</span> elpisEntryList = path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'../../pages/**/entry.*.js'</span>);

<span class="hljs-comment">// ✅ 业务路径：使用 process.cwd()</span>
<span class="hljs-keyword">const</span> businessEntryList = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'./app/pages/**/entry.*.js'</span>);
</code></pre>
<p><strong>常见卡点</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误：混淆两种路径类型</span>
<span class="hljs-keyword">const</span> businessConfig = <span class="hljs-built_in">require</span>(path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'./app/config.js'</span>));

<span class="hljs-comment">// ✅ 正确：明确区分</span>
<span class="hljs-keyword">const</span> businessConfig = <span class="hljs-built_in">require</span>(path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'./app/config.js'</span>));
</code></pre>
<p><strong>学习要点</strong>：</p>
<ul>
<li><code>__dirname</code> = 模块文件所在目录（包内，固定）</li>
<li><code>process.cwd()</code> = 进程当前工作目录（业务项目，动态）</li>
<li><strong>永远不要假设业务项目路径相对于包的位置</strong></li>
</ul>
<hr/>
<h3 data-id="heading-2">2. Loader 解析的路径问题 ⭐⭐⭐</h3>
<p><strong>问题</strong>：直接使用字符串路径配置 loader 会导致路径找不到或版本冲突。</p>
<p><strong>解决方案</strong>：使用 <code>require.resolve()</code> 确保从包内解析 loader。</p>
<p><strong>代码对比</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误：可能找不到或版本不对</span>
<span class="hljs-attr">module</span>: {
  <span class="hljs-attr">rules</span>: [{
    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.vue$/</span>,
    <span class="hljs-attr">use</span>: <span class="hljs-string">'vue-loader'</span>
  }]
}

<span class="hljs-comment">// ✅ 正确：使用 require.resolve() 从包内解析</span>
<span class="hljs-attr">module</span>: {
  <span class="hljs-attr">rules</span>: [{
    <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.vue$/</span>,
    <span class="hljs-attr">use</span>: {
      <span class="hljs-attr">loader</span>: <span class="hljs-built_in">require</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'vue-loader'</span>),  <span class="hljs-comment">// 确保版本一致</span>
    }
  }]
}
</code></pre>
<p><strong>为什么这样做？</strong></p>
<ul>
<li>✅ <strong>版本一致性</strong>：确保使用包内定义的 loader 版本</li>
<li>✅ <strong>路径可靠性</strong>：无论在什么环境下都能找到正确的 loader</li>
<li>✅ <strong>隔离性</strong>：包内依赖不会影响业务项目</li>
</ul>
<hr/>
<h3 data-id="heading-3">3. 业务扩展点的可选性设计 ⭐⭐</h3>
<p><strong>问题</strong>：框架需要提供扩展点让业务项目自定义配置，但这些配置必须是<strong>可选的</strong>，缺失时不能报错。</p>
<p><strong>解决方案</strong>：使用 <code>fs.existsSync()</code> 检查 + 空模块降级。</p>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.base.js</span>

<span class="hljs-attr">resolve</span>: {
  <span class="hljs-attr">alias</span>: (<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> aliasMap = {};
    <span class="hljs-keyword">const</span> blankModulePath = path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'../libs/blank.js'</span>);

    <span class="hljs-comment">// 检查业务配置文件是否存在</span>
    <span class="hljs-keyword">const</span> businessConfig = path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'./app/pages/dashboard/root.js'</span>);

    <span class="hljs-comment">// ✅ 关键：存在用业务配置，不存在用空模块</span>
    aliasMap[<span class="hljs-string">'$businessDashboardRouterConfig'</span>] =
      fs.<span class="hljs-title function_">existsSync</span>(businessConfig)
        ? businessConfig      <span class="hljs-comment">// 存在：使用业务配置</span>
        : blankModulePath;    <span class="hljs-comment">// 不存在：使用空模块</span>

    <span class="hljs-keyword">return</span> aliasMap;
  })()
}
</code></pre>
<p><strong>空模块</strong> (<code>blank.js</code>)：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {}  <span class="hljs-comment">// 确保业务代码可以安全 require</span>
</code></pre>
<p><strong>设计模式</strong>：</p>
<ol>
<li><strong>检测</strong>：<code>fs.existsSync()</code> 检查文件是否存在</li>
<li><strong>降级</strong>：不存在时提供默认实现（空模块）</li>
<li><strong>透明</strong>：通过 webpack alias，业务代码无需关心配置来源</li>
</ol>
<hr/>
<h3 data-id="heading-4">4. 配置合并与容错加载 ⭐⭐</h3>
<p><strong>问题</strong>：业务项目可能想要自定义 webpack 配置，但这个配置应该是可选的。</p>
<p><strong>解决方案</strong>：使用 try-catch 容错 + webpack-merge 合并。</p>
<p><strong>代码示例</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack.base.js</span>

<span class="hljs-comment">// ✅ 容错加载业务配置</span>
<span class="hljs-keyword">let</span> businessWebpackConfig = {};
<span class="hljs-keyword">try</span> {
  businessWebpackConfig = <span class="hljs-built_in">require</span>(<span class="hljs-string">`<span class="hljs-subst">${process.cwd()}</span>/app/webpack.config.js`</span>);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-comment">// 静默处理：业务配置不存在是正常的</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'未找到业务 webpack 配置'</span>);
}

<span class="hljs-comment">// ✅ 使用 webpack-merge 的 smart 策略合并</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = merge.<span class="hljs-title function_">smart</span>(
  baseConfig,        <span class="hljs-comment">// 框架基础配置</span>
  businessWebpackConfig  <span class="hljs-comment">// 业务配置（可选，会覆盖基础配置）</span>
);
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>✅ 业务配置缺失不影响框架功能</li>
<li>✅ 业务配置会智能合并（数组合并，对象覆盖）</li>
<li>✅ 降低使用门槛，渐进增强</li>
</ul>
<hr/>
<h2 data-id="heading-5">关键技术点总结</h2>
<h3 data-id="heading-6">路径解析的核心原则</h3>

























<table><thead><tr><th>场景</th><th>使用变量</th><th>原因</th></tr></thead><tbody><tr><td>包内资源路径</td><td><code>__dirname</code></td><td>指向包安装位置，固定不变</td></tr><tr><td>业务资源路径</td><td><code>process.cwd()</code></td><td>指向执行目录，动态变化</td></tr><tr><td>Loader/插件路径</td><td><code>require.resolve()</code></td><td>确保从包内解析，版本一致</td></tr></tbody></table>
<h3 data-id="heading-7">容错设计模式</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模式1：可选配置检查 + 空模块降级</span>
<span class="hljs-keyword">const</span> config = fs.<span class="hljs-title function_">existsSync</span>(configPath) ? configPath : blankModulePath;

<span class="hljs-comment">// 模式2：try-catch 容错</span>
<span class="hljs-keyword">let</span> config = {};
<span class="hljs-keyword">try</span> {
  config = <span class="hljs-built_in">require</span>(configPath);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-comment">// 静默处理</span>
}
</code></pre>
<h3 data-id="heading-8">配置合并策略</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用 webpack-merge 的 smart 策略</span>
<span class="hljs-keyword">const</span> finalConfig = merge.<span class="hljs-title function_">smart</span>(baseConfig, businessConfig);
<span class="hljs-comment">// - 对象属性：后面的覆盖前面的</span>
<span class="hljs-comment">// - 数组：会合并去重（如 plugins、rules）</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">最佳实践</h2>
<h3 data-id="heading-10">1. 路径处理规范</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 推荐：使用辅助函数明确区分</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getPackagePath</span>(<span class="hljs-params">...paths</span>) {
  <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'../../'</span>, ...paths);
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getProjectPath</span>(<span class="hljs-params">...paths</span>) {
  <span class="hljs-keyword">return</span> path.<span class="hljs-title function_">resolve</span>(process.<span class="hljs-title function_">cwd</span>(), ...paths);
}
</code></pre>
<h3 data-id="heading-11">2. 依赖管理</h3>
<ul>
<li><strong>框架包</strong>：构建依赖放在 <code>dependencies</code>，确保版本一致</li>
<li><strong>业务项目</strong>：只需安装框架包，依赖由包提供</li>
</ul>
<hr/>
<h2 data-id="heading-12">总结</h2>
<p>将框架抽离为 npm 包的核心挑战在于<strong>路径上下文的管理</strong>。通过合理使用：</p>
<ol>
<li>✅ <strong><code>__dirname</code></strong> - 访问包内资源（固定）</li>
<li>✅ <strong><code>process.cwd()</code></strong> - 访问业务项目资源（动态）</li>
<li>✅ <strong><code>require.resolve()</code></strong> - 解析包内依赖（版本一致）</li>
<li>✅ <strong>容错设计</strong> - 可选配置优雅降级</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>